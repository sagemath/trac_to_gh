# Issue 10752: EclLib should allow signals to make LISP code interruptable

archive/issues_010752.json:
```json
{
    "body": "Assignee: was\n\nCC:  fbissey jdemeyer kcrisman\n\nKeywords: lisp ecl signal interrupt\n\nPresently, ecllib does not enable signals when executing ecl code. This makes LISP code uninterruptable:\n\n```\nsage: from sage.libs.ecl import *\nsage: ecl_eval(\"(setf i 0)\")\n<ECL: 0>\nsage: inf_loop=ecl_eval(\"(defun infinite() (loop (incf i)))\")\nsage: inf_loop() #DON'T DO THIS! (bye bye)\n```\n\nThe signal handling in ECL should be studied a bit more to ensure that we are safely interacting with it. The attached patch just inserts `sig_on()/sig_off()` around the possibly slow parts. This seems to work, but I suspect it might leave ECL in an inconsistent state.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10818\n\n",
    "created_at": "2011-02-21T22:30:07Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.1",
    "title": "EclLib should allow signals to make LISP code interruptable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10752",
    "user": "nbruin"
}
```
Assignee: was

CC:  fbissey jdemeyer kcrisman

Keywords: lisp ecl signal interrupt

Presently, ecllib does not enable signals when executing ecl code. This makes LISP code uninterruptable:

```
sage: from sage.libs.ecl import *
sage: ecl_eval("(setf i 0)")
<ECL: 0>
sage: inf_loop=ecl_eval("(defun infinite() (loop (incf i)))")
sage: inf_loop() #DON'T DO THIS! (bye bye)
```

The signal handling in ECL should be studied a bit more to ensure that we are safely interacting with it. The attached patch just inserts `sig_on()/sig_off()` around the possibly slow parts. This seems to work, but I suspect it might leave ECL in an inconsistent state.

Issue created by migration from https://trac.sagemath.org/ticket/10818





---

archive/issue_comments_113520.json:
```json
{
    "body": "rudimentary approach to signal handling in Ecllib",
    "created_at": "2011-02-21T22:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113520",
    "user": "nbruin"
}
```

rudimentary approach to signal handling in Ecllib



---

archive/issue_comments_113521.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2011-02-21T22:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113521",
    "user": "nbruin"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_113522.json:
```json
{
    "body": "Attachment [signal-handling.patch](tarball://root/attachments/some-uuid/ticket10818/signal-handling.patch) by nbruin created at 2011-02-21 22:36:02\n\nWith the patch, we can indeed interrupt ECL. We should try to do some more critical stuff and see if ECL can get in an inconsistent state due to this (I expect it can). Example session:\n\n```\nsage: from sage.libs.ecl import *\nsage: ecl_eval(\"(setf i 0)\")\n<ECL: 0>\nsage: inf_loop=ecl_eval(\"(defun infinite() (loop (incf i)))\")\nsage: inf_loop()\nKeyboardInterrupt: \nsage: ecl_eval(\"i\")\n<ECL: 5337027>\nsage: ecl_eval(\"(infinite)\")\nKeyboardInterrupt: \nsage: ecl_eval(\"i\")\n<ECL: 15518182>\n```\n",
    "created_at": "2011-02-21T22:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113522",
    "user": "nbruin"
}
```

Attachment [signal-handling.patch](tarball://root/attachments/some-uuid/ticket10818/signal-handling.patch) by nbruin created at 2011-02-21 22:36:02

With the patch, we can indeed interrupt ECL. We should try to do some more critical stuff and see if ECL can get in an inconsistent state due to this (I expect it can). Example session:

```
sage: from sage.libs.ecl import *
sage: ecl_eval("(setf i 0)")
<ECL: 0>
sage: inf_loop=ecl_eval("(defun infinite() (loop (incf i)))")
sage: inf_loop()
KeyboardInterrupt: 
sage: ecl_eval("i")
<ECL: 5337027>
sage: ecl_eval("(infinite)")
KeyboardInterrupt: 
sage: ecl_eval("i")
<ECL: 15518182>
```




---

archive/issue_comments_113523.json:
```json
{
    "body": "Try to swap signal handlers",
    "created_at": "2011-02-24T06:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113523",
    "user": "nbruin"
}
```

Try to swap signal handlers



---

archive/issue_comments_113524.json:
```json
{
    "body": "Attachment [siginttest.c](tarball://root/attachments/some-uuid/ticket10818/siginttest.c) by nbruin created at 2011-02-24 06:01:34",
    "created_at": "2011-02-24T06:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113524",
    "user": "nbruin"
}
```

Attachment [siginttest.c](tarball://root/attachments/some-uuid/ticket10818/siginttest.c) by nbruin created at 2011-02-24 06:01:34



---

archive/issue_comments_113525.json:
```json
{
    "body": "A simple approach would be to swap in ECL's signal handler for SIGINT upon entry of ECL code and swap back to the sage signal handler afterwards. The patch handlerswap.patch takes this approach. Unfortunately, it doesn't work. For some reason, the SIGINT handler we capture from ECL seems to just exit upon interrupt. This is not ECL's normal behaviour and the attached stand-alone program siginttest.c (also attached) shows that this approach works in principle.\n\nI have no idea why the same approach leads to different results in a sage and cython context.",
    "created_at": "2011-02-24T06:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113525",
    "user": "nbruin"
}
```

A simple approach would be to swap in ECL's signal handler for SIGINT upon entry of ECL code and swap back to the sage signal handler afterwards. The patch handlerswap.patch takes this approach. Unfortunately, it doesn't work. For some reason, the SIGINT handler we capture from ECL seems to just exit upon interrupt. This is not ECL's normal behaviour and the attached stand-alone program siginttest.c (also attached) shows that this approach works in principle.

I have no idea why the same approach leads to different results in a sage and cython context.



---

archive/issue_comments_113526.json:
```json
{
    "body": "Apply handlerswap.p2.patch\n\nAnother take on swapping handlers and this one seems to work:\n\n```\nsage: from sage.interfaces.maxima_lib import maxima as max\nsage: max('sum(1/x^2, x, 1, 100000)')\n^C---------------------------------------------------------------------------\n[...]\nTypeError: ECL says: Console interrupt\nsage: #we press Ctrl-C again\nKeyboardInterrupt\n```\n\nFor reference, ECL prefers to use sigaction (in fact, probably sage should be using sigaction as well. Certain race conditions with signal are avoidable with sigaction). In glibc, signal is implemented via sigaction anyway. sigaction has a richer interface, so signal cannot always properly report what sigaction has done. By using sigaction to record and swap the different SIGINT handlers, it seems to work.\n\nSubtle race conditions still exist: the ECL handler is instated just before entering lisp code and setting up the \"unwind-protect stack frame\", so an interrupt that gets delivered in that window would cause unspecified behaviour. By running\n\nwhile True: os.kill(<PID>,2)\n\nit is easy to trigger such behaviour, but sage in its present state already cannot handle this.\nTherefore, I think the present patch establishes acceptable \"best effort\" behaviour.",
    "created_at": "2011-02-25T09:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113526",
    "user": "nbruin"
}
```

Apply handlerswap.p2.patch

Another take on swapping handlers and this one seems to work:

```
sage: from sage.interfaces.maxima_lib import maxima as max
sage: max('sum(1/x^2, x, 1, 100000)')
^C---------------------------------------------------------------------------
[...]
TypeError: ECL says: Console interrupt
sage: #we press Ctrl-C again
KeyboardInterrupt
```

For reference, ECL prefers to use sigaction (in fact, probably sage should be using sigaction as well. Certain race conditions with signal are avoidable with sigaction). In glibc, signal is implemented via sigaction anyway. sigaction has a richer interface, so signal cannot always properly report what sigaction has done. By using sigaction to record and swap the different SIGINT handlers, it seems to work.

Subtle race conditions still exist: the ECL handler is instated just before entering lisp code and setting up the "unwind-protect stack frame", so an interrupt that gets delivered in that window would cause unspecified behaviour. By running

while True: os.kill(<PID>,2)

it is easy to trigger such behaviour, but sage in its present state already cannot handle this.
Therefore, I think the present patch establishes acceptable "best effort" behaviour.



---

archive/issue_comments_113527.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-02-25T09:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113527",
    "user": "nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_113528.json:
```json
{
    "body": "Swap signal handlers and enable signals (this one seems to work!)",
    "created_at": "2011-02-25T22:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113528",
    "user": "nbruin"
}
```

Swap signal handlers and enable signals (this one seems to work!)



---

archive/issue_comments_113529.json:
```json
{
    "body": "Attachment [handlerswap.p2.patch](tarball://root/attachments/some-uuid/ticket10818/handlerswap.p2.patch) by nbruin created at 2011-02-25 22:50:56\n\nSmall update:\n* Juanjo explains that unwelcome signals in ECL get queued. To mark this fact, a memory block gets mprotected to readonly. The next time a write occurs, a SIGSEGV is received and the queued signal is processed if it is now safe to do so. This means, however, that if ECL is allowed to process *any* signals then it should be allowed to handle SIGSEGV. So that handler needs to be swapped as well.\n* constants SIGINT and SIGSEGV are now actually imported.\n\nRace conditions still exist. If you run a sage process with pid PID with something along the lines of\n\n```\nfrom sage.libs.ecl import *\nlp = ecl_eval(\"(defun lp (a) (loop))\")\nwhile True:\n    try:\n        lp(1)\n    except RuntimeError as e:\n        print e\n```\n\nand then run in another process:\n\n```\nwhile True:\n    os.kill(PID,2)\n    sleep(0.01)\n```\n\nyou may eventually see strange behaviour. To avoid this we could disable signals prior to swapping the handlers and only enable them once we're inside lisp (and do the reverse on the way out). However, the signal handlers in sage are already not completely bullet proof (I don't think there are many programs where they are). Improvements welcome of course, but I think the present gives a workable compromise.",
    "created_at": "2011-02-25T22:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113529",
    "user": "nbruin"
}
```

Attachment [handlerswap.p2.patch](tarball://root/attachments/some-uuid/ticket10818/handlerswap.p2.patch) by nbruin created at 2011-02-25 22:50:56

Small update:
* Juanjo explains that unwelcome signals in ECL get queued. To mark this fact, a memory block gets mprotected to readonly. The next time a write occurs, a SIGSEGV is received and the queued signal is processed if it is now safe to do so. This means, however, that if ECL is allowed to process *any* signals then it should be allowed to handle SIGSEGV. So that handler needs to be swapped as well.
* constants SIGINT and SIGSEGV are now actually imported.

Race conditions still exist. If you run a sage process with pid PID with something along the lines of

```
from sage.libs.ecl import *
lp = ecl_eval("(defun lp (a) (loop))")
while True:
    try:
        lp(1)
    except RuntimeError as e:
        print e
```

and then run in another process:

```
while True:
    os.kill(PID,2)
    sleep(0.01)
```

you may eventually see strange behaviour. To avoid this we could disable signals prior to swapping the handlers and only enable them once we're inside lisp (and do the reverse on the way out). However, the signal handlers in sage are already not completely bullet proof (I don't think there are many programs where they are). Improvements welcome of course, but I think the present gives a workable compromise.



---

archive/issue_comments_113530.json:
```json
{
    "body": "patchbot apply handlerswap.p2.patch",
    "created_at": "2011-02-25T22:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113530",
    "user": "nbruin"
}
```

patchbot apply handlerswap.p2.patch



---

archive/issue_comments_113531.json:
```json
{
    "body": "If this can leave ECL in an undefined state, and so potentially Maxima generate incorrect results, would it not be better left out? Not being able to interrupt code is annoying, but potentially getting incorrect results is more dangerous. \n\nDave",
    "created_at": "2011-02-28T09:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113531",
    "user": "drkirkby"
}
```

If this can leave ECL in an undefined state, and so potentially Maxima generate incorrect results, would it not be better left out? Not being able to interrupt code is annoying, but potentially getting incorrect results is more dangerous. 

Dave



---

archive/issue_comments_113532.json:
```json
{
    "body": "Replying to [comment:7 drkirkby]:\n> If this can leave ECL in an undefined state, and so potentially Maxima generate incorrect results\nI don't know if maxima is robust in the face of interrupts, but we're already exposed to that by letting pexpect propagate SIGINT.\n\nAs far as I know, the present patch does not contribute to possible corruption of ECL. You might end up in the ECL debugger if the interrupt arrives between teardown of the Lisp version of try/expect and the swap of the interrupt handlers. This is easily distinguished from a wrong answer.\n\nSee http://sourceforge.net/mailarchive/message.php?msg_id=27127709 for JJ G-P's suggestion for dealing with this.",
    "created_at": "2011-02-28T17:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113532",
    "user": "nbruin"
}
```

Replying to [comment:7 drkirkby]:
> If this can leave ECL in an undefined state, and so potentially Maxima generate incorrect results
I don't know if maxima is robust in the face of interrupts, but we're already exposed to that by letting pexpect propagate SIGINT.

As far as I know, the present patch does not contribute to possible corruption of ECL. You might end up in the ECL debugger if the interrupt arrives between teardown of the Lisp version of try/expect and the swap of the interrupt handlers. This is easily distinguished from a wrong answer.

See http://sourceforge.net/mailarchive/message.php?msg_id=27127709 for JJ G-P's suggestion for dealing with this.



---

archive/issue_comments_113533.json:
```json
{
    "body": "With my patch, I introduce new functions `ecl_sig_on()` and `ecl_sig_off()` which is a cleaner solution.  I also added two tests to check that interrupts actually work.",
    "created_at": "2011-03-30T12:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113533",
    "user": "jdemeyer"
}
```

With my patch, I introduce new functions `ecl_sig_on()` and `ecl_sig_off()` which is a cleaner solution.  I also added two tests to check that interrupts actually work.



---

archive/issue_comments_113534.json:
```json
{
    "body": "Nice cleanup! Two questions:\n* in ecl_sig_on(), you do a sig_on() BEFORE switching to the ecl signal handler. That provides a window for an interrupt to still be handled by the SAGE handler. Is that intentional? (It might even be a good idea if that \"clears out\" the signal queue before switching to ecl handling, because ecl will not be aware of any signals queued by SAGE, which might cause them to grow stale)\n\n* Juanjo's suggestion http://sourceforge.net/mailarchive/message.php?msg_id=27127709 includes using some macros from ecl's header files. Can that be integrated in ecl_sig_on() etc? Since you are moving things to a .c file, using those macros will be much easier. I gave some thought on how to import those into cython but failed to come up with a solution.",
    "created_at": "2011-03-30T22:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113534",
    "user": "nbruin"
}
```

Nice cleanup! Two questions:
* in ecl_sig_on(), you do a sig_on() BEFORE switching to the ecl signal handler. That provides a window for an interrupt to still be handled by the SAGE handler. Is that intentional? (It might even be a good idea if that "clears out" the signal queue before switching to ecl handling, because ecl will not be aware of any signals queued by SAGE, which might cause them to grow stale)

* Juanjo's suggestion http://sourceforge.net/mailarchive/message.php?msg_id=27127709 includes using some macros from ecl's header files. Can that be integrated in ecl_sig_on() etc? Since you are moving things to a .c file, using those macros will be much easier. I gave some thought on how to import those into cython but failed to come up with a solution.



---

archive/issue_comments_113535.json:
```json
{
    "body": "Replying to [comment:13 nbruin]:\n> in ecl_sig_on(), you do a sig_on() BEFORE switching to the ecl signal handler. That provides a window for an interrupt to still be handled by the SAGE handler. Is that intentional?\nYes, it is intentional.  It fixes the problem of an interrupt arriving *before* ecl_sig_on() is called, I added a test to prove that it works.",
    "created_at": "2011-04-01T10:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113535",
    "user": "jdemeyer"
}
```

Replying to [comment:13 nbruin]:
> in ecl_sig_on(), you do a sig_on() BEFORE switching to the ecl signal handler. That provides a window for an interrupt to still be handled by the SAGE handler. Is that intentional?
Yes, it is intentional.  It fixes the problem of an interrupt arriving *before* ecl_sig_on() is called, I added a test to prove that it works.



---

archive/issue_comments_113536.json:
```json
{
    "body": "Replying to [comment:13 nbruin]:\n> Juanjo's suggestion http://sourceforge.net/mailarchive/message.php?msg_id=27127709 includes using some macros from ecl's header files. Can that be integrated in ecl_sig_on() etc? Since you are moving things to a .c file, using those macros will be much easier.\n\nMaybe it's a good idea, maybe not.  I do not know how ECL's interrupt handling works (and to be honest, I don't feel like studying it).  So personally, I am not going to do this now.",
    "created_at": "2011-04-01T10:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113536",
    "user": "jdemeyer"
}
```

Replying to [comment:13 nbruin]:
> Juanjo's suggestion http://sourceforge.net/mailarchive/message.php?msg_id=27127709 includes using some macros from ecl's header files. Can that be integrated in ecl_sig_on() etc? Since you are moving things to a .c file, using those macros will be much easier.

Maybe it's a good idea, maybe not.  I do not know how ECL's interrupt handling works (and to be honest, I don't feel like studying it).  So personally, I am not going to do this now.



---

archive/issue_comments_113537.json:
```json
{
    "body": "It would be good to include this patch before #7377.  Nils, are you able to review this? (if no, just say so).",
    "created_at": "2011-04-04T18:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113537",
    "user": "jdemeyer"
}
```

It would be good to include this patch before #7377.  Nils, are you able to review this? (if no, just say so).



---

archive/issue_comments_113538.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> It would be good to include this patch before #7377.  Nils, are you able to review this?\nNo, sorry. I'm currently not set up to apply and test patches. I gave your code a quick look and it looks great\n\n* The fact that ecl_sig_on() is a macro will work great with Juanjo's refinement later\n\n* I'm a little puzzled that ecl_sig_off() is not a macro. Doesn't the same argument apply there?\n(certainly if we apply Juanjo's suggestion it will have to be, because I think there is a macro pair that involves straddling \"{\" and \"}\"). However, if the current code works that that is fine. We can always change it later.\n\n* Jeroen is almost certainly more of an expert in Posix signal handling than I am. Take that as a recommendation.",
    "created_at": "2011-04-05T00:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113538",
    "user": "nbruin"
}
```

Replying to [comment:16 jdemeyer]:
> It would be good to include this patch before #7377.  Nils, are you able to review this?
No, sorry. I'm currently not set up to apply and test patches. I gave your code a quick look and it looks great

* The fact that ecl_sig_on() is a macro will work great with Juanjo's refinement later

* I'm a little puzzled that ecl_sig_off() is not a macro. Doesn't the same argument apply there?
(certainly if we apply Juanjo's suggestion it will have to be, because I think there is a macro pair that involves straddling "{" and "}"). However, if the current code works that that is fine. We can always change it later.

* Jeroen is almost certainly more of an expert in Posix signal handling than I am. Take that as a recommendation.



---

archive/issue_comments_113539.json:
```json
{
    "body": "Replying to [comment:18 nbruin]:\n>  * I'm a little puzzled that ecl_sig_off() is not a macro. Doesn't the same argument apply there?\n> (certainly if we apply Juanjo's suggestion it will have to be, because I think there is a macro pair that involves straddling \"{\" and \"}\"). However, if the current code works that that is fine. We can always change it later.\nThe main reason for *not* making it a macro is that there is currently no reason why it should be a macro.  Between macros and inline functions, I much prefer inline functions.  So I only use macros when they are really needed.\n\nLet me state again that I'm not against Juanjo's suggestion, it's just that I don't really know how the ECL signal handling works.  The code which is currently on this ticket makes few assumptions on the inner workings of the ECL signal handler.  The more we start \"interfering\" with the ECL signal handler, the more important it becomes to really understand what is going on.",
    "created_at": "2011-04-05T08:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113539",
    "user": "jdemeyer"
}
```

Replying to [comment:18 nbruin]:
>  * I'm a little puzzled that ecl_sig_off() is not a macro. Doesn't the same argument apply there?
> (certainly if we apply Juanjo's suggestion it will have to be, because I think there is a macro pair that involves straddling "{" and "}"). However, if the current code works that that is fine. We can always change it later.
The main reason for *not* making it a macro is that there is currently no reason why it should be a macro.  Between macros and inline functions, I much prefer inline functions.  So I only use macros when they are really needed.

Let me state again that I'm not against Juanjo's suggestion, it's just that I don't really know how the ECL signal handling works.  The code which is currently on this ticket makes few assumptions on the inner workings of the ECL signal handler.  The more we start "interfering" with the ECL signal handler, the more important it becomes to really understand what is going on.



---

archive/issue_comments_113540.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-04-06T14:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113540",
    "user": "jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_113541.json:
```json
{
    "body": "I've looked through the code and (after understanding lots of things about signal handling in Sage) it seems great.\n\nI would be ready to give it positive review if the test_sigint_... was a little bit more explicit.\n\nRight now, letting sig_on(), sig_off() in ecl_sig_on() and ecl_sig_off() does not look really different (ok, there is one line more).\n\nFor example adding an infinite loop between ecl_sig_on and ecl_sig_off:\n\n\n```\n    global safe_funcall_clobj\n    cl_eval(string_to_object(\"(setf i 0)\"))\n    cl_eval(string_to_object(\"(defun infinite() (loop (incf i)))\"))\n    inf_loop=cl_eval(string_to_object(\"(symbol-function 'infinite)\"))\n    signal_raise(SIGINT)\n    ecl_sig_on() # KeyboardInterrupt should be raised because ecl_sig_on() calls sig_on() first\n    cl_funcall(1,inf_loop)\n    ecl_sig_off()\n```\n",
    "created_at": "2011-04-06T14:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113541",
    "user": "jpflori"
}
```

I've looked through the code and (after understanding lots of things about signal handling in Sage) it seems great.

I would be ready to give it positive review if the test_sigint_... was a little bit more explicit.

Right now, letting sig_on(), sig_off() in ecl_sig_on() and ecl_sig_off() does not look really different (ok, there is one line more).

For example adding an infinite loop between ecl_sig_on and ecl_sig_off:


```
    global safe_funcall_clobj
    cl_eval(string_to_object("(setf i 0)"))
    cl_eval(string_to_object("(defun infinite() (loop (incf i)))"))
    inf_loop=cl_eval(string_to_object("(symbol-function 'infinite)"))
    signal_raise(SIGINT)
    ecl_sig_on() # KeyboardInterrupt should be raised because ecl_sig_on() calls sig_on() first
    cl_funcall(1,inf_loop)
    ecl_sig_off()
```




---

archive/issue_comments_113542.json:
```json
{
    "body": "Replying to [comment:20 jpflori]:\n> For example adding an infinite loop between ecl_sig_on and ecl_sig_off:\n> \n> {{{\n>     global safe_funcall_clobj\n>     cl_eval(string_to_object(\"(setf i 0)\"))\n>     cl_eval(string_to_object(\"(defun infinite() (loop (incf i)))\"))\n>     inf_loop=cl_eval(string_to_object(\"(symbol-function 'infinite)\"))\n>     signal_raise(SIGINT)\n>     ecl_sig_on() # KeyboardInterrupt should be raised because ecl_sig_on() calls sig_on() first\n>     cl_funcall(1,inf_loop)\n>     ecl_sig_off()\n> }}}\n\nI decided not to do this, in order to keep the code simple and make it more clear what is happening.  I *did* add more explanation to the test though, I hope this helps also.",
    "created_at": "2011-04-07T14:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113542",
    "user": "jdemeyer"
}
```

Replying to [comment:20 jpflori]:
> For example adding an infinite loop between ecl_sig_on and ecl_sig_off:
> 
> {{{
>     global safe_funcall_clobj
>     cl_eval(string_to_object("(setf i 0)"))
>     cl_eval(string_to_object("(defun infinite() (loop (incf i)))"))
>     inf_loop=cl_eval(string_to_object("(symbol-function 'infinite)"))
>     signal_raise(SIGINT)
>     ecl_sig_on() # KeyboardInterrupt should be raised because ecl_sig_on() calls sig_on() first
>     cl_funcall(1,inf_loop)
>     ecl_sig_off()
> }}}

I decided not to do this, in order to keep the code simple and make it more clear what is happening.  I *did* add more explanation to the test though, I hope this helps also.



---

archive/issue_comments_113543.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-07T14:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113543",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_113544.json:
```json
{
    "body": "I'm sorry to complain a little more about the test you put, but I think putting something python-ish at that place is a bad idea.\n\nOf course because you will actually leave \"sig_on()\" in \"ecl_sig_on()\", that won't cause any problems, but if we were to leave out \"sig_on()\"  we won't see \"Failure\" printed (the SIGINT will get caught before, and that is the main reason which makes it a bad test for me) and that will completely break interrupt handling (pressing Ctrl-C afterwards will lead you into Lisp debugger, I don't even know how to get out of there without pressing Ctrl+\\). So IMHO that is not a good example to clearly understand what is going on with interrupt handling for someone who is not acquainted to it (just as me !).\n\nTherefore I put something C-ish (but too complicated I agree) in there. Without \"sig_on()\", at least it should not lead to a broken situation because the interrupt only gets caught after the C-ish part is finished (but my example is even worse than yours because the C-ish part never ends...).\n\nSo you could just add a line stating that even with sig_on(), \"Failure !\" will not be printed, or a little explanatory paragraph in a note rather than just comments inside sage code.",
    "created_at": "2011-04-07T14:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113544",
    "user": "jpflori"
}
```

I'm sorry to complain a little more about the test you put, but I think putting something python-ish at that place is a bad idea.

Of course because you will actually leave "sig_on()" in "ecl_sig_on()", that won't cause any problems, but if we were to leave out "sig_on()"  we won't see "Failure" printed (the SIGINT will get caught before, and that is the main reason which makes it a bad test for me) and that will completely break interrupt handling (pressing Ctrl-C afterwards will lead you into Lisp debugger, I don't even know how to get out of there without pressing Ctrl+\). So IMHO that is not a good example to clearly understand what is going on with interrupt handling for someone who is not acquainted to it (just as me !).

Therefore I put something C-ish (but too complicated I agree) in there. Without "sig_on()", at least it should not lead to a broken situation because the interrupt only gets caught after the C-ish part is finished (but my example is even worse than yours because the C-ish part never ends...).

So you could just add a line stating that even with sig_on(), "Failure !" will not be printed, or a little explanatory paragraph in a note rather than just comments inside sage code.



---

archive/issue_comments_113545.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-04-07T14:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113545",
    "user": "jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_113546.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-08T08:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113546",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_113547.json:
```json
{
    "body": "Attachment [10818_handlerswap.p3.patch](tarball://root/attachments/some-uuid/ticket10818/10818_handlerswap.p3.patch) by jdemeyer created at 2011-04-08 08:41:49\n\nReplying to [comment:22 jpflori]:\n> Therefore I put something C-ish (but too complicated I agree) in there.\nNow I added an `abort()` which is certainly C-ish.",
    "created_at": "2011-04-08T08:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113547",
    "user": "jdemeyer"
}
```

Attachment [10818_handlerswap.p3.patch](tarball://root/attachments/some-uuid/ticket10818/10818_handlerswap.p3.patch) by jdemeyer created at 2011-04-08 08:41:49

Replying to [comment:22 jpflori]:
> Therefore I put something C-ish (but too complicated I agree) in there.
Now I added an `abort()` which is certainly C-ish.



---

archive/issue_comments_113548.json:
```json
{
    "body": "Thanks, I'm happy with that.",
    "created_at": "2011-04-08T08:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113548",
    "user": "jpflori"
}
```

Thanks, I'm happy with that.



---

archive/issue_comments_113549.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-08T08:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113549",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_113550.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-11T19:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113550",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_113551.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2011-04-14T18:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113551",
    "user": "jdemeyer"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_113552.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2011-04-14T18:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113552",
    "user": "jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_113553.json:
```json
{
    "body": "On OSX 10.6-32 (bsd):\n\n```\nsage -t -long  -force_lib devel/sage/sage/libs/ecl.pyx\nThe doctested process was killed by signal 10\n```\n",
    "created_at": "2011-04-14T18:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113553",
    "user": "jdemeyer"
}
```

On OSX 10.6-32 (bsd):

```
sage -t -long  -force_lib devel/sage/sage/libs/ecl.pyx
The doctested process was killed by signal 10
```




---

archive/issue_comments_113554.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2011-04-14T18:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113554",
    "user": "jdemeyer"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_113555.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> On OSX 10.6-32 (bsd):\n> {{{\n> sage -t -long  -force_lib devel/sage/sage/libs/ecl.pyx\n> The doctested process was killed by signal 10\n> }}}\nWould it be at all possible to have the output of\n\n```\nsage -t -long -verbose -force_lib devel/sage/sage/libs/ecl.pyx\n```\n\non that machine?",
    "created_at": "2011-04-14T21:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113555",
    "user": "fbissey"
}
```

Replying to [comment:26 jdemeyer]:
> On OSX 10.6-32 (bsd):
> {{{
> sage -t -long  -force_lib devel/sage/sage/libs/ecl.pyx
> The doctested process was killed by signal 10
> }}}
Would it be at all possible to have the output of

```
sage -t -long -verbose -force_lib devel/sage/sage/libs/ecl.pyx
```

on that machine?



---

archive/issue_comments_113556.json:
```json
{
    "body": "I'll try to test that on different OSX versions (I guess this is an Intel processor).",
    "created_at": "2011-04-15T06:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113556",
    "user": "jpflori"
}
```

I'll try to test that on different OSX versions (I guess this is an Intel processor).



---

archive/issue_comments_113557.json:
```json
{
    "body": "We need to handle SIGBUS in addition to SIGINT and SIGSEGV.",
    "created_at": "2011-04-16T14:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113557",
    "user": "jdemeyer"
}
```

We need to handle SIGBUS in addition to SIGINT and SIGSEGV.



---

archive/issue_comments_113558.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-16T14:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113558",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_113559.json:
```json
{
    "body": "Attachment [10818_handlerswap.p4.patch](tarball://root/attachments/some-uuid/ticket10818/10818_handlerswap.p4.patch) by kcrisman created at 2011-04-18 15:11:05\n\nI don't have access to bsd, but on my OS X 10.6 Intel laptop and my OS X 10.4 PPC desktop I get, using the command fbissey suggests,\n\n```\n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 4.0 seconds\n```\n\nWell, it was 36.1 seconds on the older machine!  So for what it's worth, the latest patch seems to be ok.  Since this is Jeroen's patch, presumably he tested it works on bsd?",
    "created_at": "2011-04-18T15:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113559",
    "user": "kcrisman"
}
```

Attachment [10818_handlerswap.p4.patch](tarball://root/attachments/some-uuid/ticket10818/10818_handlerswap.p4.patch) by kcrisman created at 2011-04-18 15:11:05

I don't have access to bsd, but on my OS X 10.6 Intel laptop and my OS X 10.4 PPC desktop I get, using the command fbissey suggests,

```
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 4.0 seconds
```

Well, it was 36.1 seconds on the older machine!  So for what it's worth, the latest patch seems to be ok.  Since this is Jeroen's patch, presumably he tested it works on bsd?



---

archive/issue_comments_113560.json:
```json
{
    "body": "Replying to [comment:34 kcrisman]:\n> Since this is Jeroen's patch, presumably he tested it works on bsd?\n\nNo, `bsd` is totally completely utterly unusably slow these days so I can't test it on that machine.  I have sent an email to William about this slowness.",
    "created_at": "2011-04-18T15:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113560",
    "user": "jdemeyer"
}
```

Replying to [comment:34 kcrisman]:
> Since this is Jeroen's patch, presumably he tested it works on bsd?

No, `bsd` is totally completely utterly unusably slow these days so I can't test it on that machine.  I have sent an email to William about this slowness.



---

archive/issue_comments_113561.json:
```json
{
    "body": "Replying to [comment:34 kcrisman]:\n> Since this is Jeroen's patch, presumably he tested it works on bsd?\n\nbsd is fixed now and yes it works on that machine.  Can anybody look at the patch and give a review?",
    "created_at": "2011-04-20T07:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113561",
    "user": "jdemeyer"
}
```

Replying to [comment:34 kcrisman]:
> Since this is Jeroen's patch, presumably he tested it works on bsd?

bsd is fixed now and yes it works on that machine.  Can anybody look at the patch and give a review?



---

archive/issue_comments_113562.json:
```json
{
    "body": "Can you post a diff from previous versions if no one reviews it soon?  It looks ok but it takes me a long time to review this sort of code properly so I don't feel comfortable giving review until I have time to sit down and really parse it.",
    "created_at": "2011-04-20T12:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113562",
    "user": "kcrisman"
}
```

Can you post a diff from previous versions if no one reviews it soon?  It looks ok but it takes me a long time to review this sort of code properly so I don't feel comfortable giving review until I have time to sit down and really parse it.



---

archive/issue_comments_113563.json:
```json
{
    "body": "The only difference with the previous version is that SIGBUS is handled as SIGINT and SIGSEGV now (so basically a line added everytime they are involved).\n\nI think that the code its testcases and its doc are fine, but I don't have the time and the means to test it on any exotic architecture, so I don't really feel like giving it a positive review (last time I let the bsd problem go through).\n\nI'm not an ECL interrupt expert as well, so some other things could be wrong...",
    "created_at": "2011-04-20T12:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113563",
    "user": "jpflori"
}
```

The only difference with the previous version is that SIGBUS is handled as SIGINT and SIGSEGV now (so basically a line added everytime they are involved).

I think that the code its testcases and its doc are fine, but I don't have the time and the means to test it on any exotic architecture, so I don't really feel like giving it a positive review (last time I let the bsd problem go through).

I'm not an ECL interrupt expert as well, so some other things could be wrong...



---

archive/issue_comments_113564.json:
```json
{
    "body": "Replying to [comment:38 jpflori]:\n> I don't have the time and the means to test it on any exotic architecture, so I don't really feel like giving it a positive review\n\n*(speaking as release manager)*\nI don't think that testing on exotic architectures should be a requirement for a patch to get positive_review.  It is much more important to actually look at the patch and check that it makes sense rather than test it on all possible architectures.  Some minimal testing should of course be done (say `-t -long` in directories obviously affected by the patch on at least one system).",
    "created_at": "2011-04-20T13:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113564",
    "user": "jdemeyer"
}
```

Replying to [comment:38 jpflori]:
> I don't have the time and the means to test it on any exotic architecture, so I don't really feel like giving it a positive review

*(speaking as release manager)*
I don't think that testing on exotic architectures should be a requirement for a patch to get positive_review.  It is much more important to actually look at the patch and check that it makes sense rather than test it on all possible architectures.  Some minimal testing should of course be done (say `-t -long` in directories obviously affected by the patch on at least one system).



---

archive/issue_comments_113565.json:
```json
{
    "body": "Replying to [comment:38 jpflori]:\n> I'm not an ECL interrupt expert as well, so some other things could be wrong...\n\nUnfortunately, even I am not an ECL interrupt expert.  However, I tried to write the code in such a way that it doesn't really matter what ECL does.  With the current patch, there is no interaction between Sage interrupt handling and ECL interrupt handling.  We just let ECL deal with all relevant signals.",
    "created_at": "2011-04-20T13:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113565",
    "user": "jdemeyer"
}
```

Replying to [comment:38 jpflori]:
> I'm not an ECL interrupt expert as well, so some other things could be wrong...

Unfortunately, even I am not an ECL interrupt expert.  However, I tried to write the code in such a way that it doesn't really matter what ECL does.  With the current patch, there is no interaction between Sage interrupt handling and ECL interrupt handling.  We just let ECL deal with all relevant signals.



---

archive/issue_comments_113566.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-20T13:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113566",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_113567.json:
```json
{
    "body": "Ok, then I'll put it back as positive review.",
    "created_at": "2011-04-20T13:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113567",
    "user": "jpflori"
}
```

Ok, then I'll put it back as positive review.



---

archive/issue_comments_113568.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-20T15:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10752#issuecomment-113568",
    "user": "jdemeyer"
}
```

Resolution: fixed
