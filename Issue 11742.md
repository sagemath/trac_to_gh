# Issue 11742: `sage -n` fails when current directory is $SAGE_ROOT/devel/sage

Issue created by migration from Trac.

Original creator: kini

Original creation time: 2011-10-11 11:44:03

CC:  ppurka leif

Keywords: startup, crash, sage-env

Traceback as follows:


```
fs`@`zhenghe /opt/sage/devel/sage $ ../../sage -n
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |
| Type notebook() for the GUI, and license() for information.        |
Please wait while the Sage Notebook server starts...
Traceback (most recent call last):
  File "/opt/sage/local/bin/sage-notebook", line 9, in <module>
    from sage.server.notebook.all import notebook
  File "/opt/sage-4.7.2.alpha3/devel/sage-main/sage/server/notebook/all.py", line 22, in <module>
    from sagenb.notebook.all import *
  File "/opt/sage/devel/sagenb/sagenb/notebook/all.py", line 18, in <module>
    from interact import interact, input_box, slider, range_slider, selector, checkbox, input_grid, text_control, color_selector
  File "/opt/sage/devel/sagenb/sagenb/notebook/interact.py", line 158, in <module>
    from sage.misc.cachefunc import cached_method
  File "/opt/sage-4.7.2.alpha3/devel/sage-main/sage/misc/cachefunc.py", line 22, in <module>
    from function_mangling import ArgumentFixer
ImportError: No module named function_mangling
fs`@`zhenghe /opt/sage/devel/sage $ 
```


ppurka suggests prepending `$SAGE_ROOT/devel/sage/build/sage/` to `PYTHONPATH` in `sage-env`. This indeed works, but I'm not sure what else it might break. Advice?


---

Comment by kini created at 2011-10-11 11:50:30

To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.


---

Comment by leif created at 2011-10-11 13:44:02

Replying to [comment:2 kini]:
> To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.

The subdirectory `./sage` was my guess...


---

Comment by leif created at 2011-10-11 14:39:21

Replying to [comment:3 leif]:
> Replying to [comment:2 kini]:
> > To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.
> 
> The subdirectory `./sage` was my guess...


```sh
$ cd $SAGE_ROOT
$ (mkdir -p tmp/sage/sage && cd tmp/sage && ../../sage -n)
```


in contrast works for me.


---

Comment by ppurka created at 2011-10-12 03:20:27

Replying to [comment:4 leif]:
> ` #!sh $ cd $SAGE_ROOT $ (mkdir -p tmp/sage/sage && cd tmp/sage && ../../sage -n) ` in contrast works for me.

But the following doesn't work:

```
cd Installations/sage-4.7/tmp
ln -s ../devel/sage/sage .
../sage -n
```



---

Comment by jhpalmieri created at 2011-10-12 03:53:05

If I delete the file `SAGE_ROOT/devel/sage/sage/__init__.py` (and the corresponding .pyc file if present), then I don't see this problem.  Should that file be autogenerated (as `SAGE_ROOT/local/lib/python/site-packages/sage/__init__.py`, say by the `install` script in devel/sage) when necessary?  Or is that a bad, or a too complicated, idea?


---

Comment by kini created at 2011-10-12 04:01:14

But `$SAGE_ROOT/local/lib/python/site-packages/sage` is a symlink to `$SAGE_ROOT/local/lib/python/site-packages/../../../../devel/sage/build/sage`, which already contains an `__init__.py`. Or am I misunderstanding what you propose to do?


---

Comment by kini created at 2011-10-12 04:02:33

Never mind, I guess you mean we should remove `__init__.py` from `$SAGE_ROOT/devel/sage/sage`. I don't think this is a good idea, as it _is_ part of the Sage library.


---

Comment by jhpalmieri created at 2011-10-12 04:04:35

Or perhaps this patch to the script sage-notebook:

```diff
diff --git a/sage-notebook b/sage-notebook
--- a/sage-notebook
+++ b/sage-notebook
`@``@` -2,6 +2,13 `@``@`
 
 import os, sys, socket
 
+CUR=os.path.abspath(os.curdir)
+if os.path.samefile(CUR, os.path.join(os.environ['SAGE_ROOT'], 'devel', 'sage')):
+    try:
+        sys.path.remove(CUR)
+    except ValueError:
+        pass
+
 print open(os.environ['SAGE_ROOT'] + '/local/bin/sage-banner').read()
 
 print "Please wait while the Sage Notebook server starts..."
```

This looks safer than my first suggestion, although it could be a bit more refined: search sys.path not just for CUR, but for anything which is equivalent to CUR.


---

Comment by kini created at 2011-10-12 04:12:18

That raises the question of whether we want to fix this too:


```
fs`@`zhenghe ~ $ mkdir sage
fs`@`zhenghe ~ $ touch sage/__init__.py
fs`@`zhenghe ~ $ sage -n
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |
| Type notebook() for the GUI, and license() for information.        |
Please wait while the Sage Notebook server starts...
Traceback (most recent call last):
  File "/opt/sage/local/bin/sage-notebook", line 9, in <module>
    from sage.server.notebook.all import notebook
ImportError: No module named server.notebook.all
```



---

Comment by leif created at 2011-10-12 04:17:28

Pffffffff...

How about this:

```diff
diff --git a/sage-env b/sage-env
--- a/sage-env
+++ b/sage-env
`@``@` -186,7 +186,12 `@``@`
 fi
 
 if [ -d "$SAGE_ROOT/local/lib/python" ]; then
-    PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"   && export PYTHONPATH
+    if [ -n "$SAGE_PATH" ]; then
+        PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"
+    else
+        PYTHONPATH="$SAGE_ROOT/local/lib/python"
+    fi
+    export PYTHONPATH
     PYTHONHOME="$SAGE_ROOT/local" && export PYTHONHOME
 fi
 
```


We could make it more nice of course.

This disturbed me for a while now...


---

Comment by leif created at 2011-10-12 04:23:30

Replying to [comment:11 leif]:
> We could make it more nice of course.

Like this for example:


```diff
diff --git a/sage-env b/sage-env
--- a/sage-env
+++ b/sage-env
`@``@` -186,8 +186,13 `@``@`
 fi
 
 if [ -d "$SAGE_ROOT/local/lib/python" ]; then
-    PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"   && export PYTHONPATH
-    PYTHONHOME="$SAGE_ROOT/local" && export PYTHONHOME
+    PYTHONPATH="$SAGE_ROOT/local/lib/python"
+    if [ -n "$SAGE_PATH" ]; then
+        PYTHONPATH="$SAGE_PATH:$PYTHONPATH"
+    fi
+    PYTHONHOME="$SAGE_ROOT/local"
+    export PYTHONPATH
+    export PYTHONHOME
 fi
 
 if [ -z "${SAGE_ORIG_LD_LIBRARY_PATH_SET}" ]; then
```



---

Comment by leif created at 2011-10-12 04:26:24

(I don't know what potentially weird shells might source `sage-env`, otherwise I'd use `export FOO="bar"` or `export FOO BAR` etc.)


---

Comment by kini created at 2011-10-12 04:28:44

What, seriously!? The cause of this is just the colon at the beginning of `PYTHONPATH`? Well then your solution is simple and obviously the correct way to fix this, it seems to me.


---

Comment by leif created at 2011-10-12 04:30:36

Replying to [comment:14 kini]:
> What, seriously!? The cause of this is just the colon at the beginning of `PYTHONPATH`? Well then your solution is simple and obviously the correct way to fix this, it seems to me.

Python interprets the empty entry as the current working directory ("`.`").


---

Comment by ppurka created at 2011-10-12 05:33:13

Replying to [comment:13 leif]:
> (I don't know what potentially weird shells might source `sage-env`, otherwise I'd use `export FOO="bar"` or `export FOO BAR` etc.)

Is sage-env even called from anywhere outside Sage scripts? It seems weird that all the sage scripts are called as `#!/usr/bin/env bash` but the scripts themselves are not written (most of the time) as bash scripts. It should probably be like the `$SAGE_ROOT/sage` script should be POSIX shell compatible and then the rest should be proper bash scripts, since they anyway invoke bash. It will make the scripts nicer and easier to read.

Thanks for the PYTHONPATH fix. Didn't know that empty paths resolve to current directory.


---

Comment by kini created at 2011-10-12 05:42:15

If they are mostly written as POSIX-compatible, why not just go all the way and make them all call `sh` instead, and remove bashisms? But this is getting off topic, I think...

I'll make an hg patch out of leif's diff.


---

Comment by kini created at 2011-10-12 05:43:35

apply to $SAGE_ROOT/local/bin


---

Attachment


---

Comment by kini created at 2011-10-12 05:45:01

Changing status from new to needs_review.


---

Comment by kini created at 2011-10-12 05:45:44

I'll leave formal review to others who know shell scripting better than I, but it looks fine to me, fwiw.


---

Comment by leif created at 2011-10-12 05:58:34

Replying to [comment:17 kini]:
> If they are mostly written as POSIX-compatible, why not just go all the way and make them all call `sh` instead, and remove bashisms? But this is getting off topic, I think...

Hmmm.  In principle we should avoid bashisms whenever possible.  (One of the very few exceptions would IMHO be `set -o pipefail`, which is supported by bashs >=3.0, but we still officially require just 2.04 since this version is shipped with MacOS X 10.4 [which is a mess to support anyway], <flame> and its users are incapable of installing a more recent version </flame>.)

The main reason we use `bash` is that we can to some extent rely on it being functional; there are too many broken Bourne shells, or at least `/bin/sh`ells.




> I'll make an hg patch out of leif's diff.

Nice service, thanks.

I just wonder how many parts of Sage (unconsciously exploiting it) break if we fix this bug.


---

Comment by kini created at 2011-10-12 08:26:31

Well, I'll run a doctest, though I doubt this will catch anything relevant...


---

Comment by ppurka created at 2011-10-12 08:51:04

I don't think anything should break because the following two commands returned no output:

```
...lations/sage-4.7.2 [130] > LC_ALL="C" grep -re 'from [^\.]+[This is the Trac macro *:space:* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#:space:-macro)+import' *
...allations/sage-4.7.2 [1] > LC_ALL="C" grep -re '^[This is the Trac macro *:space:* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#:space:-macro)+import [^\.]+' *
...allations/sage-4.7.2 [1] > 
```



---

Comment by ppurka created at 2011-10-12 08:55:16

Neglect above post. Really weird. It should have returned some output.


---

Comment by kini created at 2011-10-12 09:06:23

All tests pass on `sage.math.washington.edu`, as expected.


---

Comment by leif created at 2011-10-13 11:10:02

Added a reference to #10192.


---

Comment by leif created at 2011-10-13 11:14:07

Changing keywords from "startup, crash, sage-env" to "notebook SageNB startup, crash, sage-env PYTHONPATH".


---

Comment by jhpalmieri created at 2011-10-14 18:45:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-10-17 07:58:18

Resolution: fixed


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted
