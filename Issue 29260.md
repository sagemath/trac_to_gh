# Issue 29260: package symengine and its Python interface

Issue created by migration from https://trac.sagemath.org/ticket/29497

Original creator: vdelecroix

Original creation time: 2020-04-11 11:13:48

CC:  isuruf mkoeppe egourgoulhon

tarballs
- https://github.com/symengine/symengine/archive/v0.6.0.tar.gz
- https://github.com/symengine/symengine.py/archive/v0.6.1.tar.gz


---

Comment by isuruf created at 2020-04-12 02:11:20

Let me know if you run into any trouble.

Here are some of the options I use in conda. https://github.com/conda-forge/symengine-feedstock/blob/master/recipe/build.sh#L6-L19. They should work fine for sage (except for WITH_LLVM=yes)

Dependencies: CMake, GMP/MPIR, MPFR, MPC, FLINT2, ARB


---

Comment by vdelecroix created at 2020-04-12 07:35:56

New commits:


---

Comment by git created at 2020-04-12 07:45:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2020-04-12 07:46:55

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-12 07:50:47

Please add upstream_url to checksums.ini and distros/ Information


---

Comment by vdelecroix created at 2020-04-12 08:06:50

I intentionally did write upstream_url because the tarballs are from github with their tags as names.


---

Comment by git created at 2020-04-12 08:14:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-04-12 08:23:36

(I wanted instead to use the tarball from PyPI for symengine.py but its name is `symengine-0.6.1.tar.gz` which collides with symengine tarballs)


---

Comment by isuruf created at 2020-04-12 12:46:38

`symengine.py` needs cmake as well.


---

Comment by git created at 2020-04-12 12:51:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-12 14:45:26

Replying to [comment:8 vdelecroix]:
> (I wanted instead to use the tarball from PyPI for symengine.py but its name is `symengine-0.6.1.tar.gz` which collides with symengine tarballs)
The `upstream_url` code handles renaming just fine

```diff
diff --git a/build/pkgs/symengine.py/checksums.ini b/build/pkgs/symengine.py/checksums.ini
index ea4c44b468..489d040bcc 100644
--- a/build/pkgs/symengine.py/checksums.ini
+++ b/build/pkgs/symengine.py/checksums.ini
@@ -2,3 +2,4 @@ tarball=symengine.py-VERSION.tar.gz
 sha1=40df2b8f406b6ac4a86c83a82d31593b5738a470
 md5=52b035da7851414d74f3bde83b6c2976
 cksum=2829876300
+upstream_url=https://github.com/symengine/symengine.py/archive/vVERSION.tar.gz
diff --git a/build/pkgs/symengine/checksums.ini b/build/pkgs/symengine/checksums.ini
index 8143c8eae5..b2651f694c 100644
--- a/build/pkgs/symengine/checksums.ini
+++ b/build/pkgs/symengine/checksums.ini
@@ -2,3 +2,4 @@ tarball=symengine-VERSION.tar.gz
 sha1=abd7d39b1b724f47bcdc5b1d811cf33f2c413aea
 md5=3c0df2b14310467c6d45bc26a557324b
 cksum=100973134
+upstream_url=https://github.com/symengine/symengine/archive/vVERSION.tar.gz
```



---

Comment by vdelecroix created at 2020-04-12 14:46:29

Replying to [comment:12 mkoeppe]:
> Replying to [comment:8 vdelecroix]:
> > (I wanted instead to use the tarball from PyPI for symengine.py but its name is `symengine-0.6.1.tar.gz` which collides with symengine tarballs)
> The `upstream_url` code handles renaming just fine

Wunderbar!


---

Comment by git created at 2020-04-12 14:53:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-12 15:09:31

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-12 15:09:31

Builds and tests OK on macOS with python3. Could you add a little bit to the ticket description please - what is it intended to be used for in Sage


---

Comment by isuruf created at 2020-04-12 15:19:07

New commits:


---

Comment by isuruf created at 2020-04-12 15:19:07

Changing status from positive_review to needs_review.


---

Comment by isuruf created at 2020-04-12 15:23:16

`'import symengine; symengine.test()'` uses pytest. Switched to nose


---

Comment by vdelecroix created at 2020-04-12 15:29:38

As tests are not run by default, I don't like this so much

```diff
-symengine $(PYTHON) | cmake pip setuptools
+symengine $(PYTHON) | cmake pip setuptools nose
```

`@`Matthias: how do we solve that when tests depend on additional libraries? (same thing actually hapenning with numpy, rpy2, etc)


---

Comment by mkoeppe created at 2020-04-12 16:02:30

Something like this (untested)?

```diff
--- a/build/pkgs/symengine.py/dependencies
+++ b/build/pkgs/symengine.py/dependencies
@@ -1,4 +1,4 @@
-symengine $(PYTHON) | cmake pip setuptools
+symengine $(PYTHON) | cmake pip setuptools $(and $(filter-out no,$(SAGE_CHECK)), nose)
 
 ----------
 All lines of this file are ignored except the first.
diff --git a/src/bin/sage b/src/bin/sage
index 10acddcd96..2106102952 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -359,6 +359,11 @@ if [ "$1" = '-i' ]; then
                 echo >&2 "Error: 'sage -i $OPT <package>' is no longer supported, use 'sage --info <package>' instead."
                 exit 2;;
             -f) FORCE_INSTALL=yes;;
+            # Setting SAGE_CHECK here duplicates what we do in sage-spkg
+            # but we need it in "make" already when there are (order-only)
+            # dependencies on packages providing test infrastructure
+            -c) INSTALL_OPTIONS="$INSTALL_OPTIONS $OPT"; SAGE_CHECK=yes;;
+            -w) INSTALL_OPTIONS="$INSTALL_OPTIONS $OPT"; SAGE_CHECK=warn;;
             -*) INSTALL_OPTIONS="$INSTALL_OPTIONS $OPT";;
             *) PACKAGES="$PACKAGES $OPT";;
         esac
```



---

Comment by mkoeppe created at 2020-04-12 16:48:26

Forgot `export SAGE_CHECK` obviously


---

Comment by vdelecroix created at 2020-04-13 14:45:18

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2020-04-13 14:45:18

The doctester does not like dot

```
Traceback (most recent call last):
  File "/opt/sage/src/bin/sage-runtests", line 177, in <module>
    DC = DocTestController(options, args)
  File "/opt/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 365, in __init__
    raise ValueError('invalid optional tag {!r}'.format(o))
ValueError: invalid optional tag 'symengine.py'
```



---

Comment by vdelecroix created at 2020-05-14 08:43:39

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-05-14 08:43:39

New commits:


---

Comment by git created at 2020-05-14 09:31:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-05-14 09:34:32

`@`isuruf: I think this ticket is ready for inclusion. Next step is I believe to implement the conversion `Sage -> symengine` (which is not there, right?)


---

Comment by vdelecroix created at 2020-05-14 09:35:06

Changing keywords from "" to "thursdaysbdx".


---

Comment by mkoeppe created at 2020-05-29 21:52:04

Does sympy have to be configured specifically to use this package? Does the package have to be available at installation time of sympy?


---

Comment by isuruf created at 2020-05-29 22:15:28

symengine and sympy can interoperate without any configuration.

There's a feature in sympy enabled by the env variable `USE_SYMENGINE=1` at runtime which will make some modules of sympy use symengine as the core symbolic engine. This is still experimental work.


---

Comment by certik created at 2020-05-29 22:25:07

`@`vdelecroix, thanks for this effort. Let us know what you need, we'll be happy to implement in `SymEngine`.


---

Comment by mkoeppe created at 2020-05-29 22:39:11


```
[symengine_py-0.6.1] Installing symengine_py-0.6.1
[symengine_py-0.6.1] /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/bin/sage-pip-install requires . as final argument
```



---

Comment by mkoeppe created at 2020-05-29 22:39:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-05-30 06:55:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-30 06:56:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-05-30 06:56:31

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-06-01 19:16:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-01 19:16:27

Tests running at https://github.com/mkoeppe/sage/actions/runs/121775190


---

Comment by mkoeppe created at 2020-06-01 19:16:58

Changing keywords from "thursdaysbdx" to "thursdaysbdx, sd109".


---

Comment by mkoeppe created at 2020-06-02 19:10:07

`symengine_py` build fails:

```
    running build_ext
    error: error in command line: command 'BuildExtWithCmake' has no such option 'no_user_cfg'
    Running setup.py install for symengine: finished with status 'error'
```

(see https://github.com/mkoeppe/sage/runs/728445828?check_suite_focus=true)


---

Comment by mkoeppe created at 2020-06-02 19:10:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-07-04 22:22:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-04 22:22:29

Rebased on 9.2.beta3


---

Comment by git created at 2020-07-04 23:41:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-04 23:41:59

Tests run at https://github.com/mkoeppe/sage/actions/runs/157858355


---

Comment by mkoeppe created at 2020-07-04 23:45:03

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-07-05 06:28:41

Maybe

```
-upstream_url=https://github.com/symengine/symengine/releases/download/v0.6.0/symengine-VERSION.tar.gz
+upstream_url=https://github.com/symengine/symengine/releases/download/vVERSION/symengine-VERSION.tar.gz
```



---

Comment by git created at 2020-07-05 07:27:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-05 16:58:48

Replying to [comment:43 mkoeppe]:
> Tests run at https://github.com/mkoeppe/sage/actions/runs/157858355
The docker-based tests didn't go through because they are broken in 9.2.beta3 (#30064 has the fix).

But the `cygwin-standard` build (https://github.com/mkoeppe/sage/runs/838016220) reveals a build problem:

```
[arb-2.16.0.p0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/arb-2.16.0.p0.log
[ecm-7.0.4.p1] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/ecm-7.0.4.p1.log
  [ecm-7.0.4.p1] successfully installed.
  [arb-2.16.0.p0] successfully installed.
sage-logger -p 'sage-spkg -y -o  symengine-0.6.0' '/cygdrive/d/a/sage/sage/logs/pkgs/symengine-0.6.0.log'
[symengine-0.6.0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/symengine-0.6.0.log
  [symengine-0.6.0] error installing, exit status 1. End of log file:
  [symengine-0.6.0]   -- Check size of long double
  [symengine-0.6.0]   -- Check size of long double - done
  [symengine-0.6.0]   -- Found GMP: /usr/lib/libgmp.dll.a  
  [symengine-0.6.0]   -- Found ECM: /cygdrive/d/a/sage/sage/local/lib/libecm.dll.a  
  [symengine-0.6.0]   -- Found FLINT: /usr/lib/libflint.dll.a  
  [symengine-0.6.0]   CMake Error at /usr/share/cmake-3.14.5/Modules/FindPackageHandleStandardArgs.cmake:137 (message):
  [symengine-0.6.0]     Could NOT find ARB (missing: ARB_LIBRARIES)
  [symengine-0.6.0]   Call Stack (most recent call first):
  [symengine-0.6.0]     /usr/share/cmake-3.14.5/Modules/FindPackageHandleStandardArgs.cmake:378 (_FPHSA_FAILURE_MESSAGE)
  [symengine-0.6.0]     cmake/FindARB.cmake:11 (find_package_handle_standard_args)
  [symengine-0.6.0]     CMakeLists.txt:336 (find_package)
  [symengine-0.6.0]   
  [symengine-0.6.0]   
  [symengine-0.6.0]   -- Configuring incomplete, errors occurred!
```



---

Comment by mkoeppe created at 2020-07-05 17:01:24

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2020-07-05 18:00:33

This is an issue with arb not installing the import library on windows. https://github.com/fredrik-johansson/arb/pull/315 should fix it


---

Comment by git created at 2020-07-05 18:36:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-11 22:06:41

Replying to [comment:49 isuruf]:
> This is an issue with arb not installing the import library on windows. https://github.com/fredrik-johansson/arb/pull/315 should fix it

It's marked as a draft - should we be testing it here on the ticket?


---

Comment by git created at 2020-07-11 22:47:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-11 22:48:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-12 05:13:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-01-18 17:37:40

Replying to [comment:31 certik]:
> `@`vdelecroix, thanks for this effort. Let us know what you need, we'll be happy to implement in `SymEngine`.

How about Documentation? :-)


---

Comment by @bollu created at 2021-01-19 12:57:28

`@`dimpase: What kind of documentation would help? I'm also interested in pushing this along!


---

Comment by git created at 2021-01-20 00:29:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-01-20 00:29:59

Rebased on current develop


---

Comment by git created at 2021-01-20 00:54:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-20 01:06:08

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-01-20 01:06:08

I've updated the package metadata. Ready for review.


---

Comment by vdelecroix created at 2021-02-17 15:15:49

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2021-02-17 15:15:49

Install worked fine and tests pass! Time to move forward.


---

Comment by mkoeppe created at 2021-02-17 15:21:50

Great, thanks.


---

Comment by vbraun created at 2021-03-01 00:20:57

Resolution: fixed
