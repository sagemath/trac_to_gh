# Issue 18279: Posets: canonical_label() returns a poset from lattice

Issue created by migration from https://trac.sagemath.org/ticket/18516

Original creator: jmantysalo

Original creation time: 2015-05-26 11:20:19

CC:  ncohen


```
sage: L=LatticePoset({1:[2]}); L
Finite lattice containing 2 elements
sage: L.canonical_label()
Finite poset containing 2 elements
```


Canonically relabeling a (semi)lattice should return a (semi)lattice. (Compare to `.relabel()`.)


---

Comment by jmantysalo created at 2015-05-26 12:46:50

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2015-05-26 12:46:50

Simple correction.
----
New commits:


---

Comment by ncohen created at 2015-05-26 12:49:13

Hellooooo,

Why wouldn't just call `FinitePoset.relabel` which already handles that?

Nathann


---

Comment by ncohen created at 2015-05-26 12:49:20

Changing status from needs_review to needs_info.


---

Comment by jmantysalo created at 2015-05-26 13:02:02

Replying to [comment:3 ncohen]:

> Why wouldn't just call `FinitePoset.relabel` which already handles that?

I don't understand. How? Calling `canonical_label` from DiGraph gives a DiGraph, not a dictionary that could be directly used for `relabel()`.


---

Comment by ncohen created at 2015-05-26 13:09:50

> I don't understand. How? Calling `canonical_label` from DiGraph gives a DiGraph, not a dictionary that could be directly used for `relabel()`.


```
sage: graphs.PetersenGraph().canonical_label(certify=True)
(Graph on 10 vertices,
 {0: 9, 1: 8, 2: 5, 3: 4, 4: 6, 5: 7, 6: 2, 7: 3, 8: 1, 9: 0})
```


Honestly I don't see why `canonical_label` should always return a copy of the graph. In this present case, we see that it is not necessary at all `O_o`

Nathann


---

Comment by jmantysalo created at 2015-05-26 13:39:14

OK. But actually... How is `self.canonical_label()` different from `Poset(self._hasse_diagram, linear_extension=self._with_linear_extension, category=self.category(), facade=self._is_facade)`? I.e. when is canonical label of Hasse diagram not already on canonically numbered?


---

Comment by ncohen created at 2015-05-26 13:40:55

> I.e. when is canonical label of Hasse diagram not already on canonically numbered?

I am not sure I understand your question, but there is no reason why `_hasse_diagram` should be canonically labelled by default, even though it is integer-valued.


---

Comment by ncohen created at 2015-05-26 13:42:06

The point of using `FinitePoset.relabel` directly is that it handles the 'class' (`Lattice`, `MeetSemiLattice`, ...) already.


---

Comment by jmantysalo created at 2015-05-26 13:54:49

OK, so you mean to convert this to oneliner


```
self.relabel(self.cover_relations_graph().canonical_label(certify=True)[1])
```


? Then `relabel()` will take care of facade property, poset vs. lattice -thing and so on.


---

Comment by ncohen created at 2015-05-26 14:05:44

> {{{
> self.relabel(self.cover_relations_graph().canonical_label(certify=True)[1])
> }}}
> 
> ? Then `relabel()` will take care of facade property, poset vs. lattice -thing and so on.

Yep, that's the idea. Though you can avoid creating a copy of the graph by:
1) computing the canonical label on _hasse_diagram
2) "relabel the canonical label" using the correspondance between _hasse_diagram vertices and poset vertices
3) call relabel on the poset itself with the "relabelled" canonical label

Nathann


---

Comment by jmantysalo created at 2015-05-26 16:38:35

Uh, got a headache. So you mean


```
self.relabel({self._list[e]:e for e in self._hasse_diagram.canonical_label(certify=True)[1]})
```


?


---

Comment by ncohen created at 2015-05-27 11:28:18

I added a commit at public/18516.

It also fixes a bug, as the embedded linear extension seemed to be excluded from the relabelling.

Nathann


---

Comment by jmantysalo created at 2015-05-27 12:23:38

Replying to [comment:13 ncohen]:

> I added a commit at public/18516.

Why those `# random` parts on doctests? And isn't `sorted` unneeded, as the order of 'a' and 'b' is always the same?

Also you say that this issue is now corrected, but give an example with `relabel` function, not with `canonical_relabel`?


---

Comment by ncohen created at 2015-05-27 12:31:08

Hello !

> Why those `# random` parts on doctests?

Because the doctests wrongly assume that the canonical label should never change. We had this problem with bliss: the canonical labels it returns are different from the ones returned by 'native' Sage.

A labelling is 'canonical' in the sense that two isomorphic object will be relabelled to the same object. This being said, nothing says that a canonical label never changes in time, and in particular the documentation of Nauty says explicitly that it will.

> And isn't `sorted` unneeded, as the order of 'a' and 'b' is always the same?

I am not sure. These letters will be stored on dictionaries, and you never know what happens with dictionaires on different architectures. Anyway I removed that, because of your next comment:

> Also you say that this issue is now corrected, but give an example with `relabel` function, not with `canonical_relabel`? 

My mistake. I added another commit at the same location.

Nathann


---

Comment by jmantysalo created at 2015-05-27 12:35:13

Replying to [comment:15 ncohen]:

> A labelling is 'canonical' in the sense that two isomorphic object will be relabelled to the same object. This being said, nothing says that a canonical label never changes in time, and in particular the documentation of Nauty says explicitly that it will.

OK. It seems to be good now, but I don't have time to test it just now.


---

Comment by jmantysalo created at 2015-05-27 15:56:32

New commits:


---

Comment by git created at 2015-05-27 16:15:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-05-27 16:26:49

After canonical relabeling we should be sure of the *elements* of the poset, even if not sure of their *position*, i.e. cover relations. Hence I removed a `# random`. But it seems that `sorted` does not work. Strange, what did I forgot?

I also moved a part of documentation from tests to examples.

Maybe these were stupid changes and should be reverted.


---

Comment by git created at 2015-05-27 16:29:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-05-27 16:30:44

I should not code today. There is no order for non-facade elements.


---

Comment by ncohen created at 2015-05-27 16:31:54

> I should not code today. There is no order for non-facade elements.

Yeah. I hate those things.


---

Comment by git created at 2015-06-09 09:08:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-06-09 09:10:03

OK, now it should work.


---

Comment by jmantysalo created at 2015-06-09 09:10:03

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2015-06-09 13:14:54

Yep !


---

Comment by ncohen created at 2015-06-09 13:14:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-11 13:50:55

Resolution: fixed
