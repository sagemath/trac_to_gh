# Issue 11450: Add some targets to the top-level Makefile (and other make-related issues)

archive/issues_011450.json:
```json
{
    "body": "Assignee: @nexttime\n\nCC:  @kiwifb @jdemeyer @jhpalmieri\n\nKeywords: make upgrade documentation rebuild parallel sequential SAGE_CHECK SAGE_PARALLEL_SPKG_BUILD\n\nThis perhaps just gets a meta-ticket to collect various additions (or changes), to be discussed and implemented on their own tickets.\n\nThere are a few things I would like to have a `make` target for, partially just for convenience (at the moment random choice / incomplete, random order):\n* `rebuild` as a short-cut (or, more precisely, the user interface) to the currently (intentionally) undocumented\n\n```sh\nenv SAGE_UPGRADING=yes make build\n```\n\n   which builds new / updated spkgs copied to `spkg/standard/` and also forces the rebuild of all dependent packages.\n* `build-check`, perhaps also `all-check`, as an \"alias\" for\n\n```sh\nenv SAGE_CHECK=yes make build\n```\n\n* `build-check-ignore` once we support `SAGE_CHECK=ignore` to (build and) run all test suites without treating failed tests as fatal errors (since e.g. the Python test suite fails on many systems)\n* `build-parallel` or something like that to build Sage in parallel with a default number of jobs (preferably the number of cores or hardware threads), or at least (currently just) setting `SAGE_PARALLEL_SPKG_BUILD=yes` and doing the usual thing\n* `build-sequential` in case we one day default to a parallel build\n* similar things for `doc` (see below) and `all`\n* perhaps `library` as an alias for `./sage -b`\n* ...\n\nI could imagine to also have\n* different targets to build the documentation sequentially or in parallel (cf. #6495),\n* ...\n\n**Please add further suggestions (and the tickets implementing them).**\n\n----\n\nRelated:\n\n* As of Sage 4.7.1.rc0, running `./sage -b` before running tests is currently not performed consistently. It's perhaps discussable whether we should do that in *all* test receipts or none of them, or provide *separate* targets which do that (which is a trivial task except for the choice of names).\n\n\n* The current behaviour of `devel/sage/setup.py` w.r.t. to parallel building is IMHO undesirable or sub-optimal:\n  * It uses the number of hardware threads even if `MAKE` isn't set (*of course<sup>TM</sup>* regardless of the system load). (If `MAKE` is set to e.g. `make -j`, which means an \"unlimited\" number of jobs, it uses twice the number of hardware threads.) \n\n    One can of course circumvent that by setting `MAKE` to `make -j1`, but that's IMHO kind of odd.\n  * It complains about an *\"impossibly large number of threads\"* if the number of jobs (`-j...`) found in `$MAKE` exceeds twice the number of hardware threads, where the number of hardware threads is equal to the number of cores on processors without what Intel calls Hyper-Threading (HT), then falling back to (at most) the number of hardware threads.\n\n\n* We should stop unsetting `MAKEFLAGS` and setting `MAKE` to `make` whenever `SAGE_PARALLEL_SPKG_BUILD!=yes` in `spkg/install`, which is simply wrong for a couple of reasons:\n  * It invalidates e.g. `MAKE=gmake`.\n  * It clears all flags passed to `make` on the command line as well as those eventually added in `MAKE` (or to `MAKEFLAGS`), e.g. `-d`, `-k` (`--keep-going`), and even `-n` (`--dry-run`) and `-q`. \n\n\n It should instead (if at all) just add `-j1` to `MAKE` if `SAGE_PARALLEL_SPKG_BUILD!=yes`. \n\n\n Oh, just noticed this has meanwhile slightly changed (but don't want to rewrite all the above):\n\n```sh\nif [ \"$SAGE_PARALLEL_SPKG_BUILD\" = \"yes\" ] && [ -n \"$MAKE\" ]; then\n    time $MAKE -f standard/deps $1\nelse\n    time make -f standard/deps $1\nfi\n```\n\n So we do no longer clear `MAKEFLAGS`, but not using `$MAKE` there remains. (And this won't prevent a parallel build invoked through `-j` without a number of jobs.) Note that `MAKE` will always be set at that point, unless some user tries to call `spkg/install` directly (or doesn't use GNU `make`), which is an error condition by itself, to be catched separately.\n\n\n* The sequence top-level Makefile (`make`) -> `spkg/install` (shell script) -> `spkg/standard/deps`, another Makefile run by a *different* `make` instance is IMHO bad and not necessary anyway, since it is possible to set all environment (or `make`) variables in `spkg/standard/deps` (ill name for a Makefile that isn't included by another one) itself. \n\n  Changing this is of course a bigger task. (We have to keep the two-stage make procedure, i.e. two separate Makefiles, to support upgrading at least, which I think isn't bad since it is more modular.)\n\n----\n\nIn case we disagree or have contrary opinions on / suggestions for some changes or in design, we can move the discussion of *individual aspects* to `sage-devel` (or `sage-release` :-) ) threads, but we IMHO shouldn't move the *whole* discussion there. There'll certainly be follow-up or \"real\" (non-meta) tickets anyway, so it should be possible to not mix up different aspects in a single thread.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11622\n\n",
    "created_at": "2011-07-24T21:56:36Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Add some targets to the top-level Makefile (and other make-related issues)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11450",
    "user": "https://github.com/nexttime"
}
```
Assignee: @nexttime

CC:  @kiwifb @jdemeyer @jhpalmieri

Keywords: make upgrade documentation rebuild parallel sequential SAGE_CHECK SAGE_PARALLEL_SPKG_BUILD

This perhaps just gets a meta-ticket to collect various additions (or changes), to be discussed and implemented on their own tickets.

There are a few things I would like to have a `make` target for, partially just for convenience (at the moment random choice / incomplete, random order):
* `rebuild` as a short-cut (or, more precisely, the user interface) to the currently (intentionally) undocumented

```sh
env SAGE_UPGRADING=yes make build
```

   which builds new / updated spkgs copied to `spkg/standard/` and also forces the rebuild of all dependent packages.
* `build-check`, perhaps also `all-check`, as an "alias" for

```sh
env SAGE_CHECK=yes make build
```

* `build-check-ignore` once we support `SAGE_CHECK=ignore` to (build and) run all test suites without treating failed tests as fatal errors (since e.g. the Python test suite fails on many systems)
* `build-parallel` or something like that to build Sage in parallel with a default number of jobs (preferably the number of cores or hardware threads), or at least (currently just) setting `SAGE_PARALLEL_SPKG_BUILD=yes` and doing the usual thing
* `build-sequential` in case we one day default to a parallel build
* similar things for `doc` (see below) and `all`
* perhaps `library` as an alias for `./sage -b`
* ...

I could imagine to also have
* different targets to build the documentation sequentially or in parallel (cf. #6495),
* ...

**Please add further suggestions (and the tickets implementing them).**

----

Related:

* As of Sage 4.7.1.rc0, running `./sage -b` before running tests is currently not performed consistently. It's perhaps discussable whether we should do that in *all* test receipts or none of them, or provide *separate* targets which do that (which is a trivial task except for the choice of names).


* The current behaviour of `devel/sage/setup.py` w.r.t. to parallel building is IMHO undesirable or sub-optimal:
  * It uses the number of hardware threads even if `MAKE` isn't set (*of course<sup>TM</sup>* regardless of the system load). (If `MAKE` is set to e.g. `make -j`, which means an "unlimited" number of jobs, it uses twice the number of hardware threads.) 

    One can of course circumvent that by setting `MAKE` to `make -j1`, but that's IMHO kind of odd.
  * It complains about an *"impossibly large number of threads"* if the number of jobs (`-j...`) found in `$MAKE` exceeds twice the number of hardware threads, where the number of hardware threads is equal to the number of cores on processors without what Intel calls Hyper-Threading (HT), then falling back to (at most) the number of hardware threads.


* We should stop unsetting `MAKEFLAGS` and setting `MAKE` to `make` whenever `SAGE_PARALLEL_SPKG_BUILD!=yes` in `spkg/install`, which is simply wrong for a couple of reasons:
  * It invalidates e.g. `MAKE=gmake`.
  * It clears all flags passed to `make` on the command line as well as those eventually added in `MAKE` (or to `MAKEFLAGS`), e.g. `-d`, `-k` (`--keep-going`), and even `-n` (`--dry-run`) and `-q`. 


 It should instead (if at all) just add `-j1` to `MAKE` if `SAGE_PARALLEL_SPKG_BUILD!=yes`. 


 Oh, just noticed this has meanwhile slightly changed (but don't want to rewrite all the above):

```sh
if [ "$SAGE_PARALLEL_SPKG_BUILD" = "yes" ] && [ -n "$MAKE" ]; then
    time $MAKE -f standard/deps $1
else
    time make -f standard/deps $1
fi
```

 So we do no longer clear `MAKEFLAGS`, but not using `$MAKE` there remains. (And this won't prevent a parallel build invoked through `-j` without a number of jobs.) Note that `MAKE` will always be set at that point, unless some user tries to call `spkg/install` directly (or doesn't use GNU `make`), which is an error condition by itself, to be catched separately.


* The sequence top-level Makefile (`make`) -> `spkg/install` (shell script) -> `spkg/standard/deps`, another Makefile run by a *different* `make` instance is IMHO bad and not necessary anyway, since it is possible to set all environment (or `make`) variables in `spkg/standard/deps` (ill name for a Makefile that isn't included by another one) itself. 

  Changing this is of course a bigger task. (We have to keep the two-stage make procedure, i.e. two separate Makefiles, to support upgrading at least, which I think isn't bad since it is more modular.)

----

In case we disagree or have contrary opinions on / suggestions for some changes or in design, we can move the discussion of *individual aspects* to `sage-devel` (or `sage-release` :-) ) threads, but we IMHO shouldn't move the *whole* discussion there. There'll certainly be follow-up or "real" (non-meta) tickets anyway, so it should be possible to not mix up different aspects in a single thread.

Issue created by migration from https://trac.sagemath.org/ticket/11622





---

archive/issue_comments_127620.json:
```json
{
    "body": "There are some changes to the top-level `Makefile` at #11969, needs_review.",
    "created_at": "2011-11-04T09:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127620",
    "user": "https://github.com/jdemeyer"
}
```

There are some changes to the top-level `Makefile` at #11969, needs_review.



---

archive/issue_comments_127621.json:
```json
{
    "body": "Replying to [ticket:11622 leif]:\n>  * `build-check-ignore` once we support `SAGE_CHECK=ignore` to (build and) run all test suites without treating failed tests as fatal errors (since e.g. the Python test suite fails on many systems)\nWe don't have `SAGE_CHECK=ignore` yet, so this isn't applicable.\n\n>  * `build-sequential` in case we one day default to a parallel build\nWell, we don't build in parallel by default.\n\n>  * perhaps `library` as an alias for `./sage -b`\nVery bad idea. We shouldn't encourage `./sage -b`, just run `make` or `make build` or `make sagelib` if needed.",
    "created_at": "2015-09-16T08:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127621",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:11622 leif]:
>  * `build-check-ignore` once we support `SAGE_CHECK=ignore` to (build and) run all test suites without treating failed tests as fatal errors (since e.g. the Python test suite fails on many systems)
We don't have `SAGE_CHECK=ignore` yet, so this isn't applicable.

>  * `build-sequential` in case we one day default to a parallel build
Well, we don't build in parallel by default.

>  * perhaps `library` as an alias for `./sage -b`
Very bad idea. We shouldn't encourage `./sage -b`, just run `make` or `make build` or `make sagelib` if needed.



---

archive/issue_comments_127622.json:
```json
{
    "body": "Replying to [ticket:11622 leif]:\n>  It's perhaps discussable whether we should do that in *all* test receipts\nIt is done in all test targets.",
    "created_at": "2015-09-16T08:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127622",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:11622 leif]:
>  It's perhaps discussable whether we should do that in *all* test receipts
It is done in all test targets.



---

archive/issue_comments_127623.json:
```json
{
    "body": "Replying to [ticket:11622 leif]:\n>  * The current behaviour of `devel/sage/setup.py` w.r.t. to parallel building is IMHO undesirable or sub-optimal:\n>    * It uses the number of hardware threads even if `MAKE` isn't set (*of course<sup>TM</sup>* regardless of the system load). (If `MAKE` is set to e.g. `make -j`, which means an \"unlimited\" number of jobs, it uses twice the number of hardware threads.) \n\n>      One can of course circumvent that by setting `MAKE` to `make -j1`, but that's IMHO kind of odd.\n>    * It complains about an *\"impossibly large number of threads\"* if the number of jobs (`-j...`) found in `$MAKE` exceeds twice the number of hardware threads, where the number of hardware threads is equal to the number of cores on processors without what Intel calls Hyper-Threading (HT), then falling back to (at most) the number of hardware threads.\n\nNeither of this is still true.",
    "created_at": "2015-09-16T08:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127623",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:11622 leif]:
>  * The current behaviour of `devel/sage/setup.py` w.r.t. to parallel building is IMHO undesirable or sub-optimal:
>    * It uses the number of hardware threads even if `MAKE` isn't set (*of course<sup>TM</sup>* regardless of the system load). (If `MAKE` is set to e.g. `make -j`, which means an "unlimited" number of jobs, it uses twice the number of hardware threads.) 

>      One can of course circumvent that by setting `MAKE` to `make -j1`, but that's IMHO kind of odd.
>    * It complains about an *"impossibly large number of threads"* if the number of jobs (`-j...`) found in `$MAKE` exceeds twice the number of hardware threads, where the number of hardware threads is equal to the number of cores on processors without what Intel calls Hyper-Threading (HT), then falling back to (at most) the number of hardware threads.

Neither of this is still true.



---

archive/issue_comments_127624.json:
```json
{
    "body": "Replying to [ticket:11622 leif]:\n> it is possible to set all environment variables in `build/make/Makefile` itself.\nI don't think so (or at least, I don't know how to do it). In any case, I don't see the point of *repeating* all environment variables in `build/make/Makefile`, what's wrong with keeping the use of `sage-env`?",
    "created_at": "2015-09-16T08:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127624",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:11622 leif]:
> it is possible to set all environment variables in `build/make/Makefile` itself.
I don't think so (or at least, I don't know how to do it). In any case, I don't see the point of *repeating* all environment variables in `build/make/Makefile`, what's wrong with keeping the use of `sage-env`?



---

archive/issue_comments_127625.json:
```json
{
    "body": "Replying to [ticket:11622 leif]:\n>  * `build-sequential` in case we one day default to a parallel build\nWe still don't do that by default.",
    "created_at": "2015-09-16T08:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127625",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:11622 leif]:
>  * `build-sequential` in case we one day default to a parallel build
We still don't do that by default.



---

archive/issue_comments_127626.json:
```json
{
    "body": "I propose to use `pbuild` and `pall` as target names, by analogy to `ptest(long)`.\n\nI don't see the need for a target `pdoc` (I never need to run `make doc`, I just run `make` which is mostly the same anyway).",
    "created_at": "2015-09-16T08:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127626",
    "user": "https://github.com/jdemeyer"
}
```

I propose to use `pbuild` and `pall` as target names, by analogy to `ptest(long)`.

I don't see the need for a target `pdoc` (I never need to run `make doc`, I just run `make` which is mostly the same anyway).



---

archive/issue_comments_127627.json:
```json
{
    "body": "Outdated, should close",
    "created_at": "2021-08-26T19:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127627",
    "user": "https://github.com/mkoeppe"
}
```

Outdated, should close



---

archive/issue_comments_127628.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-26T19:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127628",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_127629.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-26T21:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127629",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_127630.json:
```json
{
    "body": "There might be something with some validity here, but we can always open a new ticket with a more clear focus.",
    "created_at": "2021-08-26T21:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127630",
    "user": "https://github.com/jhpalmieri"
}
```

There might be something with some validity here, but we can always open a new ticket with a more clear focus.



---

archive/issue_comments_127631.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-09-02T18:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11450#issuecomment-127631",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid
