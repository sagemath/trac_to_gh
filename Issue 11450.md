# Issue 11450: Add some targets to the top-level Makefile (and other make-related issues)

Issue created by migration from https://trac.sagemath.org/ticket/11622

Original creator: leif

Original creation time: 2011-07-24 21:56:36

Assignee: leif

CC:  fbissey jdemeyer jhpalmieri

Keywords: make upgrade documentation rebuild parallel sequential SAGE_CHECK SAGE_PARALLEL_SPKG_BUILD

This perhaps just gets a meta-ticket to collect various additions (or changes), to be discussed and implemented on their own tickets.

There are a few things I would like to have a `make` target for, partially just for convenience (at the moment random choice / incomplete, random order):
 * `rebuild` as a short-cut (or, more precisely, the user interface) to the currently (intentionally) undocumented

```sh
env SAGE_UPGRADING=yes make build
```

   which builds new / updated spkgs copied to `spkg/standard/` and also forces the rebuild of all dependent packages.
 * `build-check`, perhaps also `all-check`, as an "alias" for

```sh
env SAGE_CHECK=yes make build
```

 * `build-check-ignore` once we support `SAGE_CHECK=ignore` to (build and) run all test suites without treating failed tests as fatal errors (since e.g. the Python test suite fails on many systems)
 * `build-parallel` or something like that to build Sage in parallel with a default number of jobs (preferably the number of cores or hardware threads), or at least (currently just) setting `SAGE_PARALLEL_SPKG_BUILD=yes` and doing the usual thing
 * `build-sequential` in case we one day default to a parallel build
 * similar things for `doc` (see below) and `all`
 * perhaps `library` as an alias for `./sage -b`
 * ...

I could imagine to also have
 * different targets to build the documentation sequentially or in parallel (cf. #6495),
 * ...

*Please add further suggestions (and the tickets implementing them).*

----

Related:

 * As of Sage 4.7.1.rc0, running `./sage -b` before running tests is currently not performed consistently. It's perhaps discussable whether we should do that in _all_ test receipts or none of them, or provide _separate_ targets which do that (which is a trivial task except for the choice of names).


 * The current behaviour of `devel/sage/setup.py` w.r.t. to parallel building is IMHO undesirable or sub-optimal:
   * It uses the number of hardware threads even if `MAKE` isn't set (_of course<sup>TM</sup>_ regardless of the system load). (If `MAKE` is set to e.g. `make -j`, which means an "unlimited" number of jobs, it uses twice the number of hardware threads.) 

     One can of course circumvent that by setting `MAKE` to `make -j1`, but that's IMHO kind of odd.
   * It complains about an _"impossibly large number of threads"_ if the number of jobs (`-j...`) found in `$MAKE` exceeds twice the number of hardware threads, where the number of hardware threads is equal to the number of cores on processors without what Intel calls Hyper-Threading (HT), then falling back to (at most) the number of hardware threads.


 * We should stop unsetting `MAKEFLAGS` and setting `MAKE` to `make` whenever `SAGE_PARALLEL_SPKG_BUILD!=yes` in `spkg/install`, which is simply wrong for a couple of reasons:
   * It invalidates e.g. `MAKE=gmake`.
   * It clears all flags passed to `make` on the command line as well as those eventually added in `MAKE` (or to `MAKEFLAGS`), e.g. `-d`, `-k` (`--keep-going`), and even `-n` (`--dry-run`) and `-q`. 


 It should instead (if at all) just add `-j1` to `MAKE` if `SAGE_PARALLEL_SPKG_BUILD!=yes`. 


 Oh, just noticed this has meanwhile slightly changed (but don't want to rewrite all the above):

```sh
if [ "$SAGE_PARALLEL_SPKG_BUILD" = "yes" ] && [ -n "$MAKE" ]; then
    time $MAKE -f standard/deps $1
else
    time make -f standard/deps $1
fi
```

 So we do no longer clear `MAKEFLAGS`, but not using `$MAKE` there remains. (And this won't prevent a parallel build invoked through `-j` without a number of jobs.) Note that `MAKE` will always be set at that point, unless some user tries to call `spkg/install` directly (or doesn't use GNU `make`), which is an error condition by itself, to be catched separately.


 * The sequence top-level Makefile (`make`) -> `spkg/install` (shell script) -> `spkg/standard/deps`, another Makefile run by a _different_ `make` instance is IMHO bad and not necessary anyway, since it is possible to set all environment (or `make`) variables in `spkg/standard/deps` (ill name for a Makefile that isn't included by another one) itself. 

   Changing this is of course a bigger task. (We have to keep the two-stage make procedure, i.e. two separate Makefiles, to support upgrading at least, which I think isn't bad since it is more modular.)

----

In case we disagree or have contrary opinions on / suggestions for some changes or in design, we can move the discussion of _individual aspects_ to `sage-devel` (or `sage-release` :-) ) threads, but we IMHO shouldn't move the _whole_ discussion there. There'll certainly be follow-up or "real" (non-meta) tickets anyway, so it should be possible to not mix up different aspects in a single thread.


---

Comment by jdemeyer created at 2011-11-04 09:18:57

There are some changes to the top-level `Makefile` at #11969, needs_review.


---

Comment by jdemeyer created at 2015-09-16 08:30:45

Replying to [ticket:11622 leif]:
>  * `build-check-ignore` once we support `SAGE_CHECK=ignore` to (build and) run all test suites without treating failed tests as fatal errors (since e.g. the Python test suite fails on many systems)
We don't have `SAGE_CHECK=ignore` yet, so this isn't applicable.

>  * `build-sequential` in case we one day default to a parallel build
Well, we don't build in parallel by default.

>  * perhaps `library` as an alias for `./sage -b`
Very bad idea. We shouldn't encourage `./sage -b`, just run `make` or `make build` or `make sagelib` if needed.


---

Comment by jdemeyer created at 2015-09-16 08:32:12

Replying to [ticket:11622 leif]:
>  It's perhaps discussable whether we should do that in _all_ test receipts
It is done in all test targets.


---

Comment by jdemeyer created at 2015-09-16 08:33:21

Replying to [ticket:11622 leif]:
>  * The current behaviour of `devel/sage/setup.py` w.r.t. to parallel building is IMHO undesirable or sub-optimal:
>    * It uses the number of hardware threads even if `MAKE` isn't set (_of course<sup>TM</sup>_ regardless of the system load). (If `MAKE` is set to e.g. `make -j`, which means an "unlimited" number of jobs, it uses twice the number of hardware threads.) 

>      One can of course circumvent that by setting `MAKE` to `make -j1`, but that's IMHO kind of odd.
>    * It complains about an _"impossibly large number of threads"_ if the number of jobs (`-j...`) found in `$MAKE` exceeds twice the number of hardware threads, where the number of hardware threads is equal to the number of cores on processors without what Intel calls Hyper-Threading (HT), then falling back to (at most) the number of hardware threads.

Neither of this is still true.


---

Comment by jdemeyer created at 2015-09-16 08:39:42

Replying to [ticket:11622 leif]:
> it is possible to set all environment variables in `build/make/Makefile` itself.
I don't think so (or at least, I don't know how to do it). In any case, I don't see the point of _repeating_ all environment variables in `build/make/Makefile`, what's wrong with keeping the use of `sage-env`?


---

Comment by jdemeyer created at 2015-09-16 08:46:38

Replying to [ticket:11622 leif]:
>  * `build-sequential` in case we one day default to a parallel build
We still don't do that by default.


---

Comment by jdemeyer created at 2015-09-16 08:50:51

I propose to use `pbuild` and `pall` as target names, by analogy to `ptest(long)`.

I don't see the need for a target `pdoc` (I never need to run `make doc`, I just run `make` which is mostly the same anyway).


---

Comment by mkoeppe created at 2021-08-26 19:08:56

Outdated, should close


---

Comment by mkoeppe created at 2021-08-26 19:08:56

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-08-26 21:18:09

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-08-26 21:18:09

There might be something with some validity here, but we can always open a new ticket with a more clear focus.


---

Comment by mkoeppe created at 2021-09-02 18:48:47

Resolution: invalid
