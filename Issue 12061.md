# Issue 12061: Cythonize elements of modular subgroups

Issue created by migration from Trac.

Original creator: davidloeffler

Original creation time: 2011-12-25 14:40:04

Assignee: craigcitro

CC:  georgsweber

This patch does the following:

 * reimplements class `sage.modular.arithgroup.arithgroup_element.ArithmeticSubgroupElement` as a Cython extension type, resulting in considerable speed gains;
 * modifies element constructor methods for the classes in `sage.modular.arithgroup` for consistency with the category framework;
 * various small changes (mostly to `__cmp__`) that make TestSuite doctests pass for all these classes.

The patch adds no new methods, but speeds up arithmetic with elements of SL2Z and its subgroups by a factor of about 4 on my machine.


---

Comment by davidloeffler created at 2011-12-25 15:22:44

Changing status from new to needs_review.


---

Comment by davidloeffler created at 2011-12-25 15:22:44

Changing type from defect to enhancement.


---

Comment by davidloeffler created at 2011-12-27 16:23:24

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2011-12-30 11:21:30

Changing status from needs_work to needs_review.


---

Comment by tkluck created at 2012-12-23 20:08:43

Changing status from needs_review to needs_work.


---

Comment by tkluck created at 2012-12-23 20:08:43

That sounds like a worthwhile speed gain!

Your patch still applies to v5.4 and the all doctests pass.

One remark is that you should probably rename the `__contains_sl2__` method. Double-underscore identifiers are reserved by Python. Sage uses single underscores like `_element_constructor_` for its reserved identifiers. But this doesn't seem to be a reserved identifier, you just want it to be private. So call it `_contains_sl2` instead.

Another thing is that I could trigger a crash by an overflow:

```
sage: a = SL2Z([88, 5, -53, -3])
sage: a^18
<Sage crashes>
```


This is not due to your patch, because it also occurs in the unpatched v5.4. But since it is definitely related to Cython code in modular subgroups, maybe you could look into it.

I'll set this ticket to `needs_work` for the part about `_contains_sl2`.


---

Comment by davidloeffler created at 2013-01-08 10:03:04

Hi Timo,

I'm surprised that the patch works with 5.4, because it definitely doesn't with the current beta (5.6.beta2) -- it applies but about a hundred doctests fail. These all seem to be due to issues with unhashability of immutable matrices, which I can fix but only at the cost of reducing the speed gain: I had to move the line 

```python
x = mi2x2(M2Z, x, copy=True, coerce=True)
```

in ` ArithmeticSubgroupElement.__init__` outside the ` if check: ` block. This incurs a speed penalty for arithmetic operations, although the patch still represents a considerable speedup over unpatched Sage. I'll upload a new patch when the doctest run has finished.

By the way, I couldn't reproduce your integer overflow crash -- your example works fine for me, even with much larger exponents. Perhaps this has been fixed by some other patch merged in between 5.4 and 5.6.beta2?


---

Comment by davidloeffler created at 2013-01-08 10:30:14

Changing status from needs_work to needs_review.


---

Comment by tkluck created at 2013-01-10 00:32:44

In sage/modular/modsym/ghlist.py b/sage/modular/modsym/ghlist.py:

```
-            sage: L1 < L2
+            sage: L1 > L2
```

I'm not sure what a ghlist does, but can you explain this change? Will this break people's existing code?

As for the tests, my server runs out of memory for

```
sage -t  "devel/sage-main-git/sage/modular/arithgroup/congroup_gamma1.py"
xmalloc: out of virtual memory
```

I cannot really test this on a more capable machine, so I'll take your word for it that it passes.

It seems that we should create a new ticket for the mutability issue. Apparently, the result of a multiplication of these matrices does not have a `Mutability` object assigned to `self._mutability`.

```
sage: from sage.matrix.matrix_integer_2x2 import Matrix_integer_2x2 as mi2x2
sage: M2Z = MatrixSpace(ZZ,2)            
sage: mi2x2(M2Z, [1,0,0,1])
sage: x=mi2x2(M2Z, [1,0,0,1], false, false)
sage: y=mi2x2(M2Z, [1,0,0,1], false, false)
sage: type(x)
<type 'sage.matrix.matrix_integer_2x2.Matrix_integer_2x2'>
sage: z = x*y
sage: type(z)
<type 'sage.matrix.matrix_integer_2x2.Matrix_integer_2x2'>
sage: x.set_immutable()    # ok
sage: z.set_immutable()    # error
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/sage/src/sage/devel/sage-main-git/<ipython console> in <module>()

/home/sage/src/sage/local/lib/python2.7/site-packages/sage/matrix/matrix0.so in sage.matrix.matrix0.Matrix.set_immutable (sage/matrix/matrix0.c:4454)()

AttributeError: 'NoneType' object has no attribute 'set_immutable'
```

If that's easy to resolve, we may want to wait for that. Otherwise, your workaround seems fine.


---

Comment by davidloeffler created at 2013-01-10 09:37:17

Hi Timo,

Thanks for looking at this! 

- The issue with comparison of ghlists is very minor (comparison order of *elements* of a ghlist is quite important, but I can't imagine any reason why you'd want to compare two different ghlist objects). 

- Can you tell me which test is taking so long in `congroup_gamma1.py`? Is it perhaps computing generators for a Gamma1 group? (The message looks like it was some C / C++ code that ran out of memory rather than Python, so I suspect it might be Hartmut Monien's Farey symbols package.) It might be worth flagging the test as #long or something.

- I have no clue what is going on with the mutability issue so I've aksed about it on sage-devel (https://groups.google.com/d/topic/sage-devel/rLRHESWVzDU/discussion).

Regards, David


---

Comment by tkluck created at 2013-01-11 00:16:51

Hi David,

> The issue with comparison of ghlists is very minor (comparison order of *elements* of a ghlist is quite important, but I can't imagine any reason why you'd want to compare two different ghlist objects). 

All right.

> Can you tell me which test is taking so long in congroup_gamma1.py?

This is the one that fails:

```
Trying:
    [ModularSymbols(eps,k,sign=Integer(1)).cuspidal_subspace().new_subspace().dimension()  for k in (ellipsis_range(Integer(2),Ellipsis,Integer(10)))]###line 590:_sage_    >>> [ModularSymbols(eps,k,sign=1).cuspidal_subspace().new_subspace().dimension()  for k in [2..10]]
Expecting:
    [0, 0, 0, 2, 0, 2, 0, 2, 0]
xmalloc: out of virtual memory
	 [14.4 s]
```


This is also the last one that is executed.


---

Comment by tkluck created at 2013-01-12 01:13:53

Replying to [comment:8 tkluck]:
> As for the tests, my server runs out of memory for
> {{{
> sage -t  "devel/sage-main-git/sage/modular/arithgroup/congroup_gamma1.py"
> xmalloc: out of virtual memory
> }}}
I just tested this on my laptop (which is more powerful than my "server" which is just a cheap vps) and all tests pass. There is also no integer overflow. I think we can disregard those issues.

As discussed on sage-devel, the best way to deal with the mutability issue is probably to have matrices store their mutability as a Cython `bint` instead of as a full-blown object. Do you want to wait for that, or just commit with the current workaround?

Feel free to set the status to "positive review" in the latter case.


---

Comment by nbruin created at 2013-01-12 09:47:17

See #13949 for the `bint` business. The trick seems to be that many matrix classes try to get away with only calling `__cinit__` and avoiding the corresponding `__init__` methods (I guess that is what results from the `__new__` calls). They just manually patch up things that are missed. That's exactly what `2x2` does too. It may be possible to rationalize what gets done at `__cinit__` and what gets done at `__init__` and to what extent a matrix is usable after a just a `__new__`, but not a full `__init__` initialization, but that should probably be done for all matrix classes at once.


---

Attachment

Rebased to 5.11.beta3


---

Comment by davidloeffler created at 2013-07-25 11:38:38

Changing keywords from "" to "sd51".


---

Comment by davidloeffler created at 2013-07-25 11:38:38

Changing status from needs_review to positive_review.


---

Comment by davidloeffler created at 2013-07-25 11:38:38

I rebased the patch to 5.11.beta3. Timo said he was happy modulo the issue with mutability, which has now been fixed at #13949, so I'll set this to positive review.


---

Comment by jdemeyer created at 2013-08-19 06:45:18

Resolution: fixed
