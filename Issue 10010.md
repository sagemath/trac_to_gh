# Issue 10010: "sage -upgrade" appears to hang when its output is tee'd

archive/issues_010010.json:
```json
{
    "body": "Assignee: leif\n\nCC:  jhpalmieri mpatel jdemeyer\n\nKeywords: upgrade update prompt log redirect\n\n\n```sh\nuser@host$ ./sage -upgrade | tee upgrade.log\n```\n\nappears to hang (without giving **any** output).\n\nThis is because `sage-update` prompts the user for confirmation, but doesn't flush the output.\n\nThe attached patch to `sage-update` (a Python script called by `sage-upgrade`) adds flushing various output and also contains some clean-up and corrections (to comments, docstrings, and the messages printed).\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10011\n\n",
    "created_at": "2010-09-25T02:52:23Z",
    "labels": [
        "build",
        "minor",
        "bug"
    ],
    "title": "\"sage -upgrade\" appears to hang when its output is tee'd",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10010",
    "user": "leif"
}
```
Assignee: leif

CC:  jhpalmieri mpatel jdemeyer

Keywords: upgrade update prompt log redirect


```sh
user@host$ ./sage -upgrade | tee upgrade.log
```

appears to hang (without giving **any** output).

This is because `sage-update` prompts the user for confirmation, but doesn't flush the output.

The attached patch to `sage-update` (a Python script called by `sage-upgrade`) adds flushing various output and also contains some clean-up and corrections (to comments, docstrings, and the messages printed).


Issue created by migration from https://trac.sagemath.org/ticket/10011





---

archive/issue_comments_100565.json:
```json
{
    "body": "Attachment [trac_10011-make_sage-update_flush_output-scripts_repo.patch](tarball://root/attachments/some-uuid/ticket10011/trac_10011-make_sage-update_flush_output-scripts_repo.patch) by leif created at 2010-09-25 03:00:48\n\nApply to scripts repo. Based on Sage 4.6.alpha1.",
    "created_at": "2010-09-25T03:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100565",
    "user": "leif"
}
```

Attachment [trac_10011-make_sage-update_flush_output-scripts_repo.patch](tarball://root/attachments/some-uuid/ticket10011/trac_10011-make_sage-update_flush_output-scripts_repo.patch) by leif created at 2010-09-25 03:00:48

Apply to scripts repo. Based on Sage 4.6.alpha1.



---

archive/issue_comments_100566.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-09-25T03:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100566",
    "user": "leif"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_100567.json:
```json
{
    "body": "Just for the record:\n\n```\nleif@quadriga:~/Sage/sage-4.6.alpha1$ ./sage -upgrade | tee -a upgrade-tee-test-10011.1.log\nTesting mirrors...\n\n    [8 ] ftp.sh.cvut.cz                   224 [ms]\n    [11] mirror.switch.ch                 259 [ms]\n    [3 ] content.wuala.com                381 [ms]\n    [13] mirrors.fe.up.pt                 382 [ms]\n    [21] www.mirrorservice.org            387 [ms]\n    [19] sunsite.rediris.es               434 [ms]\n    [12] mirror.yandex.ru                 529 [ms]\n    [15] modular.math.jmu.edu             806 [ms]\n    [14] mirrors.xmission.com             833 [ms]\n    [2 ] boxen.math.washington.edu        851 [ms]\n    [5 ] ftp.iitm.ac.in                   938 [ms]\n    [20] www.cecm.sfu.ca                  967 [ms]\n    [17] sagemath.mirror.ac.za           1038 [ms]\n    [4 ] echidna.maths.usyd.edu.au       1451 [ms]\n    [10] mirror.aarnet.edu.au            1523 [ms]\n    [7 ] ftp.leg.uct.ac.za               1581 [ms]\n    [16] sagemath.c3sl.ufpr.br           1703 [ms]\n    [6 ] ftp.kaist.ac.kr                 2108 [ms]\n    [18] sagemath.polytechnic.edu.na     6327 [ms]\n    [9 ] mira.sunsite.utk.edu           11068 [ms]\n\nAutomatically selected server ftp.sh.cvut.cz (http://ftp.sh.cvut.cz/MIRRORS/sagemath/).\nDownloading packages from 'http://ftp.sh.cvut.cz/MIRRORS/sagemath//spkg'.\nReading package lists.......... Done!\nThe following packages will be upgraded:\n\n    cliquer-1.2.p6 examples-4.5.3 extcode-4.5.3 genus2reduction-0.3.p6\n    iconv-1.13.1.p2 lcalc-20100428-1.23.p1 pari-2.3.5.p4\n    polybori-0.6.4.p4 sage-4.5.3 sage_scripts-4.5.3\n    singular-3-1-1-4.p0\n\n ** WARNING: This is a source-based upgrade, which could take hours,\n ** fail, and render your Sage install useless!!\n\nDo you want to continue [y/N]? n\nAbort.\nleif@quadriga:~/Sage/sage-4.6.alpha1$ \n```\n\n\nNote that I did **not** run `sage -downgrade`! 8D",
    "created_at": "2010-09-25T03:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100567",
    "user": "leif"
}
```

Just for the record:

```
leif@quadriga:~/Sage/sage-4.6.alpha1$ ./sage -upgrade | tee -a upgrade-tee-test-10011.1.log
Testing mirrors...

    [8 ] ftp.sh.cvut.cz                   224 [ms]
    [11] mirror.switch.ch                 259 [ms]
    [3 ] content.wuala.com                381 [ms]
    [13] mirrors.fe.up.pt                 382 [ms]
    [21] www.mirrorservice.org            387 [ms]
    [19] sunsite.rediris.es               434 [ms]
    [12] mirror.yandex.ru                 529 [ms]
    [15] modular.math.jmu.edu             806 [ms]
    [14] mirrors.xmission.com             833 [ms]
    [2 ] boxen.math.washington.edu        851 [ms]
    [5 ] ftp.iitm.ac.in                   938 [ms]
    [20] www.cecm.sfu.ca                  967 [ms]
    [17] sagemath.mirror.ac.za           1038 [ms]
    [4 ] echidna.maths.usyd.edu.au       1451 [ms]
    [10] mirror.aarnet.edu.au            1523 [ms]
    [7 ] ftp.leg.uct.ac.za               1581 [ms]
    [16] sagemath.c3sl.ufpr.br           1703 [ms]
    [6 ] ftp.kaist.ac.kr                 2108 [ms]
    [18] sagemath.polytechnic.edu.na     6327 [ms]
    [9 ] mira.sunsite.utk.edu           11068 [ms]

Automatically selected server ftp.sh.cvut.cz (http://ftp.sh.cvut.cz/MIRRORS/sagemath/).
Downloading packages from 'http://ftp.sh.cvut.cz/MIRRORS/sagemath//spkg'.
Reading package lists.......... Done!
The following packages will be upgraded:

    cliquer-1.2.p6 examples-4.5.3 extcode-4.5.3 genus2reduction-0.3.p6
    iconv-1.13.1.p2 lcalc-20100428-1.23.p1 pari-2.3.5.p4
    polybori-0.6.4.p4 sage-4.5.3 sage_scripts-4.5.3
    singular-3-1-1-4.p0

 ** WARNING: This is a source-based upgrade, which could take hours,
 ** fail, and render your Sage install useless!!

Do you want to continue [y/N]? n
Abort.
leif@quadriga:~/Sage/sage-4.6.alpha1$ 
```


Note that I did **not** run `sage -downgrade`! 8D



---

archive/issue_comments_100568.json:
```json
{
    "body": "I know you don't like interactive scripts... ;-)",
    "created_at": "2010-10-19T13:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100568",
    "user": "leif"
}
```

I know you don't like interactive scripts... ;-)



---

archive/issue_comments_100569.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> I know you don't like interactive scripts... ;-)\nVery true.\n\nThe patch looks fine and fixes the problem mentioned in the ticket.  I can't really be sure that it doesn't break anything, but positive_review anyway.",
    "created_at": "2010-10-21T15:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100569",
    "user": "jdemeyer"
}
```

Replying to [comment:3 leif]:
> I know you don't like interactive scripts... ;-)
Very true.

The patch looks fine and fixes the problem mentioned in the ticket.  I can't really be sure that it doesn't break anything, but positive_review anyway.



---

archive/issue_comments_100570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-21T15:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100570",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_100571.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-01T10:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10010#issuecomment-100571",
    "user": "jdemeyer"
}
```

Resolution: fixed
