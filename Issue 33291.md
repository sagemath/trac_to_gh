# Issue 33291: Hashing problem in overconvergent modular symbols

archive/issues_033291.json:
```json
{
    "body": "The following causes an error in the Pollack-Stevens distributions code\n\n```\nsage: from sage.modular.pollack_stevens.space import ps_modsym_from_simple_modsym_space\nsage: p = 3\nsage: A = ModularSymbols(188, 2, 1).cuspidal_submodule().new_subspace().decomposition()[0]\nsage: phi = ps_modsym_from_simple_modsym_space(A)\nsage: ap = phi.Tq_eigenvalue(p, 2)\nsage: phi1, psi1 = phi.completions(p, 8)\nsage: R = psi1.codomain()\nsage: poly = PolynomialRing(R, 'x')( [p, -ap, 1] )\nsage: v0, v1 = poly.roots(multiplicities=False)\nsage: if v0.valuation(): v0, v1 = v1, v0\nsage: phi1p = phi1.p_stabilize_and_lift(p, 2, ap = psi1(ap), alpha = v0, check = False, new_base_ring = R)\nTraceback (most recent call last):\n...\n  File \"/usr/lib/python3.10/site-packages/sage/modular/pollack_stevens/manin_map.py\", line 292, in _compute_image_from_gens\n    g1 = self._dict[self._manin.reps(g)] * A\n  File \"sage/structure/element.pyx\", line 1516, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12320)\n    return coercion_model.bin_op(left, right, mul)\n  File \"sage/structure/coerce.pyx\", line 1196, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10715)\n    return (<Action>action)._act_(y, x)\n  File \"sage/categories/action.pyx\", line 494, in sage.categories.action.PrecomposedAction._act_ (build/cythonized/sage/categories/action.c:7445)\n    return self._action._act_(g, x)\n  File \"sage/modular/pollack_stevens/dist.pyx\", line 1478, in sage.modular.pollack_stevens.dist.WeightKAction_vector._act_ (build/cythonized/sage/modular/pollack_stevens/dist.c:24103)\n    ans._moments = v_moments * self.acting_matrix(g, len(v_moments))\n  File \"sage/modular/pollack_stevens/dist.pyx\", line 1323, in sage.modular.pollack_stevens.dist.WeightKAction.acting_matrix (build/cythonized/sage/modular/pollack_stevens/dist.c:21164)\n    if not g in self._maxprecs:\n  File \"sage/matrix/matrix0.pyx\", line 5905, in sage.matrix.matrix0.Matrix.__hash__ (build/cythonized/sage/matrix/matrix0.c:39632)\n    cdef long h = self._hash_()\n  File \"sage/matrix/matrix0.pyx\", line 5956, in sage.matrix.matrix0.Matrix._hash_ (build/cythonized/sage/matrix/matrix0.c:39788)\n    h += (k ^ l) * hash(self.get_unsafe(i, j))\n  File \"sage/rings/padics/qadic_flint_CR.pyx\", line 170, in sage.rings.padics.qadic_flint_CR.qAdicCappedRelativeElement.__hash__ (build/cythonized/sage/rings/padics/qadic_flint_CR.c:39531)\n    raise TypeError(\"unhashable type: 'sage.rings.padics.qadic_flint_CR.qAdicCappedRelativeElement'\")\nTypeError: unhashable type: 'sage.rings.padics.qadic_flint_CR.qAdicCappedRelativeElement'\n```\n\nThe initialization of the distributions module uses a p-adic version of `Sigma0` in this case (lines 298-303 of `sage/modular/pollack_stevens/distributions.py`):\n\n```\nif self.is_symk() or character is not None:\n            self._act = WeightKAction(self, character, adjuster, act_on_left,\n                                      dettwist, padic=act_padic)\n        else:\n            self._act = WeightKAction(self, character, adjuster, act_on_left,\n                                      dettwist, padic=True)\n```\n\nWhen the coefficients are Zp or Qp, this works because those elements are hashable (though they probably shouldn't be).  But once the coefficient ring is an unramified extension, it fails.\n\nThe fix is probably to change the logic in the `acting_matrix` method of `sage/modular/pollack_stevens/dist.pyx` to handle the case that matrices aren't hashable.  Disabling caching completely by adding (at line 1323 of that file)\n\n```\nif not (g.base_ring().is_exact() or g.base_ring().absolute_degree() == 1):\n    return self._compute_acting_matrix(g, M)\n```\n\nfixes the problem, but probably has some serious performance consequences.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33528\n\n",
    "created_at": "2022-03-18T18:20:04Z",
    "labels": [
        "modular forms",
        "major",
        "bug"
    ],
    "title": "Hashing problem in overconvergent modular symbols",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33291",
    "user": "roed"
}
```
The following causes an error in the Pollack-Stevens distributions code

```
sage: from sage.modular.pollack_stevens.space import ps_modsym_from_simple_modsym_space
sage: p = 3
sage: A = ModularSymbols(188, 2, 1).cuspidal_submodule().new_subspace().decomposition()[0]
sage: phi = ps_modsym_from_simple_modsym_space(A)
sage: ap = phi.Tq_eigenvalue(p, 2)
sage: phi1, psi1 = phi.completions(p, 8)
sage: R = psi1.codomain()
sage: poly = PolynomialRing(R, 'x')( [p, -ap, 1] )
sage: v0, v1 = poly.roots(multiplicities=False)
sage: if v0.valuation(): v0, v1 = v1, v0
sage: phi1p = phi1.p_stabilize_and_lift(p, 2, ap = psi1(ap), alpha = v0, check = False, new_base_ring = R)
Traceback (most recent call last):
...
  File "/usr/lib/python3.10/site-packages/sage/modular/pollack_stevens/manin_map.py", line 292, in _compute_image_from_gens
    g1 = self._dict[self._manin.reps(g)] * A
  File "sage/structure/element.pyx", line 1516, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12320)
    return coercion_model.bin_op(left, right, mul)
  File "sage/structure/coerce.pyx", line 1196, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10715)
    return (<Action>action)._act_(y, x)
  File "sage/categories/action.pyx", line 494, in sage.categories.action.PrecomposedAction._act_ (build/cythonized/sage/categories/action.c:7445)
    return self._action._act_(g, x)
  File "sage/modular/pollack_stevens/dist.pyx", line 1478, in sage.modular.pollack_stevens.dist.WeightKAction_vector._act_ (build/cythonized/sage/modular/pollack_stevens/dist.c:24103)
    ans._moments = v_moments * self.acting_matrix(g, len(v_moments))
  File "sage/modular/pollack_stevens/dist.pyx", line 1323, in sage.modular.pollack_stevens.dist.WeightKAction.acting_matrix (build/cythonized/sage/modular/pollack_stevens/dist.c:21164)
    if not g in self._maxprecs:
  File "sage/matrix/matrix0.pyx", line 5905, in sage.matrix.matrix0.Matrix.__hash__ (build/cythonized/sage/matrix/matrix0.c:39632)
    cdef long h = self._hash_()
  File "sage/matrix/matrix0.pyx", line 5956, in sage.matrix.matrix0.Matrix._hash_ (build/cythonized/sage/matrix/matrix0.c:39788)
    h += (k ^ l) * hash(self.get_unsafe(i, j))
  File "sage/rings/padics/qadic_flint_CR.pyx", line 170, in sage.rings.padics.qadic_flint_CR.qAdicCappedRelativeElement.__hash__ (build/cythonized/sage/rings/padics/qadic_flint_CR.c:39531)
    raise TypeError("unhashable type: 'sage.rings.padics.qadic_flint_CR.qAdicCappedRelativeElement'")
TypeError: unhashable type: 'sage.rings.padics.qadic_flint_CR.qAdicCappedRelativeElement'
```

The initialization of the distributions module uses a p-adic version of `Sigma0` in this case (lines 298-303 of `sage/modular/pollack_stevens/distributions.py`):

```
if self.is_symk() or character is not None:
            self._act = WeightKAction(self, character, adjuster, act_on_left,
                                      dettwist, padic=act_padic)
        else:
            self._act = WeightKAction(self, character, adjuster, act_on_left,
                                      dettwist, padic=True)
```

When the coefficients are Zp or Qp, this works because those elements are hashable (though they probably shouldn't be).  But once the coefficient ring is an unramified extension, it fails.

The fix is probably to change the logic in the `acting_matrix` method of `sage/modular/pollack_stevens/dist.pyx` to handle the case that matrices aren't hashable.  Disabling caching completely by adding (at line 1323 of that file)

```
if not (g.base_ring().is_exact() or g.base_ring().absolute_degree() == 1):
    return self._compute_acting_matrix(g, M)
```

fixes the problem, but probably has some serious performance consequences.


Issue created by migration from https://trac.sagemath.org/ticket/33528


