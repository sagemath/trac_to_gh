# Issue 15024: Fix brian optional spkg for new workflow

archive/issues_015024.json:
```json
{
    "body": "CC:  uri @vbraun\n\nSee #14962.  We have to either fix the newest version checking in brian or (better) get rid of it completely.\n\nThis would be an ideal time to upgrade brian to a new version and use the patch file instead of the py file for the one fix that is in it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15261\n\n",
    "created_at": "2013-10-07T16:35:59Z",
    "labels": [
        "packages: optional",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "Fix brian optional spkg for new workflow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15024",
    "user": "@kcrisman"
}
```
CC:  uri @vbraun

See #14962.  We have to either fix the newest version checking in brian or (better) get rid of it completely.

This would be an ideal time to upgrade brian to a new version and use the patch file instead of the py file for the one fix that is in it.

Issue created by migration from https://trac.sagemath.org/ticket/15261





---

archive/issue_comments_192082.json:
```json
{
    "body": "Here's my current diff.  I won't have time to upgrade and test today, but hopefully tomorrow.  Note that \n\n```\n$ diff -Naur src/brian/units.py patches/units.py\n```\n\nactually returns a lot of whitespace changes so this is better from that standpoint as well.\n\n```diff\ndiff --git a/SPKG.txt b/SPKG.txt\n--- a/SPKG.txt\n+++ b/SPKG.txt\n@@ -31,9 +31,11 @@\n \n == Changelog ==\n \n+=== brian-1.2.1.p1 (Karl-Dieter Crisman, 7 October 2013) ===\n+ * Change spkg-install for transition to git\n+\n === brian-1.2.1.p0 (Oriol Castejon, 3rd August 2010) ===\n  * Version for Sage of the Python package Brian released.\n-\n  * Minor change added to avoid problems with Brian units and Sage Integers and \n    RealNumbers.\n \ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -6,42 +6,16 @@\n    exit 1\n fi\n \n-############################## Check dependencies ##############################\n-NUMPY=`cd $SAGE_ROOT/spkg/standard/; ./newest_version numpy`\n-if [ $? -ne 0 ]; then\n-    echo \"Failed to find numpy.  Please install the numpy spkg.\"\n-    exit 1\n-fi\n+cd src\n \n-SCIPY=`cd $SAGE_ROOT/spkg/standard/; ./newest_version scipy`\n-if [ $? -ne 0 ]; then\n-    echo \"Failed to find scipy.  Please install the scipy spkg.\"\n-    exit 1\n-fi\n-\n-MATPLOTLIB=`cd $SAGE_ROOT/spkg/standard/; ./newest_version matplotlib`\n-if [ $? -ne 0 ]; then\n-    echo \"Failed to find matplotlib.  Please install the matplotlib spkg.\"\n-    exit 1\n-fi\n-\n-SYMPY=`cd $SAGE_ROOT/spkg/standard/; ./newest_version sympy`\n-if [ $? -ne 0 ]; then\n-    echo \"Failed to find sympy.  Please install the sympy spkg.\"\n-    exit 1\n-fi\n-################################################################################\n-\n-\n-################################ Apply patches #################################\n-cp patches/units.py src/brian/units.py\n-if [ $? -ne 0 ]; then\n-    echo \"Error copying patch.\"\n-    exit 1\n-fi\n-################################################################################\n-\n-cd src\n+# Apply patch so that Sage reals and integers do not conflict\n+for patch in ../patches/*.patch; do\n+   patch -p1 <\"$patch\"\n+   if [ $? -ne 0 ]; then\n+       echo \"Error applying '$patch'.\"\n+       exit 1\n+   fi\n+done\n \n python setup.py build\n if [ $? -ne 0 ]; then\n```\n\nI may have to change the `p1` to something else or change the patch file slightly.",
    "created_at": "2013-10-07T16:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192082",
    "user": "@kcrisman"
}
```

Here's my current diff.  I won't have time to upgrade and test today, but hopefully tomorrow.  Note that 

```
$ diff -Naur src/brian/units.py patches/units.py
```

actually returns a lot of whitespace changes so this is better from that standpoint as well.

```diff
diff --git a/SPKG.txt b/SPKG.txt
--- a/SPKG.txt
+++ b/SPKG.txt
@@ -31,9 +31,11 @@
 
 == Changelog ==
 
+=== brian-1.2.1.p1 (Karl-Dieter Crisman, 7 October 2013) ===
+ * Change spkg-install for transition to git
+
 === brian-1.2.1.p0 (Oriol Castejon, 3rd August 2010) ===
  * Version for Sage of the Python package Brian released.
-
  * Minor change added to avoid problems with Brian units and Sage Integers and 
    RealNumbers.
 
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -6,42 +6,16 @@
    exit 1
 fi
 
-############################## Check dependencies ##############################
-NUMPY=`cd $SAGE_ROOT/spkg/standard/; ./newest_version numpy`
-if [ $? -ne 0 ]; then
-    echo "Failed to find numpy.  Please install the numpy spkg."
-    exit 1
-fi
+cd src
 
-SCIPY=`cd $SAGE_ROOT/spkg/standard/; ./newest_version scipy`
-if [ $? -ne 0 ]; then
-    echo "Failed to find scipy.  Please install the scipy spkg."
-    exit 1
-fi
-
-MATPLOTLIB=`cd $SAGE_ROOT/spkg/standard/; ./newest_version matplotlib`
-if [ $? -ne 0 ]; then
-    echo "Failed to find matplotlib.  Please install the matplotlib spkg."
-    exit 1
-fi
-
-SYMPY=`cd $SAGE_ROOT/spkg/standard/; ./newest_version sympy`
-if [ $? -ne 0 ]; then
-    echo "Failed to find sympy.  Please install the sympy spkg."
-    exit 1
-fi
-################################################################################
-
-
-################################ Apply patches #################################
-cp patches/units.py src/brian/units.py
-if [ $? -ne 0 ]; then
-    echo "Error copying patch."
-    exit 1
-fi
-################################################################################
-
-cd src
+# Apply patch so that Sage reals and integers do not conflict
+for patch in ../patches/*.patch; do
+   patch -p1 <"$patch"
+   if [ $? -ne 0 ]; then
+       echo "Error applying '$patch'."
+       exit 1
+   fi
+done
 
 python setup.py build
 if [ $? -ne 0 ]; then
```

I may have to change the `p1` to something else or change the patch file slightly.



---

archive/issue_comments_192083.json:
```json
{
    "body": "I do get \n\n```\nsage: import brian\n.../sage-5.11.rc0/local/lib/python2.7/site-packages/brian/utils/sparse_patch/__init__.py:34: UserWarning: Couldn't find matching sparse matrix patch for scipy version 0.12.0, but in most cases this shouldn't be a problem.\n  warnings.warn(\"Couldn't find matching sparse matrix patch for scipy version %s, but in most cases this shouldn't be a problem.\" % scipy.__version__)\n```\n\nPresumably an upgrade would fix this - e.g. [1.4.1](http://briansimulator.org/brian-1-4-1/), which seems to be most recent.",
    "created_at": "2013-10-07T17:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192083",
    "user": "@kcrisman"
}
```

I do get 

```
sage: import brian
.../sage-5.11.rc0/local/lib/python2.7/site-packages/brian/utils/sparse_patch/__init__.py:34: UserWarning: Couldn't find matching sparse matrix patch for scipy version 0.12.0, but in most cases this shouldn't be a problem.
  warnings.warn("Couldn't find matching sparse matrix patch for scipy version %s, but in most cases this shouldn't be a problem." % scipy.__version__)
```

Presumably an upgrade would fix this - e.g. [1.4.1](http://briansimulator.org/brian-1-4-1/), which seems to be most recent.



---

archive/issue_comments_192084.json:
```json
{
    "body": "I have two different ones to try.  I think I got the patches right for the upgrade.  Oriol, can you check that this still works for your clash issue with Sage-defined types?",
    "created_at": "2013-10-08T02:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192084",
    "user": "@kcrisman"
}
```

I have two different ones to try.  I think I got the patches right for the upgrade.  Oriol, can you check that this still works for your clash issue with Sage-defined types?



---

archive/issue_comments_192085.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-08T02:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192085",
    "user": "@kcrisman"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_192086.json:
```json
{
    "body": "Looks good to me. I've repacked it with gnu tar instead of bsd tar, no other changes.",
    "created_at": "2013-10-08T10:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192086",
    "user": "@vbraun"
}
```

Looks good to me. I've repacked it with gnu tar instead of bsd tar, no other changes.



---

archive/issue_comments_192087.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-10-08T10:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192087",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_192088.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-10-12T17:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192088",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_192089.json:
```json
{
    "body": "Closed... Presumably this still needs to be uploaded to the server, though?",
    "created_at": "2013-10-14T17:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192089",
    "user": "@kcrisman"
}
```

Closed... Presumably this still needs to be uploaded to the server, though?



---

archive/issue_comments_192090.json:
```json
{
    "body": "I surely see `brian-1.4.1.p0` on [optional packages](http://www.sagemath.org/packages/optional/).",
    "created_at": "2013-10-14T20:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192090",
    "user": "@jdemeyer"
}
```

I surely see `brian-1.4.1.p0` on [optional packages](http://www.sagemath.org/packages/optional/).



---

archive/issue_comments_192091.json:
```json
{
    "body": "> I surely see `brian-1.4.1.p0` on [optional packages](http://www.sagemath.org/packages/optional/).\nSorry, I didn't even look - usually I see an announcement here or only after the release (here, apparently 5.13) is actually released.  But if it was earlier, great!",
    "created_at": "2013-10-15T00:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15024#issuecomment-192091",
    "user": "@kcrisman"
}
```

> I surely see `brian-1.4.1.p0` on [optional packages](http://www.sagemath.org/packages/optional/).
Sorry, I didn't even look - usually I see an announcement here or only after the release (here, apparently 5.13) is actually released.  But if it was earlier, great!
