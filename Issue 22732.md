# Issue 22732: Upgrade to Pynac-0.7.7

Issue created by migration from https://trac.sagemath.org/ticket/22969

Original creator: rws

Original creation time: 2017-05-10 06:57:29

Pynac-0.7.7 changes:
* fix regression in Singular interface (last minute fix of #22838)
* fix series problems (#22959)
* fix dilog/polylog numerics (#18386, #19906)
* avoid Python errors when comparing complex in richcmp
* general handling of evalf of one-arg functions (obsoletes py_sin etc)


---

Comment by rws created at 2017-05-10 07:04:39

Changing status from new to needs_review.


---

Comment by rws created at 2017-05-10 07:04:39

New commits:


---

Comment by tscrim created at 2017-05-10 13:42:32

LGTM. Off to the buildbots.


---

Comment by tscrim created at 2017-05-10 13:42:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-05-14 08:16:29

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-05-14 08:16:29

On OSX:

```
sage -t --long src/sage/functions/log.py
**********************************************************************
File "src/sage/functions/log.py", line 434, in sage.functions.log.Function_polylog.__init__
Failed example:
    polylog(2, 1.0)
Expected:
    NaN
Got:
    NaN + NaN*I
**********************************************************************
File "src/sage/functions/log.py", line 436, in sage.functions.log.Function_polylog.__init__
Failed example:
    polylog(2.0, 1.0)
Expected:
    NaN
Got:
    NaN + NaN*I
**********************************************************************
1 item had failures:
   2 of  26 in sage.functions.log.Function_polylog.__init__
    [271 tests, 2 failures, 9.23 s]
```



---

Comment by rws created at 2017-05-15 07:37:03

The difference may be due to different results from `cmp(RBF(NaN),1)` on OSX (?, Linux gives `1`) but it shows things can be done better in other parts of the computation.


---

Comment by rws created at 2017-05-15 13:19:37

There will be a new release, specifically usage of `PyObject_Cmp` will be phased out.

I hope the following is `False` on OSX too, as my attempt to fix the above depends on it:

```
sage: RBF(NaN)._richcmp_(RBF(1),0)
False
```

If this is different then we'll depend on #23001 for a fix.


---

Comment by rws created at 2017-05-15 13:28:46

> The difference may be due to different results from `cmp(RBF(NaN),1)` on OSX (?, Linux gives `1`) but it shows things can be done better in other parts of the computation.

No this is not the reason.


---

Comment by git created at 2017-05-16 13:49:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-05-16 13:53:08

OK, no new release, but I added a patch and it all depends on #23001. I'm pretty sure this fixes the issue which was very poor programming---I relied on undefined behaviour to get the right result.


---

Comment by rws created at 2017-05-16 13:53:08

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-05-16 14:24:41

Back to the buildbots.


---

Comment by tscrim created at 2017-05-16 14:24:41

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-05-17 00:06:20

Doesn't build for me with the added patch

```
libtool: compile:  x86_64-pc-linux-gnu-g++ -DHAVE_CONFIG_H -I. -I.. -I/usr/include/python2.7 -DSING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -Wall -Wextra -Wshadow -Wnon-virtual-dtor -Wno-unused-parameter -march=native -O2 -pipe -std=gnu++11 -c numeric.cpp  -fPIC -DPIC -o .libs/libpynac_la-numeric.o
In file included from /usr/include/python2.7/Python.h:8:0,
                 from basic.h:26,
                 from numeric.h:49,
                 from numeric.cpp:55:
/usr/include/python2.7/pyconfig.h:1193:0: warning: "_POSIX_C_SOURCE" redefined
 #define _POSIX_C_SOURCE 200112L
 ^
In file included from /usr/include/stdlib.h:24:0,
                 from /usr/include/flint/fmpz.h:37,
                 from numeric.cpp:52:
/usr/include/features.h:225:0: note: this is the location of the previous definition
 # define _POSIX_C_SOURCE 200809L
 ^
In file included from /usr/include/python2.7/Python.h:8:0,
                 from basic.h:26,
                 from numeric.h:49,
                 from numeric.cpp:55:
/usr/include/python2.7/pyconfig.h:1215:0: warning: "_XOPEN_SOURCE" redefined
 #define _XOPEN_SOURCE 600
 ^
In file included from /usr/include/stdlib.h:24:0,
                 from /usr/include/flint/fmpz.h:37,
                 from numeric.cpp:52:
/usr/include/features.h:166:0: note: this is the location of the previous definition
 # define _XOPEN_SOURCE 700
 ^
numeric.cpp: In member function ‘bool GiNaC::numeric::operator<=(const GiNaC::numeric&) const’:
numeric.cpp:1996:95: error: ‘Pynac_PyObj_RichCmp’ was not declared in this scope
                         return Pynac_PyObj_RichCmp(v._pyobject, right.v._pyobject, Py_LE, "<=");
                                                                                               ^
numeric.cpp: In member function ‘bool GiNaC::numeric::operator>(const GiNaC::numeric&) const’:
numeric.cpp:2020:94: error: ‘Pynac_PyObj_RichCmp’ was not declared in this scope
                         return Pynac_PyObj_RichCmp(v._pyobject, right.v._pyobject, Py_GT, ">");
                                                                                              ^
numeric.cpp: In member function ‘bool GiNaC::numeric::operator>=(const GiNaC::numeric&) const’:
numeric.cpp:2044:95: error: ‘Pynac_PyObj_RichCmp’ was not declared in this scope
                         return Pynac_PyObj_RichCmp(v._pyobject, right.v._pyobject, Py_GE, ">=");
                                                                                               ^
make[2]: *** [Makefile:854: libpynac_la-numeric.lo] Error 1
make[2]: Leaving directory '/dev/shm/portage/sci-libs/pynac-0.7.7-r1/work/pynac-0.7.7/ginac'
```



---

Comment by fbissey created at 2017-05-17 01:27:22

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2017-05-17 01:27:22

Yes it looks like you forgot those 3 instances of `Pynac_PyObj_RichCmp` when switching to `PyObject_RichCompareBool`.


---

Comment by fbissey created at 2017-05-17 02:01:37

Somehow I missed part of the patch. Not sure how it happened but it is all there. Sorry for the noise.


---

Comment by fbissey created at 2017-05-17 02:01:37

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-05-21 10:08:30

Resolution: fixed
