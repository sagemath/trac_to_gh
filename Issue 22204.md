# Issue 22204: Don't fail plot.py doctest if DISPLAY is unset

Issue created by migration from Trac.

Original creator: infinity0

Original creation time: 2017-02-25 15:24:29




---

Comment by infinity0 created at 2017-02-25 15:28:06

Changing type from PLEASE CHANGE to defect.


---

Comment by infinity0 created at 2017-02-25 15:28:06

Changing component from PLEASE CHANGE to interfaces.


---

Comment by infinity0 created at 2017-02-25 15:28:06

Changing status from new to needs_review.


---

Comment by infinity0 created at 2017-02-25 15:28:06

New commits:


---

Comment by vdelecroix created at 2017-02-25 17:40:26

I found weird that this modification has to be done only in two places... there are plots everywhere in the doctests! Why is that? Wouldn't it be better to set it automatically by the doctest engine?


---

Comment by infinity0 created at 2017-02-25 18:22:56

Debian is on matplotlib v2 and Sage is still using v1.5 (see [our status page](https://people.debian.org/~thansen/debian-sage-7.4-status.html)).

I did initially also add it into other places, but only these two were needed in the end to fix the test failures. Perhaps it runs the other plots after running these tests, so the "good" settings have already been set by then?

Agreed that this is best done in the main code itself; probably not even in the doctest engine, but the Sage-matplotlib interface. I'm not certain where would be the best place though, I'm not familiar with the code.


---

Comment by infinity0 created at 2017-02-25 19:14:26

It might be cleaner to patch matplotlib itself, I've filed [a ticket](https://github.com/matplotlib/matplotlib/issues/8147) on their side too.


---

Comment by jdemeyer created at 2017-02-25 19:54:06

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-02-25 19:54:06

I cannot reproduce this problem. I'm sure that many bots run Sage with `DISPLAY` unset, so there must be something more going on...


---

Comment by infinity0 created at 2017-02-25 22:10:16

Looks like upstream rejected my suggestion. I can't reproduce this now on my main computer either, but I'll try it again in Debian's build-in-a-chroot program later.

`env -i PATH=/usr/bin:/bin HOME=$HOME sage -c 'plot(x^2, (x,0,5))'`

They did point me to the `MPLBACKEND` envvar so perhaps Sage's doctesting framework can set this envvar, assuming the "real cause" isn't something else.


---

Comment by jdemeyer created at 2017-06-26 11:39:41

Any further news? Can this be reproduced in vanilla Sage?


---

Comment by chapoton created at 2017-08-26 19:27:09

see #23696 for matplotlib update


---

Comment by saraedum created at 2018-03-24 03:09:14

It appears that #23696 fixed this:

```
+# Make sure the agg backend is selected during doctesting
+# This needs to be done before any other matplotlib calls.
+import matplotlib
+matplotlib.use('agg')
```

So, can this be closed now?


---

Comment by saraedum created at 2018-03-24 03:09:14

Changing status from needs_info to needs_review.


---

Comment by fbissey created at 2018-03-24 09:10:24

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-03-24 09:10:24

Yes, I didn't know there was a matching ticket to the debian patch. But this was definitely part of my target in #23696.


---

Comment by vdelecroix created at 2018-05-18 17:16:26

Resolution: wontfix


---

Comment by vdelecroix created at 2018-05-18 17:16:26

closing positively reviewed duplicates
