# Issue 22204: Don't fail plot.py doctest if DISPLAY is unset

archive/issues_022204.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/22441\n\n",
    "created_at": "2017-02-25T15:24:29Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Don't fail plot.py doctest if DISPLAY is unset",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22204",
    "user": "https://github.com/infinity0"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/22441





---

archive/issue_comments_308084.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308084",
    "user": "https://github.com/infinity0"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_308085.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to interfaces.",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308085",
    "user": "https://github.com/infinity0"
}
```

Changing component from PLEASE CHANGE to interfaces.



---

archive/issue_comments_308086.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308086",
    "user": "https://github.com/infinity0"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_308087.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308087",
    "user": "https://github.com/infinity0"
}
```

New commits:



---

archive/issue_comments_308088.json:
```json
{
    "body": "I found weird that this modification has to be done only in two places... there are plots everywhere in the doctests! Why is that? Wouldn't it be better to set it automatically by the doctest engine?",
    "created_at": "2017-02-25T17:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308088",
    "user": "https://github.com/videlec"
}
```

I found weird that this modification has to be done only in two places... there are plots everywhere in the doctests! Why is that? Wouldn't it be better to set it automatically by the doctest engine?



---

archive/issue_comments_308089.json:
```json
{
    "body": "Debian is on matplotlib v2 and Sage is still using v1.5 (see [our status page](https://people.debian.org/~thansen/debian-sage-7.4-status.html)).\n\nI did initially also add it into other places, but only these two were needed in the end to fix the test failures. Perhaps it runs the other plots after running these tests, so the \"good\" settings have already been set by then?\n\nAgreed that this is best done in the main code itself; probably not even in the doctest engine, but the Sage-matplotlib interface. I'm not certain where would be the best place though, I'm not familiar with the code.",
    "created_at": "2017-02-25T18:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308089",
    "user": "https://github.com/infinity0"
}
```

Debian is on matplotlib v2 and Sage is still using v1.5 (see [our status page](https://people.debian.org/~thansen/debian-sage-7.4-status.html)).

I did initially also add it into other places, but only these two were needed in the end to fix the test failures. Perhaps it runs the other plots after running these tests, so the "good" settings have already been set by then?

Agreed that this is best done in the main code itself; probably not even in the doctest engine, but the Sage-matplotlib interface. I'm not certain where would be the best place though, I'm not familiar with the code.



---

archive/issue_comments_308090.json:
```json
{
    "body": "It might be cleaner to patch matplotlib itself, I've filed [a ticket](https://github.com/matplotlib/matplotlib/issues/8147) on their side too.",
    "created_at": "2017-02-25T19:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308090",
    "user": "https://github.com/infinity0"
}
```

It might be cleaner to patch matplotlib itself, I've filed [a ticket](https://github.com/matplotlib/matplotlib/issues/8147) on their side too.



---

archive/issue_comments_308091.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-02-25T19:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308091",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_308092.json:
```json
{
    "body": "I cannot reproduce this problem. I'm sure that many bots run Sage with `DISPLAY` unset, so there must be something more going on...",
    "created_at": "2017-02-25T19:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308092",
    "user": "https://github.com/jdemeyer"
}
```

I cannot reproduce this problem. I'm sure that many bots run Sage with `DISPLAY` unset, so there must be something more going on...



---

archive/issue_comments_308093.json:
```json
{
    "body": "Looks like upstream rejected my suggestion. I can't reproduce this now on my main computer either, but I'll try it again in Debian's build-in-a-chroot program later.\n\n`env -i PATH=/usr/bin:/bin HOME=$HOME sage -c 'plot(x^2, (x,0,5))'`\n\nThey did point me to the `MPLBACKEND` envvar so perhaps Sage's doctesting framework can set this envvar, assuming the \"real cause\" isn't something else.",
    "created_at": "2017-02-25T22:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308093",
    "user": "https://github.com/infinity0"
}
```

Looks like upstream rejected my suggestion. I can't reproduce this now on my main computer either, but I'll try it again in Debian's build-in-a-chroot program later.

`env -i PATH=/usr/bin:/bin HOME=$HOME sage -c 'plot(x^2, (x,0,5))'`

They did point me to the `MPLBACKEND` envvar so perhaps Sage's doctesting framework can set this envvar, assuming the "real cause" isn't something else.



---

archive/issue_comments_308094.json:
```json
{
    "body": "Any further news? Can this be reproduced in vanilla Sage?",
    "created_at": "2017-06-26T11:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308094",
    "user": "https://github.com/jdemeyer"
}
```

Any further news? Can this be reproduced in vanilla Sage?



---

archive/issue_comments_308095.json:
```json
{
    "body": "see #23696 for matplotlib update",
    "created_at": "2017-08-26T19:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308095",
    "user": "https://github.com/fchapoton"
}
```

see #23696 for matplotlib update



---

archive/issue_comments_308096.json:
```json
{
    "body": "It appears that #23696 fixed this:\n\n```\n+# Make sure the agg backend is selected during doctesting\n+# This needs to be done before any other matplotlib calls.\n+import matplotlib\n+matplotlib.use('agg')\n```\n\nSo, can this be closed now?",
    "created_at": "2018-03-24T03:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308096",
    "user": "https://github.com/saraedum"
}
```

It appears that #23696 fixed this:

```
+# Make sure the agg backend is selected during doctesting
+# This needs to be done before any other matplotlib calls.
+import matplotlib
+matplotlib.use('agg')
```

So, can this be closed now?



---

archive/issue_comments_308097.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-03-24T03:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308097",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_308098.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-24T09:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308098",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_308099.json:
```json
{
    "body": "Yes, I didn't know there was a matching ticket to the debian patch. But this was definitely part of my target in #23696.",
    "created_at": "2018-03-24T09:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308099",
    "user": "https://github.com/kiwifb"
}
```

Yes, I didn't know there was a matching ticket to the debian patch. But this was definitely part of my target in #23696.



---

archive/issue_comments_308100.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308100",
    "user": "https://github.com/videlec"
}
```

Resolution: wontfix



---

archive/issue_comments_308101.json:
```json
{
    "body": "closing positively reviewed duplicates",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22204#issuecomment-308101",
    "user": "https://github.com/videlec"
}
```

closing positively reviewed duplicates
