# Issue 10160: AlgebraicNumber comparisons wrong/fail

archive/issues_010160.json:
```json
{
    "body": "Assignee: @williamstein\n\nCC:  @tornaria\n\nComparing `AlgebraicNumber` with `Integer` or `Rational` can lead to unexpected results:\n\n```\nsage: x = Integer(1)\nsage: y = Rational(1,1)\nsage: z = AlgebraicNumber(1)\nsage: ( x==y, y==z, x==y )    # so far, so good\n(True, True, True)\nsage: ( set([x,y]), set([x,z]), set([y,z]) )   # what?\n(set([1]), set([1, 1]), set([1, 1]))\nsage: for i in (x,y,z):\n....:         for j in (x,y,z):\n....:             print i._cmp_(j)   # i think this is the culprit\n....: \n0\n0\n1\n1\n0\n1\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n\n/home/vbraun/Sage/patches/<ipython console> in <module>()\n\n/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/structure/element.so in sage.structure.element.Element._cmp_ (sage/structure/element.c:5842)()\n\n/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/structure/element.so in sage.structure.element.Element._cmp_c_impl (sage/structure/element.c:7336)()\n\nNotImplementedError: BUG: sort algorithm for elements of 'Integer Ring' not implemented\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/10161\n\n",
    "created_at": "2010-10-23T20:26:12Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "AlgebraicNumber comparisons wrong/fail",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10160",
    "user": "https://github.com/vbraun"
}
```
Assignee: @williamstein

CC:  @tornaria

Comparing `AlgebraicNumber` with `Integer` or `Rational` can lead to unexpected results:

```
sage: x = Integer(1)
sage: y = Rational(1,1)
sage: z = AlgebraicNumber(1)
sage: ( x==y, y==z, x==y )    # so far, so good
(True, True, True)
sage: ( set([x,y]), set([x,z]), set([y,z]) )   # what?
(set([1]), set([1, 1]), set([1, 1]))
sage: for i in (x,y,z):
....:         for j in (x,y,z):
....:             print i._cmp_(j)   # i think this is the culprit
....: 
0
0
1
1
0
1
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)

/home/vbraun/Sage/patches/<ipython console> in <module>()

/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/structure/element.so in sage.structure.element.Element._cmp_ (sage/structure/element.c:5842)()

/home/vbraun/Sage/sage/local/lib/python2.6/site-packages/sage/structure/element.so in sage.structure.element.Element._cmp_c_impl (sage/structure/element.c:7336)()

NotImplementedError: BUG: sort algorithm for elements of 'Integer Ring' not implemented
```

Issue created by migration from https://trac.sagemath.org/ticket/10161





---

archive/issue_comments_102719.json:
```json
{
    "body": "Now with segfaults! Retested on Sage 4.6.2; got some strange inconsistencies with ._cmp_() on Integer vs. Rational, and a segfault when trying to compare either to a AlgebraicNumber:\n\n```\nsage: x = Integer(1)\nsage: y = Rational(1,1)\nsage: z = AlgebraicNumber(1)\nsage: (x==y, x==z, y==z)\n(True, True, True)\nsage: (x._cmp_(y), y._cmp_(x))\n(0, 1)\nsage: x._cmp_(z)\n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component\nof Sage has a bug in it (typically accessing invalid memory)\nand is not properly wrapped with sig_on(), sig_off().\nYou might want to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate (sorry).\n------------------------------------------------------------\n```",
    "created_at": "2011-03-23T19:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10160#issuecomment-102719",
    "user": "https://github.com/haikona"
}
```

Now with segfaults! Retested on Sage 4.6.2; got some strange inconsistencies with ._cmp_() on Integer vs. Rational, and a segfault when trying to compare either to a AlgebraicNumber:

```
sage: x = Integer(1)
sage: y = Rational(1,1)
sage: z = AlgebraicNumber(1)
sage: (x==y, x==z, y==z)
(True, True, True)
sage: (x._cmp_(y), y._cmp_(x))
(0, 1)
sage: x._cmp_(z)

------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
and is not properly wrapped with sig_on(), sig_off().
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------
```



---

archive/issue_comments_102720.json:
```json
{
    "body": "The issue is actually:\n\n```\nsage: map(hash, (x,y,z))\n[1, 1, -3730706066237751940]\n```\n\nIf two things have the same hash and compare equal, then they are the same as far as dictionaries are concerned:\n\n```\nsage: d = {}\nsage: d[x] = x\nsage: d[y] = y\nsage: len(d)\n1\nsage: id(y)\n110133424\nsage: id(d[x])\n110133424\n```\n\nOne fix would be to change the hash of rational numbers.  Although, I think their hash function was designed to be consistent with the integers.",
    "created_at": "2013-07-24T16:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10160#issuecomment-102720",
    "user": "https://github.com/mwhansen"
}
```

The issue is actually:

```
sage: map(hash, (x,y,z))
[1, 1, -3730706066237751940]
```

If two things have the same hash and compare equal, then they are the same as far as dictionaries are concerned:

```
sage: d = {}
sage: d[x] = x
sage: d[y] = y
sage: len(d)
1
sage: id(y)
110133424
sage: id(d[x])
110133424
```

One fix would be to change the hash of rational numbers.  Although, I think their hash function was designed to be consistent with the integers.



---

archive/issue_events_025972.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-02T05:54:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25972"
}
```



---

archive/issue_comments_102721.json:
```json
{
    "body": "Still the same with 9.1.rc2",
    "created_at": "2020-05-02T05:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10160#issuecomment-102721",
    "user": "https://github.com/mkoeppe"
}
```

Still the same with 9.1.rc2



---

archive/issue_events_025973.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25973"
}
```



---

archive/issue_events_025974.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25974"
}
```



---

archive/issue_comments_102722.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10160#issuecomment-102722",
    "user": "https://github.com/mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_025975.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25975"
}
```



---

archive/issue_events_025976.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25976"
}
```



---

archive/issue_events_025977.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25977"
}
```



---

archive/issue_events_025978.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25978"
}
```



---

archive/issue_events_025979.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25979"
}
```



---

archive/issue_events_025980.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25980"
}
```



---

archive/issue_events_025981.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25981"
}
```



---

archive/issue_events_025982.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25982"
}
```



---

archive/issue_events_025983.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25983"
}
```



---

archive/issue_events_025984.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10160",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10160#event-25984"
}
```
