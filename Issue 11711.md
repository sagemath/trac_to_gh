# Issue 11711: fix boehm-gc so it builds on OS X Lion

archive/issues_011711.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  @nexttime\n\nKeywords: boehm-gc lion\n\nAs the summary says.  A new spkg is available here:\n\n- [http://sage.math.washington.edu/home/palmieri/SPKG/boehm_gc-7.2.alpha6.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/boehm_gc-7.2.alpha6.p0.spkg)\n\nThis also upgrades to version 7.2.alpha6. According to [the boehm-gc website](http://www.hpl.hp.com/personal/Hans_Boehm/gc/), the current stable version (7.1, which is what is included in Sage) \"is old enough that you are almost certainly better off going with the much more recent and only somewhat experimental version\", namely 7.2.alpha6.\n\nThe home base for this ticket is the Lion ticket #11881.\n\nSee #12126 for a follow-up.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11883\n\n",
    "closed_at": "2011-10-31T11:27:36Z",
    "created_at": "2011-09-30T17:32:43Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "fix boehm-gc so it builds on OS X Lion",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11711",
    "user": "https://github.com/jhpalmieri"
}
```
Assignee: tbd

CC:  @nexttime

Keywords: boehm-gc lion

As the summary says.  A new spkg is available here:

- [http://sage.math.washington.edu/home/palmieri/SPKG/boehm_gc-7.2.alpha6.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/boehm_gc-7.2.alpha6.p0.spkg)

This also upgrades to version 7.2.alpha6. According to [the boehm-gc website](http://www.hpl.hp.com/personal/Hans_Boehm/gc/), the current stable version (7.1, which is what is included in Sage) "is old enough that you are almost certainly better off going with the much more recent and only somewhat experimental version", namely 7.2.alpha6.

The home base for this ticket is the Lion ticket #11881.

See #12126 for a follow-up.

Issue created by migration from https://trac.sagemath.org/ticket/11883





---

archive/issue_comments_132441.json:
```json
{
    "body": "patch for boehm-gc spkg, for review only",
    "created_at": "2011-09-30T17:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132441",
    "user": "https://github.com/jhpalmieri"
}
```

patch for boehm-gc spkg, for review only



---

archive/issue_comments_132442.json:
```json
{
    "body": "Attachment [trac_11883-boehm-gc.patch](tarball://root/attachments/some-uuid/ticket11883/trac_11883-boehm-gc.patch) by @jhpalmieri created at 2011-09-30 17:35:42",
    "created_at": "2011-09-30T17:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132442",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_11883-boehm-gc.patch](tarball://root/attachments/some-uuid/ticket11883/trac_11883-boehm-gc.patch) by @jhpalmieri created at 2011-09-30 17:35:42



---

archive/issue_comments_132443.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-09-30T17:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132443",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_132444.json:
```json
{
    "body": "That spkg also compiles on my ARM box (bug #10285) ; which isn't the case of the one in 4.7.2-alpha4.",
    "created_at": "2011-10-29T15:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132444",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

That spkg also compiles on my ARM box (bug #10285) ; which isn't the case of the one in 4.7.2-alpha4.



---

archive/issue_comments_132445.json:
```json
{
    "body": "This builds fine on OS X 10.7 for me.  It also still builds on Linux, and works.  The changes to the spkg look fine to me too.  Thus... positive review.",
    "created_at": "2011-10-30T15:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132445",
    "user": "https://github.com/williamstein"
}
```

This builds fine on OS X 10.7 for me.  It also still builds on Linux, and works.  The changes to the spkg look fine to me too.  Thus... positive review.



---

archive/issue_comments_132446.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-30T15:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132446",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_132447.json:
```json
{
    "body": "For what it's worth, I've also built this successfully on all of the skynet machines that I have access to: cicero, cleo, eno, iras, flavius, mark, silius, and taurus.  It also builds on David Kirkby's OpenSolaris machine hawk.",
    "created_at": "2011-10-30T15:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132447",
    "user": "https://github.com/jhpalmieri"
}
```

For what it's worth, I've also built this successfully on all of the skynet machines that I have access to: cicero, cleo, eno, iras, flavius, mark, silius, and taurus.  It also builds on David Kirkby's OpenSolaris machine hawk.



---

archive/issue_events_031406.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-31T11:27:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11711#event-31406"
}
```



---

archive/issue_comments_132448.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-10-31T11:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132448",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_132449.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132449",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_031407.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:18:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11711#event-31407"
}
```



---

archive/issue_comments_132450.json:
```json
{
    "body": "Under some circumstances, this fails to install on *older* versions of Sage, which is a problem for upgrading.  I will investigate, but it is possible that this spkg will need to be unmerged.  It happens for example on sage-4.5.3 using gcc 4.5.1 on sage.math:\n\n```\n/bin/bash ./libtool --tag=CC   --mode=compile gcc -DHAVE_CONFIG_H   -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src  -\nfexceptions -g -O2 -MT mach_dep.lo -MD -MP -MF .deps/mach_dep.Tpo -c -o mach_dep.lo mach_dep.c\nrm: cannot remove `mach_dep.o': No such file or directory\nrm: cannot remove `.libs/mach_dep.o': No such file or directory\nrm: cannot remove `mach_dep.lo': No such file or directory\nrm: cannot remove `mach_dep.loT': No such file or directory\nlibtool: compile:  gcc -DHAVE_CONFIG_H -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src -fexceptions -g -O2 -MT mach_de\np.lo -MD -MP -MF .deps/mach_dep.Tpo -c mach_dep.c  -fPIC -DPIC -o .libs/mach_dep.o\nlibtool: compile:  gcc -DHAVE_CONFIG_H -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src -fexceptions -g -O2 -MT mach_de\np.lo -MD -MP -MF .deps/mach_dep.Tpo -c mach_dep.c -o mach_dep.o >/dev/null 2>&1\nmv -f .deps/mach_dep.Tpo .deps/mach_dep.Plo\n/bin/bash ./libtool --tag=CC   --mode=link gcc -fexceptions -g -O2  -version-info 1:3:0 -no-undefined  -o libgc.la -rpath /mnt/usb1/scratc\nh/jdemeyer/sage-4.5.3/local/lib allchblk.lo alloc.lo blacklst.lo checksums.lo dbg_mlc.lo dyn_load.lo finalize.lo gc_dlopen.lo gcj_mlc.lo h\neaders.lo malloc.lo mallocx.lo mark.lo mark_rts.lo misc.lo new_hblk.lo obj_map.lo os_dep.lo pcr_interface.lo ptr_chck.lo real_malloc.lo re\nclaim.lo specific.lo stubborn.lo typd_mlc.lo backgraph.lo thread_local_alloc.lo pthread_start.lo pthread_support.lo pthread_stop_world.lo\n  atomic_ops.lo mach_dep.lo -lpthread -ldl\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/allchblk.o .libs/alloc.o .libs/blacklst.o .libs/checksums.o .libs/dbg_mlc.o .libs/dyn_load.\no .libs/finalize.o .libs/gc_dlopen.o .libs/gcj_mlc.o .libs/headers.o .libs/malloc.o .libs/mallocx.o .libs/mark.o .libs/mark_rts.o .libs/mi\nsc.o .libs/new_hblk.o .libs/obj_map.o .libs/os_dep.o .libs/pcr_interface.o .libs/ptr_chck.o .libs/real_malloc.o .libs/reclaim.o .libs/spec\nific.o .libs/stubborn.o .libs/typd_mlc.o .libs/backgraph.o .libs/thread_local_alloc.o .libs/pthread_start.o .libs/pthread_support.o .libs/\npthread_stop_world.o .libs/atomic_ops.o .libs/mach_dep.o   -lpthread -ldl  -O2   -Wl,-soname -Wl,libgc.so.1 -o .libs/libgc.so.1.0.3\nlibtool: link: (cd \".libs\" && rm \"libgc.so.1\" && ln -s \"libgc.so.1.0.3\" \"libgc.so.1\")\nrm: cannot remove `libgc.so.1': No such file or directory\nmake[1]: *** [libgc.la] Error 1\nmake[1]: Leaving directory `/mnt/usb1/scratch/jdemeyer/sage-4.5.3/spkg/build/boehm_gc-7.2.alpha6.p0/src'\nmake: *** [all-recursive] Error 1\nError building BoehmGC.\n```",
    "created_at": "2011-12-02T14:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132450",
    "user": "https://github.com/jdemeyer"
}
```

Under some circumstances, this fails to install on *older* versions of Sage, which is a problem for upgrading.  I will investigate, but it is possible that this spkg will need to be unmerged.  It happens for example on sage-4.5.3 using gcc 4.5.1 on sage.math:

```
/bin/bash ./libtool --tag=CC   --mode=compile gcc -DHAVE_CONFIG_H   -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src  -
fexceptions -g -O2 -MT mach_dep.lo -MD -MP -MF .deps/mach_dep.Tpo -c -o mach_dep.lo mach_dep.c
rm: cannot remove `mach_dep.o': No such file or directory
rm: cannot remove `.libs/mach_dep.o': No such file or directory
rm: cannot remove `mach_dep.lo': No such file or directory
rm: cannot remove `mach_dep.loT': No such file or directory
libtool: compile:  gcc -DHAVE_CONFIG_H -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src -fexceptions -g -O2 -MT mach_de
p.lo -MD -MP -MF .deps/mach_dep.Tpo -c mach_dep.c  -fPIC -DPIC -o .libs/mach_dep.o
libtool: compile:  gcc -DHAVE_CONFIG_H -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src -fexceptions -g -O2 -MT mach_de
p.lo -MD -MP -MF .deps/mach_dep.Tpo -c mach_dep.c -o mach_dep.o >/dev/null 2>&1
mv -f .deps/mach_dep.Tpo .deps/mach_dep.Plo
/bin/bash ./libtool --tag=CC   --mode=link gcc -fexceptions -g -O2  -version-info 1:3:0 -no-undefined  -o libgc.la -rpath /mnt/usb1/scratc
h/jdemeyer/sage-4.5.3/local/lib allchblk.lo alloc.lo blacklst.lo checksums.lo dbg_mlc.lo dyn_load.lo finalize.lo gc_dlopen.lo gcj_mlc.lo h
eaders.lo malloc.lo mallocx.lo mark.lo mark_rts.lo misc.lo new_hblk.lo obj_map.lo os_dep.lo pcr_interface.lo ptr_chck.lo real_malloc.lo re
claim.lo specific.lo stubborn.lo typd_mlc.lo backgraph.lo thread_local_alloc.lo pthread_start.lo pthread_support.lo pthread_stop_world.lo
  atomic_ops.lo mach_dep.lo -lpthread -ldl
libtool: link: gcc -shared  -fPIC -DPIC  .libs/allchblk.o .libs/alloc.o .libs/blacklst.o .libs/checksums.o .libs/dbg_mlc.o .libs/dyn_load.
o .libs/finalize.o .libs/gc_dlopen.o .libs/gcj_mlc.o .libs/headers.o .libs/malloc.o .libs/mallocx.o .libs/mark.o .libs/mark_rts.o .libs/mi
sc.o .libs/new_hblk.o .libs/obj_map.o .libs/os_dep.o .libs/pcr_interface.o .libs/ptr_chck.o .libs/real_malloc.o .libs/reclaim.o .libs/spec
ific.o .libs/stubborn.o .libs/typd_mlc.o .libs/backgraph.o .libs/thread_local_alloc.o .libs/pthread_start.o .libs/pthread_support.o .libs/
pthread_stop_world.o .libs/atomic_ops.o .libs/mach_dep.o   -lpthread -ldl  -O2   -Wl,-soname -Wl,libgc.so.1 -o .libs/libgc.so.1.0.3
libtool: link: (cd ".libs" && rm "libgc.so.1" && ln -s "libgc.so.1.0.3" "libgc.so.1")
rm: cannot remove `libgc.so.1': No such file or directory
make[1]: *** [libgc.la] Error 1
make[1]: Leaving directory `/mnt/usb1/scratch/jdemeyer/sage-4.5.3/spkg/build/boehm_gc-7.2.alpha6.p0/src'
make: *** [all-recursive] Error 1
Error building BoehmGC.
```



---

archive/issue_comments_132451.json:
```json
{
    "body": "Okay, I think I know how to fix this: add these lines to spkg-install:\n\n```diff\n\ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -39,6 +39,10 @@ if [ $? -ne 0 ]; then\n    exit 1\n fi\n \n+if [ \"$RM\" = 'rm' ]; then\n+   unset RM\n+fi\n+\n make\n if [ $? -ne 0 ]; then\n    echo \"Error building BoehmGC.\"\n```\nIn Sage 4.5.3's version of `sage-env`, we used to have \n\n```\nif [ \"$RM\" = \"\" ]; then\n    RM=\"rm\"  && export RM\nfi\n```\nWe no longer have these lines, and their presence in 4.5.3 is why the upgrade fails.  So forcibly unsetting `$RM` if it's set to 'rm' fixes the problem, at least for me.\n\nI've posted a new spkg, listed in the ticket description, and a corresponding patch, for review.  (It's simple enough that maybe we don't need a new ticket.)",
    "created_at": "2011-12-02T20:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132451",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, I think I know how to fix this: add these lines to spkg-install:

```diff

diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -39,6 +39,10 @@ if [ $? -ne 0 ]; then
    exit 1
 fi
 
+if [ "$RM" = 'rm' ]; then
+   unset RM
+fi
+
 make
 if [ $? -ne 0 ]; then
    echo "Error building BoehmGC."
```
In Sage 4.5.3's version of `sage-env`, we used to have 

```
if [ "$RM" = "" ]; then
    RM="rm"  && export RM
fi
```
We no longer have these lines, and their presence in 4.5.3 is why the upgrade fails.  So forcibly unsetting `$RM` if it's set to 'rm' fixes the problem, at least for me.

I've posted a new spkg, listed in the ticket description, and a corresponding patch, for review.  (It's simple enough that maybe we don't need a new ticket.)



---

archive/issue_comments_132452.json:
```json
{
    "body": "Could you add a comment like\n\n```\n# In order to allow upgrades from versions < 4.7.1 of Sage,\n# we should not set $RM to \"rm\".  See\n# http://trac.sagemath.org/sage_trac/ticket/3537\n# http://trac.sagemath.org/sage_trac/ticket/11883#comment:13\nif [ \"$RM\" = 'rm' ]; then\n   unset RM\nfi\n```",
    "created_at": "2011-12-03T09:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132452",
    "user": "https://github.com/jdemeyer"
}
```

Could you add a comment like

```
# In order to allow upgrades from versions < 4.7.1 of Sage,
# we should not set $RM to "rm".  See
# http://trac.sagemath.org/sage_trac/ticket/3537
# http://trac.sagemath.org/sage_trac/ticket/11883#comment:13
if [ "$RM" = 'rm' ]; then
   unset RM
fi
```



---

archive/issue_comments_132453.json:
```json
{
    "body": "Okay, I've posted a new version with a comment like that.",
    "created_at": "2011-12-03T17:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132453",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, I've posted a new version with a comment like that.



---

archive/issue_comments_132454.json:
```json
{
    "body": "Changing keywords from \"boehm-bc lion\" to \"boehm-gc lion\".",
    "created_at": "2011-12-03T17:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132454",
    "user": "https://github.com/jhpalmieri"
}
```

Changing keywords from "boehm-bc lion" to "boehm-gc lion".



---

archive/issue_comments_132455.json:
```json
{
    "body": "Attachment [trac_11883-rm.patch](tarball://root/attachments/some-uuid/ticket11883/trac_11883-rm.patch) by @jhpalmieri created at 2011-12-03 17:15:09\n\npatch for boehm-gc p1 spkg, for review only",
    "created_at": "2011-12-03T17:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11711#issuecomment-132455",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_11883-rm.patch](tarball://root/attachments/some-uuid/ticket11883/trac_11883-rm.patch) by @jhpalmieri created at 2011-12-03 17:15:09

patch for boehm-gc p1 spkg, for review only
