# Issue 11711: fix boehm-gc so it builds on OS X Lion

Issue created by migration from https://trac.sagemath.org/ticket/11883

Original creator: jhpalmieri

Original creation time: 2011-09-30 17:32:43

Assignee: tbd

CC:  leif

Keywords: boehm-bc lion

As the summary says.  A new spkg is available here:

 - [http://sage.math.washington.edu/home/palmieri/SPKG/boehm_gc-7.2.alpha6.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/boehm_gc-7.2.alpha6.p0.spkg)


---

Comment by jhpalmieri created at 2011-09-30 17:33:45

patch for boehm-gc spkg, for review only


---

Attachment


---

Comment by jhpalmieri created at 2011-09-30 17:35:42

Changing status from new to needs_review.


---

Comment by Snark created at 2011-10-29 15:28:42

That spkg also compiles on my ARM box (bug #10285) ; which isn't the case of the one in 4.7.2-alpha4.


---

Comment by was created at 2011-10-30 15:07:47

This builds fine on OS X 10.7 for me.  It also still builds on Linux, and works.  The changes to the spkg look fine to me too.  Thus... positive review.


---

Comment by was created at 2011-10-30 15:08:13

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2011-10-30 15:25:14

For what it's worth, I've also built this successfully on all of the skynet machines that I have access to: cicero, cleo, eno, iras, flavius, mark, silius, and taurus.  It also builds on David Kirkby's OpenSolaris machine hawk.


---

Comment by jdemeyer created at 2011-10-31 11:27:36

Resolution: fixed


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2011-12-02 14:11:46

Under some circumstances, this fails to install on _older_ versions of Sage, which is a problem for upgrading.  I will investigate, but it is possible that this spkg will need to be unmerged.  It happens for example on sage-4.5.3 using gcc 4.5.1 on sage.math:

```
/bin/bash ./libtool --tag=CC   --mode=compile gcc -DHAVE_CONFIG_H   -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src  -
fexceptions -g -O2 -MT mach_dep.lo -MD -MP -MF .deps/mach_dep.Tpo -c -o mach_dep.lo mach_dep.c
rm: cannot remove `mach_dep.o': No such file or directory
rm: cannot remove `.libs/mach_dep.o': No such file or directory
rm: cannot remove `mach_dep.lo': No such file or directory
rm: cannot remove `mach_dep.loT': No such file or directory
libtool: compile:  gcc -DHAVE_CONFIG_H -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src -fexceptions -g -O2 -MT mach_de
p.lo -MD -MP -MF .deps/mach_dep.Tpo -c mach_dep.c  -fPIC -DPIC -o .libs/mach_dep.o
libtool: compile:  gcc -DHAVE_CONFIG_H -I./include -I./include -I./libatomic_ops/src -I./libatomic_ops/src -fexceptions -g -O2 -MT mach_de
p.lo -MD -MP -MF .deps/mach_dep.Tpo -c mach_dep.c -o mach_dep.o >/dev/null 2>&1
mv -f .deps/mach_dep.Tpo .deps/mach_dep.Plo
/bin/bash ./libtool --tag=CC   --mode=link gcc -fexceptions -g -O2  -version-info 1:3:0 -no-undefined  -o libgc.la -rpath /mnt/usb1/scratc
h/jdemeyer/sage-4.5.3/local/lib allchblk.lo alloc.lo blacklst.lo checksums.lo dbg_mlc.lo dyn_load.lo finalize.lo gc_dlopen.lo gcj_mlc.lo h
eaders.lo malloc.lo mallocx.lo mark.lo mark_rts.lo misc.lo new_hblk.lo obj_map.lo os_dep.lo pcr_interface.lo ptr_chck.lo real_malloc.lo re
claim.lo specific.lo stubborn.lo typd_mlc.lo backgraph.lo thread_local_alloc.lo pthread_start.lo pthread_support.lo pthread_stop_world.lo
  atomic_ops.lo mach_dep.lo -lpthread -ldl
libtool: link: gcc -shared  -fPIC -DPIC  .libs/allchblk.o .libs/alloc.o .libs/blacklst.o .libs/checksums.o .libs/dbg_mlc.o .libs/dyn_load.
o .libs/finalize.o .libs/gc_dlopen.o .libs/gcj_mlc.o .libs/headers.o .libs/malloc.o .libs/mallocx.o .libs/mark.o .libs/mark_rts.o .libs/mi
sc.o .libs/new_hblk.o .libs/obj_map.o .libs/os_dep.o .libs/pcr_interface.o .libs/ptr_chck.o .libs/real_malloc.o .libs/reclaim.o .libs/spec
ific.o .libs/stubborn.o .libs/typd_mlc.o .libs/backgraph.o .libs/thread_local_alloc.o .libs/pthread_start.o .libs/pthread_support.o .libs/
pthread_stop_world.o .libs/atomic_ops.o .libs/mach_dep.o   -lpthread -ldl  -O2   -Wl,-soname -Wl,libgc.so.1 -o .libs/libgc.so.1.0.3
libtool: link: (cd ".libs" && rm "libgc.so.1" && ln -s "libgc.so.1.0.3" "libgc.so.1")
rm: cannot remove `libgc.so.1': No such file or directory
make[1]: *** [libgc.la] Error 1
make[1]: Leaving directory `/mnt/usb1/scratch/jdemeyer/sage-4.5.3/spkg/build/boehm_gc-7.2.alpha6.p0/src'
make: *** [all-recursive] Error 1
Error building BoehmGC.
```



---

Comment by jhpalmieri created at 2011-12-02 20:36:12

Okay, I think I know how to fix this: add these lines to spkg-install:

```diff

diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -39,6 +39,10 @@ if [ $? -ne 0 ]; then
    exit 1
 fi
 
+if [ "$RM" = 'rm' ]; then
+   unset RM
+fi
+
 make
 if [ $? -ne 0 ]; then
    echo "Error building BoehmGC."
```

In Sage 4.5.3's version of `sage-env`, we used to have 

```
if [ "$RM" = "" ]; then
    RM="rm"  && export RM
fi
```

We no longer have these lines, and their presence in 4.5.3 is why the upgrade fails.  So forcibly unsetting `$RM` if it's set to 'rm' fixes the problem, at least for me.

I've posted a new spkg, listed in the ticket description, and a corresponding patch, for review.  (It's simple enough that maybe we don't need a new ticket.)


---

Comment by jdemeyer created at 2011-12-03 09:57:06

Could you add a comment like

```
# In order to allow upgrades from versions < 4.7.1 of Sage,
# we should not set $RM to "rm".  See
# http://trac.sagemath.org/sage_trac/ticket/3537
# http://trac.sagemath.org/sage_trac/ticket/11883#comment:13
if [ "$RM" = 'rm' ]; then
   unset RM
fi
```



---

Comment by jhpalmieri created at 2011-12-03 17:14:45

Okay, I've posted a new version with a comment like that.


---

Comment by jhpalmieri created at 2011-12-03 17:14:53

Changing keywords from "boehm-bc lion" to "boehm-gc lion".


---

Attachment

patch for boehm-gc p1 spkg, for review only
