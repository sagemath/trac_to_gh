# Issue 21755: Compute J-ideal of a matrix

Issue created by migration from Trac.

Original creator: cheuberg

Original creation time: 2016-11-29 16:36:50

CC:  dkrenn rrissner

In a forthcoming paper, an algorithm for computing the `J`-ideal of a matrix is given: Given a matrix `B` over a principal ideal domain `R` and an ideal `(a)`, the `(a)` ideal of `B` consists of those polynomials over `R[X]` which map `B` to a matrix in `M_n((a))`.

This ticket contains the accompanying code.


---

Comment by cheuberg created at 2016-11-30 14:31:52

Changing status from new to needs_review.


---

Comment by cheuberg created at 2016-11-30 14:31:52

Last 10 new commits:


---

Comment by git created at 2016-12-01 06:35:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-01-01 16:00:17

Changing status from needs_review to needs_work.


---

Comment by dkrenn created at 2017-01-01 16:00:17

Code looks good, is extensively tested, docs are fine. I only found the following minor issues / suggestions: 

1. correct the 2 lines with whitespace errors
1. Python 3:
  - imports at top of file
    {{{
    from __future__ import print_function
    from __future__ import absolute_import
    }}}
    AFAIK, we put this now in all SageMath-files which are already
    Python3-compatibel
  - print_function in doctests (simply use `print(...)`,
    which works in Python2 and 3
  - iteritems/iterkeys: use e.g. six
1. refactor imports to be more locally:
  e.g. heapq is only needed in one function/method, so you can put it there.
  I tend to use file-global imports only when really needed there (e.g. SageObject).
1. `print *.null_ideal(...)` in all doctests: maybe do not break
  'Univariate Polynomial Ring'; I find this hard to read
  then. Maybe break already after the preceding 'of'
  Not sure if this helps, but and/or: indent the second line.
1. `(Default: ...)` vs. `(default: ...)`; I think [SageMath](SageMath) has a preference
  for the latter:
  {{{
  sage -grep "(default:" | wc -l
  4920
  sage -grep "(Default:" | wc -l
  92
  }}}
1. doc p_minimal_polynomial, INPUT s_max vs. last sentence before EXAMPLES:
  At first sight it seems weird that in the INPUT block it can easily be
  described what happens when s_max is set, whereas in the sentence
  before the EXAMPLES block a much longer explaination is needed. Also
  t <= s_max vs s <= s_max confuses when reading first. Moreover I find the
  sentence before the EXAMPLES block hard to read.
  So maybe could be rewritten to make it easier understandable.
  Adapt this in matrix_integer_dense as well.
1. L 328: "square matrix required." full stop at end, but in no
  other raised exception.
1. As we are already talking about exceptions and FYI, sometimes they
  are formulated as proper English sentences like
  `s is not in N_{(%s^%s)}(B)`
  (but omiting the full stop, where I personally would put one as the
   sentence ends here, but I am aware that there are different
   perspectives here), sometime not like
   `%s not in (%s^%s)-ideal`
1. L559: two blanks after "return"
1. FYI, between two methods there are two empty lines most of the time,
  but not always
1. matrix_integer_dense, p_minimal_polynomials: Should it be explained
  what the `(p^t)`-minimal polynomials `\nu_t` of this matrix are?

I am not sure, why no patchbot tested this ticket yet...


---

Comment by git created at 2017-01-02 12:13:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2017-01-02 12:22:50

Thank you for your review. I modified the branch taking all your comments into account.
6. I split the sentence into two parts, perhaps it is now easier to understand. I also added a "see below" in the documentation for the input parameter to at least announce that it is somewhat tricky. I replaced several `t` by `s` to have more homogeneous notation.
7. done
8. Abbreviated all but one exception to non-sentences without full stop; one exception has been upgraded to a full sentence with full stop because I did not see a concise non-sentence formulation.
I am not sure about the patchbot; I now added the "?kick" parameter.


---

Comment by cheuberg created at 2017-01-02 12:22:50

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2017-01-02 12:49:40

Replying to [comment:6 cheuberg]:
> Thank you for your review. I modified the branch taking all your comments into account.

LGTM.

> 6. I split the sentence into two parts, perhaps it is now easier to understand. I also added a "see below" in the documentation for the input parameter to at least announce that it is somewhat tricky. I replaced several `t` by `s` to have more homogeneous notation.

Ok, thank you. I think this is much better now.

> 8. Abbreviated all but one exception to non-sentences without full stop; one exception has been upgraded to a full sentence with full stop because I did not see a concise non-sentence formulation.

Ok.

> I am not sure about the patchbot; I now added the "?kick" parameter.

So, this is a positive review from my side. I suggest to wait some more days to see if the patchbot with all plugins agrees as well.


---

Comment by tscrim created at 2017-01-03 00:13:13

Some very minor points:

- References should go in the master reference file.
- `INPUT`'s should not end in a period. One of the longer ones should be changed to:
  {{{
    - ``G`` -- a matrix over `D[X]`; the columns of
      `\begin{pmatrix}p^{t-1}I& G\end{pmatrix}` are generators
      of `\{ f\in D[X]^d \mid Af \equiv 0\pmod{p^{t-1}}\}`;
      can be set to ``None`` if ``t`` is zero
  }}}
  The other long one to change:
  {{{
        - ``s_max`` -- a positive integer (default: ``None``); if set, only
          `(p^s)`-minimal polynomials for ``s <= s_max`` are computed
          (see below for details)
  }}}
- To one line:
  {{{#!diff
-        raise ValueError(
-            "A*G not zero mod %s^%s" % (p, t-1))
+        raise ValueError("A*G not zero mod %s^%s" % (p, t-1))
  }}}
- The `assert`s are just checking that the Smith normal form is correct? I know its considered good form, but all `assert`s are (currently) checked in Sage.
- This break is strange:
  {{{#!diff
-    return sum(c//p * X**i for
-               i, c in enumerate(f.list())
+    return sum(c//p * X**i for i, c in enumerate(f.list())
                if c % p == 0)
  }}}
- Move the description of what the method does before the `INPUT:` and `OUTPUT:`. It makes it easier to parse and (IMO) is more important information.
- Use the Sage macro `\ZZ` instead of `\mathbb{Z}`. Same for `\QQ`.
- Add some whitespace around the latex. While it doesn't make a difference in the html/pdf rendered doc, it makes it easier to read when using the `?`.
- You can freely split lines in `.. MATH::` blocks.


---

Comment by git created at 2017-01-03 06:48:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2017-01-03 06:53:58

Replying to [comment:8 tscrim]:
> Some very minor points:

Thank you for your comments. I pushed changes. 

> 
> - References should go in the master reference file.

done. This required merging a 6.5.rc1 (until now, the branch was based on 6.4 which had no master reference file).

> - The `assert`s are just checking that the Smith normal form is correct? I know its considered good form, but all `assert`s are (currently) checked in Sage.

Yes, and to recall what matrix is what. I commented out those asserts checking Smith normal form.
There are several other asserts scattered through the code checking that our own code here works as expected. I kept those.

> - Move the description of what the method does before the `INPUT:` and `OUTPUT:`. It makes it easier to parse and (IMO) is more important information.

I did this in two instances; it does not seem to be trivial because the information from the input section is somehow needed. So this introduces some redundancy.

> - Add some whitespace around the latex. While it doesn't make a difference in the html/pdf rendered doc, it makes it easier to read when using the `?`.

Please be more specific where you want to have whitespace added. There is quite a number of LaTeX formulae throughout the module.


---

Comment by dkrenn created at 2017-01-03 10:19:02

Dear Travis,

Replying to [comment:8 tscrim]:
> - `INPUT`'s should not end in a period. One of the longer ones should be changed to:
>   {{{
>     - ``G`` -- a matrix over `D[X]`; the columns of
>       `\begin{pmatrix}p^{t-1}I& G\end{pmatrix}` are generators
>       of `\{ f\in D[X]^d \mid Af \equiv 0\pmod{p^{t-1}}\}`;
>       can be set to ``None`` if ``t`` is zero
>   }}}

I agree that constructs like

```
``G`` -- a matrix over `D[X]`
```

should not end in a period (by our new convention), but
the part after the first `;` is a proper English sentence, thus I think it should end in a period.

Best, Daniel


---

Comment by dkrenn created at 2017-01-03 11:22:14

Replying to [comment:11 dkrenn]:
> [...], but
> the part after the first `;` is a proper English sentence, thus I think it should end in a period.

Maybe this would be a good compromise:

```
  - ``G`` -- a matrix over `D[X]`

    The columns of
    `\begin{pmatrix}p^{t-1}I& G\end{pmatrix}` are generators
    of `\{ f\in D[X]^d \mid Af \equiv 0\pmod{p^{t-1}}\}`.
    This parameter can be set to ``None`` if ``t`` is zero.
```



---

Comment by tscrim created at 2017-01-03 14:11:25

Redundancy is not necessarily a bad thing, especially when it comes to documenting inputs.

Also, why did you leave in the `.. TODO::` about the tests? I feel like that could be easily done.

For the latex and spacing, I think this is the worst one (I'm also okay with no space after `\max`):

```diff
-        For `0<t\le \max\mathcal{S}`, a `(p^t)`-minimal polynomial is
-        For `0 < t \le \max \mathcal{S}`, a `(p^t)`-minimal polynomial is
         given by `\nu_s` where
-        `s=\min\{ r\in\mathcal{S}\mid r\ge t\}`.
-        For `t>\max\mathcal{S}`, the minimal polynomial of `B` is
+        `s = \min\{ r \in \mathcal{S} \mid r \ge t\}`.
+        For `t > \max \mathcal{S}`, the minimal polynomial of `B` is
         also a `(p^t)`-minimal polynomial.
```


Also, for `null_ideal`, I would be a bit more verbose and document it as:

```diff
     def null_ideal(self, b=0):
         r"""
-        Return the `(b)`-ideal `N_{(b)}(B)=\{f\in \ZZ[X] \mid f(B)\in M_n(b\ZZ)\}` where `B`
-        is this matrix.
+        Return the null ideal corresponding to ``b`` of ``self``.
+
+        Let `B` be an `n \times n` matrix. The *null ideal* of `b`, or `(b)`-ideal, is
+
+        .. MATH::
+
+            N_{(b)}(B) = \{f \in \ZZ[X] \mid f(B) \in M_n(b\ZZ)\}.
+
```


For `integer_valued_polynomials`, I would expect, based on the method name, that the output would be a list/tuple of polynomials. Also, overall, I'm far less convinced than other people about the necessity of an `OUTPUT` block when the documentation clearly described the output.

I like the compromise less than just allowing the periods. While I would like to adhere more to our (long standing) conventions of allowing things closer to run-on sentences to not end in periods in `INPUT` bullets, this is long enough that I am okay with it going in.


---

Comment by git created at 2017-01-03 15:02:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2017-01-03 15:26:34

Replying to [comment:13 tscrim]:
> Also, why did you leave in the `.. TODO::` about the tests? I feel like that could be easily done.

Because it does not work: First problem is that the first step (`prime_candidates`) needs Frobenius Rational Form and this is only implemented over ZZ.

Next problem is some kind of bug in lifting, cf. https://ask.sagemath.org/question/35555/lifting-a-matrix-from-mathbbqyy-1/ .

At this point, we stopped trying and decided to concentrate on the integer case first.

> For the latex and spacing, I think this is the worst one (I'm also okay with no space after `\max`):

done.


> Also, for `null_ideal`, I would be a bit more verbose and document it as:

done (in slightly different wording). This concerns the documentation in `matrix_integer_dense`.
In `compute_J_ideal.py`, the explanation is at the top of the module.

> For `integer_valued_polynomials`, I would expect, based on the method name, that the output would be a list/tuple of polynomials.

The set of integer valued polynomials of the matrix `B = matrix(ZZ, [[1, 0, 1], [1, -2, -1], [10, 0, 0]])` is
`(x<sup>3+x</sup>2−12x−20)QQ[X]+ZZ[X]+(1/4)(x^2+3x+2)ZZ[X].`
As a `ZZ[X]` module, this is not finitely generated. It is not a `QQ[X]` module. Therefore, its description needs two components. Therefore, the output is a pair where the second component is a list of polynomials.

> I like the compromise less than just allowing the periods. While I would like to adhere more to our (long standing) conventions of allowing things closer to run-on sentences to not end in periods in `INPUT` bullets, this is long enough that I am okay with it going in.

Can we leave it in the current form?


---

Comment by tscrim created at 2017-01-04 12:35:41

Replying to [comment:15 cheuberg]:
> Replying to [comment:13 tscrim]:
> > Also, why did you leave in the `.. TODO::` about the tests? I feel like that could be easily done.
> 
> Because it does not work: First problem is that the first step (`prime_candidates`) needs Frobenius Rational Form and this is only implemented over ZZ.
> 
> Next problem is some kind of bug in lifting, cf. https://ask.sagemath.org/question/35555/lifting-a-matrix-from-mathbbqyy-1/ .

Could you add these to the `.. TODO::`, because I think anyone else reading the code will ask the same question I did.

> > For `integer_valued_polynomials`, I would expect, based on the method name, that the output would be a list/tuple of polynomials.
> 
> The set of integer valued polynomials of the matrix `B = matrix(ZZ, [[1, 0, 1], [1, -2, -1], [10, 0, 0]])` is
> `(x<sup>3+x</sup>2−12x−20)QQ[X]+ZZ[X]+(1/4)(x^2+3x+2)ZZ[X].`
> As a `ZZ[X]` module, this is not finitely generated. It is not a `QQ[X]` module. Therefore, its description needs two components. Therefore, the output is a pair where the second component is a list of polynomials.

I think a bit more verbose name is warranted here, something like `generators_integer_valued_polynomials`. If you want the method to be named `integer_valued_polynomials`, then it should return the set (algebra?) of integer valued polynomials.

> > I like the compromise less than just allowing the periods. While I would like to adhere more to our (long standing) conventions of allowing things closer to run-on sentences to not end in periods in `INPUT` bullets, this is long enough that I am okay with it going in.
> 
> Can we leave it in the current form?

Yes.


---

Comment by git created at 2017-01-04 13:46:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2017-01-04 13:48:18

Replying to [comment:16 tscrim]:
> Replying to [comment:15 cheuberg]:
> > Replying to [comment:13 tscrim]:
> > > Also, why did you leave in the `.. TODO::` about the tests? I feel like that could be easily done.
> > 
> > Because it does not work: First problem is that the first step (`prime_candidates`) needs Frobenius Rational Form and this is only implemented over ZZ.
> > 
> > Next problem is some kind of bug in lifting, cf. https://ask.sagemath.org/question/35555/lifting-a-matrix-from-mathbbqyy-1/ .
> 
> Could you add these to the `.. TODO::`, because I think anyone else reading the code will ask the same question I did.

Done.
 
> I think a bit more verbose name is warranted here, something like `generators_integer_valued_polynomials`. If you want the method to be named `integer_valued_polynomials`, then it should return the set (algebra?) of integer valued polynomials.

I renamed the method to `integer_valued_polynomials_generators` for the sake of tab completion.


---

Comment by tscrim created at 2017-01-04 23:19:54

LGTM. Daniel, any other comments before we set this to a positive review.


---

Comment by dkrenn created at 2017-01-05 08:19:51

Replying to [comment:19 tscrim]:
> LGTM. Daniel, any other comments before we set this to a positive review.

Fine for me as well.


---

Comment by dkrenn created at 2017-01-05 08:19:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-01-18 20:39:00

Resolution: fixed
