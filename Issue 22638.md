# Issue 22638: py3: operator has no longer div and idiv methods

Issue created by migration from https://trac.sagemath.org/ticket/22875

Original creator: chapoton

Original creation time: 2017-04-26 11:42:12

CC:  jdemeyer tscrim jhpalmieri embray

related to #15995

this means that we need to change the coercion framework, and in particular

src/sage/structure/coerce.pyx
src/sage/structure/element.pyx


---

Comment by chapoton created at 2017-05-27 12:38:54

New commits:


---

Comment by jdemeyer created at 2017-05-27 13:04:22

Replying to [ticket:22875 chapoton]:
> this means that we need to change the coercion framework

You don't have to. You could keep using `operator.div` in Python 2. I would prefer the code to be something like

```
try:
    from operator import div, idiv
except ImportError:
    pass
```


Please revert the change to lazy import, it conflicts with #22755.


---

Comment by git created at 2017-05-27 15:43:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-27 17:48:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-16 10:03:10

Changing status from new to needs_info.


---

Comment by chapoton created at 2017-06-16 10:03:10

maybe this does not really depend on #22755 ?


---

Comment by jdemeyer created at 2017-06-16 10:44:43

Replying to [comment:7 chapoton]:
> maybe this does not really depend on #22755 ?

No, it doesn't.


---

Comment by chapoton created at 2017-06-16 11:04:54

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2017-06-16 11:04:54

thanks. So let me put this into "needs_review" and hope that a patchbot will run on it.


---

Comment by chapoton created at 2017-06-16 17:29:29

well, patchbot is morally green. Please review


---

Comment by jhpalmieri created at 2017-06-16 23:15:28

I'm confused by the Python 2-to-3 conversion here. When I look at documentation for the  [Python 2 `operator` module](https://docs.python.org/2/library/operator.html), I see for `operator.truediv`:

```
Return a / b when __future__.division is in effect. This is also known as “true” division.
```

Does this mean that we need `from __future__ import division` everywhere, or is the single import in sage.all enough?

Regarding the change

```diff
         cdef long j
         cdef long prec
 
-        if op not in (operator.add, operator.sub, operator.mul, operator.div):
+        if op not in (operator.add, operator.sub, operator.mul, operator.truediv):
             raise ValueError("op must be operator.OP where OP=add, sub, mul or div")
 
         if not isinstance(p2, Polynomial):
```

in sage/rings/polynomial/polynomial_element.pyx, the docstring needs to be changed, too:

```
        - ``op`` -- ``operator.OP`` where ``OP=add`` or ``sub`` or ``mul`` or
          ``div``.
```

Also the string in the error message: "op must be ... or _truediv_".


---

Comment by git created at 2017-06-17 07:03:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-17 07:09:38

* in python3, div does no longer exist

* in python2, the behaviour of truediv is the same as in python3

* the future import transforms the behaviour of div and / in python2 to become the same as truediv

The strategy here is very simple : get rid of any use of div everywhere, and use truediv instead. This works smoothly, as the bot has been green already.

This does not fix completely the division issue, as we may have later to add the future import in some files that use /. This has already been partially done.


---

Comment by chapoton created at 2017-06-17 20:43:25

green bot !


---

Comment by jdemeyer created at 2017-06-19 08:05:35

Replying to [comment:11 jhpalmieri]:
> I'm confused by the Python 2-to-3 conversion here. When I look at documentation for the  [Python 2 `operator` module](https://docs.python.org/2/library/operator.html), I see for `operator.truediv`:
> {{{
> Return a / b when __future__.division is in effect. This is also known as “true” division.
> }}}

You need to interpret it "Return `a/b` as if `__future__.division` is in effect" (I agree that the documentation is a bit confusing). It does true division regardless of any future imports. Analogously, `operator.div` does old-style division regardless of any futute imports.


---

Comment by jdemeyer created at 2017-06-19 08:30:12

1. `src/sage/ext/fast_callable.pyx`: I guess you should support both `div` and `truediv` (instead of only `truediv`).

2. `src/sage/interfaces/maxima_lib.py`: same as 1

3. `src/sage/rings/integer.pyx`: it is wrong to call `operator.truediv` from `__div__`. Either call `div` from `__div__` or `truediv` from `__truediv__`.

4. `src/sage/rings/polynomial/polynomial_element.pyx`: `composed_op`: same as 1

5. `src/sage/rings/qqbar.py`: add `from __future__ import division` such that the semantics remain compatible.

6. `src/sage/rings/rational.pyx`: same as 3

7. `src/sage/rings/real_lazy.pyx`: same as 5

8. `src/sage/structure/coerce.pyx`: keep the doctests involving `operator.div` on Python 2. We still want that to work on Python 2.

9. `src/sage/structure/coerce_actions.pyx`: same as 8

10. `src/sage/structure/element.pyx`: this is really wrong: `from operator import truediv as div`. "truediv" and "div" are distinct operators which should be handled separately.

I don't really understand the symbolic stuff, so I cannot really check it well. On the other hard, there is probably no reason for symbolics to treat "div" differently from "truediv".


---

Comment by jdemeyer created at 2017-06-19 08:30:12

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-19 12:43:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-21 07:51:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-22 09:58:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-09-05 14:16:42

Working on getting a working `import sage.all` on Python 3 and this is one of the fixes needed (among others).  I can work on the needed updates if you want.


---

Comment by chapoton created at 2017-09-05 14:20:22

Cool ! This is what I was trying to do, see the branch

public/python3-experiment-v1

for nearly the latest stage that I reached.


---

Comment by jdemeyer created at 2017-09-05 14:42:43

I'll push a reviewer commit, which is easier than telling you what to fix.


---

Comment by embray created at 2017-09-05 15:01:36

Replying to [comment:21 chapoton]:
> Cool ! This is what I was trying to do, see the branch
> 
> public/python3-experiment-v1
> 
> for nearly the latest stage that I reached.

Ah, I wasn't sure what your latest branch was.  I was confused because there weren't tickets for some things yet, but I was pretty sure you had something closer to working somewhere...


---

Comment by chapoton created at 2017-09-05 15:20:48

I went slightly further, in particular by adding `__hash__` in one Complex Field class somewhere. I do have a branch, I think.


---

Comment by jdemeyer created at 2017-09-05 15:31:05

These are my proposed fixes. Essentially, all fixes are to keep support for Python 2 division where applicable. I reintroduced some instances of `operator.div`, but all those are guarded in a `try`/`except` or are in `__div__` which exists only in Python 2.

For me, this ticket can get positive review if you agree with my commit.
----
New commits:


---

Comment by chapoton created at 2017-09-06 05:51:53

one failing doctest ('div' gets duplicated in this list, somehow)


---

Comment by git created at 2017-09-06 07:55:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-06 07:55:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-06 07:55:39

Fixed.


---

Comment by chapoton created at 2017-09-06 11:21:14

Looks good to me. I am ready to set to positive. Thanks a lot for finishing the job !

But maybe one should have more patchbot reports, including some with more optional packages installed, just to be sure that nothing serious breaks ?


---

Comment by chapoton created at 2017-09-07 18:06:34

ok, there are two green bots. I am setting to positive.


---

Comment by chapoton created at 2017-09-07 18:06:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-10 22:05:39

Resolution: fixed
