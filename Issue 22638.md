# Issue 22638: py3: operator has no longer div and idiv methods

archive/issues_022638.json:
```json
{
    "body": "CC:  jdemeyer tscrim jhpalmieri embray\n\nrelated to #15995\n\nthis means that we need to change the coercion framework, and in particular\n\nsrc/sage/structure/coerce.pyx\nsrc/sage/structure/element.pyx\n\nIssue created by migration from https://trac.sagemath.org/ticket/22875\n\n",
    "created_at": "2017-04-26T11:42:12Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: operator has no longer div and idiv methods",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22638",
    "user": "chapoton"
}
```
CC:  jdemeyer tscrim jhpalmieri embray

related to #15995

this means that we need to change the coercion framework, and in particular

src/sage/structure/coerce.pyx
src/sage/structure/element.pyx

Issue created by migration from https://trac.sagemath.org/ticket/22875





---

archive/issue_comments_315814.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-05-27T12:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315814",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_315815.json:
```json
{
    "body": "Replying to [ticket:22875 chapoton]:\n> this means that we need to change the coercion framework\n\nYou don't have to. You could keep using `operator.div` in Python 2. I would prefer the code to be something like\n\n```\ntry:\n    from operator import div, idiv\nexcept ImportError:\n    pass\n```\n\n\nPlease revert the change to lazy import, it conflicts with #22755.",
    "created_at": "2017-05-27T13:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315815",
    "user": "jdemeyer"
}
```

Replying to [ticket:22875 chapoton]:
> this means that we need to change the coercion framework

You don't have to. You could keep using `operator.div` in Python 2. I would prefer the code to be something like

```
try:
    from operator import div, idiv
except ImportError:
    pass
```


Please revert the change to lazy import, it conflicts with #22755.



---

archive/issue_comments_315816.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-27T15:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315816",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315817.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-27T17:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315817",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315818.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-06-16T10:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315818",
    "user": "chapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_315819.json:
```json
{
    "body": "maybe this does not really depend on #22755 ?",
    "created_at": "2017-06-16T10:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315819",
    "user": "chapoton"
}
```

maybe this does not really depend on #22755 ?



---

archive/issue_comments_315820.json:
```json
{
    "body": "Replying to [comment:7 chapoton]:\n> maybe this does not really depend on #22755 ?\n\nNo, it doesn't.",
    "created_at": "2017-06-16T10:44:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315820",
    "user": "jdemeyer"
}
```

Replying to [comment:7 chapoton]:
> maybe this does not really depend on #22755 ?

No, it doesn't.



---

archive/issue_comments_315821.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-06-16T11:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315821",
    "user": "chapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_315822.json:
```json
{
    "body": "thanks. So let me put this into \"needs_review\" and hope that a patchbot will run on it.",
    "created_at": "2017-06-16T11:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315822",
    "user": "chapoton"
}
```

thanks. So let me put this into "needs_review" and hope that a patchbot will run on it.



---

archive/issue_comments_315823.json:
```json
{
    "body": "well, patchbot is morally green. Please review",
    "created_at": "2017-06-16T17:29:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315823",
    "user": "chapoton"
}
```

well, patchbot is morally green. Please review



---

archive/issue_comments_315824.json:
```json
{
    "body": "I'm confused by the Python 2-to-3 conversion here. When I look at documentation for the  [Python 2 `operator` module](https://docs.python.org/2/library/operator.html), I see for `operator.truediv`:\n\n```\nReturn a / b when __future__.division is in effect. This is also known as \u201ctrue\u201d division.\n```\n\nDoes this mean that we need `from __future__ import division` everywhere, or is the single import in sage.all enough?\n\nRegarding the change\n\n```diff\n         cdef long j\n         cdef long prec\n \n-        if op not in (operator.add, operator.sub, operator.mul, operator.div):\n+        if op not in (operator.add, operator.sub, operator.mul, operator.truediv):\n             raise ValueError(\"op must be operator.OP where OP=add, sub, mul or div\")\n \n         if not isinstance(p2, Polynomial):\n```\n\nin sage/rings/polynomial/polynomial_element.pyx, the docstring needs to be changed, too:\n\n```\n        - ``op`` -- ``operator.OP`` where ``OP=add`` or ``sub`` or ``mul`` or\n          ``div``.\n```\n\nAlso the string in the error message: \"op must be ... or *truediv*\".",
    "created_at": "2017-06-16T23:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315824",
    "user": "jhpalmieri"
}
```

I'm confused by the Python 2-to-3 conversion here. When I look at documentation for the  [Python 2 `operator` module](https://docs.python.org/2/library/operator.html), I see for `operator.truediv`:

```
Return a / b when __future__.division is in effect. This is also known as “true” division.
```

Does this mean that we need `from __future__ import division` everywhere, or is the single import in sage.all enough?

Regarding the change

```diff
         cdef long j
         cdef long prec
 
-        if op not in (operator.add, operator.sub, operator.mul, operator.div):
+        if op not in (operator.add, operator.sub, operator.mul, operator.truediv):
             raise ValueError("op must be operator.OP where OP=add, sub, mul or div")
 
         if not isinstance(p2, Polynomial):
```

in sage/rings/polynomial/polynomial_element.pyx, the docstring needs to be changed, too:

```
        - ``op`` -- ``operator.OP`` where ``OP=add`` or ``sub`` or ``mul`` or
          ``div``.
```

Also the string in the error message: "op must be ... or *truediv*".



---

archive/issue_comments_315825.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-17T07:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315825",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315826.json:
```json
{
    "body": "* in python3, div does no longer exist\n\n* in python2, the behaviour of truediv is the same as in python3\n\n* the future import transforms the behaviour of div and / in python2 to become the same as truediv\n\nThe strategy here is very simple : get rid of any use of div everywhere, and use truediv instead. This works smoothly, as the bot has been green already.\n\nThis does not fix completely the division issue, as we may have later to add the future import in some files that use /. This has already been partially done.",
    "created_at": "2017-06-17T07:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315826",
    "user": "chapoton"
}
```

* in python3, div does no longer exist

* in python2, the behaviour of truediv is the same as in python3

* the future import transforms the behaviour of div and / in python2 to become the same as truediv

The strategy here is very simple : get rid of any use of div everywhere, and use truediv instead. This works smoothly, as the bot has been green already.

This does not fix completely the division issue, as we may have later to add the future import in some files that use /. This has already been partially done.



---

archive/issue_comments_315827.json:
```json
{
    "body": "green bot !",
    "created_at": "2017-06-17T20:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315827",
    "user": "chapoton"
}
```

green bot !



---

archive/issue_comments_315828.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> I'm confused by the Python 2-to-3 conversion here. When I look at documentation for the  [Python 2 `operator` module](https://docs.python.org/2/library/operator.html), I see for `operator.truediv`:\n> {{{\n> Return a / b when __future__.division is in effect. This is also known as \u201ctrue\u201d division.\n> }}}\n\nYou need to interpret it \"Return `a/b` as if `__future__.division` is in effect\" (I agree that the documentation is a bit confusing). It does true division regardless of any future imports. Analogously, `operator.div` does old-style division regardless of any futute imports.",
    "created_at": "2017-06-19T08:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315828",
    "user": "jdemeyer"
}
```

Replying to [comment:11 jhpalmieri]:
> I'm confused by the Python 2-to-3 conversion here. When I look at documentation for the  [Python 2 `operator` module](https://docs.python.org/2/library/operator.html), I see for `operator.truediv`:
> {{{
> Return a / b when __future__.division is in effect. This is also known as “true” division.
> }}}

You need to interpret it "Return `a/b` as if `__future__.division` is in effect" (I agree that the documentation is a bit confusing). It does true division regardless of any future imports. Analogously, `operator.div` does old-style division regardless of any futute imports.



---

archive/issue_comments_315829.json:
```json
{
    "body": "1. `src/sage/ext/fast_callable.pyx`: I guess you should support both `div` and `truediv` (instead of only `truediv`).\n\n2. `src/sage/interfaces/maxima_lib.py`: same as 1\n\n3. `src/sage/rings/integer.pyx`: it is wrong to call `operator.truediv` from `__div__`. Either call `div` from `__div__` or `truediv` from `__truediv__`.\n\n4. `src/sage/rings/polynomial/polynomial_element.pyx`: `composed_op`: same as 1\n\n5. `src/sage/rings/qqbar.py`: add `from __future__ import division` such that the semantics remain compatible.\n\n6. `src/sage/rings/rational.pyx`: same as 3\n\n7. `src/sage/rings/real_lazy.pyx`: same as 5\n\n8. `src/sage/structure/coerce.pyx`: keep the doctests involving `operator.div` on Python 2. We still want that to work on Python 2.\n\n9. `src/sage/structure/coerce_actions.pyx`: same as 8\n\n10. `src/sage/structure/element.pyx`: this is really wrong: `from operator import truediv as div`. \"truediv\" and \"div\" are distinct operators which should be handled separately.\n\nI don't really understand the symbolic stuff, so I cannot really check it well. On the other hard, there is probably no reason for symbolics to treat \"div\" differently from \"truediv\".",
    "created_at": "2017-06-19T08:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315829",
    "user": "jdemeyer"
}
```

1. `src/sage/ext/fast_callable.pyx`: I guess you should support both `div` and `truediv` (instead of only `truediv`).

2. `src/sage/interfaces/maxima_lib.py`: same as 1

3. `src/sage/rings/integer.pyx`: it is wrong to call `operator.truediv` from `__div__`. Either call `div` from `__div__` or `truediv` from `__truediv__`.

4. `src/sage/rings/polynomial/polynomial_element.pyx`: `composed_op`: same as 1

5. `src/sage/rings/qqbar.py`: add `from __future__ import division` such that the semantics remain compatible.

6. `src/sage/rings/rational.pyx`: same as 3

7. `src/sage/rings/real_lazy.pyx`: same as 5

8. `src/sage/structure/coerce.pyx`: keep the doctests involving `operator.div` on Python 2. We still want that to work on Python 2.

9. `src/sage/structure/coerce_actions.pyx`: same as 8

10. `src/sage/structure/element.pyx`: this is really wrong: `from operator import truediv as div`. "truediv" and "div" are distinct operators which should be handled separately.

I don't really understand the symbolic stuff, so I cannot really check it well. On the other hard, there is probably no reason for symbolics to treat "div" differently from "truediv".



---

archive/issue_comments_315830.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-19T08:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315830",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_315831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-19T12:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315831",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315832.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-21T07:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315832",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315833.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-22T09:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315833",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315834.json:
```json
{
    "body": "Working on getting a working `import sage.all` on Python 3 and this is one of the fixes needed (among others).  I can work on the needed updates if you want.",
    "created_at": "2017-09-05T14:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315834",
    "user": "embray"
}
```

Working on getting a working `import sage.all` on Python 3 and this is one of the fixes needed (among others).  I can work on the needed updates if you want.



---

archive/issue_comments_315835.json:
```json
{
    "body": "Cool ! This is what I was trying to do, see the branch\n\npublic/python3-experiment-v1\n\nfor nearly the latest stage that I reached.",
    "created_at": "2017-09-05T14:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315835",
    "user": "chapoton"
}
```

Cool ! This is what I was trying to do, see the branch

public/python3-experiment-v1

for nearly the latest stage that I reached.



---

archive/issue_comments_315836.json:
```json
{
    "body": "I'll push a reviewer commit, which is easier than telling you what to fix.",
    "created_at": "2017-09-05T14:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315836",
    "user": "jdemeyer"
}
```

I'll push a reviewer commit, which is easier than telling you what to fix.



---

archive/issue_comments_315837.json:
```json
{
    "body": "Replying to [comment:21 chapoton]:\n> Cool ! This is what I was trying to do, see the branch\n> \n> public/python3-experiment-v1\n> \n> for nearly the latest stage that I reached.\n\nAh, I wasn't sure what your latest branch was.  I was confused because there weren't tickets for some things yet, but I was pretty sure you had something closer to working somewhere...",
    "created_at": "2017-09-05T15:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315837",
    "user": "embray"
}
```

Replying to [comment:21 chapoton]:
> Cool ! This is what I was trying to do, see the branch
> 
> public/python3-experiment-v1
> 
> for nearly the latest stage that I reached.

Ah, I wasn't sure what your latest branch was.  I was confused because there weren't tickets for some things yet, but I was pretty sure you had something closer to working somewhere...



---

archive/issue_comments_315838.json:
```json
{
    "body": "I went slightly further, in particular by adding `__hash__` in one Complex Field class somewhere. I do have a branch, I think.",
    "created_at": "2017-09-05T15:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315838",
    "user": "chapoton"
}
```

I went slightly further, in particular by adding `__hash__` in one Complex Field class somewhere. I do have a branch, I think.



---

archive/issue_comments_315839.json:
```json
{
    "body": "These are my proposed fixes. Essentially, all fixes are to keep support for Python 2 division where applicable. I reintroduced some instances of `operator.div`, but all those are guarded in a `try`/`except` or are in `__div__` which exists only in Python 2.\n\nFor me, this ticket can get positive review if you agree with my commit.\n----\nNew commits:",
    "created_at": "2017-09-05T15:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315839",
    "user": "jdemeyer"
}
```

These are my proposed fixes. Essentially, all fixes are to keep support for Python 2 division where applicable. I reintroduced some instances of `operator.div`, but all those are guarded in a `try`/`except` or are in `__div__` which exists only in Python 2.

For me, this ticket can get positive review if you agree with my commit.
----
New commits:



---

archive/issue_comments_315840.json:
```json
{
    "body": "one failing doctest ('div' gets duplicated in this list, somehow)",
    "created_at": "2017-09-06T05:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315840",
    "user": "chapoton"
}
```

one failing doctest ('div' gets duplicated in this list, somehow)



---

archive/issue_comments_315841.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-06T07:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315841",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315842.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-06T07:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315842",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_315843.json:
```json
{
    "body": "Fixed.",
    "created_at": "2017-09-06T07:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315843",
    "user": "jdemeyer"
}
```

Fixed.



---

archive/issue_comments_315844.json:
```json
{
    "body": "Looks good to me. I am ready to set to positive. Thanks a lot for finishing the job !\n\nBut maybe one should have more patchbot reports, including some with more optional packages installed, just to be sure that nothing serious breaks ?",
    "created_at": "2017-09-06T11:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315844",
    "user": "chapoton"
}
```

Looks good to me. I am ready to set to positive. Thanks a lot for finishing the job !

But maybe one should have more patchbot reports, including some with more optional packages installed, just to be sure that nothing serious breaks ?



---

archive/issue_comments_315845.json:
```json
{
    "body": "ok, there are two green bots. I am setting to positive.",
    "created_at": "2017-09-07T18:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315845",
    "user": "chapoton"
}
```

ok, there are two green bots. I am setting to positive.



---

archive/issue_comments_315846.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-07T18:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315846",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_315847.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T22:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22638#issuecomment-315847",
    "user": "vbraun"
}
```

Resolution: fixed
