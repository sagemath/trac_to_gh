# Issue 21035: hash for Laurent polynomials is broken

archive/issues_021035.json:
```json
{
    "body": "\n```\nsage: R.<t> = LaurentPolynomialRing(ZZ)\nsage: hash(R.zero())\n0\nsage: hash(t - t)\n1\n```\n\n\nOriginal report:\n\n    https://groups.google.com/forum/#!topic/sage-support/HqP8dXYNDTU\n\nIssue created by migration from https://trac.sagemath.org/ticket/21272\n\n",
    "created_at": "2016-08-17T21:52:41Z",
    "labels": [
        "algebra",
        "major",
        "bug"
    ],
    "title": "hash for Laurent polynomials is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21035",
    "user": "vdelecroix"
}
```

```
sage: R.<t> = LaurentPolynomialRing(ZZ)
sage: hash(R.zero())
0
sage: hash(t - t)
1
```


Original report:

    https://groups.google.com/forum/#!topic/sage-support/HqP8dXYNDTU

Issue created by migration from https://trac.sagemath.org/ticket/21272





---

archive/issue_comments_291500.json:
```json
{
    "body": "Fixing `__normalize` should be pretty easy: laurent polynomials are represented as u*x<sup>n</sup>, where u is a unit or 0. Normalize should simply force `n` to be a particular value (probably `n=0`) if `u=0`.",
    "created_at": "2016-08-18T04:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291500",
    "user": "nbruin"
}
```

Fixing `__normalize` should be pretty easy: laurent polynomials are represented as u*x<sup>n</sup>, where u is a unit or 0. Normalize should simply force `n` to be a particular value (probably `n=0`) if `u=0`.



---

archive/issue_comments_291501.json:
```json
{
    "body": "Sure but there are other things I want to do:\n- the hash should coincide with polynomials when valuation is >= 0\n- the hash should be non-trivial enough to avoid simple collisions",
    "created_at": "2016-08-18T13:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291501",
    "user": "vdelecroix"
}
```

Sure but there are other things I want to do:
- the hash should coincide with polynomials when valuation is >= 0
- the hash should be non-trivial enough to avoid simple collisions



---

archive/issue_comments_291502.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-18T14:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291502",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_291503.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-18T14:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291503",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_291504.json:
```json
{
    "body": "* How did you choose the value `700005`? \n* You should replace `TESTS:` by `TESTS::` in `__hash__`.",
    "created_at": "2016-08-22T12:17:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291504",
    "user": "bruno"
}
```

* How did you choose the value `700005`? 
* You should replace `TESTS:` by `TESTS::` in `__hash__`.



---

archive/issue_comments_291505.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-12-16T04:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291505",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_291506.json:
```json
{
    "body": "vdelecroix: Can you somehow push this branch again? For me, all it shows in trac is that the laurent_polynomial.pyx file has been deleted.",
    "created_at": "2016-12-16T04:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291506",
    "user": "saraedum"
}
```

vdelecroix: Can you somehow push this branch again? For me, all it shows in trac is that the laurent_polynomial.pyx file has been deleted.



---

archive/issue_comments_291507.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-12-16T13:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291507",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_291508.json:
```json
{
    "body": "Rebased on 7.5.beta6!",
    "created_at": "2016-12-16T13:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291508",
    "user": "vdelecroix"
}
```

Rebased on 7.5.beta6!



---

archive/issue_comments_291509.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-17T12:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291509",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_291510.json:
```json
{
    "body": "Replying to [comment:6 bruno]:\n> * How did you choose the value `700005`? \n\nA fairly random number.\n\n> * You should replace `TESTS:` by `TESTS::` in `__hash__`.\n\nDone. Thanks.",
    "created_at": "2016-12-17T12:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291510",
    "user": "vdelecroix"
}
```

Replying to [comment:6 bruno]:
> * How did you choose the value `700005`? 

A fairly random number.

> * You should replace `TESTS:` by `TESTS::` in `__hash__`.

Done. Thanks.



---

archive/issue_comments_291511.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-12-17T12:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291511",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_291512.json:
```json
{
    "body": "If you agree with my change, feel free to set this to positive review.",
    "created_at": "2016-12-17T16:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291512",
    "user": "saraedum"
}
```

If you agree with my change, feel free to set this to positive review.



---

archive/issue_comments_291513.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-12-17T16:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291513",
    "user": "saraedum"
}
```

New commits:



---

archive/issue_comments_291514.json:
```json
{
    "body": "Have you considered turning `__u` into a sparse polynomial, shifting it, and computing the hash from there? I guess that would be my only proposal here to remove a duplication of code. But it is probably not worth it. Your tests should catch any changes in the implementation of the hash function of polynomials\u2026",
    "created_at": "2016-12-17T16:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291514",
    "user": "saraedum"
}
```

Have you considered turning `__u` into a sparse polynomial, shifting it, and computing the hash from there? I guess that would be my only proposal here to remove a duplication of code. But it is probably not worth it. Your tests should catch any changes in the implementation of the hash function of polynomials…



---

archive/issue_comments_291515.json:
```json
{
    "body": "Replying to [comment:17 saraedum]:\n> Have you considered turning `__u` into a sparse polynomial, shifting it, and computing the hash from there? I guess that would be my only proposal here to remove a duplication of code. But it is probably not worth it. Your tests should catch any changes in the implementation of the hash function of polynomials\u2026\n\nConverting the data structure at the time of the hash is not a good idea (time costly). Is this what you were proposing? On the other hand, modifying the internal data structure of laurent polynomials is beyond the scope of this ticket.",
    "created_at": "2016-12-19T07:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291515",
    "user": "vdelecroix"
}
```

Replying to [comment:17 saraedum]:
> Have you considered turning `__u` into a sparse polynomial, shifting it, and computing the hash from there? I guess that would be my only proposal here to remove a duplication of code. But it is probably not worth it. Your tests should catch any changes in the implementation of the hash function of polynomials…

Converting the data structure at the time of the hash is not a good idea (time costly). Is this what you were proposing? On the other hand, modifying the internal data structure of laurent polynomials is beyond the scope of this ticket.



---

archive/issue_comments_291516.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-23T23:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291516",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_291517.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-01-18T20:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21035#issuecomment-291517",
    "user": "vbraun"
}
```

Resolution: fixed
