# Issue 23249: Echelon form for p-adic matrices

Issue created by migration from https://trac.sagemath.org/ticket/23486

Original creator: caruso

Original creation time: 2017-07-20 04:10:42

CC:  roed saraedum tristanvaccon

Keywords: sd87

This ticket implements echelon form for matrices over complete discrete valuation rings/fields.


---

Comment by caruso created at 2017-07-20 04:11:24

New commits:


---

Comment by git created at 2017-07-20 17:24:50

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by caruso created at 2017-07-20 17:25:18

Ticket ready for review!


---

Comment by caruso created at 2017-07-20 17:25:35

Changing status from new to needs_review.


---

Comment by bhutz created at 2017-07-20 20:58:38

I looked at this from a functionality perspective as opposed to looking through the algorithm line by line.

All of the examples I was able to come up with behaved as expected, so I just have a few minor issues

- 2 doc test failures

```
sage -t --warn-long 72.0 rings/laurent_series_ring.py  # 1 doctest failed
sage -t --warn-long 72.0 rings/padics/tests.py  # 1 doctest failed
```


- in a couple places you say

```
if `d_i` denotes the `(i,i)` entry of `D`
```

I think you means `D` to be `S`

- extra word

```
'it is possible to do not'
```


- in several places you say 'also possible for rectangular matrices' where you mean 'nonrectangular'

- in two different places for echelon form you state it as find the Smith normal form instead of the echelon form

```
to determine the Smith normal form
```


- is there a reason to assign

```
    else:
        left = right = None
```

they don't seem to be used later.

- incorrect word


```
integer this of this
```

should be 'integer ring of this'


---

Comment by bhutz created at 2017-07-20 20:58:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-21 01:20:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2017-07-21 01:27:26

Thanks for your comments.

I fixed the wording.
The failing doctests were due to the fact that, in the case of a matrix M defined over a complete discrete valuation *field* K, my function `echelon_form()` did not compute the row-echelon from of M over K but over its ring of integers (i.e. the transformation matrix has coefficients in the ring of integers and is invertible over it). I then changed the name for `integral_echelon_from()`.

NB: Some of your comments are related to ticket #23450. Maybe you should look at this one as well.


---

Comment by caruso created at 2017-07-21 01:36:44

Changing status from needs_work to needs_review.


---

Comment by roed created at 2018-05-24 20:05:42

See also #17272, which just got a positive review.
----
New commits:


---

Comment by caruso created at 2018-05-24 20:37:53

Great! So, what do we do with this ticket (which is now a kind of redundant)?


---

Comment by roed created at 2018-05-24 20:41:47

Are there any features here that aren't included in #17272?


---

Comment by caruso created at 2018-05-24 20:51:23

The computation of transformation matrices, I think.

Moreover, for matrices over Qp, it makes sense to have an option for computing the echelon form over Zp (that is, without renormalizing the pivots) in order to save precision. But I don't think that it's implemented in this ticket.


---

Comment by roed created at 2018-07-22 20:22:35

Changing keywords from "sd87" to "sd87, padicIMA".


---

Comment by caruso created at 2018-07-25 22:36:43

Changing status from needs_review to needs_work.


---

Comment by caruso created at 2018-07-25 22:36:43

New commits:


---

Comment by roed created at 2019-09-07 09:52:45

Changing keywords from "sd87, padicIMA" to "sd87, padicIMA, padicBordeaux".


---

Comment by roed created at 2019-09-09 09:09:46

I merged in the latest beta, but this still needs to be reconciled with #17272.  I think there are features here that we want that weren't done by #17272 (for example, when the base ring is Zp), so this ticket should remain open.
----
New commits:


---

Comment by caruso created at 2022-02-14 13:16:33

I noticed that there is a lot of variations between the way operations over matrices are designed:
- `echelon_form` is directly implemented in the class `sage.matrix.matrix2.Matrix`
- `smith_form` calls the method `_matrix_smith_form` of the base ring; concretely, this method is implemented in the class `sage.rings.padics.local_generic.LocalGeneric`
- `hessenberg_form` calls the method `_matrix_hessenbergize` of the base ring; this method is defined in the category `sage.categories.discrete_valuation.DiscreteValuationFields` and concretely implemented in the separate file `sage.matrix.matrix_cdv`.

I think it would be a good thing to uniformize all of this and, personally, I have a small preference for the third approach. What's your opinion?

----
New commits:


---

Comment by git created at 2022-02-14 13:28:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-16 17:36:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2022-02-16 17:43:22

Changing status from needs_work to needs_review.


---

Comment by caruso created at 2022-02-16 17:43:22

I followed the third approach: I put everything in the category and put the code in a separate `pyx` file. So far, most of the code is written in pure python; maybe we should move to cython at some point.

There is some code duplication due to the fact that we have separate categories for discrete valuation rings and fields but not a common category for both.

Anyway, everything is supposed over all types of p-adics as well as over power series and Laurent series rings. Moreover, with the general machinery already provided by sage, this is enough to manipulate free modules over those rings, including then lattices in finite dimensional p-adic vector spaces.


---

Comment by git created at 2022-02-16 17:47:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2022-02-16 19:54:52

Have you considered putting things into a `.py` file instead? I don't think that it makes a real difference in terms of performance (and I am struggling right now to debug an (unrelated) call that uses too much Cython ;) )


---

Comment by caruso created at 2022-02-16 19:59:25

The point is that `matrix_cdv.pyx` already exists with some cython code inside. But I can probably split the file in two parts and call them `matrix_cdv_python` and `matrix_cdv_cython`.


---

Comment by caruso created at 2022-02-19 19:24:10

Changing status from needs_review to needs_work.


---

Comment by caruso created at 2022-02-19 19:24:10

The patchbot reported a lot of doctest failures... :-(


---

Comment by git created at 2022-02-20 09:16:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2022-02-20 09:17:41

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-02-20 09:22:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-20 09:34:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-20 16:05:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-20 20:40:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2022-02-20 21:28:46

Here are the test failures when I ran tests locally:

```
Doctesting 7 files using 64 threads.
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/matrix/matrix_cdv.pxd
    [0 tests, 0.00 s]
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/matrix/matrix2.pxd
    [0 tests, 0.00 s]
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/matrix/matrix_cdv.pyx
**********************************************************************
File "src/sage/matrix/matrix_cdv.pyx", line 710, in sage.matrix.matrix_cdv.hessenbergize_cdvf
Failed example:
    M.charpoly()
Expected:
    x^3 + (1 + 4*t + 4*t^2 + O(t^3))*x^2 + (t + 2*t^2 + O(t^3))*x + 3 + 2*t^2 + O(t^3)
Got:
    x^3 + (1 + 4*t + 4*t^2 + O(t^4))*x^2 + (t + 2*t^2 + O(t^3))*x + 3 + 2*t^2 + O(t^3)
**********************************************************************
1 item had failures:
   1 of  11 in sage.matrix.matrix_cdv.hessenbergize_cdvf
    [41 tests, 1 failure, 0.08 s]
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/rings/laurent_series_ring.py
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 119, in sage.rings.laurent_series_ring.LaurentSeriesRing
Failed example:
    TestSuite(F).run()
Expected nothing
Got:
    Failure in _test_euclidean_degree:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/euclidean_domains.py", line 155, in _test_euclidean_degree
        tester.assertEqual(a.euclidean_degree() == min_degree, a.is_unit())
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: False != True
    ------------------------------------------------------------
    Failure in _test_gcd_vs_xgcd:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/principal_ideal_domains.py", line 119, in _test_gcd_vs_xgcd
        tester.assertTrue(gcd==xgcd[0],
      File "/usr/lib/python3.8/unittest/case.py", line 765, in assertTrue
        raise self.failureException(msg)
    AssertionError: The methods gcd and xgcd disagree on Laurent Series Ring in x over Rational Field:
      gcd(x,x) = x
     xgcd(x,x) = (1, x^-1, 0)
    ------------------------------------------------------------
    Failure in _test_matrix_smith:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/complete_discrete_valuation.py", line 304, in _test_matrix_smith
        tester.assertEqual(U.base_ring(), base)
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: Laurent Series Ring in x over Rational Field != Power Series Ring in x over Rational Field
    ------------------------------------------------------------
    The following tests failed: _test_euclidean_degree, _test_gcd_vs_xgcd, _test_matrix_smith
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 128, in sage.rings.laurent_series_ring.LaurentSeriesRing
Failed example:
    F.category()
Expected:
    Join of Category of complete discrete valuation fields and Category of commutative algebras over (finite enumerated fields and subquotients of monoids and quotients of semigroups) and Category of infinite sets
Got:
    Join of Category of complete discrete valuation rings and Category of commutative algebras over (finite enumerated fields and subquotients of monoids and quotients of semigroups) and Category of infinite sets
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 130, in sage.rings.laurent_series_ring.LaurentSeriesRing
Failed example:
    TestSuite(F).run()
Expected nothing
Got:
    Failure in _test_euclidean_degree:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/euclidean_domains.py", line 155, in _test_euclidean_degree
        tester.assertEqual(a.euclidean_degree() == min_degree, a.is_unit())
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: False != True
    ------------------------------------------------------------
    Failure in _test_gcd_vs_xgcd:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/principal_ideal_domains.py", line 119, in _test_gcd_vs_xgcd
        tester.assertTrue(gcd==xgcd[0],
      File "/usr/lib/python3.8/unittest/case.py", line 765, in assertTrue
        raise self.failureException(msg)
    AssertionError: The methods gcd and xgcd disagree on Laurent Series Ring in x over Finite Field of size 11:
      gcd(x,x) = x
     xgcd(x,x) = (1, x^-1, 0)
    ------------------------------------------------------------
    Failure in _test_matrix_smith:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/complete_discrete_valuation.py", line 304, in _test_matrix_smith
        tester.assertEqual(U.base_ring(), base)
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: Laurent Series Ring in x over Finite Field of size 11 != Power Series Ring in x over Finite Field of size 11
    ------------------------------------------------------------
    The following tests failed: _test_euclidean_degree, _test_gcd_vs_xgcd, _test_matrix_smith
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 151, in sage.rings.laurent_series_ring.LaurentSeriesRing
Failed example:
    LaurentSeriesRing(QQ, 'x').category()
Expected:
    Join of Category of complete discrete valuation fields and Category of commutative algebras over (number fields and quotient fields and metric spaces) and Category of infinite sets
Got:
    Join of Category of complete discrete valuation rings and Category of fields and Category of commutative algebras over (number fields and quotient fields and metric spaces) and Category of infinite sets
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 227, in sage.rings.laurent_series_ring.LaurentSeriesRing.__init__
Failed example:
    R2.category()
Expected:
    Join of Category of complete discrete valuation fields and Category of commutative algebras over (finite enumerated fields and subquotients of monoids and quotients of semigroups) and Category of infinite sets
Got:
    Join of Category of complete discrete valuation rings and Category of commutative algebras over (finite enumerated fields and subquotients of monoids and quotients of semigroups) and Category of infinite sets
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 229, in sage.rings.laurent_series_ring.LaurentSeriesRing.__init__
Failed example:
    TestSuite(R2).run()
Expected nothing
Got:
    Failure in _test_euclidean_degree:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/euclidean_domains.py", line 155, in _test_euclidean_degree
        tester.assertEqual(a.euclidean_degree() == min_degree, a.is_unit())
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: False != True
    ------------------------------------------------------------
    Failure in _test_gcd_vs_xgcd:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/principal_ideal_domains.py", line 119, in _test_gcd_vs_xgcd
        tester.assertTrue(gcd==xgcd[0],
      File "/usr/lib/python3.8/unittest/case.py", line 765, in assertTrue
        raise self.failureException(msg)
    AssertionError: The methods gcd and xgcd disagree on Laurent Series Ring in t over Ring of integers modulo 2:
      gcd(t,t) = t
     xgcd(t,t) = (1, t^-1, 0)
    ------------------------------------------------------------
    Failure in _test_matrix_smith:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/complete_discrete_valuation.py", line 304, in _test_matrix_smith
        tester.assertEqual(U.base_ring(), base)
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: Laurent Series Ring in t over Ring of integers modulo 2 != Power Series Ring in t over Ring of integers modulo 2
    ------------------------------------------------------------
    The following tests failed: _test_euclidean_degree, _test_gcd_vs_xgcd, _test_matrix_smith
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 237, in sage.rings.laurent_series_ring.LaurentSeriesRing.__init__
Failed example:
    RQQ.category()
Expected:
    Join of Category of complete discrete valuation fields and Category of commutative algebras over (number fields and quotient fields and metric spaces) and Category of infinite sets
Got:
    Join of Category of complete discrete valuation rings and Category of commutative algebras over (number fields and quotient fields and metric spaces) and Category of infinite sets
**********************************************************************
File "src/sage/rings/laurent_series_ring.py", line 239, in sage.rings.laurent_series_ring.LaurentSeriesRing.__init__
Failed example:
    TestSuite(RQQ).run()
Expected nothing
Got:
    Failure in _test_euclidean_degree:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/euclidean_domains.py", line 155, in _test_euclidean_degree
        tester.assertEqual(a.euclidean_degree() == min_degree, a.is_unit())
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: False != True
    ------------------------------------------------------------
    Failure in _test_gcd_vs_xgcd:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/principal_ideal_domains.py", line 119, in _test_gcd_vs_xgcd
        tester.assertTrue(gcd==xgcd[0],
      File "/usr/lib/python3.8/unittest/case.py", line 765, in assertTrue
        raise self.failureException(msg)
    AssertionError: The methods gcd and xgcd disagree on Laurent Series Ring in t over Rational Field:
      gcd(t,t) = t
     xgcd(t,t) = (1, t^-1, 0)
    ------------------------------------------------------------
    Failure in _test_matrix_smith:
    Traceback (most recent call last):
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "/home/roed/sage-9.6.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/complete_discrete_valuation.py", line 304, in _test_matrix_smith
        tester.assertEqual(U.base_ring(), base)
      File "/usr/lib/python3.8/unittest/case.py", line 912, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/usr/lib/python3.8/unittest/case.py", line 905, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: Laurent Series Ring in t over Rational Field != Power Series Ring in t over Rational Field
    ------------------------------------------------------------
    The following tests failed: _test_euclidean_degree, _test_gcd_vs_xgcd, _test_matrix_smith
**********************************************************************
2 items had failures:
   4 of  43 in sage.rings.laurent_series_ring.LaurentSeriesRing
   4 of  18 in sage.rings.laurent_series_ring.LaurentSeriesRing.__init__
    [182 tests, 8 failures, 0.21 s]
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/rings/multi_power_series_ring_element.py
**********************************************************************
File "src/sage/rings/multi_power_series_ring_element.py", line 1081, in sage.rings.multi_power_series_ring_element.MPowerSeries.__mod__
Failed example:
    g in R
Expected:
    False
Got:
    True
**********************************************************************
1 item had failures:
   1 of   7 in sage.rings.multi_power_series_ring_element.MPowerSeries.__mod__
    [466 tests, 1 failure, 0.27 s]
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/categories/complete_discrete_valuation.py
**********************************************************************
File "src/sage/categories/complete_discrete_valuation.py", line 621, in sage.categories.complete_discrete_valuation.CompleteDiscreteValuationFields
Failed example:
    LaurentSeriesRing(QQ,'u') in CompleteDiscreteValuationFields()
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   6 in sage.categories.complete_discrete_valuation.CompleteDiscreteValuationFields
    [200 tests, 1 failure, 0.24 s]
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/matrix/matrix2.pyx
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 9855, in sage.matrix.matrix2.Matrix.inverse
Failed example:
    ~M
Expected:
    [t^-1 t^-2]
    [   0 t^-1]
Got:
    [1 0]
    [0 1]
**********************************************************************
1 item had failures:
   1 of  13 in sage.matrix.matrix2.Matrix.inverse
    [2807 tests, 1 failure, 8.67 s]
----------------------------------------------------------------------
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/matrix/matrix_cdv.pyx  # 1 doctest failed
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/rings/laurent_series_ring.py  # 8 doctests failed
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/rings/multi_power_series_ring_element.py  # 1 doctest failed
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/categories/complete_discrete_valuation.py  # 1 doctest failed
sage -t --long --warn-long 40.9 --random-seed=317472647872885548861559054668703098865 src/sage/matrix/matrix2.pyx  # 1 doctest failed
```



---

Comment by roed created at 2022-02-20 22:11:35

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-20 22:50:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2022-02-20 22:51:29

I fixed the doctest failures, except the one in `src/sage/rings/multi_power_series_ring_element.py` because I can't understand the relation with this ticket. Any idea?


---

Comment by caruso created at 2022-02-20 23:08:18

Oh, it's just because I removed the function `__contains__` in `sage.rings.power_series_ring`.

However, this function didn't work as expected. Typically, we had:

```
sage: R.<t> = QQ[[]]
sage: K = R.fraction_field()
sage: K(t) in R
False
```


Falling back to the generic implementation of `__contains__`, this problem disappears but an element in `Z/2Z[This is the Trac macro *u* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#u-macro)` is considered as belonging to `Z[This is the Trac macro *u* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#u-macro)`. It's certainly not mathematically correct but the same holds for polynomials. So I'm not sure if it's better to fix the bug (I don't expect this to be easy) or the doctest.


---

Comment by roed created at 2022-02-20 23:21:23

I think this is just a consequence of Sage's longstanding definition of containment.  It's analogous to

```
sage: mod(3, 7) in ZZ                                                                                                  
True
```

So I would say that restoring the generic behavior for containment is correct.


---

Comment by caruso created at 2022-02-20 23:26:41

OK. Do you agree if I just remove the failing doctest?


---

Comment by roed created at 2022-02-21 01:19:32

I agree.  In fact, the implementation of `__mod__` here does not agree with the convention in the rest of Sage, where `__mod__` returns something in the same parent rather than just changing the base ring.  But I think that's an issue for another ticket.


---

Comment by git created at 2022-02-21 01:36:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2022-02-21 01:36:55

Changing status from needs_work to needs_review.


---

Comment by roed created at 2022-02-21 01:40:38

Another comment (since I see you're still awake)

* Anywhere you use backslashes in docstrings you need to make sure that they're raw strings (have an "r" before the triple quote)

I'm reading through the changes now and may have more comments....


---

Comment by git created at 2022-02-21 10:08:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-05-12 07:11:06

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2022-05-12 07:11:06

red branch => needs work


---

Comment by git created at 2022-05-19 09:51:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2022-05-19 09:58:15

I fixed merging issues.

I put needs review in order to get feedback from the patchbot.


---

Comment by caruso created at 2022-05-19 09:58:15

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-19 17:01:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-19 20:31:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-19 20:44:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-19 20:50:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2022-05-19 21:10:19

Are you using any results from the articles you wrote on p-adic precision? If so, I think that it would be nice to reference the articles in the ALGORITHM sections.
----
New commits:


---

Comment by saraedum created at 2022-05-19 21:28:34

How are these change related to this issue? Can they be reverted?


```
diff --git a/src/sage/rings/padics/relaxed_template.pxi b/src/sage/rings/padics/relaxed_template.pxi
index 7269da0..42af3ea 100644
--- a/src/sage/rings/padics/relaxed_template.pxi
+++ b/src/sage/rings/padics/relaxed_template.pxi
@@ -1265,19 +1265,10 @@ cdef class RelaxedElement(pAdicGenericElement):
             sage: a.lift_to_precision(20)
             4*5 + 4*5^2 + 5^4 + O(5^20)
 
-        When the precision is omitted, the default precision of the parent
-        is used::
+        When the precision is omitted, the element is made unbounded::
 
             sage: a.lift_to_precision()
-            4*5 + 4*5^2 + 5^4 + O(5^10)
-
-        When the parent is a field, the behaviour is slightly different since
-        the default precision of the parent becomes the relative precision
-        of the lifted element::
-
-            sage: K = R.fraction_field()
-            sage: K(a).lift_to_precision()
-            4*5 + 4*5^2 + 5^4 + O(5^11)
+            4*5 + 4*5^2 + 5^4 + ...
 
         Note that the precision never decreases::
 
@@ -1298,13 +1289,14 @@ cdef class RelaxedElement(pAdicGenericElement):
         cdef long prec
         cdef long default_prec = self._parent.default_prec()
         if absprec is None:
-            if self.prime_pow.in_field:
-                self._jump_relative_c(1, self._precbound)
-                if self._precrel == 0:
-                    return self._parent.zero()
-                prec = self._valuation + default_prec
-            else:
-                prec = default_prec
+            prec = maxordp
+            #if self.prime_pow.in_field:
+            #    self._jump_relative_c(1, self._precbound)
+            #    if self._precrel == 0:
+            #        return self._parent.zero()
+            #    prec = self._valuation + default_prec
+            #else:
+            #    prec = default_prec
         else:
             if absprec > maxordp:
                 raise OverflowError("beyond the maximal precision (which is %s)" % maxordp)
```



---

Comment by git created at 2022-05-19 21:33:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2022-05-19 21:34:34

Xavier, I made some review changes, trying to simplify things a bit and improving some docstrings (hopefully.)

This looks great to me, so once doctests pass again an the above comments have been adressed, this is good to be merged.
----
New commits:


---

Comment by caruso created at 2022-05-21 10:23:22

It seems that your class `SharedParentMethods` does not work.


```
sage: R = Zp(5, prec=10)
sage: R._matrix_echelonize
Traceback (most recent call last):
...
AttributeError: 'pAdicRingCappedRelative_with_category' object has no attribute '_matrix_echelonize'
```

----
New commits:


---

Comment by caruso created at 2022-06-02 09:22:04

I'm getting the following warning when Sage starts:

```
/home/xcaruso/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/categories/category.py:1592: UserWarning: CompleteDiscreteValuationRings.ParentMethods should not have a super class
```

So I'm coming back to the previous version.


---

Comment by git created at 2022-06-02 09:27:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-02 09:38:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-02 21:36:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-08-09 06:40:52

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2022-08-09 06:40:52

red branch => needs work
----
New commits:
