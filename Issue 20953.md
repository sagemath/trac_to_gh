# Issue 20953: PPL blows away cysignals' SIGALRM handler on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-08-08 11:48:00

During startup of Sage, when cysignals is imported it sets up its own signal handlers, including its handler for `SIGALRM` and other interrupts.

At some point later, during startup of Sage, the `sage.libs.ppl` module causes PPL to be loaded an initialized.  PPL contains a `Watchdog` timer class, which although not used by PPL itself as far as I can tell, may be used by client code to set a timeout on calculations.  The problem is that it has a static initializer called during PPL's initialization, which simply sets either the `SIGPROF` or `SIGALRM` handler and clobbers the previous handler.

This is no problem on Linux because there it uses `SIGPROF` which Cysignals doesn't do anything with.  But according to the PPL source:


```
// Cygwin only supports ITIMER_REAL.
// Apparently GNU Hurd also only supports ITIMER_REAL
// (see http://www.cs.unipr.it/pipermail/ppl-devel/2010-March/016072.html).
// Profiling does not work on programs that use the ITIMER_PROF timer.
#if defined(__CYGWIN__) || defined(__gnu_hurd__) || defined(PPL_PROFILING)
#define THE_TIMER  ITIMER_REAL
#define THE_SIGNAL SIGALRM
#else
#define THE_TIMER  ITIMER_PROF
#define THE_SIGNAL SIGPROF
#endif
```


The note that Cygwin only supports `ITIMER_REAL` still appears to be true, so okay.  But it's still annoying that it sets the `SIGALRM` handler even when no such timers are active.

In fairness the same might be said for Cysignals.

For now I will try to just disable the Watchdog timer in PPL for Cygwin and see where I get with that.

A possible workaround from the Cysignals end, which might not be a bad idea regardless would be when calling `alarm()` to explicitly set the `SIGALRM` handler to Cysignals', and after the signal is handled restore it to the previous handler (if it was anything other than Cysignals' or `SIG_DFL/IGN`). 



---

Comment by jdemeyer created at 2016-08-08 12:08:52

Seems like a duplicate of #17650.


---

Comment by jdemeyer created at 2016-08-08 12:11:01

Replying to [ticket:21190 embray]:
> A possible workaround from the Cysignals end, which might not be a bad idea regardless would be when calling `alarm()` to explicitly set the `SIGALRM` handler to Cysignals', and after the signal is handled restore it to the previous handler (if it was anything other than Cysignals' or `SIG_DFL/IGN`). 

That wouldn't really work with Python's `signal.alarm` which I also want to support in cysignals.


---

Comment by embray created at 2016-08-08 12:23:00

In what sense do you want to support it?


---

Comment by jdemeyer created at 2016-08-08 12:34:58

Replying to [comment:3 embray]:
> In what sense do you want to support it?

At least it should actually interrupt a `sig_on` block. The only way to do this is to set the POSIX signal handler for `SIGALRM`.

I currently don't support a custom Python-level handler in cysignals but that's not affected by PPL anyway.


---

Comment by embray created at 2016-08-08 13:00:54

Yes, it is a duplicate of #17650.  For what it's worth I have a different workaround that's maybe a little less invasive, but either way.  I'll also test the fix in #17650.

Ideally I'd rather get around this without patching/disabling functionality.  Would be better if Cysignals played better with this, somehow.


---

Comment by jdemeyer created at 2016-08-08 14:25:19

Replying to [comment:5 embray]:
> Would be better if Cysignals played better with this, somehow.

The problem is really that the OS supports only one handler for each signal. When you have different libraries each doing its own signal handling, you get conflicts. For example, in Sage, we pass a flag to PARI to not install a `SIGINT` handler.


---

Comment by jdemeyer created at 2016-08-08 14:33:23

A simple fix would be to call `init_cysignals` after loading PPL. That will reset the `SIGALRM` handler to what cysignals expects.


---

Comment by embray created at 2016-08-08 16:16:14

FWIW adding a workaround for this fixed `alarm` and got all tests for the Singular interface working on Cygwin again \o/


---

Comment by embray created at 2016-08-09 09:10:45

My point regarding Cysignals is that I think that PPL is misbehaving by installing a `SIGALRM` handler when it's not explicitly starting a timer or otherwise expecting a `SIGALRM`, and I think that it would be best if Cysignals also not do this.  Both should be patched.

If Cysignals _does_ unconditionally install its own signal handler I think it would be best if it at least delegated to an existing (non-default) signal handler that is already installed if one exists, and otherwise fall back to its default behavior (raising a Python exception).  Or at the very least have an option to control its behavior (i.e. via a flag).


---

Comment by jdemeyer created at 2016-08-09 09:43:27

For cysignals, that would make `SIGALRM` behave differently from other signals (`SIGINT`, `SIGSEGV`,...) for which a handler is installed by default. I'm not saying that this is a huge problem, but I think it is unexpected.

Perhaps a better solution for cysignals would be to accept an explicit list of signals that it should handle.

Related Python question: do you consider it acceptable behaviour that `cysignals` installs signal handlers when it's imported? Or should that require an explicit action? This is of course a question of style, but I wonder what your opinion is.


---

Comment by embray created at 2016-08-09 10:02:02

Replying to [comment:10 jdemeyer]:
> For cysignals, that would make `SIGALRM` behave differently from other signals (`SIGINT`, `SIGSEGV`,...) for which a handler is installed by default. I'm not saying that this is a huge problem, but I think it is unexpected.

The purpose of `SIGALRM` is different though.  Most other code I see in the wild that uses it only installs a handler for it if and when it's explicitly preparing to receive that signal (i.e. by calling `alarm()` or `setitimer()`).  I think that's a wise approach to it, though I haven't seen any explicit guidance on that either (such as in the POSIX standard).

I understand what you're getting at though.  It's nice to be able to handle all (well, some, since cysignals only handles some signals) equally, but maybe in the end that's not entirely appropriate in all cases.

> Perhaps a better solution for cysignals would be to accept an explicit list of signals that it should handle.

Yes, one way or another it would be nice if cysignals could be more configurable in this regard.  I don't have a strong opinion about it.

> Related Python question: do you consider it acceptable behaviour that `cysignals` installs signal handlers when it's imported? Or should that require an explicit action? This is of course a question of style, but I wonder what your opinion is.

I'm not crazy about the on-import behavior of cysignals.  It may be convenient, but for something that modifies the global state of an application, the timing may need to be precisely controlled, and that's hard to do with actions that occur automatically at import time.


---

Comment by embray created at 2016-08-09 10:02:51

(To be clear, as far as this ticket is concerned I think it's PPL that's at fault--it just got me thinking about cysignals as well.)


---

Comment by embray created at 2016-08-10 08:55:12

Attaching my initial workaround for the issue. Definitely not an end-all-be-all solution, but it works and is the least invasive workaround I could think of, as it doesn't even require a patch file really.  Instead, by slightly tweaking the `configure` output before `make` we can make PPL think it does not have `setitimer` support.  The only place where this particular macro is used is in checking whether or not to initialize the Watchdog timer `SIGALRM` handler.

In the longer term I would like to see PPL patched to do as I suggested for cysignals as well, of only setting a `SIGALRM` (or `SIGPRFL`) handler when explicitly setting up a timer, and restoring the previous handler once the signal is received.  Are there any PPL experts I should CC?
----
New commits:


---

Comment by jdemeyer created at 2016-08-10 09:03:04

I would prefer to apply the patch in all cases, not just Cygwin. It's just because of a general principle that I don't like a fix to be system-specific if it does not have to system-specific. Of course the comment should mention that it fixes a Cygwin issue.


---

Comment by jdemeyer created at 2016-08-10 09:04:09

And as usual, the patchlevel in `build/pkgs/ppl/package-version.txt` should be increased.


---

Comment by embray created at 2016-08-10 09:10:21

Like I said, this is not an end-all solution. I'm not sure it should necessarily even be merged.  Just posting it for now since it demonstrates what the issue is and how to fix it.

I also strongly believe this should be a Cygwin-only fix.  There is no problem here on other platforms.  It's effectively breaking functionality--it just happens there isn't anything immediately in Sage that is affected (but that says nothing for other user code).

Further, I don't think the patch level needs to be increased so long as it only affects Cygwin.


---

Comment by embray created at 2017-04-13 10:04:29

Changing status from new to needs_review.


---

Comment by embray created at 2017-04-13 10:04:29

I never did set this to "needs review".

Jeroen: If you're still not happy with this workaround what I could do is adapt the patch from #17650 to add a configure option to disable PPL's watchdog timer entirely, and we could apply that option on all platforms as you suggested.

On one hand, I still think this is harmless except on Cygwin; but on the other hand it's not needed for Sage either so maybe it's better to be consistent.


---

Comment by jdemeyer created at 2017-04-13 13:32:56

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-04-13 13:32:56

OK, fine for me.

Just add a comment in the `spkg-install` file pointing to this issue. Once you did that, you can set this to positive_review.


---

Comment by git created at 2017-04-14 09:12:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-04-14 09:13:10

Okay, done.  I'm not particularly happy with this workaround myself but it's good enough for now.


---

Comment by embray created at 2017-04-14 09:13:10

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-04-14 19:56:15

Resolution: fixed
