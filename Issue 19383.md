# Issue 19383: fast (lazy) infinite words

archive/issues_019383.json:
```json
{
    "body": "CC:  @seblabbe @mantepse\n\nIn order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`.\n\nAs a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.\n\nIn order to have fast slices (i.e. with shared memory), we first need a cleanup in `words.py` (see #19619).\n\nIssue created by migration from https://trac.sagemath.org/ticket/19620\n\n",
    "created_at": "2015-11-24T23:15:39Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "fast (lazy) infinite words",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19383",
    "user": "@videlec"
}
```
CC:  @seblabbe @mantepse

In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`.

As a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.

In order to have fast slices (i.e. with shared memory), we first need a cleanup in `words.py` (see #19619).

Issue created by migration from https://trac.sagemath.org/ticket/19620





---

archive/issue_comments_266412.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2015-12-15T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266412",
    "user": "@videlec"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_266413.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-12-15T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266413",
    "user": "@videlec"
}
```

New commits:



---

archive/issue_comments_266414.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-15T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266414",
    "user": "@videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_266415.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-16T12:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266415",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266416.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-20T14:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266416",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266417.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-20T15:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266417",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266418.json:
```json
{
    "body": "The patchbot says\n\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 1641, in <module>\n    getattr(get_builder(name), type)()\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 302, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 513, in _wrapper\n    x.get(99999)\n  File \"/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py\", line 567, in get\n    raise self._value\nOSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.\n```\n",
    "created_at": "2015-12-22T21:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266418",
    "user": "@seblabbe"
}
```

The patchbot says


```
Error building the documentation.
Traceback (most recent call last):
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 1641, in <module>
    getattr(get_builder(name), type)()
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 302, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 513, in _wrapper
    x.get(99999)
  File "/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
OSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.
```




---

archive/issue_comments_266419.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-23T02:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266419",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266420.json:
```json
{
    "body": "Salut S\u00e9bastien,\n\nThanks for having a look. I fixed the issue aout the doc.",
    "created_at": "2015-12-23T02:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266420",
    "user": "@videlec"
}
```

Salut SÃ©bastien,

Thanks for having a look. I fixed the issue aout the doc.



---

archive/issue_comments_266421.json:
```json
{
    "body": "Wow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do\n\n```\nsage: SymmetricFunctions(QQ).inject_shorthands()\nsage: Word(lambda n: h[n])\nword: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...\n\n```\n\n\nand now apply a `lambda f: p(f)` to each \"letter\".  Is this easy to do?",
    "created_at": "2016-01-05T18:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266421",
    "user": "@mantepse"
}
```

Wow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: Word(lambda n: h[n])
word: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...

```


and now apply a `lambda f: p(f)` to each "letter".  Is this easy to do?



---

archive/issue_comments_266422.json:
```json
{
    "body": "What is p?",
    "created_at": "2016-01-05T18:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266422",
    "user": "@videlec"
}
```

What is p?



---

archive/issue_comments_266423.json:
```json
{
    "body": "`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do\n\n```\nsage: w_new = Word(lambda l: p(w_old[l]))\n```\n\n\nPossibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.",
    "created_at": "2016-01-05T18:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266423",
    "user": "@mantepse"
}
```

`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do

```
sage: w_new = Word(lambda l: p(w_old[l]))
```


Possibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.



---

archive/issue_comments_266424.json:
```json
{
    "body": "You can do that with lazy list (that are faster and avoids precomputations)\n\n```\nsage: SymmetricFunctions(QQ).inject_shorthands()\nsage: from itertools import count\nsage: from sage.misc.lazy_list import lazy_list\nsage: hn = lazy_list(h[n] for n in count())\nsage: phn = lazy_list(p(x) for x in hn)\nsage: hn.info()  # 0 computation at this stage\ncache length 0\nstart        0\nstop         9223372036854775807\nstep         1\nsage: phn.info() # 0 computation at this stage\ncache length 0\nstart        0\nstop         9223372036854775807\nstep         1\nsage: phn[2]\n1/2*p[1, 1] + 1/2*p[2]\nsage: hn.info()  # now we have 3 elts in cache\ncache length 3\nstart        0\nstop         9223372036854775807\nstep         1\n```\n",
    "created_at": "2016-01-05T18:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266424",
    "user": "@videlec"
}
```

You can do that with lazy list (that are faster and avoids precomputations)

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: from itertools import count
sage: from sage.misc.lazy_list import lazy_list
sage: hn = lazy_list(h[n] for n in count())
sage: phn = lazy_list(p(x) for x in hn)
sage: hn.info()  # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn.info() # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn[2]
1/2*p[1, 1] + 1/2*p[2]
sage: hn.info()  # now we have 3 elts in cache
cache length 3
start        0
stop         9223372036854775807
step         1
```




---

archive/issue_comments_266425.json:
```json
{
    "body": "OK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).",
    "created_at": "2016-01-05T19:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266425",
    "user": "@mantepse"
}
```

OK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).



---

archive/issue_comments_266426.json:
```json
{
    "body": "Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.\n\nNote that you can avoid precomputations with word initialization with the option `check=False`\n\n```\nsage: W = Words()\nsage: w = W(lambda n: haha[n], check=False)  # no precomputation\nsage: w[0]\nTraceback (most recent call last):\n...\nNameError: global name 'haha' is not defined\n```\n\nIdeally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.",
    "created_at": "2016-01-05T19:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266426",
    "user": "@videlec"
}
```

Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Note that you can avoid precomputations with word initialization with the option `check=False`

```
sage: W = Words()
sage: w = W(lambda n: haha[n], check=False)  # no precomputation
sage: w[0]
Traceback (most recent call last):
...
NameError: global name 'haha' is not defined
```

Ideally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.



---

archive/issue_comments_266427.json:
```json
{
    "body": "Replying to [comment:15 vdelecroix]:\n> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.\n\nYes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...",
    "created_at": "2016-01-05T19:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266427",
    "user": "@mantepse"
}
```

Replying to [comment:15 vdelecroix]:
> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Yes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...



---

archive/issue_comments_266428.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-21T04:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266428",
    "user": "@rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_266429.json:
```json
{
    "body": "Does not merge.",
    "created_at": "2016-08-21T04:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19383#issuecomment-266429",
    "user": "@rwst"
}
```

Does not merge.
