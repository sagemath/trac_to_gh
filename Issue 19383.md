# Issue 19383: fast (lazy) infinite words

Issue created by migration from https://trac.sagemath.org/ticket/19620

Original creator: vdelecroix

Original creation time: 2015-11-24 23:15:39

CC:  slabbe mantepse

In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`.

As a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.

In order to have fast slices (i.e. with shared memory), we first need a cleanup in `words.py` (see #19619).


---

Comment by vdelecroix created at 2015-12-15 19:58:03

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by vdelecroix created at 2015-12-15 19:58:03

New commits:


---

Comment by vdelecroix created at 2015-12-15 19:58:03

Changing status from new to needs_review.


---

Comment by git created at 2015-12-16 12:36:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-20 14:57:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-20 15:16:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-12-22 21:43:12

The patchbot says


```
Error building the documentation.
Traceback (most recent call last):
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 1641, in <module>
    getattr(get_builder(name), type)()
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 302, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 513, in _wrapper
    x.get(99999)
  File "/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
OSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.
```



---

Comment by git created at 2015-12-23 02:01:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-12-23 02:05:20

Salut SÃ©bastien,

Thanks for having a look. I fixed the issue aout the doc.


---

Comment by mantepse created at 2016-01-05 18:37:34

Wow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: Word(lambda n: h[n])
word: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...

```


and now apply a `lambda f: p(f)` to each "letter".  Is this easy to do?


---

Comment by vdelecroix created at 2016-01-05 18:49:08

What is p?


---

Comment by mantepse created at 2016-01-05 18:52:42

`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do

```
sage: w_new = Word(lambda l: p(w_old[l]))
```


Possibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.


---

Comment by vdelecroix created at 2016-01-05 18:59:21

You can do that with lazy list (that are faster and avoids precomputations)

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: from itertools import count
sage: from sage.misc.lazy_list import lazy_list
sage: hn = lazy_list(h[n] for n in count())
sage: phn = lazy_list(p(x) for x in hn)
sage: hn.info()  # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn.info() # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn[2]
1/2*p[1, 1] + 1/2*p[2]
sage: hn.info()  # now we have 3 elts in cache
cache length 3
start        0
stop         9223372036854775807
step         1
```



---

Comment by mantepse created at 2016-01-05 19:10:25

OK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).


---

Comment by vdelecroix created at 2016-01-05 19:20:47

Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Note that you can avoid precomputations with word initialization with the option `check=False`

```
sage: W = Words()
sage: w = W(lambda n: haha[n], check=False)  # no precomputation
sage: w[0]
Traceback (most recent call last):
...
NameError: global name 'haha' is not defined
```

Ideally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.


---

Comment by mantepse created at 2016-01-05 19:58:40

Replying to [comment:15 vdelecroix]:
> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Yes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...


---

Comment by rws created at 2016-08-21 04:57:06

Changing status from needs_review to needs_work.


---

Comment by rws created at 2016-08-21 04:57:06

Does not merge.
