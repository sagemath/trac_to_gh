# Issue 30369: sage.features.Feature.resolution: If SAGE_ROOT is available, recommend system packages

Issue created by migration from https://trac.sagemath.org/ticket/30606

Original creator: mkoeppe

Original creation time: 2020-09-18 20:53:02

CC:  fbissey jhpalmieri slelievre slabbe

Currently, if a `Feature` is keyed to an `spkg`, a `FeatureNotPresentError` recommends to use `sage -i` to install the package.

When `SAGE_ROOT` (or `sage_bootstrap`) is available, we can do better: We can recommend equivalent system packages.


---

Comment by mkoeppe created at 2020-09-19 03:14:31

New commits:


---

Comment by mkoeppe created at 2020-09-19 03:14:31

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-09-19 13:44:50

resolution should be lazier


---

Comment by mkoeppe created at 2020-09-19 13:44:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-09-19 18:29:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-19 19:02:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-19 19:04:27

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2020-09-19 20:23:16

I immediately thought that the doctests would fail in sage-on-gentoo and more generally in sage-on-distros. And I was right.

```
sage -t --long --warn-long 112.3 --random-seed=0 /usr/lib/python3.7/site-packages/sage/features/__init__.py
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 43, in sage.features
Failed example:
    Executable(name="random", executable="randomOochoz6x", spkg="random", url="http://rand.om").require()
Expected:
    Traceback (most recent call last):
    ...
    FeatureNotPresentError: random is not available.
    Executable 'randomOochoz6x' not found on PATH.
    ...try to run...sage -i random...
    Further installation instructions might be available at http://rand.om.
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.features[5]>", line 1, in <module>
        Executable(name="random", executable="randomOochoz6x", spkg="random", url="http://rand.om").require()
      File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 192, in require
        raise FeatureNotPresentError(self, presence.reason, presence.resolution)
    sage.features.FeatureNotPresentError: random is not available.
    Executable 'randomOochoz6x' not found on PATH.
    No equivalent system packages for pip are known to Sage.
    Further installation instructions might be available at http://rand.om.
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 219, in sage.features.Feature.resolution
Failed example:
    Executable(name="CSDP", spkg="csdp", executable="theta", url="http://github.org/dimpase/csdp").resolution()
Expected:
    l'...To install CSDP...you can try to run...sage -i csdp...Further installation instructions might be available at http://github.org/dimpase/csdp.'
Got:
    l'No equivalent system packages for pip are known to Sage.\nFurther installation instructions might be available at http://github.org/dimpase/csdp.'
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 307, in sage.features.FeatureTestResult
Failed example:
    str(FeatureTestResult(package, True).resolution)
Expected:
    '...To install GAP package NOT_A_PACKAGE...you can try to run...sage -i no_package...'
Got:
    'No equivalent system packages for pip are known to Sage.'
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 309, in sage.features.FeatureTestResult
Failed example:
    str(FeatureTestResult(package, False).resolution)
Expected:
    '...To install GAP package NOT_A_PACKAGE...you can try to run...sage -i no_package...'
Got:
    'No equivalent system packages for pip are known to Sage.'
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 623, in sage.features.StaticFile
Failed example:
    StaticFile(name="no_such_file", filename="KaT1aihu", search_path=("/",), spkg="some_spkg", url="http://rand.om").require()
Expected:
    Traceback (most recent call last):
    ...
    FeatureNotPresentError: no_such_file is not available.
    'KaT1aihu' not found in any of ['/']...
    To install no_such_file...you can try to run...sage -i some_spkg...
    Further installation instructions might be available at http://rand.om.
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.features.StaticFile[1]>", line 1, in <module>
        StaticFile(name="no_such_file", filename="KaT1aihu", search_path=("/",), spkg="some_spkg", url="http://rand.om").require()
      File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 192, in require
        raise FeatureNotPresentError(self, presence.reason, presence.resolution)
    sage.features.FeatureNotPresentError: no_such_file is not available.
    'KaT1aihu' not found in any of ['/']
    No equivalent system packages for pip are known to Sage.
    Further installation instructions might be available at http://rand.om.
**********************************************************************
File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 673, in sage.features.StaticFile.absolute_path
Failed example:
    StaticFile(name="no_such_file", filename="KaT1aihu", search_path=(), spkg="some_spkg", url="http://rand.om").absolute_path()
Expected:
    Traceback (most recent call last):
    ...
    FeatureNotPresentError: no_such_file is not available.
    'KaT1aihu' not found in any of []...
    To install no_such_file...you can try to run...sage -i some_spkg...
    Further installation instructions might be available at http://rand.om.
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.7/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.features.StaticFile.absolute_path[2]>", line 1, in <module>
        StaticFile(name="no_such_file", filename="KaT1aihu", search_path=(), spkg="some_spkg", url="http://rand.om").absolute_path()
      File "/usr/lib/python3.7/site-packages/sage/features/__init__.py", line 687, in absolute_path
        resolution=self.resolution())
    sage.features.FeatureNotPresentError: no_such_file is not available.
    'KaT1aihu' not found in any of []
    No equivalent system packages for pip are known to Sage.
    Further installation instructions might be available at http://rand.om.
**********************************************************************
5 items had failures:
   1 of   7 in sage.features
   1 of   3 in sage.features.Feature.resolution
   2 of  11 in sage.features.FeatureTestResult
   1 of   3 in sage.features.StaticFile
   1 of   4 in sage.features.StaticFile.absolute_path
    [118 tests, 6 failures, 9.26 s]
----------------------------------------------------------------------
sage -t --long --warn-long 112.3 --random-seed=0 /usr/lib/python3.7/site-packages/sage/features/__init__.py  # 6 doctests failed
```

At least that may tell you if things are working as you expected them.


---

Comment by mkoeppe created at 2020-09-19 20:25:16

Thanks for testing! This code is meant to work also on distributions without patching. I'll try to fix it.


---

Comment by git created at 2020-09-19 20:43:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2020-09-21 07:42:41

With Ubuntu 18.04 + 9.2beta12 + #30053 (so that it uses sage's python 3.8 instead of system 3.6 which can't get the doc to build) + #30606, I obtain what's below.

I don't know if it is noise yet, so, I pasted it here instead: https://groups.google.com/g/sage-devel/c/_8oQ4T9WxD4/m/S0ywrlUNAwAJ


---

Comment by dimpase created at 2020-09-21 08:01:01

Replying to [comment:15 slabbe]:
> With Ubuntu 18.04 + 9.2beta12 + #30053 (so that it uses sage's python 3.8 instead of system 3.6 which can't get the doc to build) + #30606, I obtain what's below.
> 
> I don't know if it is noise yet, so, I pasted it here instead: https://groups.google.com/g/sage-devel/c/_8oQ4T9WxD4/m/S0ywrlUNAwAJ

IMHO it's better to put "noise" here - you can edit later on - than on a list with a much larger readership.

Anyhow, changing Python needs a big rebuild (of everything depending on Python), so the error looks unsurprising.


---

Comment by slabbe created at 2020-09-21 09:02:55

It was noise, sorry. Yes, you are right, I should have put it here, and erased it after...


---

Comment by slabbe created at 2020-09-21 09:03:27

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-09-21 09:03:27

I get error building the documentation:


```
[dochtml] OSError: /home/slabbe/GitBox/sage/local/lib/python3.8/site-packages/sage/features/__init__.py:docstrin
g of sage.features.PackageSystem.spkg_installation_hint:9: WARNING: Block quote ends without a blank line; unexp
ected unindent.
```



---

Comment by slabbe created at 2020-09-21 09:08:59

Many docstrings are starting with `"""` instead of `r"""`. Maybe that's the issue?


---

Comment by slabbe created at 2020-09-21 09:29:32

Yes it is. I pushed my current branch #30053 + #30606 rebased on top of #30053 + 1 commit fixing the docstring here: u/slabbe/30606 on which doc builds.


---

Comment by git created at 2020-09-21 15:50:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-21 15:50:43

Thank you! I have cherry-picked your commit onto my branch.


---

Comment by mkoeppe created at 2020-09-21 15:50:58

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2020-09-23 11:14:00

Patchbot shows the following doctest failing:

```
sage -t --long --random-seed=0 src/sage/doctest/control.py
**********************************************************************
File "src/sage/doctest/control.py", line 777, in sage.doctest.control.DocTestController.expand_files_into_sources
Failed example:
    sorted(DC.sources[0].options.optional)  # abs tol 1
Expected:
    ['guava', 'magma', 'py2']
Got:
    ['debian', 'guava', 'magma', 'pip', 'py3', 'sage_spkg']
**********************************************************************
File "src/sage/doctest/control.py", line 1009, in sage.doctest.control.DocTestController._optional_tags_string
Failed example:
    DC._optional_tags_string()
Expected:
    'openssl,sage'
Got:
    'debian,openssl,pip,sage,sage_spkg'
**********************************************************************
2 items had failures:
   1 of   8 in sage.doctest.control.DocTestController._optional_tags_string
   1 of  23 in sage.doctest.control.DocTestController.expand_files_into_sources
    [208 tests, 2 failures, 4.49 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/doctest/control.py  # 2 doctests failed
----------------------------------------------------------------------
```


Also reported by the patchbot, `EXAMPLE::` should always be plural `EXAMPLES::`.


---

Comment by slabbe created at 2020-09-23 11:16:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-09-23 11:51:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-23 11:51:59

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2020-09-23 12:51:59

I did few tests, I get:

```
sage: from sage.features import package_systems
sage: package_systems()
[Feature('debian'), Feature('sage_spkg'), Feature('pip')]
```


So this looks good:

```
sage: from sage.features import PackageSystem
sage: PackageSystem('condaa').is_present()
FeatureTestResult('condaa', False)
sage: PackageSystem('conda').is_present()
FeatureTestResult('conda', False)
sage: PackageSystem('debian').is_present()
FeatureTestResult('debian', True)
```


It seems one needs to avoid `PackageSystem('sage_spkg')`:


```
sage: from sage.features import SagePackageSystem
sage: A = PackageSystem('sage_spkg')
sage: B = SagePackageSystem()
sage: A
Feature('sage_spkg')
sage: B
Feature('sage_spkg')
sage: A.is_present()        # expecting True
FeatureTestResult('sage_spkg', False)
sage: B.is_present()
FeatureTestResult('sage_spkg', True)
```


Similarly, 

```
sage: PackageSystem('pip').is_present()   # I was expecting True here
FeatureTestResult('pip', False)
```


The following looks good:


```
sage: PackageSystem('pip').spkg_installation_hint('jupyterlab')
'To install jupyterlab using the pip package manager, you can try to run:\n!sage -pip install jupyterlab~=2.2.5'
sage: from sage.features import PipPackageSystem
sage: PipPackageSystem().is_present()
FeatureTestResult('pip', True)
sage: PipPackageSystem().spkg_installation_hint('jupyterlab')
'To install jupyterlab using the pip package manager, you can try to run:\n!sage -pip install jupyterlab~=2.2.5'
sage: SagePackageSystem().spkg_installation_hint('jupyterlab')
'To install jupyterlab using the Sage package manager, you can try to run:\n  !sage -i jupyterlab'
```


The following does not look good (or maybe it is?):


```
sage: PackageSystem('debian').spkg_installation_hint('jupyterlab')
'No equivalent system packages for debian are known to Sage.'
```



---

Comment by slabbe created at 2020-09-23 18:30:53

Well, I understand the idea is to use `SagePackageSystem()` instead of `PackageSystem('sage_spkg')`
and `PipPackageSystem()` instead of `PackageSystem('pip')`.


---

Comment by slabbe created at 2020-09-23 18:35:12

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2020-09-23 18:35:12

Looks good. Doc builds ok. doctests failures are fixed.


---

Comment by mkoeppe created at 2020-09-23 18:45:59

Replying to [comment:28 slabbe]:
> It seems one needs to avoid `PackageSystem('sage_spkg')`:
> 
> {{{
> sage: from sage.features import SagePackageSystem
> sage: A = PackageSystem('sage_spkg')
> sage: B = SagePackageSystem()
> sage: A
> Feature('sage_spkg')
> sage: B
> Feature('sage_spkg')
> sage: A.is_present()        # expecting True
> FeatureTestResult('sage_spkg', False)
> sage: B.is_present()
> FeatureTestResult('sage_spkg', True)
> }}}
> 
> Similarly, 
> {{{
> sage: PackageSystem('pip').is_present()   # I was expecting True here
> FeatureTestResult('pip', False)
> }}}

I didn't implement delegation to the correct class by name -- note that also `Feature` does not do that even though the default repr seems to suggest unique representation behavior of this kind:

```
sage: from sage.features.bliss import Bliss                                                                                                                                                                               
sage: Bliss()                                                                                                                                                                                                             
Feature('sage.graphs.bliss')
sage: Bliss() is Bliss()                                                                                                                                                                                                  
True
sage: from sage.features import Feature                                                                                                                                                                                   
sage: Bliss() is Feature('sage.graphs.bliss')                                                                                                                                                                             
False
```



---

Comment by mkoeppe created at 2020-09-23 18:48:50

Replying to [comment:28 slabbe]:
> The following does not look good (or maybe it is?):
> 
> {{{
> sage: PackageSystem('debian').spkg_installation_hint('jupyterlab')
> 'No equivalent system packages for debian are known to Sage.'
> }}}

It is correct because so far there is no system package information for this package -- `build/pkgs/jupyterlab/distros` does not exist.  

(See #30124 - System package information, `spkg-configure` for Jupyter `notebook` package, `rst2ipynb`, and dependencies)


---

Comment by mkoeppe created at 2020-09-23 18:49:16

Replying to [comment:29 slabbe]:
> I understand the idea is to use `SagePackageSystem()` instead of `PackageSystem('sage_spkg')`
> and `PipPackageSystem()` instead of `PackageSystem('pip')`.

That's right.


---

Comment by mkoeppe created at 2020-09-23 18:49:24

Thanks for the review!


---

Comment by fbissey created at 2020-09-23 21:21:32

I was wanting to have another go at this but I am flat out right now. I'll open follow up as needed if it gets merged as is.


---

Comment by vbraun created at 2020-10-05 20:13:19

Resolution: fixed


---

Comment by slelievre created at 2020-10-07 19:33:20

This breaks some tests when building with system Python 3.6.x, see

- [2020-10-07 post on sage-release in 9.2.rc0 release thread](https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/yhXDenfMAAAJ)

Follow-up ticket for that: #30740.
