# Issue 32149: Merge pynac as src/sage/symbolics/ginac

Issue created by migration from https://trac.sagemath.org/ticket/32386

Original creator: mkoeppe

Original creation time: 2021-08-16 17:27:13

CC:  @kliem fbissey arojas @davewittemorris slelievre dimpase tscrim egourgoulhon nbruin

Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.

Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.

We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolics/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC.

This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.

It will also make it easier for Sage developers to make changes to Pynac.


---

Comment by mkoeppe created at 2021-08-16 18:17:19

I ran `git filter-branch -f --tree-filter 'rm -f Makefile.am; mkdir -p src/sage/symbolic/ginac; mv *.* src/sage/symbolic/ginac/; :' -- --all` on pynac 0.7.29 and merged it here, thus preserving the relevant history
----
Last 10 new commits:


---

Comment by git created at 2021-08-16 18:29:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-16 18:32:07

Next: Move stuff from `sage.libs.pynac` to `sage.symbolic.ginac`, leaving some deprecated reimports behind. 

Help from Cython experts very welcome...


---

Comment by git created at 2021-08-16 19:16:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-16 19:30:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-16 19:31:59

This version compiles OK


---

Comment by git created at 2021-08-16 20:02:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-16 20:11:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-16 20:17:00

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-08-16 21:06:51

This mostly works but I'm getting a few timeouts/crashes that I'm not sure about

```
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
sage -t --random-seed=0 src/sage/manifolds/differentiable/degenerate_submanifold.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/base.pyx  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/symbolic/relation.py  # Timed out
sage -t --random-seed=0 src/sage/symbolic/expression.pyx  # Killed due to illegal instruction
sage -t --random-seed=0 src/sage/symbolic/pynac_constant.pyx  # 18 doctests failed
```



---

Comment by git created at 2021-08-16 21:13:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-16 21:39:52

The crash is from this doctest:

```
>>> m = var('m')
>>> assume(m, 'integer')
>>> (I**m).real_part()
```

which seems to lead to an infinite recursion through `GiNaC::power::real_part()`


---

Comment by mkoeppe created at 2021-08-16 21:47:24

Oh, this is #28357 and I forgot to apply `realpartloop.patch`


---

Comment by git created at 2021-08-16 21:54:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-16 22:11:03

Ready for testing and review. (I think the patchbot will not run because `build/pkgs/pynac/` is removed by the ticket.)


---

Comment by git created at 2021-08-16 22:14:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2021-08-16 22:20:55

Replying to [comment:19 mkoeppe]:
> Ready for testing and review. (I think the patchbot will not run because `build/pkgs/pynac/` is removed by the ticket.)

That's a bit inconvenient. Such a massive change needs all the bot runs it can get.


---

Comment by mkoeppe created at 2021-08-16 22:28:42

I can of course move the pynac removal to a follow-up ticket


---

Comment by git created at 2021-08-16 22:32:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-08-17 00:16:56

My previous tests were on macOS. On Linux this fails with 

```
  File "sage/symbolic/pynac.pyx", line 1, in init sage.symbolic.pynac (build/cythonized/sage/symbolic/pynac.cpp:31348)
ImportError: /home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTIN5GiNaC5basicE
```

(as reported by a patchbot; also verified using `tox -e docker-ubuntu-focal-standard`)


---

Comment by mkoeppe created at 2021-08-17 00:16:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-08-17 01:42:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-17 01:52:59

This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)

```
$ git grep pynac.*cimport
src/sage/symbolic/comparison.pyx:from sage.symbolic.pynac cimport (
src/sage/symbolic/expression.pxd:from sage.symbolic.pynac cimport GEx
src/sage/symbolic/expression.pyx:from sage.symbolic.pynac cimport *
src/sage/symbolic/function.pyx:from sage.symbolic.pynac cimport (
src/sage/symbolic/getitem.pyx:from sage.symbolic.pynac cimport GEx
src/sage/symbolic/pynac.pyx:from .pynac_constant cimport PynacConstant
src/sage/symbolic/pynac_constant.pxd:from .pynac cimport GConstant
src/sage/symbolic/pynac_constant.pyx:from .pynac cimport (
src/sage/symbolic/ring.pyx:from sage.symbolic.pynac cimport (GEx, GExprSeq, GExVector, GSymbol,
src/sage/symbolic/series.pyx:from sage.symbolic.pynac cimport GEx, g_is_a_terminating_series, g_series_var, series_to_poly
src/sage/symbolic/substitution_map.pxd:from sage.symbolic.pynac cimport GExMap
src/sage/symbolic/substitution_map.pyx:from sage.symbolic.pynac cimport make_pair, GEx, GExPair
```

I don't know if there's a better solution.


---

Comment by @kliem created at 2021-08-17 07:56:33

I will take a look, if I can resolve this.


---

Comment by @kliem created at 2021-08-17 10:19:19

New commits:


---

Comment by git created at 2021-08-17 13:40:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-17 15:04:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-08-17 15:11:45

I basically have this working by specifying:


```diff
diff --git a/src/sage/symbolic/series.pyx b/src/sage/symbolic/series.pyx
index 0e395ae4b4..d93cccc50b 100644
--- a/src/sage/symbolic/series.pyx
+++ b/src/sage/symbolic/series.pyx
@@ -1,3 +1,4 @@
+# distutils: extra_link_args = /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/symbolic/pynac.cpython-37m-x86_64-linux-gnu.so
 """
 Symbolic Series
```


to all of those files (and the one doctest in `sage/symbolic/pynac.pxd` that raises an `ImportError` currently).

So this is basically working, but the correct linking is missing.

We could create an extra file `sage/symbolic/linked_pynac.pxd`, which just consists of


```
# distutils: extra_link_args = ...
from sage.symbolic/pynac cimport *
```


then there is no need to specify this extra distutils thing in every file that cimports pynac.


---

Comment by @kliem created at 2021-08-17 15:15:11

Once more thing: The headers in `pkgs/sagemath-standard/build/cythonized/` are not cleaned up. Can this be fixed somehow or is this just going to stay this way? (This is probably the reason, why you did not notice the missing headers that were fixed in ||[01dfef3](https://git.sagemath.org/sage.git/commit?id=01dfef3756a4da5fc01355f10954dea69fbf01f6)||`missing headers`||


---

Comment by mkoeppe created at 2021-08-17 17:48:13

I don't like the change https://git.sagemath.org/sage.git/commit/?id=70bcddf168950f477c2b56fca725e668a1236fb6 (simpler inclusion of headers); putting stuff in the include search path can lead to shadowing headers of other libraries


---

Comment by mkoeppe created at 2021-08-17 17:54:56

Thanks for the investigation and fixes.

I think I would be reluctant to use the `extra_link_args` workaround -- it will requires changes to the build system because now building one extension module would depend on another extension module.

In any case, I'd think that your successful experiment indicates the approach of merging everything that needs to `cimport` stuff from ginac/ into one extension module would work.


---

Comment by mkoeppe created at 2021-08-17 18:06:12

Replying to [comment:33 gh-kliem]:
> Once more thing: The headers in `pkgs/sagemath-standard/build/cythonized/` are not cleaned up. 
Do we already have a ticket for this? If not, please open one

However, I think we should move away from the custom build system of Sage. I have opened #32390 for the next step in this.


---

Comment by mkoeppe created at 2021-08-17 18:17:05

Replying to [comment:27 mkoeppe]:
> This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)

For cleaning up `ring.pyx`, I have opened #32391.


---

Comment by @kliem created at 2021-08-17 18:38:34

Replying to [comment:37 mkoeppe]:
> Replying to [comment:27 mkoeppe]:
> > This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)
> 
> For cleaning up `ring.pyx`, I have opened #32391.

We would still lose ability to use it directly in cython at all. E.g. the doctest in `pynac.pxd` would fail.

At the moment, I'm building this branch with `./configure --enable-editable` and will report whether this resolves anything.


---

Comment by @kliem created at 2021-08-17 18:51:35

Replying to [comment:34 mkoeppe]:
> I don't like the change https://git.sagemath.org/sage.git/commit/?id=70bcddf168950f477c2b56fca725e668a1236fb6 (simpler inclusion of headers); putting stuff in the include search path can lead to shadowing headers of other libraries

`from ... cimport ...` should usually just work out of the box. But of course one can also spell out all those header (e.g. with a cython alias).

Then again, if we decide to put it all into one large `pyx` and not cimport things from `ginac` directly, the commit isn't necessary at all.


---

Comment by mkoeppe created at 2021-08-17 19:00:01

Replying to [comment:38 gh-kliem]:
> Replying to [comment:37 mkoeppe]:
> > Replying to [comment:27 mkoeppe]:
> > > This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)
> > 
> > For cleaning up `ring.pyx`, I have opened #32391.
> 
> We would still lose ability to use it directly in cython at all. E.g. the doctest in `pynac.pxd` would fail.

I wouldn't be too concerned about this. I'd be surprised if there's any user code in the wild that does that; and if at all necessary, it can be mitigated by adding some missing methods at a higher level.


---

Comment by @kliem created at 2021-08-17 19:03:36

Ok, same problem with `./configure --enable-editable`.

Btw, this is exactly our problem and there is no proper solution to it. So instead of adding a custom one, I agree that it would be easier, to move all the `cdef extern from ...` into one large `pyx` and only `cimport` the cython wrappers. This is the way, your meant to do it anyway.


---

Comment by mkoeppe created at 2021-08-17 19:11:18

A simple way of doing this might be to rename files like `series.pxd` to `series.pxi` and `series.pyx` to `series_impl.pxi` and then to `include` them into the target extension module (`pynac.pxd`, `pynac.pyx`?)


---

Comment by @kliem created at 2021-08-17 19:21:06

Using `pxi` is outdated, I was told. But maybe using something outdated is more desirable than having huge files.


---

Comment by mkoeppe created at 2021-08-17 19:25:31

That's probably just from the warning at https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html?highlight=include#the-include-statement-and-include-files; but if I'm not mistaken, this just refers to a particular use case of "pxi" that was superseded by "pxd". I don't see any indication that the mechanism of `include` is intended to be removed in Cython.


---

Comment by mkoeppe created at 2021-08-17 20:04:38

It would look like this (currently does not compile because I haven't done the changes to `ring.pyx`)
----
New commits:


---

Comment by mkoeppe created at 2021-08-17 20:06:33

(cherry-picked some of your changes onto this branch)


---

Comment by git created at 2021-08-17 21:45:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-17 21:45:22

or perhaps better like this.


---

Comment by git created at 2021-08-18 00:21:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-18 04:19:29

Forgive me for asking a naïve question, but isn't this going against the modularization you are trying to have Sage do? I fully understand the reason for bringing it in (which should make it easier to bug-fix), but doesn't this make Sage more monolithic?


---

Comment by mkoeppe created at 2021-08-18 17:53:58

Replying to [comment:51 tscrim]:
> isn't this going against the modularization you are trying to have Sage do? I fully understand the reason for bringing it in (which should make it easier to bug-fix), but doesn't this make Sage more monolithic?

This is a natural question. 

The pynac library just does not make sense as a module. It is the basis of the implementation of SR elements and as such there is no way to build Sage symbolics without it. 

In the modularization plan of #29705, we would instead create a distribution package `sagemath-symbolics`, containing the integrated pynac from the present ticket and most of `sage.symbolic`, `sage.calculus`, `sage.functions`, and parts of `sage.interfaces`. This will make sense as a module because there are many parts of Sage that (fortunately!) do not depend at all on Sage symbolics, or only depend on it for some smaller features. For example, `sage.graphs` has 0 imports from `sage.symbolic`, `sage.combinat` just a handful, etc.


---

Comment by tscrim created at 2021-08-22 02:06:34

Thank you for the explanation. So wouldn't it make sense to instead take the symbolics stuff out from Sage in one go rather than this two step process of add in pynac just to remove it later? Or is this just meant to be a stop-gap until it comes time to split everything?


---

Comment by mkoeppe created at 2021-08-22 02:30:55

Replying to [comment:53 tscrim]:
> So wouldn't it make sense to instead take the symbolics stuff out from Sage in one go rather than this two step process of add in pynac just to remove it later? Or is this just meant to be a stop-gap until it comes time to split everything?

The modularization plan does not involve "taking ... stuff out from Sage" at all. It will all remain in the same git repository, and also `src/sage` will remain monolithic.

Modularization is achieved by preparing sub-distributions defined using one of several possible mechanisms. Take a look at `sagemath-objects` from #29865 (https://pypi.org/project/sagemath-objects/), for example: It defines a sub-distribution using a `MANIFEST` file. Via the Python 3 "native namespace packages" mechanism, (after some work in #31420, #28925), these distributions can be installed cleanly next to each other and provide the shared `sage.*` namespace.


---

Comment by git created at 2021-08-22 22:33:37

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-08-22 22:34:53

It remains to remove the import cycle `sage.symbolic.ring` -> `sage.symbolic.expression` -> `sage.symbolic.function` -> `sage.symbolic.ring`


---

Comment by tscrim created at 2021-08-23 00:31:54

Ah, okay, I was thinking the modularization meant splitting Sage up into different subprojects that would have a main link that would be the actual Sage. However, it is a little different than that. I don't completely understand how all of this works and some of the benefits, but it doesn't seem to be as fragmented as I was thinking. Thank you.


---

Comment by git created at 2021-08-23 00:45:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-23 00:53:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-23 01:33:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-23 02:02:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-23 02:05:09

Still struggling with an import cycle `sage.symbolic.ring` -> `sage.symbolic.expression` -> `sage.symbolic.ring`


---

Comment by mkoeppe created at 2021-08-23 02:05:28

Help welcome


---

Comment by dimpase created at 2021-08-23 07:08:27

I recall that `i`, a.k.a. `I`, is really close the the center of the import troubles.


---

Comment by @kliem created at 2021-08-23 10:50:46

New commits:


---

Comment by git created at 2021-08-23 10:51:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @kliem created at 2021-08-23 10:56:25

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-08-23 10:56:25

Seems to work now.


---

Comment by git created at 2021-08-23 15:19:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-23 16:34:39

Cool, thanks very much!!


---

Comment by mkoeppe created at 2021-08-23 16:35:50

I'm getting

```
sage -t --random-seed=0 src/sage/functions/prime_pi.pyx
**********************************************************************
File "src/sage/functions/prime_pi.pyx", line 17, in sage.functions.prime_pi
Failed example:
    loads(dumps(z)) == z
Expected:
    True
Got:
    False
```



---

Comment by mkoeppe created at 2021-08-23 16:38:35

It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions


---

Comment by mkoeppe created at 2021-08-23 16:49:55

Also I don't think we need `src/sage/symbolic/pynac.py` -- the module `sage.symbolic.pynac` only had a short-lived existence here in this branch.
Did you mean to add these `lazy_import` to `src/sage/libs/pynac/pynac.py`?


---

Comment by @kliem created at 2021-08-23 17:54:37

New commits:


---

Comment by @kliem created at 2021-08-23 17:54:57

Replying to [comment:72 mkoeppe]:
> I'm getting
> {{{
> sage -t --random-seed=0 src/sage/functions/prime_pi.pyx
> **********************************************************************
> File "src/sage/functions/prime_pi.pyx", line 17, in sage.functions.prime_pi
> Failed example:
>     loads(dumps(z)) == z
> Expected:
>     True
> Got:
>     False
> }}}

Fixed.


---

Comment by git created at 2021-08-23 18:51:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-23 18:56:15

If we want to deprecate these reimports like you do here...

```
+++ b/src/sage/symbolic/series.py
@@ -0,0 +1,2 @@
+from sage.misc.lazy_import import lazy_import
+lazy_import('sage.symbolic.expression', 'SymbolicSeries', deprecation=32386)
```

... then we should probably also do this in `substitution_map.py` (and perhaps other places).


---

Comment by @kliem created at 2021-08-23 19:00:39

I tried to get all places. I didn't do `substitution_map.py` because, you had already added the reimport.

I did those lazy imports here, so that people importing python functions from places where they used to be, get a proper deprecation warning:

https://git.sagemath.org/sage.git/commit/?h=2d2153446fc3bb4d2d17d32cc770c0efc5121ecf&id=5b557c68dd722ae8063334b23a595f9b1482a5d7


---

Comment by git created at 2021-08-23 19:00:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-23 22:44:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-24 00:42:08

Replying to [comment:73 mkoeppe]:
> It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions

A quick comparison using `./sage -tp --long src/sage/symbolic/ src/sage/functions/ src/sage/calculus/ src/sage/manifolds/` shows a serious slowdown around +30% with this branch


---

Comment by mkoeppe created at 2021-08-24 00:42:08

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-08-24 03:52:37

I cannot reproduce these timings any more; perhaps this was just from CPU throttling.


---

Comment by mkoeppe created at 2021-08-24 03:53:27

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-08-24 11:42:11

New commits:


---

Comment by git created at 2021-08-24 18:01:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-24 21:05:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Snark created at 2021-08-25 06:56:14

If I understand well, that means that when sage 9.5 enters Debian pynac can be let go.

Is that right?

(Asking as the one responsible for pynac in Debian: [package tracker](https://tracker.debian.org/pkg/pynac))


---

Comment by fbissey created at 2021-08-25 08:03:39

Replying to [comment:91 Snark]:
> If I understand well, that means that when sage 9.5 enters Debian pynac can be let go.
> 
> Is that right?
> 
> (Asking as the one responsible for pynac in Debian: [package tracker](https://tracker.debian.org/pkg/pynac))

Yes, you understand well.


---

Comment by mkoeppe created at 2021-08-25 15:57:55


```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
**********************************************************************
File "src/sage/misc/sageinspect.py", line 2263, in sage.misc.sageinspect.sage_getsourcelines
Failed example:
    lines, lineno = sage_getsourcelines(x); lines[0:2]
Expected:
    ['cdef class Expression(CommutativeRingElement):\n',
     '    cpdef object pyobject(self):\n']
Got:
    ['cdef class Expression(CommutativeRingElement):\n', '\n']
```



---

Comment by @kliem created at 2021-08-25 17:25:53

Fixed that test in `sageinspect.py`.
----
New commits:


---

Comment by git created at 2021-08-25 21:26:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-08-25 21:27:51

Coverage is still an issue, e.g. `new_Expression_from_pyobject` doesn't even have a docstring.


---

Comment by mkoeppe created at 2021-08-25 23:04:42

I've solved this by consolidating two similar functions into one 
----
New commits:


---

Comment by git created at 2021-08-26 18:24:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-26 19:37:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-27 23:06:23

The portability tests on GH Actions ran through successfully. 

Ready for review


---

Comment by dimpase created at 2021-09-03 16:33:29

there is a failing test:

```
e023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 340)     sage: result = integral(sinh(x^2+sqrt(x-1)),x)  # long time (15s on sage.math, 2012)
e023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 341)     ...
e023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 342)     sage: result
d0c52e4aa36 (Jean-Pierre Flori   2013-05-27 15:36:24 +0200 343)     integrate(sinh(x^2 + sqrt(x - 1)), x)
```

line 342 needs `# long time` tag.


---

Comment by mkoeppe created at 2021-09-03 17:18:48

Unrelated to this ticket but yes


---

Comment by mkoeppe created at 2021-09-03 17:24:47

opened #32461 for this


---

Comment by dimpase created at 2021-09-03 19:29:00

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-09-03 19:29:00

lgtm


---

Comment by mkoeppe created at 2021-09-03 19:53:10

Thank you!


---

Comment by dimpase created at 2021-09-04 08:45:48

should #32461  be a dependency here?


---

Comment by git created at 2021-09-13 23:39:27

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-09-13 23:39:27

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2021-09-13 23:40:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-09-15 22:06:00

Resolution: fixed


---

Comment by egourgoulhon created at 2021-09-28 19:37:27

Replying to [comment:73 mkoeppe]:
> It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions

FWIW, the change performed here did not introduced any speed regression in the rather demanding [Kerr spacetime notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), which involves parallelized (8 threads) heavy symbolic computations. On the contrary, it seems there is some little speed up :-) On my i7-8665U laptop:
 - Sage 9.4: 461 s 
 - Sage 9.5.beta2: 449 s


---

Comment by mkoeppe created at 2021-09-28 19:38:43

Thanks for testing!
