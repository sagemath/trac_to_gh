# Issue 23655: Various doctest failures if pynormaliz is installed

archive/issues_023655.json:
```json
{
    "body": "CC:  @koffie\n\nDetails to follow...\n\nIssue created by migration from https://trac.sagemath.org/ticket/23892\n\n",
    "created_at": "2017-09-19T10:58:06Z",
    "labels": [
        "component: packages: optional",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Various doctest failures if pynormaliz is installed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23655",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @koffie

Details to follow...

Issue created by migration from https://trac.sagemath.org/ticket/23892





---

archive/issue_comments_330966.json:
```json
{
    "body": "Again??? :(",
    "created_at": "2017-09-19T11:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330966",
    "user": "https://github.com/koffie"
}
```

Again??? :(



---

archive/issue_comments_330967.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-20T12:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330967",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_330968.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-09-20T12:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330968",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_330969.json:
```json
{
    "body": "Hi Jeroen,\n\nI want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.",
    "created_at": "2017-09-20T12:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330969",
    "user": "https://github.com/koffie"
}
```

Hi Jeroen,

I want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.



---

archive/issue_comments_330970.json:
```json
{
    "body": "In particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.\n\nSince the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?",
    "created_at": "2017-09-20T13:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330970",
    "user": "https://github.com/jdemeyer"
}
```

In particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.

Since the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?



---

archive/issue_comments_330971.json:
```json
{
    "body": "Replying to [comment:8 mderickx]:\n> Also is there any particular reason for the integer 2?\n\n\nYes, it is the smallest integer strictly larger than 1.\n\n1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.",
    "created_at": "2017-09-20T13:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330971",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 mderickx]:
> Also is there any particular reason for the integer 2?


Yes, it is the smallest integer strictly larger than 1.

1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.



---

archive/issue_comments_330972.json:
```json
{
    "body": "Without the patch I indeed get 4 files with failing doctests if I do:\n\n```\nexport OMP_NUM_THREADS=24\nsage -t long src/sage/combinat/rigged_configurations\n```\n\nand it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. \n\nOne thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?",
    "created_at": "2017-09-20T15:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330972",
    "user": "https://github.com/koffie"
}
```

Without the patch I indeed get 4 files with failing doctests if I do:

```
export OMP_NUM_THREADS=24
sage -t long src/sage/combinat/rigged_configurations
```

and it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. 

One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?



---

archive/issue_comments_330973.json:
```json
{
    "body": "Replying to [comment:11 mderickx]:\n> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.\n\n\nI consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.\n\n> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.\n\n\nAlternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.",
    "created_at": "2017-09-21T07:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330973",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 mderickx]:
> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.


I consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.

> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.


Alternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.



---

archive/issue_comments_330974.json:
```json
{
    "body": "Ok, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.\n\nDoes your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?",
    "created_at": "2017-09-25T13:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330974",
    "user": "https://github.com/koffie"
}
```

Ok, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.

Does your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?



---

archive/issue_comments_330975.json:
```json
{
    "body": "Replying to [comment:13 mderickx]:\n> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?\n\n\nAre you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.",
    "created_at": "2017-09-25T13:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330975",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 mderickx]:
> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?


Are you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.



---

archive/issue_comments_330976.json:
```json
{
    "body": "Sorry, I meant #23613.",
    "created_at": "2017-09-25T13:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330976",
    "user": "https://github.com/koffie"
}
```

Sorry, I meant #23613.



---

archive/issue_comments_330977.json:
```json
{
    "body": "Ok looks good to me.",
    "created_at": "2017-09-25T15:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330977",
    "user": "https://github.com/koffie"
}
```

Ok looks good to me.



---

archive/issue_comments_330978.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-25T15:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330978",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330979.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-09-25T22:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330979",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_330980.json:
```json
{
    "body": "Reviewer name",
    "created_at": "2017-09-25T22:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330980",
    "user": "https://github.com/vbraun"
}
```

Reviewer name



---

archive/issue_comments_330981.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-09-26T01:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330981",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_330982.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-01T00:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330982",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060840.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:19:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23655#event-60840"
}
```



---

archive/issue_comments_330983.json:
```json
{
    "body": "I wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...",
    "created_at": "2017-10-05T16:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330983",
    "user": "https://github.com/embray"
}
```

I wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...



---

archive/issue_comments_330984.json:
```json
{
    "body": "Oh wait, this was just for the doctests, I misread.  Maybe not then...",
    "created_at": "2017-10-05T16:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23655#issuecomment-330984",
    "user": "https://github.com/embray"
}
```

Oh wait, this was just for the doctests, I misread.  Maybe not then...
