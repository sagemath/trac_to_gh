# Issue 23655: Various doctest failures if pynormaliz is installed

Issue created by migration from https://trac.sagemath.org/ticket/23892

Original creator: jdemeyer

Original creation time: 2017-09-19 10:58:06

CC:  mderickx

Details to follow...


---

Comment by mderickx created at 2017-09-19 11:20:19

Again??? :(


---

Comment by jdemeyer created at 2017-09-20 12:02:03

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-20 12:02:03

New commits:


---

Comment by mderickx created at 2017-09-20 12:22:07

Hi Jeroen,

I want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.


---

Comment by jdemeyer created at 2017-09-20 13:21:09

In particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.

Since the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?


---

Comment by jdemeyer created at 2017-09-20 13:22:34

Replying to [comment:8 mderickx]:
> Also is there any particular reason for the integer 2?

Yes, it is the smallest integer strictly larger than 1.

1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.


---

Comment by mderickx created at 2017-09-20 15:02:29

Without the patch I indeed get 4 files with failing doctests if I do:


```
export OMP_NUM_THREADS=24
sage -t long src/sage/combinat/rigged_configurations
```


and it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. 

One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?


---

Comment by jdemeyer created at 2017-09-21 07:53:52

Replying to [comment:11 mderickx]:
> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.

I consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.

> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.

Alternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.


---

Comment by mderickx created at 2017-09-25 13:15:40

Ok, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.

Does your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?


---

Comment by jdemeyer created at 2017-09-25 13:24:52

Replying to [comment:13 mderickx]:
> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?

Are you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.


---

Comment by mderickx created at 2017-09-25 13:35:09

Sorry, I meant #23613.


---

Comment by mderickx created at 2017-09-25 15:43:05

Ok looks good to me.


---

Comment by mderickx created at 2017-09-25 15:43:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-25 22:42:06

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-09-25 22:42:06

Reviewer name


---

Comment by mderickx created at 2017-09-26 01:59:30

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-10-01 00:19:15

Resolution: fixed


---

Comment by embray created at 2017-10-05 16:54:20

I wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...


---

Comment by embray created at 2017-10-05 16:55:51

Oh wait, this was just for the doctests, I misread.  Maybe not then...
