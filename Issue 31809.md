# Issue 31809: Use pip --use-feature=in-tree-build, replace use of sdh_setup_bdist_wheel by sdh_pip_install

Issue created by migration from https://trac.sagemath.org/ticket/32046

Original creator: mkoeppe

Original creation time: 2021-06-23 18:43:30

CC:  jhpalmieri @kliem isuruf

This is a feature added in pip 21.1.

We can now build wheels for all packages using `pip wheel`, even those with symlinks or that need in-tree configuration files. Direct invocation of `setup.py bdist_wheel` is no longer necessary.



---

Comment by git created at 2021-06-23 20:24:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-23 20:35:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-23 20:38:25

A similar change can be done with `numpy`, but to avoid conflicts, that's best done in #32021 or #31565


---

Comment by mkoeppe created at 2021-06-23 20:38:25

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-06-27 22:19:21

Do we need to change `build/pkgs/pip/install-requires.txt` to require at least version 21.1?


---

Comment by mkoeppe created at 2021-06-27 22:24:08

Yes, it's a good idea to update it to document this lower bound - although technically pip's lower bound is not used - pip does not appear in `build/pkgs/sagelib/src/pyproject.toml.m4` nor `build/pkgs/sagelib/src/setup.cfg.m4`.


---

Comment by git created at 2021-06-27 22:28:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-06-28 03:41:16

Replying to [comment:6 mkoeppe]:
> Yes, it's a good idea to update it to document this lower bound - although technically pip's lower bound is not used - pip does not appear in `build/pkgs/sagelib/src/pyproject.toml.m4` nor `build/pkgs/sagelib/src/setup.cfg.m4`.

So what happens if someone has a system version of pip installed that doesn't support `--use-feature=in-tree-build`?


---

Comment by mkoeppe created at 2021-06-28 03:45:35

We don't use any system Python packages, even when we use system Python.


---

Comment by jhpalmieri created at 2021-06-28 04:35:20

Are you saying that we always build and use our own pip? Are the entries in `pip/distros` ignored?


---

Comment by mkoeppe created at 2021-06-28 04:44:52

Replying to [comment:10 jhpalmieri]:
> Are you saying that we always build and use our own pip? 

That's right. See `build/bin/sage-venv`, which is the script that we use to set up our venv over the system Python. https://docs.python.org/3/library/venv.html#venv.EnvBuilder `with_pip` defaults to False; and we also use `system_site_packages=False`.
We then bootstrap `setuptools`, `pip`, and `wheel` in our empty virtual environment -- same as we do when we build our own python.

> Are the entries in `pip/distros` ignored?

Yes, they are only decoration. There is currently only one use-case for Python system packages, and that is a conda development environment (see `src/environment.yml`).


---

Comment by mkoeppe created at 2021-07-24 19:10:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-24 19:14:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-24 19:14:48

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-08-12 20:56:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 21:07:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-12 21:07:52

Replying to [comment:4 mkoeppe]:
> A similar change can be done with `numpy`, but to avoid conflicts, that's best done in #32021 or #31565

I've made the change now


---

Comment by git created at 2021-08-12 22:14:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-08-16 20:25:04

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-08-16 20:25:04

Okay, let's merge it. It works for me on OS X. I haven't tested with conda, but the changes make sense.


---

Comment by mkoeppe created at 2021-08-16 20:44:18

Thanks!


---

Comment by vbraun created at 2021-08-31 22:00:50

Resolution: fixed
