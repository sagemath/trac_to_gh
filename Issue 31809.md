# Issue 31809: Use pip --use-feature=in-tree-build, replace use of sdh_setup_bdist_wheel by sdh_pip_install

archive/issues_031809.json:
```json
{
    "body": "CC:  @jhpalmieri @kliem @isuruf\n\nThis is a feature added in pip 21.1.\n\nWe can now build wheels for all packages using `pip wheel`, even those with symlinks or that need in-tree configuration files. Direct invocation of `setup.py bdist_wheel` is no longer necessary.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32046\n\n",
    "created_at": "2021-06-23T18:43:30Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Use pip --use-feature=in-tree-build, replace use of sdh_setup_bdist_wheel by sdh_pip_install",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31809",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @kliem @isuruf

This is a feature added in pip 21.1.

We can now build wheels for all packages using `pip wheel`, even those with symlinks or that need in-tree configuration files. Direct invocation of `setup.py bdist_wheel` is no longer necessary.


Issue created by migration from https://trac.sagemath.org/ticket/32046





---

archive/issue_comments_454067.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-23T20:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454067",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454068.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-23T20:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454069.json:
```json
{
    "body": "A similar change can be done with `numpy`, but to avoid conflicts, that's best done in #32021 or #31565",
    "created_at": "2021-06-23T20:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454069",
    "user": "https://github.com/mkoeppe"
}
```

A similar change can be done with `numpy`, but to avoid conflicts, that's best done in #32021 or #31565



---

archive/issue_comments_454070.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-23T20:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454070",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_454071.json:
```json
{
    "body": "Do we need to change `build/pkgs/pip/install-requires.txt` to require at least version 21.1?",
    "created_at": "2021-06-27T22:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454071",
    "user": "https://github.com/jhpalmieri"
}
```

Do we need to change `build/pkgs/pip/install-requires.txt` to require at least version 21.1?



---

archive/issue_comments_454072.json:
```json
{
    "body": "Yes, it's a good idea to update it to document this lower bound - although technically pip's lower bound is not used - pip does not appear in `build/pkgs/sagelib/src/pyproject.toml.m4` nor `build/pkgs/sagelib/src/setup.cfg.m4`.",
    "created_at": "2021-06-27T22:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454072",
    "user": "https://github.com/mkoeppe"
}
```

Yes, it's a good idea to update it to document this lower bound - although technically pip's lower bound is not used - pip does not appear in `build/pkgs/sagelib/src/pyproject.toml.m4` nor `build/pkgs/sagelib/src/setup.cfg.m4`.



---

archive/issue_comments_454073.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-27T22:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454074.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Yes, it's a good idea to update it to document this lower bound - although technically pip's lower bound is not used - pip does not appear in `build/pkgs/sagelib/src/pyproject.toml.m4` nor `build/pkgs/sagelib/src/setup.cfg.m4`.\n\nSo what happens if someone has a system version of pip installed that doesn't support `--use-feature=in-tree-build`?",
    "created_at": "2021-06-28T03:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454074",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:6 mkoeppe]:
> Yes, it's a good idea to update it to document this lower bound - although technically pip's lower bound is not used - pip does not appear in `build/pkgs/sagelib/src/pyproject.toml.m4` nor `build/pkgs/sagelib/src/setup.cfg.m4`.

So what happens if someone has a system version of pip installed that doesn't support `--use-feature=in-tree-build`?



---

archive/issue_comments_454075.json:
```json
{
    "body": "We don't use any system Python packages, even when we use system Python.",
    "created_at": "2021-06-28T03:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454075",
    "user": "https://github.com/mkoeppe"
}
```

We don't use any system Python packages, even when we use system Python.



---

archive/issue_comments_454076.json:
```json
{
    "body": "Are you saying that we always build and use our own pip? Are the entries in `pip/distros` ignored?",
    "created_at": "2021-06-28T04:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454076",
    "user": "https://github.com/jhpalmieri"
}
```

Are you saying that we always build and use our own pip? Are the entries in `pip/distros` ignored?



---

archive/issue_comments_454077.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> Are you saying that we always build and use our own pip? \n\nThat's right. See `build/bin/sage-venv`, which is the script that we use to set up our venv over the system Python. https://docs.python.org/3/library/venv.html#venv.EnvBuilder `with_pip` defaults to False; and we also use `system_site_packages=False`.\nWe then bootstrap `setuptools`, `pip`, and `wheel` in our empty virtual environment -- same as we do when we build our own python.\n\n> Are the entries in `pip/distros` ignored?\n\nYes, they are only decoration. There is currently only one use-case for Python system packages, and that is a conda development environment (see `src/environment.yml`).",
    "created_at": "2021-06-28T04:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454077",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:10 jhpalmieri]:
> Are you saying that we always build and use our own pip? 

That's right. See `build/bin/sage-venv`, which is the script that we use to set up our venv over the system Python. https://docs.python.org/3/library/venv.html#venv.EnvBuilder `with_pip` defaults to False; and we also use `system_site_packages=False`.
We then bootstrap `setuptools`, `pip`, and `wheel` in our empty virtual environment -- same as we do when we build our own python.

> Are the entries in `pip/distros` ignored?

Yes, they are only decoration. There is currently only one use-case for Python system packages, and that is a conda development environment (see `src/environment.yml`).



---

archive/issue_comments_454078.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-24T19:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454078",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_454079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-24T19:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454080.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-24T19:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454080",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_084796.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-24T19:14:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31809#event-84796"
}
```



---

archive/issue_comments_454081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-12T20:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454081",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454082.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-12T21:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454082",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454083.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> A similar change can be done with `numpy`, but to avoid conflicts, that's best done in #32021 or #31565\n\nI've made the change now",
    "created_at": "2021-08-12T21:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454083",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:4 mkoeppe]:
> A similar change can be done with `numpy`, but to avoid conflicts, that's best done in #32021 or #31565

I've made the change now



---

archive/issue_comments_454084.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-12T22:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454084",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454085.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-16T20:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454085",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_454086.json:
```json
{
    "body": "Okay, let's merge it. It works for me on OS X. I haven't tested with conda, but the changes make sense.",
    "created_at": "2021-08-16T20:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454086",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, let's merge it. It works for me on OS X. I haven't tested with conda, but the changes make sense.



---

archive/issue_comments_454087.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-08-16T20:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454087",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_454088.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-08-31T22:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-454088",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_084797.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-08-31T22:00:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31809#event-84797"
}
```
