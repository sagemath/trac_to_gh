# Issue 20056: matrix constructor fails on numpy.matrix

archive/issues_020056.json:
```json
{
    "body": "Keywords: numpy, matrix\n\nThis failure seems to be new in Sage.7.2.beta0 \n\n```\nsage: import numpy\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: matrix(n)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-7-649197712655> in <module>()\n----> 1 matrix(n)\n\n/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()\n    741                     entries = arg\n    742                 else:\n--> 743                     raise TypeError(\"invalid matrix constructor: type matrix? for help\")\n    744         else:  # len(args) >= 2\n    745             raise TypeError(\"invalid matrix constructor: type matrix? for help\")\n\nTypeError: invalid matrix constructor: type matrix? for help\n```\n\n\nUsing `numpy.array` instead of `numpy.matrix` still works (and is doctested).  \n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20293\n\n",
    "created_at": "2016-03-25T17:26:39Z",
    "labels": [
        "numerical",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "matrix constructor fails on numpy.matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20056",
    "user": "cnassau"
}
```
Keywords: numpy, matrix

This failure seems to be new in Sage.7.2.beta0 

```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: matrix(n)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-7-649197712655> in <module>()
----> 1 matrix(n)

/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()
    741                     entries = arg
    742                 else:
--> 743                     raise TypeError("invalid matrix constructor: type matrix? for help")
    744         else:  # len(args) >= 2
    745             raise TypeError("invalid matrix constructor: type matrix? for help")

TypeError: invalid matrix constructor: type matrix? for help
```


Using `numpy.array` instead of `numpy.matrix` still works (and is doctested).  


Issue created by migration from https://trac.sagemath.org/ticket/20293





---

archive/issue_comments_276259.json:
```json
{
    "body": "I think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:\n\n\n```\nsage: import numpy\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: from sage.structure.coerce import is_numpy_type\nsage: is_numpy_type(type(n))\nFalse\n```\n\n\nThe code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with \"numpy.\"; in this case the `tp_name` is just \"`matrix`\". Maybe we should check `type(n).__module__` instead, since the official doc \n   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name\nsays that \"dynamically allocated types\" should not contain the module name in the `tp_type`. \n\n\n```\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: type(n).__module__\n'numpy.matrixlib.defmatrix'\nsage: n = numpy.array([[1,2],[3,4]],float)\nsage: type(n).__module__\n'numpy'\n```\n\nI currently do not know how to code this check in cython, though.",
    "created_at": "2016-03-25T18:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276259",
    "user": "cnassau"
}
```

I think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:


```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: from sage.structure.coerce import is_numpy_type
sage: is_numpy_type(type(n))
False
```


The code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with "numpy."; in this case the `tp_name` is just "`matrix`". Maybe we should check `type(n).__module__` instead, since the official doc 
   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name
says that "dynamically allocated types" should not contain the module name in the `tp_type`. 


```
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy.matrixlib.defmatrix'
sage: n = numpy.array([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy'
```

I currently do not know how to code this check in cython, though.



---

archive/issue_comments_276260.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-25T21:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276260",
    "user": "cnassau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_276261.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276261",
    "user": "cnassau"
}
```

New commits:



---

archive/issue_comments_276262.json:
```json
{
    "body": "This is silly:\n\n```\nstrncmp(t.__module__, \"numpy\", 5) == 0\n```\n\nEither you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.",
    "created_at": "2016-03-27T07:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276262",
    "user": "jdemeyer"
}
```

This is silly:

```
strncmp(t.__module__, "numpy", 5) == 0
```

Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.



---

archive/issue_comments_276263.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-27T08:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276263",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276264.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> This is silly:\n> {{{\n> strncmp(t.__module__, \"numpy\", 5) == 0\n> }}}\n> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.\n\nHere you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).",
    "created_at": "2016-03-27T09:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276264",
    "user": "cnassau"
}
```

Replying to [comment:5 jdemeyer]:
> This is silly:
> {{{
> strncmp(t.__module__, "numpy", 5) == 0
> }}}
> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.

Here you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).



---

archive/issue_comments_276265.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-27T09:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276265",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276266.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-27T10:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276266",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_276267.json:
```json
{
    "body": "To keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!",
    "created_at": "2016-03-29T03:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276267",
    "user": "vdelecroix"
}
```

To keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!



---

archive/issue_comments_276268.json:
```json
{
    "body": "One other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.\n\nI'm not going to implement that, though, since I'm away on vacation, starting now.",
    "created_at": "2016-03-29T08:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276268",
    "user": "cnassau"
}
```

One other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.

I'm not going to implement that, though, since I'm away on vacation, starting now.



---

archive/issue_comments_276269.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-29T08:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276269",
    "user": "cnassau"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_276270.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276270",
    "user": "cnassau"
}
```

New commits:



---

archive/issue_comments_276271.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276271",
    "user": "cnassau"
}
```

New commits:



---

archive/issue_comments_276272.json:
```json
{
    "body": "New commits:\n|                                                                                                                                          |                                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|\n|[050d97d](http://git.sagemath.org/sage.git/commit/?id=050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|\nThe matrix constructor has been slightly changed:\n\n* it uses a new function \"might_be_numpy_array\" to test for numpy array/matrix objects before actually importing numpy. This way the function \"is_numpy_type\" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the \"newbyteorder\" method.\n\n* the conversion from numpy array/matrix to python lists now uses the numpy \"tolist\" method. The old code no longer worked for numpy.matrix objects (only numpy.array).",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276272",
    "user": "cnassau"
}
```

New commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[050d97d](http://git.sagemath.org/sage.git/commit/?id=050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|
The matrix constructor has been slightly changed:

* it uses a new function "might_be_numpy_array" to test for numpy array/matrix objects before actually importing numpy. This way the function "is_numpy_type" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the "newbyteorder" method.

* the conversion from numpy array/matrix to python lists now uses the numpy "tolist" method. The old code no longer worked for numpy.matrix objects (only numpy.array).



---

archive/issue_comments_276273.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-12T11:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276273",
    "user": "cnassau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_276274.json:
```json
{
    "body": "I didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.",
    "created_at": "2016-04-12T11:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276274",
    "user": "jdemeyer"
}
```

I didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.



---

archive/issue_comments_276275.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-12T11:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276275",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_276276.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276276",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_276277.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276277",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_276278.json:
```json
{
    "body": "Simple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?",
    "created_at": "2016-04-12T15:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276278",
    "user": "vdelecroix"
}
```

Simple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?



---

archive/issue_comments_276279.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?\n\nYes, and I think that's probably the right thing to do anyway.",
    "created_at": "2016-04-12T15:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276279",
    "user": "jdemeyer"
}
```

Replying to [comment:21 vdelecroix]:
> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?

Yes, and I think that's probably the right thing to do anyway.



---

archive/issue_comments_276280.json:
```json
{
    "body": "Why not\n\n```\nreturn strncmp(T.tp_name, \"numpy.\", 6) == 0 or \\\n       strncmp(T.tp_base.tp_name, \"numpy.\", 6) == 0\n```\n",
    "created_at": "2016-04-12T15:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276280",
    "user": "vdelecroix"
}
```

Why not

```
return strncmp(T.tp_name, "numpy.", 6) == 0 or \
       strncmp(T.tp_base.tp_name, "numpy.", 6) == 0
```




---

archive/issue_comments_276281.json:
```json
{
    "body": "Readability?",
    "created_at": "2016-04-12T15:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276281",
    "user": "jdemeyer"
}
```

Readability?



---

archive/issue_comments_276282.json:
```json
{
    "body": "I guess this is a personal matter...",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276282",
    "user": "vdelecroix"
}
```

I guess this is a personal matter...



---

archive/issue_comments_276283.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276283",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_276284.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> New commits:\n> ||[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)||`Support numpy.matrix in is_numpy_type()`||\n> ||[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)||`Doctest conversion numpy.matrix -> Sage matrix`||\n\nThanks for getting this fixed!",
    "created_at": "2016-04-12T18:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276284",
    "user": "cnassau"
}
```

Replying to [comment:20 jdemeyer]:
> New commits:
> ||[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)||`Support numpy.matrix in is_numpy_type()`||
> ||[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)||`Doctest conversion numpy.matrix -> Sage matrix`||

Thanks for getting this fixed!



---

archive/issue_comments_276285.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-13T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20056",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20056#issuecomment-276285",
    "user": "vbraun"
}
```

Resolution: fixed
