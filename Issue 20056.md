# Issue 20056: matrix constructor fails on numpy.matrix

Issue created by migration from https://trac.sagemath.org/ticket/20293

Original creator: cnassau

Original creation time: 2016-03-25 17:26:39

Keywords: numpy, matrix

This failure seems to be new in Sage.7.2.beta0 

```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: matrix(n)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-7-649197712655> in <module>()
----> 1 matrix(n)

/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()
    741                     entries = arg
    742                 else:
--> 743                     raise TypeError("invalid matrix constructor: type matrix? for help")
    744         else:  # len(args) >= 2
    745             raise TypeError("invalid matrix constructor: type matrix? for help")

TypeError: invalid matrix constructor: type matrix? for help
```


Using `numpy.array` instead of `numpy.matrix` still works (and is doctested).  



---

Comment by cnassau created at 2016-03-25 18:11:23

I think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:


```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: from sage.structure.coerce import is_numpy_type
sage: is_numpy_type(type(n))
False
```


The code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with "numpy."; in this case the `tp_name` is just "`matrix`". Maybe we should check `type(n).__module__` instead, since the official doc 
   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name
says that "dynamically allocated types" should not contain the module name in the `tp_type`. 


```
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy.matrixlib.defmatrix'
sage: n = numpy.array([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy'
```

I currently do not know how to code this check in cython, though.


---

Comment by cnassau created at 2016-03-25 21:36:34

Changing status from new to needs_review.


---

Comment by cnassau created at 2016-03-26 06:52:25

New commits:


---

Comment by jdemeyer created at 2016-03-27 07:36:45

This is silly:

```
strncmp(t.__module__, "numpy", 5) == 0
```

Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.


---

Comment by git created at 2016-03-27 08:56:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cnassau created at 2016-03-27 09:03:19

Replying to [comment:5 jdemeyer]:
> This is silly:
> {{{
> strncmp(t.__module__, "numpy", 5) == 0
> }}}
> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.

Here you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).


---

Comment by git created at 2016-03-27 09:38:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-27 10:10:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-03-29 03:17:24

To keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!


---

Comment by cnassau created at 2016-03-29 08:32:55

One other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.

I'm not going to implement that, though, since I'm away on vacation, starting now.


---

Comment by cnassau created at 2016-03-29 08:33:36

Changing status from needs_review to needs_work.


---

Comment by cnassau created at 2016-04-12 10:51:32

New commits:


---

Comment by cnassau created at 2016-04-12 10:57:34

New commits:


---

Comment by cnassau created at 2016-04-12 10:59:06

New commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[050d97d](http://git.sagemath.org/sage.git/commit/?id=050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|
The matrix constructor has been slightly changed:

   * it uses a new function "might_be_numpy_array" to test for numpy array/matrix objects before actually importing numpy. This way the function "is_numpy_type" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the "newbyteorder" method.

   * the conversion from numpy array/matrix to python lists now uses the numpy "tolist" method. The old code no longer worked for numpy.matrix objects (only numpy.array).


---

Comment by cnassau created at 2016-04-12 11:06:43

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-04-12 11:22:27

I didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.


---

Comment by jdemeyer created at 2016-04-12 11:35:55

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-04-12 11:36:27

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-04-12 11:36:27

New commits:


---

Comment by vdelecroix created at 2016-04-12 15:04:45

Simple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?


---

Comment by jdemeyer created at 2016-04-12 15:09:17

Replying to [comment:21 vdelecroix]:
> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?

Yes, and I think that's probably the right thing to do anyway.


---

Comment by vdelecroix created at 2016-04-12 15:14:58

Why not

```
return strncmp(T.tp_name, "numpy.", 6) == 0 or \
       strncmp(T.tp_base.tp_name, "numpy.", 6) == 0
```



---

Comment by jdemeyer created at 2016-04-12 15:17:01

Readability?


---

Comment by vdelecroix created at 2016-04-12 15:45:42

I guess this is a personal matter...


---

Comment by vdelecroix created at 2016-04-12 15:45:42

Changing status from needs_review to positive_review.


---

Comment by cnassau created at 2016-04-12 18:16:24

Replying to [comment:20 jdemeyer]:
> New commits:
> ||[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)||`Support numpy.matrix in is_numpy_type()`||
> ||[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)||`Doctest conversion numpy.matrix -> Sage matrix`||

Thanks for getting this fixed!


---

Comment by vbraun created at 2016-04-13 17:05:16

Resolution: fixed
