# Issue 26016: update psutil to version 5.4.7

Issue created by migration from https://trac.sagemath.org/ticket/26253

Original creator: dimpase

Original creation time: 2018-09-11 21:41:26

CC:  embray slelievre mjo mkoeppe fbissey arojas isuruf

the tarball is here: 

https://files.pythonhosted.org/packages/7d/9a/1e93d41708f8ed2b564395edfa3389f0fd6d567597401c2e5e2775118d8b/psutil-5.4.7.tar.gz


---

Comment by dimpase created at 2018-09-11 21:42:13

The cygwin-specific patch does not apply, needs a rebase. It's removed for the sake of being able to test on other system (needed on FreeBSD, older package does not work there).


---

Comment by dimpase created at 2018-09-12 10:18:30

New commits:


---

Comment by dimpase created at 2018-11-21 16:48:05

meanwhile 5.4.8 is out.


---

Comment by embray created at 2018-11-22 11:13:21

I keep starting and stopping on reworking my Cygwin stuff for psutil.  It needs to be refactored pretty badly and every time I start to work on it I quickly get pulled away to other things.

Is there some specific reason to update the psutil version?


---

Comment by dimpase created at 2018-11-22 11:26:10

One reason is that the current version does not work on FreeBSD 12.0.
How hard is that refactoring? I have a Windows laptop around, which BSODs now and then due to some hardware issue, but probably is good enough for mild Cygwin work.

A related Cygwin issue is on #26052 - any idea about that?


---

Comment by embray created at 2018-11-29 13:28:13

It's very non-trivial, unfortunately, and requires upstream cooperation (where in this case the psutil maintainer has been helpful and amenable, but that doesn't mean I can just go and do what I want).


---

Comment by dimpase created at 2019-02-11 12:56:43

meanwhile psutils 5.5.0 is out


---

Comment by chapoton created at 2019-03-01 18:46:03

Changing keywords from "" to "upgrade".


---

Comment by embray created at 2019-03-01 18:50:46

I'm working on a new (simpler) version of the Cygwin patch for psutil.  Hopefully it will be ready soon.


---

Comment by dimpase created at 2019-05-03 16:12:22

the latest psutil is 5.6.2.


---

Comment by fbissey created at 2019-05-03 20:15:53

It would be good to update. Distros likely use a more recent psutil (I do). It causes at least one optional doctest failure (when combined with `fricas`) due to changes to output

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/interfaces/fricas.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/interfaces/fricas.py", line 351, in sage.interfaces.fricas.FriCAS._quit_string
Failed example:
    p = fricas.pid(); pr = psutil.Process(p); pr                  # optional - fricas
Expected:
    <psutil.Process(pid=..., name='AXIOMsys') at ...>
Got:
    psutil.Process(pid=7277, name='AXIOMsys', started='19:52:17')
**********************************************************************
```

This is with `psutil-5.5.0`.


---

Comment by chapoton created at 2019-06-08 06:41:13

Here is a branch, not tested. I have not removed the patches.
----
New commits:


---

Comment by git created at 2019-06-08 06:43:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2020-05-12 12:00:40

New release (2020-02): psutil 5.7.0.


---

Comment by git created at 2020-06-29 16:46:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-29 16:51:27

The psutil upstream issue on cygwin support is still open: https://github.com/giampaolo/psutil/issues/82

Erik, your help is needed


---

Comment by dimpase created at 2020-11-12 09:10:20

perhaps we should look into removing psutils (on cygwin, or perhaps totally)


---

Comment by embray created at 2020-11-12 14:43:55

I have been thinking lately of spending a couple days updating the cygwin version of psutils.  In particular, I think I will start maintaining my own fork of psutils with cygwin support, since last time I tried to upstream these changes it did not go well.  If the psutil developer wants to port over any work from my fork he'd still be free to.

I was thinking about this lately because there was yet another issue on the psutils github asking for cygwin support and pointing to my incomplete pull requests...


---

Comment by embray created at 2020-11-12 14:44:35

If nothing else, I'll try rebasing my existing patches again...


---

Comment by embray created at 2020-11-17 18:03:08

I've rebased the latest version of my Cygwin patch onto psutil master.  Once we update this ticket and decide which psutil version to upgrade to I can update the patch as well.

I might also try submitting this upstream again.  The patch is incomplete (many features are missing) but good enough for Sage's purposes for now.


---

Comment by dimpase created at 2020-11-18 13:19:34

5.7.3 is close to master, so hopefully one can apply your patches on top of  5.7.3


---

Comment by git created at 2020-11-18 17:09:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-18 17:13:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-11-20 12:56:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-11-20 12:57:56

wrong comment - confused by the timeline, which I didn't update. It's fine.


---

Comment by dimpase created at 2020-11-20 13:00:40

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-11-20 13:00:40

this should be tested everywhere, except Cygwin, where Erik has promised a patch.


---

Comment by embray created at 2020-11-24 21:34:39

I can generate a patch from my latest Cygwin branch at https://github.com/embray/psutil/tree/cygwin/v3

But longer term if we want psutil to support Cygwin someone other than me will have to try to talk sense into its maintainer, who apparently does not have time to work on the project, but also says that he and only he can work on the Cygwin port which I've already spent days bringing to around 90% completion, with frankly a pretty clean patch not requiring a lot of changes. Seems pretty unreasonable, and disappointing.

I continued to work on my branch and he blocked me from the project bc I unthinkingly used his `@` in a commit message (perhaps in unfounded optimism that he'd be willing to give the work another look later): https://github.com/giampaolo/psutil/pull/1884#issuecomment-733165286


---

Comment by dimpase created at 2020-11-24 23:14:10

one cannot even open issues on the main psutil repo, I don't think there is any hope that patches would be accepted there.

it's not the 1st case we have where our patches are not welcome, I would not be too upset about it (cf. e.g. csdp, cliquer...)


---

Comment by mkoeppe created at 2020-11-24 23:35:06

We should not maintain patches that add functionality in Sage. This will create problems later when switch to using standard Python package dependency information for Python packages.

Instead I see two options:
 - Fork `psutil`, making it available on PyPI under a new name. Only makes sense if you are willing to maintain it, obviously.
 - Just implement Cygwin version of the few things needed from `psutil` in `src/sage/interfaces/gap.py` and `src/sage/misc/getusage.py`


---

Comment by embray created at 2020-11-27 12:12:40

Replying to [comment:33 mkoeppe]:
> We should not maintain patches that add functionality in Sage. This will create problems later when switch to using standard Python package dependency information for Python packages.

Normally I would agree but that's not really the case here.  We're not talking about adding new functionality or bug fixes required for Sage to function in such a way that would be at odds with using system packages.

This is just adding support to the package for a platform it doesn't otherwise support: Which is to say, there is no "standard Python package dependency information" for psutil on Cygwin.  In fact, PyPI does not even support cygwin wheels yet (something I plan to lobby on, but it's slightly complicated).  There is also no psutil package for Cygwin, again because support for it does not even exist modulo my patch.

> Instead I see two options:
>  - Fork `psutil`, making it available on PyPI under a new name. Only makes sense if you are willing to maintain it, obviously.
>  - Just implement Cygwin version of the few things needed from `psutil` in `src/sage/interfaces/gap.py` and `src/sage/misc/getusage.py`

What I plan to do is, once my Cygwin port of psutil reaches 100% feature parity then I will add a Cygwin package for it to [cygwinports](https://github.com/cygwinports) based on my fork.  Then there will at least be a standard Cygwin package for psutil and we can drop the patch and/or use my fork as the standard installation source for psutil on all platforms.

I don't think it will require a lot of maintenance since he says he's planning on taking a break from making new psutil releases for a while.


---

Comment by git created at 2021-02-21 10:09:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-02-21 17:56:23

Is there any news on Cygwin support?


---

Comment by embray created at 2021-02-26 11:00:50

I don't know.  It would be great if someone would try to talk sense to its maintainer at https://github.com/giampaolo/psutil/pull/1884#issuecomment-733165286.

Otherwise we can still just generate a patch from my existing work in the meantime...


---

Comment by dimpase created at 2021-03-10 14:49:09

It sounds as if psutil is ripe for a fork :-)


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by slelievre created at 2021-08-23 13:03:10

Changing keywords from "upgrade" to "upgrade, psutil".


---

Comment by slelievre created at 2021-08-23 13:03:10

Currently our spkg is at psutil 5.2.0,
from 2017-03 (with patches).

Python 3 deprecation warnings in psutil
were resolved in psutil itself by

- [psutil pull request 1318](https://github.com/giampaolo/psutil/pull/1318),
  merged in 2018-08

With a recent psutil, the first start of
Sage on Cygwin could be warnings-free.

Some user reports mentioning the deprecation warnings:

- [2020-08: Ask Sage question 53120](https://ask.sagemath.org/question/53120)
- [2021-08: sage-support](https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/cP-fduA5AQAJ)


---

Comment by dimpase created at 2021-08-23 17:24:30

psutil 5.8 does not support Cygwin, as far as I know.


---

Comment by mjo created at 2021-10-07 12:13:53

Do we need psutil at all? I think we can delete it. It's used for three things:

1. To guess at the initial GAP memory pool size, passed to gap via `-o` and `-s`. I don't think we need these flags, though: https://www.gap-system.org/Manuals/doc/ref/chap3.html
2. To set the maximum stack size during PARI initialization. Again, we can just set it to a big number; it's a limit, and we're already guessing.
3. Two doctests that call `get_memory_usage()` to check for leaks.

Those two doctests are not worth keeping it around, even as an optional package, considering it won't work on one of our supported platforms. So I say we,

1. Drop the `-o` and `-s` flags to GAP. If the absence of `-s` causes problems in some cases, we  can always pass `-s <big_number>` since that memory should not actually be allocated. And if _that_ assumption is violated on some platform, then we could special-case that platform.
2. Pass a big value to PARI in `libs/pari/__init__.py` for its stack size limit. 1024 times the initial size, or something like that.
3. Delete those two doctests.
4. Delete psutil, and sleep easier knowing that we won't be responsible for a fork of it for the rest of our lives.


---

Comment by dimpase created at 2021-10-07 16:27:04

+1 to removing psutils


---

Comment by mkoeppe created at 2021-10-07 17:40:21

+1 if it can be done without breaking stuff


---

Comment by mkoeppe created at 2021-10-07 19:14:37

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2021-10-10 12:31:15

Consider setting to invalid/wontfix after removal of psutil in #32656.


---

Comment by slelievre created at 2021-10-10 12:31:15

Changing status from needs_work to needs_info.


---

Comment by slelievre created at 2021-11-08 12:35:02

Changing status from needs_info to needs_review.


---

Comment by slelievre created at 2021-11-08 12:35:02

Ticket #32656 was merged in Sage 9.5.beta5.


---

Comment by mjo created at 2021-11-20 22:42:27

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-20 23:57:15

Resolution: invalid
