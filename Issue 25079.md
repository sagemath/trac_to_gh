# Issue 25079: Replace python 5755 patch by monkey patch

Issue created by migration from https://trac.sagemath.org/ticket/25316

Original creator: @timokau

Original creation time: 2018-05-09 10:34:40

Python bug #5755 won't be fixed in 2.7. Because of that, sage patches python.

I don't know what the policy for that is, but at least in my opinion hard patches of dependencies (especially big ones such as python) should be avoided if possible.

In this case it is possible: We can instead monkey-patch `build_extensions` to always remove the `-Wstrict-prototypes` argument. Thats a bit of a hack of course. But it doesn't have any practical disadvantages to the python patch and removes one patch from python.


---

Comment by @timokau created at 2018-05-09 10:34:51

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-05-09 11:40:59

Replying to [ticket:25316 gh-timokau]:
> We can instead monkey-patch `build_extensions` to always remove the `-Wstrict-prototypes` argument.

I don't see that in your branch.


---

Comment by jdemeyer created at 2018-05-09 11:40:59

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-05-09 12:00:52

Two general comments:

1. This patch fixes a _warning_, it should not affect functionality. Are there any problems building Sage without this patch?

2. There are plenty of patches to Python in Sage. I don't think that all of them can be replaced by a monkey-patch, so how does it help if this one patch is removed?


---

Comment by git created at 2018-05-09 12:13:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-05-09 12:14:14

Replying to [comment:3 jdemeyer]:
> Replying to [ticket:25316 gh-timokau]:
> > We can instead monkey-patch `build_extensions` to always remove the `-Wstrict-prototypes` argument.
> 
> I don't see that in your branch.

Oh sorry, I must've forgotten to `git add` it. I've amended the commit.


---

Comment by @timokau created at 2018-05-09 12:19:38

Replying to [comment:4 jdemeyer]:
> Two general comments:
> 
> 1. This patch fixes a _warning_, it should not affect functionality. Are there any problems building Sage without this patch?

Not building, but it causes the doctests to fail.

> 2. There are plenty of patches to Python in Sage. I don't think that all of them can be replaced by a monkey-patch, so how does it help if this one patch is removed?

Its not *that* much. I only had to adopt two: `re_match_index-issue_27177.patch` (apparently `re` is impossible to monkey-patch) and `descr_ref-issue_25750.patch`.

The re patch was accepted upstream but unfortuantely not backported to 2.7.

The other one is currently in an upstream PR and seems likely to be accepted.

So after that one is accepted, only one patch is needed. I think just because 0 patches can't be archived doesn't mean the amount shouldn't be minimized.


---

Comment by jdemeyer created at 2018-05-09 14:50:22

Replying to [comment:7 gh-timokau]:
> it causes the doctests to fail.

Can you show the test failures?


---

Comment by @timokau created at 2018-05-09 21:14:15

Surprisingly not all that many, just 3 tests in `cython.py`:

https://gist.github.com/timokau/569928555dcec4868d7411c0ca6beb51


---

Comment by @timokau created at 2018-05-10 11:58:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-05-11 21:16:55

To be honest, I'm not too happy with this branch. The Python patch that you want to remove fixes an obvious bug. The way I see it, you're proposing that Sage *adds* a Python bug. I don't think that Sage should suffer because upstream Python ignores a bug report.

Of course, I'll admit that I'm very biased: I'm not packaging Sage for a distro, so I'm in a very different situation than you are.


---

Comment by @timokau created at 2018-05-12 14:15:13

I get where you're coming from. Its a matter of priorities: every patch to sages dependencies makes packaging sage a bit more painful. In my mind reducing that hurdle is more valuable than the "purity" gained by patching python instead. If upstream doesn't recognize the bug, I think its best to work around it if possible.

Its not *that* important to me anymore: I already have a working patch for sage that probably won't be too hard to maintain. But it is one more annoyance if somebody wants to create a sage package for another distro.


---

Comment by jdemeyer created at 2018-05-12 14:47:32

Replying to [comment:12 gh-timokau]:
> If upstream doesn't recognize the bug, I think its best to work around it if possible.

This is the part that I disagree most with. In my view, it's Python who is at fault here, not Sage.

Maybe I should just open a real pull request for the upstream Python issue?


---

Comment by nbruin created at 2018-05-12 19:34:03

The patch produced here has a runtime effect: Any sage process will import distutils. It doesn't do that now.

Another, reduced, effect: presently, with the hard patch included, the "sage" python will have this fixed. After this fix, it will only have it fixed if it imports sage.all (which probably not all scripts in the sage distributions do).

So it looks like a proper monkeypatch fix would find a hook somewhere to execute the patch upon importing distutils. Another option would be to instead import some module distutils-fixed or so (together with distutils) to make the fix. That would basically amount to manually providing the relevant hook. That's probably rather invasive to maintain.

I think the most important part is that sage can run as much as possible on vanilla python, so that we allow progress towards integrating sage as normal software, rather than having it live in its own little world. Given that the problem here seems to be a warning perhaps we don't need to insist on fixing it.


---

Comment by @timokau created at 2018-05-12 21:44:04

Replying to [comment:13 jdemeyer]:
> In my view, it's Python who is at fault here, not Sage.

Definitely pythons fault. But what does it practically matter who is at fault? If python does not fix it, sage users (or packagers) are the ones who have to deal with it.

> Maybe I should just open a real pull request for the upstream Python issue?
> Replying to [comment:12 gh-timokau]:
> > If upstream doesn't recognize the bug, I think its best to work around it if possible.

This is the part that I disagree most with. bug already something like a pull request that was effectively rejected? I'm not very familiar with the contribution process of python.
Isn't the python 


Replying to [comment:14 nbruin]:
> The patch produced here has a runtime effect: Any sage process will import distutils. It doesn't do that now.

Does that make any practical difference? Distutils will always be there anyways and while I haven't run any benchmarks, I can't imagine that it significantly impacts sages startup time.

> Another, reduced, effect: presently, with the hard patch included, the "sage" python will have this fixed. After this fix, it will only have it fixed if it imports sage.all (which probably not all scripts in the sage distributions do).

Well its just a warning after all, so practically it mostly matters to fix the doctests.

> So it looks like a proper monkeypatch fix would find a hook somewhere to execute the patch upon importing distutils. Another option would be to instead import some module distutils-fixed or so (together with distutils) to make the fix. That would basically amount to manually providing the relevant hook. That's probably rather invasive to maintain.

That honestly exceeds my pthon knowledge.

> I think the most important part is that sage can run as much as possible on vanilla python, so that we allow progress towards integrating sage as normal software, rather than having it live in its own little world.

Exactly my point.

> Given that the problem here seems to be a warning perhaps we don't need to insist on fixing it.

We could instead just drop the patch entirely and fix the few failing doctests.

I think its very valuable to have the doctests pass. Sages doctests may be a bit brittle, but very valuable
nonetheless.


---

Comment by jdemeyer created at 2018-05-13 09:44:46

Has the particular patch that you suggest as monkey-patch (but perhaps only for C++ extensions) been proposed as pull request? As far as I can tell not.


---

Comment by jdemeyer created at 2018-05-13 09:45:41

Replying to [comment:15 gh-timokau]:
> Definitely pythons fault. But what does it practically matter who is at fault? If python does not fix it, sage users (or packagers) are the ones who have to deal with it.

Packagers could just package the Python patch too.


---

Comment by @timokau created at 2018-05-13 09:58:00

Replying to [comment:16 jdemeyer]:
> Has the particular patch that you suggest as monkey-patch been proposed as pull request? As far as I can tell not.

Isn't the python bug linked the equivalent of a pull request? As I said, not familiar with the process there. The best outcome would be if upstream just accepted the patch of course.

> Packagers could just package the Python patch too.

Yeah thats what I meant with packagers have to deal with it. Every patch adds friction while packaging.


---

Comment by jdemeyer created at 2018-05-14 05:35:34

Replying to [comment:18 gh-timokau]:
> Isn't the python bug linked the equivalent of a pull request?

The patch sent upstream is the same patch as in Sage, but very different from what you are proposing as monkey-patch here. So my proposal is: change the monkey-patch to a real patch, make sure that it takes effect only for non-C code and then put that in a pull request.


---

Comment by @timokau created at 2018-05-14 09:32:31

Replying to [comment:19 jdemeyer]:
> So my proposal is: change the monkey-patch to a real patch, make sure that it takes effect only for non-C code and then put that in a pull request.

Why should that have any better chances than the current one? In my view the one currently proposed upstream is "cleaner" as a hard-patch, because it doesn't add the flag to begin with. The monkey patch is more of a band-aid.


---

Comment by jdemeyer created at 2018-05-14 09:55:41

Replying to [comment:20 gh-timokau]:
> Why should that have any better chances than the current one? In my view the one currently proposed upstream is "cleaner" as a hard-patch, because it doesn't add the flag to begin with.

One could certainly argue that it's a feature to add that flag for C code. But given how distutils almost makes no difference between C and C++ code, I just realized that it's not really possible to add that flag just for C code.


---

Comment by jdemeyer created at 2018-05-14 09:58:42

Still, it makes sense to compile Python itself with `-Wstrict-prototypes` but not extension modules.


---

Comment by @timokau created at 2018-05-14 10:04:29

That seems to be done in the linked issues:

https://bugs.python.org/issue1222585
https://bugs.python.org/issue9031

However since they are "adding" support for C++ (as opposed to "fixing" broken C++ support), a 2.7 backport seems unlikely.


---

Comment by jdemeyer created at 2018-06-04 12:50:29

Upstream CPython has accepted the patch which was originally in Sage.


---

Comment by jdemeyer created at 2018-06-04 12:50:29

Resolution: invalid


---

Comment by @timokau created at 2018-06-04 15:09:24

For reference: https://github.com/python/cpython/pull/6791

Thats great, thanks! Does that also include a 2.7 backport? It looks like the PR only targets master and backporting isn't mentioned.


---

Comment by @timokau created at 2018-06-06 11:14:00

Upstream only applied the patch to 3.6 so the motivation for this issue is still valid.


---

Comment by jdemeyer created at 2019-07-02 21:00:32

Resolution changed from invalid to 


---

Comment by jdemeyer created at 2019-07-02 21:00:32

Changing status from closed to new.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by slelievre created at 2020-09-16 18:15:13

Setting milestone to 9.1.1 assuming this ticket is only about Python 2.

If not please revert.


---

Comment by chapoton created at 2022-05-19 12:16:57

can this now be closed as invalid ?


---

Comment by chapoton created at 2022-05-19 12:16:57

Changing status from new to needs_review.


---

Comment by slelievre created at 2022-05-19 15:37:46

Resolution: wontfix


---

Comment by slelievre created at 2022-05-19 15:37:46

It can.
