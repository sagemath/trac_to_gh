# Issue 14014: height and canonical height for projective points and morphisms

Issue created by migration from Trac.

Original creator: bhutz

Original creation time: 2013-03-03 18:29:52

Assignee: bhutz

Keywords: height, canonical, projective, dynamics

This patch implements height functionality from the initial dynamics functionality problems proposed at the 2012 ICERM semester in Complex and Arithmetic dynamics.

Builds on Trac #13130 and Trac #14217

Implements height functionality:

 * height of points
 * height of morphisms
 * local green's functions
 * canonical heights


---

Attachment


---

Comment by bhutz created at 2013-03-18 12:31:02

Changing status from new to needs_review.


---

Comment by chapoton created at 2013-05-07 20:06:00

apply trac_14218_heights.patch


---

Comment by bhutz created at 2013-05-16 11:58:11

apply trac_14218_heights.patch


---

Attachment

new patch, changed the import of copy


---

Comment by bhutz created at 2013-09-04 16:36:05

apply trac_14218_heights.patch trac_14218_remove_imports.patch


---

Comment by jdefaria created at 2013-10-02 16:45:53

Changing status from needs_review to needs_work.


---

Comment by jdefaria created at 2013-10-02 16:45:53

Confirmed that the functions were returning the correct values. Also tested the functions would not accept undefined variables, here are the list of known issues found

projective_point.py:
- green_function: kwd "precision"in should be "prec"
- green_function: Joe's name is spelled wrong
- global_height: lacking both a number field and precision example
- global_height: description still says ZZ or QQ only
- canonical_height: lacking a precision example


---

Comment by bhutz created at 2013-10-03 12:55:49

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2013-10-03 12:55:49

Fixed all the issues described above. The only change of note was that fixing the 'precision' keyword required more than just a rename. The use of the precision needed to be included throughout the green's function computation.

Since that patchbot seems to be trying to apply the patches from the *closed* dependencies #13130 and #14217, I've removed those from the dependency field. Hopefully that will allow the patchbot to test this patch.


---

Comment by bhutz created at 2013-10-03 12:56:59

apply trac_14218_heights.patch trac_14218_remove_imports.patch


---

Comment by atowsley created at 2013-10-03 18:15:04

Changing status from needs_review to needs_work.


---

Comment by atowsley created at 2013-10-03 18:15:04

When computing the height of the constant 0 in a function field global_height gives and error. Every other constant seems fine.

R.<x> = PolynomialRing(QQ)

A.<x> = AffineSpace(QQ,1)

H=Hom(A,A)

f=H([0])

f.global_height()


returns 


Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_100.py", line 10, in <module>
    exec compile(u'open("___code___.py","w").write("# -*- coding: utf-8 -*-\\n" + _support_.preparse_worksheet_cell(base64.b64decode("Ui48eD4gPSBQb2x5bm9taWFsUmluZyhRUSkKQS48eD4gPSBBZmZpbmVTcGFjZShRUSwxKQpIPUhvbShBLEEpCmY9SChbMF0pCmYuZ2xvYmFsX2hlaWdodCgp"),globals())+"\\n"); execfile(os.path.abspath("___code___.py"))
  File "", line 1, in <module>
    
  File "/tmp/tmpYiF_cn/___code___.py", line 7, in <module>
    exec compile(u'f.global_height()
  File "", line 1, in <module>
    
  File "/home/atowsley/sage-5.12.rc0/local/lib/python2.7/site-packages/sage/schemes/affine/affine_morphism.py", line 542, in global_height
    h=max([c.global_height(prec) for c in C])
ValueError: max() arg is an empty sequence


---

Comment by bhutz created at 2013-10-03 19:20:01

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2013-10-03 19:20:01

Yes, missed that case. Actually, in any dimension if any one of the coordinate functions is 0 it has the same issue. The new patches catches those.


apply trac_14218_heights.patch trac_14218_remove_imports.patch


---

Comment by atowsley created at 2013-10-06 19:11:24

Changing status from needs_review to positive_review.


---

Comment by atowsley created at 2013-10-06 19:11:24

I found no more issues. It passed the long test.


---

Comment by jdemeyer created at 2013-10-12 09:45:25

Resolution: fixed


---

Comment by jdemeyer created at 2013-10-19 09:18:43

Changing status from closed to new.


---

Comment by jdemeyer created at 2013-10-19 09:18:43

Sorry, but this needs work:

there are numerical precision issues on Solaris with `green_function`:

```
**********************************************************************
File "devel/sage/sage/schemes/projective/projective_morphism.py", line 1236, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.green_function
Failed example:
    f.green_function(P.point([5,2],False),0,N=30)
Expected:
    1.7315451844777406965714211646
Got:
    1.7315451844777406965172110560
**********************************************************************
File "devel/sage/sage/schemes/projective/projective_morphism.py", line 1238, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.green_function
Failed example:
    f.green_function(P.point([2,1],False),0,N=30)
Expected:
    0.86577259223181085968927265240
Got:
    0.86577259223181085966216759809
**********************************************************************
File "devel/sage/sage/schemes/projective/projective_morphism.py", line 1240, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.green_function
Failed example:
    f.green_function(P.point([1,1],False),0,N=30)
Expected:
    0.43288629610862337434550672337
Got:
    0.43288629610862337433195419621
**********************************************************************
File "devel/sage/sage/schemes/projective/projective_point.py", line 727, in sage.schemes.projective.projective_point.SchemeMorphism_point_projective_ring.green_function
Failed example:
    Q.green_function(f,0,N=200,prec=200)
Expected:
    1.6460930160038721221892751679783564477424287857689424150860
Got:
    1.6460930160038721221892751679783564477424287857689424150656
**********************************************************************
```


This actually shows a bigger problem: it shows that some computations depend on machine floats and therefore are done only to 53 bits precision. In the code I see:

```
RealField(prec)(log(m))
```

this should be

```
RealField(prec)(m).log()
```

(the best solution to avoid this is simply removing `from math import log`)

Also, I recommend you to write _once_

```
R = RealField(prec)
```

and then use `R(a)` every where.

Also, comparisons to `None` should be done with `is`: `a is None` or `a is not None`.


---

Comment by jdemeyer created at 2013-10-19 09:18:43

Resolution changed from fixed to 


---

Comment by bhutz created at 2013-10-20 12:59:53

apply trac_14218_heights.patch trac_14218_remove_imports.patch 

Removed the `math.log` function and replaced with `R.log()` everywhere it occurred. That should fix the precision issue.

Fixed comparisons to None everywhere they occurred.

Also, added another input check to the `error_bound` kwd.


---

Comment by bhutz created at 2013-10-20 13:00:15

Changing status from new to needs_review.


---

Attachment


---

Comment by chapoton created at 2013-10-20 17:38:36

Hello,

I have added a patch which mainly cleans the doc a little bit.

for the patchbot:

apply trac_14218_heights.patch trac_14218_remove_imports.patch trac_14218_addon1.patch

By the way, did you know that you could run your own patchbot on your own tickets instead of waiting for the bot of someone else ?


---

Comment by jdemeyer created at 2013-10-21 12:05:32

I suggest removing the added

```
from math import log
```

(the addon patch removes only 1 out of 2)


---

Comment by bhutz created at 2013-10-21 12:24:29

Yes, thanks, I'll upload a new version that gets the missed one in affine_point.py as soon as my tests are done.


---

Attachment

removed the log import from affine_point.py


---

Comment by bhutz created at 2013-10-21 17:34:05

apply trac_14218_heights.patch trac_14218_remove_imports.patch trac_14218_addon1.patch 

all I have to say is that I can't wait to switch to git instead of dealing with a stack of patches like this...


---

Comment by jdemeyer created at 2013-10-22 06:36:44

Replying to [comment:24 bhutz]:
> all I have to say is that I can't wait to switch to git instead of dealing with a stack of patches like this...

It is perfectly fine to fold all patches into one patch.


---

Comment by atowsley created at 2013-10-24 18:02:12

Changing status from needs_review to positive_review.


---

Comment by atowsley created at 2013-10-24 18:02:12

Green's function works and is accurate on my computer.


---

Comment by jdemeyer created at 2013-10-31 19:16:24

Resolution: fixed
