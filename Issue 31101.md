# Issue 31101: sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf

Issue created by migration from https://trac.sagemath.org/ticket/31338

Original creator: mkoeppe

Original creation time: 2021-02-04 05:47:50

CC:  jhpalmieri fbissey mjo arojas dimpase

(from #31335)

To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over leaks described in #31335, we may want to essentially revert #29697, adding some refinements:
 - `SAGE_LOCAL` vs `SAGE_VENV`
 - make sure that if `$SAGE_LOCAL` is unset, nothing is added.

Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)


---

Comment by mkoeppe created at 2021-04-06 02:03:34

New commits:


---

Comment by mkoeppe created at 2021-04-06 02:03:34

Changing status from new to needs_review.


---

Comment by git created at 2021-05-11 02:59:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-05-12 13:35:57

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-05-12 13:35:57

lgtm


---

Comment by mkoeppe created at 2021-05-12 14:55:02

Thank you!


---

Comment by git created at 2021-05-27 00:51:49

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-05-27 00:51:49

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2021-06-02 12:04:28

ran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).


---

Comment by mkoeppe created at 2021-06-02 16:34:02

I think this is actually coming from #31280


---

Comment by dimpase created at 2021-06-02 21:20:10

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-06-02 21:20:10

OK, fine, this works otherwise, will look at #31280 again.


---

Comment by mkoeppe created at 2021-06-03 00:10:55

Thanks!


---

Comment by vbraun created at 2021-06-20 08:14:27

Resolution: fixed


---

Comment by fbissey created at 2021-06-22 23:41:44

A bit late to that party. `sage_setup/setenv.py` is highly "polluting" - i.e. it all works but fill my build logs with useless junk

```
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc
```


I am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have 

```
SAGE_LOCAL = var("SAGE_LOCAL", SAGE_VENV)
```

So either something from the environment or `SAGE_VENV` and it is defined by

```
SAGE_VENV = var("SAGE_VENV", os.path.abspath(sys.prefix))
```

So if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.

I am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.

Is there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?


---

Comment by mkoeppe created at 2021-06-23 00:17:40

The idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.

That it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.


---

Comment by fbissey created at 2021-06-23 00:21:52

I am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036


---

Comment by mkoeppe created at 2021-06-24 21:42:57

Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?


---

Comment by fbissey created at 2021-06-24 21:54:06

Replying to [comment:16 mkoeppe]:
> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?

Because you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.

It is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.


---

Comment by mkoeppe created at 2021-06-24 21:59:56

OK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?


---

Comment by fbissey created at 2021-06-24 22:02:59

It is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.


---

Comment by fbissey created at 2021-06-24 22:09:39

Hum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.


---

Comment by fbissey created at 2021-06-24 22:14:54

This is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.


---

Comment by mkoeppe created at 2021-06-24 22:28:27

Another possible solution: #32057
