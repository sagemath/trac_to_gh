# Issue 15720: Let easily switch between GMP and MPIR

archive/issues_015720.json:
```json
{
    "body": "CC:  @kiwifb\n\nFollow up to #12661.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15957\n\n",
    "created_at": "2014-03-17T09:55:37Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Let easily switch between GMP and MPIR",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15720",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
CC:  @kiwifb

Follow up to #12661.

Issue created by migration from https://trac.sagemath.org/ticket/15957





---

archive/issue_comments_203232.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-03-17T16:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203232",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_203233.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-03-17T16:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203233",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

New commits:



---

archive/issue_events_046931.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15720#event-46931"
}
```



---

archive/issue_comments_203234.json:
```json
{
    "body": "* I get a few failures when running the tests after building sage with SAGE_MP_LIBRARY=GMP:\n\n```\nsage -t src/sage/rings/integer.pyx\n**********************************************************************\nFile \"src/sage/rings/integer.pyx\", line 1959, in sage.rings.integer.Integer.__pow__\nFailed example:\n    2^(2^63-2)\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate 1152921504606847008 bytes  \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.rings.integer.Integer.__pow__[27]>\", line 1, in <module>\n        Integer(2)**(Integer(2)**Integer(63)-Integer(2))\n      File \"integer.pyx\", line 1998, in sage.rings.integer.Integer.__pow__ (sage/rings/integer.c:14703)\n      File \"c_lib.pyx\", line 85, in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:1040)\n    RuntimeError: Aborted\n**********************************************************************\nFile \"src/sage/rings/integer.pyx\", line 5431, in sage.rings.integer.Integer._xgcd\nFailed example:\n    2._xgcd(-2)\nExpected:\n    (2, 1, 0)\nGot:\n    (2, 0, -1)\n**********************************************************************\n```\n* The new environment variable should probably be documented in `src/doc/en/installation/source.rst`. (Well, in the long run, a `configure` flag would IMO be much more appropriate than an environment variable.)\n* The GMP tarball apparently still needs to be mirrored (see #12661).",
    "created_at": "2014-05-24T14:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203234",
    "user": "https://github.com/mezzarobba"
}
```

* I get a few failures when running the tests after building sage with SAGE_MP_LIBRARY=GMP:

```
sage -t src/sage/rings/integer.pyx
**********************************************************************
File "src/sage/rings/integer.pyx", line 1959, in sage.rings.integer.Integer.__pow__
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes  
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.rings.integer.Integer.__pow__[27]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "integer.pyx", line 1998, in sage.rings.integer.Integer.__pow__ (sage/rings/integer.c:14703)
      File "c_lib.pyx", line 85, in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:1040)
    RuntimeError: Aborted
**********************************************************************
File "src/sage/rings/integer.pyx", line 5431, in sage.rings.integer.Integer._xgcd
Failed example:
    2._xgcd(-2)
Expected:
    (2, 1, 0)
Got:
    (2, 0, -1)
**********************************************************************
```
* The new environment variable should probably be documented in `src/doc/en/installation/source.rst`. (Well, in the long run, a `configure` flag would IMO be much more appropriate than an environment variable.)
* The GMP tarball apparently still needs to be mirrored (see #12661).



---

archive/issue_comments_203235.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-24T14:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203235",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_203236.json:
```json
{
    "body": "You forgot one. But those are known from #12661. I am not sure we can fix minor differences in behavior. We can choose different tests in some case but the expected failure will be hard to replace.",
    "created_at": "2014-05-24T19:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203236",
    "user": "https://github.com/kiwifb"
}
```

You forgot one. But those are known from #12661. I am not sure we can fix minor differences in behavior. We can choose different tests in some case but the expected failure will be hard to replace.



---

archive/issue_comments_203237.json:
```json
{
    "body": "Replying to [comment:5 fbissey]:\n> You forgot one. But those are known from #12661.\n\n\nYou are completely right, thanks!\n\n> I am not sure we can fix minor differences in behavior.\n\n\nOk, I still don't like keeping around doctests that are know to fail, but I don't want to let the issue block this ticket.\n\n> We can choose different tests in some case but the expected failure will be hard to replace.\n\n\nWhat about something like\n\n```\nsage: try: 2^(2^63-2)\n....: except MemoryError, RuntimeError: true\n```\n?\n\nAnd does anyone understand if the output of the failing test in `sage/tests/book_stein_modform.py` is correct?",
    "created_at": "2014-05-26T09:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203237",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:5 fbissey]:
> You forgot one. But those are known from #12661.


You are completely right, thanks!

> I am not sure we can fix minor differences in behavior.


Ok, I still don't like keeping around doctests that are know to fail, but I don't want to let the issue block this ticket.

> We can choose different tests in some case but the expected failure will be hard to replace.


What about something like

```
sage: try: 2^(2^63-2)
....: except MemoryError, RuntimeError: true
```
?

And does anyone understand if the output of the failing test in `sage/tests/book_stein_modform.py` is correct?



---

archive/issue_comments_203238.json:
```json
{
    "body": "Replying to [comment:6 mmezzarobba]:\n> And does anyone understand if the output of the failing test in `sage/tests/book_stein_modform.py` is correct?\n\nI don't, but from the look of it, it seems plausible it is still correct :)",
    "created_at": "2014-05-26T09:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203238",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:6 mmezzarobba]:
> And does anyone understand if the output of the failing test in `sage/tests/book_stein_modform.py` is correct?

I don't, but from the look of it, it seems plausible it is still correct :)



---

archive/issue_comments_203239.json:
```json
{
    "body": "Also note GMP 6.0.0 is out.",
    "created_at": "2014-05-26T09:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203239",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Also note GMP 6.0.0 is out.



---

archive/issue_events_046932.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15720#event-46932"
}
```



---

archive/issue_events_046933.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15720#event-46933"
}
```



---

archive/issue_comments_203240.json:
```json
{
    "body": "I guess the doctests issues (except for the memory one) are gone now that MPIR behaves just like GMP, see #15015.\n\nIf I rebase the ticket, would anyone be kind enough to review it?\nMaybe I'll just simplify the ticket discarding the black magic to be able to change the MP lib you use.\nThen you just choose which one you use the first time you build Sage and live with it.\nJust like with SAGE_DEBUG.",
    "created_at": "2015-01-13T12:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203240",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I guess the doctests issues (except for the memory one) are gone now that MPIR behaves just like GMP, see #15015.

If I rebase the ticket, would anyone be kind enough to review it?
Maybe I'll just simplify the ticket discarding the black magic to be able to change the MP lib you use.
Then you just choose which one you use the first time you build Sage and live with it.
Just like with SAGE_DEBUG.



---

archive/issue_comments_203241.json:
```json
{
    "body": "Indeed I only have the memory issue left in sage-on-gentoo. I'll review anything you put here.",
    "created_at": "2015-01-13T19:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203241",
    "user": "https://github.com/kiwifb"
}
```

Indeed I only have the memory issue left in sage-on-gentoo. I'll review anything you put here.



---

archive/issue_comments_203242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-14T10:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203242",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_203243.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-14T12:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203243",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_203244.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-14T12:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203244",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_203245.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-14T12:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203245",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_203246.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-14T18:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203246",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203247.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2015-01-14T18:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203247",
    "user": "https://github.com/kiwifb"
}
```

Looks good to me.



---

archive/issue_comments_203248.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-01-14T18:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203248",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_203249.json:
```json
{
    "body": "I don't think the lines\n\n```\n###############################################################################\n# Determine whether we should automatically rebuild dependencies.\n###############################################################################\n\nif [ \"$SAGE_UPGRADING\" = yes ]; then\n # We're doing an upgrade. Let build/Makefile call sage-spkg with\n # \"-f\" to force rebuilding dependent packages, too:\n export SAGE_SPKG_OPTS=\"-f\"\nfi\n```\nshould be there: I think they are a remnant from an older version of Sage. The environment variable `SAGE_UPGRADING` was also removed. See #17072.",
    "created_at": "2015-01-14T18:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203249",
    "user": "https://github.com/jhpalmieri"
}
```

I don't think the lines

```
###############################################################################
# Determine whether we should automatically rebuild dependencies.
###############################################################################

if [ "$SAGE_UPGRADING" = yes ]; then
 # We're doing an upgrade. Let build/Makefile call sage-spkg with
 # "-f" to force rebuilding dependent packages, too:
 export SAGE_SPKG_OPTS="-f"
fi
```
should be there: I think they are a remnant from an older version of Sage. The environment variable `SAGE_UPGRADING` was also removed. See #17072.



---

archive/issue_comments_203250.json:
```json
{
    "body": "Oops, I'll quickly fix that.",
    "created_at": "2015-01-14T18:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203250",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Oops, I'll quickly fix that.



---

archive/issue_comments_203251.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-14T18:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203251",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_203252.json:
```json
{
    "body": "Looks better now.",
    "created_at": "2015-01-14T18:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203252",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Looks better now.



---

archive/issue_comments_203253.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-14T18:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203253",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_203254.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-14T19:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203254",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203255.json:
```json
{
    "body": "Okay, thanks.",
    "created_at": "2015-01-14T19:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203255",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, thanks.



---

archive/issue_comments_203256.json:
```json
{
    "body": "Replying to [comment:17 jhpalmieri]:\n> I don't think the lines\n> \n> ```\n> ###############################################################################\n> # Determine whether we should automatically rebuild dependencies.\n> ###############################################################################\n> \n> if [ \"$SAGE_UPGRADING\" = yes ]; then\n>  # We're doing an upgrade. Let build/Makefile call sage-spkg with\n>  # \"-f\" to force rebuilding dependent packages, too:\n>  export SAGE_SPKG_OPTS=\"-f\"\n> fi\n> ```\n> should be there: I think they are a remnant from an older version of Sage. The environment variable `SAGE_UPGRADING` was also removed. See #17072.\n\n\nIt does look like a left over, yes.",
    "created_at": "2015-01-14T19:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203256",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:17 jhpalmieri]:
> I don't think the lines
> 
> ```
> ###############################################################################
> # Determine whether we should automatically rebuild dependencies.
> ###############################################################################
> 
> if [ "$SAGE_UPGRADING" = yes ]; then
>  # We're doing an upgrade. Let build/Makefile call sage-spkg with
>  # "-f" to force rebuilding dependent packages, too:
>  export SAGE_SPKG_OPTS="-f"
> fi
> ```
> should be there: I think they are a remnant from an older version of Sage. The environment variable `SAGE_UPGRADING` was also removed. See #17072.


It does look like a left over, yes.



---

archive/issue_comments_203257.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-15T08:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15720#issuecomment-203257",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_046934.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-01-15T08:41:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15720",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15720#event-46934"
}
```
