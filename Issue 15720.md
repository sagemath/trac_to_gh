# Issue 15720: Let easily switch between GMP and MPIR

Issue created by migration from https://trac.sagemath.org/ticket/15957

Original creator: jpflori

Original creation time: 2014-03-17 09:55:37

CC:  fbissey

Follow up to #12661.


---

Comment by jpflori created at 2014-03-17 16:00:22

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-03-17 16:00:22

New commits:


---

Comment by mmezzarobba created at 2014-05-24 14:30:42

* I get a few failures when running the tests after building sage with SAGE_MP_LIBRARY=GMP:

```
sage -t src/sage/rings/integer.pyx
**********************************************************************
File "src/sage/rings/integer.pyx", line 1959, in sage.rings.integer.Integer.__pow__
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes  
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.rings.integer.Integer.__pow__[27]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "integer.pyx", line 1998, in sage.rings.integer.Integer.__pow__ (sage/rings/integer.c:14703)
      File "c_lib.pyx", line 85, in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:1040)
    RuntimeError: Aborted
**********************************************************************
File "src/sage/rings/integer.pyx", line 5431, in sage.rings.integer.Integer._xgcd
Failed example:
    2._xgcd(-2)
Expected:
    (2, 1, 0)
Got:
    (2, 0, -1)
**********************************************************************
```

* The new environment variable should probably be documented in `src/doc/en/installation/source.rst`. (Well, in the long run, a `configure` flag would IMO be much more appropriate than an environment variable.)
* The GMP tarball apparently still needs to be mirrored (see #12661).


---

Comment by mmezzarobba created at 2014-05-24 14:31:05

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2014-05-24 19:29:33

You forgot one. But those are known from #12661. I am not sure we can fix minor differences in behavior. We can choose different tests in some case but the expected failure will be hard to replace.


---

Comment by mmezzarobba created at 2014-05-26 09:37:13

Replying to [comment:5 fbissey]:
> You forgot one. But those are known from #12661.

You are completely right, thanks!

> I am not sure we can fix minor differences in behavior.

Ok, I still don't like keeping around doctests that are know to fail, but I don't want to let the issue block this ticket.

> We can choose different tests in some case but the expected failure will be hard to replace.

What about something like

```
sage: try: 2^(2^63-2)
....: except MemoryError, RuntimeError: true
```

?

And does anyone understand if the output of the failing test in `sage/tests/book_stein_modform.py` is correct?


---

Comment by jpflori created at 2014-05-26 09:42:26

Replying to [comment:6 mmezzarobba]:
> And does anyone understand if the output of the failing test in `sage/tests/book_stein_modform.py` is correct?
I don't, but from the look of it, it seems plausible it is still correct :)


---

Comment by jpflori created at 2014-05-26 09:43:02

Also note GMP 6.0.0 is out.


---

Comment by jpflori created at 2015-01-13 12:34:31

I guess the doctests issues (except for the memory one) are gone now that MPIR behaves just like GMP, see #15015.

If I rebase the ticket, would anyone be kind enough to review it?
Maybe I'll just simplify the ticket discarding the black magic to be able to change the MP lib you use.
Then you just choose which one you use the first time you build Sage and live with it.
Just like with SAGE_DEBUG.


---

Comment by fbissey created at 2015-01-13 19:25:55

Indeed I only have the memory issue left in sage-on-gentoo. I'll review anything you put here.


---

Comment by git created at 2015-01-14 10:43:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-14 12:29:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-01-14 12:30:07

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-01-14 12:38:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-01-14 18:06:34

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-01-14 18:06:34

Looks good to me.


---

Comment by jhpalmieri created at 2015-01-14 18:20:48

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2015-01-14 18:20:48

I don't think the lines

```
###############################################################################
# Determine whether we should automatically rebuild dependencies.
###############################################################################

if [ "$SAGE_UPGRADING" = yes ]; then
 # We're doing an upgrade. Let build/Makefile call sage-spkg with
 # "-f" to force rebuilding dependent packages, too:
 export SAGE_SPKG_OPTS="-f"
fi
```

should be there: I think they are a remnant from an older version of Sage. The environment variable `SAGE_UPGRADING` was also removed. See #17072.


---

Comment by jpflori created at 2015-01-14 18:24:17

Oops, I'll quickly fix that.


---

Comment by git created at 2015-01-14 18:26:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-01-14 18:27:10

Looks better now.


---

Comment by jpflori created at 2015-01-14 18:28:30

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2015-01-14 19:16:05

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2015-01-14 19:16:05

Okay, thanks.


---

Comment by fbissey created at 2015-01-14 19:23:31

Replying to [comment:17 jhpalmieri]:
> I don't think the lines
> {{{
> ###############################################################################
> # Determine whether we should automatically rebuild dependencies.
> ###############################################################################
> 
> if [ "$SAGE_UPGRADING" = yes ]; then
>  # We're doing an upgrade. Let build/Makefile call sage-spkg with
>  # "-f" to force rebuilding dependent packages, too:
>  export SAGE_SPKG_OPTS="-f"
> fi
> }}}
> should be there: I think they are a remnant from an older version of Sage. The environment variable `SAGE_UPGRADING` was also removed. See #17072.

It does look like a left over, yes.


---

Comment by vbraun created at 2015-01-15 08:41:45

Resolution: fixed
