# Issue 13535: more informative error message from multiplication of symbolic expressions

Issue created by migration from https://trac.sagemath.org/ticket/13739

Original creator: burcin

Original creation time: 2012-11-21 17:17:05

Assignee: burcin

The error returned by multiplication of symbolic expressions is hard coded to `ArithmeticError` in the Cython wrappers (`sage/libs/ginac.pxd`). Since the time that was written, Cython got far better at handling errors, so this is not necessary. Removing this directive actually allows us to return more informative error messages. For example:


```
sage: t = GF(5)(3)
sage: u = GF(7)(4)
sage: var('y')
y
sage: e = t*x + u*y
sage: t*e
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for '*': 'Finite Field of size 7' and 'Finite Field of size 5'
```



---

Comment by burcin created at 2012-11-21 17:21:44

Changing status from new to needs_review.


---

Comment by mjo created at 2012-12-02 01:38:09

I had to rebase the last hunk to apply on 5.5.rc0, but it looks like it works.

I also noticed that a similar issue (fixed by this patch) was reported as #10960, so I added the test case from that ticket.


---

Comment by mjo created at 2012-12-02 01:43:12

...and I just noticed there's a dependency, crap. Aside from the context lines, this is independent of #13609, so might it make sense to get this reviewed and then refresh that patch instead?


---

Comment by nbruin created at 2012-12-02 02:47:00

Because try/except is a regularly used programming paradigm in python, the expection object generation should be fast. It used to be the case that a lot of things in the coercion framework were simply tried before trying more complicated things. So, making a more informative but slower to produce error message can really slow down operations. Have you checked whether this is the case?

I guess the idea was that after a raised expection, one can examine the traceback with pdb and query the frames for what values led to the error. That won't work so well in cython code of course ...


---

Comment by kcrisman created at 2012-12-02 02:55:27

In this case the change seems so minimal that I don't see how it can really slow things down. We aren't actually adding any extra checks... this change would only affect the case where an exception was already raised, right?  This may be a dumb question, but hopefully not.  Good catch on #10960, mjo.


---

Comment by kcrisman created at 2012-12-02 02:56:40

> ...and I just noticed there's a dependency, crap. Aside from the context lines, this is independent of #13609, so might it make sense to get this reviewed and then refresh that patch instead?
I concur, because there is a lot of stuff with that and it also has dependencies, which might take a while.


---

Comment by mjo created at 2012-12-02 04:12:19

The test suite passes with just my patch applied, so it is really independent of those other tickets.

Nils' question is unfortunately above my pay grade.


---

Comment by nbruin created at 2012-12-02 08:42:45

Replying to [comment:5 kcrisman]:
>  this change would only affect the case where an exception was already raised, right?
Yes, looking at the code I think you're right. The exception object already exists by the time this code comes into play. It's hard to imagine how this code could cause a slowdown.


---

Comment by kcrisman created at 2012-12-03 16:06:47

Great!

Any extra review needed, then?  Michael, do you consider your patch to more or less be a rebase with an extra test?  (Assuming you rebased it away from dependency on #13609).

If so, looks like positive review; if you'd like to add yourself as an author, then presumably someone else (including Burcin) would have to do the final once-over.


---

Comment by mjo created at 2012-12-04 01:35:47

Yes, all I did was change the context to get his patch to apply. I assumed Burcin was working from either an old version, or on top of some local patchset. To a smart person, that would have hinted that there might be dependencies. To me, it just meant that I should rebase it on top of a fresh 5.5.rc0.

I did run the full test suite afterwards, and except for the one known failure in 5.5.rc0, it passed. I don't care about the author credit.


---

Comment by mjo created at 2012-12-04 01:37:10

Oh, and to avoid the appearance of impropriety: I also added a line break in his original TypeError output.


---

Comment by burcin created at 2012-12-04 08:33:49

Thanks for rebasing the patch. I was indeed working with the patches required for the pynac update applied to the Sage library as you can see from the dependency. It turns out that the pynac update will not be able to go in as quick as I thought.

Replying to [comment:10 mjo]:
 
> I don't care about the author credit.

Your patch replaces the author line on the patch. I don't think this is appropriate. If we were using mercurial properly, we wouldn't run into such problems. But while we have to struggle with patches exported from queues, you should take care to keep the author credit on the patches.


---

Comment by mjo created at 2012-12-04 14:51:53

Replying to [comment:12 burcin]:
> 
> Replying to [comment:10 mjo]:
>  
> > I don't care about the author credit.
> 
> Your patch replaces the author line on the patch. I don't think this is appropriate. If we were using mercurial properly, we wouldn't run into such problems. But while we have to struggle with patches exported from queues, you should take care to keep the author credit on the patches.
> 

What should I do here? Yours also had a more-informative commit message. To rebase it, I started a new patch on a fresh queue so that I could apply yours with fuzz (hg qimport won't let me do that).

Now when I export it, it has my info/commit message.

Should I just mangle the patch header myself?


---

Comment by kcrisman created at 2012-12-04 15:15:48

> Now when I export it, it has my info/commit message.
> Should I just mangle the patch header myself?

Yeah, why not?  If the patch won't import properly, that is probably the best quick solution.  Actually, you can use `hg qrefresh -e` to edit the commit message.  It doesn't look like there is an easy way to change the author, so you can do that by hand, just use the same info as in Burcin's patch.


---

Attachment

Rebase Burcin's patch and add a doctest from #10960


---

Comment by mjo created at 2012-12-04 15:30:02

Ok, patch is updated. I added a line to the original commit message mentioning the new doctest.


---

Comment by kcrisman created at 2012-12-04 15:47:05

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2012-12-04 15:47:37

Patchbot, apply sage-trac_13739-review.patch


---

Comment by jdemeyer created at 2012-12-27 10:23:57

Resolution: fixed
