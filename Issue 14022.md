# Issue 14022: add SAGE_INST environment variable

Issue created by migration from https://trac.sagemath.org/ticket/14226

Original creator: ohanar

Original creation time: 2013-03-05 07:34:06

Assignee: jason

There are a fair number of places that does stuff with the directory `SAGE_ROOT/spkg/installed`, so let's add an environment variable for this directory. This will help ease the transition to git.


---

Comment by ohanar created at 2013-03-05 07:54:07

Changing status from new to needs_review.


---

Comment by ohanar created at 2013-03-05 08:25:05

breaks stuff... working on a fix...


---

Comment by ohanar created at 2013-03-05 08:25:05

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2013-03-05 08:28:30

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2013-03-05 08:28:30

Ok, found the missing link, should be good now.


---

Comment by leif created at 2013-03-05 12:43:49

Hmmm, I guess its name is pretty likely to confuse new users...

Note that `$(INST)` in the Makefile now contains an _absolute_ path...  (Similar for some scripts; although that doesn't break anything yet.)


---

Comment by tkluck created at 2013-03-05 19:34:35

The patch looks fine as a quick solution.

In general though, I think that this directory shouldn't be needed from different places at all. There should be two functions (or shell scripts, or ./sage options) like set_installed(name, bool) and is_installed(name) that know about how installation status is tracked, and only they are allowed to know about this directory. Having INST in the environment will allow/encourage people to check installation status themselves, and I think that should be prevented.


---

Comment by ohanar created at 2013-03-10 03:24:43

Replying to [comment:7 tkluck]:
> In general though, I think that this directory shouldn't be needed from different places at all. There should be two functions (or shell scripts, or ./sage options) like set_installed(name, bool) and is_installed(name) that know about how installation status is tracked, and only they are allowed to know about this directory. Having INST in the environment will allow/encourage people to check installation status themselves, and I think that should be prevented.

Maybe, but at the same time it makes it a lot easier to find offending cases if we do move to a pair of functions like you propose, so at the very least this would be a step in the right direction.


---

Comment by robertwb created at 2013-03-10 08:14:29

Eventually we shouldn't be tracking this information ourselves at all (letting a package manager do it for us) so I'm fine with this "quick" solution.  Users shouldn't have to use it, so the name being obscure isn't a big deal (and it's easy to discover reading the code).


---

Comment by robertwb created at 2013-03-10 08:14:29

Changing status from needs_review to positive_review.


---

Comment by leif created at 2013-03-10 11:58:19

`$SAGE_INST` needs to be quoted on line 339 of `$SAGE_ROOT/spkg/install`.


---

Comment by leif created at 2013-03-10 12:02:12

Replying to [comment:10 leif]:
> `$SAGE_INST` needs to be quoted on line 339 of `$SAGE_ROOT/spkg/install`.

Same for `deps`, although I really don't like an _absolute_ path there.


---

Comment by leif created at 2013-03-10 12:05:29

And although this variable is (or should be) only used internally, we should document it (with a warning that it doesn't refer to the location of a Sage *inst*allation, nor should be set/modified by the user).

2ct


---

Comment by leif created at 2013-03-10 12:30:07

Changing status from positive_review to needs_work.


---

Comment by leif created at 2013-03-10 12:30:07

There are also instances in the Sage scripts repository (`$SAGE_ROOT/local/bin/`) which have to get fixed, e.g. in
`sage-update`:

```python
    installed = set(os.listdir(os.path.join(SPKG_ROOT, "installed")))
```


Same in `sage-list-packages`:

```python
try:
     installed = set(os.listdir(os.path.join(SPKG_ROOT, 'installed')))
except OSError:
     installed = set([])
```


There are presumably even more, but simple grepping yields false positives as well; I've found:

```
local/bin/sage-bdist:   cp $CP_OPT installed "$TMP/$PKGDIR/"

local/bin/sage-list-packages:     installed = set(os.listdir(os.path.join(SPKG_ROOT, 'installed')))

local/bin/sage-make_devel_packages:SPKG_INST="$SAGE_ROOT"/spkg/installed/

local/bin/sage-update:    installed = set(os.listdir(os.path.join(SPKG_ROOT, "installed")))
```


Looking at those, isn't `SPKG_INST` (or `SAGE_SPKG_INST`) a better name? ;-)


---

Comment by leif created at 2013-03-10 12:38:16

Changing keywords from "" to "installed spkgs directory".


---

Comment by ohanar created at 2013-03-12 22:25:54

So my only objection to `SPKG_INST` is that it follows the convention of `SPKG_ROOT` which has been replaced with `SAGE_PACKAGES`, so it seems like a slight regression.

On the other hand, `SPKG_INST` makes sense in the context of trying to move to a real package manager, and that this directory only records the installations of spkgs (as opposed to packages installed with other methods). From this perspective, I agree that `SPKG_INST` would be a better name (enough to outweigh my objection).

As for documentation, from what I can tell there is no documentation on any development related variables, so I've made a new ticket for the task. (#14262)


---

Comment by ohanar created at 2013-03-13 20:12:24

apply to scripts repository


---

Attachment

apply to sage library


---

Comment by ohanar created at 2013-03-13 20:15:10

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2013-03-17 09:30:39

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2013-03-17 09:30:39

Quoting the variable in deps brakes lots of stuff.


---

Comment by leif created at 2013-03-17 09:33:58

Replying to [comment:17 ohanar]:
> Quoting the variable in deps brakes lots of stuff.

Apply `sage-make_relative` to it?  XD


---

Comment by leif created at 2013-03-17 09:37:23

Seriously, if you really want an absolute path there, create a symbolic link from `$(INST)` to `$SAGE_INST` before running `make`?

Btw., what did it break?


---

Comment by leif created at 2013-03-17 09:41:58

Replying to [comment:19 leif]:
> Seriously, if you really want an absolute path there, create a symbolic link from `$(INST)` to `$SAGE_INST` before running `make`?

(Where `$(INST)` is still relative, but its target is absolute.)


---

Comment by ohanar created at 2013-03-17 09:47:40

I don't mind if it is relative, but I don't want to be fixed to the location `spkg/installed`. The problem with a relative path is that then there are issues if using `$SAGE_SPKG_INST` from some other directory (which can and does happen) and `sage-make_relative` isn't available upon the first usage of `deps`. Making a symbolic link would work in the case that `$(INST) != $SAGE_SPKG_INST`.


---

Comment by leif created at 2013-03-17 10:03:12

Or, how does `make INST="${SAGE_SPKG_INST:-installed}"` behave?  (I think this would be better.)




Replying to [comment:21 ohanar]:
> I don't mind if it is relative, but I don't want to be fixed to the location `spkg/installed`.

I meant just in the `Makefile`.  (`$SAGE_SPKG_INST` could still be absolute.)

> The problem with a relative path is that then there are issues if using `$SAGE_SPKG_INST` from some other directory (which can and does happen)

See above.

> `sage-make_relative` isn't available upon the first usage of `deps`.

I was just kidding.

> Making a symbolic link would work in the case that `$(INST) != $SAGE_SPKG_INST`.

Well, just change `INST = installed` to something else (`INST = this_is_always_the_relative_path_to_a_symlink`), and let it point to either `installed` or `$SAGE_SPKG_INST` (where the latter is absolute).  Not sure about performance issues.


---

Comment by ohanar created at 2013-03-17 10:46:53

Replying to [comment:22 leif]:
> Or, how does `make INST="${SAGE_SPKG_INST:-installed}"` behave?  (I think this would be better.)

Yes, this resolves the issue -- which was that any entry of the form `$(MAKE) $(INST)/$(SPKG)` would error out complaining about a missing target.


---

Comment by ohanar created at 2013-03-17 10:46:53

Changing status from needs_work to needs_review.


---

Comment by leif created at 2013-03-17 10:50:01

Replying to [comment:22 leif]:
> Or, how does `make INST="${SAGE_SPKG_INST:-installed}"` behave?  (I think this would be better.)

After deep thinking...


```sh
make INST="`echo ${SAGE_SPKG_INST:-installed} | sed 's/ /\\\\ /g'`"
```

(without changes to `deps`).


I think this should solve all issues.


---

Comment by leif created at 2013-03-17 11:00:24

I'd keep the "default" value of `INST` in `deps`.

Also, I think there's more than one instance of `$MAKE` in `spkg/install`, not sure whether also elsewhere.


---

Comment by ohanar created at 2013-03-17 11:19:55

ok, made your suggested changes.

Testing locally I found no difference when introducing whitespace in the directory name of `SAGE_SPKG_INST`, but I have a very recent version of gmake installed on my system.


---

Comment by leif created at 2013-03-17 11:42:32

Replying to [comment:26 ohanar]:
> Testing locally I found no difference when introducing whitespace in the directory name of `SAGE_SPKG_INST`, but I have a very recent version of gmake installed on my system.

_Should<sup>TM</sup>_ also work with

```
GNU Make 3.81
Copyright (C) 2006  Free Software Foundation, Inc.
```



---

Comment by jdemeyer created at 2013-03-26 21:20:05

apply to root repository


---

Attachment

Rebased to #14263.


---

Attachment


---

Comment by jdemeyer created at 2013-03-28 20:39:46

Positive review given in person by R. Andrew Ohana.


---

Comment by jdemeyer created at 2013-03-28 20:39:46

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-03-29 01:17:41

Resolution: fixed
