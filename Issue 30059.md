# Issue 30059: System package information and spkg-configure for mathjax

Issue created by migration from https://trac.sagemath.org/ticket/30296

Original creator: mkoeppe

Original creation time: 2020-08-05 20:02:12

CC:  @jcamp0x2a paulmasson slelievre egourgoulhon mjo klee jhpalmieri nthiery enriqueartal fbissey arojas thansen etn40ff @tobiasdiez

We add an `spkg-configure.m4` script for the standard package `mathjax`, as well as corresponding system package information in `build/pkgs/mathjax/distros/`


---

Comment by mkoeppe created at 2020-08-05 20:07:47

There are numerous unresolved tickets regarding mathjax...

#30296 (System package information and spkg-configure for mathjax) – Sage
https://trac.sagemath.org/ticket/30296#modify

#30226 (Allow LaTeX in text3d) – Sage
https://trac.sagemath.org/ticket/30226

#30030 (Prevent JSmol from phoning home) – Sage
https://trac.sagemath.org/ticket/30030

#29993 (Enable MathJax in the TOC of Sage reference manual) – Sage
https://trac.sagemath.org/ticket/29993#comment:9

#28547 (Remove hardcoded mathjax path in docs/conf.py) – Sage
https://trac.sagemath.org/ticket/28547

#28257 (MathJax causing unusual hanging in large notebooks) – Sage
https://trac.sagemath.org/ticket/28257

#26612 (Remove bad mathjax symlink and bad mathjax directories) – Sage
https://trac.sagemath.org/ticket/26612

#25833 (Upgrade to MathJax 3) – Sage
https://trac.sagemath.org/ticket/25833

#24024 (Meta-ticket: Update other packages to using the sage-dist-helpers functions + DESTDIR where applicable) – Sage
https://trac.sagemath.org/ticket/24024

#24367 (Confusing documentation on MathJax in light of use in Jupyter notebook) – Sage
https://trac.sagemath.org/ticket/24367

#25015 (Improve introspection capabilities of Sage Jupyter Kernel) – Sage
https://trac.sagemath.org/ticket/25015

#25111 (In the built documentation, replace duplicate files by symlinks) – Sage
https://trac.sagemath.org/ticket/25111

#22394 (MathJax javascript loaded more than once) – Sage
https://trac.sagemath.org/ticket/22394

#18596 (Don't strip MathJax fonts) – Sage
https://trac.sagemath.org/ticket/18596


---

Comment by mkoeppe created at 2020-08-05 20:08:28

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-05 20:09:26

For availability of mathjax in distributions, see https://repology.org/project/mathjax/versions


---

Comment by mkoeppe created at 2020-08-05 20:28:43

The commit only indicates where the system directory should be inserted.

I don't plan to work on this ticket. 


Hoping that people knowledgeable about the Jupyter notebook and/or documentation building will be interesting in working on it.

----
New commits:


---

Comment by mkoeppe created at 2020-08-06 02:29:03

There is also a pip-installable package https://pypi.org/project/py-mathjax/, but I think using it has not benefits for us.


---

Comment by mkoeppe created at 2020-08-08 06:48:44

Also `notebook` bundles mathjax ... why do we install another copy?


---

Comment by mkoeppe created at 2020-08-08 06:49:11

Changing status from new to needs_info.


---

Comment by jhpalmieri created at 2020-08-08 22:51:32

Replying to [comment:8 mkoeppe]:
> Also `notebook` bundles mathjax ... why do we install another copy?

The change

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index ed5294cc4e..3d65767bf7 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -289,7 +289,7 @@ base: $(inst_patch) $(inst_pkgconf)
 # produce plots.
 DOC_DEPENDENCIES = sagelib $(inst_sphinx) \
        | $(SAGERUNTIME) $(inst_maxima) $(inst_networkx) $(inst_scipy) $(inst_sympy) \
-       $(inst_matplotlib) $(inst_pillow) $(inst_mathjax) $(inst_mpmath) \
+       $(inst_matplotlib) $(inst_pillow) $(inst_mpmath) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
diff --git a/build/pkgs/mathjax/type b/build/pkgs/mathjax/type
index a6a7b9cd72..134d9bc32d 100644
--- a/build/pkgs/mathjax/type
+++ b/build/pkgs/mathjax/type
@@ -1 +1 @@
-standard
+optional
```

avoids building mathjax, but then Sphinx doesn't find it when building the documentation. So if we want to use the version bundled with `notebook`, we need to make sure that Sphinx knows where to find it.


---

Comment by mkoeppe created at 2020-08-08 23:41:05

`src/sage/docs/conf.py` expects `sage.env.MATHJAX_DIR` to be set to the location. This is what we'd have to configure if we take mathjax either from a system installation, or some other source.


---

Comment by slelievre created at 2020-08-20 01:16:32

Changing keywords from "" to "spkg-configure, mathjax".


---

Comment by mkoeppe created at 2020-09-03 03:02:54

Changing priority from critical to major.


---

Comment by slelievre created at 2020-09-05 10:05:04

Replying to [comment:8 mkoeppe]:
> Also `notebook` bundles mathjax ... why do we install another copy?

See

- [Stack Overflow question 28909747: How do I configure mathjax for iPython notebooks?](https://stackoverflow.com/q/28909747)

and the various answers there, including

- [StackOverflow answer 58866858](https://stackoverflow.com/a/58866858)

which states

> Jupyter ships with its own (smaller) version of MathJax.
> This is why it is not able to find the (Computer Modern)
> 'TeX' font -- there only is the STIX font.

So it's possible that the smaller version of MathJax
shipped by Jupyter Notebook is not enough for our Sphinx use.

Configuring Jupyter Notebook to use Sage's fuller MathJax
might have benefits (ability to typeset more math?)
and/or drawbacks (performance?).


---

Comment by mkoeppe created at 2020-11-29 07:29:44

Replying to [comment:16 slelievre]:
> Configuring Jupyter Notebook to use Sage's fuller MathJax
> might have benefits (ability to typeset more math?)

This should be investigated.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "spkg-configure, mathjax" to "spkg-configure, mathjax, sd111".


---

Comment by arojas created at 2020-12-10 07:31:55

FWIW: On Arch we're unbundling mathjax from Jupyter and using the system one:

https://github.com/archlinux/svntogit-community/blob/packages/jupyter-notebook/trunk/PKGBUILD#L40

Everything works fine, even without the /usr/share/jupyter/nbextensions/mathjax symlink installed by sage.


---

Comment by mkoeppe created at 2020-12-10 18:24:06

Thanks. I have created #31035 (Remove mathjax configuration/symlink from jupyter notebook), as it seems what Sage is doing is simply not necessary any more after various updates of Jupyter.


---

Comment by mkoeppe created at 2020-12-10 19:42:05

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by slelievre created at 2021-03-22 01:57:22

Here is distro info to hopefully restart things here.
----
New commits:


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2022-03-30 16:31:35

See also #33600: Configure mathjax in sphinx config and upgrade to Mathjax v3


---

Comment by klee created at 2022-04-08 06:50:34

Still no `spkg-configure.m4`?

This script just needs to rewrite `sage.env.MATHJAX_DIR` to the system mathjax2 directory (`/usr/share/mathjax`?) if found in the system.

Perhaps it also needs to decide if it is really mathjax2 or mathjax3...

I am ready to duplicate it to #25833.


---

Comment by klee created at 2022-04-08 07:03:31

Replying to [comment:35 klee]:
> This script just needs to rewrite `sage.env.MATHJAX_DIR` to the system mathjax2 directory (`/usr/share/mathjax`?) if found in the system.

This may not be true since the system mathjax2 would have all fonts and be too large to use for sage documentation. Sphinx will copy the whole to each `_static` directory of every documentation (reference, tutorial, ...).

Then the conclusion would be that we should not try to use the system mathjax???


---

Comment by arojas created at 2022-04-08 07:15:24

Replying to [comment:36 klee]:
> This may not be true since the system mathjax2 would have all fonts and be too large to use for sage documentation. Sphinx will copy the whole to each `_static` directory of every documentation (reference, tutorial, ...).
> 
> Then the conclusion would be that we should not try to use the system mathjax??? 

On Arch (and Gentoo, which is where I got the idea from) distro packages we replace all `_static` copies with a symlink to the one in `html/en/_static` post-installation. Perhaps that sould be done on install by default?


---

Comment by klee created at 2022-04-08 07:28:16

Replying to [comment:37 arojas]:
> On Arch (and Gentoo, which is where I got the idea from) distro packages we replace all `_static` copies with a symlink to the one in `html/en/_static` post-installation. Perhaps that should be done on install by default?

I guess that could be done for sage, independent of this ticket. Then it would reduce the number of times to copy `$SAGE_SHARE/mathjax` to `_static/`.

Nonetheless, `spkg-configure.m4` needs to copy the reduced set of files from the system mathjax to `$SAGE_SHARE/mathjax`.


---

Comment by arojas created at 2022-04-08 12:19:23

Replying to [comment:38 klee]:
> Replying to [comment:37 arojas]:
> > On Arch (and Gentoo, which is where I got the idea from) distro packages we replace all `_static` copies with a symlink to the one in `html/en/_static` post-installation. Perhaps that should be done on install by default?
> 
> I guess that could be done for sage, independent of this ticket. Then it would reduce the number of times to copy `$SAGE_SHARE/mathjax` to `_static/`.
> 
> Nonetheless, `spkg-configure.m4` needs to copy the reduced set of files from the system mathjax to `$SAGE_SHARE/mathjax`.

Well, my point is that once there is just one copy of `_static`, then maybe it's not *that* bad to just copy over the entire contents of the system mathjax dir.


---

Comment by klee created at 2022-04-08 12:53:39

Replying to [comment:39 arojas]:
> Well, my point is that once there is just one copy of `_static`, then maybe it's not *that* bad to just copy over the entire contents of the system mathjax dir.

It would not be just one copy, because you have `_static` directory for each of languages.


---

Comment by klee created at 2022-04-08 14:06:00

Replying to [comment:39 arojas]:
> Well, my point is that once there is just one copy of `_static`, then maybe it's not *that* bad to just copy over the entire contents of the system mathjax dir.

One copy to `html/_static` might suffice. 

Other question: the location of the system mathjax is `/usr/share/mathjax` on all linux platforms? Or does it vary?


---

Comment by klee created at 2022-04-08 14:12:42

The mathjax3 tarball is around 5Mb. I think this is not so big. Then is it worth while to detect the system mathjax and copy it instead of downloading the tarball?


---

Comment by arojas created at 2022-04-08 14:28:13

Replying to [comment:41 klee]:
> Other question: the location of the system mathjax is `/usr/share/mathjax` on all linux platforms? Or does it vary?

mathjax doesn't provide an install script, so unfortunately there's no standard location and it's up to each distro to decide where to install it. On Arch we use `/usr/share/mathjax`, other distros may use `mathjax3` instead if they also ship v2. (But, according to https://repology.org/project/mathjax/versions, no other distro is shipping mathjax 3 yet)


---

Comment by klee created at 2022-04-08 15:11:30

Replying to [comment:43 arojas]:
> Replying to [comment:41 klee]:
> > Other question: the location of the system mathjax is `/usr/share/mathjax` on all linux platforms? Or does it vary?
> 
> mathjax doesn't provide an install script, so unfortunately there's no standard location and it's up to each distro to decide where to install it. 

mathjax is a javascript library, and perhaps unique in that among sage spkgs. I doubt if `spkg-configure.m4` script is relevant with mathjax. 

`@`matthias: would you comment?


---

Comment by mkoeppe created at 2022-04-08 16:05:12

Given that the spread of mathjax 3 in distributions is so low, I don't think that there is a need to support system packages providing it. If this changes in the future, `spkg-configure.m4` would be the correct mechanism though.


---

Comment by mjo created at 2022-04-10 20:56:59

Replying to [comment:44 klee]:
> 
> mathjax is a javascript library, and perhaps unique in that among sage spkgs. I doubt if `spkg-configure.m4` script is relevant with mathjax. 
> 

It is kind of an awkward fit, since there's no reliable way of detecting via `spkg-configure.m4` where the the html/js files might live. But we can at the very least check a list of known locations. The gp2c package does that for lack of a better strategy.


---

Comment by mkoeppe created at 2022-04-10 21:26:23

One would probably only want to search for the system library when also system `node` is installed, which would give discoverability.


---

Comment by klee created at 2022-04-11 00:51:19

Replying to [comment:46 mjo]:
> Replying to [comment:44 klee]:
> > 
> > mathjax is a javascript library, and perhaps unique in that among sage spkgs. I doubt if `spkg-configure.m4` script is relevant with mathjax. 
> > 
> 
> It is kind of an awkward fit, since there's no reliable way of detecting via `spkg-configure.m4` where the the html/js files might live. But we can at the very least check a list of known locations. The gp2c package does that for lack of a better strategy.

I agree. Still as this mathjax package is not big and does not take time to install, I doubt if it would ever be worth while to put necessary efforts for this package.

Hence I suggest closing this ticket as "won't fix".


---

Comment by mjo created at 2022-04-12 21:36:39

Replying to [comment:48 klee]:
>
> Hence I suggest closing this ticket as "won't fix". 
> 

Sage's mathjax has "never" worked for me. This is probably due to font stripping (https://trac.sagemath.org/ticket/18596#comment:4), but undoing that would make the package larger.

So I'd quite like the ability to use the unbroken copy my distro provides, regardless of any time/bandwidth savings. Ultimately I can write the spkg-configure if no one else does it. I'll probably wait until the mathjax-3.x upgrade is done though.


---

Comment by klee created at 2022-04-12 23:55:59

Replying to [comment:49 mjo]:
> Replying to [comment:48 klee]:
> >
> > Hence I suggest closing this ticket as "won't fix". 
> > 
> 
> Sage's mathjax has "never" worked for me. This is probably due to font stripping (https://trac.sagemath.org/ticket/18596#comment:4), but undoing that would make the package larger.
> 
> So I'd quite like the ability to use the unbroken copy my distro provides, regardless of any time/bandwidth savings. Ultimately I can write the spkg-configure if no one else does it. I'll probably wait until the mathjax-3.x upgrade is done though.

Okay. Thanks. Does mathjax3 (#25833) work for you?


---

Comment by mjo created at 2022-04-13 20:11:37

Replying to [comment:50 klee]:
> 
> Okay. Thanks. Does mathjax3 (#25833) work for you? 

Yes, thanks, replied there.


---

Comment by klee created at 2022-11-24 05:14:55

Replying to [comment:49 Michael Orlitzky]:
> Ultimately I can write the spkg-configure if no one else does it. I'll probably wait until the mathjax-3.x upgrade is done though.

Now that mathjax3 is well in place, would you do the work? 

From Matthias: `src/sage/docs/conf.py` expects sage.env.MATHJAX_DIR to be set to the location. This is what we'd have to configure if we take mathjax either from a system installation, or some other source.


---

Comment by mjo created at 2022-11-24 10:49:57

Replying to [comment:53 Kwankyu Lee]:
> Replying to [comment:49 Michael Orlitzky]:
> > Ultimately I can write the spkg-configure if no one else does it. I'll probably wait until the mathjax-3.x upgrade is done though.
> 
> Now that mathjax3 is well in place, would you do the work?

Now I'm waiting for my distro package to be upgraded (https://bugs.gentoo.org/837722), but yes, I'll get to it eventually.
