# Issue 18838: Speedup creation of Kleber tree

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2015-08-23 21:57:10

Assignee: sage-combinat

CC:  sage-combinat aschilling bsalisbury1

Keywords: rigged configurations, kleber tree

Currently, generating the first level of the Kleber tree grows poorly as the rank and the complexity of the root system increases. This is due to the fact that it uses all positive roots. Instead we use integral points (when expressed as simple roots) in the intersection of the negative root cone and a shifted positive weight cone.

Also due to the number of operations involved, this ticket changes all lower levels to use the polytope enumeration as well.


---

Comment by tscrim created at 2015-08-23 22:08:05

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-08-23 22:08:05

With the branch, we have (on SMC):

```
sage: %time RiggedConfigurations(['E',8,1], [This is the Trac macro *8,1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#8,1-macro)).module_generators
CPU times: user 384 ms, sys: 80 ms, total: 464 ms
Wall time: 430 ms
```

whereas previously this took

```
sage: %time RiggedConfigurations(['E',8,1], [This is the Trac macro *8,1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#8,1-macro)).module_generators
CPU times: user 23.9 s, sys: 72 ms, total: 24 s
Wall time: 24.5 s
```

As an added benefit, this allows us to combine the children iterators into a single method.
----
New commits:


---

Comment by tscrim created at 2015-08-23 22:27:55

To note, from looking over the profiling data, the majority of time is devoted to doing arithmetic using combinatorial free modules and just taking so long due to the sheer number of calculations.

It seems like on small rank, this is slower change is ~3-5x slower:

```
sage: RC = RiggedConfigurations(['D',4,1], [[4,2], [1,3], [2,4]])
sage: %time len(RC.module_generators)
CPU times: user 928 ms, sys: 84 ms, total: 1.01 s
Wall time: 1.47 s
586
```

vs the current version:

```
sage: %time len(RC.module_generators)
CPU times: user 340 ms, sys: 4 ms, total: 344 ms
Wall time: 348 ms
586
```

But for larger rank, it still is faster:

```
sage: RC = RiggedConfigurations(['D',8,1], [[4,2], [1,3], [2,4]])
sage: %time len(RC.module_generators)
CPU times: user 38.4 s, sys: 148 ms, total: 38.6 s
Wall time: 40.7 s
19234
```

vs I didn't have the patience to wait.

More data:

```
sage: RC = RiggedConfigurations(['D',6,1], [This is the Trac macro *4,6* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#4,6-macro))
sage: %time len(RC.module_generators)
CPU times: user 392 ms, sys: 56 ms, total: 448 ms
Wall time: 648 ms
28
```

previous:

```
sage: %time len(RC.module_generators)
CPU times: user 1.46 s, sys: 0 ns, total: 1.46 s
Wall time: 1.52 s
28
```


For F<sub>4</sub><sup>(1)</sup>, I get the new version is 2-20x faster for B<sup>i,1</sup>, where i = 1,2,3,4.

The question then becomes should we deal with the slowdown in small ranks, or keep both algorithms and have a heuristic which chooses between the two?


---

Comment by git created at 2015-11-19 05:47:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-19 05:52:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-12-21 03:14:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-21 03:22:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-12-21 03:32:44

From doing some more testing, as soon as the rank hits 7, the children iterator by using integer points of polytopes is faster than going over all possible up roots. I'm fairly certain this will hold true for all cases as this was true for even small examples in type A (the `use_uproot` was just an extra parameter I added for testing):

```
sage: from sage.combinat.rigged_configurations.kleber_tree import KleberTree
sage: %time K = KleberTree(['A',7,1], [[1,6],[1,1]], use_uproot=True)
CPU times: user 51.3 ms, sys: 8.19 ms, total: 59.5 ms
Wall time: 56.4 ms
sage: %time K = KleberTree(['A',7,1], [[1,6],[1,1]], use_uproot=False)
CPU times: user 14.6 ms, sys: 695 µs, total: 15.3 ms
Wall time: 13.4 ms
sage: %time K = KleberTree(['A',7,1], [[1,3],[1,1]], use_uproot=True)
CPU times: user 12.6 ms, sys: 139 µs, total: 12.8 ms
Wall time: 11.2 ms
sage: %time K = KleberTree(['A',7,1], [[1,3],[1,1]], use_uproot=False)
CPU times: user 8.66 ms, sys: 182 µs, total: 8.84 ms
Wall time: 8.12 ms
```



---

Comment by git created at 2017-02-05 04:02:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-02-05 04:09:39

This is blazingly fast with normaliz (i.e. with the optional spkg `pynormaliz`):

```
sage: %time [len(RiggedConfigurations(['E',8,1], [This is the Trac macro *r,1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#r,1-macro)).module_generators) for r in [1,.
....: .,8]]
CPU times: user 16.4 s, sys: 32 ms, total: 16.4 s
Wall time: 3.37 s
[3, 7, 24, 368, 75, 18, 5, 2]
```

Without it, the B<sup>4,1</sup> takes longer than I want to wait for it (and nearly impossible without this branch).


---

Comment by bsalisbury1 created at 2017-05-03 13:43:10

I'm getting doctest errors in a few places:


```
----------------------------------------------------------------------
sage -t --long src/sage/misc/sagedoc.py  # 3 doctests failed
sage -t --long src/sage/combinat/rigged_configurations/rigged_configurations.py  # 1 doctest failed
sage -t --long src/sage/combinat/posets/posets.py  # 1 doctest failed
sage -t --long src/sage/combinat/rigged_configurations/kleber_tree.py  # 13 doctests failed
sage -t --long src/sage/combinat/crystals/tensor_product.py  # 1 doctest failed
sage -t --long src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # 3 doctests failed
----------------------------------------------------------------------
Total time for all tests: 3348.8 seconds
    cpu time: 20669.5 seconds
    cumulative wall time: 26249.8 seconds
```


Note this is after the merge with the latest develop branch.


---

Comment by tscrim created at 2017-05-03 15:43:17

So the problem is with the normaliz interface. This is now #22938.


---

Comment by git created at 2017-05-03 15:51:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-03 15:51:29

Try it with this.


---

Comment by bsalisbury1 created at 2017-05-05 00:44:26

HTML and PDF docs build and all tests passed on my machine.

One question/comment before giving a positive review:  Should the following tests have the `#long time` tag removed?


```
sage: from sage.combinat.rigged_configurations.kleber_tree import KleberTree
sage: KT = KleberTree(['E', 6, 1], [This is the Trac macro *4, 2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#4, 2-macro))  # long time (9s on sage.math, 2012)
sage: KT.cardinality()  # long time
12
```


Both of these calculations are now immediate with this update.


---

Comment by tscrim created at 2017-05-05 01:17:09

I think they are only immediate when using `normaliz`, so I'm not yet ready to remove them.


---

Comment by bsalisbury1 created at 2017-05-05 14:26:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-05-11 21:58:49

Resolution: fixed
