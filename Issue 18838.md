# Issue 18838: Speedup creation of Kleber tree

archive/issues_018838.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  sage-combinat aschilling bsalisbury1\n\nKeywords: rigged configurations, kleber tree\n\nCurrently, generating the first level of the Kleber tree grows poorly as the rank and the complexity of the root system increases. This is due to the fact that it uses all positive roots. Instead we use integral points (when expressed as simple roots) in the intersection of the negative root cone and a shifted positive weight cone.\n\nAlso due to the number of operations involved, this ticket changes all lower levels to use the polytope enumeration as well.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19075\n\n",
    "created_at": "2015-08-23T21:57:10Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Speedup creation of Kleber tree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18838",
    "user": "tscrim"
}
```
Assignee: sage-combinat

CC:  sage-combinat aschilling bsalisbury1

Keywords: rigged configurations, kleber tree

Currently, generating the first level of the Kleber tree grows poorly as the rank and the complexity of the root system increases. This is due to the fact that it uses all positive roots. Instead we use integral points (when expressed as simple roots) in the intersection of the negative root cone and a shifted positive weight cone.

Also due to the number of operations involved, this ticket changes all lower levels to use the polytope enumeration as well.

Issue created by migration from https://trac.sagemath.org/ticket/19075





---

archive/issue_comments_257745.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-08-23T22:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257745",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_257746.json:
```json
{
    "body": "With the branch, we have (on SMC):\n\n```\nsage: %time RiggedConfigurations(['E',8,1], [[8,1]]).module_generators\nCPU times: user 384 ms, sys: 80 ms, total: 464 ms\nWall time: 430 ms\n```\n\nwhereas previously this took\n\n```\nsage: %time RiggedConfigurations(['E',8,1], [[8,1]]).module_generators\nCPU times: user 23.9 s, sys: 72 ms, total: 24 s\nWall time: 24.5 s\n```\n\nAs an added benefit, this allows us to combine the children iterators into a single method.\n----\nNew commits:",
    "created_at": "2015-08-23T22:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257746",
    "user": "tscrim"
}
```

With the branch, we have (on SMC):

```
sage: %time RiggedConfigurations(['E',8,1], [[8,1]]).module_generators
CPU times: user 384 ms, sys: 80 ms, total: 464 ms
Wall time: 430 ms
```

whereas previously this took

```
sage: %time RiggedConfigurations(['E',8,1], [[8,1]]).module_generators
CPU times: user 23.9 s, sys: 72 ms, total: 24 s
Wall time: 24.5 s
```

As an added benefit, this allows us to combine the children iterators into a single method.
----
New commits:



---

archive/issue_comments_257747.json:
```json
{
    "body": "To note, from looking over the profiling data, the majority of time is devoted to doing arithmetic using combinatorial free modules and just taking so long due to the sheer number of calculations.\n\nIt seems like on small rank, this is slower change is ~3-5x slower:\n\n```\nsage: RC = RiggedConfigurations(['D',4,1], [[4,2], [1,3], [2,4]])\nsage: %time len(RC.module_generators)\nCPU times: user 928 ms, sys: 84 ms, total: 1.01 s\nWall time: 1.47 s\n586\n```\n\nvs the current version:\n\n```\nsage: %time len(RC.module_generators)\nCPU times: user 340 ms, sys: 4 ms, total: 344 ms\nWall time: 348 ms\n586\n```\n\nBut for larger rank, it still is faster:\n\n```\nsage: RC = RiggedConfigurations(['D',8,1], [[4,2], [1,3], [2,4]])\nsage: %time len(RC.module_generators)\nCPU times: user 38.4 s, sys: 148 ms, total: 38.6 s\nWall time: 40.7 s\n19234\n```\n\nvs I didn't have the patience to wait.\n\nMore data:\n\n```\nsage: RC = RiggedConfigurations(['D',6,1], [[4,6]])\nsage: %time len(RC.module_generators)\nCPU times: user 392 ms, sys: 56 ms, total: 448 ms\nWall time: 648 ms\n28\n```\n\nprevious:\n\n```\nsage: %time len(RC.module_generators)\nCPU times: user 1.46 s, sys: 0 ns, total: 1.46 s\nWall time: 1.52 s\n28\n```\n\n\nFor F<sub>4</sub><sup>(1)</sup>, I get the new version is 2-20x faster for B<sup>i,1</sup>, where i = 1,2,3,4.\n\nThe question then becomes should we deal with the slowdown in small ranks, or keep both algorithms and have a heuristic which chooses between the two?",
    "created_at": "2015-08-23T22:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257747",
    "user": "tscrim"
}
```

To note, from looking over the profiling data, the majority of time is devoted to doing arithmetic using combinatorial free modules and just taking so long due to the sheer number of calculations.

It seems like on small rank, this is slower change is ~3-5x slower:

```
sage: RC = RiggedConfigurations(['D',4,1], [[4,2], [1,3], [2,4]])
sage: %time len(RC.module_generators)
CPU times: user 928 ms, sys: 84 ms, total: 1.01 s
Wall time: 1.47 s
586
```

vs the current version:

```
sage: %time len(RC.module_generators)
CPU times: user 340 ms, sys: 4 ms, total: 344 ms
Wall time: 348 ms
586
```

But for larger rank, it still is faster:

```
sage: RC = RiggedConfigurations(['D',8,1], [[4,2], [1,3], [2,4]])
sage: %time len(RC.module_generators)
CPU times: user 38.4 s, sys: 148 ms, total: 38.6 s
Wall time: 40.7 s
19234
```

vs I didn't have the patience to wait.

More data:

```
sage: RC = RiggedConfigurations(['D',6,1], [[4,6]])
sage: %time len(RC.module_generators)
CPU times: user 392 ms, sys: 56 ms, total: 448 ms
Wall time: 648 ms
28
```

previous:

```
sage: %time len(RC.module_generators)
CPU times: user 1.46 s, sys: 0 ns, total: 1.46 s
Wall time: 1.52 s
28
```


For F<sub>4</sub><sup>(1)</sup>, I get the new version is 2-20x faster for B<sup>i,1</sup>, where i = 1,2,3,4.

The question then becomes should we deal with the slowdown in small ranks, or keep both algorithms and have a heuristic which chooses between the two?



---

archive/issue_comments_257748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-19T05:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257748",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257749.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-11-19T05:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257749",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_257750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-21T03:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257750",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257751.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-21T03:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257751",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257752.json:
```json
{
    "body": "From doing some more testing, as soon as the rank hits 7, the children iterator by using integer points of polytopes is faster than going over all possible up roots. I'm fairly certain this will hold true for all cases as this was true for even small examples in type A (the `use_uproot` was just an extra parameter I added for testing):\n\n```\nsage: from sage.combinat.rigged_configurations.kleber_tree import KleberTree\nsage: %time K = KleberTree(['A',7,1], [[1,6],[1,1]], use_uproot=True)\nCPU times: user 51.3 ms, sys: 8.19 ms, total: 59.5 ms\nWall time: 56.4 ms\nsage: %time K = KleberTree(['A',7,1], [[1,6],[1,1]], use_uproot=False)\nCPU times: user 14.6 ms, sys: 695 \u00b5s, total: 15.3 ms\nWall time: 13.4 ms\nsage: %time K = KleberTree(['A',7,1], [[1,3],[1,1]], use_uproot=True)\nCPU times: user 12.6 ms, sys: 139 \u00b5s, total: 12.8 ms\nWall time: 11.2 ms\nsage: %time K = KleberTree(['A',7,1], [[1,3],[1,1]], use_uproot=False)\nCPU times: user 8.66 ms, sys: 182 \u00b5s, total: 8.84 ms\nWall time: 8.12 ms\n```\n",
    "created_at": "2015-12-21T03:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257752",
    "user": "tscrim"
}
```

From doing some more testing, as soon as the rank hits 7, the children iterator by using integer points of polytopes is faster than going over all possible up roots. I'm fairly certain this will hold true for all cases as this was true for even small examples in type A (the `use_uproot` was just an extra parameter I added for testing):

```
sage: from sage.combinat.rigged_configurations.kleber_tree import KleberTree
sage: %time K = KleberTree(['A',7,1], [[1,6],[1,1]], use_uproot=True)
CPU times: user 51.3 ms, sys: 8.19 ms, total: 59.5 ms
Wall time: 56.4 ms
sage: %time K = KleberTree(['A',7,1], [[1,6],[1,1]], use_uproot=False)
CPU times: user 14.6 ms, sys: 695 µs, total: 15.3 ms
Wall time: 13.4 ms
sage: %time K = KleberTree(['A',7,1], [[1,3],[1,1]], use_uproot=True)
CPU times: user 12.6 ms, sys: 139 µs, total: 12.8 ms
Wall time: 11.2 ms
sage: %time K = KleberTree(['A',7,1], [[1,3],[1,1]], use_uproot=False)
CPU times: user 8.66 ms, sys: 182 µs, total: 8.84 ms
Wall time: 8.12 ms
```




---

archive/issue_comments_257753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-05T04:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257753",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257754.json:
```json
{
    "body": "This is blazingly fast with normaliz (i.e. with the optional spkg `pynormaliz`):\n\n```\nsage: %time [len(RiggedConfigurations(['E',8,1], [[r,1]]).module_generators) for r in [1,.\n....: .,8]]\nCPU times: user 16.4 s, sys: 32 ms, total: 16.4 s\nWall time: 3.37 s\n[3, 7, 24, 368, 75, 18, 5, 2]\n```\n\nWithout it, the B<sup>4,1</sup> takes longer than I want to wait for it (and nearly impossible without this branch).",
    "created_at": "2017-02-05T04:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257754",
    "user": "tscrim"
}
```

This is blazingly fast with normaliz (i.e. with the optional spkg `pynormaliz`):

```
sage: %time [len(RiggedConfigurations(['E',8,1], [[r,1]]).module_generators) for r in [1,.
....: .,8]]
CPU times: user 16.4 s, sys: 32 ms, total: 16.4 s
Wall time: 3.37 s
[3, 7, 24, 368, 75, 18, 5, 2]
```

Without it, the B<sup>4,1</sup> takes longer than I want to wait for it (and nearly impossible without this branch).



---

archive/issue_comments_257755.json:
```json
{
    "body": "I'm getting doctest errors in a few places:\n\n\n```\n----------------------------------------------------------------------\nsage -t --long src/sage/misc/sagedoc.py  # 3 doctests failed\nsage -t --long src/sage/combinat/rigged_configurations/rigged_configurations.py  # 1 doctest failed\nsage -t --long src/sage/combinat/posets/posets.py  # 1 doctest failed\nsage -t --long src/sage/combinat/rigged_configurations/kleber_tree.py  # 13 doctests failed\nsage -t --long src/sage/combinat/crystals/tensor_product.py  # 1 doctest failed\nsage -t --long src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # 3 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 3348.8 seconds\n    cpu time: 20669.5 seconds\n    cumulative wall time: 26249.8 seconds\n```\n\n\nNote this is after the merge with the latest develop branch.",
    "created_at": "2017-05-03T13:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257755",
    "user": "bsalisbury1"
}
```

I'm getting doctest errors in a few places:


```
----------------------------------------------------------------------
sage -t --long src/sage/misc/sagedoc.py  # 3 doctests failed
sage -t --long src/sage/combinat/rigged_configurations/rigged_configurations.py  # 1 doctest failed
sage -t --long src/sage/combinat/posets/posets.py  # 1 doctest failed
sage -t --long src/sage/combinat/rigged_configurations/kleber_tree.py  # 13 doctests failed
sage -t --long src/sage/combinat/crystals/tensor_product.py  # 1 doctest failed
sage -t --long src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # 3 doctests failed
----------------------------------------------------------------------
Total time for all tests: 3348.8 seconds
    cpu time: 20669.5 seconds
    cumulative wall time: 26249.8 seconds
```


Note this is after the merge with the latest develop branch.



---

archive/issue_comments_257756.json:
```json
{
    "body": "So the problem is with the normaliz interface. This is now #22938.",
    "created_at": "2017-05-03T15:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257756",
    "user": "tscrim"
}
```

So the problem is with the normaliz interface. This is now #22938.



---

archive/issue_comments_257757.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-03T15:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257757",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257758.json:
```json
{
    "body": "Try it with this.",
    "created_at": "2017-05-03T15:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257758",
    "user": "tscrim"
}
```

Try it with this.



---

archive/issue_comments_257759.json:
```json
{
    "body": "HTML and PDF docs build and all tests passed on my machine.\n\nOne question/comment before giving a positive review:  Should the following tests have the `#long time` tag removed?\n\n\n```\nsage: from sage.combinat.rigged_configurations.kleber_tree import KleberTree\nsage: KT = KleberTree(['E', 6, 1], [[4, 2]])  # long time (9s on sage.math, 2012)\nsage: KT.cardinality()  # long time\n12\n```\n\n\nBoth of these calculations are now immediate with this update.",
    "created_at": "2017-05-05T00:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257759",
    "user": "bsalisbury1"
}
```

HTML and PDF docs build and all tests passed on my machine.

One question/comment before giving a positive review:  Should the following tests have the `#long time` tag removed?


```
sage: from sage.combinat.rigged_configurations.kleber_tree import KleberTree
sage: KT = KleberTree(['E', 6, 1], [[4, 2]])  # long time (9s on sage.math, 2012)
sage: KT.cardinality()  # long time
12
```


Both of these calculations are now immediate with this update.



---

archive/issue_comments_257760.json:
```json
{
    "body": "I think they are only immediate when using `normaliz`, so I'm not yet ready to remove them.",
    "created_at": "2017-05-05T01:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257760",
    "user": "tscrim"
}
```

I think they are only immediate when using `normaliz`, so I'm not yet ready to remove them.



---

archive/issue_comments_257761.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-05T14:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257761",
    "user": "bsalisbury1"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_257762.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-11T21:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18838#issuecomment-257762",
    "user": "vbraun"
}
```

Resolution: fixed
