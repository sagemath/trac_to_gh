# Issue 14039: Try not to pick up user versions of things like numpy, mpl

archive/issues_014039.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @vbraun @jdemeyer\n\nAt [this ask.sagemath.org question](http://ask.sagemath.org/question/1449/sage-uses-system-wide-python), where some users have the system Python being picked up for some reasons, Volker asks\n\n```\nCan you try\nexport PYTHONNOUSERSITE=yes\nsage\nThis should prevent Sage from picking up stuff in .local/lib. If that fixes your problem we can add it to the next release.\n```\n\nApparently this works, and [this sage-support question](https://groups.google.com/forum/?fromgroups=#!topic/sage-support/Y9bjhb6-dcM) suggests it works a lot.  Maybe we should put this in now.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14243\n\n",
    "created_at": "2013-03-07T19:16:34Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Try not to pick up user versions of things like numpy, mpl",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14039",
    "user": "@kcrisman"
}
```
Assignee: GeorgSWeber

CC:  @vbraun @jdemeyer

At [this ask.sagemath.org question](http://ask.sagemath.org/question/1449/sage-uses-system-wide-python), where some users have the system Python being picked up for some reasons, Volker asks

```
Can you try
export PYTHONNOUSERSITE=yes
sage
This should prevent Sage from picking up stuff in .local/lib. If that fixes your problem we can add it to the next release.
```

Apparently this works, and [this sage-support question](https://groups.google.com/forum/?fromgroups=#!topic/sage-support/Y9bjhb6-dcM) suggests it works a lot.  Maybe we should put this in now.

Issue created by migration from https://trac.sagemath.org/ticket/14243





---

archive/issue_comments_175546.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-28T20:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175546",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_175547.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-07-28T20:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175547",
    "user": "@jhpalmieri"
}
```

New commits:



---

archive/issue_comments_175548.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-28T20:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175548",
    "user": "buck"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_175549.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-07-28T22:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175549",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_175550.json:
```json
{
    "body": "Author name is missing....",
    "created_at": "2015-07-28T22:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175550",
    "user": "@vbraun"
}
```

Author name is missing....



---

archive/issue_comments_175551.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-07-28T22:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175551",
    "user": "@jhpalmieri"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_175552.json:
```json
{
    "body": "Oops.",
    "created_at": "2015-07-28T22:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175552",
    "user": "@jhpalmieri"
}
```

Oops.



---

archive/issue_comments_175553.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-29T14:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175553",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_175554.json:
```json
{
    "body": "That we do this is a shame.   It only further alienates Sage from standard practices.   It makes it so this FAQ entry is no longer valid: \n\nhttps://github.com/sagemathinc/smc/wiki/FAQ#-question-how-can-i-install-python-packages-from-httpspypipythonorgpypi--using-pip \n\nIt makes it very, very painful for anybody to ever install Python packages and use them without Sage, without actually modifying a Sage install.  This is very much exactly the opposite direction in which we should be going.     Big -1.",
    "created_at": "2015-10-26T00:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175554",
    "user": "@williamstein"
}
```

That we do this is a shame.   It only further alienates Sage from standard practices.   It makes it so this FAQ entry is no longer valid: 

https://github.com/sagemathinc/smc/wiki/FAQ#-question-how-can-i-install-python-packages-from-httpspypipythonorgpypi--using-pip 

It makes it very, very painful for anybody to ever install Python packages and use them without Sage, without actually modifying a Sage install.  This is very much exactly the opposite direction in which we should be going.     Big -1.



---

archive/issue_comments_175555.json:
```json
{
    "body": "Replying to [comment:11 was]:\n> It makes it very, very painful for anybody to ever install Python packages and use them without Sage, without actually modifying a Sage install.\n\nI thought this was exactly what it *did* accomplish: allow people to install their own Python packages and not have them interfere with Sage, not have Sage interfere with them. Maybe I am misunderstanding what you're saying.",
    "created_at": "2015-10-26T15:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175555",
    "user": "@jhpalmieri"
}
```

Replying to [comment:11 was]:
> It makes it very, very painful for anybody to ever install Python packages and use them without Sage, without actually modifying a Sage install.

I thought this was exactly what it *did* accomplish: allow people to install their own Python packages and not have them interfere with Sage, not have Sage interfere with them. Maybe I am misunderstanding what you're saying.



---

archive/issue_comments_175556.json:
```json
{
    "body": "I made a horrible typo.  I meant \"It makes it very, very painful for anybody to ever install Python packages and use them **with** Sage, without actually modifying a Sage install.\"   \n\nThis is an absolutely massive problem with SageMathCloud, where there is one Sage install and (literally) 15,000 users on a single computer that use that Sage install.   They can't all have their own copy of Sage.  So when they install packages (often from pip) to use *with* Sage, they have to use the --user flag.     My solution is that I now have a fork of Sage that removes the code from this ticket. \n\nhttps://github.com/sagemathinc/smc-sage/commit/7c9cfd095463091bcf41e1c6ea6e8eebfb61f00c\n\nThis works for me, I guess.  However, I doubt I'm the only person with this problem.\n\nI think the right solution in this case should be better educate people about how to control their Python packaging.  For example, for those ask posts, and this problem, we should instead have something in the README about PYTHONNOUSERSITE=yes, and a link to the relevant Python docs.  Telling the person with the problem to use that environment variable would have solved the problem for them.",
    "created_at": "2015-10-26T16:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175556",
    "user": "@williamstein"
}
```

I made a horrible typo.  I meant "It makes it very, very painful for anybody to ever install Python packages and use them **with** Sage, without actually modifying a Sage install."   

This is an absolutely massive problem with SageMathCloud, where there is one Sage install and (literally) 15,000 users on a single computer that use that Sage install.   They can't all have their own copy of Sage.  So when they install packages (often from pip) to use *with* Sage, they have to use the --user flag.     My solution is that I now have a fork of Sage that removes the code from this ticket. 

https://github.com/sagemathinc/smc-sage/commit/7c9cfd095463091bcf41e1c6ea6e8eebfb61f00c

This works for me, I guess.  However, I doubt I'm the only person with this problem.

I think the right solution in this case should be better educate people about how to control their Python packaging.  For example, for those ask posts, and this problem, we should instead have something in the README about PYTHONNOUSERSITE=yes, and a link to the relevant Python docs.  Telling the person with the problem to use that environment variable would have solved the problem for them.



---

archive/issue_comments_175557.json:
```json
{
    "body": "Follow up.  I think we absolutely must move to a model where we make it easy for users to create and share packages of code that depend on Sage.   Our current spkg system is a complete failure in this regard, and has only got worse with its tight integration into the Sage git repo.    In constrast, setuptools and pypi -- the official Python packaging framework -- works very well, is heavily tested, and there's tons of documentation and tutorials.  Instead of making it much harder to use pip/setuptools/pypi with Sage, which is what this trac ticket does, we should be making it much easier.  \n\nThere are about 6,000 user-created R packages in Rcran -- I've installed many of these (ok, dozens requested by users), and they all install perfectly.  Sage could have hundreds or even thousands of packages on pip right now.  We could have an automated testing framework that downloads them all and builds them, and runs their test suites (setuptools has integrated test suite support).   We could decide to include some of these packages standard with Sage, and referee them.   It's an epic mistake that we aren't doing this with a passion right now.  Let's not make it even more difficult.",
    "created_at": "2015-10-26T16:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175557",
    "user": "@williamstein"
}
```

Follow up.  I think we absolutely must move to a model where we make it easy for users to create and share packages of code that depend on Sage.   Our current spkg system is a complete failure in this regard, and has only got worse with its tight integration into the Sage git repo.    In constrast, setuptools and pypi -- the official Python packaging framework -- works very well, is heavily tested, and there's tons of documentation and tutorials.  Instead of making it much harder to use pip/setuptools/pypi with Sage, which is what this trac ticket does, we should be making it much easier.  

There are about 6,000 user-created R packages in Rcran -- I've installed many of these (ok, dozens requested by users), and they all install perfectly.  Sage could have hundreds or even thousands of packages on pip right now.  We could have an automated testing framework that downloads them all and builds them, and runs their test suites (setuptools has integrated test suite support).   We could decide to include some of these packages standard with Sage, and referee them.   It's an epic mistake that we aren't doing this with a passion right now.  Let's not make it even more difficult.



---

archive/issue_comments_175558.json:
```json
{
    "body": "There are two different use cases:\n* A private build of Sage (everything user-writable) should not conflict with another private numpy installation. You can use pip just fine without the `--user` option. Then `PYTHONNOUSERSITE=yes` is the way to achieve that.\n* A system-wide build of Sage (nothing user-writable, so just `pip install foo` cannot work) should work with `pip --user`. This is the SMC problem.\nReally this is a special case of distinguishing a build-from-source and a binary install. Sage traditionally pretends that there is no difference, but there is.",
    "created_at": "2015-10-26T16:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175558",
    "user": "@vbraun"
}
```

There are two different use cases:
* A private build of Sage (everything user-writable) should not conflict with another private numpy installation. You can use pip just fine without the `--user` option. Then `PYTHONNOUSERSITE=yes` is the way to achieve that.
* A system-wide build of Sage (nothing user-writable, so just `pip install foo` cannot work) should work with `pip --user`. This is the SMC problem.
Really this is a special case of distinguishing a build-from-source and a binary install. Sage traditionally pretends that there is no difference, but there is.



---

archive/issue_comments_175559.json:
```json
{
    "body": "BTW its now really easy to use pip for optional packages:\n\n```\n$ ll build/pkgs/trac/\ntotal 4\n-rw-rw-r--. 1 vbraun vbraun 4 Sep 27 14:25 type\n$ cat build/pkgs/trac/type \npip\n```\n\nFor various non-technical reasons (mainly OSX and OpenSSL) we can't use pip for all our Python packaging (yet).",
    "created_at": "2015-10-26T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175559",
    "user": "@vbraun"
}
```

BTW its now really easy to use pip for optional packages:

```
$ ll build/pkgs/trac/
total 4
-rw-rw-r--. 1 vbraun vbraun 4 Sep 27 14:25 type
$ cat build/pkgs/trac/type 
pip
```

For various non-technical reasons (mainly OSX and OpenSSL) we can't use pip for all our Python packaging (yet).



---

archive/issue_comments_175560.json:
```json
{
    "body": "Replying to [comment:15 vbraun]:\n> There are two different use cases:\n> * A private build of Sage (everything user-writable) should not conflict with another private numpy installation. You can use pip just fine without the `--user` option. Then `PYTHONNOUSERSITE=yes` is the way to achieve that.\n> * A system-wide build of Sage (nothing user-writable, so just `pip install foo` cannot work) should work with `pip --user`. This is the SMC problem.\n> Really this is a special case of distinguishing a build-from-source and a binary install. Sage traditionally pretends that there is no difference, but there is. \n\nAgreed.  I think the terminology \"build-from-source\" and \"binary install\" is a little misleading though, since *I* did build the SMC install from source myself.    Maybe \"system-wide\" versus \"personal install\" would be a better distinction. \n\nAny thoughts about how to technically distinguish between these two types of setups?  A flag to ./configure on first build?  Something else?  \n\n> BTW its now really easy to use pip for optional packages \n\nAwesome -- a very good step in the right direction!",
    "created_at": "2015-10-26T17:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175560",
    "user": "@williamstein"
}
```

Replying to [comment:15 vbraun]:
> There are two different use cases:
> * A private build of Sage (everything user-writable) should not conflict with another private numpy installation. You can use pip just fine without the `--user` option. Then `PYTHONNOUSERSITE=yes` is the way to achieve that.
> * A system-wide build of Sage (nothing user-writable, so just `pip install foo` cannot work) should work with `pip --user`. This is the SMC problem.
> Really this is a special case of distinguishing a build-from-source and a binary install. Sage traditionally pretends that there is no difference, but there is. 

Agreed.  I think the terminology "build-from-source" and "binary install" is a little misleading though, since *I* did build the SMC install from source myself.    Maybe "system-wide" versus "personal install" would be a better distinction. 

Any thoughts about how to technically distinguish between these two types of setups?  A flag to ./configure on first build?  Something else?  

> BTW its now really easy to use pip for optional packages 

Awesome -- a very good step in the right direction!



---

archive/issue_comments_175561.json:
```json
{
    "body": "Of course every software must be built from source at one point, possibly by your distributor ;-)\n\nThe easiest way would probably be to check if `$SAGE_ROOT` is writable by the current user. \n\nIn fact, there are four different cases for the two independent choices:\n* Private install (I have write permissions) vs. system-wide (I do not have write permissions)\n* Build from source vs. using a pre-built binary\nThe issue here only depends on the first choice.",
    "created_at": "2015-10-26T17:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175561",
    "user": "@vbraun"
}
```

Of course every software must be built from source at one point, possibly by your distributor ;-)

The easiest way would probably be to check if `$SAGE_ROOT` is writable by the current user. 

In fact, there are four different cases for the two independent choices:
* Private install (I have write permissions) vs. system-wide (I do not have write permissions)
* Build from source vs. using a pre-built binary
The issue here only depends on the first choice.



---

archive/issue_comments_175562.json:
```json
{
    "body": "I think we should revert this change.   I will always revert it in SMC, and user confusion is happening for sure (e.g., a sage-support message yesterday).  I've made #19612, which is revert this.\n\n -- William",
    "created_at": "2015-11-21T20:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14039#issuecomment-175562",
    "user": "@williamstein"
}
```

I think we should revert this change.   I will always revert it in SMC, and user confusion is happening for sure (e.g., a sage-support message yesterday).  I've made #19612, which is revert this.

 -- William
