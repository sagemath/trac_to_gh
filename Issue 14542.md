# Issue 14542: Clean up S-class group, S-unit and Selmer group code

archive/issues_014542.json:
```json
{
    "body": "Assignee: @loefflerd\n\nCC:  argaezg akoutsianas\n\nKeywords: S-class group, S-units, Selmer group\n\nThe code for S-class groups, S-units and Selmer groups of number fields, and more generally \u00e9tale algebras, is not entirely satisfactory in the following respects:\n\n1. The code for computing Selmer groups is somewhat convoluted. Conceptually, the computation of the generators for principal ideals of the form gen<sup>order</sup> belongs in selmer_group, not _S_class_group_and_units. It would be more correct to return, as S-class group generators, pairs (gen, order) instead of triples (gen, order, pr), and leave the computation of the principal ideal generators to selmer_group.\n\n2. The docstrings are not very clear. The sentences are very long and contain awkward constructions (\"a fractional ideal representative of the S-class group generator whose order (in the S-class group) is order\"; \"principal generator\").\n\n3. The docstring of NumberField._S_class_group_and_units suggests that to obtain a principal ideal, genorder can be multiplied by any fractional ideal J whose class is in the subgroup of the class group generated by ideals in S. However, the condition is more strict: J must be in the subgroup of the ideal group generated by ideals in S.\n\nThe attached patch does the following things:\n\n1. Move computation of generators of principal ideals from NumberField._S_class_group_and_units to NumberField.selmer_group.\n\n2. Add a method _S_decomposition to PolynomialQuotientRing_generic, which computes the decomposition of an \u00e9tale algebra as a product of number fields.  Use this function in S_class_group, S_units and selmer_group.\n\n3. Delete PolynomialQuotientRing_generic._S_class_group_and_units, and move its code and doctests to S_class_group, class_group, S_units and units.\n\n4. Reimplement PolynomialQuotientRing_generic.selmer_group to compute the Selmer group as the product of the Selmer groups of the distinct components, instead of imitating the algorithm of NumberField.selmer_group.\n\n5. Make the documentation more precise.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14746\n\n",
    "created_at": "2013-06-15T15:08:25Z",
    "labels": [
        "component: number fields"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "Clean up S-class group, S-unit and Selmer group code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14542",
    "user": "https://github.com/pjbruin"
}
```
Assignee: @loefflerd

CC:  argaezg akoutsianas

Keywords: S-class group, S-units, Selmer group

The code for S-class groups, S-units and Selmer groups of number fields, and more generally étale algebras, is not entirely satisfactory in the following respects:

1. The code for computing Selmer groups is somewhat convoluted. Conceptually, the computation of the generators for principal ideals of the form gen<sup>order</sup> belongs in selmer_group, not _S_class_group_and_units. It would be more correct to return, as S-class group generators, pairs (gen, order) instead of triples (gen, order, pr), and leave the computation of the principal ideal generators to selmer_group.

2. The docstrings are not very clear. The sentences are very long and contain awkward constructions ("a fractional ideal representative of the S-class group generator whose order (in the S-class group) is order"; "principal generator").

3. The docstring of NumberField._S_class_group_and_units suggests that to obtain a principal ideal, genorder can be multiplied by any fractional ideal J whose class is in the subgroup of the class group generated by ideals in S. However, the condition is more strict: J must be in the subgroup of the ideal group generated by ideals in S.

The attached patch does the following things:

1. Move computation of generators of principal ideals from NumberField._S_class_group_and_units to NumberField.selmer_group.

2. Add a method _S_decomposition to PolynomialQuotientRing_generic, which computes the decomposition of an étale algebra as a product of number fields.  Use this function in S_class_group, S_units and selmer_group.

3. Delete PolynomialQuotientRing_generic._S_class_group_and_units, and move its code and doctests to S_class_group, class_group, S_units and units.

4. Reimplement PolynomialQuotientRing_generic.selmer_group to compute the Selmer group as the product of the Selmer groups of the distinct components, instead of imitating the algorithm of NumberField.selmer_group.

5. Make the documentation more precise.

Issue created by migration from https://trac.sagemath.org/ticket/14746





---

archive/issue_comments_184337.json:
```json
{
    "body": "based on 5.10.rc1 + #14489",
    "created_at": "2013-06-15T15:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184337",
    "user": "https://github.com/pjbruin"
}
```

based on 5.10.rc1 + #14489



---

archive/issue_comments_184338.json:
```json
{
    "body": "Attachment [trac_14746_selmer_group_cleanup.patch](tarball://root/attachments/some-uuid/ticket14746/trac_14746_selmer_group_cleanup.patch) by @pjbruin created at 2013-06-15 15:13:04",
    "created_at": "2013-06-15T15:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184338",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_14746_selmer_group_cleanup.patch](tarball://root/attachments/some-uuid/ticket14746/trac_14746_selmer_group_cleanup.patch) by @pjbruin created at 2013-06-15 15:13:04



---

archive/issue_comments_184339.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-06-15T15:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184339",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_184340.json:
```json
{
    "body": "Attachment [trac_14746_doctests_32_64_bit_undo.patch](tarball://root/attachments/some-uuid/ticket14746/trac_14746_doctests_32_64_bit_undo.patch) by @pjbruin created at 2013-07-05 18:47:53\n\nundo the effect of trac_14489_doctests_32_64_bit.patch",
    "created_at": "2013-07-05T18:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184340",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_14746_doctests_32_64_bit_undo.patch](tarball://root/attachments/some-uuid/ticket14746/trac_14746_doctests_32_64_bit_undo.patch) by @pjbruin created at 2013-07-05 18:47:53

undo the effect of trac_14489_doctests_32_64_bit.patch



---

archive/issue_comments_184341.json:
```json
{
    "body": "For patchbot:\n\nApply trac_14746_doctests_32_64_bit_undo.patch, trac_14746_selmer_group_cleanup.patch",
    "created_at": "2013-07-15T21:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184341",
    "user": "https://github.com/pjbruin"
}
```

For patchbot:

Apply trac_14746_doctests_32_64_bit_undo.patch, trac_14746_selmer_group_cleanup.patch



---

archive/issue_comments_184342.json:
```json
{
    "body": "The source file needs to specify UTF-8 encoding if you want to use non-ascii characters, but `rings/polynomial/polynomial_quotient_ring.py` does not. See http://www.python.org/dev/peps/pep-0263/",
    "created_at": "2013-07-17T20:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184342",
    "user": "https://github.com/vbraun"
}
```

The source file needs to specify UTF-8 encoding if you want to use non-ascii characters, but `rings/polynomial/polynomial_quotient_ring.py` does not. See http://www.python.org/dev/peps/pep-0263/



---

archive/issue_comments_184343.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> The source file needs to specify UTF-8 encoding if you want to use non-ascii characters, but `rings/polynomial/polynomial_quotient_ring.py` does not. See http://www.python.org/dev/peps/pep-0263/\n\nMy patch fixes that as well, by adding a line `# -*- coding: utf-8 -*-` at the beginning (I forgot to mention this in the patch description).  Does this conform to the expected syntax?",
    "created_at": "2013-07-17T21:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184343",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:6 vbraun]:
> The source file needs to specify UTF-8 encoding if you want to use non-ascii characters, but `rings/polynomial/polynomial_quotient_ring.py` does not. See http://www.python.org/dev/peps/pep-0263/

My patch fixes that as well, by adding a line `# -*- coding: utf-8 -*-` at the beginning (I forgot to mention this in the patch description).  Does this conform to the expected syntax?



---

archive/issue_comments_184344.json:
```json
{
    "body": "After checking the documentation, I doubt that the 'raw' declaration (changing `\"\"\"` to `r\"\"\"`) is the right fix.  Should `u\"\"\"` be used instead, or is `\"\"\"` OK as long as the file is declared to be UTF-8?",
    "created_at": "2013-07-17T21:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184344",
    "user": "https://github.com/pjbruin"
}
```

After checking the documentation, I doubt that the 'raw' declaration (changing `"""` to `r"""`) is the right fix.  Should `u"""` be used instead, or is `"""` OK as long as the file is declared to be UTF-8?



---

archive/issue_comments_184345.json:
```json
{
    "body": "OK, I didn't see the last patch in context. The **r**aw only concerns backlashes but handy to not have to escape `\\TeX` commands. No need for **u**nicode strings.",
    "created_at": "2013-07-17T23:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184345",
    "user": "https://github.com/vbraun"
}
```

OK, I didn't see the last patch in context. The **r**aw only concerns backlashes but handy to not have to escape `\TeX` commands. No need for **u**nicode strings.



---

archive/issue_comments_184346.json:
```json
{
    "body": "I removed the second part of the patch, which changed `\"\"\"` to `r\"\"\"`.",
    "created_at": "2013-07-18T07:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184346",
    "user": "https://github.com/pjbruin"
}
```

I removed the second part of the patch, which changed `"""` to `r"""`.



---

archive/issue_comments_184347.json:
```json
{
    "body": "I hope I can look at this and get it finished next week.  Does it provide a class for S-units like the class for units?",
    "created_at": "2013-07-18T20:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184347",
    "user": "https://github.com/JohnCremona"
}
```

I hope I can look at this and get it finished next week.  Does it provide a class for S-units like the class for units?



---

archive/issue_comments_184348.json:
```json
{
    "body": "Test failure in my 32-bit VM:\n\n```\nFile \"sage/rings/polynomial/polynomial_quotient_ring.py\", line 926, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic._S_decomposition\nFailed example:\n    S._S_decomposition(tuple(K.primes_above(3)))\nExpected:\n    ([Number Field in x0 with defining polynomial x^2 + 23 over its base field,\n      Number Field in x1 with defining polynomial x^2 + 31 over its base field],\n     [(Ring endomorphism of Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324\n      Defn: y0 |--> y0,\n       0),\n      (Ring endomorphism of Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676\n      Defn: y1 |--> y1,\n       1)],\n     [(Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324,\n       [Fractional ideal (3, 1/4*y0^2 + 1/2*y0 + 11/2),\n        Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 8),\n        Fractional ideal (3, 1/36*y0^3 + 1/4*y0^2 + 5/9*y0 + 13/2),\n        Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 6)]),\n      (Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676,\n       [Fractional ideal (3, -1/52*y1^3 - 23/26*y1 - 1),\n        Fractional ideal (3, -1/52*y1^3 - 23/26*y1 + 1)])])\nGot:\n    ([Number Field in x0 with defining polynomial x^2 + 23 over its base field, Number Field in x1 with defining polynomial x^2 + 31 over its base field], [(Ring endomorphism of Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324\n      Defn: y0 |--> y0, 0), (Ring endomorphism of Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676\n      Defn: y1 |--> y1, 1)], [(Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324, [Fractional ideal (3, -1/4*y0^2 - 1/2*y0 - 11/2), Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 8), Fractional ideal (3, 1/36*y0^3 - 1/4*y0^2 + 14/9*y0 - 17/2), Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 6)]), (Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676, [Fractional ideal (3, -1/52*y1^3 - 23/26*y1 - 1), Fractional ideal (3, -1/52*y1^3 - 23/26*y1 + 1)])])\n```\nEdit: sorry had the wrong ticket number, this is the failure I'm getting.",
    "created_at": "2013-07-19T01:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184348",
    "user": "https://github.com/vbraun"
}
```

Test failure in my 32-bit VM:

```
File "sage/rings/polynomial/polynomial_quotient_ring.py", line 926, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic._S_decomposition
Failed example:
    S._S_decomposition(tuple(K.primes_above(3)))
Expected:
    ([Number Field in x0 with defining polynomial x^2 + 23 over its base field,
      Number Field in x1 with defining polynomial x^2 + 31 over its base field],
     [(Ring endomorphism of Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324
      Defn: y0 |--> y0,
       0),
      (Ring endomorphism of Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676
      Defn: y1 |--> y1,
       1)],
     [(Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324,
       [Fractional ideal (3, 1/4*y0^2 + 1/2*y0 + 11/2),
        Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 8),
        Fractional ideal (3, 1/36*y0^3 + 1/4*y0^2 + 5/9*y0 + 13/2),
        Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 6)]),
      (Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676,
       [Fractional ideal (3, -1/52*y1^3 - 23/26*y1 - 1),
        Fractional ideal (3, -1/52*y1^3 - 23/26*y1 + 1)])])
Got:
    ([Number Field in x0 with defining polynomial x^2 + 23 over its base field, Number Field in x1 with defining polynomial x^2 + 31 over its base field], [(Ring endomorphism of Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324
      Defn: y0 |--> y0, 0), (Ring endomorphism of Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676
      Defn: y1 |--> y1, 1)], [(Number Field in y0 with defining polynomial x^4 + 56*x^2 + 324, [Fractional ideal (3, -1/4*y0^2 - 1/2*y0 - 11/2), Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 8), Fractional ideal (3, 1/36*y0^3 - 1/4*y0^2 + 14/9*y0 - 17/2), Fractional ideal (3, 1/72*y0^3 + 1/4*y0^2 + 19/36*y0 + 6)]), (Number Field in y1 with defining polynomial x^4 + 72*x^2 + 676, [Fractional ideal (3, -1/52*y1^3 - 23/26*y1 - 1), Fractional ideal (3, -1/52*y1^3 - 23/26*y1 + 1)])])
```
Edit: sorry had the wrong ticket number, this is the failure I'm getting.



---

archive/issue_comments_184349.json:
```json
{
    "body": "Replying to [comment:11 cremona]:\n> I hope I can look at this and get it finished next week.  Does it provide a class for S-units like the class for units?\n\nIt doesn't add new (user-level) functionality, but the clean-up might make it easier to add this in the future.",
    "created_at": "2013-07-19T09:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184349",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:11 cremona]:
> I hope I can look at this and get it finished next week.  Does it provide a class for S-units like the class for units?

It doesn't add new (user-level) functionality, but the clean-up might make it easier to add this in the future.



---

archive/issue_comments_184350.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> Test failure in my 32-bit VM:\n\n\nWith hindsight I could have guessed that the new doctest would create another 32/64-bit difference...  I am preparing a patch that\n* adds a bit more explanation to the docstring;\n* instead of checking the generators of the primes lying above 3, just checks whether the number of such primes is correct;\n* makes a trivial simplification in the code;\n* changes back `\"\"\"` to `r\"\"\"` in two docstrings, since they contain backslashes.",
    "created_at": "2013-07-19T09:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184350",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:12 vbraun]:
> Test failure in my 32-bit VM:


With hindsight I could have guessed that the new doctest would create another 32/64-bit difference...  I am preparing a patch that
* adds a bit more explanation to the docstring;
* instead of checking the generators of the primes lying above 3, just checks whether the number of such primes is correct;
* makes a trivial simplification in the code;
* changes back `"""` to `r"""` in two docstrings, since they contain backslashes.



---

archive/issue_comments_184351.json:
```json
{
    "body": "Attachment [trac_14746_docstring_fixes.patch](tarball://root/attachments/some-uuid/ticket14746/trac_14746_docstring_fixes.patch) by @pjbruin created at 2013-07-19 09:41:46\n\nadd doctest, utf-8 declaration, r\"\"\" for backslashes, trivial edit in code",
    "created_at": "2013-07-19T09:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184351",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_14746_docstring_fixes.patch](tarball://root/attachments/some-uuid/ticket14746/trac_14746_docstring_fixes.patch) by @pjbruin created at 2013-07-19 09:41:46

add doctest, utf-8 declaration, r""" for backslashes, trivial edit in code



---

archive/issue_comments_184352.json:
```json
{
    "body": "Changing keywords from \"S-class group, S-units, Selmer group\" to \"S-class group, S-units, Selmer group, sd51\".",
    "created_at": "2013-07-22T13:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184352",
    "user": "https://github.com/loefflerd"
}
```

Changing keywords from "S-class group, S-units, Selmer group" to "S-class group, S-units, Selmer group, sd51".



---

archive/issue_comments_184353.json:
```json
{
    "body": "All three patches apply fine to (5.11.beta3 + the two patches from #14489).\nMost of the changes here are cosmetic, moving code around and improving the documentation, and they look fine to me.  Testing now...",
    "created_at": "2013-07-24T12:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184353",
    "user": "https://github.com/JohnCremona"
}
```

All three patches apply fine to (5.11.beta3 + the two patches from #14489).
Most of the changes here are cosmetic, moving code around and improving the documentation, and they look fine to me.  Testing now...



---

archive/issue_comments_184354.json:
```json
{
    "body": "All tests (including long) pass in sage/rings, so I'll give this a positive review.",
    "created_at": "2013-07-24T13:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184354",
    "user": "https://github.com/JohnCremona"
}
```

All tests (including long) pass in sage/rings, so I'll give this a positive review.



---

archive/issue_comments_184355.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-24T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184355",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_042274.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-25T06:50:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14542#event-42274"
}
```



---

archive/issue_comments_184356.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-16T21:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184356",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_042275.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:19:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14542#event-42275"
}
```



---

archive/issue_comments_184357.json:
```json
{
    "body": "See #16496.",
    "created_at": "2014-06-18T11:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14542",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14542#issuecomment-184357",
    "user": "https://github.com/JohnCremona"
}
```

See #16496.
