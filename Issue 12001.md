# Issue 12001: Update FLINT to 2.3

archive/issues_012001.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  jpflori spancratz @williamstein @nexttime\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12173\n\n",
    "created_at": "2011-12-17T19:13:29Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "Update FLINT to 2.3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12001",
    "user": "https://github.com/mwhansen"
}
```
Assignee: tbd

CC:  jpflori spancratz @williamstein @nexttime



Issue created by migration from https://trac.sagemath.org/ticket/12173





---

archive/issue_comments_138006.json:
```json
{
    "body": "Building flint2 in Sage:\n\n- Update MPFR to 3.1.0 - #11666\n  http://sage.math.washington.edu/mpfr-3.1.0.spkg\n\n- Update MPFI to 1.5.0 - #12171\n  http://sage.math.washington.edu/home/mhansen/mpfi-1.5.0.spkg\n\n- Reinstall http://sagemath.org/packages/standard/libfplll-3.0.12.p1.spkg\n\n- Install flint2 spkg (beware, this will break Sage)\n  http://sage.math.washington.edu/flint-2.3.spkg\n\n- touch SAGE_ROOT/devel/sage/sage/combinat/partitions.*\n\n- Run \"sage -b\"",
    "created_at": "2011-12-17T19:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138006",
    "user": "https://github.com/mwhansen"
}
```

Building flint2 in Sage:

- Update MPFR to 3.1.0 - #11666
  http://sage.math.washington.edu/mpfr-3.1.0.spkg

- Update MPFI to 1.5.0 - #12171
  http://sage.math.washington.edu/home/mhansen/mpfi-1.5.0.spkg

- Reinstall http://sagemath.org/packages/standard/libfplll-3.0.12.p1.spkg

- Install flint2 spkg (beware, this will break Sage)
  http://sage.math.washington.edu/flint-2.3.spkg

- touch SAGE_ROOT/devel/sage/sage/combinat/partitions.*

- Run "sage -b"



---

archive/issue_comments_138007.json:
```json
{
    "body": "Attachment [ulong_extras.patch](tarball://root/attachments/some-uuid/ticket12173/ulong_extras.patch) by @mwhansen created at 2011-12-18 13:31:49",
    "created_at": "2011-12-18T13:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138007",
    "user": "https://github.com/mwhansen"
}
```

Attachment [ulong_extras.patch](tarball://root/attachments/some-uuid/ticket12173/ulong_extras.patch) by @mwhansen created at 2011-12-18 13:31:49



---

archive/issue_comments_138008.json:
```json
{
    "body": "Attachment [zmod.patch](tarball://root/attachments/some-uuid/ticket12173/zmod.patch) by @fredrik-johansson created at 2011-12-18 16:55:48\n\nzmod.patch replaces references to zmod_poly with nmod_poly and (hopefully) fixes places where the interface of a function changed. Completely untested at this point, of course.\n\nSome remarks:\n\nI deleted the zmod_poly_pow function implemented in Sage, since FLINT now provides such a function.\n\nThere is no longer a _nmod_poly_set_coeff_ui, which was used in one place (creating a polynomial from a list). I replaced it with nmod_poly_set_coeff_ui rather than manipulating coefficients directly, which is a bit slower, but shouldn't matter that much.\n\nnmod_poly_resultant needs to be added in FLINT 2. If we don't get it done, the code calling it could just be commented out to fall back to the default Sage code that already handles the non-prime case.\n\nI didn't change any filenames or Sage types (so the corresponding Sage files/functions/types are all still called zmod_poly).\n\nThe new pxd file uses the GMP mp_limb_t (etc) types rather than unsigned long (etc). Some search and replace might be needed, or importing the types from gmp.h.",
    "created_at": "2011-12-18T16:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138008",
    "user": "https://github.com/fredrik-johansson"
}
```

Attachment [zmod.patch](tarball://root/attachments/some-uuid/ticket12173/zmod.patch) by @fredrik-johansson created at 2011-12-18 16:55:48

zmod.patch replaces references to zmod_poly with nmod_poly and (hopefully) fixes places where the interface of a function changed. Completely untested at this point, of course.

Some remarks:

I deleted the zmod_poly_pow function implemented in Sage, since FLINT now provides such a function.

There is no longer a _nmod_poly_set_coeff_ui, which was used in one place (creating a polynomial from a list). I replaced it with nmod_poly_set_coeff_ui rather than manipulating coefficients directly, which is a bit slower, but shouldn't matter that much.

nmod_poly_resultant needs to be added in FLINT 2. If we don't get it done, the code calling it could just be commented out to fall back to the default Sage code that already handles the non-prime case.

I didn't change any filenames or Sage types (so the corresponding Sage files/functions/types are all still called zmod_poly).

The new pxd file uses the GMP mp_limb_t (etc) types rather than unsigned long (etc). Some search and replace might be needed, or importing the types from gmp.h.



---

archive/issue_comments_138009.json:
```json
{
    "body": "Attachment [fmpz.patch](tarball://root/attachments/some-uuid/ticket12173/fmpz.patch) by @fredrik-johansson created at 2011-12-18 23:18:29\n\nAdded another patch for fmpz_poly functions.\n\nfmpz_poly.pxi still needs rewriting, and I didn't touch the cases in polynomial_rational_flint.pyx (since that file needs fmpq_poly fixes as well).",
    "created_at": "2011-12-18T23:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138009",
    "user": "https://github.com/fredrik-johansson"
}
```

Attachment [fmpz.patch](tarball://root/attachments/some-uuid/ticket12173/fmpz.patch) by @fredrik-johansson created at 2011-12-18 23:18:29

Added another patch for fmpz_poly functions.

fmpz_poly.pxi still needs rewriting, and I didn't touch the cases in polynomial_rational_flint.pyx (since that file needs fmpq_poly fixes as well).



---

archive/issue_comments_138010.json:
```json
{
    "body": "I just want to let you know that I have incorporated the current state of progress into an installation of Sage at \n\n    /scratch/spancratz/sflint\n\non sage.math.washington.edu.  Step by step, I have gotten rid of some of the problems, but I didn't have enough time last week to finish this.  By all means, please go ahead and continue working on this copy of the work.\n\nBest wishes\n\nSebastian",
    "created_at": "2012-02-28T17:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138010",
    "user": "https://trac.sagemath.org/admin/accounts/users/spancratz"
}
```

I just want to let you know that I have incorporated the current state of progress into an installation of Sage at 

    /scratch/spancratz/sflint

on sage.math.washington.edu.  Step by step, I have gotten rid of some of the problems, but I didn't have enough time last week to finish this.  By all means, please go ahead and continue working on this copy of the work.

Best wishes

Sebastian



---

archive/issue_comments_138011.json:
```json
{
    "body": "That might be a stupid question, but how do I access your working copy?\n\nShould I ask for an account on the mentioned machine (to whom?)?",
    "created_at": "2012-02-28T17:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138011",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

That might be a stupid question, but how do I access your working copy?

Should I ask for an account on the mentioned machine (to whom?)?



---

archive/issue_comments_138012.json:
```json
{
    "body": "You should e-mail wstein`@`gmail.com and say you're working on getting FLINT into Sage.  He'll give you an account on sage.math.washington.edu",
    "created_at": "2012-03-04T05:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138012",
    "user": "https://github.com/roed314"
}
```

You should e-mail wstein`@`gmail.com and say you're working on getting FLINT into Sage.  He'll give you an account on sage.math.washington.edu



---

archive/issue_comments_138013.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages.",
    "created_at": "2012-03-04T05:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138013",
    "user": "https://github.com/roed314"
}
```

Changing component from PLEASE CHANGE to packages.



---

archive/issue_comments_138014.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2012-03-04T05:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138014",
    "user": "https://github.com/roed314"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_138015.json:
```json
{
    "body": "Was the directory lost after the recent sage.math problems ?\nI can't locate a spancratz directory on /scratch...\nI'll have a look at the google groups in case I can find more info there.",
    "created_at": "2012-03-29T10:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138015",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Was the directory lost after the recent sage.math problems ?
I can't locate a spancratz directory on /scratch...
I'll have a look at the google groups in case I can find more info there.



---

archive/issue_comments_138016.json:
```json
{
    "body": "Yes, it seems to be gone.",
    "created_at": "2012-03-29T10:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138016",
    "user": "https://github.com/fredrik-johansson"
}
```

Yes, it seems to be gone.



---

archive/issue_comments_138017.json:
```json
{
    "body": "Any chance that one of you backed it up somewhere else ?",
    "created_at": "2012-03-29T13:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138017",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Any chance that one of you backed it up somewhere else ?



---

archive/issue_comments_138018.json:
```json
{
    "body": "Sebastian says he doesn't have a backup.",
    "created_at": "2012-04-04T23:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138018",
    "user": "https://github.com/roed314"
}
```

Sebastian says he doesn't have a backup.



---

archive/issue_comments_138019.json:
```json
{
    "body": "This new spkg and patch should apply to a clean install of sage-5.0, and almost completely allows building Sage against flint-2.3:\n\nhttp://sage.math.washington.edu/home/fredrik/flint-2.3.spkg\n\nhttp://sage.math.washington.edu/home/fredrik/flint-2.3-sage-5.0.diff\n\nThere is one small remaining issue building Sage: at one point, the definition of ulong in zn_poly.h apparently clashes with the one in flint. A quick workaround for development purposes is to add #ifndef ulong ... #endif in sage/local/include/zn_poly.h. I don't know the best proper fix. But with the workaround,\n\nsage -f flint-2.3.spkg\n\nsage -b\n\nshould work.\n\nWhen starting Sage, there is a link time error (finding fmpz_set_ZZ), so it seems that the NTL interface is not being built or included correctly. Presumably, fixing that, Sage will start up successfully, though most likely there will be some bugs to hunt down...",
    "created_at": "2012-05-24T03:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138019",
    "user": "https://github.com/fredrik-johansson"
}
```

This new spkg and patch should apply to a clean install of sage-5.0, and almost completely allows building Sage against flint-2.3:

http://sage.math.washington.edu/home/fredrik/flint-2.3.spkg

http://sage.math.washington.edu/home/fredrik/flint-2.3-sage-5.0.diff

There is one small remaining issue building Sage: at one point, the definition of ulong in zn_poly.h apparently clashes with the one in flint. A quick workaround for development purposes is to add #ifndef ulong ... #endif in sage/local/include/zn_poly.h. I don't know the best proper fix. But with the workaround,

sage -f flint-2.3.spkg

sage -b

should work.

When starting Sage, there is a link time error (finding fmpz_set_ZZ), so it seems that the NTL interface is not being built or included correctly. Presumably, fixing that, Sage will start up successfully, though most likely there will be some bugs to hunt down...



---

archive/issue_comments_138020.json:
```json
{
    "body": "I've had a very quick look and the spkg needs major simplification.\nMost of the logic which was present is now in the flint configure script.\nI'll try to provide an updated version.\n\nI see that there was some restriction in the previous spkg-install reported by Michael Abshoff on an \"US IIIi\" with GCCC 4.3.2 which is not reflected in the configure script.\nSome reason for this ?\n\nTo answer my own question, by default -funroll-loops is not included by default, which covers the solaris case.",
    "created_at": "2012-05-24T09:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138020",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've had a very quick look and the spkg needs major simplification.
Most of the logic which was present is now in the flint configure script.
I'll try to provide an updated version.

I see that there was some restriction in the previous spkg-install reported by Michael Abshoff on an "US IIIi" with GCCC 4.3.2 which is not reflected in the configure script.
Some reason for this ?

To answer my own question, by default -funroll-loops is not included by default, which covers the solaris case.



---

archive/issue_comments_138021.json:
```json
{
    "body": "I've just reuploaded fredrik patch as an attachment so that it can be easily viewed in trac.",
    "created_at": "2012-05-24T10:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138021",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've just reuploaded fredrik patch as an attachment so that it can be easily viewed in trac.



---

archive/issue_comments_138022.json:
```json
{
    "body": "Attachment [flint-2.3-sage-5.0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.0.patch) by jpflori created at 2012-05-24 10:00:47\n\nFredrik's patch.",
    "created_at": "2012-05-24T10:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138022",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-sage-5.0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.0.patch) by jpflori created at 2012-05-24 10:00:47

Fredrik's patch.



---

archive/issue_comments_138023.json:
```json
{
    "body": "The NTL problem is just that interfaces/NTL-interface.lo is not included into libflint anymore.\nThe configure and Makefile.in files should be modified.\n\nThere was some partial magic added here (*_EXTRAS):\nhttps://github.com/wbhart/flint2/commit/64b5b59977cf1b29bc01faf4d4ff20e121ab7198\nbut removed here:\nhttps://github.com/wbhart/flint2/commit/0103ccbef63781436ad51e060a7adcb0e6b23865\nif I'm not wrong.\n\nViolently changing the Makefile.in to include NTL-interface.lo solves the problem, although this should certainly be included upstream rather than here.",
    "created_at": "2012-05-24T12:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138023",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The NTL problem is just that interfaces/NTL-interface.lo is not included into libflint anymore.
The configure and Makefile.in files should be modified.

There was some partial magic added here (*_EXTRAS):
https://github.com/wbhart/flint2/commit/64b5b59977cf1b29bc01faf4d4ff20e121ab7198
but removed here:
https://github.com/wbhart/flint2/commit/0103ccbef63781436ad51e060a7adcb0e6b23865
if I'm not wrong.

Violently changing the Makefile.in to include NTL-interface.lo solves the problem, although this should certainly be included upstream rather than here.



---

archive/issue_comments_138024.json:
```json
{
    "body": "Now sage launches but I get a crash when quitting due to an undefined symbol flint_stack_cleanup.\nI'll have a look later.",
    "created_at": "2012-05-24T12:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138024",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Now sage launches but I get a crash when quitting due to an undefined symbol flint_stack_cleanup.
I'll have a look later.



---

archive/issue_comments_138025.json:
```json
{
    "body": "Another complication might be that the headers used to be installed into $SAGE_LOCAL/include/FLINT which is quite meaningful because there are a lot of them.\n\nIt would be nice to use the install target, but it would put everything into $S_L/include/.\n\nSomebody has a thought about that?\nModify flint Makefile? Install the headers into $S_L/include/ and modify Sage source (mainly the module thing at the top of Sage and flint*.px* files)? Continue to copy the files by hand?",
    "created_at": "2012-05-24T12:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138025",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Another complication might be that the headers used to be installed into $SAGE_LOCAL/include/FLINT which is quite meaningful because there are a lot of them.

It would be nice to use the install target, but it would put everything into $S_L/include/.

Somebody has a thought about that?
Modify flint Makefile? Install the headers into $S_L/include/ and modify Sage source (mainly the module thing at the top of Sage and flint*.px* files)? Continue to copy the files by hand?



---

archive/issue_comments_138026.json:
```json
{
    "body": "The call to flint_stack_cleanup() should be replaced with a call to _fmpz_cleanup(), I think.\n\nI agree that it would be nice to keep the header files in a subdirectory. Dunno what the best solution is.",
    "created_at": "2012-05-24T13:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138026",
    "user": "https://github.com/fredrik-johansson"
}
```

The call to flint_stack_cleanup() should be replaced with a call to _fmpz_cleanup(), I think.

I agree that it would be nice to keep the header files in a subdirectory. Dunno what the best solution is.



---

archive/issue_comments_138027.json:
```json
{
    "body": "Replying to [comment:19 fredrik.johansson]:\n> I agree that it would be nice to keep the header files in a subdirectory. Dunno what the best solution is.\nMy prefered solution would be that make install puts them in a separate directory by default.\nI'll ask on flint-devel to get bill's preference.",
    "created_at": "2012-05-24T13:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138027",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:19 fredrik.johansson]:
> I agree that it would be nice to keep the header files in a subdirectory. Dunno what the best solution is.
My prefered solution would be that make install puts them in a separate directory by default.
I'll ask on flint-devel to get bill's preference.



---

archive/issue_comments_138028.json:
```json
{
    "body": "Replying to [comment:19 fredrik.johansson]:\n> The call to flint_stack_cleanup() should be replaced with a call to _fmpz_cleanup(), I think.\nAfter quickly looking at the memory management in flint 1.* and flint 2.3, this seems the right solution to me (without real insight nonetheless) and indeed fixes the problem!",
    "created_at": "2012-05-24T16:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138028",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:19 fredrik.johansson]:
> The call to flint_stack_cleanup() should be replaced with a call to _fmpz_cleanup(), I think.
After quickly looking at the memory management in flint 1.* and flint 2.3, this seems the right solution to me (without real insight nonetheless) and indeed fixes the problem!



---

archive/issue_comments_138029.json:
```json
{
    "body": "Now I get a LOT of segfaults.\nFor example, running:\n\n```\nsage: GF(4, 'a')\n```\n",
    "created_at": "2012-05-24T17:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138029",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Now I get a LOT of segfaults.
For example, running:

```
sage: GF(4, 'a')
```




---

archive/issue_comments_138030.json:
```json
{
    "body": "Two things :\n* the order of the structure changed, now exp is before p, not sure this is important...\n* n_factor_t has to be initialized.\n\nWith these changes I can create GF(4)!",
    "created_at": "2012-05-24T17:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138030",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Two things :
* the order of the structure changed, now exp is before p, not sure this is important...
* n_factor_t has to be initialized.

With these changes I can create GF(4)!



---

archive/issue_comments_138031.json:
```json
{
    "body": "The function n_factor is also called in descent_two_isogeny.",
    "created_at": "2012-05-24T17:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138031",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The function n_factor is also called in descent_two_isogeny.



---

archive/issue_comments_138032.json:
```json
{
    "body": "Running make ptest raises a limited number of problem.\nThe first one I saw is quite bad: I get time out caused by some segfaults...\n\nApparently, something is now deallocated twice (I get a double linked blah from glibc, more precisely \"*** glibc detected *** python: corrupted double-linked list: 0x00... ***\").\n(This is not caused by the _fmps_cleanup() call, it also happens without it)\n\nThis is not sytemcan be reproduced by testing ell_tate_curve.py for example.",
    "created_at": "2012-05-25T07:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138032",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Running make ptest raises a limited number of problem.
The first one I saw is quite bad: I get time out caused by some segfaults...

Apparently, something is now deallocated twice (I get a double linked blah from glibc, more precisely "*** glibc detected *** python: corrupted double-linked list: 0x00... ***").
(This is not caused by the _fmps_cleanup() call, it also happens without it)

This is not sytemcan be reproduced by testing ell_tate_curve.py for example.



---

archive/issue_comments_138033.json:
```json
{
    "body": "Aa far as the other bugs are concerned, it seems that #6919 is back???\nAt least, the same doctest fails.",
    "created_at": "2012-05-25T07:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138033",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Aa far as the other bugs are concerned, it seems that #6919 is back???
At least, the same doctest fails.



---

archive/issue_comments_138034.json:
```json
{
    "body": "Replying to [comment:26 jpflori]:\n> Aa far as the other bugs are concerned, it seems that #6919 is back???\n> At least, the same doctest fails.\nIt seems that this is unfortunately the case.\nI'll report on flint-devel.",
    "created_at": "2012-05-25T08:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138034",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:26 jpflori]:
> Aa far as the other bugs are concerned, it seems that #6919 is back???
> At least, the same doctest fails.
It seems that this is unfortunately the case.
I'll report on flint-devel.



---

archive/issue_comments_138035.json:
```json
{
    "body": "About other easy errors:\n* failures in polynomial_zmod_flint are just a change in the behavior of _mul_trunc_opposite which calls nmod_poly_mulhigh\n* failures in combinat/sf/jack are just changes in ordering and normalization\n* a failure in rings.fraction_field_FpT is just a change in a choice of a sqrt, the other error is more mysterious, in fact it is just because of a different normalization (the minus goes into the denominator rather the numerator)... the problem is that equality testing is consequently wrong, or the result of sqrt should be normalized with the corresponding Sage function (note for later, the nmod_poly_cmp defined there should be removed and nmod_poly_equal used instead)\n* the failure in function_field_element is a chang in the choice of a sqrt\n\nThere is a segfault in function_field_ideal in a call to _nmod_poly_xgcd_euclidean\n\nThe error in flint.pyx is mentioned in the previous post.\n\nThe error in jacobian_morphism might be related to the FFT problem, otherwise, I have no idea.\nQuite strangely Q*239 where Q is a point on a jacobian of hyperelliptic curve should return Q because Q is of order 238...\nEvaluating Q*237+Q*2 is ok equal to Q, but Q*2+Q*237 is wrong equal to -Q !!\nThis is not true for 3, but true for 4, so I guess there is a problem when a point is doubled.\n\nAnd the following files (at least) randomly produced memory managment errors (although all test passed):\n* book_stein_modform\n* ell_tate_curve (less often, potentially different problem)\n* ell_padic_field\n* overconvergent/genus0",
    "created_at": "2012-05-25T09:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138035",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

About other easy errors:
* failures in polynomial_zmod_flint are just a change in the behavior of _mul_trunc_opposite which calls nmod_poly_mulhigh
* failures in combinat/sf/jack are just changes in ordering and normalization
* a failure in rings.fraction_field_FpT is just a change in a choice of a sqrt, the other error is more mysterious, in fact it is just because of a different normalization (the minus goes into the denominator rather the numerator)... the problem is that equality testing is consequently wrong, or the result of sqrt should be normalized with the corresponding Sage function (note for later, the nmod_poly_cmp defined there should be removed and nmod_poly_equal used instead)
* the failure in function_field_element is a chang in the choice of a sqrt

There is a segfault in function_field_ideal in a call to _nmod_poly_xgcd_euclidean

The error in flint.pyx is mentioned in the previous post.

The error in jacobian_morphism might be related to the FFT problem, otherwise, I have no idea.
Quite strangely Q*239 where Q is a point on a jacobian of hyperelliptic curve should return Q because Q is of order 238...
Evaluating Q*237+Q*2 is ok equal to Q, but Q*2+Q*237 is wrong equal to -Q !!
This is not true for 3, but true for 4, so I guess there is a problem when a point is doubled.

And the following files (at least) randomly produced memory managment errors (although all test passed):
* book_stein_modform
* ell_tate_curve (less often, potentially different problem)
* ell_padic_field
* overconvergent/genus0



---

archive/issue_comments_138036.json:
```json
{
    "body": "Good work. I'll look at some of the failures tonight.\n\nUntil the FFT gets fixed, we could temporarily disable SS multiplication in _fmpz_poly_mul/low/high to suppress those errors.\n\nDo you have a diff of your edits so far?",
    "created_at": "2012-05-25T09:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138036",
    "user": "https://github.com/fredrik-johansson"
}
```

Good work. I'll look at some of the failures tonight.

Until the FFT gets fixed, we could temporarily disable SS multiplication in _fmpz_poly_mul/low/high to suppress those errors.

Do you have a diff of your edits so far?



---

archive/issue_comments_138037.json:
```json
{
    "body": "Some progress:\nThe nmod_xgcd problem seems to be that it segfaults on constant input (that is polynomials of degree 0), this should be reported on flint-devel as well.",
    "created_at": "2012-05-25T09:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138037",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Some progress:
The nmod_xgcd problem seems to be that it segfaults on constant input (that is polynomials of degree 0), this should be reported on flint-devel as well.



---

archive/issue_comments_138038.json:
```json
{
    "body": "Replying to [comment:30 jpflori]:\n> Some progress:\n> The nmod_xgcd problem seems to be that it segfaults on constant input (that is polynomials of degree 0), this should be reported on flint-devel as well.\n\nAh, great! I love when the segfault is due to \"constant input\" and not \"this specific product of five polynomials of length 2564148\" :-)",
    "created_at": "2012-05-25T09:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138038",
    "user": "https://github.com/fredrik-johansson"
}
```

Replying to [comment:30 jpflori]:
> Some progress:
> The nmod_xgcd problem seems to be that it segfaults on constant input (that is polynomials of degree 0), this should be reported on flint-devel as well.

Ah, great! I love when the segfault is due to "constant input" and not "this specific product of five polynomials of length 2564148" :-)



---

archive/issue_comments_138039.json:
```json
{
    "body": "Replying to [comment:29 fredrik.johansson]:\n\n> Do you have a diff of your edits so far?\nI have.\nI also have to quit my office right now, but I'll quickly copy my working directory and try to upload something usable this afternoon.\nThe patch will surely not be clean, but sufficient to make further testing, because then I'll be away for 3 days (until tuesday morning).",
    "created_at": "2012-05-25T09:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138039",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:29 fredrik.johansson]:

> Do you have a diff of your edits so far?
I have.
I also have to quit my office right now, but I'll quickly copy my working directory and try to upload something usable this afternoon.
The patch will surely not be clean, but sufficient to make further testing, because then I'll be away for 3 days (until tuesday morning).



---

archive/issue_comments_138040.json:
```json
{
    "body": "Sorry, it seems I failed to upload anything...\n\nAnyway, I just found out that you can doctest a file within gdb which will vastly simplify solving the remaining issues!",
    "created_at": "2012-05-29T10:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138040",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Sorry, it seems I failed to upload anything...

Anyway, I just found out that you can doctest a file within gdb which will vastly simplify solving the remaining issues!



---

archive/issue_comments_138041.json:
```json
{
    "body": "Quite strangely, something got broken on my 5.0 install and I was not able to reinstall zn_poly while trying to provide a patched spkg (by the way I just found out #12433).\n\nThe problem seems to be that while building profiler.c, the inclusion of profiler.h is skipped so lots of things are undefined (even stderr!).\nI don't get why yet...\n\nAnyway I just started rebuilding stuff on top of a 5.1.beta0 install, first the updated zn_poly spkg from #12433) and then my wip flint-2.3 package and no more tweaking of zn_poly.h is needed to build flint-2.3, which is good news.\nI'm also able to rebuild zn_poly afterward, so maybe I just did something wrong on the previous install.\n\nFredrik's patch needs some rebasing to apply on top of 5.1.beta0.\nI'll rebase it and also upload the few further changes and an updated spkg I made for testing purposes.",
    "created_at": "2012-05-30T08:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138041",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Quite strangely, something got broken on my 5.0 install and I was not able to reinstall zn_poly while trying to provide a patched spkg (by the way I just found out #12433).

The problem seems to be that while building profiler.c, the inclusion of profiler.h is skipped so lots of things are undefined (even stderr!).
I don't get why yet...

Anyway I just started rebuilding stuff on top of a 5.1.beta0 install, first the updated zn_poly spkg from #12433) and then my wip flint-2.3 package and no more tweaking of zn_poly.h is needed to build flint-2.3, which is good news.
I'm also able to rebuild zn_poly afterward, so maybe I just did something wrong on the previous install.

Fredrik's patch needs some rebasing to apply on top of 5.1.beta0.
I'll rebase it and also upload the few further changes and an updated spkg I made for testing purposes.



---

archive/issue_comments_138042.json:
```json
{
    "body": "Attachment [flint-2.3-sage-5.1.beta0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.1.beta0.patch) by jpflori created at 2012-05-30 08:40:16\n\nRebased patch for 5.1.beta0.",
    "created_at": "2012-05-30T08:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138042",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-sage-5.1.beta0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.1.beta0.patch) by jpflori created at 2012-05-30 08:40:16

Rebased patch for 5.1.beta0.



---

archive/issue_comments_138043.json:
```json
{
    "body": "An updated spkg, including Fredrik's fix for the xgcd segfaults, NTL interface build, header files installation, simplified spkg-* scripts, is available at:\nhttp://perso.telecom-paristech.fr/~flori/sage/flint-2.3.jp.spkg\n\nThis is for testing only.",
    "created_at": "2012-05-30T08:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138043",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

An updated spkg, including Fredrik's fix for the xgcd segfaults, NTL interface build, header files installation, simplified spkg-* scripts, is available at:
http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.jp.spkg

This is for testing only.



---

archive/issue_comments_138044.json:
```json
{
    "body": "On top of my 5.1.beta0 installation (with #12313 and #12877 applied), I get additional failures in\n* number_field.py (random segfault when quitting).\n* heegner.py (146 doctests (!!!) when running make ptest and then just 2 because a 0.0000... became 0 when running the file doctests alone.)",
    "created_at": "2012-05-30T15:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138044",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

On top of my 5.1.beta0 installation (with #12313 and #12877 applied), I get additional failures in
* number_field.py (random segfault when quitting).
* heegner.py (146 doctests (!!!) when running make ptest and then just 2 because a 0.0000... became 0 when running the file doctests alone.)



---

archive/issue_comments_138045.json:
```json
{
    "body": "My bad... the memory problems were indeed caused by the call to _fmpz_cleanup as I found out using valgrind.\n\nI wrote pass instead of return so that the function was still called...",
    "created_at": "2012-05-31T12:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138045",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

My bad... the memory problems were indeed caused by the call to _fmpz_cleanup as I found out using valgrind.

I wrote pass instead of return so that the function was still called...



---

archive/issue_comments_138046.json:
```json
{
    "body": "I'm not sure how everything gets freed when Sage exits but I think I got the culprit (or one of them).\n\nWhen quit_all() in sage.all is called\n- in the beginning free_flint_stack() is called which calls _fmpz_cleanup(),\n- but then there must be other calls to fmpz_poly_clear() for example in ..quaternion_algebra_element._clear_globals(),\nwhence potential double free().\n\nAlso the __dealloc__ methods of the classes based on fmp?_poly call fmp?_clear_poly.\nI don't know when Python objects are deallocated but if this happens after the call to _fmpz_cleanup(), that might be problematic.\n\nAs far as PARI is concerned, the __dealloc__ function of gen objects first checks that the pointer to the PARI object is not 0, maybe the same should be done for Sage objects based on flint objects.\nHowever, calls to fmpz_poly_clear as in quaternion_algebra_element will be more tedious to deal with.\n\nAfter a first experiment, putting the call to free_flint_stack() a little later, just after twisted is closed solves memory corruption when doctesting ell_padic_field.\nThis is quite mysterious to me...",
    "created_at": "2012-05-31T12:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138046",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I'm not sure how everything gets freed when Sage exits but I think I got the culprit (or one of them).

When quit_all() in sage.all is called
- in the beginning free_flint_stack() is called which calls _fmpz_cleanup(),
- but then there must be other calls to fmpz_poly_clear() for example in ..quaternion_algebra_element._clear_globals(),
whence potential double free().

Also the __dealloc__ methods of the classes based on fmp?_poly call fmp?_clear_poly.
I don't know when Python objects are deallocated but if this happens after the call to _fmpz_cleanup(), that might be problematic.

As far as PARI is concerned, the __dealloc__ function of gen objects first checks that the pointer to the PARI object is not 0, maybe the same should be done for Sage objects based on flint objects.
However, calls to fmpz_poly_clear as in quaternion_algebra_element will be more tedious to deal with.

After a first experiment, putting the call to free_flint_stack() a little later, just after twisted is closed solves memory corruption when doctesting ell_padic_field.
This is quite mysterious to me...



---

archive/issue_comments_138047.json:
```json
{
    "body": "Mmm, all of this seems quite more involved...\nThe calls to *_poly_clear should not be problematic, the problem comes from somewhere else.",
    "created_at": "2012-05-31T13:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138047",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Mmm, all of this seems quite more involved...
The calls to *_poly_clear should not be problematic, the problem comes from somewhere else.



---

archive/issue_comments_138048.json:
```json
{
    "body": "Here is some progress hopefully:\nthe easiiest way I found to reproduce the memory corruption error is through doctesting sage/schemes/elliptic_curves/ell_padic_field.py\n\nWithin this file the problem seems to come (meaning that if I remove it I cannont repoduce the bug in a reasonable time) from the line\n\n```\nuN = (1 + h(x0)/y0**(2*p)).sqrt()\n```\n\nand more precisely from the evaluation\n\n```\nh(x0)\n```\n\nAND because it is done within a locally defined function whereas h is defined in the outer function.\n\nI'm not sure all the memory corruption problems come from such a case, but at least sage/schemes/elliptic_curves/padics.py where I've seen one time such a bug and sage/schemes/elliptic_curves/ell_tate_curve.py where I've seen it several times use similarly locally defined functions.",
    "created_at": "2012-06-01T08:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138048",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Here is some progress hopefully:
the easiiest way I found to reproduce the memory corruption error is through doctesting sage/schemes/elliptic_curves/ell_padic_field.py

Within this file the problem seems to come (meaning that if I remove it I cannont repoduce the bug in a reasonable time) from the line

```
uN = (1 + h(x0)/y0**(2*p)).sqrt()
```

and more precisely from the evaluation

```
h(x0)
```

AND because it is done within a locally defined function whereas h is defined in the outer function.

I'm not sure all the memory corruption problems come from such a case, but at least sage/schemes/elliptic_curves/padics.py where I've seen one time such a bug and sage/schemes/elliptic_curves/ell_tate_curve.py where I've seen it several times use similarly locally defined functions.



---

archive/issue_comments_138049.json:
```json
{
    "body": "That's really strange. Does building flint in reentrant mode change anything?",
    "created_at": "2012-06-01T09:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138049",
    "user": "https://github.com/fredrik-johansson"
}
```

That's really strange. Does building flint in reentrant mode change anything?



---

archive/issue_comments_138050.json:
```json
{
    "body": "I think that unfortunately the real reason is deeper but the error occurs only in this situation...\nI'll post some valgrind logs and point out what I think might be hintful.",
    "created_at": "2012-06-01T09:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138050",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think that unfortunately the real reason is deeper but the error occurs only in this situation...
I'll post some valgrind logs and point out what I think might be hintful.



---

archive/issue_comments_138051.json:
```json
{
    "body": "Replying to [comment:42 fredrik.johansson]:\n> That's really strange. Does building flint in reentrant mode change anything?\nCompiling flint in reentrant mode seems to \"solve\" the ell_padic_field error.\nI just launched \"make ptest\" and will report about that when it finishes.",
    "created_at": "2012-06-01T11:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138051",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:42 fredrik.johansson]:
> That's really strange. Does building flint in reentrant mode change anything?
Compiling flint in reentrant mode seems to "solve" the ell_padic_field error.
I just launched "make ptest" and will report about that when it finishes.



---

archive/issue_comments_138052.json:
```json
{
    "body": "Rebase on 5.1.beta1 (this is basically the original 5.0 patch without fuzz)",
    "created_at": "2012-06-01T11:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138052",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Rebase on 5.1.beta1 (this is basically the original 5.0 patch without fuzz)



---

archive/issue_comments_138053.json:
```json
{
    "body": "Attachment [flint-2.3-sage-5.1.beta1.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.1.beta1.patch) by jpflori created at 2012-06-01 11:42:15\n\nSome further changes. For testing only.",
    "created_at": "2012-06-01T11:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138053",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-sage-5.1.beta1.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.1.beta1.patch) by jpflori created at 2012-06-01 11:42:15

Some further changes. For testing only.



---

archive/issue_comments_138054.json:
```json
{
    "body": "Attachment [flint-2.3-jp.2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-jp.2.patch) by jpflori created at 2012-06-01 11:43:27\n\nDoctest of ell_padic_field.py on vanilla 5.1.beta1.",
    "created_at": "2012-06-01T11:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138054",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-jp.2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-jp.2.patch) by jpflori created at 2012-06-01 11:43:27

Doctest of ell_padic_field.py on vanilla 5.1.beta1.



---

archive/issue_comments_138055.json:
```json
{
    "body": "Attachment [ell_padic_field-5.1.beta1.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1.valgrind) by jpflori created at 2012-06-01 11:44:07\n\nDoctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg.",
    "created_at": "2012-06-01T11:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138055",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [ell_padic_field-5.1.beta1.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1.valgrind) by jpflori created at 2012-06-01 11:44:07

Doctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg.



---

archive/issue_comments_138056.json:
```json
{
    "body": "Attachment [ell_padic_field-5.1.beta1+flint2.3.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1+flint2.3.valgrind) by jpflori created at 2012-06-01 11:44:36\n\nDoctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg + new flint spkg.",
    "created_at": "2012-06-01T11:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138056",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [ell_padic_field-5.1.beta1+flint2.3.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1+flint2.3.valgrind) by jpflori created at 2012-06-01 11:44:36

Doctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg + new flint spkg.



---

archive/issue_comments_138057.json:
```json
{
    "body": "Attachment [ell_padic_field-5.1.beta1+flint2.3+move.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1+flint2.3+move.valgrind) by jpflori created at 2012-06-01 11:45:04\n\nDoctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg + new flint spkg + moving the \"h =\" line.",
    "created_at": "2012-06-01T11:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138057",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [ell_padic_field-5.1.beta1+flint2.3+move.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1+flint2.3+move.valgrind) by jpflori created at 2012-06-01 11:45:04

Doctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg + new flint spkg + moving the "h =" line.



---

archive/issue_comments_138058.json:
```json
{
    "body": "Attachment [ell_padic_field-5.1.beta1+flint2.3+reentrant.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1+flint2.3+reentrant.valgrind) by jpflori created at 2012-06-01 11:45:41\n\nDoctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg + new flint spkg compiled reentrant.",
    "created_at": "2012-06-01T11:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138058",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [ell_padic_field-5.1.beta1+flint2.3+reentrant.valgrind](tarball://root/attachments/some-uuid/ticket12173/ell_padic_field-5.1.beta1+flint2.3+reentrant.valgrind) by jpflori created at 2012-06-01 11:45:41

Doctest of ell_padic_field.py on 5.1.beta1 + new zn_poly spkg + new flint spkg compiled reentrant.



---

archive/issue_comments_138059.json:
```json
{
    "body": "Replying to [comment:44 jpflori]:\n> Replying to [comment:42 fredrik.johansson]:\n> > That's really strange. Does building flint in reentrant mode change anything?\n> Compiling flint in reentrant mode seems to \"solve\" the ell_padic_field error.\n> I just launched \"make ptest\" and will report about that when it finishes.\nIndeed, make ptest only returns non memory related errors.",
    "created_at": "2012-06-01T12:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138059",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:44 jpflori]:
> Replying to [comment:42 fredrik.johansson]:
> > That's really strange. Does building flint in reentrant mode change anything?
> Compiling flint in reentrant mode seems to "solve" the ell_padic_field error.
> I just launched "make ptest" and will report about that when it finishes.
Indeed, make ptest only returns non memory related errors.



---

archive/issue_comments_138060.json:
```json
{
    "body": "Here is what might be the important part from the valgrind log of 5.1.beta1 + zn_poly + flint (single)\n\n```\n==17534== Invalid read of size 8\n==17534==    at 0x829DE0D: __gmpn_copyi (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/local/lib/libgmp.so.7.4.0)\n==17534==    by 0x8256F49: __gmpz_export (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/local/lib/libgmp.so.7.4.0)\n==17534==    by 0x1318FD2C: __pyx_f_4sage_4libs_4pari_3gen_12PariInstance__new_GEN_from_mpz_t (gen.c:43564)\n==17534==    by 0x131B31E2: __pyx_f_4sage_4libs_4pari_3gen_12PariInstance_new_gen_from_padic (gen.c:43941)\n==17534==    by 0x1DBFF444: __pyx_f_4sage_5rings_6padics_29padic_capped_relative_element_26pAdicCappedRelativeElement__to_gen (padic_capped_relative_element.c:15445)\n==17534==    by 0x1DBFECED: __pyx_pf_4sage_5rings_6padics_29padic_capped_relative_element_26pAdicCappedRelativeElement_25_pari_ (padic_capped_relative_element.c:15492)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x131ECF4D: __pyx_pf_4sage_4libs_4pari_3gen_12PariInstance_14__call__ (gen.c:44625)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x1D5A9CDB: __pyx_pf_4sage_5rings_6padics_21padic_generic_element_19pAdicGenericElement_19square_root (padic_generic_element.c:7417)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x1D398D26: __pyx_pf_4sage_5rings_6padics_21local_generic_element_19LocalGenericElement_6sqrt (local_generic_element.c:2604)\n==17534==    by 0x4F20DBC: PyEval_EvalFrameEx (ceval.c:4013)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4F20690: PyEval_EvalFrameEx (ceval.c:4109)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4F20690: PyEval_EvalFrameEx (ceval.c:4109)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4F22551: PyEval_EvalCode (ceval.c:667)\n==17534==    by 0x4F20C5E: PyEval_EvalFrameEx (ceval.c:4710)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4EA53DB: function_call (funcobject.c:526)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x4E8AD0E: instancemethod_call (classobject.c:2578)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==  Address 0x2f78a098 is 0 bytes after a block of size 8 alloc'd\n==17534==    at 0x4C2B313: malloc (vg_replace_malloc.c:263)\n==17534==    by 0x75DF272: sage_malloc (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/devel/sage-main/c_lib/libcsage.so)\n==17534==    by 0x75DF30D: sage_mpir_malloc (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/devel/sage-main/c_lib/libcsage.so)\n==17534==    by 0x14BDA9E9: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:33356)\n==17534==    by 0x14BFAB8A: __pyx_f_4sage_5rings_7integer_7Integer__valuation (integer.c:21279)\n==17534==    by 0x14BDB3F6: __pyx_pf_4sage_5rings_7integer_7Integer_65valuation (integer.c:21643)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x1DC06CF3: __pyx_pf_4sage_5rings_6padics_29padic_capped_relative_element_26pAdicCappedRelativeElement_6__pow__ (padic_capped_relative_element.c:9477)\n==17534==    by 0x4E78891: ternary_op.isra.9 (abstract.c:1065)\n==17534==    by 0x4F1CA3C: PyEval_EvalFrameEx (ceval.c:1254)\n==17534==    by 0x4F21260: PyEval_EvalFrameEx (ceval.c:4099)\n==17534==    by 0x4F21260: PyEval_EvalFrameEx (ceval.c:4099)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4EA53DB: function_call (funcobject.c:526)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x4E8AD0E: instancemethod_call (classobject.c:2578)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x4F1F46C: PyEval_EvalFrameEx (ceval.c:4231)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4EA53DB: function_call (funcobject.c:526)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x4E8AD0E: instancemethod_call (classobject.c:2578)\n==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)\n==17534==    by 0x4EDE2AF: slot_tp_init (typeobject.c:5657)\n==17534==    by 0x4EDA0A7: type_call (typeobject.c:737)\n==17534== \n==17534== Invalid write of size 8\n==17534==    at 0x14E76501: _fmpz_clear_mpz (fmpz.c:78)\n==17534==    by 0x14E86E2B: fmpz_poly_clear (fmpz.h:75)\n==17534==    by 0x1CD20BB8: __pyx_tp_dealloc_4sage_5rings_10polynomial_30polynomial_integer_dense_flint_Polynomial_integer_dense_flint(_object*) (polynomial_integer_dense_flint.cpp:4390)\n==17534==    by 0x4EB6F6E: dict_dealloc (dictobject.c:985)\n==17534==    by 0x4ED5EF3: subtype_dealloc (typeobject.c:999)\n==17534==    by 0x4E88E6D: cell_dealloc (cellobject.c:50)\n==17534==    by 0x4ED3282: tupledealloc (tupleobject.c:220)\n==17534==    by 0x4EA5646: func_dealloc (funcobject.c:461)\n==17534==    by 0x4EB8B1A: PyDict_Clear (dictobject.c:891)\n==17534==    by 0x4EB8C78: dict_tp_clear (dictobject.c:2088)\n==17534==    by 0x4F593B6: collect (gcmodule.c:769)\n==17534==    by 0x4F59F27: _PyObject_GC_Malloc (gcmodule.c:996)\n==17534==    by 0x4F59F8D: _PyObject_GC_NewVar (gcmodule.c:1477)\n==17534==    by 0x4ED374D: PyTuple_New (tupleobject.c:90)\n==17534==    by 0x4F3D20D: r_object (marshal.c:874)\n==17534==    by 0x4F3D743: r_object (marshal.c:1013)\n==17534==    by 0x4F3D254: r_object (marshal.c:880)\n==17534==    by 0x4F3D743: r_object (marshal.c:1013)\n==17534==    by 0x4F3FB47: PyMarshal_ReadObjectFromString (marshal.c:1181)\n==17534==    by 0x4F3FC2B: PyMarshal_ReadLastObjectFromFile (marshal.c:1142)\n==17534==    by 0x4F398F4: load_source_module (import.c:773)\n==17534==    by 0x4F3A97B: import_submodule (import.c:2596)\n==17534==    by 0x4F3AEFF: ensure_fromlist (import.c:2507)\n==17534==    by 0x4F3B393: import_module_level.isra.9 (import.c:2175)\n==17534==    by 0x4F3B849: PyImport_ImportModuleLevel (import.c:2189)\n==17534==  Address 0x60fac08 is 728 bytes inside a block of size 1,024 free'd\n==17534==    at 0x4C2A654: free (vg_replace_malloc.c:427)\n==17534==    by 0x14E765B0: _fmpz_cleanup (fmpz.c:88)\n==17534==    by 0x3C310E4A: __pyx_pf_4sage_4libs_5flint_5flint_free_flint_stack (flint.c:447)\n==17534==    by 0x4F20B52: PyEval_EvalFrameEx (ceval.c:3997)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4F20690: PyEval_EvalFrameEx (ceval.c:4109)\n==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)\n==17534==    by 0x4F22551: PyEval_EvalCode (ceval.c:667)\n==17534==    by 0x4F44CEF: PyRun_FileExFlags (pythonrun.c:1346)\n==17534==    by 0x4F4578E: PyRun_SimpleFileExFlags (pythonrun.c:936)\n==17534==    by 0x4F586B4: Py_Main (main.c:599)\n==17534==    by 0x544876C: (below main) (libc-start.c:226)\n```\n",
    "created_at": "2012-06-01T12:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138060",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Here is what might be the important part from the valgrind log of 5.1.beta1 + zn_poly + flint (single)

```
==17534== Invalid read of size 8
==17534==    at 0x829DE0D: __gmpn_copyi (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/local/lib/libgmp.so.7.4.0)
==17534==    by 0x8256F49: __gmpz_export (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/local/lib/libgmp.so.7.4.0)
==17534==    by 0x1318FD2C: __pyx_f_4sage_4libs_4pari_3gen_12PariInstance__new_GEN_from_mpz_t (gen.c:43564)
==17534==    by 0x131B31E2: __pyx_f_4sage_4libs_4pari_3gen_12PariInstance_new_gen_from_padic (gen.c:43941)
==17534==    by 0x1DBFF444: __pyx_f_4sage_5rings_6padics_29padic_capped_relative_element_26pAdicCappedRelativeElement__to_gen (padic_capped_relative_element.c:15445)
==17534==    by 0x1DBFECED: __pyx_pf_4sage_5rings_6padics_29padic_capped_relative_element_26pAdicCappedRelativeElement_25_pari_ (padic_capped_relative_element.c:15492)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x131ECF4D: __pyx_pf_4sage_4libs_4pari_3gen_12PariInstance_14__call__ (gen.c:44625)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x1D5A9CDB: __pyx_pf_4sage_5rings_6padics_21padic_generic_element_19pAdicGenericElement_19square_root (padic_generic_element.c:7417)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x1D398D26: __pyx_pf_4sage_5rings_6padics_21local_generic_element_19LocalGenericElement_6sqrt (local_generic_element.c:2604)
==17534==    by 0x4F20DBC: PyEval_EvalFrameEx (ceval.c:4013)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4F20690: PyEval_EvalFrameEx (ceval.c:4109)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4F20690: PyEval_EvalFrameEx (ceval.c:4109)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4F22551: PyEval_EvalCode (ceval.c:667)
==17534==    by 0x4F20C5E: PyEval_EvalFrameEx (ceval.c:4710)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4EA53DB: function_call (funcobject.c:526)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x4E8AD0E: instancemethod_call (classobject.c:2578)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==  Address 0x2f78a098 is 0 bytes after a block of size 8 alloc'd
==17534==    at 0x4C2B313: malloc (vg_replace_malloc.c:263)
==17534==    by 0x75DF272: sage_malloc (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/devel/sage-main/c_lib/libcsage.so)
==17534==    by 0x75DF30D: sage_mpir_malloc (in /media/local/flori/sage/sage-5.1.beta1+flint-2.3/devel/sage-main/c_lib/libcsage.so)
==17534==    by 0x14BDA9E9: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:33356)
==17534==    by 0x14BFAB8A: __pyx_f_4sage_5rings_7integer_7Integer__valuation (integer.c:21279)
==17534==    by 0x14BDB3F6: __pyx_pf_4sage_5rings_7integer_7Integer_65valuation (integer.c:21643)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x1DC06CF3: __pyx_pf_4sage_5rings_6padics_29padic_capped_relative_element_26pAdicCappedRelativeElement_6__pow__ (padic_capped_relative_element.c:9477)
==17534==    by 0x4E78891: ternary_op.isra.9 (abstract.c:1065)
==17534==    by 0x4F1CA3C: PyEval_EvalFrameEx (ceval.c:1254)
==17534==    by 0x4F21260: PyEval_EvalFrameEx (ceval.c:4099)
==17534==    by 0x4F21260: PyEval_EvalFrameEx (ceval.c:4099)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4EA53DB: function_call (funcobject.c:526)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x4E8AD0E: instancemethod_call (classobject.c:2578)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x4F1F46C: PyEval_EvalFrameEx (ceval.c:4231)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4EA53DB: function_call (funcobject.c:526)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x4E8AD0E: instancemethod_call (classobject.c:2578)
==17534==    by 0x4E7D5B2: PyObject_Call (abstract.c:2529)
==17534==    by 0x4EDE2AF: slot_tp_init (typeobject.c:5657)
==17534==    by 0x4EDA0A7: type_call (typeobject.c:737)
==17534== 
==17534== Invalid write of size 8
==17534==    at 0x14E76501: _fmpz_clear_mpz (fmpz.c:78)
==17534==    by 0x14E86E2B: fmpz_poly_clear (fmpz.h:75)
==17534==    by 0x1CD20BB8: __pyx_tp_dealloc_4sage_5rings_10polynomial_30polynomial_integer_dense_flint_Polynomial_integer_dense_flint(_object*) (polynomial_integer_dense_flint.cpp:4390)
==17534==    by 0x4EB6F6E: dict_dealloc (dictobject.c:985)
==17534==    by 0x4ED5EF3: subtype_dealloc (typeobject.c:999)
==17534==    by 0x4E88E6D: cell_dealloc (cellobject.c:50)
==17534==    by 0x4ED3282: tupledealloc (tupleobject.c:220)
==17534==    by 0x4EA5646: func_dealloc (funcobject.c:461)
==17534==    by 0x4EB8B1A: PyDict_Clear (dictobject.c:891)
==17534==    by 0x4EB8C78: dict_tp_clear (dictobject.c:2088)
==17534==    by 0x4F593B6: collect (gcmodule.c:769)
==17534==    by 0x4F59F27: _PyObject_GC_Malloc (gcmodule.c:996)
==17534==    by 0x4F59F8D: _PyObject_GC_NewVar (gcmodule.c:1477)
==17534==    by 0x4ED374D: PyTuple_New (tupleobject.c:90)
==17534==    by 0x4F3D20D: r_object (marshal.c:874)
==17534==    by 0x4F3D743: r_object (marshal.c:1013)
==17534==    by 0x4F3D254: r_object (marshal.c:880)
==17534==    by 0x4F3D743: r_object (marshal.c:1013)
==17534==    by 0x4F3FB47: PyMarshal_ReadObjectFromString (marshal.c:1181)
==17534==    by 0x4F3FC2B: PyMarshal_ReadLastObjectFromFile (marshal.c:1142)
==17534==    by 0x4F398F4: load_source_module (import.c:773)
==17534==    by 0x4F3A97B: import_submodule (import.c:2596)
==17534==    by 0x4F3AEFF: ensure_fromlist (import.c:2507)
==17534==    by 0x4F3B393: import_module_level.isra.9 (import.c:2175)
==17534==    by 0x4F3B849: PyImport_ImportModuleLevel (import.c:2189)
==17534==  Address 0x60fac08 is 728 bytes inside a block of size 1,024 free'd
==17534==    at 0x4C2A654: free (vg_replace_malloc.c:427)
==17534==    by 0x14E765B0: _fmpz_cleanup (fmpz.c:88)
==17534==    by 0x3C310E4A: __pyx_pf_4sage_4libs_5flint_5flint_free_flint_stack (flint.c:447)
==17534==    by 0x4F20B52: PyEval_EvalFrameEx (ceval.c:3997)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4F20690: PyEval_EvalFrameEx (ceval.c:4109)
==17534==    by 0x4F22414: PyEval_EvalCodeEx (ceval.c:3253)
==17534==    by 0x4F22551: PyEval_EvalCode (ceval.c:667)
==17534==    by 0x4F44CEF: PyRun_FileExFlags (pythonrun.c:1346)
==17534==    by 0x4F4578E: PyRun_SimpleFileExFlags (pythonrun.c:936)
==17534==    by 0x4F586B4: Py_Main (main.c:599)
==17534==    by 0x544876C: (below main) (libc-start.c:226)
```




---

archive/issue_comments_138061.json:
```json
{
    "body": "The first Invalid read of size 8 is likely not a bug. On various platforms, mpn_copyi relies on page boundaries being aligned to a multiple of 16 bytes so that it can safely read an extra 8 bytes, IIRC. (This pops up all over the place when valgrinding flint unit tests, and it's convenient to add it to the valgrind suppression file.)\n\nThe second one has to be what it looks like: some polynomial lives until after _fmpz_cleanup has been called.\n\nSo the question is how we can guarantee that all Python objects referencing flint objects get deallocated before _fmpz_cleanup is called. \n\nIf this is impossible, I guess we could compile flint in reentrant mode for Sage (but this would slow things down, unfortunately). \n\nOne possibility is that we change _fmpz_cleanup to free all mpz limb data but leave the mpz array. This might still be a bit fragile, but if it works, it should solve the problem of polluting valgrind logs since there will only be one large block of unfreed memory.\n\nWe must also have this problem with flint_compute_primes.\n\nDoes Sage free the MPFR caches on exit, and if so where?\n\nPerhaps this should be brought to sage-devel.",
    "created_at": "2012-06-01T13:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138061",
    "user": "https://github.com/fredrik-johansson"
}
```

The first Invalid read of size 8 is likely not a bug. On various platforms, mpn_copyi relies on page boundaries being aligned to a multiple of 16 bytes so that it can safely read an extra 8 bytes, IIRC. (This pops up all over the place when valgrinding flint unit tests, and it's convenient to add it to the valgrind suppression file.)

The second one has to be what it looks like: some polynomial lives until after _fmpz_cleanup has been called.

So the question is how we can guarantee that all Python objects referencing flint objects get deallocated before _fmpz_cleanup is called. 

If this is impossible, I guess we could compile flint in reentrant mode for Sage (but this would slow things down, unfortunately). 

One possibility is that we change _fmpz_cleanup to free all mpz limb data but leave the mpz array. This might still be a bit fragile, but if it works, it should solve the problem of polluting valgrind logs since there will only be one large block of unfreed memory.

We must also have this problem with flint_compute_primes.

Does Sage free the MPFR caches on exit, and if so where?

Perhaps this should be brought to sage-devel.



---

archive/issue_comments_138062.json:
```json
{
    "body": "Replying to [comment:48 fredrik.johansson]:\n> Does Sage free the MPFR caches on exit, and if so where?\n\nActually, this is irrelevant, because it can't cause the same kind of errors.",
    "created_at": "2012-06-01T13:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138062",
    "user": "https://github.com/fredrik-johansson"
}
```

Replying to [comment:48 fredrik.johansson]:
> Does Sage free the MPFR caches on exit, and if so where?

Actually, this is irrelevant, because it can't cause the same kind of errors.



---

archive/issue_comments_138063.json:
```json
{
    "body": "Replying to [comment:48 fredrik.johansson]:\n> The first Invalid read of size 8 is likely not a bug. On various platforms, mpn_copyi relies on page boundaries being aligned to a multiple of 16 bytes so that it can safely read an extra 8 bytes, IIRC. (This pops up all over the place when valgrinding flint unit tests, and it's convenient to add it to the valgrind suppression file.)\nThanks, I wasn't aware of that.\n> \n> The second one has to be what it looks like: some polynomial lives until after _fmpz_cleanup has been called.\n> \n> So the question is how we can guarantee that all Python objects referencing flint objects get deallocated before _fmpz_cleanup is called. \nI tried to modify the __dealloc__ methods of all classes involving flint polynomials and in the different files directly using them by first checking that the pointer is not 0 before calling the clear function, but it did not solve the problem.\nSo either I forgot some of them or my test was stupid (I just copied the idea from the PARI's GEN class, I didn't actually think).\n> \n> If this is impossible, I guess we could compile flint in reentrant mode for Sage (but this would slow things down, unfortunately). \nSlowing down the library would not be that great.\nAs i mentioned earlier, jsut moving the call to _flint_cleanup within quit_sage solves the problem, even though this is surely not the \"right\" solution.\nI'm not convinced compiling flint in reentrant mode would be although I have no real knowledge of reentrancy.\n> \n> One possibility is that we change _fmpz_cleanup to free all mpz limb data but leave the mpz array. This might still be a bit fragile, but if it works, it should solve the problem of polluting valgrind logs since there will only be one large block of unfreed memory.\n> \n> We must also have this problem with flint_compute_primes.\n> \n> Does Sage free the MPFR caches on exit, and if so where?\nDeallocation is done by quit_sage() defined in $SAGE_ROOT/devel/sage/sage/all.py\n\nDifferent libraries are concerned, e.g. PARI, but MPFR is not.\nPotentially, and if this was possible, this was just forgotten.\n> \n> Perhaps this should be brought to sage-devel.",
    "created_at": "2012-06-01T13:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138063",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:48 fredrik.johansson]:
> The first Invalid read of size 8 is likely not a bug. On various platforms, mpn_copyi relies on page boundaries being aligned to a multiple of 16 bytes so that it can safely read an extra 8 bytes, IIRC. (This pops up all over the place when valgrinding flint unit tests, and it's convenient to add it to the valgrind suppression file.)
Thanks, I wasn't aware of that.
> 
> The second one has to be what it looks like: some polynomial lives until after _fmpz_cleanup has been called.
> 
> So the question is how we can guarantee that all Python objects referencing flint objects get deallocated before _fmpz_cleanup is called. 
I tried to modify the __dealloc__ methods of all classes involving flint polynomials and in the different files directly using them by first checking that the pointer is not 0 before calling the clear function, but it did not solve the problem.
So either I forgot some of them or my test was stupid (I just copied the idea from the PARI's GEN class, I didn't actually think).
> 
> If this is impossible, I guess we could compile flint in reentrant mode for Sage (but this would slow things down, unfortunately). 
Slowing down the library would not be that great.
As i mentioned earlier, jsut moving the call to _flint_cleanup within quit_sage solves the problem, even though this is surely not the "right" solution.
I'm not convinced compiling flint in reentrant mode would be although I have no real knowledge of reentrancy.
> 
> One possibility is that we change _fmpz_cleanup to free all mpz limb data but leave the mpz array. This might still be a bit fragile, but if it works, it should solve the problem of polluting valgrind logs since there will only be one large block of unfreed memory.
> 
> We must also have this problem with flint_compute_primes.
> 
> Does Sage free the MPFR caches on exit, and if so where?
Deallocation is done by quit_sage() defined in $SAGE_ROOT/devel/sage/sage/all.py

Different libraries are concerned, e.g. PARI, but MPFR is not.
Potentially, and if this was possible, this was just forgotten.
> 
> Perhaps this should be brought to sage-devel.



---

archive/issue_comments_138064.json:
```json
{
    "body": "Replying to [comment:50 jpflori]:\n> or my test was stupid (I just copied the idea from the PARI's GEN class, I didn't actually think).\nThis was surely the case :)",
    "created_at": "2012-06-01T13:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138064",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:50 jpflori]:
> or my test was stupid (I just copied the idea from the PARI's GEN class, I didn't actually think).
This was surely the case :)



---

archive/issue_comments_138065.json:
```json
{
    "body": "I do think moving the _fmpz_cleanup call within quit_sage is the correct solution if it does work.\n\nIf it doesn't work, that means some part of Sage is hanging on to some Python objects, and that code should arguably be fixed so that they can be freed first (perhaps with an explicit call).",
    "created_at": "2012-06-01T13:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138065",
    "user": "https://github.com/fredrik-johansson"
}
```

I do think moving the _fmpz_cleanup call within quit_sage is the correct solution if it does work.

If it doesn't work, that means some part of Sage is hanging on to some Python objects, and that code should arguably be fixed so that they can be freed first (perhaps with an explicit call).



---

archive/issue_comments_138066.json:
```json
{
    "body": "Replying to [comment:52 fredrik.johansson]:\n> I do think moving the _fmpz_cleanup call within quit_sage is the correct solution if it does work.\nI'm quite ok with this decision, although, as I pointed before, I have no idea of when Python/Sage objects actually get deallocated, so this might be a flaky solution.\n\nNow I'm getting a little lost:\nI have trouble to understand how the error (in the different forms it takes, I assumed it was actually an underlying \"double free\") can be caused by a call to fmpz_poly_clean after _fmpz_cleanup was called.\nIndeed, all fmpz_poly_clean does is to deallocate the space needed to store pointers to the coefficients and write in the fmpz_unused_arr that the coeff itself can be reused.\nThis array was already deallocated by _fmpz_cleanup, so we end up writing somewhere we should not really, but whatever should I say: it is quite unlikely that this will actually break something.\n\nSorry if that sounds stupid or is deeply wrong, but I prefer to be sure everything is clear in my mind.",
    "created_at": "2012-06-01T14:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138066",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:52 fredrik.johansson]:
> I do think moving the _fmpz_cleanup call within quit_sage is the correct solution if it does work.
I'm quite ok with this decision, although, as I pointed before, I have no idea of when Python/Sage objects actually get deallocated, so this might be a flaky solution.

Now I'm getting a little lost:
I have trouble to understand how the error (in the different forms it takes, I assumed it was actually an underlying "double free") can be caused by a call to fmpz_poly_clean after _fmpz_cleanup was called.
Indeed, all fmpz_poly_clean does is to deallocate the space needed to store pointers to the coefficients and write in the fmpz_unused_arr that the coeff itself can be reused.
This array was already deallocated by _fmpz_cleanup, so we end up writing somewhere we should not really, but whatever should I say: it is quite unlikely that this will actually break something.

Sorry if that sounds stupid or is deeply wrong, but I prefer to be sure everything is clear in my mind.



---

archive/issue_comments_138067.json:
```json
{
    "body": "fmpz_poly_clear calls fmpz_clear on all its coefficients. fmpz_clear adds the pointer to the unused array to make it available for subsequent reuse. So we can't deallocate fmpz_unused_arr until all fmpz_clear calls have been made.",
    "created_at": "2012-06-01T15:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138067",
    "user": "https://github.com/fredrik-johansson"
}
```

fmpz_poly_clear calls fmpz_clear on all its coefficients. fmpz_clear adds the pointer to the unused array to make it available for subsequent reuse. So we can't deallocate fmpz_unused_arr until all fmpz_clear calls have been made.



---

archive/issue_comments_138068.json:
```json
{
    "body": "Ok, but then some fmpz won't be freed and that's all.\nThis won't lead to any segfault, memory error or horrible breaks.\n\nIn case someone actually used Sage in library mode, and played at launching and closing it several times, that would lead to memory leaks (surely among a lot of other ones), but nothing more.\n\nAnd I do not see any problematic calls to fmpz_clear within Sage.\nThe few ones (its definition within fmpz.pxi, 4 calls in polynomial_integer_dense_flint.pyx and one call in quaternion_algebra_element.pyx) are typically made on local variables which are allocated and freed within functions.",
    "created_at": "2012-06-01T15:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138068",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, but then some fmpz won't be freed and that's all.
This won't lead to any segfault, memory error or horrible breaks.

In case someone actually used Sage in library mode, and played at launching and closing it several times, that would lead to memory leaks (surely among a lot of other ones), but nothing more.

And I do not see any problematic calls to fmpz_clear within Sage.
The few ones (its definition within fmpz.pxi, 4 calls in polynomial_integer_dense_flint.pyx and one call in quaternion_algebra_element.pyx) are typically made on local variables which are allocated and freed within functions.



---

archive/issue_comments_138069.json:
```json
{
    "body": "It (calling some flint clear function after _fmpz_cleanup) can segfault -- fmpz_clear ends up writing to fmpz_unused_arr, and that array might have been freed.\n\nAny explicit \"local\" calls in Sage should be fine -- presumably those will only be triggered by explicit computation. What could go wrong is that Sage say caches some polynomial in some coercion or IO code somewhere, and due to some cyclic reference the cache doesn't gets deallocated until the Python interpreter shuts down (i.e. after having already gone through sage_exit).",
    "created_at": "2012-06-01T15:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138069",
    "user": "https://github.com/fredrik-johansson"
}
```

It (calling some flint clear function after _fmpz_cleanup) can segfault -- fmpz_clear ends up writing to fmpz_unused_arr, and that array might have been freed.

Any explicit "local" calls in Sage should be fine -- presumably those will only be triggered by explicit computation. What could go wrong is that Sage say caches some polynomial in some coercion or IO code somewhere, and due to some cyclic reference the cache doesn't gets deallocated until the Python interpreter shuts down (i.e. after having already gone through sage_exit).



---

archive/issue_comments_138070.json:
```json
{
    "body": "Replying to [comment:56 fredrik.johansson]:\n> It (calling some flint clear function after _fmpz_cleanup) can segfault -- fmpz_clear ends up writing to fmpz_unused_arr, and that array might have been freed.\nI agree with that.\nI would have just expected it to happen less often, especially that it doesn't segfault but return errors typical of a double free (from glibc, which seems to me even more unfortunate than getting a nice segfault).\nI indeed get an error every time I doctest ell_padic_field.py",
    "created_at": "2012-06-01T15:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138070",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:56 fredrik.johansson]:
> It (calling some flint clear function after _fmpz_cleanup) can segfault -- fmpz_clear ends up writing to fmpz_unused_arr, and that array might have been freed.
I agree with that.
I would have just expected it to happen less often, especially that it doesn't segfault but return errors typical of a double free (from glibc, which seems to me even more unfortunate than getting a nice segfault).
I indeed get an error every time I doctest ell_padic_field.py



---

archive/issue_comments_138071.json:
```json
{
    "body": "Anyway, after some more testing I'm rather convinced the call to fmpz_poly_clear is the problem.",
    "created_at": "2012-06-01T16:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138071",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Anyway, after some more testing I'm rather convinced the call to fmpz_poly_clear is the problem.



---

archive/issue_comments_138072.json:
```json
{
    "body": "Although there are several calls to fmpz_poly_clear in the quatalg stuff which does not seem to cause similar problem.\n\nAs a solution, let's just put the call to _fmpz_cleanup at the end of the quit_sage function and let the buildbot decide if it's really acceptable.\n\nI'll go on with the other problems now.",
    "created_at": "2012-06-04T08:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138072",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Although there are several calls to fmpz_poly_clear in the quatalg stuff which does not seem to cause similar problem.

As a solution, let's just put the call to _fmpz_cleanup at the end of the quit_sage function and let the buildbot decide if it's really acceptable.

I'll go on with the other problems now.



---

archive/issue_comments_138073.json:
```json
{
    "body": "Attachment [sqrt_normalization_fix.diff](tarball://root/attachments/some-uuid/ticket12173/sqrt_normalization_fix.diff) by @fredrik-johansson created at 2012-06-04 15:20:35\n\nFix normalization of sqrt for fraction field elements",
    "created_at": "2012-06-04T15:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138073",
    "user": "https://github.com/fredrik-johansson"
}
```

Attachment [sqrt_normalization_fix.diff](tarball://root/attachments/some-uuid/ticket12173/sqrt_normalization_fix.diff) by @fredrik-johansson created at 2012-06-04 15:20:35

Fix normalization of sqrt for fraction field elements



---

archive/issue_comments_138074.json:
```json
{
    "body": "The patch makes the tests in fraction_field_FpT and function_field_element pass. I have not checked whether there are tests elsewhere in Sage that disagree with the chosen convention.",
    "created_at": "2012-06-04T15:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138074",
    "user": "https://github.com/fredrik-johansson"
}
```

The patch makes the tests in fraction_field_FpT and function_field_element pass. I have not checked whether there are tests elsewhere in Sage that disagree with the chosen convention.



---

archive/issue_comments_138075.json:
```json
{
    "body": "With the most recent changes in my repository, and moving the fmpz_cleanup call to the end of the quit function, the following no longer crash/fail: sage_object.pyx, elliptic_curves/padics.py, hyperelliptic_curves/jacobian_morphism.py, flint.pyx, modform/element.py, ell_point.py\n\nThe following still fail with what only appears to be simple normalization problems: polynomial_zmod_flint.pyx, combinat/sf/jack.py\n\nOnly one failure remains that appears to be a genuine bug: graphs/matchpoly.pyx\n\nThis one seems a bit difficult to debug. Anyone familiar with the math?",
    "created_at": "2012-06-05T09:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138075",
    "user": "https://github.com/fredrik-johansson"
}
```

With the most recent changes in my repository, and moving the fmpz_cleanup call to the end of the quit function, the following no longer crash/fail: sage_object.pyx, elliptic_curves/padics.py, hyperelliptic_curves/jacobian_morphism.py, flint.pyx, modform/element.py, ell_point.py

The following still fail with what only appears to be simple normalization problems: polynomial_zmod_flint.pyx, combinat/sf/jack.py

Only one failure remains that appears to be a genuine bug: graphs/matchpoly.pyx

This one seems a bit difficult to debug. Anyone familiar with the math?



---

archive/issue_comments_138076.json:
```json
{
    "body": "As far as jack.py goes, I'm not sure exactly where the difference in normalization comes from, but the new output is nicer, so I suggest just changing those doctests.",
    "created_at": "2012-06-05T09:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138076",
    "user": "https://github.com/fredrik-johansson"
}
```

As far as jack.py goes, I'm not sure exactly where the difference in normalization comes from, but the new output is nicer, so I suggest just changing those doctests.



---

archive/issue_comments_138077.json:
```json
{
    "body": "Jean-Pierre, could you push your changes to the build scripts so we can merge them in the official repository? (It would be nice to get a new 2.3 beta version out ASAP and base a new spkg on that.)",
    "created_at": "2012-06-05T09:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138077",
    "user": "https://github.com/fredrik-johansson"
}
```

Jean-Pierre, could you push your changes to the build scripts so we can merge them in the official repository? (It would be nice to get a new 2.3 beta version out ASAP and base a new spkg on that.)



---

archive/issue_comments_138078.json:
```json
{
    "body": "Unfortunately, there are still memory errors; they just show up inconsistently. The ones that sometimes crash for me include:\n\n```\nsage -t  devel/sage-main/sage/modular/abvar/torsion_subgroup.py # Killed/crashed\nsage -t  devel/sage-main/sage/modular/modform/ambient_g1.py # Killed/crashed\nsage -t  devel/sage-main/sage/tests/book_stein_modform.py # Time out\nsage -t  devel/sage-main/sage/modular/hecke/element.py # Killed/crashed\n```\n",
    "created_at": "2012-06-05T10:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138078",
    "user": "https://github.com/fredrik-johansson"
}
```

Unfortunately, there are still memory errors; they just show up inconsistently. The ones that sometimes crash for me include:

```
sage -t  devel/sage-main/sage/modular/abvar/torsion_subgroup.py # Killed/crashed
sage -t  devel/sage-main/sage/modular/modform/ambient_g1.py # Killed/crashed
sage -t  devel/sage-main/sage/tests/book_stein_modform.py # Time out
sage -t  devel/sage-main/sage/modular/hecke/element.py # Killed/crashed
```




---

archive/issue_comments_138079.json:
```json
{
    "body": "Replying to [comment:63 fredrik.johansson]:\n> Jean-Pierre, could you push your changes to the build scripts so we can merge them in the official repository? (It would be nice to get a new 2.3 beta version out ASAP and base a new spkg on that.)\nI've got a github account with the same login as here.\nFeel free to get what you want from there, merge it, modify it, or whatever you want.\nIf you need me to do any further processing, please let me know.",
    "created_at": "2012-06-05T10:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138079",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:63 fredrik.johansson]:
> Jean-Pierre, could you push your changes to the build scripts so we can merge them in the official repository? (It would be nice to get a new 2.3 beta version out ASAP and base a new spkg on that.)
I've got a github account with the same login as here.
Feel free to get what you want from there, merge it, modify it, or whatever you want.
If you need me to do any further processing, please let me know.



---

archive/issue_comments_138080.json:
```json
{
    "body": "Replying to [comment:64 fredrik.johansson]:\n> Unfortunately, there are still memory errors; they just show up inconsistently. The ones that sometimes crash for me include:\n> {{{\n> sage -t  devel/sage-main/sage/modular/abvar/torsion_subgroup.py # Killed/crashed\n> sage -t  devel/sage-main/sage/modular/modform/ambient_g1.py # Killed/crashed\n> sage -t  devel/sage-main/sage/tests/book_stein_modform.py # Time out\n> sage -t  devel/sage-main/sage/modular/hecke/element.py # Killed/crashed\n> }}}\nToo bad...",
    "created_at": "2012-06-05T10:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138080",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:64 fredrik.johansson]:
> Unfortunately, there are still memory errors; they just show up inconsistently. The ones that sometimes crash for me include:
> {{{
> sage -t  devel/sage-main/sage/modular/abvar/torsion_subgroup.py # Killed/crashed
> sage -t  devel/sage-main/sage/modular/modform/ambient_g1.py # Killed/crashed
> sage -t  devel/sage-main/sage/tests/book_stein_modform.py # Time out
> sage -t  devel/sage-main/sage/modular/hecke/element.py # Killed/crashed
> }}}
Too bad...



---

archive/issue_comments_138081.json:
```json
{
    "body": "Replying to [comment:61 fredrik.johansson]:\n> With the most recent changes in my repository, and moving the fmpz_cleanup call to the end of the quit function, the following no longer crash/fail: sage_object.pyx, elliptic_curves/padics.py, hyperelliptic_curves/jacobian_morphism.py, flint.pyx, modform/element.py, ell_point.py\n> \n> The following still fail with what only appears to be simple normalization problems: polynomial_zmod_flint.pyx, combinat/sf/jack.py\n> \n> Only one failure remains that appears to be a genuine bug: graphs/matchpoly.pyx\n> \n> This one seems a bit difficult to debug. Anyone familiar with the math?\nThat's strange, I did not get this failure earlier.\nI'll have a look this afternoon.",
    "created_at": "2012-06-05T10:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138081",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:61 fredrik.johansson]:
> With the most recent changes in my repository, and moving the fmpz_cleanup call to the end of the quit function, the following no longer crash/fail: sage_object.pyx, elliptic_curves/padics.py, hyperelliptic_curves/jacobian_morphism.py, flint.pyx, modform/element.py, ell_point.py
> 
> The following still fail with what only appears to be simple normalization problems: polynomial_zmod_flint.pyx, combinat/sf/jack.py
> 
> Only one failure remains that appears to be a genuine bug: graphs/matchpoly.pyx
> 
> This one seems a bit difficult to debug. Anyone familiar with the math?
That's strange, I did not get this failure earlier.
I'll have a look this afternoon.



---

archive/issue_comments_138082.json:
```json
{
    "body": "No memory errors if I comment out free_flint_stack(), so hopefully there really isn't anything else going on. We just need to figure out how to fix this one...",
    "created_at": "2012-06-05T11:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138082",
    "user": "https://github.com/fredrik-johansson"
}
```

No memory errors if I comment out free_flint_stack(), so hopefully there really isn't anything else going on. We just need to figure out how to fix this one...



---

archive/issue_comments_138083.json:
```json
{
    "body": "Replying to [comment:67 jpflori]:\n> Replying to [comment:61 fredrik.johansson]:\n> > Only one failure remains that appears to be a genuine bug: graphs/matchpoly.pyx\n> > \n> > This one seems a bit difficult to debug. Anyone familiar with the math?\n> That's strange, I did not get this failure earlier.\n> I'll have a look this afternoon.\nI've just tested graphs/matchpoly.pyx with the latest flint's commit (see what is on my github account), together with all patches to the Sage library posted here (and some minor additional stuff including moving flint_free_stack just before cleaning symmetrica), and cannot repoduce errors in that file.\n\nCould you post a log here?",
    "created_at": "2012-06-05T16:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138083",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:67 jpflori]:
> Replying to [comment:61 fredrik.johansson]:
> > Only one failure remains that appears to be a genuine bug: graphs/matchpoly.pyx
> > 
> > This one seems a bit difficult to debug. Anyone familiar with the math?
> That's strange, I did not get this failure earlier.
> I'll have a look this afternoon.
I've just tested graphs/matchpoly.pyx with the latest flint's commit (see what is on my github account), together with all patches to the Sage library posted here (and some minor additional stuff including moving flint_free_stack just before cleaning symmetrica), and cannot repoduce errors in that file.

Could you post a log here?



---

archive/issue_comments_138084.json:
```json
{
    "body": "\n```\nFile \"/scratch/fjohanss/sage-5.1.beta1/devel/sage-main/sage/graphs/matchpoly.pyx\", line 333:\n    sage: len(str(f))\nExpected:\n    406824\nGot:\n    6179056\n```\n\n\nThe new value definitely seems to be wrong: complete_poly(n) has coefficients with about n digits for n = 100, 200, ..., 900, but then complete_poly(1000) evaluates to have coefficients with 6000 digits. \n\nThis is on a 32-bit system, by the way.",
    "created_at": "2012-06-05T16:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138084",
    "user": "https://github.com/fredrik-johansson"
}
```


```
File "/scratch/fjohanss/sage-5.1.beta1/devel/sage-main/sage/graphs/matchpoly.pyx", line 333:
    sage: len(str(f))
Expected:
    406824
Got:
    6179056
```


The new value definitely seems to be wrong: complete_poly(n) has coefficients with about n digits for n = 100, 200, ..., 900, but then complete_poly(1000) evaluates to have coefficients with 6000 digits. 

This is on a 32-bit system, by the way.



---

archive/issue_comments_138085.json:
```json
{
    "body": "I'm on a 64 bit system and cannot see the error... we should get confirmation form someone else (on both architectures), it's possible something got screwed on my system.\n\nBy the way, it seems to me that the FFT bug is still present on my system although I've merged the latest commits.\nCould you confirm or infirm that (testing sage/libs/flint/flint.pyx)?",
    "created_at": "2012-06-05T16:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138085",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I'm on a 64 bit system and cannot see the error... we should get confirmation form someone else (on both architectures), it's possible something got screwed on my system.

By the way, it seems to me that the FFT bug is still present on my system although I've merged the latest commits.
Could you confirm or infirm that (testing sage/libs/flint/flint.pyx)?



---

archive/issue_comments_138086.json:
```json
{
    "body": "The FFT bug is fixed for me (same system; the standalone .c program also works on a 64-bit system, but I have not tried Sage there).",
    "created_at": "2012-06-05T16:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138086",
    "user": "https://github.com/fredrik-johansson"
}
```

The FFT bug is fixed for me (same system; the standalone .c program also works on a 64-bit system, but I have not tried Sage there).



---

archive/issue_comments_138087.json:
```json
{
    "body": "Ok, so something went wrong on my side.\n\nI'll double check everything tomorrow.",
    "created_at": "2012-06-05T21:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138087",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, so something went wrong on my side.

I'll double check everything tomorrow.



---

archive/issue_comments_138088.json:
```json
{
    "body": "I indeed ended up with a different version of my directory on the machine where I test Sage....",
    "created_at": "2012-06-06T06:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138088",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I indeed ended up with a different version of my directory on the machine where I test Sage....



---

archive/issue_comments_138089.json:
```json
{
    "body": "Ok, everything should be fine now.\nI don't have errors anymore in flint.pyx,.\nNonetheless I cannot reproduce the problem in matchpoly.pyx, so this may indeed be related to a 32/64 bits difference?",
    "created_at": "2012-06-06T07:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138089",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, everything should be fine now.
I don't have errors anymore in flint.pyx,.
Nonetheless I cannot reproduce the problem in matchpoly.pyx, so this may indeed be related to a 32/64 bits difference?



---

archive/issue_comments_138090.json:
```json
{
    "body": "Attachment [headers.patch](tarball://root/attachments/some-uuid/ticket12173/headers.patch) by jpflori created at 2012-06-06 08:04:58\n\nReplace FLINT by flint for headers inclusion.",
    "created_at": "2012-06-06T08:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138090",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [headers.patch](tarball://root/attachments/some-uuid/ticket12173/headers.patch) by jpflori created at 2012-06-06 08:04:58

Replace FLINT by flint for headers inclusion.



---

archive/issue_comments_138091.json:
```json
{
    "body": "Attachment [multrunc.patch](tarball://root/attachments/some-uuid/ticket12173/multrunc.patch) by jpflori created at 2012-06-06 08:05:21\n\nModify doctest for _mul_trunc_opposite",
    "created_at": "2012-06-06T08:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138091",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [multrunc.patch](tarball://root/attachments/some-uuid/ticket12173/multrunc.patch) by jpflori created at 2012-06-06 08:05:21

Modify doctest for _mul_trunc_opposite



---

archive/issue_comments_138092.json:
```json
{
    "body": "On my amd64 Ubuntu 12.04 (processor must be some kind of Xeon), with sage 5.1.beta1 + the new zn_poly spkg at #12433 + custom flint 2.3 spkg at http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.jp.spkg + the following patches:\n- flint-2.3-sage-5.1.beta1.patch\n- flint-2.3-jp.patch (this one should be cleaned, split, etc.)\n- sqrt_normalization_fix.diff\n- headers.patch\n- multrunc.patch\nmake ptest only spat 3 errors:\n- the ordering problem in jack.py\n- memory error in ell_curve_is_isogeny.py\n- memory error in ell_tate_curve",
    "created_at": "2012-06-06T08:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138092",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

On my amd64 Ubuntu 12.04 (processor must be some kind of Xeon), with sage 5.1.beta1 + the new zn_poly spkg at #12433 + custom flint 2.3 spkg at http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.jp.spkg + the following patches:
- flint-2.3-sage-5.1.beta1.patch
- flint-2.3-jp.patch (this one should be cleaned, split, etc.)
- sqrt_normalization_fix.diff
- headers.patch
- multrunc.patch
make ptest only spat 3 errors:
- the ordering problem in jack.py
- memory error in ell_curve_is_isogeny.py
- memory error in ell_tate_curve



---

archive/issue_comments_138093.json:
```json
{
    "body": "Some further changes. For testing only.",
    "created_at": "2012-06-06T08:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138093",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Some further changes. For testing only.



---

archive/issue_comments_138094.json:
```json
{
    "body": "Attachment [flint-2.3-jp.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-jp.patch) by @fredrik-johansson created at 2012-06-06 09:41:21\n\nI pushed an experimental alternative to _fmpz_cleanup that does not free the main arrays. Could you check if using this avoids memory problems?",
    "created_at": "2012-06-06T09:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138094",
    "user": "https://github.com/fredrik-johansson"
}
```

Attachment [flint-2.3-jp.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-jp.patch) by @fredrik-johansson created at 2012-06-06 09:41:21

I pushed an experimental alternative to _fmpz_cleanup that does not free the main arrays. Could you check if using this avoids memory problems?



---

archive/issue_comments_138095.json:
```json
{
    "body": "I'll test this once the doc of Sage 5.1.beta2 finally finishes to build.",
    "created_at": "2012-06-06T09:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138095",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I'll test this once the doc of Sage 5.1.beta2 finally finishes to build.



---

archive/issue_comments_138096.json:
```json
{
    "body": "A quick test of the file ell_tate_curve which produced an error each time I ran it with the latest version of everything, seems to indicate that not freeing the array is enough.\n\nI've just launched a make ptest to be sure that the problem was not just moved somewhere else once more.",
    "created_at": "2012-06-06T10:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138096",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

A quick test of the file ell_tate_curve which produced an error each time I ran it with the latest version of everything, seems to indicate that not freeing the array is enough.

I've just launched a make ptest to be sure that the problem was not just moved somewhere else once more.



---

archive/issue_comments_138097.json:
```json
{
    "body": "No errors except for jack.py after a first make ptest.",
    "created_at": "2012-06-06T11:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138097",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

No errors except for jack.py after a first make ptest.



---

archive/issue_comments_138098.json:
```json
{
    "body": "Very good news. I guess we should try running long tests as well?",
    "created_at": "2012-06-06T12:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138098",
    "user": "https://github.com/fredrik-johansson"
}
```

Very good news. I guess we should try running long tests as well?



---

archive/issue_comments_138099.json:
```json
{
    "body": "Same results after a second make ptest on sage-5.1.beta1 and another one on sage-5.1.beta2: only errors in jack.py (no memory errors and no error in matchpoly)\n\nYes, we should try running the long tests at least once, but then that will be the patchbot job I think",
    "created_at": "2012-06-06T12:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138099",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Same results after a second make ptest on sage-5.1.beta1 and another one on sage-5.1.beta2: only errors in jack.py (no memory errors and no error in matchpoly)

Yes, we should try running the long tests at least once, but then that will be the patchbot job I think



---

archive/issue_comments_138100.json:
```json
{
    "body": "Fredrik's patch; rebase on 5.1.beta2.",
    "created_at": "2012-06-06T12:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138100",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Fredrik's patch; rebase on 5.1.beta2.



---

archive/issue_comments_138101.json:
```json
{
    "body": "Attachment [flint-2.3-sage-5.1.beta2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.1.beta2.patch) by jpflori created at 2012-06-06 12:43:43\n\nReplace _fmpz_cleanup by fmpz_cleanup_mpz_content",
    "created_at": "2012-06-06T12:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138101",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-sage-5.1.beta2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-sage-5.1.beta2.patch) by jpflori created at 2012-06-06 12:43:43

Replace _fmpz_cleanup by fmpz_cleanup_mpz_content



---

archive/issue_comments_138102.json:
```json
{
    "body": "Attachment [fmpz_cleanup.patch](tarball://root/attachments/some-uuid/ticket12173/fmpz_cleanup.patch) by jpflori created at 2012-06-06 12:52:23\n\nBy the way, the only problem I get in jack.py is that some fractions which used to be \"minus sthg over minus sthg\" are now \"plus sthg over plus sthg\".",
    "created_at": "2012-06-06T12:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138102",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [fmpz_cleanup.patch](tarball://root/attachments/some-uuid/ticket12173/fmpz_cleanup.patch) by jpflori created at 2012-06-06 12:52:23

By the way, the only problem I get in jack.py is that some fractions which used to be "minus sthg over minus sthg" are now "plus sthg over plus sthg".



---

archive/issue_comments_138103.json:
```json
{
    "body": "Replying to [comment:83 jpflori]:\n> By the way, the only problem I get in jack.py is that some fractions which used to be \"minus sthg over minus sthg\" are now \"plus sthg over plus sthg\".\n\nYes, same here. The new output is clearly nicer, so we should just update the doctests.",
    "created_at": "2012-06-06T12:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138103",
    "user": "https://github.com/fredrik-johansson"
}
```

Replying to [comment:83 jpflori]:
> By the way, the only problem I get in jack.py is that some fractions which used to be "minus sthg over minus sthg" are now "plus sthg over plus sthg".

Yes, same here. The new output is clearly nicer, so we should just update the doctests.



---

archive/issue_comments_138104.json:
```json
{
    "body": "Here come some more proper patches.\n\nAfter running make ptestlong on 5.1.beta2 I got failures:\n- in jack.py as before\n- in sage/misc/cython.py because I renamed the FLINT directory into flint and fmpq.h is not found anymore, this also use the old fmpq_poly.c file which is now included in FLINT itself I guess. So the test has to be changed somehow.\n- in polynomial_rational_flint.pyx: time out...",
    "created_at": "2012-06-06T13:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138104",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Here come some more proper patches.

After running make ptestlong on 5.1.beta2 I got failures:
- in jack.py as before
- in sage/misc/cython.py because I renamed the FLINT directory into flint and fmpq.h is not found anymore, this also use the old fmpq_poly.c file which is now included in FLINT itself I guess. So the test has to be changed somehow.
- in polynomial_rational_flint.pyx: time out...



---

archive/issue_comments_138105.json:
```json
{
    "body": "Attachment [degree.patch](tarball://root/attachments/some-uuid/ticket12173/degree.patch) by jpflori created at 2012-06-06 13:58:51\n\nSet length to its correct value in a realloc",
    "created_at": "2012-06-06T13:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138105",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [degree.patch](tarball://root/attachments/some-uuid/ticket12173/degree.patch) by jpflori created at 2012-06-06 13:58:51

Set length to its correct value in a realloc



---

archive/issue_comments_138106.json:
```json
{
    "body": "Attachment [doctests.patch](tarball://root/attachments/some-uuid/ticket12173/doctests.patch) by jpflori created at 2012-06-06 13:59:17\n\nFix formatting of different doctests; not really related to the ticket.",
    "created_at": "2012-06-06T13:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138106",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [doctests.patch](tarball://root/attachments/some-uuid/ticket12173/doctests.patch) by jpflori created at 2012-06-06 13:59:17

Fix formatting of different doctests; not really related to the ticket.



---

archive/issue_comments_138107.json:
```json
{
    "body": "Attachment [jack.patch](tarball://root/attachments/some-uuid/ticket12173/jack.patch) by jpflori created at 2012-06-06 13:59:39\n\nChange doctests in jack.py",
    "created_at": "2012-06-06T13:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138107",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [jack.patch](tarball://root/attachments/some-uuid/ticket12173/jack.patch) by jpflori created at 2012-06-06 13:59:39

Change doctests in jack.py



---

archive/issue_comments_138108.json:
```json
{
    "body": "Update n_factor structure and initialize it before use",
    "created_at": "2012-06-06T14:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138108",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Update n_factor structure and initialize it before use



---

archive/issue_comments_138109.json:
```json
{
    "body": "Attachment [n_factor.patch](tarball://root/attachments/some-uuid/ticket12173/n_factor.patch) by jpflori created at 2012-06-06 14:00:27\n\nFredrik's patch for sqrt normalization",
    "created_at": "2012-06-06T14:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138109",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [n_factor.patch](tarball://root/attachments/some-uuid/ticket12173/n_factor.patch) by jpflori created at 2012-06-06 14:00:27

Fredrik's patch for sqrt normalization



---

archive/issue_comments_138110.json:
```json
{
    "body": "Attachment [sqrt_normalization_fix.patch](tarball://root/attachments/some-uuid/ticket12173/sqrt_normalization_fix.patch) by jpflori created at 2012-06-06 14:00:55\n\nReplace flint_stack_cleanup by _fmpz_cleanup",
    "created_at": "2012-06-06T14:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138110",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [sqrt_normalization_fix.patch](tarball://root/attachments/some-uuid/ticket12173/sqrt_normalization_fix.patch) by jpflori created at 2012-06-06 14:00:55

Replace flint_stack_cleanup by _fmpz_cleanup



---

archive/issue_comments_138111.json:
```json
{
    "body": "Attachment [flint_stack_cleanup.patch](tarball://root/attachments/some-uuid/ticket12173/flint_stack_cleanup.patch) by jpflori created at 2012-06-06 14:12:41",
    "created_at": "2012-06-06T14:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138111",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint_stack_cleanup.patch](tarball://root/attachments/some-uuid/ticket12173/flint_stack_cleanup.patch) by jpflori created at 2012-06-06 14:12:41



---

archive/issue_comments_138112.json:
```json
{
    "body": "Attachment [cython.patch](tarball://root/attachments/some-uuid/ticket12173/cython.patch) by jpflori created at 2012-06-06 14:30:30\n\nFix for #11680 doctest in cython.py",
    "created_at": "2012-06-06T14:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138112",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [cython.patch](tarball://root/attachments/some-uuid/ticket12173/cython.patch) by jpflori created at 2012-06-06 14:30:30

Fix for #11680 doctest in cython.py



---

archive/issue_comments_138113.json:
```json
{
    "body": "The cython stuff should be fixed now.",
    "created_at": "2012-06-06T14:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138113",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The cython stuff should be fixed now.



---

archive/issue_comments_138114.json:
```json
{
    "body": "The polynomial_rational_flint timeout problem seem to be that calling \"__getitem__\" on a slice is indeed horribly slow.\nPlaying with the (only) long test of the file, Sage returns f[1:3] instantly but needs 2.6 seconds to return g[1:2] !!! And I've removed the test for signal activation.",
    "created_at": "2012-06-06T15:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138114",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The polynomial_rational_flint timeout problem seem to be that calling "__getitem__" on a slice is indeed horribly slow.
Playing with the (only) long test of the file, Sage returns f[1:3] instantly but needs 2.6 seconds to return g[1:2] !!! And I've removed the test for signal activation.



---

archive/issue_comments_138115.json:
```json
{
    "body": "Using the same code as in polynomial_integer_dense_flint yields similar performance.\n\nMaybe there's a problem in fmpq_poly_get_slice, although the code seems ok at first sight.",
    "created_at": "2012-06-06T15:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138115",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Using the same code as in polynomial_integer_dense_flint yields similar performance.

Maybe there's a problem in fmpq_poly_get_slice, although the code seems ok at first sight.



---

archive/issue_comments_138116.json:
```json
{
    "body": "Or the call to \"len(list(self))\" to get the degree of the polynomial plus one is just too bizarre.",
    "created_at": "2012-06-06T15:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138116",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Or the call to "len(list(self))" to get the degree of the polynomial plus one is just too bizarre.



---

archive/issue_comments_138117.json:
```json
{
    "body": "That was this bizarre construction indeed.\nHere comes a fix.",
    "created_at": "2012-06-06T15:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138117",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

That was this bizarre construction indeed.
Here comes a fix.



---

archive/issue_comments_138118.json:
```json
{
    "body": "Make __getitem__ for slices faster",
    "created_at": "2012-06-06T15:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138118",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Make __getitem__ for slices faster



---

archive/issue_comments_138119.json:
```json
{
    "body": "Attachment [slice.patch](tarball://root/attachments/some-uuid/ticket12173/slice.patch) by jpflori created at 2012-06-06 15:26:29",
    "created_at": "2012-06-06T15:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138119",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [slice.patch](tarball://root/attachments/some-uuid/ticket12173/slice.patch) by jpflori created at 2012-06-06 15:26:29



---

archive/issue_comments_138120.json:
```json
{
    "body": "I've built Sage 5.1.beta2 within a 32 bits virtual machine running Ubuntu 12.04 and could reproduce the matchpoly error.",
    "created_at": "2012-06-07T12:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138120",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've built Sage 5.1.beta2 within a 32 bits virtual machine running Ubuntu 12.04 and could reproduce the matchpoly error.



---

archive/issue_comments_138121.json:
```json
{
    "body": "Running make ptestlong within the 32 bits virtual machine only raised this error as well (and another one in polynomial_real_mpfr_dense which could not be reproduced when ran alone).",
    "created_at": "2012-06-07T14:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138121",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Running make ptestlong within the 32 bits virtual machine only raised this error as well (and another one in polynomial_real_mpfr_dense which could not be reproduced when ran alone).



---

archive/issue_comments_138122.json:
```json
{
    "body": "Attachment [ref_flint1.patch](tarball://root/attachments/some-uuid/ticket12173/ref_flint1.patch) by jpflori created at 2012-06-08 16:28:53\n\nRemove a reference to FLINT 1.",
    "created_at": "2012-06-08T16:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138122",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [ref_flint1.patch](tarball://root/attachments/some-uuid/ticket12173/ref_flint1.patch) by jpflori created at 2012-06-08 16:28:53

Remove a reference to FLINT 1.



---

archive/issue_comments_138123.json:
```json
{
    "body": "I've updated the spkg available at http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.jp.spkg with new git commits.\nMoreover it contains better cleaned up spkg-install and spkg-check scripts, together with an updated SPKG.txt (for the moment nothing is committed).\n\nI'm not sure about some stuff for that spkg :\n- There is some stuff related to Cygwin, I've tried to let it act as before, but have no idea why this was needed, nor if it's still needed.\n- There is some stuff related to 64 bits build when SAGE64 is set, not sure about the status of this (in fact I don't really know on what systems this is needed for any spkg, not usual Linux install for sure). With FLINT current configure system, behaving as before overwrites the default CFLAGS FLINT would have chosen (ok, the only relevant part is -O2 -g which is also set together with -m64 when SAGE64 is set, but I'm not really happy with such a solution, could FLINT use some kind of ABI variable?).\n- We could or should treat the SAGE_DEBUG flag correctly. As far as CFLAGS are concerned, we can set them ourselves but there is no way to prevent FLINT from using the FLINT_TUNE magic.\n- I've put Fredrik and I as maintainers for the moment, any more reasonable proposition is welcomed.",
    "created_at": "2012-06-08T16:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138123",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've updated the spkg available at http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.jp.spkg with new git commits.
Moreover it contains better cleaned up spkg-install and spkg-check scripts, together with an updated SPKG.txt (for the moment nothing is committed).

I'm not sure about some stuff for that spkg :
- There is some stuff related to Cygwin, I've tried to let it act as before, but have no idea why this was needed, nor if it's still needed.
- There is some stuff related to 64 bits build when SAGE64 is set, not sure about the status of this (in fact I don't really know on what systems this is needed for any spkg, not usual Linux install for sure). With FLINT current configure system, behaving as before overwrites the default CFLAGS FLINT would have chosen (ok, the only relevant part is -O2 -g which is also set together with -m64 when SAGE64 is set, but I'm not really happy with such a solution, could FLINT use some kind of ABI variable?).
- We could or should treat the SAGE_DEBUG flag correctly. As far as CFLAGS are concerned, we can set them ourselves but there is no way to prevent FLINT from using the FLINT_TUNE magic.
- I've put Fredrik and I as maintainers for the moment, any more reasonable proposition is welcomed.



---

archive/issue_comments_138124.json:
```json
{
    "body": "The spkg-check is in fact broken because of undefined symbols related to NTL in libflint.so.\nThis also occurs on my personal install of FLINT when built with the NTL interface.",
    "created_at": "2012-06-08T17:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138124",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The spkg-check is in fact broken because of undefined symbols related to NTL in libflint.so.
This also occurs on my personal install of FLINT when built with the NTL interface.



---

archive/issue_comments_138125.json:
```json
{
    "body": "My bad, I forgot to add -lntl when building FLINT with the NTL interface.\nThis is now fixed on my github account and in the spkg.",
    "created_at": "2012-06-08T17:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138125",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

My bad, I forgot to add -lntl when building FLINT with the NTL interface.
This is now fixed on my github account and in the spkg.



---

archive/issue_comments_138126.json:
```json
{
    "body": "I've uploaded a new spkg (same address) based on Fredrik's latest git commit (c644b926cd6f...) plus an additional modification to Makefile.in so that the NTL interface is correctly build (not committed, let's wait for Bill to properly fix it, if that's actually needed).\n\nWith this latest spkg, Sage 5.1.beta3 builds correctly and passes \"make ptestlong\" on my amd64 Ubuntu 12.04.\n\nWithin the 32 bits virtual machine, Sage 5.1.beta2 passes \"./sage -t sage/graphs/matchpoly.pyx\" (although the mul_SS bug is still present, now another algorithm is used I presume).\n\nSo I guess we just have to wait for a proper release of FLINT, potentially modify the way it is configure by spkg-install, and properly review every patch to the Sage library and changes to the spkg.",
    "created_at": "2012-06-11T11:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138126",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've uploaded a new spkg (same address) based on Fredrik's latest git commit (c644b926cd6f...) plus an additional modification to Makefile.in so that the NTL interface is correctly build (not committed, let's wait for Bill to properly fix it, if that's actually needed).

With this latest spkg, Sage 5.1.beta3 builds correctly and passes "make ptestlong" on my amd64 Ubuntu 12.04.

Within the 32 bits virtual machine, Sage 5.1.beta2 passes "./sage -t sage/graphs/matchpoly.pyx" (although the mul_SS bug is still present, now another algorithm is used I presume).

So I guess we just have to wait for a proper release of FLINT, potentially modify the way it is configure by spkg-install, and properly review every patch to the Sage library and changes to the spkg.



---

archive/issue_comments_138127.json:
```json
{
    "body": "Updated http://sage.math.washington.edu/home/fredrik/flint-2.3.spkg to the release version.\n\nPossibly this now just needs changing the milestone to 5.2, rebasing any patches that have broken, and getting it reviewed?",
    "created_at": "2012-07-03T09:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138127",
    "user": "https://github.com/fredrik-johansson"
}
```

Updated http://sage.math.washington.edu/home/fredrik/flint-2.3.spkg to the release version.

Possibly this now just needs changing the milestone to 5.2, rebasing any patches that have broken, and getting it reviewed?



---

archive/issue_comments_138128.json:
```json
{
    "body": "I'm currently tweaking the spkg-install to take into account the build system changes in FLINT, should not be too long.\n\nI've also build 5.1.rc0 to rebase the patches on it.",
    "created_at": "2012-07-03T11:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138128",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I'm currently tweaking the spkg-install to take into account the build system changes in FLINT, should not be too long.

I've also build 5.1.rc0 to rebase the patches on it.



---

archive/issue_comments_138129.json:
```json
{
    "body": "Attachment [headers-5.1.rc0.patch](tarball://root/attachments/some-uuid/ticket12173/headers-5.1.rc0.patch) by jpflori created at 2012-07-03 14:02:06\n\nUpdated patch for 5.1.rc0.",
    "created_at": "2012-07-03T14:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138129",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [headers-5.1.rc0.patch](tarball://root/attachments/some-uuid/ticket12173/headers-5.1.rc0.patch) by jpflori created at 2012-07-03 14:02:06

Updated patch for 5.1.rc0.



---

archive/issue_comments_138130.json:
```json
{
    "body": "There is some work to be done to rebase on #10617.\nI'm working on this.\n\nAs far as the spkg is concerned, I think there is only the Cygwin question to deal with.\nIt seems to me that FLINT can not be build as a shared library on Cygwin (at least Bill disabled this possibility).\nI'm not sure this is required by Sage, but would guess so.\nSo potentially we should disable the Cygwin hacks altogether and only build a static library (which would link to the static NTL library).",
    "created_at": "2012-07-03T14:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138130",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

There is some work to be done to rebase on #10617.
I'm working on this.

As far as the spkg is concerned, I think there is only the Cygwin question to deal with.
It seems to me that FLINT can not be build as a shared library on Cygwin (at least Bill disabled this possibility).
I'm not sure this is required by Sage, but would guess so.
So potentially we should disable the Cygwin hacks altogether and only build a static library (which would link to the static NTL library).



---

archive/issue_comments_138131.json:
```json
{
    "body": "Attachment [17060.patch](tarball://root/attachments/some-uuid/ticket12173/17060.patch) by jpflori created at 2012-07-03 16:28:01\n\nTake #10617 into account",
    "created_at": "2012-07-03T16:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138131",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [17060.patch](tarball://root/attachments/some-uuid/ticket12173/17060.patch) by jpflori created at 2012-07-03 16:28:01

Take #10617 into account



---

archive/issue_comments_138132.json:
```json
{
    "body": "By the way \"make ptest\" gives no error on my computer.",
    "created_at": "2012-07-03T16:29:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138132",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

By the way "make ptest" gives no error on my computer.



---

archive/issue_comments_138133.json:
```json
{
    "body": "Is 17060.patch the right file? It just seems to be the flint1-based patch from #10617, which won't work.",
    "created_at": "2012-07-04T09:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138133",
    "user": "https://github.com/fredrik-johansson"
}
```

Is 17060.patch the right file? It just seems to be the flint1-based patch from #10617, which won't work.



---

archive/issue_comments_138134.json:
```json
{
    "body": "Indeed, wrong file.\nI just hope that I did not lose the patch on top of that one...",
    "created_at": "2012-07-04T11:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138134",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Indeed, wrong file.
I just hope that I did not lose the patch on top of that one...



---

archive/issue_comments_138135.json:
```json
{
    "body": "Take #10617 into account",
    "created_at": "2012-07-04T11:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138135",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Take #10617 into account



---

archive/issue_comments_138136.json:
```json
{
    "body": "Attachment [compose_eval.patch](tarball://root/attachments/some-uuid/ticket12173/compose_eval.patch) by jpflori created at 2012-07-04 11:30:29\n\nOk, this should be the right one.",
    "created_at": "2012-07-04T11:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138136",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [compose_eval.patch](tarball://root/attachments/some-uuid/ticket12173/compose_eval.patch) by jpflori created at 2012-07-04 11:30:29

Ok, this should be the right one.



---

archive/issue_comments_138137.json:
```json
{
    "body": "I can verify that the patches apply and build cleanly on 5.1-rc0, and the test suite passes (have not tried long tests).\n\nIs this ready for review? I guess updating the build scripts to use static libraries on Cygwin is necessary first?",
    "created_at": "2012-07-04T13:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138137",
    "user": "https://github.com/fredrik-johansson"
}
```

I can verify that the patches apply and build cleanly on 5.1-rc0, and the test suite passes (have not tried long tests).

Is this ready for review? I guess updating the build scripts to use static libraries on Cygwin is necessary first?



---

archive/issue_comments_138138.json:
```json
{
    "body": "I've completely failed to croospost on both flint-devel and sage-devel yesterday, and have just posted on sage-devel to get some info about the shared/static and cygwin stuff.\n\nI'm also installing Cygwin right now to get a hint of what happens there.\n\nOnce I've gathered more info, I'll update the Cygwin part of spkg-install and I guess the spkg will be ready for review.\n\nOn the other hand, I guess that all the patches to the Sage library deserve proper review now.\nIf you feel ok with mine, please post about it here.\nI'll have a(nother) look at what Mike, Sebastian and you did to be sure we've not let anything go through.\n\nWhat might be nice to check is that all functions defined in the pxi files still correspond to actual functions (for example the compose stuff now has an _fmpz trailing), because Im not sure that defining something in these files that does not actually exist in the library would lead to a build failure (if it does, then there's no problem cos everything builds fine here :))",
    "created_at": "2012-07-04T13:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138138",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've completely failed to croospost on both flint-devel and sage-devel yesterday, and have just posted on sage-devel to get some info about the shared/static and cygwin stuff.

I'm also installing Cygwin right now to get a hint of what happens there.

Once I've gathered more info, I'll update the Cygwin part of spkg-install and I guess the spkg will be ready for review.

On the other hand, I guess that all the patches to the Sage library deserve proper review now.
If you feel ok with mine, please post about it here.
I'll have a(nother) look at what Mike, Sebastian and you did to be sure we've not let anything go through.

What might be nice to check is that all functions defined in the pxi files still correspond to actual functions (for example the compose stuff now has an _fmpz trailing), because Im not sure that defining something in these files that does not actually exist in the library would lead to a build failure (if it does, then there's no problem cos everything builds fine here :))



---

archive/issue_comments_138139.json:
```json
{
    "body": "We should do something about this horrible horror:\n\n\n```\nsage: a = ZZ['x'](range(100000)); R = Integers(3)['x']                \nsage: %time R(a);\nCPU times: user 51.96 s, sys: 0.00 s, total: 51.96 s\n```\n\n\nIt was this slow before as well, but there's no reason not to fix it.",
    "created_at": "2012-07-05T11:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138139",
    "user": "https://github.com/fredrik-johansson"
}
```

We should do something about this horrible horror:


```
sage: a = ZZ['x'](range(100000)); R = Integers(3)['x']                
sage: %time R(a);
CPU times: user 51.96 s, sys: 0.00 s, total: 51.96 s
```


It was this slow before as well, but there's no reason not to fix it.



---

archive/issue_comments_138140.json:
```json
{
    "body": "Hmm, I seem to be unable to fix this in the obvious way. If I add\n\n\n```\nfrom sage.rings.polynomial.polynomial_integer_dense_flint cimport Polynomial_integer_dense_flint\n```\n\n\nto polynomial_zmod_flint.pyx in order to be able to access the value as an fmpz_poly_t, I get\n\n\n```\nIn file included from /scratch/fjohanss/sage-5.1.rc0/local/include/NTL/ZZ.h:19:0,\n                 from /scratch/fjohanss/sage-5.1.rc0/local/include/flint/NTL-interface.h:36,\n                 from sage/rings/polynomial/polynomial_zmod_flint.c:250:\n/scratch/fjohanss/sage-5.1.rc0/local/include/NTL/tools.h:11:19: fatal error: cstdlib: No such file or directory\n```\n\n\nAny idea how to fix this?",
    "created_at": "2012-07-06T09:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138140",
    "user": "https://github.com/fredrik-johansson"
}
```

Hmm, I seem to be unable to fix this in the obvious way. If I add


```
from sage.rings.polynomial.polynomial_integer_dense_flint cimport Polynomial_integer_dense_flint
```


to polynomial_zmod_flint.pyx in order to be able to access the value as an fmpz_poly_t, I get


```
In file included from /scratch/fjohanss/sage-5.1.rc0/local/include/NTL/ZZ.h:19:0,
                 from /scratch/fjohanss/sage-5.1.rc0/local/include/flint/NTL-interface.h:36,
                 from sage/rings/polynomial/polynomial_zmod_flint.c:250:
/scratch/fjohanss/sage-5.1.rc0/local/include/NTL/tools.h:11:19: fatal error: cstdlib: No such file or directory
```


Any idea how to fix this?



---

archive/issue_comments_138141.json:
```json
{
    "body": "Is this a flint related problem? If we convert `a` into a list first we get a huge speedup:\n\n```\nsage: a = ZZ['x'](range(100000))\nsage: R = Integers(3)['x']\nsage: %timeit R(list(a))\n5 loops, best of 3: 116 ms per loop\n```\n\nPerhaps we should look into `R._element_constructor_` for the root of the issue, maybe some ring coercion done in a weird way?",
    "created_at": "2012-07-14T18:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138141",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Is this a flint related problem? If we convert `a` into a list first we get a huge speedup:

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: %timeit R(list(a))
5 loops, best of 3: 116 ms per loop
```

Perhaps we should look into `R._element_constructor_` for the root of the issue, maybe some ring coercion done in a weird way?



---

archive/issue_comments_138142.json:
```json
{
    "body": "Right, this is not a flint problem as such, and we should probably open a separate ticket for it.\n\nBut in this particular case, we should be doing a direct conversion between the flint polynomial types, which will be much faster still.",
    "created_at": "2012-07-14T18:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138142",
    "user": "https://github.com/fredrik-johansson"
}
```

Right, this is not a flint problem as such, and we should probably open a separate ticket for it.

But in this particular case, we should be doing a direct conversion between the flint polynomial types, which will be much faster still.



---

archive/issue_comments_138143.json:
```json
{
    "body": "I have created #13257 for this issue.",
    "created_at": "2012-07-15T10:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138143",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

I have created #13257 for this issue.



---

archive/issue_comments_138144.json:
```json
{
    "body": "I've posted an updated spkg on my website\n(http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.spkg)\nbased on my github trunk.\nApart from updating the src directory to the FLINT final 2.3 release and committing, tagging the changes in the HG repository, nothing should really change (except for fixing bugs :) ).",
    "created_at": "2012-07-19T00:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138144",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've posted an updated spkg on my website
(http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.spkg)
based on my github trunk.
Apart from updating the src directory to the FLINT final 2.3 release and committing, tagging the changes in the HG repository, nothing should really change (except for fixing bugs :) ).



---

archive/issue_comments_138145.json:
```json
{
    "body": "Changing keywords from \"\" to \"flint\".",
    "created_at": "2012-07-19T00:44:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138145",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing keywords from "" to "flint".



---

archive/issue_comments_138146.json:
```json
{
    "body": "Replying to [comment:112 fredrik.johansson]:\n> Hmm, I seem to be unable to fix this in the obvious way. If I add\n> \n> {{{\n> from sage.rings.polynomial.polynomial_integer_dense_flint cimport Polynomial_integer_dense_flint\n> }}}\n> \n> to polynomial_zmod_flint.pyx in order to be able to access the value as an fmpz_poly_t, I get\n> \n> {{{\n> In file included from /scratch/fjohanss/sage-5.1.rc0/local/include/NTL/ZZ.h:19:0,\n>                  from /scratch/fjohanss/sage-5.1.rc0/local/include/flint/NTL-interface.h:36,\n>                  from sage/rings/polynomial/polynomial_zmod_flint.c:250:\n> /scratch/fjohanss/sage-5.1.rc0/local/include/NTL/tools.h:11:19: fatal error: cstdlib: No such file or directory\n> }}}\n> \n> Any idea how to fix this?\nI once had such a problem.\nIIRC a hackish but working fix is to \"cdef extern blahblah\" directly the structure in the file where you want to use it, so that you avoid to include all of the corresponding file with cimport and the corresponding dependencies and conflicts hell, in particular here where C and C++ get mixed because of NTL.",
    "created_at": "2012-07-19T00:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138146",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:112 fredrik.johansson]:
> Hmm, I seem to be unable to fix this in the obvious way. If I add
> 
> {{{
> from sage.rings.polynomial.polynomial_integer_dense_flint cimport Polynomial_integer_dense_flint
> }}}
> 
> to polynomial_zmod_flint.pyx in order to be able to access the value as an fmpz_poly_t, I get
> 
> {{{
> In file included from /scratch/fjohanss/sage-5.1.rc0/local/include/NTL/ZZ.h:19:0,
>                  from /scratch/fjohanss/sage-5.1.rc0/local/include/flint/NTL-interface.h:36,
>                  from sage/rings/polynomial/polynomial_zmod_flint.c:250:
> /scratch/fjohanss/sage-5.1.rc0/local/include/NTL/tools.h:11:19: fatal error: cstdlib: No such file or directory
> }}}
> 
> Any idea how to fix this?
I once had such a problem.
IIRC a hackish but working fix is to "cdef extern blahblah" directly the structure in the file where you want to use it, so that you avoid to include all of the corresponding file with cimport and the corresponding dependencies and conflicts hell, in particular here where C and C++ get mixed because of NTL.



---

archive/issue_comments_138147.json:
```json
{
    "body": "Rebase on 5.2",
    "created_at": "2012-07-30T17:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138147",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Rebase on 5.2



---

archive/issue_comments_138148.json:
```json
{
    "body": "Attachment [01-flint-2.3-sage-5.2.patch](tarball://root/attachments/some-uuid/ticket12173/01-flint-2.3-sage-5.2.patch) by jpflori created at 2012-07-30 17:40:20\n\nRebase on 5.2",
    "created_at": "2012-07-30T17:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138148",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [01-flint-2.3-sage-5.2.patch](tarball://root/attachments/some-uuid/ticket12173/01-flint-2.3-sage-5.2.patch) by jpflori created at 2012-07-30 17:40:20

Rebase on 5.2



---

archive/issue_comments_138149.json:
```json
{
    "body": "Attachment [07-headers-sage-5.2.patch](tarball://root/attachments/some-uuid/ticket12173/07-headers-sage-5.2.patch) by jpflori created at 2012-07-30 17:49:33\n\nI've rebased patches on top of 5.2.\nI guess this is quite of useless because all patches related to #715 should get remerged soon and we'll need to rebase on top of that which is basically the same as the latest 5.1 betas.\nAnyway...\n\nApart from that I've posted a patch to get faster conversion between integer and mod polys, this is quite dirty, but seems to work ok.\nI did not have the time to rerun the test suite yet.\n\nThe trick about ntl was to tell cython to use g++ rather than gcc.\n\nTwo other remarks:\n* there is some file still named zmod_poly, I guess that's from FLINT 1.x and zn_poly, we might rename it to nmod_poly,\n* the integer_dense class does not use the template thing used by other polynomial class, I guess it should be treated in another ticket, but will be potentially a big amount of work. this is also true for other classes there.\n* the fmpz_mod_poly module could be wrapped, once again a fairly big amount of work.",
    "created_at": "2012-07-30T17:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138149",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [07-headers-sage-5.2.patch](tarball://root/attachments/some-uuid/ticket12173/07-headers-sage-5.2.patch) by jpflori created at 2012-07-30 17:49:33

I've rebased patches on top of 5.2.
I guess this is quite of useless because all patches related to #715 should get remerged soon and we'll need to rebase on top of that which is basically the same as the latest 5.1 betas.
Anyway...

Apart from that I've posted a patch to get faster conversion between integer and mod polys, this is quite dirty, but seems to work ok.
I did not have the time to rerun the test suite yet.

The trick about ntl was to tell cython to use g++ rather than gcc.

Two other remarks:
* there is some file still named zmod_poly, I guess that's from FLINT 1.x and zn_poly, we might rename it to nmod_poly,
* the integer_dense class does not use the template thing used by other polynomial class, I guess it should be treated in another ticket, but will be potentially a big amount of work. this is also true for other classes there.
* the fmpz_mod_poly module could be wrapped, once again a fairly big amount of work.



---

archive/issue_comments_138150.json:
```json
{
    "body": "And obviously I did not changed the doc of the new function I created.\nAny more sensible name or code organization is welcomed.",
    "created_at": "2012-07-30T17:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138150",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

And obviously I did not changed the doc of the new function I created.
Any more sensible name or code organization is welcomed.



---

archive/issue_comments_138151.json:
```json
{
    "body": "I've updated a more proper spkg at the same address as before.\nAnd updated some patches.",
    "created_at": "2012-07-31T17:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138151",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've updated a more proper spkg at the same address as before.
And updated some patches.



---

archive/issue_comments_138152.json:
```json
{
    "body": "Faster conversion between integer and mod polys.",
    "created_at": "2012-07-31T17:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138152",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Faster conversion between integer and mod polys.



---

archive/issue_comments_138153.json:
```json
{
    "body": "Attachment [16-rename_zmod_to_nmod.patch](tarball://root/attachments/some-uuid/ticket12173/16-rename_zmod_to_nmod.patch) by jpflori created at 2012-07-31 17:11:19\n\nRename zmod stuff to nmod",
    "created_at": "2012-07-31T17:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138153",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [16-rename_zmod_to_nmod.patch](tarball://root/attachments/some-uuid/ticket12173/16-rename_zmod_to_nmod.patch) by jpflori created at 2012-07-31 17:11:19

Rename zmod stuff to nmod



---

archive/issue_comments_138154.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-31T17:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138154",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_138155.json:
```json
{
    "body": "In case this helps the patchbot:\n\nUse the spkg:\n* the FLINT spkg at http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.spkg;\n\nApply:\n\n* [attachment:01-flint-2.3-sage-5.2.patch],\n* [attachment:doctests.patch] (optional),\n* [attachment:flint_stack_cleanup.patch],\n* [attachment:n_factor.patch],\n* [attachment:degree.patch],\n* [attachment:sqrt_normalization_fix.patch],\n* [attachment:07-headers-sage-5.2.patch],\n* [attachment:multrunc.patch],\n* [attachment:fmpz_cleanup.patch],\n* [attachment:jack.patch],\n* [attachment:cython.patch],\n* [attachment:slice.patch],\n* [attachment:ref_flint1.patch],\n* [attachment:compose_eval.patch],\n* [attachment:15-integer_to_mod.patch],\n* [attachment:16-rename_zmod_to_nmod.patch].",
    "created_at": "2012-07-31T17:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138155",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

In case this helps the patchbot:

Use the spkg:
* the FLINT spkg at http://perso.telecom-paristech.fr/~flori/sage/flint-2.3.spkg;

Apply:

* [attachment:01-flint-2.3-sage-5.2.patch],
* [attachment:doctests.patch] (optional),
* [attachment:flint_stack_cleanup.patch],
* [attachment:n_factor.patch],
* [attachment:degree.patch],
* [attachment:sqrt_normalization_fix.patch],
* [attachment:07-headers-sage-5.2.patch],
* [attachment:multrunc.patch],
* [attachment:fmpz_cleanup.patch],
* [attachment:jack.patch],
* [attachment:cython.patch],
* [attachment:slice.patch],
* [attachment:ref_flint1.patch],
* [attachment:compose_eval.patch],
* [attachment:15-integer_to_mod.patch],
* [attachment:16-rename_zmod_to_nmod.patch].



---

archive/issue_comments_138156.json:
```json
{
    "body": "Is there a reason for not just using fmpz_poly_get_nmod_poly?",
    "created_at": "2012-07-31T17:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138156",
    "user": "https://github.com/fredrik-johansson"
}
```

Is there a reason for not just using fmpz_poly_get_nmod_poly?



---

archive/issue_comments_138157.json:
```json
{
    "body": "Not at all.\nExcept that I did not now it existed...",
    "created_at": "2012-07-31T17:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138157",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Not at all.
Except that I did not now it existed...



---

archive/issue_comments_138158.json:
```json
{
    "body": "Attachment [15-integer_to_mod-v2.patch](tarball://root/attachments/some-uuid/ticket12173/15-integer_to_mod-v2.patch) by jpflori created at 2012-07-31 17:48:05",
    "created_at": "2012-07-31T17:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138158",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [15-integer_to_mod-v2.patch](tarball://root/attachments/some-uuid/ticket12173/15-integer_to_mod-v2.patch) by jpflori created at 2012-07-31 17:48:05



---

archive/issue_comments_138159.json:
```json
{
    "body": "Attachment [16-rename_zmod_to_nmod-v2.patch](tarball://root/attachments/some-uuid/ticket12173/16-rename_zmod_to_nmod-v2.patch) by jpflori created at 2012-07-31 17:52:24\n\nHere you go.",
    "created_at": "2012-07-31T17:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138159",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [16-rename_zmod_to_nmod-v2.patch](tarball://root/attachments/some-uuid/ticket12173/16-rename_zmod_to_nmod-v2.patch) by jpflori created at 2012-07-31 17:52:24

Here you go.



---

archive/issue_comments_138160.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-08-03T06:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138160",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_138161.json:
```json
{
    "body": "We need to make sure the MPFR (and the PARI and NTL) spkg get build before FLINT.",
    "created_at": "2012-08-03T06:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138161",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

We need to make sure the MPFR (and the PARI and NTL) spkg get build before FLINT.



---

archive/issue_comments_138162.json:
```json
{
    "body": "Changing keywords from \"flint\" to \"flint spkg\".",
    "created_at": "2012-08-03T06:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138162",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing keywords from "flint" to "flint spkg".



---

archive/issue_comments_138163.json:
```json
{
    "body": "Just as a reminder, we should updated the Singular spkg with FLINT support when this gets in.\nI've created #13331.",
    "created_at": "2012-08-03T10:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138163",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Just as a reminder, we should updated the Singular spkg with FLINT support when this gets in.
I've created #13331.



---

archive/issue_comments_138164.json:
```json
{
    "body": "Attachment [00-mpfr.patch](tarball://root/attachments/some-uuid/ticket12173/00-mpfr.patch) by jpflori created at 2012-08-03 11:50:56\n\nMake FLINT spkg depend on MPFR spkg",
    "created_at": "2012-08-03T11:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138164",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [00-mpfr.patch](tarball://root/attachments/some-uuid/ticket12173/00-mpfr.patch) by jpflori created at 2012-08-03 11:50:56

Make FLINT spkg depend on MPFR spkg



---

archive/issue_comments_138165.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-08-03T11:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138165",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138166.json:
```json
{
    "body": "I did not look into the patch, but according to Jean-Pierre, you had problems with segfaults at quitting Sage.\n\nI am pretty much sure that this comes from something similar I had to struggle with at #12215 in the case of Pari. Namely, if you want to deallocate C-data of pari, flint, ... instances, you should do so in a `__dealloc__` method, but *not* like this:\n\n```\n    import sage.matrix.matrix_mod2_dense\n    sage.matrix.matrix_mod2_dense.free_m4ri()\n\n    import sage.libs.flint.flint\n    sage.libs.flint.flint.free_flint_stack()\n\n    pari._unsafe_deallocate_pari_stack()\n```\n\nThat is code from sage.all.quit_sage. I have replaced the pari._unsafe_deallocate... by a proper `__dealloc__` method in #12215, but perhaps you should do the same for the flint stack here?",
    "created_at": "2012-08-24T11:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138166",
    "user": "https://github.com/simon-king-jena"
}
```

I did not look into the patch, but according to Jean-Pierre, you had problems with segfaults at quitting Sage.

I am pretty much sure that this comes from something similar I had to struggle with at #12215 in the case of Pari. Namely, if you want to deallocate C-data of pari, flint, ... instances, you should do so in a `__dealloc__` method, but *not* like this:

```
    import sage.matrix.matrix_mod2_dense
    sage.matrix.matrix_mod2_dense.free_m4ri()

    import sage.libs.flint.flint
    sage.libs.flint.flint.free_flint_stack()

    pari._unsafe_deallocate_pari_stack()
```

That is code from sage.all.quit_sage. I have replaced the pari._unsafe_deallocate... by a proper `__dealloc__` method in #12215, but perhaps you should do the same for the flint stack here?



---

archive/issue_comments_138167.json:
```json
{
    "body": "I think there is two differences here which complicate the situation:\n* we don't have an equivalent of PARIUniqueInstance to which every Sage objects using (in)directly fmpz's could point to\n* I fear some classes keep C pointers to fmpz's without any Python level wrapping (such as gen in the PARI case) and free them when they are deleted.\n\nSo without implementing such a unique FLINT instance and pointing to it in every stuff using part of FLINT, it will be hard to ensure that every Sage object is deleted before calling the FLINT cleanup function.",
    "created_at": "2012-08-24T11:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138167",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think there is two differences here which complicate the situation:
* we don't have an equivalent of PARIUniqueInstance to which every Sage objects using (in)directly fmpz's could point to
* I fear some classes keep C pointers to fmpz's without any Python level wrapping (such as gen in the PARI case) and free them when they are deleted.

So without implementing such a unique FLINT instance and pointing to it in every stuff using part of FLINT, it will be hard to ensure that every Sage object is deleted before calling the FLINT cleanup function.



---

archive/issue_comments_138168.json:
```json
{
    "body": "How is this going?  Is this waiting on a review or does the problem Simon mentioned need to be solved first?",
    "created_at": "2012-10-15T08:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138168",
    "user": "https://github.com/roed314"
}
```

How is this going?  Is this waiting on a review or does the problem Simon mentioned need to be solved first?



---

archive/issue_comments_138169.json:
```json
{
    "body": "I think the spkg here is (almost?) completely usable.\n\nSimon's remark is sensible, but currently there should be no segfaults occurring at all.\nIt would surely lead to a better integration of Sage/Python and FLINT memory management, but this would need a huge amount of work, modifying all the pieces of code in Sage which directly use FLINT at the C/Cython level.\nThis could be a \"follow-up\" ticket (although the problem also exists with the previous versions of FLINT).\n\nThe main blocker now is to wait for the final FLINT 2.3 release.\n\n(I've update the spkg link to point to a working address)",
    "created_at": "2012-10-15T08:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138169",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think the spkg here is (almost?) completely usable.

Simon's remark is sensible, but currently there should be no segfaults occurring at all.
It would surely lead to a better integration of Sage/Python and FLINT memory management, but this would need a huge amount of work, modifying all the pieces of code in Sage which directly use FLINT at the C/Cython level.
This could be a "follow-up" ticket (although the problem also exists with the previous versions of FLINT).

The main blocker now is to wait for the final FLINT 2.3 release.

(I've update the spkg link to point to a working address)



---

archive/issue_comments_138170.json:
```json
{
    "body": "2.3 final is out.\n\nI guess we need a separate ticket for upgrading MPIR to 2.6.0?",
    "created_at": "2012-11-13T09:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138170",
    "user": "https://github.com/fredrik-johansson"
}
```

2.3 final is out.

I guess we need a separate ticket for upgrading MPIR to 2.6.0?



---

archive/issue_comments_138171.json:
```json
{
    "body": "Replying to [comment:134 fredrik.johansson]:\n> 2.3 final is out.\nIndeed :)\n> \n> I guess we need a separate ticket for upgrading MPIR to 2.6.0?\nI don't think this is mandatory to upgrade FLINT? Of course it would be nice to update MPIR as well.\n\nI'll try to upload an updated spkg containing the 2.3 final later today, so this should quite trivially get positive review.",
    "created_at": "2012-11-19T10:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138171",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:134 fredrik.johansson]:
> 2.3 final is out.
Indeed :)
> 
> I guess we need a separate ticket for upgrading MPIR to 2.6.0?
I don't think this is mandatory to upgrade FLINT? Of course it would be nice to update MPIR as well.

I'll try to upload an updated spkg containing the 2.3 final later today, so this should quite trivially get positive review.



---

archive/issue_comments_138172.json:
```json
{
    "body": "Oops, I just updated my repo and saw that Bill made MPIR 2.6.0 a prereq for FLINT 2.3...",
    "created_at": "2012-11-19T10:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138172",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Oops, I just updated my repo and saw that Bill made MPIR 2.6.0 a prereq for FLINT 2.3...



---

archive/issue_comments_138173.json:
```json
{
    "body": "The MPIR upgrade could be dealt with in #13137, although this was originally targetted for 2.5.*.",
    "created_at": "2012-11-19T11:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138173",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The MPIR upgrade could be dealt with in #13137, although this was originally targetted for 2.5.*.



---

archive/issue_comments_138174.json:
```json
{
    "body": "Attachment [flint-2.3-root-5.5.rc0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-root-5.5.rc0.patch) by jpflori created at 2012-11-23 16:53:31\n\nHere comes an updated spkg including FLINT 2.3 final at http://boxen.math.washington.edu/home/jpflori/flint-2.3.spkg\nand two combined and rebased patch to apply to Sage 5.5.rc0.\n\nThe only real additions were make to jack.patch because a lot of new doctests were included in sage/combinat/sf/jack.py and had to be fixed as well.\n\nThe other rebasing stuff was quite trivial.\n\nI've not included the renaming done by the previous 16-... patch to stick with FLINT terminology as it was surely a bad idea and broke some unpickling tests in Sage.\nAnyway, it can be done later.\n\nRemark that as Sage only includes MPIR 2.4.x and not MPIR 2.5.x, the FLINT spkg builds correctly and its and Sage test suite pass, so we could first include this, then work on upgrading MPIR directly to 2.6.x, skipping the problematic 2.5.x versions.",
    "created_at": "2012-11-23T16:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138174",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-root-5.5.rc0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-root-5.5.rc0.patch) by jpflori created at 2012-11-23 16:53:31

Here comes an updated spkg including FLINT 2.3 final at http://boxen.math.washington.edu/home/jpflori/flint-2.3.spkg
and two combined and rebased patch to apply to Sage 5.5.rc0.

The only real additions were make to jack.patch because a lot of new doctests were included in sage/combinat/sf/jack.py and had to be fixed as well.

The other rebasing stuff was quite trivial.

I've not included the renaming done by the previous 16-... patch to stick with FLINT terminology as it was surely a bad idea and broke some unpickling tests in Sage.
Anyway, it can be done later.

Remark that as Sage only includes MPIR 2.4.x and not MPIR 2.5.x, the FLINT spkg builds correctly and its and Sage test suite pass, so we could first include this, then work on upgrading MPIR directly to 2.6.x, skipping the problematic 2.5.x versions.



---

archive/issue_comments_138175.json:
```json
{
    "body": "Attachment [flint-2.3-combined-5.5.rc0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-combined-5.5.rc0.patch) by jpflori created at 2012-11-24 21:36:51\n\nWorking version",
    "created_at": "2012-11-24T21:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138175",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-combined-5.5.rc0.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-combined-5.5.rc0.patch) by jpflori created at 2012-11-24 21:36:51

Working version



---

archive/issue_comments_138176.json:
```json
{
    "body": "I was delighted to see that people have done all the work in getting flint-2.3 into Sage, as I am planning to make it a dependency for eclib.\n\nI am happy to test the new spkg and patch from this ticket, and hope that doing so without reading all the above comments will still be useful input.",
    "created_at": "2012-12-31T16:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138176",
    "user": "https://github.com/JohnCremona"
}
```

I was delighted to see that people have done all the work in getting flint-2.3 into Sage, as I am planning to make it a dependency for eclib.

I am happy to test the new spkg and patch from this ticket, and hope that doing so without reading all the above comments will still be useful input.



---

archive/issue_comments_138177.json:
```json
{
    "body": "Replying to [comment:140 cremona]:\n> I was delighted to see that people have done all the work in getting flint-2.3 into Sage, as I am planning to make it a dependency for eclib.\n> \n> I am happy to test the new spkg and patch from this ticket, and hope that doing so without reading all the above comments will still be useful input.\n\nThe new spkg built fine for me (64-bit ubuntu), the patches both applied fine to sage-5.5, and all tests pass.  Hence:\n\n+1 to a positive review.",
    "created_at": "2012-12-31T17:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138177",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:140 cremona]:
> I was delighted to see that people have done all the work in getting flint-2.3 into Sage, as I am planning to make it a dependency for eclib.
> 
> I am happy to test the new spkg and patch from this ticket, and hope that doing so without reading all the above comments will still be useful input.

The new spkg built fine for me (64-bit ubuntu), the patches both applied fine to sage-5.5, and all tests pass.  Hence:

+1 to a positive review.



---

archive/issue_comments_138178.json:
```json
{
    "body": "The spkg should be rebased to the flint-1.5.2.p2 package currently in Sage.\n\nAlso, the deprecated `_sig_on` and `_sig_off` should be replaced by `sig_on()` and `sig_off()`.",
    "created_at": "2013-01-11T16:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138178",
    "user": "https://github.com/jdemeyer"
}
```

The spkg should be rebased to the flint-1.5.2.p2 package currently in Sage.

Also, the deprecated `_sig_on` and `_sig_off` should be replaced by `sig_on()` and `sig_off()`.



---

archive/issue_comments_138179.json:
```json
{
    "body": "Root patch",
    "created_at": "2013-01-11T16:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138179",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Root patch



---

archive/issue_comments_138180.json:
```json
{
    "body": "Attachment [flint-2.3-combined-5.6.b3.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-combined-5.6.b3.patch) by jpflori created at 2013-01-11 16:58:32\n\nLibrary patch",
    "created_at": "2013-01-11T16:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138180",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-combined-5.6.b3.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-combined-5.6.b3.patch) by jpflori created at 2013-01-11 16:58:32

Library patch



---

archive/issue_comments_138181.json:
```json
{
    "body": "Replying to [comment:142 jdemeyer]:\n> The spkg should be rebased to the flint-1.5.2.p2 package currently in Sage.\n> \nDone.\n> Also, the deprecated `_sig_on` and `_sig_off` should be replaced by `sig_on()` and `sig_off()`.\nDone.",
    "created_at": "2013-01-11T16:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138181",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:142 jdemeyer]:
> The spkg should be rebased to the flint-1.5.2.p2 package currently in Sage.
> 
Done.
> Also, the deprecated `_sig_on` and `_sig_off` should be replaced by `sig_on()` and `sig_off()`.
Done.



---

archive/issue_comments_138182.json:
```json
{
    "body": "I removed the longlong patch as the asm code completely changed.\nHopefully no new fix is needed but that will need testing on ARM, not sure that was done during the FLINT release process.",
    "created_at": "2013-01-11T17:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138182",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I removed the longlong patch as the asm code completely changed.
Hopefully no new fix is needed but that will need testing on ARM, not sure that was done during the FLINT release process.



---

archive/issue_comments_138183.json:
```json
{
    "body": "The new spkg builds fine for me (64-bit ubuntu) with SAGE_CHECK=yes.  I am running a full test after applying both patches and doing sage -br.\n\nAll tests pass.  I'm not sure that I will test it again after Jeroen's suggested edits!",
    "created_at": "2013-01-11T20:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138183",
    "user": "https://github.com/JohnCremona"
}
```

The new spkg builds fine for me (64-bit ubuntu) with SAGE_CHECK=yes.  I am running a full test after applying both patches and doing sage -br.

All tests pass.  I'm not sure that I will test it again after Jeroen's suggested edits!



---

archive/issue_comments_138184.json:
```json
{
    "body": "Allow me to suggest a few small changes to `spkg-install`:\n\n1. Change\n\n```\nCFLAGS=\"-O0 -g\"; export CFLAGS\n```\n\nto\n\n```\nexport CFLAGS=\"-O0 -g $CFLAGS\"\n```\n\n\n2. Rename `$EXTRA_CONF` to `$FLINT_CONFIGURE` for analogy with other packages, **don't** quote it in the `./configure` invocation and change\n\n```\nEXTRA_CONF=\"--disable-static\"\n```\n\nto\n\n```\nFLINT_CONFIGURE=\"--disable-static $FLINT_CONFIGURE\"\n```\n\n\n3. Quote `$SAGE_LOCAL`:\n\n```\nrm -f \"$SAGE_LOCAL\"/lib/libflint* \nrm -rf \"$SAGE_LOCAL\"/include/flint \n```\n\n\n4. Why doesn't `spkg-check` have a newline at the end of the file?",
    "created_at": "2013-01-11T20:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138184",
    "user": "https://github.com/jdemeyer"
}
```

Allow me to suggest a few small changes to `spkg-install`:

1. Change

```
CFLAGS="-O0 -g"; export CFLAGS
```

to

```
export CFLAGS="-O0 -g $CFLAGS"
```


2. Rename `$EXTRA_CONF` to `$FLINT_CONFIGURE` for analogy with other packages, **don't** quote it in the `./configure` invocation and change

```
EXTRA_CONF="--disable-static"
```

to

```
FLINT_CONFIGURE="--disable-static $FLINT_CONFIGURE"
```


3. Quote `$SAGE_LOCAL`:

```
rm -f "$SAGE_LOCAL"/lib/libflint* 
rm -rf "$SAGE_LOCAL"/include/flint 
```


4. Why doesn't `spkg-check` have a newline at the end of the file?



---

archive/issue_comments_138185.json:
```json
{
    "body": "Attachment [flint-2.3+reviewer.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3+reviewer.diff) by jpflori created at 2013-01-11 22:52:41\n\nSpkg diff, for review only.",
    "created_at": "2013-01-11T22:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138185",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3+reviewer.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3+reviewer.diff) by jpflori created at 2013-01-11 22:52:41

Spkg diff, for review only.



---

archive/issue_comments_138186.json:
```json
{
    "body": "Replying to [comment:146 jdemeyer]:\n> Allow me to suggest a few small changes to `spkg-install`:\n> \n> 1. Change\n> {{{\n> CFLAGS=\"-O0 -g\"; export CFLAGS\n> }}}\n> to\n> {{{\n> export CFLAGS=\"-O0 -g $CFLAGS\"\n> }}}\nDone for CFLAGS and similar exports.\n> \n> 2. Rename `$EXTRA_CONF` to `$FLINT_CONFIGURE` for analogy with other packages, **don't** quote it in the `./configure` invocation and change\n> {{{\n> EXTRA_CONF=\"--disable-static\"\n> }}}\n> to\n> {{{\n> FLINT_CONFIGURE=\"--disable-static $FLINT_CONFIGURE\"\n> }}}\n> \nDone.\nWhy not quote FLINT_CONFIGURE?\n> 3. Quote `$SAGE_LOCAL`:\n> {{{\n> rm -f \"$SAGE_LOCAL\"/lib/libflint* \n> rm -rf \"$SAGE_LOCAL\"/include/flint \n> }}}\nDone.\n> \n> 4. Why doesn't `spkg-check` have a newline at the end of the file?\nNo reason, it's in now.",
    "created_at": "2013-01-11T22:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138186",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:146 jdemeyer]:
> Allow me to suggest a few small changes to `spkg-install`:
> 
> 1. Change
> {{{
> CFLAGS="-O0 -g"; export CFLAGS
> }}}
> to
> {{{
> export CFLAGS="-O0 -g $CFLAGS"
> }}}
Done for CFLAGS and similar exports.
> 
> 2. Rename `$EXTRA_CONF` to `$FLINT_CONFIGURE` for analogy with other packages, **don't** quote it in the `./configure` invocation and change
> {{{
> EXTRA_CONF="--disable-static"
> }}}
> to
> {{{
> FLINT_CONFIGURE="--disable-static $FLINT_CONFIGURE"
> }}}
> 
Done.
Why not quote FLINT_CONFIGURE?
> 3. Quote `$SAGE_LOCAL`:
> {{{
> rm -f "$SAGE_LOCAL"/lib/libflint* 
> rm -rf "$SAGE_LOCAL"/include/flint 
> }}}
Done.
> 
> 4. Why doesn't `spkg-check` have a newline at the end of the file?
No reason, it's in now.



---

archive/issue_comments_138187.json:
```json
{
    "body": "Replying to [comment:147 jpflori]:\n> Why not quote FLINT_CONFIGURE?\nTo allow\n\n```\nFLINT_CONFIGURE=\"--enable-foo --disable-bar\"\n```\n\nYou want this to be two separate words, similar to how `$CC` and `$CFLAGS` should not be quoted.",
    "created_at": "2013-01-12T07:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138187",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:147 jpflori]:
> Why not quote FLINT_CONFIGURE?
To allow

```
FLINT_CONFIGURE="--enable-foo --disable-bar"
```

You want this to be two separate words, similar to how `$CC` and `$CFLAGS` should not be quoted.



---

archive/issue_comments_138188.json:
```json
{
    "body": "This breaks all over the place on OS X, see [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio)\n\nThis also shows that some `cdef` functions should have `except` clauses, in particular\n\n```\ncdef void _set_fmpz_poly(self, fmpz_poly_t)\n```\n\nOtherwise, what's the point of `sig_on()`?",
    "created_at": "2013-01-14T12:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138188",
    "user": "https://github.com/jdemeyer"
}
```

This breaks all over the place on OS X, see [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio)

This also shows that some `cdef` functions should have `except` clauses, in particular

```
cdef void _set_fmpz_poly(self, fmpz_poly_t)
```

Otherwise, what's the point of `sig_on()`?



---

archive/issue_comments_138189.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-14T12:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138189",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_138190.json:
```json
{
    "body": "Replying to [comment:149 jdemeyer]:\n> This breaks all over the place on OS X, see [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio)\nDoes FLINT pass its testsuite there?\n(I don't have access to bsd so cannot check for myself.)\n> \n> This also shows that some `cdef` functions should have `except` clauses, in particular\n> {{{\n> cdef void _set_fmpz_poly(self, fmpz_poly_t)\n> }}}\n> Otherwise, what's the point of `sig_on()`?",
    "created_at": "2013-01-14T12:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138190",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:149 jdemeyer]:
> This breaks all over the place on OS X, see [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio)
Does FLINT pass its testsuite there?
(I don't have access to bsd so cannot check for myself.)
> 
> This also shows that some `cdef` functions should have `except` clauses, in particular
> {{{
> cdef void _set_fmpz_poly(self, fmpz_poly_t)
> }}}
> Otherwise, what's the point of `sig_on()`?



---

archive/issue_comments_138191.json:
```json
{
    "body": "Replying to [comment:151 jpflori]:\n> Replying to [comment:149 jdemeyer]:\n> > This breaks all over the place on OS X, see [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio)\n> Does FLINT pass its testsuite there?\nYes, it does.",
    "created_at": "2013-01-14T14:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138191",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:151 jpflori]:
> Replying to [comment:149 jdemeyer]:
> > This breaks all over the place on OS X, see [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/192/steps/shell_7/logs/stdio)
> Does FLINT pass its testsuite there?
Yes, it does.



---

archive/issue_comments_138192.json:
```json
{
    "body": "This is problematic:\n\n```\n     Extension('sage.rings.fraction_field_FpT',\n               sources = ['sage/rings/fraction_field_FpT.pyx'],\n               language = 'c++',\n               libraries = [\"csage\", \"flint\", \"gmp\", \"gmpxx\", \"ntl\", \"zn_poly\"],\n               extra_compile_args=[\"-std=c99\", \"-D_XPG6\"],\n               include_dirs = [SAGE_INC + 'flint/'],\n               depends = flint_depends),\n```\n\nA file cannot be both C++ and C99.\n\nThis causes a build failure on OpenSolaris (buildbot machine `hawk`).",
    "created_at": "2013-01-15T11:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138192",
    "user": "https://github.com/jdemeyer"
}
```

This is problematic:

```
     Extension('sage.rings.fraction_field_FpT',
               sources = ['sage/rings/fraction_field_FpT.pyx'],
               language = 'c++',
               libraries = ["csage", "flint", "gmp", "gmpxx", "ntl", "zn_poly"],
               extra_compile_args=["-std=c99", "-D_XPG6"],
               include_dirs = [SAGE_INC + 'flint/'],
               depends = flint_depends),
```

A file cannot be both C++ and C99.

This causes a build failure on OpenSolaris (buildbot machine `hawk`).



---

archive/issue_comments_138193.json:
```json
{
    "body": "Attachment [12173_fixes.patch](tarball://root/attachments/some-uuid/ticket12173/12173_fixes.patch) by @jdemeyer created at 2013-01-17 14:09:23",
    "created_at": "2013-01-17T14:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138193",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12173_fixes.patch](tarball://root/attachments/some-uuid/ticket12173/12173_fixes.patch) by @jdemeyer created at 2013-01-17 14:09:23



---

archive/issue_comments_138194.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-17T14:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138194",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138195.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-17T14:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138195",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_138196.json:
```json
{
    "body": "Your changes look good, so I'm putting back this to positive review with the idea it will relaunch a set of tests on the buildbots (am I wrong?) even though I cannot really think of how this could fix the bsd problems.",
    "created_at": "2013-01-17T14:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138196",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Your changes look good, so I'm putting back this to positive review with the idea it will relaunch a set of tests on the buildbots (am I wrong?) even though I cannot really think of how this could fix the bsd problems.



---

archive/issue_comments_138197.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-01-17T14:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138197",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_138198.json:
```json
{
    "body": "Replying to [comment:156 jpflori]:\n> Your changes look good, so I'm putting back this to positive review with the idea it will relaunch a set of tests on the buildbots (am I wrong?) even though I cannot really think of how this could fix the bsd problems.\n\nNot so fast.  First of all, the main FLINT patch never received positive_review.  And then indeed, it's unlikely the OS X problems are resolved.",
    "created_at": "2013-01-17T14:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138198",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:156 jpflori]:
> Your changes look good, so I'm putting back this to positive review with the idea it will relaunch a set of tests on the buildbots (am I wrong?) even though I cannot really think of how this could fix the bsd problems.

Not so fast.  First of all, the main FLINT patch never received positive_review.  And then indeed, it's unlikely the OS X problems are resolved.



---

archive/issue_comments_138199.json:
```json
{
    "body": "Replying to [comment:157 jdemeyer]:\n> Replying to [comment:156 jpflori]:\n> > Your changes look good, so I'm putting back this to positive review with the idea it will relaunch a set of tests on the buildbots (am I wrong?) even though I cannot really think of how this could fix the bsd problems.\n> \n> Not so fast.  First of all, the main FLINT patch never received positive_review.\nHum, that's true.\n> And then indeed, it's unlikely the OS X problems are resolved.\nAnyway, it leaves you the pleasure to launch tests on bsd.\nCannot do much about that as I don't have access to such systems and I won't have time to stare at the code thinking about what goes wrong in factor() or whatever.",
    "created_at": "2013-01-17T14:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138199",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:157 jdemeyer]:
> Replying to [comment:156 jpflori]:
> > Your changes look good, so I'm putting back this to positive review with the idea it will relaunch a set of tests on the buildbots (am I wrong?) even though I cannot really think of how this could fix the bsd problems.
> 
> Not so fast.  First of all, the main FLINT patch never received positive_review.
Hum, that's true.
> And then indeed, it's unlikely the OS X problems are resolved.
Anyway, it leaves you the pleasure to launch tests on bsd.
Cannot do much about that as I don't have access to such systems and I won't have time to stare at the code thinking about what goes wrong in factor() or whatever.



---

archive/issue_comments_138200.json:
```json
{
    "body": "Looks like a chicken-and-egg situation, if the only way to get buildbots to test it is to give it a positive review!",
    "created_at": "2013-01-17T16:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138200",
    "user": "https://github.com/JohnCremona"
}
```

Looks like a chicken-and-egg situation, if the only way to get buildbots to test it is to give it a positive review!



---

archive/issue_comments_138201.json:
```json
{
    "body": "Replying to [comment:159 cremona]:\n> Looks like a chicken-and-egg situation, if the only way to get buildbots to test it is to give it a positive review!\nThat's not really true.  I sometimes test tickets (like this one) which don't have positive review.\n\nHowever: if a reviewer thinks a ticket is good, except perhaps that it hasn't been tested on some systems, then that reviewer should put the ticket to positive_review to get it tested.  But that's not the situation here, no reviewer has looked sufficiently well at the patch to approve it.",
    "created_at": "2013-01-17T18:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138201",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:159 cremona]:
> Looks like a chicken-and-egg situation, if the only way to get buildbots to test it is to give it a positive review!
That's not really true.  I sometimes test tickets (like this one) which don't have positive review.

However: if a reviewer thinks a ticket is good, except perhaps that it hasn't been tested on some systems, then that reviewer should put the ticket to positive_review to get it tested.  But that's not the situation here, no reviewer has looked sufficiently well at the patch to approve it.



---

archive/issue_comments_138202.json:
```json
{
    "body": "For easier reviewing, it would really be good to split up the big patchbomb into a \"rename methods\" patch (e.g. from zmod to nmod) which does only that and should be automatically generated and a \"remainder\" patch.",
    "created_at": "2013-01-18T09:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138202",
    "user": "https://github.com/jdemeyer"
}
```

For easier reviewing, it would really be good to split up the big patchbomb into a "rename methods" patch (e.g. from zmod to nmod) which does only that and should be automatically generated and a "remainder" patch.



---

archive/issue_comments_138203.json:
```json
{
    "body": "In fact the changes used to be split among different patches, but at some point I've gather them back together thinking it would be easier to maintain them that way.\n\nYou can see the previous bunch of patch in the diff at http://trac.sagemath.org/sage_trac/ticket/12173#comment:138\nExcept for additional changes in jack.pyx and the removal of a bad change I made, the changes did not really evolve IIRC, maybe some rebasing only.\nI don't really feel like resplitting everything back now...",
    "created_at": "2013-01-18T09:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138203",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

In fact the changes used to be split among different patches, but at some point I've gather them back together thinking it would be easier to maintain them that way.

You can see the previous bunch of patch in the diff at http://trac.sagemath.org/sage_trac/ticket/12173#comment:138
Except for additional changes in jack.pyx and the removal of a bad change I made, the changes did not really evolve IIRC, maybe some rebasing only.
I don't really feel like resplitting everything back now...



---

archive/issue_comments_138204.json:
```json
{
    "body": "In any case, things still look very bad on OS X: [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/194/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/194/steps/shell_7/logs/stdio)",
    "created_at": "2013-01-18T13:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138204",
    "user": "https://github.com/jdemeyer"
}
```

In any case, things still look very bad on OS X: [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/194/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/194/steps/shell_7/logs/stdio)



---

archive/issue_comments_138205.json:
```json
{
    "body": "On OS X 10.4 PPC, Sage doesn't even start:\n\n```\n\nTesting that Sage starts...\n[2013-01-18 19:51:11] Sage version 5.7.alpha0, released 2013-01-17\nTraceback (most recent call last):\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/bin/sage-eval\", line 4, in <module>\n    from sage.all import *\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/all.py\", line 66, in <module>\n    from sage.misc.all       import *         # takes a while\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/misc/all.py\", line 83, in <module>\n    from functional import (additive_order,\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 36, in <module>\n    from sage.rings.complex_double import CDF\n  File \"integer.pxd\", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:16552)\nImportError: dlopen(/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/rings/integer.so, 2): Symbol not found: _n_factor\n  Referenced from: /Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/rings/integer.so\n  Expected in: dynamic lookup\n```\n",
    "created_at": "2013-01-19T09:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138205",
    "user": "https://github.com/jdemeyer"
}
```

On OS X 10.4 PPC, Sage doesn't even start:

```

Testing that Sage starts...
[2013-01-18 19:51:11] Sage version 5.7.alpha0, released 2013-01-17
Traceback (most recent call last):
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/bin/sage-eval", line 4, in <module>
    from sage.all import *
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/all.py", line 66, in <module>
    from sage.misc.all       import *         # takes a while
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/misc/all.py", line 83, in <module>
    from functional import (additive_order,
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/misc/functional.py", line 36, in <module>
    from sage.rings.complex_double import CDF
  File "integer.pxd", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:16552)
ImportError: dlopen(/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/rings/integer.so, 2): Symbol not found: _n_factor
  Referenced from: /Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.7.alpha0/local/lib/python2.7/site-packages/sage/rings/integer.so
  Expected in: dynamic lookup
```




---

archive/issue_comments_138206.json:
```json
{
    "body": "On all buildbot systems which aren't OS X, this builds fine and all doctests pass.",
    "created_at": "2013-01-19T09:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138206",
    "user": "https://github.com/jdemeyer"
}
```

On all buildbot systems which aren't OS X, this builds fine and all doctests pass.



---

archive/issue_comments_138207.json:
```json
{
    "body": "So are there any developers around with access to an OS X system who'd be able to take a look at this?",
    "created_at": "2013-01-25T09:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138207",
    "user": "https://github.com/fredrik-johansson"
}
```

So are there any developers around with access to an OS X system who'd be able to take a look at this?



---

archive/issue_comments_138208.json:
```json
{
    "body": "Replying to [comment:166 fredrik.johansson]:\n> So are there any developers around with access to an OS X system who'd be able to take a look at this?\nDoes not look so.\nMaybe the easiest way is to ask William for access to bsd.",
    "created_at": "2013-01-25T10:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138208",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:166 fredrik.johansson]:
> So are there any developers around with access to an OS X system who'd be able to take a look at this?
Does not look so.
Maybe the easiest way is to ask William for access to bsd.



---

archive/issue_comments_138209.json:
```json
{
    "body": "Hum, that's not just OS X that OS X on PPC. By the look of the log I am wondering if flint was built properly. I don't know if the buildbot run with spkg-check but I would be curious to see the result on that machine. And the build log too.\n\nKarl-dieter has (or had) such a machine.",
    "created_at": "2013-01-25T10:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138209",
    "user": "https://github.com/kiwifb"
}
```

Hum, that's not just OS X that OS X on PPC. By the look of the log I am wondering if flint was built properly. I don't know if the buildbot run with spkg-check but I would be curious to see the result on that machine. And the build log too.

Karl-dieter has (or had) such a machine.



---

archive/issue_comments_138210.json:
```json
{
    "body": "There are problems on all OS X machines, it's just that the problem on OS X 10.4 PPC is *different* from the problems with other OS X versions.",
    "created_at": "2013-01-25T10:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138210",
    "user": "https://github.com/jdemeyer"
}
```

There are problems on all OS X machines, it's just that the problem on OS X 10.4 PPC is *different* from the problems with other OS X versions.



---

archive/issue_comments_138211.json:
```json
{
    "body": "Then I can have a look at it (10.5.8). I'll see if beta0 build at the same time, that may be another issue in and of itself.",
    "created_at": "2013-01-25T10:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138211",
    "user": "https://github.com/kiwifb"
}
```

Then I can have a look at it (10.5.8). I'll see if beta0 build at the same time, that may be another issue in and of itself.



---

archive/issue_comments_138212.json:
```json
{
    "body": "It built for me on 10.6.8 and all tests passed.  What kind of errors should I be looking for?",
    "created_at": "2013-01-27T09:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138212",
    "user": "https://github.com/roed314"
}
```

It built for me on 10.6.8 and all tests passed.  What kind of errors should I be looking for?



---

archive/issue_comments_138213.json:
```json
{
    "body": "Replying to [comment:171 roed]:\n> It built for me on 10.6.8 and all tests passed.\nThat's totally wierd.  I doesn't work on any OS X buildbot machine (there are 3 of them).\n\n> What kind of errors should I be looking for?\n\n```\nThe following tests failed:\n\n\tsage -t  --long -force_lib devel/sage/doc/de/tutorial/tour_advanced.rst # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/doc/en/constructions/modular_forms.rst # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/doc/en/bordeaux_2008/birds_other.rst # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/doc/en/tutorial/tour_advanced.rst # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/doc/fr/tutorial/tour_advanced.rst # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/doc/ru/tutorial/tour_advanced.rst # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/matrix/matrix_modn_dense_template.pxi # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/matrix/matrix2.pyx # 2 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/modular/buzzard.py # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/modular/abvar/abvar.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/abvar/torsion_subgroup.py # 4 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/ambient.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/eis_series.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/constructor.py # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/find_generators.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/hecke_operator_on_qexp.py # 2 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/vm_basis.py # 2 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/space.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modsym/ambient.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modsym/subspace.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/overconvergent/genus0.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/overconvergent/hecke_series.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/rings/qqbar.py # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/rings/number_field/number_field.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/rings/number_field/number_field_element.pyx # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/rings/polynomial/complex_roots.py # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/rings/polynomial/polynomial_element.pyx # 1 doctests failed\n\tsage -t  --long -force_lib devel/sage/sage/schemes/elliptic_curves/gal_reps.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # Killed/crashed\n\tsage -t  --long -force_lib devel/sage/sage/modular/modform/element.py # Time out\n\tsage -t  --long -force_lib devel/sage/sage/tests/book_stein_modform.py # 2 doctests failed\n```\n",
    "created_at": "2013-01-27T10:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138213",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:171 roed]:
> It built for me on 10.6.8 and all tests passed.
That's totally wierd.  I doesn't work on any OS X buildbot machine (there are 3 of them).

> What kind of errors should I be looking for?

```
The following tests failed:

	sage -t  --long -force_lib devel/sage/doc/de/tutorial/tour_advanced.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/doc/en/constructions/modular_forms.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/doc/en/bordeaux_2008/birds_other.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/doc/en/tutorial/tour_advanced.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/doc/fr/tutorial/tour_advanced.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/doc/ru/tutorial/tour_advanced.rst # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/matrix/matrix_modn_dense_template.pxi # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/matrix/matrix2.pyx # 2 doctests failed
	sage -t  --long -force_lib devel/sage/sage/modular/buzzard.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/modular/abvar/abvar.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/abvar/torsion_subgroup.py # 4 doctests failed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/ambient.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/eis_series.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/constructor.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/find_generators.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/hecke_operator_on_qexp.py # 2 doctests failed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/vm_basis.py # 2 doctests failed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/space.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/modsym/ambient.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/modsym/subspace.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/overconvergent/genus0.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/overconvergent/hecke_series.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/rings/qqbar.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/rings/number_field/number_field.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/rings/number_field/number_field_element.pyx # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/rings/polynomial/complex_roots.py # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/rings/polynomial/polynomial_element.pyx # 1 doctests failed
	sage -t  --long -force_lib devel/sage/sage/schemes/elliptic_curves/gal_reps.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # Killed/crashed
	sage -t  --long -force_lib devel/sage/sage/modular/modform/element.py # Time out
	sage -t  --long -force_lib devel/sage/sage/tests/book_stein_modform.py # 2 doctests failed
```




---

archive/issue_comments_138214.json:
```json
{
    "body": "The first patch to the library doesn't apply properly over 5.7.beta0. Looking into it but I hope it won't need more changes for beta1.",
    "created_at": "2013-01-27T23:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138214",
    "user": "https://github.com/kiwifb"
}
```

The first patch to the library doesn't apply properly over 5.7.beta0. Looking into it but I hope it won't need more changes for beta1.



---

archive/issue_comments_138215.json:
```json
{
    "body": "All tests passed on top of 5.6.rc0 (which I had handy) on an iMAC core2 duo running 10.5.8. No clues what could go wrong on the build bots. This build used the gcc shipped with this particular version of sage.",
    "created_at": "2013-01-28T02:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138215",
    "user": "https://github.com/kiwifb"
}
```

All tests passed on top of 5.6.rc0 (which I had handy) on an iMAC core2 duo running 10.5.8. No clues what could go wrong on the build bots. This build used the gcc shipped with this particular version of sage.



---

archive/issue_comments_138216.json:
```json
{
    "body": "Replying to [comment:174 fbissey]:\n> All tests passed on top of 5.6.rc0 (which I had handy) on an iMAC core2 duo running 10.5.8. No clues what could go wrong on the build bots.\nPerhaps you just have a lucky version? I could very well be that versions >= 10.6 have a problem and versions <= 10.4 a different problem.\n\n> This build used the gcc shipped with this particular version of sage. \nThe buildbot machines also.",
    "created_at": "2013-01-28T07:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138216",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:174 fbissey]:
> All tests passed on top of 5.6.rc0 (which I had handy) on an iMAC core2 duo running 10.5.8. No clues what could go wrong on the build bots.
Perhaps you just have a lucky version? I could very well be that versions >= 10.6 have a problem and versions <= 10.4 a different problem.

> This build used the gcc shipped with this particular version of sage. 
The buildbot machines also.



---

archive/issue_comments_138217.json:
```json
{
    "body": "But I'm having no trouble with 10.6.8.  What version of OS X are the buildbot machines running?",
    "created_at": "2013-01-28T07:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138217",
    "user": "https://github.com/roed314"
}
```

But I'm having no trouble with 10.6.8.  What version of OS X are the buildbot machines running?



---

archive/issue_comments_138218.json:
```json
{
    "body": "May be the order things are done matters. I had a plain 5.6.rc0 on which I applied the patches. Then I updated flint. Finally I did sage -ba.\n\nI assume the buildbots never built flint-1.5 and used a prepatched sage-root and sage spkg. I cannot prepare this particular test before tomorrow.\n\nI actually cannot access my iMac before tomorrow (it's shutdown down and someone is borrowing it for video conferencing) but I am wondering if my build and David's still have an old dylib of the previous flint. The way flint is upgraded probably don't remove everything of flint 1.5/ It merely overwrite the common files and leave the other in place. If there is a versionned libflint-1.5.dylib it probably is still there.\n\nCould you try to find if there are still bits of flint 1.5 on your install and remove them David?",
    "created_at": "2013-01-28T08:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138218",
    "user": "https://github.com/kiwifb"
}
```

May be the order things are done matters. I had a plain 5.6.rc0 on which I applied the patches. Then I updated flint. Finally I did sage -ba.

I assume the buildbots never built flint-1.5 and used a prepatched sage-root and sage spkg. I cannot prepare this particular test before tomorrow.

I actually cannot access my iMac before tomorrow (it's shutdown down and someone is borrowing it for video conferencing) but I am wondering if my build and David's still have an old dylib of the previous flint. The way flint is upgraded probably don't remove everything of flint 1.5/ It merely overwrite the common files and leave the other in place. If there is a versionned libflint-1.5.dylib it probably is still there.

Could you try to find if there are still bits of flint 1.5 on your install and remove them David?



---

archive/issue_comments_138219.json:
```json
{
    "body": "The buildbots always do a complete install from source, so there was never a FLINT-1.5 with the buildbot tests.  The OS X buildbots are 10.4 PCC, 10.6 x86_64, 10.8 x86_64.",
    "created_at": "2013-01-28T08:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138219",
    "user": "https://github.com/jdemeyer"
}
```

The buildbots always do a complete install from source, so there was never a FLINT-1.5 with the buildbot tests.  The OS X buildbots are 10.4 PCC, 10.6 x86_64, 10.8 x86_64.



---

archive/issue_comments_138220.json:
```json
{
    "body": "OK my iMAC is 10.5 \"x86_32\" that may be part of it.",
    "created_at": "2013-01-28T08:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138220",
    "user": "https://github.com/kiwifb"
}
```

OK my iMAC is 10.5 "x86_32" that may be part of it.



---

archive/issue_comments_138221.json:
```json
{
    "body": "Rebased on top of 5.7.beta1",
    "created_at": "2013-01-29T13:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138221",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Rebased on top of 5.7.beta1



---

archive/issue_comments_138222.json:
```json
{
    "body": "Attachment [flint-2.3-combined-5.7.b1.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-combined-5.7.b1.patch) by jpflori created at 2013-01-29 13:55:15",
    "created_at": "2013-01-29T13:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138222",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-combined-5.7.b1.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-combined-5.7.b1.patch) by jpflori created at 2013-01-29 13:55:15



---

archive/issue_comments_138223.json:
```json
{
    "body": "Rebased patch on top of 5.7.beta1",
    "created_at": "2013-01-29T13:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138223",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Rebased patch on top of 5.7.beta1



---

archive/issue_comments_138224.json:
```json
{
    "body": "Replying to [comment:177 fbissey]:\n> May be the order things are done matters. I had a plain 5.6.rc0 on which I applied the patches. Then I updated flint. Finally I did sage -ba.\n\nI started with a freshly built 5.6, installed the spkg and patches and then did sage -b.\n\n> The way flint is upgraded probably don't remove everything of flint 1.5/ It merely overwrite the common files and leave the other in place. If there is a versionned libflint-1.5.dylib it probably is still there.\n\nI ran \"find $SAGE_ROOT -name *flint* -print,\" and the only versioned files I found were\n\n\n```\n./spkg/installed/flint-1.5.2.p2\n./spkg/installed/flint-2.3\n./spkg/logs/flint-1.5.2.p2.log\n./spkg/logs/flint-2.3.log\n./spkg/optional/flint-2.3.spkg\n./spkg/standard/flint-1.5.2.p2.spkg\n```\n\n\nThe .a, .o, .so and .dylib files were all unversioned:\n\n\n```\n./devel/sage-main/build/temp.macosx-10.6-x86_64-2.7/sage/libs/flint/flint.o\n./local/lib/libflint.a\n./local/lib/libflint.dylib\n```\n\n\n> Could you try to find if there are still bits of flint 1.5 on your install and remove them David?\n\nAre there any of the above that actually matter removing?",
    "created_at": "2013-01-29T15:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138224",
    "user": "https://github.com/roed314"
}
```

Replying to [comment:177 fbissey]:
> May be the order things are done matters. I had a plain 5.6.rc0 on which I applied the patches. Then I updated flint. Finally I did sage -ba.

I started with a freshly built 5.6, installed the spkg and patches and then did sage -b.

> The way flint is upgraded probably don't remove everything of flint 1.5/ It merely overwrite the common files and leave the other in place. If there is a versionned libflint-1.5.dylib it probably is still there.

I ran "find $SAGE_ROOT -name *flint* -print," and the only versioned files I found were


```
./spkg/installed/flint-1.5.2.p2
./spkg/installed/flint-2.3
./spkg/logs/flint-1.5.2.p2.log
./spkg/logs/flint-2.3.log
./spkg/optional/flint-2.3.spkg
./spkg/standard/flint-1.5.2.p2.spkg
```


The .a, .o, .so and .dylib files were all unversioned:


```
./devel/sage-main/build/temp.macosx-10.6-x86_64-2.7/sage/libs/flint/flint.o
./local/lib/libflint.a
./local/lib/libflint.dylib
```


> Could you try to find if there are still bits of flint 1.5 on your install and remove them David?

Are there any of the above that actually matter removing?



---

archive/issue_comments_138225.json:
```json
{
    "body": "Replying to [comment:182 roed]:\n> Replying to [comment:177 fbissey]:\n> > May be the order things are done matters. I had a plain 5.6.rc0 on which I applied the patches. Then I updated flint. Finally I did sage -ba.\n> \n> I started with a freshly built 5.6, installed the spkg and patches and then did sage -b.\n> \n> > The way flint is upgraded probably don't remove everything of flint 1.5/ It merely overwrite the common files and leave the other in place. If there is a versionned libflint-1.5.dylib it probably is still there.\n> \n> I ran \"find $SAGE_ROOT -name *flint* -print,\" and the only versioned files I found were\n> \n> {{{\n> ./spkg/installed/flint-1.5.2.p2\n> ./spkg/installed/flint-2.3\n> ./spkg/logs/flint-1.5.2.p2.log\n> ./spkg/logs/flint-2.3.log\n> ./spkg/optional/flint-2.3.spkg\n> ./spkg/standard/flint-1.5.2.p2.spkg\n> }}}\n> \n> The .a, .o, .so and .dylib files were all unversioned:\n> \n> {{{\n> ./devel/sage-main/build/temp.macosx-10.6-x86_64-2.7/sage/libs/flint/flint.o\n> ./local/lib/libflint.a\n> ./local/lib/libflint.dylib\n> }}}\n> \n> > Could you try to find if there are still bits of flint 1.5 on your install and remove them David?\n> \n> Are there any of the above that actually matter removing?\n\nIt was an idea that I had but it turns out flint is indeed unversioned and the spkg tries to clean previous install before putting the new libs. So that's a dead end. No need to remove anything. I am trying with a build including flint 2.3 from scratch.",
    "created_at": "2013-01-29T17:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138225",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:182 roed]:
> Replying to [comment:177 fbissey]:
> > May be the order things are done matters. I had a plain 5.6.rc0 on which I applied the patches. Then I updated flint. Finally I did sage -ba.
> 
> I started with a freshly built 5.6, installed the spkg and patches and then did sage -b.
> 
> > The way flint is upgraded probably don't remove everything of flint 1.5/ It merely overwrite the common files and leave the other in place. If there is a versionned libflint-1.5.dylib it probably is still there.
> 
> I ran "find $SAGE_ROOT -name *flint* -print," and the only versioned files I found were
> 
> {{{
> ./spkg/installed/flint-1.5.2.p2
> ./spkg/installed/flint-2.3
> ./spkg/logs/flint-1.5.2.p2.log
> ./spkg/logs/flint-2.3.log
> ./spkg/optional/flint-2.3.spkg
> ./spkg/standard/flint-1.5.2.p2.spkg
> }}}
> 
> The .a, .o, .so and .dylib files were all unversioned:
> 
> {{{
> ./devel/sage-main/build/temp.macosx-10.6-x86_64-2.7/sage/libs/flint/flint.o
> ./local/lib/libflint.a
> ./local/lib/libflint.dylib
> }}}
> 
> > Could you try to find if there are still bits of flint 1.5 on your install and remove them David?
> 
> Are there any of the above that actually matter removing?

It was an idea that I had but it turns out flint is indeed unversioned and the spkg tries to clean previous install before putting the new libs. So that's a dead end. No need to remove anything. I am trying with a build including flint 2.3 from scratch.



---

archive/issue_comments_138226.json:
```json
{
    "body": "The build from scratch didn't behave any differently on my system, all tests pass. So is flint making weird assumptions about OS X on ppc and x86_64?",
    "created_at": "2013-01-31T00:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138226",
    "user": "https://github.com/kiwifb"
}
```

The build from scratch didn't behave any differently on my system, all tests pass. So is flint making weird assumptions about OS X on ppc and x86_64?



---

archive/issue_comments_138227.json:
```json
{
    "body": "Flint has some inline assembly for x86, x86_64, arm and itanium, but nothing for ppc. You could try editing longlong.h to fall back to the generic code and see if that changes anything on x86_64.\n\nThe only way to get to the bottom of this is probably to take one of the failing tests and isolate the point in the code where results start to differ from a passing system...",
    "created_at": "2013-01-31T08:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138227",
    "user": "https://github.com/fredrik-johansson"
}
```

Flint has some inline assembly for x86, x86_64, arm and itanium, but nothing for ppc. You could try editing longlong.h to fall back to the generic code and see if that changes anything on x86_64.

The only way to get to the bottom of this is probably to take one of the failing tests and isolate the point in the code where results start to differ from a passing system...



---

archive/issue_comments_138228.json:
```json
{
    "body": "I could put my hand on a Mac OS X 10.7 where the problems occur.\n\nAt least one of the really worrying things is as follow:\n* converting an integer coefficients poly to a rational coeffs one kill all coeffs after any coeff whose size is larger than 64.stg bits.\n* but they are not really killed as the poly is still aware of it degree and you can still test equality of the original int poly with the new rat poly and get True.\nThat's the problem behind all the factor() calls giving stupid results (and maybe other failing doctests).\n\nThere seems to be a problem in the call to fmpq_poly_set_fmpz_poly in polynomial_rational_flint.pyx at line 257.",
    "created_at": "2013-03-05T17:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138228",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I could put my hand on a Mac OS X 10.7 where the problems occur.

At least one of the really worrying things is as follow:
* converting an integer coefficients poly to a rational coeffs one kill all coeffs after any coeff whose size is larger than 64.stg bits.
* but they are not really killed as the poly is still aware of it degree and you can still test equality of the original int poly with the new rat poly and get True.
That's the problem behind all the factor() calls giving stupid results (and maybe other failing doctests).

There seems to be a problem in the call to fmpq_poly_set_fmpz_poly in polynomial_rational_flint.pyx at line 257.



---

archive/issue_comments_138229.json:
```json
{
    "body": "It's quite funny, if I call fmpz_poly_print before entering fmpq_poly_set_fmpz_poly then its ok, but inside I get 0s instead of the right MPZ values (for things not stored directly).\nAnd when outside again, its ok.\n\nAnd if I first create an fmpq_poly with small coeffs and then multipliy it and convert it to int coeffs and convert it back to rat coeffs its ok...",
    "created_at": "2013-03-05T18:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138229",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

It's quite funny, if I call fmpz_poly_print before entering fmpq_poly_set_fmpz_poly then its ok, but inside I get 0s instead of the right MPZ values (for things not stored directly).
And when outside again, its ok.

And if I first create an fmpq_poly with small coeffs and then multipliy it and convert it to int coeffs and convert it back to rat coeffs its ok...



---

archive/issue_comments_138230.json:
```json
{
    "body": "Thanks a bunch for looking at this, jp.\n\nIt sounds really bizarre. Just from looking at the code, I see no reason that it should fail.\n\nWhat happens if you manually print the actual values of the fmpzs (as longs) in both the input fmpz_poly and the output fmpq_poly, and what does the output show?\n\nDoes reentrant mode help?",
    "created_at": "2013-03-05T18:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138230",
    "user": "https://github.com/fredrik-johansson"
}
```

Thanks a bunch for looking at this, jp.

It sounds really bizarre. Just from looking at the code, I see no reason that it should fail.

What happens if you manually print the actual values of the fmpzs (as longs) in both the input fmpz_poly and the output fmpq_poly, and what does the output show?

Does reentrant mode help?



---

archive/issue_comments_138231.json:
```json
{
    "body": "Replying to [comment:188 fredrik.johansson]:\n> What happens if you manually print the actual values of the fmpzs (as longs) in both the input fmpz_poly and the output fmpq_poly, and what does the output show?\nInside fmpq_set_fmpz_poly, printing each (in fact Ive tried to bedug only the case a*x where a is either 1 or huge so \"each\" is \"the two\") fmpz independently using fmpz_print(op->coeffs+i) or through fmpz_print_poly gives the same result: I get 0 for what are actually mpz_t rather than (tweaked) longs (IIRC I don't have access to the Mac right now) which at least is consistent.\nWhat disturbing is that calling COEFF_IS_MPZ gives the correct answer inside the function call (i.e. 1 for the x coefficient when a is huge, although 0 is printed, and 0 for the constant coefficient which is 0).\n\nI've checked the value of x._ _poly/ op is the same outside and inside the function call, and the address op->coeffs inside the function call looks fine.\n> \n> Does reentrant mode help?\nI'll try that tomorrow.\n\nFYI I tried using the fallback routines in longlong.h and that did not solve the problem.",
    "created_at": "2013-03-05T21:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138231",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:188 fredrik.johansson]:
> What happens if you manually print the actual values of the fmpzs (as longs) in both the input fmpz_poly and the output fmpq_poly, and what does the output show?
Inside fmpq_set_fmpz_poly, printing each (in fact Ive tried to bedug only the case a*x where a is either 1 or huge so "each" is "the two") fmpz independently using fmpz_print(op->coeffs+i) or through fmpz_print_poly gives the same result: I get 0 for what are actually mpz_t rather than (tweaked) longs (IIRC I don't have access to the Mac right now) which at least is consistent.
What disturbing is that calling COEFF_IS_MPZ gives the correct answer inside the function call (i.e. 1 for the x coefficient when a is huge, although 0 is printed, and 0 for the constant coefficient which is 0).

I've checked the value of x._ _poly/ op is the same outside and inside the function call, and the address op->coeffs inside the function call looks fine.
> 
> Does reentrant mode help?
I'll try that tomorrow.

FYI I tried using the fallback routines in longlong.h and that did not solve the problem.



---

archive/issue_comments_138232.json:
```json
{
    "body": "I was wondering what would show if you print them with printf(\"%ld\", poly[i])",
    "created_at": "2013-03-05T21:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138232",
    "user": "https://github.com/fredrik-johansson"
}
```

I was wondering what would show if you print them with printf("%ld", poly[i])



---

archive/issue_comments_138233.json:
```json
{
    "body": "Using a reentrant version did not solve the problem...\nReplying to [comment:190 fredrik.johansson]:\n> I was wondering what would show if you print them with printf(\"%ld\", poly[i])\nI modified FLINT as follow:\n* in fmpz_poly.h:\n\n```\nstatic __inline__\nint fmpz_poly_print(const fmpz_poly_t poly)\n{\n  int i = 0;\n\tfor (; i < fmpz_poly_length(poly); i++)\n\t{\n\t    printf(\"exp: %d \", i);\n\t    printf(\"MPZ: %d \", (COEFF_IS_MPZ(*(poly->coeffs+i)))?1:0);\n\t    printf(\"addr: %lX \", (unsigned long) poly->coeffs+i);\n\t    printf(\"val: %ld \", *(poly->coeffs+i));\n\t    printf(\"val: %lX \", *(poly->coeffs+i));\n\t    printf(\"fmpz: \");\n            fmpz_print(poly->coeffs+i);\n\t    printf(\" !! \");\n\t}\n\tprintf(\"\\n\");\n    return fmpz_poly_fprint(stdout, poly);\n}\n```\n\n* in fmpq_poly/set_fmpz_poly.c:\n\n```\nvoid fmpq_poly_set_fmpz_poly(fmpq_poly_t rop, const fmpz_poly_t op)\n{\n    if (fmpz_poly_is_zero(op))\n    {\n        fmpq_poly_zero(rop);\n    }\n    else\n    {\n        int i = 0;\n        fmpz_poly_print(op);\n        printf(\"\\n\");\n        fmpq_poly_fit_length(rop, fmpz_poly_length(op));\n        fmpz_poly_print(op);\n        printf(\"\\n\");\n        _fmpq_poly_set_length(rop, fmpz_poly_length(op));\n\tprintf(\"length = %ld\\n\", fmpz_poly_length(op));\n\tprintf(\"id = %lX\\n\", (unsigned long)op);\n\tfmpz_poly_print(op);\n\tprintf(\"\\n\");\n\tfor (; i < fmpz_poly_length(op); i++)\n\t{\n\t    printf(\"exp: %d \", i);\n\t    printf(\"MPZ: %d \", (COEFF_IS_MPZ(*(op->coeffs+i)))?1:0);\n\t    printf(\"addr: %lX \", (unsigned long) op->coeffs+i);\n\t    printf(\"val: %ld \", *(op->coeffs+i));\n\t    printf(\"val: %lX \", *(op->coeffs+i));\n\t    printf(\"fmpz: \");\n            fmpz_print(op->coeffs+i);\n\t    printf(\" !! \");\n\t}\n\tprintf(\"\\n\");\n        _fmpz_vec_set(rop->coeffs, op->coeffs, rop->length);\n        fmpz_one(rop->den);\n    }\n}\n```\n\n\nIn Sage:\n* in polynomial_integer_dense_flint.pyx:\n\n```\n    def jprint(self):\n        fmpz_poly_print(self.__poly)\n```\n\n* in polynomial_rational_flint.pyx\n\n```\n        elif PY_TYPE_CHECK(x, Polynomial_integer_dense_flint):\n            print hex(<long>((<Polynomial_integer_dense_flint>x).__poly))\n            printf(\"%X\\n\",(<Polynomial_integer_dense_flint>x).__poly)\n            print x\n            x.jprint()\n            print \"\"\n            (<Polynomial_integer_dense_flint>x).jprint()\n            print \"\"\n            fmpq_poly_set_fmpz_poly(self.__poly, (<Polynomial_integer_dense_flint>x).__poly)\n```\n\n\nHere is some data after modifying Sage and FLINT:\n\n```\nsage: a = 2**61\nsage: b = 2**62\nsage: c = 2**63\nsage: R.<x> = ZZ[]\nsage: f = R([1,2,3,a,b,c,3,2,1])\nsage: f.change_ring(QQ)\n0x1152447d0\n152447D0\nx^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\nexp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nexp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nexp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nexp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nlength = 9\nid = 1152447D0\nexp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nexp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! \nx^8 + 2*x^7 + 3*x^6 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\n```\n",
    "created_at": "2013-03-06T10:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138233",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Using a reentrant version did not solve the problem...
Replying to [comment:190 fredrik.johansson]:
> I was wondering what would show if you print them with printf("%ld", poly[i])
I modified FLINT as follow:
* in fmpz_poly.h:

```
static __inline__
int fmpz_poly_print(const fmpz_poly_t poly)
{
  int i = 0;
	for (; i < fmpz_poly_length(poly); i++)
	{
	    printf("exp: %d ", i);
	    printf("MPZ: %d ", (COEFF_IS_MPZ(*(poly->coeffs+i)))?1:0);
	    printf("addr: %lX ", (unsigned long) poly->coeffs+i);
	    printf("val: %ld ", *(poly->coeffs+i));
	    printf("val: %lX ", *(poly->coeffs+i));
	    printf("fmpz: ");
            fmpz_print(poly->coeffs+i);
	    printf(" !! ");
	}
	printf("\n");
    return fmpz_poly_fprint(stdout, poly);
}
```

* in fmpq_poly/set_fmpz_poly.c:

```
void fmpq_poly_set_fmpz_poly(fmpq_poly_t rop, const fmpz_poly_t op)
{
    if (fmpz_poly_is_zero(op))
    {
        fmpq_poly_zero(rop);
    }
    else
    {
        int i = 0;
        fmpz_poly_print(op);
        printf("\n");
        fmpq_poly_fit_length(rop, fmpz_poly_length(op));
        fmpz_poly_print(op);
        printf("\n");
        _fmpq_poly_set_length(rop, fmpz_poly_length(op));
	printf("length = %ld\n", fmpz_poly_length(op));
	printf("id = %lX\n", (unsigned long)op);
	fmpz_poly_print(op);
	printf("\n");
	for (; i < fmpz_poly_length(op); i++)
	{
	    printf("exp: %d ", i);
	    printf("MPZ: %d ", (COEFF_IS_MPZ(*(op->coeffs+i)))?1:0);
	    printf("addr: %lX ", (unsigned long) op->coeffs+i);
	    printf("val: %ld ", *(op->coeffs+i));
	    printf("val: %lX ", *(op->coeffs+i));
	    printf("fmpz: ");
            fmpz_print(op->coeffs+i);
	    printf(" !! ");
	}
	printf("\n");
        _fmpz_vec_set(rop->coeffs, op->coeffs, rop->length);
        fmpz_one(rop->den);
    }
}
```


In Sage:
* in polynomial_integer_dense_flint.pyx:

```
    def jprint(self):
        fmpz_poly_print(self.__poly)
```

* in polynomial_rational_flint.pyx

```
        elif PY_TYPE_CHECK(x, Polynomial_integer_dense_flint):
            print hex(<long>((<Polynomial_integer_dense_flint>x).__poly))
            printf("%X\n",(<Polynomial_integer_dense_flint>x).__poly)
            print x
            x.jprint()
            print ""
            (<Polynomial_integer_dense_flint>x).jprint()
            print ""
            fmpq_poly_set_fmpz_poly(self.__poly, (<Polynomial_integer_dense_flint>x).__poly)
```


Here is some data after modifying Sage and FLINT:

```
sage: a = 2**61
sage: b = 2**62
sage: c = 2**63
sage: R.<x> = ZZ[]
sage: f = R([1,2,3,a,b,c,3,2,1])
sage: f.change_ring(QQ)
0x1152447d0
152447D0
x^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
exp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
exp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
exp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
exp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
length = 9
id = 1152447D0
exp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
exp: 0 MPZ: 0 addr: 7FE1D1919410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FE1D1919411 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FE1D1919412 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FE1D1919413 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FE1D1919414 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FE1D1919415 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FE1D1919416 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FE1D1919417 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FE1D1919418 val: 1 val: 1 fmpz: 1 !! 
x^8 + 2*x^7 + 3*x^6 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
```




---

archive/issue_comments_138234.json:
```json
{
    "body": "If I'm reading this right, it prints the fmpz_poly four times before even entering fmpq_poly, and it's wrong the third time, that is, when calling (<Polynomial_integer_dense_flint>x).jprint()?\n\nBut the fmpz coefficients are the same, so it is (seemingly) the entries in flint's global mpz array that are being zeroed when they shouldn't.\n\nIt smells a lot like one of the bugs we've had in the past with the non-reentrant mode, i.e., somewhere, some code loads an mpz pointer, and hangs on to it while the mpz array gets resized. It could potentially be triggered by a compiler bug which, say, makes it overlook constness somewhere.\n\nYou might be able to track down exactly where the mpz gets zeroed (say, by saving the pointer somewhere, and printing it in various places). Or, since the fmpz just encodes an index into the mpz array, you could perhaps edit the COEFF_TO_PTR macro to print the index, and find out the places where the particular indices of the mpzs in the coefficients of this polynomial are being accessed. It might also help to print where mpz array is being resized.",
    "created_at": "2013-03-06T11:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138234",
    "user": "https://github.com/fredrik-johansson"
}
```

If I'm reading this right, it prints the fmpz_poly four times before even entering fmpq_poly, and it's wrong the third time, that is, when calling (<Polynomial_integer_dense_flint>x).jprint()?

But the fmpz coefficients are the same, so it is (seemingly) the entries in flint's global mpz array that are being zeroed when they shouldn't.

It smells a lot like one of the bugs we've had in the past with the non-reentrant mode, i.e., somewhere, some code loads an mpz pointer, and hangs on to it while the mpz array gets resized. It could potentially be triggered by a compiler bug which, say, makes it overlook constness somewhere.

You might be able to track down exactly where the mpz gets zeroed (say, by saving the pointer somewhere, and printing it in various places). Or, since the fmpz just encodes an index into the mpz array, you could perhaps edit the COEFF_TO_PTR macro to print the index, and find out the places where the particular indices of the mpzs in the coefficients of this polynomial are being accessed. It might also help to print where mpz array is being resized.



---

archive/issue_comments_138235.json:
```json
{
    "body": "Replying to [comment:192 fredrik.johansson]:\n> If I'm reading this right, it prints the fmpz_poly four times before even entering fmpq_poly, and it's wrong the third time, that is, when calling (<Polynomial_integer_dense_flint>x).jprint()?\n> \nNope, the first wrong printing is the the first one inside fmpq_set_fmpz_poly.\nThe first \"print x\" command at the Sage level corresponds to \"x^8 + 2*x^7 + 3*x^6 + 92233...\".\n\n> But the fmpz coefficients are the same, so it is (seemingly) the entries in flint's global mpz array that are being zeroed when they shouldn't.\nI'm not sure they really get zeroed.\nOk it sounds fishy, but I'm able to print again f correctly after having done f.change_ring(QQ)...\n\nI'll give the same piece of code a shot on Linux to see if anything looks different but I doubt it, then I'll try to watch the addresses with gdb.",
    "created_at": "2013-03-06T12:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138235",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:192 fredrik.johansson]:
> If I'm reading this right, it prints the fmpz_poly four times before even entering fmpq_poly, and it's wrong the third time, that is, when calling (<Polynomial_integer_dense_flint>x).jprint()?
> 
Nope, the first wrong printing is the the first one inside fmpq_set_fmpz_poly.
The first "print x" command at the Sage level corresponds to "x^8 + 2*x^7 + 3*x^6 + 92233...".

> But the fmpz coefficients are the same, so it is (seemingly) the entries in flint's global mpz array that are being zeroed when they shouldn't.
I'm not sure they really get zeroed.
Ok it sounds fishy, but I'm able to print again f correctly after having done f.change_ring(QQ)...

I'll give the same piece of code a shot on Linux to see if anything looks different but I doubt it, then I'll try to watch the addresses with gdb.



---

archive/issue_comments_138236.json:
```json
{
    "body": "Replying to [comment:191 jpflori]:\nThis line\n> {{{\n> void fmpq_poly_set_fmpz_poly(fmpq_poly_t rop, const fmpz_poly_t op)\n> {\n>           ....\n> \t    printf(\"addr: %lX \", (unsigned long) op->coeffs+i);\n>           ....\n> }}}\nwas supposed to be\n\n```\nvoid fmpq_poly_set_fmpz_poly(fmpq_poly_t rop, const fmpz_poly_t op)\n{\n          ....\n\t    printf(\"addr: %lX \", (unsigned long) (op->coeffs+i));\n          ....\n```\n\n\nThe additional one appearing sometimes there is strange:\n> {{{\n> 0x1152447d0\n> 152447D0\n> ...\n> id = 1152447D0\n> }}}\nMaybe some casting problems?\n\nOn Linux, I get the same value the three times.",
    "created_at": "2013-03-06T12:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138236",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:191 jpflori]:
This line
> {{{
> void fmpq_poly_set_fmpz_poly(fmpq_poly_t rop, const fmpz_poly_t op)
> {
>           ....
> 	    printf("addr: %lX ", (unsigned long) op->coeffs+i);
>           ....
> }}}
was supposed to be

```
void fmpq_poly_set_fmpz_poly(fmpq_poly_t rop, const fmpz_poly_t op)
{
          ....
	    printf("addr: %lX ", (unsigned long) (op->coeffs+i));
          ....
```


The additional one appearing sometimes there is strange:
> {{{
> 0x1152447d0
> 152447D0
> ...
> id = 1152447D0
> }}}
Maybe some casting problems?

On Linux, I get the same value the three times.



---

archive/issue_comments_138237.json:
```json
{
    "body": "My bad, its just because I used %X and on the Mac, the address is more than 4 bytes.",
    "created_at": "2013-03-06T13:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138237",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

My bad, its just because I used %X and on the Mac, the address is more than 4 bytes.



---

archive/issue_comments_138238.json:
```json
{
    "body": "It seems there have been some problems when updating FLINT, with a flint directory created, but a FLINT one somehow still there.\n\nI did not test reentrant mode correctly because there were multiple spaces before --reentrant and it was not parsed by FLINT configure.",
    "created_at": "2013-03-06T14:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138238",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

It seems there have been some problems when updating FLINT, with a flint directory created, but a FLINT one somehow still there.

I did not test reentrant mode correctly because there were multiple spaces before --reentrant and it was not parsed by FLINT configure.



---

archive/issue_comments_138239.json:
```json
{
    "body": "And with reentrant mode, the problem goes away:\n\n```\nsage: a = 2**61\nsage: b = 2**62\nsage: c = 2**63\nsage: R.<x> = ZZ[]\nsage: f = R([1,2,3,a,b,c,3,2,1])\nsage: f.change_ring(QQ)\n0x1118f67d0L\n1118F67D0\nx^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\nexp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nexp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nexp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nexp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nlength = 9\nid = 1118F67D0\nexp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nexp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! \nx^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\n```\n",
    "created_at": "2013-03-06T14:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138239",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

And with reentrant mode, the problem goes away:

```
sage: a = 2**61
sage: b = 2**62
sage: c = 2**63
sage: R.<x> = ZZ[]
sage: f = R([1,2,3,a,b,c,3,2,1])
sage: f.change_ring(QQ)
0x1118f67d0L
1118F67D0
x^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
exp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
exp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
exp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
exp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
length = 9
id = 1118F67D0
exp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
exp: 0 MPZ: 0 addr: 7FFA4B407410 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FFA4B407418 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FFA4B407420 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FFA4B407428 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FFA4B407430 val: 4611721196672653224 val: 40001FFE92D017A8 fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FFA4B407438 val: 4611721196672654616 val: 40001FFE92D01D18 fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FFA4B407440 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FFA4B407448 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FFA4B407450 val: 1 val: 1 fmpz: 1 !! 
x^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
```




---

archive/issue_comments_138240.json:
```json
{
    "body": "Replying to [comment:192 fredrik.johansson]:\n> If I'm reading this right, it prints the fmpz_poly four times before even entering fmpq_poly, and it's wrong the third time, that is, when calling (<Polynomial_integer_dense_flint>x).jprint()?\n> \n> But the fmpz coefficients are the same, so it is (seemingly) the entries in flint's global mpz array that are being zeroed when they shouldn't.\nSo that must be it.\n> \n> It smells a lot like one of the bugs we've had in the past with the non-reentrant mode, i.e., somewhere, some code loads an mpz pointer, and hangs on to it while the mpz array gets resized. It could potentially be triggered by a compiler bug which, say, makes it overlook constness somewhere.\n> \n> You might be able to track down exactly where the mpz gets zeroed (say, by saving the pointer somewhere, and printing it in various places). Or, since the fmpz just encodes an index into the mpz array, you could perhaps edit the COEFF_TO_PTR macro to print the index, and find out the places where the particular indices of the mpzs in the coefficients of this polynomial are being accessed. It might also help to print where mpz array is being resized.\nI'll try this now.",
    "created_at": "2013-03-06T14:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138240",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:192 fredrik.johansson]:
> If I'm reading this right, it prints the fmpz_poly four times before even entering fmpq_poly, and it's wrong the third time, that is, when calling (<Polynomial_integer_dense_flint>x).jprint()?
> 
> But the fmpz coefficients are the same, so it is (seemingly) the entries in flint's global mpz array that are being zeroed when they shouldn't.
So that must be it.
> 
> It smells a lot like one of the bugs we've had in the past with the non-reentrant mode, i.e., somewhere, some code loads an mpz pointer, and hangs on to it while the mpz array gets resized. It could potentially be triggered by a compiler bug which, say, makes it overlook constness somewhere.
> 
> You might be able to track down exactly where the mpz gets zeroed (say, by saving the pointer somewhere, and printing it in various places). Or, since the fmpz just encodes an index into the mpz array, you could perhaps edit the COEFF_TO_PTR macro to print the index, and find out the places where the particular indices of the mpzs in the coefficients of this polynomial are being accessed. It might also help to print where mpz array is being resized.
I'll try this now.



---

archive/issue_comments_138241.json:
```json
{
    "body": "I does not seem the global array gets resized.\nIve put some printf lines in the if(fmpz_allocated) part of _fmpz_new_mpz and ot does not get triggered.\n\nBut somehow the fmpz_arr value changes...\n\n```\n\nsage: f.change_ring(QQ)\n0x1170d57d0L\n1170D57D0\nx^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\nglobal array at 0x7FEB3C002A00\nexp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nglobal array at 0x7FEB3C002A00\nexp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nglobal array at 0x7FEB3BBCF200\nglobal array at 0x7FEB3BBCF200\nexp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nglobal array at 0x7FEB3BBCF200\nexp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nlength = 9\nid = 1170D57D0\nglobal array at 0x7FEB3BBCF200\nexp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nexp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! \nx^8 + 2*x^7 + 3*x^6 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\n```\n",
    "created_at": "2013-03-06T14:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138241",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I does not seem the global array gets resized.
Ive put some printf lines in the if(fmpz_allocated) part of _fmpz_new_mpz and ot does not get triggered.

But somehow the fmpz_arr value changes...

```

sage: f.change_ring(QQ)
0x1170d57d0L
1170D57D0
x^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
global array at 0x7FEB3C002A00
exp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
global array at 0x7FEB3C002A00
exp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
global array at 0x7FEB3BBCF200
global array at 0x7FEB3BBCF200
exp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
global array at 0x7FEB3BBCF200
exp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
length = 9
id = 1170D57D0
global array at 0x7FEB3BBCF200
exp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
exp: 0 MPZ: 0 addr: 7FEB3B304C80 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FEB3B304C88 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FEB3B304C90 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FEB3B304C98 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FEB3B304CA0 val: 4611686018427387966 val: 400000000000003E fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FEB3B304CA8 val: 4611686018427387965 val: 400000000000003D fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FEB3B304CB0 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FEB3B304CB8 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FEB3B304CC0 val: 1 val: 1 fmpz: 1 !! 
x^8 + 2*x^7 + 3*x^6 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
```




---

archive/issue_comments_138242.json:
```json
{
    "body": "But somehow it seems we get two global arrays:\n\n```\n\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nAllocating fmpz_arr at 0x7FC702AC2600\nAllocating fmpz_unused_arr at 0x7FC704123480\nsage: a = 2**61\nsage: b = 2**62\nsage: c = 2**63\nsage: R.<x> = ZZ[]\nsage: f = R([1,2,3,a,b,c,3,2,1])\nAllocating fmpz_arr at 0x7FC703850000\nAllocating fmpz_unused_arr at 0x7FC702366530\nsage: f = R([1,2,3,a,b,c,3,2,1])\nsage: f.jprint()\nglobal array at 0x7FC703850000\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \n9  1 2f.change_ring(QQ)\n0x10dce0838L\n10DCE0838\nx^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\nglobal array at 0x7FC703850000\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nglobal array at 0x7FC703850000\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1\nglobal array at 0x7FC702AC2600\nglobal array at 0x7FC702AC2600\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nglobal array at 0x7FC702AC2600\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nlength = 9\nid = 10DCE0838\nglobal array at 0x7FC702AC2600\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \n9  1 2 3 2305843009213693952 0 0 3 2 1\nexp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! \nx^8 + 2*x^7 + 3*x^6 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1\nsage: \n```\n",
    "created_at": "2013-03-06T14:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138242",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

But somehow it seems we get two global arrays:

```

**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
Allocating fmpz_arr at 0x7FC702AC2600
Allocating fmpz_unused_arr at 0x7FC704123480
sage: a = 2**61
sage: b = 2**62
sage: c = 2**63
sage: R.<x> = ZZ[]
sage: f = R([1,2,3,a,b,c,3,2,1])
Allocating fmpz_arr at 0x7FC703850000
Allocating fmpz_unused_arr at 0x7FC702366530
sage: f = R([1,2,3,a,b,c,3,2,1])
sage: f.jprint()
global array at 0x7FC703850000
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
9  1 2f.change_ring(QQ)
0x10dce0838L
10DCE0838
x^8 + 2*x^7 + 3*x^6 + 9223372036854775808*x^5 + 4611686018427387904*x^4 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
global array at 0x7FC703850000
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
global array at 0x7FC703850000
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 4611686018427387904 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 9223372036854775808 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 4611686018427387904 9223372036854775808 3 2 1
global array at 0x7FC702AC2600
global array at 0x7FC702AC2600
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
global array at 0x7FC702AC2600
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
length = 9
id = 10DCE0838
global array at 0x7FC702AC2600
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
9  1 2 3 2305843009213693952 0 0 3 2 1
exp: 0 MPZ: 0 addr: 7FC7026D2530 val: 1 val: 1 fmpz: 1 !! exp: 1 MPZ: 0 addr: 7FC7026D2538 val: 2 val: 2 fmpz: 2 !! exp: 2 MPZ: 0 addr: 7FC7026D2540 val: 3 val: 3 fmpz: 3 !! exp: 3 MPZ: 0 addr: 7FC7026D2548 val: 2305843009213693952 val: 2000000000000000 fmpz: 2305843009213693952 !! exp: 4 MPZ: 1 addr: 7FC7026D2550 val: 4611686018427387964 val: 400000000000003C fmpz: 0 !! exp: 5 MPZ: 1 addr: 7FC7026D2558 val: 4611686018427387963 val: 400000000000003B fmpz: 0 !! exp: 6 MPZ: 0 addr: 7FC7026D2560 val: 3 val: 3 fmpz: 3 !! exp: 7 MPZ: 0 addr: 7FC7026D2568 val: 2 val: 2 fmpz: 2 !! exp: 8 MPZ: 0 addr: 7FC7026D2570 val: 1 val: 1 fmpz: 1 !! 
x^8 + 2*x^7 + 3*x^6 + 2305843009213693952*x^3 + 3*x^2 + 2*x + 1
sage: 
```




---

archive/issue_comments_138243.json:
```json
{
    "body": "This is stranger than ever :-)\n\nIf you can figure out where the two arrays are coming from, it might just be the solution of the problem.\n\nIf nothing else works, perhaps we could just update flint to include the patch https://github.com/fredrik-johansson/flint2/commit/03487ed18f40f08cea7f5a71dcfd43cb6fd70115 but with the `__thread` prefixes removed. (If my own benchmarking was correct, this will even make flint faster, too.)",
    "created_at": "2013-03-06T16:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138243",
    "user": "https://github.com/fredrik-johansson"
}
```

This is stranger than ever :-)

If you can figure out where the two arrays are coming from, it might just be the solution of the problem.

If nothing else works, perhaps we could just update flint to include the patch https://github.com/fredrik-johansson/flint2/commit/03487ed18f40f08cea7f5a71dcfd43cb6fd70115 but with the `__thread` prefixes removed. (If my own benchmarking was correct, this will even make flint faster, too.)



---

archive/issue_comments_138244.json:
```json
{
    "body": "Think I got it.\nSomething does not like the dylib64 extension so some parts of Sage where linked with the static libflint.a, but some others with libflint.dylib64.\n\nIve copied libflint.dylib64 to liblint.dylib, touched everything in sage/libs/flint and sage/rings/polynomial and rebuilt Sage and could not reproduce the error.\n\nAll of this is because of me...\nhttps://groups.google.com/d/msg/flint-devel/Vy0PlkeEgf8/TbpSDTZBgg8J\nSo keeping dylib64 extension from FLINT 1 series was not a good idea.",
    "created_at": "2013-03-06T17:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138244",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Think I got it.
Something does not like the dylib64 extension so some parts of Sage where linked with the static libflint.a, but some others with libflint.dylib64.

Ive copied libflint.dylib64 to liblint.dylib, touched everything in sage/libs/flint and sage/rings/polynomial and rebuilt Sage and could not reproduce the error.

All of this is because of me...
https://groups.google.com/d/msg/flint-devel/Vy0PlkeEgf8/TbpSDTZBgg8J
So keeping dylib64 extension from FLINT 1 series was not a good idea.



---

archive/issue_comments_138245.json:
```json
{
    "body": "In fact I think I got confused between the make target and the extension of the library in FLINT 1.\nSorry about that.",
    "created_at": "2013-03-06T17:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138245",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

In fact I think I got confused between the make target and the extension of the library in FLINT 1.
Sorry about that.



---

archive/issue_comments_138246.json:
```json
{
    "body": "Updated spkg.\nPlease test.",
    "created_at": "2013-03-06T17:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138246",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Updated spkg.
Please test.



---

archive/issue_comments_138247.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-06T17:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138247",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138248.json:
```json
{
    "body": "Attachment [dylib.diff](tarball://root/attachments/some-uuid/ticket12173/dylib.diff) by jpflori created at 2013-03-06 17:30:00\n\nFix for darwin, spkg diff, only for review.",
    "created_at": "2013-03-06T17:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138248",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [dylib.diff](tarball://root/attachments/some-uuid/ticket12173/dylib.diff) by jpflori created at 2013-03-06 17:30:00

Fix for darwin, spkg diff, only for review.



---

archive/issue_comments_138249.json:
```json
{
    "body": "Attachment [flint-2.3-library-5.8.b2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-library-5.8.b2.patch) by jpflori created at 2013-03-06 17:30:20\n\nPatch for the Sage library.",
    "created_at": "2013-03-06T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138249",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-library-5.8.b2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-library-5.8.b2.patch) by jpflori created at 2013-03-06 17:30:20

Patch for the Sage library.



---

archive/issue_comments_138250.json:
```json
{
    "body": "Attachment [flint-2.3-root-5.8.b2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-root-5.8.b2.patch) by jpflori created at 2013-03-06 17:30:40\n\nRoot patch",
    "created_at": "2013-03-06T17:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138250",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-root-5.8.b2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-root-5.8.b2.patch) by jpflori created at 2013-03-06 17:30:40

Root patch



---

archive/issue_comments_138251.json:
```json
{
    "body": "Patches corrected and rebased on top of 5.8.b2, hoping that b3 did not break them...",
    "created_at": "2013-03-06T17:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138251",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Patches corrected and rebased on top of 5.8.b2, hoping that b3 did not break them...



---

archive/issue_comments_138252.json:
```json
{
    "body": "I've just reupped an spkg which actually apply the patch.",
    "created_at": "2013-03-06T17:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138252",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've just reupped an spkg which actually apply the patch.



---

archive/issue_comments_138253.json:
```json
{
    "body": "Now it's also clear why this problem affects only OS X systems.",
    "created_at": "2013-03-06T20:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138253",
    "user": "https://github.com/jdemeyer"
}
```

Now it's also clear why this problem affects only OS X systems.



---

archive/issue_comments_138254.json:
```json
{
    "body": "This should be rebased on top of #14241 (expect for hg and SPKG.txt history this should be trivial).",
    "created_at": "2013-03-14T17:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138254",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

This should be rebased on top of #14241 (expect for hg and SPKG.txt history this should be trivial).



---

archive/issue_comments_138255.json:
```json
{
    "body": "And even on top of #14268",
    "created_at": "2013-03-14T17:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138255",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

And even on top of #14268



---

archive/issue_comments_138256.json:
```json
{
    "body": "So, what needs to be done on this ticket?  Is it just the rebase?  It would be great to finally get this in Sage (#14304 depends on it for example).",
    "created_at": "2013-03-22T18:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138256",
    "user": "https://github.com/roed314"
}
```

So, what needs to be done on this ticket?  Is it just the rebase?  It would be great to finally get this in Sage (#14304 depends on it for example).



---

archive/issue_comments_138257.json:
```json
{
    "body": "Replying to [comment:211 roed]:\n> So, what needs to be done on this ticket?  Is it just the rebase?  It would be great to finally get this in Sage (#14304 depends on it for example).\nI'd say it \"just\" needs review now that the crap I introduced for OS X is fixed.\nJohn Cremona was already happy with the patches if that's relevant.\nSee some comment above.\n\nAs far as rebasing is concerned, I did it not so long ago, but it might need another one unfortunately...",
    "created_at": "2013-03-22T19:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138257",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:211 roed]:
> So, what needs to be done on this ticket?  Is it just the rebase?  It would be great to finally get this in Sage (#14304 depends on it for example).
I'd say it "just" needs review now that the crap I introduced for OS X is fixed.
John Cremona was already happy with the patches if that's relevant.
See some comment above.

As far as rebasing is concerned, I did it not so long ago, but it might need another one unfortunately...



---

archive/issue_comments_138258.json:
```json
{
    "body": "What has been done beyond the patches listed at comment 123?  Anything besides OS X fixes and rebasing?",
    "created_at": "2013-03-22T19:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138258",
    "user": "https://github.com/roed314"
}
```

What has been done beyond the patches listed at comment 123?  Anything besides OS X fixes and rebasing?



---

archive/issue_comments_138259.json:
```json
{
    "body": "Replying to [comment:213 roed]:\n> What has been done beyond the patches listed at comment 123?  Anything besides OS X fixes and rebasing?\nI don't think they really changed except for the fact they were merged together without the last of the list which was not such a good idea, or at least deserve more thoughts.\n\nAfter comment 123 they were basically just rebased over and over, and at some point additional fixes were added by Jeroen, see http://trac.sagemath.org/sage_trac/ticket/12173?replyto=213#comment:153.\n\nThe spkg itself needs rebasing for sure, on top of #14241 and potentially #14268.\nI could surely do that next week.\nDon't know about the patches to the Sage library.",
    "created_at": "2013-03-23T17:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138259",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:213 roed]:
> What has been done beyond the patches listed at comment 123?  Anything besides OS X fixes and rebasing?
I don't think they really changed except for the fact they were merged together without the last of the list which was not such a good idea, or at least deserve more thoughts.

After comment 123 they were basically just rebased over and over, and at some point additional fixes were added by Jeroen, see http://trac.sagemath.org/sage_trac/ticket/12173?replyto=213#comment:153.

The spkg itself needs rebasing for sure, on top of #14241 and potentially #14268.
I could surely do that next week.
Don't know about the patches to the Sage library.



---

archive/issue_comments_138260.json:
```json
{
    "body": "Ok I've reupped a rebased p0 spkg including the OS X fix and porting the ulong stuff from #14268.\nNot completely sure the ulong stuff is completely right, but it seems to pass all tests.\n\nSpkg at:\n* http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg\n\nPlease review the new spkg and the Sage's library patches!",
    "created_at": "2013-03-27T13:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138260",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok I've reupped a rebased p0 spkg including the OS X fix and porting the ulong stuff from #14268.
Not completely sure the ulong stuff is completely right, but it seems to pass all tests.

Spkg at:
* http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg

Please review the new spkg and the Sage's library patches!



---

archive/issue_comments_138261.json:
```json
{
    "body": "(Of course there may be some proper spkg rebasing hell because #14268 is not merged yet and so the flint spkg there is not tagged.)",
    "created_at": "2013-03-27T13:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138261",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

(Of course there may be some proper spkg rebasing hell because #14268 is not merged yet and so the flint spkg there is not tagged.)



---

archive/issue_comments_138262.json:
```json
{
    "body": "Should it really depend on #14268?\n\nMinor thing: `spkg-check`: No newline at end of file.",
    "created_at": "2013-03-27T13:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138262",
    "user": "https://github.com/nexttime"
}
```

Should it really depend on #14268?

Minor thing: `spkg-check`: No newline at end of file.



---

archive/issue_comments_138263.json:
```json
{
    "body": "I think `spkg-install` still needs some clean-up (overwriting `CFLAGS`, quoting, superfluous `;` :-) ... )\n\nHaven't tested anything yet...",
    "created_at": "2013-03-27T14:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138263",
    "user": "https://github.com/nexttime"
}
```

I think `spkg-install` still needs some clean-up (overwriting `CFLAGS`, quoting, superfluous `;` :-) ... )

Haven't tested anything yet...



---

archive/issue_comments_138264.json:
```json
{
    "body": "P.S.:  For consistency, we could also support a user-definable `FLINT_CONFIGURE` (and [append to and] use that instead of `$EXTRA_CONF`).",
    "created_at": "2013-03-27T14:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138264",
    "user": "https://github.com/nexttime"
}
```

P.S.:  For consistency, we could also support a user-definable `FLINT_CONFIGURE` (and [append to and] use that instead of `$EXTRA_CONF`).



---

archive/issue_comments_138265.json:
```json
{
    "body": "Replying to [comment:218 leif]:\n> Should it really depend on #14268?\nI think the changes from #14268 make sense.\nUsing one typedef rather than macros (and bunch of #undef in FLINT 2.3 all over the code to mitigate conflicts with system headers in FLINT itself) is a good thing.\nI'll report it upstream and that will hopefully change in a future minor release (also including the OS X fix).\n\nSo even though the patch for FLINT 2.3 is completely different from the one from #14268, the idea is from there and I think it's a good think maybe not to depend on the ticket itself, but at least to inherit from the spkg there.\nTherefore if we get this ticket positively reviewed before #14268 we could just remove the dependency on #14268 and the 1.5.2.p4 spkg from there.\nI don't think making #14268 on this ticket would be fair.\n> \n> Minor thing: `spkg-check`: No newline at end of file.\nI'll fix that.",
    "created_at": "2013-03-27T14:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138265",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:218 leif]:
> Should it really depend on #14268?
I think the changes from #14268 make sense.
Using one typedef rather than macros (and bunch of #undef in FLINT 2.3 all over the code to mitigate conflicts with system headers in FLINT itself) is a good thing.
I'll report it upstream and that will hopefully change in a future minor release (also including the OS X fix).

So even though the patch for FLINT 2.3 is completely different from the one from #14268, the idea is from there and I think it's a good think maybe not to depend on the ticket itself, but at least to inherit from the spkg there.
Therefore if we get this ticket positively reviewed before #14268 we could just remove the dependency on #14268 and the 1.5.2.p4 spkg from there.
I don't think making #14268 on this ticket would be fair.
> 
> Minor thing: `spkg-check`: No newline at end of file.
I'll fix that.



---

archive/issue_comments_138266.json:
```json
{
    "body": "Attachment [flint-2.3.p0.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p0.diff) by jpflori created at 2013-03-27 14:13:06\n\nSpkg diff, for review only.",
    "created_at": "2013-03-27T14:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138266",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3.p0.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p0.diff) by jpflori created at 2013-03-27 14:13:06

Spkg diff, for review only.



---

archive/issue_comments_138267.json:
```json
{
    "body": "Ok I've reupped a cleaner spkg.\nIn fact most of the spkg-* fixes were in a previous version, but I must have mixed up some versions when working on the OS X fix and was too lazy to double check that.",
    "created_at": "2013-03-27T14:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138267",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok I've reupped a cleaner spkg.
In fact most of the spkg-* fixes were in a previous version, but I must have mixed up some versions when working on the OS X fix and was too lazy to double check that.



---

archive/issue_comments_138268.json:
```json
{
    "body": "FWIW, I don't see how you compile FLINT as C99.",
    "created_at": "2013-03-27T14:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138268",
    "user": "https://github.com/nexttime"
}
```

FWIW, I don't see how you compile FLINT as C99.



---

archive/issue_comments_138269.json:
```json
{
    "body": "I think we don't...\n\nDo you suggest we keep the \"#define ulong unsigned long\"?\nI don't really care.",
    "created_at": "2013-03-27T14:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138269",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think we don't...

Do you suggest we keep the "#define ulong unsigned long"?
I don't really care.



---

archive/issue_comments_138270.json:
```json
{
    "body": "Replying to [comment:224 jpflori]:\n> Do you suggest we keep the \"#define ulong unsigned long\"?\n> I don't really care.\n\nI think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).",
    "created_at": "2013-03-27T14:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138270",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:224 jpflori]:
> Do you suggest we keep the "#define ulong unsigned long"?
> I don't really care.

I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).



---

archive/issue_comments_138271.json:
```json
{
    "body": "I cannot review the Sage library patch, \"since the file size exceeds 262144 bytes\"... ;-)",
    "created_at": "2013-03-27T15:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138271",
    "user": "https://github.com/nexttime"
}
```

I cannot review the Sage library patch, "since the file size exceeds 262144 bytes"... ;-)



---

archive/issue_comments_138272.json:
```json
{
    "body": "Replying to [comment:225 leif]:\n> Replying to [comment:224 jpflori]:\n> > Do you suggest we keep the \"#define ulong unsigned long\"?\n> > I don't really care.\n> \n> I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).\nYou can just propose whatever changes you want to include here, I'm in close contact with upstream, especially for the build system, so I'll take care of coordination.\nI agree there is some fishy things going on with FLINT_TUNE and CFLAGS and surely other things.\n\nAnd don't say \"let's switch to autotools\" unless you wanna be in charge of the build system maintenance as Bill Hart will definitely not want to maintain it.\n\nBe also aware there won't be any FLINT release before at least the dev meeting in may.\nSo I think we should just make minor modifications and get this in quickly.\nIt's been bitrotting for so long...\nI'll up another spkg based on #14241  not touching the ulong stuff.",
    "created_at": "2013-03-27T15:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138272",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:225 leif]:
> Replying to [comment:224 jpflori]:
> > Do you suggest we keep the "#define ulong unsigned long"?
> > I don't really care.
> 
> I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).
You can just propose whatever changes you want to include here, I'm in close contact with upstream, especially for the build system, so I'll take care of coordination.
I agree there is some fishy things going on with FLINT_TUNE and CFLAGS and surely other things.

And don't say "let's switch to autotools" unless you wanna be in charge of the build system maintenance as Bill Hart will definitely not want to maintain it.

Be also aware there won't be any FLINT release before at least the dev meeting in may.
So I think we should just make minor modifications and get this in quickly.
It's been bitrotting for so long...
I'll up another spkg based on #14241  not touching the ulong stuff.



---

archive/issue_comments_138273.json:
```json
{
    "body": "Replying to [comment:226 leif]:\n> I cannot review the Sage library patch, \"since the file size exceeds 262144 bytes\"... ;-)\nThe big patch bomb is modulo rebasing issues made from the patches at\n* http://trac.sagemath.org/sage_trac/ticket/12173?replyto=226#comment:123\nplus fixes by Jeroen from\n* http://trac.sagemath.org/sage_trac/ticket/12173?replyto=226#comment:153",
    "created_at": "2013-03-27T15:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138273",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:226 leif]:
> I cannot review the Sage library patch, "since the file size exceeds 262144 bytes"... ;-)
The big patch bomb is modulo rebasing issues made from the patches at
* http://trac.sagemath.org/sage_trac/ticket/12173?replyto=226#comment:123
plus fixes by Jeroen from
* http://trac.sagemath.org/sage_trac/ticket/12173?replyto=226#comment:153



---

archive/issue_comments_138274.json:
```json
{
    "body": "Spkg diff, for review only. Based on #14268.",
    "created_at": "2013-03-27T15:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138274",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Spkg diff, for review only. Based on #14268.



---

archive/issue_comments_138275.json:
```json
{
    "body": "Attachment [flint-2.3.p0.spkg.14241](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p0.spkg.14241) by jpflori created at 2013-03-27 15:22:09\n\nWrong file...",
    "created_at": "2013-03-27T15:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138275",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3.p0.spkg.14241](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p0.spkg.14241) by jpflori created at 2013-03-27 15:22:09

Wrong file...



---

archive/issue_comments_138276.json:
```json
{
    "body": "Ok so we have now:\n* http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg.14241 based on #14241, and mirrored at http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg,\n* http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg.14268 based on #14268.\n\nRename the one you prefer and give it a try.",
    "created_at": "2013-03-27T15:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138276",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok so we have now:
* http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg.14241 based on #14241, and mirrored at http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg,
* http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg.14268 based on #14268.

Rename the one you prefer and give it a try.



---

archive/issue_comments_138277.json:
```json
{
    "body": "Replying to [comment:227 jpflori]:\n> Replying to [comment:225 leif]:\n> > Replying to [comment:224 jpflori]:\n> > > Do you suggest we keep the \"#define ulong unsigned long\"?\n> > > I don't really care.\n\n`for f in $SOURCES; do sed -i 's/ulong/mp_limb_t/g' $f; done` ;-)\n\n\n\n\n> > I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).\n> You can just propose whatever changes you want to include here, I'm in close contact with upstream, especially for the build system, so I'll take care of coordination.\n> I agree there is some fishy things going on with FLINT_TUNE and CFLAGS and surely other things.\n> \n> And don't say \"let's switch to autotools\" unless you wanna be in charge of the build system maintenance as Bill Hart will definitely not want to maintain it.\n\n:-)  Yes.  I just meant I don't know if there are any changes in progress w.r.t. this.\n\nIt doesn't seem we'd need any *Sage-specific* changes, so IMHO we should take fixes from upstream, or push (generic) changes there.\n\n \n> Be also aware there won't be any FLINT release before at least the dev meeting in may.\n\nYes.  But FLINT 2.3.1 should (already) include any fixes we (and others) need, see above.",
    "created_at": "2013-03-27T15:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138277",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:227 jpflori]:
> Replying to [comment:225 leif]:
> > Replying to [comment:224 jpflori]:
> > > Do you suggest we keep the "#define ulong unsigned long"?
> > > I don't really care.

`for f in $SOURCES; do sed -i 's/ulong/mp_limb_t/g' $f; done` ;-)




> > I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).
> You can just propose whatever changes you want to include here, I'm in close contact with upstream, especially for the build system, so I'll take care of coordination.
> I agree there is some fishy things going on with FLINT_TUNE and CFLAGS and surely other things.
> 
> And don't say "let's switch to autotools" unless you wanna be in charge of the build system maintenance as Bill Hart will definitely not want to maintain it.

:-)  Yes.  I just meant I don't know if there are any changes in progress w.r.t. this.

It doesn't seem we'd need any *Sage-specific* changes, so IMHO we should take fixes from upstream, or push (generic) changes there.

 
> Be also aware there won't be any FLINT release before at least the dev meeting in may.

Yes.  But FLINT 2.3.1 should (already) include any fixes we (and others) need, see above.



---

archive/issue_comments_138278.json:
```json
{
    "body": "Replying to [comment:231 leif]:\n> Replying to [comment:227 jpflori]:\n> > Replying to [comment:225 leif]:\n> > > Replying to [comment:224 jpflori]:\n> > > > Do you suggest we keep the \"#define ulong unsigned long\"?\n> > > > I don't really care.\n> \n> `for f in $SOURCES; do sed -i 's/ulong/mp_limb_t/g' $f; done` ;-)\n> \n> \n\n> \n> > > I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).\n> > You can just propose whatever changes you want to include here, I'm in close contact with upstream, especially for the build system, so I'll take care of coordination.\n> > I agree there is some fishy things going on with FLINT_TUNE and CFLAGS and surely other things.\n> > \n> > And don't say \"let's switch to autotools\" unless you wanna be in charge of the build system maintenance as Bill Hart will definitely not want to maintain it.\n> \n> :-)  Yes.  I just meant I don't know if there are any changes in progress w.r.t. this.\nNot that I am aware of, so unless Bill posts here and rants we all should assume so.\n> \n> It doesn't seem we'd need any *Sage-specific* changes, so IMHO we should take fixes from upstream, or push (generic) changes there.\n> \n>  \n> > Be also aware there won't be any FLINT release before at least the dev meeting in may.\n> \n> Yes.  But FLINT 2.3.1 should (already) include any fixes we (and others) need, see above.\nOf course, its just I'm getting tired by this ticket and don't want to wait for the 2.3.1 release which at best will happen in mid-may and then all the stuff here will have to be rebased again...\nAnd that's optimistic because I guess most people at the FLINT meeting will expect to work with FLINT 2.3 and this spkg and will implement new features in FLINT/Sage, rather than working on the FLINT build system and trying to push a new release.\n\nSo I feel our best shot is to get http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg.14241 in as it just modifies flint-2.3 minimally to make it work on OS X.\nLet's keep the C99, strange env variables fun for a later FLINT release/Sage spkg if its not definitely needed to let Sage work on supported systems.",
    "created_at": "2013-03-27T16:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138278",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:231 leif]:
> Replying to [comment:227 jpflori]:
> > Replying to [comment:225 leif]:
> > > Replying to [comment:224 jpflori]:
> > > > Do you suggest we keep the "#define ulong unsigned long"?
> > > > I don't really care.
> 
> `for f in $SOURCES; do sed -i 's/ulong/mp_limb_t/g' $f; done` ;-)
> 
> 

> 
> > > I think we should [better?] coordinate that with upstream (probably including changes to the weird `configure` and `Makefile.in`, too -- haven't looked at FLINT's current state recently at all).
> > You can just propose whatever changes you want to include here, I'm in close contact with upstream, especially for the build system, so I'll take care of coordination.
> > I agree there is some fishy things going on with FLINT_TUNE and CFLAGS and surely other things.
> > 
> > And don't say "let's switch to autotools" unless you wanna be in charge of the build system maintenance as Bill Hart will definitely not want to maintain it.
> 
> :-)  Yes.  I just meant I don't know if there are any changes in progress w.r.t. this.
Not that I am aware of, so unless Bill posts here and rants we all should assume so.
> 
> It doesn't seem we'd need any *Sage-specific* changes, so IMHO we should take fixes from upstream, or push (generic) changes there.
> 
>  
> > Be also aware there won't be any FLINT release before at least the dev meeting in may.
> 
> Yes.  But FLINT 2.3.1 should (already) include any fixes we (and others) need, see above.
Of course, its just I'm getting tired by this ticket and don't want to wait for the 2.3.1 release which at best will happen in mid-may and then all the stuff here will have to be rebased again...
And that's optimistic because I guess most people at the FLINT meeting will expect to work with FLINT 2.3 and this spkg and will implement new features in FLINT/Sage, rather than working on the FLINT build system and trying to push a new release.

So I feel our best shot is to get http://boxen.math.washington.edu/home/jpflori/flint-2.3.p0.spkg.14241 in as it just modifies flint-2.3 minimally to make it work on OS X.
Let's keep the C99, strange env variables fun for a later FLINT release/Sage spkg if its not definitely needed to let Sage work on supported systems.



---

archive/issue_comments_138279.json:
```json
{
    "body": "Ok, too many uploads today, it seems the last version I posted are broken.\nPlease wait for a couple of minutes so that I fix that.",
    "created_at": "2013-03-27T17:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138279",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, too many uploads today, it seems the last version I posted are broken.
Please wait for a couple of minutes so that I fix that.



---

archive/issue_comments_138280.json:
```json
{
    "body": "Attachment [flint-2.3.p0.diff.14241](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p0.diff.14241) by jpflori created at 2013-03-27 17:07:52\n\nSpkg diff, for review only. Based on #14241.",
    "created_at": "2013-03-27T17:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138280",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3.p0.diff.14241](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p0.diff.14241) by jpflori created at 2013-03-27 17:07:52

Spkg diff, for review only. Based on #14241.



---

archive/issue_comments_138281.json:
```json
{
    "body": "Should be ok now.\nAt least I've checked the two spkgs seem to build and pass their testsuite on my system.",
    "created_at": "2013-03-27T17:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138281",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Should be ok now.
At least I've checked the two spkgs seem to build and pass their testsuite on my system.



---

archive/issue_comments_138282.json:
```json
{
    "body": "One additional doctest change for 5.9.beta2",
    "created_at": "2013-03-29T18:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138282",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

One additional doctest change for 5.9.beta2



---

archive/issue_comments_138283.json:
```json
{
    "body": "Attachment [flint-2.3-library-5.9.b2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-library-5.9.b2.patch) by jpflori created at 2013-03-29 18:50:00",
    "created_at": "2013-03-29T18:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138283",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [flint-2.3-library-5.9.b2.patch](tarball://root/attachments/some-uuid/ticket12173/flint-2.3-library-5.9.b2.patch) by jpflori created at 2013-03-29 18:50:00



---

archive/issue_comments_138284.json:
```json
{
    "body": "Works fine on the buildbot.",
    "created_at": "2013-04-04T17:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138284",
    "user": "https://github.com/jdemeyer"
}
```

Works fine on the buildbot.



---

archive/issue_comments_138285.json:
```json
{
    "body": "As for `ulong`: I think the correct solution is\n\n```\ntypedef unsigned long ulong;\n```\n\ninstead of `#define`. This `typedef` is compatible with the common C libraries. Of course, the workaround currently in `zn_poly` would need to be removed too.",
    "created_at": "2013-04-04T17:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138285",
    "user": "https://github.com/jdemeyer"
}
```

As for `ulong`: I think the correct solution is

```
typedef unsigned long ulong;
```

instead of `#define`. This `typedef` is compatible with the common C libraries. Of course, the workaround currently in `zn_poly` would need to be removed too.



---

archive/issue_comments_138286.json:
```json
{
    "body": "Replying to [comment:236 jdemeyer]:\n> Works fine on the buildbot.\n\nI've also tested it with Sage 5.9.beta2 on Linux x86 (GCC 4.7.2, with '-O3') and Linux x86_64 (GCC 4.8.0, with '-O3') without any issues, i.e., patches apply, `sage -b` works as expected (all modules that need rebuilding get rebuilt -- no need to brute-force `sage -ba`), and all long tests ([p]testlong) passed.\n\nI haven't reviewed the 8000+ lines patch though...",
    "created_at": "2013-04-04T19:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138286",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:236 jdemeyer]:
> Works fine on the buildbot.

I've also tested it with Sage 5.9.beta2 on Linux x86 (GCC 4.7.2, with '-O3') and Linux x86_64 (GCC 4.8.0, with '-O3') without any issues, i.e., patches apply, `sage -b` works as expected (all modules that need rebuilding get rebuilt -- no need to brute-force `sage -ba`), and all long tests ([p]testlong) passed.

I haven't reviewed the 8000+ lines patch though...



---

archive/issue_comments_138287.json:
```json
{
    "body": "Replying to [comment:237 jdemeyer]:\n> As for `ulong`: I think the correct solution is\n> {{{\n> typedef unsigned long ulong;\n> }}}\n> instead of `#define`. This `typedef` is compatible with the common C libraries. Of course, the workaround currently in `zn_poly` would need to be removed too.\n\nWell, the disadvantage of `typedef`s (vs. `#define`s) is always that there's no way to test (with the preprocessor) whether a type is already (`type`)def'd (other than checking such in `configure` and defining `HAVE_TYPEDEF_FOO` etc.).\n\nAs mentioned elsewhere, in the present cases it would IMHO be cleaner to use `mp_limb_t` anyway (which of course isn't that much shorter or easier to type than `unsigned long`).",
    "created_at": "2013-04-04T20:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138287",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:237 jdemeyer]:
> As for `ulong`: I think the correct solution is
> {{{
> typedef unsigned long ulong;
> }}}
> instead of `#define`. This `typedef` is compatible with the common C libraries. Of course, the workaround currently in `zn_poly` would need to be removed too.

Well, the disadvantage of `typedef`s (vs. `#define`s) is always that there's no way to test (with the preprocessor) whether a type is already (`type`)def'd (other than checking such in `configure` and defining `HAVE_TYPEDEF_FOO` etc.).

As mentioned elsewhere, in the present cases it would IMHO be cleaner to use `mp_limb_t` anyway (which of course isn't that much shorter or easier to type than `unsigned long`).



---

archive/issue_comments_138288.json:
```json
{
    "body": "Replying to [comment:238 leif]:\n> I've also tested it with Sage 5.9.beta2 on Linux x86 (GCC 4.7.2, with '-O3') and Linux x86_64 (GCC 4.8.0, with '-O3') without any issues, i.e., patches apply, `sage -b` works as expected (all modules that need rebuilding get rebuilt -- no need to brute-force `sage -ba`), and all long tests ([p]testlong) passed.\n\nOh, and of course FLINT 2.3's test suite passed in both cases as well; I just noticed there's no message regarding that (and when running the test suite in parallel, the output isn't synced, i.e., you may get `foo...bar...` and a couple of `PASS`s where it's not obvious what they refer to, which isn't really a problem until a test fails).",
    "created_at": "2013-04-04T20:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138288",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:238 leif]:
> I've also tested it with Sage 5.9.beta2 on Linux x86 (GCC 4.7.2, with '-O3') and Linux x86_64 (GCC 4.8.0, with '-O3') without any issues, i.e., patches apply, `sage -b` works as expected (all modules that need rebuilding get rebuilt -- no need to brute-force `sage -ba`), and all long tests ([p]testlong) passed.

Oh, and of course FLINT 2.3's test suite passed in both cases as well; I just noticed there's no message regarding that (and when running the test suite in parallel, the output isn't synced, i.e., you may get `foo...bar...` and a couple of `PASS`s where it's not obvious what they refer to, which isn't really a problem until a test fails).



---

archive/issue_comments_138289.json:
```json
{
    "body": "About the typedef thing, I propose we wait until the FLINT meeting in early may which I should attend.\nI'll discuss it there with Bill Hart.\n\nBut if you think its really an issue and want #14268 merged first (or at the same time, I mean going from define to typedef in FLINT whether its 1.x or 2.x), feel free to discuss it on flint-devel group.\nYou can then use the spkg a few comments above I based on the one from #14268.\n\nAnd it's know that the output of tests are out of sync when run in parallel, but before they were not even run in parallel, so I think the situation is better now, although not optimal.",
    "created_at": "2013-04-04T20:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138289",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

About the typedef thing, I propose we wait until the FLINT meeting in early may which I should attend.
I'll discuss it there with Bill Hart.

But if you think its really an issue and want #14268 merged first (or at the same time, I mean going from define to typedef in FLINT whether its 1.x or 2.x), feel free to discuss it on flint-devel group.
You can then use the spkg a few comments above I based on the one from #14268.

And it's know that the output of tests are out of sync when run in parallel, but before they were not even run in parallel, so I think the situation is better now, although not optimal.



---

archive/issue_comments_138290.json:
```json
{
    "body": "Replying to [comment:241 jpflori]:\n> About the typedef thing, I propose we wait until the FLINT meeting in early may which I should attend.\n> I'll discuss it there with Bill Hart.\n> \n> But if you think its really an issue and want #14268 merged first (or at the same time, I mean going from define to typedef in FLINT whether its 1.x or 2.x), feel free to discuss it on flint-devel group.\n> You can then use the spkg a few comments above I based on the one from #14268.\n\nI think we should postpone that to a follow-up ticket, i.e., get FLINT 2.3 in as is first.\n\n\n\n\n> And it's know that the output of tests are out of sync when run in parallel, but before they were not even run in parallel, so I think the situation is better now, although not optimal.\n\n:-)  Yes, but adding (back?) a message to `spkg-check` in case all tests passed wouldn't be bad, nor hard...\n\nThe end of the log currently looks like this:\n\n```\n...\ng++-4.8.0 -march=native -mtune=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS -funroll-loops -I${SAGE_ROOT}/spkg/build/flint-2.3.p0/src -I${SAGE_ROOT}/local/include -I${SAGE_ROOT}/local/include -I${SAGE_ROOT}/local/include interfaces/test/t-NTL-interface.cpp build/interfaces/NTL-interface.o -o build/interfaces/test/t-NTL-interface -L${SAGE_ROOT}/spkg/build/flint-2.3.p0/src -L${SAGE_ROOT}/local/lib -L${SAGE_ROOT}/local/lib -L${SAGE_ROOT}/local/lib -lflint -lntl -lmpfr -lmpir -lm -lpthread;\nmake[1]: Leaving directory `${SAGE_ROOT}/spkg/build/flint-2.3.p0/src'\nZZ_to_fmpz....PASS\nZZX_to_fmpz_poly....PASS\n\nreal\t57m16.835s\nuser\t50m49.950s\nsys\t1m56.670s\nDeleting temporary build directory\n${SAGE_ROOT}/spkg/build/flint-2.3.p0\nFinished installing flint-2.3.p0.spkg\n```\n",
    "created_at": "2013-04-04T21:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138290",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:241 jpflori]:
> About the typedef thing, I propose we wait until the FLINT meeting in early may which I should attend.
> I'll discuss it there with Bill Hart.
> 
> But if you think its really an issue and want #14268 merged first (or at the same time, I mean going from define to typedef in FLINT whether its 1.x or 2.x), feel free to discuss it on flint-devel group.
> You can then use the spkg a few comments above I based on the one from #14268.

I think we should postpone that to a follow-up ticket, i.e., get FLINT 2.3 in as is first.




> And it's know that the output of tests are out of sync when run in parallel, but before they were not even run in parallel, so I think the situation is better now, although not optimal.

:-)  Yes, but adding (back?) a message to `spkg-check` in case all tests passed wouldn't be bad, nor hard...

The end of the log currently looks like this:

```
...
g++-4.8.0 -march=native -mtune=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS -funroll-loops -I${SAGE_ROOT}/spkg/build/flint-2.3.p0/src -I${SAGE_ROOT}/local/include -I${SAGE_ROOT}/local/include -I${SAGE_ROOT}/local/include interfaces/test/t-NTL-interface.cpp build/interfaces/NTL-interface.o -o build/interfaces/test/t-NTL-interface -L${SAGE_ROOT}/spkg/build/flint-2.3.p0/src -L${SAGE_ROOT}/local/lib -L${SAGE_ROOT}/local/lib -L${SAGE_ROOT}/local/lib -lflint -lntl -lmpfr -lmpir -lm -lpthread;
make[1]: Leaving directory `${SAGE_ROOT}/spkg/build/flint-2.3.p0/src'
ZZ_to_fmpz....PASS
ZZX_to_fmpz_poly....PASS

real	57m16.835s
user	50m49.950s
sys	1m56.670s
Deleting temporary build directory
${SAGE_ROOT}/spkg/build/flint-2.3.p0
Finished installing flint-2.3.p0.spkg
```




---

archive/issue_comments_138291.json:
```json
{
    "body": "Replying to [comment:241 jpflori]:\n> About the typedef thing, I propose we wait until the FLINT meeting in early may which I should attend.\n> I'll discuss it there with Bill Hart.\nI agree. The main argument in favour of `typedef` is that some other libraries (including `glibc`, which should be a strong precedent and `zn_poly`) also use `typedef`. And it's not a problem to have the same `typedef` twice.",
    "created_at": "2013-04-04T21:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138291",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:241 jpflori]:
> About the typedef thing, I propose we wait until the FLINT meeting in early may which I should attend.
> I'll discuss it there with Bill Hart.
I agree. The main argument in favour of `typedef` is that some other libraries (including `glibc`, which should be a strong precedent and `zn_poly`) also use `typedef`. And it's not a problem to have the same `typedef` twice.



---

archive/issue_comments_138292.json:
```json
{
    "body": "Replying to [comment:243 jdemeyer]:\n> The main argument in favour of `typedef` is that some other libraries (including `glibc`, which should be a strong precedent and `zn_poly`) also use `typedef`. And it's not a problem to have the same `typedef` twice.\n\n\n```C\ntypedef unsigned long ulong;\n\ntypedef unsigned long ulong;\n```\n\ngives an error (redefinition of ulong) at least with earlier versions of GCC.  `clang` is more verbose:\n\n```\ntypedef.c:3:23: warning: redefinition of typedef 'ulong' is a C11 feature [-Wtypedef-redefinition]\ntypedef unsigned long ulong;\n                      ^\ntypedef.c:1:23: note: previous definition is here\ntypedef unsigned long ulong;\n                      ^\n1 warning generated.\n```\n",
    "created_at": "2013-04-04T21:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138292",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:243 jdemeyer]:
> The main argument in favour of `typedef` is that some other libraries (including `glibc`, which should be a strong precedent and `zn_poly`) also use `typedef`. And it's not a problem to have the same `typedef` twice.


```C
typedef unsigned long ulong;

typedef unsigned long ulong;
```

gives an error (redefinition of ulong) at least with earlier versions of GCC.  `clang` is more verbose:

```
typedef.c:3:23: warning: redefinition of typedef 'ulong' is a C11 feature [-Wtypedef-redefinition]
typedef unsigned long ulong;
                      ^
typedef.c:1:23: note: previous definition is here
typedef unsigned long ulong;
                      ^
1 warning generated.
```




---

archive/issue_comments_138293.json:
```json
{
    "body": "GCC 4.6.3 warns with `-pedantic`:\n\n```\ntypedef.c:2:23: warning: redefinition of typedef 'ulong' [-pedantic]\ntypedef.c:1:23: note: previous declaration of 'ulong' was here\n```\n\nWithout `-pedantic` (even with `-Wall -Wextra`), there is no warning or error.",
    "created_at": "2013-04-04T22:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138293",
    "user": "https://github.com/jdemeyer"
}
```

GCC 4.6.3 warns with `-pedantic`:

```
typedef.c:2:23: warning: redefinition of typedef 'ulong' [-pedantic]
typedef.c:1:23: note: previous declaration of 'ulong' was here
```

Without `-pedantic` (even with `-Wall -Wextra`), there is no warning or error.



---

archive/issue_comments_138294.json:
```json
{
    "body": "GCC 4.4.3 errors out, regardless what `-std` is active.",
    "created_at": "2013-04-04T22:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138294",
    "user": "https://github.com/nexttime"
}
```

GCC 4.4.3 errors out, regardless what `-std` is active.



---

archive/issue_comments_138295.json:
```json
{
    "body": "But g++ always accepts it, this is legal in C++.",
    "created_at": "2013-04-04T22:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138295",
    "user": "https://github.com/jdemeyer"
}
```

But g++ always accepts it, this is legal in C++.



---

archive/issue_comments_138296.json:
```json
{
    "body": "Replying to [comment:247 jdemeyer]:\n> But g++ always accepts it, this is legal in C++.\n\n... while both FLINT and zn_poly are (mostly) written in C, not C++. ;-)",
    "created_at": "2013-04-04T22:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138296",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:247 jdemeyer]:
> But g++ always accepts it, this is legal in C++.

... while both FLINT and zn_poly are (mostly) written in C, not C++. ;-)



---

archive/issue_comments_138297.json:
```json
{
    "body": "Some good read: [http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c](http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c)",
    "created_at": "2013-04-04T22:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138297",
    "user": "https://github.com/jdemeyer"
}
```

Some good read: [http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c](http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c)



---

archive/issue_comments_138298.json:
```json
{
    "body": "Replying to [comment:249 jdemeyer]:\n> Some good read: [http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c](http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c)\n\nSo the optimal solution is\n\n```C\n#define typedef please typedef\n\n...\n\ntypedef unsigned long ulong;\n```\n",
    "created_at": "2013-04-04T22:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138298",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:249 jdemeyer]:
> Some good read: [http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c](http://stackoverflow.com/questions/8594954/repeated-typedefs-invalid-in-c-but-valid-in-c)

So the optimal solution is

```C
#define typedef please typedef

...

typedef unsigned long ulong;
```




---

archive/issue_comments_138299.json:
```json
{
    "body": "Or maybe, a bit safer:\n\n```C\n#ifndef typedef\n#define typedef please typedef\n#endif\n\n...\n```\n",
    "created_at": "2013-04-04T22:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138299",
    "user": "https://github.com/nexttime"
}
```

Or maybe, a bit safer:

```C
#ifndef typedef
#define typedef please typedef
#endif

...
```




---

archive/issue_comments_138300.json:
```json
{
    "body": "Reminder:\n\nReplying to [comment:161 jdemeyer]:\n> For easier reviewing, it would really be good to split up the big patchbomb into a \"rename methods\" patch (e.g. from zmod to nmod) which does only that and should be automatically generated and a \"remainder\" patch.",
    "created_at": "2013-04-09T13:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138300",
    "user": "https://github.com/jdemeyer"
}
```

Reminder:

Replying to [comment:161 jdemeyer]:
> For easier reviewing, it would really be good to split up the big patchbomb into a "rename methods" patch (e.g. from zmod to nmod) which does only that and should be automatically generated and a "remainder" patch.



---

archive/issue_comments_138301.json:
```json
{
    "body": "This should be rebased to #14393.",
    "created_at": "2013-04-09T13:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138301",
    "user": "https://github.com/jdemeyer"
}
```

This should be rebased to #14393.



---

archive/issue_comments_138302.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-04-09T13:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138302",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_138303.json:
```json
{
    "body": "Replying to [comment:162 jpflori]:\n> I don't really feel like resplitting everything back now...\nBut you expect a reviewer to do it... not me.",
    "created_at": "2013-04-09T13:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138303",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:162 jpflori]:
> I don't really feel like resplitting everything back now...
But you expect a reviewer to do it... not me.



---

archive/issue_comments_138304.json:
```json
{
    "body": "As I pointed above before, all the content of the patchbomb is from:\n* http://trac.sagemath.org/sage_trac/ticket/12173#comment:123\nexcept that:\n* the last patch from there is omitted in the merged patchbomb;\n* the patch bomb was rebased several times;\n* one or two newly introduced doctests had to be changed;\n* your fixes from http://trac.sagemath.org/sage_trac/ticket/12173?replyto=213#comment:153 were included.\n\nBut if you feel we must really have the latest version resplitted to do a proper review, I'll give it a try when rebasing once more against #14393.",
    "created_at": "2013-04-11T09:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138304",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

As I pointed above before, all the content of the patchbomb is from:
* http://trac.sagemath.org/sage_trac/ticket/12173#comment:123
except that:
* the last patch from there is omitted in the merged patchbomb;
* the patch bomb was rebased several times;
* one or two newly introduced doctests had to be changed;
* your fixes from http://trac.sagemath.org/sage_trac/ticket/12173?replyto=213#comment:153 were included.

But if you feel we must really have the latest version resplitted to do a proper review, I'll give it a try when rebasing once more against #14393.



---

archive/issue_comments_138305.json:
```json
{
    "body": "Replying to [comment:256 jpflori]:\n> But if you feel we must really have the latest version resplitted to do a proper review\nYou don't need to resplit everything as before. The problem is that a large part of this patch is simply renaming stuff. This should be done automatically (e.g. with a `sed` command).\n\nThat's the minimal thing that I require: a script which does the automatic parts of the patch, so I can review that script instead of its output (which is much more).",
    "created_at": "2013-04-11T09:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138305",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:256 jpflori]:
> But if you feel we must really have the latest version resplitted to do a proper review
You don't need to resplit everything as before. The problem is that a large part of this patch is simply renaming stuff. This should be done automatically (e.g. with a `sed` command).

That's the minimal thing that I require: a script which does the automatic parts of the patch, so I can review that script instead of its output (which is much more).



---

archive/issue_comments_138306.json:
```json
{
    "body": "Result of script.sh",
    "created_at": "2013-04-15T13:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138306",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Result of script.sh



---

archive/issue_comments_138307.json:
```json
{
    "body": "Attachment [trac_12173-fixes-v4.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v4.patch) by jpflori created at 2013-04-15 13:11:59\n\nFixes after running script.sh",
    "created_at": "2013-04-15T13:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138307",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-fixes-v4.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v4.patch) by jpflori created at 2013-04-15 13:11:59

Fixes after running script.sh



---

archive/issue_comments_138308.json:
```json
{
    "body": "Attachment [trac_12173-doctests.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-doctests.patch) by jpflori created at 2013-04-15 13:12:19\n\nDoctests.",
    "created_at": "2013-04-15T13:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138308",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-doctests.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-doctests.patch) by jpflori created at 2013-04-15 13:12:19

Doctests.



---

archive/issue_comments_138309.json:
```json
{
    "body": "Ok here you go.\nAt least Sage builds correctly, I've just launched make ptestlong.",
    "created_at": "2013-04-15T13:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138309",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok here you go.
At least Sage builds correctly, I've just launched make ptestlong.



---

archive/issue_comments_138310.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-15T13:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138310",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138311.json:
```json
{
    "body": "Root patch",
    "created_at": "2013-04-15T13:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138311",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Root patch



---

archive/issue_comments_138312.json:
```json
{
    "body": "Attachment [trac_12173-root.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-root.patch) by jpflori created at 2013-04-15 13:17:19",
    "created_at": "2013-04-15T13:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138312",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-root.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-root.patch) by jpflori created at 2013-04-15 13:17:19



---

archive/issue_comments_138313.json:
```json
{
    "body": "Remainder: the current spkg does not take #14268 into account, anyway it is not merged yet, so could rather be rebased on top of this ticket.\nFor an spkg based on #14268, look at the links at comment 229: http://trac.sagemath.org/sage_trac/ticket/12173#comment:229.",
    "created_at": "2013-04-15T13:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138313",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Remainder: the current spkg does not take #14268 into account, anyway it is not merged yet, so could rather be rebased on top of this ticket.
For an spkg based on #14268, look at the links at comment 229: http://trac.sagemath.org/sage_trac/ticket/12173#comment:229.



---

archive/issue_comments_138314.json:
```json
{
    "body": "Hum, there is something wrong. Having a look at it right now.",
    "created_at": "2013-04-15T13:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138314",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Hum, there is something wrong. Having a look at it right now.



---

archive/issue_comments_138315.json:
```json
{
    "body": "(when testing cython.py)",
    "created_at": "2013-04-15T13:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138315",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

(when testing cython.py)



---

archive/issue_comments_138316.json:
```json
{
    "body": "The last version of script.sh does not delete fmpq_poly.h...",
    "created_at": "2013-04-15T13:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138316",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

The last version of script.sh does not delete fmpq_poly.h...



---

archive/issue_comments_138317.json:
```json
{
    "body": "In fact that's not the good script...\nReuploading everything in a few minutes.",
    "created_at": "2013-04-15T13:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138317",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

In fact that's not the good script...
Reuploading everything in a few minutes.



---

archive/issue_comments_138318.json:
```json
{
    "body": "Attachment [script.sh](tarball://root/attachments/some-uuid/ticket12173/script.sh) by jpflori created at 2013-04-15 14:05:48\n\nUpdate script.",
    "created_at": "2013-04-15T14:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138318",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [script.sh](tarball://root/attachments/some-uuid/ticket12173/script.sh) by jpflori created at 2013-04-15 14:05:48

Update script.



---

archive/issue_comments_138319.json:
```json
{
    "body": "Result of script.sh",
    "created_at": "2013-04-15T14:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138319",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Result of script.sh



---

archive/issue_comments_138320.json:
```json
{
    "body": "Attachment [trac_12173-script-v6.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-script-v6.patch) by jpflori created at 2013-04-15 14:12:15\n\nMore readable patch for nmod_poly.pxd",
    "created_at": "2013-04-15T14:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138320",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-script-v6.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-script-v6.patch) by jpflori created at 2013-04-15 14:12:15

More readable patch for nmod_poly.pxd



---

archive/issue_comments_138321.json:
```json
{
    "body": "Attachment [nmod_poly.patch](tarball://root/attachments/some-uuid/ticket12173/nmod_poly.patch) by jpflori created at 2013-04-15 14:13:47\n\nI've upped [attachment:nmod_poly.patch] which gives a more readable view of the changes in nmod_poly.pxd than what mercurial spits out in [attachment:trac_12173-fixes-v4.patch].",
    "created_at": "2013-04-15T14:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138321",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [nmod_poly.patch](tarball://root/attachments/some-uuid/ticket12173/nmod_poly.patch) by jpflori created at 2013-04-15 14:13:47

I've upped [attachment:nmod_poly.patch] which gives a more readable view of the changes in nmod_poly.pxd than what mercurial spits out in [attachment:trac_12173-fixes-v4.patch].



---

archive/issue_comments_138322.json:
```json
{
    "body": "\"make ptestlong\" went fine on a 64 bits Ubuntu 12.04.2 install (except for two unrelated files, cachefunc.py wich passes when run afterward and gen_interpreters.py which fails because of NFS timestamps issues).",
    "created_at": "2013-04-15T14:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138322",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

"make ptestlong" went fine on a 64 bits Ubuntu 12.04.2 install (except for two unrelated files, cachefunc.py wich passes when run afterward and gen_interpreters.py which fails because of NFS timestamps issues).



---

archive/issue_comments_138323.json:
```json
{
    "body": "Will this package make it possible to drop the flintqs spkg too?",
    "created_at": "2013-04-15T16:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138323",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

Will this package make it possible to drop the flintqs spkg too?



---

archive/issue_comments_138324.json:
```json
{
    "body": "Everything went fine on a fresh 5.9.beta5 build with the patched ecl package as at #14426 (which has been merged into 5.9.rc0 now).  I did not do make ptestlong, but I did do sage -tp10 --long on the whole library and had no failures.\n\nI don't know the answer to the question about flintqs.",
    "created_at": "2013-04-16T09:01:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138324",
    "user": "https://github.com/JohnCremona"
}
```

Everything went fine on a fresh 5.9.beta5 build with the patched ecl package as at #14426 (which has been merged into 5.9.rc0 now).  I did not do make ptestlong, but I did do sage -tp10 --long on the whole library and had no failures.

I don't know the answer to the question about flintqs.



---

archive/issue_comments_138325.json:
```json
{
    "body": "Replying to [comment:270 cremona]:\n> I don't know the answer to the question about flintqs.\nNor do I.\nLatest info I remember is from:\n* https://groups.google.com/d/msg/flint-devel/lmRdEPV6el8/TjHd0NzSOWsJ\n* https://groups.google.com/d/msg/flint-devel/lmRdEPV6el8/JNbZ4eTy_n0J\nbut it seems Julien is aware of that.\n\nAnyway, this should be dealt with at #11792.",
    "created_at": "2013-04-16T10:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138325",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:270 cremona]:
> I don't know the answer to the question about flintqs.
Nor do I.
Latest info I remember is from:
* https://groups.google.com/d/msg/flint-devel/lmRdEPV6el8/TjHd0NzSOWsJ
* https://groups.google.com/d/msg/flint-devel/lmRdEPV6el8/JNbZ4eTy_n0J
but it seems Julien is aware of that.

Anyway, this should be dealt with at #11792.



---

archive/issue_comments_138326.json:
```json
{
    "body": "Just to be clear: these three patches when applied should result in exactly the same end result as the original [attachment:flint-2.3-library-5.9.b2.patch], right?",
    "created_at": "2013-04-17T10:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138326",
    "user": "https://github.com/jdemeyer"
}
```

Just to be clear: these three patches when applied should result in exactly the same end result as the original [attachment:flint-2.3-library-5.9.b2.patch], right?



---

archive/issue_comments_138327.json:
```json
{
    "body": "No.",
    "created_at": "2013-04-17T11:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138327",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

No.



---

archive/issue_comments_138328.json:
```json
{
    "body": "But functionally yes.\n\nHere is what I did:\n* look thru the original patch and write the sed script;\n* remove the scripted part from the original part by hand;\n* remove the purely doctests, doc, parts of the original part and put them apart;\n* fix the punctured original patch by hand, and especially, completely reorder the nmod_poly.pxd part so that it can be read by a human;\n* remark some other parts could be scripted and go back to the first step until Sage builds and passes its testsuite.",
    "created_at": "2013-04-17T11:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138328",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

But functionally yes.

Here is what I did:
* look thru the original patch and write the sed script;
* remove the scripted part from the original part by hand;
* remove the purely doctests, doc, parts of the original part and put them apart;
* fix the punctured original patch by hand, and especially, completely reorder the nmod_poly.pxd part so that it can be read by a human;
* remark some other parts could be scripted and go back to the first step until Sage builds and passes its testsuite.



---

archive/issue_comments_138329.json:
```json
{
    "body": "Slightly updated. Now the three patches together are exactly the same as the original, except for changes in `module_list.py` (which needed rebasing anyway) and except for the CRLF line endings.",
    "created_at": "2013-04-17T11:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138329",
    "user": "https://github.com/jdemeyer"
}
```

Slightly updated. Now the three patches together are exactly the same as the original, except for changes in `module_list.py` (which needed rebasing anyway) and except for the CRLF line endings.



---

archive/issue_comments_138330.json:
```json
{
    "body": "Sorry, I was wrong. The three patches aren't the same as the original, there is an additional move of `zmod_poly.pxd` to `nmod_poly.pxd` and similar for `zmod_poly_linkage.pxi`.",
    "created_at": "2013-04-17T11:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138330",
    "user": "https://github.com/jdemeyer"
}
```

Sorry, I was wrong. The three patches aren't the same as the original, there is an additional move of `zmod_poly.pxd` to `nmod_poly.pxd` and similar for `zmod_poly_linkage.pxi`.



---

archive/issue_comments_138331.json:
```json
{
    "body": "Except for the renaming of the two zmod_ files to nmod_, except for the CRLF line endings and except for `module_list.py`, the first three patches correspond the the previous split-in-3 patches, while the four patches (with [attachment:trac_12173-extra.patch]) correspond to the original all-in-one patch.\n\nTherefore, the file [attachment:trac_12173-extra.patch] contains some unexplained changes which were in the original all-in-one patch but not in jpflori's 3 patches. This needs to be clarified.",
    "created_at": "2013-04-17T12:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138331",
    "user": "https://github.com/jdemeyer"
}
```

Except for the renaming of the two zmod_ files to nmod_, except for the CRLF line endings and except for `module_list.py`, the first three patches correspond the the previous split-in-3 patches, while the four patches (with [attachment:trac_12173-extra.patch]) correspond to the original all-in-one patch.

Therefore, the file [attachment:trac_12173-extra.patch] contains some unexplained changes which were in the original all-in-one patch but not in jpflori's 3 patches. This needs to be clarified.



---

archive/issue_comments_138332.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-04-17T12:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138332",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_138333.json:
```json
{
    "body": "Indeed, some pieces went missing or were inadvertently added.\n* sage/ext/gen_interpreters.py, spurious case change not fixed in the \"fixes\" patch, so this hunk is needed;\n* sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify \"s|sage\\.libs\\.flint\\.long_extras|sage.libs.flint.ulong_extras|g\" in the script by omitting the \"sage.libs\" part\n* sage/libs/flint/fmpq_poly.pxd, ignore this hunk, it just adds a spurious newline\n* sage/libs/flint/fmpz_poly.pxi, the first hunk is needed, not sure where it went; the second hunk is more or less moving lines, in fact we could even order the lines better; the third hunk was plain wrong and now defines twice \"fmpz_poly_scalar_fdiv_ui\", so the solution is to remove that line completely.\n* sage/libs/flint/ntl_interface.pxd, should be applied; ZZ_limbs does not exists anymore, and in fact the previous declaration of fmpz_to_mpz here was misplaced... even though fmpz_get_ZZ is unused, its place is here so the all in one patch is right.\n* sage/modular/modform/eis_series.py, discard this hunk, we forgot to rename a zmod to nmod before (within a comment).\n\nAn additional change would make sense:\n* sage/libs/flint/fmpz_poly.pxi: replace \"fmpz_t fmpz_poly_get_coeff_ptr\" by \"fmpz* fmpz_poly_get_coeff_ptr\", and maybe remove the commented out line (fmpz_poly_scalar_mul), cleanup spaces",
    "created_at": "2013-04-17T12:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138333",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Indeed, some pieces went missing or were inadvertently added.
* sage/ext/gen_interpreters.py, spurious case change not fixed in the "fixes" patch, so this hunk is needed;
* sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify "s|sage\.libs\.flint\.long_extras|sage.libs.flint.ulong_extras|g" in the script by omitting the "sage.libs" part
* sage/libs/flint/fmpq_poly.pxd, ignore this hunk, it just adds a spurious newline
* sage/libs/flint/fmpz_poly.pxi, the first hunk is needed, not sure where it went; the second hunk is more or less moving lines, in fact we could even order the lines better; the third hunk was plain wrong and now defines twice "fmpz_poly_scalar_fdiv_ui", so the solution is to remove that line completely.
* sage/libs/flint/ntl_interface.pxd, should be applied; ZZ_limbs does not exists anymore, and in fact the previous declaration of fmpz_to_mpz here was misplaced... even though fmpz_get_ZZ is unused, its place is here so the all in one patch is right.
* sage/modular/modform/eis_series.py, discard this hunk, we forgot to rename a zmod to nmod before (within a comment).

An additional change would make sense:
* sage/libs/flint/fmpz_poly.pxi: replace "fmpz_t fmpz_poly_get_coeff_ptr" by "fmpz* fmpz_poly_get_coeff_ptr", and maybe remove the commented out line (fmpz_poly_scalar_mul), cleanup spaces



---

archive/issue_comments_138334.json:
```json
{
    "body": "Attachment [12173_script.sh](tarball://root/attachments/some-uuid/ticket12173/12173_script.sh) by @jdemeyer created at 2013-04-17 12:49:08",
    "created_at": "2013-04-17T12:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138334",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12173_script.sh](tarball://root/attachments/some-uuid/ticket12173/12173_script.sh) by @jdemeyer created at 2013-04-17 12:49:08



---

archive/issue_comments_138335.json:
```json
{
    "body": "Attachment [trac_12173-script-v7.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-script-v7.patch) by @jdemeyer created at 2013-04-17 12:49:20",
    "created_at": "2013-04-17T12:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138335",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_12173-script-v7.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-script-v7.patch) by @jdemeyer created at 2013-04-17 12:49:20



---

archive/issue_comments_138336.json:
```json
{
    "body": "Attachment [trac_12173-fixes-v5.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v5.patch) by @jdemeyer created at 2013-04-17 12:49:29",
    "created_at": "2013-04-17T12:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138336",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_12173-fixes-v5.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v5.patch) by @jdemeyer created at 2013-04-17 12:49:29



---

archive/issue_comments_138337.json:
```json
{
    "body": "Removed trailing whitespace from all patches.",
    "created_at": "2013-04-17T12:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138337",
    "user": "https://github.com/jdemeyer"
}
```

Removed trailing whitespace from all patches.



---

archive/issue_comments_138338.json:
```json
{
    "body": "Replying to [comment:281 jpflori]:\n> * sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify \"s|sage\\.libs\\.flint\\.long_extras|sage.libs.flint.ulong_extras|g\" in the script by omitting the \"sage.libs\" part\nDone.",
    "created_at": "2013-04-17T12:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138338",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:281 jpflori]:
> * sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify "s|sage\.libs\.flint\.long_extras|sage.libs.flint.ulong_extras|g" in the script by omitting the "sage.libs" part
Done.



---

archive/issue_comments_138339.json:
```json
{
    "body": "Replying to [comment:283 jdemeyer]:\n> Replying to [comment:281 jpflori]:\n> > * sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify \"s|sage\\.libs\\.flint\\.long_extras|sage.libs.flint.ulong_extras|g\" in the script by omitting the \"sage.libs\" part\n> Done.\nDon't you mind taking care of the changes I proposed?\nI also started modifying the script and the fixes patch, but let's not duplicate work.",
    "created_at": "2013-04-17T12:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138339",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:283 jdemeyer]:
> Replying to [comment:281 jpflori]:
> > * sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify "s|sage\.libs\.flint\.long_extras|sage.libs.flint.ulong_extras|g" in the script by omitting the "sage.libs" part
> Done.
Don't you mind taking care of the changes I proposed?
I also started modifying the script and the fixes patch, but let's not duplicate work.



---

archive/issue_comments_138340.json:
```json
{
    "body": "Replying to [comment:283 jdemeyer]:\n> Replying to [comment:281 jpflori]:\n> > * sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify \"s|sage\\.libs\\.flint\\.long_extras|sage.libs.flint.ulong_extras|g\" in the script by omitting the \"sage.libs\" part\n> Done.\nNevermind, that won't fix the problem.\nWe should rather add \"s|flint/long_extras\\.h|flint/ulong_extras\\.h|g\".\nI'm taking care of that and other fixes now.",
    "created_at": "2013-04-17T13:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138340",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:283 jdemeyer]:
> Replying to [comment:281 jpflori]:
> > * sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi, I missed this one, we should modify "s|sage\.libs\.flint\.long_extras|sage.libs.flint.ulong_extras|g" in the script by omitting the "sage.libs" part
> Done.
Nevermind, that won't fix the problem.
We should rather add "s|flint/long_extras\.h|flint/ulong_extras\.h|g".
I'm taking care of that and other fixes now.



---

archive/issue_comments_138341.json:
```json
{
    "body": "Oops, me too.",
    "created_at": "2013-04-17T13:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138341",
    "user": "https://github.com/jdemeyer"
}
```

Oops, me too.



---

archive/issue_comments_138342.json:
```json
{
    "body": "Attachment [trac_12173-extra.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-extra.patch) by @jdemeyer created at 2013-04-17 13:20:04",
    "created_at": "2013-04-17T13:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138342",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_12173-extra.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-extra.patch) by @jdemeyer created at 2013-04-17 13:20:04



---

archive/issue_comments_138343.json:
```json
{
    "body": "Attachment [undo.patch](tarball://root/attachments/some-uuid/ticket12173/undo.patch) by @jdemeyer created at 2013-04-17 13:20:35\n\nOriginal changes, not applied anymore",
    "created_at": "2013-04-17T13:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138343",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [undo.patch](tarball://root/attachments/some-uuid/ticket12173/undo.patch) by @jdemeyer created at 2013-04-17 13:20:35

Original changes, not applied anymore



---

archive/issue_comments_138344.json:
```json
{
    "body": "OK, not making further changes.\n\nI *removed* some hunks and, for reference, I put all removed hunks in [attachment:undo.patch]. So this should not be applied, it contains stuff from the original all-in-one patch which are undone.",
    "created_at": "2013-04-17T13:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138344",
    "user": "https://github.com/jdemeyer"
}
```

OK, not making further changes.

I *removed* some hunks and, for reference, I put all removed hunks in [attachment:undo.patch]. So this should not be applied, it contains stuff from the original all-in-one patch which are undone.



---

archive/issue_comments_138345.json:
```json
{
    "body": "Replying to [comment:285 jpflori]:\n> We should rather add \"s|flint/long_extras\\.h|flint/ulong_extras\\.h|g\".\nThat's essentially the change I made, it works.",
    "created_at": "2013-04-17T13:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138345",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:285 jpflori]:
> We should rather add "s|flint/long_extras\.h|flint/ulong_extras\.h|g".
That's essentially the change I made, it works.



---

archive/issue_comments_138346.json:
```json
{
    "body": "Your patches actually undid some of the changes that I made, please fix this. For example, I don't think it is needed to change the script.",
    "created_at": "2013-04-17T13:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138346",
    "user": "https://github.com/jdemeyer"
}
```

Your patches actually undid some of the changes that I made, please fix this. For example, I don't think it is needed to change the script.



---

archive/issue_comments_138347.json:
```json
{
    "body": "Indeed, I did not have the latest version of your script...",
    "created_at": "2013-04-17T13:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138347",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Indeed, I did not have the latest version of your script...



---

archive/issue_comments_138348.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-04-17T14:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138348",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_138349.json:
```json
{
    "body": "Should be fixed now, I'm getting lost on what versions of everything I actually use now.\n\nApart from the suggestion you had not inlcuded yet,\nI only modified the \"fixes\" patch including new cosmetic changes to \"fmpz_poly.pxi\".\nThe v6 is based on the v5 you posted (and that I hopefully got the right version of and did not mess with some versions I crafted earlier).",
    "created_at": "2013-04-17T14:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138349",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Should be fixed now, I'm getting lost on what versions of everything I actually use now.

Apart from the suggestion you had not inlcuded yet,
I only modified the "fixes" patch including new cosmetic changes to "fmpz_poly.pxi".
The v6 is based on the v5 you posted (and that I hopefully got the right version of and did not mess with some versions I crafted earlier).



---

archive/issue_comments_138350.json:
```json
{
    "body": "I also remove a blank line at the top of sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi and break a long line in fmpq_poly.pxd.\nThat should be all.\n\nI did not split long lines in nmod_poly.pxd, there are too many of them and that would not be so useful and the patch would be even less readable, so unless someone really want that we conform strictly to our coding guidelines in that file, I won't do it.",
    "created_at": "2013-04-17T14:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138350",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I also remove a blank line at the top of sage/groups/perm_gps/partn_ref/data_structures_pxd.pxi and break a long line in fmpq_poly.pxd.
That should be all.

I did not split long lines in nmod_poly.pxd, there are too many of them and that would not be so useful and the patch would be even less readable, so unless someone really want that we conform strictly to our coding guidelines in that file, I won't do it.



---

archive/issue_comments_138351.json:
```json
{
    "body": "There is still something wrong, your [attachment:trac_12173-fixes-v6.patch] doesn't actually apply cleanly on top of [attachment:trac_12173-script-v7.patch] (probably because I removed some trailing white space).",
    "created_at": "2013-04-17T15:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138351",
    "user": "https://github.com/jdemeyer"
}
```

There is still something wrong, your [attachment:trac_12173-fixes-v6.patch] doesn't actually apply cleanly on top of [attachment:trac_12173-script-v7.patch] (probably because I removed some trailing white space).



---

archive/issue_comments_138352.json:
```json
{
    "body": "I think I know how to fix the merge conflict, but I give you a chance to fix it first.",
    "created_at": "2013-04-17T15:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138352",
    "user": "https://github.com/jdemeyer"
}
```

I think I know how to fix the merge conflict, but I give you a chance to fix it first.



---

archive/issue_comments_138353.json:
```json
{
    "body": "Attachment [trac_12173-fixes-v6.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v6.patch) by jpflori created at 2013-04-17 15:30:12\n\nI think the patch was not copied onto my USB key.\nThis one should be ok.",
    "created_at": "2013-04-17T15:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138353",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-fixes-v6.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v6.patch) by jpflori created at 2013-04-17 15:30:12

I think the patch was not copied onto my USB key.
This one should be ok.



---

archive/issue_comments_138354.json:
```json
{
    "body": "OK, now let's continue the actual review...",
    "created_at": "2013-04-17T15:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138354",
    "user": "https://github.com/jdemeyer"
}
```

OK, now let's continue the actual review...



---

archive/issue_comments_138355.json:
```json
{
    "body": "jpflori: please confirm that you agree **to not apply** the stuff in [attachment:undo.patch]",
    "created_at": "2013-04-17T15:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138355",
    "user": "https://github.com/jdemeyer"
}
```

jpflori: please confirm that you agree **to not apply** the stuff in [attachment:undo.patch]



---

archive/issue_comments_138356.json:
```json
{
    "body": "Replying to [comment:298 jdemeyer]:\n> jpflori: please confirm that you agree **to not apply** the stuff in [attachment:undo.patch]\nYes, I do.",
    "created_at": "2013-04-17T15:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138356",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:298 jdemeyer]:
> jpflori: please confirm that you agree **to not apply** the stuff in [attachment:undo.patch]
Yes, I do.



---

archive/issue_comments_138357.json:
```json
{
    "body": "Attachment [trac_12173-review.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-review.patch) by @jdemeyer created at 2013-04-18 09:21:46",
    "created_at": "2013-04-18T09:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138357",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_12173-review.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-review.patch) by @jdemeyer created at 2013-04-18 09:21:46



---

archive/issue_comments_138358.json:
```json
{
    "body": "The following is quite strange:\n\n```\nConfiguring FLINT.\nConfiguring...x86_64-Linux\nTesting __builtin_popcountl...yes\nTesting native popcount..../configure : ligne 315 :  8361 Instruction non permise build/test-popcnt > /dev/null 2>&1\nno\nBuilding FLINT shared library.\n```\n\n\nThe configure script *dies*, but the result is still zero, so spkg-install still starts to compile!\n\nNotice that the death of the configure script is present in upstream's 2.3 and today's git checkout, so it's not sage-specific.\n\nI have tried to get more information about it : on x86_64, compiling with -mpopcnt works, but running the resulting test file raises an illegal instruction... which kills the configure script without error (!).\n\nI still haven't reported upstream because I saw the problem while testing the spkg in this report. You'll have to actually look at your spkg/logs/flint-2.3.p0.log to see the problem, because the package compiles perfectly.",
    "created_at": "2013-04-21T08:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138358",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

The following is quite strange:

```
Configuring FLINT.
Configuring...x86_64-Linux
Testing __builtin_popcountl...yes
Testing native popcount..../configure : ligne 315 :  8361 Instruction non permise build/test-popcnt > /dev/null 2>&1
no
Building FLINT shared library.
```


The configure script *dies*, but the result is still zero, so spkg-install still starts to compile!

Notice that the death of the configure script is present in upstream's 2.3 and today's git checkout, so it's not sage-specific.

I have tried to get more information about it : on x86_64, compiling with -mpopcnt works, but running the resulting test file raises an illegal instruction... which kills the configure script without error (!).

I still haven't reported upstream because I saw the problem while testing the spkg in this report. You'll have to actually look at your spkg/logs/flint-2.3.p0.log to see the problem, because the package compiles perfectly.



---

archive/issue_comments_138359.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-04-21T08:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138359",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_138360.json:
```json
{
    "body": "Replying to [comment:300 Snark]:\n> The configure script *dies*\nAre you sure about this? I'm pretty sure it's not the `configure` script which dies, but a subprogram started by `configure` to test popcount. The `test-popcnt` program dies a horrible death and `configure` correctly concludes (note the \"no\") there is no popcount support.",
    "created_at": "2013-04-21T10:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138360",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:300 Snark]:
> The configure script *dies*
Are you sure about this? I'm pretty sure it's not the `configure` script which dies, but a subprogram started by `configure` to test popcount. The `test-popcnt` program dies a horrible death and `configure` correctly concludes (note the "no") there is no popcount support.



---

archive/issue_comments_138361.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-04-21T10:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138361",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_138362.json:
```json
{
    "body": "Replying to [comment:300 Snark]:\n> The following is quite strange:\n> {{{\n> Configuring FLINT.\n> Configuring...x86_64-Linux\n> Testing __builtin_popcountl...yes\n> Testing native popcount..../configure : ligne 315 :  8361 Instruction non permise build/test-popcnt > /dev/null 2>&1\n> no\n> Building FLINT shared library.\n> }}}\n\nWhat does `bash --version` say?",
    "created_at": "2013-04-21T10:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138362",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:300 Snark]:
> The following is quite strange:
> {{{
> Configuring FLINT.
> Configuring...x86_64-Linux
> Testing __builtin_popcountl...yes
> Testing native popcount..../configure : ligne 315 :  8361 Instruction non permise build/test-popcnt > /dev/null 2>&1
> no
> Building FLINT shared library.
> }}}

What does `bash --version` say?



---

archive/issue_comments_138363.json:
```json
{
    "body": "Confirmed with `GNU bash, version 4.2.37(1)-release (x86_64-pc-linux-gnu)`\n\nBut really, the bug is just that\n\n```\n./configure : ligne 315 :  8361 Illegal instruction build/test-popcnt > /dev/null 2>&1\n```\n\nis displayed.\n\nImagine the output simply says\n\n```\nConfiguring FLINT.\nConfiguring...x86_64-Linux\nTesting __builtin_popcountl...yes\nTesting native popcount... no\nBuilding FLINT shared library.\n```\n",
    "created_at": "2013-04-21T10:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138363",
    "user": "https://github.com/jdemeyer"
}
```

Confirmed with `GNU bash, version 4.2.37(1)-release (x86_64-pc-linux-gnu)`

But really, the bug is just that

```
./configure : ligne 315 :  8361 Illegal instruction build/test-popcnt > /dev/null 2>&1
```

is displayed.

Imagine the output simply says

```
Configuring FLINT.
Configuring...x86_64-Linux
Testing __builtin_popcountl...yes
Testing native popcount... no
Building FLINT shared library.
```




---

archive/issue_comments_138364.json:
```json
{
    "body": "Oh, indeed! This is in fact the last test, so it's normal that no more tests are shown. I'll perhaps write and propose a patch to upstream to make the configure script less noisy about this error, and more noisy about the fact that it successfully generated a few files.\n\nI'll just review this ticket from the start now that is settled.",
    "created_at": "2013-04-21T12:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138364",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

Oh, indeed! This is in fact the last test, so it's normal that no more tests are shown. I'll perhaps write and propose a patch to upstream to make the configure script less noisy about this error, and more noisy about the fact that it successfully generated a few files.

I'll just review this ticket from the start now that is settled.



---

archive/issue_comments_138365.json:
```json
{
    "body": "In the doctests-v2 patch, I notice there are comments about \"todo: missing auto normalization\" ; but isn't the chunk about normalizing, in which case the comments should go too?\n\nThe patches don't apply to sage-5.8 ; the description didn't mention I was to use something else than the latest stable version.",
    "created_at": "2013-04-21T13:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138365",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

In the doctests-v2 patch, I notice there are comments about "todo: missing auto normalization" ; but isn't the chunk about normalizing, in which case the comments should go too?

The patches don't apply to sage-5.8 ; the description didn't mention I was to use something else than the latest stable version.



---

archive/issue_comments_138366.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-04-21T13:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138366",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_138367.json:
```json
{
    "body": "Replying to [comment:305 Snark]:\n> The patches don't apply to sage-5.8 ; the description didn't mention I was to use something else than the latest stable version.\n\nWell, the patches' names tell you what they're based on.",
    "created_at": "2013-04-21T14:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138367",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:305 Snark]:
> The patches don't apply to sage-5.8 ; the description didn't mention I was to use something else than the latest stable version.

Well, the patches' names tell you what they're based on.



---

archive/issue_comments_138368.json:
```json
{
    "body": "Replying to [comment:307 leif]:\n> Replying to [comment:305 Snark]:\n> > The patches don't apply to sage-5.8 ; the description didn't mention I was to use something else than the latest stable version.\n> \n> Well, the patches' names tell you what they're based on.\n\nOoops, sorry, they *used to*.",
    "created_at": "2013-04-21T14:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138368",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:307 leif]:
> Replying to [comment:305 Snark]:
> > The patches don't apply to sage-5.8 ; the description didn't mention I was to use something else than the latest stable version.
> 
> Well, the patches' names tell you what they're based on.

Ooops, sorry, they *used to*.



---

archive/issue_comments_138369.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-04-22T14:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138369",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_138370.json:
```json
{
    "body": "I think the auto normalizaiton thing has nothing to do with FLINT, it something with the Sage code used.\n\nThe fact that the output of the doctests slightly changed, is because FLINT now deals with fractions a little differently and is better at normalizing the output (less minus signs), but that's not the same normalization as the one quoted in the comment I think.",
    "created_at": "2013-04-22T14:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138370",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think the auto normalizaiton thing has nothing to do with FLINT, it something with the Sage code used.

The fact that the output of the doctests slightly changed, is because FLINT now deals with fractions a little differently and is better at normalizing the output (less minus signs), but that's not the same normalization as the one quoted in the comment I think.



---

archive/issue_comments_138371.json:
```json
{
    "body": "Unfortunately, there is a problem on OS X 10.4 PPC:\n\n```\nTraceback (most recent call last):\n  File \"./spkg-install\", line 4, in <module>\n    from sage.all import save\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/all.py\", line 81, in <module>\n    from sage.misc.all       import *         # takes a while\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/all.py\", line 87, in <module>\n    from functional import (additive_order,\n  File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 36, in <module>\n    from sage.rings.complex_double import CDF\n  File \"integer.pxd\", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:16711)\nImportError: dlopen(/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so, 2): Symbol not found: _n_factor\n  Referenced from: /Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so\n  Expected in: dynamic lookup\n```\n",
    "created_at": "2013-04-28T10:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138371",
    "user": "https://github.com/jdemeyer"
}
```

Unfortunately, there is a problem on OS X 10.4 PPC:

```
Traceback (most recent call last):
  File "./spkg-install", line 4, in <module>
    from sage.all import save
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/all.py", line 81, in <module>
    from sage.misc.all       import *         # takes a while
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/all.py", line 87, in <module>
    from functional import (additive_order,
  File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/functional.py", line 36, in <module>
    from sage.rings.complex_double import CDF
  File "integer.pxd", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:16711)
ImportError: dlopen(/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so, 2): Symbol not found: _n_factor
  Referenced from: /Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so
  Expected in: dynamic lookup
```




---

archive/issue_comments_138372.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-04-28T10:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138372",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_138373.json:
```json
{
    "body": "Here are some comments after reading attachment:trac_12173-fixes-v6.patch.\n\nI don't understand this hunk:\n\n\n```\ndiff --git a/sage/libs/flint/fmpz_poly.pyx b/sage/libs/flint/fmpz_poly.pyx\n--- a/sage/libs/flint/fmpz_poly.pyx\n+++ b/sage/libs/flint/fmpz_poly.pyx\n@@ -53,7 +53,7 @@\n         cdef long c\n         cdef Integer w\n         if PY_TYPE_CHECK(v, str):\n-            if fmpz_poly_set_str(self.poly, v):\n+            if not fmpz_poly_set_str(self.poly, v):\n                 return\n             else:\n                 raise ValueError, \"Unable to create Fmpz_poly from that string.\"\n```\n\n\n\n`nmod_poly_pow(..., 2)` should be used below instead of `nmod_poly_mul()`.\n\n\n```\ndiff --git a/sage/libs/flint/nmod_poly_linkage.pxi b/sage/libs/flint/nmod_poly_linkage.pxi\n--- a/sage/libs/flint/nmod_poly_linkage.pxi\n+++ b/sage/libs/flint/nmod_poly_linkage.pxi\n@@ -496,7 +495,7 @@\n     elif e == 1:\n         nmod_poly_set(res, x)\n     elif e == 2:\n-        nmod_poly_sqr(res, x)\n+        nmod_poly_mul(res, x, x)\n     else:\n         if res == x:\n             nmod_poly_set(tmp, x)\n@@ -510,7 +509,7 @@\n             nmod_poly_set_coeff_ui(res, 0, 1)\n         e = e >> 1\n         while(e != 0):\n-            nmod_poly_sqr(pow2, pow2)\n+            nmod_poly_mul(pow2, pow2, pow2)\n             if e % 2:\n                 nmod_poly_mul(res, res, pow2)\n             e = e >> 1\n```\n\n\nThis seems to remove the fast exit path:\n\n\n```\ndiff --git a/sage/rings/fraction_field_FpT.pyx b/sage/rings/fraction_field_FpT.pyx\n--- a/sage/rings/fraction_field_FpT.pyx\n+++ b/sage/rings/fraction_field_FpT.pyx\n@@ -688,26 +688,34 @@\n         \"\"\"\n         if nmod_poly_degree(self._numer) == -1:\n             return self\n-        if not nmod_poly_sqrt_check(self._numer) or not nmod_poly_sqrt_check(self._denom):\n-            return None\n```\n\n\nFredrik says that FLINT also does the same checks in `nmod_poly_sqrt()`, but some memory allocations are performed by the time we get to that point. If the input to this function is not a perfect square most of the time, then IMHO removing these checks will introduce a performance regression.\n\nIn the same hunk as above:\n\n\n```\n+            # Make denominator monic\n+            a = nmod_poly_leading(denom)\n+            if a != 1:\n+                a = mod_inverse_int(a, self.p)\n+                nmod_poly_scalar_mul_nmod(numer, numer, a)\n+                nmod_poly_scalar_mul_nmod(denom, denom, a)\n+            # Choose numerator with smaller leading coefficient\n+            a = nmod_poly_leading(numer)\n+            if a > self.p - a:\n+                nmod_poly_neg(numer, numer)\n```\n\n\nIs this necessary? If the input is normalized, the denominator will have 1 as a leading coefficient anyway. If we really want to normalize, the `normalize()` method in the same file should be used.\n\n\n`_nmod_poly_set_coeff_ui()` was removed from FLINT2. Removing the underscore introduces a potential branch for each function call. Shall we implement our own underscore version?\n\n\n```\ndiff --git a/sage/rings/polynomial/polynomial_zmod_flint.pyx b/sage/rings/polynomial/polynomial_zmod_flint.pyx\n--- a/sage/rings/polynomial/polynomial_zmod_flint.pyx\n+++ b/sage/rings/polynomial/polynomial_zmod_flint.pyx\n@@ -157,17 +170,47 @@\n<snip>\n+        sig_on()\n         for i from 0 <= i < length:\n-            _nmod_poly_set_coeff_ui(&self.x, i, l_in[i])\n-        # we need to set the length manually, we used _nmod_poly_set_coeff_ui\n-        self.x.length = length\n+            nmod_poly_set_coeff_ui(&self.x, i, l_in[i])\n+        sig_off()\n+        return 0\n```\n",
    "created_at": "2013-05-05T16:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138373",
    "user": "https://github.com/burcin"
}
```

Here are some comments after reading attachment:trac_12173-fixes-v6.patch.

I don't understand this hunk:


```
diff --git a/sage/libs/flint/fmpz_poly.pyx b/sage/libs/flint/fmpz_poly.pyx
--- a/sage/libs/flint/fmpz_poly.pyx
+++ b/sage/libs/flint/fmpz_poly.pyx
@@ -53,7 +53,7 @@
         cdef long c
         cdef Integer w
         if PY_TYPE_CHECK(v, str):
-            if fmpz_poly_set_str(self.poly, v):
+            if not fmpz_poly_set_str(self.poly, v):
                 return
             else:
                 raise ValueError, "Unable to create Fmpz_poly from that string."
```



`nmod_poly_pow(..., 2)` should be used below instead of `nmod_poly_mul()`.


```
diff --git a/sage/libs/flint/nmod_poly_linkage.pxi b/sage/libs/flint/nmod_poly_linkage.pxi
--- a/sage/libs/flint/nmod_poly_linkage.pxi
+++ b/sage/libs/flint/nmod_poly_linkage.pxi
@@ -496,7 +495,7 @@
     elif e == 1:
         nmod_poly_set(res, x)
     elif e == 2:
-        nmod_poly_sqr(res, x)
+        nmod_poly_mul(res, x, x)
     else:
         if res == x:
             nmod_poly_set(tmp, x)
@@ -510,7 +509,7 @@
             nmod_poly_set_coeff_ui(res, 0, 1)
         e = e >> 1
         while(e != 0):
-            nmod_poly_sqr(pow2, pow2)
+            nmod_poly_mul(pow2, pow2, pow2)
             if e % 2:
                 nmod_poly_mul(res, res, pow2)
             e = e >> 1
```


This seems to remove the fast exit path:


```
diff --git a/sage/rings/fraction_field_FpT.pyx b/sage/rings/fraction_field_FpT.pyx
--- a/sage/rings/fraction_field_FpT.pyx
+++ b/sage/rings/fraction_field_FpT.pyx
@@ -688,26 +688,34 @@
         """
         if nmod_poly_degree(self._numer) == -1:
             return self
-        if not nmod_poly_sqrt_check(self._numer) or not nmod_poly_sqrt_check(self._denom):
-            return None
```


Fredrik says that FLINT also does the same checks in `nmod_poly_sqrt()`, but some memory allocations are performed by the time we get to that point. If the input to this function is not a perfect square most of the time, then IMHO removing these checks will introduce a performance regression.

In the same hunk as above:


```
+            # Make denominator monic
+            a = nmod_poly_leading(denom)
+            if a != 1:
+                a = mod_inverse_int(a, self.p)
+                nmod_poly_scalar_mul_nmod(numer, numer, a)
+                nmod_poly_scalar_mul_nmod(denom, denom, a)
+            # Choose numerator with smaller leading coefficient
+            a = nmod_poly_leading(numer)
+            if a > self.p - a:
+                nmod_poly_neg(numer, numer)
```


Is this necessary? If the input is normalized, the denominator will have 1 as a leading coefficient anyway. If we really want to normalize, the `normalize()` method in the same file should be used.


`_nmod_poly_set_coeff_ui()` was removed from FLINT2. Removing the underscore introduces a potential branch for each function call. Shall we implement our own underscore version?


```
diff --git a/sage/rings/polynomial/polynomial_zmod_flint.pyx b/sage/rings/polynomial/polynomial_zmod_flint.pyx
--- a/sage/rings/polynomial/polynomial_zmod_flint.pyx
+++ b/sage/rings/polynomial/polynomial_zmod_flint.pyx
@@ -157,17 +170,47 @@
<snip>
+        sig_on()
         for i from 0 <= i < length:
-            _nmod_poly_set_coeff_ui(&self.x, i, l_in[i])
-        # we need to set the length manually, we used _nmod_poly_set_coeff_ui
-        self.x.length = length
+            nmod_poly_set_coeff_ui(&self.x, i, l_in[i])
+        sig_off()
+        return 0
```




---

archive/issue_comments_138374.json:
```json
{
    "body": "Replying to [comment:311 burcin]:\n> Here are some comments after reading attachment:trac_12173-fixes-v6.patch.\n> \n> I don't understand this hunk:\n> \n> {{{\n> diff --git a/sage/libs/flint/fmpz_poly.pyx b/sage/libs/flint/fmpz_poly.pyx\n> --- a/sage/libs/flint/fmpz_poly.pyx\n> +++ b/sage/libs/flint/fmpz_poly.pyx\n> `@``@` -53,7 +53,7 `@``@`\n>          cdef long c\n>          cdef Integer w\n>          if PY_TYPE_CHECK(v, str):\n> -            if fmpz_poly_set_str(self.poly, v):\n> +            if not fmpz_poly_set_str(self.poly, v):\n>                  return\n>              else:\n>                  raise ValueError, \"Unable to create Fmpz_poly from that string.\"\n> }}}\nIndeed, this looks wrong.\nThis also shows this function does not seem to be well tested.\n> \n> \n> `nmod_poly_pow(..., 2)` should be used below instead of `nmod_poly_mul()`.\n> \n> {{{\n> diff --git a/sage/libs/flint/nmod_poly_linkage.pxi b/sage/libs/flint/nmod_poly_linkage.pxi\n> --- a/sage/libs/flint/nmod_poly_linkage.pxi\n> +++ b/sage/libs/flint/nmod_poly_linkage.pxi\n> `@``@` -496,7 +495,7 `@``@`\n>      elif e == 1:\n>          nmod_poly_set(res, x)\n>      elif e == 2:\n> -        nmod_poly_sqr(res, x)\n> +        nmod_poly_mul(res, x, x)\n>      else:\n>          if res == x:\n>              nmod_poly_set(tmp, x)\n> `@``@` -510,7 +509,7 `@``@`\n>              nmod_poly_set_coeff_ui(res, 0, 1)\n>          e = e >> 1\n>          while(e != 0):\n> -            nmod_poly_sqr(pow2, pow2)\n> +            nmod_poly_mul(pow2, pow2, pow2)\n>              if e % 2:\n>                  nmod_poly_mul(res, res, pow2)\n>              e = e >> 1\n> }}}\nsure, but I wouldn't say that's a critical issue.\n> \n> This seems to remove the fast exit path:\n> \n> {{{\n> diff --git a/sage/rings/fraction_field_FpT.pyx b/sage/rings/fraction_field_FpT.pyx\n> --- a/sage/rings/fraction_field_FpT.pyx\n> +++ b/sage/rings/fraction_field_FpT.pyx\n> `@``@` -688,26 +688,34 `@``@`\n>          \"\"\"\n>          if nmod_poly_degree(self._numer) == -1:\n>              return self\n> -        if not nmod_poly_sqrt_check(self._numer) or not nmod_poly_sqrt_check(self._denom):\n> -            return None\n> }}}\n> \n> Fredrik says that FLINT also does the same checks in `nmod_poly_sqrt()`, but some memory allocations are performed by the time we get to that point. If the input to this function is not a perfect square most of the time, then IMHO removing these checks will introduce a performance regression.\nI think the best place for such a function would be in FLINT itself.\nThe problem is that if we plan on integrating this ticket without calling this to be implemented function (I'd prefer to go this way, let's not wait for another couple of monthes/years to merge this ticket), we should make sure to not forget to call it from Sage when it actually gets implemented in (a stable release of) FLINT, so we should surely open a follow-up ticket.\n> \n> In the same hunk as above:\n> \n> {{{\n> +            # Make denominator monic\n> +            a = nmod_poly_leading(denom)\n> +            if a != 1:\n> +                a = mod_inverse_int(a, self.p)\n> +                nmod_poly_scalar_mul_nmod(numer, numer, a)\n> +                nmod_poly_scalar_mul_nmod(denom, denom, a)\n> +            # Choose numerator with smaller leading coefficient\n> +            a = nmod_poly_leading(numer)\n> +            if a > self.p - a:\n> +                nmod_poly_neg(numer, numer)\n> }}}\n> \n> Is this necessary? If the input is normalized, the denominator will have 1 as a leading coefficient anyway. If we really want to normalize, the `normalize()` method in the same file should be used.\nSure, I'll have  alook at the code.\n> \n> \n> `_nmod_poly_set_coeff_ui()` was removed from FLINT2. Removing the underscore introduces a potential branch for each function call. Shall we implement our own underscore version?\n> \nI'd say no, if that's useful, it should be in FLINT.\n> {{{\n> diff --git a/sage/rings/polynomial/polynomial_zmod_flint.pyx b/sage/rings/polynomial/polynomial_zmod_flint.pyx\n> --- a/sage/rings/polynomial/polynomial_zmod_flint.pyx\n> +++ b/sage/rings/polynomial/polynomial_zmod_flint.pyx\n> `@``@` -157,17 +170,47 `@``@`\n> <snip>\n> +        sig_on()\n>          for i from 0 <= i < length:\n> -            _nmod_poly_set_coeff_ui(&self.x, i, l_in[i])\n> -        # we need to set the length manually, we used _nmod_poly_set_coeff_ui\n> -        self.x.length = length\n> +            nmod_poly_set_coeff_ui(&self.x, i, l_in[i])\n> +        sig_off()\n> +        return 0\n> }}}",
    "created_at": "2013-05-06T11:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138374",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:311 burcin]:
> Here are some comments after reading attachment:trac_12173-fixes-v6.patch.
> 
> I don't understand this hunk:
> 
> {{{
> diff --git a/sage/libs/flint/fmpz_poly.pyx b/sage/libs/flint/fmpz_poly.pyx
> --- a/sage/libs/flint/fmpz_poly.pyx
> +++ b/sage/libs/flint/fmpz_poly.pyx
> `@``@` -53,7 +53,7 `@``@`
>          cdef long c
>          cdef Integer w
>          if PY_TYPE_CHECK(v, str):
> -            if fmpz_poly_set_str(self.poly, v):
> +            if not fmpz_poly_set_str(self.poly, v):
>                  return
>              else:
>                  raise ValueError, "Unable to create Fmpz_poly from that string."
> }}}
Indeed, this looks wrong.
This also shows this function does not seem to be well tested.
> 
> 
> `nmod_poly_pow(..., 2)` should be used below instead of `nmod_poly_mul()`.
> 
> {{{
> diff --git a/sage/libs/flint/nmod_poly_linkage.pxi b/sage/libs/flint/nmod_poly_linkage.pxi
> --- a/sage/libs/flint/nmod_poly_linkage.pxi
> +++ b/sage/libs/flint/nmod_poly_linkage.pxi
> `@``@` -496,7 +495,7 `@``@`
>      elif e == 1:
>          nmod_poly_set(res, x)
>      elif e == 2:
> -        nmod_poly_sqr(res, x)
> +        nmod_poly_mul(res, x, x)
>      else:
>          if res == x:
>              nmod_poly_set(tmp, x)
> `@``@` -510,7 +509,7 `@``@`
>              nmod_poly_set_coeff_ui(res, 0, 1)
>          e = e >> 1
>          while(e != 0):
> -            nmod_poly_sqr(pow2, pow2)
> +            nmod_poly_mul(pow2, pow2, pow2)
>              if e % 2:
>                  nmod_poly_mul(res, res, pow2)
>              e = e >> 1
> }}}
sure, but I wouldn't say that's a critical issue.
> 
> This seems to remove the fast exit path:
> 
> {{{
> diff --git a/sage/rings/fraction_field_FpT.pyx b/sage/rings/fraction_field_FpT.pyx
> --- a/sage/rings/fraction_field_FpT.pyx
> +++ b/sage/rings/fraction_field_FpT.pyx
> `@``@` -688,26 +688,34 `@``@`
>          """
>          if nmod_poly_degree(self._numer) == -1:
>              return self
> -        if not nmod_poly_sqrt_check(self._numer) or not nmod_poly_sqrt_check(self._denom):
> -            return None
> }}}
> 
> Fredrik says that FLINT also does the same checks in `nmod_poly_sqrt()`, but some memory allocations are performed by the time we get to that point. If the input to this function is not a perfect square most of the time, then IMHO removing these checks will introduce a performance regression.
I think the best place for such a function would be in FLINT itself.
The problem is that if we plan on integrating this ticket without calling this to be implemented function (I'd prefer to go this way, let's not wait for another couple of monthes/years to merge this ticket), we should make sure to not forget to call it from Sage when it actually gets implemented in (a stable release of) FLINT, so we should surely open a follow-up ticket.
> 
> In the same hunk as above:
> 
> {{{
> +            # Make denominator monic
> +            a = nmod_poly_leading(denom)
> +            if a != 1:
> +                a = mod_inverse_int(a, self.p)
> +                nmod_poly_scalar_mul_nmod(numer, numer, a)
> +                nmod_poly_scalar_mul_nmod(denom, denom, a)
> +            # Choose numerator with smaller leading coefficient
> +            a = nmod_poly_leading(numer)
> +            if a > self.p - a:
> +                nmod_poly_neg(numer, numer)
> }}}
> 
> Is this necessary? If the input is normalized, the denominator will have 1 as a leading coefficient anyway. If we really want to normalize, the `normalize()` method in the same file should be used.
Sure, I'll have  alook at the code.
> 
> 
> `_nmod_poly_set_coeff_ui()` was removed from FLINT2. Removing the underscore introduces a potential branch for each function call. Shall we implement our own underscore version?
> 
I'd say no, if that's useful, it should be in FLINT.
> {{{
> diff --git a/sage/rings/polynomial/polynomial_zmod_flint.pyx b/sage/rings/polynomial/polynomial_zmod_flint.pyx
> --- a/sage/rings/polynomial/polynomial_zmod_flint.pyx
> +++ b/sage/rings/polynomial/polynomial_zmod_flint.pyx
> `@``@` -157,17 +170,47 `@``@`
> <snip>
> +        sig_on()
>          for i from 0 <= i < length:
> -            _nmod_poly_set_coeff_ui(&self.x, i, l_in[i])
> -        # we need to set the length manually, we used _nmod_poly_set_coeff_ui
> -        self.x.length = length
> +            nmod_poly_set_coeff_ui(&self.x, i, l_in[i])
> +        sig_off()
> +        return 0
> }}}



---

archive/issue_comments_138375.json:
```json
{
    "body": "Replying to [comment:310 jdemeyer]:\n> Unfortunately, there is a problem on OS X 10.4 PPC:\n> {{{\n> Traceback (most recent call last):\n>   File \"./spkg-install\", line 4, in <module>\n>     from sage.all import save\n>   File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/all.py\", line 81, in <module>\n>     from sage.misc.all       import *         # takes a while\n>   File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/all.py\", line 87, in <module>\n>     from functional import (additive_order,\n>   File \"/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 36, in <module>\n>     from sage.rings.complex_double import CDF\n>   File \"integer.pxd\", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:16711)\n> ImportError: dlopen(/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so, 2): Symbol not found: _n_factor\n>   Referenced from: /Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so\n>   Expected in: dynamic lookup\n> }}}\nAny chance to get the FLINt build log? (and to know what file it produced? libflint.dylib i presume.)\nAnd some \"otool -L\" output on integer.so?\n(By the way is it expected that the cython produced file end in .so and not in .dylib on Mac OS?)",
    "created_at": "2013-05-06T12:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138375",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:310 jdemeyer]:
> Unfortunately, there is a problem on OS X 10.4 PPC:
> {{{
> Traceback (most recent call last):
>   File "./spkg-install", line 4, in <module>
>     from sage.all import save
>   File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/all.py", line 81, in <module>
>     from sage.misc.all       import *         # takes a while
>   File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/all.py", line 87, in <module>
>     from functional import (additive_order,
>   File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/misc/functional.py", line 36, in <module>
>     from sage.rings.complex_double import CDF
>   File "integer.pxd", line 9, in init sage.rings.complex_double (sage/rings/complex_double.c:16711)
> ImportError: dlopen(/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so, 2): Symbol not found: _n_factor
>   Referenced from: /Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/rings/integer.so
>   Expected in: dynamic lookup
> }}}
Any chance to get the FLINt build log? (and to know what file it produced? libflint.dylib i presume.)
And some "otool -L" output on integer.so?
(By the way is it expected that the cython produced file end in .so and not in .dylib on Mac OS?)



---

archive/issue_comments_138376.json:
```json
{
    "body": "I think i found one build log at http://build.sagemath.org/sage/builders/UGent%20moufang%20%28OSX%2010.4%20ppc32%29/builds/197/steps/shell_6/logs/flint\n\nAnd it seems something is broken in FLINT configuration:\n\n```\ngcc -fPIC -O2 -g -ansi -pedantic -Wall   -m64 -mcpu=970 -mtune=970 -mpowerpc64 -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16 -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/spkg/build/flint-2.3.p0/src -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/local/include -c clz_tab.c -o build/clz_tab.lo;\n```\n\ndoes not look that good on a ppc32 (which I assume to be 32 bits) computer.",
    "created_at": "2013-05-06T13:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138376",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think i found one build log at http://build.sagemath.org/sage/builders/UGent%20moufang%20%28OSX%2010.4%20ppc32%29/builds/197/steps/shell_6/logs/flint

And it seems something is broken in FLINT configuration:

```
gcc -fPIC -O2 -g -ansi -pedantic -Wall   -m64 -mcpu=970 -mtune=970 -mpowerpc64 -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16 -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/spkg/build/flint-2.3.p0/src -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta0/local/include -c clz_tab.c -o build/clz_tab.lo;
```

does not look that good on a ppc32 (which I assume to be 32 bits) computer.



---

archive/issue_comments_138377.json:
```json
{
    "body": "And the problematic lines are:\n\n```\n   elif [ \"$KERNEL\" = \"Darwin\" -a \"$ARCH\" = \"ppc\" ]; then\n      FLINT_TUNE=\" -funroll-loops\"\n   elif [ \"`uname -p`\" = \"powerpc\" ]; then\n      FLINT_TUNE=\"-m64 -mcpu=970 -mtune=970 -mpowerpc64 -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16\"\n```\n\nin FLINT configure.\nOf course I don't remember for which kind of cpus the uname -p stuff was put in FLINT 1.",
    "created_at": "2013-05-06T13:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138377",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

And the problematic lines are:

```
   elif [ "$KERNEL" = "Darwin" -a "$ARCH" = "ppc" ]; then
      FLINT_TUNE=" -funroll-loops"
   elif [ "`uname -p`" = "powerpc" ]; then
      FLINT_TUNE="-m64 -mcpu=970 -mtune=970 -mpowerpc64 -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16"
```

in FLINT configure.
Of course I don't remember for which kind of cpus the uname -p stuff was put in FLINT 1.



---

archive/issue_comments_138378.json:
```json
{
    "body": "Hum, its not from FLINT 1, but was added in FLINT 2 to catch PowerG5 cpus I guess.\nThe problem is likely to be that Sage builds 32 bits by default on OS X 10.4 (and 10.5) (see http://www.sagemath.org/doc/installation/source.html and the stuff about SAGE64), but FLINT 2 wants to be too smart and forces the build of a 64 bits library (because it has detected the cpu has such capabilities).",
    "created_at": "2013-05-06T13:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138378",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Hum, its not from FLINT 1, but was added in FLINT 2 to catch PowerG5 cpus I guess.
The problem is likely to be that Sage builds 32 bits by default on OS X 10.4 (and 10.5) (see http://www.sagemath.org/doc/installation/source.html and the stuff about SAGE64), but FLINT 2 wants to be too smart and forces the build of a 64 bits library (because it has detected the cpu has such capabilities).



---

archive/issue_comments_138379.json:
```json
{
    "body": "Replying to [comment:312 jpflori]:\n> The problem is that if we plan on integrating this ticket without calling this to be implemented function (I'd prefer to go this way, let's not wait for another couple of monthes/years to merge this ticket), we should make sure to not forget to call it from Sage when it actually gets implemented in (a stable release of) FLINT, so we should surely open a follow-up ticket.\n\nI suggest we revert these hunks and put the code for `nmod_poly_sqrt_check()` back. I wasn't trying to suggest that we implement these in FLINT and wait for the next release. I'd really like to get this ticket resolved by the end of the week.",
    "created_at": "2013-05-06T13:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138379",
    "user": "https://github.com/burcin"
}
```

Replying to [comment:312 jpflori]:
> The problem is that if we plan on integrating this ticket without calling this to be implemented function (I'd prefer to go this way, let's not wait for another couple of monthes/years to merge this ticket), we should make sure to not forget to call it from Sage when it actually gets implemented in (a stable release of) FLINT, so we should surely open a follow-up ticket.

I suggest we revert these hunks and put the code for `nmod_poly_sqrt_check()` back. I wasn't trying to suggest that we implement these in FLINT and wait for the next release. I'd really like to get this ticket resolved by the end of the week.



---

archive/issue_comments_138380.json:
```json
{
    "body": "Replying to [comment:316 jpflori]:\n> FLINT 2 wants to be too smart\nFor certain values of \"smart\" I guess. Rolling your own `configure` system is almost certainly a bad idea. One should never just add `-m32` or `-m64` to the `CFLAGS`. I would also avoid adding the `-mtune` and `-mcpu` options.",
    "created_at": "2013-05-06T13:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138380",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:316 jpflori]:
> FLINT 2 wants to be too smart
For certain values of "smart" I guess. Rolling your own `configure` system is almost certainly a bad idea. One should never just add `-m32` or `-m64` to the `CFLAGS`. I would also avoid adding the `-mtune` and `-mcpu` options.



---

archive/issue_comments_138381.json:
```json
{
    "body": "Replying to [comment:317 burcin]:\n> Replying to [comment:312 jpflori]:\n> > The problem is that if we plan on integrating this ticket without calling this to be implemented function (I'd prefer to go this way, let's not wait for another couple of monthes/years to merge this ticket), we should make sure to not forget to call it from Sage when it actually gets implemented in (a stable release of) FLINT, so we should surely open a follow-up ticket.\n> \n> I suggest we revert these hunks and put the code for `nmod_poly_sqrt_check()` back. I \n> wasn't trying to suggest that we implement these in FLINT and wait for the next release. \nThe function used to be three lines of calls to FLINT C functions, so it should be trivial to add to FLINT 2 (although refactoring the nmod_poly_sqrt function so that it uses the _check function in a proper way could need (a little) more thoughts).\nTherefore, what I'd prefer to do is to push something on github and let Bill pull it to FLINT's trunk.\nAnd we should then use this backported patch in our spkg.\nSo when this gets into a stable version of FLINT, we'll only have to update the spkg and delete the patch.\nSame feeling for the underscore set_ui method.\n>I'd really like to get this ticket resolved by the end of the week.\nSame here!",
    "created_at": "2013-05-06T13:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138381",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:317 burcin]:
> Replying to [comment:312 jpflori]:
> > The problem is that if we plan on integrating this ticket without calling this to be implemented function (I'd prefer to go this way, let's not wait for another couple of monthes/years to merge this ticket), we should make sure to not forget to call it from Sage when it actually gets implemented in (a stable release of) FLINT, so we should surely open a follow-up ticket.
> 
> I suggest we revert these hunks and put the code for `nmod_poly_sqrt_check()` back. I 
> wasn't trying to suggest that we implement these in FLINT and wait for the next release. 
The function used to be three lines of calls to FLINT C functions, so it should be trivial to add to FLINT 2 (although refactoring the nmod_poly_sqrt function so that it uses the _check function in a proper way could need (a little) more thoughts).
Therefore, what I'd prefer to do is to push something on github and let Bill pull it to FLINT's trunk.
And we should then use this backported patch in our spkg.
So when this gets into a stable version of FLINT, we'll only have to update the spkg and delete the patch.
Same feeling for the underscore set_ui method.
>I'd really like to get this ticket resolved by the end of the week.
Same here!



---

archive/issue_comments_138382.json:
```json
{
    "body": "Replying to [comment:318 jdemeyer]:\n> Replying to [comment:316 jpflori]:\n> > FLINT 2 wants to be too smart\n> For certain values of \"smart\" I guess. Rolling your own `configure` system is almost certainly a bad idea. One should never just add `-m32` or `-m64` to the `CFLAGS`. I would also avoid adding the `-mtune` and `-mcpu` options.\nI agree, the compiler should be smart enough to decide what to compile by default, and the user should take the responsibility to pass such options.",
    "created_at": "2013-05-06T14:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138382",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:318 jdemeyer]:
> Replying to [comment:316 jpflori]:
> > FLINT 2 wants to be too smart
> For certain values of "smart" I guess. Rolling your own `configure` system is almost certainly a bad idea. One should never just add `-m32` or `-m64` to the `CFLAGS`. I would also avoid adding the `-mtune` and `-mcpu` options.
I agree, the compiler should be smart enough to decide what to compile by default, and the user should take the responsibility to pass such options.



---

archive/issue_comments_138383.json:
```json
{
    "body": "Fix for PowerPC G5",
    "created_at": "2013-05-06T15:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138383",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Fix for PowerPC G5



---

archive/issue_comments_138384.json:
```json
{
    "body": "Attachment [trac_12173-ffixes.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-ffixes.patch) by jpflori created at 2013-05-07 09:25:09\n\nFurther fixes",
    "created_at": "2013-05-07T09:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138384",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-ffixes.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-ffixes.patch) by jpflori created at 2013-05-07 09:25:09

Further fixes



---

archive/issue_comments_138385.json:
```json
{
    "body": "Attachment [powerpcg5.diff](tarball://root/attachments/some-uuid/ticket12173/powerpcg5.diff) by jpflori created at 2013-05-07 09:27:55\n\nPowerPC G5 spkg diff, review only.",
    "created_at": "2013-05-07T09:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138385",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [powerpcg5.diff](tarball://root/attachments/some-uuid/ticket12173/powerpcg5.diff) by jpflori created at 2013-05-07 09:27:55

PowerPC G5 spkg diff, review only.



---

archive/issue_comments_138386.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-05-07T09:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138386",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138387.json:
```json
{
    "body": "Ok, here comes a new patch to apply taking Burcin's review into account.\n\nThe spkg at the previous address has been updated to include the fix for PowerPC G5.\nIt's being discussed upstream and should get in at some point.\n\nI'm starting a \"make ptestlong\" right now on top of 5.10.beta1 (already tested some files directly related to FLINT).",
    "created_at": "2013-05-07T09:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138387",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ok, here comes a new patch to apply taking Burcin's review into account.

The spkg at the previous address has been updated to include the fix for PowerPC G5.
It's being discussed upstream and should get in at some point.

I'm starting a "make ptestlong" right now on top of 5.10.beta1 (already tested some files directly related to FLINT).



---

archive/issue_comments_138388.json:
```json
{
    "body": "By the way, the doctests in fmpz_poly.pyx are formatted in an ugly way.",
    "created_at": "2013-05-07T09:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138388",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

By the way, the doctests in fmpz_poly.pyx are formatted in an ugly way.



---

archive/issue_comments_138389.json:
```json
{
    "body": "Ill be updating the script to clean up that file and merge patch which should be (i.e fixes + review + ffixes) when I've built a clean Sage 5.10.beta1.",
    "created_at": "2013-05-07T09:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138389",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Ill be updating the script to clean up that file and merge patch which should be (i.e fixes + review + ffixes) when I've built a clean Sage 5.10.beta1.



---

archive/issue_comments_138390.json:
```json
{
    "body": "Update script to cleanup fmpz_poly.pyx",
    "created_at": "2013-05-07T11:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138390",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Update script to cleanup fmpz_poly.pyx



---

archive/issue_comments_138391.json:
```json
{
    "body": "Attachment [trac_12173-script-v8.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-script-v8.patch) by jpflori created at 2013-05-07 11:23:20",
    "created_at": "2013-05-07T11:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138391",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-script-v8.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-script-v8.patch) by jpflori created at 2013-05-07 11:23:20



---

archive/issue_comments_138392.json:
```json
{
    "body": "Attachment [trac_12173-fixes-v7.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v7.patch) by jpflori created at 2013-05-07 11:23:41\n\nMerged fixes",
    "created_at": "2013-05-07T11:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138392",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12173-fixes-v7.patch](tarball://root/attachments/some-uuid/ticket12173/trac_12173-fixes-v7.patch) by jpflori created at 2013-05-07 11:23:41

Merged fixes



---

archive/issue_comments_138393.json:
```json
{
    "body": "I've updated the patch, please check tat I've not messed up everything.\nApart from that, I think what really needs to be done is to check that the spkg works fine on PowerPC G5 OS X 10.4.",
    "created_at": "2013-05-07T11:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138393",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I've updated the patch, please check tat I've not messed up everything.
Apart from that, I think what really needs to be done is to check that the spkg works fine on PowerPC G5 OS X 10.4.



---

archive/issue_comments_138394.json:
```json
{
    "body": "For `powerpc`, why not remove the whole\n\n```\nelif [ \"`uname -p`\" = \"powerpc\" ]; then\n    FLINT_TUNE=\"-falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16\"\n```\n\nblock?",
    "created_at": "2013-05-07T12:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138394",
    "user": "https://github.com/jdemeyer"
}
```

For `powerpc`, why not remove the whole

```
elif [ "`uname -p`" = "powerpc" ]; then
    FLINT_TUNE="-falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16"
```

block?



---

archive/issue_comments_138395.json:
```json
{
    "body": "Replying to [comment:325 jdemeyer]:\n> For `powerpc`, why not remove the whole\n> {{{\n> elif [ \"`uname -p`\" = \"powerpc\" ]; then\n>     FLINT_TUNE=\"-falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16\"\n> }}}\n> block?\nI'd say to perform minimal modification.\nI don't really care.\nIn fact I'd prefer that FLINT gets its flags from gmp/mpfr if CFLAGS is empty and does not do anything if not.",
    "created_at": "2013-05-07T12:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138395",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:325 jdemeyer]:
> For `powerpc`, why not remove the whole
> {{{
> elif [ "`uname -p`" = "powerpc" ]; then
>     FLINT_TUNE="-falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16"
> }}}
> block?
I'd say to perform minimal modification.
I don't really care.
In fact I'd prefer that FLINT gets its flags from gmp/mpfr if CFLAGS is empty and does not do anything if not.



---

archive/issue_comments_138396.json:
```json
{
    "body": "Looks good to me.\n\nMany thanks for the great work.",
    "created_at": "2013-05-07T15:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138396",
    "user": "https://github.com/burcin"
}
```

Looks good to me.

Many thanks for the great work.



---

archive/issue_comments_138397.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-07T15:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138397",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_138398.json:
```json
{
    "body": "It doesn't actually build on OS X 10.4 PPC G5:\n\n```\ng++ -fPIC -O2 -g -ansi -pedantic -Wall   -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16 -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/spkg/build/flint-2.3.p0/src -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/local/include -c interfaces/NTL-interface.cpp -o build/interfaces/NTL-interface.lo;\n/usr/bin/ld: common symbols not allowed with MH_DYLIB output format with the -multi_module option\nbuild/fmpz.lo definition of common _fmpz_arr (size 4)\nbuild/profiler.lo definition of common _clock_accum (size 160)\nbuild/profiler.lo definition of common _clock_last (size 160)\nbuild/ulong_extras.lo definition of common _flint_num_primes_mutex (size 44)\nbuild/ulong_extras.lo definition of common _flint_prime_inverses (size 4)\nbuild/ulong_extras.lo definition of common _flint_primes (size 4)\nbuild/ulong_extras.lo definition of common _sieve (size 4)\nbuild/fmpz.lo definition of common _fmpz_unused_arr (size 4)\ncollect2: error: ld returned 1 exit status\nmake[4]: *** [libflint.dylib] Error 1\nmake[3]: *** [library] Error 2\nmake[3]: Target `all' not remade because of errors.\nError: Failed to build FLINT shared library.\n```\n\n\nI can try a few variations of the flags to see if that helps.",
    "created_at": "2013-05-08T07:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138398",
    "user": "https://github.com/jdemeyer"
}
```

It doesn't actually build on OS X 10.4 PPC G5:

```
g++ -fPIC -O2 -g -ansi -pedantic -Wall   -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16 -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/spkg/build/flint-2.3.p0/src -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/local/include -I/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.10.beta2/local/include -c interfaces/NTL-interface.cpp -o build/interfaces/NTL-interface.lo;
/usr/bin/ld: common symbols not allowed with MH_DYLIB output format with the -multi_module option
build/fmpz.lo definition of common _fmpz_arr (size 4)
build/profiler.lo definition of common _clock_accum (size 160)
build/profiler.lo definition of common _clock_last (size 160)
build/ulong_extras.lo definition of common _flint_num_primes_mutex (size 44)
build/ulong_extras.lo definition of common _flint_prime_inverses (size 4)
build/ulong_extras.lo definition of common _flint_primes (size 4)
build/ulong_extras.lo definition of common _sieve (size 4)
build/fmpz.lo definition of common _fmpz_unused_arr (size 4)
collect2: error: ld returned 1 exit status
make[4]: *** [libflint.dylib] Error 1
make[3]: *** [library] Error 2
make[3]: Target `all' not remade because of errors.
Error: Failed to build FLINT shared library.
```


I can try a few variations of the flags to see if that helps.



---

archive/issue_comments_138399.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-05-08T07:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138399",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_138400.json:
```json
{
    "body": "Needs to pass \"-fno-common\" on darwin. [http://gcc.gnu.org/ml/gcc/2005-06/msg00375.html](http://gcc.gnu.org/ml/gcc/2005-06/msg00375.html) and follow up is interesting on that subject.",
    "created_at": "2013-05-08T10:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138400",
    "user": "https://github.com/kiwifb"
}
```

Needs to pass "-fno-common" on darwin. [http://gcc.gnu.org/ml/gcc/2005-06/msg00375.html](http://gcc.gnu.org/ml/gcc/2005-06/msg00375.html) and follow up is interesting on that subject.



---

archive/issue_comments_138401.json:
```json
{
    "body": "OK, I am making and testing a new spkg. Please leave yours alone in order to avoid duplicate work.",
    "created_at": "2013-05-08T10:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138401",
    "user": "https://github.com/jdemeyer"
}
```

OK, I am making and testing a new spkg. Please leave yours alone in order to avoid duplicate work.



---

archive/issue_comments_138402.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-05-08T10:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138402",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138403.json:
```json
{
    "body": "Diff flint-2.3 -> flint-2.3.p1",
    "created_at": "2013-05-08T10:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138403",
    "user": "https://github.com/jdemeyer"
}
```

Diff flint-2.3 -> flint-2.3.p1



---

archive/issue_comments_138404.json:
```json
{
    "body": "Attachment [flint-2.3.p1.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p1.diff) by @jdemeyer created at 2013-05-08 10:19:59",
    "created_at": "2013-05-08T10:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138404",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [flint-2.3.p1.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.p1.diff) by @jdemeyer created at 2013-05-08 10:19:59



---

archive/issue_comments_138405.json:
```json
{
    "body": "Spkg diff, for review only.",
    "created_at": "2013-05-08T10:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138405",
    "user": "https://github.com/jdemeyer"
}
```

Spkg diff, for review only.



---

archive/issue_comments_138406.json:
```json
{
    "body": "Attachment [flint-2.3.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.diff) by @jdemeyer created at 2013-05-08 10:24:18\n\nThe new spkg with `-fno-common` at least builds on OS X 10.4 PPC G5. I'll need some more time to actually completely test it.",
    "created_at": "2013-05-08T10:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138406",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [flint-2.3.diff](tarball://root/attachments/some-uuid/ticket12173/flint-2.3.diff) by @jdemeyer created at 2013-05-08 10:24:18

The new spkg with `-fno-common` at least builds on OS X 10.4 PPC G5. I'll need some more time to actually completely test it.



---

archive/issue_comments_138407.json:
```json
{
    "body": "FLINT's testsuite (`./sage -i -c`) passes on OS X 10.4 PPC G5.",
    "created_at": "2013-05-08T11:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138407",
    "user": "https://github.com/jdemeyer"
}
```

FLINT's testsuite (`./sage -i -c`) passes on OS X 10.4 PPC G5.



---

archive/issue_comments_138408.json:
```json
{
    "body": "Jeroen, could you please test te spkg on the PPC G5 with FLINT_TUNE=\"-fno-common -funroll-loops\"?\nIf that works fine, I guess we should just go with that upstream rather than the \"*=16\" thing.",
    "created_at": "2013-05-09T10:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138408",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Jeroen, could you please test te spkg on the PPC G5 with FLINT_TUNE="-fno-common -funroll-loops"?
If that works fine, I guess we should just go with that upstream rather than the "*=16" thing.



---

archive/issue_comments_138409.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-09T13:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138409",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_138410.json:
```json
{
    "body": "Anyway, I'm ok with Jeroen changes to the spkg/patches, so I'm putting this back to positive_review.",
    "created_at": "2013-05-09T13:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138410",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Anyway, I'm ok with Jeroen changes to the spkg/patches, so I'm putting this back to positive_review.



---

archive/issue_comments_138411.json:
```json
{
    "body": "FYI, some patches similar to what Jeroen did have been integrated upstream and should be in the next release (and the other patch about dylib64 as well).",
    "created_at": "2013-05-10T10:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138411",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

FYI, some patches similar to what Jeroen did have been integrated upstream and should be in the next release (and the other patch about dylib64 as well).



---

archive/issue_comments_138412.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-13T13:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138412",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_138413.json:
```json
{
    "body": "It would probably be better to keep a symlink `$SAGE_LOCAL/include/FLINT -> flint` for a while...  which would also have avoided [comment:ticket:14600:4 this].",
    "created_at": "2013-05-17T00:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138413",
    "user": "https://github.com/nexttime"
}
```

It would probably be better to keep a symlink `$SAGE_LOCAL/include/FLINT -> flint` for a while...  which would also have avoided [comment:ticket:14600:4 this].



---

archive/issue_comments_138414.json:
```json
{
    "body": "The FLINT include directory issue (`FLINT` vs. `flint`) is now #14603.",
    "created_at": "2013-05-17T11:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12001#issuecomment-138414",
    "user": "https://github.com/nexttime"
}
```

The FLINT include directory issue (`FLINT` vs. `flint`) is now #14603.
