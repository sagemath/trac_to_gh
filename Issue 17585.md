# Issue 17585: faster matrix integer dense

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-02-21 16:17:00

We now have a flint implementation of dense integer matrices. The branch proposes various optimization in `matrix.matrix_integer_dense` to make it faster.


---

Comment by vdelecroix created at 2015-02-21 16:21:51

New commits:


---

Comment by vdelecroix created at 2015-02-21 16:21:51

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-02-21 16:24:11

new timings:

```
sage: M = MatrixSpace(ZZ,3)
sage: m = M([1,2,3,4,5,6,1,2,-3])
sage: %timeit m*m
1000000 loops, best of 3: 1.13 µs per loop
sage: %timeit m**3
100000 loops, best of 3: 2.04 µs per loop
sage: %timeit m**100
100000 loops, best of 3: 7.71 µs per loop
sage: %timeit m**-100
1000 loops, best of 3: 377 µs per loop
sage: %timeit ~m
10000 loops, best of 3: 37 µs per loop
sage: M1 = MatrixSpace(ZZ,4,2)
sage: m1 = M1(range(8))
sage: M2 = MatrixSpace(ZZ,3,4)
sage: m2 = M2(range(12))
sage: %timeit m2*m1
100000 loops, best of 3: 4.8 µs per loop
```


same operations on sage-6.6.beta0:

```
sage: M = MatrixSpace(ZZ,3)
sage: m = M([1,2,3,4,5,6,1,2,-3])
sage: %timeit m*m
100000 loops, best of 3: 4.72 µs per loop
sage: %timeit m**3
100000 loops, best of 3: 10.2 µs per loop
sage: %timeit m**100
10000 loops, best of 3: 45.8 µs per loop
sage: %timeit m**-100
1000 loops, best of 3: 462 µs per loop
sage: %timeit ~m
1000 loops, best of 3: 138 µs per loop
sage: M1 = MatrixSpace(ZZ,4,2)
sage: m1 = M1(range(8))
sage: M2 = MatrixSpace(ZZ,3,4)
sage: m2 = M2(range(12))
sage: %timeit m2*m1
100000 loops, best of 3: 10.7 µs per loop
```



---

Comment by jdemeyer created at 2015-02-21 17:49:47

Instead of `mpz_cmp_ui((<Integer>n).value, ULONG_MAX) < 1:`, why not use `mpz_fits_ui` which is *exactly* made for that purpose?


---

Comment by git created at 2015-02-21 18:39:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-21 18:40:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-02-21 20:47:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-23 09:19:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-23 14:11:43

Why did you _move_ `__copy__`? It's harder to review that way.

Please remove

```
cdef object P
```

since it serves no purpose.


---

Comment by git created at 2015-02-23 14:15:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-02-23 14:16:01

Replying to [comment:9 jdemeyer]:
> Why did you _move_ `__copy__`? It's harder to review that way.

`__copy__` is referenced in the list of LEVEL 2 functionalities. So I first implement it there and then I discover that it was already in the begining of the file.

> Please remove
> {{{
> cdef object P
> }}}
> since it serves no purpose.

right.


---

Comment by jdemeyer created at 2015-02-23 14:21:21

Replying to [comment:11 vdelecroix]:
> `__copy__` is referenced in the list of LEVEL 2 functionalities.
What does this "LEVEL 2 functionalities" mean anyway?


---

Comment by vdelecroix created at 2015-02-23 14:22:35

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 vdelecroix]:
> > `__copy__` is referenced in the list of LEVEL 2 functionalities.
> What does this "LEVEL 2 functionalities" mean anyway?

It refers to the crazy organization of the matrix code inside `matrix0.pyx`, `matrix1.pyx` and `matrix2.pyx`.


---

Comment by jdemeyer created at 2015-02-24 09:43:29

Reviewer patch needs review.
----
New commits:


---

Comment by vdelecroix created at 2015-02-24 09:52:41

What is this Cython syntax for?

```
cdef Matrix_integer_dense self = <Matrix_integer_dense?>sself
```



---

Comment by jdemeyer created at 2015-02-24 09:58:26

It's a cast with _check_. In particular, it disallows `sself = None`.


---

Comment by vdelecroix created at 2015-02-24 09:59:20

Replying to [comment:16 vdelecroix]:
> What is this Cython syntax for?
> {{{
> cdef Matrix_integer_dense self = <Matrix_integer_dense?>sself
> }}}

just found out "cast type checked".


---

Comment by vdelecroix created at 2015-02-24 10:02:17

Replying to [comment:17 jdemeyer]:
> It's a cast with _check_. In particular, it disallows `sself = None`.

`sself` can be `None` here!?


---

Comment by jdemeyer created at 2015-02-24 10:06:25

If you do `None^M` with `M` an integer matrix, then yes.


---

Comment by vdelecroix created at 2015-02-24 10:17:46

Thanks for the improvements! (And if you have time, there is the follow up #17824)


---

Comment by vdelecroix created at 2015-02-24 10:17:46

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-02-24 13:08:37

Replying to [comment:21 vdelecroix]:
> And if you have time, there is the follow up #17824
Not before this one is merged (I rely on the web trac diff view for reviewing which is only reliable if all dependencies have been merged).


---

Comment by vbraun created at 2015-02-25 22:34:17

Resolution: fixed
