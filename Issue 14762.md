# Issue 14762: subgraph_search does not like labeled edges

Issue created by migration from https://trac.sagemath.org/ticket/14999

Original creator: azi

Original creation time: 2013-08-05 10:23:52

CC:  rbeezer ncohen dcoudert

It appears that subgraph_search does not return the edge set of the searched graph in case we label the edges.


```
sage: G = graphs.CompleteGraph(10)               
sage: C = G.subgraph_search(graphs.CycleGraph(4))
sage: C.size()     
4
sage: C.edges()
[(0, 1, None), (0, 3, None), (1, 2, None), (2, 3, None)]
```


But after labeling the edges


```
sage: for (u,v) in G.edges(labels=False):^J    G.set_edge_label(u,v, u | v)
....: 
sage: C = G.subgraph_search(graphs.CycleGraph(4))                          
sage: C.size()                                                             
0
sage: C.edges()                                                            
[]
```



---

Comment by ncohen created at 2013-08-05 10:28:05

Hmmmmmmmmm... Subgraph search as it is does NOT support labeled edges in the sense that the edge labels of the small graph are assumed to be unlabelled. And the copy of the small graph found in the large graph has nothing to do with the labels of edges in the large graph. Just saying `:-P`

It should probably return an exception when the small graph's edges are labelled. Just to be clear `:-P`

But of course, what you say makes sense. For as long as you do not expect Sage's result to change if you add many multiple edges between two adjacent vertices in the big graph. This would be a mess `:-P`

Nathann


---

Comment by iconjack created at 2016-08-19 02:13:07

Set assignee to iconjack.


---

Comment by @Rithesh17 created at 2019-03-03 08:38:02

New commits:


---

Comment by @Rithesh17 created at 2019-03-03 08:38:02

Changing status from new to needs_review.


---

Comment by dcoudert created at 2019-03-03 16:05:45

Welcome to Sagemath !

If I understand well, you propose to raise an error whenever the the graph has a label on a vertex or an edge.
Wouldn't it be better to ignore labels in the subgraph search ?


Various comments:

- I would prefer `check_vertices` instead of `check_in_vertices`. Similarly, `check_edges`.

- I method `has_labels`, you must add an `INPUT:` block. See http://doc.sagemath.org/html/en/developer/coding_basics.html

- The following form might be better

```diff
-        if check_in_vertices:
-            for v in self.vertices():
-                if self.get_vertex(v) != None:
-                    return True
+        if check_in_vertices:
+            if any(self.get_vertex(v) is not None for v in self):
+                return True
```

- We can avoid building a potentially very long list of None.

```diff
-            if self.edge_labels() != [None]*(len(self.edges())):
-                return True
+            if any(l is not None for _,_,l in self.edge_iterator()):
+                return True
```

 Note that instead of `len(self.edges())`, it's much better/faster to use `self.size()`


- your patch adds trailing white spaces that we try to avoid. For instance:

```diff
-
+            
```

 or

```diff
+        flag is set to True. 
```


- comments must be formatted in 80 columns mode

- `Checks if the graph has labels.` -> `Check if the graph has labels.`

- `atleast` -> `at least`

- you must put the doctests reporting errors to a correct form

```diff
-            sage: g.subgraph_search(graphs.CycleGraph(3))
-            ---------------------------------------------------------------------------
-            ValueError                                Traceback (most recent call last)
-            ...
-            ValueError: Graph must be unlabelled
+            sage: g.subgraph_search(graphs.CycleGraph(3))
+            Traceback (most recent call last)
+            ...
+            ValueError: Graph must be unlabelled
```


- this seems better

```diff
-        If vertex labels or edge labels are found, it returns a ValuesError.
+        If vertex labels or edge labels are found, an error is raised.
```


- remove useless space

```diff
-        For labelled edges (:trac: `14999`)::
+        For labelled edges (:trac:`14999`)::
```



---

Comment by dcoudert created at 2019-03-03 16:05:45

Changing status from needs_review to needs_work.


---

Comment by @Rithesh17 created at 2019-03-03 19:55:11

Thank you for the review.

To ignore the labels in the parent graph, the SubgraphSearch class does not give any option to ignore the labels. So we either need to set all the labels back to None, or create a new graph from the existing one but without the labels.

Please comment on which of the two methods is preferable. Or if there is a more efficient way to do this.


---

Comment by dcoudert created at 2019-03-05 12:22:25

You should investigate more where the problem comes from.

For instance, in `.subgraph_search(...)`, to ensure that we ignore the labels of the edges of `G`, you can do:

```diff
-                return self.subgraph(vertices=Gcopy, edges=Gcopy.edges(sort=False))
+                return self.subgraph(vertices=Gcopy, edges=Gcopy.edges(labels=False, sort=False))
```

To understand that, check methods `.subgraph`, `._subgraph_by_deleting` and `._subgraph_by_adding`.

This is not enough to solve the issue, but at least, we get:

```
sage: G = graphs.CompleteGraph(10)
sage: for u,v in G.edge_iterator(labels=False):
....:     G.set_edge_label(u, v, u)
sage: C4 = graphs.CycleGraph(4)
sage: G._subgraph_by_adding(vertices=C4, edges=C4.edges()).edges()
[]
sage: G._subgraph_by_adding(vertices=C4, edges=C4.edges(labels=False)).edges()
[(0, 1, 0), (0, 3, 0), (1, 2, 1), (2, 3, 2)]
sage: G._subgraph_by_deleting(vertices=C4, edges=C4.edges(labels=False)).edges()
[(0, 1, 0), (0, 3, 0), (1, 2, 1), (2, 3, 2)]
```


Note also that inside `SubgraphSearch`, the search is done without considering vertex or edge labels, and that the graph returned by `.subgraph_search` has the correct 4 vertices but no edges...


---

Comment by @Rithesh17 created at 2019-03-05 14:57:18

I almost did not notice that the `.subgraph` function had an option already to disable labels. I will use it to solve the problem in `.subgraph_search` function.

As to the `._subgraph_by_adding` function, the edges are considered in this way:

```
for u, v, l in self.edge_iterator(vertices):
    if (v in vertices and ((u, v, l) in edges_to_keep_labeled
                          or (u, v) in edges_to_keep_unlabeled)):
        edges_to_keep.append((u, v, l))
```


I think if we just consider `self.edge_iterator(vertices, labels=False)` and only `(u, v) in edges_to_keep_labeled` instead of `self.edge_iterator(vertices)` we can deal with the issue. The same holds true in the case of `._subgraph_by_deleting`

I would like to commit this to the branch only after this comment is reviewed.


---

Comment by dcoudert created at 2019-03-06 08:04:29

What you propose will break other parts of the code. `.subgraph` is used in various places so you can not change it just like that.
Are you sure we are loosing edges in that precise loops ?


---

Comment by @Rithesh17 created at 2019-03-06 10:59:27

All the other applications of `._subgraph_by_adding` has neglected the labelling of the vertices and edges.

I have verified that the loss of the edges in `._subgraph_by_adding` is happening in that loop. And that if I apply the proposed changes it works just fine.


---

Comment by dcoudert created at 2019-03-06 11:55:44

Have you tried the change I proposed in #comment:10 ?


---

Comment by @Rithesh17 created at 2019-03-06 16:08:03

That will work. By setting `labels=False` in the `.subgraph` function call the `.subgraph_search` method ignores the labels.


```
sage: G = graphs.CompleteGraph(10)
sage: for u,v in G.edge_iterator(labels=False): G.set_edge_label(u, v, u)
sage: C4 = graphs.CycleGraph(4)
sage: C = G.subgraph_search(C4)
sage: C.edges()
[(0, 1, 0), (0, 3, 0), (1, 2, 1), (2, 3, 2)]
```


Can I stick on to that as the solution?


---

Comment by dcoudert created at 2019-03-06 16:30:03

Yes. At least it's better than the current situation. And, it's a much easier solution than your previous proposal :P

Then you can try different graphs with labels to check if it's OK. I don't think that vertex labels are taken into account here. Check that to.


---

Comment by @Rithesh17 created at 2019-03-06 16:45:55

The solution is working for a few variations that I can think of.

And the vertex labels are ignored, as `Gcopy` in `return self.subgraph(vertices=Gcopy, edges=Gcopy.edges(labels=False, sort=False))` returns the vertices without their labels.

Extending the previous example,

```
sage: G.set_vertex(0, 'foo')
sage: C = G.subgraph_search(C4)
sage: C.get_vertices()
{0: 'foo', 1: None, 2: None, 3: None}
```



---

Comment by dcoudert created at 2019-03-06 16:59:11

good.


---

Comment by git created at 2019-03-06 17:13:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-06 17:15:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-03-07 07:55:25

Can you clean this branch, keeping only what is necessary to fix the issue. For instance, we don't need to keep method `has_labels`. Also, I disagree with the removal of the `.. NOTE::` blocks which are important information for users.

May be you should restart from a new clean branch.


---

Comment by @Rithesh17 created at 2019-03-07 15:34:04

New commits:


---

Comment by @Rithesh17 created at 2019-03-07 15:34:04

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2019-03-08 16:27:14

Some comments.


```diff
-            sage: for (u,v) in G.edges(labels=False): G.set_edge_label(u, v, u)
-
+            sage: for (u,v) in G.edges(labels=False):
+            ....:     G.set_edge_label(u, v, u)
```


This example might not be well chosen (result is 0, so are labels considered or not ??). May be you could take the same example you added in `subgraph_search_iterator`.

```diff
+        If the graph has vertex labels or edge labels, the label is just ignored::
+
+            sage: g.set_vertex(0, 'foo')
+            sage: g.subgraph_search_count(graphs.CycleGraph(3))
+            0
+}}}


---

Comment by git created at 2019-03-08 17:55:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-08 17:56:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-03-09 17:48:16

Looks good to me.


---

Comment by dcoudert created at 2019-03-09 17:51:24

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2019-03-09 17:51:24

Looks good to me.


---

Comment by chapoton created at 2019-03-10 06:52:57

reviewer name please


---

Comment by vbraun created at 2019-03-11 22:42:11

Resolution: fixed
