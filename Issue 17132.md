# Issue 17132: sphinx-build is broken

archive/issues_017132.json:
```json
{
    "body": "The script `$SAGE_LOCAL/bin/sphinx-build` (which is copied over from `build/pkgs/sphinx/patches/sphinx-build`) is broken since it refers to the wrong version.\n\nThe Sage documentation build no longer uses the `sphinx-build` script, so this wasn't noticed immediately. Manually calling this script gives\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/src/sage-git/local/bin/sphinx-build\", line 5, in <module>\n    from pkg_resources import load_entry_point\n  File \"build/bdist.linux-x86_64/egg/pkg_resources.py\", line 2817, in <module>\n  File \"build/bdist.linux-x86_64/egg/pkg_resources.py\", line 451, in _build_master\n  File \"build/bdist.linux-x86_64/egg/pkg_resources.py\", line 464, in _build_from_requirements\n  File \"build/bdist.linux-x86_64/egg/pkg_resources.py\", line 639, in resolve\npkg_resources.DistributionNotFound: Sphinx==1.1.2\nmake: *** [html] Error 1\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17369\n\n",
    "created_at": "2014-11-19T15:57:37Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "sphinx-build is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17132",
    "user": "https://github.com/jdemeyer"
}
```
The script `$SAGE_LOCAL/bin/sphinx-build` (which is copied over from `build/pkgs/sphinx/patches/sphinx-build`) is broken since it refers to the wrong version.

The Sage documentation build no longer uses the `sphinx-build` script, so this wasn't noticed immediately. Manually calling this script gives

```
Traceback (most recent call last):
  File "/usr/local/src/sage-git/local/bin/sphinx-build", line 5, in <module>
    from pkg_resources import load_entry_point
  File "build/bdist.linux-x86_64/egg/pkg_resources.py", line 2817, in <module>
  File "build/bdist.linux-x86_64/egg/pkg_resources.py", line 451, in _build_master
  File "build/bdist.linux-x86_64/egg/pkg_resources.py", line 464, in _build_from_requirements
  File "build/bdist.linux-x86_64/egg/pkg_resources.py", line 639, in resolve
pkg_resources.DistributionNotFound: Sphinx==1.1.2
make: *** [html] Error 1
```


Issue created by migration from https://trac.sagemath.org/ticket/17369





---

archive/issue_comments_227493.json:
```json
{
    "body": "I guess this could be fixed by \n\n```diff\ndiff --git a/build/pkgs/sphinx/patches/sphinx-build b/build/pkgs/sphinx/patches/sphinx-build\nindex a20792f..46e7a1d 100755\n--- a/build/pkgs/sphinx/patches/sphinx-build\n+++ b/build/pkgs/sphinx/patches/sphinx-build\n@@ -1,9 +1,9 @@\n #!/usr/bin/env python\n-# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.1.2','console_scripts','sphinx-build'\n+# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.2.2','console_scripts','sphinx-build'\n __requires__ = 'Sphinx==1.1.2'\n import sys\n from pkg_resources import load_entry_point\n import sage.all\n sys.exit(\n-   load_entry_point('Sphinx==1.1.2', 'console_scripts', 'sphinx-build')()\n+   load_entry_point('Sphinx==1.2.2', 'console_scripts', 'sphinx-build')()\n )\n```\n",
    "created_at": "2014-11-19T16:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227493",
    "user": "https://github.com/kcrisman"
}
```

I guess this could be fixed by 

```diff
diff --git a/build/pkgs/sphinx/patches/sphinx-build b/build/pkgs/sphinx/patches/sphinx-build
index a20792f..46e7a1d 100755
--- a/build/pkgs/sphinx/patches/sphinx-build
+++ b/build/pkgs/sphinx/patches/sphinx-build
@@ -1,9 +1,9 @@
 #!/usr/bin/env python
-# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.1.2','console_scripts','sphinx-build'
+# EASY-INSTALL-ENTRY-SCRIPT: 'Sphinx==1.2.2','console_scripts','sphinx-build'
 __requires__ = 'Sphinx==1.1.2'
 import sys
 from pkg_resources import load_entry_point
 import sage.all
 sys.exit(
-   load_entry_point('Sphinx==1.1.2', 'console_scripts', 'sphinx-build')()
+   load_entry_point('Sphinx==1.2.2', 'console_scripts', 'sphinx-build')()
 )
```




---

archive/issue_comments_227494.json:
```json
{
    "body": "Is there any way to doctest this, or possibly at least fix SPKG.txt to say so?\n\nHaha!  It's ALREADY THERE!!!\n\n```\n * Make sure to update the Sphinx version number in the file\n   patches/sphinx-build.\n```\n\nSigh.",
    "created_at": "2014-11-19T16:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227494",
    "user": "https://github.com/kcrisman"
}
```

Is there any way to doctest this, or possibly at least fix SPKG.txt to say so?

Haha!  It's ALREADY THERE!!!

```
 * Make sure to update the Sphinx version number in the file
   patches/sphinx-build.
```

Sigh.



---

archive/issue_comments_227495.json:
```json
{
    "body": "Or maybe the script could be modified to grab the number in `build/pkgs/sphinx/package-version.txt` automatically, before being copied?  That would be more future-proof.",
    "created_at": "2014-11-19T16:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227495",
    "user": "https://github.com/kcrisman"
}
```

Or maybe the script could be modified to grab the number in `build/pkgs/sphinx/package-version.txt` automatically, before being copied?  That would be more future-proof.



---

archive/issue_comments_227496.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-11-19T16:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227496",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_227497.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-11-19T16:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227497",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_227498.json:
```json
{
    "body": "??  But how will a brand-new Sage install now get sphinx-build?  Is it part of `setup.py install` somehow?",
    "created_at": "2014-11-19T16:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227498",
    "user": "https://github.com/kcrisman"
}
```

??  But how will a brand-new Sage install now get sphinx-build?  Is it part of `setup.py install` somehow?



---

archive/issue_comments_227499.json:
```json
{
    "body": "Replying to [comment:6 kcrisman]:\n> But how will a brand-new Sage install now get sphinx-build?  Is it part of `setup.py install` somehow?\nYes indeed!",
    "created_at": "2014-11-19T16:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227499",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 kcrisman]:
> But how will a brand-new Sage install now get sphinx-build?  Is it part of `setup.py install` somehow?
Yes indeed!



---

archive/issue_comments_227500.json:
```json
{
    "body": "Huh.\n\nBut the salient features are rather different.\n\n```\nimport sys \nfrom pkg_resources import load_entry_point \nimport sage.all \n```\n\nWill being in `sage -sh` be enough for that?  As opposed to\n\n```\nfrom sphinx import main\nimport sys\n```\n\nwhich is the probable effect of [sphinx-build](https://bitbucket.org/birkenfeld/sphinx/src/9d4bb376c69e485516629171cb2d78f0fe4fc397/sphinx-build.py?at=default)?  There must have been a reason to have the custom version of the script.",
    "created_at": "2014-11-19T16:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227500",
    "user": "https://github.com/kcrisman"
}
```

Huh.

But the salient features are rather different.

```
import sys 
from pkg_resources import load_entry_point 
import sage.all 
```

Will being in `sage -sh` be enough for that?  As opposed to

```
from sphinx import main
import sys
```

which is the probable effect of [sphinx-build](https://bitbucket.org/birkenfeld/sphinx/src/9d4bb376c69e485516629171cb2d78f0fe4fc397/sphinx-build.py?at=default)?  There must have been a reason to have the custom version of the script.



---

archive/issue_comments_227501.json:
```json
{
    "body": "For the record, the patching of `sphinx-build` was introduced in #4737, which has very little info...",
    "created_at": "2014-11-19T17:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227501",
    "user": "https://github.com/jdemeyer"
}
```

For the record, the patching of `sphinx-build` was introduced in #4737, which has very little info...



---

archive/issue_comments_227502.json:
```json
{
    "body": "Replying to [comment:8 kcrisman]:\n> There must have been a reason to have the custom version of the script.\nI have no idea really. But for #17265 I tested this ticket: `sphinx-build` seems to work without the `import sage.all`...",
    "created_at": "2014-11-19T17:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227502",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 kcrisman]:
> There must have been a reason to have the custom version of the script.
I have no idea really. But for #17265 I tested this ticket: `sphinx-build` seems to work without the `import sage.all`...



---

archive/issue_comments_227503.json:
```json
{
    "body": "I was just about to ask you that question.  Otherwise the script `setup.py` creates is indeed identical to the one here.",
    "created_at": "2014-11-19T17:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227503",
    "user": "https://github.com/kcrisman"
}
```

I was just about to ask you that question.  Otherwise the script `setup.py` creates is indeed identical to the one here.



---

archive/issue_comments_227504.json:
```json
{
    "body": "And I can confirm what you say about #17265.  Huh.",
    "created_at": "2014-11-19T17:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227504",
    "user": "https://github.com/kcrisman"
}
```

And I can confirm what you say about #17265.  Huh.



---

archive/issue_comments_227505.json:
```json
{
    "body": "Can you think of anything else `sphinx-build` would be used for now?  I do know that while building the documentation now, if a given module doesn't exist in Sage (say, some stale files from switching branches) that it complains that it can't find the module and one has to delete the generated .rst by hand.  (That is probably a bug that those aren't destroyed after having been auto-generated and then the original file is gone, by the way, but not for this ticket.)  So perhaps at some point this functionality is necessary, even if this script is no longer used for building the Sage doc per se.  Why does Sphinx have to know that the module exists to build the whole documentation?\n\nIf we can resolve that, otherwise this is fine and has a couple other good cleanups.",
    "created_at": "2014-11-19T17:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227505",
    "user": "https://github.com/kcrisman"
}
```

Can you think of anything else `sphinx-build` would be used for now?  I do know that while building the documentation now, if a given module doesn't exist in Sage (say, some stale files from switching branches) that it complains that it can't find the module and one has to delete the generated .rst by hand.  (That is probably a bug that those aren't destroyed after having been auto-generated and then the original file is gone, by the way, but not for this ticket.)  So perhaps at some point this functionality is necessary, even if this script is no longer used for building the Sage doc per se.  Why does Sphinx have to know that the module exists to build the whole documentation?

If we can resolve that, otherwise this is fine and has a couple other good cleanups.



---

archive/issue_comments_227506.json:
```json
{
    "body": "Replying to [comment:13 kcrisman]:\n> I do know that while building the documentation now, if a given module doesn't exist in Sage (say, some stale files from switching branches) that it complains that it can't find the module and one has to delete the generated .rst by hand.\nWhat makes you think that this has to do with the `sphinx-build` script?",
    "created_at": "2014-11-19T19:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227506",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 kcrisman]:
> I do know that while building the documentation now, if a given module doesn't exist in Sage (say, some stale files from switching branches) that it complains that it can't find the module and one has to delete the generated .rst by hand.
What makes you think that this has to do with the `sphinx-build` script?



---

archive/issue_comments_227507.json:
```json
{
    "body": "> > I do know that while building the documentation now, if a given module doesn't exist in Sage (say, some stale files from switching branches) that it complains that it can't find the module and one has to delete the generated .rst by hand.\n> What makes you think that this has to do with the `sphinx-build` script?\nI *don't* think it has to do with that, or at least I believe you when you say it doesn't (above).  But it *does* mean that, at least at certain times, Sphinx wants to try to import Sage modules when it builds the documentation, and blows up if it can't.  So I'm wondering whether there might be times when that type of behavior, via `sphinx-build`, would affect whatever remaining uses of `sphinx-build` there are.  Perhaps there is no such behavior, but I'm trying to brainstorm.",
    "created_at": "2014-11-19T19:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227507",
    "user": "https://github.com/kcrisman"
}
```

> > I do know that while building the documentation now, if a given module doesn't exist in Sage (say, some stale files from switching branches) that it complains that it can't find the module and one has to delete the generated .rst by hand.
> What makes you think that this has to do with the `sphinx-build` script?
I *don't* think it has to do with that, or at least I believe you when you say it doesn't (above).  But it *does* mean that, at least at certain times, Sphinx wants to try to import Sage modules when it builds the documentation, and blows up if it can't.  So I'm wondering whether there might be times when that type of behavior, via `sphinx-build`, would affect whatever remaining uses of `sphinx-build` there are.  Perhaps there is no such behavior, but I'm trying to brainstorm.



---

archive/issue_comments_227508.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-19T20:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227508",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_227509.json:
```json
{
    "body": "Okay, here is our `src/doc/common/custom-sphinx-build.py`\n\n```\n\n\"\"\"\nThis is Sage's version of the sphinx-build script\n\nEnhancements are:\n\n* import the Sage library to access the docstrings, otherwise doc\n  buliding doesn't work.\n\n* redirect stdout to our own logger, and remove some unwanted chatter.\n\"\"\"\n```\n\nAlthough this is actually now in `builder.py`, and in any case the magic place this is needed is there too - \n\n```\n    def get_module_docstring_title(self, module_name):\n        \"\"\"\n        Returns the title of the module from its docstring.\n        \"\"\"\n        #Try to import the module\n        try:\n            __import__(module_name)\n        except ImportError as err:\n            logger.error(\"Warning: Could not import %s %s\", module_name, err)\n            return \"UNABLE TO IMPORT MODULE\"\n```\n\n\nSo as long as we aren't trying to auto-generate stuff with [autodoc](http://sphinx-doc.org/ext/autodoc.html) in these we should be cool.",
    "created_at": "2014-11-19T20:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227509",
    "user": "https://github.com/kcrisman"
}
```

Okay, here is our `src/doc/common/custom-sphinx-build.py`

```

"""
This is Sage's version of the sphinx-build script

Enhancements are:

* import the Sage library to access the docstrings, otherwise doc
  buliding doesn't work.

* redirect stdout to our own logger, and remove some unwanted chatter.
"""
```

Although this is actually now in `builder.py`, and in any case the magic place this is needed is there too - 

```
    def get_module_docstring_title(self, module_name):
        """
        Returns the title of the module from its docstring.
        """
        #Try to import the module
        try:
            __import__(module_name)
        except ImportError as err:
            logger.error("Warning: Could not import %s %s", module_name, err)
            return "UNABLE TO IMPORT MODULE"
```


So as long as we aren't trying to auto-generate stuff with [autodoc](http://sphinx-doc.org/ext/autodoc.html) in these we should be cool.



---

archive/issue_comments_227510.json:
```json
{
    "body": "For what it's worth, this also seems to work with `sage --docbuild file=... html`. I can't think of any reasons why we would need to import sage.all in this file.",
    "created_at": "2014-11-19T20:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227510",
    "user": "https://github.com/jhpalmieri"
}
```

For what it's worth, this also seems to work with `sage --docbuild file=... html`. I can't think of any reasons why we would need to import sage.all in this file.



---

archive/issue_comments_227511.json:
```json
{
    "body": "?  I think the point is that the `sphinx-build` which is in the `patches` directory of sphinx is no longer needed because we don't need to import sage.all any more for that, since it's not the one used to build Sage doc.  The version in `src/doc/common` refers to it, but actually the import is in `builder.py`, and there it is indeed necessary so that autodoc can do its stuff - or if not, maybe to raise an error earlier?\n\nAnyway, if the files in `src/doc/common` can be modified, let's make that a different ticket.",
    "created_at": "2014-11-19T20:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227511",
    "user": "https://github.com/kcrisman"
}
```

?  I think the point is that the `sphinx-build` which is in the `patches` directory of sphinx is no longer needed because we don't need to import sage.all any more for that, since it's not the one used to build Sage doc.  The version in `src/doc/common` refers to it, but actually the import is in `builder.py`, and there it is indeed necessary so that autodoc can do its stuff - or if not, maybe to raise an error earlier?

Anyway, if the files in `src/doc/common` can be modified, let's make that a different ticket.



---

archive/issue_comments_227512.json:
```json
{
    "body": "I didn't mean to delete you as a reviewer. Sorry about that.\n\nI meant that the changes in this ticket look good to me: there is no need to import `sage.all` in the `sphinx-build` script (that's what I meant by \"this file\"), so we should go back to using the standard version of that script.",
    "created_at": "2014-11-19T21:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227512",
    "user": "https://github.com/jhpalmieri"
}
```

I didn't mean to delete you as a reviewer. Sorry about that.

I meant that the changes in this ticket look good to me: there is no need to import `sage.all` in the `sphinx-build` script (that's what I meant by "this file"), so we should go back to using the standard version of that script.



---

archive/issue_events_016556.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-11-20T16:35:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17132#event-16556"
}
```



---

archive/issue_comments_227513.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-20T16:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17132#issuecomment-227513",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
