# Issue 25813: zn_poly breaks Cygwin64 build

Issue created by migration from https://trac.sagemath.org/ticket/26050

Original creator: @darijgr

Original creation time: 2018-08-12 14:19:17

CC:  embray tscrim

Keywords: zn_poly, build, ld, gcc

sage 8.4beta0 fails to compile on my cygwin, even after a distclean, because "ld: cannot find -lzn_poly". This happens at the sagelib compilation stage (zn_poly itself seems to have installed correctly; at least sage doesn't let me install it again):


```
[sagelib-8.4.beta0] [  1/184] gcc -I/usr/include/ncurses -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -I./sage/libs/ntl -I/home/skraeling/sage/local/lib/python2.7/site-packages/cypari2 -I/home/skraeling/sage/local/include -I/home/skraeling/sage/local/include/python2.7 -I/home/skraeling/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/skraeling/sage/src -I/home/skraeling/sage/src/sage/ext -Ibuild/cythonized -I/home/skraeling/sage/local/include/python2.7 -c build/cythonized/sage/modular/pollack_stevens/dist.c -o build/temp.cygwin-2.10.0-x86_64-2.7/build/cythonized/sage/modular/pollack_stevens/dist.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -D_XPG6 -std=gnu99
[sagelib-8.4.beta0] gcc -shared -Wl,--enable-auto-image-base -L/home/skraeling/sage/local/lib -Wl,-rpath,/home/skraeling/sage/local/lib -L/home/skraeling/sage/local/lib -Wl,-rpath,/home/skraeling/sage/local/lib build/temp.cygwin-2.10.0-x86_64-2.7/build/cythonized/sage/modular/pollack_stevens/dist.o -L/home/skraeling/sage/local/lib -L/home/skraeling/sage/local/lib/python2.7/config -L/home/skraeling/sage/local/lib -lflint -lgmp -lzn_poly -lpython2.7 -o build/lib.cygwin-2.10.0-x86_64-2.7/sage/modular/pollack_stevens/dist.dll
[sagelib-8.4.beta0] /usr/lib/gcc/x86_64-pc-cygwin/7.3.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lzn_poly
```


Reverting #25085 fixes the bug on my machine.


---

Comment by embray created at 2018-08-13 11:56:55

Set assignee to embray.


---

Comment by embray created at 2018-08-13 11:56:55

Thanks, I'll look into it.  I think I see what the problem might be.

I didn't have any problems with this, but it looks like I still have an old `libzn_poly-0.9.so` hanging out in my `$SAGE_LOCAL/lib`.  That _should_ have been cleaned away but it wasn't--it appears the zn_poly package doesn't do anything to clean up old versions.  So building from scratch would still fail.


---

Comment by embray created at 2018-09-06 12:19:51

Changing priority from major to blocker.


---

Comment by embray created at 2018-09-06 13:35:49

New commits:


---

Comment by embray created at 2018-09-06 13:35:49

Changing status from new to needs_review.


---

Comment by embray created at 2018-09-07 13:17:18

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-09-07 13:17:18

There is still a problem, which is that since the build outputs the libzn_poly DLL as `libzn_poly-0.9.so`, that is also set to its DLL name in the binary; simply renaming the file to `cygzn_poly.dll` when moving it does not change this, so modules linked to it are still looking for a `libzn_poly-0.9.so`.  Really need to fix that.


---

Comment by embray created at 2018-09-07 13:30:35

It seems the `-soname` flag for GNU `ld` has no impact on the DLL name used in DLL export sections, only the actual output filename.

Does anyone know the most recent status of zn_poly?  According to http://web.maths.unsw.edu.au/~davidharvey/code/zn_poly/ it is "no longer maintained".  Should we just make a new upstream repo for it and become its maintainers?


---

Comment by darij created at 2018-09-10 14:33:25

Thanks for doing this, Erik!


---

Comment by embray created at 2018-09-10 15:06:18

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-09-10 15:06:18

New upstream tarball for an 0.9.1 release candidate based on https://gitlab.com/sagemath/zn_poly  

If this works in Sage then I'll "release" it for real.

The new tarball has all the previous patches from Sage applied, and few other changes besides that.  It also contains improved Cygwin build support so this remains a blocker for fixing the Cygwin build.
----
New commits:


---

Comment by tscrim created at 2018-09-16 04:10:34

Darij, does this work for you? I am ready to set this to a positive review.


---

Comment by @darijgr created at 2018-09-16 04:11:51

Ouch, I forgot to check. Await an answer in a day or longer (Cygwin full compiles aren't a laughing matter).


---

Comment by @darijgr created at 2018-09-16 19:45:47

Hmm :(


```
[zn_poly-0.9.1] http://sagepad.org/spkg/upstream/zn_poly/zn_poly-0.9.1.tar.gz
[zn_poly-0.9.1] [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[zn_poly-0.9.1] ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/zn_poly/zn_poly-0.9.1.tar.gz'
[zn_poly-0.9.1] Traceback (most recent call last):
[zn_poly-0.9.1]   File "/home/skraeling/sage/build/bin/sage-download-file", line 28, in <module>
[zn_poly-0.9.1]     run_safe()
[zn_poly-0.9.1]   File "/home/skraeling/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 118, in run_safe
[zn_poly-0.9.1]     run()
[zn_poly-0.9.1]   File "/home/skraeling/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 100, in run
[zn_poly-0.9.1]     app.download_tarball(args.url_or_tarball, args.destination)
[zn_poly-0.9.1]   File "/home/skraeling/sage/build/bin/../sage_bootstrap/download/app.py", line 43, in download_tarball
[zn_poly-0.9.1]     tarball.download()
[zn_poly-0.9.1]   File "/home/skraeling/sage/build/bin/../sage_bootstrap/tarball.py", line 162, in download
[zn_poly-0.9.1]     raise FileNotMirroredError('tarball does not exist on mirror network')
[zn_poly-0.9.1] sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
[zn_poly-0.9.1] ************************************************************************
[zn_poly-0.9.1] Error downloading zn_poly-0.9.1.tar.gz
[zn_poly-0.9.1] ************************************************************************
[zn_poly-0.9.1] Please email sage-devel (http://groups.google.com/group/sage-devel)
[zn_poly-0.9.1] explaining the problem and including the log file
[zn_poly-0.9.1]   /home/skraeling/sage/logs/pkgs/zn_poly-0.9.1.log
[zn_poly-0.9.1] Describe your computer, operating system, etc.
[zn_poly-0.9.1] ************************************************************************
make[3]: *** [Makefile:2099: /home/skraeling/sage/local/var/lib/sage/installed/zn_poly-0.9.1] Error 1
make[3]: Leaving directory '/home/skraeling/sage/build/make'
make[2]: *** [Makefile:1792: all-build] Error 2
make[2]: Leaving directory '/home/skraeling/sage/build/make'

real    195m21.143s
user    101m24.436s
sys     49m44.530s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make all-build'):

* package: zn_poly-0.9.1
  log file: /home/skraeling/sage/logs/pkgs/zn_poly-0.9.1.log
  build directory: /home/skraeling/sage/local/var/tmp/sage/build/zn_poly-0.9.1

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

make[1]: *** [Makefile:33: all-build] Error 1
make[1]: Leaving directory '/home/skraeling/sage'
make: *** [Makefile:16: build] Error 2
```


This is with your branch merged into 8.4.beta5. But at least this looks like an easy one to fix.


---

Comment by tscrim created at 2018-09-16 20:32:00

You need to manually download the tar ball and put it in your upstream folder. Is that what you did?


---

Comment by @darijgr created at 2018-09-16 20:47:43

No; how does it work?=


---

Comment by tscrim created at 2018-09-16 21:15:54

Download the tar file in the ticket description and put it in the "$SAGE_ROOT/upstream" flder. Then run make.


---

Comment by @darijgr created at 2018-09-16 21:28:44

OK, I did, but it's still searching the web:

```
sage-logger -p 'sage-spkg zn_poly-0.9.1' '/home/skraeling/sage/logs/pkgs/zn_poly-0.9.1.log'
[zn_poly-0.9.1] Found local metadata for zn_poly-0.9.1
[zn_poly-0.9.1] Attempting to download package zn_poly-0.9.1.tar.gz from mirrors
```



---

Comment by @darijgr created at 2018-09-16 21:31:00

Ooooh, it was a wget issue. Sorry.


---

Comment by @darijgr created at 2018-09-16 21:54:20

It works! Thanks, Erik!

(Note to future self: wget mangles .gz on download; use curl instead.)


---

Comment by tscrim created at 2018-09-16 22:28:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-18 22:39:48

This causes massive breakage on incremental builds. Some modules link to libzn_poly-0.9.so which no longer exists:

```
$ ldd src/build/lib.linux-x86_64-2.7/sage/modular/pollack_stevens/dist.so
	linux-vdso.so.1 (0x00007ffc8a5f8000)
	libflint.so.13 => /mnt/disk/home/release/Sage/local/lib/libflint.so.13 (0x00007f70f46db000)
	libgmp.so.23 => /mnt/disk/home/release/Sage/local/lib/libgmp.so.23 (0x00007f70f4467000)
	libzn_poly-0.9.so => not found
$ ll local/lib/libzn_poly*
-rwxrwxr-x. 1 release release 527456 Sep 18 00:22 local/lib/libzn_poly-0.9.1.so
lrwxrwxrwx. 1 release release     19 Sep 18 00:22 local/lib/libzn_poly.so -> libzn_poly-0.9.1.so
```



---

Comment by vbraun created at 2018-09-18 22:39:48

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-09-19 14:27:58

I'm not sure I understand.  Shouldn't they just be rebuilt?


---

Comment by embray created at 2018-09-19 14:36:43

Perhaps I'll just modify it so that the soname still uses "0.9" instead of "0.9.1".  After all, the ABI is identical so there's no reason to change it.

But really Sage should just be rebuilt.  It lists zn_poly as a dependency, but there's no mechanism to recompile/link all modules that depend on a library that changed...


---

Comment by tscrim created at 2018-09-20 02:32:04

Replying to [comment:21 embray]:
> Perhaps I'll just modify it so that the soname still uses "0.9" instead of "0.9.1".  After all, the ABI is identical so there's no reason to change it.
> 
> But really Sage should just be rebuilt.  It lists zn_poly as a dependency, but there's no mechanism to recompile/link all modules that depend on a library that changed...

That doesn't see like a good thing to do. What if there happens to be a major upgrade? A less-bad-but-still-major-hack way to do this might be to touch all of the Cython files so they will be forced to be rebuilt and link against the new library.

I agree that all of these files should just be rebuilt because the dependency changed. Maybe there is a bug somewhere in the build system?


---

Comment by embray created at 2018-09-20 08:38:26

AFAICT there's no bug--although zn_poly is listed among the dependencies for Sage in the makefile, the result of updating them is to effectively run `./sage -b`, which has no mechanism by which to determine if any libraries modules are linked to changed.  As you suggested, the only obvious way to is touch all the Cython files, which should probably happen any time one of Sage's link-time dependencies change.

So that's something that clearly needs to be fixed.

However, in the meantime, for zn_poly I really should have included a `libzn_poly-0.9` symlink, since there is effectively no difference between 0.9 and 0.9.1.  If/when I get around to redoing zn_poly's build system with automake I can easily handle this better.


---

Attachment


---

Comment by git created at 2018-09-20 09:11:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-09-20 09:16:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-09-20 09:16:51

Updated tarball and branch.  This version should retain the original "libzn_poly-0.9.so" SONAME on Linux, for a smooth upgrade.


---

Comment by embray created at 2018-09-20 09:16:51

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2018-09-20 17:49:41

Can you also bump the version when making a new release; the old tarball is already on the mirrors.


---

Comment by tscrim created at 2018-09-20 22:39:12

I am still not in favor of making a symlink, but I will not object to this as this ticket is a net improvement and my solution is still a hack.


---

Comment by embray created at 2018-09-21 08:48:39

It's not really a question of making a symlink.  In fact, really that has nothing to do with it--the problem is everything to do with the SONAME embedded in the binary.


---

Comment by embray created at 2018-09-21 08:50:58

Replying to [comment:27 vbraun]:
> Can you also bump the version when making a new release; the old tarball is already on the mirrors.

I'm not sure what you mean.  I stated that the original 0.9.1 tarball I uploaded was a release candidate.  Perhaps I should have appended something to the filename to that effect.  The tarball attached to this ticket is different from the original one of the same name.  Can't you just replace it on the mirrors?  I don't think anyone cares if you do.


---

Comment by tscrim created at 2018-09-21 14:05:01

Replying to [comment:29 embray]:
> It's not really a question of making a symlink.  In fact, really that has nothing to do with it--the problem is everything to do with the SONAME embedded in the binary. 

I was going off what you said in comment:23 (I'm still a bit out of my depth on these issues). But my objection still applies in either case: 0.9.1 should not be masquerading as 0.9. Yet, like I said, this should not block this ticket from getting a positive review.


---

Comment by embray created at 2018-09-21 14:57:31

I think I see what you're saying here, and I admit I'm not 100% sure if it's the best way to go either.  I'm being inspired partially by https://www.debian.org/doc/debian-policy/ch-sharedlibs.html, though the exact file naming scheme is not the same (for now) as Debian prescribes.

There the convention is generally that the _actual_ .so file has the full library version in the filename (this allows multiple versions to be installed simultaneously, in principle.  Then there is usually at least once.  Then there's a symlink that is named the same as the library's SONAME, pointing to the real file.  Finally in some cases (but not all) there is a symlink that's just `libwhatever.so` with no version.

For example on my Debian system I have:


```
lrwxrwxrwx 1 root root       16 May 29  2017 libtiff.so -> libtiff.so.5.2.0
lrwxrwxrwx 1 root root       16 May 29  2017 libtiff.so.5 -> libtiff.so.5.2.0
-rw-r--r-- 1 root root   467208 May 29  2017 libtiff.so.5.2.0
```


Though for most libs there's no `libfoo.so`; usually just `libfoo.so.<ABI version>`.  I don't know why that's the case.

In this case for zn_poly what I have is:


```
libzn_poly-0.9.1.so  (where 0.9.1 is the library version)
libzn_poly-0.9.so -> libzn_poly-0.9.1.so (where in this case I'm saying 0.9 is just the ABI version--in a future release I will probably change this to just "1")
libzn_poly.so -> libzn_poly-0.9.1.so  (generic libzn_poly without version info)
```


So I think this makes sense, but is it "right"? I'm not really sure.  I plan to redo it later anyways when it's not as urgent :)


---

Comment by tscrim created at 2018-09-22 22:52:34

I'm not quite sure either about Volker's comment:27. Perhaps it was a misunderstanding? If not, Volker, could you explain a bit more when you set this back from positive review?


---

Comment by tscrim created at 2018-09-22 22:52:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-22 23:08:33

The mirrors don't update instantaneously, rather it takes some number of days that is up to the mirror admin. In the meantime everybody will download stale tarballs from the mirrors, note that the checksum does not match, and fail to build.

I can update the tarball on the mirror and then you wait until **all** mirrors have updated if you prefer.


---

Comment by vbraun created at 2018-09-22 23:08:33

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2018-09-23 22:40:58

I'm sorry, I still don't quite understand. The current (8.4.beta6) tarball is 0.9, but this new tarball is 0.9.1. Why is this different than any other spkg upgrade? At least, I see that as a version bump. Or did 0.9.1 get put onto the mirrors?


---

Comment by vbraun created at 2018-09-23 23:00:46

Tarballs are uploaded before the ticket is tested on the buildbot. On this ticket Eric had one 0.9.1 tarball, I tested it (hence uploaded to mirrors), then Eric make a different 0.9.1 tarball, the problem is going to be due to the different tarball.


---

Comment by tscrim created at 2018-09-23 23:10:39

I see, I was not aware of that. Thank you for the explanation.


---

Comment by embray created at 2018-09-24 10:14:32

> Tarballs are uploaded before the ticket is tested on the buildbot.

Why?  That doesn't make a lot of sense.  At the very least, shouldn't there be a couple of testing mirrors that the buildbots can be pointed to, rather that ones used for releases?

What do I need to do here?  This issue not only blocks Cygwin builds, it is also preventing the Cygwin patchbot from proceeding.


---

Comment by embray created at 2018-09-24 10:15:46

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-09-24 10:15:46

I'm just going to go ahead and set this back to positive review.  I'm going to go ahead now and put the updated tarball on the mirrors (now that I know how to do that).


---

Comment by vbraun created at 2018-09-24 17:43:51

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-09-24 17:43:51

Please set it back to positive review after all mirrors have synced


---

Comment by embray created at 2018-09-25 09:07:15

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-09-25 09:07:15

I have no idea how to know that all mirrors have synced.  Look: The change has been reviewed positively in of its own right.  You are within your own power to determine if/when it is safe for you to merge--that's a matter of your process, not the review status of the change.


---

Comment by embray created at 2018-09-25 09:10:32

To follow up: I'm not trying to pick a fight here; I just feel like you're creating a double-standard around this for some reason.  I've never seen you or anyone claim a ticket that updates a package does not have "positive review" just because the package tarball has not "synced to all the mirrors" (which IMO should not be part of the process in the first place but nevermind...)


---

Comment by embray created at 2018-09-25 09:20:08

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-09-25 09:20:08

In good faith, I'll set it back to "needs_work" but as I have no idea how to know if "all mirrors are synced" I will leave that to you.


---

Comment by vbraun created at 2018-09-25 22:55:55

Just wait a day or two...


---

Comment by embray created at 2018-09-26 09:16:10

That's fine, I'm in no hurry.  I am just confused.


---

Comment by tscrim created at 2018-09-30 22:06:45

Since it has been 5 days, I am setting this back to positive review.


---

Comment by tscrim created at 2018-09-30 22:06:45

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-10-01 22:35:52

Resolution: fixed


---

Comment by @timokau created at 2018-10-03 14:52:31

Apparently sage ships zn_poly 0.9.1 now, but there is no tagged release on the fork. Is that intentional? And what are the differences between 0.9 and 0.9.1? Did you just apply all the sage patches?

Thanks for taking over maintenance!


---

Comment by embray created at 2018-10-03 15:43:21

Replying to [comment:48 gh-timokau]:
> Apparently sage ships zn_poly 0.9.1 now, but there is no tagged release on the fork. Is that intentional?

Yes. It says elsewhere here that I'll tag the new release after this ticket is approved (which it looks like it has been) since testing it against sage's buildbots was the best way to test it.

> And what are the differences between 0.9 and 0.9.1? Did you just apply all the sage patches?

You can look at the commit log on the fork, but that's mainly it, modulo a few other minor build changes.

I intend to redo the build system for this package, but it's low priority as long a the existing one is "working".


---

Comment by @timokau created at 2018-10-03 16:02:10

Replying to [comment:49 embray]:
> Replying to [comment:48 gh-timokau]:
> > Apparently sage ships zn_poly 0.9.1 now, but there is no tagged release on the fork. Is that intentional?
> 
> Yes. It says elsewhere here that I'll tag the new release after this ticket is approved (which it looks like it has been) since testing it against sage's buildbots was the best way to test it.

So since that is done and sage and arch already ship 0.9.1, can you add the tag now?
 
> > And what are the differences between 0.9 and 0.9.1? Did you just apply all the sage patches?
> 
> You can look at the commit log on the fork, but that's mainly it, modulo a few other minor build changes.
> 
> I intend to redo the build system for this package, but it's low priority as long a the existing one is "working".


---

Comment by embray created at 2018-10-03 16:46:08

Replying to [comment:50 gh-timokau]:
> Replying to [comment:49 embray]:
> > Replying to [comment:48 gh-timokau]:
> > > Apparently sage ships zn_poly 0.9.1 now, but there is no tagged release on the fork. Is that intentional?
> > 
> > Yes. It says elsewhere here that I'll tag the new release after this ticket is approved (which it looks like it has been) since testing it against sage's buildbots was the best way to test it.
> 
> So since that is done and sage and arch already ship 0.9.1, can you add the tag now?

Yup! I'll do it before the end of the week.


---

Comment by embray created at 2018-10-04 09:58:47

Ok done.  The new release can be obtained from its new canonical home at: https://gitlab.com/sagemath/zn_poly/tags/0.9.1


---

Comment by @timokau created at 2018-10-04 20:42:16

Thank you! I noticed that tuning is enabled by default now. Shouldn't it be disabled in spkg-install when `SAGE_FAT_BINARY` is set? I see that it wasn't before either, but it should right?


---

Comment by embray created at 2018-10-05 09:18:50

Replying to [comment:53 gh-timokau]:
> Thank you! I noticed that tuning is enabled by default now. Shouldn't it be disabled in spkg-install when `SAGE_FAT_BINARY` is set? I see that it wasn't before either, but it should right?

TBH I'm not sure it much matters.  If you build without running the "tune" program it just uses some default tunings from David Harvey's own machine from god-knows-when, so it's arbitrary either way.

If I had the time and inclination I would redesign it to be able to read the tunings from a file rather than hard-coded, so the tuning program can be re-run on individual machines without having to recompile.  IIUC how the tuning program works, there's no deep reason it couldn't be done this way.


---

Comment by @timokau created at 2018-10-05 16:15:17

Replying to [comment:54 embray]:
> Replying to [comment:53 gh-timokau]:
> > Thank you! I noticed that tuning is enabled by default now. Shouldn't it be disabled in spkg-install when `SAGE_FAT_BINARY` is set? I see that it wasn't before either, but it should right?
> 
> TBH I'm not sure it much matters.  If you build without running the "tune" program it just uses some default tunings from David Harvey's own machine from god-knows-when, so it's arbitrary either way.

Thats good to know. I thought it may depend on some particular hardware aspects after tuning.
One other reason against always tuning is binary reproducibilty. I don't know if that is a goal
of SAGE_FAT_BINARY, but at least thats the reason why I still disable tuning on nix.

> If I had the time and inclination I would redesign it to be able to read the tunings from a file rather than hard-coded, so the tuning program can be re-run on individual machines without having to recompile.  IIUC how the tuning program works, there's no deep reason it couldn't be done this way.


---

Comment by embray created at 2018-10-08 09:57:53

Replying to [comment:55 gh-timokau]:
> Replying to [comment:54 embray]:
> > Replying to [comment:53 gh-timokau]:
> > > Thank you! I noticed that tuning is enabled by default now. Shouldn't it be disabled in spkg-install when `SAGE_FAT_BINARY` is set? I see that it wasn't before either, but it should right?
> > 
> > TBH I'm not sure it much matters.  If you build without running the "tune" program it just uses some default tunings from David Harvey's own machine from god-knows-when, so it's arbitrary either way.

In this case it doesn't result in machine-specific code.  I don't fully understand how this code works to be honest, but my vague understanding is that it implements a number of different algorithms that may work at different speeds on different machines, and it adjusts how many times to run each algorithm to converge on the best solution the most efficiently.  Something to that effect... *waves hands*

> Thats good to know. I thought it may depend on some particular hardware aspects after tuning.
> One other reason against always tuning is binary reproducibilty. I don't know if that is a goal
> of SAGE_FAT_BINARY, but at least thats the reason why I still disable tuning on nix.

I don't know if that's a goal for SAGE_FAT_BINARY either.  That might be something to bring up on the mailing list.  But yes, for binary reproducibility you'll want to disable tuning, so now (as document) the way to do that is to run `./configure --disable-tuning`.


---

Comment by @timokau created at 2018-10-08 10:04:31

Replying to [comment:56 embray]:
> Replying to [comment:55 gh-timokau]:
> > Replying to [comment:54 embray]:
> > > Replying to [comment:53 gh-timokau]:
> > > > Thank you! I noticed that tuning is enabled by default now. Shouldn't it be disabled in spkg-install when `SAGE_FAT_BINARY` is set? I see that it wasn't before either, but it should right?
> > > 
> > > TBH I'm not sure it much matters.  If you build without running the "tune" program it just uses some default tunings from David Harvey's own machine from god-knows-when, so it's arbitrary either way.
> 
> In this case it doesn't result in machine-specific code.  I don't fully understand how this code works to be honest, but my vague understanding is that it implements a number of different algorithms that may work at different speeds on different machines, and it adjusts how many times to run each algorithm to converge on the best solution the most efficiently.  Something to that effect... *waves hands*
> 
> > Thats good to know. I thought it may depend on some particular hardware aspects after tuning.
> > One other reason against always tuning is binary reproducibilty. I don't know if that is a goal
> > of SAGE_FAT_BINARY, but at least thats the reason why I still disable tuning on nix.
> 
> I don't know if that's a goal for SAGE_FAT_BINARY either.  That might be something to bring up on the mailing list.  But yes, for binary reproducibility you'll want to disable tuning, so now (as document) the way to do that is to run `./configure --disable-tuning`.

Binary reproducibility is probably overkill for `SAGE_FAT_BINARY`, so it should be fine as-is. Thanks for the clarification.
