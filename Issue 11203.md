# Issue 11203: speed up computation of level one eisenstein series

Issue created by migration from Trac.

Original creator: was

Original creation time: 2011-05-24 20:24:44

Assignee: craigcitro

CC:  alexghitza

Craig Citro sent me some much faster code.  See attached patch.  He says "i need to just yank the testing stuff in that patch and
it's probably ready to submit.

interestingly/sadly the tests i ran had that code spending ~15-20% of
its time computing the coefficients, and ~80-85% converting them and
copying them around multiple times. depending on what you want to do
with it, it's definitely plausible to push it quite a bit more.

i think the current setup is good enough for some stuff, but honestly,
if i ever get a chance to work on some of the stuff i originally wrote
that code for ... i'm probably just going to rewrite it in C/C++ and
link directly against gmp/zn_poly. ;)"


---

Attachment

rebased for sage-4.7.1


---

Comment by was created at 2012-01-05 04:15:47

Note: Though not a logical dependency, #12265 is going to make a soon-to-be-posted version of this code massively faster.


---

Comment by was created at 2012-01-05 06:20:30

Changing status from new to needs_review.


---

Comment by was created at 2012-01-05 06:20:30

I read through and basically refereed Craig's patch.  I deleted the testing code he had, added some doctests, and some more comments.  I also rewrote the part that converts the integer list into a polynomial in a way that is dramatically faster *if* you have the relatively simple patch at #12265 applied.  Since that's numerous changes, somebody else needs to approve this.  I think even Craig could do so.


---

Comment by craigcitro created at 2012-01-05 07:16:59

LGTM! Too bad my name won't appear in the hg repo for this code anymore. ;)

I'm really glad to see that you did #12265; I didn't want to figure out the right way to get that in order (the FLINT QQX stuff was still in flux when I wrote this patch IIRC), but it's what kept me from actually pushing any harder to get it in.

Do you happen to have some timing comparisons for the actual coefficient computation vs. the whole eisenstein_series_qexp call? I'm curious how low the overhead is now.

The Py_GET_ITEM is indeed gross, but a necessary evil.


---

Comment by craigcitro created at 2012-01-05 07:16:59

Changing status from needs_review to positive_review.


---

Comment by was created at 2012-01-05 07:22:57

Replying to [comment:4 craigcitro]:
> LGTM! Too bad my name won't appear in the hg repo for this code anymore. ;)

I'll update the author of the patch right now to have both our names on it.   That's easy with queues, of course. 
 
> I'm really glad to see that you did #12265; I didn't want to figure out the right way to get that in order (the FLINT QQX stuff was still in flux when I wrote this patch IIRC), but it's what kept me from actually pushing any harder to get it in.
> 

I kept thinking of a way to do what *we* need for #11375, then thinking of a better way, then a better way, then a better way, etc., (where better means it will be more generally helpful to code).  I ended up settling on a pretty good solution, I think.   But I deleted a lot of code on the way there!


> Do you happen to have some timing comparisons for the actual coefficient computation vs. the whole eisenstein_series_qexp call? I'm curious how low the overhead is now.
> 

Yes, here is an example:

```
sage: from sage.modular.modform.eis_series_cython import Ek_ZZ
sage: time v = Ek_ZZ(4,10^6)                  
Time: CPU 1.08 s, Wall: 1.08 s
sage: time f = eisenstein_series_qexp(4, 10^6)                
Time: CPU 1.32 s, Wall: 1.33 s
```

Before it would take 1 second to compute the v, then over 4 seconds to make the power series!



> The Py_GET_ITEM is indeed gross, but a necessary evil.


---

Comment by was created at 2012-01-05 07:23:36

apply only this (and this is updated by including craig as a co-author).


---

Attachment

In the docstring, there should be a blank line after `INPUT:` and `OUTPUT:` (if you use an item list, which you do).


---

Comment by jdemeyer created at 2012-01-05 07:45:54

Changing status from positive_review to needs_work.


---

Comment by was created at 2012-01-07 04:32:19

apply only this (also addresses remark of jdmeyer)


---

Comment by was created at 2012-01-07 04:32:37

Changing status from needs_work to needs_review.


---

Attachment

jdmeyer -- good now?


---

Attachment

apply on this.  Addresses Jereon's remark *and* fixes a missing-line bug (convert to power series) that caused some test failures.


---

Comment by was created at 2012-01-13 14:49:07

jdmeyer -- I think the attached patch is good now.  It fixes the Sphinx issue you pointed out.  Also, I noticed a separate issue (output was coming out as polynomials instead of power series), and fixes that, checking that no performance regression was introduced.


---

Comment by jdemeyer created at 2012-01-13 15:06:08

Sorry to bother again, but the `INPUT:` and `OUTPUT:` blocks should _not_ be indented.


---

Comment by jdemeyer created at 2012-01-13 15:06:08

Changing status from needs_review to needs_work.


---

Comment by was created at 2012-01-13 16:12:21

Changing status from needs_work to needs_review.


---

Comment by was created at 2012-01-13 16:12:21

Replying to [comment:9 jdemeyer]:
> Sorry to bother again, but the `INPUT:` and `OUTPUT:` blocks should _not_ be indented.

I think it...

  1. looks better to indent in the original source (since the rendered Sphinx list is indented), 
  2. looks identical in the rendered Sphinx output whether or not it is indented,
  3. is not an error to indent; in fact, there isn't even a warning when you indent, as far as I can tell (unless they are being suppressed somehow?). 

When double-checking the above, I added eis_series_cython to the reference manual.  I've updated this patch based on adding it. 


```
wstein`@`linux ~/d/sage/modular/modform $ sage -docbuild reference html
sphinx-build -b html -d /home/wstein/sage/install/sage-4.8.alpha5/devel/sage/doc/output/doctrees/en/reference    /home/wstein/sage/install/sage-4.8.alpha5/devel/sage/doc/en/reference /home/wstein/sage/install/sage-4.8.alpha5/devel/sage/doc/output/html/en/reference
Running Sphinx v1.1.2
loading pickled environment... done
building [html]: targets for 1 source files that are out of date
updating environment: 0 added, 1 changed, 0 removed
reading sources... [100%] sage/modular/modform/eis_series_cython                                           
looking for now-outdated files... none found
pickling environment... done
checking consistency... done
preparing documents... done
writing output... [100%] sage/modular/modform/eis_series_cython                                            
writing additional files... genindex py-modindex search
copying static files... done
dumping search index... done
dumping object inventory... done
build succeeded.
Build finished.  The built documents can be found in /home/wstein/sage/install/sage-4.8.alpha5/devel/sage/doc/output/html/en/reference
```



---

Comment by was created at 2012-01-13 16:12:56

apply only this.


---

Attachment

I'll change it to you want just for consistency with most Sage code (but I still don't see that it is invalid).


---

Comment by was created at 2012-01-13 16:34:30

apply only this.


---

Attachment

Replying to [comment:10 was]:
>   2. looks identical in the rendered Sphinx output whether or not it is indented,
This is not true, the rendered output is indented more.

>   3. is not an error to indent; in fact, there isn't even a warning when you indent, as far as I can tell (unless they are being suppressed somehow?).
True, it's not an error.  It just produces more indent.

Anyway, with the latest patch the documentation formatting is as it should be, so positive_review on that part.  I'll leave it to Craig Citro to review the rest of the patch.


---

Comment by craigcitro created at 2012-01-13 22:46:01

Changing status from needs_review to positive_review.


---

Comment by craigcitro created at 2012-01-13 22:46:01

LGTM on the power series bit ... glad the tests caught it. :) 

One wildly minor nit: the conversion from list -> poly -> power series has comments interspersed about what it's doing a faster version of; it might be nice for those to be either grouped at the top or at least always before the code they're replaced by. (So lines 102-103 in eis_series.py could be moved above line 98 or 99, respectively.) Putting them all together might also be a nice TODO list for anyone looking to speed up general power series creation.


---

Comment by jdemeyer created at 2012-01-18 08:14:12

Resolution: fixed
