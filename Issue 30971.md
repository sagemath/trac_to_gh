# Issue 30971: Use popcnt and tzcnt to speed up bitsets on Intel and AMD

Issue created by migration from https://trac.sagemath.org/ticket/31208

Original creator: @kliem

Original creation time: 2021-01-08 10:37:29

CC:  tscrim dcoudert hivert slelievre

Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available.

Comparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).

Tests are run with #31197, as this provides an easy use case for a bitset iterator.

Before:


```                                                           
sage: set_random_seed(0)
sage: B = Bitset([randint(0,1000000) for _ in range(100000)])
sage: %timeit len(B)
15.2 µs ± 8.99 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: set_random_seed(0)
sage: G = Graph(edges, sparse=False, loops=True) 
sage: %timeit _ = G.copy(sparse=False)
2.62 ms ± 2.75 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: H = G.copy(sparse=False)
sage: %timeit H == G
2.45 ms ± 2.06 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


After:


```
sage: set_random_seed(0)
sage: B = Bitset([randint(0,1000000) for _ in range(100000)])
sage: %timeit len(B)
5.87 µs ± 7.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: set_random_seed(0)
sage: G = Graph(edges, sparse=False, loops=True)
sage: %timeit _ = G.copy(sparse=False)
2.32 ms ± 6.73 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: H = G.copy(sparse=False)
sage: %timeit H == G
2.04 ms ± 2.38 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```



---

Comment by @kliem created at 2021-01-08 10:43:28

New commits:


---

Comment by @kliem created at 2021-01-08 10:50:57

Changing status from new to needs_review.


---

Comment by dcoudert created at 2021-01-08 19:11:57

Works well on my macOS laptop with similar speed up than reported (although my laptop is slower). It seems also ok on a desktop with fedora 32, but I have doctests errors due to cplex (problems with threads) and so it's not easy to know if all tests pass. Nonetheless, I also observe a significant speed up.

Before setting this ticket to positive review, it would be better to have a second opinion.


---

Comment by @kliem created at 2021-01-08 19:35:09

The timings are from my office computer, which is pretty fast. I think the ratio is about the same on my laptop.

We should also definitely wait for a few patchbots. It took my a number of attempts to figure out most of the problems (tested popcount on an earlier branch of #26887 and then on #27103, in particular it doens't seem to work on 32-bit, which is why it is excluded now).


---

Comment by dcoudert created at 2021-01-08 19:41:07

I though `mpn_cnt` was using intrinsic whenever available. Apparently it's not the case.


---

Comment by dcoudert created at 2021-01-15 00:09:09

I don't know why the patchbot is not testing this ticket...


---

Comment by tscrim created at 2021-01-15 02:12:12

Replying to [comment:8 dcoudert]:
> I don't know why the patchbot is not testing this ticket...

I think because there was no author filled in.


---

Comment by dcoudert created at 2021-01-15 09:01:19

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2021-01-15 09:01:19

For me, this is working well on macOS 10.15.7 and fedora 32.


---

Comment by @kliem created at 2021-01-15 09:11:37

Thank you.


---

Comment by vbraun created at 2021-01-24 10:37:31

Resolution: fixed
