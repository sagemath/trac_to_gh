# Issue 29742: Make rings doctests ready for random seeds

Issue created by migration from https://trac.sagemath.org/ticket/29979

Original creator: @kliem

Original creation time: 2020-06-24 21:36:02

This ticket makes

```
sage -t --long --random-seed=n src/sage/rings/
```

pass for different values `n` than just `0`.


---

Comment by @kliem created at 2020-06-24 21:37:31

I have a partial fix. After that at least the following need fixes:

```
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/complex_double.pyx  # 3 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/complex_field.py  # 4 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/complex_interval_field.py  # 3 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/finite_rings/element_givaro.pyx  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/finite_rings/element_ntl_gf2e.pyx  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/finite_rings/finite_field_base.pyx  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/finite_rings/finite_field_givaro.py  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/finite_rings/finite_field_ntl_gf2e.py  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/finite_rings/integer_mod_ring.py  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/integer_ring.pyx  # 10 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/number_field/order.py  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/padics/generic_nodes.py  # 3 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/padics/padic_extension_generic.py  # 4 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/padics/tests.py  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/pari_ring.py  # 3 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/cyclotomic.pyx  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/multi_polynomial_element.py  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/multi_polynomial_ideal.py  # 5 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/multi_polynomial_ring_base.pyx  # 13 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/pbori.pyx  # 27 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/polynomial_element.pyx  # 4 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/polynomial_ring.py  # 7 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/polynomial/skew_polynomial_element.pyx  # 15 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/rational_field.py  # 6 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/real_double.pyx  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/real_mpfi.pyx  # 5 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/real_mpfr.pyx  # 12 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/rings/ring.pyx  # 1 doctest failed
```



---

Comment by @kliem created at 2020-06-24 21:43:59

New commits:


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-06-29 21:09:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2021-06-29 21:09:59

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-06-29 21:12:34

If a reviewer feels like we should split this into several tickets, then this is also fine with me (e.g. start with some submodules).


---

Comment by git created at 2021-06-29 21:29:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-03 06:08:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-03 07:00:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2021-07-03 09:04:25

There are a few more tests that fail (some of these might be duplicates):

```
sage -t --long --warn-long 62.5 --random-seed=3000 src/sage/rings/tate_algebra_element.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3000 src/sage/rings/tests.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3002 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3002 src/sage/rings/padics/padic_generic_element.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3003 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3004 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3007 src/sage/rings/polynomial/ore_function_field.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3009 src/sage/rings/polynomial/ore_polynomial_element.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3009 src/sage/rings/tests.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3011 src/sage/rings/polynomial/ore_function_element.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3012 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3013 src/sage/rings/continued_fraction.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3014 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3017 src/sage/rings/invariants/invariant_theory.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3019 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3023 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3028 src/sage/rings/padics/padic_generic_element.pyx  # 2 doctests failed
sage -t --long --warn-long 62.5 --random-seed=3030 src/sage/rings/tests.py  # 7 doctests failed
sage -t --long --warn-long 62.5 --random-seed=3031 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3035 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3037 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3040 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3042 src/sage/rings/padics/padic_generic_element.pyx  # 2 doctests failed
sage -t --long --warn-long 62.5 --random-seed=3043 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3043 src/sage/rings/invariants/invariant_theory.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3043 src/sage/rings/polynomial/ore_function_element.py  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3049 src/sage/rings/tate_algebra_element.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3050 src/sage/rings/finite_rings/integer_mod.pyx  # 1 doctest failed
sage -t --long --warn-long 62.5 --random-seed=3050 src/sage/rings/padics/padic_generic_element.pyx  # 1 doctest failed
```



---

Comment by @mwageringel created at 2021-07-03 09:04:25

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-07-03 09:47:02

Thanks for catching those. It's really hard to catch all those one in a thousand failures in all of sage...


---

Comment by @kliem created at 2021-07-03 18:38:37

And some of the errors are really something.

In `src/sage/rings/tests.py` we are trying to construct a relative number field by only checking that the polynomial is irreducible over `ZZ`...


---

Comment by @kliem created at 2021-07-03 21:18:23

Last 10 new commits:


---

Comment by @kliem created at 2021-07-03 21:18:23

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-07-04 12:39:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-04 15:33:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2021-07-04 15:39:59

Replying to [comment:17 gh-kliem]:
> It's really hard to catch all those one in a thousand failures in all of sage...

I agree and I appreciate all the work you put into this a lot. In the last commit, I have just added a few small fixes for some other test failures I found.


---

Comment by @kliem created at 2021-07-05 09:32:07

The `continue_fraction_gosper.py` doctest sometimes fails for negative period as well. I'm not sure if this is a bug or just the doctest being incorrect::


```
sage: def foo(a, b, c, d): 
....:      from sage.rings.continued_fraction_gosper import gosper_iterator 
....:      x = continued_fraction(([1,2],[3,4])); i = iter(gosper_iterator(a,b,c,d,x)) 
....:      l = list(i) 
....:      preperiod_length = i.output_preperiod_length 
....:      preperiod = l[:preperiod_length] 
....:      period = [abs(w) for w in l[preperiod_length:]] 
....:      c == d == 0 or continued_fraction((preperiod, period), x.value()) == continued_fraction((a*x.value()+b)/(c*x.value()+d)) 
sage: for i in range(-10, 11): 
....:     for j in range(-10, 11): 
....:         try: 
....:             foo(0,0,i,j) 
....:         except: 
....:             print("foo(0, 0, %s, %s)" % (i, j)) 
....:              
....:                                                                                                                                 
foo(0, 0, -9, 10)
foo(0, 0, -8, 9)
foo(0, 0, -8, 10)
foo(0, 0, -7, 8)
foo(0, 0, -7, 9)
foo(0, 0, -7, 10)
foo(0, 0, -6, 7)
foo(0, 0, -6, 8)
foo(0, 0, -6, 9)
foo(0, 0, -5, 6)
foo(0, 0, -5, 7)
foo(0, 0, -4, 5)
foo(0, 0, -4, 6)
foo(0, 0, -3, 4)
foo(0, 0, -2, 3)
foo(0, 0, 2, -3)
foo(0, 0, 3, -4)
foo(0, 0, 4, -6)
foo(0, 0, 4, -5)
foo(0, 0, 5, -7)
foo(0, 0, 5, -6)
foo(0, 0, 6, -9)
foo(0, 0, 6, -8)
foo(0, 0, 6, -7)
foo(0, 0, 7, -10)
foo(0, 0, 7, -9)
foo(0, 0, 7, -8)
foo(0, 0, 8, -10)
foo(0, 0, 8, -9)
foo(0, 0, 9, -10)
```



---

Comment by git created at 2021-07-05 18:29:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2021-07-05 18:31:11

Replying to [comment:27 gh-kliem]:
> The `continue_fraction_gosper.py` doctest sometimes fails for negative period as well. I'm not sure if this is a bug or just the doctest being incorrect::

I am not sure either. I have opened #32127 for this problem and have now marked this test as well as the other tests for which I opened tickets yesterday as `not tested`.


---

Comment by git created at 2021-07-05 20:15:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2021-07-05 20:24:48

I have now reviewed your code and made a few small adjustments. The line I removed in `multi_polynomial_ring_base` seems redundant since `R` is the base ring of `S`, but I think the test might have failed if `f` happened to be zero.

Do you agree with my changes? It is inevitable that there are still sporadic failures, but to me the current branch seems robust enough for now. Nice work.


---

Comment by @kliem created at 2021-07-06 07:16:23

Thanks for the improvements.


---

Comment by @mwageringel created at 2021-07-06 19:18:43

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2021-07-06 19:18:43

So we can set this ticket to positive then.


---

Comment by git created at 2021-07-06 19:27:01

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-07-06 19:27:01

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by @kliem created at 2021-07-06 19:27:12

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-07-06 19:27:19

Thank you.


---

Comment by vbraun created at 2021-07-23 22:09:32

Merge conflict


---

Comment by vbraun created at 2021-07-23 22:09:32

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2021-08-09 11:35:27

Rebased.
----
New commits:


---

Comment by @kliem created at 2021-08-09 11:35:27

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-08-29 09:37:51

Resolution: fixed
