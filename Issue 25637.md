# Issue 25637: Conversions between S unit group and number field are not each others inverse

archive/issues_025637.json:
```json
{
    "body": "Keywords: number field unit group conversion\n\nWhen working in a number field, converting back and forth between elements of the (S) unit group and their values in the number fields does not necessarily give the same element back. Here is a toy example\n\n```\nsage: K = QuadraticField(-3).composite_fields(QuadraticField(2))[0]\nsage: U = K.unit_group()\nsage: [(u, U(K(u))) for u in U.gens()]\n[(u0, u0^5), (u1, u1)]\nsage: US = K.S_unit_group(3)\nsage: [(u, U(K(u))) for u in U.gens()]\n[(u0, u0^5), (u1, u1)]\n```\n\nThis problem does not seem to occur for simple number fields and only causes a problem on the torsion part of the unit group.\n\nLooking into the code it seems that the cause of this problem is that the conversion from the number field to the unit group uses the  pari conversion, which considers a (possibly) different torsion generator then the one picked by sage when the unit group is initialized.\n\nLooking into the pari documentation, pari seems to use bnf.tu (an element stored in the pari number field data object) to convert to the unit group, whilst sage uses the pari function nfrootsof1 to initialize the value of the fundamental unit.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25874\n\n",
    "created_at": "2018-07-18T09:54:21Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Conversions between S unit group and number field are not each others inverse",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25637",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```
Keywords: number field unit group conversion

When working in a number field, converting back and forth between elements of the (S) unit group and their values in the number fields does not necessarily give the same element back. Here is a toy example

```
sage: K = QuadraticField(-3).composite_fields(QuadraticField(2))[0]
sage: U = K.unit_group()
sage: [(u, U(K(u))) for u in U.gens()]
[(u0, u0^5), (u1, u1)]
sage: US = K.S_unit_group(3)
sage: [(u, U(K(u))) for u in U.gens()]
[(u0, u0^5), (u1, u1)]
```

This problem does not seem to occur for simple number fields and only causes a problem on the torsion part of the unit group.

Looking into the code it seems that the cause of this problem is that the conversion from the number field to the unit group uses the  pari conversion, which considers a (possibly) different torsion generator then the one picked by sage when the unit group is initialized.

Looking into the pari documentation, pari seems to use bnf.tu (an element stored in the pari number field data object) to convert to the unit group, whilst sage uses the pari function nfrootsof1 to initialize the value of the fundamental unit.

Issue created by migration from https://trac.sagemath.org/ticket/25874





---

archive/issue_comments_361221.json:
```json
{
    "body": "I am doing some more experimenting and the output of pari's function nfrootsof1 seems to be random, in the sense that calling it successively can give different answers. Of course the root of unity is not unique, but having a different torsion generator each time the unit group is initialized is guaranteed to cause some problems, especially in testing.",
    "created_at": "2018-07-18T10:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361221",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

I am doing some more experimenting and the output of pari's function nfrootsof1 seems to be random, in the sense that calling it successively can give different answers. Of course the root of unity is not unique, but having a different torsion generator each time the unit group is initialized is guaranteed to cause some problems, especially in testing.



---

archive/issue_comments_361222.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-18T13:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361222",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

New commits:



---

archive/issue_comments_361223.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-20T12:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361223",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing status from new to needs_review.



---

archive/issue_events_064717.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jvlangen",
    "created_at": "2018-09-19T09:43:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25637#event-64717"
}
```



---

archive/issue_comments_361224.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-19T10:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361225.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-11-06T20:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361225",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_361226.json:
```json
{
    "body": "There are some failing doctests, see e.g. [this patchbot report](https://patchbot.sagemath.org/log/25874/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-11-01%2022:54:27?short).",
    "created_at": "2018-11-06T20:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361226",
    "user": "https://github.com/pjbruin"
}
```

There are some failing doctests, see e.g. [this patchbot report](https://patchbot.sagemath.org/log/25874/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-11-01%2022:54:27?short).



---

archive/issue_comments_361227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-07T10:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361227",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361228.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-11-07T10:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361228",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_361229.json:
```json
{
    "body": "As far as I can see this is indeed the right solution, and tests pass.",
    "created_at": "2018-11-07T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361229",
    "user": "https://github.com/pjbruin"
}
```

As far as I can see this is indeed the right solution, and tests pass.



---

archive/issue_comments_361230.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-07T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361230",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064718.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-08T16:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25637#event-64718"
}
```



---

archive/issue_events_064719.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-08T16:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25637#event-64719"
}
```



---

archive/issue_comments_361231.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-09T17:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25637#issuecomment-361231",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_064720.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-09T17:16:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25637",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25637#event-64720"
}
```
