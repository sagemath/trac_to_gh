# Issue 25637: Conversions between S unit group and number field are not each others inverse

Issue created by migration from Trac.

Original creator: jvlangen

Original creation time: 2018-07-18 09:54:21

Keywords: number field unit group conversion

When working in a number field, converting back and forth between elements of the (S) unit group and their values in the number fields does not necessarily give the same element back. Here is a toy example


```
sage: K = QuadraticField(-3).composite_fields(QuadraticField(2))[0]
sage: U = K.unit_group()
sage: [(u, U(K(u))) for u in U.gens()]
[(u0, u0^5), (u1, u1)]
sage: US = K.S_unit_group(3)
sage: [(u, U(K(u))) for u in U.gens()]
[(u0, u0^5), (u1, u1)]
```


This problem does not seem to occur for simple number fields and only causes a problem on the torsion part of the unit group.

Looking into the code it seems that the cause of this problem is that the conversion from the number field to the unit group uses the  pari conversion, which considers a (possibly) different torsion generator then the one picked by sage when the unit group is initialized.

Looking into the pari documentation, pari seems to use bnf.tu (an element stored in the pari number field data object) to convert to the unit group, whilst sage uses the pari function nfrootsof1 to initialize the value of the fundamental unit.


---

Comment by jvlangen created at 2018-07-18 10:14:53

I am doing some more experimenting and the output of pari's function nfrootsof1 seems to be random, in the sense that calling it successively can give different answers. Of course the root of unity is not unique, but having a different torsion generator each time the unit group is initialized is guaranteed to cause some problems, especially in testing.


---

Comment by jvlangen created at 2018-07-18 13:05:41

New commits:


---

Comment by jvlangen created at 2018-07-20 12:54:36

Changing status from new to needs_review.


---

Comment by git created at 2018-09-19 10:15:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2018-11-06 20:21:35

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2018-11-06 20:21:35

There are some failing doctests, see e.g. [this patchbot report](https://patchbot.sagemath.org/log/25874/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-11-01%2022:54:27?short).


---

Comment by git created at 2018-11-07 10:35:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jvlangen created at 2018-11-07 10:38:41

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2018-11-07 12:37:43

As far as I can see this is indeed the right solution, and tests pass.


---

Comment by pbruin created at 2018-11-07 12:37:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-11-09 17:16:11

Resolution: fixed
