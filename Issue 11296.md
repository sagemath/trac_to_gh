# Issue 11296: Memleak when using elliptic curves

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2011-06-13 16:44:06

Assignee: rlm

CC:  jpflori burcin

Keywords: memleak, elliptic curves

Using the following piece of code makes the memory footprint of sage 
 grow indefinitely: 


sage: K = GF(1<<50,'t') 
 sage: j = K.random_element() 
 sage: while 1: 
 ....:    E = EllipticCurve(j=j) 
 ....:    del E 
 ....: 


This seems to be less dramatic with finite fields of char != 2 and 
inexistant for ZZ and QQ.

However this makes big computations involving different elliptic curves quite inpractical.



---

Comment by jpflori created at 2011-06-15 17:51:55

Changing keywords from "memleak, elliptic curves" to "memleak, libsingular".


---

Comment by jpflori created at 2011-06-15 17:51:55

Changing type from PLEASE CHANGE to defect.


---

Comment by jpflori created at 2011-06-15 19:45:49

Calling gc.collect() just after the creation prevents the memory problem.

But it does not if called later.


---

Comment by jpflori created at 2011-06-15 22:01:49

Changing status from new to needs_review.


---

Comment by jpflori created at 2011-06-15 22:07:28

I finally found the memleaks in different si2sa_* functions.

Potential fix provided.


---

Comment by mariah created at 2011-06-22 13:14:44

The patch does not seem to fix the reported problem.  I applied the patch to sage-4.7.1.alpha2, did 'sage -b', yet I still see memory
increasing when I run the code in the ticket description.


---

Comment by mariah created at 2011-06-22 13:14:44

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2011-06-22 16:08:06

Changing status from needs_work to needs_info.


---

Comment by jpflori created at 2011-06-22 16:08:06

I just retested it and it seems to fix the memleak for me:

no increase in memory footprint after 30 minutes.

Which code did you run ?

The one in the tickect description or the one on sage-support post ?

Because there are other memleaks involved when using EllipticCurve class.

See #11495 and #11521 for example.


---

Comment by mariah created at 2011-06-22 18:39:06

Replying to [comment:9 jpflori]:
> I just retested it and it seems to fix the memleak for me:
> 
> no increase in memory footprint after 30 minutes.
> 
> Which code did you run ?
> 
> The one in the tickect description or the one on sage-support post ?

I used the code in the ticket description.

I will try again.


---

Comment by mariah created at 2011-06-22 18:39:06

Changing status from needs_info to needs_review.


---

Comment by mariah created at 2011-06-23 18:31:45

Changing status from needs_review to positive_review.


---

Comment by mariah created at 2011-06-23 18:31:45

I must have forgotten to do 'sage -b' when I tried before.  Apologies
for the noise.

This time when I applied the patch (and did 'sage -b') the code in the
ticket description ran for 30 CPU minutes without an increase in memory.
I also did 'make testlong' and all tests passed.

Positive review!


---

Comment by jdemeyer created at 2011-06-23 21:15:39

The commit message

```
Trac 114666666x memleaks in singular.pyx
```

looks a bit odd...

Also, if you change the "copyright" message, at least make it such that it looks like [http://sagemath.org/doc/developer/conventions.html#headings-of-sage-library-code-files](http://sagemath.org/doc/developer/conventions.html#headings-of-sage-library-code-files)


---

Comment by jdemeyer created at 2011-06-23 21:15:39

Changing status from positive_review to needs_work.


---

Attachment

New version with correct commit message and copyright.


---

Comment by jpflori created at 2011-06-24 07:47:02

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2011-06-24 07:48:06

Just apply:

trac_11468-memleaks_singular.patch


---

Comment by bober created at 2011-07-25 19:17:25

Changing status from needs_review to positive_review.


---

Comment by bober created at 2011-07-25 19:17:25

This patch looks good to me. I don't get a leak with either the example or the code I was running that lead me to this ticket, and the changes that the patch makes seem simple and sensible.


---

Comment by jdemeyer created at 2011-07-28 10:25:16

Resolution: fixed
