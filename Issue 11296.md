# Issue 11296: Memleak when using elliptic curves

archive/issues_011296.json:
```json
{
    "body": "Assignee: @rlmill\n\nCC:  jpflori @burcin\n\nKeywords: memleak, elliptic curves\n\nUsing the following piece of code makes the memory footprint of sage \n grow indefinitely: \n\n\nsage: K = GF(1<<50,'t') \n sage: j = K.random_element() \n sage: while 1: \n ....: \u00a0 \u00a0E = EllipticCurve(j=j) \n ....: \u00a0 \u00a0del E \n ....: \n\n\nThis seems to be less dramatic with finite fields of char != 2 and \ninexistant for ZZ and QQ.\n\nHowever this makes big computations involving different elliptic curves quite inpractical.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11468\n\n",
    "created_at": "2011-06-13T16:44:06Z",
    "labels": [
        "component: memleak",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Memleak when using elliptic curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11296",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
Assignee: @rlmill

CC:  jpflori @burcin

Keywords: memleak, elliptic curves

Using the following piece of code makes the memory footprint of sage 
 grow indefinitely: 


sage: K = GF(1<<50,'t') 
 sage: j = K.random_element() 
 sage: while 1: 
 ....:    E = EllipticCurve(j=j) 
 ....:    del E 
 ....: 


This seems to be less dramatic with finite fields of char != 2 and 
inexistant for ZZ and QQ.

However this makes big computations involving different elliptic curves quite inpractical.


Issue created by migration from https://trac.sagemath.org/ticket/11468





---

archive/issue_comments_124355.json:
```json
{
    "body": "Changing keywords from \"memleak, elliptic curves\" to \"memleak, libsingular\".",
    "created_at": "2011-06-15T17:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124355",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing keywords from "memleak, elliptic curves" to "memleak, libsingular".



---

archive/issue_comments_124356.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2011-06-15T17:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124356",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_124357.json:
```json
{
    "body": "Calling gc.collect() just after the creation prevents the memory problem.\n\nBut it does not if called later.",
    "created_at": "2011-06-15T19:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124357",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Calling gc.collect() just after the creation prevents the memory problem.

But it does not if called later.



---

archive/issue_comments_124358.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-06-15T22:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124358",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_124359.json:
```json
{
    "body": "I finally found the memleaks in different si2sa_* functions.\n\nPotential fix provided.",
    "created_at": "2011-06-15T22:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124359",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I finally found the memleaks in different si2sa_* functions.

Potential fix provided.



---

archive/issue_comments_124360.json:
```json
{
    "body": "The patch does not seem to fix the reported problem.  I applied the patch to sage-4.7.1.alpha2, did 'sage -b', yet I still see memory\nincreasing when I run the code in the ticket description.",
    "created_at": "2011-06-22T13:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124360",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

The patch does not seem to fix the reported problem.  I applied the patch to sage-4.7.1.alpha2, did 'sage -b', yet I still see memory
increasing when I run the code in the ticket description.



---

archive/issue_comments_124361.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-06-22T13:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124361",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_124362.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2011-06-22T16:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124362",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_124363.json:
```json
{
    "body": "I just retested it and it seems to fix the memleak for me:\n\nno increase in memory footprint after 30 minutes.\n\nWhich code did you run ?\n\nThe one in the tickect description or the one on sage-support post ?\n\nBecause there are other memleaks involved when using EllipticCurve class.\n\nSee #11495 and #11521 for example.",
    "created_at": "2011-06-22T16:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124363",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I just retested it and it seems to fix the memleak for me:

no increase in memory footprint after 30 minutes.

Which code did you run ?

The one in the tickect description or the one on sage-support post ?

Because there are other memleaks involved when using EllipticCurve class.

See #11495 and #11521 for example.



---

archive/issue_comments_124364.json:
```json
{
    "body": "Replying to [comment:9 jpflori]:\n> I just retested it and it seems to fix the memleak for me:\n> \n> no increase in memory footprint after 30 minutes.\n> \n> Which code did you run ?\n> \n> The one in the tickect description or the one on sage-support post ?\n\n\nI used the code in the ticket description.\n\nI will try again.",
    "created_at": "2011-06-22T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124364",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Replying to [comment:9 jpflori]:
> I just retested it and it seems to fix the memleak for me:
> 
> no increase in memory footprint after 30 minutes.
> 
> Which code did you run ?
> 
> The one in the tickect description or the one on sage-support post ?


I used the code in the ticket description.

I will try again.



---

archive/issue_comments_124365.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-06-22T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124365",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_124366.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-06-23T18:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124366",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_124367.json:
```json
{
    "body": "I must have forgotten to do 'sage -b' when I tried before.  Apologies\nfor the noise.\n\nThis time when I applied the patch (and did 'sage -b') the code in the\nticket description ran for 30 CPU minutes without an increase in memory.\nI also did 'make testlong' and all tests passed.\n\nPositive review!",
    "created_at": "2011-06-23T18:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124367",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

I must have forgotten to do 'sage -b' when I tried before.  Apologies
for the noise.

This time when I applied the patch (and did 'sage -b') the code in the
ticket description ran for 30 CPU minutes without an increase in memory.
I also did 'make testlong' and all tests passed.

Positive review!



---

archive/issue_comments_124368.json:
```json
{
    "body": "The commit message\n\n```\nTrac 114666666x memleaks in singular.pyx\n```\nlooks a bit odd...\n\nAlso, if you change the \"copyright\" message, at least make it such that it looks like [http://sagemath.org/doc/developer/conventions.html#headings-of-sage-library-code-files](http://sagemath.org/doc/developer/conventions.html#headings-of-sage-library-code-files)",
    "created_at": "2011-06-23T21:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124368",
    "user": "https://github.com/jdemeyer"
}
```

The commit message

```
Trac 114666666x memleaks in singular.pyx
```
looks a bit odd...

Also, if you change the "copyright" message, at least make it such that it looks like [http://sagemath.org/doc/developer/conventions.html#headings-of-sage-library-code-files](http://sagemath.org/doc/developer/conventions.html#headings-of-sage-library-code-files)



---

archive/issue_comments_124369.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-06-23T21:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124369",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_124370.json:
```json
{
    "body": "Attachment [trac_11468-memleaks_singular.patch](tarball://root/attachments/some-uuid/ticket11468/trac_11468-memleaks_singular.patch) by jpflori created at 2011-06-24 07:46:43\n\nNew version with correct commit message and copyright.",
    "created_at": "2011-06-24T07:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124370",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_11468-memleaks_singular.patch](tarball://root/attachments/some-uuid/ticket11468/trac_11468-memleaks_singular.patch) by jpflori created at 2011-06-24 07:46:43

New version with correct commit message and copyright.



---

archive/issue_comments_124371.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-06-24T07:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124371",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_124372.json:
```json
{
    "body": "Just apply:\n\ntrac_11468-memleaks_singular.patch",
    "created_at": "2011-06-24T07:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124372",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Just apply:

trac_11468-memleaks_singular.patch



---

archive/issue_comments_124373.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-07-25T19:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124373",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_124374.json:
```json
{
    "body": "This patch looks good to me. I don't get a leak with either the example or the code I was running that lead me to this ticket, and the changes that the patch makes seem simple and sensible.",
    "created_at": "2011-07-25T19:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124374",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

This patch looks good to me. I don't get a leak with either the example or the code I was running that lead me to this ticket, and the changes that the patch makes seem simple and sensible.



---

archive/issue_events_029824.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-27T13:35:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "milestone": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11296#event-29824"
}
```



---

archive/issue_comments_124375.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-07-28T10:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11296#issuecomment-124375",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_029825.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-28T10:25:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11296",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11296#event-29825"
}
```
