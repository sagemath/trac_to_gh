# Issue 16821: Add abelian_vectors and abelian_complexity method to finite words

Issue created by migration from https://trac.sagemath.org/ticket/17058

Original creator: slabbe

Original creation time: 2014-09-27 20:56:55

CC:  vdelecroix sstarosta




---

Comment by slabbe created at 2014-09-27 21:46:49

Changing status from new to needs_review.


---

Comment by slabbe created at 2014-09-27 21:46:49

New commits:


---

Comment by vdelecroix created at 2014-09-28 08:48:53

Could we use this ticket to deprecate `parikh_vector` and use `abelianization` or `abelian_image` instead?

Vincent


---

Comment by vdelecroix created at 2014-09-28 09:12:13

Hello,

It is weird to call a method `alphabet` on the word which is not the alphabet of the parent. Moreover, there is already the method `letters` which does the job. So please use `letters` if you need it.

Now about your design choice, if the alphabet of the parent is {a,b,c} and my word is abbab then the abelianization must be a vector of length 3. With your branch:

```
sage: W = Words([0,1,2])
sage: w = W([0,1,1,0,1,2,0,2,0,2])
sage: w.abelian_vectors(3)
{(1, 0, 2), (1, 1, 1), (1, 2, 0), (2, 0, 1)}
sage: w[:5].abelian_vectors(3)  # word on 0,1
{(1, 2)}
sage: w[5:].abelian_vectors(3)  # word on 0,2
{(1, 2), (2, 1)}
```

which is completely crazy!

For the algorithm, it would be faster to deal only with integers because

```
sage: tuple(my_list)
```

is much faster than

```
sage: tuple(my_dict[a] for a in alphabet)
```

i.e. I would initialize `abelian` as a list of length the cardinality of the alphabet and then

```
    abelian[rank[start.next()]] += 1
    abelian[rank[stop.next()]]  -= 1
    S.add(tuple(abelian))
```

where `rank` would be a dictionnary `letter -> index`.

Cheers
Vincent


---

Comment by vdelecroix created at 2014-09-28 09:12:13

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2014-09-28 20:01:16

I often get the following error while working on this ticket. Is it the same issue that was fixed in #17056?


```
sage -t finite_word.py
**********************************************************************
File "finite_word.py", line 6053, in sage.combinat.words.finite_word.FiniteWord_class.apply_permutation_to_positions
Failed example:
    w.apply_permutation_to_positions(PermutationGroupElement([2,1,4,3]))
Expected:
    word: badc
Got:
    python(17649) malloc: *** error for object 0xff37a70: double free
    *** set a breakpoint in malloc_error_break to debug
    word: badc
**********************************************************************
1 item had failures:
   1 of   8 in sage.combinat.words.finite_word.FiniteWord_class.apply_permutation_to_positions
    [1142 tests, 1 failure, 16.64 s]
----------------------------------------------------------------------
sage -t finite_word.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by git created at 2014-09-28 20:14:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2014-09-28 20:15:10

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2014-09-28 21:28:15

Replying to [comment:5 slabbe]:
> I often get the following error while working on this ticket. Is it the same issue that was fixed in #17056?

Yes it is! It is quite strange that this did not occur before.


---

Comment by vdelecroix created at 2014-09-28 22:07:08

Hi,

I got

```
sage: w = Word([0,1,0])
sage: w.abelian_complexity(5)
Traceback (most recent call last):
...
StopIteration: 
```

where I would expect a `0`.

stupid coercion is around

```
sage: timeit("1 < Infinity")
625 loops, best of 3: 12.6 µs per loop
sage: timeit("1 < float('inf')")
625 loops, best of 3: 803 ns per loop
```

but I guess it is not critical here.

What do you think of

```
sage: from itertools import count
sage: w = Word(count(), alphabet=NN)
sage: w[:2].abelian_vectors(2)
{(1, 1)}
sage: w[:3].abelian_vectors(2)
{(0, 1, 1), (1, 1, 0)}
sage: w[:4].abelian_vectors(2)
{(0, 0, 1, 1), (0, 1, 1, 0), (1, 1, 0, 0)}
```

I think this is very bad. I would rather raise an Error when the alphabet is infinite (in the very same way `abelian_vector` does, by the way). But at least `.abelian_complexity()` gets right.

Are you sure that the ``@`cached_method` is needed on `.letters()`? It seems used only when the alphabet is infinite... in which case the user is doing something wrong.

The convention for the header of methods is "Return bla" instead of "Returns bla". See [developer guide](http://www.sagemath.org/doc/developer/coding_basics.html#docstring-markup-with-rest-and-sphinx) about the header:

```
A one-sentence description of the function, followed by a blank line and
ending in a period. It prescribes the function or method’s effect as a
command (“Do this”, “Return that”), not as a description; e.g. don’t
write “Returns the pathname ...”.
```


Be careful, you introduced several trailing whitespaces.

Vincent


---

Comment by vdelecroix created at 2014-09-28 22:07:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-09-29 20:12:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2014-09-29 20:33:24

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2014-09-29 20:58:13

I pushed a commit at `u/vdelecroix/17058` with few optimizations and the things that I describe below.

I do not feel very comfortable with your note and the examples. The reasonable way to get the Abelian complexity from 0 to n is actually to build the language. Certainly not to call `w.abelian_complexity` n times. A version of the suffix tree in which we can compute things on the fly would be really helpful (as it is trivial to update the abelian vectors along the tree)! Do you mind if we remove the `.. NOTE:`?

For the `INPUT` section. It is needed only if the arguments are not described in the documentation or if they are quite subtle. And whatever is inside `self` can not appear there.

As a sided note, I guess we have a global problem with alphabet managed at the level of word

```
sage: W = Words()
sage: w = W([0,1,2,3,4,5,6,7,8])
sage: w[:4].to_integer_list()
[0, 1, 2, 3]
sage: w[1:5].to_integer_list()
[0, 1, 2, 3]
```


Tell me what you think.

Vincent


---

Comment by vdelecroix created at 2014-09-29 20:58:13

Changing status from needs_review to needs_info.


---

Comment by slabbe created at 2014-09-29 21:46:43

> Do you mind if we remove the `.. NOTE:`?

Okay.

> For the `INPUT` section. It is needed only if the arguments are not described in the documentation or if they are quite subtle. And whatever is inside `self` can not appear there.

I thought the INPUT block was always necessary...

> As a sided note, I guess we have a global problem with alphabet managed at the level of word. Tell me what you think.

There are a lot of methods of `FiniteWord_class` that do not need the existence of a parent alphabet. That was one of the first clean up that we did back in 2009: get rid of things that were not necesary.

But then, there are also a lot of methods of `FiniteWord_class` that *needs* an alphabet. At that time, we choose to allow the user to use such methods without having previously defined an alphabet. But, I think we were wrong. If a method needs an alphabet to work reasonably, we should just raise an error if there were no alphabet assigned to the parent. This is in accordance to the way I fixed the `abelian_vector` method and added a deprecation to the alphabet input.


---

Comment by slabbe created at 2014-09-30 07:15:56

New commits:


---

Comment by vdelecroix created at 2014-09-30 08:17:25

Replying to [comment:15 slabbe]:
> > Do you mind if we remove the `.. NOTE:`?
> 
> Okay.

Cool!
 
> > For the `INPUT` section. It is needed only if the arguments are not described in the documentation or if they are quite subtle. And whatever is inside `self` can not appear there.
> 
> I thought the INPUT block was always necessary...

None of the section of the docstring is mandatory except `EXAMPLES` or `TESTS`. In particular a function whose header is `Return the number of factors of length n` does not need an `INPUT` nor an `OUTPUT` section. The docstring are only used for documentation (and doctesting): the simplest the best!

I am having a last look.

Vincent


---

Comment by git created at 2014-09-30 08:48:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-09-30 08:49:21

Hello,

A last commit for optimization, including a much faster implementation of `.letters()` in `WordDatatype_char`. If you like it, you can then set to positive review.

Vincent


---

Comment by slabbe created at 2014-09-30 19:18:46

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2014-09-30 20:09:50

New commits:


---

Comment by slabbe created at 2014-09-30 20:29:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-01 15:30:41

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-10-01 15:30:41

Merge conflict (probably with #17021)


---

Comment by git created at 2014-10-01 21:31:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2014-10-01 21:36:35

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2014-10-02 06:47:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-03 22:37:30

Resolution: fixed
