# Issue 26089: Upgrade networkx to 2.2 and add self tests

Issue created by migration from https://trac.sagemath.org/ticket/26326

Original creator: tmonteil

Original creation time: 2018-09-21 12:54:31

CC:  embray fbissey @timokau

Note that self tests require `nose` which is optional only.

Tarball:


---

Comment by git created at 2018-09-21 13:25:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-09-21 13:27:06

Changing status from new to needs_review.


---

Comment by tmonteil created at 2018-09-21 13:41:44

There are issues with random graphs provided by networkx:


```
sage: graphs.RandomBarabasiAlbert(50,2)
ValueError: 71598026902468055907350337076908659440L cannot be used to generate a random.Random instance
```



---

Comment by tmonteil created at 2018-09-21 13:41:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-09-21 14:36:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-09-21 14:42:00

Erik, there is an issue about the nature of random seeds provided by `current_randstate` during doctests that is not of the same type that the ones provided during a normal session. It might come from #24508, any idea on how to fix that ?


---

Comment by embray created at 2018-09-21 15:28:05

I see; the relevant code in networkx is here: https://github.com/networkx/networkx/blob/3466b800ef241cdfe76bae875fac50ac1ab54e02/networkx/utils/misc.py#L373

What I don't quite understand is why you changed this to `current_python` everywhere.  It should still accept a plain `int` as the RNG seed (I don't quite like how networkx uses "seed" to mean something else, but that's another question...)

I could offer a workaround, but first I want to make sure it's really necessary to make this change in Sage, because it doesn't seem like it should be necessary.  The release notes you linked to are unclear about what they thing the best practice should be.


---

Comment by tmonteil created at 2018-09-21 15:56:04

Replying to [comment:9 embray]:
> I see; the relevant code in networkx is here: https://github.com/networkx/networkx/blob/3466b800ef241cdfe76bae875fac50ac1ab54e02/networkx/utils/misc.py#L373
> 
> What I don't quite understand is why you changed this to `current_python` everywhere.  It should still accept a plain `int` as the RNG seed (I don't quite like how networkx uses "seed" to mean something else, but that's another question...)


The problem is that `current_randstate().seed()` provides longs, and apparently networkx does not like it:


```
sage: graphs.RandomBarabasiAlbert(50,2)
ValueError: 337906337582125808005456054818180223663L cannot be used to generate a random.Random instance
```


However it likes instances of `random.Random` objects which are provided by `current_randstate().python_random()`.

Maybe should i use `current_randstate().c_random()` which is a 31bit-only integer, or `current_randstate().python_random() % sys.maxint`.

I guess that they do not support long because they are going to support Python 3 only.

> I could offer a workaround, but first I want to make sure it's really necessary to make this change in Sage, because it doesn't seem like it should be necessary.  The release notes you linked to are unclear about what they thing the best practice should be.


---

Comment by saraedum created at 2018-10-10 07:40:50

So what's the status of this ticket now? Does this need review again or do you still want to change something here embray?


---

Comment by arojas created at 2018-10-14 13:57:07

With this patch I'm getting lots of test suite errors on Arch:

ValueError: <sage.cpython._py2_random.Random object at 0x561e012e8f50> cannot be used to generate a random.Random instance

Running the test code directly in Sage works fine. Using c_random() instead of python_random() makes the tests pass.


---

Comment by arojas created at 2018-10-14 17:01:25

Replying to [comment:14 arojas]:
> With this patch I'm getting lots of test suite errors on Arch:
> 
> ValueError: <sage.cpython._py2_random.Random object at 0x561e012e8f50> cannot be used to generate a random.Random instance
> 
> Running the test code directly in Sage works fine. Using c_random() instead of python_random() makes the tests pass.

Actually no, there are still some (fewer) failures


```
File "/usr/lib/python2.7/site-packages/sage/graphs/graph_plot.py", line 1286, in sage.graphs.graph_plot.GraphPlot.layout_tree
Failed example:
    T.show(layout='tree',tree_orientation='up') # indirect doctest
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_plot.GraphPlot.layout_tree[1]>", line 1, in <module>
        T.show(layout='tree',tree_orientation='up') # indirect doctest
      File "/usr/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 19265, in show
        return self.graphplot(**plot_kwds).show(**kwds)
      File "/usr/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18867, in graphplot
        return GraphPlot(graph=self, options=options)
      File "/usr/lib/python2.7/site-packages/sage/graphs/graph_plot.py", line 256, in __init__
        self.set_pos()
      File "/usr/lib/python2.7/site-packages/sage/graphs/graph_plot.py", line 340, in set_pos
        self._pos = self._graph.layout(**self._options)
      File "/usr/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18187, in layout
        pos = getattr(self, "layout_%s"%layout)(dim = dim, **options)
      File "/usr/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18443, in layout_tree
        raise RuntimeError("Cannot use tree layout on this graph: "
    RuntimeError: Cannot use tree layout on this graph: self.is_tree() returns False.
```


Again, running the code inside a Sage session works fine


---

Comment by @timokau created at 2018-10-24 15:13:12

I'm getting the same errors as Antonio on nix.


---

Comment by embray created at 2018-10-26 13:27:25

> I guess that they do not support long because they are going to support Python 3 only.

That doesn't really make sense given that the Python 3 int type is the Python 2 long type.  Probably more likely it needs to be modulo `sys.max_size`.


---

Comment by git created at 2018-10-26 15:59:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-10-26 16:03:30

I would have preferred to rely on `random.Random` seeds, but let us move forward with that.


---

Comment by tmonteil created at 2018-10-26 16:03:30

Changing status from needs_work to needs_review.


---

Comment by @timokau created at 2018-10-27 10:53:00

I'm still getting:


```
File "/nix/store/9h32ccgbsdjbbiw5y9lvc338w5fbskkh-sage-src-8.4/src/sage/graphs/generators/degree_sequence.py", line 153, in sage.graphs.generators.degree_sequence.DegreeSequenceConfigurationModel
Failed example:
    G = graphs.DegreeSequenceConfigurationModel([1,1])
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.degree_sequence.DegreeSequenceConfigurationModel[0]>", line 1, in <module>
        G = graphs.DegreeSequenceConfigurationModel([Integer(1),Integer(1)])
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/graphs/generators/degree_sequence.py", line 177, in DegreeSequenceConfigurationModel
        return Graph(networkx.configuration_model([int(i) for i in deg_sequence], seed=seed), loops=True, multiedges=True, sparse=True)
      File "<decorator-gen-154>", line 2, in configuration_model
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/networkx/utils/decorators.py", line 459, in _random_state
        random_state = create_py_random_state(random_state_arg)
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/networkx/utils/misc.py", line 409, in create_py_random_state
        raise ValueError(msg % random_state)
    ValueError: 138300676084728942938177272249092044107L cannot be used to generate a random.Random instance
**********************************************************************
File "/nix/store/9h32ccgbsdjbbiw5y9lvc338w5fbskkh-sage-src-8.4/src/sage/graphs/generators/degree_sequence.py", line 164, in sage.graphs.generators.degree_sequence.DegreeSequenceConfigurationModel
Failed example:
    G = graphs.DegreeSequenceConfigurationModel([3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3])
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.degree_sequence.DegreeSequenceConfigurationModel[2]>", line 1, in <module>
        G = graphs.DegreeSequenceConfigurationModel([Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3),Integer(3)])
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/graphs/generators/degree_sequence.py", line 177, in DegreeSequenceConfigurationModel
        return Graph(networkx.configuration_model([int(i) for i in deg_sequence], seed=seed), loops=True, multiedges=True, sparse=True)
      File "<decorator-gen-154>", line 2, in configuration_model
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/networkx/utils/decorators.py", line 459, in _random_state
        random_state = create_py_random_state(random_state_arg)
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/networkx/utils/misc.py", line 409, in create_py_random_state
        raise ValueError(msg % random_state)
    ValueError: 41203442069597040437188274198544025403L cannot be used to generate a random.Random instance
**********************************************************************
File "/nix/store/9h32ccgbsdjbbiw5y9lvc338w5fbskkh-sage-src-8.4/src/sage/graphs/generators/degree_sequence.py", line 221, in sage.graphs.generators.degree_sequence.DegreeSequenceExpected
Failed example:
    G = graphs.DegreeSequenceExpected([1,2,3,2,3])
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.degree_sequence.DegreeSequenceExpected[0]>", line 1, in <module>
        G = graphs.DegreeSequenceExpected([Integer(1),Integer(2),Integer(3),Integer(2),Integer(3)])
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/sage/graphs/generators/degree_sequence.py", line 235, in DegreeSequenceExpected
        return Graph(networkx.expected_degree_graph([int(i) for i in deg_sequence], seed=seed), loops=True)
      File "<decorator-gen-158>", line 2, in expected_degree_graph
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/networkx/utils/decorators.py", line 459, in _random_state
        random_state = create_py_random_state(random_state_arg)
      File "/nix/store/44zw4cgfi89wcyqg4p24yrs29hys03dj-python-2.7.15-env/lib/python2.7/site-packages/networkx/utils/misc.py", line 409, in create_py_random_state
        raise ValueError(msg % random_state)
    ValueError: 138300676084728942938177272249092044107L cannot be used to generate a random.Random instance
```



---

Comment by git created at 2018-10-27 13:36:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2018-10-27 13:39:13

Oops, my bad, i forgot that file (i remembered about two files only). Should be OK now.


---

Comment by arojas created at 2018-12-27 22:15:16

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2018-12-27 22:15:16

Needs rebasing for 8.6.beta0


---

Comment by git created at 2019-01-05 11:55:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2019-01-05 11:58:43

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2019-01-05 11:58:43

Thanks for noticing.


---

Comment by tmonteil created at 2019-01-05 12:01:03

Note that Debian `buster` uses networkx 2.2, so i guess this should enter Sage 8.6, see https://packages.debian.org/buster/python-networkx


---

Comment by vbraun created at 2019-01-05 13:48:52

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-01-06 02:26:13

Replying to [comment:17 embray]:
> > I guess that they do not support long because they are going to support Python 3 only.
> 
> That doesn't really make sense given that the Python 3 int type is the Python 2 long type.  Probably more likely it needs to be modulo `sys.max_size`.

Perhaps it's the same issue as I've noticed with networkx before, and even fixed some of it. Basically, they don't quite respect the Python's numerical tower, if it's extended, say by numpy, or Sage.
See https://github.com/networkx/networkx/issues/2799

Basically they did dispatch on types not quite right, e.g. `isinstance(foo,int)` instead of `isinstance(foo,numbers.Integral)`


---

Comment by vbraun created at 2019-01-06 09:39:26

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-01-06 09:39:26

Doctests fail on 32 bit: http://build.sagemath.org/#/builders/15/builds/10/steps/9/logs/stdio


---

Comment by git created at 2019-01-06 22:26:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2019-01-06 22:45:19

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2019-01-06 23:06:04

lets give it a try


---

Comment by vbraun created at 2019-01-06 23:06:04

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-01-10 10:32:52

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2019-01-10 10:32:52

on python3:

```
----> 1 sys.maxint

AttributeError: module 'sys' has no attribute 'maxint'
```


*EDIT*:

sys.maxsize is the correct replacement, I think

https://stackoverflow.com/questions/13795758/what-is-sys-maxint-in-python-3


---

Comment by dimpase created at 2019-01-10 10:44:12

that's right, sys.maxsize works for py3 and py2. Who's going to update this?


---

Comment by dimpase created at 2019-01-10 11:33:01

New commits:


---

Comment by dimpase created at 2019-01-10 11:33:01

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-01-10 12:01:16

tests pass on py2. 

On py3 there are 6 different formatting/ordering-induced test failures in ` src/sage/graphs/generators/random.py`. I suppose this is for another ticket.


---

Comment by dimpase created at 2019-01-10 12:01:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-10 17:26:57

Resolution: fixed


---

Comment by Konrad127123 created at 2019-02-10 22:06:01

This breaks building with `SAGE_CHECK="yes"`, see #27253.
