# Issue 22396: Pari default stack size results in huge physical memory commit after fork on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-03-17 17:09:00

CC:  jdemeyer

Keywords: days85 windows cygwin pari mmap

It turns out #21582 causes big problems for fork on Cygwin.  This is due to an implementation detail of how Cygwin handles copy-on-write private mappings when forking.  A fact that might, unfortunately, be difficult to avoid.  The problem with this on Cygwin is that, while Windows does not commit pages to physical memory until they are accessed, they _do_ become committed upon any access (even reads, when they haven't already been written to).

So when a process with a private mmap is forked, it loops over all pages in the mmap'd region and copies them into the child's copy of the mmap'd region.  This results in committing physical memory on both the parent and the child, even for pages that haven't been written to yet.

TL;DR, if there's a huge private|anonymous mmap in a process, and that process is forked, it will commit the full size of the mmap to memory in both the parent and child processes.

This is a big problem in Sage since we set a very large default stack size for Pari.  This was not a problem prior to #21582, since Pari used the MAP_NORESERVE flag which circumvents this issue (only dirty pages need to be copied).  The changes in #21582 make sense for Linux, but for Cygwin the opposite is true.  Different but unfortunate implementation details on both platforms.

The best way forward is to partially revert #21582 for _Cygwin only_.  That is, keep the current behavior on Linux and other platforms, and restore the old behavior just on Cygwin.


---

Comment by embray created at 2017-03-17 19:14:18

The additional patch I've attached seems to fix this, but I would like to do more testing to see if any more work is needed.

This definitely fixes the immediate problem of memory being eaten up after `fork()`, but I don't know if there are any other implications for these changes on Cygwin (I suspect the rest is fine, however).
----
New commits:


---

Comment by embray created at 2017-03-17 23:22:12

Per jdemeyer it might be fine to simplify this by including `MAP_NORESERVE` on all platforms that support it.  Now that `PROT_NONE` is used I think the `MAP_NORESERVE` should be harmless on Linux (though I'd like to know a way to check that...)


---

Comment by jdemeyer created at 2017-03-18 06:56:05

Replying to [comment:2 embray]:
> Now that `PROT_NONE` is used I think the `MAP_NORESERVE` should be harmless on Linux (though I'd like to know a way to check that...)

If you have a patch ready, I can test it.


---

Comment by jdemeyer created at 2017-03-21 16:12:35

Do you want me to report this upstream?


---

Comment by git created at 2017-03-21 16:32:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-03-21 16:33:05

I just updated the patch with your suggestion. I'll report it now.


---

Comment by jdemeyer created at 2017-03-23 10:46:02

Can you check if it suffices to add `MAP_NORESERVE` only to the `PROT_NONE` allocations? That would be more in line with the intent of the current code. See also my answer to the PARI bug.


---

Comment by jdemeyer created at 2017-03-23 10:55:41

Beware of #22675: we might need to synchronize these tickets.


---

Comment by embray created at 2017-03-23 11:08:31

I can update these after #22675.


---

Comment by embray created at 2017-03-23 11:13:02

Hm, for some reason, while I got Bill's initial reply to my report I didn't get your response in my e-mail.  Maybe I need to explicitly subscribe to updates on the bug...

Yeah, I can try making that change.  I don't see what difference it would make--what harm does it have on the other allocations?  But if you think it will help I can try it.  It _should_ be fine.


---

Comment by jdemeyer created at 2017-04-03 11:05:05

Replying to [comment:9 jdemeyer]:
> Can you check if it suffices to add `MAP_NORESERVE` only to the `PROT_NONE` allocations? That would be more in line with the intent of the current code. See also my answer to the PARI bug.

*ping*


---

Comment by embray created at 2017-04-03 12:26:10

Right. Working on it.


---

Comment by embray created at 2017-04-03 12:48:39

A minimal example in C seems to indicate that this would not work.  Perhaps it's a limitation of Cygwin and/or Windows, but calling `mmap(..., PROT_NONE, MAP_NORESERVE)` at the address of a previous `mmap(NULL, ..., PROT_READ|PROT_WRITE, ...)` without `MAP_NORESERVE` exhibits the same bug on fork.


---

Comment by jdemeyer created at 2017-04-03 13:55:37

Thanks for testing.

I will push a new patch here, hang on.


---

Comment by jdemeyer created at 2017-04-03 15:32:52

Does this work for you?
----
New commits:


---

Comment by jdemeyer created at 2017-04-04 08:48:00

Hang on, I will add a check for the return value of `mmap()`.


---

Comment by git created at 2017-04-04 08:51:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-04-04 15:29:14

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-04-04 15:30:25

Does it work on Cygwin?


---

Comment by embray created at 2017-04-04 15:30:36

It looks like the explicit munmap before remapping works.  I don't exactly see what advantage this has over my original patch but this is fine too.


---

Comment by embray created at 2017-04-04 15:30:36

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-04-05 13:34:03

Accepted by upstream.


---

Comment by vbraun created at 2017-04-05 19:40:07

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-04-05 19:40:07

Reviewer name missing...


---

Comment by jdemeyer created at 2017-04-06 08:07:56

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-04-07 22:24:04

Resolution: fixed
