# Issue 22396: Pari default stack size results in huge physical memory commit after fork on Cygwin

archive/issues_022396.json:
```json
{
    "body": "CC:  @jdemeyer\n\nKeywords: days85 windows cygwin pari mmap\n\nIt turns out #21582 causes big problems for fork on Cygwin.  This is due to an implementation detail of how Cygwin handles copy-on-write private mappings when forking.  A fact that might, unfortunately, be difficult to avoid.  The problem with this on Cygwin is that, while Windows does not commit pages to physical memory until they are accessed, they *do* become committed upon any access (even reads, when they haven't already been written to).\n\nSo when a process with a private mmap is forked, it loops over all pages in the mmap'd region and copies them into the child's copy of the mmap'd region.  This results in committing physical memory on both the parent and the child, even for pages that haven't been written to yet.\n\nTL;DR, if there's a huge private|anonymous mmap in a process, and that process is forked, it will commit the full size of the mmap to memory in both the parent and child processes.\n\nThis is a big problem in Sage since we set a very large default stack size for Pari.  This was not a problem prior to #21582, since Pari used the MAP_NORESERVE flag which circumvents this issue (only dirty pages need to be copied).  The changes in #21582 make sense for Linux, but for Cygwin the opposite is true.  Different but unfortunate implementation details on both platforms.\n\nThe best way forward is to partially revert #21582 for *Cygwin only*.  That is, keep the current behavior on Linux and other platforms, and restore the old behavior just on Cygwin.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22633\n\n",
    "created_at": "2017-03-17T17:09:00Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Pari default stack size results in huge physical memory commit after fork on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22396",
    "user": "@embray"
}
```
CC:  @jdemeyer

Keywords: days85 windows cygwin pari mmap

It turns out #21582 causes big problems for fork on Cygwin.  This is due to an implementation detail of how Cygwin handles copy-on-write private mappings when forking.  A fact that might, unfortunately, be difficult to avoid.  The problem with this on Cygwin is that, while Windows does not commit pages to physical memory until they are accessed, they *do* become committed upon any access (even reads, when they haven't already been written to).

So when a process with a private mmap is forked, it loops over all pages in the mmap'd region and copies them into the child's copy of the mmap'd region.  This results in committing physical memory on both the parent and the child, even for pages that haven't been written to yet.

TL;DR, if there's a huge private|anonymous mmap in a process, and that process is forked, it will commit the full size of the mmap to memory in both the parent and child processes.

This is a big problem in Sage since we set a very large default stack size for Pari.  This was not a problem prior to #21582, since Pari used the MAP_NORESERVE flag which circumvents this issue (only dirty pages need to be copied).  The changes in #21582 make sense for Linux, but for Cygwin the opposite is true.  Different but unfortunate implementation details on both platforms.

The best way forward is to partially revert #21582 for *Cygwin only*.  That is, keep the current behavior on Linux and other platforms, and restore the old behavior just on Cygwin.

Issue created by migration from https://trac.sagemath.org/ticket/22633





---

archive/issue_comments_311837.json:
```json
{
    "body": "The additional patch I've attached seems to fix this, but I would like to do more testing to see if any more work is needed.\n\nThis definitely fixes the immediate problem of memory being eaten up after `fork()`, but I don't know if there are any other implications for these changes on Cygwin (I suspect the rest is fine, however).\n----\nNew commits:",
    "created_at": "2017-03-17T19:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311837",
    "user": "@embray"
}
```

The additional patch I've attached seems to fix this, but I would like to do more testing to see if any more work is needed.

This definitely fixes the immediate problem of memory being eaten up after `fork()`, but I don't know if there are any other implications for these changes on Cygwin (I suspect the rest is fine, however).
----
New commits:



---

archive/issue_comments_311838.json:
```json
{
    "body": "Per jdemeyer it might be fine to simplify this by including `MAP_NORESERVE` on all platforms that support it.  Now that `PROT_NONE` is used I think the `MAP_NORESERVE` should be harmless on Linux (though I'd like to know a way to check that...)",
    "created_at": "2017-03-17T23:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311838",
    "user": "@embray"
}
```

Per jdemeyer it might be fine to simplify this by including `MAP_NORESERVE` on all platforms that support it.  Now that `PROT_NONE` is used I think the `MAP_NORESERVE` should be harmless on Linux (though I'd like to know a way to check that...)



---

archive/issue_comments_311839.json:
```json
{
    "body": "Replying to [comment:2 embray]:\n> Now that `PROT_NONE` is used I think the `MAP_NORESERVE` should be harmless on Linux (though I'd like to know a way to check that...)\n\nIf you have a patch ready, I can test it.",
    "created_at": "2017-03-18T06:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311839",
    "user": "@jdemeyer"
}
```

Replying to [comment:2 embray]:
> Now that `PROT_NONE` is used I think the `MAP_NORESERVE` should be harmless on Linux (though I'd like to know a way to check that...)

If you have a patch ready, I can test it.



---

archive/issue_comments_311840.json:
```json
{
    "body": "Do you want me to report this upstream?",
    "created_at": "2017-03-21T16:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311840",
    "user": "@jdemeyer"
}
```

Do you want me to report this upstream?



---

archive/issue_comments_311841.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-21T16:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311841",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_311842.json:
```json
{
    "body": "I just updated the patch with your suggestion. I'll report it now.",
    "created_at": "2017-03-21T16:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311842",
    "user": "@embray"
}
```

I just updated the patch with your suggestion. I'll report it now.



---

archive/issue_comments_311843.json:
```json
{
    "body": "Can you check if it suffices to add `MAP_NORESERVE` only to the `PROT_NONE` allocations? That would be more in line with the intent of the current code. See also my answer to the PARI bug.",
    "created_at": "2017-03-23T10:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311843",
    "user": "@jdemeyer"
}
```

Can you check if it suffices to add `MAP_NORESERVE` only to the `PROT_NONE` allocations? That would be more in line with the intent of the current code. See also my answer to the PARI bug.



---

archive/issue_comments_311844.json:
```json
{
    "body": "Beware of #22675: we might need to synchronize these tickets.",
    "created_at": "2017-03-23T10:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311844",
    "user": "@jdemeyer"
}
```

Beware of #22675: we might need to synchronize these tickets.



---

archive/issue_comments_311845.json:
```json
{
    "body": "I can update these after #22675.",
    "created_at": "2017-03-23T11:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311845",
    "user": "@embray"
}
```

I can update these after #22675.



---

archive/issue_comments_311846.json:
```json
{
    "body": "Hm, for some reason, while I got Bill's initial reply to my report I didn't get your response in my e-mail.  Maybe I need to explicitly subscribe to updates on the bug...\n\nYeah, I can try making that change.  I don't see what difference it would make--what harm does it have on the other allocations?  But if you think it will help I can try it.  It *should* be fine.",
    "created_at": "2017-03-23T11:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311846",
    "user": "@embray"
}
```

Hm, for some reason, while I got Bill's initial reply to my report I didn't get your response in my e-mail.  Maybe I need to explicitly subscribe to updates on the bug...

Yeah, I can try making that change.  I don't see what difference it would make--what harm does it have on the other allocations?  But if you think it will help I can try it.  It *should* be fine.



---

archive/issue_comments_311847.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Can you check if it suffices to add `MAP_NORESERVE` only to the `PROT_NONE` allocations? That would be more in line with the intent of the current code. See also my answer to the PARI bug.\n\n**ping**",
    "created_at": "2017-04-03T11:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311847",
    "user": "@jdemeyer"
}
```

Replying to [comment:9 jdemeyer]:
> Can you check if it suffices to add `MAP_NORESERVE` only to the `PROT_NONE` allocations? That would be more in line with the intent of the current code. See also my answer to the PARI bug.

**ping**



---

archive/issue_comments_311848.json:
```json
{
    "body": "Right. Working on it.",
    "created_at": "2017-04-03T12:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311848",
    "user": "@embray"
}
```

Right. Working on it.



---

archive/issue_comments_311849.json:
```json
{
    "body": "A minimal example in C seems to indicate that this would not work.  Perhaps it's a limitation of Cygwin and/or Windows, but calling `mmap(..., PROT_NONE, MAP_NORESERVE)` at the address of a previous `mmap(NULL, ..., PROT_READ|PROT_WRITE, ...)` without `MAP_NORESERVE` exhibits the same bug on fork.",
    "created_at": "2017-04-03T12:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311849",
    "user": "@embray"
}
```

A minimal example in C seems to indicate that this would not work.  Perhaps it's a limitation of Cygwin and/or Windows, but calling `mmap(..., PROT_NONE, MAP_NORESERVE)` at the address of a previous `mmap(NULL, ..., PROT_READ|PROT_WRITE, ...)` without `MAP_NORESERVE` exhibits the same bug on fork.



---

archive/issue_comments_311850.json:
```json
{
    "body": "Thanks for testing.\n\nI will push a new patch here, hang on.",
    "created_at": "2017-04-03T13:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311850",
    "user": "@jdemeyer"
}
```

Thanks for testing.

I will push a new patch here, hang on.



---

archive/issue_comments_311851.json:
```json
{
    "body": "Does this work for you?\n----\nNew commits:",
    "created_at": "2017-04-03T15:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311851",
    "user": "@jdemeyer"
}
```

Does this work for you?
----
New commits:



---

archive/issue_comments_311852.json:
```json
{
    "body": "Hang on, I will add a check for the return value of `mmap()`.",
    "created_at": "2017-04-04T08:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311852",
    "user": "@jdemeyer"
}
```

Hang on, I will add a check for the return value of `mmap()`.



---

archive/issue_comments_311853.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-04T08:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311853",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_311854.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-04T15:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311854",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_311855.json:
```json
{
    "body": "Does it work on Cygwin?",
    "created_at": "2017-04-04T15:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311855",
    "user": "@jdemeyer"
}
```

Does it work on Cygwin?



---

archive/issue_comments_311856.json:
```json
{
    "body": "It looks like the explicit munmap before remapping works.  I don't exactly see what advantage this has over my original patch but this is fine too.",
    "created_at": "2017-04-04T15:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311856",
    "user": "@embray"
}
```

It looks like the explicit munmap before remapping works.  I don't exactly see what advantage this has over my original patch but this is fine too.



---

archive/issue_comments_311857.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-04T15:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311857",
    "user": "@embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_311858.json:
```json
{
    "body": "Accepted by upstream.",
    "created_at": "2017-04-05T13:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311858",
    "user": "@jdemeyer"
}
```

Accepted by upstream.



---

archive/issue_comments_311859.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-05T19:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311859",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_311860.json:
```json
{
    "body": "Reviewer name missing...",
    "created_at": "2017-04-05T19:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311860",
    "user": "@vbraun"
}
```

Reviewer name missing...



---

archive/issue_comments_311861.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-04-06T08:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311861",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_311862.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-07T22:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22396#issuecomment-311862",
    "user": "@vbraun"
}
```

Resolution: fixed
