# Issue 28317: Scalar Field Restrictions

Issue created by migration from https://trac.sagemath.org/ticket/28554

Original creator: @DeRhamSource

Original creation time: 2019-10-03 17:40:55

CC:  tscrim egourgoulhon

Keywords: manifolds, scalar fields

How is a scalar field implemented which is split into different expressions in one particular chart?

Take for instance a scalar field `f` on the real line with standard "top" chart `x`, defined via `f(x)=0 for x<-1`, `f(x)=x+1 for -1<=x<0`, `f(x)=1-x for 0<=x<1` and `f(x)=0 for x>=1`. Currently, this is solved by using

```
f = M.scalar_field( unit_step(x + 1)*unit_step(1 - x)*(1 - abs(x)) )
```

(see #28519#comment:46).

This solution is quite unhandy and becomes even more so for more complicated scalar fields.

In this ticket, I try to solve this issue by adding a `set_restriction` method (similar to tensor fields) and modifying the `display` method.


---

Comment by @DeRhamSource created at 2019-10-04 09:31:44

Eric, in the ticket mentioned above, I suggested to display all _known_ expressions (on the greatest domain) and compute new expressions only if a particular chart is stated. It seems, there is no big difference to the previous code then, and the additional computation time might be negligible. What do you say? Is this a good compromise for you? Moreover, this approach seems to be the easiest one.

Or one implements an additional flag `display_all` for which the user is aware of additional computation time when using it?

However, do you have an example for me with much computation time to test my current algorithm how long it takes? Then, I can compare computation times. I have a feeling that the current algorithm is not that much slower than before because it starts from the top charts -- what happens anyway and, I guess, it only makes a significant difference if the scalar field is picewisely defined.


---

Comment by @DeRhamSource created at 2019-10-04 18:43:36

New commits:


---

Comment by @DeRhamSource created at 2019-10-04 18:50:06

I compared computation times.

**Before:**



```
...$ ./sage -t src/sage/manifolds/scalarfield.py 
too few successful tests, not using stored timings
Running doctests with ID 2019-10-04-19-03-38-e810720b.
Git branch: scalar_field_restrictions
Using --optional=build,dochtml,memlimit,python2,sage
Doctesting 1 file.
sage -t src/sage/manifolds/scalarfield.py
    [715 tests, 31.77 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 32.0 seconds
    cpu time: 33.2 seconds
    cumulative wall time: 31.8 seconds
```


**With this ticket:**


```
...$ ./sage -t src/sage/manifolds/scalarfield.py
too few successful tests, not using stored timings
Running doctests with ID 2019-10-04-20-45-12-df0ec794.
Git branch: scalar_field_restrictions
Using --optional=build,dochtml,memlimit,python2,sage
Doctesting 1 file.
sage -t src/sage/manifolds/scalarfield.py
    [735 tests, 34.59 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 34.8 seconds
    cpu time: 35.9 seconds
    cumulative wall time: 34.6 seconds
```


What do you say?


---

Comment by git created at 2019-10-04 19:03:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-06 13:23:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @DeRhamSource created at 2019-10-07 19:22:46

Please give me a short feedback so that I can work further on this.

This ticket is essential for my future implementation of characteristic classes (due to the `set_restriction` method).


---

Comment by @DeRhamSource created at 2019-10-07 19:58:57

Changing status from new to needs_info.


---

Comment by egourgoulhon created at 2019-10-26 15:46:46

Sorry for the delay. The ticket looks good; it clearly improves the treatment of restrictions of scalar fields. I have a few remarks:
- Regarding the change in `display()`, I agree that your solution is a good compromise
- I guess the method `_new_instance()` has been introduced in scalar fields by analogy of what is done for tensor fields. However in the present case, this method is quite trivial, since it returns a mere `type(self)(self.parent())`. IMHO this adds some code complexity (a new method) for not a big gain; for someone reading the code, 

```
   res = type(self)(self.parent())
```

  is at least as clear as

```
   res = self._new_instance()
```

   Moreover the latter involves one extra function call. Therefore I would suggest to revert this change.
- When you perform significant changes/additions to some file, I would suggest that you add your name to the `AUTHORS` field and copyright statement. For instance in `src/sage/mnifolds/scalarfield.py`, you could add to the `AUTHORS` field something like 

```
- Michael Jung (2019) : improve restrictions; make ``display()`` show all
  distinct expressions
```

  The same holds for #28628 and other tickets of #28519.


---

Comment by git created at 2019-10-27 13:29:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-27 13:31:08

Changing status from needs_info to needs_review.


---

Comment by @DeRhamSource created at 2019-10-27 13:31:08

Thanks! There we go. :)


---

Comment by egourgoulhon created at 2019-10-27 14:27:27

Changing status from needs_review to needs_work.


---

Comment by egourgoulhon created at 2019-10-27 14:27:27

With Sage 9.0.beta3, there are two failed doctests:

```
**********************************************************************
File "src/sage/manifolds/section.py", line 971, in sage.manifolds.section.Section.add_expr_from_subdomain
Failed example:
    sorted(s._components.values())[0]._comp[(1,)].display()
Expected:
    S^2 --> R
    on U: (x, y) |--> x
Got:
    S^2 --> R
    on U: (x, y) |--> x
    on W: (u, v) |--> u/(u^2 + v^2)
**********************************************************************

**********************************************************************
File "src/sage/manifolds/differentiable/pseudo_riemannian_submanifold.py", line 1517, in sage.manifolds.differentiable.pseudo_riemannian_submanifold.?.principal_curvatures
Failed example:
    N.principal_curvatures(stereoN)[0].display()  # long time
Expected:
    k_0: N --> R
    on U: x |--> -1
Got:
    k_0: N --> R
    on U: x |--> -1
    on W: y |--> -1
**********************************************************************
```



---

Comment by egourgoulhon created at 2019-10-27 14:28:41

Btw, thanks for reverting `_new_instance()`.


---

Comment by git created at 2019-10-27 14:44:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-10-27 14:45:18

I totally missed that we are in beta3 already!

Please check once again.

Thanks for your effort so far! :)


---

Comment by @DeRhamSource created at 2019-10-27 14:45:41

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2019-10-28 17:56:48

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-10-28 17:56:48

Everything is fine now. Thanks.


---

Comment by vbraun created at 2019-10-29 23:41:59

Resolution: fixed
