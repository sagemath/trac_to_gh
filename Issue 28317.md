# Issue 28317: Scalar Field Restrictions

archive/issues_028317.json:
```json
{
    "body": "CC:  tscrim egourgoulhon\n\nKeywords: manifolds, scalar fields\n\nHow is a scalar field implemented which is split into different expressions in one particular chart?\n\nTake for instance a scalar field `f` on the real line with standard \"top\" chart `x`, defined via `f(x)=0 for x<-1`, `f(x)=x+1 for -1<=x<0`, `f(x)=1-x for 0<=x<1` and `f(x)=0 for x>=1`. Currently, this is solved by using\n\n```\nf = M.scalar_field( unit_step(x + 1)*unit_step(1 - x)*(1 - abs(x)) )\n```\n\n(see #28519#comment:46).\n\nThis solution is quite unhandy and becomes even more so for more complicated scalar fields.\n\nIn this ticket, I try to solve this issue by adding a `set_restriction` method (similar to tensor fields) and modifying the `display` method.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28554\n\n",
    "created_at": "2019-10-03T17:40:55Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "title": "Scalar Field Restrictions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28317",
    "user": "@DeRhamSource"
}
```
CC:  tscrim egourgoulhon

Keywords: manifolds, scalar fields

How is a scalar field implemented which is split into different expressions in one particular chart?

Take for instance a scalar field `f` on the real line with standard "top" chart `x`, defined via `f(x)=0 for x<-1`, `f(x)=x+1 for -1<=x<0`, `f(x)=1-x for 0<=x<1` and `f(x)=0 for x>=1`. Currently, this is solved by using

```
f = M.scalar_field( unit_step(x + 1)*unit_step(1 - x)*(1 - abs(x)) )
```

(see #28519#comment:46).

This solution is quite unhandy and becomes even more so for more complicated scalar fields.

In this ticket, I try to solve this issue by adding a `set_restriction` method (similar to tensor fields) and modifying the `display` method.

Issue created by migration from https://trac.sagemath.org/ticket/28554





---

archive/issue_comments_399909.json:
```json
{
    "body": "Eric, in the ticket mentioned above, I suggested to display all *known* expressions (on the greatest domain) and compute new expressions only if a particular chart is stated. It seems, there is no big difference to the previous code then, and the additional computation time might be negligible. What do you say? Is this a good compromise for you? Moreover, this approach seems to be the easiest one.\n\nOr one implements an additional flag `display_all` for which the user is aware of additional computation time when using it?\n\nHowever, do you have an example for me with much computation time to test my current algorithm how long it takes? Then, I can compare computation times. I have a feeling that the current algorithm is not that much slower than before because it starts from the top charts -- what happens anyway and, I guess, it only makes a significant difference if the scalar field is picewisely defined.",
    "created_at": "2019-10-04T09:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399909",
    "user": "@DeRhamSource"
}
```

Eric, in the ticket mentioned above, I suggested to display all *known* expressions (on the greatest domain) and compute new expressions only if a particular chart is stated. It seems, there is no big difference to the previous code then, and the additional computation time might be negligible. What do you say? Is this a good compromise for you? Moreover, this approach seems to be the easiest one.

Or one implements an additional flag `display_all` for which the user is aware of additional computation time when using it?

However, do you have an example for me with much computation time to test my current algorithm how long it takes? Then, I can compare computation times. I have a feeling that the current algorithm is not that much slower than before because it starts from the top charts -- what happens anyway and, I guess, it only makes a significant difference if the scalar field is picewisely defined.



---

archive/issue_comments_399910.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-10-04T18:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399910",
    "user": "@DeRhamSource"
}
```

New commits:



---

archive/issue_comments_399911.json:
```json
{
    "body": "I compared computation times.\n\n**Before:**\n\n\n\n```\n...$ ./sage -t src/sage/manifolds/scalarfield.py \ntoo few successful tests, not using stored timings\nRunning doctests with ID 2019-10-04-19-03-38-e810720b.\nGit branch: scalar_field_restrictions\nUsing --optional=build,dochtml,memlimit,python2,sage\nDoctesting 1 file.\nsage -t src/sage/manifolds/scalarfield.py\n    [715 tests, 31.77 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 32.0 seconds\n    cpu time: 33.2 seconds\n    cumulative wall time: 31.8 seconds\n```\n\n\n**With this ticket:**\n\n\n```\n...$ ./sage -t src/sage/manifolds/scalarfield.py\ntoo few successful tests, not using stored timings\nRunning doctests with ID 2019-10-04-20-45-12-df0ec794.\nGit branch: scalar_field_restrictions\nUsing --optional=build,dochtml,memlimit,python2,sage\nDoctesting 1 file.\nsage -t src/sage/manifolds/scalarfield.py\n    [735 tests, 34.59 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 34.8 seconds\n    cpu time: 35.9 seconds\n    cumulative wall time: 34.6 seconds\n```\n\n\nWhat do you say?",
    "created_at": "2019-10-04T18:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399911",
    "user": "@DeRhamSource"
}
```

I compared computation times.

**Before:**



```
...$ ./sage -t src/sage/manifolds/scalarfield.py 
too few successful tests, not using stored timings
Running doctests with ID 2019-10-04-19-03-38-e810720b.
Git branch: scalar_field_restrictions
Using --optional=build,dochtml,memlimit,python2,sage
Doctesting 1 file.
sage -t src/sage/manifolds/scalarfield.py
    [715 tests, 31.77 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 32.0 seconds
    cpu time: 33.2 seconds
    cumulative wall time: 31.8 seconds
```


**With this ticket:**


```
...$ ./sage -t src/sage/manifolds/scalarfield.py
too few successful tests, not using stored timings
Running doctests with ID 2019-10-04-20-45-12-df0ec794.
Git branch: scalar_field_restrictions
Using --optional=build,dochtml,memlimit,python2,sage
Doctesting 1 file.
sage -t src/sage/manifolds/scalarfield.py
    [735 tests, 34.59 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 34.8 seconds
    cpu time: 35.9 seconds
    cumulative wall time: 34.6 seconds
```


What do you say?



---

archive/issue_comments_399912.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-04T19:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399912",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399913.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-10-06T13:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399913",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399914.json:
```json
{
    "body": "Please give me a short feedback so that I can work further on this.\n\nThis ticket is essential for my future implementation of characteristic classes (due to the `set_restriction` method).",
    "created_at": "2019-10-07T19:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399914",
    "user": "@DeRhamSource"
}
```

Please give me a short feedback so that I can work further on this.

This ticket is essential for my future implementation of characteristic classes (due to the `set_restriction` method).



---

archive/issue_comments_399915.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-10-07T19:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399915",
    "user": "@DeRhamSource"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_399916.json:
```json
{
    "body": "Sorry for the delay. The ticket looks good; it clearly improves the treatment of restrictions of scalar fields. I have a few remarks:\n- Regarding the change in `display()`, I agree that your solution is a good compromise\n- I guess the method `_new_instance()` has been introduced in scalar fields by analogy of what is done for tensor fields. However in the present case, this method is quite trivial, since it returns a mere `type(self)(self.parent())`. IMHO this adds some code complexity (a new method) for not a big gain; for someone reading the code, \n\n```\n   res = type(self)(self.parent())\n```\n\n  is at least as clear as\n\n```\n   res = self._new_instance()\n```\n\n   Moreover the latter involves one extra function call. Therefore I would suggest to revert this change.\n- When you perform significant changes/additions to some file, I would suggest that you add your name to the `AUTHORS` field and copyright statement. For instance in `src/sage/mnifolds/scalarfield.py`, you could add to the `AUTHORS` field something like \n\n```\n- Michael Jung (2019) : improve restrictions; make ``display()`` show all\n  distinct expressions\n```\n\n  The same holds for #28628 and other tickets of #28519.",
    "created_at": "2019-10-26T15:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399916",
    "user": "egourgoulhon"
}
```

Sorry for the delay. The ticket looks good; it clearly improves the treatment of restrictions of scalar fields. I have a few remarks:
- Regarding the change in `display()`, I agree that your solution is a good compromise
- I guess the method `_new_instance()` has been introduced in scalar fields by analogy of what is done for tensor fields. However in the present case, this method is quite trivial, since it returns a mere `type(self)(self.parent())`. IMHO this adds some code complexity (a new method) for not a big gain; for someone reading the code, 

```
   res = type(self)(self.parent())
```

  is at least as clear as

```
   res = self._new_instance()
```

   Moreover the latter involves one extra function call. Therefore I would suggest to revert this change.
- When you perform significant changes/additions to some file, I would suggest that you add your name to the `AUTHORS` field and copyright statement. For instance in `src/sage/mnifolds/scalarfield.py`, you could add to the `AUTHORS` field something like 

```
- Michael Jung (2019) : improve restrictions; make ``display()`` show all
  distinct expressions
```

  The same holds for #28628 and other tickets of #28519.



---

archive/issue_comments_399917.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-27T13:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399917",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399918.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-10-27T13:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399918",
    "user": "@DeRhamSource"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_399919.json:
```json
{
    "body": "Thanks! There we go. :)",
    "created_at": "2019-10-27T13:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399919",
    "user": "@DeRhamSource"
}
```

Thanks! There we go. :)



---

archive/issue_comments_399920.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-10-27T14:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399920",
    "user": "egourgoulhon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399921.json:
```json
{
    "body": "With Sage 9.0.beta3, there are two failed doctests:\n\n```\n**********************************************************************\nFile \"src/sage/manifolds/section.py\", line 971, in sage.manifolds.section.Section.add_expr_from_subdomain\nFailed example:\n    sorted(s._components.values())[0]._comp[(1,)].display()\nExpected:\n    S^2 --> R\n    on U: (x, y) |--> x\nGot:\n    S^2 --> R\n    on U: (x, y) |--> x\n    on W: (u, v) |--> u/(u^2 + v^2)\n**********************************************************************\n\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/pseudo_riemannian_submanifold.py\", line 1517, in sage.manifolds.differentiable.pseudo_riemannian_submanifold.?.principal_curvatures\nFailed example:\n    N.principal_curvatures(stereoN)[0].display()  # long time\nExpected:\n    k_0: N --> R\n    on U: x |--> -1\nGot:\n    k_0: N --> R\n    on U: x |--> -1\n    on W: y |--> -1\n**********************************************************************\n```\n",
    "created_at": "2019-10-27T14:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399921",
    "user": "egourgoulhon"
}
```

With Sage 9.0.beta3, there are two failed doctests:

```
**********************************************************************
File "src/sage/manifolds/section.py", line 971, in sage.manifolds.section.Section.add_expr_from_subdomain
Failed example:
    sorted(s._components.values())[0]._comp[(1,)].display()
Expected:
    S^2 --> R
    on U: (x, y) |--> x
Got:
    S^2 --> R
    on U: (x, y) |--> x
    on W: (u, v) |--> u/(u^2 + v^2)
**********************************************************************

**********************************************************************
File "src/sage/manifolds/differentiable/pseudo_riemannian_submanifold.py", line 1517, in sage.manifolds.differentiable.pseudo_riemannian_submanifold.?.principal_curvatures
Failed example:
    N.principal_curvatures(stereoN)[0].display()  # long time
Expected:
    k_0: N --> R
    on U: x |--> -1
Got:
    k_0: N --> R
    on U: x |--> -1
    on W: y |--> -1
**********************************************************************
```




---

archive/issue_comments_399922.json:
```json
{
    "body": "Btw, thanks for reverting `_new_instance()`.",
    "created_at": "2019-10-27T14:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399922",
    "user": "egourgoulhon"
}
```

Btw, thanks for reverting `_new_instance()`.



---

archive/issue_comments_399923.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-27T14:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399923",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399924.json:
```json
{
    "body": "I totally missed that we are in beta3 already!\n\nPlease check once again.\n\nThanks for your effort so far! :)",
    "created_at": "2019-10-27T14:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399924",
    "user": "@DeRhamSource"
}
```

I totally missed that we are in beta3 already!

Please check once again.

Thanks for your effort so far! :)



---

archive/issue_comments_399925.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-10-27T14:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399925",
    "user": "@DeRhamSource"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399926.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-28T17:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399926",
    "user": "egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399927.json:
```json
{
    "body": "Everything is fine now. Thanks.",
    "created_at": "2019-10-28T17:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399927",
    "user": "egourgoulhon"
}
```

Everything is fine now. Thanks.



---

archive/issue_comments_399928.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-29T23:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28317#issuecomment-399928",
    "user": "vbraun"
}
```

Resolution: fixed
