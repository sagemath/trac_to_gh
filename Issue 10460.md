# Issue 10460: Coercion and category framework for modules

archive/issues_010460.json:
```json
{
    "body": "Assignee: robertwb\n\nCC:  vbraun novoselt jpflori\n\nKeywords: coercion, category framework, modules\n\nCurrently, modules in Sage do not use the category framework and are based on the old coercion model. Moreover, some coercions go wrong:\n\nWithout my patch, we have\n\n```\nsage: V3 = QQ^3\nsage: M = V3 / [[1,2,3]]\nsage: V2 = QQ^2\nsage: N = V3 / [[1,1,1]]\n# The quotient maps are of course coercions\nsage: f3M = M.coerce_map_from(V3)\nsage: f3N = N.coerce_map_from(V3)\n# The following is a bug...\nsage: V2.has_coerce_map_from(N)\nTrue\nsage: M.has_coerce_map_from(V2)\nTrue\nsage: N.has_coerce_map_from(V2)\nTrue\n#... because the composition of coercion\n# from N to V2 to M should be a coercion,\n# but it isn't:\nsage: M.has_coerce_map_from(N)\nFalse\n# Moreover, we obtain a non-commuting triangle of\n# coercions:\nsage: fM2 = V2.coerce_map_from(M)\nsage: fN2 = V2.coerce_map_from(N)\nsage: [fM2(f3M(x)) for x in V3.basis()]\n[(1, 0), (0, 1), (-1/3, -2/3)]\nsage: [fN2(f3N(x)) for x in V3.basis()]\n[(1, 0), (0, 1), (-1, -1)]\n```\n\n\nComparison goes wrong as well without my patch:\n\n```\nsage: V2==M\nTrue\nsage: M==V2\nFalse\n```\n\n\nMy patch removes the coercion between abstract module `V^2` and the quotient modules. Moreover, we then have `V2!=M`.\n\nI did not implement the \"advanced\" bits of coercion yet, namely the construction functor and pushout magic. This will be dealt with on a different ticket.\n\nNote that what I propose here goes beyond what is done \"on the fly\" in #9713, whose main purpose isn't coercion anyway. Moreover, my patch here does hardly touch the stuff that is really important for #9713. Hence, I suggest to add the ticket here to the long list of dependencies for #9713.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10513\n\n",
    "created_at": "2010-12-22T09:20:06Z",
    "labels": [
        "coercion",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "Coercion and category framework for modules",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10460",
    "user": "SimonKing"
}
```
Assignee: robertwb

CC:  vbraun novoselt jpflori

Keywords: coercion, category framework, modules

Currently, modules in Sage do not use the category framework and are based on the old coercion model. Moreover, some coercions go wrong:

Without my patch, we have

```
sage: V3 = QQ^3
sage: M = V3 / [[1,2,3]]
sage: V2 = QQ^2
sage: N = V3 / [[1,1,1]]
# The quotient maps are of course coercions
sage: f3M = M.coerce_map_from(V3)
sage: f3N = N.coerce_map_from(V3)
# The following is a bug...
sage: V2.has_coerce_map_from(N)
True
sage: M.has_coerce_map_from(V2)
True
sage: N.has_coerce_map_from(V2)
True
#... because the composition of coercion
# from N to V2 to M should be a coercion,
# but it isn't:
sage: M.has_coerce_map_from(N)
False
# Moreover, we obtain a non-commuting triangle of
# coercions:
sage: fM2 = V2.coerce_map_from(M)
sage: fN2 = V2.coerce_map_from(N)
sage: [fM2(f3M(x)) for x in V3.basis()]
[(1, 0), (0, 1), (-1/3, -2/3)]
sage: [fN2(f3N(x)) for x in V3.basis()]
[(1, 0), (0, 1), (-1, -1)]
```


Comparison goes wrong as well without my patch:

```
sage: V2==M
True
sage: M==V2
False
```


My patch removes the coercion between abstract module `V^2` and the quotient modules. Moreover, we then have `V2!=M`.

I did not implement the "advanced" bits of coercion yet, namely the construction functor and pushout magic. This will be dealt with on a different ticket.

Note that what I propose here goes beyond what is done "on the fly" in #9713, whose main purpose isn't coercion anyway. Moreover, my patch here does hardly touch the stuff that is really important for #9713. Hence, I suggest to add the ticket here to the long list of dependencies for #9713.

Issue created by migration from https://trac.sagemath.org/ticket/10513





---

archive/issue_comments_108510.json:
```json
{
    "body": "Attachment\n\nImplement coercion and category framework for free modules, submodules, quotient modules. Depends on #10496",
    "created_at": "2010-12-22T09:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108510",
    "user": "SimonKing"
}
```

Attachment

Implement coercion and category framework for free modules, submodules, quotient modules. Depends on #10496



---

archive/issue_comments_108511.json:
```json
{
    "body": "For the patchbot/release manager:\n\ndepends on #10496\n\nReady for review!",
    "created_at": "2010-12-22T09:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108511",
    "user": "SimonKing"
}
```

For the patchbot/release manager:

depends on #10496

Ready for review!



---

archive/issue_comments_108512.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-22T09:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108512",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_108513.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2010-12-22T09:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108513",
    "user": "SimonKing"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_108514.json:
```json
{
    "body": "One of the things that I did in #9713 was to replace `sage.structure.parent_gens.ParentWithAdditiveAbelianGens` with `sage.structure.parent.Parent` as the base class of `Module`. At the top of `sage/structure/parent_gens.pyx` it says that \n\n```\n   This class is being deprecated, see\n   ``sage.structure.parent.Parent`` and\n   ``sage.structure.category_object.CategoryObject`` for the new\n   model.\n```\n\nBut your patch does not change the Module base class. So I'm a bit confused about what the right way of doing things is.",
    "created_at": "2010-12-22T11:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108514",
    "user": "vbraun"
}
```

One of the things that I did in #9713 was to replace `sage.structure.parent_gens.ParentWithAdditiveAbelianGens` with `sage.structure.parent.Parent` as the base class of `Module`. At the top of `sage/structure/parent_gens.pyx` it says that 

```
   This class is being deprecated, see
   ``sage.structure.parent.Parent`` and
   ``sage.structure.category_object.CategoryObject`` for the new
   model.
```

But your patch does not change the Module base class. So I'm a bit confused about what the right way of doing things is.



---

archive/issue_comments_108515.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2010-12-22T11:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108515",
    "user": "vbraun"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_108516.json:
```json
{
    "body": "Replying to [comment:2 vbraun]:\n> At the top of `sage/structure/parent_gens.pyx` it says that \n> {{{\n>    This class is being deprecated, see\n>    ``sage.structure.parent.Parent`` and\n>    ``sage.structure.category_object.CategoryObject`` for the new\n>    model.\n> }}}\n> But your patch does not change the Module base class.\n\nThank you, I simply wasn't aware of the deprecation. Changing it now, and if tests pass I'll update my patch.",
    "created_at": "2010-12-22T11:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108516",
    "user": "SimonKing"
}
```

Replying to [comment:2 vbraun]:
> At the top of `sage/structure/parent_gens.pyx` it says that 
> {{{
>    This class is being deprecated, see
>    ``sage.structure.parent.Parent`` and
>    ``sage.structure.category_object.CategoryObject`` for the new
>    model.
> }}}
> But your patch does not change the Module base class.

Thank you, I simply wasn't aware of the deprecation. Changing it now, and if tests pass I'll update my patch.



---

archive/issue_comments_108517.json:
```json
{
    "body": "I just noticed that `ParentWithBase` is requested in various other files. So, it will take a while until I can replace `ParentWithAdditiveAbelianGens` by `Parent`.",
    "created_at": "2010-12-22T11:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108517",
    "user": "SimonKing"
}
```

I just noticed that `ParentWithBase` is requested in various other files. So, it will take a while until I can replace `ParentWithAdditiveAbelianGens` by `Parent`.



---

archive/issue_comments_108518.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2010-12-22T11:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108518",
    "user": "SimonKing"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_108519.json:
```json
{
    "body": "I am trying to finish this ticket.  I currently have a branch that passes all doctests, but I am still improving some of the code and adding documentation.",
    "created_at": "2014-06-21T13:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108519",
    "user": "pbruin"
}
```

I am trying to finish this ticket.  I currently have a branch that passes all doctests, but I am still improving some of the code and adding documentation.



---

archive/issue_comments_108520.json:
```json
{
    "body": "OK, ready for review.  There is still some future work to be done:\n- move the last few classes from `Module_old` to `Module`.  There are only four of these remaining:\n  1. `sage.coding.linear_code.LinearCode`\n  2. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`\n  3. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`\n  4. `sage.structure.formal_sum.FormalSums`\n- make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition.\nI think it is better to do these in separate tickets.",
    "created_at": "2014-06-21T23:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108520",
    "user": "pbruin"
}
```

OK, ready for review.  There is still some future work to be done:
- move the last few classes from `Module_old` to `Module`.  There are only four of these remaining:
  1. `sage.coding.linear_code.LinearCode`
  2. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`
  3. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`
  4. `sage.structure.formal_sum.FormalSums`
- make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition.
I think it is better to do these in separate tickets.



---

archive/issue_comments_108521.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-06-21T23:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108521",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_108522.json:
```json
{
    "body": "`sage.coding.linear_code.LinearCode` is taken care of in #16644.",
    "created_at": "2014-07-23T21:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108522",
    "user": "tscrim"
}
```

`sage.coding.linear_code.LinearCode` is taken care of in #16644.



---

archive/issue_comments_108523.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-15T11:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108523",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108524.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-27T17:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108524",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108525.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-04T22:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108525",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108526.json:
```json
{
    "body": "Could you add a little documentation about the `coercion_reverse` thing?\nOr rather, move it in the actual code, rather than in comments?\nNot that the category/coercion stuff is already obscure, but...",
    "created_at": "2014-12-08T17:17:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108526",
    "user": "jpflori"
}
```

Could you add a little documentation about the `coercion_reverse` thing?
Or rather, move it in the actual code, rather than in comments?
Not that the category/coercion stuff is already obscure, but...



---

archive/issue_comments_108527.json:
```json
{
    "body": "I guess my comment should have been made in #16507.",
    "created_at": "2014-12-08T17:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108527",
    "user": "jpflori"
}
```

I guess my comment should have been made in #16507.



---

archive/issue_comments_108528.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-12-18T20:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108528",
    "user": "pbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_108529.json:
```json
{
    "body": "After merging with 6.5.beta3 (which `git` does automatically, despite Trac being unable to auto-merge), there is one failing doctest:\n\n```\nFile \"src/sage/modules/free_module.py\", line 6074, in sage.modules.free_module.FreeModule_submodule_with_basis_field\nFailed example:\n    TestSuite(W).run()\nExpected nothing\nGot:\n    Failure in _test_pickling:\n    Traceback (most recent call last):\n      File \"/home/bruinpj/src/sage/local/lib/python2.7/site-packages/sage/misc/sage_unittest.py\", line 282, in run\n        test_method(tester = tester)\n      File \"sage/structure/sage_object.pyx\", line 543, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4553)\n        tester.assertEqual(loads(dumps(self)), self)\n      File \"/home/bruinpj/src/sage/local/lib/python/unittest/case.py\", line 513, in assertEqual\n        assertion_func(first, second, msg=msg)\n      File \"/home/bruinpj/src/sage/local/lib/python/unittest/case.py\", line 506, in _baseAssertEqual\n        raise self.failureException(msg)\n    AssertionError: Vector space of degree 3 and dimension 1 over Fraction Field of Univariate Polynomial Ring in x over Rational Field\n    User basis matrix:\n    [1 1 x] != Vector space of degree 3 and dimension 1 over Fraction Field of Univariate Polynomial Ring in x over Rational Field\n    User basis matrix:\n    [1 1 x]\n    ------------------------------------------------------------\n    The following tests failed: _test_pickling\n```\n\nThis is due to the cached `echelonized_basis_matrix` behaving badly under pickling:\n\n```\nsage: K.<x> = FractionField(QQ['x'])\nsage: M = K^3\nsage: W = M.span_of_basis([[1, 1, x]])\nsage: W.echelonized_basis_matrix()\n[1 1 x]\nsage: s = dumps(W)\nsage: V = loads(s)\nsage: V.echelonized_basis_matrix()\n[1, 1, x]\nsage: type(_)\n<type 'list'>\n```\n\nThere does not seem to be any such problem with `basis_matrix()`:\n\n```\nsage: W.basis_matrix()\n[1 1 x]\nsage: V.basis_matrix()\n[1 1 x]\n```\n",
    "created_at": "2014-12-18T20:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108529",
    "user": "pbruin"
}
```

After merging with 6.5.beta3 (which `git` does automatically, despite Trac being unable to auto-merge), there is one failing doctest:

```
File "src/sage/modules/free_module.py", line 6074, in sage.modules.free_module.FreeModule_submodule_with_basis_field
Failed example:
    TestSuite(W).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "/home/bruinpj/src/sage/local/lib/python2.7/site-packages/sage/misc/sage_unittest.py", line 282, in run
        test_method(tester = tester)
      File "sage/structure/sage_object.pyx", line 543, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4553)
        tester.assertEqual(loads(dumps(self)), self)
      File "/home/bruinpj/src/sage/local/lib/python/unittest/case.py", line 513, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/home/bruinpj/src/sage/local/lib/python/unittest/case.py", line 506, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: Vector space of degree 3 and dimension 1 over Fraction Field of Univariate Polynomial Ring in x over Rational Field
    User basis matrix:
    [1 1 x] != Vector space of degree 3 and dimension 1 over Fraction Field of Univariate Polynomial Ring in x over Rational Field
    User basis matrix:
    [1 1 x]
    ------------------------------------------------------------
    The following tests failed: _test_pickling
```

This is due to the cached `echelonized_basis_matrix` behaving badly under pickling:

```
sage: K.<x> = FractionField(QQ['x'])
sage: M = K^3
sage: W = M.span_of_basis([[1, 1, x]])
sage: W.echelonized_basis_matrix()
[1 1 x]
sage: s = dumps(W)
sage: V = loads(s)
sage: V.echelonized_basis_matrix()
[1, 1, x]
sage: type(_)
<type 'list'>
```

There does not seem to be any such problem with `basis_matrix()`:

```
sage: W.basis_matrix()
[1 1 x]
sage: V.basis_matrix()
[1 1 x]
```




---

archive/issue_comments_108530.json:
```json
{
    "body": "The pickling problem is independent of this ticket, see #17527.",
    "created_at": "2014-12-19T10:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108530",
    "user": "pbruin"
}
```

The pickling problem is independent of this ticket, see #17527.



---

archive/issue_comments_108531.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-19T12:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108531",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108532.json:
```json
{
    "body": "The pickling problem can actually be circumvented in a more elegant way by avoiding an unnecessary caching step (the echelon form of a matrix is already cached).",
    "created_at": "2014-12-19T12:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108532",
    "user": "pbruin"
}
```

The pickling problem can actually be circumvented in a more elegant way by avoiding an unnecessary caching step (the echelon form of a matrix is already cached).



---

archive/issue_comments_108533.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-12-19T12:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108533",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_108534.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-19T14:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108534",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108535.json:
```json
{
    "body": "I had a look at the work done here and it looks nice.\n\n\nReplying to [comment:10 pbruin]:\n> OK, ready for review.  There is still some future work to be done:\n> - move the last few classes from `Module_old` to `Module`.  There are only four of these remaining:\n>   1. `sage.coding.linear_code.LinearCode`\n>   2. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`\n>   3. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`\n>   4. `sage.structure.formal_sum.FormalSums`\n> - make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition.\n> I think it is better to do these in separate tickets.\nDid you open tickets for these?\n\nAnd in a couple of changes to `src/sage/geometry/cone.py` you modify code not to use `_ in _` as ther is no coercion defined.\nAny ticket opened to implement such a coercion?",
    "created_at": "2014-12-23T14:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108535",
    "user": "jpflori"
}
```

I had a look at the work done here and it looks nice.


Replying to [comment:10 pbruin]:
> OK, ready for review.  There is still some future work to be done:
> - move the last few classes from `Module_old` to `Module`.  There are only four of these remaining:
>   1. `sage.coding.linear_code.LinearCode`
>   2. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`
>   3. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`
>   4. `sage.structure.formal_sum.FormalSums`
> - make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition.
> I think it is better to do these in separate tickets.
Did you open tickets for these?

And in a couple of changes to `src/sage/geometry/cone.py` you modify code not to use `_ in _` as ther is no coercion defined.
Any ticket opened to implement such a coercion?



---

archive/issue_comments_108536.json:
```json
{
    "body": "Replying to [comment:25 jpflori]:\n> I had a look at the work done here and it looks nice.\nThanks!\n> Replying to [comment:10 pbruin]:\n> > OK, ready for review.  There is still some future work to be done:\n> > - move the last few classes from `Module_old` to `Module`.  There are only four of these remaining:\n> >   1. `sage.coding.linear_code.LinearCode`\n> >   2. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`\n> >   3. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`\n> >   4. `sage.structure.formal_sum.FormalSums`\n> > - make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition.\n> > I think it is better to do these in separate tickets.\n> Did you open tickets for these?\nI just created #17543 and #17544.  (See comment:11 for `LinearCode`.)\n> And in a couple of changes to `src/sage/geometry/cone.py` you modify code not to use `_ in _` as ther is no coercion defined.\n> Any ticket opened to implement such a coercion?\nI'm not sure if this is desired; the absence of these particular maps may have been an (unintended) consequence of implementing the new coercion model in the simplest possible way, but it may have been intentional as well, I don't remember.",
    "created_at": "2014-12-23T17:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108536",
    "user": "pbruin"
}
```

Replying to [comment:25 jpflori]:
> I had a look at the work done here and it looks nice.
Thanks!
> Replying to [comment:10 pbruin]:
> > OK, ready for review.  There is still some future work to be done:
> > - move the last few classes from `Module_old` to `Module`.  There are only four of these remaining:
> >   1. `sage.coding.linear_code.LinearCode`
> >   2. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`
> >   3. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`
> >   4. `sage.structure.formal_sum.FormalSums`
> > - make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition.
> > I think it is better to do these in separate tickets.
> Did you open tickets for these?
I just created #17543 and #17544.  (See comment:11 for `LinearCode`.)
> And in a couple of changes to `src/sage/geometry/cone.py` you modify code not to use `_ in _` as ther is no coercion defined.
> Any ticket opened to implement such a coercion?
I'm not sure if this is desired; the absence of these particular maps may have been an (unintended) consequence of implementing the new coercion model in the simplest possible way, but it may have been intentional as well, I don't remember.



---

archive/issue_comments_108537.json:
```json
{
    "body": "Replying to [comment:26 pbruin]:> > Any ticket opened to implement such a coercion?\n> I'm not sure if this is desired; the absence of these particular maps may have been an (unintended) consequence of implementing the new coercion model in the simplest possible way, but it may have been intentional as well, I don't remember.\nI was asking because it used to be possible to use the `in` keyword when the classes were using the old coercion model.",
    "created_at": "2014-12-23T17:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108537",
    "user": "jpflori"
}
```

Replying to [comment:26 pbruin]:> > Any ticket opened to implement such a coercion?
> I'm not sure if this is desired; the absence of these particular maps may have been an (unintended) consequence of implementing the new coercion model in the simplest possible way, but it may have been intentional as well, I don't remember.
I was asking because it used to be possible to use the `in` keyword when the classes were using the old coercion model.



---

archive/issue_comments_108538.json:
```json
{
    "body": "Replying to [comment:27 jpflori]:\n> Replying to [comment:26 pbruin]:> > Any ticket opened to implement such a coercion?\n> > I'm not sure if this is desired; the absence of these particular maps may have been an (unintended) consequence of implementing the new coercion model in the simplest possible way, but it may have been intentional as well, I don't remember.\n> I was asking because it used to be possible to use the `in` keyword when the classes were using the old coercion model.\nAfter looking at this again, I think the reason was as follows: a cone *C* is a certain type of subset of a vector space *V*, and *C* contains a largest maximal linear subspace *S*.  Now to test if an element *x* of *C* is in *S*, the coercion framework checks if *S*(*x*) == *x*, but when trying to comparing these two elements it cannot find a common parent for the toric lattice and the linear subspace.  This seems to be because of the following method in `ToricLattice_generic`:\n\n```python\n# We need to override this function, otherwise e.g. the sum of elements of\n# different lattices of the same dimension will live in ZZ^n.\ndef construction(self):\n    r\"\"\"\n    Return the functorial construction of ``self``.\n\n    OUTPUT:\n\n    - ``None``, we do not think of toric lattices as constructed from\n      simpler objects since we do not want to perform arithmetic involving\n      different lattices.\n\n    [...]\n    \"\"\"\n    return None\n```\n\nThe reason why it used to work with the old coercion model might have been a peculiarity of some `_coerce_impl()` method.  Trying to fix this (so that we can use `... in ...` again) will probably lead to all kind of other problems, so I'd prefer not to do that on this ticket.",
    "created_at": "2014-12-23T20:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108538",
    "user": "pbruin"
}
```

Replying to [comment:27 jpflori]:
> Replying to [comment:26 pbruin]:> > Any ticket opened to implement such a coercion?
> > I'm not sure if this is desired; the absence of these particular maps may have been an (unintended) consequence of implementing the new coercion model in the simplest possible way, but it may have been intentional as well, I don't remember.
> I was asking because it used to be possible to use the `in` keyword when the classes were using the old coercion model.
After looking at this again, I think the reason was as follows: a cone *C* is a certain type of subset of a vector space *V*, and *C* contains a largest maximal linear subspace *S*.  Now to test if an element *x* of *C* is in *S*, the coercion framework checks if *S*(*x*) == *x*, but when trying to comparing these two elements it cannot find a common parent for the toric lattice and the linear subspace.  This seems to be because of the following method in `ToricLattice_generic`:

```python
# We need to override this function, otherwise e.g. the sum of elements of
# different lattices of the same dimension will live in ZZ^n.
def construction(self):
    r"""
    Return the functorial construction of ``self``.

    OUTPUT:

    - ``None``, we do not think of toric lattices as constructed from
      simpler objects since we do not want to perform arithmetic involving
      different lattices.

    [...]
    """
    return None
```

The reason why it used to work with the old coercion model might have been a peculiarity of some `_coerce_impl()` method.  Trying to fix this (so that we can use `... in ...` again) will probably lead to all kind of other problems, so I'd prefer not to do that on this ticket.



---

archive/issue_comments_108539.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-12-26T10:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108539",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_108540.json:
```json
{
    "body": "Ok, I buy your explanation, thanks for digging this out.",
    "created_at": "2014-12-26T10:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108540",
    "user": "jpflori"
}
```

Ok, I buy your explanation, thanks for digging this out.



---

archive/issue_comments_108541.json:
```json
{
    "body": "I get lots of doctest failures all originating at something like\n\n```\n    TypeError: must be intialized with a type, not Manin Symbol List of weight 4 for Gamma0(11)\n```\n",
    "created_at": "2015-01-02T08:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108541",
    "user": "vbraun"
}
```

I get lots of doctest failures all originating at something like

```
    TypeError: must be intialized with a type, not Manin Symbol List of weight 4 for Gamma0(11)
```




---

archive/issue_comments_108542.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-01-02T08:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108542",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_108543.json:
```json
{
    "body": "Replying to [comment:30 vbraun]:\n> I get lots of doctest failures all originating at something like\n> {{{\n>     TypeError: must be intialized with a type, not Manin Symbol List of weight 4 for Gamma0(11)\n> }}}\nCan you give more details and/or a link to a log file?  I am not getting any doctest failures in `sage/modular` (which I would guess is where these failures occur) after merging this branch with 6.5.beta4, both on x86_64 and on ARM.",
    "created_at": "2015-01-02T11:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108543",
    "user": "pbruin"
}
```

Replying to [comment:30 vbraun]:
> I get lots of doctest failures all originating at something like
> {{{
>     TypeError: must be intialized with a type, not Manin Symbol List of weight 4 for Gamma0(11)
> }}}
Can you give more details and/or a link to a log file?  I am not getting any doctest failures in `sage/modular` (which I would guess is where these failures occur) after merging this branch with 6.5.beta4, both on x86_64 and on ARM.



---

archive/issue_comments_108544.json:
```json
{
    "body": "I think it's because of #10962.",
    "created_at": "2015-01-02T12:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108544",
    "user": "jdemeyer"
}
```

I think it's because of #10962.



---

archive/issue_comments_108545.json:
```json
{
    "body": "Does this patch address anything of https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g by chance?",
    "created_at": "2015-01-02T12:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108545",
    "user": "jdemeyer"
}
```

Does this patch address anything of https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g by chance?



---

archive/issue_comments_108546.json:
```json
{
    "body": "Replying to [comment:34 jdemeyer]:\n> Does this patch address anything of https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g by chance?\nNo, I don't think so.  (It does solve #17576, though.)",
    "created_at": "2015-01-02T12:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108546",
    "user": "pbruin"
}
```

Replying to [comment:34 jdemeyer]:
> Does this patch address anything of https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g by chance?
No, I don't think so.  (It does solve #17576, though.)



---

archive/issue_comments_108547.json:
```json
{
    "body": "Replying to [comment:33 jdemeyer]:\n> I think it's because of #10962.\nYou're right, I'm looking into it.",
    "created_at": "2015-01-02T13:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108547",
    "user": "pbruin"
}
```

Replying to [comment:33 jdemeyer]:
> I think it's because of #10962.
You're right, I'm looking into it.



---

archive/issue_comments_108548.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-01-02T19:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108548",
    "user": "pbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_108549.json:
```json
{
    "body": "The failures when applying this together with #10962 are caused by the fact that Manin symbols do not use the `Parent`/`Element` machinery.  This is fixed by #17578.",
    "created_at": "2015-01-02T19:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108549",
    "user": "pbruin"
}
```

The failures when applying this together with #10962 are caused by the fact that Manin symbols do not use the `Parent`/`Element` machinery.  This is fixed by #17578.



---

archive/issue_comments_108550.json:
```json
{
    "body": "In `src/sage/modules/free_module_element.pyx`, you changed in one place\n\n```\nexcept TypeError:\n```\n\nto\n\n```\nexcept (TypeError, ValueError):\n```\n\n\nIs this change needed? If yes, it should also be applied to the other place with similar code (there is one `__init__` method for dense and one for sparse vectors).",
    "created_at": "2015-01-03T00:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108550",
    "user": "jdemeyer"
}
```

In `src/sage/modules/free_module_element.pyx`, you changed in one place

```
except TypeError:
```

to

```
except (TypeError, ValueError):
```


Is this change needed? If yes, it should also be applied to the other place with similar code (there is one `__init__` method for dense and one for sparse vectors).



---

archive/issue_comments_108551.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2015-01-03T00:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108551",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_108552.json:
```json
{
    "body": "(I'm asking because this is a conflict with #17561)",
    "created_at": "2015-01-03T00:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108552",
    "user": "jdemeyer"
}
```

(I'm asking because this is a conflict with #17561)



---

archive/issue_comments_108553.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-03T08:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108553",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108554.json:
```json
{
    "body": "Replying to [comment:38 jdemeyer]:\n> In `src/sage/modules/free_module_element.pyx`, you changed in one place\n> {{{\n> except TypeError:\n> }}}\n> to\n> {{{\n> except (TypeError, ValueError):\n> }}}\n> \n> Is this change needed?\nApparently not; the last commit reverts it.",
    "created_at": "2015-01-03T08:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108554",
    "user": "pbruin"
}
```

Replying to [comment:38 jdemeyer]:
> In `src/sage/modules/free_module_element.pyx`, you changed in one place
> {{{
> except TypeError:
> }}}
> to
> {{{
> except (TypeError, ValueError):
> }}}
> 
> Is this change needed?
Apparently not; the last commit reverts it.



---

archive/issue_comments_108555.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2015-01-03T08:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108555",
    "user": "pbruin"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_108556.json:
```json
{
    "body": "There is a minor conflict with #17561.",
    "created_at": "2015-01-11T21:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108556",
    "user": "jdemeyer"
}
```

There is a minor conflict with #17561.



---

archive/issue_comments_108557.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-01-11T21:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108557",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_108558.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-01-12T13:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108558",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_108559.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-01-12T13:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108559",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_108560.json:
```json
{
    "body": "On 6.5.beta5:\n\n```\nsage: %time for p in prime_range(10^5): V=(GF(p))^3\nCPU times: user 3.63 s, sys: 28 ms, total: 3.66 s\nWall time: 3.65 s\n```\n\nWith this branch:\n\n```\nsage: %time for p in prime_range(10^5): V=(GF(p))^3\nCPU times: user 13.4 s, sys: 29 ms, total: 13.5 s\nWall time: 13.5 s\n```\n\nI think that's a significant regression in performance. It's probably due to the construction of the category-with-base. If you change the category to be \"Category of vector spaces over Fields\" or \"over Finite Fields\" you'll get much better performance, because there's not a new category to be constructed for every single space.\n\n(this stuff isn't academic--such spaces really get made a lot in CRT code). See also #17360, where the issue causes a memleak (that seems to be fine here). See also [http://trac.sagemath.org/ticket/10963#comment:506](http://trac.sagemath.org/ticket/10963#comment:506) where this issue was mentioned right at the start of the development of these parametrized categories.",
    "created_at": "2015-01-13T16:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108560",
    "user": "nbruin"
}
```

On 6.5.beta5:

```
sage: %time for p in prime_range(10^5): V=(GF(p))^3
CPU times: user 3.63 s, sys: 28 ms, total: 3.66 s
Wall time: 3.65 s
```

With this branch:

```
sage: %time for p in prime_range(10^5): V=(GF(p))^3
CPU times: user 13.4 s, sys: 29 ms, total: 13.5 s
Wall time: 13.5 s
```

I think that's a significant regression in performance. It's probably due to the construction of the category-with-base. If you change the category to be "Category of vector spaces over Fields" or "over Finite Fields" you'll get much better performance, because there's not a new category to be constructed for every single space.

(this stuff isn't academic--such spaces really get made a lot in CRT code). See also #17360, where the issue causes a memleak (that seems to be fine here). See also [http://trac.sagemath.org/ticket/10963#comment:506](http://trac.sagemath.org/ticket/10963#comment:506) where this issue was mentioned right at the start of the development of these parametrized categories.



---

archive/issue_comments_108561.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-01-13T16:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108561",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_108562.json:
```json
{
    "body": "Yep, with\n\n```diff\ndiff --git a/src/sage/modules/free_module.py b/src/sage/modules/free_module.py\nindex 4cf68fc..dc9248c 100644\n--- a/src/sage/modules/free_module.py\n+++ b/src/sage/modules/free_module.py\n@@ -721,10 +721,11 @@ done from the right side.\"\"\")\n \n         if category is None:\n             from sage.categories.all import Fields, FreeModules, VectorSpaces\n-            if base_ring in Fields():\n-                category = VectorSpaces(base_ring)\n+            F=Fields()\n+            if base_ring in F:\n+                category = VectorSpaces(F)\n             else:\n-                category = FreeModules(base_ring)\n+                category = FreeModules(base_ring.category())\n             try:\n                 if base_ring.is_finite() or rank == 0:\n                     # Put the module in the category of finite enumerated\n\n```\n\nI get\n\n```\nsage: %time for p in prime_range(10^5): V=(GF(p))^3\nCPU times: user 2.52 s, sys: 27 ms, total: 2.54 s\nWall time: 2.53 s\n```\n\nIn profiling this example I'm still finding\n\n```\n    28774    0.054    0.000    0.329    0.000 category.py:2281(join)\n```\n\nso it seems we're still spending more than 10% of our time on dynamically constructing a category (taking the join with `FiniteEnumeratedSets()`) just to get a list method. This looks like another candidate to improve (a bit).\n\nOn the other hand, part of this might by due to `GF(p)` construction by itself. If I first do `L=[GF(p) for  p in prime_range(10^5)]` the run time drops to 1.19 s, there are less calls to join (exactly one per constructed field, so `GF(p)` seems to need two category joins) and the impact of `category.join` drops to `0.086`, which is about 6-7% of the run time then.",
    "created_at": "2015-01-13T19:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108562",
    "user": "nbruin"
}
```

Yep, with

```diff
diff --git a/src/sage/modules/free_module.py b/src/sage/modules/free_module.py
index 4cf68fc..dc9248c 100644
--- a/src/sage/modules/free_module.py
+++ b/src/sage/modules/free_module.py
@@ -721,10 +721,11 @@ done from the right side.""")
 
         if category is None:
             from sage.categories.all import Fields, FreeModules, VectorSpaces
-            if base_ring in Fields():
-                category = VectorSpaces(base_ring)
+            F=Fields()
+            if base_ring in F:
+                category = VectorSpaces(F)
             else:
-                category = FreeModules(base_ring)
+                category = FreeModules(base_ring.category())
             try:
                 if base_ring.is_finite() or rank == 0:
                     # Put the module in the category of finite enumerated

```

I get

```
sage: %time for p in prime_range(10^5): V=(GF(p))^3
CPU times: user 2.52 s, sys: 27 ms, total: 2.54 s
Wall time: 2.53 s
```

In profiling this example I'm still finding

```
    28774    0.054    0.000    0.329    0.000 category.py:2281(join)
```

so it seems we're still spending more than 10% of our time on dynamically constructing a category (taking the join with `FiniteEnumeratedSets()`) just to get a list method. This looks like another candidate to improve (a bit).

On the other hand, part of this might by due to `GF(p)` construction by itself. If I first do `L=[GF(p) for  p in prime_range(10^5)]` the run time drops to 1.19 s, there are less calls to join (exactly one per constructed field, so `GF(p)` seems to need two category joins) and the impact of `category.join` drops to `0.086`, which is about 6-7% of the run time then.



---

archive/issue_comments_108563.json:
```json
{
    "body": "Replying to [comment:47 nbruin]:\n> On the other hand, part of this might by due to `GF(p)` construction by itself. If I first do `L=[GF(p) for  p in prime_range(10^5)]` the run time drops to 1.19 s, there are less calls to join (exactly one per constructed field, so `GF(p)` seems to need two category joins) and the impact of `category.join` drops to `0.086`, which is about 6-7% of the run time then.\nIndeed, the category of `GF(p)` is a join of three categories:\n\n```\nsage: GF(3).category()\nJoin of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups\n```\n\nMaybe parts of the category code (like `join`) should be transformed into Cython to make it faster?",
    "created_at": "2015-01-20T14:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108563",
    "user": "pbruin"
}
```

Replying to [comment:47 nbruin]:
> On the other hand, part of this might by due to `GF(p)` construction by itself. If I first do `L=[GF(p) for  p in prime_range(10^5)]` the run time drops to 1.19 s, there are less calls to join (exactly one per constructed field, so `GF(p)` seems to need two category joins) and the impact of `category.join` drops to `0.086`, which is about 6-7% of the run time then.
Indeed, the category of `GF(p)` is a join of three categories:

```
sage: GF(3).category()
Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups
```

Maybe parts of the category code (like `join`) should be transformed into Cython to make it faster?



---

archive/issue_comments_108564.json:
```json
{
    "body": "With the new commits, the category of free modules is `FreeModules(base_ring.category())` by default, and instead of taking the join with `FiniteEnumeratedSets` (if applicable), we add a `list()` method.\n\nThere are two doctest failures:\n\n```\nsage -t --long --warn-long 43.7 src/sage/matrix/matrix2.pyx  # 1 doctest failed\nsage -t --long --warn-long 43.7 src/sage/modules/free_module.py  # 1 doctest failed\n```\n\nThe first is caused by #11126; the second is a `NotImplementedError` in `repr()` caused by the fact that `basis()` is not implemented for abstract free modules.\n----\nNew commits:",
    "created_at": "2015-01-21T10:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108564",
    "user": "pbruin"
}
```

With the new commits, the category of free modules is `FreeModules(base_ring.category())` by default, and instead of taking the join with `FiniteEnumeratedSets` (if applicable), we add a `list()` method.

There are two doctest failures:

```
sage -t --long --warn-long 43.7 src/sage/matrix/matrix2.pyx  # 1 doctest failed
sage -t --long --warn-long 43.7 src/sage/modules/free_module.py  # 1 doctest failed
```

The first is caused by #11126; the second is a `NotImplementedError` in `repr()` caused by the fact that `basis()` is not implemented for abstract free modules.
----
New commits:



---

archive/issue_comments_108565.json:
```json
{
    "body": "Replying to [comment:48 pbruin]:\n> Indeed, the category of `GF(p)` is a join of three categories:\n> {{{\n> sage: GF(3).category()\n> Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups\n> }}}\n> Maybe parts of the category code (like `join`) should be transformed into Cython to make it faster?\n\nThat's one option, but ultimately taking joins is a a rather dynamic operation that needs to investigate quite a bit of the category graph in order to ensure it's safe to use what's cached (can the result of a join depend on changes elsewhere in the graph?). In the case of finite fields, there is *no* variation in what the category is: this thing can be created up front (to accommodate GF(2), which is always present if I'm not mistaken), and just be set to be the category. The current problem is that the joining of categories happens in some of the more generic construction routines. We'd need a way of signalling that we want to shortcut that (a precise_category keyword that percolates up perhaps?). That's an optimization strategy that may have more pay-off for this particular scenario than making \"join\" faster (which might still be worthwhile to do). In any case, that's for another ticket. Also: premature optimization etc. Thanks for looking into this.",
    "created_at": "2015-01-21T18:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108565",
    "user": "nbruin"
}
```

Replying to [comment:48 pbruin]:
> Indeed, the category of `GF(p)` is a join of three categories:
> {{{
> sage: GF(3).category()
> Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups
> }}}
> Maybe parts of the category code (like `join`) should be transformed into Cython to make it faster?

That's one option, but ultimately taking joins is a a rather dynamic operation that needs to investigate quite a bit of the category graph in order to ensure it's safe to use what's cached (can the result of a join depend on changes elsewhere in the graph?). In the case of finite fields, there is *no* variation in what the category is: this thing can be created up front (to accommodate GF(2), which is always present if I'm not mistaken), and just be set to be the category. The current problem is that the joining of categories happens in some of the more generic construction routines. We'd need a way of signalling that we want to shortcut that (a precise_category keyword that percolates up perhaps?). That's an optimization strategy that may have more pay-off for this particular scenario than making "join" faster (which might still be worthwhile to do). In any case, that's for another ticket. Also: premature optimization etc. Thanks for looking into this.



---

archive/issue_comments_108566.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-20T20:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108566",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108567.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-20T20:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108567",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_108568.json:
```json
{
    "body": "Everything should work again after this update.",
    "created_at": "2015-03-20T20:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108568",
    "user": "pbruin"
}
```

Everything should work again after this update.



---

archive/issue_comments_108569.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-21T10:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108569",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_108570.json:
```json
{
    "body": "Not everything...\n\n```\nsome tests failed:\nsage -t --long src/sage/matrix/matrix2.pyx  # 1 doctest failed\nsage -t --long src/sage/modular/modform/constructor.py  # 1 doctest failed\nsage -t --long src/sage/modular/modform/eisenstein_submodule.py  # 1 doctest failed\nsage -t --long src/sage/modular/modform/ambient_g1.py  # 1 doctest failed\nsage -t --long src/sage/modular/arithgroup/congroup_gamma0.py  # 1 doctest failed\n```\n",
    "created_at": "2015-03-21T10:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108570",
    "user": "vdelecroix"
}
```

Not everything...

```
some tests failed:
sage -t --long src/sage/matrix/matrix2.pyx  # 1 doctest failed
sage -t --long src/sage/modular/modform/constructor.py  # 1 doctest failed
sage -t --long src/sage/modular/modform/eisenstein_submodule.py  # 1 doctest failed
sage -t --long src/sage/modular/modform/ambient_g1.py  # 1 doctest failed
sage -t --long src/sage/modular/arithgroup/congroup_gamma0.py  # 1 doctest failed
```




---

archive/issue_comments_108571.json:
```json
{
    "body": "Replying to [comment:53 vdelecroix]:\n> Not everything...\n> {{{\n> some tests failed:\n> sage -t --long src/sage/matrix/matrix2.pyx  # 1 doctest failed\n> sage -t --long src/sage/modular/modform/constructor.py  # 1 doctest failed\n> sage -t --long src/sage/modular/modform/eisenstein_submodule.py  # 1 doctest failed\n> sage -t --long src/sage/modular/modform/ambient_g1.py  # 1 doctest failed\n> sage -t --long src/sage/modular/arithgroup/congroup_gamma0.py  # 1 doctest failed\n> }}}\nI just tested again with 6.6.rc0 and #11126 merged, and got no failures.  What kind of errors are you getting?",
    "created_at": "2015-03-21T19:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108571",
    "user": "pbruin"
}
```

Replying to [comment:53 vdelecroix]:
> Not everything...
> {{{
> some tests failed:
> sage -t --long src/sage/matrix/matrix2.pyx  # 1 doctest failed
> sage -t --long src/sage/modular/modform/constructor.py  # 1 doctest failed
> sage -t --long src/sage/modular/modform/eisenstein_submodule.py  # 1 doctest failed
> sage -t --long src/sage/modular/modform/ambient_g1.py  # 1 doctest failed
> sage -t --long src/sage/modular/arithgroup/congroup_gamma0.py  # 1 doctest failed
> }}}
I just tested again with 6.6.rc0 and #11126 merged, and got no failures.  What kind of errors are you getting?



---

archive/issue_comments_108572.json:
```json
{
    "body": "Replying to [comment:54 pbruin]:\n> Replying to [comment:53 vdelecroix]:\n>> ...\n> I just tested again with 6.6.rc0 and #11126 merged, and got no failures.  What kind of errors are you getting?\n\nStrange... I am launching the tests again.",
    "created_at": "2015-03-21T19:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108572",
    "user": "vdelecroix"
}
```

Replying to [comment:54 pbruin]:
> Replying to [comment:53 vdelecroix]:
>> ...
> I just tested again with 6.6.rc0 and #11126 merged, and got no failures.  What kind of errors are you getting?

Strange... I am launching the tests again.



---

archive/issue_comments_108573.json:
```json
{
    "body": "Please be aware of #17562 which also involves modules. Given that #10513 is mostly about the parent and #17562 is mostly about the elements, there is probably no conflict but I felt like I should mention this anyway.",
    "created_at": "2015-03-21T20:04:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108573",
    "user": "jdemeyer"
}
```

Please be aware of #17562 which also involves modules. Given that #10513 is mostly about the parent and #17562 is mostly about the elements, there is probably no conflict but I felt like I should mention this anyway.



---

archive/issue_comments_108574.json:
```json
{
    "body": "Results of the new test... most of the failures disappeared except one\n\n```\nsage -t --long src/sage/matrix/matrix2.pyx\n**********************************************************************\nFile \"src/sage/matrix/matrix2.pyx\", line 1931, in sage.matrix.matrix2.Matrix.minpoly\nFailed example:\n    m.minimal_polynomial()\nException raised:\n    Traceback (most recent call last):\n    ...\n    NotImplementedError: is_squarefree() is only implemented for polynomials over principal ideal domains\n**********************************************************************\n```\n",
    "created_at": "2015-03-21T20:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108574",
    "user": "vdelecroix"
}
```

Results of the new test... most of the failures disappeared except one

```
sage -t --long src/sage/matrix/matrix2.pyx
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 1931, in sage.matrix.matrix2.Matrix.minpoly
Failed example:
    m.minimal_polynomial()
Exception raised:
    Traceback (most recent call last):
    ...
    NotImplementedError: is_squarefree() is only implemented for polynomials over principal ideal domains
**********************************************************************
```




---

archive/issue_comments_108575.json:
```json
{
    "body": "Replying to [comment:57 vdelecroix]:\n> Results of the new test... most of the failures disappeared except one\n> {{{\n> sage -t --long src/sage/matrix/matrix2.pyx\n> **********************************************************************\n> File \"src/sage/matrix/matrix2.pyx\", line 1931, in sage.matrix.matrix2.Matrix.minpoly\n> Failed example:\n>     m.minimal_polynomial()\n> Exception raised:\n>     Traceback (most recent call last):\n>     ...\n>     NotImplementedError: is_squarefree() is only implemented for polynomials over principal ideal domains\n> **********************************************************************\n> }}}\nThis one is fixed by #11126.  (The other failures were probably fixed by #17578 which is in 6.6.rc0.)  I deliberately did not merge #11126 into this branch since I expected some discussion about it.  Maybe this particular failure can be fixed in a more minimalistic way than as part of #11126.",
    "created_at": "2015-03-23T10:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108575",
    "user": "pbruin"
}
```

Replying to [comment:57 vdelecroix]:
> Results of the new test... most of the failures disappeared except one
> {{{
> sage -t --long src/sage/matrix/matrix2.pyx
> **********************************************************************
> File "src/sage/matrix/matrix2.pyx", line 1931, in sage.matrix.matrix2.Matrix.minpoly
> Failed example:
>     m.minimal_polynomial()
> Exception raised:
>     Traceback (most recent call last):
>     ...
>     NotImplementedError: is_squarefree() is only implemented for polynomials over principal ideal domains
> **********************************************************************
> }}}
This one is fixed by #11126.  (The other failures were probably fixed by #17578 which is in 6.6.rc0.)  I deliberately did not merge #11126 into this branch since I expected some discussion about it.  Maybe this particular failure can be fixed in a more minimalistic way than as part of #11126.



---

archive/issue_comments_108576.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-23T13:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108576",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_108577.json:
```json
{
    "body": "Replying to [comment:56 jdemeyer]:\n> Please be aware of #17562 which also involves modules.\nAll tests pass after merging #17562 and the new dependency #18040.",
    "created_at": "2015-03-23T13:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108577",
    "user": "pbruin"
}
```

Replying to [comment:56 jdemeyer]:
> Please be aware of #17562 which also involves modules.
All tests pass after merging #17562 and the new dependency #18040.



---

archive/issue_comments_108578.json:
```json
{
    "body": "Is this then ready to go back to positive review? Vincent, did/could you run through the tests again?",
    "created_at": "2015-03-25T20:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108578",
    "user": "tscrim"
}
```

Is this then ready to go back to positive review? Vincent, did/could you run through the tests again?



---

archive/issue_comments_108579.json:
```json
{
    "body": "Note: #17562 is actually independent of this ticket; it merges cleanly and tests pass with or without it.  Also, I intentionally did not merge #18040 (or any other dependencies) into the branch here.  The only merge conflict was with #17561, which was fixed by Jeroen.",
    "created_at": "2015-03-25T21:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108579",
    "user": "pbruin"
}
```

Note: #17562 is actually independent of this ticket; it merges cleanly and tests pass with or without it.  Also, I intentionally did not merge #18040 (or any other dependencies) into the branch here.  The only merge conflict was with #17561, which was fixed by Jeroen.



---

archive/issue_comments_108580.json:
```json
{
    "body": "At least on my computer\n\n```\nAll tests passed!\n```\n",
    "created_at": "2015-03-26T21:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108580",
    "user": "vdelecroix"
}
```

At least on my computer

```
All tests passed!
```




---

archive/issue_comments_108581.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-27T07:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108581",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_108582.json:
```json
{
    "body": "Thanks Vincent. I'm going to set this (back) to positive review.",
    "created_at": "2015-03-27T07:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108582",
    "user": "tscrim"
}
```

Thanks Vincent. I'm going to set this (back) to positive review.



---

archive/issue_comments_108583.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-04-15T01:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108583",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_108584.json:
```json
{
    "body": "Merge conflict with 6.7.beta0",
    "created_at": "2015-04-15T01:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108584",
    "user": "vbraun"
}
```

Merge conflict with 6.7.beta0



---

archive/issue_comments_108585.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-15T10:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108585",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_108586.json:
```json
{
    "body": "There was only a minor conflict; I assume this doesn't need another review.",
    "created_at": "2015-04-15T10:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108586",
    "user": "pbruin"
}
```

There was only a minor conflict; I assume this doesn't need another review.



---

archive/issue_comments_108587.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-04-15T10:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108587",
    "user": "pbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_108588.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-15T13:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10460#issuecomment-108588",
    "user": "vbraun"
}
```

Resolution: fixed
