# Issue 17541: preparse behaviour

Issue created by migration from https://trac.sagemath.org/ticket/17778

Original creator: mantepse

Original creation time: 2015-02-13 17:34:23

Keywords: preparser

I noticed that apparently `preparse` treats a (multiline) string as comment, if the first non-whitespace character is a `#`:

```
    L = line.lstrip()
    if len(L) > 0 and L[0] in ['#', '!']:
        return line
```


I wonder why, because it is not unusual for a block of code to start with a comment.  I cannot see where comments in later lines are treated, so I have no idea how to fix this.


---

Comment by jdemeyer created at 2015-02-13 18:53:09

What exactly is the issue, I don't understand the description...


---

Comment by tscrim created at 2015-02-13 19:56:57

The issue is that when calling preparse, if the first line is a comment (IDK why it would start with a `!`...) then it does not preparse anything further. Specifically, if there is a multiline statement that you want to preparse, but the first line is a comment, it doesn't do anything. For example:

```
# Comment
def foo(x):
    R.<y> = QQ[]
    return x * y
```

would not get preparsed. Given the description, the preparser works on the assumption that the input is a specific self-contained line, but it seems to have the functionality to handle multi-line input. I think we should either see if there is a line break and then preparse the rest after the comment line or very explicitly state the assumption.


---

Comment by jdemeyer created at 2015-02-13 20:02:47

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-02-13 20:02:47

Not a bug.

`preparse` preparses single lines, not blocks of code.


---

Comment by jdemeyer created at 2015-02-13 20:02:52

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-02-13 20:28:02

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2015-02-13 20:28:02

I feel like this needs to a be little bit more explicitly documented.
----
New commits:


---

Comment by tscrim created at 2015-02-13 20:38:28

Actually, I'm not sure that is true. How are block comments with `"""` handled? It seems like they are passed as a group to `preparse()` by the interpreter after stripping out `....:`. So here's what I believe happens:

I type in

```
sage: def foo(x):
....:     return 5 * x
```

which gets fed to the interpreter, which results in

```
def foo(x):
    return 5 * x
```

which then gets sent to the preparser as a complete unit (a single string) and becomes

```
def foo(x):
    return Integer(5) * x
```

Unless I am misunderstanding something?


---

Comment by tscrim created at 2015-02-13 20:45:59

Changing status from needs_review to needs_info.


---

Comment by tscrim created at 2015-02-13 20:45:59

Okay, so it does things a little differently than I thought. The interpreter decides whether or not it needs to preparse a line. So the interpreter keeps track of whether you're in a comment or not. If it has a line break with a `\`, then it stitches the lines together. If it has a parenthesis with a line break, then it feeds that (with the `\n`) into the preparser as single string.

Although I can break the preparser by doing

```
sage: def foo(x):
....:     R.<x> = QQ[
....:     ]
```

So there is an issue with bad user input, but I'm not sure what to do about that.


---

Comment by slelievre created at 2021-03-25 05:41:05

Changing status from needs_info to needs_review.


---

Comment by slelievre created at 2021-03-25 05:41:05

Solved by #31043.

If you agree, remove the branch, move your name
from author to reviewer, and give positive review.


---

Comment by tscrim created at 2021-03-25 22:42:14

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-03-25 22:42:14

I agree this is fixed. It would be nice to do something about the error in comment:8, but I think that is expecting too much.


---

Comment by slelievre created at 2021-03-25 22:54:09

Resolution: duplicate
