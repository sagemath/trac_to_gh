# Issue 22405: Cythonize tensor product of crystals elements

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2017-03-19 00:08:43

CC:  sage-combinat bsalisbury1 aschilling alubovsky

Keywords: crystals

It is good to Cythonize things that can be called quite frequently.

I also go through and change the base class to `ClonableArray` from `CombinatorialElement`. This helps out things like the R-matrix computation, which relies heavily on hashing and is slow because `CombinatorialElement` uses the string representations to hash. However, all crystal elements should be hashable, so we can just hash the input.

I'm also taking this opportunity to do a little bit of extra cleanup of the methods.


---

Comment by tscrim created at 2017-03-19 00:17:40

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-03-19 00:17:40

With this branch, I get:

```
sage: T = crystals.Tableaux(['D',5], shape=[4,2,1])
sage: %time for x in T: x
CPU times: user 4.98 s, sys: 68 ms, total: 5.05 s
Wall time: 4.88 s
sage: La = RootSystem(['D',5,1]).weight_space().fundamental_weights()
sage: B = crystals.ProjectedLevelZeroLSPaths(La[3])
sage: %time L = [hash(x) for x in tensor([B,B])]
CPU times: user 11.2 s, sys: 52 ms, total: 11.2 s
Wall time: 11.1 s
```

vs the old

```
sage: T = crystals.Tableaux(['D',5], shape=[4,2,1])
sage: %time for x in T: x
CPU times: user 8.06 s, sys: 32 ms, total: 8.09 s
Wall time: 8.03 s
sage: La = RootSystem(['D',5,1]).weight_space().fundamental_weights()
sage: B = crystals.ProjectedLevelZeroLSPaths(La[3])
sage: %time L = [hash(x) for x in tensor([B,B])]
CPU times: user 12.5 s, sys: 52 ms, total: 12.6 s
Wall time: 12.5 s
```

This ticket might seem like a lot, but it is really fundamentally a move to a Cython file and doing some simple optimizations.


---

Comment by git created at 2017-03-19 20:17:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-04-17 18:13:44

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-04-17 18:13:44

many failing doctests


---

Comment by git created at 2017-04-17 23:14:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-04-17 23:17:00

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-04-17 23:17:00

This should take care of the failing doctests. If there are others, then its is a trivial sorting order thing, which is a little bit of a harder problem because of the poset nature of crystals.


---

Comment by aschilling created at 2017-04-17 23:33:47

Some trivial comments: 

- It should be "Tensor Products of Crystal Elements" not "Tensor Products of Crystals Elements"

- Your conventions for the descriptions are not always consistent. Sometimes you use upper case letter "- ``i`` -- An element of the index set" but sometimes you also use lower case letter "- ``i`` -- an element of the index set"


---

Comment by git created at 2017-04-18 00:15:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-04-18 00:16:02

Replying to [comment:6 aschilling]:
> - It should be "Tensor Products of Crystal Elements" not "Tensor Products of Crystals Elements"

Fixed.

> - Your conventions for the descriptions are not always consistent. Sometimes you use upper case letter "- ``i`` -- An element of the index set" but sometimes you also use lower case letter "- ``i`` -- an element of the index set" 

This was from the existing code and the move over. However, this is a good chance to move this to Sage's convention of lower case. Fixed.


---

Comment by chapoton created at 2017-04-19 14:36:49

still some failing doctests


---

Comment by git created at 2017-04-19 18:23:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-04-19 18:27:15

This should take care of those doctests. Some were trivial, but some exposed that element comparison was not working correctly. I made the element classes trivial Python subclasses, which makes the sorting work correctly. I don't know why, but it doesn't result in a change in the timings and is a good workaround for now. I would say this is a bug, but it is somewhere higher up. I don't know a MWE or where to look, but IMO it shouldn't block this ticket.


---

Comment by git created at 2017-04-23 22:24:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2017-04-28 23:21:35

With this branch Sage does not start after compilation on my computer.

```
...
[sagelib-8.0.beta2] real	0m4.607s
[sagelib-8.0.beta2] user	0m3.264s
[sagelib-8.0.beta2] sys	0m0.939s
"/Applications/sage/local/bin/sage-starts"

Testing that Sage starts...
[2017-04-28 16:17:10] SageMath version 8.0.beta2, Release Date: 2017-04-12
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
Sage failed to start up.
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and send the log file
  /Applications/sage/logs/start.log
Describe your computer, operating system, etc.
make[2]: *** [/Applications/sage/local/etc/sage-started.txt] Error 1
make[1]: *** [all] Error 2

real	15m3.416s
user	44m8.369s
sys	2m23.495s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make all'):

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

make: *** [all] Error 1
```



---

Comment by tscrim created at 2017-04-29 00:19:39

It looks like you upgraded to beta2 (via this branch) without running `make build`. I've never had any problems with building this branch (nor do the patchbots that work). Does Sage start for you on `develop`?


---

Comment by aschilling created at 2017-04-29 02:27:28

Replying to [comment:14 tscrim]:
> It looks like you upgraded to beta2 (via this branch) without running `make build`. I've never had any problems with building this branch (nor do the patchbots that work). Does Sage start for you on `develop`?

Yes, Sage runs for me on `develop`. I now remade the branch after `make distclean` and it is now running!


---

Comment by git created at 2017-04-29 06:25:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-04-29 06:27:35

I made one small tweak to force that the output ordering of those `dict`'s in `kirillov_reshetikhin.py` are ordered. After working on this ticket, I'm somewhat shocked those tests were passing beforehand. Anyways...now they should always be in the same order on every system.


---

Comment by git created at 2017-04-30 16:02:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-04-30 16:02:50

Rebased over #22429.


---

Comment by bsalisbury1 created at 2017-05-01 22:36:15

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-05-01 22:45:26

Thank you very much!!!


---

Comment by aschilling created at 2017-05-02 00:18:09

Hi Ben, did you actually check that none of the tests in tensor product got lost in the process of moving the file? I just want to make sure ... Anne


---

Comment by bsalisbury1 created at 2017-05-02 00:27:02

Hi Anne,

I did... By my check, there is nothing missing that should be there.  Thanks for keeping me honest!

Ben


---

Comment by vbraun created at 2017-05-04 18:32:09

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-05-04 18:32:09

PDF docs don't build


---

Comment by git created at 2017-05-04 19:34:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-04 19:35:59

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2017-05-04 19:35:59

Fixed in #22429, which introduced the typo.


---

Comment by vbraun created at 2017-05-08 21:18:56

Resolution: fixed
