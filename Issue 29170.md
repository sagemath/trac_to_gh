# Issue 29170: Fix a bug in residue_field and add get_place to rational function fields

Issue created by migration from https://trac.sagemath.org/ticket/29407

Original creator: klee

Original creation time: 2020-03-26 00:20:12

CC:  @brentbaccala

There is a bug in residue_field method:

```
sage: K.<a> = GF(16)
....: F.<x> = FunctionField(K)
....: p = F.places(1)[2]
....: 
sage: p
Place (x + a)
sage: R, from_R, to_R = p.residue_field()
sage: R
Finite Field in a of size 2^4
sage: to_R(x)
a
sage: _.parent()
Univariate Polynomial Ring in x over Finite Field in a of size 2^4
```


This bug was sneaked in by the recent introduction of function fields of characteristic zero into Sage.

We fix the bug. In addition, we add get_place() method to rational global function fields, which has been already introduced to global function fields.


---

Comment by git created at 2020-03-26 00:21:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2020-03-26 00:25:14

Changing status from new to needs_review.


---

Comment by git created at 2020-03-26 02:26:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @BrentBaccala created at 2020-03-27 22:59:41

Changing status from needs_review to needs_work.


---

Comment by @BrentBaccala created at 2020-03-27 22:59:41

I think that the characteristic zero case will still have the same problem, so give me a few days to update this ticket.


---

Comment by git created at 2020-03-27 23:52:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2020-04-06 00:29:53

Replying to [comment:6 gh-BrentBaccala]:
> I think that the characteristic zero case will still have the same problem, so give me a few days to update this ticket.

If you need more days, how about opening a separate ticket and letting this ticket move on?


---

Comment by git created at 2020-04-06 04:01:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @BrentBaccala created at 2020-04-06 04:07:58

OK, I've updated the ticket, but I've got a question.

First, what I've done is return to handling degree one prime ideals as a special case.  I don't see the need for the complexity of `_residue_field_global` in the degree one case.  Do you?

I've also added some test cases to try to catch this bug.

Now, my question: how should `_residue_field` handle elements with non-trivial denominators?  Right now, it just discards the denominator at the end of the function and calls `_to_R` on the numerator.  Is there some reason why this function will only be called on polynomials?  (I don't see any such restriction.)  If not, then I think it should operate on both the numerator and the denominator and raise, perhaps, `ZeroDivisorError`, if the denominator maps to zero.

Do you agree?


---

Comment by @BrentBaccala created at 2020-04-06 04:11:31

I also updated the docstring.  I don't think the old one was accurate, do you?


---

Comment by klee created at 2020-04-06 05:16:19

Replying to [comment:11 gh-BrentBaccala]:
> OK, I've updated the ticket, but I've got a question.
> 
> First, what I've done is return to handling degree one prime ideals as a special case.  I don't see the need for the complexity of `_residue_field_global` in the degree one case.  Do you?

I don't see a significant gain of treating the degree one case separately when the code works for general case. For some situations, the gain might be in performance increase. Here the gain seems negligible. I would revert this change.  

> I've also added some test cases to try to catch this bug.

Ok.

> Now, my question: how should `_residue_field` handle elements with non-trivial denominators?  Right now, it just discards the denominator at the end of the function and calls `_to_R` on the numerator.  Is there some reason why this function will only be called on polynomials?  (I don't see any such restriction.)  

As the docstring says, `_residue_field` treat elements in k[x].

> If not, then I think it should operate on both the numerator and the denominator and raise, perhaps, `ZeroDivisorError`, if the denominator maps to zero.
> Do you agree?

No. Those cases treated in the `residue_field` code for `places`.


---

Comment by klee created at 2020-04-06 05:17:03

Replying to [comment:12 gh-BrentBaccala]:
> I also updated the docstring.  I don't think the old one was accurate, do you?

The new ones are still inaccurate. I revised them again.


---

Comment by git created at 2020-04-06 05:19:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2020-04-06 05:21:14

Changing status from needs_work to needs_review.


---

Comment by @BrentBaccala created at 2020-04-06 17:13:36

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-04-06 20:04:39

please add the missing reviewer full name


---

Comment by klee created at 2020-04-07 00:21:26

Positive review on the partner's code. Thanks.


---

Comment by vbraun created at 2020-04-18 08:34:58

Resolution: fixed
