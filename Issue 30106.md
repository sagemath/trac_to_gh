# Issue 30106: Graphs: point-graph of generalised polygons

Issue created by migration from https://trac.sagemath.org/ticket/30343

Original creator: @Ivo-Maffei

Original creation time: 2020-08-12 09:49:18

CC:  dimpase

Added constructions to obtain distance-regular graphs from generalised polygons.


---

Comment by @Ivo-Maffei created at 2020-08-12 09:50:18

Changing status from new to needs_review.


---

Comment by @Ivo-Maffei created at 2020-08-12 09:50:18

Last 10 new commits:


---

Comment by dimpase created at 2020-08-12 10:03:30

should I review this before #29886 is fixed (or removed from the deps chain here)?


---

Comment by @Ivo-Maffei created at 2020-08-12 10:15:12

Changing status from needs_review to needs_work.


---

Comment by @Ivo-Maffei created at 2020-08-12 10:15:12

Replying to [comment:2 dimpase]:
> should I review this before #29886 is fixed (or removed from the deps chain here)?
Oops, I rushed this out...
I think I'll remove #29886 from the dependency chain and update all tickets.
Once we decide on something for #29886, I'll make a quick patch.


---

Comment by git created at 2020-08-12 14:00:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-27 08:35:00

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @Ivo-Maffei created at 2020-08-27 08:35:20

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-08-27 12:48:58

this is incorrect:

```
+        ValueError: generalised octagons of order (q, q^2) exist only for q odd powers of 2
```

what's correct that only for these values of q a construction is known.

Please also check for similar incorrect things elsewhere in this code.


---

Comment by @Ivo-Maffei created at 2020-08-27 19:33:25

Replying to [comment:7 dimpase]:

I'm apologise for the late reply.

> this is incorrect:
> {{{
> +        ValueError: generalised octagons of order (q, q^2) exist only for q odd powers of 2
> }}}
> what's correct that only for these values of q a construction is known.
With the latest commit (5367858) I changed all such error messages.
Now the above should read:

```
ValueError(("generalised octagons of order (q, q^2) "
            "are known only for q odd powers of 2"))
```



---

Comment by git created at 2020-08-28 21:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-28 21:42:44

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-28 21:42:44

OK, looks good.


---

Comment by git created at 2020-09-13 09:23:01

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-09-13 09:23:01

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by @Ivo-Maffei created at 2020-09-13 09:26:19

I merged the last beta and the last changes to #30337. 
The patch box had a weird error with the documentation of `UstimenkoGraph`. I couldn't understand what was wrong so I'll check if the issue is still there after this merging.


---

Comment by git created at 2020-09-13 12:21:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-09-13 12:22:21

The patchbot still complains about the docstrings, but I can't see any issue in the built html.


---

Comment by chapoton created at 2020-09-13 14:48:10

There should be no space before colons

```
++    while edges :
++            try :
```

This is a typography rule.

And importing something from sagenb does not look right, as sagenb is plain dead.

EDIT: you can safely forget about the patchbot complaints in graph_database.py, even if they point to real problems.


---

Comment by git created at 2020-09-13 14:48:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-13 14:50:16

this fixes the 2nd of the pyflakes complaints:

```
src/sage/graphs/graph_database.py:421:47 undefined name 'subgraphs_to_data'
src/sage/graphs/graph_database.py:945:9 'sagenb.notebook.interact.input_grid' imported but unused
```


the 1st looks like a bug, just never tested that code.


---

Comment by chapoton created at 2020-09-13 14:53:26

yes, both are bugs. Probably many things are broken, even if only because they depend on sagenb


---

Comment by git created at 2020-09-13 15:17:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-13 15:20:14

Replying to [comment:15 chapoton]:
> There should be no space before colons
> {{{
> ++    while edges :
> ++            try :
> }}}
> This is a typography rule.

OK, thanks, that's fixed. The bot is mis-reporting the locations where these are, though.

> 
> EDIT: you can safely forget about the patchbot complaints in graph_database.py, even if they point to real problems.

yeah, that is a legacy code...


---

Comment by dimpase created at 2020-09-13 22:18:09

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-09-13 22:18:09

ok


---

Comment by vbraun created at 2020-09-26 18:15:31

On some but not all machines I'm getting

```
**********************************************************************
File "src/sage/graphs/generators/distance_regular.pyx", line 1714, in sage.graphs.generators.distance_regular._line_graph_generalised_polygon
Failed example:
    G = graphs.GeneralisedHexagonGraph(3, 3)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.distance_regular._line_graph_generalised_polygon[4]>", line 1, in <module>
        G = graphs.GeneralisedHexagonGraph(Integer(3), Integer(3))
      File "sage/graphs/generators/distance_regular.pyx", line 1587, in sage.graphs.generators.distance_regular.GeneralisedHexagonGraph (build/cythonized/sage/graphs/generators/distance_regular.c:25912)
        orb = libgap.Orbit(matrixRep, e1, libgap.OnLines)
      File "sage/libs/gap/element.pyx", line 2525, in sage.libs.gap.element.GapElement_Function.__call__ (build/cythonized/sage/libs/gap/element.c:19781)
        sig_on()
    sage.libs.gap.util.GAPError: Error, no method found! Error, no 1st choice method found for `GeneratorsOfMagmaWithInverses' on 1 arguments
    The 1st argument is 'fail' which might point to an earlier problem
**********************************************************************
```

Same when running manually: 

```
sage: graphs.GeneralisedHexagonGraph(3, 3) 
....:                                                                                                                                                            
---------------------------------------------------------------------------
GAPError                                  Traceback (most recent call last)
<ipython-input-1-6dbe64b36795> in <module>
----> 1 graphs.GeneralisedHexagonGraph(Integer(3), Integer(3))

~/slave/sage_git/build/local/lib/python3.8/site-packages/sage/graphs/generators/distance_regular.pyx in sage.graphs.generators.distance_regular.GeneralisedHexagonGraph (build/cythonized/sage/graphs/generators/distance_regular.c:25912)()
   1585             matrixRep = libgap.AtlasGroup("G2(3)", libgap.Position, 7)
   1586             e1 = vector(GF(3), [1, 0, 0, 0, 0, 0, 0])
-> 1587             orb = libgap.Orbit(matrixRep, e1, libgap.OnLines)
   1588             group = libgap.Action(matrixRep, orb, libgap.OnLines)
   1589 

~/slave/sage_git/build/local/lib/python3.8/site-packages/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement_Function.__call__ (build/cythonized/sage/libs/gap/element.c:19781)()
   2523         try:
   2524             sig_GAP_Enter()
-> 2525             sig_on()
   2526             if n == 0:
   2527                 result = CALL_0ARGS(self.value)

GAPError: Error, no method found! Error, no 1st choice method found for `GeneratorsOfMagmaWithInverses' on 1 arguments
The 1st argument is 'fail' which might point to an earlier problem
sage:                                                                                                                                                            
Exiting Sage (CPU time 0m1.43s, Wall time 0m15.41s).
```



---

Comment by vbraun created at 2020-09-26 18:15:31

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2020-09-27 13:08:56

I cannot reproduce this (neither with python 3.7 or 3.8, neither with the currenly Sage's GAP, nor with GAP 4.11 update, with or without gap_packages installed) - do you actually have working libgap on these machines?


---

Comment by git created at 2020-09-27 13:26:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2020-09-27 16:05:01

It might be one of the dependent tickets...


---

Comment by dimpase created at 2020-09-27 16:41:03

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2020-09-27 16:41:03

Replying to [comment:25 vbraun]:
> It might be one of the dependent tickets...

Do you mean to say you mass-test some more tickets along with this one and  attribute the error you see to this one?

I'm setting this to positive review, as I don't see what work  can be done here.


---

Comment by vbraun created at 2020-10-03 10:20:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-10-03 10:20:46

Its definitely this ticket thats failing. Possibly running out of memory, prematurely garbage collecting, or generator choice...


---

Comment by vbraun created at 2020-10-03 22:42:18


```
sage: libgap.AtlasGroup("G2(3)")                                                                                                                   
fail
```



---

Comment by vbraun created at 2020-10-03 22:54:19

After installing gap_packages:

```
sage: libgap.AtlasGroup("G2(3)")                                                                                                                   
<matrix group of size 4245696 with 2 generators>
sage: graphs.GeneralisedHexagonGraph(3, 3)                                                                                                         
Generalised hexagon of order (3, 3): Graph on 364 vertices
```



---

Comment by @Ivo-Maffei created at 2020-10-03 22:56:47

The test is marked with gap_packages. Is the syntax wrong or is an issue with the testing?


---

Comment by mkoeppe created at 2020-12-14 18:25:08

This ticket seems to be blocking a number of positively reviewed tickets that have it as a dependency


---

Comment by dcoudert created at 2020-12-14 22:41:22

I tried this ticket before and after installing `gap_packages` and I measured the memory used while testing the ticket. For me the ticket looks ok, so I don't know why the some bots are failing.


```
sapristi:sage dcoudert$ /usr/bin/time -l ./sage -t --long src/sage/graphs/generators/distance_regular.pyx
Running doctests with ID 2020-12-12-10-37-04-0c0dc92b.
Git branch: HEAD
Using --optional=bliss,build,dochtml,homebrew,pip,python_igraph,sage,sage_numerical_backends_cplex,sage_spkg,tdlib,texttable
Doctesting 1 file.
sage -t --long --warn-long 203.5 --random-seed=0 src/sage/graphs/generators/distance_regular.pyx
    [129 tests, 178.33 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 178.5 seconds
    cpu time: 177.3 seconds
    cumulative wall time: 178.3 seconds
      193.93 real       179.36 user         5.70 sys
 433836032  maximum resident set size
         0  average shared memory size
         0  average unshared data size
         0  average unshared stack size
    472070  page reclaims
      6723  page faults
         0  swaps
         0  block input operations
         0  block output operations
         0  messages sent
         0  messages received
       156  signals received
      5180  voluntary context switches
     93942  involuntary context switches
```



```
sapristi:sage dcoudert$ /usr/bin/time -l ./sage -t --long src/sage/graphs/generators/distance_regular.pyx
Forcing sage-location, probably because a new package was installed.
Cleaning up, do not interrupt this.
Done cleaning.
Running doctests with ID 2020-12-12-11-40-44-e3fae3fc.
Git branch: develop
Using --optional=bliss,build,dochtml,gap_packages,homebrew,libsemigroups,pip,python_igraph,sage,sage_numerical_backends_cplex,sage_spkg,tdlib,texttable
Doctesting 1 file.
sage -t --long --warn-long 203.5 --random-seed=0 src/sage/graphs/generators/distance_regular.pyx
    [105 tests, 195.51 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 195.6 seconds
    cpu time: 186.3 seconds
    cumulative wall time: 195.5 seconds
      207.59 real       187.34 user         5.13 sys
 450232320  maximum resident set size
         0  average shared memory size
         0  average unshared data size
         0  average unshared stack size
    467254  page reclaims
     13861  page faults
         0  swaps
         0  block input operations
         0  block output operations
         0  messages sent
         0  messages received
       170  signals received
      7876  voluntary context switches
    189530  involuntary context switches
```



---

Comment by chapoton created at 2020-12-15 10:26:14

maybe there is a line missing the tag ?

```
+         sage: G = graphs.GeneralisedHexagonGraph(3, 3)
```



---

Comment by dcoudert created at 2020-12-15 10:32:59

Right, may be we should tag all the tests of these methods with `gap_packages`, even the trivial ones


---

Comment by dimpase created at 2020-12-15 11:27:46

GAP is used here. As GAP has been finally updated to 4.11 in the latest beta, let's retest this ticket and see if it works.


---

Comment by git created at 2020-12-15 12:01:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-12-15 12:03:59

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-12-15 12:03:59

rebased and added a missing tag in https://git.sagemath.org/sage.git/commit/?id=1ade78be95f0ffe4885917bc9ce36196d2b6d5e6


---

Comment by dcoudert created at 2020-12-15 12:30:41

you must also tag the 2 lines after in the test. Depends on the result.


---

Comment by git created at 2020-12-15 13:46:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-12-15 13:46:49

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-12-15 13:46:49

OK, it all works now.


---

Comment by vbraun created at 2020-12-27 00:23:19

Resolution: fixed
