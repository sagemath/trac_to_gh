# Issue 17571: Preparse integers as strings

archive/issues_017571.json:
```json
{
    "body": "Currently we have\n\n```\nsage: print preparse(\"100\")\nInteger(100)\nsage: preparse(\"100.0\")\nRealNumber('100.0')\n```\n\nbut the first could be changed to\n\n```\nsage: print preparse(\"100\")\nInteger('100')\n```\n\n\nThis has two advantages:\n\n1. it would also be a lot faster since MPIR parses large string constants faster than Python:\n\n```\nsage: s=\"1\" + \"0\"*10000\nsage: timeit(\"\"\"eval(\"%s\")\"\"\" % s)\n625 loops, best of 3: 751 \u00b5s per loop\nsage: timeit(\"\"\"eval('Integer(\"%s\")')\"\"\" % s)\n625 loops, best of 3: 151 \u00b5s per loop\n```\n\n\n2. It solves #17807: thanks to #17413, entering `0100` will give a deprecation warning so at users should know something funny is going on when they enter `0100`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17808\n\n",
    "created_at": "2015-02-19T08:31:31Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "title": "Preparse integers as strings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17571",
    "user": "jdemeyer"
}
```
Currently we have

```
sage: print preparse("100")
Integer(100)
sage: preparse("100.0")
RealNumber('100.0')
```

but the first could be changed to

```
sage: print preparse("100")
Integer('100')
```


This has two advantages:

1. it would also be a lot faster since MPIR parses large string constants faster than Python:

```
sage: s="1" + "0"*10000
sage: timeit("""eval("%s")""" % s)
625 loops, best of 3: 751 µs per loop
sage: timeit("""eval('Integer("%s")')""" % s)
625 loops, best of 3: 151 µs per loop
```


2. It solves #17807: thanks to #17413, entering `0100` will give a deprecation warning so at users should know something funny is going on when they enter `0100`.

Issue created by migration from https://trac.sagemath.org/ticket/17808





---

archive/issue_comments_234525.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-21T20:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234525",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_234526.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-21T20:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234526",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_234527.json:
```json
{
    "body": "I would think the slow-down for small integers makes the proposed changes very unattractive. The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one, and hence conversion is much faster.\n\nFor instance, in code like:\n\n```\nsage: %timeit L=[Integer('1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') for i in range(10000r)]\n100 loops, best of 3: 11.4 ms per loop\nsage: %timeit L=[Integer(1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) for i in range(10000r)]\n100 loops, best of 3: 4.66 ms per loop\n```\n\nyou really start to notice this.\n\npreparse_file mitigates issues like this a little bit by factoring out numeric constants, so that their conversion doesn't happen in inner loops.\n\nIf you want to store your numerical constants as strings in the byte code and have fast conversion, you should probably store them in hex. It's a little more work in the preparser, but the result is more compact and conversion to a numerical constant is truly linear in number of bits.",
    "created_at": "2015-02-22T08:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234527",
    "user": "nbruin"
}
```

I would think the slow-down for small integers makes the proposed changes very unattractive. The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one, and hence conversion is much faster.

For instance, in code like:

```
sage: %timeit L=[Integer('1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') for i in range(10000r)]
100 loops, best of 3: 11.4 ms per loop
sage: %timeit L=[Integer(1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) for i in range(10000r)]
100 loops, best of 3: 4.66 ms per loop
```

you really start to notice this.

preparse_file mitigates issues like this a little bit by factoring out numeric constants, so that their conversion doesn't happen in inner loops.

If you want to store your numerical constants as strings in the byte code and have fast conversion, you should probably store them in hex. It's a little more work in the preparser, but the result is more compact and conversion to a numerical constant is truly linear in number of bits.



---

archive/issue_comments_234528.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one\nIs that really important? The \"timeit\" example is of course a bit artificial.",
    "created_at": "2015-02-22T09:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234528",
    "user": "jdemeyer"
}
```

Replying to [comment:5 nbruin]:
> The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one
Is that really important? The "timeit" example is of course a bit artificial.



---

archive/issue_comments_234529.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Replying to [comment:5 nbruin]:\n> > The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one\n> Is that really important? The \"timeit\" example is of course a bit artificial.\n\nI think so. Storing the numerical constant as a string forces the decimal-to-binary conversion to happen at runtime. If you just write it as a python integer, the conversion happens at parsing, so by the time it's an ast and the compiler looks at it, you're already dealing with an integer. \n\nUnfortunately, python doesn't permit compile-time macros (perhaps if we're ever going to rewrite our preparser to properly parse, we can combine it with [MacroPy](https://pypi.python.org/pypi/MacroPy) and then we can have `Integer` object creation at compile time)\n\nI am fairly certain that nearly all code that gets run with sage has TONS of small integer literals in it. Probably for many applications, people would get better performance writing `100r`, but of course nobody will. This ticket would deteriorate the much more common situation in favour of a small gain in the extremely rare situation that someone wants to include an incredibly large integer literal in their code (talk about artificial--I don't think having a (small) numerical literal in an inner loop is artificial at all!). And the extremely rare situation can be solved by writing quotes already (and by the time you're writing such a long string you might as well convert it to hex anyway, in which case Python and GMP are (at least asymptotically) comparable.\n\nIf you use `preparse_file` instead of `preparse`, you'll see that numerical constants get pushed outside (which has its own set of problems, see #11542), which mitigates the string-conversion-in-inner-loop.",
    "created_at": "2015-02-22T18:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234529",
    "user": "nbruin"
}
```

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 nbruin]:
> > The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one
> Is that really important? The "timeit" example is of course a bit artificial.

I think so. Storing the numerical constant as a string forces the decimal-to-binary conversion to happen at runtime. If you just write it as a python integer, the conversion happens at parsing, so by the time it's an ast and the compiler looks at it, you're already dealing with an integer. 

Unfortunately, python doesn't permit compile-time macros (perhaps if we're ever going to rewrite our preparser to properly parse, we can combine it with [MacroPy](https://pypi.python.org/pypi/MacroPy) and then we can have `Integer` object creation at compile time)

I am fairly certain that nearly all code that gets run with sage has TONS of small integer literals in it. Probably for many applications, people would get better performance writing `100r`, but of course nobody will. This ticket would deteriorate the much more common situation in favour of a small gain in the extremely rare situation that someone wants to include an incredibly large integer literal in their code (talk about artificial--I don't think having a (small) numerical literal in an inner loop is artificial at all!). And the extremely rare situation can be solved by writing quotes already (and by the time you're writing such a long string you might as well convert it to hex anyway, in which case Python and GMP are (at least asymptotically) comparable.

If you use `preparse_file` instead of `preparse`, you'll see that numerical constants get pushed outside (which has its own set of problems, see #11542), which mitigates the string-conversion-in-inner-loop.



---

archive/issue_comments_234530.json:
```json
{
    "body": "Fine, you convinced me.",
    "created_at": "2015-02-22T19:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234530",
    "user": "jdemeyer"
}
```

Fine, you convinced me.



---

archive/issue_comments_234531.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-22T19:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234531",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_234532.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-02-24T14:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234532",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_234533.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-24T15:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234533",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_234534.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-19T08:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234534",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_234535.json:
```json
{
    "body": "Changing component from misc to python3.",
    "created_at": "2016-05-02T13:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234535",
    "user": "jdemeyer"
}
```

Changing component from misc to python3.



---

archive/issue_comments_234536.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-02T15:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234536",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_234537.json:
```json
{
    "body": "is the title still acurately describing the content of the ticket ?",
    "created_at": "2016-05-29T18:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234537",
    "user": "chapoton"
}
```

is the title still acurately describing the content of the ticket ?



---

archive/issue_comments_234538.json:
```json
{
    "body": "Replying to [comment:17 chapoton]:\n> is the title still acurately describing the content of the ticket ?\n\nYes.",
    "created_at": "2016-05-29T19:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234538",
    "user": "jdemeyer"
}
```

Replying to [comment:17 chapoton]:
> is the title still acurately describing the content of the ticket ?

Yes.



---

archive/issue_comments_234539.json:
```json
{
    "body": "Although the ticket does change a little bit more than that, I added a sentence to the description.",
    "created_at": "2016-05-29T19:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234539",
    "user": "jdemeyer"
}
```

Although the ticket does change a little bit more than that, I added a sentence to the description.



---

archive/issue_comments_234540.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-29T19:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234540",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_234541.json:
```json
{
    "body": "ok, looks good to me",
    "created_at": "2016-05-29T19:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234541",
    "user": "chapoton"
}
```

ok, looks good to me



---

archive/issue_comments_234542.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-31T07:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17571#issuecomment-234542",
    "user": "vbraun"
}
```

Resolution: fixed
