# Issue 32707: pyzmq: Fix build error on cygwin

Issue created by migration from https://trac.sagemath.org/ticket/32944

Original creator: mkoeppe

Original creation time: 2021-11-28 04:16:57

CC:  dimpase slelievre

Follow up after #32828.


```
Installing pyzmq-22.3.0
Processing /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src
  Preparing metadata (pyproject.toml): started
  Running command /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs
  running dist_info
  creating /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info
  writing /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/PKG-INFO
  writing dependency_links to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/dependency_links.txt
  writing requirements to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/requires.txt
  writing top-level names to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/top_level.txt
  writing manifest file '/tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/SOURCES.txt'
  running configure
  /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/setuptools/_distutils/dist.py:275: UserWarning: Unknown distribution option: 'cffi_modules'
    warnings.warn(msg)
  {'libraries': ['zmq'], 'include_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include'], 'library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'runtime_library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'extra_link_args': []}
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o
  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.exe
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information
  collect2: error: ld returned 1 exit status
  Warning: No sys/un.h, IPC_PATH_MAX_LEN will be undefined: command '/usr/bin/gcc' failed with exit code 1
  Configure: Autodetecting ZMQ settings...
      Custom ZMQ dir:       /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36
  ************************************************
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -Izmq/utils -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o
  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -lzmq -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.exe
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information
  collect2: error: ld returned 1 exit status

  error: command '/usr/bin/gcc' failed with exit code 1

  Fatal: Falling back on bundled libzmq, but config has explicitly prohibited building the libzmq extension.
  Preparing metadata (pyproject.toml): finished with status 'error'
WARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.
```



---

Comment by mkoeppe created at 2021-11-28 06:23:29

Looks like this is more fallout from using `SETUPTOOLS_USE_DISTUTILS=local`, see https://github.com/pypa/distutils/pull/60#issuecomment-980846735


---

Comment by mkoeppe created at 2021-11-28 06:24:05

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-11-28 07:13:06

Last 10 new commits:


---

Comment by mkoeppe created at 2021-11-28 20:26:32

With this ticket, 
https://github.com/mkoeppe/sage/actions/runs/1512139060 shows in `cygwin-stage-ii-d`:

```
[pyzmq-22.3.0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/pyzmq-22.3.0.log
  [pyzmq-22.3.0] successfully installed.
```

(the build stage fails later because of the unrelated issue #32945).


---

Comment by mkoeppe created at 2021-11-28 20:26:32

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-28 20:26:45

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-12-01 20:03:48

Anyone willing to give this a positive review based on the GH Actions run?


---

Comment by dimpase created at 2021-12-01 21:05:44

lgtm


---

Comment by dimpase created at 2021-12-01 21:05:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-12 15:09:27

Resolution: fixed
