# Issue 32707: pyzmq: Fix build error on cygwin

archive/issues_032707.json:
```json
{
    "body": "CC:  @dimpase @slel\n\nFollow up after #32828.\n\n\n```\nInstalling pyzmq-22.3.0\nProcessing /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src\n  Preparing metadata (pyproject.toml): started\n  Running command /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs\n  running dist_info\n  creating /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info\n  writing /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/PKG-INFO\n  writing dependency_links to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/dependency_links.txt\n  writing requirements to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/requires.txt\n  writing top-level names to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/top_level.txt\n  writing manifest file '/tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/SOURCES.txt'\n  running configure\n  /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/setuptools/_distutils/dist.py:275: UserWarning: Unknown distribution option: 'cffi_modules'\n    warnings.warn(msg)\n  {'libraries': ['zmq'], 'include_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include'], 'library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'runtime_library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'extra_link_args': []}\n  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o\n  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.exe\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information\n  collect2: error: ld returned 1 exit status\n  Warning: No sys/un.h, IPC_PATH_MAX_LEN will be undefined: command '/usr/bin/gcc' failed with exit code 1\n  Configure: Autodetecting ZMQ settings...\n      Custom ZMQ dir:       /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36\n  ************************************************\n  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -Izmq/utils -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o\n  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -lzmq -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.exe\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information\n  collect2: error: ld returned 1 exit status\n\n  error: command '/usr/bin/gcc' failed with exit code 1\n\n  Fatal: Falling back on bundled libzmq, but config has explicitly prohibited building the libzmq extension.\n  Preparing metadata (pyproject.toml): finished with status 'error'\nWARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32944\n\n",
    "created_at": "2021-11-28T04:16:57Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "pyzmq: Fix build error on cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32707",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @slel

Follow up after #32828.


```
Installing pyzmq-22.3.0
Processing /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src
  Preparing metadata (pyproject.toml): started
  Running command /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs
  running dist_info
  creating /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info
  writing /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/PKG-INFO
  writing dependency_links to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/dependency_links.txt
  writing requirements to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/requires.txt
  writing top-level names to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/top_level.txt
  writing manifest file '/tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/SOURCES.txt'
  running configure
  /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/setuptools/_distutils/dist.py:275: UserWarning: Unknown distribution option: 'cffi_modules'
    warnings.warn(msg)
  {'libraries': ['zmq'], 'include_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include'], 'library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'runtime_library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'extra_link_args': []}
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o
  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.exe
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information
  collect2: error: ld returned 1 exit status
  Warning: No sys/un.h, IPC_PATH_MAX_LEN will be undefined: command '/usr/bin/gcc' failed with exit code 1
  Configure: Autodetecting ZMQ settings...
      Custom ZMQ dir:       /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36
  ************************************************
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -Izmq/utils -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o
  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -lzmq -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.exe
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information
  collect2: error: ld returned 1 exit status

  error: command '/usr/bin/gcc' failed with exit code 1

  Fatal: Falling back on bundled libzmq, but config has explicitly prohibited building the libzmq extension.
  Preparing metadata (pyproject.toml): finished with status 'error'
WARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.
```


Issue created by migration from https://trac.sagemath.org/ticket/32944





---

archive/issue_comments_465995.json:
```json
{
    "body": "Looks like this is more fallout from using `SETUPTOOLS_USE_DISTUTILS=local`, see https://github.com/pypa/distutils/pull/60#issuecomment-980846735",
    "created_at": "2021-11-28T06:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-465995",
    "user": "https://github.com/mkoeppe"
}
```

Looks like this is more fallout from using `SETUPTOOLS_USE_DISTUTILS=local`, see https://github.com/pypa/distutils/pull/60#issuecomment-980846735



---

archive/issue_comments_465996.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-11-28T06:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-465996",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_465997.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-11-28T07:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-465997",
    "user": "https://github.com/mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_465998.json:
```json
{
    "body": "With this ticket, \nhttps://github.com/mkoeppe/sage/actions/runs/1512139060 shows in `cygwin-stage-ii-d`:\n\n```\n[pyzmq-22.3.0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/pyzmq-22.3.0.log\n  [pyzmq-22.3.0] successfully installed.\n```\n\n(the build stage fails later because of the unrelated issue #32945).",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-465998",
    "user": "https://github.com/mkoeppe"
}
```

With this ticket, 
https://github.com/mkoeppe/sage/actions/runs/1512139060 shows in `cygwin-stage-ii-d`:

```
[pyzmq-22.3.0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/pyzmq-22.3.0.log
  [pyzmq-22.3.0] successfully installed.
```

(the build stage fails later because of the unrelated issue #32945).



---

archive/issue_comments_465999.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-465999",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_466000.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-11-28T20:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-466000",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_466001.json:
```json
{
    "body": "Anyone willing to give this a positive review based on the GH Actions run?",
    "created_at": "2021-12-01T20:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-466001",
    "user": "https://github.com/mkoeppe"
}
```

Anyone willing to give this a positive review based on the GH Actions run?



---

archive/issue_comments_466002.json:
```json
{
    "body": "lgtm",
    "created_at": "2021-12-01T21:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-466002",
    "user": "https://github.com/dimpase"
}
```

lgtm



---

archive/issue_comments_466003.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-01T21:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-466003",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_466004.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-12T15:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32707#issuecomment-466004",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_029654.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32707",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32707#event-29654"
}
```
