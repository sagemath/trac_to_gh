# Issue 27459: py3: deprecate long and __long__, and remove doctesting special-case for long

Issue created by migration from https://trac.sagemath.org/ticket/27696

Original creator: jhpalmieri

Original creation time: 2019-04-17 19:35:10

CC:  mkoeppe

The main point of this ticket is this change:

```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 4b222dd1db..d97034090f 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -2377,20 +2377,11 @@ class DocTestTask(object):
         sage: sorted(results.keys())
         ['cputime', 'err', 'failures', 'optionals', 'tests', 'walltime', 'walltime_skips']
     """
-
-    if six.PY2:
-        extra_globals = {}
-    else:
-        extra_globals = {'long': int}
+    extra_globals = {}
     """
     Extra objects to place in the global namespace in which tests are run.
     Normally this should be empty but there are special cases where it may
     be useful.
-
-    In particular, on Python 3 add ``long`` as an alias for ``int`` so that
-    tests that use the ``long`` built-in (of which there are many) still pass.
-    We do this so that the test suite can run on Python 3 while Python 2 is
-    still the default.
     """
 
     def __init__(self, source):
```

With Python 3 doctesting, `long` has been automatically converted to `int`. It would be better to not have such a big difference in the behavior of doctesting vs. ordinary Sage usage: with Python 3, evaluating `long(3)` would fail at the command line but work in doctesting.


---

Comment by jhpalmieri created at 2019-04-17 19:39:15

There are a few places where there should be deprecations but there are not: in rational.pyx and integer.pyx, deprecations lead to deprecations warnings all over the place in the Sage library. In `complex_double.pyx`, for example, the `__long__` method just raises an error, and it seemed that deprecating such a method has no effect: the deprecation warning is not printed, just the error is.
----
New commits:


---

Comment by jhpalmieri created at 2019-04-17 19:39:15

Changing status from new to needs_review.


---

Comment by embray created at 2019-05-13 10:01:37

This was done this way very intentionally in #24559, in large part to avoid such a massive patch like this.

It would be better I think to wait until Python 2 support is dropped completely.


---

Comment by embray created at 2019-05-13 10:01:37

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2019-05-13 17:23:17

Right, but that was a year ago. I see no reason to wait until Python 2 support is dropped completely, although if you prefer, we can do this incrementally: say, first add `# py2` to a bunch of doctests of the form

```
sage: long(blah)
```

We should also deprecate `__long__` for various classes. When the appropriate pieces are in place, turn off the conversion `long --> int` in Python 3 doctesting.

The current situation is very misleading, where a doctest will pass with Python 3 but the same code will fail if run by hand.


---

Comment by embray created at 2019-05-13 18:42:24

Replying to [comment:4 jhpalmieri]:
> The current situation is very misleading, where a doctest will pass with Python 3 but the same code will fail if run by hand.

There are many cases like that where the doctests don't work quite the same on Python 3 but in mostly trivial ways which are made transparent by the doctest framework.  I think that's ok, personally.

However, I do like the idea of adding deprecation warnings to `__long__`.  What if as a middle ground we started with just that part?


---

Comment by jhpalmieri created at 2019-05-13 22:41:02

Changing status from needs_work to needs_info.


---

Comment by jdemeyer created at 2019-05-16 12:46:53

Replying to [comment:5 embray]:
> However, I do like the idea of adding deprecation warnings to `__long__`.

I disagree, we shouldn't deprecate `__long__`, it's a standard Python feature. But let's discuss at #27826.


---

Comment by jdemeyer created at 2019-05-16 13:35:36

Also, I don't see how deprecating `__long__` helps to achieve the goal of this ticket. Adding the `# py2` flags to all doctests involving `long(...)` should be sufficient.


---

Comment by jhpalmieri created at 2020-04-19 22:56:32

#27826 may now take care of this entire issue. If #27826 is merged, this can be closed.


---

Comment by chapoton created at 2020-08-17 18:37:52

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2020-08-17 18:37:52

shall we close this one too ?


---

Comment by jhpalmieri created at 2020-08-18 22:51:33

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-08-18 22:51:33

Yes.


---

Comment by chapoton created at 2020-08-19 07:18:51

Resolution: invalid
