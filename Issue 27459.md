# Issue 27459: py3: deprecate long and __long__, and remove doctesting special-case for long

archive/issues_027459.json:
```json
{
    "body": "CC:  mkoeppe\n\nThe main point of this ticket is this change:\n\n```diff\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex 4b222dd1db..d97034090f 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -2377,20 +2377,11 @@ class DocTestTask(object):\n         sage: sorted(results.keys())\n         ['cputime', 'err', 'failures', 'optionals', 'tests', 'walltime', 'walltime_skips']\n     \"\"\"\n-\n-    if six.PY2:\n-        extra_globals = {}\n-    else:\n-        extra_globals = {'long': int}\n+    extra_globals = {}\n     \"\"\"\n     Extra objects to place in the global namespace in which tests are run.\n     Normally this should be empty but there are special cases where it may\n     be useful.\n-\n-    In particular, on Python 3 add ``long`` as an alias for ``int`` so that\n-    tests that use the ``long`` built-in (of which there are many) still pass.\n-    We do this so that the test suite can run on Python 3 while Python 2 is\n-    still the default.\n     \"\"\"\n \n     def __init__(self, source):\n```\n\nWith Python 3 doctesting, `long` has been automatically converted to `int`. It would be better to not have such a big difference in the behavior of doctesting vs. ordinary Sage usage: with Python 3, evaluating `long(3)` would fail at the command line but work in doctesting.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27696\n\n",
    "created_at": "2019-04-17T19:35:10Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: deprecate long and __long__, and remove doctesting special-case for long",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27459",
    "user": "jhpalmieri"
}
```
CC:  mkoeppe

The main point of this ticket is this change:

```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 4b222dd1db..d97034090f 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -2377,20 +2377,11 @@ class DocTestTask(object):
         sage: sorted(results.keys())
         ['cputime', 'err', 'failures', 'optionals', 'tests', 'walltime', 'walltime_skips']
     """
-
-    if six.PY2:
-        extra_globals = {}
-    else:
-        extra_globals = {'long': int}
+    extra_globals = {}
     """
     Extra objects to place in the global namespace in which tests are run.
     Normally this should be empty but there are special cases where it may
     be useful.
-
-    In particular, on Python 3 add ``long`` as an alias for ``int`` so that
-    tests that use the ``long`` built-in (of which there are many) still pass.
-    We do this so that the test suite can run on Python 3 while Python 2 is
-    still the default.
     """
 
     def __init__(self, source):
```

With Python 3 doctesting, `long` has been automatically converted to `int`. It would be better to not have such a big difference in the behavior of doctesting vs. ordinary Sage usage: with Python 3, evaluating `long(3)` would fail at the command line but work in doctesting.

Issue created by migration from https://trac.sagemath.org/ticket/27696





---

archive/issue_comments_387217.json:
```json
{
    "body": "There are a few places where there should be deprecations but there are not: in rational.pyx and integer.pyx, deprecations lead to deprecations warnings all over the place in the Sage library. In `complex_double.pyx`, for example, the `__long__` method just raises an error, and it seemed that deprecating such a method has no effect: the deprecation warning is not printed, just the error is.\n----\nNew commits:",
    "created_at": "2019-04-17T19:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387217",
    "user": "jhpalmieri"
}
```

There are a few places where there should be deprecations but there are not: in rational.pyx and integer.pyx, deprecations lead to deprecations warnings all over the place in the Sage library. In `complex_double.pyx`, for example, the `__long__` method just raises an error, and it seemed that deprecating such a method has no effect: the deprecation warning is not printed, just the error is.
----
New commits:



---

archive/issue_comments_387218.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-17T19:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387218",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_387219.json:
```json
{
    "body": "This was done this way very intentionally in #24559, in large part to avoid such a massive patch like this.\n\nIt would be better I think to wait until Python 2 support is dropped completely.",
    "created_at": "2019-05-13T10:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387219",
    "user": "embray"
}
```

This was done this way very intentionally in #24559, in large part to avoid such a massive patch like this.

It would be better I think to wait until Python 2 support is dropped completely.



---

archive/issue_comments_387220.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-13T10:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387220",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_387221.json:
```json
{
    "body": "Right, but that was a year ago. I see no reason to wait until Python 2 support is dropped completely, although if you prefer, we can do this incrementally: say, first add `# py2` to a bunch of doctests of the form\n\n```\nsage: long(blah)\n```\n\nWe should also deprecate `__long__` for various classes. When the appropriate pieces are in place, turn off the conversion `long --> int` in Python 3 doctesting.\n\nThe current situation is very misleading, where a doctest will pass with Python 3 but the same code will fail if run by hand.",
    "created_at": "2019-05-13T17:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387221",
    "user": "jhpalmieri"
}
```

Right, but that was a year ago. I see no reason to wait until Python 2 support is dropped completely, although if you prefer, we can do this incrementally: say, first add `# py2` to a bunch of doctests of the form

```
sage: long(blah)
```

We should also deprecate `__long__` for various classes. When the appropriate pieces are in place, turn off the conversion `long --> int` in Python 3 doctesting.

The current situation is very misleading, where a doctest will pass with Python 3 but the same code will fail if run by hand.



---

archive/issue_comments_387222.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> The current situation is very misleading, where a doctest will pass with Python 3 but the same code will fail if run by hand.\n\nThere are many cases like that where the doctests don't work quite the same on Python 3 but in mostly trivial ways which are made transparent by the doctest framework.  I think that's ok, personally.\n\nHowever, I do like the idea of adding deprecation warnings to `__long__`.  What if as a middle ground we started with just that part?",
    "created_at": "2019-05-13T18:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387222",
    "user": "embray"
}
```

Replying to [comment:4 jhpalmieri]:
> The current situation is very misleading, where a doctest will pass with Python 3 but the same code will fail if run by hand.

There are many cases like that where the doctests don't work quite the same on Python 3 but in mostly trivial ways which are made transparent by the doctest framework.  I think that's ok, personally.

However, I do like the idea of adding deprecation warnings to `__long__`.  What if as a middle ground we started with just that part?



---

archive/issue_comments_387223.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2019-05-13T22:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387223",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_387224.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> However, I do like the idea of adding deprecation warnings to `__long__`.\n\nI disagree, we shouldn't deprecate `__long__`, it's a standard Python feature. But let's discuss at #27826.",
    "created_at": "2019-05-16T12:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387224",
    "user": "jdemeyer"
}
```

Replying to [comment:5 embray]:
> However, I do like the idea of adding deprecation warnings to `__long__`.

I disagree, we shouldn't deprecate `__long__`, it's a standard Python feature. But let's discuss at #27826.



---

archive/issue_comments_387225.json:
```json
{
    "body": "Also, I don't see how deprecating `__long__` helps to achieve the goal of this ticket. Adding the `# py2` flags to all doctests involving `long(...)` should be sufficient.",
    "created_at": "2019-05-16T13:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387225",
    "user": "jdemeyer"
}
```

Also, I don't see how deprecating `__long__` helps to achieve the goal of this ticket. Adding the `# py2` flags to all doctests involving `long(...)` should be sufficient.



---

archive/issue_comments_387226.json:
```json
{
    "body": "#27826 may now take care of this entire issue. If #27826 is merged, this can be closed.",
    "created_at": "2020-04-19T22:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387226",
    "user": "jhpalmieri"
}
```

#27826 may now take care of this entire issue. If #27826 is merged, this can be closed.



---

archive/issue_comments_387227.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-08-17T18:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387227",
    "user": "chapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_387228.json:
```json
{
    "body": "shall we close this one too ?",
    "created_at": "2020-08-17T18:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387228",
    "user": "chapoton"
}
```

shall we close this one too ?



---

archive/issue_comments_387229.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-18T22:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387229",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_387230.json:
```json
{
    "body": "Yes.",
    "created_at": "2020-08-18T22:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387230",
    "user": "jhpalmieri"
}
```

Yes.



---

archive/issue_comments_387231.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-08-19T07:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27459",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27459#issuecomment-387231",
    "user": "chapoton"
}
```

Resolution: invalid
