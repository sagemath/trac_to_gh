# Issue 16159: upgrade Sphinx to 1.2

Issue created by migration from https://trac.sagemath.org/ticket/16396

Original creator: rws

Original creation time: 2014-05-25 15:21:26

CC:  strogdon snark

Keywords: speed, slow, build, rst

According to https://groups.google.com/forum/#!topic/sphinx-users/EC7_wNtE5To Sphinx-1.2 is 25% faster than 1.1.2, and this matters with doc-clean Sage builds.


---

Comment by fbissey created at 2014-05-27 22:58:27

The sage-on-gentoo experience with this is that we need to clean up a number of things before upgrading. It of course can be done at the same time.


---

Comment by rws created at 2014-05-28 07:52:10

New commits:
----
Lots of `SEEALSO` problems apparently.


---

Comment by git created at 2014-05-28 08:26:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-28 08:37:58

Changing status from new to needs_info.


---

Comment by rws created at 2014-05-28 08:37:58

Further, I get a crash which is reported at https://bitbucket.org/birkenfeld/sphinx/issue/1475/typeerror-in-get_js_index


---

Comment by rws created at 2014-05-28 09:11:21

Changing status from needs_info to needs_work.


---

Comment by rws created at 2014-05-28 09:11:21

Upstream says:

```
Sphinx-1.2 has changed the signature of sphinx.search.IndexBuilder class (e5bd5a84b5fd) and Sage extension has used the IndexBuilder directly without a appended argument.

I think you can build the document with Sphinx-1.1.3. Alternatively, please contact to sage documentation maintainer.
```



---

Comment by fbissey created at 2014-05-28 10:36:49

I will have a look. I have a number of patches for sphinx 1.2 in sage-on-gentoo. We have success at building the html doc with sphinx 1.2. However there is a mystery on whether or not we can build the pdf documentation at the moment.


---

Comment by fbissey created at 2014-05-28 10:47:13

OK, you did the right thing for SEEALSO what you are missing can be found here [https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-6.2-sphinx.patch](https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-6.2-sphinx.patch) that should solve the crash you reported. Not that because you are not sage-on-gentoo you do not have to bother with testing the sphinx version. However we would appreciate if you did.


---

Comment by git created at 2014-05-28 15:49:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-28 16:02:13

I did a `sage -tp --long src/doc/` if you meant that. Except for pdf it's ready for review now. Not sure if we should wait for it.


---

Comment by rws created at 2014-05-28 16:02:13

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2014-05-28 16:55:26

Can you provide a link to the new tarball?


---

Comment by fbissey created at 2014-05-28 23:48:34

In sage-on-gentoo pdf generation is officially broken with sphinx 1.2.2. Some math is generated in pure tex rather than latex ("\(...\)" rather than "$...$") and it breaks the pdf engine. We are investigating at this stage.


---

Comment by rws created at 2014-05-29 07:00:08

If the pdf issue is an upstream issue, is there a ticket? Can you please add it to this ticket description and set the resp. field? Any other links with information?

Tarball link is added.


---

Comment by rws created at 2014-05-29 07:12:43

I should say that I manually untarred, renamed the `Sphinx` directory to `sphinx` and re`bzip`ped. There must be a better way of doing this, as there is no difference in names to  the previous version.


---

Comment by fbissey created at 2014-05-29 07:14:31

Replying to [comment:13 rws]:
> If the pdf issue is an upstream issue, is there a ticket? Can you please add it to this ticket description and set the resp. field? Any other links with information?
> 
> Tarball link is added.

We don't know yet if it is an upstream issue or something that sage's doc need to be adapted to. sage-on-gentoo is technically downstream from you not upstream.


---

Comment by jhpalmieri created at 2014-05-29 19:44:03

For what it's worth, I did several iterations of `make doc-clean` followed by `make`. Docbuilding did not speed up with the new version of Sphinx:

- old version: 219.8 seconds, 217.3 seconds, 224.7 seconds
- new version: 227.5 seconds, 218.3 seconds, 219.5 seconds

(This was with 4 threads.) Given the problems with PDF building, maybe there isn't much hurry with this? Or are other people seeing a speed improvement with the new version?


---

Comment by fbissey created at 2014-05-29 21:41:28

OK Steve has found the commit of sphinx that break things for pdflatex and I have left a comment of the corresponding issue [https://bitbucket.org/birkenfeld/sphinx/issue/929/parsed-literal-creates-bad-latex-math](https://bitbucket.org/birkenfeld/sphinx/issue/929/parsed-literal-creates-bad-latex-math).
If they don't pick up the comment in a couple of day I'll open an issue proper with them.


---

Comment by rws created at 2014-05-30 05:47:42

Replying to [comment:16 jhpalmieri]:
> For what it's worth, I did several iterations of `make doc-clean` followed by `make`. Docbuilding did not speed up with the new version of Sphinx:
> 
> - old version: 219.8 seconds, 217.3 seconds, 224.7 seconds
> - new version: 227.5 seconds, 218.3 seconds, 219.5 seconds
> 
> (This was with 4 threads.) Given the problems with PDF building, maybe there isn't much hurry with this? Or are other people seeing a speed improvement with the new version?
No, it confirms my impression. There is no hurry. I thought it might somehow fix the docbuild issue discussed in sage-releases but I cannot reproduce that at the moment, so I cannot even look if Sphinx-1.2 makes a difference there.


---

Comment by fbissey created at 2014-06-04 02:45:44

Given the lack of answer to my first comment on the commit that breaks pdf generation I opened a brand new issue for the problem: [https://bitbucket.org/birkenfeld/sphinx/issue/1480/latex-math-output-is-broken-for-inline](https://bitbucket.org/birkenfeld/sphinx/issue/1480/latex-math-output-is-broken-for-inline)


---

Comment by fbissey created at 2014-06-10 21:48:12

Upstream is quite unresponsive. If anyone has a direct line they can try that. I think it is time to patch on our side.


---

Comment by strogdon created at 2014-06-10 22:36:28

I believe I have a patch that's not to invasive, i.e. it basically reverts to the old behavior when using inline math and doesn't disrupt (hopefully) the need to use pure tex in a verbatim (alltt) environment. I'll post here since it will take me time to remember how to commit

```
--- sphinx/writers/latex.py.orig        2014-06-05 23:38:03.808669401 -0500
+++ sphinx/writers/latex.py     2014-06-05 23:27:22.752376713 -0500
@@ -264,6 +264,7 @@
         self.next_figure_ids = set()
         self.next_table_ids = set()
         # flags
+        self.verbatim = False
         self.in_title = 0
         self.in_production_list = 0
         self.in_footnote = 0
@@ -1319,6 +1320,7 @@
                                    (self.curfilestack[-1], node.line))
         if node.rawsource != node.astext():
             # most probably a parsed-literal block -- don't highlight
+            self.verbatim = True
             self.body.append('\\begin{alltt}\n')
         else:
             code = node.astext().rstrip('\n')
@@ -1351,6 +1353,7 @@
             raise nodes.SkipNode
     def depart_literal_block(self, node):
         self.body.append('\n\\end{alltt}\n')
+        self.verbatim = False
     visit_doctest_block = visit_literal_block
     depart_doctest_block = depart_literal_block
 
--- sphinx/ext/mathbase.py.orig 2014-06-05 23:39:36.773293241 -0500
+++ sphinx/ext/mathbase.py      2014-06-05 23:18:53.949020605 -0500
@@ -88,7 +88,10 @@
 
 
 def latex_visit_math(self, node):
-    self.body.append('\\(' + node['latex'] + '\\)')
+    if self.verbatim:
+        self.body.append('\\(' + node['latex'] + '\\)')
+    else:
+        self.body.append('$' + node['latex'] + '$')
     raise nodes.SkipNode
 
 def latex_visit_displaymath(self, node):
```



---

Comment by git created at 2014-07-28 13:43:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-07-28 13:44:44

Replying to [comment:22 strogdon]:
> I believe I have a patch that's not to invasive, i.e. it basically reverts to the old behavior when using inline math and doesn't disrupt (hopefully) the need to use pure tex in a verbatim (alltt) environment. I'll post here since it will take me time to remember how to commit
Thanks, I have added your patch with you as author.


---

Comment by fbissey created at 2014-08-11 22:29:02

Anything left to do with this ticket?


---

Comment by Snark created at 2014-08-22 17:35:48

I wanted to give it a try, but it failed to download the tarball from sagemath.org ; when I took the tarball from the link in the ticket description the sums didn't match.


---

Comment by fbissey created at 2014-08-24 02:44:26

There are several wrong things. checksums.ini looks for 

```
tarball=sphinx-VERSION.tar.bz2
```

the linked tarball is Sphinx-1.2.2.tar.gz so of course the checksum won't match. We need to recommit that with 

```
tarball=Sphinx-VERSION.tar.gz
```

and new checksum to be sure. Once checksum.ini is corrected for the right filename run

```
./sage -sh sage-fix-pkg-checksums
```

As detailed in [http://sagemath.org/doc/developer/packaging.html#checksums](http://sagemath.org/doc/developer/packaging.html#checksums).


---

Comment by Snark created at 2014-08-24 06:50:07

Changing the filename doesn't modify the checksum as far as I know, so I just renamed the tarball. The fact that it was wrong was enough to see the ticket wasn't ready for review.


---

Comment by fbissey created at 2014-08-24 07:20:56

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2014-08-24 07:20:56

Replying to [comment:30 Snark]:
> Changing the filename doesn't modify the checksum as far as I know, so I just renamed the tarball. The fact that it was wrong was enough to see the ticket wasn't ready for review.

It is indeed not ready to review. Switching to French Julien. 

Il est vrai que changer le nom de fichier ne suffit pas. Mon commentaire a deux instructions:
 * changer le nom
 * executer le script "./sage -sh sage-fix-pkg-checksums" qui va recalculer les checksums d'apres les fichiers que tu as deja telecharge.

Renommer un tar.gz en tar.bz2 n'est pas une bonne idee, decompresser et recompresser ne donneras pas la meme checksum, si la version de bzip2 n'est pas completement identique le bzip2 serat legerement different.


---

Comment by Snark created at 2014-08-24 07:50:19

Ooooooooh, I hadn't noticed the original was a .gz and not a .bz2! Indeed, no wonder that didn't work... I had only seen the Sphinx vs sphinx.

I'll probably give it a try later today, to see exactly how much work is involved in fixing that ticket. I'm quite interested in getting docutils upgraded, and this is a prerequisite!


---

Comment by Snark created at 2014-08-24 18:17:10

Ok, doing things less stupidly does make things better (who would have thought?! ;-P ) : it builds and there are three failing doctests, which are trivial to fix: those doctests expect a newline before a div, and there are none now:

```
sage -t --long local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg/sagenb/misc/sphinxify.py
**********************************************************************
File "local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg/sagenb/misc/sphinxify.py", line 69, in sagenb.misc.sphinxify.sphinxify
Failed example:
    sphinxify('A test')
Expected:
    '\n<div class="docstring">\n    \n  <p>A test</p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p>A test</p>\n\n\n</div>'
**********************************************************************
File "local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg/sagenb/misc/sphinxify.py", line 71, in sagenb.misc.sphinxify.sphinxify
Failed example:
    sphinxify('**Testing**\n`monospace`')
Expected:
    '\n<div class="docstring"...<strong>Testing</strong>\n<span class="math"...</p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><strong>Testing</strong>\n<span class="math">monospace</span></p>\n\n\n</div>'
**********************************************************************
File "local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg/sagenb/misc/sphinxify.py", line 73, in sagenb.misc.sphinxify.sphinxify
Failed example:
    sphinxify('`x=y`')
Expected:
    '\n<div class="docstring">\n    \n  <p><span class="math">x=y</span></p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><span class="math">x=y</span></p>\n\n\n</div>'
**********************************************************************
1 item had failures:
   3 of  10 in sagenb.misc.sphinxify.sphinxify
    [14 tests, 3 failures, 0.44 s]
```


I also had a look at the branch to see how the patches looked like : there is a strange chunk on src/doc/common/multidocs.py with a test on whether the sphinx version is less or above 1.2... which makes no sense if we're upgrading to 1.2.2!

So I would say : rebase the branch, fix the tarball issues (name, checksum), remove the chunk mentioned above, fix the doctests and it will be good to review and close!

PS: in fact, I may give git-trac a try and push a patch fixing the doctests this evening... if I manage to.


---

Comment by Snark created at 2014-08-24 18:38:22

Hmmmmmm... it's in sagenb... how does one proceed in such a case? Ask sagenb to make a new release with patched doctests, then push a ticket to upgrade to that, making this one depend on that new ticket, etc?


---

Comment by fbissey created at 2014-08-25 22:52:08

Replying to [comment:33 Snark]:
> Ok, doing things less stupidly does make things better (who would have thought?! ;-P ) > I also had a look at the branch to see how the patches looked like : there is a strange chunk on src/doc/common/multidocs.py with a test on whether the sphinx version is less or above 1.2... which makes no sense if we're upgrading to 1.2.2!

See http://trac.sagemath.org/ticket/16396#comment:8 but like I said we are not strongly attached to it.

For sagenb you can open a ticket on their github [https://github.com/sagemath/sagenb](https://github.com/sagemath/sagenb) and yes we'll need a new release.


---

Comment by fbissey created at 2014-08-29 10:03:50

Do you want to open an issue for sagenb and make a pull request or would you prefer I do it Julien?


---

Comment by Snark created at 2014-08-29 18:43:15

First eclib and its detection of NTL, now sagenb and its sphinx doctests... you're late to the [party](https://github.com/sagemath/sagenb/pull/215) again! ;-P


---

Comment by fbissey created at 2014-08-30 10:27:39

Replying to [comment:37 Snark]:
> First eclib and its detection of NTL, now sagenb and its sphinx doctests... you're late to the [party](https://github.com/sagemath/sagenb/pull/215) again! ;-P

Yes you work while I sleep. I cannot really complain about that ;)


---

Comment by ppurka created at 2014-09-07 12:49:32

Something is wrong with your patches. First, `checksums.ini` contains the patch:

```diff
diff --git a/build/pkgs/sphinx/checksums.ini b/build/pkgs/sphinx/checksums.ini
index a9fda75..5befdc5 100644
--- a/build/pkgs/sphinx/checksums.ini
+++ b/build/pkgs/sphinx/checksums.ini
@@ -1,4 +1,4 @@
 tarball=sphinx-VERSION.tar.bz2
-sha1=2a6f238185a58cbb5c597c985d715ab9653e0fbe
-md5=9ea0a6f218779ddbe3222c5ef8c0f6e6
-cksum=1040528499
+sha1=deb2a9308d50a508ed9c26b02373a3965c2a5500
+md5=a81ab4ca80eec8fa1cc72cb5858f7f5a
+cksum=2539330004
```

which neither matches the filename of the actual download, the extension, nor the md5sum of the download when converted to the correct extension using

```
gunzip -c Sphinx-1.2.2.tar.gz | bzip2 > sphinx-1.2.2.tar.bz2
```



---

Comment by Snark created at 2014-09-08 14:55:09

I checked that when the sagenb upgrade #16911 will be done, this ticket will go well.


---

Comment by Snark created at 2014-10-09 07:55:32

What's the status?


---

Comment by fbissey created at 2014-10-09 08:13:38

Are we getting a new sagenb in that can take this and a new docutils?


---

Comment by Snark created at 2014-10-09 08:32:49

From what I know, we need a new sagenb(#16911) so we can get a new sphinx(here) so we can get a new docutils(#16733) (in that order). And Volker has added a reverse dep from the new sphinx to the new sagenb to the mix, see #16911.


---

Comment by fbissey created at 2014-10-09 08:38:55

OK so #16911 is positively reviewed, it looks like we need to check everything here, ppurka said the checksum is wrong so it has to be checked and given a last test. After we put on a positive review and hope that it get in the next beta/rc. Can you do the work on the checksum I have a couple of other issues I am dealing with.


---

Comment by Snark created at 2014-10-15 07:11:28

Ok, I started from ppurka's update_sagenb branch, merged the t/16396/upgrade_sphinx_to_1_2 branch, got the upstream tarball and fixed the checksums as in the ticket description, reinstalled sagenb, reinstalled sphinx, rebuilt sage, then "make ptestlong".

All tests passed.


---

Comment by ppurka created at 2014-10-15 10:55:28

You also need to submit the updated checksums to the ticket. Then,  you can set this to needs review so that `@`fbissey can confirm the changes.


---

Comment by Snark created at 2014-10-15 12:59:09

I'm actually reviewing the ticket...


---

Comment by kcrisman created at 2014-10-17 14:34:42

If there isn't too much left to do here other than this checksum/tarball issue, it would be wonderful to get this and #16911 in the next beta.


---

Comment by fbissey created at 2014-10-19 09:58:07

I am working on updating the branch (package name, checksums and patch refresh to eliminate fuzz). I'll also update the description once I am finished. It will then be up to Julien to push the button.
I am not doing anything new, just clean up.


---

Comment by fbissey created at 2014-10-19 10:45:41

Here it comes....
----
New commits:


---

Comment by fbissey created at 2014-10-19 10:45:41

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-10-21 17:13:26

Is the change from `sphinx` to `Sphinx` going to cause any upgrading troubles?


---

Comment by strogdon created at 2014-10-21 17:39:05

Replying to [comment:52 kcrisman]:
> Is the change from `sphinx` to `Sphinx` going to cause any upgrading troubles?

I've tried this and I didn't see an issue. But Fran√ßois may see something.


---

Comment by fbissey created at 2014-10-21 19:08:39

We've been there before with another package. The answer is not anymore. Since Julien is not around and Steve tried it I am pushing the button to get on with this. We waited long enough.


---

Comment by fbissey created at 2014-10-21 19:08:39

Changing status from needs_review to positive_review.


---

Comment by strogdon created at 2014-10-21 19:37:44

And now to get the sphinx patches out of #16733 so hopefully #16736 can be resolved.


---

Comment by vbraun created at 2014-10-22 23:02:48

Breaks pdf docs for me with

```
! LATEX ERROR: BAD MATH ENVIRONMENT DELIMITER.

SEE THE LATEX MANUAL OR LATEX COMPANION FOR EXPLANATION.
Type  H <return>  for immediate help.
 ...                                              
                                                  
l.222 ... index subgroups of \({\rm SL}_2(\ZZ)\))}
                                                  
? 
! Emergency stop.
 ...                                              
                                                  
l.222 ... index subgroups of \({\rm SL}_2(\ZZ)\))}
                                                  
!  ==> Fatal error occurred, no output PDF file produced!
Transcript written on arithgroup.log.
Makefile:55: recipe for target 'arithgroup.pdf' failed
make[1]: *** [arithgroup.pdf] Error 1
```

I think the tex code has been around for a while, but the new sphinx doesn't allow these math delimiters. I would just change them to the usual dollar sign or backtick.


---

Comment by vbraun created at 2014-10-22 23:02:48

Changing status from positive_review to needs_work.


---

Comment by strogdon created at 2014-10-23 00:15:49

This should have been taken care of with this commit:

http://git.sagemath.org/sage.git/commit/?id=761be309a895a85c91ec24af8acc69eca0126faf

However the name of the patch file, `inline-latex` doesn't have a `.patch` extension and thus it is never applied.


---

Comment by fbissey created at 2014-10-23 00:19:12

Darn I missed that. I will take care of this shortly.


---

Comment by git created at 2014-10-23 00:25:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2014-10-23 00:26:06

New commits:


---

Comment by fbissey created at 2014-10-23 00:26:20

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2014-10-23 00:26:20

Fixed.


---

Comment by jhpalmieri created at 2014-10-23 03:18:18

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2014-10-23 03:18:18

This works for me.


---

Comment by vbraun created at 2014-10-24 10:14:41

Resolution: fixed


---

Comment by slelievre created at 2014-10-28 08:12:04

The upstream [sphinx ticket](https://bitbucket.org/birkenfeld/sphinx/issue/1480/latex-math-output-is-broken-for-inline) has a question from 2014-07-13, can someone add a comment there?


---

Comment by strogdon created at 2014-10-29 15:13:24

Replying to [comment:65 slelievre]:
> The upstream [sphinx ticket](https://bitbucket.org/birkenfeld/sphinx/issue/1480/latex-math-output-is-broken-for-inline) has a question from 2014-07-13, can someone add a comment there?
I'm the one that commented there. And the suggested patch is included in this ticket. What were you thinking of in terms of comment?


---

Comment by Snark created at 2014-11-06 07:45:34

Replying to [comment:50 fbissey]:
> I am working on updating the branch (package name, checksums and patch refresh to eliminate fuzz). I'll also update the description once I am finished. It will then be up to Julien to push the button.
> I am not doing anything new, just clean up.

Sorry, I've been away for two weeks, then my browser didn't let me connect to trac (I just found the time to dig and behead the beast). Great work, thanks!


---

Comment by kcrisman created at 2014-11-19 16:07:29

<psa>For future reference, folks, please do use/read SPKG.txt.  This caused some annoyance in #17265 because of #17369.</psa>
