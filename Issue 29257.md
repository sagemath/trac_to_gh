# Issue 29257: Reject old system pari with bug in hyperellcharpoly

Issue created by migration from https://trac.sagemath.org/ticket/29494

Original creator: @kliem

Original creation time: 2020-04-10 15:34:07

CC:  mkoeppe â€‹jdemeyer mjo dimpase

Keywords: pari, hyperellcharpoly

We shouldn't accept a system pari, if it has known bug reported in #28789.


```
sage: P.<x> = PolynomialRing(GF(3))
sage: u = x^10 + x^9 + x^8 + x
sage: C = HyperellipticCurve(u)
sage: C.frobenius_polynomial()
x^8 + 731*x^7 + 6*x^6 - 720*x^5 + 18*x^4 - 2160*x^3 + 54*x^2 + 19737*x + 81
```


The corresponding doctests fails e.g. on debian buster [https://github.com/kliem/sage-test-27122/runs/576167329](https://github.com/kliem/sage-test-27122/runs/576167329) or [https://github.com/mkoeppe/sage/runs/542655855](https://github.com/mkoeppe/sage/runs/542655855)

We fix this by rejecting pari if it has that bug.


---

Comment by @kliem created at 2020-04-10 15:35:22

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-04-10 15:37:01

New commits:


---

Comment by mjo created at 2020-04-10 15:53:11

If we copy/paste every upstream test into a sage doctest and then copy/paste every sage doctest into spkg-configure.m4, we're going to wind up (a) spending a whole lot of time, and (b) ultimately forcing the exact same version of and patches to pari that sage ships with anyway.

This doctest (and others like it) should just be deleted now that we're using system packages.


---

Comment by @kliem created at 2020-04-10 15:59:04

Alternatively to this approach, we can move the minimal pari version up to 2.11.2. This would also solve it.

I just don't think it is right to accept a system package, where we know it has a bug leading to a mathematical incorrect answer.


---

Comment by mjo created at 2020-04-10 16:09:44

Replying to [comment:4 gh-kliem]:
> 
> I just don't think it is right to accept a system package, where we know it has a bug leading to a mathematical incorrect answer.

This approach leaves you with the empty set =)

The absolute best you can do is to not accept a system package that doesn't fail any sage doctests, where certain sage doctests for the correct answers have not yet been added because the SPKG that ships with sage produces the wrong ones. But then you're just forcing the exact same version/patches of the package that ships with sage. I can certainly go find a bug in pari-2.11.2 that was fixed in pari-2.11.3 and add a doctest for it, and then retroactively decide that we must not allow that bug in sage. The same is true of (almost) every new version of (almost) every package.

For best results, users should upgrade their system packages to the latest available versions... as with any software. Old versions have bugs and security vulnerabilities fixed in the new ones. Anything API compatible should be accepted IMO.


---

Comment by mkoeppe created at 2020-04-10 16:18:54

Replying to [comment:4 gh-kliem]:
> Alternatively to this approach, we can move the minimal pari version up to 2.11.2. This would also solve it.
> 
> I just don't think it is right to accept a system package, where we know it has a bug leading to a mathematical incorrect answer.

I agree with the current approach. I prefer testing whether the known bugs are present to using version numbers because many distributions tend to backport fixes.


---

Comment by mjo created at 2020-04-10 16:20:55

Then you might as well save time and just require pari-2.11.3 as soon as the SPKG is upgraded.


---

Comment by mkoeppe created at 2020-04-10 16:21:15

Replying to [comment:5 mjo]:
> For best results, users should upgrade their system packages to the latest available versions... as with any software. 
Sorry, many users are not able to do this, for example in HPC and other centrally managed environments.


---

Comment by mjo created at 2020-04-10 16:22:25

Replying to [comment:8 mkoeppe]:
> 
> Sorry, many users are not able to do this, for example in HPC and other centrally managed environments.
> 

./configure --without-system-pari


---

Comment by mkoeppe created at 2020-04-10 16:23:17

No.


---

Comment by mkoeppe created at 2020-04-10 16:23:37

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-10 16:27:43

Replying to [comment:10 mkoeppe]:
> No.
To expand on this: Sage users want a distribution that works. We use extensive testing for that so that users don't have to. The spkg-configure mechanism was designed to reduce compilation times. But we cannot sacrifice correctness for that and leave it to the users to find versions or configurations that work.


---

Comment by mjo created at 2020-04-10 16:32:22

Replying to [comment:12 mkoeppe]:
> Replying to [comment:10 mkoeppe]:
> > No.
> To expand on this: Sage users want a distribution that works. We use extensive testing for that so that users don't have to. The spkg-configure mechanism was designed to reduce compilation times. But we cannot sacrifice correctness for that and leave it to the users to find versions or configurations that work.

It's an awkward position to be arguing against correctness =)

My point is mainly that every mathematical bug fixed in pari-2.11.3 is present in sage if we accept pari-2.11.2 from the system. Is that OK? If not, then copy/pasting the upstream tests into sage and then copy/pasting sage tests into spkg-configure.m4 is an extremely roundabout way of only accepting pari-2.11.3 on the system.


---

Comment by mkoeppe created at 2020-04-10 16:41:57

Replying to [comment:13 mjo]:
> My point is mainly that every mathematical bug fixed in pari-2.11.3 is present in sage if we accept pari-2.11.2 from the system. Is that OK? If not, then copy/pasting the upstream tests into sage and then copy/pasting sage tests into spkg-configure.m4 is an extremely roundabout way of only accepting pari-2.11.3 on the system.

Of course in general the right balance needs to be found. I do not know about the details of the 2.11.2->2.11.3 update and whether it contains other fixes that are relevant for sage (and I don't know if you know).  Because conservatively managed distributions tend to backport fixes rather than doing updates that bring many changes (and again I do not know whether the 2.11.2->2.11.3 update brings many changes), testing for a small number of bugs instead of testing for version numbers can be preferable. Concretely I think testing for 2 bugs is fine; but we should certainly not be testing for 10 bugs.


---

Comment by mjo created at 2020-04-10 17:10:48

This was fixed in the update:


```
sage: M1 = matrix(ZZ,[[16,6],[6,10]])
sage: M2 = matrix(ZZ,[[4,3],[3,10]])
sage: Q1 = QuadraticForm(M1)
sage: Q2 = QuadraticForm(M2)
sage: Q1.is_globally_equivalent_to(Q2)
False
sage: Q2.is_globally_equivalent_to(Q1)
True
```


Should we add a doctest to the sage library for that bug, and thus add it to spkg-configure.m4 as well to avoid doctest failures? If not, what makes this different from the hyperellcharpoly bug?


---

Comment by mkoeppe created at 2020-04-10 22:44:28

Replying to [comment:15 mjo]:
> 
> Should we add a doctest to the sage library for that bug, and thus add it to spkg-configure.m4 as well to avoid doctest failures?

Yes


---

Comment by mjo created at 2020-04-10 22:56:17

Replying to [comment:16 mkoeppe]:
> 
> Yes

In that case, the only version of pari that would be acceptable is 2.11.3. However, 2.11.3 has a critical bug in it that's _not_ present in 2.11.2, requiring a backported patch. So in reality, the only version that can be used is the precise one that is shipped with sage, including the patch. And the same will be true of a lot of packages, if you look closely enough.

At that point I step back and see that a series of reasonable-sounding decisions has led to an absurd outcome, and that maybe we shouldn't be testing all of these upstream bugs after all. But if you still think this is the right thing to do (it's not wrong, we just have different philosophies)... isn't it easier to just bump the MINVER check and test for the backported patch? Why test for a million bugs when together they imply the latest version?


---

Comment by mkoeppe created at 2020-04-10 23:03:08

If 2.11.3 - 2.11.2 is really the sum of these 2 or 3 bugfixes, then, yes, we should just change the lower bound.


---

Comment by mkoeppe created at 2020-04-10 23:04:38

Replying to [comment:17 mjo]:
> 2.11.3. However, 2.11.3 has a critical bug in it that's _not_ present in 2.11.2, requiring a backported patch. So in reality, the only version that can be used is the precise one that is shipped with sage, including the patch. And the same will be true of a lot of packages, if you look closely enough.

This may be true now, but in reaction to distribution bug reports, distributions may be updating their packages by backporting.


---

Comment by vbraun created at 2020-04-16 22:33:09

Resolution: fixed


---

Comment by arojas created at 2020-04-23 07:45:00

Am I missing something, or is this actually testing for the *wrong* answer?


---

Comment by @kliem created at 2020-04-23 08:43:05

Thanks for checking. That's awful.

Indeed it looks like your correct:


```diff
-expected="%1 = x^8 + 731*x^7 + 6*x^6 - 720*x^5 + 18*x^4 - 2160*x^3 + 54*x^2 + 19737*x + 81"
+expected="%1 = x^8 + 2*x^7 + 6*x^6 + 9*x^5 + 18*x^4 + 27*x^3 + 54*x^2 + 54*x + 81"
```


Looks like I copied the wrong result (I manually installed the broken pari, to see what the test should look like and then I copied from the wrong source. My bad.


---

Comment by dimpase created at 2020-04-23 10:51:40

let's fix all this on #29554
