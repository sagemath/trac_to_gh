# Issue 16495: Fix translation of psi(x,y) to/from maxima

archive/issues_016495.json:
```json
{
    "body": "CC:  @rwst @kcrisman @burcin\n\nFollow-up to #9217. We have some imperfect translations to/from maxima of `psi(x,y)`. The template is:\n\n```\nsage: x,y=var(\"x y\")\nsage: maxima_calculus(psi(x,y))\npsi[x](y)\n```\n\nThe conversion doesn't seem to completely recurse on the first argument, though:\n\n```\nsage: maxima_calculus(psi(psi(x,y),y))\npsi[psi(x,y)](y)\n```\n\n(note that the inner psi does not have the square brackets)\n\nRound-tripping only works for completely numeric first arguments (as per how the responsible regexp is designed):\n\n```\nsage: maxima_calculus(psi(x,y))._sage_()\nTypeError: unable to make sense of Maxima expression 'psi[x](y)' in Sage\n```\n\n\nThese conversions all go fine with the tree-walking translation of maxima_lib (which gets used for some, but not all calculus operations):\n\n```\nsage: from sage.interfaces.maxima_lib import sr_to_max,max_to_sr\nsage: T=maxima_calculus(sr_to_max(psi(psi(x,y),y))); T\npsi[psi[x](y)](y)\nsage: max_to_sr(T.ecl())\npsi(psi(x, y), y)\n```\n\nNote that the regex-based \"._sage_()\" conversion will fundamentally have trouble with nested square brackets:\n\n```\nsage: T._sage_()\nTypeError: unable to make sense of Maxima expression 'psi[psi[x](y)](y)' in Sage\n```\n\nAs a first step we might want to change the regex to accept \"non-]\" inside the square brackets to allow translation with non-numeric parameters. I don't think anybody has seen an expression in the wild yet that has nested square brackets (indeed, mostly the parameter is explicit numeric).\n\nThere are some other maxima functions that use square brackets too. These might benefit from a similar treatment.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16732\n\n",
    "created_at": "2014-07-29T18:58:35Z",
    "labels": [
        "component: interfaces",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Fix translation of psi(x,y) to/from maxima",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16495",
    "user": "https://github.com/nbruin"
}
```
CC:  @rwst @kcrisman @burcin

Follow-up to #9217. We have some imperfect translations to/from maxima of `psi(x,y)`. The template is:

```
sage: x,y=var("x y")
sage: maxima_calculus(psi(x,y))
psi[x](y)
```

The conversion doesn't seem to completely recurse on the first argument, though:

```
sage: maxima_calculus(psi(psi(x,y),y))
psi[psi(x,y)](y)
```

(note that the inner psi does not have the square brackets)

Round-tripping only works for completely numeric first arguments (as per how the responsible regexp is designed):

```
sage: maxima_calculus(psi(x,y))._sage_()
TypeError: unable to make sense of Maxima expression 'psi[x](y)' in Sage
```


These conversions all go fine with the tree-walking translation of maxima_lib (which gets used for some, but not all calculus operations):

```
sage: from sage.interfaces.maxima_lib import sr_to_max,max_to_sr
sage: T=maxima_calculus(sr_to_max(psi(psi(x,y),y))); T
psi[psi[x](y)](y)
sage: max_to_sr(T.ecl())
psi(psi(x, y), y)
```

Note that the regex-based "._sage_()" conversion will fundamentally have trouble with nested square brackets:

```
sage: T._sage_()
TypeError: unable to make sense of Maxima expression 'psi[psi[x](y)](y)' in Sage
```

As a first step we might want to change the regex to accept "non-]" inside the square brackets to allow translation with non-numeric parameters. I don't think anybody has seen an expression in the wild yet that has nested square brackets (indeed, mostly the parameter is explicit numeric).

There are some other maxima functions that use square brackets too. These might benefit from a similar treatment.

Issue created by migration from https://trac.sagemath.org/ticket/16732





---

archive/issue_comments_216657.json:
```json
{
    "body": "turns out the issue here lies a little deeper and can really affect conceivably useful expressions, so I'm upgrading to usual \"major\" priority.",
    "created_at": "2014-07-29T20:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216657",
    "user": "https://github.com/nbruin"
}
```

turns out the issue here lies a little deeper and can really affect conceivably useful expressions, so I'm upgrading to usual "major" priority.



---

archive/issue_comments_216658.json:
```json
{
    "body": "OK, little search:\n\n```\nsage: search_src(\"init_evaled\")\nfunctions/special.py:285:    def _maxima_init_evaled_(self, *args):\nfunctions/special.py:294:            sage: f._maxima_init_evaled_(1/2, 1/2)\nfunctions/special.py:344:        return parent(maxima(\"%s, numer\"%self._maxima_init_evaled_(*args)))\nfunctions/special.py:368:            s = maxima(self._maxima_init_evaled_(*args))\n```\n\nthe above are fine. They process the arguments.\n\n\n```\nfunctions/log.py:415:    def _maxima_init_evaled_(self, *args):\nfunctions/log.py:713:    def _maxima_init_evaled_(self, n, z):\nfunctions/other.py:1153:    def _maxima_init_evaled_(self, n, x):\n```\n\nThe above are bad. They do not process their arguments.\n\n\n```\nfunctions/orthogonal_polys.py:402:    def _maxima_init_evaled_(self, *args):\nfunctions/orthogonal_polys.py:411:            sage: P._maxima_init_evaled_(2, 5) is None\nfunctions/orthogonal_polys.py:715:    def _maxima_init_evaled_(self, n, x):\nfunctions/orthogonal_polys.py:723:            sage: chebyshev_T._maxima_init_evaled_(1,x)\nfunctions/orthogonal_polys.py:1024:    def _maxima_init_evaled_(self, n, x):\n```\n\nThese are fine.\n\nSo the only problems are in `polylog`, `lambert_w`, `psi`. They should just call `_maxima_init_()` on all their arguments before stuffing them in the string template.",
    "created_at": "2014-07-29T20:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216658",
    "user": "https://github.com/nbruin"
}
```

OK, little search:

```
sage: search_src("init_evaled")
functions/special.py:285:    def _maxima_init_evaled_(self, *args):
functions/special.py:294:            sage: f._maxima_init_evaled_(1/2, 1/2)
functions/special.py:344:        return parent(maxima("%s, numer"%self._maxima_init_evaled_(*args)))
functions/special.py:368:            s = maxima(self._maxima_init_evaled_(*args))
```

the above are fine. They process the arguments.


```
functions/log.py:415:    def _maxima_init_evaled_(self, *args):
functions/log.py:713:    def _maxima_init_evaled_(self, n, z):
functions/other.py:1153:    def _maxima_init_evaled_(self, n, x):
```

The above are bad. They do not process their arguments.


```
functions/orthogonal_polys.py:402:    def _maxima_init_evaled_(self, *args):
functions/orthogonal_polys.py:411:            sage: P._maxima_init_evaled_(2, 5) is None
functions/orthogonal_polys.py:715:    def _maxima_init_evaled_(self, n, x):
functions/orthogonal_polys.py:723:            sage: chebyshev_T._maxima_init_evaled_(1,x)
functions/orthogonal_polys.py:1024:    def _maxima_init_evaled_(self, n, x):
```

These are fine.

So the only problems are in `polylog`, `lambert_w`, `psi`. They should just call `_maxima_init_()` on all their arguments before stuffing them in the string template.



---

archive/issue_comments_216659.json:
```json
{
    "body": "For the bracket problem: since we are *removing* the square brackets we CAN actually do the transformations with regexes, if we apply the substitutions repeatedly:\n\n```\nsage: s=\"psi[psi[a](b)](c)\"\nsage: s=maxima_polygamma.sub('psi(\\g<1>,',s);s\n'psi[psi(a,b)](c)'\nsage: s=maxima_polygamma.sub('psi(\\g<1>,',s);s\n'psi(psi(a,b),c)'\n```\n\nso we could have a little square-bracket replacement loop:\n\n```\nsold = None\nwhile s != sold:\n    sold = s\n    s=maxima_polygamma.sub('psi(\\g<1>,',s)\n    s=maxima_<other square bracket pattern>.sub(...,s)\n    s=maxima_<yet other one>.sub(...,s)\n```\n\nwe should converge to a fixed point that is square-bracketless if our patterns cover all legitimate uses of square brackets: If there is a square-bracket use, there is an \"innermost\" one (that doesn't contain any square bracket uses itself) and its pattern will trigger and remove it (modifying s).\n\nI'm not claiming this is an *efficient* way of doing it, but it can be done with relatively mild changes to the code.",
    "created_at": "2014-07-30T00:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216659",
    "user": "https://github.com/nbruin"
}
```

For the bracket problem: since we are *removing* the square brackets we CAN actually do the transformations with regexes, if we apply the substitutions repeatedly:

```
sage: s="psi[psi[a](b)](c)"
sage: s=maxima_polygamma.sub('psi(\g<1>,',s);s
'psi[psi(a,b)](c)'
sage: s=maxima_polygamma.sub('psi(\g<1>,',s);s
'psi(psi(a,b),c)'
```

so we could have a little square-bracket replacement loop:

```
sold = None
while s != sold:
    sold = s
    s=maxima_polygamma.sub('psi(\g<1>,',s)
    s=maxima_<other square bracket pattern>.sub(...,s)
    s=maxima_<yet other one>.sub(...,s)
```

we should converge to a fixed point that is square-bracketless if our patterns cover all legitimate uses of square brackets: If there is a square-bracket use, there is an "innermost" one (that doesn't contain any square bracket uses itself) and its pattern will trigger and remove it (modifying s).

I'm not claiming this is an *efficient* way of doing it, but it can be done with relatively mild changes to the code.



---

archive/issue_comments_216660.json:
```json
{
    "body": "Something along these lines should do the job.\n----\nNew commits:",
    "created_at": "2014-07-30T01:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216660",
    "user": "https://github.com/nbruin"
}
```

Something along these lines should do the job.
----
New commits:



---

archive/issue_comments_216661.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-07-30T01:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216661",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_216662.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-08-04T07:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216662",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_216663.json:
```json
{
    "body": "Looks straightforward and patchbot is happy.",
    "created_at": "2014-08-04T07:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216663",
    "user": "https://github.com/rwst"
}
```

Looks straightforward and patchbot is happy.



---

archive/issue_comments_216664.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-08-04T16:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16495#issuecomment-216664",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
