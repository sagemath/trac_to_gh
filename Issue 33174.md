# Issue 33174: include time for checking doctest output in '--warn-long'

Issue created by migration from https://trac.sagemath.org/ticket/33411

Original creator: @mwageringel

Original creation time: 2022-02-23 19:45:27

CC:  mjo

With this ticket the doctest framework takes into account the time it takes to check the output of doctests when issuing a `--warn-long` warning, as discussed in #33293.

This should make it easier to notice problems in which a test finishes quickly, but checking its output takes a long time.

```
sage -t --long --warn-long 30.0 --random-seed=167278271317752899549362543776637089081 src/sage/schemes/elliptic_curves/isogeny_small_degree.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/isogeny_small_degree.py", line 1553, in sage.schemes.elliptic_curves.isogeny_small_degree.Psi2
Warning, slow doctest:
    Psi2(71)  # long time (1 second)
Test ran for 0.50 s, check ran for 188.94 s
    [303 tests, 226.15 s]
```

To test this change locally and obtain the output above, one needs to revert the fixes from #33293 (e.g. `git revert 0047c4d d3a07b2 6c4a27e`).



---

Comment by @mwageringel created at 2022-02-23 20:00:53

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2022-02-23 20:00:53

For now, I have used wall time instead of cpu time in order to be consistent with the rest of the measurements. This ticket has a mild conflict with #32981, but it will not be hard to rebase either of the tickets on top of the other.
----
New commits:


---

Comment by mjo created at 2022-02-23 23:13:18

Replying to [comment:1 gh-mwageringel]:
> For now, I have used wall time instead of cpu time in order to be consistent with the rest of the measurements. This ticket has a mild conflict with #32981, but it will not be hard to rebase either of the tickets on top of the other.

Makes sense, with #32981 stalled indefinitely. The changes look good but I'm still recovering from my last branch switch. I'll test it in the next day or two.


---

Comment by mjo created at 2022-02-24 03:04:39

The doctest timings make two other appearances that I've found. First, in the summary,


```
sage -t --random-seed=... src/sage/crypto/sbox.pyx
    [269 tests, 43.87 s]
```


and also in the `sage -t --verbose` output,


```
Trying (line 11):    units.length.meter
Expecting:
    meter
ok [0.11 s]
```


Should we include the check time in those?

Or more generally, do you think we should combine the example & check times for most purposes -- except when reporting a `--warn-long` violation? If we combined them, the "summary" time and verbose timings above would then include the check time, solving for us the problem of how to display the check times in those situations. Moreover we could do without this clause,


```python
if self.options.warn_long > 0 and example.walltime > self.options.warn_long:
    self.report_overtime(out, test, example, got)
```


since the subsequent one (including the check time) would suffice, being consistent with what the users sees in the summary/verbose timings.

To be clear, I think the variables should remain separate. I'm just wondering if we shouldn't use ` example.walltime + check_duration` in most places where we currently have `example.walltime`.


---

Comment by git created at 2022-02-25 19:30:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2022-02-25 19:36:02

Replying to [comment:3 mjo]:
> Or more generally, do you think we should combine the example & check times for most purposes -- except when reporting a `--warn-long` violation?

Yes, I think you are right about this. I have changed it in the last commit.

The summary time already included the check duration. Apparently, the variable `total_walltime` is only used when the time for running the tests is bounded by `--short=…`, but it makes sense to include the duration of the checking in that computation as well.


> Moreover we could do without this clause,

I have removed the clause, but this means that the long time warning almost always looks like

```
Test ran for 71.83 s, check ran for 0.00 s
```

where the second time is not of much use. Since these warnings should be rare anyway and since this simplifies the implementation (by getting rid of a branch that is practically never used unless there is a problem in the doctesting framework like #33293), this extra bit of verbosity seems acceptable to me.


---

Comment by mjo created at 2022-02-26 02:22:41

Replying to [comment:5 gh-mwageringel]:
> 
> I have removed the clause, but this means that the long time warning almost always looks like
> {{{
> Test ran for 71.83 s, check ran for 0.00 s
> }}}
> where the second time is not of much use.

This has a nice side effect. With the current branch, I can do something like `--warn-long=0.1`, and then grep/sort the output to see if any checks have taken too long, even if the entire test+check would not have exceeded a normal test+check time. Doing so works around the fact that checks should be much faster than tests, without requiring us to add a separate option for, say, `--warn-long-check`.

Overall, I think this is a good compromise that will catch the bugs it's intended to catch without overcomplicating everything. Thanks.


---

Comment by mjo created at 2022-02-26 02:22:41

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2022-02-26 13:27:33

For example,


```
$ grep 'Test ran for' warnlong.log | sed 's/^.*check ran for \([^ ]*\) s/\1/g' | sort | uniq
0.00
0.01
0.02
0.03
0.04
0.05
0.09
0.14
0.19
0.24
0.28
0.31
```



---

Comment by @mwageringel created at 2022-02-26 17:04:42

Replying to [comment:6 mjo]:
> This has a nice side effect. With the current branch, I can do something like `--warn-long=0.1`, and then grep/sort the output to see if any checks have taken too long, even if the entire test+check would not have exceeded a normal test+check time.

It took me a while to understand this because I was convinced this was already possible with the old branch, but you are right – this works now, since previously the report for a test taking more than 0.1 seconds would not include the check time.

Thanks for the comments and the review.


---

Comment by vbraun created at 2022-03-03 22:19:29

Resolution: fixed
