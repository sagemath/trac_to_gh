# Issue 33174: include time for checking doctest output in '--warn-long'

archive/issues_033174.json:
```json
{
    "body": "CC:  @orlitzky\n\nWith this ticket the doctest framework takes into account the time it takes to check the output of doctests when issuing a `--warn-long` warning, as discussed in #33293.\n\nThis should make it easier to notice problems in which a test finishes quickly, but checking its output takes a long time.\n\n```\nsage -t --long --warn-long 30.0 --random-seed=167278271317752899549362543776637089081 src/sage/schemes/elliptic_curves/isogeny_small_degree.py\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/isogeny_small_degree.py\", line 1553, in sage.schemes.elliptic_curves.isogeny_small_degree.Psi2\nWarning, slow doctest:\n    Psi2(71)  # long time (1 second)\nTest ran for 0.50 s, check ran for 188.94 s\n    [303 tests, 226.15 s]\n```\n\nTo test this change locally and obtain the output above, one needs to revert the fixes from #33293 (e.g. `git revert 0047c4d d3a07b2 6c4a27e`).\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33411\n\n",
    "created_at": "2022-02-23T19:45:27Z",
    "labels": [
        "component: doctest framework",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "include time for checking doctest output in '--warn-long'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33174",
    "user": "https://github.com/mwageringel"
}
```
CC:  @orlitzky

With this ticket the doctest framework takes into account the time it takes to check the output of doctests when issuing a `--warn-long` warning, as discussed in #33293.

This should make it easier to notice problems in which a test finishes quickly, but checking its output takes a long time.

```
sage -t --long --warn-long 30.0 --random-seed=167278271317752899549362543776637089081 src/sage/schemes/elliptic_curves/isogeny_small_degree.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/isogeny_small_degree.py", line 1553, in sage.schemes.elliptic_curves.isogeny_small_degree.Psi2
Warning, slow doctest:
    Psi2(71)  # long time (1 second)
Test ran for 0.50 s, check ran for 188.94 s
    [303 tests, 226.15 s]
```

To test this change locally and obtain the output above, one needs to revert the fixes from #33293 (e.g. `git revert 0047c4d d3a07b2 6c4a27e`).


Issue created by migration from https://trac.sagemath.org/ticket/33411





---

archive/issue_comments_471992.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-23T20:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471992",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471993.json:
```json
{
    "body": "For now, I have used wall time instead of cpu time in order to be consistent with the rest of the measurements. This ticket has a mild conflict with #32981, but it will not be hard to rebase either of the tickets on top of the other.\n----\nNew commits:",
    "created_at": "2022-02-23T20:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471993",
    "user": "https://github.com/mwageringel"
}
```

For now, I have used wall time instead of cpu time in order to be consistent with the rest of the measurements. This ticket has a mild conflict with #32981, but it will not be hard to rebase either of the tickets on top of the other.
----
New commits:



---

archive/issue_comments_471994.json:
```json
{
    "body": "Replying to [comment:1 gh-mwageringel]:\n> For now, I have used wall time instead of cpu time in order to be consistent with the rest of the measurements. This ticket has a mild conflict with #32981, but it will not be hard to rebase either of the tickets on top of the other.\n\nMakes sense, with #32981 stalled indefinitely. The changes look good but I'm still recovering from my last branch switch. I'll test it in the next day or two.",
    "created_at": "2022-02-23T23:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471994",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:1 gh-mwageringel]:
> For now, I have used wall time instead of cpu time in order to be consistent with the rest of the measurements. This ticket has a mild conflict with #32981, but it will not be hard to rebase either of the tickets on top of the other.

Makes sense, with #32981 stalled indefinitely. The changes look good but I'm still recovering from my last branch switch. I'll test it in the next day or two.



---

archive/issue_comments_471995.json:
```json
{
    "body": "The doctest timings make two other appearances that I've found. First, in the summary,\n\n\n```\nsage -t --random-seed=... src/sage/crypto/sbox.pyx\n    [269 tests, 43.87 s]\n```\n\n\nand also in the `sage -t --verbose` output,\n\n\n```\nTrying (line 11):    units.length.meter\nExpecting:\n    meter\nok [0.11 s]\n```\n\n\nShould we include the check time in those?\n\nOr more generally, do you think we should combine the example & check times for most purposes -- except when reporting a `--warn-long` violation? If we combined them, the \"summary\" time and verbose timings above would then include the check time, solving for us the problem of how to display the check times in those situations. Moreover we could do without this clause,\n\n\n```python\nif self.options.warn_long > 0 and example.walltime > self.options.warn_long:\n    self.report_overtime(out, test, example, got)\n```\n\n\nsince the subsequent one (including the check time) would suffice, being consistent with what the users sees in the summary/verbose timings.\n\nTo be clear, I think the variables should remain separate. I'm just wondering if we shouldn't use ` example.walltime + check_duration` in most places where we currently have `example.walltime`.",
    "created_at": "2022-02-24T03:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471995",
    "user": "https://github.com/orlitzky"
}
```

The doctest timings make two other appearances that I've found. First, in the summary,


```
sage -t --random-seed=... src/sage/crypto/sbox.pyx
    [269 tests, 43.87 s]
```


and also in the `sage -t --verbose` output,


```
Trying (line 11):    units.length.meter
Expecting:
    meter
ok [0.11 s]
```


Should we include the check time in those?

Or more generally, do you think we should combine the example & check times for most purposes -- except when reporting a `--warn-long` violation? If we combined them, the "summary" time and verbose timings above would then include the check time, solving for us the problem of how to display the check times in those situations. Moreover we could do without this clause,


```python
if self.options.warn_long > 0 and example.walltime > self.options.warn_long:
    self.report_overtime(out, test, example, got)
```


since the subsequent one (including the check time) would suffice, being consistent with what the users sees in the summary/verbose timings.

To be clear, I think the variables should remain separate. I'm just wondering if we shouldn't use ` example.walltime + check_duration` in most places where we currently have `example.walltime`.



---

archive/issue_comments_471996.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-25T19:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471996",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471997.json:
```json
{
    "body": "Replying to [comment:3 mjo]:\n> Or more generally, do you think we should combine the example & check times for most purposes -- except when reporting a `--warn-long` violation?\n\nYes, I think you are right about this. I have changed it in the last commit.\n\nThe summary time already included the check duration. Apparently, the variable `total_walltime` is only used when the time for running the tests is bounded by `--short=\u2026`, but it makes sense to include the duration of the checking in that computation as well.\n\n\n> Moreover we could do without this clause,\n\nI have removed the clause, but this means that the long time warning almost always looks like\n\n```\nTest ran for 71.83 s, check ran for 0.00 s\n```\n\nwhere the second time is not of much use. Since these warnings should be rare anyway and since this simplifies the implementation (by getting rid of a branch that is practically never used unless there is a problem in the doctesting framework like #33293), this extra bit of verbosity seems acceptable to me.",
    "created_at": "2022-02-25T19:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471997",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:3 mjo]:
> Or more generally, do you think we should combine the example & check times for most purposes -- except when reporting a `--warn-long` violation?

Yes, I think you are right about this. I have changed it in the last commit.

The summary time already included the check duration. Apparently, the variable `total_walltime` is only used when the time for running the tests is bounded by `--short=…`, but it makes sense to include the duration of the checking in that computation as well.


> Moreover we could do without this clause,

I have removed the clause, but this means that the long time warning almost always looks like

```
Test ran for 71.83 s, check ran for 0.00 s
```

where the second time is not of much use. Since these warnings should be rare anyway and since this simplifies the implementation (by getting rid of a branch that is practically never used unless there is a problem in the doctesting framework like #33293), this extra bit of verbosity seems acceptable to me.



---

archive/issue_comments_471998.json:
```json
{
    "body": "Replying to [comment:5 gh-mwageringel]:\n> \n> I have removed the clause, but this means that the long time warning almost always looks like\n> {{{\n> Test ran for 71.83 s, check ran for 0.00 s\n> }}}\n> where the second time is not of much use.\n\nThis has a nice side effect. With the current branch, I can do something like `--warn-long=0.1`, and then grep/sort the output to see if any checks have taken too long, even if the entire test+check would not have exceeded a normal test+check time. Doing so works around the fact that checks should be much faster than tests, without requiring us to add a separate option for, say, `--warn-long-check`.\n\nOverall, I think this is a good compromise that will catch the bugs it's intended to catch without overcomplicating everything. Thanks.",
    "created_at": "2022-02-26T02:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471998",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:5 gh-mwageringel]:
> 
> I have removed the clause, but this means that the long time warning almost always looks like
> {{{
> Test ran for 71.83 s, check ran for 0.00 s
> }}}
> where the second time is not of much use.

This has a nice side effect. With the current branch, I can do something like `--warn-long=0.1`, and then grep/sort the output to see if any checks have taken too long, even if the entire test+check would not have exceeded a normal test+check time. Doing so works around the fact that checks should be much faster than tests, without requiring us to add a separate option for, say, `--warn-long-check`.

Overall, I think this is a good compromise that will catch the bugs it's intended to catch without overcomplicating everything. Thanks.



---

archive/issue_comments_471999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-26T02:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-471999",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472000.json:
```json
{
    "body": "For example,\n\n\n```\n$ grep 'Test ran for' warnlong.log | sed 's/^.*check ran for \\([^ ]*\\) s/\\1/g' | sort | uniq\n0.00\n0.01\n0.02\n0.03\n0.04\n0.05\n0.09\n0.14\n0.19\n0.24\n0.28\n0.31\n```\n",
    "created_at": "2022-02-26T13:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-472000",
    "user": "https://github.com/orlitzky"
}
```

For example,


```
$ grep 'Test ran for' warnlong.log | sed 's/^.*check ran for \([^ ]*\) s/\1/g' | sort | uniq
0.00
0.01
0.02
0.03
0.04
0.05
0.09
0.14
0.19
0.24
0.28
0.31
```




---

archive/issue_comments_472001.json:
```json
{
    "body": "Replying to [comment:6 mjo]:\n> This has a nice side effect. With the current branch, I can do something like `--warn-long=0.1`, and then grep/sort the output to see if any checks have taken too long, even if the entire test+check would not have exceeded a normal test+check time.\n\nIt took me a while to understand this because I was convinced this was already possible with the old branch, but you are right \u2013 this works now, since previously the report for a test taking more than 0.1 seconds would not include the check time.\n\nThanks for the comments and the review.",
    "created_at": "2022-02-26T17:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-472001",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:6 mjo]:
> This has a nice side effect. With the current branch, I can do something like `--warn-long=0.1`, and then grep/sort the output to see if any checks have taken too long, even if the entire test+check would not have exceeded a normal test+check time.

It took me a while to understand this because I was convinced this was already possible with the old branch, but you are right – this works now, since previously the report for a test taking more than 0.1 seconds would not include the check time.

Thanks for the comments and the review.



---

archive/issue_comments_472002.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-03T22:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33174#issuecomment-472002",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
