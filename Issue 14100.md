# Issue 14100: New implementation of unramified p-adics using FLINT and templates

Issue created by migration from Trac.

Original creator: roed

Original creation time: 2013-03-19 03:14:00

Assignee: roed

CC:  fredrik.johansson jpflori saraedum

Reimplement Qq using FLINT.


---

Comment by roed created at 2013-03-22 05:28:44

This ticket is essentially complete at https://github.com/saraedum/sage/tree/Zq.  Once #12173 is positively reviewed we'll make some patches and put this up for review.


---

Comment by jdemeyer created at 2013-05-09 18:37:39

Replying to [comment:3 roed]:
> Once #12173 is positively reviewed
check!


---

Comment by saraedum created at 2013-07-25 15:18:33

The repository moved to https://github.com/saraedum/sage-renamed/tree/Zq


---

Comment by roed created at 2014-01-05 00:38:49

Last 10 new commits:


---

Comment by roed created at 2014-01-05 20:49:26

New commits:


---

Comment by roed created at 2014-01-05 20:49:26

Changing status from new to needs_review.


---

Comment by saraedum created at 2014-01-06 00:22:48

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2014-01-06 00:26:23

I mostly looked at the last two commits. Everything else had already been reviewed before. I did not run doctests. Is there a working patchbot which will run the doctests or do I have to run them manually?


---

Comment by vbraun created at 2014-01-07 00:40:55

Does not work... please run "make ptestlong"


---

Comment by roed created at 2014-01-07 00:54:40

Will do.


---

Comment by roed created at 2014-01-07 00:54:40

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-01-07 08:51:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2014-01-07 08:56:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-01-07 12:45:53

There is invalid use of `sig_on()` in many places. The following is wrong:

```
sig_on()
if condition:
    raise Exception
sig_off()
```

You must put a `sig_off()` before the `raise` (or use `try`/`finally`).

I also recommend to doctest these exceptions. The doctesting framework catches such invalid use of `sig_on()`.

I also don't like bare `except:` statements. Be explicit and use `except BaseException:` or `except Exception:` instead.


---

Comment by jdemeyer created at 2014-01-07 12:45:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-01-08 02:31:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2014-01-08 02:35:23

Replying to [comment:17 jdemeyer]:
> There is invalid use of `sig_on()` in many places. The following is wrong:
> {{{
> sig_on()
> if condition:
>     raise Exception
> sig_off()
> }}}
> You must put a `sig_off()` before the `raise` (or use `try`/`finally`).

Thanks.  I fixed them.

> I also recommend to doctest these exceptions. The doctesting framework catches such invalid use of `sig_on()`.

All of the instances I found were for problems that we never expect to arise (out of memory errors, etc).  So I don't see a reasonable way to doctest these exceptions.

> I also don't like bare `except:` statements. Be explicit and use `except BaseException:` or `except Exception:` instead.

I know.  :-)  I told Julian you didn't like them, but he claimed it was okay since we raised after catching in each case.  Anyway, I've changed them to `except BaseException:`.


---

Comment by roed created at 2014-01-08 02:35:23

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-01-08 07:10:18

For the record, the Python docs say

    exception BaseException

    The base class for all built-in exceptions. It is not meant to be directly 
    inherited by user-defined classes (for that, use Exception).

Nested exception blocks are generally hard to read, quadruply nested exception try/except/finally blocks even more so. Besides the usual advice of breaking long functions up into shorter ones, for the heap cleanup in the face of exceptions make sure that invalid / not yet allocated pointers are NULL. To simplify the cleanup part, `free(NULL)` is a no-op.

The `for i from 0 <= i <= n` construct is old, Cython nowadays produces the same C code for the (preferred) Python syntax `for i in range(n)`.


---

Comment by jdemeyer created at 2014-01-08 07:29:15

Replying to [comment:19 roed]:
> but he claimed it was okay since we raised after catching in each case.  Anyway, I've changed them to `except BaseException:`.
It is technically ok in this case. The reason I don't like `except:` is that in almost all cases that I have seen, it was a mistake. If you write `except BaseException:`, it shows that you probably know what you're doing and that it is not a mistake. It is also consistent with "Explicit is better than implicit" from the Zen of Python (`import this`).


---

Comment by jdemeyer created at 2014-01-08 08:39:34

`sig_on()` should be outside the try/finally block (if `sig_on()` raises a `KeyboardInterrupt`, then `sig_off()` should not be called)

```
sig_on()
try:
    ...
finally:
    sig_off()
```



---

Comment by jdemeyer created at 2014-01-09 17:01:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-01-09 21:58:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2014-01-09 22:42:24

> Nested exception blocks are generally hard to read, quadruply nested exception try/except/finally blocks even more so. Besides the usual advice of breaking long functions up into shorter ones, for the heap cleanup in the face of exceptions make sure that invalid / not yet allocated pointers are NULL. To simplify the cleanup part, `free(NULL)` is a no-op.

What about things like `mpz_clear`, `fmpz_clear` and `fmpz_poly_clear`?  If `a` is an `fmpz_poly_t` that has not yet had `fmpz_poly_init(a)` run on it, won't `fmpz_poly_clear(a)` be a double free?


---

Comment by roed created at 2014-01-09 22:45:01

I've addressed the concerns about `sig_on` and the Cython for loops.  I agree that the super-nested try blocks are ugly, but I don't know how to rewrite it safely without this nesting.


---

Comment by roed created at 2014-01-09 22:45:01

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2014-01-09 22:47:44

Replying to [comment:25 roed]:
> What about things like `mpz_clear`, `fmpz_clear` and `fmpz_poly_clear`?  If `a` is an `fmpz_poly_t` that has not yet had `fmpz_poly_init(a)` run on it, won't `fmpz_poly_clear(a)` be a double free?
Yes, they will and Sage will crash, or at least could.
On Linux you can set _MALLOC_CHECK=3 to ensure (or have a higher probability) it will crash in such cases.


---

Comment by roed created at 2014-01-09 22:50:21

Replying to [comment:27 jpflori]:
> Replying to [comment:25 roed]:
> > What about things like `mpz_clear`, `fmpz_clear` and `fmpz_poly_clear`?  If `a` is an `fmpz_poly_t` that has not yet had `fmpz_poly_init(a)` run on it, won't `fmpz_poly_clear(a)` be a double free?
> Yes, they will and Sage will crash, or at least could.
> On Linux you can set _MALLOC_CHECK=3 to ensure (or have a higher probability) it will crash in such cases.

So, does anyone have suggestions on how to rewrite the ugly nested try blocks in `PowComputer_flint_unram.__cinit__`?  Julian and I couldn't think of a better way to do it that would never have a memory leak or a double free.


---

Comment by jpflori created at 2014-01-09 22:51:09

I'll have a look tomorrow (french time).


---

Comment by jdemeyer created at 2014-01-10 07:42:34

Replying to [comment:28 roed]:
> So, does anyone have suggestions on how to rewrite the ugly nested try blocks in `PowComputer_flint_unram.__cinit__`?  Julian and I couldn't think of a better way to do it that would never have a memory leak or a double free.

I had a look at the code and the current code actually is never going to work. The C-level functions like `fmpz_poly_init` and `mpz_init` never raise exceptions. So, the `try`/`except` is pointless. As far as I can tell, there are two kinds of exceptions which can happen: a `MemoryError` in MPIR or a `KeyboardInterrupt`. In both cases, the exception will be raised by `sig_on()` and none of the `except` blocks are executed.

If you want to be absolutely correct, every single allocation should be wrapped individually in `sig_on()`/`sig_off()`. Example for 2 allocations:

```
sig_on()
alloc1()
sig_off()

try:
    sig_on()
    alloc2()
    sig_off()
except BaseException:
    free1()
    raise
```


But at least the very deeply nested block on this ticket is allocating extremely little memory (surely less than 1000 bytes), so why not simply

```
alloc1()
alloc2()
```



---

Comment by saraedum created at 2014-01-10 11:51:00

Replying to [comment:30 jdemeyer]:
> Replying to [comment:28 roed]:
> > So, does anyone have suggestions on how to rewrite the ugly nested try blocks in `PowComputer_flint_unram.__cinit__`?  Julian and I couldn't think of a better way to do it that would never have a memory leak or a double free.
> 
> I had a look at the code and the current code actually is never going to work. [...]
You are right. I had misunderstood how `sig_on`/`sig_off` worked.

> But at least the very deeply nested block on this ticket is allocating extremely little memory (surely less than 1000 bytes), so why not simply
> {{{
> alloc1()
> alloc2()
> }}}
Is this acceptable? In the unlikely case that this allocation fails because we're out of memory, then sage is going to crash right?


---

Comment by jdemeyer created at 2014-01-10 12:40:18

Replying to [comment:31 saraedum]:
> Is this acceptable? In the unlikely case that this allocation fails because we're out of memory, then sage is going to crash right?
Well, at least the very deeply nested allocation in this branch is allocating very little memory. If that already fails, bad things are going to happen anyway.


---

Comment by git created at 2014-01-12 05:36:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2014-01-12 05:38:23

Here are two commits; the first has the 11-nested try blocks with "safe" memory handling, and the second removes them for code readability.  I'm fine with either approach.


---

Comment by jdemeyer created at 2014-01-13 09:49:09

This comment is wrong:

```
While the following allocations have the potential to leak
small amounts of memory when interrupted or when one of the
init methods raises a MemoryError
```


If you don't have `sig_on()`, the code cannot be interrupted (unless it's called from within `sig_on()`, but that would not be a good idea). It also cannot raise a `MemoryError`, since there is no `sig_on()` to raise them. Instead of a `MemoryError`, Sage would simply crash hard.


---

Comment by roed created at 2014-01-13 10:04:17

Replying to [comment:35 jdemeyer]:

> If you don't have `sig_on()`, the code cannot be interrupted (unless it's called from within `sig_on()`, but that would not be a good idea). It also cannot raise a `MemoryError`, since there is no `sig_on()` to raise them. Instead of a `MemoryError`, Sage would simply crash hard.

So the whole block of allocations should be wrapped in a single `sig_on()`/`sig_off()`?


---

Comment by jdemeyer created at 2014-01-13 10:15:23

Replying to [comment:36 roed]:
> So the whole block of allocations should be wrapped in a single `sig_on()`/`sig_off()`?
In that case, memory leaks are possible and the comment would be 100% correct.


---

Comment by jpflori created at 2014-01-13 10:34:28

I see that there is some smartness added to sage_mpir_malloc/... functions in src/c_lib/memory.c, and these functions are hopefully called when mpir_init is (instead of plain malloc/...).

But as far as I now, nothing similar was done for flint, and if that's the case, a failed memory allocation would go undetected anyway (and Sage crash quite quickly with null pointer dereference or similar delicious stuff).

I just looked at flint memory allocation code (flfint_malloc/...), and a failed allocation by malloc would call the flint_memory_error function which calls abort().


---

Comment by jdemeyer created at 2014-01-13 10:38:26

Replying to [comment:38 jpflori]:
> I just looked at flint memory allocation code (flfint_malloc/...), and a failed allocation by malloc would call the flint_memory_error function which calls abort().
That's great because (unlike MPIR which silenty ignores memory errors) an `abort()` within `sig_on()` yields a `RuntimeError` which can safely be handled.


---

Comment by pbruin created at 2014-01-13 14:12:30

Why not increment the `__allocated` counter after every successful allocation and use its value in `__dealloc__()` to decide which objects have to be deallocated?  E.g.

```python
def __cinit__(self, ...):
    sig_on()
    self.__allocated = 0
    fmpz_init(self.fmpz_ccmp); self.__allocated++
    fmpz_init(self.fmpz_cval); self.__allocated++
    ...
    fmpz_poly_init(self.poly_cconv); self.__allocated++
    fmpz_poly_init(self.poly_ctm); self.__allocated++
    ...
    sig_off()

def __dealloc__(self, ...):
    if self.__allocated >= 1:
        fmpz_clear(self.fmpz_ccmp)
    if self.__allocated >= 2:
        fmpz_clear(self.fmpz_cval)
    ...
```

I hope I'm understanding the problem correctly; I'm just looking at the code and didn't follow the above discussion very closely.


---

Comment by jdemeyer created at 2014-01-13 14:16:36

For that to work properly, `self.__allocated` should have type `volatile int`.


---

Comment by pbruin created at 2014-01-13 14:38:42

Replying to [comment:41 jdemeyer]:
> For that to work properly, `self.__allocated` should have type `volatile int`.
OK, I can believe that.  Does Cython support `volatile`?


---

Comment by jdemeyer created at 2014-01-13 14:40:16

Replying to [comment:42 pbruin]:
> Replying to [comment:41 jdemeyer]:
> > For that to work properly, `self.__allocated` should have type `volatile int`.
> OK, I can believe that.  Does Cython support `volatile`?
Not directly, as far as I know. You can do

```
cdef extern from *:
    ctypedef int volatile_int "volatile int"
```

and then use `volatile_int`.


---

Comment by vbraun created at 2014-01-13 16:59:42

Agree with the volatile being necessary so that the optimizer doesn't combine the increments into a single += n. But afaik it would still be legal for the optimizer to reorder statements as 

```python
    self.__allocated++
    self.__allocated++
    ...
    self.__allocated++
    fmpz_init(self.fmpz_ccmp)
    fmpz_init(self.fmpz_cval)
    ...
    fmpz_poly_init(self.poly_ctm)
```

So either mark everything that needs to be accessed in-order as volatile. Or use the usual pattern 

```python
def __cinit__(self, ...):
    self.fmpz_ccmp = NULL
    self.fmpz_cval = NULL
    sig_on()
    fmpz_init(self.fmpz_ccmp)
    fmpz_init(self.fmpz_cval)
    sig_off()

def __dealloc__(self, ...):
    if self.fmpz_ccmp != NULL:
        fmpz_clear(self.fmpz_ccmp)
    if self.fmpz_ccval != NULL:
        fmpz_clear(self.fmpz_ccval)
```



---

Comment by vbraun created at 2014-01-13 17:31:19

I guess that can still be broken by creative reordering of the pointer initialization, so to be 100% safe one would need to split the setting to NULL from the `fmpz_init` either by  
1. a compiler barrier (`asm volatile("" ::: "memory")` in gcc) 
2. move the `fmpz_init` into `__init__`
3. RAII (separate classes for each `fmpz_poly_t`)


---

Comment by git created at 2014-01-14 07:30:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-05-01 16:54:14

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2014-05-01 16:54:14

I merged the latest development branch (conflicts in `sage/rings/padics/factory.py` and `sage/rings/padics/pow_computer.pyx`), and then got this error while compiling:

```
Error compiling Cython file:
------------------------------------------------------------
...

        fmpz_poly_content(prime_pow.fmpz_cinv, a)
        fmpz_poly_scalar_divexact_fmpz(out, a, prime_pow.fmpz_cinv)

        fmpz_poly_xgcd(prime_pow.fmpz_cinv2, out, prime_pow.poly_cinv2, out, prime_pow.poly_cinv)
        if fmpz_is_zero(prime_pow.cinv2): raise ValueError("polynomials are not coprime")
                                ^
------------------------------------------------------------

./sage/libs/linkages/padics/fmpz_poly_unram.pxi:343:33: Cannot convert Python object to 'fmpz_t'
```



---

Comment by saraedum created at 2014-06-25 22:22:24

Changing keywords from "" to "sd59".


---

Comment by saraedum created at 2014-06-25 22:22:24

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2014-06-25 22:27:29

I'm happy with the changes roed made since my last `positive_review`. So from my point of view this could go back to `positive_review` once somebody reviewed my few changes and if the patchbot is happy.
----
New commits:


---

Comment by git created at 2014-06-26 05:13:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2014-06-26 05:15:21

I hope that this fixes all the bugs the patchbot detected.


---

Comment by git created at 2014-06-26 06:01:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-26 09:06:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-08-25 09:25:56

needs rebase


---

Comment by chapoton created at 2014-08-25 09:25:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-10-27 01:47:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-27 08:42:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-10-31 20:27:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-05 01:40:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-11-05 07:12:55

Just a few technical comments (I don't plan to formally review this):
1. You don't need to add `include_dirs = [SAGE_INC + '/flint']` (just add `flint/` to the path to the `.h` files)
2. You don't need to add `__richcmp__` calling `_richcmp`
3. You don't need to add `__hash__` which just raises `TypeError`: all `Element`s are now unhashable by default.
4. For consistency with other `.pxd` files, could you move all declarations of FLINT types to `sage/libs/flint/types.pxd`?
5. In this block

```
            try:
                padic_ctx_init(self.ctx, self.fprime, 0, prec_cap, PADIC_SERIES)
            except:
                mpz_clear(self.top_power)
                raise
```

given that `padic_ctx_init` is a C function, how could it ever raise a Python exception? Moreover, I find it bad style to use `except:`, you should be more explicit and catch `except BaseException:` instead (the reason I say this is because most people write `except:` by mistake).


---

Comment by git created at 2015-11-09 08:19:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-14 01:50:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-19 18:59:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-11-19 19:19:30

Why this change?

```diff
diff --git a/src/sage/algebras/quatalg/quaternion_algebra_element.pyx b/src/sage/algebras/quatalg/quaternion_algebra_element.pyx
index 03470ef..c5620e1 100644
--- a/src/sage/algebras/quatalg/quaternion_algebra_element.pyx
+++ b/src/sage/algebras/quatalg/quaternion_algebra_element.pyx
`@``@` -18,6 +18,9 `@``@` quaternion algebras and quaternion algebras over number fields.
 #                  http://www.gnu.org/licenses/
 #*****************************************************************************
 
+from sage.libs.flint.fmpz cimport *
+from sage.libs.flint.fmpz_poly cimport *
+from sage.libs.flint.ntl_interface cimport *
 from sage.structure.element cimport AlgebraElement, RingElement, ModuleElement, Element
 from sage.algebras.quatalg.quaternion_algebra_element cimport QuaternionAlgebraElement_abstract
 from sage.rings.rational cimport Rational
```



---

Comment by jdemeyer created at 2015-11-19 19:20:30

There are also some strange added imports in `src/sage/rings/polynomial/...`


---

Comment by jdemeyer created at 2015-11-19 19:22:07

Similarly:

```diff
diff --git a/src/sage/libs/flint/ntl_interface.pxd b/src/sage/libs/flint/ntl_interface.pxd
index 7cea729..6b88b9b 100644
--- a/src/sage/libs/flint/ntl_interface.pxd
+++ b/src/sage/libs/flint/ntl_interface.pxd
`@``@` -2,6 +2,8 `@``@` from types cimport fmpz_t, fmpz_poly_t
 
 from sage.libs.ntl.ntl_ZZ_decl cimport ZZ_c
 from sage.libs.ntl.ntl_ZZX_decl cimport ZZX_c
+from sage.libs.flint.fmpz cimport fmpz_t
+from sage.libs.flint.fmpz_poly cimport fmpz_poly_t
 
 cdef extern from "flint/NTL-interface.h":
     void fmpz_poly_get_ZZX(ZZX_c output, fmpz_poly_t poly)
```



---

Comment by saraedum created at 2015-11-21 18:49:02

These imports happened because we fixed flint build errors by importing the necessary symbols. We just imported them in different places than what got into develop did. So the merge did not catch this conflict it seems.
Thanks for pointing these out.


---

Comment by git created at 2015-11-21 18:49:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-21 20:21:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-23 18:27:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-11-29 21:18:53

Conflicts with 6.10.beta6. If you fix this conflict, I can easily merge #19646.


---

Comment by git created at 2015-12-17 04:09:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-22 05:28:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-22 05:52:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2015-12-23 18:20:15

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2015-12-23 18:20:15

All doctests in `rings/` now pass (have not checked with `--long`.)


---

Comment by git created at 2015-12-23 18:20:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-12-23 19:26:00

See [comment:63]


---

Comment by jdemeyer created at 2015-12-23 19:26:00

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-12-23 19:27:07

Avoid `cdefs.pxi`, just `cimport` whatever you need.


---

Comment by git created at 2016-01-09 05:08:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-01-09 05:10:13

Replying to [comment:63 jdemeyer]:
> 1. You don't need to add `include_dirs = [SAGE_INC + '/flint']` (just add `flint/` to the path to the `.h` files)
Fixed in [ab07bc41a76f58c6063c5e7a9ab8b4add7bc4f6a](http://git.sagemath.org/sage.git/commit/?id=ab07bc41a76f58c6063c5e7a9ab8b4add7bc4f6a).
> 2. You don't need to add `__richcmp__` calling `_richcmp`
Fixed in [2a1f29345297da21ffe14c47e39faa1ac76eda5a](http://git.sagemath.org/sage.git/commit/?id=2a1f29345297da21ffe14c47e39faa1ac76eda5a).
> 3. You don't need to add `__hash__` which just raises `TypeError`: all `Element`s are now unhashable by default.
I actually do need this implementation to override the base class. Adressed in [2a1f29345297da21ffe14c47e39faa1ac76eda5a](http://git.sagemath.org/sage.git/commit/?id=2a1f29345297da21ffe14c47e39faa1ac76eda5a).
> 4. For consistency with other `.pxd` files, could you move all declarations of FLINT types to `sage/libs/flint/types.pxd`?
I believe that this has happened by now.
> 5. In this block
> {{{
>             try:
>                 padic_ctx_init(self.ctx, self.fprime, 0, prec_cap, PADIC_SERIES)
>             except:
>                 mpz_clear(self.top_power)
>                 raise
> }}}
> given that `padic_ctx_init` is a C function, how could it ever raise a Python exception? Moreover, 
> I find it bad style to use `except:`, you should be more explicit and catch `except BaseException:` instead (the reason I say this is because most people write `except:` by mistake).
Both fixed in [860366d0bf36e8684c97f5bd5d3e336e79f5795d](http://git.sagemath.org/sage.git/commit/?id=860366d0bf36e8684c97f5bd5d3e336e79f5795d).
----
New commits:


---

Comment by saraedum created at 2016-01-09 05:16:32

Replying to [comment:83 jdemeyer]:
> Avoid `cdefs.pxi`, just `cimport` whatever you need.
Fixed.


---

Comment by git created at 2016-01-09 05:16:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-01-09 05:21:58

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-03-21 15:30:10

I just corrected a raise statement. There seems to be many failing doctests.
----
New commits:


---

Comment by git created at 2016-03-21 15:57:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aly.deines created at 2016-03-21 16:16:54

Changing status from needs_review to needs_work.


---

Comment by aly.deines created at 2016-03-21 16:16:54

On line 494 in sage/local/lib/python2.7/site-packages/sage/rings/padics/factory.py, you need to break the line using parenthesis.


```

aly`@`aly-laptop:~/Sage/sage$ ./sage -t src/sage
Traceback (most recent call last):
  File "/home/aly/Sage/sage/src/bin/sage-runtests", line 80, in <module>
    from sage.doctest.control import DocTestController
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 30, in <module>
    from sources import FileDocTestSource, DictAsObject
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/sources.py", line 27, in <module>
    from parsing import SageDocTestParser
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/parsing.py", line 49, in <module>
    from sage.all import RealIntervalField
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/all.py", line 100, in <module>
    from sage.rings.all      import *
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/rings/all.py", line 62, in <module>
    from padics.all import *
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/rings/padics/all.py", line 2, in <module>
    from factory import Zp, Zq, Zp as pAdicRing, ZpCR, ZpCA, ZpFM, ZqCR, ZqCA, ZqFM #, ZpL, ZqL
  File "/home/aly/Sage/sage/local/lib/python2.7/site-packages/sage/rings/padics/factory.py", line 494
    if version[0] < 4 or (len(version) > 1 and version[0] == 4 and version[1] < 5) or
                                                                                    ^
SyntaxError: invalid syntax


```



---

Comment by git created at 2016-03-21 16:56:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2016-03-21 16:57:34

Changing status from needs_work to needs_review.


---

Comment by roed created at 2016-03-21 16:57:34

Fixed


---

Comment by jdemeyer created at 2016-03-21 17:02:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-03-21 17:02:40

Needs to be rebased on top of #20210.


---

Comment by git created at 2016-03-22 00:00:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-22 01:32:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2016-03-22 01:40:34

Okay, I think I rebased it, but there are a ton of doctest errors that have nothing to do with p-adics.  I'm not sure what's going on.


```
sage -t src/sage/combinat/root_system/root_lattice_realizations.py  # 1 doctest failed
sage -t src/sage/combinat/designs/database.py  # 2 doctests failed
sage -t src/sage/geometry/polyhedron/base.py  # 2 doctests failed
sage -t src/sage/graphs/generic_graph.py  # 94 doctests failed
sage -t src/sage/graphs/graph.py  # 46 doctests failed
sage -t src/sage/doctest/forker.py  # 1 doctest failed
sage -t src/sage/schemes/generic/algebraic_scheme.py  # 10 doctests failed
sage -t src/sage/graphs/generators/smallgraphs.py  # 18 doctests failed
sage -t src/sage/tests/cmdline.py  # 14 doctests failed
sage -t src/sage/structure/sage_object.pyx  # 4 doctests failed
sage -t src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # 1 doctest failed
sage -t src/sage/schemes/toric/points.py  # 1 doctest failed
sage -t src/sage/combinat/posets/posets.py  # 5 doctests failed
sage -t src/sage/interfaces/sage0.py  # 1 doctest failed
sage -t src/sage/combinat/designs/orthogonal_arrays.py  # 8 doctests failed
sage -t src/sage/graphs/generators/families.py  # 4 doctests failed
sage -t src/sage/geometry/cone.py  # 3 doctests failed
sage -t src/sage/combinat/rigged_configurations/rigged_configurations.py  # 1 doctest failed
sage -t src/sage/combinat/designs/orthogonal_arrays_build_recursive.py  # 13 doctests failed
sage -t src/sage/matroids/matroid.pyx  # 1 doctest failed
sage -t src/sage/repl/interpreter.py  # 22 doctests failed
sage -t src/sage/structure/misc.pyx  # 1 doctest failed
sage -t src/sage/combinat/designs/incidence_structures.py  # 10 doctests failed
sage -t src/sage/numerical/optimize.py  # 6 doctests failed
sage -t src/sage/combinat/rigged_configurations/rc_infinity.py  # 1 doctest failed
sage -t src/sage/graphs/comparability.pyx  # 6 doctests failed
sage -t src/sage/graphs/generators/basic.py  # 1 doctest failed
sage -t src/sage/repl/ipython_extension.py  # 9 doctests failed
sage -t src/sage/repl/attach.py  # 2 doctests failed
sage -t src/sage/graphs/digraph.py  # 4 doctests failed
sage -t src/sage/typeset/ascii_art.py  # 2 doctests failed
sage -t src/sage/numerical/mip.pyx  # 486 doctests failed
sage -t src/sage/tests/french_book/nonlinear_doctest.py  # 1 doctest failed
sage -t src/sage/interacts/debugger.py  # 1 doctest failed
sage -t src/sage/repl/display/formatter.py  # 10 doctests failed
sage -t src/sage/combinat/designs/bibd.py  # 19 doctests failed
sage -t src/sage/repl/inputhook.pyx  # 2 doctests failed
sage -t src/sage/misc/temporary_file.py  # 1 doctest failed
sage -t src/sage/doctest/test.py  # 1 doctest failed
sage -t src/sage/repl/interface_magic.py  # 3 doctests failed
sage -t src/sage/dev/trac_interface.py  # 1 doctest failed
sage -t src/doc/en/thematic_tutorials/lie/infinity_crystals.rst  # 1 doctest failed
sage -t src/sage/combinat/posets/poset_examples.py  # 1 doctest failed
sage -t src/sage/repl/ipython_tests.py  # 4 doctests failed
sage -t src/sage/combinat/designs/orthogonal_arrays_find_recursive.pyx  # 2 doctests failed
sage -t src/sage/graphs/graph_decompositions/vertex_separation.pyx  # 7 doctests failed
sage -t src/sage/numerical/backends/glpk_backend.pyx  # 470 doctests failed
sage -t src/sage/combinat/integer_vector.py  # 5 doctests failed
sage -t src/sage/numerical/linear_functions.pyx  # 212 doctests failed
sage -t src/sage/combinat/rigged_configurations/rc_crystal.py  # 1 doctest failed
sage -t src/sage/combinat/shard_order.py  # 1 doctest failed
sage -t src/sage/graphs/generators/degree_sequence.py  # 3 doctests failed
sage -t src/sage/repl/rich_output/backend_ipython.py  # 3 doctests failed
sage -t src/sage/numerical/linear_tensor_element.pyx  # 50 doctests failed
sage -t src/doc/en/thematic_tutorials/numerical_sage/weave.rst  # 1 doctest failed
sage -t src/sage/numerical/linear_tensor_constraints.py  # 46 doctests failed
sage -t src/sage/numerical/backends/cvxopt_backend.pyx  # 10 doctests failed
sage -t src/sage/numerical/linear_tensor.py  # 57 doctests failed
sage -t src/sage/repl/ipython_kernel/install.py  # 1 doctest failed
sage -t src/sage/graphs/generators/chessboard.py  # 1 doctest failed
sage -t src/doc/en/reference/sat/index.rst  # 4 doctests failed
sage -t src/sage/numerical/backends/generic_backend.pyx  # 1 doctest failed
sage -t src/sage/graphs/graph_coloring.py  # 17 doctests failed
sage -t src/sage/numerical/knapsack.py  # 5 doctests failed
sage -t src/sage/graphs/hypergraph_generators.py  # 1 doctest failed
sage -t src/sage/repl/ipython_kernel/kernel.py  # 4 doctests failed
sage -t src/doc/en/thematic_tutorials/linear_programming.rst  # 35 doctests failed
sage -t src/sage/sat/solvers/sat_lp.py  # 15 doctests failed
sage -t src/sage/graphs/graph_decompositions/cutwidth.pyx  # 9 doctests failed
sage -t src/sage/graphs/convexity_properties.pyx  # 4 doctests failed
sage -t src/sage/sat/solvers/satsolver.pyx  # 1 doctest failed
sage -t src/sage/numerical/backends/gurobi_backend.pyx  # 1 doctest failed
```



---

Comment by roed created at 2016-03-22 01:40:48

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-03-22 17:02:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2016-03-22 17:14:36

Ok, I think I fixed the problems.


---

Comment by aly.deines created at 2016-03-22 21:32:05

I'm getting the same list of doctests failing.  They don't fail on #20210.  This is weird.  I did a clean pull and tested them.  None of them seem to have anything to do with your patch. Are they passing for you?


---

Comment by roed created at 2016-03-22 22:11:41

I think mine are passing.  See Prec_Build.term on the project....


---

Comment by aly.deines created at 2016-03-23 10:04:10

Changing status from needs_review to positive_review.


---

Comment by aly.deines created at 2016-03-23 10:04:10

I updated my development branch and now everything is passing.  It looks good to me! :)


---

Comment by aly.deines created at 2016-03-23 15:22:19

Changing keywords from "sd59" to "sd59, sd71".


---

Comment by aly.deines created at 2016-03-23 17:42:11

Changing keywords from "sd59, sd71" to "sd59, days71".


---

Comment by saraedum created at 2016-03-23 18:37:59

(I was told to be consistent about my last name…)


---

Comment by vbraun created at 2016-03-23 23:55:10

Resolution: fixed
