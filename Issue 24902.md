# Issue 24902: Add sage-spkg-uninstall script and use it when possible to remove packages

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-04-10 17:11:12

Keywords: uninstall

This is a cleaned up an simplified version of a _portion_ of the work originally done in #22510.  This ticket adds a few new features that I felt were fundamentally inseparable (in part due to peculiarities of specific packages meaning that uninstallation could not be supported without some additional work).

1. Adds a new script `sage-spkg-uninstall` which is invoked like `sage-spkg-uninstall <pkgname>` to uninstall a single package from `$SAGE_LOCAL` (this also allows uninstalling standard packages, though we might prefer to prevent that by default).  This script handles all matters of package uninstallation, including the final step of removing the package stamp file from  under `$SAGE_SPKG_INST`.  There are two different ways a package can be uninstalled:


   a. "Modern" uninstallation: if a package has staged-installation support (i.e. has been updated to support #22509), this means that its stamp file contains a manifest of _all_ files installed by that package (minus any files created by the package's `spkg-postinst` script). Therefore "modern" uninstallation consists mainly of looping over those files and removing them from `$SAGE_LOCAL`.  Any directories left empty by this process are also removed.


   b. "Legacy" uinstallation: many (though not all) packages have in their `spkg-install` script some code to perform an ad-hoc uninstallation of any previous versions of the package before installing the new version (this was sometimes necessary in particular for old versions of libraries).  Support for this functionality is retained in order to properly support upgrades from older versions of Sage, where most packages may not support "modern" uninstallation.

      However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.

      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #?????).

2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.

   This is needed in particular for some packages (namely `pkgconf` and `widgetsnbextension`) which really can't be removed properly without some post-removal steps.  Other packages will need this as well, but less crucially.  I haven't found a specific use case yet for `spkg-prerm`, but it's included for symmetry.

   Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed _somewhere_ (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.

3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files).


---

Comment by embray created at 2018-04-10 17:43:36

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-04-10 23:16:01

* There is a `TODO:` in your changeset. Should that be resolved now?
* I know you just copied code over in `build/pkgs/pkgconf/spkg-postinst` but shouldn't all return values be checked (or a `set -e` be set?)
* Should we check the return value in `build/pkgs/widgetsnbextension/spkg-prerm`?
* Why did you push the patch level in `build/pkgs/widgetsnbextension/package-version.txt`
* Why did you create a "docstring" here and not just a comment?

```
+PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')
+"""Directory where all spkg sources are found."""
```

* `SAGE_SPKG_INST` is always set, isn't it? Maybe it should then just be an error here if it isn't instead of copying the default from somewhere else?

```
+    spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')
+    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)
```

  and similarly for `SAGE_SPKG_SCRIPTS`.
* `postrm` should read `prerm` here I guess?

```
+    # Run the package's postrm script, if it exists
+    # If an error occurs here we abort the uninstallation for now
+    run_spkg_script(spkg_name, spkg_scripts, 'prerm', 'pre-uninstall')
```



---

Comment by saraedum created at 2018-04-10 23:16:47

Overall this looks good to me. It's great that we finally get a feature like that in Sage :)


---

Comment by saraedum created at 2018-04-10 23:17:03

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-11 13:04:52

Thanks for having a look!

Replying to [comment:3 saraedum]:
> * There is a `TODO:` in your changeset. Should that be resolved now?

I don't think that should be resolved now--the comment was just a note that it would be the correct spot, most likely, to start implementing such functionality.  Thanks for reminding me about that though.  There should be a follow-up ticket for it.



> * I know you just copied code over in `build/pkgs/pkgconf/spkg-postinst` but shouldn't all return values be checked (or a `set -e` be set?)

I agree, there should be some error checking there.  It could also use `sdh_install` from #25039 for the copy, which would take care of error checking.




> * Should we check the return value in `build/pkgs/widgetsnbextension/spkg-prerm`?

I'm not really sure it's necessary or desirable.  There are various reasons it _could_ fail, such as if that action had already (whether or not for good reasons) been performed by the user, or if the installation was otherwise broken somehow.  In this case other things _might_ break too, but at the very least you want to still allow the rest of the package uninstallation to proceed.




> * Why did you push the patch level in `build/pkgs/widgetsnbextension/package-version.txt`
The `pre/postrm` scripts have to be _installed_, so that means a version bump is needed here to make sure the package is upgraded in order to install them.




> * Why did you create a "docstring" here and not just a comment?
> {{{
> +PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')
> +"""Directory where all spkg sources are found."""
> }}}
It's standard syntax understood by Sphinx for documenting module-level variables and class attributes.  [Some people don't like it](https://trac.sagemath.org/ticket/24559#comment:24), apparently, but I'm personally quite partial to it for documenting variables, even in code that won't necessarily be processed by Sphinx.




> * `SAGE_SPKG_INST` is always set, isn't it? Maybe it should then just be an error here if it isn't instead of copying the default from somewhere else?
> {{{
> +    spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')
> +    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)
> }}}
>   and similarly for `SAGE_SPKG_SCRIPTS`.
Maybe it's not necessary, but I wrote `sage-spkg-uninstall` such that it works without necessarily instantiating the full "Sage environment" (I don't like how many programs in Sage do rely on this).  In fact you can pass it the path to `$SAGE_LOCAL` as an optional argument (which is otherwise read out of the environment).  One thing I don't like about this is that we don't exactly have an easy-to-parse file providing the default values for various environment variables used by Sage and its tooling.  But that's something to resolve elsewhere...




> * `postrm` should read `prerm` here I guess?
> {{{
> +    # Run the package's postrm script, if it exists
> +    # If an error occurs here we abort the uninstallation for now
> +    run_spkg_script(spkg_name, spkg_scripts, 'prerm', 'pre-uninstall')
> }}}

Yep. And since you pointed that out I also noticed some other fishy business going on at the bottom of the `modern_uninstall` function that it looks like I might have been sloppy about.


---

Comment by git created at 2018-04-18 09:00:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-04-18 09:08:46

Last 10 new commits:


---

Comment by git created at 2018-04-18 09:37:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2018-04-18 09:39:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-18 09:41:24

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-04-18 09:41:24

I believe I addressed all your comments, and made all the code updates I agreed were needed (especially cleaning up `sage_bootstrap.uninstall` a bit).  If you don't agree with any of my responses above we can still discuss that though.  I'm not too hard-set on any of the details of this.


---

Comment by embray created at 2018-04-18 09:42:15

Though before anyone reviews this further they should probably look at #24645 first.


---

Comment by git created at 2018-04-26 09:13:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-04-26 09:16:08

Something in the last patchbot build went awry with brial.  I'm not sure I understand the issue yet.


---

Comment by git created at 2018-04-26 10:05:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-04-26 10:07:09

Ok, the issue is fixed in #24645.  The next patchbot build _should_ be good but we'll see.


---

Comment by saraedum created at 2018-05-19 00:34:35

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-05-19 00:34:35

The patchbot still seems to be unhappy. I do not understand what's going on there…


---

Comment by embray created at 2018-05-21 11:37:05

Looks like just a merge conflict, yet again.


---

Comment by git created at 2018-05-21 11:55:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-05-21 11:58:57

Rebased, and removed the stuff related with `widgetsnbextension` which as jdemeyer pointed out in #24646 should no longer be relevant.


---

Comment by embray created at 2018-05-21 13:10:58

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-05-21 16:21:57

Looks good to me. I have not tested this though. If you are confident that this works, feel free to set it to positive review.


---

Comment by embray created at 2018-05-21 17:37:29

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-05-21 17:37:29

Will be interesting to see what the buildbots do with it, especially OSX.  I expect it will be fine.


---

Comment by vbraun created at 2018-05-24 07:10:46

Resolution: fixed
