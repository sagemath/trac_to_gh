# Issue 15238: Reenable broken doctest in #15473 when #10963 is merged

archive/issues_015238.json:
```json
{
    "body": "CC:  nthiery simonking tscrim sage-combinat\n\nKeywords: 10963, categories, c3\n\nSpeaking of this one:\n\n```\n            The following doctest is disabled pending :trac:`10963`::\n\n                sage: s = SymmetricFunctions(Zmod(14)).s() # not tested\n                sage: s.is_integral_domain() # not tested\n                False\n```\n\nAlso, rebase and merge the attached doc fixes to the categories primer.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15475\n\n",
    "created_at": "2013-12-01T01:34:54Z",
    "labels": [
        "categories",
        "minor",
        "enhancement"
    ],
    "title": "Reenable broken doctest in #15473 when #10963 is merged",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15238",
    "user": "darij"
}
```
CC:  nthiery simonking tscrim sage-combinat

Keywords: 10963, categories, c3

Speaking of this one:

```
            The following doctest is disabled pending :trac:`10963`::

                sage: s = SymmetricFunctions(Zmod(14)).s() # not tested
                sage: s.is_integral_domain() # not tested
                False
```

Also, rebase and merge the attached doc fixes to the categories primer.

Issue created by migration from https://trac.sagemath.org/ticket/15475





---

archive/issue_comments_195834.json:
```json
{
    "body": "Attachment [cat-fixes.patch](tarball://root/attachments/some-uuid/ticket15475/cat-fixes.patch) by darij created at 2013-12-01 01:35:14\n\njust documentation typos that i fixed when i was reading it",
    "created_at": "2013-12-01T01:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195834",
    "user": "darij"
}
```

Attachment [cat-fixes.patch](tarball://root/attachments/some-uuid/ticket15475/cat-fixes.patch) by darij created at 2013-12-01 01:35:14

just documentation typos that i fixed when i was reading it



---

archive/issue_comments_195835.json:
```json
{
    "body": "[obsolete]",
    "created_at": "2013-12-10T16:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195835",
    "user": "darij"
}
```

[obsolete]



---

archive/issue_comments_195836.json:
```json
{
    "body": "Changing type from task to defect.",
    "created_at": "2014-05-25T16:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195836",
    "user": "darij"
}
```

Changing type from task to defect.



---

archive/issue_comments_195837.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-25T16:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195837",
    "user": "darij"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_195838.json:
```json
{
    "body": "Needs_review now (finally). The review is really trivial.",
    "created_at": "2014-05-25T16:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195838",
    "user": "darij"
}
```

Needs_review now (finally). The review is really trivial.



---

archive/issue_comments_195839.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-25T16:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195839",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195840.json:
```json
{
    "body": "Branch fixed, but more bughuntery in progress.",
    "created_at": "2014-05-25T16:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195840",
    "user": "darij"
}
```

Branch fixed, but more bughuntery in progress.



---

archive/issue_comments_195841.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-25T16:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195841",
    "user": "darij"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_195842.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-05-25T16:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195842",
    "user": "darij"
}
```

New commits:



---

archive/issue_comments_195843.json:
```json
{
    "body": "Here is the bug. First, let us doctest ncsf.py with this branch normally:\n\n```\ndarij@travis-virtualbox:~/gitsage6.2$ ./sage -bt src/sage/combinat/ncsf_qsym/ncsf.py\nscons: `install' is up to date.\nUpdating Cython code....\nFinished Cythonizing, time: 3.75 seconds.\nrunning install\nrunning build\nrunning build_py\nrunning build_ext\nExecuting 0 commands (using 1 thread)\nTime to execute 0 commands: 0.00 seconds.\nTotal time spent compiling C/C++ extensions: 0.08 seconds.\nrunning install_lib\nrunning install_egg_info\nRemoving /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info\nWriting /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info\nRunning doctests with ID 2014-05-25-09-34-58-fd673a84.\nDoctesting 1 file.\nsage -t src/sage/combinat/ncsf_qsym/ncsf.py\n    [679 tests, 10.12 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 10.4 seconds\n    cpu time: 10.1 seconds\n    cumulative wall time: 10.1 seconds\n```\n\nNow, let's do the --long test:\n\n```\ndarij@travis-virtualbox:~/gitsage6.2$ ./sage -bt --long src/sage/combinat/ncsf_qsym/ncsf.py\nscons: `install' is up to date.\nUpdating Cython code....\nFinished Cythonizing, time: 3.88 seconds.\nrunning install\nrunning build\nrunning build_py\nrunning build_ext\nExecuting 0 commands (using 1 thread)\nTime to execute 0 commands: 0.00 seconds.\nTotal time spent compiling C/C++ extensions: 0.08 seconds.\nrunning install_lib\nrunning install_egg_info\nRemoving /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info\nWriting /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info\nRunning doctests with ID 2014-05-25-09-35-19-947fb6ad.\nDoctesting 1 file.\nsage -t --long src/sage/combinat/ncsf_qsym/ncsf.py\n**********************************************************************\nFile \"src/sage/combinat/ncsf_qsym/ncsf.py\", line 1520, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra\nFailed example:\n    all( S[C].to_symmetric_group_algebra()\n         == SGA4(D4(S[C].to_descent_algebra(4)))\n         for C in Compositions(4) )\nException raised:\n    Traceback (most recent call last):\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra[6]>\", line 3, in <module>\n        for C in Compositions(Integer(4)) )\n      File \"<doctest sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra[6]>\", line 3, in <genexpr>\n        for C in Compositions(Integer(4)) )\n      File \"parent.pyx\", line 1083, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8905)\n      File \"coerce_maps.pyx\", line 95, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:4206)\n      File \"coerce_maps.pyx\", line 90, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:4113)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/free_module.py\", line 1577, in _element_constructor_\n        raise TypeError(\"do not know how to make x (= %s) an element of self (=%s)\"%(x,self))\n    TypeError: do not know how to make x (= D{} + D{1} + D{1, 2} + D{1, 2, 3} + D{1, 3} + D{2} + D{2, 3} + D{3}) an element of self (=Symmetric group algebra of order 4 over Rational Field)\n**********************************************************************\n1 item had failures:\n   1 of   8 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra\n    [686 tests, 1 failure, 116.10 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/combinat/ncsf_qsym/ncsf.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 116.4 seconds\n    cpu time: 116.0 seconds\n    cumulative wall time: 116.1 seconds\n```\n\nThe failure was in a doctest which is **not** #long time!\n\nThere must be some coercion cache poisoning going on, probably similar to #15248, possibly connected to #10906. Any comments are welcome, since I don't have enough time for Sage these days.",
    "created_at": "2014-05-25T16:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195843",
    "user": "darij"
}
```

Here is the bug. First, let us doctest ncsf.py with this branch normally:

```
darij@travis-virtualbox:~/gitsage6.2$ ./sage -bt src/sage/combinat/ncsf_qsym/ncsf.py
scons: `install' is up to date.
Updating Cython code....
Finished Cythonizing, time: 3.75 seconds.
running install
running build
running build_py
running build_ext
Executing 0 commands (using 1 thread)
Time to execute 0 commands: 0.00 seconds.
Total time spent compiling C/C++ extensions: 0.08 seconds.
running install_lib
running install_egg_info
Removing /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info
Writing /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info
Running doctests with ID 2014-05-25-09-34-58-fd673a84.
Doctesting 1 file.
sage -t src/sage/combinat/ncsf_qsym/ncsf.py
    [679 tests, 10.12 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 10.4 seconds
    cpu time: 10.1 seconds
    cumulative wall time: 10.1 seconds
```

Now, let's do the --long test:

```
darij@travis-virtualbox:~/gitsage6.2$ ./sage -bt --long src/sage/combinat/ncsf_qsym/ncsf.py
scons: `install' is up to date.
Updating Cython code....
Finished Cythonizing, time: 3.88 seconds.
running install
running build
running build_py
running build_ext
Executing 0 commands (using 1 thread)
Time to execute 0 commands: 0.00 seconds.
Total time spent compiling C/C++ extensions: 0.08 seconds.
running install_lib
running install_egg_info
Removing /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info
Writing /home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage-6.3.beta2-py2.7.egg-info
Running doctests with ID 2014-05-25-09-35-19-947fb6ad.
Doctesting 1 file.
sage -t --long src/sage/combinat/ncsf_qsym/ncsf.py
**********************************************************************
File "src/sage/combinat/ncsf_qsym/ncsf.py", line 1520, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra
Failed example:
    all( S[C].to_symmetric_group_algebra()
         == SGA4(D4(S[C].to_descent_algebra(4)))
         for C in Compositions(4) )
Exception raised:
    Traceback (most recent call last):
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra[6]>", line 3, in <module>
        for C in Compositions(Integer(4)) )
      File "<doctest sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra[6]>", line 3, in <genexpr>
        for C in Compositions(Integer(4)) )
      File "parent.pyx", line 1083, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8905)
      File "coerce_maps.pyx", line 95, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:4206)
      File "coerce_maps.pyx", line 90, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:4113)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/free_module.py", line 1577, in _element_constructor_
        raise TypeError("do not know how to make x (= %s) an element of self (=%s)"%(x,self))
    TypeError: do not know how to make x (= D{} + D{1} + D{1, 2} + D{1, 2, 3} + D{1, 3} + D{2} + D{2, 3} + D{3}) an element of self (=Symmetric group algebra of order 4 over Rational Field)
**********************************************************************
1 item had failures:
   1 of   8 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Bases.ElementMethods.to_symmetric_group_algebra
    [686 tests, 1 failure, 116.10 s]
----------------------------------------------------------------------
sage -t --long src/sage/combinat/ncsf_qsym/ncsf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 116.4 seconds
    cpu time: 116.0 seconds
    cumulative wall time: 116.1 seconds
```

The failure was in a doctest which is **not** #long time!

There must be some coercion cache poisoning going on, probably similar to #15248, possibly connected to #10906. Any comments are welcome, since I don't have enough time for Sage these days.



---

archive/issue_comments_195844.json:
```json
{
    "body": "OK, here is a minimal(?) way to cause the bug. Copy this code:\n\n```\ndef descent_test(n):\n    DA = DescentAlgebra(QQ, n)\n    DAD = DA.D()\n    DAB = DA.B()\n    DAD([])\n    for I in Compositions(n):\n        DAD(DAB[I])\n\ndef maintest():\n    descent_test(3)\n    descent_test(4) # you need both 3 and 4, IN THIS ORDER, to break it!\n    SGA4 = SymmetricGroupAlgebra(QQ, 4)\n    DAB = DescentAlgebra(QQ, 4).B()\n    x = DAB[4]\n    SGA4(x)\n```\n\n\ninto a .py file and attach it. Run maintest(). You will get an error:\n\n```\nTypeError: do not know how to make x (= B[4]) an element of self (=Symmetric group algebra of order 4 over Rational Field)\n```\n\nAfterwards, try doing\n\n```\nsage: SGA4 = SymmetricGroupAlgebra(QQ, 4)\nsage: D4 = DescentAlgebra(QQ, 4).D()\nsage: SGA4.has_coerce_map_from(D4)\n```\n\nYou get `False`, although in a virgin session it would be `True`. So it looks like either we have problems with UniqueRepresentation and coercion, or the coercion graph has become too confusing for Sage to find a way (#15303?).\n\nHow do I debug a failed coercion? Is there a method that shows me a local coercion graph?\n\nAlso, I am no longer sure if the sfa.py issue has really been fixed or if #10963 has just kicked the can further down the road. Is there a sanity check for coercion graphs?",
    "created_at": "2014-05-25T17:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195844",
    "user": "darij"
}
```

OK, here is a minimal(?) way to cause the bug. Copy this code:

```
def descent_test(n):
    DA = DescentAlgebra(QQ, n)
    DAD = DA.D()
    DAB = DA.B()
    DAD([])
    for I in Compositions(n):
        DAD(DAB[I])

def maintest():
    descent_test(3)
    descent_test(4) # you need both 3 and 4, IN THIS ORDER, to break it!
    SGA4 = SymmetricGroupAlgebra(QQ, 4)
    DAB = DescentAlgebra(QQ, 4).B()
    x = DAB[4]
    SGA4(x)
```


into a .py file and attach it. Run maintest(). You will get an error:

```
TypeError: do not know how to make x (= B[4]) an element of self (=Symmetric group algebra of order 4 over Rational Field)
```

Afterwards, try doing

```
sage: SGA4 = SymmetricGroupAlgebra(QQ, 4)
sage: D4 = DescentAlgebra(QQ, 4).D()
sage: SGA4.has_coerce_map_from(D4)
```

You get `False`, although in a virgin session it would be `True`. So it looks like either we have problems with UniqueRepresentation and coercion, or the coercion graph has become too confusing for Sage to find a way (#15303?).

How do I debug a failed coercion? Is there a method that shows me a local coercion graph?

Also, I am no longer sure if the sfa.py issue has really been fixed or if #10963 has just kicked the can further down the road. Is there a sanity check for coercion graphs?



---

archive/issue_comments_195845.json:
```json
{
    "body": "Changing keywords from \"10963, categories, c3\" to \"10963, categories, c3, coercion, transitivity, descent algebras, symmetric functions\".",
    "created_at": "2014-05-25T17:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195845",
    "user": "darij"
}
```

Changing keywords from "10963, categories, c3" to "10963, categories, c3, coercion, transitivity, descent algebras, symmetric functions".



---

archive/issue_comments_195846.json:
```json
{
    "body": "I feel like this is the same issue as #15309, in that calling `DAD([])` makes it so that no coercions can be added dynamically (up to doing something extreme like overriding `_coerce_map_from_()`). So if this is indeed the case, either we need to have better hard-coded coercions (which is the best solution, but the most work) to changing the doctests to mask this.",
    "created_at": "2014-05-31T00:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195846",
    "user": "tscrim"
}
```

I feel like this is the same issue as #15309, in that calling `DAD([])` makes it so that no coercions can be added dynamically (up to doing something extreme like overriding `_coerce_map_from_()`). So if this is indeed the case, either we need to have better hard-coded coercions (which is the best solution, but the most work) to changing the doctests to mask this.



---

archive/issue_comments_195847.json:
```json
{
    "body": "Indeed...\n\n\n```\nsage: DAD = DescentAlgebra(QQ, 4).D()\nsage: DAD._coercions_used\nFalse\nsage: maintest()\nsage: DAD._coercions_used\nTrue\n```\n\n\nHmm; what is `_coercions_used` and what is it good for? Why can't we just remove it?\n\nEDIT: On the other hand, commenting out `self._coercions_used = True` in parent.pyx does not fix the error. But why do we have this kind of flag anyway? How on earth do we want to know if all coercions from/to a given objects are already known? Why on earth do we want this information?",
    "created_at": "2014-05-31T11:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195847",
    "user": "darij"
}
```

Indeed...


```
sage: DAD = DescentAlgebra(QQ, 4).D()
sage: DAD._coercions_used
False
sage: maintest()
sage: DAD._coercions_used
True
```


Hmm; what is `_coercions_used` and what is it good for? Why can't we just remove it?

EDIT: On the other hand, commenting out `self._coercions_used = True` in parent.pyx does not fix the error. But why do we have this kind of flag anyway? How on earth do we want to know if all coercions from/to a given objects are already known? Why on earth do we want this information?



---

archive/issue_comments_195848.json:
```json
{
    "body": "Replying to [comment:15 darij]:\n> EDIT: On the other hand, commenting out `self._coercions_used = True` in parent.pyx does not fix the error. But why do we have this kind of flag anyway? How on earth do we want to know if all coercions from/to a given objects are already known? Why on earth do we want this information?\n\nIf I understand correctly, this flag is only relevant if we want to explicitly set a new coercion via `register_coerce_map_from` or something of that kind (can't look into the code right now). The idea is that the explicit registrations happens during initialisation, whereas the automatic discovery of coerce maps by backtracking happens later and is not hampered by `self._coercions_used`.",
    "created_at": "2014-05-31T12:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195848",
    "user": "SimonKing"
}
```

Replying to [comment:15 darij]:
> EDIT: On the other hand, commenting out `self._coercions_used = True` in parent.pyx does not fix the error. But why do we have this kind of flag anyway? How on earth do we want to know if all coercions from/to a given objects are already known? Why on earth do we want this information?

If I understand correctly, this flag is only relevant if we want to explicitly set a new coercion via `register_coerce_map_from` or something of that kind (can't look into the code right now). The idea is that the explicit registrations happens during initialisation, whereas the automatic discovery of coerce maps by backtracking happens later and is not hampered by `self._coercions_used`.



---

archive/issue_comments_195849.json:
```json
{
    "body": "I believe the purpose of the flag is to try and prevent users from changing coercions dynamically:\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: D = CombinatorialFreeModule(QQ, ['a','b'])\nsage: phi = C.module_morphism(D.monomial, codomain=D)\nsage: C.register_coercion(phi)\nsage: # D(C.monomial('a'))\n'a'\nsage: def f(x):\n....:     if x == 'a':\n....:         return D.monomial('b')\n....:     return D.monomial('a')\n....: \nsage: psi = C.module_morphism(f, codomain=D)\nsage: C.register_coercion(psi)\nsage: # D(C.monomial('a'))\n'b'\n```\n",
    "created_at": "2014-05-31T16:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195849",
    "user": "tscrim"
}
```

I believe the purpose of the flag is to try and prevent users from changing coercions dynamically:

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: D = CombinatorialFreeModule(QQ, ['a','b'])
sage: phi = C.module_morphism(D.monomial, codomain=D)
sage: C.register_coercion(phi)
sage: # D(C.monomial('a'))
'a'
sage: def f(x):
....:     if x == 'a':
....:         return D.monomial('b')
....:     return D.monomial('a')
....: 
sage: psi = C.module_morphism(f, codomain=D)
sage: C.register_coercion(psi)
sage: # D(C.monomial('a'))
'b'
```




---

archive/issue_comments_195850.json:
```json
{
    "body": "Thanks`@`Simon, Travis.\n\nCan anyone check if it is really this flag which causes the bug I described in comment:13? I still get the error without the flag. Thank you.",
    "created_at": "2014-05-31T17:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195850",
    "user": "darij"
}
```

Thanks`@`Simon, Travis.

Can anyone check if it is really this flag which causes the bug I described in comment:13? I still get the error without the flag. Thank you.



---

archive/issue_comments_195851.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-24T23:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195851",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195852.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-24T23:54:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195852",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195853.json:
```json
{
    "body": "I've figured it out. The issue is that because we are not holding a strong reference to `SGA4`, it is being garbage collected, but `DAB` has not been. As such, the new coercion map does not get recreated, so the new `SGA4` doesn't know about the (dynamically created) coercion:\n\n```\nsage: SGA4 = SymmetricGroupAlgebra(QQ, 4); DAB = DescentAlgebra(QQ, 4).B()\nsage: del SGA4\nsage: import gc\nsage: gc.collect()\n599 # Some number, not important\nsage: SGA4 = SymmetricGroupAlgebra(QQ, 4) # Now recreate it\nsage: x = DAB[4]; SGA4(x)\n```\n\nIf you remove the `del SGA4`, it always works. I think the doctest runner is much more liberal about garbage collection which is why the test we had *almost* always failed.\n\nTherefore I've fixed this by making the descent algebra hold a *strong* reference to the SGA (which it probably should irregardless).\n\nThis is now #16532.",
    "created_at": "2014-06-25T05:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195853",
    "user": "tscrim"
}
```

I've figured it out. The issue is that because we are not holding a strong reference to `SGA4`, it is being garbage collected, but `DAB` has not been. As such, the new coercion map does not get recreated, so the new `SGA4` doesn't know about the (dynamically created) coercion:

```
sage: SGA4 = SymmetricGroupAlgebra(QQ, 4); DAB = DescentAlgebra(QQ, 4).B()
sage: del SGA4
sage: import gc
sage: gc.collect()
599 # Some number, not important
sage: SGA4 = SymmetricGroupAlgebra(QQ, 4) # Now recreate it
sage: x = DAB[4]; SGA4(x)
```

If you remove the `del SGA4`, it always works. I think the doctest runner is much more liberal about garbage collection which is why the test we had *almost* always failed.

Therefore I've fixed this by making the descent algebra hold a *strong* reference to the SGA (which it probably should irregardless).

This is now #16532.



---

archive/issue_comments_195854.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T05:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195854",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195855.json:
```json
{
    "body": "Replying to [comment:21 tscrim]:\n> I've figured it out. The issue is that because we are not holding a strong reference to `SGA4`, it is being garbage collected, but `DAB` has not been. As such, the new coercion map does not get recreated, so the new `SGA4` doesn't know about the (dynamically created) coercion:\n> ...\n> This is now #16532.\n\nI have no time to look at the code now. But from the description at #16532, it seems to be the case that the coercion `phi: A -> B` is registered by `B.register_coercion(phi)` during creation of A, which would be a misuse. It should either be registered as *the unique* coerce embedding of A (if this makes sense) by `A.register_embedding(phi)` during creation of A, or it should be registered by `B.register_coercion(phi)` during creation of B (not A), or should not be registered at all, letting `B._coerce_map_from_(A)` do the job.",
    "created_at": "2014-06-25T11:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195855",
    "user": "SimonKing"
}
```

Replying to [comment:21 tscrim]:
> I've figured it out. The issue is that because we are not holding a strong reference to `SGA4`, it is being garbage collected, but `DAB` has not been. As such, the new coercion map does not get recreated, so the new `SGA4` doesn't know about the (dynamically created) coercion:
> ...
> This is now #16532.

I have no time to look at the code now. But from the description at #16532, it seems to be the case that the coercion `phi: A -> B` is registered by `B.register_coercion(phi)` during creation of A, which would be a misuse. It should either be registered as *the unique* coerce embedding of A (if this makes sense) by `A.register_embedding(phi)` during creation of A, or it should be registered by `B.register_coercion(phi)` during creation of B (not A), or should not be registered at all, letting `B._coerce_map_from_(A)` do the job.



---

archive/issue_comments_195856.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T13:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195856",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T14:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195857",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195858.json:
```json
{
    "body": "Replying to [comment:23 SimonKing]:\n> I have no time to look at the code now. But from the description at #16532, it seems to be the case that the coercion `phi: A -> B` is registered by `B.register_coercion(phi)` during creation of A, which would be a misuse. It should either be registered as *the unique* coerce embedding of A (if this makes sense) by `A.register_embedding(phi)` during creation of A, or it should be registered by `B.register_coercion(phi)` during creation of B (not A), or should not be registered at all, letting `B._coerce_map_from_(A)` do the job.\n\nI've changed it to use `_coerce_map_from_` as this was the most robust with #15303 not being done (although I had to explicitly do the function composition). Thanks for clarifying.\n\nDarij, final review.",
    "created_at": "2014-06-25T14:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195858",
    "user": "tscrim"
}
```

Replying to [comment:23 SimonKing]:
> I have no time to look at the code now. But from the description at #16532, it seems to be the case that the coercion `phi: A -> B` is registered by `B.register_coercion(phi)` during creation of A, which would be a misuse. It should either be registered as *the unique* coerce embedding of A (if this makes sense) by `A.register_embedding(phi)` during creation of A, or it should be registered by `B.register_coercion(phi)` during creation of B (not A), or should not be registered at all, letting `B._coerce_map_from_(A)` do the job.

I've changed it to use `_coerce_map_from_` as this was the most robust with #15303 not being done (although I had to explicitly do the function composition). Thanks for clarifying.

Darij, final review.



---

archive/issue_comments_195859.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2014-06-25T14:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195859",
    "user": "tscrim"
}
```

Changing priority from minor to major.



---

archive/issue_comments_195860.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-06-25T14:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195860",
    "user": "tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_195861.json:
```json
{
    "body": "`@`Travis: You use the `canonical_embedding`, which gives a module homomorphism, as a coercion in case of coercing but distinct base rings. But is this clean? I thought module homomorphisms would only work over the same base ring. I don't see what should go wrong, but it feels like relying on indefinite behavior...\n\nGreat job hunting down the bug! It is scary that these things can make stuff break in Sage, though...",
    "created_at": "2014-06-25T20:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195861",
    "user": "darij"
}
```

`@`Travis: You use the `canonical_embedding`, which gives a module homomorphism, as a coercion in case of coercing but distinct base rings. But is this clean? I thought module homomorphisms would only work over the same base ring. I don't see what should go wrong, but it feels like relying on indefinite behavior...

Great job hunting down the bug! It is scary that these things can make stuff break in Sage, though...



---

archive/issue_comments_195862.json:
```json
{
    "body": "Suppose you want `phi : M -> N` with `M` an `R`-module and `N` an `S`-module with a coercion `R -> S`. Then `phi` is a morphism in the category of `R` modules. `canonical_embedding()` takes care of this (albeit somewhat silently) by defining the morphism only on the basis vectors and extending by linearity (over `R` in this case).",
    "created_at": "2014-06-25T23:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195862",
    "user": "tscrim"
}
```

Suppose you want `phi : M -> N` with `M` an `R`-module and `N` an `S`-module with a coercion `R -> S`. Then `phi` is a morphism in the category of `R` modules. `canonical_embedding()` takes care of this (albeit somewhat silently) by defining the morphism only on the basis vectors and extending by linearity (over `R` in this case).



---

archive/issue_comments_195863.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-26T11:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195863",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195864.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-26T11:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195864",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195865.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-26T11:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195865",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195866.json:
```json
{
    "body": "OUCH. I just realized that I forgot to reenable the symmetric functions doctest, and not unexpectedly it is still broken. OK, this thing must be unrelated to #10963 after all. Simon, can you make sense of this?\n\n\n```\nDoctesting 1 file.\nsage -t src/sage/combinat/sf/sfa.py\n**********************************************************************\nFile \"src/sage/combinat/sf/sfa.py\", line 752, in sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over\nFailed example:\n    s.corresponding_basis_over(Integers(13))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over[5]>\", line 1, in <module>\n        s.corresponding_basis_over(Integers(Integer(13)))\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sfa.py\", line 814, in corresponding_basis_over\n        return attrcall(self._basis)(SymmetricFunctions(R))\n      File \"classcall_metaclass.pyx\", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1282)\n      File \"cachefunc.pyx\", line 1077, in sage.misc.cachefunc.WeakCachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6486)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1021, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"classcall_metaclass.pyx\", line 518, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:1665)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sf.py\", line 763, in __init__\n        Parent.__init__(self, category = GradedHopfAlgebras(R).WithRealizations())\n      File \"parent.pyx\", line 358, in sage.structure.parent.Parent.__init__ (build/cythonized/sage/structure/parent.c:4247)\n      File \"parent.pyx\", line 418, in sage.structure.parent.Parent._init_category_ (build/cythonized/sage/structure/parent.c:4797)\n      File \"lazy_attribute.pyx\", line 127, in sage.misc.lazy_attribute._lazy_attribute.__get__ (build/cythonized/sage/misc/lazy_attribute.c:1353)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py\", line 1298, in parent_class\n        return self._make_named_class('parent_class', 'ParentMethods')\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py\", line 2568, in _make_named_class\n        cache=cache, **options)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py\", line 1221, in _make_named_class\n        reduction = reduction, cache = cache)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py\", line 316, in dynamic_class\n        return dynamic_class_internal.f(name, bases, cls, reduction, doccls, prepend_cls_bases)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py\", line 411, in dynamic_class_internal\n        return metaclass(name, bases, methods)\n    TypeError: Cannot create a consistent method resolution\n    order (MRO) for bases Algebras.parent_class, Monoids.WithRealizations.parent_class, Bialgebras.parent_class, Coalgebras.WithRealizations.parent_class\n**********************************************************************\nFile \"src/sage/combinat/sf/sfa.py\", line 758, in sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over\nFailed example:\n    mj.corresponding_basis_over(Integers(13))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over[9]>\", line 1, in <module>\n        mj.corresponding_basis_over(Integers(Integer(13)))\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sfa.py\", line 814, in corresponding_basis_over\n        return attrcall(self._basis)(SymmetricFunctions(R))\n      File \"classcall_metaclass.pyx\", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1282)\n      File \"cachefunc.pyx\", line 1077, in sage.misc.cachefunc.WeakCachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6486)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1021, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"classcall_metaclass.pyx\", line 518, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:1665)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sf.py\", line 763, in __init__\n        Parent.__init__(self, category = GradedHopfAlgebras(R).WithRealizations())\n      File \"parent.pyx\", line 358, in sage.structure.parent.Parent.__init__ (build/cythonized/sage/structure/parent.c:4247)\n      File \"parent.pyx\", line 418, in sage.structure.parent.Parent._init_category_ (build/cythonized/sage/structure/parent.c:4797)\n      File \"lazy_attribute.pyx\", line 127, in sage.misc.lazy_attribute._lazy_attribute.__get__ (build/cythonized/sage/misc/lazy_attribute.c:1353)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py\", line 1298, in parent_class\n        return self._make_named_class('parent_class', 'ParentMethods')\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py\", line 2568, in _make_named_class\n        cache=cache, **options)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py\", line 1221, in _make_named_class\n        reduction = reduction, cache = cache)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py\", line 316, in dynamic_class\n        return dynamic_class_internal.f(name, bases, cls, reduction, doccls, prepend_cls_bases)\n      File \"/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py\", line 411, in dynamic_class_internal\n        return metaclass(name, bases, methods)\n    TypeError: Cannot create a consistent method resolution\n    order (MRO) for bases Algebras.parent_class, Monoids.WithRealizations.parent_class, Bialgebras.parent_class, Coalgebras.WithRealizations.parent_class\n**********************************************************************\n1 item had failures:\n   2 of  43 in sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over\n    [881 tests, 2 failures, 19.17 s]\n----------------------------------------------------------------------\nsage -t src/sage/combinat/sf/sfa.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\n----\nNew commits:",
    "created_at": "2014-06-26T11:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195866",
    "user": "darij"
}
```

OUCH. I just realized that I forgot to reenable the symmetric functions doctest, and not unexpectedly it is still broken. OK, this thing must be unrelated to #10963 after all. Simon, can you make sense of this?


```
Doctesting 1 file.
sage -t src/sage/combinat/sf/sfa.py
**********************************************************************
File "src/sage/combinat/sf/sfa.py", line 752, in sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over
Failed example:
    s.corresponding_basis_over(Integers(13))
Exception raised:
    Traceback (most recent call last):
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over[5]>", line 1, in <module>
        s.corresponding_basis_over(Integers(Integer(13)))
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sfa.py", line 814, in corresponding_basis_over
        return attrcall(self._basis)(SymmetricFunctions(R))
      File "classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1282)
      File "cachefunc.pyx", line 1077, in sage.misc.cachefunc.WeakCachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6486)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1021, in __classcall__
        instance = typecall(cls, *args, **options)
      File "classcall_metaclass.pyx", line 518, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:1665)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sf.py", line 763, in __init__
        Parent.__init__(self, category = GradedHopfAlgebras(R).WithRealizations())
      File "parent.pyx", line 358, in sage.structure.parent.Parent.__init__ (build/cythonized/sage/structure/parent.c:4247)
      File "parent.pyx", line 418, in sage.structure.parent.Parent._init_category_ (build/cythonized/sage/structure/parent.c:4797)
      File "lazy_attribute.pyx", line 127, in sage.misc.lazy_attribute._lazy_attribute.__get__ (build/cythonized/sage/misc/lazy_attribute.c:1353)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py", line 1298, in parent_class
        return self._make_named_class('parent_class', 'ParentMethods')
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py", line 2568, in _make_named_class
        cache=cache, **options)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py", line 1221, in _make_named_class
        reduction = reduction, cache = cache)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 316, in dynamic_class
        return dynamic_class_internal.f(name, bases, cls, reduction, doccls, prepend_cls_bases)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 411, in dynamic_class_internal
        return metaclass(name, bases, methods)
    TypeError: Cannot create a consistent method resolution
    order (MRO) for bases Algebras.parent_class, Monoids.WithRealizations.parent_class, Bialgebras.parent_class, Coalgebras.WithRealizations.parent_class
**********************************************************************
File "src/sage/combinat/sf/sfa.py", line 758, in sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over
Failed example:
    mj.corresponding_basis_over(Integers(13))
Exception raised:
    Traceback (most recent call last):
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over[9]>", line 1, in <module>
        mj.corresponding_basis_over(Integers(Integer(13)))
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sfa.py", line 814, in corresponding_basis_over
        return attrcall(self._basis)(SymmetricFunctions(R))
      File "classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1282)
      File "cachefunc.pyx", line 1077, in sage.misc.cachefunc.WeakCachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6486)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1021, in __classcall__
        instance = typecall(cls, *args, **options)
      File "classcall_metaclass.pyx", line 518, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:1665)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/combinat/sf/sf.py", line 763, in __init__
        Parent.__init__(self, category = GradedHopfAlgebras(R).WithRealizations())
      File "parent.pyx", line 358, in sage.structure.parent.Parent.__init__ (build/cythonized/sage/structure/parent.c:4247)
      File "parent.pyx", line 418, in sage.structure.parent.Parent._init_category_ (build/cythonized/sage/structure/parent.c:4797)
      File "lazy_attribute.pyx", line 127, in sage.misc.lazy_attribute._lazy_attribute.__get__ (build/cythonized/sage/misc/lazy_attribute.c:1353)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py", line 1298, in parent_class
        return self._make_named_class('parent_class', 'ParentMethods')
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py", line 2568, in _make_named_class
        cache=cache, **options)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/categories/category.py", line 1221, in _make_named_class
        reduction = reduction, cache = cache)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 316, in dynamic_class
        return dynamic_class_internal.f(name, bases, cls, reduction, doccls, prepend_cls_bases)
      File "/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 411, in dynamic_class_internal
        return metaclass(name, bases, methods)
    TypeError: Cannot create a consistent method resolution
    order (MRO) for bases Algebras.parent_class, Monoids.WithRealizations.parent_class, Bialgebras.parent_class, Coalgebras.WithRealizations.parent_class
**********************************************************************
1 item had failures:
   2 of  43 in sage.combinat.sf.sfa.SymmetricFunctionsBases.ParentMethods.corresponding_basis_over
    [881 tests, 2 failures, 19.17 s]
----------------------------------------------------------------------
sage -t src/sage/combinat/sf/sfa.py  # 2 doctests failed
----------------------------------------------------------------------
```

----
New commits:



---

archive/issue_comments_195867.json:
```json
{
    "body": "Replying to [comment:32 darij]:\n> OUCH. I just realized that I forgot to reenable the symmetric functions doctest, and not unexpectedly it is still broken. OK, this thing must be unrelated to #10963 after all. Simon, can you make sense of this?\n> \n> {{{\n>     TypeError: Cannot create a consistent method resolution\n>     order (MRO) for bases Algebras.parent_class, Monoids.WithRealizations.parent_class, Bialgebras.parent_class, Coalgebras.WithRealizations.parent_class\n> }}}\n\nDoes that mean that the controlled C3 algorithm is not bullet proof, resp. that the global ordering imposed on the categories is not as it should be? Nicolas?",
    "created_at": "2014-06-26T13:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195867",
    "user": "SimonKing"
}
```

Replying to [comment:32 darij]:
> OUCH. I just realized that I forgot to reenable the symmetric functions doctest, and not unexpectedly it is still broken. OK, this thing must be unrelated to #10963 after all. Simon, can you make sense of this?
> 
> {{{
>     TypeError: Cannot create a consistent method resolution
>     order (MRO) for bases Algebras.parent_class, Monoids.WithRealizations.parent_class, Bialgebras.parent_class, Coalgebras.WithRealizations.parent_class
> }}}

Does that mean that the controlled C3 algorithm is not bullet proof, resp. that the global ordering imposed on the categories is not as it should be? Nicolas?



---

archive/issue_comments_195868.json:
```json
{
    "body": "I'm pretty sure it's related to the category refinement that occurs for `Zmod(13)`:\n\n```\nsage: SymmetricFunctions(Zmod(14))\nSymmetric Functions over Ring of integers modulo 14\nsage: SymmetricFunctions(Zmod(12)) # This isn't needed to reproduce the error\nSymmetric Functions over Ring of integers modulo 12\nsage: SymmetricFunctions(Zmod(13))\n   # Boom\nsage: Rp = Zmod(13)\nsage: Rp.category()\nJoin of Category of finite commutative rings and Category of subquotients of monoids and Category of quotients of semigroups\nsage: Rp in Fields()\nTrue\nsage: Rp.category()\nJoin of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups\nsage: SymmetricFunctions(Rp)\nSymmetric Functions over Ring of integers modulo 13\n```\n\n(You can remove the `Rp.category()` and it will still work.) Compare this with\n\n```\nsage: SymmetricFunctions(Zmod(12))\nSymmetric Functions over Ring of integers modulo 12\nsage: SymmetricFunctions(GF(13))\nSymmetric Functions over Finite Field of size 13\n```\n\n\nHowever, in a fresh Sage:\n\n```\nsage: Rp = Zmod(13)\nsage: SymmetricFunctions(Rp)\nSymmetric Functions over Ring of integers modulo 13\nsage: Rp.category()\nJoin of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups\n```\n\n\nThis might be useful info (also in a fresh Sage):\n\n```\nsage: GradedHopfAlgebras(Zmod(14))\nJoin of Category of hopf algebras over Ring of integers modulo 14 and Category of graded algebras over Ring of integers modulo 14\nsage: Rp = Zmod(13)\nsage: GradedHopfAlgebras(Rp)\n/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/category.py:858: UserWarning: Inconsistent sorting results for all super categories of <class 'sage.categories.category.JoinCategory'>\n  self.__class__))\n/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/category.py:858: UserWarning: Inconsistent sorting results for all super categories of <class 'sage.categories.hopf_algebras.HopfAlgebras_with_category'>\n  self.__class__))\nJoin of Category of hopf algebras over Ring of integers modulo 13 and Category of graded algebras over Ring of integers modulo 13\nsage: Rp.category()\nJoin of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups\n```\n",
    "created_at": "2014-06-26T14:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195868",
    "user": "tscrim"
}
```

I'm pretty sure it's related to the category refinement that occurs for `Zmod(13)`:

```
sage: SymmetricFunctions(Zmod(14))
Symmetric Functions over Ring of integers modulo 14
sage: SymmetricFunctions(Zmod(12)) # This isn't needed to reproduce the error
Symmetric Functions over Ring of integers modulo 12
sage: SymmetricFunctions(Zmod(13))
   # Boom
sage: Rp = Zmod(13)
sage: Rp.category()
Join of Category of finite commutative rings and Category of subquotients of monoids and Category of quotients of semigroups
sage: Rp in Fields()
True
sage: Rp.category()
Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups
sage: SymmetricFunctions(Rp)
Symmetric Functions over Ring of integers modulo 13
```

(You can remove the `Rp.category()` and it will still work.) Compare this with

```
sage: SymmetricFunctions(Zmod(12))
Symmetric Functions over Ring of integers modulo 12
sage: SymmetricFunctions(GF(13))
Symmetric Functions over Finite Field of size 13
```


However, in a fresh Sage:

```
sage: Rp = Zmod(13)
sage: SymmetricFunctions(Rp)
Symmetric Functions over Ring of integers modulo 13
sage: Rp.category()
Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups
```


This might be useful info (also in a fresh Sage):

```
sage: GradedHopfAlgebras(Zmod(14))
Join of Category of hopf algebras over Ring of integers modulo 14 and Category of graded algebras over Ring of integers modulo 14
sage: Rp = Zmod(13)
sage: GradedHopfAlgebras(Rp)
/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/category.py:858: UserWarning: Inconsistent sorting results for all super categories of <class 'sage.categories.category.JoinCategory'>
  self.__class__))
/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/category.py:858: UserWarning: Inconsistent sorting results for all super categories of <class 'sage.categories.hopf_algebras.HopfAlgebras_with_category'>
  self.__class__))
Join of Category of hopf algebras over Ring of integers modulo 13 and Category of graded algebras over Ring of integers modulo 13
sage: Rp.category()
Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups
```




---

archive/issue_comments_195869.json:
```json
{
    "body": "On u/nthiery/15475-sym_in_categories_over_base_ring is a tentative workaround the MRO crash by making sym's category more independent of the base ring. Almost all tests pass in sage.combinat.sf, except for trivialities and a test involving QSym (which should probably get the same treatment).",
    "created_at": "2014-07-02T16:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195869",
    "user": "nthiery"
}
```

On u/nthiery/15475-sym_in_categories_over_base_ring is a tentative workaround the MRO crash by making sym's category more independent of the base ring. Almost all tests pass in sage.combinat.sf, except for trivialities and a test involving QSym (which should probably get the same treatment).



---

archive/issue_comments_195870.json:
```json
{
    "body": "Darij, would you be okay separating the current fixes of the descent and symmetric group algebras off as another ticket so we can get that in (everything up to \u200bff4e546)?",
    "created_at": "2014-07-18T01:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195870",
    "user": "tscrim"
}
```

Darij, would you be okay separating the current fixes of the descent and symmetric group algebras off as another ticket so we can get that in (everything up to ​ff4e546)?



---

archive/issue_comments_195871.json:
```json
{
    "body": "Definitely. Are you also planning to fix the bugs recently posted on sage-devel?",
    "created_at": "2014-07-18T11:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195871",
    "user": "darij"
}
```

Definitely. Are you also planning to fix the bugs recently posted on sage-devel?



---

archive/issue_comments_195872.json:
```json
{
    "body": "Replying to [comment:37 darij]:\n> Definitely. Are you also planning to fix the bugs recently posted on sage-devel?\n\nYes; I did so on #16678.",
    "created_at": "2014-07-18T18:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195872",
    "user": "tscrim"
}
```

Replying to [comment:37 darij]:
> Definitely. Are you also planning to fix the bugs recently posted on sage-devel?

Yes; I did so on #16678.



---

archive/issue_comments_195873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-18T18:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195873",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195874.json:
```json
{
    "body": "Currently, the branch `public/categories/15475` doesn't contain any changes compared with `origin/develop`.",
    "created_at": "2014-08-28T15:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195874",
    "user": "aapitzsch"
}
```

Currently, the branch `public/categories/15475` doesn't contain any changes compared with `origin/develop`.



---

archive/issue_comments_195875.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-08-28T15:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195875",
    "user": "aapitzsch"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_195876.json:
```json
{
    "body": "Replying to [comment:41 aapitzsch]:\n> Currently, the branch `public/categories/15475` doesn't contain any changes compared with `origin/develop`.\n\nYes it does, it removes the `# not tested`. However we do still need to make this handle the category refinement.",
    "created_at": "2014-08-28T23:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195876",
    "user": "tscrim"
}
```

Replying to [comment:41 aapitzsch]:
> Currently, the branch `public/categories/15475` doesn't contain any changes compared with `origin/develop`.

Yes it does, it removes the `# not tested`. However we do still need to make this handle the category refinement.



---

archive/issue_comments_195877.json:
```json
{
    "body": "Another path-dependent MRO fail related to Hopf algebras over Zmod(n) observed in #11979. This shows that we should fix the category framework or our C3, or whatever else is at fault, rather than try to change Sym into a different category. (Are we actually using our controlled C3 here, or Python's old C3?)",
    "created_at": "2014-11-06T20:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195877",
    "user": "darij"
}
```

Another path-dependent MRO fail related to Hopf algebras over Zmod(n) observed in #11979. This shows that we should fix the category framework or our C3, or whatever else is at fault, rather than try to change Sym into a different category. (Are we actually using our controlled C3 here, or Python's old C3?)



---

archive/issue_comments_195878.json:
```json
{
    "body": "We might be able to get a good workaround by finishing #15229.",
    "created_at": "2014-11-06T21:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195878",
    "user": "tscrim"
}
```

We might be able to get a good workaround by finishing #15229.



---

archive/issue_comments_195879.json:
```json
{
    "body": "That's good news! #15229 might actually be a fix for the root cause, not a workaround:\n\n\n```\nsage: SymmetricFunctions(Zmod(14))\nSymmetric Functions over Ring of integers modulo 14\nsage: Zmod(13) in Fields() # if not for this \"check\", then the following would break\nTrue\nsage: SymmetricFunctions(Zmod(13))\nSymmetric Functions over Ring of integers modulo 13\n```\n\n\nand, for #11979:\n\n\n```\nsage: from sage.algebras.divided_power_algebra import UnivariateDividedPowerAlgebra\nsage: A = UnivariateDividedPowerAlgebra(Zmod(9)); A\nThe divided power algebra over Ring of integers modulo 9\nsage: Zmod(5) in Fields() # if not for this \"check\", then the following would break\nTrue\nsage: A = UnivariateDividedPowerAlgebra(Zmod(5)); A\nThe divided power algebra over Ring of integers modulo 5\n```\n\n\nSo my guess would be that category refinement doesn't like it when a category changes in the midst of it, and the category of Zmod(n) does change when Zmod(n) is tested for fieldness:\n\n\n```\nsage: Zmod(17).category()\nJoin of Category of finite commutative rings and Category of subquotients of monoids and Category of quotients of semigroups\nsage: Zmod(17) in Fields()\nTrue\nsage: Zmod(17).category()\nJoin of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups\n```\n\n\nWith #15229 fixing this, I think we can hope to see the end of this issue.\n\nIs this pattern, where an object lazily starts off with a broad category and then refines in when the user checks for properties, common in Sage? Should we get rid of that or tweak the code to allow it? If we are to allow it, we would probably need to establish a hierarchy of categories or classes such that refining a category of some object can only trigger refinements of categories of lower-class objects in its process, and said refinements should be made sure not to interfere or run races with each other?\n\nEDIT: I also wanted to add that this whole tradeoff between \"allow several instances of ZZ/nZZ with different properties, and try to somehow ensure that they behave like they are equal, e.g., providing automatic coercion between their polynomial rings\" and \"force all instances of ZZ/nZZ to be identical, at the cost of having to update and mutate this single instance long after it is created, and try to somehow ensure that these mutations do not break consistency\" reminds me a lot of the constructivity problem of Voevodsky's univalent foundations. Looks like equality is the trickiest thing to formalize...",
    "created_at": "2014-11-06T21:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195879",
    "user": "darij"
}
```

That's good news! #15229 might actually be a fix for the root cause, not a workaround:


```
sage: SymmetricFunctions(Zmod(14))
Symmetric Functions over Ring of integers modulo 14
sage: Zmod(13) in Fields() # if not for this "check", then the following would break
True
sage: SymmetricFunctions(Zmod(13))
Symmetric Functions over Ring of integers modulo 13
```


and, for #11979:


```
sage: from sage.algebras.divided_power_algebra import UnivariateDividedPowerAlgebra
sage: A = UnivariateDividedPowerAlgebra(Zmod(9)); A
The divided power algebra over Ring of integers modulo 9
sage: Zmod(5) in Fields() # if not for this "check", then the following would break
True
sage: A = UnivariateDividedPowerAlgebra(Zmod(5)); A
The divided power algebra over Ring of integers modulo 5
```


So my guess would be that category refinement doesn't like it when a category changes in the midst of it, and the category of Zmod(n) does change when Zmod(n) is tested for fieldness:


```
sage: Zmod(17).category()
Join of Category of finite commutative rings and Category of subquotients of monoids and Category of quotients of semigroups
sage: Zmod(17) in Fields()
True
sage: Zmod(17).category()
Join of Category of finite fields and Category of subquotients of monoids and Category of quotients of semigroups
```


With #15229 fixing this, I think we can hope to see the end of this issue.

Is this pattern, where an object lazily starts off with a broad category and then refines in when the user checks for properties, common in Sage? Should we get rid of that or tweak the code to allow it? If we are to allow it, we would probably need to establish a hierarchy of categories or classes such that refining a category of some object can only trigger refinements of categories of lower-class objects in its process, and said refinements should be made sure not to interfere or run races with each other?

EDIT: I also wanted to add that this whole tradeoff between "allow several instances of ZZ/nZZ with different properties, and try to somehow ensure that they behave like they are equal, e.g., providing automatic coercion between their polynomial rings" and "force all instances of ZZ/nZZ to be identical, at the cost of having to update and mutate this single instance long after it is created, and try to somehow ensure that these mutations do not break consistency" reminds me a lot of the constructivity problem of Voevodsky's univalent foundations. Looks like equality is the trickiest thing to formalize...



---

archive/issue_comments_195880.json:
```json
{
    "body": "This is great to hear. I've rebased #15229, so hopefully that will get in soon so we can (finally) close this.",
    "created_at": "2014-11-07T06:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195880",
    "user": "tscrim"
}
```

This is great to hear. I've rebased #15229, so hopefully that will get in soon so we can (finally) close this.



---

archive/issue_comments_195881.json:
```json
{
    "body": "OK, this actually didn't help. :/ What I meant by #15229 fixing this is that the source of this bug was discussed in the #15229 thread. But it wasn't solved there, because with #15229 I still have:\n\n```\nsage: len(Zmod(5).categories())\n42\nsage: Zmod(5).is_field()\nTrue\nsage: len(Zmod(5).categories())\n51\n```\n\nEither this lazy discovery of categories has to be removed, or the category refinement and MRO routines must be hardened against it.",
    "created_at": "2014-11-07T15:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15238#issuecomment-195881",
    "user": "darij"
}
```

OK, this actually didn't help. :/ What I meant by #15229 fixing this is that the source of this bug was discussed in the #15229 thread. But it wasn't solved there, because with #15229 I still have:

```
sage: len(Zmod(5).categories())
42
sage: Zmod(5).is_field()
True
sage: len(Zmod(5).categories())
51
```

Either this lazy discovery of categories has to be removed, or the category refinement and MRO routines must be hardened against it.
