# Issue 31431: Run TestSuite on polynomial rings

Issue created by migration from https://trac.sagemath.org/ticket/31668

Original creator: mkoeppe

Original creation time: 2021-04-13 18:17:04

CC:  tscrim vdelecroix dkrenn @mwageringel mmezzarobba yzh novoselt nbruin

#27364 fixes a bug that `_test_construction` should have found -- except `TestSuite` is not called at all for any multivariate polynomial rings. 

We add a bunch of `TestSuite` calls for the rings constructed as examples in `polynomial_ring_constructor`.


---

Comment by mkoeppe created at 2021-04-13 18:34:23


```
sage -t --random-seed=0 src/sage/rings/polynomial/polynomial_ring_constructor.py  # 12 doctests failed
```

----
New commits:


---

Comment by vdelecroix created at 2021-05-19 07:02:53

One more test to add here (from #27261): check that multipolynomial substitution works consistently and return objects in the right parent

```
def test(base_ring):
    R = base_ring['x, y']
    S = base_ring['q, r']
    x, y = R.gens()
    q, r = S.gens()
    polys = [R.zero(), R.one(), x, y, x + y]
    assert all(p.subs(x=0).parent() is R for p in polys)
    assert all(p.subs(y=0).parent() is R for p in polys)
    assert all(p.subs(x=0, y=0).parent() is base_ring for p in polys)
    assert all(p.subs(x=q, y=r).parent() is S for p in polys)
```



---

Comment by git created at 2021-05-24 00:33:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-05-24 00:48:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-24 00:51:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by novoselt created at 2021-05-24 01:58:09

Replying to [comment:6 vdelecroix]:
> One more test to add here (from #27261): check that multipolynomial substitution works consistently and return objects in the right parent
> {{{
> def test(base_ring):
>     R = base_ring['x, y']
>     S = base_ring['q, r']
>     x, y = R.gens()
>     q, r = S.gens()
>     polys = [R.zero(), R.one(), x, y, x + y]
>     assert all(p.subs(x=0).parent() is R for p in polys)
>     assert all(p.subs(y=0).parent() is R for p in polys)
>     assert all(p.subs(x=0, y=0).parent() is base_ring for p in polys)
>     assert all(p.subs(x=q, y=r).parent() is S for p in polys)
> }}}

I disagree with this logic - why the parent of the result depends on values used for substitution? If one always wants "the minimal parent", then after plugging in `x=0` one can end up in `base_ring[y]`. When the variables and their substitution values are computed in some fashion and then substituted into a bunch of different polynomials it is inconvenient that the result may have different type and so one has to consider multiple cases. I hit it because toric code breaks on certain examples because of this issue.


---

Comment by git created at 2021-05-24 02:04:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-24 02:09:20

Changing priority from minor to major.


---

Comment by mkoeppe created at 2021-05-24 02:25:30

Replying to [comment:12 novoselt]:
> Replying to [comment:6 vdelecroix]:
> > {{{
> > def test(base_ring):
> >     R = base_ring['x, y']
> >     S = base_ring['q, r']
> >     x, y = R.gens()
> >     q, r = S.gens()
> >     polys = [R.zero(), R.one(), x, y, x + y]
> >     assert all(p.subs(x=0).parent() is R for p in polys)
> >     assert all(p.subs(y=0).parent() is R for p in polys)
> >     assert all(p.subs(x=0, y=0).parent() is base_ring for p in polys)
> >     assert all(p.subs(x=q, y=r).parent() is S for p in polys)
> > }}}
> 
> I disagree with this logic - why the parent of the result depends on values used for substitution? 

Just a quick comment -- the above only demonstrates that the parent of the result depends on the parents of the substituted values (not the values themselves), and which subset is substituted.


---

Comment by vdelecroix created at 2021-05-24 06:20:18

Replying to [comment:15 mkoeppe]:
> Replying to [comment:12 novoselt]:
> > Replying to [comment:6 vdelecroix]:
> > > {{{
> > > def test(base_ring):
> > >     R = base_ring['x, y']
> > >     S = base_ring['q, r']
> > >     x, y = R.gens()
> > >     q, r = S.gens()
> > >     polys = [R.zero(), R.one(), x, y, x + y]
> > >     assert all(p.subs(x=0).parent() is R for p in polys)
> > >     assert all(p.subs(y=0).parent() is R for p in polys)
> > >     assert all(p.subs(x=0, y=0).parent() is base_ring for p in polys)
> > >     assert all(p.subs(x=q, y=r).parent() is S for p in polys)
> > > }}}
> > 
> > I disagree with this logic - why the parent of the result depends on values used for substitution? 
> 
> Just a quick comment -- the above only demonstrates that the parent of the result depends on the parents of the substituted values (not the values themselves), and which subset is substituted.

And more precisely, the rule for substitution is:
- if the substitution is "partial" then the omitted variables are set to themselves
- for a full substitution, the result of the parent is set to be the common_parent of the base_ring of the polynomial ring and the parents of values to be substituted


---

Comment by vdelecroix created at 2021-05-24 06:45:10

Note that the parents of substituted polynomials should be fixed in #27261. We can either set it as a dependency of this ticket or I can split this part from #27261 into an independent ticket.


---

Comment by git created at 2021-05-24 06:46:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-24 06:49:27

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-05-24 06:50:26

Replying to [comment:17 vdelecroix]:
> Note that the parents of substituted polynomials should be fixed in #27261. We can either set it as a dependency of this ticket or I can split this part from #27261 into an independent ticket.

I have prepared the present ticket for inclusion by disabling the failing tests.

Ready for review


---

Comment by vdelecroix created at 2021-05-24 07:04:23

Why something that specific is needed in `rings/polynomial/polynomial_ring.py`?

```
def construction(self):
    ...
    implementation = None
    if 'NTL' in self._implementation_repr:
        implementation = 'NTL'
    ...
```


On multi-variate polynomials with a single variable this test should fail

```
            # substituting one variable (in a polynomial ring with variables) with 0
            d = {str(gens[0]): 0}
            tester.assertEqual(self.subs(**d).parent(), self.parent())
```



---

Comment by mkoeppe created at 2021-05-24 07:06:46

Replying to [comment:21 vdelecroix]:
> Why something that specific is needed in `rings/polynomial/polynomial_ring.py`?
> {{{
> def construction(self):
>     ...
>     implementation = None
>     if 'NTL' in self._implementation_repr:
>         implementation = 'NTL'
>     ...
> }}}

This is obviously not a complete solution. The parents don't keep track in a clean way what the implementation is. I have some other experimental code that tries to decode the element class, but it's all not very satisfying.


---

Comment by vdelecroix created at 2021-05-24 07:10:31

Replying to [comment:23 mkoeppe]:
> Replying to [comment:21 vdelecroix]:
> > Why something that specific is needed in `rings/polynomial/polynomial_ring.py`?
> > {{{
> > def construction(self):
> >     ...
> >     implementation = None
> >     if 'NTL' in self._implementation_repr:
> >         implementation = 'NTL'
> >     ...
> > }}}
> 
> This is obviously not a complete solution. The parents don't keep track in a clean way what the implementation is. I have some other experimental code that tries to decode the element class, but it's all not very satisfying.

Certainly not optimal, but something similar is implemented for `MatrixSpace` (from `matrix/matrix_class.py`) via `_has_default_implementation`.


---

Comment by git created at 2021-05-24 07:12:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-24 07:15:03

Replying to [comment:24 vdelecroix]:
> Certainly not optimal, but something similar is implemented for `MatrixSpace` (from `matrix/matrix_class.py`) via `_has_default_implementation`.

Thanks for the pointer. 

Perhaps something for a follow-up ticket?


---

Comment by vdelecroix created at 2021-05-24 07:30:41

Replying to [comment:26 mkoeppe]:
> Replying to [comment:24 vdelecroix]:
> > Certainly not optimal, but something similar is implemented for `MatrixSpace` (from `matrix/matrix_class.py`) via `_has_default_implementation`.
> 
> Thanks for the pointer. 
> 
> Perhaps something for a follow-up ticket?

Definitely: this is #31852. I was not convinced by the solution I used for `MatrixClass`. I secretly hoped that you had some alternative.


---

Comment by vdelecroix created at 2021-05-24 07:33:43

Also, the test suite does not catch invalid substitution such as

```
sage: QQ['x,y'].gen(0).subs(x=QQ['t'].gen())  # not intended to work
t
```



---

Comment by novoselt created at 2021-05-24 14:55:50

Replying to [comment:16 vdelecroix]:
> Replying to [comment:15 mkoeppe]:
> > Replying to [comment:12 novoselt]:
> > > I disagree with this logic - why the parent of the result depends on values used for substitution? 
> > 
> > Just a quick comment -- the above only demonstrates that the parent of the result depends on the parents of the substituted values (not the values themselves), and which subset is substituted.
> 
> And more precisely, the rule for substitution is:
> - if the substitution is "partial" then the omitted variables are set to themselves
> - for a full substitution, the result of the parent is set to be the common_parent of the base_ring of the polynomial ring and the parents of values to be substituted

What is "partial"? How about this one:

```
sage: R.<x, y> = QQ[]
sage: parent(x.subs(x=1))
Multivariate Polynomial Ring in x, y over Rational Field
sage: R.<x, y> = QQ["a, b"][]
sage: parent(x.subs(x=1))
Multivariate Polynomial Ring in a, b over Rational Field
```

I also think that it makes sense to have the same results here

```
sage; R.<x, y> = QQ["a, b"][]
sage: p = x + y
sage: parent(p.subs(x=1, y=2))
Multivariate Polynomial Ring in a, b over Rational Field
sage: parent(p.subs(x=1).subs(y=2))
Multivariate Polynomial Ring in x, y over Multivariate Polynomial Ring in a, b over Rational Field
```



---

Comment by vdelecroix created at 2021-05-24 17:40:45

Replying to [comment:29 novoselt]:
> Replying to [comment:16 vdelecroix]:
> > Replying to [comment:15 mkoeppe]:
> > > Replying to [comment:12 novoselt]:
> > > > I disagree with this logic - why the parent of the result depends on values used for substitution? 
> > > 
> > > Just a quick comment -- the above only demonstrates that the parent of the result depends on the parents of the substituted values (not the values themselves), and which subset is substituted.
> > 
> > And more precisely, the rule for substitution is:
> > - if the substitution is "partial" then the omitted variables are set to themselves
> > - for a full substitution, the result of the parent is set to be the common_parent of the base_ring of the polynomial ring and the parents of values to be substituted
> 
> What is "partial"?

Partial is when you do not substitute all variables. On `QQ[x,y]` if you only specify the value of `x`, let say `x=1` then `y` is set to `y`. In other words `p.subs(x=1)` is equivalent to `p(1, y)`. All the examples you wrote are perfectly valid and will be supported in the same way. The only example that is wrong and I want to disable is in [comment:28 comment:28].


---

Comment by git created at 2021-05-24 18:17:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-24 18:36:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-24 18:38:22

The example from comment 28 is now tested


---

Comment by vdelecroix created at 2021-05-24 21:29:02

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2021-05-24 21:29:02

As expected, `QQ[x,y]` now fails its test suite. Great.

```
sage -t --long --random-seed=0 src/sage/rings/ring.pyx  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/rings/polynomial/polynomial_ring_constructor.py  # 4 doctests failed
```



---

Comment by git created at 2021-05-24 22:37:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-24 22:38:02

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2021-05-28 07:37:16

Replying to [comment:23 mkoeppe]:
> Replying to [comment:21 vdelecroix]:
> > Why something that specific is needed in `rings/polynomial/polynomial_ring.py`?
> > {{{
> > def construction(self):
> >     ...
> >     implementation = None
> >     if 'NTL' in self._implementation_repr:
> >         implementation = 'NTL'
> >     ...
> > }}}
> 
> This is obviously not a complete solution. The parents don't keep track in a clean way what the implementation is. I have some other experimental code that tries to decode the element class, but it's all not very satisfying.

Could you at least add a `# NOTE:` to this code and possibly add a pointer to the ticket #31852.


---

Comment by git created at 2021-05-29 02:24:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-05-30 08:07:19

Tiny doctest issue in the tests you introduced

```
sage -t --long --random-seed=0 src/sage/rings/polynomial/polynomial_ring.py
**********************************************************************
File "src/sage/rings/polynomial/polynomial_ring.py", line 1964, in sage.rings.polynomial.polynomial_ring.PolynomialRing_commutative.construction
Failed example:
    R = PRing(ZZ, 'x'); R
Expected nothing
Got:
    Univariate Polynomial Ring in x over Integer Ring
**********************************************************************
File "src/sage/rings/polynomial/polynomial_ring.py", line 1970, in sage.rings.polynomial.polynomial_ring.PolynomialRing_commutative.construction
Failed example:
    R = PRing(ZZ, 'x', implementation='NTL'); R
Expected nothing
Got:
    Univariate Polynomial Ring in x over Integer Ring (using NTL)
**********************************************************************
```



---

Comment by vdelecroix created at 2021-05-30 08:07:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-30 08:13:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-30 08:13:45

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-06 21:12:20

Can we get this in please? The patchbot failures are unrelated


---

Comment by vdelecroix created at 2021-06-06 21:24:28

Sure. I did not receive any notification e-mail for your comments 43 and 44 in the ticket.


---

Comment by vdelecroix created at 2021-06-06 21:24:28

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-06 21:25:26

Thanks!


---

Comment by tscrim created at 2021-06-06 22:34:47

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2021-06-06 22:34:47

I don't really like having those `TestSuite` calls in the main part of the documentation for the likely very heavily used and read `PolynomialRing`. It adds a lot of clutter and will be confusing for any non-developer. These should all occur in after the `TESTS:` line, and I feel they are best grouped together so it is easier to tell if we have full coverage rather than spread across the file.


---

Comment by mkoeppe created at 2021-06-06 22:41:50

Sorry, I will not work on changing this
