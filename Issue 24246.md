# Issue 24246: complex_field.py complex_number.pyx -> complex_mpfr.pyx

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2018-01-07 13:25:10

CC:  @mjungmath chapoton

In order to uniformize, simplify and in view of #24456 (see also #17713) we merge the two files `complex_field.py`, `complex_number.pyx` into a unique `complex_mpfr.pyx`.

As pynac used explicitely these modules, we had to provide a tiny patch.


---

Comment by vdelecroix created at 2018-01-07 15:43:07

Let us see about doctests
----
New commits:


---

Comment by vdelecroix created at 2018-01-07 15:43:07

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-01-07 17:31:20

patchbot not happy if Author is not given...


---

Comment by git created at 2018-01-07 18:59:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-01-08 08:40:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-08 11:00:38

Can we just do the renaming _without_ deprecation for now? That way, we wouldn't need the fix the Pynac. If possible, I would like to avoid Sage-specific patches to upstream projects.


---

Comment by vdelecroix created at 2018-01-08 11:03:44

Replying to [comment:9 jdemeyer]:
> Can we just do the renaming _without_ deprecation for now? That way, we wouldn't need the fix the Pynac. If possible, I would like to avoid Sage-specific patches to upstream projects.

The whole point is precisely to start a deprecation... though for ease of review I can move the deprecation in another ticket. Would that be better?


---

Comment by git created at 2018-01-08 14:56:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-01-08 14:56:42

All right. The import of `ComplexField` from `sage.rings.complex_field` is not deprecated anymore...


---

Comment by vdelecroix created at 2018-01-09 09:46:32

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-01-09 09:46:32

Great! Thanks Ralf. I will put back the deprecation.


---

Comment by git created at 2018-01-09 09:58:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-01-09 09:59:21

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-01-11 17:14:08

a lot of doctest failures...


---

Comment by vdelecroix created at 2018-01-11 17:14:08

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-01-11 19:22:00

Actually these are failing because the patchbot is not merging #24497 first!


---

Comment by vdelecroix created at 2018-01-11 19:22:00

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-01-15 16:09:17

Changing status from needs_review to needs_work.


---

Comment by rws created at 2018-02-23 16:25:38

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-02-23 16:25:38

New commits:


---

Comment by vdelecroix created at 2018-02-26 10:45:13

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-02-26 10:45:13

Got one doctest failure

```
sage -t src/sage/misc/citation.pyx
**********************************************************************
File "src/sage/misc/citation.pyx", line 87, in sage.misc.citation.get_systems
Failed example:
    get_systems('((a+1)^2).expand()')
Expected:
    ['MPFR', 'ginac']
Got:
    ['ginac']
**********************************************************************
1 item had failures:
   1 of  11 in sage.misc.citation.get_systems
    [13 tests, 1 failure, 1.75 s]
```



---

Comment by vdelecroix created at 2020-10-09 07:37:53

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-10-09 07:37:53

New commits:


---

Comment by git created at 2020-10-09 13:34:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-09 13:42:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-09 13:51:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-09 13:58:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-10-10 07:30:55

`@`gh-mjungmath: patchbot gave its green light! Could you do the review?


---

Comment by @mjungmath created at 2020-10-10 23:01:58

I can try. I just noticed minor things.

This one could use another line break:


```diff
        return Factorization([(R(gg).monic(), e) for gg, e in zip(*F)],
                             f.leading_coefficient())
+
cdef class ComplexNumber(sage.structure.element.FieldElement):
    """
    A floating point approximation to a complex number using any
```


Due to the new global import of `Integer`, you can also remove the following now unnecessary imports:


```diff
            sage: ComplexField().characteristic()
            0
        """
-        from .integer import Integer
        return Integer(0)
...
            0.309016994374947 + 0.951056516295154*I
        """
-        from .integer import Integer
        n = Integer(n)
        if n == 1:
```


Maybe there are more of those imports, but that's what I swiftly located.

As far as I can see it, some global variables are collected in the beginning of the file while others are placed right before the corresponding class/method. I think, some sort of unification with good commenting can be beneficial for readability. But maybe that's too pedantic right now and should be part of another ticket if necessary.


---

Comment by mkoeppe created at 2020-10-11 01:24:30

Replying to [ticket:24483 vdelecroix]:
> Pynac used to explicitely depend on these modules but will use the more standard place `sage.rings.all` in the future (see #24497).

This comment in the ticket description perhaps needs clarification. I don't think we should be moving in the direction of encouraging imports from `*.all` modules.


---

Comment by git created at 2020-10-11 07:24:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-10-11 07:26:02

Replying to [comment:36 gh-mjungmath]:
> I can try. I just noticed minor things.
>
> [...]
>

Thank you. I moved around the `late_import`. The remaining `cache` global variable is used in the function just after. It makes sense to keep it there as it is not used anywhere else in the code.


---

Comment by @mjungmath created at 2020-10-11 09:23:48

The global variable `LOG_TEN_TWO_PLUS_EPSILON` can also be shifted to `create_ComplexNumber` since this is the only place where it is used.

Besides, this constant is already defined in `sage.arith.constants`, but with a slightly different value it seems. However, this value is imported in `sage.rings.complex_interval` and `sage.rings.real_mpfi`, i.e. everywhere else, but for the very same purpose. If it doesn't affect the code too much, one can import this value from there as well for the sake of unification.


---

Comment by git created at 2020-10-11 09:35:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-10-11 09:36:25

Replying to [comment:41 gh-mjungmath]:
> The global variable `LOG_TEN_TWO_PLUS_EPSILON` can also be shifted to `create_ComplexNumber` since this is the only place where it is used.
> 
> Besides, this constant is already defined in `sage.arith.constants`, but with a slightly different value it seems. However, this value is imported in `sage.rings.complex_interval` and `sage.rings.real_mpfi`, i.e. everywhere else, but for the very same purpose. If it doesn't affect the code too much, one can import this value from there as well for the sake of unification.

True. Fixed in the last commit.


---

Comment by @mjungmath created at 2020-10-11 09:43:19

I think, this would be it from my side. When patchbot turns green, I can give a positive review.


---

Comment by @mjungmath created at 2020-10-11 10:54:55

Replying to [comment:26 vdelecroix]:
> Got one doctest failure
> {{{
> sage -t src/sage/misc/citation.pyx
> **********************************************************************
> File "src/sage/misc/citation.pyx", line 87, in sage.misc.citation.get_systems
> Failed example:
>     get_systems('((a+1)^2).expand()')
> Expected:
>     ['MPFR', 'ginac']
> Got:
>     ['ginac']
> **********************************************************************
> 1 item had failures:
>    1 of  11 in sage.misc.citation.get_systems
>     [13 tests, 1 failure, 1.75 s]
> }}}

Is it worth to investigate why this (former) "spurious" output is gone now?


---

Comment by vdelecroix created at 2020-10-11 10:58:28

This was a pretty bad doctest. It is removed in my commits

```diff
diff --git a/src/sage/misc/citation.pyx b/src/sage/misc/citation.pyx
index 2de53c1..847f357 100644
--- a/src/sage/misc/citation.pyx
+++ b/src/sage/misc/citation.pyx
`@``@` -40,7 +40,7 `@``@` systems['NTL'] = ['sage.libs.ntl',
 systems['FLINT'] = ['_flint']
 systems['GMP'] = ['sage.rings.integer.Integer']
 systems['MPFR'] = ['sage.rings.real_mpfr',
-                   'sage.rings.complex_number']
+                   'sage.rings.complex_mpfr']
 systems['MPFI'] = ['sage.rings.real_mpfi',
                    'sage.rings.complex_interval']
 systems['M4RI'] = ['sage.matrix.matrix_mod2_dense']
`@``@` -80,15 +80,6 `@``@` def get_systems(cmd):
         sage: I = R.ideal(x^2+y^2, z^2+y)
         sage: get_systems('I.primary_decomposition()')
         ['Singular']
-
-    Here we get a spurious ``MPFR`` because some coercions need to be
-    initialized. The second time it is gone::
-
-        sage: a = var('a')
-        sage: get_systems('((a+1)^2).expand()')
-        ['MPFR', 'ginac']
-        sage: get_systems('((a+1)^2).expand()')
-        ['ginac']
     """
     import cProfile, pstats, re
```



---

Comment by @mjungmath created at 2020-10-11 11:24:40

Replying to [comment:46 vdelecroix]:
> This was a pretty bad doctest. It is removed in my commits
> {{{
> #!diff
> diff --git a/src/sage/misc/citation.pyx b/src/sage/misc/citation.pyx
> index 2de53c1..847f357 100644
> --- a/src/sage/misc/citation.pyx
> +++ b/src/sage/misc/citation.pyx
> `@``@` -40,7 +40,7 `@``@` systems['NTL'] = ['sage.libs.ntl',
>  systems['FLINT'] = ['_flint']
>  systems['GMP'] = ['sage.rings.integer.Integer']
>  systems['MPFR'] = ['sage.rings.real_mpfr',
> -                   'sage.rings.complex_number']
> +                   'sage.rings.complex_mpfr']
>  systems['MPFI'] = ['sage.rings.real_mpfi',
>                     'sage.rings.complex_interval']
>  systems['M4RI'] = ['sage.matrix.matrix_mod2_dense']
> `@``@` -80,15 +80,6 `@``@` def get_systems(cmd):
>          sage: I = R.ideal(x<sup>2+y</sup>2, z^2+y)
>          sage: get_systems('I.primary_decomposition()')
>          ['Singular']
> -
> -    Here we get a spurious ``MPFR`` because some coercions need to be
> -    initialized. The second time it is gone::
> -
> -        sage: a = var('a')
> -        sage: get_systems('((a+1)^2).expand()')
> -        ['MPFR', 'ginac']
> -        sage: get_systems('((a+1)^2).expand()')
> -        ['ginac']
>      """
>      import cProfile, pstats, re
> }}}

Thanks. Removing the test seems sensible. However, I just ask myself why this ticket has that effect. Perhaps it is worth to investigate it?


---

Comment by vdelecroix created at 2020-10-11 11:28:41

It might be complicated to track down precisely... with no reward as far as I can see.


---

Comment by @mjungmath created at 2020-10-11 12:08:51

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2020-10-11 12:08:51

Patchbot morally green. LGTM.


---

Comment by vdelecroix created at 2020-10-11 12:11:11

Thank you!


---

Comment by vbraun created at 2020-10-31 18:07:49

Resolution: fixed


---

Comment by mmezzarobba created at 2020-11-02 17:35:11

Hi Vincent,

What would you think of keeping files `complex_field.py` and `complex_number.pyx` that `import *` from the new location for a while, in the interest of backward compatibility?


---

Comment by vdelecroix created at 2020-11-02 17:49:29

Definitely (with deprecated lazy imports)!


---

Comment by vdelecroix created at 2020-11-02 17:50:39

Could you open a ticket?


---

Comment by mmezzarobba created at 2020-11-03 16:25:13

→ #30857
