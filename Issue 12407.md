# Issue 12407: mechanism to skip self-tests for certain spkgs

Issue created by migration from https://trac.sagemath.org/ticket/12579

Original creator: jhpalmieri

Original creation time: 2012-02-24 06:34:18

Assignee: GeorgSWeber

With the attached patch, if you set `SAGE_CHECK='!python!cvxopt'` and then build Sage, it will run self-tests for all packages except python and cvxopt. This sort of behavior can be useful with the current situation, in which python always fails self-tests (as far as I know), and a package like cvxopt fails them on OS X Lion.  So when I'm testing Sage with Lion, I could use `'!python!cvxopt'` and easily run self-tests on all of the other packages. This should be viewed as merely a convenience — I hope that people straighten out Python's test suite in general and cvxopt on Lion — but it might be a useful option.


---

Comment by jhpalmieri created at 2012-02-24 06:36:52

root repo


---

Attachment

Sage library


---

Attachment


---

Comment by jhpalmieri created at 2012-02-24 06:37:47

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-02-26 09:29:26

I'm not sure that I like the interface.  Personally, I would prefer two variables: one simply to determine whether or not to run tests (`SAGE_CHECK`) and another to actually determine which tests to run (which _by default_ should be set to `!python`).


---

Comment by jdemeyer created at 2012-02-26 09:37:44

As for implementation: the second variable (call it `SAGE_CHECK_PACKAGES` or something) should change the environment variable `SAGE_CHECK` accordingly, before running `spkg-install`.  The new GCC spkg uses `SAGE_CHECK` in its `spkg-install` and it makes sense to allow that.

Example:

```
SAGE_CHECK_PACKAGES="!python,mpir,mpfr"
```

would *always* check mpir and mpfr, regardless of `SAGE_CHECK` but would *never* check python, regardless of `SAGE_CHECK`.

The default should be

```
SAGE_CHECK_PACKAGES="!python"
```



---

Comment by jdemeyer created at 2012-02-26 09:37:44

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2012-02-26 19:20:55

My feeling was, why introduce a new environment variable when we can just use `SAGE_CHECK`? The whole approach might be better if we used autoconf:

```
./configure --self-tests=yes --skip-tests=python,cvxopt ...
```

or something like that. But I'll think about adding a second variable.


---

Comment by jdemeyer created at 2012-02-26 22:29:07

My main motivation was simply to exclude Python *by default*.


---

Comment by jhpalmieri created at 2012-02-27 05:01:11

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-02-27 05:01:11

Okay, here's a new version.


---

Comment by jdemeyer created at 2012-02-27 10:52:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-02-27 10:52:53

Yes, this is more or less what I had in mind.  Two small comments:

The lines

```
SAGE_CHECK=no
export SAGE_CHECK
```

can be simplified to

```
export SAGE_CHECK=no
```


I don't know about the portability of expr, I would use `grep` instead.  Also you don't want to match "gdmodule" when "gd" is in `$SAGE_CHECK_PACKAGES`.  Proposal:

```
# Allow spaces, commas or colons as separator (the documentation suggests commas)
if echo ",$SAGE_CHECK_PACKAGES," | grep "[ ,:]\!$PKG_BASE[ ,:]" >/dev/null; then
    export SAGE_CHECK=no
elif echo ",$SAGE_CHECK_PACKAGES," | grep "[ ,:]$PKG_BASE[ ,:]" >/dev/null; then
    export SAGE_CHECK=yes
fi
```



---

Comment by jdemeyer created at 2012-02-27 10:53:41

The documentation should mention that `SAGE_CHECK_PACKAGES='!python'` by default.


---

Comment by jdemeyer created at 2012-02-27 11:01:34

Instead of using `tr` to handle lower/upper case, simply do a case-insensitive check with `grep -i`.


---

Comment by jhpalmieri created at 2012-02-27 20:39:28

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-02-27 20:39:28

Okay, new versions. (I tried `expr` on linux, OS X, and OpenSolaris, and it seemed to work on all of them, and it seems to be POSIX-standard, but I changed to grep anyway.)


---

Attachment

root repo


---

Attachment

Sage library


---

Comment by jdemeyer created at 2012-02-28 12:23:14

Changing status from needs_review to needs_work.


---

Attachment

Rebased to #4949


---

Comment by jdemeyer created at 2012-02-28 12:25:41

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-02-28 21:41:48

The rebasing here is fine with me; the new patch applies cleanly ater #12479.


---

Attachment

Rebased to #12479


---

Comment by jdemeyer created at 2012-02-29 11:41:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-29 11:41:59

Seems to work well.  And Sage now builds with a simple

```
SAGE_CHECK=yes make
```



---

Comment by jdemeyer created at 2012-03-04 21:17:01

Resolution: fixed
