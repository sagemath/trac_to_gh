# Issue 16013: Monoids._test_one() incorrect for unhashable one elements

archive/issues_016013.json:
```json
{
    "body": "CC:  nthiery\n\nKeywords: hash\n\nIn `categories.Monoids._test_one()` the hash value of a monoid's one is tested.\n\n```\ntester.assertEqual(type(one.__hash__()), int) \ntester.assertEqual(one.__hash__(), one.__hash__())\n```\n\nFor unhashable objects, such as a `p`-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. However, since `p`-adics overwrite `__richcmp__` (in `padic_generic_element.pyx`) they are not hashable, i.e., `hash(one)` raises a `TypeError`.\n\nThe same problem exists for `AdditiveMonoids._test_zero()`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16250\n\n",
    "created_at": "2014-04-27T13:26:24Z",
    "labels": [
        "categories",
        "trivial",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Monoids._test_one() incorrect for unhashable one elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16013",
    "user": "saraedum"
}
```
CC:  nthiery

Keywords: hash

In `categories.Monoids._test_one()` the hash value of a monoid's one is tested.

```
tester.assertEqual(type(one.__hash__()), int) 
tester.assertEqual(one.__hash__(), one.__hash__())
```

For unhashable objects, such as a `p`-adic one this should not be tested. It currently works, because `__hash__()` is inherited and therefore defined. However, since `p`-adics overwrite `__richcmp__` (in `padic_generic_element.pyx`) they are not hashable, i.e., `hash(one)` raises a `TypeError`.

The same problem exists for `AdditiveMonoids._test_zero()`.

Issue created by migration from https://trac.sagemath.org/ticket/16250





---

archive/issue_comments_207919.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-04-27T13:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207919",
    "user": "saraedum"
}
```

New commits:



---

archive/issue_comments_207920.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-27T13:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207920",
    "user": "saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_207921.json:
```json
{
    "body": "Hi!\n\nThanks for shaking the generic tests with one more use case :-)\n\nI agree that it makes sense to disable the test if the object is not\nhashable. On the other hand, I would much prefer to have an explicit\ntest like:\n\n```\n    isinstance(..., collections.Hashable)\n```\n\n\nThis better expresses the intention and also avoids the risk of false\npositives in case a TypeError failure would be raised for some other\nreasons and be silently caught.\n\nOf course the above isinstance test fails if there is a `__hash__`\nmethod defined. But this can be conveniently fixed by setting\n`__hash__` to `None` in the element class. In fact this sounds like a\nnatural thing to do anyway: having `__hash__` defined and return\nsomething, and worst something that could change over time, is nothing\nbut a potential source of issues, isn't it?\n\nWith `__hash__` set to `None`, we have as desired:\n\n```\n    sage: import collections\n    sage: K.<a> = Qq(9)\n    sage: K.zero\n    sage: isinstance(K.zero(), collections.Hashable)\n    False\n```\n\n\nAgreed, the right fix (tm) would probably be to remove the infamous\n`SageObject.__hash__` method in the first place. Not all SageObjects\nare hashable, and anyway computing the hash in term of `_repr_` is\njust a continuous source of bugs. But this fix could take some work\nsince one would need to implement `__hash__` properly in a bunch of\nplaces; so let's say that this is for a separate ticket.\n\nCheers,\n                          Nicolas",
    "created_at": "2014-05-10T21:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207921",
    "user": "nthiery"
}
```

Hi!

Thanks for shaking the generic tests with one more use case :-)

I agree that it makes sense to disable the test if the object is not
hashable. On the other hand, I would much prefer to have an explicit
test like:

```
    isinstance(..., collections.Hashable)
```


This better expresses the intention and also avoids the risk of false
positives in case a TypeError failure would be raised for some other
reasons and be silently caught.

Of course the above isinstance test fails if there is a `__hash__`
method defined. But this can be conveniently fixed by setting
`__hash__` to `None` in the element class. In fact this sounds like a
natural thing to do anyway: having `__hash__` defined and return
something, and worst something that could change over time, is nothing
but a potential source of issues, isn't it?

With `__hash__` set to `None`, we have as desired:

```
    sage: import collections
    sage: K.<a> = Qq(9)
    sage: K.zero
    sage: isinstance(K.zero(), collections.Hashable)
    False
```


Agreed, the right fix (tm) would probably be to remove the infamous
`SageObject.__hash__` method in the first place. Not all SageObjects
are hashable, and anyway computing the hash in term of `_repr_` is
just a continuous source of bugs. But this fix could take some work
since one would need to implement `__hash__` properly in a bunch of
places; so let's say that this is for a separate ticket.

Cheers,
                          Nicolas



---

archive/issue_comments_207922.json:
```json
{
    "body": "Replying to [comment:6 nthiery]:\n> I agree that it makes sense to disable the test if the object is not\n> hashable. On the other hand, I would much prefer to have an explicit\n> test like:\n> {{{\n>     isinstance(..., collections.Hashable)\n> }}}\nI thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.\n\n> Agreed, the right fix (tm) would probably be to remove the infamous\n> `SageObject.__hash__` method in the first place. Not all SageObjects\n> are hashable, and anyway computing the hash in term of `_repr_` is\n> just a continuous source of bugs. But this fix could take some work\n> since one would need to implement `__hash__` properly in a bunch of\n> places; so let's say that this is for a separate ticket.\nI agree. At first it seems that basing this on `_repr_` is exactly what one wants. But the little work you save is just not worth all the trouble it causes.",
    "created_at": "2014-05-10T22:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207922",
    "user": "saraedum"
}
```

Replying to [comment:6 nthiery]:
> I agree that it makes sense to disable the test if the object is not
> hashable. On the other hand, I would much prefer to have an explicit
> test like:
> {{{
>     isinstance(..., collections.Hashable)
> }}}
I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.

> Agreed, the right fix (tm) would probably be to remove the infamous
> `SageObject.__hash__` method in the first place. Not all SageObjects
> are hashable, and anyway computing the hash in term of `_repr_` is
> just a continuous source of bugs. But this fix could take some work
> since one would need to implement `__hash__` properly in a bunch of
> places; so let's say that this is for a separate ticket.
I agree. At first it seems that basing this on `_repr_` is exactly what one wants. But the little work you save is just not worth all the trouble it causes.



---

archive/issue_comments_207923.json:
```json
{
    "body": "Replying to [comment:7 saraedum]:\n> I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.\n\n- The methods one and zero should return immutable objects whenever\n  possible, because more often than not the result is cached.  If the\n  result is a matrix this is no issue: it's enough to make it\n  immutable. And then it becomes hashable. Part of the rationale of\n  this test is precisely to check for this!\n\n- Having a method __hash__ that raises an error is bad advertising in\n  the first place. In some cases it might be simpler to do it this way\n  (e.g. for objects that can be immutable or not). But I would not\n  want to particularly support this.\n\nCheers,\n                                  Nicolas",
    "created_at": "2014-05-11T07:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207923",
    "user": "nthiery"
}
```

Replying to [comment:7 saraedum]:
> I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.

- The methods one and zero should return immutable objects whenever
  possible, because more often than not the result is cached.  If the
  result is a matrix this is no issue: it's enough to make it
  immutable. And then it becomes hashable. Part of the rationale of
  this test is precisely to check for this!

- Having a method __hash__ that raises an error is bad advertising in
  the first place. In some cases it might be simpler to do it this way
  (e.g. for objects that can be immutable or not). But I would not
  want to particularly support this.

Cheers,
                                  Nicolas



---

archive/issue_comments_207924.json:
```json
{
    "body": "Replying to [comment:8 nthiery]:\n> Replying to [comment:7 saraedum]:\n> > I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.\n> - The methods one and zero should return immutable objects whenever\n>   possible, because more often than not the result is cached.  If the\n>   result is a matrix this is no issue: it's enough to make it\n>   immutable. And then it becomes hashable. Part of the rationale of\n>   this test is precisely to check for this!\n> \n> - Having a method __hash__ that raises an error is bad advertising in\n>   the first place. In some cases it might be simpler to do it this way\n>   (e.g. for objects that can be immutable or not). But I would not\n>   want to particularly support this.\nRight. But what about any type for which equality depends on a p-adic number? (Say, a polynomial with p-adic coefficients.) If we don't want to have special classes for all these, then `__hash__` will have to raise a `TypeError` when computing the hash of its coefficients (see #11895).",
    "created_at": "2014-06-26T07:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207924",
    "user": "saraedum"
}
```

Replying to [comment:8 nthiery]:
> Replying to [comment:7 saraedum]:
> > I thought about this too. I agree that this would be better in theory. The problem with this approach are things like matrices. They define a hash which raises a `TypeError` if the matrix is mutable.
> - The methods one and zero should return immutable objects whenever
>   possible, because more often than not the result is cached.  If the
>   result is a matrix this is no issue: it's enough to make it
>   immutable. And then it becomes hashable. Part of the rationale of
>   this test is precisely to check for this!
> 
> - Having a method __hash__ that raises an error is bad advertising in
>   the first place. In some cases it might be simpler to do it this way
>   (e.g. for objects that can be immutable or not). But I would not
>   want to particularly support this.
Right. But what about any type for which equality depends on a p-adic number? (Say, a polynomial with p-adic coefficients.) If we don't want to have special classes for all these, then `__hash__` will have to raise a `TypeError` when computing the hash of its coefficients (see #11895).



---

archive/issue_comments_207925.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-06-26T07:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207925",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_207926.json:
```json
{
    "body": "Hi Julian,\n\nReplying to [comment:9 saraedum]:\n> Right. But what about any type for which equality depends on a\n> p-adic number? (Say, a polynomial with p-adic coefficients.) If we\n> don't want to have special classes for all these, then `__hash__` will\n> have to raise a `TypeError` when computing the hash of its\n> coefficients (see #11895).\n\nInteresting example. Well, we are in the situation of class that\ndeclares itself as hashable by providing a hash function, and then\nlater refutes this contract by throwing errors. I see this as a bug.\n\nAlright, a minor enough bug that we may well not want to introduce\ncomplicated infrastructure to fix it.\n\nHowever changing test_one and test_zero for this is just hiding this\nbug, and might hide other more important bugs in the future. I find\npreferable to explicitly skip `_test_one()` in the doctests: this will\ndo what we mean: there is a known bug, and it's deemed minor enough to\nignore it.\n\nNow, if we would want a real fix we could have polynomial rings check\nwhether there base ring elements can be hashed, and insert `__hash__ = None`\nin their custom element class. This could get tricky for a\nCython class though. But this states quite explicitly: I am hashable if my\nbase ring elements are.\n\nCheers,\n                                 Nicolas",
    "created_at": "2014-06-28T00:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207926",
    "user": "nthiery"
}
```

Hi Julian,

Replying to [comment:9 saraedum]:
> Right. But what about any type for which equality depends on a
> p-adic number? (Say, a polynomial with p-adic coefficients.) If we
> don't want to have special classes for all these, then `__hash__` will
> have to raise a `TypeError` when computing the hash of its
> coefficients (see #11895).

Interesting example. Well, we are in the situation of class that
declares itself as hashable by providing a hash function, and then
later refutes this contract by throwing errors. I see this as a bug.

Alright, a minor enough bug that we may well not want to introduce
complicated infrastructure to fix it.

However changing test_one and test_zero for this is just hiding this
bug, and might hide other more important bugs in the future. I find
preferable to explicitly skip `_test_one()` in the doctests: this will
do what we mean: there is a known bug, and it's deemed minor enough to
ignore it.

Now, if we would want a real fix we could have polynomial rings check
whether there base ring elements can be hashed, and insert `__hash__ = None`
in their custom element class. This could get tricky for a
Cython class though. But this states quite explicitly: I am hashable if my
base ring elements are.

Cheers,
                                 Nicolas



---

archive/issue_comments_207927.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-06-28T00:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207927",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_207928.json:
```json
{
    "body": "Replying to [comment:11 nthiery]:\n> Replying to [comment:9 saraedum]:\n> However changing test_one and test_zero for this is just hiding this\n> bug, and might hide other more important bugs in the future. I find\n> preferable to explicitly skip `_test_one()` in the doctests: this will\n> do what we mean: there is a known bug, and it's deemed minor enough to\n> ignore it.\nOk. I'll change it.",
    "created_at": "2014-07-26T19:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207928",
    "user": "saraedum"
}
```

Replying to [comment:11 nthiery]:
> Replying to [comment:9 saraedum]:
> However changing test_one and test_zero for this is just hiding this
> bug, and might hide other more important bugs in the future. I find
> preferable to explicitly skip `_test_one()` in the doctests: this will
> do what we mean: there is a known bug, and it's deemed minor enough to
> ignore it.
Ok. I'll change it.



---

archive/issue_comments_207929.json:
```json
{
    "body": "Replying to [comment:11 nthiery]:\n> Replying to [comment:9 saraedum]:\n> Now, if we would want a real fix we could have polynomial rings check\n> whether there base ring elements can be hashed, and insert `__hash__ = None`\n> in their custom element class. This could get tricky for a\n> Cython class though. But this states quite explicitly: I am hashable if my\n> base ring elements are.\nDo you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by \"This could get tricky for a Cython class though.\"?)\n\nBtw., setting `tp_hash` does not work either:\n\n```\nsage: cython('''\ncdef extern from \"Python.h\":\n    long PyObject_HashNotImplemented(object)\n    ctypedef struct PyTypeObject:\n        long tp_hash(object)\n\ncdef class A(object):\n   pass\n\n(<PyTypeObject *> A).tp_hash = PyObject_HashNotImplemented\n\n''')\nsage: hash(A())\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-83-c87e237c4d02> in <module>()\n----> 1 hash(A())\n\nTypeError: unhashable type: '_dev_shm_dot_sage_temp_cslogin02_10081_tmp_o8x_Zq_spyx_0.A'\nsage: isinstance(A(),collections.Hashable)\nTrue\n```\n\n\nI posted this as a question on cython-user: http://permalink.gmane.org/gmane.comp.python.cython.user/11569",
    "created_at": "2014-07-27T23:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207929",
    "user": "saraedum"
}
```

Replying to [comment:11 nthiery]:
> Replying to [comment:9 saraedum]:
> Now, if we would want a real fix we could have polynomial rings check
> whether there base ring elements can be hashed, and insert `__hash__ = None`
> in their custom element class. This could get tricky for a
> Cython class though. But this states quite explicitly: I am hashable if my
> base ring elements are.
Do you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by "This could get tricky for a Cython class though."?)

Btw., setting `tp_hash` does not work either:

```
sage: cython('''
cdef extern from "Python.h":
    long PyObject_HashNotImplemented(object)
    ctypedef struct PyTypeObject:
        long tp_hash(object)

cdef class A(object):
   pass

(<PyTypeObject *> A).tp_hash = PyObject_HashNotImplemented

''')
sage: hash(A())
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-83-c87e237c4d02> in <module>()
----> 1 hash(A())

TypeError: unhashable type: '_dev_shm_dot_sage_temp_cslogin02_10081_tmp_o8x_Zq_spyx_0.A'
sage: isinstance(A(),collections.Hashable)
True
```


I posted this as a question on cython-user: http://permalink.gmane.org/gmane.comp.python.cython.user/11569



---

archive/issue_comments_207930.json:
```json
{
    "body": "Replying to [comment:14 saraedum]:\n> Do you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by \"This could get tricky for a Cython class though.\"?)\n\nI don't know. That's indeed typically the kind of difficulties I\nmeant. Also that a parent can't have is own \"copy\" of the class to\nmark it as unhashable when other parent sharing the same class will\nwant to have its elements hashable.\n\nThanks for investigating!",
    "created_at": "2014-07-30T07:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207930",
    "user": "nthiery"
}
```

Replying to [comment:14 saraedum]:
> Do you know if a Cython class can be marked as being unhashable? `__hash__=None` does not work in Cython. (Maybe that's what you meant by "This could get tricky for a Cython class though."?)

I don't know. That's indeed typically the kind of difficulties I
meant. Also that a parent can't have is own "copy" of the class to
mark it as unhashable when other parent sharing the same class will
want to have its elements hashable.

Thanks for investigating!



---

archive/issue_comments_207931.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-04T07:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207931",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_207932.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-08-04T07:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207932",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_207933.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-05T13:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207933",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_207934.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-10T02:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207934",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_207935.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-10-10T02:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207935",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_207936.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-19T19:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207936",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_207937.json:
```json
{
    "body": "fixed in #19016.",
    "created_at": "2015-11-19T19:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207937",
    "user": "saraedum"
}
```

fixed in #19016.



---

archive/issue_comments_207938.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-22T20:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16013#issuecomment-207938",
    "user": "vbraun"
}
```

Resolution: fixed
