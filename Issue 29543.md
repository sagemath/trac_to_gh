# Issue 29543: Still memory leaks with matrix operations over GF(2)

Issue created by migration from https://trac.sagemath.org/ticket/29780

Original creator: @cbe90

Original creation time: 2020-06-02 09:21:21

CC:  asante @sn-d nbruin tmonteil chapoton

Keywords: memory leaks

According to the ticket #26349, the bug should have been fixed in Release 9.1., but the provided code 


```
n = 8
X = zero_vector(GF(2), n)
M = zero_matrix(GF(2), n, n)

for _ in range(10000000):
    Y = M * X
```


still leaks memory (using Ubuntu 18.04.4 LTS). There is no error message when trying to execute, but the memory consumption increases until the process crashes.


---

Comment by tscrim created at 2020-06-04 00:12:59

I can confirm that the leak is there. I remember checking when reviewing #26349 and did not see the leak.


---

Comment by tscrim created at 2020-06-04 00:13:51

It is something specific to a matrix times a vector. I don't see the leak if I do `Y = M * M`.


---

Comment by tscrim created at 2020-06-04 00:18:44

Okay, here is the problem:

```sage
        c._init(self._nrows, VS)
        c._entries = mzd_init(1, self._nrows)
```

The `c._init` already allocates `c._entries`. So this does a double allocation, and so the old allocation from `c._init` is the leak.


---

Comment by tscrim created at 2020-06-04 00:23:56

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-06-04 00:23:56

Here is the fix (plus one local micro-optimization).
----
New commits:


---

Comment by tscrim created at 2020-06-04 00:23:56

Changing priority from major to critical.


---

Comment by tscrim created at 2020-06-10 22:38:47

Green patchbot.


---

Comment by chapoton created at 2020-06-11 06:07:04

ok, but I am no expert.


---

Comment by chapoton created at 2020-06-11 06:07:04

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-06-11 13:03:38

Thank you.


---

Comment by vbraun created at 2020-06-21 22:37:29

Resolution: fixed
