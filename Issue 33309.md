# Issue 33309: Replace Sage doctest discovery by using pytest_collect_file

archive/issues_033309.json:
```json
{
    "body": "CC:  @tobiasdiez @tornaria\n\nAs suggested in #33232#comment:1\n\nIn this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33546\n\n",
    "created_at": "2022-03-21T23:56:29Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Replace Sage doctest discovery by using pytest_collect_file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33309",
    "user": "@mkoeppe"
}
```
CC:  @tobiasdiez @tornaria

As suggested in #33232#comment:1

In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.

Issue created by migration from https://trac.sagemath.org/ticket/33546





---

archive/issue_comments_474222.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-27T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474222",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474223.json:
```json
{
    "body": "In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.\n\nAny idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?",
    "created_at": "2022-03-29T16:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474223",
    "user": "@tobiasdiez"
}
```

In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.

Any idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?



---

archive/issue_comments_474224.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-29T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474224",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474225.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-05T19:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474225",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_474226.json:
```json
{
    "body": "There are still a few issues, but as a first version it should be good to go.",
    "created_at": "2022-04-05T19:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474226",
    "user": "@tobiasdiez"
}
```

There are still a few issues, but as a first version it should be good to go.



---

archive/issue_comments_474227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-04-05T19:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474227",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_474228.json:
```json
{
    "body": "Replying to [ticket:33546 mkoeppe]:\n> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n\nWould it be possible to add a doctest for that?",
    "created_at": "2022-04-05T21:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474228",
    "user": "@mkoeppe"
}
```

Replying to [ticket:33546 mkoeppe]:
> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

Would it be possible to add a doctest for that?



---

archive/issue_comments_474229.json:
```json
{
    "body": "A concern from #33531?cnum_edit=14#comment:14:\n\n  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).",
    "created_at": "2022-05-01T20:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474229",
    "user": "@mkoeppe"
}
```

A concern from #33531?cnum_edit=14#comment:14:

  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).



---

archive/issue_comments_474230.json:
```json
{
    "body": "There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).",
    "created_at": "2022-05-02T19:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474230",
    "user": "@tobiasdiez"
}
```

There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).



---

archive/issue_comments_474231.json:
```json
{
    "body": "Replying to [comment:9 gh-tobiasdiez]:\n> There are still a few issues, but as a first version it should be good to go.\n\nI haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?",
    "created_at": "2022-05-02T21:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474231",
    "user": "@mkoeppe"
}
```

Replying to [comment:9 gh-tobiasdiez]:
> There are still a few issues, but as a first version it should be good to go.

I haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?



---

archive/issue_comments_474232.json:
```json
{
    "body": "Replying to [comment:14 gh-tobiasdiez]:\n> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n\nParallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nNon-rethorical question: what is the advantage of pytest over the current sage doctest framework?",
    "created_at": "2022-05-02T22:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474232",
    "user": "@tornaria"
}
```

Replying to [comment:14 gh-tobiasdiez]:
> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?



---

archive/issue_comments_474233.json:
```json
{
    "body": "Replying to [comment:16 tornaria]:\n> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n\nMy own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?",
    "created_at": "2022-05-02T23:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474233",
    "user": "@kiwifb"
}
```

Replying to [comment:16 tornaria]:
> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?



---

archive/issue_comments_474234.json:
```json
{
    "body": "Replying to [comment:16 tornaria]:\n> Replying to [comment:14 gh-tobiasdiez]:\n> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). \n> \n> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).\n\nIf I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). \n\nAnyway, both packages are ordinary pip installable packages.",
    "created_at": "2022-05-04T09:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474234",
    "user": "@tobiasdiez"
}
```

Replying to [comment:16 tornaria]:
> Replying to [comment:14 gh-tobiasdiez]:
> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 
> 
> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

If I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). 

Anyway, both packages are ordinary pip installable packages.



---

archive/issue_comments_474235.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> Replying to [comment:16 tornaria]:\n> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?\n> \n> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?\n\nCannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).",
    "created_at": "2022-05-04T10:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474235",
    "user": "@tobiasdiez"
}
```

Replying to [comment:17 fbissey]:
> Replying to [comment:16 tornaria]:
> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?
> 
> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?

Cannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).



---

archive/issue_comments_474236.json:
```json
{
    "body": "Replying to [comment:18 gh-tobiasdiez]:\n> Replying to [comment:16 tornaria]:\n> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]\n\n> If I'm not mistaken that only runs the tests in multiple independent workers\n\nThat's right.\n\n> But as far as I'm aware there are no extensive tests of sage with concurrency\n\nYes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.\n\n> multiple threads sharing the same state (i.e. pytest-parallel). \n\nLooks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.",
    "created_at": "2022-05-04T16:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474236",
    "user": "@mkoeppe"
}
```

Replying to [comment:18 gh-tobiasdiez]:
> Replying to [comment:16 tornaria]:
> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]

> If I'm not mistaken that only runs the tests in multiple independent workers

That's right.

> But as far as I'm aware there are no extensive tests of sage with concurrency

Yes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.

> multiple threads sharing the same state (i.e. pytest-parallel). 

Looks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.



---

archive/issue_comments_474237.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2022-05-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474237",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_474238.json:
```json
{
    "body": "comment:15",
    "created_at": "2022-05-04T17:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474238",
    "user": "@mkoeppe"
}
```

comment:15



---

archive/issue_comments_474239.json:
```json
{
    "body": "What issues did you encounter?",
    "created_at": "2022-05-05T22:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474239",
    "user": "@tobiasdiez"
}
```

What issues did you encounter?



---

archive/issue_comments_474240.json:
```json
{
    "body": "pytest now runs doctests, and you say that there will be failures.\n\nBut `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n\nCorrect?",
    "created_at": "2022-05-05T22:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474240",
    "user": "@mkoeppe"
}
```

pytest now runs doctests, and you say that there will be failures.

But `sage -t` also runs pytest, so now there will be failures in `sage -t`.

Correct?



---

archive/issue_comments_474241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-06T22:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474241",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474242.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> Replying to [ticket:33546 mkoeppe]:\n> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.\n> \n> Would it be possible to add a doctest for that?\n\nAdded a pytest for it.",
    "created_at": "2022-05-06T22:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474242",
    "user": "@tobiasdiez"
}
```

Replying to [comment:12 mkoeppe]:
> Replying to [ticket:33546 mkoeppe]:
> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
> 
> Would it be possible to add a doctest for that?

Added a pytest for it.



---

archive/issue_comments_474243.json:
```json
{
    "body": "Replying to [comment:23 mkoeppe]:\n> pytest now runs doctests, and you say that there will be failures.\n> \n> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.\n> \n> Correct?\n\nThe idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!",
    "created_at": "2022-05-06T22:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474243",
    "user": "@tobiasdiez"
}
```

Replying to [comment:23 mkoeppe]:
> pytest now runs doctests, and you say that there will be failures.
> 
> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.
> 
> Correct?

The idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!



---

archive/issue_comments_474244.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-05-06T22:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474244",
    "user": "@tobiasdiez"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_474245.json:
```json
{
    "body": "\n```\n[pytest]\n python_files = *_test.py\n+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n```\n\n`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist",
    "created_at": "2022-05-06T23:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474245",
    "user": "@mkoeppe"
}
```


```
[pytest]
 python_files = *_test.py
+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
```

`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist



---

archive/issue_comments_474246.json:
```json
{
    "body": "Also could you update the ticket description please?",
    "created_at": "2022-05-06T23:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474246",
    "user": "@mkoeppe"
}
```

Also could you update the ticket description please?



---

archive/issue_comments_474247.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-08T08:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474247",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474248.json:
```json
{
    "body": "Replying to [comment:27 mkoeppe]:\n> {{{\n> [pytest]\n>  python_files = *_test.py\n> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup\n> }}}\n> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist\n\nYou are right. Not sure why I've added them in the first place, but I've removed them now.",
    "created_at": "2022-05-08T08:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474248",
    "user": "@tobiasdiez"
}
```

Replying to [comment:27 mkoeppe]:
> {{{
> [pytest]
>  python_files = *_test.py
> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
> }}}
> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist

You are right. Not sure why I've added them in the first place, but I've removed them now.



---

archive/issue_comments_474249.json:
```json
{
    "body": "In a build without `--enable-editable`:\n\n```\n./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests\n=================================================================================================== test session starts ====================================================================================================\nplatform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini\ncollected 0 items / 2 errors                                                                                                                                                                                               \n\n========================================================================================================== ERRORS ==========================================================================================================\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nsrc/conftest.py:93: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call\n    result: Optional[TResult] = func()\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>\n    call = CallInfo.from_call(lambda: list(collector.collect()), \"collect\")\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect\n    module = import_path(self.path, root=self.config.rootpath)\nlocal/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path\n    raise ImportPathMismatchError(module_name, module_file, path)\nE   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))\n================================================================================================= short test summary info ==================================================================================================\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\nERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n==================================================================================================== 2 errors in 1.16s =====================================================================================================\n```\n",
    "created_at": "2022-05-08T20:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474249",
    "user": "@mkoeppe"
}
```

In a build without `--enable-editable`:

```
./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests
=================================================================================================== test session starts ====================================================================================================
platform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini
collected 0 items / 2 errors                                                                                                                                                                                               

========================================================================================================== ERRORS ==========================================================================================================
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
src/conftest.py:93: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call
    result: Optional[TResult] = func()
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>
    call = CallInfo.from_call(lambda: list(collector.collect()), "collect")
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
================================================================================================= short test summary info ==================================================================================================
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================== 2 errors in 1.16s =====================================================================================================
```




---

archive/issue_comments_474250.json:
```json
{
    "body": "I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). \n\nThe strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.",
    "created_at": "2022-05-08T21:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474250",
    "user": "@tobiasdiez"
}
```

I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). 

The strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.



---

archive/issue_comments_474251.json:
```json
{
    "body": "You can just reconfigure without --enable-editable and rebuild to test",
    "created_at": "2022-05-08T21:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474251",
    "user": "@mkoeppe"
}
```

You can just reconfigure without --enable-editable and rebuild to test



---

archive/issue_comments_474252.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-09T12:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474252",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_474253.json:
```json
{
    "body": "Should work now.",
    "created_at": "2022-05-09T12:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474253",
    "user": "@tobiasdiez"
}
```

Should work now.



---

archive/issue_comments_474254.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-05-09T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474254",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_474255.json:
```json
{
    "body": "I've opened tickets for the follow-ups.",
    "created_at": "2022-05-09T17:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474255",
    "user": "@mkoeppe"
}
```

I've opened tickets for the follow-ups.



---

archive/issue_comments_474256.json:
```json
{
    "body": "Two times thanks!",
    "created_at": "2022-05-09T20:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474256",
    "user": "@tobiasdiez"
}
```

Two times thanks!



---

archive/issue_comments_474257.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-05-20T22:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474257",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_474258.json:
```json
{
    "body": "see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.",
    "created_at": "2022-12-07T10:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474258",
    "user": "@dimpase"
}
```

see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.



---

archive/issue_comments_474259.json:
```json
{
    "body": "Replying to [comment:41 Dima Pasechnik]:\n>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by \"classic\" Sage doctesting, i.e. by `sage -doctest`.\n\nOpened a followup ticket #34829 to deal with this.",
    "created_at": "2022-12-07T10:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33309",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33309#issuecomment-474259",
    "user": "@dimpase"
}
```

Replying to [comment:41 Dima Pasechnik]:
>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.

Opened a followup ticket #34829 to deal with this.
