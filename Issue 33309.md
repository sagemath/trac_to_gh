# Issue 33309: Replace Sage doctest discovery by using pytest_collect_file

Issue created by migration from https://trac.sagemath.org/ticket/33546

Original creator: mkoeppe

Original creation time: 2022-03-21 23:56:29

CC:  @tobiasdiez tornaria

As suggested in #33232#comment:1

In this context, the limitation of pytest to Python files matching the pytest file pattern (#31924) will be reverted.


---

Comment by git created at 2022-03-27 13:50:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-29 16:28:15

In principle this seems to work now. To test, run `./sage --pytest src/test_doctest.py`. Feedback welcome.

Any idea why the import of `Integer` is necessary in `test_doctest.py` and how to do this on a global level? How is this done for `sage -t`?


---

Comment by git created at 2022-03-29 16:28:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-05 19:44:34

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2022-04-05 19:44:34

There are still a few issues, but as a first version it should be good to go.


---

Comment by git created at 2022-04-05 19:44:48

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2022-04-05 21:19:43

Replying to [ticket:33546 mkoeppe]:
> Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.

Would it be possible to add a doctest for that?


---

Comment by mkoeppe created at 2022-05-01 20:30:16

A concern from #33531?cnum_edit=14#comment:14:

  I couldn't help but notice that pytest will use a single thread to run, which is a HUGE regression if tests start migrating from the sage doctest framework to pytest !!! Right now running pytest through all these 9 files takes 80s, while the doctest step in --long --all mode takes just 312s wall time (using 36 threads).


---

Comment by @tobiasdiez created at 2022-05-02 19:17:12

There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs).


---

Comment by mkoeppe created at 2022-05-02 21:50:42

Replying to [comment:9 gh-tobiasdiez]:
> There are still a few issues, but as a first version it should be good to go.

I haven't tested it, but won't this ticket lead to failures when `sage -t` invokes pytest?


---

Comment by tornaria created at 2022-05-02 22:22:41

Replying to [comment:14 gh-tobiasdiez]:
> There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 

Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?


---

Comment by fbissey created at 2022-05-02 23:24:26

Replying to [comment:16 tornaria]:
> Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?

My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?


---

Comment by @tobiasdiez created at 2022-05-04 09:54:44

Replying to [comment:16 tornaria]:
> Replying to [comment:14 gh-tobiasdiez]:
> > There are plugins that enable parallel processing of tests like https://github.com/pytest-dev/pytest-xdist and https://github.com/browsertron/pytest-parallel. Let's keep this in mind and do it as a follow-up (especially since I'm not sure how well tested sage is with concurrent runs). 
> 
> Parallel doctesting WORKS. As mentioned above, I can use 36 threads to doctest in --long --all mode in just 312s wall time (instead of ~3 hours which would take using a single thread). Have you actually tried using those plugins? They are not available in my distro (void linux).

If I'm not mistaken that only runs the tests in multiple independent workers and thus is only parallelism (i.e. pytest-xdist). But as far as I'm aware there are no extensive tests of sage with concurrency, that is, with multiple threads sharing the same state (i.e. pytest-parallel). 

Anyway, both packages are ordinary pip installable packages.


---

Comment by @tobiasdiez created at 2022-05-04 10:01:47

Replying to [comment:17 fbissey]:
> Replying to [comment:16 tornaria]:
> > Non-rethorical question: what is the advantage of pytest over the current sage doctest framework?
> 
> My own answer: should sage developers build and maintain their own unique testing framework when there are mature testing framework around? Could their time be better used if they didn't have to maintain that framework that no one else (apart possibly a few downstream package) uses or want?

Cannot agree more. Plus using standard tools increases synergy effects, for example IDEs have special support for pytest but not for sage's custom test runner. Also new developers might have heard of and used pytest before, but have to learn sage's test runner conventions (eg command line args).


---

Comment by mkoeppe created at 2022-05-04 16:39:46

Replying to [comment:18 gh-tobiasdiez]:
> Replying to [comment:16 tornaria]:
> > Parallel doctesting WORKS. As mentioned above, I can use 36 threads [...]

> If I'm not mistaken that only runs the tests in multiple independent workers

That's right.

> But as far as I'm aware there are no extensive tests of sage with concurrency

Yes, we shouldn't test this -- there is a lot of global state and no attempts in Sage library whatsoever to support threading on the Python level.

> multiple threads sharing the same state (i.e. pytest-parallel). 

Looks like `pytest-parallel` can do both (https://pypi.org/project/pytest-parallel/). We would only use `--workers`, not `--tests-per-worker`.


---

Comment by mkoeppe created at 2022-05-04 17:24:07

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2022-05-04 17:24:07

comment:15


---

Comment by @tobiasdiez created at 2022-05-05 22:39:19

What issues did you encounter?


---

Comment by mkoeppe created at 2022-05-05 22:41:37

pytest now runs doctests, and you say that there will be failures.

But `sage -t` also runs pytest, so now there will be failures in `sage -t`.

Correct?


---

Comment by git created at 2022-05-06 22:33:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-06 22:33:56

Replying to [comment:12 mkoeppe]:
> Replying to [ticket:33546 mkoeppe]:
> > Currently, the file `src/test_doctest.py` has been added. This is to make reviewing of this ticket easier. For example, `./sage --pytest src/test_doctest.py` is supposed to fail so that the reviewer can experiment with how failures are reported with pytest. I will remove this test file after the initial review.
> 
> Would it be possible to add a doctest for that?

Added a pytest for it.


---

Comment by @tobiasdiez created at 2022-05-06 22:36:14

Replying to [comment:23 mkoeppe]:
> pytest now runs doctests, and you say that there will be failures.
> 
> But `sage -t` also runs pytest, so now there will be failures in `sage -t`.
> 
> Correct?

The idea is that pytest only looks for doctests if `--doctest-modules` is specified. We do this only for `sage -pytest` but not in `sage -t`. However, this check got lost in one of the git merges so thanks for noticing it!


---

Comment by @tobiasdiez created at 2022-05-06 22:36:14

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2022-05-06 23:17:28


```
[pytest]
 python_files = *_test.py
+norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
```

`src/sage/pkgs` and `src/sage/src/sage_setup` do not exist


---

Comment by mkoeppe created at 2022-05-06 23:30:16

Also could you update the ticket description please?


---

Comment by git created at 2022-05-08 08:53:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-08 08:53:54

Replying to [comment:27 mkoeppe]:
> {{{
> [pytest]
>  python_files = *_test.py
> +norecursedirs = local prefix venv build pkgs .git src/sage/pkgs src/doc src/bin src/sage/src/sage_setup
> }}}
> `src/sage/pkgs` and `src/sage/src/sage_setup` do not exist

You are right. Not sure why I've added them in the first place, but I've removed them now.


---

Comment by mkoeppe created at 2022-05-08 20:29:54

In a build without `--enable-editable`:

```
./sage -pytest src/sage/manifolds/chart.py                                                                                                                         git:t/33546/public/tests/pytest_doctests
=================================================================================================== test session starts ====================================================================================================
platform darwin -- Python 3.10.2, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/src, configfile: tox.ini
collected 0 items / 2 errors                                                                                                                                                                                               

========================================================================================================== ERRORS ==========================================================================================================
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
src/conftest.py:93: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
_________________________________________________________________________________________ ERROR collecting sage/manifolds/chart.py _________________________________________________________________________________________
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:338: in from_call
    result: Optional[TResult] = func()
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/runner.py:369: in <lambda>
    call = CallInfo.from_call(lambda: list(collector.collect()), "collect")
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/doctest.py:545: in collect
    module = import_path(self.path, root=self.config.rootpath)
local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/_pytest/pathlib.py:556: in import_path
    raise ImportPathMismatchError(module_name, module_file, path)
E   _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds/chart.py', PosixPath('/Users/mkoeppe/s/sage/sage-rebasing/src/sage/manifolds/chart.py'))
================================================================================================= short test summary info ==================================================================================================
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
ERROR src/sage/manifolds/chart.py - _pytest.pathlib.ImportPathMismatchError: ('sage.manifolds.chart', '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/manifolds...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================== 2 errors in 1.16s =====================================================================================================
```



---

Comment by @tobiasdiez created at 2022-05-08 21:24:43

I cannot reproduce this on gitpod (which uses the editable install but is currently my only means to test things). 

The strange thing is that this part of the import code shouldn't be invoked at all and this exception is only raised in the pre/append import mode. https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L492-L508 vs https://github.com/pytest-dev/pytest/blob/f22451717d95d9938d95019d6399a509487f35dd/src/_pytest/pathlib.py#L556. For some reason pytest is not picking up the config from the tox ini correctly in your case. Can you please try to add `--import-mode importlib` to the command and see if it helps? Or setting `PY_IGNORE_IMPORTMISMATCH=1` should suppress this error.


---

Comment by mkoeppe created at 2022-05-08 21:28:18

You can just reconfigure without --enable-editable and rebuild to test


---

Comment by git created at 2022-05-09 12:35:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-09 12:36:09

Should work now.


---

Comment by mkoeppe created at 2022-05-09 17:30:20

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-09 17:38:45

I've opened tickets for the follow-ups.


---

Comment by @tobiasdiez created at 2022-05-09 20:46:41

Two times thanks!


---

Comment by vbraun created at 2022-05-20 22:27:13

Resolution: fixed


---

Comment by dimpase created at 2022-12-07 10:00:44

see #34828 for further discussion on doctesting and `pytest`. I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.


---

Comment by dimpase created at 2022-12-07 10:13:58

Replying to [comment:41 Dima Pasechnik]:
>  I noticed that if run on an out of tree `.py` file with `sage:` doctrings, they are ignored (while `>>>` are executed!). This seems to be a bug missed on this ticket - of course one wants Sage doctests work outside of Sage tree as well, and this is supported by "classic" Sage doctesting, i.e. by `sage -doctest`.

Opened a followup ticket #34829 to deal with this.
