# Issue 27945: Linear algorithm for squares in words

Issue created by migration from https://trac.sagemath.org/ticket/28182

Original creator: enadeau

Original creation time: 2019-07-12 09:46:24

CC:  saliola nadialafreniere




---

Comment by enadeau created at 2019-07-12 12:40:52

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by enadeau created at 2019-07-12 12:40:52

Changing type from PLEASE CHANGE to enhancement.


---

Comment by enadeau created at 2019-07-12 12:40:52

Changing keywords from "" to "fpsac2019, suffix_trees".


---

Comment by git created at 2019-07-12 13:20:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-12 13:57:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by enadeau created at 2019-07-12 14:01:05

Changing status from new to needs_review.


---

Comment by nadialafreniere created at 2019-07-14 00:34:47

The `leftmost_covering_set` function does not work properly:


```
sage: v = Word('aaaaa')
sage: Tv = v.suffix_tree()
sage: Tv.leftmost_covering_set()
[[4, 2], [], [8], [6], [4]]
```


Is that wrong? Shouldn't `i+l` be smaller than the length of the word, since it is the position where the factors are supposed to end?
I think the errors are in the 2nd condition. Testing it with the word `'aaaaa'` on the first block (of size 1), the 2nd condition returns `[(-1, 4), (-2, 6), (-3, 8)]`, which seems a bit weird, the first entry of the tuple being the position at which the square starts.
Please, fix it and add a test/example to make sure this casee is covered.
If you fix this, I'm ok with `leftmost_covering_set`.

For `square_vocabulary`, I think you should be more explicit in the description and say what the pairs are (a //couple// containing the position at which the square starts and its length).
----
New commits:


---

Comment by enadeau created at 2019-07-14 12:02:55

I've made the change to match the new signature of `suffix_walk`, see ticket:23573
----
Last 10 new commits:


---

Comment by git created at 2019-07-14 12:32:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-15 00:19:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nadialafreniere created at 2019-07-15 12:58:52

Changing status from needs_review to needs_work.


---

Comment by nadialafreniere created at 2019-07-15 12:58:52

Great! I'm happy with most of the changes and the algorithm for squares is indeed faster than the naive one.

With the naive algorithm, I had:

```
sage: w = words.ThueMorseWord()[:1000]
sage: %timeit squares(w)
10 loops, best of 3: 72.3 ms per loop
sage: u = words.ThueMorseWord()[:2000]
sage: %timeit squares(u)
1 loop, best of 3: 283 ms per loop
```

while the new one gives

```
sage: w = words.ThueMorseWord()[:1000]
sage: %timeit w.squares()
10 loops, best of 3: 30.5 ms per loop
sage: u = words.ThueMorseWord()[:2000]
sage: %timeit u.squares()
10 loops, best of 3: 60.8 ms per loop
```

which is much faster.

I'll repeat what I suggested in comment:9, because you seem to have forgotten to apply it:
> For `square_vocabulary`, I think you should be more explicit in the description and say what the pairs are (a //couple// containing the position at which the square starts and its length). 
If you disagree with this comment, I'd like to hear your point of view. Otherwise, please change it.


---

Comment by git created at 2019-07-16 11:56:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-16 12:06:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nadialafreniere created at 2019-07-16 12:08:17

Changing status from needs_work to positive_review.


---

Comment by git created at 2019-07-16 12:16:09

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-07-16 12:16:09

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by enadeau created at 2019-07-16 12:18:27

I've detailed the documentation as you suggested and also fixed some other details pointed out by the patchbot.


---

Comment by nadialafreniere created at 2019-07-16 14:04:21

New commits:


---

Comment by nadialafreniere created at 2019-07-16 14:04:21

Changing status from needs_review to positive_review.


---

Comment by enadeau created at 2019-07-17 09:21:56

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-08-14 10:23:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-14 14:50:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by enadeau created at 2019-08-15 13:07:08

Changing status from needs_work to needs_review.


---

Comment by nadialafreniere created at 2019-08-30 22:37:34

Great! I'm happy there's now a fast algorithm for computing the squares and everything looks fine.


---

Comment by nadialafreniere created at 2019-08-30 22:37:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-09-05 20:07:25

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-09-05 20:07:25

I'm getting a number of py3 failures of the sort 

```
**********************************************************************
File "src/sage/combinat/words/suffix_trees.py", line 1633, in sage.combinat.words.suffix_trees.DecoratedSuffixTree._partial_labeling
Failed example:
    T = DecoratedSuffixTree(w)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.words.suffix_trees.DecoratedSuffixTree._partial_labeling[2]>", line 1, in <module>
        T = DecoratedSuffixTree(w)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/combinat/words/suffix_trees.py", line 1609, in __init__
        self.labeling = self._complete_labeling()
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/combinat/words/suffix_trees.py", line 1786, in _complete_labeling
        prelabeling = self._partial_labeling()
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/combinat/words/suffix_trees.py", line 1703, in _partial_labeling
        treat_node(0, None)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/combinat/words/suffix_trees.py", line 1683, in treat_node
        if D.has_key(current_node):
    AttributeError: 'dict' object has no attribute 'has_key'
**********************************************************************
```

Note: `has_key` is removed in python 3, use `in` instead.


---

Comment by tscrim created at 2019-09-06 06:47:04

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-09-06 06:47:04

There were a few other things that also needed fixing (including a failing doctest on Python3) and that could be optimized. This now passes tests for me on Python3.
----
New commits:


---

Comment by enadeau created at 2019-09-12 09:39:32

Changing status from needs_review to positive_review.


---

Comment by enadeau created at 2019-09-12 09:39:32

Looks good. Thanks for your help.


---

Comment by chapoton created at 2019-09-30 08:12:27

moving milestone to 9.0 (after release of 8.9)


---

Comment by vbraun created at 2019-10-07 22:04:21

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-10-07 22:04:21

Getting some random failures:

```
sage -t --long src/sage/combinat/words/finite_word.py
**********************************************************************
File "src/sage/combinat/words/finite_word.py", line 6879, in sage.combinat.words.finite_word.FiniteWord_class.squares
Failed example:
    w.squares()
Expected:
    [word: , word: 01100110, word: 00110011, word: 00, word: 11, word: 1010]
Got:
    [word: , word: 00110011, word: 00, word: 01100110, word: 11, word: 1010]
**********************************************************************
1 item had failures:
   1 of   5 in sage.combinat.words.finite_word.FiniteWord_class.squares
    [1318 tests, 1 failure, 3.32 s]
```



---

Comment by chapoton created at 2019-10-08 07:18:27

and one missing empty line here:

```
+        EXAMPLES::
+            sage: from sage.combinat.words.suffix_trees import DecoratedSuffixTree
```



---

Comment by nadialafreniere created at 2019-10-08 14:09:10

Why don't you return the squares as a set, just like factors and palindromes? That would solve the problem of the failing doctest.


---

Comment by enadeau created at 2019-10-08 15:22:24

I could change it for a `set` if we want to be consistent with the output from `factors` and `palindromes`. However, Python has no guarantee about order of the elements in a set. This means that it wouldn't fix the doctest since it is sensitive to the order the elements are printed. To fix the doctest using `sorted` is the good way to do it. Tests for `palindromes` are also written that way.

Do you still think the output should be changed to a set?


---

Comment by nadialafreniere created at 2019-10-08 20:24:03

I think consistency is something we should aim for, so that would be an improvement. But you are also right about the doctests.


---

Comment by git created at 2019-10-09 09:26:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-09 14:50:33

INPUTS: should be INPUT:


---

Comment by git created at 2019-10-09 15:05:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-10 14:32:05

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-10-10 14:32:05

you should set back to needs review once you made all the required changes


---

Comment by tscrim created at 2019-10-30 04:44:53

LGTM as I believe all suggestions have been addressed.


---

Comment by tscrim created at 2019-10-30 04:44:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-10-31 22:40:38

Resolution: fixed
