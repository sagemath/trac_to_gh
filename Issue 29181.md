# Issue 29181: sage-download-file: Add option --no-check-certificate

Issue created by migration from https://trac.sagemath.org/ticket/29418

Original creator: mkoeppe

Original creation time: 2020-03-27 17:27:28

CC:  vbraun dimpase fbissey jhpalmieri vdelecroix chapoton @kliem

This is for downloading from an https `upstream_url` when the host is poorly configured.

As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620


---

Comment by mkoeppe created at 2020-03-27 17:35:13

https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification


---

Comment by mkoeppe created at 2020-03-27 17:50:20

https://stackoverflow.com/questions/57630314/ssl-certificate-verify-failed-error-with-python3-on-macos-10-15


---

Comment by dimpase created at 2020-03-28 15:42:31

that's why I suggested not to bother with MacOS/Xcode's python(3).
Can't one get Python3 from python.org in MacOS by running a script?
 
----
New commits:


---

Comment by mkoeppe created at 2020-03-28 15:42:53

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-28 15:43:32

Replying to [comment:6 dimpase]:
> that's why I suggested not to bother with MacOS/Xcode's python(3).
> Can't one get Python3 from python.org in MacOS by running a script?

Please... the idea is to make Sage installation easier, not harder.


---

Comment by mkoeppe created at 2020-03-28 15:45:09

One often runs into these certificate errors also with random Linux images when I run them on Docker. So this workaround is valuable for the automatic testing in any case.


---

Comment by mkoeppe created at 2020-03-28 16:05:16

Testing this at https://github.com/mkoeppe/sage/actions/runs/65346154
----
New commits:


---

Comment by dimpase created at 2020-03-28 16:11:37

Replying to [comment:8 mkoeppe]:
> Replying to [comment:6 dimpase]:
> > that's why I suggested not to bother with MacOS/Xcode's python(3).
> > Can't one get Python3 from python.org in MacOS by running a script?
> 
> Please... the idea is to make Sage installation easier, not harder.

well, it seems that using system's python would make a slighly cryptographically
broken Sagemath, one way or another.


---

Comment by mkoeppe created at 2020-03-28 16:15:38

Replying to [comment:12 dimpase]:
> well, it seems that using system's python would make a slighly cryptographically
> broken Sagemath, one way or another.

That's not a regression from the current status on macOS, see #29291 for example


---

Comment by mkoeppe created at 2020-03-28 17:24:32

And, of course, the present ticket is about `sage-system-python`, which is only used for bootstrapping and build. Unrelated to the use of a system python3 for venv (#27824), which has a completely separate test for what it accepts.


---

Comment by dimpase created at 2020-03-28 17:29:57

oy gevalt, pythons everywhere!


---

Comment by mkoeppe created at 2020-03-28 17:33:14

Replying to [comment:15 dimpase]:
> oy gevalt, pythons everywhere!
This will be addressed in #45678 "switch Sage from Python to Julia"


---

Comment by git created at 2020-03-29 14:53:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-29 14:54:00

Rebased, needs review


---

Comment by jhpalmieri created at 2020-04-08 20:32:58

Okay, I'm really confused, or my Sage installation is broken, or both. If I use `./sage -i beautifulsoup4` with a build using the system Python on OS X, it fails, but not because of the issues here. Instead, I see this:

```
make[2]: *** No rule to make target `/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/SYSTEM/sage-9.1.beta9/local/var/lib/sage/installed/beautifulsoup4-none', needed by `all-sage'.  Stop.
```

If instead I run `make beautifulsoup4`, it succeeds. When I ran `./sage -i tornado` it didn't seem to even try to install it, but `./sage -f tornado` worked.

So: why does `./sage -i ...` not work? And what is the point of this ticket: what problem does it solve?


---

Comment by mkoeppe created at 2020-04-08 21:04:18

`sage -i` was changed in #29113 -- unrelated to the present ticket


---

Comment by mkoeppe created at 2020-04-08 21:05:50

Could you try if the problem goes away if you run `bootstrap`?


---

Comment by jhpalmieri created at 2020-04-08 21:33:30

If I run `bootstrap`, then running `./sage -i benzene` acts like `./sage -i tornado`: it doesn't install. There is a message

```
running ./configure '--enable-beautifulsoup4' '--enable-biopython'  '--enable-benzene'
```

and then if I search my terminal window for `benzene`, the only other hit is

```
benzene-20130630:                            does not support check for system package; optional, use "./configure --enable-benzene" to install
```


I don't think I tested #29113 well enough when I was reviewing it.


---

Comment by jhpalmieri created at 2020-04-08 21:36:06

This fixes it for me:

```diff
diff --git a/src/bin/sage b/src/bin/sage
index 10acddcd96..6ccff3789c 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -404,7 +404,7 @@ if [ "$1" = '-i' ]; then
         #   'CC=gcc -Wall' '--enable-e_antic'
         CONFIG_CMD="./configure $(./config.status --config) $ENABLE_ARGS"
         echo >&2 "running $CONFIG_CMD"
-        bash -c "$CONFIG_CMD" && $MAKE all-build
+        bash -c "$CONFIG_CMD" && $MAKE $PACKAGES
     else
         echo "New packages may have been installed."
         echo "Re-running configure and make in case any dependent packages need updating."
```

(or maybe it could be `$MAKE all-build $PACKAGES`?)

By the way, I still don't understand the goal of this ticket.


---

Comment by mkoeppe created at 2020-04-08 23:24:02

Let's please take the issues with `sage -i` to the new ticket #29481. Thanks for catching this.


---

Comment by mkoeppe created at 2020-04-08 23:37:11

Replying to [comment:28 jhpalmieri]:
> By the way, I still don't understand the goal of this ticket.

Reworked the ticket description, please take a look


---

Comment by jhpalmieri created at 2020-04-09 03:08:01

Replying to [comment:31 mkoeppe]:
> Replying to [comment:28 jhpalmieri]:
> > By the way, I still don't understand the goal of this ticket.
> 
> Reworked the ticket description, please take a look

Sorry, I wasn't clear enough. What system configuration and commands lead to the problem in the description? I can't reproduce the problem, so I can't tell if the solution here works.


---

Comment by @kliem created at 2020-04-09 08:00:51

From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.

Do you have successfully tested this ticket?

Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)

Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?


---

Comment by mkoeppe created at 2020-04-09 15:37:06

Replying to [comment:33 gh-kliem]:
> From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.

That's a correct description for macOS. But the problem also appears on Linux distributions if one does not install ca-certificates, or those are outdated.

> Do you have successfully tested this ticket?

Yes, I have been using this as part of #29417 since end of March. 

> Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)

That's correct for the macOS tests using `tox local`. For the Linux tests with `tox docker` note that `/upstream` is in `.gitignore` (therefore in `.dockerignore`) and is therefore not provided to the container.

> Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?

That's right, normal users would not use the `upstream_url` at all; it is a feature for developers only.


---

Comment by @kliem created at 2020-04-09 15:46:14

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-04-09 15:46:14

LGTM.

Btw, I have been using this ticket to test my tickets, e.g. here: https://github.com/kliem/sage-test-27122/actions/runs/72102779


---

Comment by mkoeppe created at 2020-04-09 15:47:27

Thank you!


---

Comment by vbraun created at 2020-04-12 15:34:25

Resolution: fixed


---

Comment by mkoeppe created at 2020-11-23 02:03:56

Follow up: #30950
