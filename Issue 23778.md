# Issue 23778: fix libhomfly building on OSX

archive/issues_023778.json:
```json
{
    "body": "CC:  @embray @miguelmarco\n\nas reported on [sage-devel https://groups.google.com/d/msg/sage-devel/bOG0Xg2HmvU/m1DsYpFwAQAJ] linking on OSX fails with \"duplicate symbol\" errors.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24015\n\n",
    "created_at": "2017-10-11T22:25:30Z",
    "labels": [
        "packages: optional",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "fix libhomfly building on OSX",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23778",
    "user": "@dimpase"
}
```
CC:  @embray @miguelmarco

as reported on [sage-devel https://groups.google.com/d/msg/sage-devel/bOG0Xg2HmvU/m1DsYpFwAQAJ] linking on OSX fails with "duplicate symbol" errors.

Issue created by migration from https://trac.sagemath.org/ticket/24015





---

archive/issue_comments_333113.json:
```json
{
    "body": "I have a fix for the C code madness, now onto some cython trouble, hopefully minor:\n\n```\nsage -t --warn-long 231.9 src/sage/libs/homfly.pyx\n**********************************************************************\nFile \"src/sage/libs/homfly.pyx\", line 65, in sage.libs.homfly.homfly_polynomial_string\nFailed example:\n    from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly\nException raised:\n    Traceback (most recent call last):\n      File \"/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.homfly.homfly_polynomial_string[0]>\", line 1, in <module>\n        from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly\n    ImportError: dlopen(/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/libs/homfly.so, 2): Symbol not found: _fmemopen\n      Referenced from: /Volumes/Sage/sage/local/lib/libhomfly.0.dylib\n      Expected in: flat namespace\n     in /Volumes/Sage/sage/local/lib/libhomfly.0.dylib\n**********************************************************************\n```\n",
    "created_at": "2017-10-12T09:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333113",
    "user": "@dimpase"
}
```

I have a fix for the C code madness, now onto some cython trouble, hopefully minor:

```
sage -t --warn-long 231.9 src/sage/libs/homfly.pyx
**********************************************************************
File "src/sage/libs/homfly.pyx", line 65, in sage.libs.homfly.homfly_polynomial_string
Failed example:
    from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly
Exception raised:
    Traceback (most recent call last):
      File "/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.homfly.homfly_polynomial_string[0]>", line 1, in <module>
        from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly
    ImportError: dlopen(/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/libs/homfly.so, 2): Symbol not found: _fmemopen
      Referenced from: /Volumes/Sage/sage/local/lib/libhomfly.0.dylib
      Expected in: flat namespace
     in /Volumes/Sage/sage/local/lib/libhomfly.0.dylib
**********************************************************************
```




---

archive/issue_comments_333114.json:
```json
{
    "body": "duh, there is no `fmemopen` on OSX, as simple as this...",
    "created_at": "2017-10-12T09:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333114",
    "user": "@dimpase"
}
```

duh, there is no `fmemopen` on OSX, as simple as this...



---

archive/issue_comments_333115.json:
```json
{
    "body": "C changes proposed to upstream: https://github.com/miguelmarco/libhomfly/pull/8",
    "created_at": "2017-10-12T09:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333115",
    "user": "@dimpase"
}
```

C changes proposed to upstream: https://github.com/miguelmarco/libhomfly/pull/8



---

archive/issue_comments_333116.json:
```json
{
    "body": "still, for OSX we need to update GC to a very recent version, see https://github.com/miguelmarco/libhomfly/pull/8 for details.",
    "created_at": "2017-10-20T18:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333116",
    "user": "@dimpase"
}
```

still, for OSX we need to update GC to a very recent version, see https://github.com/miguelmarco/libhomfly/pull/8 for details.



---

archive/issue_comments_333117.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-06T09:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333117",
    "user": "@dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_333118.json:
```json
{
    "body": "the last remaining problem was the lack of `GC_INIT()` call in the library (something that is apparently not needed on Linux, but the docs\nsay that that some platforms might need it...)\n\nWith https://github.com/miguelmarco/libhomfly/pull/11\nit is all fixed, also on the current Sage's GC version on OSX.\n----\nNew commits:",
    "created_at": "2017-12-06T09:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333118",
    "user": "@dimpase"
}
```

the last remaining problem was the lack of `GC_INIT()` call in the library (something that is apparently not needed on Linux, but the docs
say that that some platforms might need it...)

With https://github.com/miguelmarco/libhomfly/pull/11
it is all fixed, also on the current Sage's GC version on OSX.
----
New commits:



---

archive/issue_comments_333119.json:
```json
{
    "body": "NB: the tarball is just a proof of concept, corresponding to commit b68b5b2aac2e89b17312208080562f5754d3da2d\non https://github.com/dimpase/libhomfly\n\nOnce the upstream is done with merging, we should get the official tarball...",
    "created_at": "2017-12-06T09:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333119",
    "user": "@dimpase"
}
```

NB: the tarball is just a proof of concept, corresponding to commit b68b5b2aac2e89b17312208080562f5754d3da2d
on https://github.com/dimpase/libhomfly

Once the upstream is done with merging, we should get the official tarball...



---

archive/issue_comments_333120.json:
```json
{
    "body": "I made a new release upstream. It is https://github.com/miguelmarco/libhomfly/releases/tag/1.02r4\n\nThe tarball is at\nhttps://github.com/miguelmarco/libhomfly/archive/1.02r4.tar.gz",
    "created_at": "2017-12-06T11:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333120",
    "user": "@miguelmarco"
}
```

I made a new release upstream. It is https://github.com/miguelmarco/libhomfly/releases/tag/1.02r4

The tarball is at
https://github.com/miguelmarco/libhomfly/archive/1.02r4.tar.gz



---

archive/issue_comments_333121.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-06T12:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333121",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_333122.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-06T12:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333122",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_333123.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-06T12:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333123",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_333124.json:
```json
{
    "body": "I had to update the tarball from github by running `autoreconf -if` and re-tarring then.\n\nShould all be ready now.",
    "created_at": "2017-12-06T12:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333124",
    "user": "@dimpase"
}
```

I had to update the tarball from github by running `autoreconf -if` and re-tarring then.

Should all be ready now.



---

archive/issue_comments_333125.json:
```json
{
    "body": "One little detail about `GC_INIT()`: it is not needed on the current Boehm GC master at https://github.com/ivmai/bdwgc, but is needed on few releases (7.4 and 7.6), as well as on the current Sage's version of GC.\n\nNo it builds with `SAGE_CHECK=yes`, and all the relevant Sage tests pass, too, on OSX 10.12 as well as on Linux.",
    "created_at": "2017-12-06T17:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333125",
    "user": "@dimpase"
}
```

One little detail about `GC_INIT()`: it is not needed on the current Boehm GC master at https://github.com/ivmai/bdwgc, but is needed on few releases (7.4 and 7.6), as well as on the current Sage's version of GC.

No it builds with `SAGE_CHECK=yes`, and all the relevant Sage tests pass, too, on OSX 10.12 as well as on Linux.



---

archive/issue_comments_333126.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-07T17:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333126",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_333127.json:
```json
{
    "body": "OK, so now even the tarball is official!",
    "created_at": "2017-12-07T17:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333127",
    "user": "@dimpase"
}
```

OK, so now even the tarball is official!



---

archive/issue_comments_333128.json:
```json
{
    "body": "I think we need a menu choice saying \"Fixes fully merged in the current upstream release\". :-)",
    "created_at": "2017-12-07T17:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333128",
    "user": "@dimpase"
}
```

I think we need a menu choice saying "Fixes fully merged in the current upstream release". :-)



---

archive/issue_comments_333129.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-08T16:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333129",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_333130.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23778#issuecomment-333130",
    "user": "@vbraun"
}
```

Resolution: fixed
