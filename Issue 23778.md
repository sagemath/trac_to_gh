# Issue 23778: fix libhomfly building on OSX

Issue created by migration from https://trac.sagemath.org/ticket/24015

Original creator: dimpase

Original creation time: 2017-10-11 22:25:30

CC:  embray mmarco

as reported on [sage-devel https://groups.google.com/d/msg/sage-devel/bOG0Xg2HmvU/m1DsYpFwAQAJ] linking on OSX fails with "duplicate symbol" errors.


---

Comment by dimpase created at 2017-10-12 09:18:45

I have a fix for the C code madness, now onto some cython trouble, hopefully minor:

```
sage -t --warn-long 231.9 src/sage/libs/homfly.pyx
**********************************************************************
File "src/sage/libs/homfly.pyx", line 65, in sage.libs.homfly.homfly_polynomial_string
Failed example:
    from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly
Exception raised:
    Traceback (most recent call last):
      File "/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.homfly.homfly_polynomial_string[0]>", line 1, in <module>
        from sage.libs.homfly import homfly_polynomial_string # optional - libhomfly
    ImportError: dlopen(/Volumes/Sage/sage/local/lib/python2.7/site-packages/sage/libs/homfly.so, 2): Symbol not found: _fmemopen
      Referenced from: /Volumes/Sage/sage/local/lib/libhomfly.0.dylib
      Expected in: flat namespace
     in /Volumes/Sage/sage/local/lib/libhomfly.0.dylib
**********************************************************************
```



---

Comment by dimpase created at 2017-10-12 09:30:33

duh, there is no `fmemopen` on OSX, as simple as this...


---

Comment by dimpase created at 2017-10-12 09:54:12

C changes proposed to upstream: https://github.com/miguelmarco/libhomfly/pull/8


---

Comment by dimpase created at 2017-10-20 18:31:38

still, for OSX we need to update GC to a very recent version, see https://github.com/miguelmarco/libhomfly/pull/8 for details.


---

Comment by dimpase created at 2017-12-06 09:50:36

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-12-06 09:50:36

the last remaining problem was the lack of `GC_INIT()` call in the library (something that is apparently not needed on Linux, but the docs
say that that some platforms might need it...)

With https://github.com/miguelmarco/libhomfly/pull/11
it is all fixed, also on the current Sage's GC version on OSX.
----
New commits:


---

Comment by dimpase created at 2017-12-06 09:54:15

NB: the tarball is just a proof of concept, corresponding to commit b68b5b2aac2e89b17312208080562f5754d3da2d
on https://github.com/dimpase/libhomfly

Once the upstream is done with merging, we should get the official tarball...


---

Comment by mmarco created at 2017-12-06 11:21:06

I made a new release upstream. It is https://github.com/miguelmarco/libhomfly/releases/tag/1.02r4

The tarball is at
https://github.com/miguelmarco/libhomfly/archive/1.02r4.tar.gz


---

Comment by git created at 2017-12-06 12:02:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-06 12:23:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-06 12:43:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-12-06 12:53:49

I had to update the tarball from github by running `autoreconf -if` and re-tarring then.

Should all be ready now.


---

Comment by dimpase created at 2017-12-06 17:48:43

One little detail about `GC_INIT()`: it is not needed on the current Boehm GC master at https://github.com/ivmai/bdwgc, but is needed on few releases (7.4 and 7.6), as well as on the current Sage's version of GC.

No it builds with `SAGE_CHECK=yes`, and all the relevant Sage tests pass, too, on OSX 10.12 as well as on Linux.


---

Comment by git created at 2017-12-07 17:03:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-12-07 17:06:10

OK, so now even the tarball is official!


---

Comment by dimpase created at 2017-12-07 17:07:57

I think we need a menu choice saying "Fixes fully merged in the current upstream release". :-)


---

Comment by jdemeyer created at 2017-12-08 16:12:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-11 01:02:54

Resolution: fixed
