# Issue 21452: OpenBLAS build failures involving Fortran library

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-10-12 08:03:49

CC:  slabbe fbissey

While building `openblas-0.2.19`:

```
gcc -O2 -DUTEST_CHECK -DSANITY_CHECK -DREFNAME=f_ -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DSMP_SERVER -DNO_WARMUP -DMAX_CPU_NUMBER=4 -DASMNAME= -DASMFNAME=_ -DNAME=_ -DCNAME= -DCHAR_NAME=\"_\" -DCHAR_CNAME=\"\" -DNO_AFFINITY -I.. -o openblas_utest utest_main.o test_amax.o test_potrs.o ../libopenblas_haswellp-r0.2.19.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran -L/home/labbe/Applications/sage-git/local/lib/../lib64 -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3 -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../../../lib64 -L/lib/x86_64-linux-gnu -L/lib/../lib64 -L/usr/lib/x86_64-linux-gnu -L/home/labbe/Applications/sage-git/local/lib -L/usr/lib/x86_64-linux-gnu -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../..  -lgfortran -lm -lquadmath -lm -lc 
./openblas_utest
./openblas_utest: error while loading shared libraries: libgfortran.so.3: cannot open shared object file: No such file or directory
```



---

Comment by fbissey created at 2016-10-12 08:12:48

The building of openblas_utest doesn't use `LDFLAGS`:

```
Mirage:OpenBLAS-0.2.19 fbissey$ more utest/Makefile 
UTEST_CHECK = 1
TOPDIR  = ..

UTESTBIN=openblas_utest

.PHONY : all
.NOTPARALLEL : all run_test $(UTESTBIN)

include $(TOPDIR)/Makefile.system

OBJS=utest_main.o test_amax.o
#test_rot.o test_swap.o test_axpy.o test_dotu.o test_rotmg.o test_dsdot.o test_fork.o

ifneq ($(NO_LAPACK), 1)
OBJS += test_potrs.o
endif

all : run_test

$(UTESTBIN): $(OBJS)
        $(CC) $(CFLAGS) -o $`@` $^ ../$(LIBNAME) $(EXTRALIB) $(FEXTRALIB)

run_test: $(UTESTBIN)
ifndef CROSS
        ./$(UTESTBIN)
endif

clean:
        -rm -f *.o $(UTESTBIN)

libs:
```



---

Comment by fbissey created at 2016-10-12 10:19:55

Will report upstream once we are sure that it fixes the problem at hand.
----
New commits:


---

Comment by fbissey created at 2016-10-12 10:20:27

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-12 10:22:58

This should obviously be reported upstream.


---

Comment by fbissey created at 2016-10-12 10:30:31

Replying to [comment:5 jdemeyer]:
> This should obviously be reported upstream.

Agreed, but I was thinking of going for a PR directly if my fix is correct. Feel free to open an issue now.


---

Comment by slabbe created at 2016-10-12 12:06:16

The branch fixes the problem I reported:


```
$ make openblas
...
[openblas-0.2.19]  OpenBLAS build complete. (BLAS CBLAS LAPACK LAPACKE)
[openblas-0.2.19] 
[openblas-0.2.19]   OS               ... Linux             
[openblas-0.2.19]   Architecture     ... x86_64               
[openblas-0.2.19]   BINARY           ... 64bit                 
[openblas-0.2.19]   C compiler       ... GCC  (command line : gcc)
[openblas-0.2.19]   Fortran compiler ... GFORTRAN  (command line : gfortran)
[openblas-0.2.19]   Library Name     ... libopenblas_haswellp-r0.2.19.a (Multi threaded; Max num-threads is 4)
[openblas-0.2.19] 
...
[openblas-0.2.19] Install OK!
[openblas-0.2.19] make[3]: Leaving directory '/home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19/src'
[openblas-0.2.19] make[2]: Leaving directory '/home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19/src'
[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/blas.pc
[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/cblas.pc
[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/lapack.pc
[openblas-0.2.19] 
[openblas-0.2.19] real	0m46.560s
[openblas-0.2.19] user	1m6.396s
[openblas-0.2.19] sys	0m11.796s
[openblas-0.2.19] Successfully installed openblas-0.2.19
[openblas-0.2.19] Deleting temporary build directory
[openblas-0.2.19] /home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19
[openblas-0.2.19] Finished installing openblas-0.2.19.spkg
make[1] : on quitte le répertoire « /home/labbe/Applications/sage-git/build/make »

real	0m50.723s
user	1m8.428s
sys	0m12.664s
Sage build/upgrade complete!
```


Thanks for the quick fix! To me it is a positive review.

Should I change the status to positive review now, or do you want to wait to check with upstream first?


---

Comment by jdemeyer created at 2016-10-12 12:12:24

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-10-12 12:12:24

Replying to [comment:3 fbissey]:
> Will report upstream once we are sure that it fixes the problem at hand.

Great, please do that.


---

Comment by vbraun created at 2016-10-15 10:25:19

Resolution: fixed
