# Issue 21452: OpenBLAS build failures involving Fortran library

archive/issues_021452.json:
```json
{
    "body": "CC:  @seblabbe @kiwifb\n\nWhile building `openblas-0.2.19`:\n\n```\ngcc -O2 -DUTEST_CHECK -DSANITY_CHECK -DREFNAME=f_ -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DSMP_SERVER -DNO_WARMUP -DMAX_CPU_NUMBER=4 -DASMNAME= -DASMFNAME=_ -DNAME=_ -DCNAME= -DCHAR_NAME=\\\"_\\\" -DCHAR_CNAME=\\\"\\\" -DNO_AFFINITY -I.. -o openblas_utest utest_main.o test_amax.o test_potrs.o ../libopenblas_haswellp-r0.2.19.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran -L/home/labbe/Applications/sage-git/local/lib/../lib64 -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3 -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../../../lib64 -L/lib/x86_64-linux-gnu -L/lib/../lib64 -L/usr/lib/x86_64-linux-gnu -L/home/labbe/Applications/sage-git/local/lib -L/usr/lib/x86_64-linux-gnu -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../..  -lgfortran -lm -lquadmath -lm -lc \n./openblas_utest\n./openblas_utest: error while loading shared libraries: libgfortran.so.3: cannot open shared object file: No such file or directory\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21689\n\n",
    "created_at": "2016-10-12T08:03:49Z",
    "labels": [
        "packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "OpenBLAS build failures involving Fortran library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21452",
    "user": "@jdemeyer"
}
```
CC:  @seblabbe @kiwifb

While building `openblas-0.2.19`:

```
gcc -O2 -DUTEST_CHECK -DSANITY_CHECK -DREFNAME=f_ -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DSMP_SERVER -DNO_WARMUP -DMAX_CPU_NUMBER=4 -DASMNAME= -DASMFNAME=_ -DNAME=_ -DCNAME= -DCHAR_NAME=\"_\" -DCHAR_CNAME=\"\" -DNO_AFFINITY -I.. -o openblas_utest utest_main.o test_amax.o test_potrs.o ../libopenblas_haswellp-r0.2.19.a -lm -lpthread -lgfortran -lm -lpthread -lgfortran -L/home/labbe/Applications/sage-git/local/lib/../lib64 -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3 -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../../../lib64 -L/lib/x86_64-linux-gnu -L/lib/../lib64 -L/usr/lib/x86_64-linux-gnu -L/home/labbe/Applications/sage-git/local/lib -L/usr/lib/x86_64-linux-gnu -L/home/labbe/Applications/sage-git/local/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../..  -lgfortran -lm -lquadmath -lm -lc 
./openblas_utest
./openblas_utest: error while loading shared libraries: libgfortran.so.3: cannot open shared object file: No such file or directory
```


Issue created by migration from https://trac.sagemath.org/ticket/21689





---

archive/issue_comments_297754.json:
```json
{
    "body": "The building of openblas_utest doesn't use `LDFLAGS`:\n\n```\nMirage:OpenBLAS-0.2.19 fbissey$ more utest/Makefile \nUTEST_CHECK = 1\nTOPDIR  = ..\n\nUTESTBIN=openblas_utest\n\n.PHONY : all\n.NOTPARALLEL : all run_test $(UTESTBIN)\n\ninclude $(TOPDIR)/Makefile.system\n\nOBJS=utest_main.o test_amax.o\n#test_rot.o test_swap.o test_axpy.o test_dotu.o test_rotmg.o test_dsdot.o test_fork.o\n\nifneq ($(NO_LAPACK), 1)\nOBJS += test_potrs.o\nendif\n\nall : run_test\n\n$(UTESTBIN): $(OBJS)\n        $(CC) $(CFLAGS) -o $@ $^ ../$(LIBNAME) $(EXTRALIB) $(FEXTRALIB)\n\nrun_test: $(UTESTBIN)\nifndef CROSS\n        ./$(UTESTBIN)\nendif\n\nclean:\n        -rm -f *.o $(UTESTBIN)\n\nlibs:\n```\n",
    "created_at": "2016-10-12T08:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297754",
    "user": "@kiwifb"
}
```

The building of openblas_utest doesn't use `LDFLAGS`:

```
Mirage:OpenBLAS-0.2.19 fbissey$ more utest/Makefile 
UTEST_CHECK = 1
TOPDIR  = ..

UTESTBIN=openblas_utest

.PHONY : all
.NOTPARALLEL : all run_test $(UTESTBIN)

include $(TOPDIR)/Makefile.system

OBJS=utest_main.o test_amax.o
#test_rot.o test_swap.o test_axpy.o test_dotu.o test_rotmg.o test_dsdot.o test_fork.o

ifneq ($(NO_LAPACK), 1)
OBJS += test_potrs.o
endif

all : run_test

$(UTESTBIN): $(OBJS)
        $(CC) $(CFLAGS) -o $@ $^ ../$(LIBNAME) $(EXTRALIB) $(FEXTRALIB)

run_test: $(UTESTBIN)
ifndef CROSS
        ./$(UTESTBIN)
endif

clean:
        -rm -f *.o $(UTESTBIN)

libs:
```




---

archive/issue_comments_297755.json:
```json
{
    "body": "Will report upstream once we are sure that it fixes the problem at hand.\n----\nNew commits:",
    "created_at": "2016-10-12T10:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297755",
    "user": "@kiwifb"
}
```

Will report upstream once we are sure that it fixes the problem at hand.
----
New commits:



---

archive/issue_comments_297756.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-12T10:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297756",
    "user": "@kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_297757.json:
```json
{
    "body": "This should obviously be reported upstream.",
    "created_at": "2016-10-12T10:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297757",
    "user": "@jdemeyer"
}
```

This should obviously be reported upstream.



---

archive/issue_comments_297758.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> This should obviously be reported upstream.\n\nAgreed, but I was thinking of going for a PR directly if my fix is correct. Feel free to open an issue now.",
    "created_at": "2016-10-12T10:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297758",
    "user": "@kiwifb"
}
```

Replying to [comment:5 jdemeyer]:
> This should obviously be reported upstream.

Agreed, but I was thinking of going for a PR directly if my fix is correct. Feel free to open an issue now.



---

archive/issue_comments_297759.json:
```json
{
    "body": "The branch fixes the problem I reported:\n\n\n```\n$ make openblas\n...\n[openblas-0.2.19]  OpenBLAS build complete. (BLAS CBLAS LAPACK LAPACKE)\n[openblas-0.2.19] \n[openblas-0.2.19]   OS               ... Linux             \n[openblas-0.2.19]   Architecture     ... x86_64               \n[openblas-0.2.19]   BINARY           ... 64bit                 \n[openblas-0.2.19]   C compiler       ... GCC  (command line : gcc)\n[openblas-0.2.19]   Fortran compiler ... GFORTRAN  (command line : gfortran)\n[openblas-0.2.19]   Library Name     ... libopenblas_haswellp-r0.2.19.a (Multi threaded; Max num-threads is 4)\n[openblas-0.2.19] \n...\n[openblas-0.2.19] Install OK!\n[openblas-0.2.19] make[3]: Leaving directory '/home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19/src'\n[openblas-0.2.19] make[2]: Leaving directory '/home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19/src'\n[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/blas.pc\n[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/cblas.pc\n[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/lapack.pc\n[openblas-0.2.19] \n[openblas-0.2.19] real\t0m46.560s\n[openblas-0.2.19] user\t1m6.396s\n[openblas-0.2.19] sys\t0m11.796s\n[openblas-0.2.19] Successfully installed openblas-0.2.19\n[openblas-0.2.19] Deleting temporary build directory\n[openblas-0.2.19] /home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19\n[openblas-0.2.19] Finished installing openblas-0.2.19.spkg\nmake[1]\u00a0: on quitte le r\u00e9pertoire \u00ab\u00a0/home/labbe/Applications/sage-git/build/make\u00a0\u00bb\n\nreal\t0m50.723s\nuser\t1m8.428s\nsys\t0m12.664s\nSage build/upgrade complete!\n```\n\n\nThanks for the quick fix! To me it is a positive review.\n\nShould I change the status to positive review now, or do you want to wait to check with upstream first?",
    "created_at": "2016-10-12T12:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297759",
    "user": "@seblabbe"
}
```

The branch fixes the problem I reported:


```
$ make openblas
...
[openblas-0.2.19]  OpenBLAS build complete. (BLAS CBLAS LAPACK LAPACKE)
[openblas-0.2.19] 
[openblas-0.2.19]   OS               ... Linux             
[openblas-0.2.19]   Architecture     ... x86_64               
[openblas-0.2.19]   BINARY           ... 64bit                 
[openblas-0.2.19]   C compiler       ... GCC  (command line : gcc)
[openblas-0.2.19]   Fortran compiler ... GFORTRAN  (command line : gfortran)
[openblas-0.2.19]   Library Name     ... libopenblas_haswellp-r0.2.19.a (Multi threaded; Max num-threads is 4)
[openblas-0.2.19] 
...
[openblas-0.2.19] Install OK!
[openblas-0.2.19] make[3]: Leaving directory '/home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19/src'
[openblas-0.2.19] make[2]: Leaving directory '/home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19/src'
[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/blas.pc
[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/cblas.pc
[openblas-0.2.19] Wrote /home/labbe/Applications/sage-git/local/lib/pkgconfig/lapack.pc
[openblas-0.2.19] 
[openblas-0.2.19] real	0m46.560s
[openblas-0.2.19] user	1m6.396s
[openblas-0.2.19] sys	0m11.796s
[openblas-0.2.19] Successfully installed openblas-0.2.19
[openblas-0.2.19] Deleting temporary build directory
[openblas-0.2.19] /home/labbe/Applications/sage-git/local/var/tmp/sage/build/openblas-0.2.19
[openblas-0.2.19] Finished installing openblas-0.2.19.spkg
make[1] : on quitte le répertoire « /home/labbe/Applications/sage-git/build/make »

real	0m50.723s
user	1m8.428s
sys	0m12.664s
Sage build/upgrade complete!
```


Thanks for the quick fix! To me it is a positive review.

Should I change the status to positive review now, or do you want to wait to check with upstream first?



---

archive/issue_comments_297760.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-12T12:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297760",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_297761.json:
```json
{
    "body": "Replying to [comment:3 fbissey]:\n> Will report upstream once we are sure that it fixes the problem at hand.\n\nGreat, please do that.",
    "created_at": "2016-10-12T12:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297761",
    "user": "@jdemeyer"
}
```

Replying to [comment:3 fbissey]:
> Will report upstream once we are sure that it fixes the problem at hand.

Great, please do that.



---

archive/issue_comments_297762.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-15T10:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21452#issuecomment-297762",
    "user": "@vbraun"
}
```

Resolution: fixed
