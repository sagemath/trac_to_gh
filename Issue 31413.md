# Issue 31413: improve LazyImport

Issue created by migration from https://trac.sagemath.org/ticket/31650

Original creator: vdelecroix

Original creation time: 2021-04-11 11:23:25

CC:  @kliem

The `LazyImport` objects suffer several problems

1. `copy` and `deepcopy` are broken

```
sage: from sage.misc.lazy_import import LazyImport
sage: sage.all.foo = [1, 2]
sage: lazy_foo = LazyImport('sage.all', 'foo')
sage: a = copy(lazy_foo)
sage: a
[1, 2]
sage: a[0] = 18
sage: a
[18, 2]
```


2. Most doctests use `lazy_import` rather than `LazyImport`. The former modifies the namespace so that the name actually points to the object afterwards. Compare

```
sage: lazy_import('sage.rings.all', 'ZZ', 'lazy_ZZ')
sage: type(lazy_ZZ)
<class 'sage.misc.lazy_import.LazyImport'>
sage: _ = lazy_ZZ(3)
sage: type(lazy_ZZ)
<class 'sage.rings.integer_ring.IntegerRing_class'>
```

    with

```
sage: from sage.misc.lazy_import import LazyImport
sage: lazy_ZZ = LazyImport('sage.rings.all', 'ZZ')
sage: _ = lazy_ZZ(3)
3
sage: type(lazy_ZZ)
<class 'sage.misc.lazy_import.LazyImport'>
```

    In the former version, any code that uses more than once the lazy object actually uses it only once.

3. Calling `__module__` triggers `get_object` whereas we could return what is contained in the `_module` attribute. This would solve #31643 but it is likely to be a bad idea as the module from which an object is imported is not necessarily the module in which it is defined.


---

Comment by vdelecroix created at 2021-04-11 12:11:50

Changing type from PLEASE CHANGE to defect.


---

Comment by vdelecroix created at 2021-04-11 19:47:49

Changing type from defect to enhancement.


---

Comment by vdelecroix created at 2021-04-11 19:47:49

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2021-04-11 19:47:49

New commits:


---

Comment by vdelecroix created at 2021-04-11 19:47:49

Changing component from PLEASE CHANGE to misc.


---

Comment by mkoeppe created at 2021-04-11 22:02:31

See also: #22793, #20626


---

Comment by tscrim created at 2021-04-16 00:07:13

I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.

Also, I don't understand what point 2 is trying to make.


---

Comment by vdelecroix created at 2021-04-16 06:23:47

Replying to [comment:9 tscrim]:
> I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.

They don't need to. It is just more condensed.

What do you mean by traceback? I don't understand your point.

> Also, I don't understand what point 2 is trying to make.

That the following doctest was not testing `LazyImport`

```
sage: lazy_import('sage.all', 'foo')
sage: type(foo)
<type 'sage.misc.lazy_import.LazyImport'>
sage: del foo[1]  # still lazy
sage: print(foo)  # not lazy anymore
```

I agree that this was not a problem in the doctests.


---

Comment by nbruin created at 2021-04-18 07:58:21

See also #16522 for improvements of the use of lazy_import rather than improving the tool itself.


---

Comment by tscrim created at 2021-04-19 00:16:03

Replying to [comment:10 vdelecroix]:
> Replying to [comment:9 tscrim]:
> > I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.
> 
> They don't need to. It is just more condensed.

However, they output too much when they do fail (see below), they obscure (very) slightly that the test should be `True`, and the `assert` tests could (in principle) be disabled as they are meant for serious errors during debugging.

> What do you mean by traceback? I don't understand your point.

You get something like this:

```
File "partition.py", line 7, in sage.combinat.partition
Failed example:
    assert False
Exception raised:
    Traceback (most recent call last):
      File "/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.partition[0]>", line 1, in <module>
        assert False
    AssertionError
```

which is a lot of noise for something that is not `True`.
(I just add this to the start of `partition.py`:

```
EXAMPLES::

    sage: assert False
```


Because of these points, I think they should follow the standard doctest practice of checking against output.

> > Also, I don't understand what point 2 is trying to make.
> 
> That the following doctest was not testing `LazyImport`
> {{{
> sage: lazy_import('sage.all', 'foo')
> sage: type(foo)
> <type 'sage.misc.lazy_import.LazyImport'>
> sage: del foo[1]  # still lazy
> sage: print(foo)  # not lazy anymore
> }}}
> I agree that this was not a problem in the doctests.

I see. Thank you for the explanation.


---

Comment by tscrim created at 2021-04-19 00:16:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-04-20 18:34:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-04-20 18:34:32

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-04-21 06:30:49

Thank you. LGTM.


---

Comment by tscrim created at 2021-04-21 06:30:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-06-06 13:18:12

Resolution: fixed
