# Issue 31413: improve LazyImport

archive/issues_031413.json:
```json
{
    "body": "CC:  @kliem\n\nThe `LazyImport` objects suffer several problems\n\n1. `copy` and `deepcopy` are broken\n\n```\nsage: from sage.misc.lazy_import import LazyImport\nsage: sage.all.foo = [1, 2]\nsage: lazy_foo = LazyImport('sage.all', 'foo')\nsage: a = copy(lazy_foo)\nsage: a\n[1, 2]\nsage: a[0] = 18\nsage: a\n[18, 2]\n```\n\n\n2. Most doctests use `lazy_import` rather than `LazyImport`. The former modifies the namespace so that the name actually points to the object afterwards. Compare\n\n```\nsage: lazy_import('sage.rings.all', 'ZZ', 'lazy_ZZ')\nsage: type(lazy_ZZ)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: _ = lazy_ZZ(3)\nsage: type(lazy_ZZ)\n<class 'sage.rings.integer_ring.IntegerRing_class'>\n```\n\n    with\n\n```\nsage: from sage.misc.lazy_import import LazyImport\nsage: lazy_ZZ = LazyImport('sage.rings.all', 'ZZ')\nsage: _ = lazy_ZZ(3)\n3\nsage: type(lazy_ZZ)\n<class 'sage.misc.lazy_import.LazyImport'>\n```\n\n    In the former version, any code that uses more than once the lazy object actually uses it only once.\n\n3. Calling `__module__` triggers `get_object` whereas we could return what is contained in the `_module` attribute. This would solve #31643 but it is likely to be a bad idea as the module from which an object is imported is not necessarily the module in which it is defined.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31650\n\n",
    "created_at": "2021-04-11T11:23:25Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "improve LazyImport",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31413",
    "user": "vdelecroix"
}
```
CC:  @kliem

The `LazyImport` objects suffer several problems

1. `copy` and `deepcopy` are broken

```
sage: from sage.misc.lazy_import import LazyImport
sage: sage.all.foo = [1, 2]
sage: lazy_foo = LazyImport('sage.all', 'foo')
sage: a = copy(lazy_foo)
sage: a
[1, 2]
sage: a[0] = 18
sage: a
[18, 2]
```


2. Most doctests use `lazy_import` rather than `LazyImport`. The former modifies the namespace so that the name actually points to the object afterwards. Compare

```
sage: lazy_import('sage.rings.all', 'ZZ', 'lazy_ZZ')
sage: type(lazy_ZZ)
<class 'sage.misc.lazy_import.LazyImport'>
sage: _ = lazy_ZZ(3)
sage: type(lazy_ZZ)
<class 'sage.rings.integer_ring.IntegerRing_class'>
```

    with

```
sage: from sage.misc.lazy_import import LazyImport
sage: lazy_ZZ = LazyImport('sage.rings.all', 'ZZ')
sage: _ = lazy_ZZ(3)
3
sage: type(lazy_ZZ)
<class 'sage.misc.lazy_import.LazyImport'>
```

    In the former version, any code that uses more than once the lazy object actually uses it only once.

3. Calling `__module__` triggers `get_object` whereas we could return what is contained in the `_module` attribute. This would solve #31643 but it is likely to be a bad idea as the module from which an object is imported is not necessarily the module in which it is defined.

Issue created by migration from https://trac.sagemath.org/ticket/31650





---

archive/issue_comments_449302.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2021-04-11T12:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449302",
    "user": "vdelecroix"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_449303.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449303",
    "user": "vdelecroix"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_449304.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449304",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_449305.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449305",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_449306.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to misc.",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449306",
    "user": "vdelecroix"
}
```

Changing component from PLEASE CHANGE to misc.



---

archive/issue_comments_449307.json:
```json
{
    "body": "See also: #22793, #20626",
    "created_at": "2021-04-11T22:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449307",
    "user": "mkoeppe"
}
```

See also: #22793, #20626



---

archive/issue_comments_449308.json:
```json
{
    "body": "I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.\n\nAlso, I don't understand what point 2 is trying to make.",
    "created_at": "2021-04-16T00:07:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449308",
    "user": "tscrim"
}
```

I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.

Also, I don't understand what point 2 is trying to make.



---

archive/issue_comments_449309.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.\n\nThey don't need to. It is just more condensed.\n\nWhat do you mean by traceback? I don't understand your point.\n\n> Also, I don't understand what point 2 is trying to make.\n\nThat the following doctest was not testing `LazyImport`\n\n```\nsage: lazy_import('sage.all', 'foo')\nsage: type(foo)\n<type 'sage.misc.lazy_import.LazyImport'>\nsage: del foo[1]  # still lazy\nsage: print(foo)  # not lazy anymore\n```\n\nI agree that this was not a problem in the doctests.",
    "created_at": "2021-04-16T06:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449309",
    "user": "vdelecroix"
}
```

Replying to [comment:9 tscrim]:
> I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.

They don't need to. It is just more condensed.

What do you mean by traceback? I don't understand your point.

> Also, I don't understand what point 2 is trying to make.

That the following doctest was not testing `LazyImport`

```
sage: lazy_import('sage.all', 'foo')
sage: type(foo)
<type 'sage.misc.lazy_import.LazyImport'>
sage: del foo[1]  # still lazy
sage: print(foo)  # not lazy anymore
```

I agree that this was not a problem in the doctests.



---

archive/issue_comments_449310.json:
```json
{
    "body": "See also #16522 for improvements of the use of lazy_import rather than improving the tool itself.",
    "created_at": "2021-04-18T07:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449310",
    "user": "nbruin"
}
```

See also #16522 for improvements of the use of lazy_import rather than improving the tool itself.



---

archive/issue_comments_449311.json:
```json
{
    "body": "Replying to [comment:10 vdelecroix]:\n> Replying to [comment:9 tscrim]:\n> > I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.\n> \n> They don't need to. It is just more condensed.\n\nHowever, they output too much when they do fail (see below), they obscure (very) slightly that the test should be `True`, and the `assert` tests could (in principle) be disabled as they are meant for serious errors during debugging.\n\n> What do you mean by traceback? I don't understand your point.\n\nYou get something like this:\n\n```\nFile \"partition.py\", line 7, in sage.combinat.partition\nFailed example:\n    assert False\nException raised:\n    Traceback (most recent call last):\n      File \"/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.partition[0]>\", line 1, in <module>\n        assert False\n    AssertionError\n```\n\nwhich is a lot of noise for something that is not `True`.\n(I just add this to the start of `partition.py`:\n\n```\nEXAMPLES::\n\n    sage: assert False\n```\n\n\nBecause of these points, I think they should follow the standard doctest practice of checking against output.\n\n> > Also, I don't understand what point 2 is trying to make.\n> \n> That the following doctest was not testing `LazyImport`\n> {{{\n> sage: lazy_import('sage.all', 'foo')\n> sage: type(foo)\n> <type 'sage.misc.lazy_import.LazyImport'>\n> sage: del foo[1]  # still lazy\n> sage: print(foo)  # not lazy anymore\n> }}}\n> I agree that this was not a problem in the doctests.\n\nI see. Thank you for the explanation.",
    "created_at": "2021-04-19T00:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449311",
    "user": "tscrim"
}
```

Replying to [comment:10 vdelecroix]:
> Replying to [comment:9 tscrim]:
> > I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.
> 
> They don't need to. It is just more condensed.

However, they output too much when they do fail (see below), they obscure (very) slightly that the test should be `True`, and the `assert` tests could (in principle) be disabled as they are meant for serious errors during debugging.

> What do you mean by traceback? I don't understand your point.

You get something like this:

```
File "partition.py", line 7, in sage.combinat.partition
Failed example:
    assert False
Exception raised:
    Traceback (most recent call last):
      File "/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.partition[0]>", line 1, in <module>
        assert False
    AssertionError
```

which is a lot of noise for something that is not `True`.
(I just add this to the start of `partition.py`:

```
EXAMPLES::

    sage: assert False
```


Because of these points, I think they should follow the standard doctest practice of checking against output.

> > Also, I don't understand what point 2 is trying to make.
> 
> That the following doctest was not testing `LazyImport`
> {{{
> sage: lazy_import('sage.all', 'foo')
> sage: type(foo)
> <type 'sage.misc.lazy_import.LazyImport'>
> sage: del foo[1]  # still lazy
> sage: print(foo)  # not lazy anymore
> }}}
> I agree that this was not a problem in the doctests.

I see. Thank you for the explanation.



---

archive/issue_comments_449312.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-19T00:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449312",
    "user": "tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_449313.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T18:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449313",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449314.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-20T18:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449314",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_449315.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2021-04-21T06:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449315",
    "user": "tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_449316.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-21T06:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449316",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_449317.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31413#issuecomment-449317",
    "user": "vbraun"
}
```

Resolution: fixed
