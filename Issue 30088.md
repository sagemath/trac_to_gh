# Issue 30088: Optional package deformation fails to build: mpir.h not found

Issue created by migration from https://trac.sagemath.org/ticket/30325

Original creator: mkoeppe

Original creation time: 2020-08-10 03:14:35

CC:  jpflori vdelecroix fbissey slelievre spancratz

On `homebrew-macos-maximal` (https://github.com/mkoeppe/sage/runs/959683064) - which uses gmp from the system, not mpir...

```
 [deformation-d05941b.p0] error installing, exit status 1. End of log file:
  [deformation-d05941b.p0]   /Users/runner/work/sage/sage/.tox/local-homebrew-macos-maximal/local/var/tmp/sage/build/deformation-d05941b.p0/src/generics.h:12:10: fatal error: 'mpir.h' file not found
  [deformation-d05941b.p0]   #include <mpir.h>
  [deformation-d05941b.p0]            ^~~~~~~~
  [deformation-d05941b.p0]   In file included from zero.c:1:
  [deformation-d05941b.p0]   In file included from /Users/runner/work/sage/sage/.tox/local-homebrew-macos-maximal/local/var/tmp/sage/build/deformation-d05941b.p0/src/vec.h:8:
  [deformation-d05941b.p0]   /Users/runner/work/sage/sage/.tox/local-homebrew-macos-maximal/local/var/tmp/sage/build/deformation-d05941b.p0/src/generics.h:12:10: fatal error: 'mpir.h' file not found
```


Is this package still maintained?


---

Comment by jpflori created at 2020-10-15 08:54:53

I pushed a modif on my github repo for the debian issue.
For the homebrew one, I fear that the package is using some MPIR internals and cannot work with GMP, though that is just a very vague souvenir.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-03-19 19:16:31

Replying to [comment:2 jpflori]:
> I pushed a modif on my github repo for the debian issue.

Could you push a tag please so that there is a cleaner way to refer to this version?


---

Comment by jpflori created at 2021-03-23 17:33:59

https://github.com/jpflori/deformation/tags
Just did.
----
New commits:


---

Comment by dimpase created at 2021-04-26 12:28:12

we now have a release that uses GMP, and doesn't use MPIR at all.


---

Comment by dimpase created at 2021-04-26 13:26:01

Changing component from packages: optional to packages: experimental.


---

Comment by dimpase created at 2021-04-26 13:26:01

this works and passes checks on Ubuntu and Fedora 32
----
New commits:


---

Comment by dimpase created at 2021-04-26 13:26:01

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-04-26 17:42:28

I would strongly suggest to use more traditionally named release tags. If there is no version scheme, how about using the date.


---

Comment by mkoeppe created at 2021-04-26 17:43:42

Also, does not build for me on macos-homebrew:

```
[deformation-mpir_fix]         ^
[deformation-mpir_fix] nmod_mat_charpoly.c:9:6: error: redefinition of 'nmod_mat_charpoly'
[deformation-mpir_fix] void nmod_mat_charpoly(nmod_poly_t rop, const nmod_mat_t op)
[deformation-mpir_fix]      ^
[deformation-mpir_fix] /usr/local/include/flint/nmod_poly.h:1412:6: note: previous definition is here
[deformation-mpir_fix] void nmod_mat_charpoly(nmod_poly_t p, const nmod_mat_t M)
[deformation-mpir_fix]      ^
[deformation-mpir_fix] 1 error generated.
```



---

Comment by dimpase created at 2021-04-26 18:45:47

yes, the C code there is far from "normal", there are various ugly bits such as `static` functions implemented in `.h` files.
E.g. `gcc 8.3` produces a slew of warnings. OK, it's something doable, to fix these.


---

Comment by dimpase created at 2021-04-26 18:46:19

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-04-27 22:53:07

Changing status from needs_work to needs_info.


---

Comment by dimpase created at 2021-04-27 22:53:07

Do we assume that we have Flint 2.6 or newer? `nmod_mat_charpoly` appeared in Flint 2.6,
and we can either use it, or rename the one in `deformation`
(both ways work, but of course it's better to use one in Flint)


---

Comment by mkoeppe created at 2021-04-27 23:35:35

Yes, if we make #31525 (Wrap FLINT 2.6 functions, drop support for system FLINT < 2.6) a dependency of this ticket


---

Comment by dimpase created at 2021-04-28 07:14:34

Changing status from needs_info to needs_work.


---

Comment by dimpase created at 2021-04-28 10:29:52

Unfortunately, some tests fail with Flint 2.6.3, while with Flint 2.5.2 everything passes.
https://github.com/dimpase/deformation/runs/2456263893


```
...
nmod_mat_charpoly... PASS
monotonic... PASS
make[1]: *** [../Makefile.subdirs:84: ../build/diagfrob/test/t-ell_curves_RUN] Aborted (core dumped)
ell_curves... make[1]: Leaving directory '/home/runner/work/deformation/deformation/diagfrob'
make: *** [Makefile:179: check] Error 2
Error: Process completed with exit code 2.
```



---

Comment by dimpase created at 2021-05-01 10:14:14

I found a workaround (by chance), it appears that the order the libraries are linked in is important, see https://github.com/dimpase/deformation/issues/2

It likely points to a bug somewhere, though (valgrind shows trouble in some tests, although not in ones which fail), but, well...


---

Comment by git created at 2021-05-03 10:48:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-03 11:31:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-05-03 11:32:32

OK, this also should work on macOS, and pass checks


---

Comment by dimpase created at 2021-05-03 11:32:32

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-05-03 11:36:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-05-03 11:36:55

the versions are now dates in format YYYYMMDD


---

Comment by mkoeppe created at 2021-05-03 15:00:45

Builds OK now on macOS, thanks


---

Comment by mkoeppe created at 2021-05-03 15:00:45

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-19 00:15:01

Changing priority from major to critical.


---

Comment by vbraun created at 2021-07-24 15:28:46

Resolution: fixed
