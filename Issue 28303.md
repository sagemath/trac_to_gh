# Issue 28303: Let bytes_to_str accept unicode as input

Issue created by migration from https://trac.sagemath.org/ticket/28540

Original creator: SimonKing

Original creation time: 2019-09-26 21:59:21

CC:  jhpalmieri @mwageringel

Keywords: python3

In #28444, bytes_to_str was made more tolerant: It now accepts as input not only bytes but also str. A str input is returned unaltered.

However, when a pickle is created in py3 and unpickled in py2, a py3-str would be unpickled as a py2-unicode, which means that bytes_to_str fails:

```
sage: from sage.cpython.string import bytes_to_str
sage: bytes_to_str(u'bla')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-342652ffe6fc> in <module>()
----> 1 bytes_to_str(u'bla')

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1539)()
     29 
     30 
---> 31 cpdef inline str bytes_to_str(b, encoding=None, errors=None):
     32     r"""
     33     Convert ``bytes`` to ``str``.

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd in sage.cpython.string.bytes_to_str (build/cythonized/sage/cpython/string.c:1406)()
     55         return b
     56     if type(b) is not bytes:
---> 57         raise TypeError(f"expected bytes, {type(b).__name__} found")
     58 
     59     if PY_MAJOR_VERSION <= 2:

TypeError: expected bytes, unicode found
```

Obvious fix: Convert unicode to str.


---

Comment by nbruin created at 2019-09-26 22:25:40

That needs to go into a differently-named routine. You're clearly not converting bytes to str here. You're taking *some* input and trying to ensure it's "str".

There is of course a way to convert a unicode object to py2: `s.encode("utf8")`. Which in Py3 will actually result in a bytes object. That's a pretty clear clue that this behaviour does NOT belong in a routine named `bytes_to_str`.


---

Comment by SimonKing created at 2019-09-26 22:31:14

Replying to [comment:1 nbruin]:
> That needs to go into a differently-named routine. You're clearly not converting bytes to str here. You're taking *some* input and trying to ensure it's "str".
> 
> There is of course a way to convert a unicode object to py2: `s.encode("utf8")`. Which in Py3 will actually result in a bytes object. That's a pretty clear clue that this behaviour does NOT belong in a routine named `bytes_to_str`.

OK, that somehow makes sense to me. So, I will not touch it.

Question: Is the change that I have introduced in #28444 OK, then? At least it made it possible to read a py2 pickle in py3.


---

Comment by SimonKing created at 2019-09-26 23:02:22

Rather than stretching byte_to_str beyond its specifications, it may be better to fix the function that actually needs a conversion from unicode to str, namely lookup_glocal. See the new ticket description.


---

Comment by SimonKing created at 2019-09-26 23:19:26

See #28414 for a situation where the fix from this ticket actually solves a problem.
----
New commits:


---

Comment by SimonKing created at 2019-09-26 23:19:26

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-11-24 19:50:49

red branch


---

Comment by chapoton created at 2019-11-24 19:50:49

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by @mwageringel created at 2020-07-11 13:45:15

As we do not support Python 2 anymore, should we close this as outdated? I imagine there is rarely a need to load a py3 pickle in a Python-2-based Sage now.


---

Comment by mkoeppe created at 2020-07-11 15:54:42

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-11 15:54:42

That was my thought too.


---

Comment by @mwageringel created at 2020-07-11 15:58:23

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2020-07-11 15:58:23

Ok.


---

Comment by slelievre created at 2020-10-11 16:51:42

Resolution: invalid


---

Comment by slelievre created at 2020-10-11 16:51:42

If this needs to be reopened, use the milestone sage-9.1.1
