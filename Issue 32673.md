# Issue 32673: Bug in NumberField.dirichlet_group

Issue created by migration from https://trac.sagemath.org/ticket/32910

Original creator: mderickx

Original creation time: 2021-11-20 11:05:25


```
Maartens-MBP:~ mderickx$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4, Release Date: 2021-08-22                     │
│ Using Python 3.9.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: x = polygen(QQ); K= NumberField(x**2 - 2885, 'a')                                            
....:                                                                    
....: K.dirichlet_group()                                                                          
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-524767294280> in <module>
      1 x = polygen(QQ); K= NumberField(x**Integer(2) - Integer(2885), 'a')
----> 2 K.dirichlet_group()

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/number_field/number_field.py in dirichlet_group(self)
   3362         m = self.conductor()
   3363         d = self.degree()
-> 3364         A = _splitting_classes_gens_(self,m,d)
   3365         # d could be improve to be the exponenent of the Galois group rather than the degree, but I do not see how to how about it already.
   3366         G = DirichletGroup(m, CyclotomicField(d))

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/number_field/number_field.py in _splitting_classes_gens_(K, m, d)
  12395         if H.order() == Horder:
  12396             break
> 12397         if g not in H:
  12398             u = map_Zmstar_to_Zm(g)
  12399             p = u.lift()

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/groups/abelian_gps/abelian_group.py in __contains__(self, x)
   1749                             continue
   1750                         if abs(x.list()[a]%g.list()[a])%abs(amb_inv[a]) < x.list()[a]%abs(amb_inv[a]):
-> 1751                             x *= g**((-1)*(x.list()[a]/g.list()[a]))
   1752                         if x.list()[a] == 0:
   1753                             break

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/groups/abelian_gps/element_base.py in __pow__(self, n)
    291             a^3
    292         """
--> 293         m = Integer(n)
    294         if n != m:
    295             raise TypeError('argument n (= '+str(n)+') must be an integer.')

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:6234)()
    691                 otmp = getattr(x, "_integer_", None)
    692                 if otmp is not None:
--> 693                     set_from_Integer(self, otmp(the_integer_ring))
    694                     return
    695 

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational._integer_ (build/cythonized/sage/rings/rational.cpp:24220)()
   2960         """
   2961         if not mpz_cmp_si(mpq_denref(self.value), 1) == 0:
-> 2962             raise TypeError("no conversion of this rational to integer")
   2963         cdef Integer n = Integer.__new__(Integer)
   2964         n.set_from_mpz(mpq_numref(self.value))

TypeError: no conversion of this rational to integer
sage: 
```



---

Comment by mderickx created at 2021-11-21 00:30:25

Ok, I don't have a development version of sage yet. And I have trouble getting one. But here is some code I wrote that I used to monkey patch
`sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__` and it seems to work like a charm for my application.


```
def __contains__(self, x):
    """
    Test whether ``x`` is an element of this subgroup.

    EXAMPLES::

        sage: G.<a,b> = AbelianGroup(2)
        sage: A = G.subgroup([a])
        sage: a in G
        True
        sage: a in A
        True

    TESTS:

    Check that :trac:`32910` is fixed::

        sage: Zmstar.<a,b> = AbelianGroup(2,[4,576])
        sage: Hgens =  [a**2,a*b**2]
        sage: H = Zmstar.subgroup(Hgens)
        sage: g = Zmstar.gen(1)**3
        sage: g in H
        True

    """
    amb_inv = self.ambient_group().gens_orders()
    inv_basis = diagonal_matrix(ZZ,amb_inv)
    gens_basis = matrix(
        ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]
    )
    return vector(ZZ, x.list()) in inv_basis.stack(gens_basis).row_module()

sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__ = __contains__
```



---

Comment by dimpase created at 2021-11-21 03:55:45

Please feel free to tell more about the problem to set up a development version.


---

Comment by @DaveWitteMorris created at 2021-11-21 06:46:39

I think this is a duplicate of #31507, so we should put the fix on that ticket.


---

Comment by @DaveWitteMorris created at 2021-11-21 06:46:39

Changing status from new to needs_review.


---

Comment by mderickx created at 2021-11-21 12:26:54

Changing status from needs_review to positive_review.


---

Comment by mderickx created at 2021-11-21 12:26:54

Agreed that it is a dup


---

Comment by mderickx created at 2021-11-21 12:37:01

Replying to [comment:3 dimpase]:
> Please feel free to tell more about the problem to set up a development version.


It is not something due to sage, I have a relatively old MacBook and I have trouble getting xcode to work.


```
2021-11-21 13:28:01+01 Maartens-MBP Xcode[95644]: Package: PKLeopardPackage <id=com.apple.pkg.MobileDeviceDevelopment, version=10.3.9000000000.1.1488876279, url=file:///Applications/Xcode.app/Contents/Resources/Packages/MobileDeviceDevelopment.pkg> Failed to verify with error: Error Domain=PKInstallErrorDomain Code=102 "The package “MobileDeviceDevelopment.pkg” is untrusted."
```


I also tried to get a recent development image through docker as an alternative, but the automatic builds of docker images seems to be broken since the latest tag is 9.2. I guess I can just build my own docker image locally, but haven't gotten to that point yet.
https://hub.docker.com/r/sagemath/sagemath/


---

Comment by dimpase created at 2021-11-21 14:40:18

try Conda/Mamba?
https://wiki.sagemath.org/Conda

it comes with a full toolchain


---

Comment by mkoeppe created at 2021-12-01 02:46:14

Resolution: invalid
