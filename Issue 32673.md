# Issue 32673: Bug in NumberField.dirichlet_group

archive/issues_032673.json:
```json
{
    "body": "\n```\nMaartens-MBP:~ mderickx$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.4, Release Date: 2021-08-22                     \u2502\n\u2502 Using Python 3.9.5. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: x = polygen(QQ); K= NumberField(x**2 - 2885, 'a')                                            \n....:                                                                    \n....: K.dirichlet_group()                                                                          \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-1-524767294280> in <module>\n      1 x = polygen(QQ); K= NumberField(x**Integer(2) - Integer(2885), 'a')\n----> 2 K.dirichlet_group()\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/number_field/number_field.py in dirichlet_group(self)\n   3362         m = self.conductor()\n   3363         d = self.degree()\n-> 3364         A = _splitting_classes_gens_(self,m,d)\n   3365         # d could be improve to be the exponenent of the Galois group rather than the degree, but I do not see how to how about it already.\n   3366         G = DirichletGroup(m, CyclotomicField(d))\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/number_field/number_field.py in _splitting_classes_gens_(K, m, d)\n  12395         if H.order() == Horder:\n  12396             break\n> 12397         if g not in H:\n  12398             u = map_Zmstar_to_Zm(g)\n  12399             p = u.lift()\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/groups/abelian_gps/abelian_group.py in __contains__(self, x)\n   1749                             continue\n   1750                         if abs(x.list()[a]%g.list()[a])%abs(amb_inv[a]) < x.list()[a]%abs(amb_inv[a]):\n-> 1751                             x *= g**((-1)*(x.list()[a]/g.list()[a]))\n   1752                         if x.list()[a] == 0:\n   1753                             break\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/groups/abelian_gps/element_base.py in __pow__(self, n)\n    291             a^3\n    292         \"\"\"\n--> 293         m = Integer(n)\n    294         if n != m:\n    295             raise TypeError('argument n (= '+str(n)+') must be an integer.')\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:6234)()\n    691                 otmp = getattr(x, \"_integer_\", None)\n    692                 if otmp is not None:\n--> 693                     set_from_Integer(self, otmp(the_integer_ring))\n    694                     return\n    695 \n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational._integer_ (build/cythonized/sage/rings/rational.cpp:24220)()\n   2960         \"\"\"\n   2961         if not mpz_cmp_si(mpq_denref(self.value), 1) == 0:\n-> 2962             raise TypeError(\"no conversion of this rational to integer\")\n   2963         cdef Integer n = Integer.__new__(Integer)\n   2964         n.set_from_mpz(mpq_numref(self.value))\n\nTypeError: no conversion of this rational to integer\nsage: \n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32910\n\n",
    "created_at": "2021-11-20T11:05:25Z",
    "labels": [
        "number fields",
        "major",
        "bug"
    ],
    "title": "Bug in NumberField.dirichlet_group",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32673",
    "user": "mderickx"
}
```

```
Maartens-MBP:~ mderickx$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4, Release Date: 2021-08-22                     │
│ Using Python 3.9.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: x = polygen(QQ); K= NumberField(x**2 - 2885, 'a')                                            
....:                                                                    
....: K.dirichlet_group()                                                                          
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-524767294280> in <module>
      1 x = polygen(QQ); K= NumberField(x**Integer(2) - Integer(2885), 'a')
----> 2 K.dirichlet_group()

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/number_field/number_field.py in dirichlet_group(self)
   3362         m = self.conductor()
   3363         d = self.degree()
-> 3364         A = _splitting_classes_gens_(self,m,d)
   3365         # d could be improve to be the exponenent of the Galois group rather than the degree, but I do not see how to how about it already.
   3366         G = DirichletGroup(m, CyclotomicField(d))

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/number_field/number_field.py in _splitting_classes_gens_(K, m, d)
  12395         if H.order() == Horder:
  12396             break
> 12397         if g not in H:
  12398             u = map_Zmstar_to_Zm(g)
  12399             p = u.lift()

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/groups/abelian_gps/abelian_group.py in __contains__(self, x)
   1749                             continue
   1750                         if abs(x.list()[a]%g.list()[a])%abs(amb_inv[a]) < x.list()[a]%abs(amb_inv[a]):
-> 1751                             x *= g**((-1)*(x.list()[a]/g.list()[a]))
   1752                         if x.list()[a] == 0:
   1753                             break

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/groups/abelian_gps/element_base.py in __pow__(self, n)
    291             a^3
    292         """
--> 293         m = Integer(n)
    294         if n != m:
    295             raise TypeError('argument n (= '+str(n)+') must be an integer.')

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:6234)()
    691                 otmp = getattr(x, "_integer_", None)
    692                 if otmp is not None:
--> 693                     set_from_Integer(self, otmp(the_integer_ring))
    694                     return
    695 

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational._integer_ (build/cythonized/sage/rings/rational.cpp:24220)()
   2960         """
   2961         if not mpz_cmp_si(mpq_denref(self.value), 1) == 0:
-> 2962             raise TypeError("no conversion of this rational to integer")
   2963         cdef Integer n = Integer.__new__(Integer)
   2964         n.set_from_mpz(mpq_numref(self.value))

TypeError: no conversion of this rational to integer
sage: 
```


Issue created by migration from https://trac.sagemath.org/ticket/32910





---

archive/issue_comments_466190.json:
```json
{
    "body": "Ok, I don't have a development version of sage yet. And I have trouble getting one. But here is some code I wrote that I used to monkey patch\n`sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__` and it seems to work like a charm for my application.\n\n\n```\ndef __contains__(self, x):\n    \"\"\"\n    Test whether ``x`` is an element of this subgroup.\n\n    EXAMPLES::\n\n        sage: G.<a,b> = AbelianGroup(2)\n        sage: A = G.subgroup([a])\n        sage: a in G\n        True\n        sage: a in A\n        True\n\n    TESTS:\n\n    Check that :trac:`32910` is fixed::\n\n        sage: Zmstar.<a,b> = AbelianGroup(2,[4,576])\n        sage: Hgens =  [a**2,a*b**2]\n        sage: H = Zmstar.subgroup(Hgens)\n        sage: g = Zmstar.gen(1)**3\n        sage: g in H\n        True\n\n    \"\"\"\n    amb_inv = self.ambient_group().gens_orders()\n    inv_basis = diagonal_matrix(ZZ,amb_inv)\n    gens_basis = matrix(\n        ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]\n    )\n    return vector(ZZ, x.list()) in inv_basis.stack(gens_basis).row_module()\n\nsage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__ = __contains__\n```\n",
    "created_at": "2021-11-21T00:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466190",
    "user": "mderickx"
}
```

Ok, I don't have a development version of sage yet. And I have trouble getting one. But here is some code I wrote that I used to monkey patch
`sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__` and it seems to work like a charm for my application.


```
def __contains__(self, x):
    """
    Test whether ``x`` is an element of this subgroup.

    EXAMPLES::

        sage: G.<a,b> = AbelianGroup(2)
        sage: A = G.subgroup([a])
        sage: a in G
        True
        sage: a in A
        True

    TESTS:

    Check that :trac:`32910` is fixed::

        sage: Zmstar.<a,b> = AbelianGroup(2,[4,576])
        sage: Hgens =  [a**2,a*b**2]
        sage: H = Zmstar.subgroup(Hgens)
        sage: g = Zmstar.gen(1)**3
        sage: g in H
        True

    """
    amb_inv = self.ambient_group().gens_orders()
    inv_basis = diagonal_matrix(ZZ,amb_inv)
    gens_basis = matrix(
        ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]
    )
    return vector(ZZ, x.list()) in inv_basis.stack(gens_basis).row_module()

sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__ = __contains__
```




---

archive/issue_comments_466191.json:
```json
{
    "body": "Please feel free to tell more about the problem to set up a development version.",
    "created_at": "2021-11-21T03:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466191",
    "user": "dimpase"
}
```

Please feel free to tell more about the problem to set up a development version.



---

archive/issue_comments_466192.json:
```json
{
    "body": "I think this is a duplicate of #31507, so we should put the fix on that ticket.",
    "created_at": "2021-11-21T06:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466192",
    "user": "@DaveWitteMorris"
}
```

I think this is a duplicate of #31507, so we should put the fix on that ticket.



---

archive/issue_comments_466193.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-21T06:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466193",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_466194.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-21T12:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466194",
    "user": "mderickx"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_466195.json:
```json
{
    "body": "Agreed that it is a dup",
    "created_at": "2021-11-21T12:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466195",
    "user": "mderickx"
}
```

Agreed that it is a dup



---

archive/issue_comments_466196.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> Please feel free to tell more about the problem to set up a development version.\n\n\nIt is not something due to sage, I have a relatively old MacBook and I have trouble getting xcode to work.\n\n\n```\n2021-11-21 13:28:01+01 Maartens-MBP Xcode[95644]: Package: PKLeopardPackage <id=com.apple.pkg.MobileDeviceDevelopment, version=10.3.9000000000.1.1488876279, url=file:///Applications/Xcode.app/Contents/Resources/Packages/MobileDeviceDevelopment.pkg> Failed to verify with error: Error Domain=PKInstallErrorDomain Code=102 \"The package \u201cMobileDeviceDevelopment.pkg\u201d is untrusted.\"\n```\n\n\nI also tried to get a recent development image through docker as an alternative, but the automatic builds of docker images seems to be broken since the latest tag is 9.2. I guess I can just build my own docker image locally, but haven't gotten to that point yet.\nhttps://hub.docker.com/r/sagemath/sagemath/",
    "created_at": "2021-11-21T12:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466196",
    "user": "mderickx"
}
```

Replying to [comment:3 dimpase]:
> Please feel free to tell more about the problem to set up a development version.


It is not something due to sage, I have a relatively old MacBook and I have trouble getting xcode to work.


```
2021-11-21 13:28:01+01 Maartens-MBP Xcode[95644]: Package: PKLeopardPackage <id=com.apple.pkg.MobileDeviceDevelopment, version=10.3.9000000000.1.1488876279, url=file:///Applications/Xcode.app/Contents/Resources/Packages/MobileDeviceDevelopment.pkg> Failed to verify with error: Error Domain=PKInstallErrorDomain Code=102 "The package “MobileDeviceDevelopment.pkg” is untrusted."
```


I also tried to get a recent development image through docker as an alternative, but the automatic builds of docker images seems to be broken since the latest tag is 9.2. I guess I can just build my own docker image locally, but haven't gotten to that point yet.
https://hub.docker.com/r/sagemath/sagemath/



---

archive/issue_comments_466197.json:
```json
{
    "body": "try Conda/Mamba?\nhttps://wiki.sagemath.org/Conda\n\nit comes with a full toolchain",
    "created_at": "2021-11-21T14:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466197",
    "user": "dimpase"
}
```

try Conda/Mamba?
https://wiki.sagemath.org/Conda

it comes with a full toolchain



---

archive/issue_comments_466198.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-12-01T02:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32673",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32673#issuecomment-466198",
    "user": "mkoeppe"
}
```

Resolution: invalid
