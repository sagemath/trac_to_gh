# Issue 11946: Parallel build of Sage is broken

Issue created by migration from Trac.

Original creator: justin

Original creation time: 2011-12-04 22:03:12

Assignee: GeorgSWeber

CC:  jdemeyer georgsweber

Beginning with the first 4.8 alpha, the build will fail if the build system is sufficiently fast, and perhaps, with sufficiently many cores available.

The attached log file (from a 4.8.a3 build) shows that the spkg libgpg_error-1.6.p3 blows up because it tries to make a directory that already exists.  Georg Weber (gsw') seems to have an explanation: while the Makefile does check to see that the file exists, if the build is sufficiently parallel, two checks can occur at the same time, see no directory, and then both try to make the directory.  Only one can succeed.

His comment on the list that "hyperthreading" may be the problem, I think, is not the case.  For me, the build fails on a dual 6-core Xeon Mac Pro for "-j24", "-h12", and "-j8".  It succeeds with "-j4".

It appears that the directories are made in a shell file, rather than a Makefile.  If so, the usual "-mkdir" Makefile trick won't work.  However, at least on Mac OS X, using "mkdir -p" will ignore failures because the directory exists.

Is this portable across all the systems we support?  The man page implies that it is.


---

Attachment

Build log from a "-j24" build of libgpg_error-1.6.p3


---

Comment by justin created at 2011-12-04 23:39:17

Changing type from PLEASE CHANGE to defect.


---

Comment by justin created at 2011-12-05 01:39:26

Updated spkg


---

Attachment

Not sure what I was smoking, but a second look found undecorated (non-macro) mkdir's in src/Makefile.  I added a leading "-" to these, and the build succeeded (as did a subsequent "ptestlong").


---

Comment by justin created at 2011-12-05 01:41:51

Changing status from new to needs_review.


---

Comment by justin created at 2011-12-05 04:25:53

I should add that the build used "make -j24".


---

Comment by jdemeyer created at 2011-12-05 09:11:34

This should be reported upstream.


---

Comment by jdemeyer created at 2011-12-05 09:11:34

Changing component from build to packages.


---

Comment by justin created at 2011-12-13 17:55:28

Reported upstream (to the libgpg mailing list).  No reply to me yet.


---

Comment by justin created at 2011-12-14 04:11:08

Updated .spkg


---

Attachment

Updates:

First, a new spkg with the correct directory name.  This replaces the previous .spkg.

Second, after checking on the upstream website, I saw that my email had not yet appeared.  I bit the bullet and joined up and resent my email today.  The email made it to the archives; we'll see what happens.


---

Comment by justin created at 2011-12-14 21:50:07

Changing status from needs_review to needs_work.


---

Comment by justin created at 2011-12-14 21:50:07

I changed this to "needs work" since it, well, needs work.  Not quite sure why it worked in the past, but it doesn't do the job now.

Also, a response from upstream: "The current version is 1.1.0.  Please test again with that one."  I don't understand the numbering scheme, but I'll fool around with "the current version".  Anyone know why this would be A Bad Idea?


---

Comment by jdemeyer created at 2011-12-16 08:44:14

Replying to [comment:8 justin]:
> I changed this to "needs work" since it, well, needs work.  Not quite sure why it worked in the past, but it doesn't do the job now.
Please explain.  What is the problem?


---

Comment by jdemeyer created at 2011-12-16 12:57:10

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-12-16 13:31:42

Diff for the spkg, for review only


---

Comment by jdemeyer created at 2011-12-16 13:32:49

Changing priority from major to critical.


---

Attachment


---

Comment by justin created at 2011-12-16 18:06:05

Applied patch to the .p4 version from #12131.  The build broke, as usual (-j24) on libgpg-error.  More to come, after I look at the log file some more.


---

Comment by justin created at 2011-12-16 18:06:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-12-16 19:51:40

Replying to [comment:14 justin]:
> Applied patch to the .p4 version from #12131.  The build broke, as usual (-j24) on libgpg-error.  More to come, after I look at the log file some more.
I am certain that my patch did fix _some bug_.  So there must be more than one bug then...

Can you post the log?


---

Comment by jdemeyer created at 2011-12-16 20:37:49

Changing assignee from GeorgSWeber to jdemeyer.


---

Comment by jdemeyer created at 2011-12-16 20:37:49

I have not been able to reproduce this on Linux, logs please.


---

Comment by justin created at 2011-12-16 20:46:26

I've asked Georg to verify this; he joined the discussion at some point, saying that he had observed this on his system (can't find the mail; I think he mentioned a linux derivative).


---

Comment by jdemeyer created at 2011-12-16 20:47:17

Please try again, I forget to make the patched `install-sh` executable.


---

Comment by jdemeyer created at 2011-12-16 20:47:17

Changing status from needs_work to needs_review.


---

Comment by justin created at 2011-12-16 21:22:25

Grumble...I took the p5 .spkg, enabled 'x' mode for install-sh, re-tarred, copied it into a fresh 4.8-a4 tree.  The build still blows up, and install-sh is no longer executable.  Is this something that has to be done in "spkg-install"?

Note: I've verified that the tarball in spkg/standard has an executable "install-sh", but the one in spkg/build does not.


---

Comment by justin created at 2011-12-16 21:22:25

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-12-16 21:27:42

First, be sure to double-check that you really have the newly updated spkg.

Could you please go into the `build` directory and do

```
ls -l . src patches
```


Next, what happens if you untar the tarball by hand and then do

```
ls -l . src patches
```



---

Comment by justin created at 2011-12-16 21:37:49

Ah...light dawns...new knowledge awaits in the new day.

So: 'patches/install-sh' was *not* executable.  Making it so caused the build to continue chugging past the libgpg-error spkg.  It continues to chug.

Thanks for the pointers, Jeroen.


---

Comment by justin created at 2011-12-16 21:37:49

Changing status from needs_work to needs_review.


---

Comment by justin created at 2011-12-16 23:27:35

Changing status from needs_review to positive_review.


---

Comment by justin created at 2011-12-16 23:27:35

I'll give this a positive review.  It clearly works, and since we (Jeroen) just pulled in a new install-sh from upstream, we rely on them (once it seems to work).


---

Comment by jdemeyer created at 2011-12-17 09:05:05

Why did you change the spkg link?  Mine also has an executable `patches/install-sh`, yours has uncommitted changes.  Changing back to mine.


---

Comment by jdemeyer created at 2011-12-17 09:10:49

Resolution: fixed
