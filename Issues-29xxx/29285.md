# Issue 29285: Unbreak the build when pyenv is present

archive/issues_029048.json:
```json
{
    "body": "The build fails when [pyenv](https://github.com/pyenv/pyenv) is present, as reported in  [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) and also in #32749/#33103.\n\nWe fix it by rejecting the pyenv shims for `sage-bootstrap-python`.\n\nTickets:\n- #29461 sage --gdb not working\n- #32531: `SAGE_ROOT/tox.ini`: Add variants that provision a system python using `pyenv`\n\n**CC:**  @embray @mkoeppe @slel @tobiasdiez @jhpalmieri\n\n**Branch/Commit:** [376932f6933c7c210dc169d5682489f454229c66](https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66)\n\n**Reviewer:** John Palmieri\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/29285\n\n",
    "closed_at": "2022-01-18T22:01:21Z",
    "created_at": "2020-03-06T14:53:42Z",
    "labels": [
        "component: build: configure",
        "blocker",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Unbreak the build when pyenv is present",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29285",
    "user": "https://github.com/dimpase"
}
```
The build fails when [pyenv](https://github.com/pyenv/pyenv) is present, as reported in  [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) and also in #32749/#33103.

We fix it by rejecting the pyenv shims for `sage-bootstrap-python`.

Tickets:
- #29461 sage --gdb not working
- #32531: `SAGE_ROOT/tox.ini`: Add variants that provision a system python using `pyenv`

**CC:**  @embray @mkoeppe @slel @tobiasdiez @jhpalmieri

**Branch/Commit:** [376932f6933c7c210dc169d5682489f454229c66](https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66)

**Reviewer:** John Palmieri

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/29285





---

archive/issue_comments_545764.json:
```json
{
    "body": "<a id='comment:1'></a>\nWho's doing something with pyenv?\n\nI don't think we need to provide work-arounds for every conceivable user environment misconfiguration.",
    "created_at": "2020-03-06T14:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545764",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Who's doing something with pyenv?

I don't think we need to provide work-arounds for every conceivable user environment misconfiguration.



---

archive/issue_comments_545765.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [embray](#comment%3A1):\n> Who's doing something with pyenv?\n\nhttps://dblp.org/pers/k/Kruppa:Alexander.html\n\n> I don't think we need to provide work-arounds for every conceivable user environment misconfiguration.\n",
    "created_at": "2020-03-06T15:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545765",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
Replying to [embray](#comment%3A1):
> Who's doing something with pyenv?

https://dblp.org/pers/k/Kruppa:Alexander.html

> I don't think we need to provide work-arounds for every conceivable user environment misconfiguration.




---

archive/issue_comments_545766.json:
```json
{
    "body": "<a id='comment:3'></a>\nPyenv creates major issues with packages sometimes, I can imagine what Sagemath might be going about. My easiest fix would be symlinking the two paths together which allows communication, between your bin and other paths, it did work for me when I was trying simple builds, of course now I use Sagemath as an application separately.\n\nPyenv is popular with MacOs users, so this will definitely need a fix",
    "created_at": "2020-03-20T17:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545766",
    "user": "https://github.com/Shlokatadistance"
}
```

<a id='comment:3'></a>
Pyenv creates major issues with packages sometimes, I can imagine what Sagemath might be going about. My easiest fix would be symlinking the two paths together which allows communication, between your bin and other paths, it did work for me when I was trying simple builds, of course now I use Sagemath as an application separately.

Pyenv is popular with MacOs users, so this will definitely need a fix



---

archive/issue_comments_545767.json:
```json
{
    "body": "<a id='comment:4'></a>\nIn fact, the breaking of the path isn't something restricted to Sage, it existed with pip too, where pip was not able to define the paths correctly for the packages to go in",
    "created_at": "2020-03-21T20:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545767",
    "user": "https://github.com/Shlokatadistance"
}
```

<a id='comment:4'></a>
In fact, the breaking of the path isn't something restricted to Sage, it existed with pip too, where pip was not able to define the paths correctly for the packages to go in



---

archive/issue_comments_545768.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,6 @@\n we had seen at least one [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) where [pyenv](https://github.com/pyenv/pyenv) broke the build, as pyenv'd Python prepends stuff like `/usr/bin` into `PATH`. \n \n It might be a good idea to check this at configure time.\n+\n+Tickets:\n+- #29461 sage --gdb not working\n``````\n",
    "created_at": "2020-04-04T15:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545768",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,6 @@
 we had seen at least one [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) where [pyenv](https://github.com/pyenv/pyenv) broke the build, as pyenv'd Python prepends stuff like `/usr/bin` into `PATH`. 
 
 It might be a good idea to check this at configure time.
+
+Tickets:
+- #29461 sage --gdb not working
``````




---

archive/issue_events_083752.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "rename": {
        "from": "avoid getting into pyenv trap",
        "to": "Meta-ticket: pyenv"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83752"
}
```



---

archive/issue_comments_545769.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [embray](#comment%3A1):\n> Who's doing something with pyenv?\n\nI do. Because I tried installing a standalone cygdb on Arch Linux for 3 days and only succeeded when I used pyenv, because I wanted two different python versions on my machine: A normal one and one compiled with --with-pydebug. Achieving this without pyenv is very hard (on Arch Linux).\n> \n> I don't think we need to provide work-arounds for every conceivable user environment misconfiguration.\n\nIf it is too hard or not possible to make sagemath work with pyenv that is ok. But there should be  a good error message, because no one looks at the message:\n\n```\nImportError: /home/volker/.pyenv/versions/3.8.1-debug/lib/python3.8/lib-dynload/math.cpython-38d-x86_64-linux-gnu.so: undefined symbol: PyFloat_Type\n/tmp/tmppfahgne0:19: Error in sourced command file:\nError while executing Python code.\n/home/volker/Sync/git/sage/src/bin/sage-gdb-commands:1: Error in sourced command file:\n```\nAnd thinks: \"Ok, it looks like I need to uninstall pyenv.\" An error message similar to this:\n\"It looks like you installed pyenv. Sagemath is incompatible with pyenv. Please uninstall pyenv.\"\ncan save someone hours of work. If mkoeppe hadn't added me to the Cc, I would be going through the source code of sagemath right now to find the error. That would have costed me multiple days.\n\nIn General, I think it is really important that misconfigurations result in nice error messages.\n\nNote: My issue can be found here: #29461",
    "created_at": "2020-04-04T17:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545769",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:6'></a>
Replying to [embray](#comment%3A1):
> Who's doing something with pyenv?

I do. Because I tried installing a standalone cygdb on Arch Linux for 3 days and only succeeded when I used pyenv, because I wanted two different python versions on my machine: A normal one and one compiled with --with-pydebug. Achieving this without pyenv is very hard (on Arch Linux).
> 
> I don't think we need to provide work-arounds for every conceivable user environment misconfiguration.

If it is too hard or not possible to make sagemath work with pyenv that is ok. But there should be  a good error message, because no one looks at the message:

```
ImportError: /home/volker/.pyenv/versions/3.8.1-debug/lib/python3.8/lib-dynload/math.cpython-38d-x86_64-linux-gnu.so: undefined symbol: PyFloat_Type
/tmp/tmppfahgne0:19: Error in sourced command file:
Error while executing Python code.
/home/volker/Sync/git/sage/src/bin/sage-gdb-commands:1: Error in sourced command file:
```
And thinks: "Ok, it looks like I need to uninstall pyenv." An error message similar to this:
"It looks like you installed pyenv. Sagemath is incompatible with pyenv. Please uninstall pyenv."
can save someone hours of work. If mkoeppe hadn't added me to the Cc, I would be going through the source code of sagemath right now to find the error. That would have costed me multiple days.

In General, I think it is really important that misconfigurations result in nice error messages.

Note: My issue can be found here: #29461



---

archive/issue_events_083753.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T06:20:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83753"
}
```



---

archive/issue_events_083754.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83754"
}
```



---

archive/issue_events_083755.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83755"
}
```



---

archive/issue_comments_545770.json:
```json
{
    "body": "<a id='comment:9'></a>\nI'm checking this with the up to date pyenv, and it seems that the issue with the PATH is no longer. Currently building latest beta with python 3.9-dev from pyenv on Debian stable, will report the results.",
    "created_at": "2021-01-06T12:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545770",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
I'm checking this with the up to date pyenv, and it seems that the issue with the PATH is no longer. Currently building latest beta with python 3.9-dev from pyenv on Debian stable, will report the results.



---

archive/issue_comments_545771.json:
```json
{
    "body": "<a id='comment:10'></a>\nI was able to successfully install Sage using python 3.9 from pyenv (installed following\nhttps://github.com/pyenv/pyenv#basic-github-checkout) on Debian 10.\n\nPerhaps one should check this on Homebrew, but it seems it's OK.",
    "created_at": "2021-01-06T22:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545771",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
I was able to successfully install Sage using python 3.9 from pyenv (installed following
https://github.com/pyenv/pyenv#basic-github-checkout) on Debian 10.

Perhaps one should check this on Homebrew, but it seems it's OK.



---

archive/issue_events_083756.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-06T22:23:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83756"
}
```



---

archive/issue_events_083757.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-06T22:23:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83757"
}
```



---

archive/issue_comments_545772.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-01-06T22:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545772",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_545773.json:
```json
{
    "body": "<a id='comment:11'></a>\nCan be fixed as worksforme, that is.",
    "created_at": "2021-01-06T22:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545773",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
Can be fixed as worksforme, that is.



---

archive/issue_comments_545774.json:
```json
{
    "body": "<a id='comment:12'></a>\nLet us close this if nobody objects.",
    "created_at": "2021-08-19T22:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545774",
    "user": "https://github.com/slel"
}
```

<a id='comment:12'></a>
Let us close this if nobody objects.



---

archive/issue_comments_545775.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2021-08-19T22:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545775",
    "user": "https://github.com/slel"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_545776.json:
```json
{
    "body": "**Reviewer:** Samuel Leli\u00e8vre",
    "created_at": "2021-08-19T22:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545776",
    "user": "https://github.com/slel"
}
```

**Reviewer:** Samuel Lelièvre



---

archive/issue_events_083758.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83758"
}
```



---

archive/issue_events_083759.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T02:08:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83759"
}
```



---

archive/issue_comments_545777.json:
```json
{
    "body": "**Changing status** from closed to new.",
    "created_at": "2021-10-24T17:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545777",
    "user": "https://github.com/mkoeppe"
}
```

**Changing status** from closed to new.



---

archive/issue_events_083760.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83760"
}
```



---

archive/issue_comments_545778.json:
```json
{
    "body": "<a id='comment:14'></a>\nNew issues with pyenv reported in #32749.",
    "created_at": "2021-10-24T17:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545778",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
New issues with pyenv reported in #32749.



---

archive/issue_events_083761.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-24T17:28:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83761"
}
```



---

archive/issue_events_083762.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-24T17:28:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83762"
}
```



---

archive/issue_comments_545779.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,3 +4,4 @@\n \n Tickets:\n - #29461 sage --gdb not working\n+- #32531: `SAGE_ROOT/tox.ini`: Add variants that provision a system python using `pyenv`\n``````\n",
    "created_at": "2021-10-24T17:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545779",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,3 +4,4 @@
 
 Tickets:
 - #29461 sage --gdb not working
+- #32531: `SAGE_ROOT/tox.ini`: Add variants that provision a system python using `pyenv`
``````




---

archive/issue_events_083763.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83763"
}
```



---

archive/issue_events_083764.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83764"
}
```



---

archive/issue_comments_545780.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n we had seen at least one [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) where [pyenv](https://github.com/pyenv/pyenv) broke the build, as pyenv'd Python prepends stuff like `/usr/bin` into `PATH`. \n+\n+It is documented in \n+https://github.com/pyenv/pyenv#managing-virtual-environments\n+that `pyenv` breaks everything regarding `venv`s. \n \n It might be a good idea to check this at configure time.\n \n``````\n",
    "created_at": "2022-01-01T23:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545780",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,8 @@
 we had seen at least one [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) where [pyenv](https://github.com/pyenv/pyenv) broke the build, as pyenv'd Python prepends stuff like `/usr/bin` into `PATH`. 
+
+It is documented in 
+https://github.com/pyenv/pyenv#managing-virtual-environments
+that `pyenv` breaks everything regarding `venv`s. 
 
 It might be a good idea to check this at configure time.
 
``````




---

archive/issue_events_083765.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83765"
}
```



---

archive/issue_events_083766.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-01T23:50:46Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83766"
}
```



---

archive/issue_events_083767.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-01T23:50:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83767"
}
```



---

archive/issue_events_083768.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "rename": {
        "from": "Meta-ticket: pyenv",
        "to": "Unbreak the build when pyenv is present"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83768"
}
```



---

archive/issue_comments_545781.json:
```json
{
    "body": "<a id='comment:19'></a>\nTest on macOS with `pyenv` from homebrew:\n\n```\n$ brew install pyenv\n$ pyenv install 3.7.8\n$ eval \"$(pyenv init --path)\"\n$ echo $PATH\n/Users/mkoeppe/.pyenv/shims:/Users/mkoeppe/miniconda3/condabin:/Users/mkoeppe/bin:/usr/local/bin:/Users/mkoeppe/google-cloud-sdk/bin:/Users/mkoeppe/perl5/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/opt/X11/bin\n$ pyenv global 3.7.8\n$ ./configure --enable-download-from-upstream-url --with-python=python3\n```\n(`--with-python=python3` is needed here because otherwise we reject it as misconfigured - see ticket:32531#comment:3)\n\npip's self-installation gets tricked into installing in the wrong place:\n\n```\n[pip-21.3.1] Using pip 21.3.1 from /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/tmp/sage/build/pip-21.3.1/src/src/pip (python 3.7)\n[pip-21.3.1] Looking in links: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/lib/sage/wheels\n[pip-21.3.1] Processing /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/tmp/sage/build/pip-21.3.1/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/lib/sage/wheels/pip-21.3.1-py3-none-any.whl\n[pip-21.3.1] Installing collected packages: pip\n[pip-21.3.1]   changing mode of /Users/mkoeppe/.pyenv/versions/3.7.8/bin/pip to 755\n[pip-21.3.1]   changing mode of /Users/mkoeppe/.pyenv/versions/3.7.8/bin/pip3 to 755\n[pip-21.3.1]   changing mode of /Users/mkoeppe/.pyenv/versions/3.7.8/bin/pip3.7 to 755\n[pip-21.3.1] Successfully installed pip-21.3.1\n[pip-21.3.1] \n```",
    "created_at": "2022-01-02T01:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545781",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>
Test on macOS with `pyenv` from homebrew:

```
$ brew install pyenv
$ pyenv install 3.7.8
$ eval "$(pyenv init --path)"
$ echo $PATH
/Users/mkoeppe/.pyenv/shims:/Users/mkoeppe/miniconda3/condabin:/Users/mkoeppe/bin:/usr/local/bin:/Users/mkoeppe/google-cloud-sdk/bin:/Users/mkoeppe/perl5/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/opt/X11/bin
$ pyenv global 3.7.8
$ ./configure --enable-download-from-upstream-url --with-python=python3
```
(`--with-python=python3` is needed here because otherwise we reject it as misconfigured - see ticket:32531#comment:3)

pip's self-installation gets tricked into installing in the wrong place:

```
[pip-21.3.1] Using pip 21.3.1 from /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/tmp/sage/build/pip-21.3.1/src/src/pip (python 3.7)
[pip-21.3.1] Looking in links: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/lib/sage/wheels
[pip-21.3.1] Processing /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/tmp/sage/build/pip-21.3.1/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/var/lib/sage/wheels/pip-21.3.1-py3-none-any.whl
[pip-21.3.1] Installing collected packages: pip
[pip-21.3.1]   changing mode of /Users/mkoeppe/.pyenv/versions/3.7.8/bin/pip to 755
[pip-21.3.1]   changing mode of /Users/mkoeppe/.pyenv/versions/3.7.8/bin/pip3 to 755
[pip-21.3.1]   changing mode of /Users/mkoeppe/.pyenv/versions/3.7.8/bin/pip3.7 to 755
[pip-21.3.1] Successfully installed pip-21.3.1
[pip-21.3.1] 
```



---

archive/issue_comments_545782.json:
```json
{
    "body": "<a id='comment:20'></a>\n`sage-pip-install -> sage-flock -> sage-bootstrap-python -> $HOME/.pyenv/shims -> $HOME/.pyenv/versions/3.7.8/bin/python3`; the `python3` shim manipulates PATH. \n\n```\n(sage-buildsh) mkoeppe@egret:pip-21.3.1$ python3 -c 'import os; print(os.environ[\"PATH\"])'\n/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/libexec/ccache:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/build/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin:/Users/mkoeppe/.pyenv/shims:/Users/mkoeppe/miniconda3/condabin:/Users/mkoeppe/bin:/usr/local/bin:/Users/mkoeppe/google-cloud-sdk/bin:/Users/mkoeppe/perl5/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/opt/X11/bin\n(sage-buildsh) mkoeppe@egret:pip-21.3.1$ sage-bootstrap-python -c 'import os; print(os.environ[\"PATH\"])'\n/Users/mkoeppe/.pyenv/versions/3.7.8/bin:/usr/local/Cellar/pyenv/2.2.3/libexec:/usr/local/Cellar/pyenv/2.2.3/plugins/python-build/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/libexec/ccache:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/build/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin:/Users/mkoeppe/.pyenv/shims:/Users/mkoeppe/miniconda3/condabin:/Users/mkoeppe/bin:/usr/local/bin:/Users/mkoeppe/google-cloud-sdk/bin:/Users/mkoeppe/perl5/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/opt/X11/bin\n```",
    "created_at": "2022-01-02T01:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545782",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
`sage-pip-install -> sage-flock -> sage-bootstrap-python -> $HOME/.pyenv/shims -> $HOME/.pyenv/versions/3.7.8/bin/python3`; the `python3` shim manipulates PATH. 

```
(sage-buildsh) mkoeppe@egret:pip-21.3.1$ python3 -c 'import os; print(os.environ["PATH"])'
/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/libexec/ccache:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/build/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin:/Users/mkoeppe/.pyenv/shims:/Users/mkoeppe/miniconda3/condabin:/Users/mkoeppe/bin:/usr/local/bin:/Users/mkoeppe/google-cloud-sdk/bin:/Users/mkoeppe/perl5/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/opt/X11/bin
(sage-buildsh) mkoeppe@egret:pip-21.3.1$ sage-bootstrap-python -c 'import os; print(os.environ["PATH"])'
/Users/mkoeppe/.pyenv/versions/3.7.8/bin:/usr/local/Cellar/pyenv/2.2.3/libexec:/usr/local/Cellar/pyenv/2.2.3/plugins/python-build/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/libexec/ccache:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/build/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.7/bin:/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin:/Users/mkoeppe/.pyenv/shims:/Users/mkoeppe/miniconda3/condabin:/Users/mkoeppe/bin:/usr/local/bin:/Users/mkoeppe/google-cloud-sdk/bin:/Users/mkoeppe/perl5/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/opt/X11/bin
```



---

archive/issue_comments_545783.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/unbreak_the_build_when_pyenv_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/unbreak_the_build_when_pyenv_is_present)",
    "created_at": "2022-01-02T01:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545783",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/unbreak_the_build_when_pyenv_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/unbreak_the_build_when_pyenv_is_present)



---

archive/issue_comments_545784.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,10 +1,6 @@\n-we had seen at least one [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) where [pyenv](https://github.com/pyenv/pyenv) broke the build, as pyenv'd Python prepends stuff like `/usr/bin` into `PATH`. \n+The build fails when [pyenv](https://github.com/pyenv/pyenv) is present, as reported in  [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) and also in #32749/#33103.\n \n-It is documented in \n-https://github.com/pyenv/pyenv#managing-virtual-environments\n-that `pyenv` breaks everything regarding `venv`s. \n-\n-It might be a good idea to check this at configure time.\n+We fix it by rejecting the pyenv shims for `sage-bootstrap-python`.\n \n Tickets:\n - #29461 sage --gdb not working\n``````\n",
    "created_at": "2022-01-02T01:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545784",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,10 +1,6 @@
-we had seen at least one [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) where [pyenv](https://github.com/pyenv/pyenv) broke the build, as pyenv'd Python prepends stuff like `/usr/bin` into `PATH`. 
+The build fails when [pyenv](https://github.com/pyenv/pyenv) is present, as reported in  [report](https://groups.google.com/d/msg/sage-devel/-cGmntUHXqE/Pw02KLksCgAJ) and also in #32749/#33103.
 
-It is documented in 
-https://github.com/pyenv/pyenv#managing-virtual-environments
-that `pyenv` breaks everything regarding `venv`s. 
-
-It might be a good idea to check this at configure time.
+We fix it by rejecting the pyenv shims for `sage-bootstrap-python`.
 
 Tickets:
 - #29461 sage --gdb not working
``````




---

archive/issue_comments_545785.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2022-01-02T01:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545785",
    "user": "https://github.com/mkoeppe"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_545786.json:
```json
{
    "body": "**Commit:** [376932f6933c7c210dc169d5682489f454229c66](https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66)",
    "created_at": "2022-01-02T01:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545786",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [376932f6933c7c210dc169d5682489f454229c66](https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66)



---

archive/issue_comments_545787.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2022-01-02T01:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545787",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_545788.json:
```json
{
    "body": "<a id='comment:22'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66\">376932f</a></td><td><code>build/bin/sage-bootstrap-python: Reject pyenv shims</code></td></tr></table>\n",
    "created_at": "2022-01-02T01:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545788",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66">376932f</a></td><td><code>build/bin/sage-bootstrap-python: Reject pyenv shims</code></td></tr></table>




---

archive/issue_comments_545789.json:
```json
{
    "body": "**Changing reviewer** from \"Samuel Leli\u00e8vre\" to \"\".",
    "created_at": "2022-01-02T01:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545789",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "Samuel Lelièvre" to "".



---

archive/issue_comments_545790.json:
```json
{
    "body": "**Reviewer:** https://github.com/mkoeppe/sage/runs/4682227249?check_suite_focus=true",
    "created_at": "2022-01-02T02:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545790",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** https://github.com/mkoeppe/sage/runs/4682227249?check_suite_focus=true



---

archive/issue_comments_545791.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/mkoeppe/sage/runs/4682227249?check_suite_focus=true\" to \"https://github.com/mkoeppe/sage/runs/4682289891?check_suite_focus=true\".",
    "created_at": "2022-01-02T02:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545791",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "https://github.com/mkoeppe/sage/runs/4682227249?check_suite_focus=true" to "https://github.com/mkoeppe/sage/runs/4682289891?check_suite_focus=true".



---

archive/issue_comments_545792.json:
```json
{
    "body": "<a id='comment:25'></a>\nLet's get this into 9.5 please",
    "created_at": "2022-01-02T18:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545792",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Let's get this into 9.5 please



---

archive/issue_comments_545793.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/mkoeppe/sage/runs/4682289891?check_suite_focus=true\" to \"John Palmieri\".",
    "created_at": "2022-01-04T00:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545793",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing reviewer** from "https://github.com/mkoeppe/sage/runs/4682289891?check_suite_focus=true" to "John Palmieri".



---

archive/issue_comments_545794.json:
```json
{
    "body": "<a id='comment:28'></a>\nWorks for me on OS X with homebrew's pyenv: without this branch, sage-bootstrap runs the \"wrong\" python3, while with this branch, it runs the right python3.",
    "created_at": "2022-01-04T00:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545794",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>
Works for me on OS X with homebrew's pyenv: without this branch, sage-bootstrap runs the "wrong" python3, while with this branch, it runs the right python3.



---

archive/issue_comments_545795.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-01-04T00:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545795",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_545796.json:
```json
{
    "body": "<a id='comment:29'></a>\nThank you!",
    "created_at": "2022-01-04T00:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545796",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>
Thank you!



---

archive/issue_events_083769.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83769"
}
```



---

archive/issue_comments_545797.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/unbreak_the_build_when_pyenv_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/unbreak_the_build_when_pyenv_is_present)\" to \"[376932f6933c7c210dc169d5682489f454229c66](https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66)\".",
    "created_at": "2022-01-18T22:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29285#issuecomment-545797",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/unbreak_the_build_when_pyenv_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/unbreak_the_build_when_pyenv_is_present)" to "[376932f6933c7c210dc169d5682489f454229c66](https://github.com/sagemath/sagetrac-mirror/commit/376932f6933c7c210dc169d5682489f454229c66)".



---

archive/issue_events_083770.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-18T22:01:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29285",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29285#event-83770"
}
```
