# Issue 29019: Make patch to pillow more robust (do not depend on "Py_MACOS_SYSROOT") and fix zlib problem on macOS

archive/issues_028782.json:
```json
{
    "body": "This patch was introduced in #27631 \"patch pythons to allow MacOS builds without `/usr/include`\"\nand is now causing errors in #27754 \"Upgrade: Python 3.8.x\" and #27824 \"`spkg-configure.m4` for `python3`\".\n\n**CC:**  @dimpase @embray @vbraun @jhpalmieri\n\n**Branch/Commit:** [56b16181df532469e5c680345166ea116a3e6f15](https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15)\n\n**Reviewer:** John Palmieri\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/29019\n\n",
    "closed_at": "2020-01-20T21:17:58Z",
    "created_at": "2020-01-15T18:38:38Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Make patch to pillow more robust (do not depend on \"Py_MACOS_SYSROOT\") and fix zlib problem on macOS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29019",
    "user": "https://github.com/mkoeppe"
}
```
This patch was introduced in #27631 "patch pythons to allow MacOS builds without `/usr/include`"
and is now causing errors in #27754 "Upgrade: Python 3.8.x" and #27824 "`spkg-configure.m4` for `python3`".

**CC:**  @dimpase @embray @vbraun @jhpalmieri

**Branch/Commit:** [56b16181df532469e5c680345166ea116a3e6f15](https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15)

**Reviewer:** John Palmieri

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/29019





---

archive/issue_comments_456124.json:
```json
{
    "body": "<a id='comment:1'></a>\nDima, could you look into this?",
    "created_at": "2020-01-15T19:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456124",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
Dima, could you look into this?



---

archive/issue_comments_456125.json:
```json
{
    "body": "<a id='comment:2'></a>\nplease see ticket:27754#comment:65\n\nUnless I get access to one of these new MacOS boxes with that `/usr/include`-less Xcode, I can't really be of much help.",
    "created_at": "2020-01-15T19:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456125",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
please see ticket:27754#comment:65

Unless I get access to one of these new MacOS boxes with that `/usr/include`-less Xcode, I can't really be of much help.



---

archive/issue_comments_456126.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__)",
    "created_at": "2020-01-15T19:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456126",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__)



---

archive/issue_comments_456127.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/258d1124b7b0739c306caaf8a6f9d08bb88eafdc\">258d112</a></td><td><code>build/pkgs/pillow/patches/setup.py.patch: Don't fail if Py_MACOS_SYSROOT sysconfig variable does not exist</code></td></tr></table>\n",
    "created_at": "2020-01-15T19:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456127",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/258d1124b7b0739c306caaf8a6f9d08bb88eafdc">258d112</a></td><td><code>build/pkgs/pillow/patches/setup.py.patch: Don't fail if Py_MACOS_SYSROOT sysconfig variable does not exist</code></td></tr></table>




---

archive/issue_events_257701.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-15T19:57:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29019#event-257701"
}
```



---

archive/issue_comments_456128.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2020-01-15T19:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456128",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_456129.json:
```json
{
    "body": "**Commit:** [258d1124b7b0739c306caaf8a6f9d08bb88eafdc](https://github.com/sagemath/sagetrac-mirror/commit/258d1124b7b0739c306caaf8a6f9d08bb88eafdc)",
    "created_at": "2020-01-15T19:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456129",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [258d1124b7b0739c306caaf8a6f9d08bb88eafdc](https://github.com/sagemath/sagetrac-mirror/commit/258d1124b7b0739c306caaf8a6f9d08bb88eafdc)



---

archive/issue_comments_456130.json:
```json
{
    "body": "<a id='comment:5'></a>\nThanks for providing context on that ticket.",
    "created_at": "2020-01-15T19:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456130",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Thanks for providing context on that ticket.



---

archive/issue_comments_456131.json:
```json
{
    "body": "<a id='comment:6'></a>\nWith this ticket merged,  #27824 gets one step further and now hits the zlib problem also mentioned in the python 3.8 upgrade ticket #27754.",
    "created_at": "2020-01-15T20:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456131",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
With this ticket merged,  #27824 gets one step further and now hits the zlib problem also mentioned in the python 3.8 upgrade ticket #27754.



---

archive/issue_comments_456132.json:
```json
{
    "body": "<a id='comment:7'></a>\nWe should probably patch out the entire horrible library discovery code from pillow's setup.py (https://github.com/python-pillow/Pillow/blob/master/setup.py)",
    "created_at": "2020-01-15T20:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456132",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
We should probably patch out the entire horrible library discovery code from pillow's setup.py (https://github.com/python-pillow/Pillow/blob/master/setup.py)



---

archive/issue_comments_456133.json:
```json
{
    "body": "<a id='comment:8'></a>\nUpstream issue for zlib on mac: https://github.com/python-pillow/Pillow/issues/3438",
    "created_at": "2020-01-15T20:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456133",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Upstream issue for zlib on mac: https://github.com/python-pillow/Pillow/issues/3438



---

archive/issue_comments_456134.json:
```json
{
    "body": "**Changing commit** from \"[258d1124b7b0739c306caaf8a6f9d08bb88eafdc](https://github.com/sagemath/sagetrac-mirror/commit/258d1124b7b0739c306caaf8a6f9d08bb88eafdc)\" to \"[56b16181df532469e5c680345166ea116a3e6f15](https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15)\".",
    "created_at": "2020-01-15T20:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456134",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[258d1124b7b0739c306caaf8a6f9d08bb88eafdc](https://github.com/sagemath/sagetrac-mirror/commit/258d1124b7b0739c306caaf8a6f9d08bb88eafdc)" to "[56b16181df532469e5c680345166ea116a3e6f15](https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15)".



---

archive/issue_comments_456135.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15\">56b1618</a></td><td><code>build/pkgs/pillow/spkg-install: Help setup.py find zlib.h on macOS; show more build output</code></td></tr></table>\n",
    "created_at": "2020-01-15T20:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456135",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15">56b1618</a></td><td><code>build/pkgs/pillow/spkg-install: Help setup.py find zlib.h on macOS; show more build output</code></td></tr></table>




---

archive/issue_events_257702.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-15T20:35:14Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "rename": {
        "from": "Make patch to pillow more robust (do not depend on \"Py_MACOS_SYSROOT\")",
        "to": "Make patch to pillow more robust (do not depend on \"Py_MACOS_SYSROOT\") and fix zlib problem on macOS"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29019#event-257702"
}
```



---

archive/issue_comments_456136.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis now compiles OK for me on macOS with #27824, after commenting out `MACOSX_DEPLOYMENT_TARGET` business from `sage-env`.",
    "created_at": "2020-01-15T20:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456136",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
This now compiles OK for me on macOS with #27824, after commenting out `MACOSX_DEPLOYMENT_TARGET` business from `sage-env`.



---

archive/issue_comments_456137.json:
```json
{
    "body": "<a id='comment:12'></a>\nReady for review.",
    "created_at": "2020-01-15T20:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456137",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
Ready for review.



---

archive/issue_events_257703.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-01-16T19:19:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29019#event-257703"
}
```



---

archive/issue_events_257704.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-01-16T19:19:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29019#event-257704"
}
```



---

archive/issue_comments_456138.json:
```json
{
    "body": "<a id='comment:13'></a>\nThis looks good to me, also works with Python 3.8 (#27754), where the patch setting `Py_MACOS_SYSROOT` is removed.",
    "created_at": "2020-01-16T19:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456138",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
This looks good to me, also works with Python 3.8 (#27754), where the patch setting `Py_MACOS_SYSROOT` is removed.



---

archive/issue_comments_456139.json:
```json
{
    "body": "**Reviewer:** John Palmieri",
    "created_at": "2020-01-16T19:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456139",
    "user": "https://github.com/jhpalmieri"
}
```

**Reviewer:** John Palmieri



---

archive/issue_comments_456140.json:
```json
{
    "body": "<a id='comment:14'></a>\nThank you!",
    "created_at": "2020-01-16T19:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456140",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
Thank you!



---

archive/issue_comments_456141.json:
```json
{
    "body": "<a id='comment:15'></a>\nWould there be any advantage to submitting this patch upstream?  It seems reasonable to me.",
    "created_at": "2020-01-17T14:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456141",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
Would there be any advantage to submitting this patch upstream?  It seems reasonable to me.



---

archive/issue_comments_456142.json:
```json
{
    "body": "<a id='comment:16'></a>\nUpstream is already aware of the issue (see comment 8), and we only have a workaround for us, not a general patch suitable for upstream.",
    "created_at": "2020-01-17T14:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456142",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Upstream is already aware of the issue (see comment 8), and we only have a workaround for us, not a general patch suitable for upstream.



---

archive/issue_events_257705.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-20T21:17:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29019#event-257705"
}
```



---

archive/issue_events_257706.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-20T21:17:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29019#event-257706"
}
```



---

archive/issue_comments_456143.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__)\" to \"[56b16181df532469e5c680345166ea116a3e6f15](https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15)\".",
    "created_at": "2020-01-20T21:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29019",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29019#issuecomment-456143",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/make_patch_to_pillow_more_robust__do_not_depend_on__py_macos_sysroot__)" to "[56b16181df532469e5c680345166ea116a3e6f15](https://github.com/sagemath/sagetrac-mirror/commit/56b16181df532469e5c680345166ea116a3e6f15)".
