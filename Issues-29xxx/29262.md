# Issue 29262: Combination unranking new algorithm

archive/issues_029025.json:
```json
{
    "body": "I propose to implement a new algorithm for the unranking of combinations in the lexicographic order, cf. sage.combinat.combination algorithm from_rank.\nThe actual implementation is related to McCaffrey's blog.\nIn a recent paper I have written, cf. https://hal.archives-ouvertes.fr/hal-02462764v1\nI compare this method to other from the literature and a new one I have developed with my co-authors. The paper is actually under review.\n\nIf possible I would like to commit this new implementation. My function has the same signature from the previous one.\n\nRegards.\nAntoine\n\n\nExample :\nActual implementation (on my laptop : core i7 32GiB Ubuntu Linux)\n\n```\nsage: n = 100\nsage: k = 50\nsage: set_random_seed(12345678987654321)\nsage: r = randint(0, binomial(n,k)-1)\nsage: %time A = combination.from_rank(r,n,k)\n\nCPU times: user 1.55 ms, sys: 0 ns, total: 1.55 ms\nWall time: 1.06 ms\n\n## With my algorithm\n## (in the commit the function replace from_rank(.,.,.))\n\nsage: %time B = unrank_combi_direct(r, n, k)   \n\nCPU times: user 297 \u00b5s, sys: 53 \u00b5s, total: 350 \u00b5s\nWall time: 296 \u00b5s\n\n## Finally\n\nsage: A==B\n\nTrue\n\n\n## A second example with greater values\n\nsage: n = 10000\nsage: k = 5000\nsage: set_random_seed(12345678987654321)\nsage: r = randint(0, binomial(n,k)-1)\nsage: %time A = combination.from_rank(r,n,k)\n\nCPU times: user 2.9 s, sys: 9.69 ms, total: 2.91 s\nWall time: 2.85 s\n\n## With my algorithm  (in the git branch I obviously reused the function name from_rank)\n\nsage: %time B = unrank_combi_direct(r, n, k)\n\nCPU times: user 22.4 ms, sys: 4.45 ms, total: 26.9 ms\nWall time: 21 ms\n\n## Finally\n\nsage: A==B\n\nTrue\n```\n\n\nKeywords: combination unranking\n\nReviewer: Travis Scrimshaw\n\nAuthor: Antoine Genitrini\n\nBranch: 845c21e3e4c1c2890aaa7cc06e8810d39a756ba0\n\nCommit: 845c21e3e4c1c2890aaa7cc06e8810d39a756ba0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29262\n\n",
    "closed_at": "2020-03-12T22:48:16Z",
    "created_at": "2020-02-29T15:54:45Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Combination unranking new algorithm",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29262",
    "user": "https://github.com/agenitrini"
}
```
I propose to implement a new algorithm for the unranking of combinations in the lexicographic order, cf. sage.combinat.combination algorithm from_rank.
The actual implementation is related to McCaffrey's blog.
In a recent paper I have written, cf. https://hal.archives-ouvertes.fr/hal-02462764v1
I compare this method to other from the literature and a new one I have developed with my co-authors. The paper is actually under review.

If possible I would like to commit this new implementation. My function has the same signature from the previous one.

Regards.
Antoine


Example :
Actual implementation (on my laptop : core i7 32GiB Ubuntu Linux)

```
sage: n = 100
sage: k = 50
sage: set_random_seed(12345678987654321)
sage: r = randint(0, binomial(n,k)-1)
sage: %time A = combination.from_rank(r,n,k)

CPU times: user 1.55 ms, sys: 0 ns, total: 1.55 ms
Wall time: 1.06 ms

## With my algorithm
## (in the commit the function replace from_rank(.,.,.))

sage: %time B = unrank_combi_direct(r, n, k)   

CPU times: user 297 µs, sys: 53 µs, total: 350 µs
Wall time: 296 µs

## Finally

sage: A==B

True


## A second example with greater values

sage: n = 10000
sage: k = 5000
sage: set_random_seed(12345678987654321)
sage: r = randint(0, binomial(n,k)-1)
sage: %time A = combination.from_rank(r,n,k)

CPU times: user 2.9 s, sys: 9.69 ms, total: 2.91 s
Wall time: 2.85 s

## With my algorithm  (in the git branch I obviously reused the function name from_rank)

sage: %time B = unrank_combi_direct(r, n, k)

CPU times: user 22.4 ms, sys: 4.45 ms, total: 26.9 ms
Wall time: 21 ms

## Finally

sage: A==B

True
```


Keywords: combination unranking

Reviewer: Travis Scrimshaw

Author: Antoine Genitrini

Branch: 845c21e3e4c1c2890aaa7cc06e8810d39a756ba0

Commit: 845c21e3e4c1c2890aaa7cc06e8810d39a756ba0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29262





---

archive/issue_comments_410324.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2020-02-29T16:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410324",
    "user": "https://github.com/agenitrini"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_410325.json:
```json
{
    "body": "Changing keywords from \"\" to \"combination unranking\".",
    "created_at": "2020-02-29T16:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410325",
    "user": "https://github.com/agenitrini"
}
```

Changing keywords from "" to "combination unranking".



---

archive/issue_comments_410326.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2020-02-29T16:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410326",
    "user": "https://github.com/agenitrini"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_410327.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-29T16:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410327",
    "user": "https://github.com/agenitrini"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_410328.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-29T16:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410328",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410329.json:
```json
{
    "body": "<a id='comment:5'></a>This is quite a nice improvement. So it would be good to add `[DGH20]` to the master references file (as `[DGH2020]`) and then cite it as `[DGH20]_` (or with the changed name `[DGH2020]_`). Other than that, a few PEP8 space around operators:\n\n```diff\n-if k < n/2:\n+if k < n / 2:\n\n-k = n-k\n+k = n - k\n\n-while d < k-1:\n+while d < k - 1:\n\n-if n-1-m==0:\n+if n - 1 - m == 0:\n\n-B = (B * (k-1-i))//(n-1-m)\n+B = (B * (k-1-i)) // (n-1-m)\n\n-D[k-1] = n+r+k-1-B\n+D[k-1] = n + r + k - 1 - B\n```\nand these can be simplified:\n\n```diff\n-D = [0 for i in range(k)]\n+D = [0]*k\n\n-d = d + 1\n+d += 1\n\n-i = i + 1\n+i += 1\n\n-n = n - 1\n+n += 1\n\n-r = r - B\n+r -= B\n\n-m = m + 1\n+m += 1\n\n-j = j + 1\n+j += 1\n```\nAlso would it be possible to keep the same variable names as before? While I doubt anyone is explicitly calling it with `n=foo`, it is still good in terms of being fully backwards compatible. Plus I feel it would be better to define `n0 = n` instead of the other way around.",
    "created_at": "2020-03-02T00:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410329",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>This is quite a nice improvement. So it would be good to add `[DGH20]` to the master references file (as `[DGH2020]`) and then cite it as `[DGH20]_` (or with the changed name `[DGH2020]_`). Other than that, a few PEP8 space around operators:

```diff
-if k < n/2:
+if k < n / 2:

-k = n-k
+k = n - k

-while d < k-1:
+while d < k - 1:

-if n-1-m==0:
+if n - 1 - m == 0:

-B = (B * (k-1-i))//(n-1-m)
+B = (B * (k-1-i)) // (n-1-m)

-D[k-1] = n+r+k-1-B
+D[k-1] = n + r + k - 1 - B
```
and these can be simplified:

```diff
-D = [0 for i in range(k)]
+D = [0]*k

-d = d + 1
+d += 1

-i = i + 1
+i += 1

-n = n - 1
+n += 1

-r = r - B
+r -= B

-m = m + 1
+m += 1

-j = j + 1
+j += 1
```
Also would it be possible to keep the same variable names as before? While I doubt anyone is explicitly calling it with `n=foo`, it is still good in terms of being fully backwards compatible. Plus I feel it would be better to define `n0 = n` instead of the other way around.



---

archive/issue_comments_410330.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-02T17:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410330",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410331.json:
```json
{
    "body": "<a id='comment:7'></a>Looks like you have some corner case issues appearing in `src/sage/combinat/subset.py`.",
    "created_at": "2020-03-04T02:24:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410331",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Looks like you have some corner case issues appearing in `src/sage/combinat/subset.py`.



---

archive/issue_comments_410332.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-04T02:24:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410332",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_410333.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-04T09:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410333",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410334.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-04T13:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410334",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410335.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-05T11:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410335",
    "user": "https://github.com/agenitrini"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_410336.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-05T12:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410336",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410337.json:
```json
{
    "body": "<a id='comment:11'></a>Thank you. LGTM.",
    "created_at": "2020-03-05T12:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410337",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Thank you. LGTM.



---

archive/issue_comments_410338.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-08T23:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410338",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_410339.json:
```json
{
    "body": "<a id='comment:12'></a>```\nsage -t --long --warn-long 35.8 src/sage/rings/polynomial/pbori.pyx  # 3 doctests failed\nsage -t --long --warn-long 35.8 src/sage/matrix/matrix_mpolynomial_dense.pyx  # 4 doctests failed\n```",
    "created_at": "2020-03-08T23:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410339",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>```
sage -t --long --warn-long 35.8 src/sage/rings/polynomial/pbori.pyx  # 3 doctests failed
sage -t --long --warn-long 35.8 src/sage/matrix/matrix_mpolynomial_dense.pyx  # 4 doctests failed
```



---

archive/issue_comments_410340.json:
```json
{
    "body": "<a id='comment:13'></a>So here is the problem:\n\n```\nsage: from sage.combinat.combination import from_rank\nsage: from_rank(0, 2, 1)\n(1,)\nsage: from_rank(1, 2, 1)\n(2,)\n```\ninstead this should be `(0,)` and `(1,)`. I haven't traced through the algorithm, but from testing, this seems to be just some special corner case (if indeed there is no bug in the implementation). It works on larger values of `n` and `k`.",
    "created_at": "2020-03-09T03:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410340",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>So here is the problem:

```
sage: from sage.combinat.combination import from_rank
sage: from_rank(0, 2, 1)
(1,)
sage: from_rank(1, 2, 1)
(2,)
```
instead this should be `(0,)` and `(1,)`. I haven't traced through the algorithm, but from testing, this seems to be just some special corner case (if indeed there is no bug in the implementation). It works on larger values of `n` and `k`.



---

archive/issue_comments_410341.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-09T08:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410341",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410342.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-09T08:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410342",
    "user": "https://github.com/agenitrini"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_410343.json:
```json
{
    "body": "<a id='comment:16'></a>Thank you. Green patchbot now. (Interestingly, there was a green patchbot on the previous version, so I was disregarding the other failing tests.) However, I am going to add a more systematic test (which is how I caught the corner case) on a push tomorrow morning. Should be trivial to review.",
    "created_at": "2020-03-09T12:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410343",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Thank you. Green patchbot now. (Interestingly, there was a green patchbot on the previous version, so I was disregarding the other failing tests.) However, I am going to add a more systematic test (which is how I caught the corner case) on a push tomorrow morning. Should be trivial to review.



---

archive/issue_comments_410344.json:
```json
{
    "body": "<a id='comment:17'></a>Here is my trivial change and additional doctest.\n\n---\nNew commits:",
    "created_at": "2020-03-09T23:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410344",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Here is my trivial change and additional doctest.

---
New commits:



---

archive/issue_comments_410345.json:
```json
{
    "body": "<a id='comment:18'></a>Green bot. If you agree with my changes, then please set it back to a positive review.",
    "created_at": "2020-03-11T02:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410345",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>Green bot. If you agree with my changes, then please set it back to a positive review.



---

archive/issue_comments_410346.json:
```json
{
    "body": "<a id='comment:19'></a>The tests are fine to me, thanks.",
    "created_at": "2020-03-11T06:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410346",
    "user": "https://github.com/agenitrini"
}
```

<a id='comment:19'></a>The tests are fine to me, thanks.



---

archive/issue_comments_410347.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-11T07:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410347",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410348.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-12T22:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29262#issuecomment-410348",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074428.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-12T22:48:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29262",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29262#event-74428"
}
```
