# Issue 29227: Plotting single text3d results in empty scene with Three.js viewer

archive/issues_028990.json:
```json
{
    "body": "Attempting to plot a single piece of text using the three.js viewer results in an empty scene (besides the coordinate frame):\n\n```\ntext3d(\"Hello world!\", (1, 2, 3))\n```\n\nInspecting the javascript in the generated HTML file, the `texts` array is empty: `var texts = []`\n\nAdding any other Graphics3d object (even an empty one) to it fixes the problem:\n\n```\nfrom sage.plot.plot3d.base import Graphics3d\ntext3d(\"Hello world!\", (1, 2, 3)) + Graphics3d()\n```\n\nI encountered this in my Ubuntu install based on 9.1.beta3 while working on #29194. I also tried it on my Windows install which is still 8.9, and the bug is present there as well.\n\nCC:  @egourgoulhon\n\nKeywords: threejs text text3d\n\nBranch/Commit: [e76dbdda30e241a4c29dcee4afee5a38e24ca4bd](https://github.com/sagemath/sagetrac-mirror/commit/e76dbdda30e241a4c29dcee4afee5a38e24ca4bd)\n\nReviewer: Paul Masson, Eric Gourgoulhon, Travis Scrimshaw\n\nAuthor: Joshua Campbell\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29227\n\n",
    "closed_at": "2020-03-29T00:23:44Z",
    "created_at": "2020-02-20T23:14:27Z",
    "labels": [
        "component: graphics",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Plotting single text3d results in empty scene with Three.js viewer",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29227",
    "user": "https://github.com/jcamp0x2a"
}
```
Attempting to plot a single piece of text using the three.js viewer results in an empty scene (besides the coordinate frame):

```
text3d("Hello world!", (1, 2, 3))
```

Inspecting the javascript in the generated HTML file, the `texts` array is empty: `var texts = []`

Adding any other Graphics3d object (even an empty one) to it fixes the problem:

```
from sage.plot.plot3d.base import Graphics3d
text3d("Hello world!", (1, 2, 3)) + Graphics3d()
```

I encountered this in my Ubuntu install based on 9.1.beta3 while working on #29194. I also tried it on my Windows install which is still 8.9, and the bug is present there as well.

CC:  @egourgoulhon

Keywords: threejs text text3d

Branch/Commit: [e76dbdda30e241a4c29dcee4afee5a38e24ca4bd](https://github.com/sagemath/sagetrac-mirror/commit/e76dbdda30e241a4c29dcee4afee5a38e24ca4bd)

Reviewer: Paul Masson, Eric Gourgoulhon, Travis Scrimshaw

Author: Joshua Campbell

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29227





---

archive/issue_comments_571012.json:
```json
{
    "body": "<a id='comment:1'></a>\nYeah, I remember coming across this when I first wrote the viewer. Something in the Python goes wrong somewhere. Need to run this down...",
    "created_at": "2020-02-21T01:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571012",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:1'></a>
Yeah, I remember coming across this when I first wrote the viewer. Something in the Python goes wrong somewhere. Need to run this down...



---

archive/issue_comments_571013.json:
```json
{
    "body": "<a id='comment:2'></a>\nI believe it's because [rich_repr_threejs](https://github.com/sagemath/sage/blob/develop/src/sage/plot/plot3d/base.pyx#L401) is expecting the text to always be 2 levels deep after flattening: the `for` loop grabs the 1st level, and the `hasattr(p.all[0], 'string')` is looking at the 2nd level. For a single piece of text, it's only 1 level deep (below a `TransformGroup`). But when added to another `Graphics3d` object it becomes 2 levels deep (that `TransformGroup` is now below a `Graphics3dGroup`).\n\nA similar bug can be produced going in the opposite direction (too many levels):\n\n```\nsage: t1 = text3d(\"t1\", (0,0,1))\nsage: t2 = text3d(\"t2\", (0,1,0))\nsage: t3 = text3d(\"t3\", (1,0,0))\nsage: g12 = t1 + t2\nsage: g12 = g12.translate(-1,-1,-1)\nsage: g123 = g12 + t3\nsage: show(g123)\n```\n\nIn this case, only \"t3\" gets displayed since its text is 2 levels deep but the text nodes for \"t1\" and \"t2\" are now 3 levels deep (`Graphics3dGroup` -> `TransformGroup` -> `TransformGroup` -> `Text`).\n\nI think `_rich_repr_threejs` may need to be modified to walk the tree of groups/transforms to find points/lines/texts instead of relying on flattening.",
    "created_at": "2020-02-21T21:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571013",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:2'></a>
I believe it's because [rich_repr_threejs](https://github.com/sagemath/sage/blob/develop/src/sage/plot/plot3d/base.pyx#L401) is expecting the text to always be 2 levels deep after flattening: the `for` loop grabs the 1st level, and the `hasattr(p.all[0], 'string')` is looking at the 2nd level. For a single piece of text, it's only 1 level deep (below a `TransformGroup`). But when added to another `Graphics3d` object it becomes 2 levels deep (that `TransformGroup` is now below a `Graphics3dGroup`).

A similar bug can be produced going in the opposite direction (too many levels):

```
sage: t1 = text3d("t1", (0,0,1))
sage: t2 = text3d("t2", (0,1,0))
sage: t3 = text3d("t3", (1,0,0))
sage: g12 = t1 + t2
sage: g12 = g12.translate(-1,-1,-1)
sage: g123 = g12 + t3
sage: show(g123)
```

In this case, only "t3" gets displayed since its text is 2 levels deep but the text nodes for "t1" and "t2" are now 3 levels deep (`Graphics3dGroup` -> `TransformGroup` -> `TransformGroup` -> `Text`).

I think `_rich_repr_threejs` may need to be modified to walk the tree of groups/transforms to find points/lines/texts instead of relying on flattening.



---

archive/issue_comments_571014.json:
```json
{
    "body": "<a id='comment:3'></a>\nI ran into a closely related issue earlier today due to the presence of a `TransformGroup`:\n\n```\ndef revolved(phi):\n    return parametric_plot3d([x, 0, sqrt(x)], (x, 0, 1)).rotateZ(phi)\nshow(revolved(0))\n```\n\n...works as expected and just shows a single curve, but...\n\n```\nshow(revolved(0) + revolved(pi))\n```\n\n...produces a single 3D arrow instead of the expected two curves. \n\nAfter flattening, each `Line` is under a `TransformGroup`, and both of those are under a single `Graphics3dGroup`. Thus, both lines fall into the case where `hasattr(p, '_trans')` and `hasattr(p.all[0], 'points')` are both `True`, resulting in an arrow.",
    "created_at": "2020-02-25T23:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571014",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:3'></a>
I ran into a closely related issue earlier today due to the presence of a `TransformGroup`:

```
def revolved(phi):
    return parametric_plot3d([x, 0, sqrt(x)], (x, 0, 1)).rotateZ(phi)
show(revolved(0))
```

...works as expected and just shows a single curve, but...

```
show(revolved(0) + revolved(pi))
```

...produces a single 3D arrow instead of the expected two curves. 

After flattening, each `Line` is under a `TransformGroup`, and both of those are under a single `Graphics3dGroup`. Thus, both lines fall into the case where `hasattr(p, '_trans')` and `hasattr(p.all[0], 'points')` are both `True`, resulting in an arrow.



---

archive/issue_comments_571015.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [paulmasson](#comment%3A1):\n> Yeah, I remember coming across this when I first wrote the viewer. Something in the Python goes wrong somewhere. Need to run this down...\n\n\nHi Paul. Do you mind if I take a shot at fixing this? I wanted to check with you first to make sure there's no duplicated effort. \n\nI'd like to try out walking the scene graph vs. flattening. I do have an ulterior motive: this would allow me to make my animation branch much more elegant by introducing a `KeyframeAnimationGroup` -- somewhat analogous to a `TransformGroup` -- that can be nested instead of the complicated combination of animation variables, keyframe indices, and the per-object mapping between them that I'm currently using.",
    "created_at": "2020-03-10T17:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571015",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:4'></a>
Replying to [paulmasson](#comment%3A1):
> Yeah, I remember coming across this when I first wrote the viewer. Something in the Python goes wrong somewhere. Need to run this down...


Hi Paul. Do you mind if I take a shot at fixing this? I wanted to check with you first to make sure there's no duplicated effort. 

I'd like to try out walking the scene graph vs. flattening. I do have an ulterior motive: this would allow me to make my animation branch much more elegant by introducing a `KeyframeAnimationGroup` -- somewhat analogous to a `TransformGroup` -- that can be nested instead of the complicated combination of animation variables, keyframe indices, and the per-object mapping between them that I'm currently using.



---

archive/issue_comments_571016.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [gh-jcamp0x2a](#comment%3A4):\n> Replying to [paulmasson](#comment%3A1):\n> > Yeah, I remember coming across this when I first wrote the viewer. Something in the Python goes wrong somewhere. Need to run this down...\n\n> \n> Hi Paul. Do you mind if I take a shot at fixing this? I wanted to check with you first to make sure there's no duplicated effort. \n\nGo for it!",
    "created_at": "2020-03-10T17:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571016",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:5'></a>
Replying to [gh-jcamp0x2a](#comment%3A4):
> Replying to [paulmasson](#comment%3A1):
> > Yeah, I remember coming across this when I first wrote the viewer. Something in the Python goes wrong somewhere. Need to run this down...

> 
> Hi Paul. Do you mind if I take a shot at fixing this? I wanted to check with you first to make sure there's no duplicated effort. 

Go for it!



---

archive/issue_comments_571017.json:
```json
{
    "body": "<a id='comment:6'></a>\nWill do. Thanks :)",
    "created_at": "2020-03-10T17:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571017",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:6'></a>
Will do. Thanks :)



---

archive/issue_comments_571018.json:
```json
{
    "body": "<a id='comment:7'></a>\nI pushed a branch that resolves the problems mentioned in the issue description and comments. It extends the existing pattern that was used to collect surfaces from the scene graph (`json_repr`) to points, lines, and texts via new `threejs_repr` methods. For testing, I ran through as many of the example plots from the [reference manual](https://doc.sagemath.org/html/en/reference/plot3d/index.html) as I could find.",
    "created_at": "2020-03-15T23:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571018",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:7'></a>
I pushed a branch that resolves the problems mentioned in the issue description and comments. It extends the existing pattern that was used to collect surfaces from the scene graph (`json_repr`) to points, lines, and texts via new `threejs_repr` methods. For testing, I ran through as many of the example plots from the [reference manual](https://doc.sagemath.org/html/en/reference/plot3d/index.html) as I could find.



---

archive/issue_comments_571019.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-jcamp0x2a/29227-threejs_repr\"",
    "created_at": "2020-03-15T23:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571019",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing branch from "" to "u/gh-jcamp0x2a/29227-threejs_repr"



---

archive/issue_comments_571020.json:
```json
{
    "body": "Changing commit from \"\" to \"0cc19c0188890fda05798105d67735e08f21a6a5\"",
    "created_at": "2020-03-15T23:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571020",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing commit from "" to "0cc19c0188890fda05798105d67735e08f21a6a5"



---

archive/issue_comments_571021.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-15T23:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571021",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_571022.json:
```json
{
    "body": "Changing author from \"\" to \"Joshua Campbell\"",
    "created_at": "2020-03-15T23:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571022",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing author from "" to "Joshua Campbell"



---

archive/issue_comments_571023.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis is excellent! I've confirmed it builds and runs as expected. It also fixes #29206 and #29251.\n\nQuestions about design choice: Three.js is not the only way to implement WebGL, yet you have named all your new methods `threejs_repr`. I can understand that you would want to move my Three.js-specific modifications out of `json_repr` in `index_face_set`, but should we have separate `json_repr`s for all geometric objects? Or would that just make a mess of things, since we will only be using these new methods in Three.js for the foreseeable future?\n\nEric, would you like to chime in on this ticket?",
    "created_at": "2020-03-19T21:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571023",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:8'></a>
This is excellent! I've confirmed it builds and runs as expected. It also fixes #29206 and #29251.

Questions about design choice: Three.js is not the only way to implement WebGL, yet you have named all your new methods `threejs_repr`. I can understand that you would want to move my Three.js-specific modifications out of `json_repr` in `index_face_set`, but should we have separate `json_repr`s for all geometric objects? Or would that just make a mess of things, since we will only be using these new methods in Three.js for the foreseeable future?

Eric, would you like to chime in on this ticket?



---

archive/issue_comments_571024.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [paulmasson](#comment%3A8):\n> Questions about design choice: Three.js is not the only way to implement WebGL, yet you have named all your new methods `threejs_repr`. I can understand that you would want to move my Three.js-specific modifications out of `json_repr` in `index_face_set`, but should we have separate `json_repr`s for all geometric objects? Or would that just make a mess of things, since we will only be using these new methods in Three.js for the foreseeable future?\n\n\nFor the name, I tried to follow the convention that I saw with some of the other viewers that have their own `*_repr` methods like `jmol_repr` and `tachyon_repr`. I'm not particularly attached to it, though, so I'd be okay with a `webgl_repr` or otherwise if that makes more sense.\n\nI think `json_repr` is what the canvas3d viewer uses, too, [_rich_repr_canvas3d](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/plot/plot3d/base.pyx?h=develop#n315). I don't have any experience using it, and I didn't want to possibly introduce a bug in one viewer whilst trying to fix one in another :) so I didn't make any modifications directly to those methods or try to introduce corresponding `json_repr` methods for points, lines, and text. I could revisit that decision if desired.\n\nThanks for taking a look at my changes. I know things are kinda hectic recently. I hope all is going well for you and yours.",
    "created_at": "2020-03-20T01:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571024",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:9'></a>
Replying to [paulmasson](#comment%3A8):
> Questions about design choice: Three.js is not the only way to implement WebGL, yet you have named all your new methods `threejs_repr`. I can understand that you would want to move my Three.js-specific modifications out of `json_repr` in `index_face_set`, but should we have separate `json_repr`s for all geometric objects? Or would that just make a mess of things, since we will only be using these new methods in Three.js for the foreseeable future?


For the name, I tried to follow the convention that I saw with some of the other viewers that have their own `*_repr` methods like `jmol_repr` and `tachyon_repr`. I'm not particularly attached to it, though, so I'd be okay with a `webgl_repr` or otherwise if that makes more sense.

I think `json_repr` is what the canvas3d viewer uses, too, [_rich_repr_canvas3d](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/plot/plot3d/base.pyx?h=develop#n315). I don't have any experience using it, and I didn't want to possibly introduce a bug in one viewer whilst trying to fix one in another :) so I didn't make any modifications directly to those methods or try to introduce corresponding `json_repr` methods for points, lines, and text. I could revisit that decision if desired.

Thanks for taking a look at my changes. I know things are kinda hectic recently. I hope all is going well for you and yours.



---

archive/issue_comments_571025.json:
```json
{
    "body": "<a id='comment:10'></a>\nYeah, I'm being too fussy about the method names. They're fine as is.\n\nEric, since I don't use Sage much, could you look over the code to check that it conforms to current standards for examples, documentation, etc.? Otherwise it looks good to go. Want to get this into the next beta!",
    "created_at": "2020-03-20T01:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571025",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:10'></a>
Yeah, I'm being too fussy about the method names. They're fine as is.

Eric, since I don't use Sage much, could you look over the code to check that it conforms to current standards for examples, documentation, etc.? Otherwise it looks good to go. Want to get this into the next beta!



---

archive/issue_comments_571026.json:
```json
{
    "body": "<a id='comment:11'></a>\nAnd hope as well that everyone is well in these trying times!",
    "created_at": "2020-03-20T01:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571026",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:11'></a>
And hope as well that everyone is well in these trying times!



---

archive/issue_comments_571027.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [paulmasson](#comment%3A10):\n> Yeah, I'm being too fussy about the method names. They're fine as is.\n> \n> Eric, since I don't use Sage much, could you look over the code to check that it conforms to current standards for examples, documentation, etc.? Otherwise it looks good to go. Want to get this into the next beta!\n\n\nI am currently having a look...",
    "created_at": "2020-03-21T10:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571027",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>
Replying to [paulmasson](#comment%3A10):
> Yeah, I'm being too fussy about the method names. They're fine as is.
> 
> Eric, since I don't use Sage much, could you look over the code to check that it conforms to current standards for examples, documentation, etc.? Otherwise it looks good to go. Want to get this into the next beta!


I am currently having a look...



---

archive/issue_comments_571028.json:
```json
{
    "body": "<a id='comment:13'></a>\nI gave a look to the code, checked the documentation and ran a few tests. In particular, I confirm #29206 is fixed by the current ticket. Everything looks good to me. The patchbot seems happy too.\nThanks a lot for this piece of work!",
    "created_at": "2020-03-21T10:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571028",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:13'></a>
I gave a look to the code, checked the documentation and ran a few tests. In particular, I confirm #29206 is fixed by the current ticket. Everything looks good to me. The patchbot seems happy too.
Thanks a lot for this piece of work!



---

archive/issue_comments_571029.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-21T10:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571029",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_571030.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Paul Masson, Eric Gourgoulhon\"",
    "created_at": "2020-03-21T10:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571030",
    "user": "https://github.com/egourgoulhon"
}
```

Changing reviewer from "" to "Paul Masson, Eric Gourgoulhon"



---

archive/issue_comments_571031.json:
```json
{
    "body": "<a id='comment:14'></a>\nThanks for taking a look at this Eric :)",
    "created_at": "2020-03-21T20:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571031",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:14'></a>
Thanks for taking a look at this Eric :)



---

archive/issue_comments_571032.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-23T23:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571032",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_571033.json:
```json
{
    "body": "<a id='comment:15'></a>\nOn 32-bit:\n\n```\nDoctesting 3819 files using 2 threads.\n**********************************************************************\nFile \"src/sage/plot/plot3d/implicit_surface.pyx\", line 1156, in sage.plot.plot3d.implicit_surface.ImplicitSurface.threejs_repr\nFailed example:\n    G.threejs_repr(G.default_render_params())\nExpected:\n    [('surface',\n      {'color': '#6666ff',\n       'faces': [[0, 1, 2],\n        ...\n       'opacity': 1.0,\n       'vertices': [{'x': 1.0,\n         'y': -0.9743589743589743,\n         'z': -0.02564102564102566},\n        ...\n        {'x': -1.0, 'y': 0.9487179487179487, 'z': 0.05128205128205132}]})]\nGot:\n    [('surface',\n      {'color': '#6666ff',\n       'faces': [[0, 1, 2],\n[...]\n        [20526, 20527, 20528],\n        [20529, 20530, 20531]],\n       'opacity': 1.0,\n       'vertices': [{'x': 0.9999999999999999,\n         'y': -0.9743589743589742,\n         'z': -0.025641025641025675},\n        {'x': 0.9999999999999999,\n         'y': -0.9487179487179487,\n         'z': -0.051282051282051135},\n[...]\n        {'x': -0.9743589743589743,\n         'y': 0.9487179487179487,\n         'z': 0.025641025641025605},\n        {'x': -1.0, 'y': 0.9743589743589743, 'z': 0.025641025641025605},\n        {'x': -1.0, 'y': 0.9487179487179487, 'z': 0.051282051282051246}]})]\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.plot.plot3d.implicit_surface.ImplicitSurface.threejs_repr\n    [101 tests, 1 failure, 12.17 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/plot/plot3d/implicit_surface.pyx  # 1 doctest failed\n----------------------------------------------------------------------",
    "created_at": "2020-03-23T23:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571033",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>
On 32-bit:

```
Doctesting 3819 files using 2 threads.
**********************************************************************
File "src/sage/plot/plot3d/implicit_surface.pyx", line 1156, in sage.plot.plot3d.implicit_surface.ImplicitSurface.threejs_repr
Failed example:
    G.threejs_repr(G.default_render_params())
Expected:
    [('surface',
      {'color': '#6666ff',
       'faces': [[0, 1, 2],
        ...
       'opacity': 1.0,
       'vertices': [{'x': 1.0,
         'y': -0.9743589743589743,
         'z': -0.02564102564102566},
        ...
        {'x': -1.0, 'y': 0.9487179487179487, 'z': 0.05128205128205132}]})]
Got:
    [('surface',
      {'color': '#6666ff',
       'faces': [[0, 1, 2],
[...]
        [20526, 20527, 20528],
        [20529, 20530, 20531]],
       'opacity': 1.0,
       'vertices': [{'x': 0.9999999999999999,
         'y': -0.9743589743589742,
         'z': -0.025641025641025675},
        {'x': 0.9999999999999999,
         'y': -0.9487179487179487,
         'z': -0.051282051282051135},
[...]
        {'x': -0.9743589743589743,
         'y': 0.9487179487179487,
         'z': 0.025641025641025605},
        {'x': -1.0, 'y': 0.9743589743589743, 'z': 0.025641025641025605},
        {'x': -1.0, 'y': 0.9487179487179487, 'z': 0.051282051282051246}]})]
**********************************************************************
1 item had failures:
   1 of   5 in sage.plot.plot3d.implicit_surface.ImplicitSurface.threejs_repr
    [101 tests, 1 failure, 12.17 s]
----------------------------------------------------------------------
sage -t --long src/sage/plot/plot3d/implicit_surface.pyx  # 1 doctest failed
----------------------------------------------------------------------



---

archive/issue_comments_571034.json:
```json
{
    "body": "<a id='comment:16'></a>\nHere is a branch that makes the doctest compatible with 32-bit and 64-bit.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                                                         |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|\n|[e36459a](https://github.com/sagemath/sagetrac-mirror/commit/e36459aa7acdb03c0a0e25898e0bac6eaebfa9d6)|`Merge branch 'u/gh-jcamp0x2a/29227-threejs_repr' of git://trac.sagemath.org/sage into u/gh-jcamp0x2a/29227-threejs_repr`|\n|[e76dbdd](https://github.com/sagemath/sagetrac-mirror/commit/e76dbdda30e241a4c29dcee4afee5a38e24ca4bd)|`Fixing doctest for numerical noise on 32-bit.`|",
    "created_at": "2020-03-24T05:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571034",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>
Here is a branch that makes the doctest compatible with 32-bit and 64-bit.

---
New commits:
|                                                                                                                                          |                                                                                                                         |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
|[e36459a](https://github.com/sagemath/sagetrac-mirror/commit/e36459aa7acdb03c0a0e25898e0bac6eaebfa9d6)|`Merge branch 'u/gh-jcamp0x2a/29227-threejs_repr' of git://trac.sagemath.org/sage into u/gh-jcamp0x2a/29227-threejs_repr`|
|[e76dbdd](https://github.com/sagemath/sagetrac-mirror/commit/e76dbdda30e241a4c29dcee4afee5a38e24ca4bd)|`Fixing doctest for numerical noise on 32-bit.`|



---

archive/issue_comments_571035.json:
```json
{
    "body": "Changing reviewer from \"Paul Masson, Eric Gourgoulhon\" to \"Paul Masson, Eric Gourgoulhon, Travis Scrimshaw\"",
    "created_at": "2020-03-24T05:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571035",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "Paul Masson, Eric Gourgoulhon" to "Paul Masson, Eric Gourgoulhon, Travis Scrimshaw"



---

archive/issue_comments_571036.json:
```json
{
    "body": "Changing branch from \"u/gh-jcamp0x2a/29227-threejs_repr\" to \"u/tscrim/threejs_repr-29227\"",
    "created_at": "2020-03-24T05:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571036",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "u/gh-jcamp0x2a/29227-threejs_repr" to "u/tscrim/threejs_repr-29227"



---

archive/issue_comments_571037.json:
```json
{
    "body": "Changing commit from \"0cc19c0188890fda05798105d67735e08f21a6a5\" to \"e76dbdda30e241a4c29dcee4afee5a38e24ca4bd\"",
    "created_at": "2020-03-24T05:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571037",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "0cc19c0188890fda05798105d67735e08f21a6a5" to "e76dbdda30e241a4c29dcee4afee5a38e24ca4bd"



---

archive/issue_comments_571038.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-24T05:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571038",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_571039.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-24T11:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571039",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_571040.json:
```json
{
    "body": "<a id='comment:17'></a>\nThank you Travis!",
    "created_at": "2020-03-24T11:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571040",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>
Thank you Travis!



---

archive/issue_comments_571041.json:
```json
{
    "body": "<a id='comment:18'></a>\nI'll second that! Many thanks, Travis.\n\nI got Sage up and running on a new 32-bit VM, and I was able to verify that your branch builds and that the test case in question now passes on both my 32-bit and 64-bit systems.\n\nI'll keep 32-bit in mind in any future Sage work I do.",
    "created_at": "2020-03-24T15:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571041",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:18'></a>
I'll second that! Many thanks, Travis.

I got Sage up and running on a new 32-bit VM, and I was able to verify that your branch builds and that the test case in question now passes on both my 32-bit and 64-bit systems.

I'll keep 32-bit in mind in any future Sage work I do.



---

archive/issue_comments_571042.json:
```json
{
    "body": "Changing branch from \"u/tscrim/threejs_repr-29227\" to \"e76dbdda30e241a4c29dcee4afee5a38e24ca4bd\"",
    "created_at": "2020-03-29T00:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571042",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/tscrim/threejs_repr-29227" to "e76dbdda30e241a4c29dcee4afee5a38e24ca4bd"



---

archive/issue_comments_571043.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-29T00:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29227#issuecomment-571043",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_083843.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-29T00:23:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29227",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29227#event-83843"
}
```
