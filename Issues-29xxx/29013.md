# Issue 29013: Add configure option --with-sage-venv=SAGE_VENV to create venv there instead of in SAGE_LOCAL

archive/issues_028776.json:
```json
{
    "body": "#27824 made `$SAGE_LOCAL` a venv if a suitable system python3 is found.\n\nIn this ticket, we add support for installing builds of Sage with several python versions, sharing the non-Python packages in `SAGE_LOCAL`:\n- keeping install records for Python packages (recognized by having `install-requires.txt` or `requirements.txt`) in `$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}`, separate from those of non-Python packages (`$SAGE_LOCAL/var/lib/sage/{installed,scripts}`)\n- likewise for `$SAGE_LOCAL/var/tmp/sage/build`\n- here `$SAGE_VENV` defaults to `$SAGE_LOCAL`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  `$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG`.\n\nConfiguration:\n- This is activated by running, for example, \n`./configure --with-python=/usr/bin/python3.8 --with-sage-venv=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"`.\n\n\nAs of this ticket, we are able to establish the venv in an arbitrary configured directory instead of `SAGE_LOCAL`. This is already useful for #31396 to create a wheel-building venv that will not be packaged as part of `SAGE_LOCAL`.\n\nIn follow-up tickets, we gain the full functionality that facilitates testing with several Python versions without having to rebuild the Sage distribution.  This depends on:\n\n- #30534 Repackage `pynac` as a pip-installable package\n\nFollow-ups:\n\n- We also want to support `./configure --with-sage-venv=no` which would suppress making any venv (#30896)\n\n- Support the tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real `$SAGE_LOCAL/bin/python3` needs to be built and a venv in SAGE_VENV created... or should python3 be installed in `$SAGE_VENV`?)\n\n- Optional: A file `build/pkgs/SPKG/trees` could override the install tree determination - this would allow us to for example install a package such as `jupyter_core` both into something like `SAGE_NOTEBOOK_VENV` and `SAGE_VENV`...\n\n\nCC:  @dimpase @jdemeyer @embray @vbraun @jhpalmieri\n\nKeywords: sd111\n\nBranch/Commit: d68e86144b4a37600654899d2ab655ae55fb4378\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29013\n\n",
    "closed_at": "2021-05-27T20:30:21Z",
    "created_at": "2020-01-14T22:26:27Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Add configure option --with-sage-venv=SAGE_VENV to create venv there instead of in SAGE_LOCAL",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29013",
    "user": "https://github.com/mkoeppe"
}
```
#27824 made `$SAGE_LOCAL` a venv if a suitable system python3 is found.

In this ticket, we add support for installing builds of Sage with several python versions, sharing the non-Python packages in `SAGE_LOCAL`:
- keeping install records for Python packages (recognized by having `install-requires.txt` or `requirements.txt`) in `$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}`, separate from those of non-Python packages (`$SAGE_LOCAL/var/lib/sage/{installed,scripts}`)
- likewise for `$SAGE_LOCAL/var/tmp/sage/build`
- here `$SAGE_VENV` defaults to `$SAGE_LOCAL`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  `$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG`.

Configuration:
- This is activated by running, for example, 
`./configure --with-python=/usr/bin/python3.8 --with-sage-venv="$SAGE_LOCAL/var/lib/sage/venv/python3.8"`.


As of this ticket, we are able to establish the venv in an arbitrary configured directory instead of `SAGE_LOCAL`. This is already useful for #31396 to create a wheel-building venv that will not be packaged as part of `SAGE_LOCAL`.

In follow-up tickets, we gain the full functionality that facilitates testing with several Python versions without having to rebuild the Sage distribution.  This depends on:

- #30534 Repackage `pynac` as a pip-installable package

Follow-ups:

- We also want to support `./configure --with-sage-venv=no` which would suppress making any venv (#30896)

- Support the tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real `$SAGE_LOCAL/bin/python3` needs to be built and a venv in SAGE_VENV created... or should python3 be installed in `$SAGE_VENV`?)

- Optional: A file `build/pkgs/SPKG/trees` could override the install tree determination - this would allow us to for example install a package such as `jupyter_core` both into something like `SAGE_NOTEBOOK_VENV` and `SAGE_VENV`...


CC:  @dimpase @jdemeyer @embray @vbraun @jhpalmieri

Keywords: sd111

Branch/Commit: d68e86144b4a37600654899d2ab655ae55fb4378

Reviewer: John Palmieri

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29013





---

archive/issue_comments_432674.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,9 +1,10 @@\n-We propose to create a venv (https://docs.python.org/3/library/venv.html) at \\`$SAGE_LOCAL/venv\\`, \n+We propose to create a venv (https://docs.python.org/3/library/venv.html) at \\`$SAGE_LOCAL/lib/sage/venv/sage/\\`, \n to activate the venv in the \\`sage-env\\` script, and to install all Python packages (including \\`sagelib\\`) into this venv.\n \n This is preparation for #27824, in which the system's python3 will be used when available.\n \n-Note, the proposal is to use \\`venv\\` (new since Python 3.3), not \\`virtualenv\\`. So this change will be limited to Python 3 builds of Sage.\n+Note, the proposal is to use \\`venv\\` (new since Python 3.3), not \\`virtualenv\\`. So this change will be limited to Python 3 builds of Sage. \n+\n \n Comment: 1\n \n```\n",
    "created_at": "2020-01-15T01:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432674",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,9 +1,10 @@
-We propose to create a venv (https://docs.python.org/3/library/venv.html) at \`$SAGE_LOCAL/venv\`, 
+We propose to create a venv (https://docs.python.org/3/library/venv.html) at \`$SAGE_LOCAL/lib/sage/venv/sage/\`, 
 to activate the venv in the \`sage-env\` script, and to install all Python packages (including \`sagelib\`) into this venv.
 
 This is preparation for #27824, in which the system's python3 will be used when available.
 
-Note, the proposal is to use \`venv\` (new since Python 3.3), not \`virtualenv\`. So this change will be limited to Python 3 builds of Sage.
+Note, the proposal is to use \`venv\` (new since Python 3.3), not \`virtualenv\`. So this change will be limited to Python 3 builds of Sage. 
+
 
 Comment: 1
 
```




---

archive/issue_comments_432675.json:
```json
{
    "body": "<a id='comment:3'></a>A simple change. Compiles from a fresh checkout and runs without problems on macOS.\n\n---\nNew commits:",
    "created_at": "2020-01-15T01:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432675",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>A simple change. Compiles from a fresh checkout and runs without problems on macOS.

---
New commits:



---

archive/issue_comments_432676.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-15T01:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432676",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_432677.json:
```json
{
    "body": "<a id='comment:4'></a>In the branch #27824, the venv is created by slightly more complicated code in `build/make/Makefile`. This complexity is not necessary for the present ticket.",
    "created_at": "2020-01-15T04:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432677",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>In the branch #27824, the venv is created by slightly more complicated code in `build/make/Makefile`. This complexity is not necessary for the present ticket.



---

archive/issue_comments_432678.json:
```json
{
    "body": "<a id='comment:5'></a>Does this ticket make sense separately, or only as part of #27824 ?",
    "created_at": "2020-01-15T10:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432678",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>Does this ticket make sense separately, or only as part of #27824 ?



---

archive/issue_comments_432679.json:
```json
{
    "body": "<a id='comment:6'></a>#27824 is the use case that I have in mind.\nThis ticket is a less intrusive change and should go through the betas first.",
    "created_at": "2020-01-15T14:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432679",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>#27824 is the use case that I have in mind.
This ticket is a less intrusive change and should go through the betas first.



---

archive/issue_comments_432680.json:
```json
{
    "body": "<a id='comment:8'></a>I tried building with this branch on OS X, and I got doctest failures:\n\n```\nsage -t --long src/sage/plot/plot.py  # 1 doctest failed\nsage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed\nsage -t --long src/sage/finance/time_series.pyx  # 5 doctests failed\nsage -t --long src/sage/misc/trace.py  # 4 doctests failed\nsage -t --long src/sage/env.py  # 1 doctest failed\nsage -t --long src/sage/repl/configuration.py  # 1 doctest failed\nsage -t --long src/sage/schemes/affine/affine_homset.py  # 1 doctest failed\n```\nFor example\n\n```\nFile \"src/sage/plot/plot.py\", line 521, in sage.plot.plot\nFailed example:\n    os.system(\"sage -c \\\"if 'matplotlib' in sys.modules: sys.exit(1)\\\"\") # long time\nExpected:\n    0\nGot:\n    Traceback (most recent call last):\n      File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.1.beta0/local/bin/sage-eval\", line 4, in <module>\n        from sage.all import *\n    ModuleNotFoundError: No module named 'sage'\n    256\n```\nand\n\n```\n**********************************************************************\nFile \"src/sage/matrix/matrix2.pyx\", line 1127, in sage.matrix.matrix2.Matrix.pseudoinverse\nFailed example:\n    M.pseudoinverse()  # tol 1e-15\nExpected:\n    [0.0620518477661335 0.0206839492553778 0.0124103695532267]\n    [ 0.124103695532267 0.0413678985107557 0.0248207391064534]\n    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]\nGot:\n    [0.0620518477661334 0.0206839492553778 0.0124103695532267]\n    [ 0.124103695532267 0.0413678985107556 0.0248207391064534]\n    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]\nTolerance exceeded in 2 of 9:\n    0.0620518477661335 vs 0.0620518477661334, tolerance 2e-15 > 1e-15\n    0.0413678985107557 vs 0.0413678985107556, tolerance 3e-15 > 1e-15\n**********************************************************************\nFile \"src/sage/matrix/matrix2.pyx\", line 1131, in sage.matrix.matrix2.Matrix.pseudoinverse\nFailed example:\n    M.pseudoinverse(algorithm=\"numpy\")  # tol 1e-15\nExpected:\n    [0.0620518477661335 0.0206839492553778 0.0124103695532267]\n    [ 0.124103695532267 0.0413678985107557 0.0248207391064534]\n    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]\nGot:\n    [0.0620518477661334 0.0206839492553778 0.0124103695532267]\n    [ 0.124103695532267 0.0413678985107556 0.0248207391064534]\n    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]\nTolerance exceeded in 2 of 9:\n    0.0620518477661335 vs 0.0620518477661334, tolerance 2e-15 > 1e-15\n    0.0413678985107557 vs 0.0413678985107556, tolerance 3e-15 > 1e-15\n**********************************************************************\n1 item had failures:\n   2 of  25 in sage.matrix.matrix2.Matrix.pseudoinverse\n    [2472 tests, 2 failures, 9.06 s]\n```",
    "created_at": "2020-01-15T20:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432680",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>I tried building with this branch on OS X, and I got doctest failures:

```
sage -t --long src/sage/plot/plot.py  # 1 doctest failed
sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed
sage -t --long src/sage/finance/time_series.pyx  # 5 doctests failed
sage -t --long src/sage/misc/trace.py  # 4 doctests failed
sage -t --long src/sage/env.py  # 1 doctest failed
sage -t --long src/sage/repl/configuration.py  # 1 doctest failed
sage -t --long src/sage/schemes/affine/affine_homset.py  # 1 doctest failed
```
For example

```
File "src/sage/plot/plot.py", line 521, in sage.plot.plot
Failed example:
    os.system("sage -c \"if 'matplotlib' in sys.modules: sys.exit(1)\"") # long time
Expected:
    0
Got:
    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.1.beta0/local/bin/sage-eval", line 4, in <module>
        from sage.all import *
    ModuleNotFoundError: No module named 'sage'
    256
```
and

```
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 1127, in sage.matrix.matrix2.Matrix.pseudoinverse
Failed example:
    M.pseudoinverse()  # tol 1e-15
Expected:
    [0.0620518477661335 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107557 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Got:
    [0.0620518477661334 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107556 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Tolerance exceeded in 2 of 9:
    0.0620518477661335 vs 0.0620518477661334, tolerance 2e-15 > 1e-15
    0.0413678985107557 vs 0.0413678985107556, tolerance 3e-15 > 1e-15
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 1131, in sage.matrix.matrix2.Matrix.pseudoinverse
Failed example:
    M.pseudoinverse(algorithm="numpy")  # tol 1e-15
Expected:
    [0.0620518477661335 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107557 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Got:
    [0.0620518477661334 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107556 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Tolerance exceeded in 2 of 9:
    0.0620518477661335 vs 0.0620518477661334, tolerance 2e-15 > 1e-15
    0.0413678985107557 vs 0.0413678985107556, tolerance 3e-15 > 1e-15
**********************************************************************
1 item had failures:
   2 of  25 in sage.matrix.matrix2.Matrix.pseudoinverse
    [2472 tests, 2 failures, 9.06 s]
```



---

archive/issue_comments_432681.json:
```json
{
    "body": "<a id='comment:9'></a>Thanks for testing!",
    "created_at": "2020-01-15T21:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432681",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Thanks for testing!



---

archive/issue_comments_432682.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 jhpalmieri]:\n> sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed\n\n\nNot sure what's causing the numerical failures.\n\n> sage -t --long src/sage/env.py  # 1 doctest failed\n\n\nFor this one, I have created #29022.",
    "created_at": "2020-01-15T22:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432682",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Replying to [comment:8 jhpalmieri]:
> sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed


Not sure what's causing the numerical failures.

> sage -t --long src/sage/env.py  # 1 doctest failed


For this one, I have created #29022.



---

archive/issue_comments_432683.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T22:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432683",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432684.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T23:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432685.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:10 mkoeppe]:\n> > sage -t --long src/sage/env.py  # 1 doctest failed\n\n> \n> For this one, I have created #29022.\n\n\nFixed.",
    "created_at": "2020-01-15T23:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432685",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Replying to [comment:10 mkoeppe]:
> > sage -t --long src/sage/env.py  # 1 doctest failed

> 
> For this one, I have created #29022.


Fixed.



---

archive/issue_comments_432686.json:
```json
{
    "body": "<a id='comment:14'></a>The numerical problems seems to happen because numpy does not find BLAS.",
    "created_at": "2020-01-16T02:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432686",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>The numerical problems seems to happen because numpy does not find BLAS.



---

archive/issue_comments_432687.json:
```json
{
    "body": "<a id='comment:15'></a>Actually, it does not find openblas or atlas, but it does find the \"Accelerate framework\":\n\n```\naccelerate_info:\n  FOUND:\n    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']\n    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']\n    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]\n\n  FOUND:\n    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']\n    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']\n    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]\n```",
    "created_at": "2020-01-16T02:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432687",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Actually, it does not find openblas or atlas, but it does find the "Accelerate framework":

```
accelerate_info:
  FOUND:
    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']
    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']
    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]

  FOUND:
    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']
    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']
    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]
```



---

archive/issue_comments_432688.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T03:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432688",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432689.json:
```json
{
    "body": "<a id='comment:17'></a>Merged #29025, fixes the numerical doctests.",
    "created_at": "2020-01-16T03:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432689",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Merged #29025, fixes the numerical doctests.



---

archive/issue_comments_432690.json:
```json
{
    "body": "<a id='comment:18'></a>I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)\n\n```\nsage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py\n**********************************************************************\nFile \"src/sage/sat/solvers/cryptominisat.py\", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat\nFailed example:\n    solver = CryptoMiniSat()                                  # optional - cryptominisat\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py\", line 69, in __init__\n        from pycryptosat import Solver\n    ModuleNotFoundError: No module named 'pycryptosat'\n```\nI wonder whether it uses a convoluted way to create python extensions, which got broken.",
    "created_at": "2020-01-16T09:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432690",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)

```
sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py
**********************************************************************
File "src/sage/sat/solvers/cryptominisat.py", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat
Failed example:
    solver = CryptoMiniSat()                                  # optional - cryptominisat
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
        from pycryptosat import Solver
    ModuleNotFoundError: No module named 'pycryptosat'
```
I wonder whether it uses a convoluted way to create python extensions, which got broken.



---

archive/issue_comments_432691.json:
```json
{
    "body": "<a id='comment:19'></a>oops, comment:18 belongs to #27824",
    "created_at": "2020-01-16T09:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432691",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>oops, comment:18 belongs to #27824



---

archive/issue_comments_432692.json:
```json
{
    "body": "<a id='comment:20'></a>Minor bikeshed, but why the long path \"lib/sage/venv/sage\"?  What about something like just \"lib/sage-X.Y\"; analogously to \"lib/python-X.Y\"?  We've never had a \"lib/sage\" before in the first place, so I don't see any immediate need to make the path so much more complicated.",
    "created_at": "2020-01-16T11:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432692",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>Minor bikeshed, but why the long path "lib/sage/venv/sage"?  What about something like just "lib/sage-X.Y"; analogously to "lib/python-X.Y"?  We've never had a "lib/sage" before in the first place, so I don't see any immediate need to make the path so much more complicated.



---

archive/issue_comments_432693.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 embray]:\n> Minor bikeshed, but why the long path \"lib/sage/venv/sage\"?  What about something like just \"lib/sage-X.Y\"; analogously to \"lib/python-X.Y\"?  We've never had a \"lib/sage\" before in the first place, so I don't see any immediate need to make the path so much more complicated.\n\n\n1) \"venv\" has to be in the path to indicate that it's a venv in the technical sense and not a random place with invitation to install stuff in it.\n\n2) Definitely no versioning.\n\n3) I suppose I could drop the final \"sage\", making it `lib/sage/venv`",
    "created_at": "2020-01-16T14:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432693",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Replying to [comment:20 embray]:
> Minor bikeshed, but why the long path "lib/sage/venv/sage"?  What about something like just "lib/sage-X.Y"; analogously to "lib/python-X.Y"?  We've never had a "lib/sage" before in the first place, so I don't see any immediate need to make the path so much more complicated.


1) "venv" has to be in the path to indicate that it's a venv in the technical sense and not a random place with invitation to install stuff in it.

2) Definitely no versioning.

3) I suppose I could drop the final "sage", making it `lib/sage/venv`



---

archive/issue_comments_432694.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:18 dimpase]:\n> I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)\n> \n> ```\n> sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py\n> **********************************************************************\n> File \"src/sage/sat/solvers/cryptominisat.py\", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat\n> Failed example:\n>     solver = CryptoMiniSat()                                  # optional - cryptominisat\n> Exception raised:\n>     Traceback (most recent call last):\n>       File \"/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py\", line 69, in __init__\n>         from pycryptosat import Solver\n>     ModuleNotFoundError: No module named 'pycryptosat'\n> ```\n> I wonder whether it uses a convoluted way to create python extensions, which got broken.\n\n\nUpstream merged pull request https://github.com/msoos/cryptominisat/pull/551\nto take care of a `virtualenv` installation.",
    "created_at": "2020-01-16T14:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432694",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Replying to [comment:18 dimpase]:
> I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)
> 
> ```
> sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py
> **********************************************************************
> File "src/sage/sat/solvers/cryptominisat.py", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat
> Failed example:
>     solver = CryptoMiniSat()                                  # optional - cryptominisat
> Exception raised:
>     Traceback (most recent call last):
>       File "/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
>         from pycryptosat import Solver
>     ModuleNotFoundError: No module named 'pycryptosat'
> ```
> I wonder whether it uses a convoluted way to create python extensions, which got broken.


Upstream merged pull request https://github.com/msoos/cryptominisat/pull/551
to take care of a `virtualenv` installation.



---

archive/issue_comments_432695.json:
```json
{
    "body": "<a id='comment:23'></a>I haven't tested whether this patch helps for our `venv`. The patch is not in the current release 5.6.8 (which we have).",
    "created_at": "2020-01-16T14:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432695",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>I haven't tested whether this patch helps for our `venv`. The patch is not in the current release 5.6.8 (which we have).



---

archive/issue_comments_432696.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T14:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432696",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432697.json:
```json
{
    "body": "<a id='comment:25'></a>Try with this patch please. I can't compile cryptominisat because of an unrelated reason.",
    "created_at": "2020-01-16T14:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432697",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Try with this patch please. I can't compile cryptominisat because of an unrelated reason.



---

archive/issue_comments_432698.json:
```json
{
    "body": "<a id='comment:26'></a>patch landed into a wrong place, it should be one level down, in patches/\n\ntesting now, after correction of this.",
    "created_at": "2020-01-16T15:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432698",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>patch landed into a wrong place, it should be one level down, in patches/

testing now, after correction of this.



---

archive/issue_comments_432699.json:
```json
{
    "body": "<a id='comment:27'></a>Sorry, thanks.",
    "created_at": "2020-01-16T15:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432699",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Sorry, thanks.



---

archive/issue_comments_432700.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T16:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432700",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432701.json:
```json
{
    "body": "<a id='comment:29'></a>the patch worked, it's all good with tests now.",
    "created_at": "2020-01-16T16:16:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432701",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>the patch worked, it's all good with tests now.



---

archive/issue_comments_432702.json:
```json
{
    "body": "<a id='comment:30'></a>Thank you!",
    "created_at": "2020-01-16T16:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432702",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>Thank you!



---

archive/issue_comments_432703.json:
```json
{
    "body": "<a id='comment:31'></a>I might have missed some discussion elsewhere, but I still don't see the advantage of this extra complication over having the sage environment just extend `sys.path` where necessary.  I say this as a big fan of virtualenvs in general, and having suggested doing something like this in the past.  But the more I think about it the less I see any advantage in this case over having an additional `sys.path` entry.",
    "created_at": "2020-01-16T16:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432703",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>I might have missed some discussion elsewhere, but I still don't see the advantage of this extra complication over having the sage environment just extend `sys.path` where necessary.  I say this as a big fan of virtualenvs in general, and having suggested doing something like this in the past.  But the more I think about it the less I see any advantage in this case over having an additional `sys.path` entry.



---

archive/issue_comments_432704.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 embray]:\n> I say this as a big fan of virtualenvs in general, and having suggested doing something like this in the past.  \n\nYes, of course this ticket was inspired by various insights and discussions shared by you and others on trac tickets. \n\n> But the more I think about it the less I see any advantage in this case over having an additional `sys.path` entry.\n\nPreviously, with our python2 build, there was no clear way to do it. But now with python 3 there is a standard and clean tool: that's venv. Installing into it is supported by standard tools.",
    "created_at": "2020-01-16T17:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432704",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>Replying to [comment:31 embray]:
> I say this as a big fan of virtualenvs in general, and having suggested doing something like this in the past.  

Yes, of course this ticket was inspired by various insights and discussions shared by you and others on trac tickets. 

> But the more I think about it the less I see any advantage in this case over having an additional `sys.path` entry.

Previously, with our python2 build, there was no clear way to do it. But now with python 3 there is a standard and clean tool: that's venv. Installing into it is supported by standard tools.



---

archive/issue_comments_432705.json:
```json
{
    "body": "<a id='comment:33'></a>Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.\n\nWith this approach, there will now be (depending whether or not the system Python is used) both:\n\n* `SAGE_LOCAL/lib/python3.7/site-packages`\n* `SAGE_LOCAL/lib/sage/venv/sage/lib/python3.7/site-packages`\n\nIf `SAGE_LOCAL` itself (if it exists) were a virtualenv already that would simplify matters greatly.",
    "created_at": "2020-01-16T17:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432705",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.

With this approach, there will now be (depending whether or not the system Python is used) both:

* `SAGE_LOCAL/lib/python3.7/site-packages`
* `SAGE_LOCAL/lib/sage/venv/sage/lib/python3.7/site-packages`

If `SAGE_LOCAL` itself (if it exists) were a virtualenv already that would simplify matters greatly.



---

archive/issue_comments_432706.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 embray]:\n> Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.\n\n\nNo, the present ticket explicitly avoids that.\nThe reason is that `venv` has no documented mechanism for adding non-Python stuff to it, in particular to its activation scripts.",
    "created_at": "2020-01-16T17:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432706",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Replying to [comment:33 embray]:
> Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.


No, the present ticket explicitly avoids that.
The reason is that `venv` has no documented mechanism for adding non-Python stuff to it, in particular to its activation scripts.



---

archive/issue_comments_432707.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:33 embray]:\n> With this approach, there will now be (depending whether or not the system Python is used) both:\n> \n> * `SAGE_LOCAL/lib/python3.7/site-packages`\n> * `SAGE_LOCAL/lib/sage/venv/sage/lib/python3.7/site-packages`\n\n\nThat's correct.\nIn a fresh install, the first one will be empty.\n\nIn an install upgraded from earlier versions, there will be packages in both.\nWhen there's an update, the old version if removed from the first one and the new version is added to the second one.",
    "created_at": "2020-01-16T17:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432707",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Replying to [comment:33 embray]:
> With this approach, there will now be (depending whether or not the system Python is used) both:
> 
> * `SAGE_LOCAL/lib/python3.7/site-packages`
> * `SAGE_LOCAL/lib/sage/venv/sage/lib/python3.7/site-packages`


That's correct.
In a fresh install, the first one will be empty.

In an install upgraded from earlier versions, there will be packages in both.
When there's an update, the old version if removed from the first one and the new version is added to the second one.



---

archive/issue_comments_432708.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:34 mkoeppe]:\n> Replying to [comment:33 embray]:\n> > Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.\n\n> \n> No, the present ticket explicitly avoids that.\n> The reason is that `venv` has no documented mechanism for adding non-Python stuff to it, in particular to its activation scripts.\n\n\nThere's no reason you can't--I've often install C libraries into a virtualenv by setting the path to it in `./configure --prefix`.",
    "created_at": "2020-01-16T17:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432708",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>Replying to [comment:34 mkoeppe]:
> Replying to [comment:33 embray]:
> > Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.

> 
> No, the present ticket explicitly avoids that.
> The reason is that `venv` has no documented mechanism for adding non-Python stuff to it, in particular to its activation scripts.


There's no reason you can't--I've often install C libraries into a virtualenv by setting the path to it in `./configure --prefix`.



---

archive/issue_comments_432709.json:
```json
{
    "body": "<a id='comment:37'></a>I really hate to be a pain in the ass because I know you put a lot of work into this, but I really don't get it...  It really seems complicated and messy to both activate the Sage environment, and then within that activate a virtualenv.  I don't think that's what I ever had in mind when I suggested using a virtualenv for Sage (or if I did, I take it back...)\n\nI'd still like to know what problem this is solving.  You say that it's required for #27824, but why?  What specific problems related to #27824 is it solving?  Because most likely there's another way.",
    "created_at": "2020-01-16T17:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432709",
    "user": "https://github.com/embray"
}
```

<a id='comment:37'></a>I really hate to be a pain in the ass because I know you put a lot of work into this, but I really don't get it...  It really seems complicated and messy to both activate the Sage environment, and then within that activate a virtualenv.  I don't think that's what I ever had in mind when I suggested using a virtualenv for Sage (or if I did, I take it back...)

I'd still like to know what problem this is solving.  You say that it's required for #27824, but why?  What specific problems related to #27824 is it solving?  Because most likely there's another way.



---

archive/issue_comments_432710.json:
```json
{
    "body": "<a id='comment:38'></a>Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.\nvenv removes an extra complication of sagelib being very far from pip-installable.",
    "created_at": "2020-01-16T18:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432710",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
venv removes an extra complication of sagelib being very far from pip-installable.



---

archive/issue_comments_432711.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:37 embray]:\n>  I don't think that's what I ever had in mind when I suggested using a virtualenv for Sage\n\n\nDon't worry. I'm prepared to take full credit for this specific version of the idea, if necessary.",
    "created_at": "2020-01-16T18:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432711",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Replying to [comment:37 embray]:
>  I don't think that's what I ever had in mind when I suggested using a virtualenv for Sage


Don't worry. I'm prepared to take full credit for this specific version of the idea, if necessary.



---

archive/issue_comments_432712.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:38 dimpase]:\n> Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.\n> venv removes an extra complication of sagelib being very far from pip-installable.\n\n\nHow?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.",
    "created_at": "2020-01-17T14:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432712",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'></a>Replying to [comment:38 dimpase]:
> Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
> venv removes an extra complication of sagelib being very far from pip-installable.


How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.



---

archive/issue_comments_432713.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:40 embray]:\n> Replying to [comment:38 dimpase]:\n> > Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.\n> > venv removes an extra complication of sagelib being very far from pip-installable.\n\n> \n> How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.\n\nPart of the magic is to use the standard instead of project-specific tricks.",
    "created_at": "2020-01-17T14:25:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432713",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Replying to [comment:40 embray]:
> Replying to [comment:38 dimpase]:
> > Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
> > venv removes an extra complication of sagelib being very far from pip-installable.

> 
> How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.

Part of the magic is to use the standard instead of project-specific tricks.



---

archive/issue_comments_432714.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 mkoeppe]:\n> Replying to [comment:40 embray]:\n> > Replying to [comment:38 dimpase]:\n> > > Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.\n> > > venv removes an extra complication of sagelib being very far from pip-installable.\n\n> > \n> > How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.\n\n> Part of the magic is to use the standard instead of project-specific tricks.\n\nWhat \"tricks\" are you avoiding?",
    "created_at": "2020-01-17T14:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432714",
    "user": "https://github.com/embray"
}
```

<a id='comment:42'></a>Replying to [comment:41 mkoeppe]:
> Replying to [comment:40 embray]:
> > Replying to [comment:38 dimpase]:
> > > Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
> > > venv removes an extra complication of sagelib being very far from pip-installable.

> > 
> > How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.

> Part of the magic is to use the standard instead of project-specific tricks.

What "tricks" are you avoiding?



---

archive/issue_comments_432715.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-17T21:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432715",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432716.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:21 mkoeppe]:\n> Replying to [comment:20 embray]:\n> > Minor bikeshed, but why the long path \"lib/sage/venv/sage\"?  ....\n\n> \n> 3) I suppose I could drop the final \"sage\", making it `lib/sage/venv`\n\n\nDone.",
    "created_at": "2020-01-17T21:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432716",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>Replying to [comment:21 mkoeppe]:
> Replying to [comment:20 embray]:
> > Minor bikeshed, but why the long path "lib/sage/venv/sage"?  ....

> 
> 3) I suppose I could drop the final "sage", making it `lib/sage/venv`


Done.



---

archive/issue_comments_432717.json:
```json
{
    "body": "<a id='comment:45'></a>I've also merged in a few changes from #29032 (Erik's version of python spkg-configure / venv), and the current #29022.",
    "created_at": "2020-01-17T21:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432717",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>I've also merged in a few changes from #29032 (Erik's version of python spkg-configure / venv), and the current #29022.



---

archive/issue_comments_432718.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-17T22:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432718",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432719.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-01-19T19:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432719",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_432720.json:
```json
{
    "body": "<a id='comment:50'></a>I would be interested in your comments on #29032.  By making `$SAGE_LOCAL` itself into a virtualenv--which it already essentially is in all other respects--no other weird hacks are needed.\n\nOther than some things like the OSX fixes I don't see what this solves that my branch doesn't.",
    "created_at": "2020-01-31T11:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432720",
    "user": "https://github.com/embray"
}
```

<a id='comment:50'></a>I would be interested in your comments on #29032.  By making `$SAGE_LOCAL` itself into a virtualenv--which it already essentially is in all other respects--no other weird hacks are needed.

Other than some things like the OSX fixes I don't see what this solves that my branch doesn't.



---

archive/issue_comments_432721.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-17T23:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432721",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_events_073492.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-19T16:24:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29013#event-73492"
}
```



---

archive/issue_comments_432722.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+#27824 makes \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+On this ticket, we create a venv (https://docs.python.org/3/library/venv.html) instead at \\`$SAGE_LOCAL/lib/sage/venv/sage/\\`, run the standard \\`activate\\` script in the \\`sage-env\\` script, and install all Python packages (including \\`sagelib\\`) into this venv.\n+\n+(This used to be preparation for #27824; but the approach of that has been changed.)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-03-19T16:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432722",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,9 @@
+#27824 makes \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+On this ticket, we create a venv (https://docs.python.org/3/library/venv.html) instead at \`$SAGE_LOCAL/lib/sage/venv/sage/\`, run the standard \`activate\` script in the \`sage-env\` script, and install all Python packages (including \`sagelib\`) into this venv.
+
+(This used to be preparation for #27824; but the approach of that has been changed.)
+
 
 
 Comment: 1
```




---

archive/issue_comments_432723.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages ($SAGE_LOCAL/var/lib/sage/{installed,scripts})\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+This is activated by running, for example, \\`make PYTHON_FOR_VENV=/usr/bin/python3.8 SAGE_VENV=\\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`. \n+\n+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-09-17T03:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432723",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,18 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages ($SAGE_LOCAL/var/lib/sage/{installed,scripts})
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+This is activated by running, for example, \`make PYTHON_FOR_VENV=/usr/bin/python3.8 SAGE_VENV=\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`. 
+
+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_events_073493.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-17T03:48:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29013#event-73493"
}
```



---

archive/issue_events_073494.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-17T03:48:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29013#event-73494"
}
```



---

archive/issue_comments_432724.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+This is activated by running, for example, \\`make PYTHON_FOR_VENV=/usr/bin/python3.8 SAGE_VENV=\\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`. \n+\n+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-09-17T03:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432724",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,18 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+This is activated by running, for example, \`make PYTHON_FOR_VENV=/usr/bin/python3.8 SAGE_VENV=\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`. 
+
+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432725.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+\n+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-09-17T03:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432725",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,18 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+
+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432726.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,19 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+(This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \\`${prefix}\\`.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-09-17T06:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432726",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,19 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+(This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \`${prefix}\`.)
+
+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432727.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,21 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+(This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \\`${prefix}\\`.)\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-09-18T04:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432727",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,21 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+(This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \`${prefix}\`.)
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created.)
+
+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432728.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \\`${prefix}\\`.\n+- We may also want to support \\`./configure --with-python=no\\` which would suppress making any venv.\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-10-04T17:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432728",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \`${prefix}\`.
+- We may also want to support \`./configure --with-python=no\` which would suppress making any venv.
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created.)
+
+To implement this, an SPKG needs an indication that it is a Python package - for example #30024.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432729.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \\`${prefix}\\`.\n+- We may also want to support \\`./configure --with-python=no\\` which would suppress making any venv.\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \\`install-requires.txt\\` or of \\`requirements.txt\\`.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-10-04T21:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432729",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \`${prefix}\`.
+- We may also want to support \`./configure --with-python=no\` which would suppress making any venv.
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created.)
+
+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \`install-requires.txt\` or of \`requirements.txt\`.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432730.json:
```json
{
    "body": "<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-10-04T22:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_432731.json:
```json
{
    "body": "<a id='comment:65'></a>Replaced the branch",
    "created_at": "2020-10-04T22:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432731",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:65'></a>Replaced the branch



---

archive/issue_comments_432732.json:
```json
{
    "body": "<a id='comment:67'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-05T01:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432732",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:67'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432733.json:
```json
{
    "body": "<a id='comment:68'></a>When `sage-env-config` is sourced, it overrides `PYTHON_FOR_VENV`.\nThis will be addressed in #30724.",
    "created_at": "2020-10-05T01:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432733",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:68'></a>When `sage-env-config` is sourced, it overrides `PYTHON_FOR_VENV`.
This will be addressed in #30724.



---

archive/issue_comments_432734.json:
```json
{
    "body": "<a id='comment:69'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-05T02:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:69'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432735.json:
```json
{
    "body": "<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-05T05:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432736.json:
```json
{
    "body": "<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-05T23:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432737.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \\`${prefix}\\`.\n+- We also want to support \\`./configure --with-python=no\\` which would suppress making any venv (#30896)\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \\`install-requires.txt\\` or of \\`requirements.txt\\`.\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-11-11T20:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432737",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \`${prefix}\`.
+- We also want to support \`./configure --with-python=no\` which would suppress making any venv (#30896)
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created.)
+
+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \`install-requires.txt\` or of \`requirements.txt\`.
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432738.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \\`make PYTHON_FOR_VENV=\"/usr/bin/python3.8\" SAGE_VENV=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \\`${prefix}\\`.\n+- We also want to support \\`./configure --with-python=no\\` which would suppress making any venv (#30896)\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \\`install-requires.txt\\` or of \\`requirements.txt\\`. \n+\n+(Optional: A file \\`build/pkgs/SPKG/trees\\` could override it - this would allow us to for example install a package such as \\`jupyter_core\\` both into something like \\`SAGE_NOTEBOOK_VENV\\` and \\`SAGE_VENV\\`...)\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-11-12T19:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432738",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,25 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, \`make PYTHON_FOR_VENV="/usr/bin/python3.8" SAGE_VENV="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+- This could also be a configure variable ([installation directory option](https://github.com/autotools-mirror/autoconf/blob/master/lib/autoconf/general.m4#L601)) defaulting to \`${prefix}\`.
+- We also want to support \`./configure --with-python=no\` which would suppress making any venv (#30896)
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created.)
+
+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \`install-requires.txt\` or of \`requirements.txt\`. 
+
+(Optional: A file \`build/pkgs/SPKG/trees\` could override it - this would allow us to for example install a package such as \`jupyter_core\` both into something like \`SAGE_NOTEBOOK_VENV\` and \`SAGE_VENV\`...)
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432739.json:
```json
{
    "body": "<a id='comment:77'></a>Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432739",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:77'></a>Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_432740.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432740",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_432741.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing several python versions into the same \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \n+\\`./configure --with-python=/usr/bin/python3.8 --with-sage-venv=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+- We also want to support \\`./configure --with-sage-venv=no\\` which would suppress making any venv (#30896)\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created.)\n+\n+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \\`install-requires.txt\\` or of \\`requirements.txt\\`. \n+\n+(Optional: A file \\`build/pkgs/SPKG/trees\\` could override it - this would allow us to for example install a package such as \\`jupyter_core\\` both into something like \\`SAGE_NOTEBOOK_VENV\\` and \\`SAGE_VENV\\`...)\n+\n+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2020-12-09T20:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432741",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,25 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing several python versions into the same \`SAGE_LOCAL\`:
+- keeping install records for Python packages in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, 
+\`./configure --with-python=/usr/bin/python3.8 --with-sage-venv="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+- We also want to support \`./configure --with-sage-venv=no\` which would suppress making any venv (#30896)
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created.)
+
+To implement this, an SPKG needs an indication that it is a Python package.  Per #30719, we use existence of \`install-requires.txt\` or of \`requirements.txt\`. 
+
+(Optional: A file \`build/pkgs/SPKG/trees\` could override it - this would allow us to for example install a package such as \`jupyter_core\` both into something like \`SAGE_NOTEBOOK_VENV\` and \`SAGE_VENV\`...)
+
+This is mainly for #29039; but also facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_events_073495.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-10T03:42:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29013#event-73495"
}
```



---

archive/issue_events_073496.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-10T03:42:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29013#event-73496"
}
```



---

archive/issue_comments_432742.json:
```json
{
    "body": "<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-02-26T02:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432742",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_432743.json:
```json
{
    "body": "<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-26T06:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432744.json:
```json
{
    "body": "<a id='comment:84'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-26T06:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:84'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432745.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing builds of Sage with several python versions, sharing the non-Python packages in \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages (recognized by having \\`install-requires.txt\\` or \\`requirements.txt\\`) in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \n+\\`./configure --with-python=/usr/bin/python3.8 --with-sage-venv=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+- We also want to support \\`./configure --with-sage-venv=no\\` which would suppress making any venv (#30896)\n+\n+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created... or should python3 be installed in \\`$SAGE_VENV\\`?)\n+\n+(Optional: A file \\`build/pkgs/SPKG/trees\\` could override the install tree determination - this would allow us to for example install a package such as \\`jupyter_core\\` both into something like \\`SAGE_NOTEBOOK_VENV\\` and \\`SAGE_VENV\\`...)\n+\n+This facilitates testing with several Python versions without having to rebuild the Sage distribution.\n+\n+This depends on:\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n \n \n Comment: 1\n```\n",
    "created_at": "2021-02-26T07:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432745",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing builds of Sage with several python versions, sharing the non-Python packages in \`SAGE_LOCAL\`:
+- keeping install records for Python packages (recognized by having \`install-requires.txt\` or \`requirements.txt\`) in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, 
+\`./configure --with-python=/usr/bin/python3.8 --with-sage-venv="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+- We also want to support \`./configure --with-sage-venv=no\` which would suppress making any venv (#30896)
+
+(Tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created... or should python3 be installed in \`$SAGE_VENV\`?)
+
+(Optional: A file \`build/pkgs/SPKG/trees\` could override the install tree determination - this would allow us to for example install a package such as \`jupyter_core\` both into something like \`SAGE_NOTEBOOK_VENV\` and \`SAGE_VENV\`...)
+
+This facilitates testing with several Python versions without having to rebuild the Sage distribution.
+
+This depends on:
+- #30534 Repackage \`pynac\` as a pip-installable package
 
 
 Comment: 1
```




---

archive/issue_comments_432746.json:
```json
{
    "body": "<a id='comment:87'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-26T17:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:87'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432747.json:
```json
{
    "body": "<a id='comment:88'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-03T20:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432747",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:88'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432748.json:
```json
{
    "body": "<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-03T20:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432749.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-03T20:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432749",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_432750.json:
```json
{
    "body": "<a id='comment:92'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-04T00:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432750",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:92'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432751.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,28 @@\n+#27824 made \\`$SAGE_LOCAL\\` a venv if a suitable system python3 is found.\n+\n+In this ticket, we add support for installing builds of Sage with several python versions, sharing the non-Python packages in \\`SAGE_LOCAL\\`:\n+- keeping install records for Python packages (recognized by having \\`install-requires.txt\\` or \\`requirements.txt\\`) in \\`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\\`, separate from those of non-Python packages (\\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\\`)\n+- likewise for \\`$SAGE_LOCAL/var/tmp/sage/build\\`\n+- here \\`$SAGE_VENV\\` defaults to \\`$SAGE_LOCAL\\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \\`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\\`.\n+\n+Configuration:\n+- This is activated by running, for example, \n+\\`./configure --with-python=/usr/bin/python3.8 --with-sage-venv=\"$SAGE_LOCAL/var/lib/sage/venv/python3.8\"\\`.\n+\n+\n+As of this ticket, we are able to establish the venv in an arbitrary configured directory instead of \\`SAGE_LOCAL\\`. This is already useful for #31396 to create a wheel-building venv that will not be packaged as part of \\`SAGE_LOCAL\\`.\n+\n+In follow-up tickets, we gain the full functionality that facilitates testing with several Python versions without having to rebuild the Sage distribution.  This depends on:\n+\n+- #30534 Repackage \\`pynac\\` as a pip-installable package\n+\n+Follow-ups:\n+\n+- We also want to support \\`./configure --with-sage-venv=no\\` which would suppress making any venv (#30896)\n+\n+- Support the tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \\`$SAGE_LOCAL/bin/python3\\` needs to be built and a venv in SAGE_VENV created... or should python3 be installed in \\`$SAGE_VENV\\`?)\n+\n+- Optional: A file \\`build/pkgs/SPKG/trees\\` could override the install tree determination - this would allow us to for example install a package such as \\`jupyter_core\\` both into something like \\`SAGE_NOTEBOOK_VENV\\` and \\`SAGE_VENV\\`...\n \n \n Comment: 1\n```\n",
    "created_at": "2021-04-04T19:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432751",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,28 @@
+#27824 made \`$SAGE_LOCAL\` a venv if a suitable system python3 is found.
+
+In this ticket, we add support for installing builds of Sage with several python versions, sharing the non-Python packages in \`SAGE_LOCAL\`:
+- keeping install records for Python packages (recognized by having \`install-requires.txt\` or \`requirements.txt\`) in \`$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}\`, separate from those of non-Python packages (\`$SAGE_LOCAL/var/lib/sage/{installed,scripts}\`)
+- likewise for \`$SAGE_LOCAL/var/tmp/sage/build\`
+- here \`$SAGE_VENV\` defaults to \`$SAGE_LOCAL\`, but can be overridden to an arbitrary directory that will be used as the wheel-building venv, for example  \`$SAGE_LOCAL/var/lib/sage/venv/$PYTHON_TAG\`.
+
+Configuration:
+- This is activated by running, for example, 
+\`./configure --with-python=/usr/bin/python3.8 --with-sage-venv="$SAGE_LOCAL/var/lib/sage/venv/python3.8"\`.
+
+
+As of this ticket, we are able to establish the venv in an arbitrary configured directory instead of \`SAGE_LOCAL\`. This is already useful for #31396 to create a wheel-building venv that will not be packaged as part of \`SAGE_LOCAL\`.
+
+In follow-up tickets, we gain the full functionality that facilitates testing with several Python versions without having to rebuild the Sage distribution.  This depends on:
+
+- #30534 Repackage \`pynac\` as a pip-installable package
+
+Follow-ups:
+
+- We also want to support \`./configure --with-sage-venv=no\` which would suppress making any venv (#30896)
+
+- Support the tricky case: When system python3 is not in use and SAGE_VENV != SAGE_LOCAL, then both a real \`$SAGE_LOCAL/bin/python3\` needs to be built and a venv in SAGE_VENV created... or should python3 be installed in \`$SAGE_VENV\`?)
+
+- Optional: A file \`build/pkgs/SPKG/trees\` could override the install tree determination - this would allow us to for example install a package such as \`jupyter_core\` both into something like \`SAGE_NOTEBOOK_VENV\` and \`SAGE_VENV\`...
 
 
 Comment: 1
```




---

archive/issue_comments_432752.json:
```json
{
    "body": "<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-05T18:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432752",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432753.json:
```json
{
    "body": "<a id='comment:96'></a>With `./configure --with-python=/usr/bin/python3 --with-sage-venv=\"`pwd`/local/var/lib/sage/venv/python3.8\"`, I'm getting some doctest failures:\n\n```\nsage -t --long --warn-long 101.2 --random-seed=0 src/sage/misc/package.py  # 5 doctests failed\n```\n(because it doesn't find some Python packages). Also\n\n```\nsage -t --long --warn-long 101.2 --random-seed=0 src/sage_setup/find.py  # 2 doctests failed\nsage -t --long --warn-long 101.2 --random-seed=0 src/sage_setup/clean.py  # 1 doctest failed\n```\nDetails:\n\n```\nFile \"src/sage_setup/find.py\", line 365, in sage_setup.find.installed_files_by_module\nFailed example:\n    f1\nExpected:\n    'sage/structure/__init__.py'\nGot:\n    '/Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.8/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 367, in sage_setup.find.installed_files_by_module\nFailed example:\n    f2\nExpected:\n    'sage/structure/....pyc'\nGot:\n    'sage/structure/__init__.py'\n**********************************************************************\nFile \"src/sage_setup/clean.py\", line 96, in sage_setup.clean._find_stale_files\nFailed example:\n    for f in stale_iter:\n        if f.endswith(skip_extensions): continue\n        if '/ext_data/' in f: continue\n        print('Found stale file: ' + f)\nExpected nothing\nGot:\n    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.8/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc\n...\n[followed by many many lines of \"stale\" files]\n```",
    "created_at": "2021-04-05T23:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432753",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:96'></a>With `./configure --with-python=/usr/bin/python3 --with-sage-venv="`pwd`/local/var/lib/sage/venv/python3.8"`, I'm getting some doctest failures:

```
sage -t --long --warn-long 101.2 --random-seed=0 src/sage/misc/package.py  # 5 doctests failed
```
(because it doesn't find some Python packages). Also

```
sage -t --long --warn-long 101.2 --random-seed=0 src/sage_setup/find.py  # 2 doctests failed
sage -t --long --warn-long 101.2 --random-seed=0 src/sage_setup/clean.py  # 1 doctest failed
```
Details:

```
File "src/sage_setup/find.py", line 365, in sage_setup.find.installed_files_by_module
Failed example:
    f1
Expected:
    'sage/structure/__init__.py'
Got:
    '/Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.8/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'
**********************************************************************
File "src/sage_setup/find.py", line 367, in sage_setup.find.installed_files_by_module
Failed example:
    f2
Expected:
    'sage/structure/....pyc'
Got:
    'sage/structure/__init__.py'
**********************************************************************
File "src/sage_setup/clean.py", line 96, in sage_setup.clean._find_stale_files
Failed example:
    for f in stale_iter:
        if f.endswith(skip_extensions): continue
        if '/ext_data/' in f: continue
        print('Found stale file: ' + f)
Expected nothing
Got:
    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.8/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc
...
[followed by many many lines of "stale" files]
```



---

archive/issue_comments_432754.json:
```json
{
    "body": "<a id='comment:97'></a>The ones in `find` and `clean` are I think #31314.\n\nFor the failure in `package` I know what to do",
    "created_at": "2021-04-06T00:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432754",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:97'></a>The ones in `find` and `clean` are I think #31314.

For the failure in `package` I know what to do



---

archive/issue_comments_432755.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-06T00:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432755",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_432756.json:
```json
{
    "body": "<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-06T03:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432757.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-06T04:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432757",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_432758.json:
```json
{
    "body": "<a id='comment:0'></a>The sage_setup doctest failures have vanished, but I am seeing different problems with `misc/package.py`:\n\n```\n**********************************************************************\nFile \"src/sage/misc/package.py\", line 554, in sage.misc.package.package_manifest\nFailed example:\n    sagetex_manifest = package_manifest('sagetex')  # optional - build\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.package.package_manifest[1]>\", line 1, in <module>\n        sagetex_manifest = package_manifest('sagetex')  # optional - build\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/misc/package.py\", line 570, in package_manifest\n        with open(stamp_file) as f:\n    FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/installed/sagetex-3.5'\n**********************************************************************\nFile \"src/sage/misc/package.py\", line 555, in sage.misc.package.package_manifest\nFailed example:\n    sagetex_manifest['package_name'] == 'sagetex'  # optional - build\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.package.package_manifest[2]>\", line 1, in <module>\n        sagetex_manifest['package_name'] == 'sagetex'  # optional - build\n    NameError: name 'sagetex_manifest' is not defined\n**********************************************************************\nFile \"src/sage/misc/package.py\", line 557, in sage.misc.package.package_manifest\nFailed example:\n    'files' in sagetex_manifest  # optional - build\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.package.package_manifest[3]>\", line 1, in <module>\n        'files' in sagetex_manifest  # optional - build\n    NameError: name 'sagetex_manifest' is not defined\n**********************************************************************\n```\nI guess the issue is that manifests are now written to two different places, depending on whether it's a Python package or not.",
    "created_at": "2021-04-06T21:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432758",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:0'></a>The sage_setup doctest failures have vanished, but I am seeing different problems with `misc/package.py`:

```
**********************************************************************
File "src/sage/misc/package.py", line 554, in sage.misc.package.package_manifest
Failed example:
    sagetex_manifest = package_manifest('sagetex')  # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_manifest[1]>", line 1, in <module>
        sagetex_manifest = package_manifest('sagetex')  # optional - build
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/misc/package.py", line 570, in package_manifest
        with open(stamp_file) as f:
    FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/installed/sagetex-3.5'
**********************************************************************
File "src/sage/misc/package.py", line 555, in sage.misc.package.package_manifest
Failed example:
    sagetex_manifest['package_name'] == 'sagetex'  # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_manifest[2]>", line 1, in <module>
        sagetex_manifest['package_name'] == 'sagetex'  # optional - build
    NameError: name 'sagetex_manifest' is not defined
**********************************************************************
File "src/sage/misc/package.py", line 557, in sage.misc.package.package_manifest
Failed example:
    'files' in sagetex_manifest  # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_manifest[3]>", line 1, in <module>
        'files' in sagetex_manifest  # optional - build
    NameError: name 'sagetex_manifest' is not defined
**********************************************************************
```
I guess the issue is that manifests are now written to two different places, depending on whether it's a Python package or not.



---

archive/issue_comments_432759.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-06T21:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432759",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_432760.json:
```json
{
    "body": "<a id='comment:1'></a>Right, I forgot about this function. It will need a slightly generalized interface",
    "created_at": "2021-04-06T21:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432760",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>Right, I forgot about this function. It will need a slightly generalized interface



---

archive/issue_comments_432761.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-07T00:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432762.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-07T00:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432762",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_432763.json:
```json
{
    "body": "<a id='comment:4'></a>That fixes the `package.py` doctest for me, thank you. I'm not sure I fully understand how venvs are supposed to work. If I do `./configure --with-sage-venv=... && make` and then separately do `./configure && make`, I should get two builds (as far as Python packages are concerned), which I could conceivably switch between, right? Now if I do `./configure && make pysingular`, then I can do `import PySingular`, but I switch to the other venv, I won't be able to. However, `'pysingular' in installed_packages()` returns `True` regardless of whether I'm using the venv, since it searches both installation directories.\n\n(a) Am I understanding the situation correctly? and\n\n(b) is it worth trying to fix?",
    "created_at": "2021-04-07T21:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432763",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>That fixes the `package.py` doctest for me, thank you. I'm not sure I fully understand how venvs are supposed to work. If I do `./configure --with-sage-venv=... && make` and then separately do `./configure && make`, I should get two builds (as far as Python packages are concerned), which I could conceivably switch between, right? Now if I do `./configure && make pysingular`, then I can do `import PySingular`, but I switch to the other venv, I won't be able to. However, `'pysingular' in installed_packages()` returns `True` regardless of whether I'm using the venv, since it searches both installation directories.

(a) Am I understanding the situation correctly? and

(b) is it worth trying to fix?



---

archive/issue_comments_432764.json:
```json
{
    "body": "<a id='comment:105'></a>Replying to [comment:104 jhpalmieri]:\n> I'm not sure I fully understand how venvs are supposed to work. If I do `./configure --with-sage-venv=... && make` and then separately do `./configure && make`, I should get two builds (as far as Python packages are concerned), which I could conceivably switch between, right?\n\n\nYes, that's right. Separate for Python packages, sharing the non-Python packages, which are only in SAGE_LOCAL.\n\n> Now if I do `./configure && make pysingular`, then I can do `import PySingular`, but I switch to the other venv, I won't be able to. However, `'pysingular' in installed_packages()` returns `True` regardless of whether I'm using the venv, since it searches both installation directories.\n\n\nOK, thanks for catching this. Yes, the `sage.misc.package` code does not handle this situation correctly. I would simply suggest to not mix builds that use with `--with-sage-venv=...` with builds that don't. You can switch between several venvs in this way.",
    "created_at": "2021-04-07T22:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432764",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:105'></a>Replying to [comment:104 jhpalmieri]:
> I'm not sure I fully understand how venvs are supposed to work. If I do `./configure --with-sage-venv=... && make` and then separately do `./configure && make`, I should get two builds (as far as Python packages are concerned), which I could conceivably switch between, right?


Yes, that's right. Separate for Python packages, sharing the non-Python packages, which are only in SAGE_LOCAL.

> Now if I do `./configure && make pysingular`, then I can do `import PySingular`, but I switch to the other venv, I won't be able to. However, `'pysingular' in installed_packages()` returns `True` regardless of whether I'm using the venv, since it searches both installation directories.


OK, thanks for catching this. Yes, the `sage.misc.package` code does not handle this situation correctly. I would simply suggest to not mix builds that use with `--with-sage-venv=...` with builds that don't. You can switch between several venvs in this way.



---

archive/issue_comments_432765.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-07T23:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432765",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_432766.json:
```json
{
    "body": "<a id='comment:6'></a>Great, let's merge it, then.",
    "created_at": "2021-04-07T23:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432766",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>Great, let's merge it, then.



---

archive/issue_comments_432767.json:
```json
{
    "body": "<a id='comment:7'></a>Thank you!",
    "created_at": "2021-04-08T00:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432767",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Thank you!



---

archive/issue_comments_432768.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29013#issuecomment-432768",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073497.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:30:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29013",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29013#event-73497"
}
```
