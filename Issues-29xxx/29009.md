# Issue 29009: Error using mpmath (python 3 version)

archive/issues_028772.json:
```json
{
    "body": "I have a problem with sage on python3, example sage8.9 and 9.0\n\nsimple code:\n\n```\nimport mpmath\nmpmath.mp.prec = 1000\nmpmath.findroot(lambda x: x^2 - 3, 2)\n\n______________________\n\nOverflowError: Python int too large to convert to C long\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"sage/libs/mpmath/ext_main.pyx\", line 1691, in sage.libs.mpmath.ext_main.mpf_base.__repr__ (build/cythonized/sage/libs/mpmath/ext_main.c:21256)\n    return \"mpf('%s')\" % to_str(self._mpf_, n)\n  File \"/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libmpf.py\", line 1242, in to_str\n    sign, digits, exponent = to_digits_exp(s, dps+3)\n  File \"/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libmpf.py\", line 1200, in to_digits_exp\n    digits = numeral(sd, base=10, size=dps)\n  File \"/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libintmath.py\", line 158, in numeral_python\n    A, B = divmod(n, base**half)\nSystemError: <built-in function divmod> returned a result with an error set\n```\n\n\n\n\nProblem is on File \".../SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libintmath.py\", line 161, in numeral_python\n\nand using\n\n```\nA, B = n // (base**half), n % (base**half)\n```\ninstead of\n\n```\nA, B = divmod(n, base**half)\n```\nsolves this problem\n\nCC:  @dimpase\n\nKeywords: mpmath, py3, python3\n\nBranch/Commit: e7d6c32d5a7d76ef7e337978a9db971d7fd1e89a\n\nUpstream: Reported upstream. No feedback yet.\n\nReviewer: Dima Pasechnik\n\nAuthor: Sebastian Oehms\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29009\n\n",
    "closed_at": "2021-05-27T20:30:24Z",
    "created_at": "2020-01-14T13:54:51Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Error using mpmath (python 3 version)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29009",
    "user": "https://github.com/nouret"
}
```
I have a problem with sage on python3, example sage8.9 and 9.0

simple code:

```
import mpmath
mpmath.mp.prec = 1000
mpmath.findroot(lambda x: x^2 - 3, 2)

______________________

OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "sage/libs/mpmath/ext_main.pyx", line 1691, in sage.libs.mpmath.ext_main.mpf_base.__repr__ (build/cythonized/sage/libs/mpmath/ext_main.c:21256)
    return "mpf('%s')" % to_str(self._mpf_, n)
  File "/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libmpf.py", line 1242, in to_str
    sign, digits, exponent = to_digits_exp(s, dps+3)
  File "/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libmpf.py", line 1200, in to_digits_exp
    digits = numeral(sd, base=10, size=dps)
  File "/home/nouret/SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libintmath.py", line 158, in numeral_python
    A, B = divmod(n, base**half)
SystemError: <built-in function divmod> returned a result with an error set
```




Problem is on File ".../SageMath/local/lib/python3.7/site-packages/mpmath/libmp/libintmath.py", line 161, in numeral_python

and using

```
A, B = n // (base**half), n % (base**half)
```
instead of

```
A, B = divmod(n, base**half)
```
solves this problem

CC:  @dimpase

Keywords: mpmath, py3, python3

Branch/Commit: e7d6c32d5a7d76ef7e337978a9db971d7fd1e89a

Upstream: Reported upstream. No feedback yet.

Reviewer: Dima Pasechnik

Author: Sebastian Oehms

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29009





---

archive/issue_comments_432615.json:
```json
{
    "body": "Changing keywords from \"mpmath\" to \"mpmath, py3, python3\".",
    "created_at": "2020-01-14T18:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432615",
    "user": "https://github.com/egourgoulhon"
}
```

Changing keywords from "mpmath" to "mpmath, py3, python3".



---

archive/issue_comments_432616.json:
```json
{
    "body": "<a id='comment:2'></a>As pointed out in this [sage-support thread](https://groups.google.com/d/msg/sage-support/T1Ig6k95_Z0/onv4SW9TCAAJ), everything is fine with the Python 2 version of Sage 9.1.beta0.",
    "created_at": "2020-01-14T18:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432616",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:2'></a>As pointed out in this [sage-support thread](https://groups.google.com/d/msg/sage-support/T1Ig6k95_Z0/onv4SW9TCAAJ), everything is fine with the Python 2 version of Sage 9.1.beta0.



---

archive/issue_comments_432617.json:
```json
{
    "body": "<a id='comment:3'></a>Upstream: https://github.com/fredrik-johansson/mpmath/issues/503",
    "created_at": "2020-01-14T19:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432617",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:3'></a>Upstream: https://github.com/fredrik-johansson/mpmath/issues/503



---

archive/issue_events_073474.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29009#event-73474"
}
```



---

archive/issue_comments_432618.json:
```json
{
    "body": "<a id='comment:4'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432618",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_073475.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29009#event-73475"
}
```



---

archive/issue_events_073476.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29009#event-73476"
}
```



---

archive/issue_comments_432619.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-16T06:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432619",
    "user": "https://github.com/soehms"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_432620.json:
```json
{
    "body": "<a id='comment:8'></a>The bug reported here is located in the Sage integer class, more precisely in the method `quo_rem` which is invoked from the code in `numeral_python`. Note that it disappears if you deactivate the mpmath sage backend, that means to call `os.environ['MPMATH_NOSAGE'] ='Y'` before you import `mpmath`.\n\nThe bug can be reproduced independently of mpmath in sage by the following example:\n\n```python\nsage: divmod(1, sys.maxsize+1r)\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\nOverflowError: Python int too large to convert to C long\n\nThe above exception was the direct cause of the following exception:\n\nSystemError                               Traceback (most recent call last)\n<ipython-input-1-292a3012ef4a> in <module>\n----> 1 divmod(Integer(1), sys.maxsize+1)\n\nSystemError: <built-in function divmod> returned a result with an error set\n```\n\nThe error occurs if the first argument is a sage integer and the second a python `int` of size larger than `sys.maxsize` in the statement `d = PyInt_AS_LONG(other)`. Therefore, I'm suggesting the following fix:\n\n```diff\ndiff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx\nindex a2f913df7f..a268f29355 100644\n--- a/src/sage/rings/integer.pyx\n+++ b/src/sage/rings/integer.pyx\n@@ -3468,12 +3468,21 @@ cdef class Integer(sage.structure.element.EuclideanDomainElement):\n             sage: 5.quo_rem(2/3)\n             (15/2, 0)\n\n+        Check that :trac:`29009` is fixed:\n+\n+            sage: divmod(1, sys.maxsize+1r)\n+            (0, 1)\n+            sage: import mpmath\n+            sage: mpmath.mp.prec = 1000\n+            sage: root = mpmath.findroot(lambda x: x^2 - 3, 2)\n+            sage: len(str(root))\n+            301\n         \"\"\"\n         cdef Integer q = PY_NEW(Integer)\n         cdef Integer r = PY_NEW(Integer)\n         cdef long d, res\n\n-        if type(other) is int:\n+        if is_small_python_int(other):\n             d = PyInt_AS_LONG(other)\n             if d > 0:\n                 mpz_fdiv_qr_ui(q.value, r.value, self.value, d)\n\n```\n\nI suspect that there are some other places of code using `PyInt_AS_LONG` where a similar fix will be necessary to have them work with python3 for large python `int`. Shall I open a ticket for that?\n\n---\nNew commits:",
    "created_at": "2021-04-16T06:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432620",
    "user": "https://github.com/soehms"
}
```

<a id='comment:8'></a>The bug reported here is located in the Sage integer class, more precisely in the method `quo_rem` which is invoked from the code in `numeral_python`. Note that it disappears if you deactivate the mpmath sage backend, that means to call `os.environ['MPMATH_NOSAGE'] ='Y'` before you import `mpmath`.

The bug can be reproduced independently of mpmath in sage by the following example:

```python
sage: divmod(1, sys.maxsize+1r)
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
<ipython-input-1-292a3012ef4a> in <module>
----> 1 divmod(Integer(1), sys.maxsize+1)

SystemError: <built-in function divmod> returned a result with an error set
```

The error occurs if the first argument is a sage integer and the second a python `int` of size larger than `sys.maxsize` in the statement `d = PyInt_AS_LONG(other)`. Therefore, I'm suggesting the following fix:

```diff
diff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx
index a2f913df7f..a268f29355 100644
--- a/src/sage/rings/integer.pyx
+++ b/src/sage/rings/integer.pyx
@@ -3468,12 +3468,21 @@ cdef class Integer(sage.structure.element.EuclideanDomainElement):
             sage: 5.quo_rem(2/3)
             (15/2, 0)

+        Check that :trac:`29009` is fixed:
+
+            sage: divmod(1, sys.maxsize+1r)
+            (0, 1)
+            sage: import mpmath
+            sage: mpmath.mp.prec = 1000
+            sage: root = mpmath.findroot(lambda x: x^2 - 3, 2)
+            sage: len(str(root))
+            301
         """
         cdef Integer q = PY_NEW(Integer)
         cdef Integer r = PY_NEW(Integer)
         cdef long d, res

-        if type(other) is int:
+        if is_small_python_int(other):
             d = PyInt_AS_LONG(other)
             if d > 0:
                 mpz_fdiv_qr_ui(q.value, r.value, self.value, d)

```

I suspect that there are some other places of code using `PyInt_AS_LONG` where a similar fix will be necessary to have them work with python3 for large python `int`. Shall I open a ticket for that?

---
New commits:



---

archive/issue_comments_432621.json:
```json
{
    "body": "<a id='comment:9'></a>What is the purpose of `divmod()` call in the doctest?",
    "created_at": "2021-04-16T08:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432621",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>What is the purpose of `divmod()` call in the doctest?



---

archive/issue_comments_432622.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 dimpase]:\n> What is the purpose of `divmod()` call in the doctest?\n\n\nI added this for ease of reading as it gets much closer to the problem. If you want to save tests, I can remove it (or better the other one?).",
    "created_at": "2021-04-16T10:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432622",
    "user": "https://github.com/soehms"
}
```

<a id='comment:10'></a>Replying to [comment:9 dimpase]:
> What is the purpose of `divmod()` call in the doctest?


I added this for ease of reading as it gets much closer to the problem. If you want to save tests, I can remove it (or better the other one?).



---

archive/issue_comments_432623.json:
```json
{
    "body": "<a id='comment:11'></a>please add a comment describing `divmod()` meaning (imagine someone who didn't read details of this ticket seeing it - it looks like a typo).\n\nsomething like `# sanity check - see #29009 for details` will do, if you cannot think of a better one.",
    "created_at": "2021-04-16T10:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432623",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>please add a comment describing `divmod()` meaning (imagine someone who didn't read details of this ticket seeing it - it looks like a typo).

something like `# sanity check - see #29009 for details` will do, if you cannot think of a better one.



---

archive/issue_comments_432624.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-16T10:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432624",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_432625.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-16T11:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432625",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_073477.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-16T11:01:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29009#event-73477"
}
```



---

archive/issue_events_073478.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-16T11:01:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29009#event-73478"
}
```



---

archive/issue_comments_432626.json:
```json
{
    "body": "<a id='comment:14'></a>Thanks! There is another similar one: #31676",
    "created_at": "2021-04-16T13:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432626",
    "user": "https://github.com/soehms"
}
```

<a id='comment:14'></a>Thanks! There is another similar one: #31676



---

archive/issue_comments_432627.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29009#issuecomment-432627",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073479.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:30:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29009",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29009#event-73479"
}
```
