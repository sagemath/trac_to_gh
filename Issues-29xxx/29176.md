# Issue 29176: Bug in Voronoi Diagram

archive/issues_028939.json:
```json
{
    "body": "We fix a bug that was exposed computing an inexact Voronoi Diagram (see below).\n\n`cdd` already computes the incidence matrix, we expose it in this ticket.\n\nWhen deciding whether or not a vertex lies on a hyperplane for inexact polyhedra, we allow numerical noise up to absolute value of `1e-6`. This might be a bad choice depending on the size of the polyhedron as witnessed in the following example:\n\n```\n\nsage: e = [[11582947.657000002, 5374.38, 4177.06, 1.0], [11562795.9322, 5373.62, 4168.38, 1.0]]\nsage: p = Polyhedron(ieqs=e); p\nA 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line\nsage: p.incidence_matrix()\n[0 0]\n[0 0]\n[0 1]\n[0 0]\n```\n\nSetting the cache of incidence matrix to the matrix that `cdd` already computed for us produces the correct output:\n\n```\nsage: p.incidence_matrix()\n[1 1]\n[1 0]\n[0 1]\n[1 1]\n```\n\nThis fixes the error reported here:\n\nhttps://ask.sagemath.org/question/49749/voronoidiagram-returns-empty-regions/\n\nThe following should give two non-empty regions\n\n```\nsage: P = [[-2687.19, -2088.53], [-2686.81, -2084.19]]\n....: V = VoronoiDiagram(P)\n....: R = V.regions()\n....: \nsage: R\n{P(-2687.19000000000, -2088.53000000000): The empty polyhedron in RDF^0,\n P(-2686.81000000000, -2084.19000000000): A 1-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex and 1 ray\n```\n\nWith this ticket we obtain:\n\n```\nsage: R\n{P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,\n P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}\n```\n\nCC:  @jplab @laisrast\n\nKeywords: cdd, incidence matrix\n\nReviewer: Jean-Philippe Labb\u00e9\n\nAuthor: Jonathan Kliem\n\nBranch: fb2d66a0e71f164e9bef37922c8d544b9b270c9c\n\nCommit: fb2d66a0e71f164e9bef37922c8d544b9b270c9c\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29176\n\n",
    "closed_at": "2020-05-02T21:58:26Z",
    "created_at": "2020-02-10T12:53:15Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Bug in Voronoi Diagram",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29176",
    "user": "https://github.com/jplab"
}
```
We fix a bug that was exposed computing an inexact Voronoi Diagram (see below).

`cdd` already computes the incidence matrix, we expose it in this ticket.

When deciding whether or not a vertex lies on a hyperplane for inexact polyhedra, we allow numerical noise up to absolute value of `1e-6`. This might be a bad choice depending on the size of the polyhedron as witnessed in the following example:

```

sage: e = [[11582947.657000002, 5374.38, 4177.06, 1.0], [11562795.9322, 5373.62, 4168.38, 1.0]]
sage: p = Polyhedron(ieqs=e); p
A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line
sage: p.incidence_matrix()
[0 0]
[0 0]
[0 1]
[0 0]
```

Setting the cache of incidence matrix to the matrix that `cdd` already computed for us produces the correct output:

```
sage: p.incidence_matrix()
[1 1]
[1 0]
[0 1]
[1 1]
```

This fixes the error reported here:

https://ask.sagemath.org/question/49749/voronoidiagram-returns-empty-regions/

The following should give two non-empty regions

```
sage: P = [[-2687.19, -2088.53], [-2686.81, -2084.19]]
....: V = VoronoiDiagram(P)
....: R = V.regions()
....: 
sage: R
{P(-2687.19000000000, -2088.53000000000): The empty polyhedron in RDF^0,
 P(-2686.81000000000, -2084.19000000000): A 1-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex and 1 ray
```

With this ticket we obtain:

```
sage: R
{P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,
 P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}
```

CC:  @jplab @laisrast

Keywords: cdd, incidence matrix

Reviewer: Jean-Philippe Labb√©

Author: Jonathan Kliem

Branch: fb2d66a0e71f164e9bef37922c8d544b9b270c9c

Commit: fb2d66a0e71f164e9bef37922c8d544b9b270c9c

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29176





---

archive/issue_comments_409243.json:
```json
{
    "body": "<a id='comment:1'></a>This can and should be solved by fetching the incidences from cdd.\n\nI will try to do so. This might get rid of a lot of numerical inconsistencies.",
    "created_at": "2020-03-19T11:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409243",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>This can and should be solved by fetching the incidences from cdd.

I will try to do so. This might get rid of a lot of numerical inconsistencies.



---

archive/issue_comments_409244.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2020-03-19T14:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409244",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_409245.json:
```json
{
    "body": "Changing keywords from \"\" to \"cdd, incidence matrix\".",
    "created_at": "2020-03-19T14:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409245",
    "user": "https://github.com/kliem"
}
```

Changing keywords from "" to "cdd, incidence matrix".



---

archive/issue_comments_409246.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-19T14:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409246",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409247.json:
```json
{
    "body": "<a id='comment:3'></a>Thanks! Looks good to me.",
    "created_at": "2020-04-19T13:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409247",
    "user": "https://github.com/jplab"
}
```

<a id='comment:3'></a>Thanks! Looks good to me.



---

archive/issue_comments_409248.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-19T13:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409248",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_409249.json:
```json
{
    "body": "<a id='comment:4'></a>Thank you.",
    "created_at": "2020-04-19T13:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409249",
    "user": "https://github.com/kliem"
}
```

<a id='comment:4'></a>Thank you.



---

archive/issue_comments_409250.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-04-21T22:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409250",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_409251.json:
```json
{
    "body": "<a id='comment:5'></a>On Python 2 Debian 9 x86_64:\n\n```\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/backend_cdd.py\", line 231, in sage.geometry.polyhedron.backend_cdd.Polyhedron_cdd._init_from_cdd_output\nFailed example:\n    R\nExpected:\n    {P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,\n     P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}\nGot:\n    {P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,\n     P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}\n**********************************************************************\n1 item had failures:\n```",
    "created_at": "2020-04-21T22:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409251",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>On Python 2 Debian 9 x86_64:

```
**********************************************************************
File "src/sage/geometry/polyhedron/backend_cdd.py", line 231, in sage.geometry.polyhedron.backend_cdd.Polyhedron_cdd._init_from_cdd_output
Failed example:
    R
Expected:
    {P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,
     P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}
Got:
    {P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,
     P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}
**********************************************************************
1 item had failures:
```



---

archive/issue_comments_409252.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-22T05:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409252",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409253.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-22T05:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409253",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_409254.json:
```json
{
    "body": "<a id='comment:7'></a>I tested this in python2:\n\n```\n>>> {(-2686.81000000000, -2084.19000000000): 0, (-2687.19000000000, -2088.53000000000): 0}\n{(-2687.19, -2088.53): 0, (-2686.81, -2084.19): 0}\n```\n\nSo the fix should work fine.",
    "created_at": "2020-04-22T05:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409254",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>I tested this in python2:

```
>>> {(-2686.81000000000, -2084.19000000000): 0, (-2687.19000000000, -2088.53000000000): 0}
{(-2687.19, -2088.53): 0, (-2686.81, -2084.19): 0}
```

So the fix should work fine.



---

archive/issue_comments_409255.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-22T12:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409255",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_409256.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks for the quick fix.",
    "created_at": "2020-04-22T12:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409256",
    "user": "https://github.com/jplab"
}
```

<a id='comment:8'></a>Thanks for the quick fix.



---

archive/issue_comments_409257.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-23T22:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409257",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074091.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-23T22:32:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29176#event-74091"
}
```



---

archive/issue_comments_409258.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2020-04-25T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409258",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_074092.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-25T08:52:42Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29176#event-74092"
}
```



---

archive/issue_comments_409259.json:
```json
{
    "body": "<a id='comment:10'></a>```\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/backend_cdd.py\", line 234, in sage.geometry.polyhedron.backend_cdd.Polyhedron_cdd._init_from_cdd_output\nFailed example:\n    R  # py2\nExpected:\n    {P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,\n     P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}\nGot:\n    {P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,\n     P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}\n**********************************************************************\n1 item had failures:\n   1 of  10 in sage.geometry.polyhedron.backend_cdd.Polyhedron_cdd._init_from_cdd_output\n    [46 tests, 1 failure, 0.59 s]\n**********************************************************************\n```",
    "created_at": "2020-04-25T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409259",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>```
**********************************************************************
File "src/sage/geometry/polyhedron/backend_cdd.py", line 234, in sage.geometry.polyhedron.backend_cdd.Polyhedron_cdd._init_from_cdd_output
Failed example:
    R  # py2
Expected:
    {P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,
     P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}
Got:
    {P(-2686.81000000000, -2084.19000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line,
     P(-2687.19000000000, -2088.53000000000): A 2-dimensional polyhedron in RDF^2 defined as the convex hull of 1 vertex, 1 ray, 1 line}
**********************************************************************
1 item had failures:
   1 of  10 in sage.geometry.polyhedron.backend_cdd.Polyhedron_cdd._init_from_cdd_output
    [46 tests, 1 failure, 0.59 s]
**********************************************************************
```



---

archive/issue_comments_409260.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2020-04-25T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409260",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_409261.json:
```json
{
    "body": "<a id='comment:11'></a>Got rid of the dictionary printing in the tests.\n\n---\nNew commits:",
    "created_at": "2020-04-25T22:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409261",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Got rid of the dictionary printing in the tests.

---
New commits:



---

archive/issue_comments_409262.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-25T22:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409262",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409263.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-27T07:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409263",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_409264.json:
```json
{
    "body": "<a id='comment:13'></a>Thank you.",
    "created_at": "2020-04-27T07:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409264",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>Thank you.



---

archive/issue_comments_409265.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-02T21:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29176#issuecomment-409265",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074093.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-05-02T21:58:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29176",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29176#event-74093"
}
```
