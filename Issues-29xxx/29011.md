# Issue 29011: speed up number field element conversions

archive/issues_028774.json:
```json
{
    "body": "CC:  @videlec\n\nThese simple changes (especially the first one) lead to surprisingly large speed-ups in real computations (larger speedups, in fact, that I'm able to observe in micro-benchmarks!). For instance, using ore_algebra:\n\n9.1.beta0:\n\n```\nsage: from ore_algebra.examples import cbt\n....: dop = cbt.dop[10]\n....: s = dop.leading_coefficient().roots(QQbar, multiplicities=False)[0]\n....: %time mat = dop.numerical_transition_matrix([0,s], 1e-30)\nCPU times: user 2.45 s, sys: 79 \u00b5s, total: 2.45 s\nWall time: 2.45 s\n```\n\nwith these patches:\n\n```\nsage: from ore_algebra.examples import cbt\n....: dop = cbt.dop[10]\n....: s = dop.leading_coefficient().roots(QQbar, multiplicities=False)[0]\n....: %time mat = dop.numerical_transition_matrix([0,s], 1e-30)\nCPU times: user 1.65 s, sys: 8.26 ms, total: 1.66 s\nWall time: 1.66 s\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/29011\n\n",
    "closed_at": "2020-01-25T17:27:27Z",
    "created_at": "2020-01-14T16:38:27Z",
    "labels": [
        "component: basic arithmetic",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "speed up number field element conversions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29011",
    "user": "https://github.com/mezzarobba"
}
```
CC:  @videlec

These simple changes (especially the first one) lead to surprisingly large speed-ups in real computations (larger speedups, in fact, that I'm able to observe in micro-benchmarks!). For instance, using ore_algebra:

9.1.beta0:

```
sage: from ore_algebra.examples import cbt
....: dop = cbt.dop[10]
....: s = dop.leading_coefficient().roots(QQbar, multiplicities=False)[0]
....: %time mat = dop.numerical_transition_matrix([0,s], 1e-30)
CPU times: user 2.45 s, sys: 79 µs, total: 2.45 s
Wall time: 2.45 s
```

with these patches:

```
sage: from ore_algebra.examples import cbt
....: dop = cbt.dop[10]
....: s = dop.leading_coefficient().roots(QQbar, multiplicities=False)[0]
....: %time mat = dop.numerical_transition_matrix([0,s], 1e-30)
CPU times: user 1.65 s, sys: 8.26 ms, total: 1.66 s
Wall time: 1.66 s
```

Issue created by migration from https://trac.sagemath.org/ticket/29011





---

archive/issue_comments_405953.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2020-01-14T16:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405953",
    "user": "https://github.com/mezzarobba"
}
```

Changing priority from major to minor.



---

archive/issue_comments_405954.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-01-14T16:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405954",
    "user": "https://github.com/mezzarobba"
}
```

New commits:



---

archive/issue_comments_405955.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-14T16:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405955",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405956.json:
```json
{
    "body": "I am a little hesitant to use ``@`cached_method` for `gen_embedding` because the embedding could, in principle, originally not be defined and then added. In this case, I think it would be best to implement a custom cache:\n\n```python\nif self._gen_emb is not None:\n    return self._gen_emb\nembedding = self.coerce_embedding()\nif embedding is None:\n    return None\nelse:\n    self._gen_emb = embedding(self.gen())\n    return self._gen_emb\n```",
    "created_at": "2020-01-16T03:58:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405956",
    "user": "https://github.com/tscrim"
}
```

I am a little hesitant to use ``@`cached_method` for `gen_embedding` because the embedding could, in principle, originally not be defined and then added. In this case, I think it would be best to implement a custom cache:

```python
if self._gen_emb is not None:
    return self._gen_emb
embedding = self.coerce_embedding()
if embedding is None:
    return None
else:
    self._gen_emb = embedding(self.gen())
    return self._gen_emb
```



---

archive/issue_comments_405957.json:
```json
{
    "body": "Thank you for the comment. \n\nReplying to [comment:2 tscrim]:\n> I am a little hesitant to use ``@`cached_method` for `gen_embedding` because the embedding could, in principle, originally not be defined and then added.\n\n\nDo you mean by misusing `register_embedding()` (which is not supposed to be be called after the parent has been \u201cused\u201d), or is there another mechanism I'm unaware of?",
    "created_at": "2020-01-16T12:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405957",
    "user": "https://github.com/mezzarobba"
}
```

Thank you for the comment. 

Replying to [comment:2 tscrim]:
> I am a little hesitant to use ``@`cached_method` for `gen_embedding` because the embedding could, in principle, originally not be defined and then added.


Do you mean by misusing `register_embedding()` (which is not supposed to be be called after the parent has been “used”), or is there another mechanism I'm unaware of?



---

archive/issue_comments_405958.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Thank you for the comment. \n> \n> Replying to [comment:2 tscrim]:\n> > I am a little hesitant to use ``@`cached_method` for `gen_embedding` because the embedding could, in principle, originally not be defined and then added.\n\n> \n> Do you mean by misusing `register_embedding()` (which is not supposed to be be called after the parent has been \u201cused\u201d), or is there another mechanism I'm unaware of?\n\n\nWell, I am not sure it is a misuse because suppose you create the field, then try `gen_embedding` but no embedding is found (which does not use the coercion framework), and then use `register_embedding` (say, because you forgot to set it) and try `gen_embedding` again. Granted, this is a very exceptional case, but it could happen. Perhaps it is sufficient to put in a `.. WARNING::` about this instructing the user to clear the cache for this method if this does happen?",
    "created_at": "2020-01-16T15:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405958",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:3 mmezzarobba]:
> Thank you for the comment. 
> 
> Replying to [comment:2 tscrim]:
> > I am a little hesitant to use ``@`cached_method` for `gen_embedding` because the embedding could, in principle, originally not be defined and then added.

> 
> Do you mean by misusing `register_embedding()` (which is not supposed to be be called after the parent has been “used”), or is there another mechanism I'm unaware of?


Well, I am not sure it is a misuse because suppose you create the field, then try `gen_embedding` but no embedding is found (which does not use the coercion framework), and then use `register_embedding` (say, because you forgot to set it) and try `gen_embedding` again. Granted, this is a very exceptional case, but it could happen. Perhaps it is sufficient to put in a `.. WARNING::` about this instructing the user to clear the cache for this method if this does happen?



---

archive/issue_comments_405959.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-17T14:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405959",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_405960.json:
```json
{
    "body": "I'm fine with you suggestion; I just wanted to be sure I understood what you had in mind.",
    "created_at": "2020-01-17T14:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405960",
    "user": "https://github.com/mezzarobba"
}
```

I'm fine with you suggestion; I just wanted to be sure I understood what you had in mind.



---

archive/issue_comments_405961.json:
```json
{
    "body": "Now you have it double cached. `;)` The more I think about it, the more I am convinced that your original way with a ``@`cached_method` was best since my situation is a very special (and somewhat pathological) corner case that we can warn users about and it is the most simple in terms of code. Anyways, feel free to use whichever solution you want, both are good IMO.",
    "created_at": "2020-01-17T16:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405961",
    "user": "https://github.com/tscrim"
}
```

Now you have it double cached. `;)` The more I think about it, the more I am convinced that your original way with a ``@`cached_method` was best since my situation is a very special (and somewhat pathological) corner case that we can warn users about and it is the most simple in terms of code. Anyways, feel free to use whichever solution you want, both are good IMO.



---

archive/issue_comments_405962.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-18T10:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_405963.json:
```json
{
    "body": "Ooooops. Reverted.",
    "created_at": "2020-01-18T10:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405963",
    "user": "https://github.com/mezzarobba"
}
```

Ooooops. Reverted.



---

archive/issue_comments_405964.json:
```json
{
    "body": "I don't have time to investigate what happens right now, but it looks like ``@`cached_method` may be doing some magic that makes what you suggested even without a custom cache:\n\n```\nsage: K = NumberField(x^2+7, 'a')\nsage: K.gen_embedding()\nsage: K.register_embedding(K.embeddings(CC)[0])\nsage: K.gen_embedding()\n-2.64575131106459*I\n```",
    "created_at": "2020-01-18T10:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405964",
    "user": "https://github.com/mezzarobba"
}
```

I don't have time to investigate what happens right now, but it looks like ``@`cached_method` may be doing some magic that makes what you suggested even without a custom cache:

```
sage: K = NumberField(x^2+7, 'a')
sage: K.gen_embedding()
sage: K.register_embedding(K.embeddings(CC)[0])
sage: K.gen_embedding()
-2.64575131106459*I
```



---

archive/issue_comments_405965.json:
```json
{
    "body": "That is very surprising to me as the ``@`cached_method` shouldn't behave any differently when returning `None`. It is also not like it is returning a variable that has a reference that can be changed either. Well, if this is not an issue then it doesn't need to be documented I guess... Still it would be nice to know why this happens.",
    "created_at": "2020-01-18T14:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405965",
    "user": "https://github.com/tscrim"
}
```

That is very surprising to me as the ``@`cached_method` shouldn't behave any differently when returning `None`. It is also not like it is returning a variable that has a reference that can be changed either. Well, if this is not an issue then it doesn't need to be documented I guess... Still it would be nice to know why this happens.



---

archive/issue_comments_405966.json:
```json
{
    "body": "So I can confirm this in an isolated context:\n\n```\nsage: class Foo(object):\n....:     def __init__(self):\n....:         self.x = None\n....:     @cached_method\n....:     def bar(self):\n....:         if self.x is None:\n....:             return None\n....:         return 5\n....:     \nsage: f = Foo()\nsage: f.bar()\nsage: f.x = -2\nsage: f.bar()\n5\n```\n\n```\nsage: class Foo(object):\n....:     def __init__(self):\n....:         self.x = None\n....:     @cached_method\n....:     def bar(self):\n....:         if self.x is None:\n....:             return -1\n....:         return 5\n....:     \nsage: f = Foo()\nsage: f.bar()\n-1\nsage: f.x = 0\nsage: f.bar()\n-1\n```\nHowever, the same does *not* hold for ``@`cached_function`\n\n```\nsage: x = None\nsage: @cached_function\n....: def foo():\n....:     if x is None:\n....:         return None\n....:     return 5\n....: \nsage: foo()\nsage: x = 2\nsage: foo()\n```\nHowever, I would say this is a bug with ``@`cached_method` because sometimes having a result of `None` is important and a result of a long computation. This is now #29037. So I would be inclined to leave a warning of the effect `This method is cached, so be sure to define the embedding before using it.`",
    "created_at": "2020-01-18T15:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405966",
    "user": "https://github.com/tscrim"
}
```

So I can confirm this in an isolated context:

```
sage: class Foo(object):
....:     def __init__(self):
....:         self.x = None
....:     @cached_method
....:     def bar(self):
....:         if self.x is None:
....:             return None
....:         return 5
....:     
sage: f = Foo()
sage: f.bar()
sage: f.x = -2
sage: f.bar()
5
```

```
sage: class Foo(object):
....:     def __init__(self):
....:         self.x = None
....:     @cached_method
....:     def bar(self):
....:         if self.x is None:
....:             return -1
....:         return 5
....:     
sage: f = Foo()
sage: f.bar()
-1
sage: f.x = 0
sage: f.bar()
-1
```
However, the same does *not* hold for ``@`cached_function`

```
sage: x = None
sage: @cached_function
....: def foo():
....:     if x is None:
....:         return None
....:     return 5
....: 
sage: foo()
sage: x = 2
sage: foo()
```
However, I would say this is a bug with ``@`cached_method` because sometimes having a result of `None` is important and a result of a long computation. This is now #29037. So I would be inclined to leave a warning of the effect `This method is cached, so be sure to define the embedding before using it.`



---

archive/issue_comments_405967.json:
```json
{
    "body": "Okay from #29037, this is actually documented behavior, but only applies to methods that do not take any arguments. I think it is a likely necessary side-effect of the implementation, so the current state is good as the behavior of ``@`cached_method` is documented and it works well with the implementation here.",
    "created_at": "2020-01-18T16:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405967",
    "user": "https://github.com/tscrim"
}
```

Okay from #29037, this is actually documented behavior, but only applies to methods that do not take any arguments. I think it is a likely necessary side-effect of the implementation, so the current state is good as the behavior of ``@`cached_method` is documented and it works well with the implementation here.



---

archive/issue_comments_405968.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-18T16:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405968",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_073481.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-25T17:27:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29011#event-73481"
}
```



---

archive/issue_comments_405969.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-25T17:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29011",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29011#issuecomment-405969",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
