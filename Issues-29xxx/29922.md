# Issue 29922: sage.doctest: Make imports more specific; make global environment for tests customizable

archive/issues_029685.json:
```json
{
    "body": "We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).\n\n1. An explicit import in `sage.doctest.parsing`:\n\n```\n# We need to import from sage.all to avoid circular imports.\nfrom sage.all import RealIntervalField\nRIFtol = RealIntervalField(1044)\n```\n\n\n2. We make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:\n\n```\n    import sage.repl.ipython_kernel.all_jupyter\n```\n   and again in `DocTestTask._run`:\n\n```\n            # Import Jupyter globals to doctest the Jupyter\n            # implementation of widgets and interacts\n            import sage.repl.ipython_kernel.all_jupyter as sage_all\n```\n... which is\n\n```\n\"\"\"\nAll imports for Jupyter\n\"\"\"\n\nfrom sage.all_cmdline import *\n\nfrom .widgets_sagenb import (input_box, text_control, slider,\n        range_slider, checkbox, selector, input_grid, color_selector)\nfrom .interact import interact\n```\n\n   This is exposed by the new `sage-runtest` option `--environment`.\n\n   For example, #29865 defines modules such as `sage.all__sage_objects`. We would invoke `sage -t --environment=sage.all__sage_objects` to test against this global environment.\n\n\n3. We ignore errors importing `sage.interfaces`.\n\n\n\nCC:  @tscrim @fchapoton @orlitzky @kliem @kiwifb\n\nBranch/Commit: 2a602df11ae0e6d3b8d8d964636c75063b51df43\n\nReviewer: Jonathan Kliem\n\nAuthor: Matthias Koeppe\n\nDependencies: #29940\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29922\n\n",
    "closed_at": "2020-07-25T22:51:09Z",
    "created_at": "2020-06-20T21:29:57Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "sage.doctest: Make imports more specific; make global environment for tests customizable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29922",
    "user": "https://github.com/mkoeppe"
}
```
We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).

1. An explicit import in `sage.doctest.parsing`:

```
# We need to import from sage.all to avoid circular imports.
from sage.all import RealIntervalField
RIFtol = RealIntervalField(1044)
```


2. We make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:

```
    import sage.repl.ipython_kernel.all_jupyter
```
   and again in `DocTestTask._run`:

```
            # Import Jupyter globals to doctest the Jupyter
            # implementation of widgets and interacts
            import sage.repl.ipython_kernel.all_jupyter as sage_all
```
... which is

```
"""
All imports for Jupyter
"""

from sage.all_cmdline import *

from .widgets_sagenb import (input_box, text_control, slider,
        range_slider, checkbox, selector, input_grid, color_selector)
from .interact import interact
```

   This is exposed by the new `sage-runtest` option `--environment`.

   For example, #29865 defines modules such as `sage.all__sage_objects`. We would invoke `sage -t --environment=sage.all__sage_objects` to test against this global environment.


3. We ignore errors importing `sage.interfaces`.



CC:  @tscrim @fchapoton @orlitzky @kliem @kiwifb

Branch/Commit: 2a602df11ae0e6d3b8d8d964636c75063b51df43

Reviewer: Jonathan Kliem

Author: Matthias Koeppe

Dependencies: #29940

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29922





---

archive/issue_comments_449272.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,10 @@\n+In `sage.doctest.parsing`:\n+\n+```\n+# We need to import from sage.all to avoid circular imports.\n+from sage.all import RealIntervalField\n+RIFtol = RealIntervalField(1044)\n+```\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-06-20T21:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449272",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,10 @@
+In `sage.doctest.parsing`:
+
+```
+# We need to import from sage.all to avoid circular imports.
+from sage.all import RealIntervalField
+RIFtol = RealIntervalField(1044)
+```
 
 
 Comment: 1
``````




---

archive/issue_comments_449273.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,35 @@\n+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).\n+\n+1. A rather disturbing, graphic import in `sage.doctest.parsing`:\n+\n+```\n+# We need to import from sage.all to avoid circular imports.\n+from sage.all import RealIntervalField\n+RIFtol = RealIntervalField(1044)\n+```\n+\n+\n+2. We need to make the global environment for tests customizable in `sage.doctest.forker`:\n+\n+```\n+            # Import Jupyter globals to doctest the Jupyter\n+            # implementation of widgets and interacts\n+            import sage.repl.ipython_kernel.all_jupyter as sage_all\n+```\n+... which is\n+\n+```\n+\"\"\"\n+All imports for Jupyter\n+\"\"\"\n+\n+from sage.all_cmdline import *\n+\n+from .widgets_sagenb import (input_box, text_control, slider,\n+        range_slider, checkbox, selector, input_grid, color_selector)\n+from .interact import interact\n+```\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-06-20T21:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449273",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,35 @@
+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).
+
+1. A rather disturbing, graphic import in `sage.doctest.parsing`:
+
+```
+# We need to import from sage.all to avoid circular imports.
+from sage.all import RealIntervalField
+RIFtol = RealIntervalField(1044)
+```
+
+
+2. We need to make the global environment for tests customizable in `sage.doctest.forker`:
+
+```
+            # Import Jupyter globals to doctest the Jupyter
+            # implementation of widgets and interacts
+            import sage.repl.ipython_kernel.all_jupyter as sage_all
+```
+... which is
+
+```
+"""
+All imports for Jupyter
+"""
+
+from sage.all_cmdline import *
+
+from .widgets_sagenb import (input_box, text_control, slider,
+        range_slider, checkbox, selector, input_grid, color_selector)
+from .interact import interact
+```
+
 
 
 Comment: 1
``````




---

archive/issue_comments_449274.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,40 @@\n+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).\n+\n+1. A rather disturbing, graphic import in `sage.doctest.parsing`:\n+\n+```\n+# We need to import from sage.all to avoid circular imports.\n+from sage.all import RealIntervalField\n+RIFtol = RealIntervalField(1044)\n+```\n+\n+\n+2. We need to make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:\n+\n+```\n+    import sage.repl.ipython_kernel.all_jupyter\n+```\n+   and again in `DocTestTask._run`:\n+\n+```\n+            # Import Jupyter globals to doctest the Jupyter\n+            # implementation of widgets and interacts\n+            import sage.repl.ipython_kernel.all_jupyter as sage_all\n+```\n+... which is\n+\n+```\n+\"\"\"\n+All imports for Jupyter\n+\"\"\"\n+\n+from sage.all_cmdline import *\n+\n+from .widgets_sagenb import (input_box, text_control, slider,\n+        range_slider, checkbox, selector, input_grid, color_selector)\n+from .interact import interact\n+```\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-06-20T21:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449274",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,40 @@
+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).
+
+1. A rather disturbing, graphic import in `sage.doctest.parsing`:
+
+```
+# We need to import from sage.all to avoid circular imports.
+from sage.all import RealIntervalField
+RIFtol = RealIntervalField(1044)
+```
+
+
+2. We need to make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:
+
+```
+    import sage.repl.ipython_kernel.all_jupyter
+```
+   and again in `DocTestTask._run`:
+
+```
+            # Import Jupyter globals to doctest the Jupyter
+            # implementation of widgets and interacts
+            import sage.repl.ipython_kernel.all_jupyter as sage_all
+```
+... which is
+
+```
+"""
+All imports for Jupyter
+"""
+
+from sage.all_cmdline import *
+
+from .widgets_sagenb import (input_box, text_control, slider,
+        range_slider, checkbox, selector, input_grid, color_selector)
+from .interact import interact
+```
+
 
 
 Comment: 1
``````




---

archive/issue_comments_449275.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,43 @@\n+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).\n+\n+1. A rather disturbing, graphic import in `sage.doctest.parsing`:\n+\n+```\n+# We need to import from sage.all to avoid circular imports.\n+from sage.all import RealIntervalField\n+RIFtol = RealIntervalField(1044)\n+```\n+\n+\n+2. We need to make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:\n+\n+```\n+    import sage.repl.ipython_kernel.all_jupyter\n+```\n+   and again in `DocTestTask._run`:\n+\n+```\n+            # Import Jupyter globals to doctest the Jupyter\n+            # implementation of widgets and interacts\n+            import sage.repl.ipython_kernel.all_jupyter as sage_all\n+```\n+... which is\n+\n+```\n+\"\"\"\n+All imports for Jupyter\n+\"\"\"\n+\n+from sage.all_cmdline import *\n+\n+from .widgets_sagenb import (input_box, text_control, slider,\n+        range_slider, checkbox, selector, input_grid, color_selector)\n+from .interact import interact\n+```\n+\n+For example, #29865 defines modules such as `sage.all__sage_objects`. We would invoke `sage -t --environment=sage.all__sage_objects` to test against this global environment.\n+\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-06-21T02:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449275",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,43 @@
+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).
+
+1. A rather disturbing, graphic import in `sage.doctest.parsing`:
+
+```
+# We need to import from sage.all to avoid circular imports.
+from sage.all import RealIntervalField
+RIFtol = RealIntervalField(1044)
+```
+
+
+2. We need to make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:
+
+```
+    import sage.repl.ipython_kernel.all_jupyter
+```
+   and again in `DocTestTask._run`:
+
+```
+            # Import Jupyter globals to doctest the Jupyter
+            # implementation of widgets and interacts
+            import sage.repl.ipython_kernel.all_jupyter as sage_all
+```
+... which is
+
+```
+"""
+All imports for Jupyter
+"""
+
+from sage.all_cmdline import *
+
+from .widgets_sagenb import (input_box, text_control, slider,
+        range_slider, checkbox, selector, input_grid, color_selector)
+from .interact import interact
+```
+
+For example, #29865 defines modules such as `sage.all__sage_objects`. We would invoke `sage -t --environment=sage.all__sage_objects` to test against this global environment.
+
+
 
 
 Comment: 1
``````




---

archive/issue_comments_449276.json:
```json
{
    "body": "<a id='comment:6'></a>Probably we will need to disable the real tolerance feature when we want to test the lowest layers such as `sage-objects` to avoid having to pull in the whole numeric tower.",
    "created_at": "2020-06-22T18:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449276",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Probably we will need to disable the real tolerance feature when we want to test the lowest layers such as `sage-objects` to avoid having to pull in the whole numeric tower.



---

archive/issue_comments_449277.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-22T20:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449278.json:
```json
{
    "body": "<a id='comment:10'></a>Cc'ing you because this ticket is touching the same files that will need to be modified if you want to implement the option for #29935",
    "created_at": "2020-06-22T20:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449278",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Cc'ing you because this ticket is touching the same files that will need to be modified if you want to implement the option for #29935



---

archive/issue_comments_449279.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-22T20:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449280.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-22T21:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449281.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-22T21:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_449282.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-22T21:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449282",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_449283.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,47 @@\n+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).\n+\n+1. An explicit import in `sage.doctest.parsing`:\n+\n+```\n+# We need to import from sage.all to avoid circular imports.\n+from sage.all import RealIntervalField\n+RIFtol = RealIntervalField(1044)\n+```\n+\n+\n+2. We make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:\n+\n+```\n+    import sage.repl.ipython_kernel.all_jupyter\n+```\n+   and again in `DocTestTask._run`:\n+\n+```\n+            # Import Jupyter globals to doctest the Jupyter\n+            # implementation of widgets and interacts\n+            import sage.repl.ipython_kernel.all_jupyter as sage_all\n+```\n+... which is\n+\n+```\n+\"\"\"\n+All imports for Jupyter\n+\"\"\"\n+\n+from sage.all_cmdline import *\n+\n+from .widgets_sagenb import (input_box, text_control, slider,\n+        range_slider, checkbox, selector, input_grid, color_selector)\n+from .interact import interact\n+```\n+\n+   This is exposed by the new `sage-runtest` option `--environment`.\n+\n+   For example, #29865 defines modules such as `sage.all__sage_objects`. We would invoke `sage -t --environment=sage.all__sage_objects` to test against this global environment.\n+\n+\n+3. We ignore errors importing `sage.interfaces`.\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-06-22T21:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449283",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,47 @@
+We prepare the Sage doctesting module for running in environments where `sage.all` is not available (#29705).
+
+1. An explicit import in `sage.doctest.parsing`:
+
+```
+# We need to import from sage.all to avoid circular imports.
+from sage.all import RealIntervalField
+RIFtol = RealIntervalField(1044)
+```
+
+
+2. We make the global environment for tests customizable in `sage.doctest.forker`: in `init_sage`:
+
+```
+    import sage.repl.ipython_kernel.all_jupyter
+```
+   and again in `DocTestTask._run`:
+
+```
+            # Import Jupyter globals to doctest the Jupyter
+            # implementation of widgets and interacts
+            import sage.repl.ipython_kernel.all_jupyter as sage_all
+```
+... which is
+
+```
+"""
+All imports for Jupyter
+"""
+
+from sage.all_cmdline import *
+
+from .widgets_sagenb import (input_box, text_control, slider,
+        range_slider, checkbox, selector, input_grid, color_selector)
+from .interact import interact
+```
+
+   This is exposed by the new `sage-runtest` option `--environment`.
+
+   For example, #29865 defines modules such as `sage.all__sage_objects`. We would invoke `sage -t --environment=sage.all__sage_objects` to test against this global environment.
+
+
+3. We ignore errors importing `sage.interfaces`.
+
 
 
 Comment: 1
``````




---

archive/issue_comments_449284.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-06-22T22:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449284",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_449285.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-22T23:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449285",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449286.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-22T23:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449286",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_449287.json:
```json
{
    "body": "<a id='comment:19'></a>Ready for review",
    "created_at": "2020-07-02T22:31:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449287",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Ready for review



---

archive/issue_comments_449288.json:
```json
{
    "body": "<a id='comment:21'></a>This looks reasonable, it does not break the doctesting framework and the added doctests pass.",
    "created_at": "2020-07-17T20:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449288",
    "user": "https://github.com/kliem"
}
```

<a id='comment:21'></a>This looks reasonable, it does not break the doctesting framework and the added doctests pass.



---

archive/issue_comments_449289.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-17T20:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449289",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_449290.json:
```json
{
    "body": "<a id='comment:22'></a>Thank you.",
    "created_at": "2020-07-17T20:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449290",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Thank you.



---

archive/issue_events_076738.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-25T22:51:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29922#event-76738"
}
```



---

archive/issue_comments_449291.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-25T22:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29922#issuecomment-449291",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
