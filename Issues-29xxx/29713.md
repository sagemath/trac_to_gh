# Issue 29713: Broken conversion from FractionField over PolynomialRing over Field back to Field

archive/issues_029476.json:
```json
{
    "body": "Let consider following code:\n\n```\nF = FunctionField(QQ, 'a')\na = F.gen()\n\npolynomial_ring = PolynomialRing(F, 'x')\nFF = FractionField(polynomial_ring)\n\nelement = F(-1/2/(a^2 + a))\n\nassert F(FF(element))\n```\n\nThe last line yields following error:\n\n```\n>           raise TypeError(\"fraction must have unit denominator\")\nE           TypeError: fraction must have unit denominator\n\n/usr/lib/python3.8/site-packages/sage/rings/fraction_field.py:1190: TypeError\n```\n\nBut actually it should be just conversion from FractionField element back to Field.\n\nP.S. There is also one more thing:\n\n```\nassert FF(element) in F\n```\n\nyields following:\n\n```\nE       assert -1/2/(a^2 + a) in Rational function field in a over Rational Field\nE        +  where -1/2/(a^2 + a) = Fraction Field of Univariate Polynomial Ring in x over Rational function field in a over Rational Field(-1/2/(a^2 + a))\n```\n\nP.P.S. [SageMath](SageMath) version 9.0, Release Date: 2020-01-01 \n\nCC:  @mezzarobba @xcaruso @slel @saraedum @videlec\n\nKeywords: fraction field\n\nBranch/Commit: 7de03008dc6315bf93919e784697f112a493cd76\n\nReviewer: Xavier Caruso\n\nAuthor: Travis Scrimshaw\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29713\n\n",
    "closed_at": "2020-05-29T21:16:07Z",
    "created_at": "2020-05-19T16:14:38Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Broken conversion from FractionField over PolynomialRing over Field back to Field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29713",
    "user": "https://github.com/petRUShka"
}
```
Let consider following code:

```
F = FunctionField(QQ, 'a')
a = F.gen()

polynomial_ring = PolynomialRing(F, 'x')
FF = FractionField(polynomial_ring)

element = F(-1/2/(a^2 + a))

assert F(FF(element))
```

The last line yields following error:

```
>           raise TypeError("fraction must have unit denominator")
E           TypeError: fraction must have unit denominator

/usr/lib/python3.8/site-packages/sage/rings/fraction_field.py:1190: TypeError
```

But actually it should be just conversion from FractionField element back to Field.

P.S. There is also one more thing:

```
assert FF(element) in F
```

yields following:

```
E       assert -1/2/(a^2 + a) in Rational function field in a over Rational Field
E        +  where -1/2/(a^2 + a) = Fraction Field of Univariate Polynomial Ring in x over Rational function field in a over Rational Field(-1/2/(a^2 + a))
```

P.P.S. [SageMath](SageMath) version 9.0, Release Date: 2020-01-01 

CC:  @mezzarobba @xcaruso @slel @saraedum @videlec

Keywords: fraction field

Branch/Commit: 7de03008dc6315bf93919e784697f112a493cd76

Reviewer: Xavier Caruso

Author: Travis Scrimshaw

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29713





---

archive/issue_comments_445734.json:
```json
{
    "body": "<a id='comment:1'></a>I feel like the right solution is to have FractionFieldEmbeddingSection._call_ raise a `ValueError` instead of a `TypeError`. From the code in fraction_field.py:\n\n```\n     # This should probably be a ValueError.\n     # However, too much existing code is expecting this to throw a\n     # TypeError, so we decided to keep it for the time being.\n     raise TypeError(\"fraction must have unit denominator\")\n```\nI did not have the courage to change this, so I implemented a hack in `RationalFunctionField._element_constructor`_that fixes this issue at least. \n\n---\nNew commits:",
    "created_at": "2020-05-20T03:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445734",
    "user": "https://github.com/heluani"
}
```

<a id='comment:1'></a>I feel like the right solution is to have FractionFieldEmbeddingSection._call_ raise a `ValueError` instead of a `TypeError`. From the code in fraction_field.py:

```
     # This should probably be a ValueError.
     # However, too much existing code is expecting this to throw a
     # TypeError, so we decided to keep it for the time being.
     raise TypeError("fraction must have unit denominator")
```
I did not have the courage to change this, so I implemented a hack in `RationalFunctionField._element_constructor`_that fixes this issue at least. 

---
New commits:



---

archive/issue_comments_445735.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-05-20T03:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445735",
    "user": "https://github.com/heluani"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_445736.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-05-20T03:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_445737.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-05-20T03:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_445738.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-05-20T03:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_445739.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-05-20T04:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445739",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_445740.json:
```json
{
    "body": "<a id='comment:5'></a>I think this is a pretty bad hack and it doesn't solve the underlying problem:\n\n```\nsage: F = FractionField(QQ['a'])\nsage: a = F.gen()\nsage: R = PolynomialRing(F, 'x')\nsage: FF = FractionField(R)\nsage: elt = F(-1/2/(a^2+a))\nsage: FF(elt)\n-1/2/(a^2 + a)\nsage: F(_)  # Same error\n```\nI think the correct fix would be to change something in the fraction field `_element_constructor_` to handle this case.",
    "created_at": "2020-05-20T04:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445740",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>I think this is a pretty bad hack and it doesn't solve the underlying problem:

```
sage: F = FractionField(QQ['a'])
sage: a = F.gen()
sage: R = PolynomialRing(F, 'x')
sage: FF = FractionField(R)
sage: elt = F(-1/2/(a^2+a))
sage: FF(elt)
-1/2/(a^2 + a)
sage: F(_)  # Same error
```
I think the correct fix would be to change something in the fraction field `_element_constructor_` to handle this case.



---

archive/issue_comments_445741.json:
```json
{
    "body": "<a id='comment:6'></a>Here is my proposal that should make sure such things work. It might not be the fastest, but there is some attempt at making the most natural code paths fast.\n\n---\nNew commits:",
    "created_at": "2020-05-20T05:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445741",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>Here is my proposal that should make sure such things work. It might not be the fastest, but there is some attempt at making the most natural code paths fast.

---
New commits:



---

archive/issue_comments_445742.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-05-20T05:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445742",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_445743.json:
```json
{
    "body": "<a id='comment:7'></a>I mostly agree with your proposal but I would have implemented things slightly differently.",
    "created_at": "2020-05-25T16:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445743",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:7'></a>I mostly agree with your proposal but I would have implemented things slightly differently.



---

archive/issue_comments_445744.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-25T16:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445745.json:
```json
{
    "body": "<a id='comment:9'></a>Moreover, I'm not sure that having a special case when `y` is not none and `parent(x)` is `self` is really relevant. I agree that it can short-circuit something but, on the contrary, I think that conveting `y` to `self` may have some impact on the efficiency.",
    "created_at": "2020-05-25T17:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445745",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:9'></a>Moreover, I'm not sure that having a special case when `y` is not none and `parent(x)` is `self` is really relevant. I agree that it can short-circuit something but, on the contrary, I think that conveting `y` to `self` may have some impact on the efficiency.



---

archive/issue_comments_445746.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 caruso]:\n> Moreover, I'm not sure that having a special case when `y` is not none and `parent(x)` is `self` is really relevant. I agree that it can short-circuit something but, on the contrary, I think that conveting `y` to `self` may have some impact on the efficiency.\n\n\nI somewhat agree. It was my first attempt at a solution, but I felt could cover some extra similar such cases. Why I convert `y` to `self` is this: If we try and short-circuit it this way, there can be some extra conversions that are there, but are not coercions. The first thing I tried was:\n\n```\ny *= x.denominator()\n```\nThe other option would be to use\n\n```\ny *= parent(y)(x.denominator())\n```\nbut I feel that could involve even more conversions. I also concluded that if we didn't short-circuit, there would be just as many conversions that would be done using the default pathway (plus extra exceptions raised).",
    "created_at": "2020-05-26T02:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445746",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Replying to [comment:9 caruso]:
> Moreover, I'm not sure that having a special case when `y` is not none and `parent(x)` is `self` is really relevant. I agree that it can short-circuit something but, on the contrary, I think that conveting `y` to `self` may have some impact on the efficiency.


I somewhat agree. It was my first attempt at a solution, but I felt could cover some extra similar such cases. Why I convert `y` to `self` is this: If we try and short-circuit it this way, there can be some extra conversions that are there, but are not coercions. The first thing I tried was:

```
y *= x.denominator()
```
The other option would be to use

```
y *= parent(y)(x.denominator())
```
but I feel that could involve even more conversions. I also concluded that if we didn't short-circuit, there would be just as many conversions that would be done using the default pathway (plus extra exceptions raised).



---

archive/issue_comments_445747.json:
```json
{
    "body": "<a id='comment:11'></a>OK.\n\nSo, if you agree with my changes, you can give a positive review to this ticket on my behalf.",
    "created_at": "2020-05-27T17:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445747",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:11'></a>OK.

So, if you agree with my changes, you can give a positive review to this ticket on my behalf.



---

archive/issue_events_076019.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2020-05-28T01:20:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29713#event-76019"
}
```



---

archive/issue_comments_445748.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-28T01:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445748",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_445749.json:
```json
{
    "body": "<a id='comment:12'></a>Yes, I agree. Thank you for the review.\n\nAddendum - I forgot to say, I like your fix by checking the parent.",
    "created_at": "2020-05-28T01:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445749",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>Yes, I agree. Thank you for the review.

Addendum - I forgot to say, I like your fix by checking the parent.



---

archive/issue_events_076020.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-05-29T21:16:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29713#event-76020"
}
```



---

archive/issue_comments_445750.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-29T21:16:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-445750",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
