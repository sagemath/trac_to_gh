# Issue 29221: fast vector partition algorithm

archive/issues_028984.json:
```json
{
    "body": "New Python implementation of Brent Yorgey's fast vector partition algorithm\n\nSome time ago Brent Yorgey published a very efficient algorithm for vector partitions in Haskell, see Brent Yorgey, Generating Multiset Partitions,        The Monad Reader, Issue 8, September 2007, p. 5. at https://wiki.haskell.org/The_Monad.Reader/Previous_issues.\n\nI have translated it into Python for my own use, also some time ago. Now I have decided to contribute it to Sage if possible. I have rewritten the source completely following Sage guidelines as best I could, got rid of some bugs (mine, not Yorgey's), and ran a number of examples against both the Sage VectorPartitions() implementation and the original Haskell code published by Yorgey. As far as I can see it works as it should, usual disclaimers apply.\n\nI will commit as soon as I can. Any comments are welcome.\n\nCheers,\n\nDenis\n\nExamples:\n\n```\n            # the older the computer, the more impressive the example:\n            sage: %time fastvparts = fast_vector_partitions([6,6,6])\n            CPU times: user 17 s, sys: 136 ms, total: 17.1 s\n            Wall time: 17.1 s\n            sage: %time vparts = list(VectorPartitions([6,6,6]))\n            CPU times: user 4min 16s, sys: 319 ms, total: 4min 16s\n            Wall time: 4min 16s\n            sage: vparts == fastvparts[::-1]\n            True\n            sage: fast_vector_partitions([1,2,3], min = [0,1,1])\n            [[[1, 2, 3]],\n             [[0, 2, 3], [1, 0, 0]],\n             [[0, 2, 2], [1, 0, 1]],\n             [[0, 2, 1], [1, 0, 2]],\n             [[0, 2, 0], [1, 0, 3]],\n             [[0, 1, 3], [1, 1, 0]],\n             [[0, 1, 2], [1, 1, 1]],\n             [[0, 1, 1], [1, 1, 2]],\n             [[0, 1, 1], [0, 1, 2], [1, 0, 0]],\n             [[0, 1, 1], [0, 1, 1], [1, 0, 1]]]\n            sage: fast_vector_partitions([5,7,6], min = [1,3,2])==\n            ....: list(VectorPartitions([5,7,6], min = [1,3,2]))[::-1]\n            True\n```\n\n\nCC:  @tscrim\n\nKeywords: vector partitions\n\nBranch/Commit: ebfa5e56ea81b3b2d9e1ab7547f09b6e71ce6829\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\n\nAuthor: Denis Sunko\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29221\n\n",
    "closed_at": "2020-03-10T23:27:23Z",
    "created_at": "2020-02-19T16:11:10Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "fast vector partition algorithm",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29221",
    "user": "https://github.com/denissunko"
}
```
New Python implementation of Brent Yorgey's fast vector partition algorithm

Some time ago Brent Yorgey published a very efficient algorithm for vector partitions in Haskell, see Brent Yorgey, Generating Multiset Partitions,        The Monad Reader, Issue 8, September 2007, p. 5. at https://wiki.haskell.org/The_Monad.Reader/Previous_issues.

I have translated it into Python for my own use, also some time ago. Now I have decided to contribute it to Sage if possible. I have rewritten the source completely following Sage guidelines as best I could, got rid of some bugs (mine, not Yorgey's), and ran a number of examples against both the Sage VectorPartitions() implementation and the original Haskell code published by Yorgey. As far as I can see it works as it should, usual disclaimers apply.

I will commit as soon as I can. Any comments are welcome.

Cheers,

Denis

Examples:

```
            # the older the computer, the more impressive the example:
            sage: %time fastvparts = fast_vector_partitions([6,6,6])
            CPU times: user 17 s, sys: 136 ms, total: 17.1 s
            Wall time: 17.1 s
            sage: %time vparts = list(VectorPartitions([6,6,6]))
            CPU times: user 4min 16s, sys: 319 ms, total: 4min 16s
            Wall time: 4min 16s
            sage: vparts == fastvparts[::-1]
            True
            sage: fast_vector_partitions([1,2,3], min = [0,1,1])
            [[[1, 2, 3]],
             [[0, 2, 3], [1, 0, 0]],
             [[0, 2, 2], [1, 0, 1]],
             [[0, 2, 1], [1, 0, 2]],
             [[0, 2, 0], [1, 0, 3]],
             [[0, 1, 3], [1, 1, 0]],
             [[0, 1, 2], [1, 1, 1]],
             [[0, 1, 1], [1, 1, 2]],
             [[0, 1, 1], [0, 1, 2], [1, 0, 0]],
             [[0, 1, 1], [0, 1, 1], [1, 0, 1]]]
            sage: fast_vector_partitions([5,7,6], min = [1,3,2])==
            ....: list(VectorPartitions([5,7,6], min = [1,3,2]))[::-1]
            True
```


CC:  @tscrim

Keywords: vector partitions

Branch/Commit: ebfa5e56ea81b3b2d9e1ab7547f09b6e71ce6829

Reviewer: Frédéric Chapoton, Travis Scrimshaw

Author: Denis Sunko

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29221





---

archive/issue_comments_409814.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T11:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409814",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409815.json:
```json
{
    "body": "<a id='comment:7'></a>The code works as advertised, but for some reason I cannot get my local version of Sage to see it. No matter how much I run ./sage -br and make, it keeps complaining that the name \"fast_vector_partitions\" is undefined. I can see that something has happened in the build, because the file fast_vector_partitions.py has migrated from ./src/sage/combinat where I put it to the other locations, and a .pyc file has appeared:\n\n```\n$ find . -name \"*fast_vector_partitions.*\"\n./src/build/lib.linux-x86_64-3.7/sage/combinat/fast_vector_partitions.py\n./src/sage/combinat/fast_vector_partitions.py\n./local/lib/python3.7/site-packages/sage/combinat/fast_vector_partitions.py\n./local/lib/python3.7/site-packages/sage/combinat/__pycache__/fast_vector_partitions.cpython-37.pyc\n```\n\nHowever, no luck with the interpreter. I hope this can be sorted out quickly.\n\nPlease help,\n\nDenis",
    "created_at": "2020-02-20T12:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409815",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:7'></a>The code works as advertised, but for some reason I cannot get my local version of Sage to see it. No matter how much I run ./sage -br and make, it keeps complaining that the name "fast_vector_partitions" is undefined. I can see that something has happened in the build, because the file fast_vector_partitions.py has migrated from ./src/sage/combinat where I put it to the other locations, and a .pyc file has appeared:

```
$ find . -name "*fast_vector_partitions.*"
./src/build/lib.linux-x86_64-3.7/sage/combinat/fast_vector_partitions.py
./src/sage/combinat/fast_vector_partitions.py
./local/lib/python3.7/site-packages/sage/combinat/fast_vector_partitions.py
./local/lib/python3.7/site-packages/sage/combinat/__pycache__/fast_vector_partitions.cpython-37.pyc
```

However, no luck with the interpreter. I hope this can be sorted out quickly.

Please help,

Denis



---

archive/issue_comments_409816.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-20T12:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409816",
    "user": "https://github.com/denissunko"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409817.json:
```json
{
    "body": "<a id='comment:9'></a>(1) You need to add\n\n```\nsage: from sage.combinat.fast_vector_partitions import fast_vector_partitions\n```\nas the first line of your doctests.\n\n(2) every function in your file must have doctests\n\n(3) Besides, your documentation is not formatted correctly. Please read \n\nhttps://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings\n\ncarefully and fix your file according to our documentation style.",
    "created_at": "2020-02-20T16:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409817",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>(1) You need to add

```
sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions
```
as the first line of your doctests.

(2) every function in your file must have doctests

(3) Besides, your documentation is not formatted correctly. Please read 

https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings

carefully and fix your file according to our documentation style.



---

archive/issue_comments_409818.json:
```json
{
    "body": "<a id='comment:10'></a>Thank you, everything works now.\n\nHere comes the next attempt to get past the patchbots.\n\nDenis",
    "created_at": "2020-02-20T18:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409818",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:10'></a>Thank you, everything works now.

Here comes the next attempt to get past the patchbots.

Denis



---

archive/issue_comments_409819.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T18:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409819",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409820.json:
```json
{
    "body": "<a id='comment:12'></a>(0) at the top of the file, you do not need to indent inside ALGORITHM: and AUTHORS:\n\n(1) `EXAMPLES:` should be `EXAMPLES::`\n\nand then the doctest inside the EXAMPLES block should be indented by 4 spaces\n\n(general rule is that something ending with :: should contain indented text)\n\n(2) `.. NOTE::` and `.. WARNING::` should be at the same indentation as the text before\n\n(3) remove the \"uncomment if...\" lines",
    "created_at": "2020-02-20T18:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409820",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>(0) at the top of the file, you do not need to indent inside ALGORITHM: and AUTHORS:

(1) `EXAMPLES:` should be `EXAMPLES::`

and then the doctest inside the EXAMPLES block should be indented by 4 spaces

(general rule is that something ending with :: should contain indented text)

(2) `.. NOTE::` and `.. WARNING::` should be at the same indentation as the text before

(3) remove the "uncomment if..." lines



---

archive/issue_comments_409821.json:
```json
{
    "body": "<a id='comment:13'></a>your `dickson_le` can be written in one line\n\n```\nall(x <= y for x, y in zip(v, w))\n```\n\nsimilarly, `vector_minus` is\n`[x - y for x, y in zip(v,w)]`",
    "created_at": "2020-02-20T18:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409821",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>your `dickson_le` can be written in one line

```
all(x <= y for x, y in zip(v, w))
```

similarly, `vector_minus` is
`[x - y for x, y in zip(v,w)]`



---

archive/issue_comments_409822.json:
```json
{
    "body": "<a id='comment:14'></a>Thank you very much, this was helpful. It is difficult to get the fine points right.\n\nWith your one-liner, I don't need to import the operator module any more.\n\nHere comes the hopefully-last commit before review.",
    "created_at": "2020-02-20T20:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409822",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:14'></a>Thank you very much, this was helpful. It is difficult to get the fine points right.

With your one-liner, I don't need to import the operator module any more.

Here comes the hopefully-last commit before review.



---

archive/issue_comments_409823.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T20:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409823",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409824.json:
```json
{
    "body": "<a id='comment:16'></a>It is going to take more rounds, I think. I hope you will not be discouraged.\n\nyou should just remove `dickson_le` which is used only once (replace its only use by the one-line code)\n\nand the same for vector_minus\n\nsame for vector_clip, which is [min(x,y) for x,y in zip(v, w)]\n\nsame for vector_unit, also used only once\n\nalso remove all the for-debugging-only code.",
    "created_at": "2020-02-20T21:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409824",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>It is going to take more rounds, I think. I hope you will not be discouraged.

you should just remove `dickson_le` which is used only once (replace its only use by the one-line code)

and the same for vector_minus

same for vector_clip, which is [min(x,y) for x,y in zip(v, w)]

same for vector_unit, also used only once

also remove all the for-debugging-only code.



---

archive/issue_comments_409825.json:
```json
{
    "body": "<a id='comment:17'></a>ok here comes\n\nlast before I turn in\n\nnot discouraged\n\npoor patchbots",
    "created_at": "2020-02-20T21:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409825",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:17'></a>ok here comes

last before I turn in

not discouraged

poor patchbots



---

archive/issue_comments_409826.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-20T21:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409827.json:
```json
{
    "body": "<a id='comment:19'></a>(0) INPUT: and OUTPUT: should be followed by an empty line (as always for lines ending with : or ::)\n\n(1) the content of NOTE:: and WARNING:: should be indented by 4\n\n(2) Do not use # inside the documentation, you can write\n\n```\n+    EXAMPLES:\n+\n+    The older the computer, the more impressive the comparison::\n+\n+        sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions\n```\n\n(3) I would suggest to make your procedure return an iterator (using \"yield\")\n\n(4) you should insert your new file in the documentation (for example by adding a line in `src/doc/en/reference/combinat/module_list.rst`. And then compile the doc (make doc) and look at the generated html file.",
    "created_at": "2020-02-21T07:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409827",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:19'></a>(0) INPUT: and OUTPUT: should be followed by an empty line (as always for lines ending with : or ::)

(1) the content of NOTE:: and WARNING:: should be indented by 4

(2) Do not use # inside the documentation, you can write

```
+    EXAMPLES:
+
+    The older the computer, the more impressive the comparison::
+
+        sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions
```

(3) I would suggest to make your procedure return an iterator (using "yield")

(4) you should insert your new file in the documentation (for example by adding a line in `src/doc/en/reference/combinat/module_list.rst`. And then compile the doc (make doc) and look at the generated html file.



---

archive/issue_comments_409828.json:
```json
{
    "body": "<a id='comment:20'></a>Is there some easy way to flip the ordering and have it iterate starting with the largest in lex? Although I guess in many ways it is nice to have another algorithm that iterates starting from the lex smallest...",
    "created_at": "2020-02-21T09:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409828",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Is there some easy way to flip the ordering and have it iterate starting with the largest in lex? Although I guess in many ways it is nice to have another algorithm that iterates starting from the lex smallest...



---

archive/issue_comments_409829.json:
```json
{
    "body": "<a id='comment:21'></a>Typo in \"decompostion\"\n\nIn vector_halve, you could use\n\n```\nfor i, vv in enumerate(v):\n```\nto take care of the indexing variable i",
    "created_at": "2020-02-21T12:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409829",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>Typo in "decompostion"

In vector_halve, you could use

```
for i, vv in enumerate(v):
```
to take care of the indexing variable i



---

archive/issue_comments_409830.json:
```json
{
    "body": "<a id='comment:22'></a>Documentation builds correctly, so I am ready for the next iteration. Thanks again for all the help, I don't think I could have done without it.\n\nI have decided against enumerate() because I think it is better to be explicit with i += 1 for such a small snippet.\n\nI cannot do yield, sorry. My time for real-time work on this is almost up, so what's done this weekend is done, as far as I am concerned, until June at least. Having said that, I would be happy to play with somebody else's contribution. The author list is open, after all.\n\nFrom a more general point of view, I think that the time may come when this code can be merged with the VectorPartitions() code, which has some very classy (ha!) features, e.g. vparts = VectorPartitions(...) returns an iterator which can be subscripted: vparts[0], vparts[1], and then reused, vparts[0] again. I don't know how to do that. However, at this time, I think it would be prudent to release this code in isolation for some reasonable period first.\n\nI don't think flipping the order is at all easy with this algorithm, but feel free to look up Yorgey's paper and contradict me. As far as I can see, his whole idea is to produce a partition on each and every cycle of the recursion, so it is natural to start with the one sure thing, v=v. Splitting and re-splitting it one gets them all, but obviously the natural order here is downwards.\n\nThere is a deep reason why \"sniffing beyond the edges\" is disastrously inefficient in vector spaces. Say we have a sphere of radius R in d-dimensional space, and another with a smaller radius r=R-D inside it. How much volume is there in the surface shell of thickness D? Evidently it is\n\n ~ R<sup>d</sup> - (R-D)<sup>d</sup> = R<sup>d</sup> [1 - (1-D/R)<sup>d</sup>] --> R<sup>d</sup> (!!!) when d>>1, because (1-D/R)<1.\n\nIn other words, the shell of thickness D=1 (integer point case) dominates the volume of the sphere, no matter how big R is, when the dimension d of the space is large. Any inefficiency, no matter how marginal along a direction, D/R << 1, will end up dominating the calculation.\n\n(deep breath) here comes the push...",
    "created_at": "2020-02-21T16:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409830",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:22'></a>Documentation builds correctly, so I am ready for the next iteration. Thanks again for all the help, I don't think I could have done without it.

I have decided against enumerate() because I think it is better to be explicit with i += 1 for such a small snippet.

I cannot do yield, sorry. My time for real-time work on this is almost up, so what's done this weekend is done, as far as I am concerned, until June at least. Having said that, I would be happy to play with somebody else's contribution. The author list is open, after all.

From a more general point of view, I think that the time may come when this code can be merged with the VectorPartitions() code, which has some very classy (ha!) features, e.g. vparts = VectorPartitions(...) returns an iterator which can be subscripted: vparts[0], vparts[1], and then reused, vparts[0] again. I don't know how to do that. However, at this time, I think it would be prudent to release this code in isolation for some reasonable period first.

I don't think flipping the order is at all easy with this algorithm, but feel free to look up Yorgey's paper and contradict me. As far as I can see, his whole idea is to produce a partition on each and every cycle of the recursion, so it is natural to start with the one sure thing, v=v. Splitting and re-splitting it one gets them all, but obviously the natural order here is downwards.

There is a deep reason why "sniffing beyond the edges" is disastrously inefficient in vector spaces. Say we have a sphere of radius R in d-dimensional space, and another with a smaller radius r=R-D inside it. How much volume is there in the surface shell of thickness D? Evidently it is

 ~ R<sup>d</sup> - (R-D)<sup>d</sup> = R<sup>d</sup> [1 - (1-D/R)<sup>d</sup>] --> R<sup>d</sup> (!!!) when d>>1, because (1-D/R)<1.

In other words, the shell of thickness D=1 (integer point case) dominates the volume of the sphere, no matter how big R is, when the dimension d of the space is large. Any inefficiency, no matter how marginal along a direction, D/R << 1, will end up dominating the calculation.

(deep breath) here comes the push...



---

archive/issue_comments_409831.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-21T16:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409831",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409832.json:
```json
{
    "body": "<a id='comment:24'></a>Some patchbots are failing because of reasons unrelated to my code, at least it seems so to me.\n\nThe failed reports are the same as the green ones where they refer to fast_vector_partitions.py.\n\nIn these reports doctests are timing out on unrelated packages, but all checkmarks are green.\n\nThis being the first time I am contributing, I don't know what to expect now.\n\nPlease advise,\n\nDenis",
    "created_at": "2020-02-22T06:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409832",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:24'></a>Some patchbots are failing because of reasons unrelated to my code, at least it seems so to me.

The failed reports are the same as the green ones where they refer to fast_vector_partitions.py.

In these reports doctests are timing out on unrelated packages, but all checkmarks are green.

This being the first time I am contributing, I don't know what to expect now.

Please advise,

Denis



---

archive/issue_comments_409833.json:
```json
{
    "body": "<a id='comment:25'></a>yes, some patchbots are known to be broken. If one patchbot is green and the other fails for obviously unrelated reasons, then that's good enough.\n\nThis ticket is starting to look very good, but still is not perfect. If you stop working on it, the risk is that nobody else will care, and you will find the ticket in the same state when you come back in 6 months.\n\n(0) the lines in the INPUT: and OUTPUT: blocks should not have final dots.\n\n(1) making iterators would be really better.",
    "created_at": "2020-02-22T07:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409833",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>yes, some patchbots are known to be broken. If one patchbot is green and the other fails for obviously unrelated reasons, then that's good enough.

This ticket is starting to look very good, but still is not perfect. If you stop working on it, the risk is that nobody else will care, and you will find the ticket in the same state when you come back in 6 months.

(0) the lines in the INPUT: and OUTPUT: blocks should not have final dots.

(1) making iterators would be really better.



---

archive/issue_comments_409834.json:
```json
{
    "body": "<a id='comment:26'></a>You don't have to tell me, look at ticket #27139 - 13 months for one line.\n\n(0) no problem\n\n(1) the problem is, I really don't know how to do yield. I've tried a few times and only got grief. I understand it may be better to defer evaluation, especially with combinatorially exploding outputs, but unless it can be done quickly (read: you tell me how) I am afraid it will go to the back burner starting Monday. It's not that I don't want to do it, it's just how it is with my time.\n\nI did try to replace return with yield just to see what will happen, and I just get errors. It is recursive twice over, so I am really reluctant to go up yield creek with no paddle, as it were.\n\nAny pointer appreciated. I will do the dotless push a little later, have to run now.",
    "created_at": "2020-02-22T10:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409834",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:26'></a>You don't have to tell me, look at ticket #27139 - 13 months for one line.

(0) no problem

(1) the problem is, I really don't know how to do yield. I've tried a few times and only got grief. I understand it may be better to defer evaluation, especially with combinatorially exploding outputs, but unless it can be done quickly (read: you tell me how) I am afraid it will go to the back burner starting Monday. It's not that I don't want to do it, it's just how it is with my time.

I did try to replace return with yield just to see what will happen, and I just get errors. It is recursive twice over, so I am really reluctant to go up yield creek with no paddle, as it were.

Any pointer appreciated. I will do the dotless push a little later, have to run now.



---

archive/issue_comments_409835.json:
```json
{
    "body": "<a id='comment:27'></a>I propose to make myself a review commit, trying to convert to iterator, if you agree.",
    "created_at": "2020-02-22T12:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409835",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:27'></a>I propose to make myself a review commit, trying to convert to iterator, if you agree.



---

archive/issue_comments_409836.json:
```json
{
    "body": "<a id='comment:28'></a>Please do, I look forward to learning a bit about yield, only in that case you must put yourself on the authors' list, I insist.\n\nDoes that mean I do the dotless iteration now, or wait?",
    "created_at": "2020-02-22T13:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409836",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:28'></a>Please do, I look forward to learning a bit about yield, only in that case you must put yourself on the authors' list, I insist.

Does that mean I do the dotless iteration now, or wait?



---

archive/issue_comments_409837.json:
```json
{
    "body": "<a id='comment:29'></a>as you want, tell me when I can",
    "created_at": "2020-02-22T13:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409837",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:29'></a>as you want, tell me when I can



---

archive/issue_comments_409838.json:
```json
{
    "body": "<a id='comment:30'></a>I will do both the \"dot removal\" and the \"yield conversion\"",
    "created_at": "2020-02-22T13:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409838",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:30'></a>I will do both the "dot removal" and the "yield conversion"



---

archive/issue_comments_409839.json:
```json
{
    "body": "<a id='comment:31'></a>Here is the new branch, with iterators.\n\nBeware that this is now on top of the latest develop release of sage, 9.1.beta5. If you pull the branch, it may trigger a large scale recompilation of sage, if you were using 9.0 for example.\n\nI have changed the doctests to much smaller cases. Our doctests are not here to display the power of the methods, but should be short and quick cases to check that the code works. Each doctests is not supposed to last more than 1s.\n\n`@`tscrim, do you see something else to be done ?\n\n---\nNew commits:",
    "created_at": "2020-02-22T13:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409839",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:31'></a>Here is the new branch, with iterators.

Beware that this is now on top of the latest develop release of sage, 9.1.beta5. If you pull the branch, it may trigger a large scale recompilation of sage, if you were using 9.0 for example.

I have changed the doctests to much smaller cases. Our doctests are not here to display the power of the methods, but should be short and quick cases to check that the code works. Each doctests is not supposed to last more than 1s.

`@`tscrim, do you see something else to be done ?

---
New commits:



---

archive/issue_comments_409840.json:
```json
{
    "body": "<a id='comment:32'></a>I have looked at the code and it is beautiful, thank you so much.\n\nI can't do anything with it right now because I want to pull/recompile first as you said, with my more-typewriter-than-computer it will take some time I suppose. Then I will put your name in the authors' list (\"conversion to iterators and shorter doctests and doc tweaks\") if you won't.\n\nCheers,\n\nDenis",
    "created_at": "2020-02-22T14:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409840",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:32'></a>I have looked at the code and it is beautiful, thank you so much.

I can't do anything with it right now because I want to pull/recompile first as you said, with my more-typewriter-than-computer it will take some time I suppose. Then I will put your name in the authors' list ("conversion to iterators and shorter doctests and doc tweaks") if you won't.

Cheers,

Denis



---

archive/issue_comments_409841.json:
```json
{
    "body": "<a id='comment:33'></a>This was quicker than I thought.\n\nYes, it works (fantastic).\n\nHere comes the push.",
    "created_at": "2020-02-22T16:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409841",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:33'></a>This was quicker than I thought.

Yes, it works (fantastic).

Here comes the push.



---

archive/issue_comments_409842.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-22T16:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409842",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409843.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-22T21:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409843",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409844.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-23T06:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409844",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409845.json:
```json
{
    "body": "<a id='comment:37'></a>It is better to do `enumerate` that the `i += 1` as it is both faster and more explicit in linking `i` to the position of `vv`.\n\nAlso, I think I will also push a reviewer change. What would you think if I port this over to Cython? Since this is suppose to be fast and it seems well-poised to be done at a lower level, I feel like that is more natural.",
    "created_at": "2020-02-23T06:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409845",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:37'></a>It is better to do `enumerate` that the `i += 1` as it is both faster and more explicit in linking `i` to the position of `vv`.

Also, I think I will also push a reviewer change. What would you think if I port this over to Cython? Since this is suppose to be fast and it seems well-poised to be done at a lower level, I feel like that is more natural.



---

archive/issue_comments_409846.json:
```json
{
    "body": "<a id='comment:38'></a>I agree about enumerate, here is the push. The [6,6,6] case is 5-10% faster, amazing. Also Cython is a great idea.\n\nSorry about the docstring, I did not know I could mess up a single line in so many ways. Still not sure the utf-8 line will work as advertised.",
    "created_at": "2020-02-23T08:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409846",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:38'></a>I agree about enumerate, here is the push. The [6,6,6] case is 5-10% faster, amazing. Also Cython is a great idea.

Sorry about the docstring, I did not know I could mess up a single line in so many ways. Still not sure the utf-8 line will work as advertised.



---

archive/issue_comments_409847.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-23T08:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409847",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409848.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-26T20:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409848",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409849.json:
```json
{
    "body": "<a id='comment:41'></a>I notice some test pending with 16/17 commits, but not any of the above codes. What is supposed to happen next?",
    "created_at": "2020-03-01T09:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409849",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:41'></a>I notice some test pending with 16/17 commits, but not any of the above codes. What is supposed to happen next?



---

archive/issue_comments_409850.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-06T00:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409850",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409851.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-06T00:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409851",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409852.json:
```json
{
    "body": "<a id='comment:44'></a>Okay, I finally got around to giving this a good optimization with Cython. With your branch:\n\n```\nsage: from sage.combinat.fast_vector_partitions import fast_vector_partitions\nsage: %time fastvparts = list(fast_vector_partitions([6,6,6]))\nCPU times: user 3.13 s, sys: 48.3 ms, total: 3.18 s\nWall time: 3.17 s\nsage: %time fastvparts = list(fast_vector_partitions([6,6,6]))\nCPU times: user 3.2 s, sys: 64.1 ms, total: 3.26 s\nWall time: 3.26 s\n```\nversus with my changes:\n\n```\nsage: %time fastvparts = list(fast_vector_partitions([6,6,6]))\nCPU times: user 1.46 s, sys: 52 ms, total: 1.51 s\nWall time: 1.51 s\nsage: %time fastvparts = list(fast_vector_partitions([6,6,6]))\nCPU times: user 1.28 s, sys: 36.1 ms, total: 1.31 s\nWall time: 1.31 s\n```\nThe next step would be using actual fixed length C arrays (instead of lists) with `memcpy`. At this point, it practically becomes a standalone C library. Anyways, I am happy with the current results. So if you agree with my changes, then this is a positive review. (Note that `cdef` do not need doctests.)",
    "created_at": "2020-03-06T00:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409852",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:44'></a>Okay, I finally got around to giving this a good optimization with Cython. With your branch:

```
sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 3.13 s, sys: 48.3 ms, total: 3.18 s
Wall time: 3.17 s
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 3.2 s, sys: 64.1 ms, total: 3.26 s
Wall time: 3.26 s
```
versus with my changes:

```
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 1.46 s, sys: 52 ms, total: 1.51 s
Wall time: 1.51 s
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 1.28 s, sys: 36.1 ms, total: 1.31 s
Wall time: 1.31 s
```
The next step would be using actual fixed length C arrays (instead of lists) with `memcpy`. At this point, it practically becomes a standalone C library. Anyways, I am happy with the current results. So if you agree with my changes, then this is a positive review. (Note that `cdef` do not need doctests.)



---

archive/issue_comments_409853.json:
```json
{
    "body": "<a id='comment:46'></a>Thank you very much.\n\nOf course I agree, code unseen.\n\nI am nowhere near my computer now, but plan one final push today or tomorrow:\n- add your name to author list (\"Cython optimizations and doc tweaks\"),\n- add a doc tweak (\"as the vector grows\" -> \"as the vector is parsed\"), reflects the code better.\n\nPlease feel free to do this yourself, if you agree.",
    "created_at": "2020-03-06T07:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409853",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:46'></a>Thank you very much.

Of course I agree, code unseen.

I am nowhere near my computer now, but plan one final push today or tomorrow:
- add your name to author list ("Cython optimizations and doc tweaks"),
- add a doc tweak ("as the vector grows" -> "as the vector is parsed"), reflects the code better.

Please feel free to do this yourself, if you agree.



---

archive/issue_comments_409854.json:
```json
{
    "body": "<a id='comment:47'></a>Here comes the push.\n\nIn addition to the above, I have:\n\n- escaped the dots in author's initials, otherwise the rst parser interpreted them as nested lists;\n- replaced one stray ``min`` with ``min_val``;\n- replaced ``len(a) >= len(b)`` with ``len(b) >= len(a)`` in the vector_sub docstring,\n  because it seems that one must not go beyond the end of b (but maybe I misunderstood).\n\nI have not touched the code at all, so I hope a positive review is still within reach.\n\nI thank both coauthors again, the code is much better than before and I have learned a lot.",
    "created_at": "2020-03-06T21:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409854",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:47'></a>Here comes the push.

In addition to the above, I have:

- escaped the dots in author's initials, otherwise the rst parser interpreted them as nested lists;
- replaced one stray ``min`` with ``min_val``;
- replaced ``len(a) >= len(b)`` with ``len(b) >= len(a)`` in the vector_sub docstring,
  because it seems that one must not go beyond the end of b (but maybe I misunderstood).

I have not touched the code at all, so I hope a positive review is still within reach.

I thank both coauthors again, the code is much better than before and I have learned a lot.



---

archive/issue_comments_409855.json:
```json
{
    "body": "<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-06T21:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409855",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409856.json:
```json
{
    "body": "<a id='comment:49'></a>Thank you. Your changes look good to me. Fr\u00e9d\u00e9ric, if you have any objections, feel free to revert the positive review.",
    "created_at": "2020-03-06T23:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409856",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:49'></a>Thank you. Your changes look good to me. Frédéric, if you have any objections, feel free to revert the positive review.



---

archive/issue_comments_409857.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-06T23:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409857",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_409858.json:
```json
{
    "body": "<a id='comment:50'></a>A summary of timings for the [6, 6, 6] case (my machine at work, floored seconds):\n\n(`VectorPartitions`) 129 > (initial version) 8 > (iterators) 7 > (pyx) 5 > (cython opt.) 2",
    "created_at": "2020-03-07T08:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409858",
    "user": "https://github.com/denissunko"
}
```

<a id='comment:50'></a>A summary of timings for the [6, 6, 6] case (my machine at work, floored seconds):

(`VectorPartitions`) 129 > (initial version) 8 > (iterators) 7 > (pyx) 5 > (cython opt.) 2



---

archive/issue_events_074262.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-10T23:27:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29221#event-74262"
}
```



---

archive/issue_comments_409859.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-10T23:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29221",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29221#issuecomment-409859",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
