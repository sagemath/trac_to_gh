# Issue 29090: sage-system-python fixup

archive/issues_028853.json:
```json
{
    "body": "This ticket updates implementation and use of `build/bin/sage-system-python`.\n\n1. The script now prefers `python3` over `python`, and in fact checks several more executable names such as `python3.7`.\n\n2. Because `sage-download-file` needs the `urllib` module (which is for example not provided by Debian's `python3-minimal` package), it only accepts a python that provides it.\n\n3. A mistake from #28657 (as reported in #28738) is fixed - `src/bin/sage-location` should use Sage's python, not the system python.\n\n4. Error reporting is improved, it gives a clearer error message instead of messages such as (see #28738 or https://github.com/mkoeppe/sage/runs/412019418)\n\n```\n/sage/build/bin/sage-system-python: line 24: exec: : not found\n```\n\n5. In `configure`, we now call `sage-system-python` and exit with an error if no suitable system python is found.\n\nSee also:\n- #26953: Allow python3 system python\n- #28657: Build Sage without \"python\"\n- #28738: Docker [SageMath](SageMath) install fails\n\n\nCC:  @dimpase @embray @jhpalmieri @vbraun @saraedum @slel @orlitzky\n\nBranch/Commit: 7ca6033e076c9ba52fb1811729d5af47ca3d09d1\n\nReviewer: Michael Orlitzky\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29090\n\n",
    "closed_at": "2020-03-25T22:48:46Z",
    "created_at": "2020-01-28T01:37:52Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "sage-system-python fixup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29090",
    "user": "https://github.com/mkoeppe"
}
```
This ticket updates implementation and use of `build/bin/sage-system-python`.

1. The script now prefers `python3` over `python`, and in fact checks several more executable names such as `python3.7`.

2. Because `sage-download-file` needs the `urllib` module (which is for example not provided by Debian's `python3-minimal` package), it only accepts a python that provides it.

3. A mistake from #28657 (as reported in #28738) is fixed - `src/bin/sage-location` should use Sage's python, not the system python.

4. Error reporting is improved, it gives a clearer error message instead of messages such as (see #28738 or https://github.com/mkoeppe/sage/runs/412019418)

```
/sage/build/bin/sage-system-python: line 24: exec: : not found
```

5. In `configure`, we now call `sage-system-python` and exit with an error if no suitable system python is found.

See also:
- #26953: Allow python3 system python
- #28657: Build Sage without "python"
- #28738: Docker [SageMath](SageMath) install fails


CC:  @dimpase @embray @jhpalmieri @vbraun @saraedum @slel @orlitzky

Branch/Commit: 7ca6033e076c9ba52fb1811729d5af47ca3d09d1

Reviewer: Michael Orlitzky

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29090





---

archive/issue_comments_434499.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,6 +7,12 @@\n /sage/build/bin/sage-system-python: line 24: exec: : not found\n ```\n \n+See also:\n+- #26953: Allow python3 system python\n+- #28657: Build Sage without \"python\"\n+- #28738: Docker [SageMath](SageMath) install fails\n+\n+\n Comment: 1\n \n Summary: configure forgets to check whether ANY Python is available on the system\n``````\n",
    "created_at": "2020-03-17T23:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434499",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,6 +7,12 @@
 /sage/build/bin/sage-system-python: line 24: exec: : not found
 ```
 
+See also:
+- #26953: Allow python3 system python
+- #28657: Build Sage without "python"
+- #28738: Docker [SageMath](SageMath) install fails
+
+
 Comment: 1
 
 Summary: configure forgets to check whether ANY Python is available on the system
``````




---

archive/issue_comments_434500.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+As tested at https://github.com/mkoeppe/sage/runs/412019418\n+\n+Only when trying to download the first package, `build/bin/sage-system-python` tries to find one, and that fails.\n+\n+```\n+Found local metadata for patch-2.7.5\n+/sage/build/bin/sage-system-python: line 24: exec: : not found\n+```\n+\n+In this ticket, we use `configure` to determine a suitable system python instead of doing so at the time of running  the `sage-system-python` script.\n+\n+See also:\n+- #26953: Allow python3 system python\n+- #28657: Build Sage without \"python\"\n+- #28738: Docker [SageMath](SageMath) install fails\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-17T23:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434500",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,18 @@
+As tested at https://github.com/mkoeppe/sage/runs/412019418
+
+Only when trying to download the first package, `build/bin/sage-system-python` tries to find one, and that fails.
+
+```
+Found local metadata for patch-2.7.5
+/sage/build/bin/sage-system-python: line 24: exec: : not found
+```
+
+In this ticket, we use `configure` to determine a suitable system python instead of doing so at the time of running  the `sage-system-python` script.
+
+See also:
+- #26953: Allow python3 system python
+- #28657: Build Sage without "python"
+- #28738: Docker [SageMath](SageMath) install fails
 
 
 Comment: 1
``````




---

archive/issue_comments_434501.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-18T01:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434501",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_434502.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,24 @@\n+This ticket updates implementation and use of `build/bin/sage-system-python`.\n+\n+1. The script now prefers `python3` over `python`, and in fact checks several more executable names such as `python3.7`.\n+\n+2. Because `sage-download-file` needs the `urllib` module (which is for example not provided by Debian's `python3-minimal` package), it only accepts a python that provides it.\n+\n+3. A mistake from #28657 (as reported in #28738) is fixed - `src/bin/sage-location` should use Sage's python, not the system python.\n+\n+4. Error reporting is improved. Instead of messages such as (see #28738 or https://github.com/mkoeppe/sage/runs/412019418)\n+\n+```\n+/sage/build/bin/sage-system-python: line 24: exec: : not found\n+```\n+it gives a clearer error message.\n+\n+5. In `configure`, we now call `sage-system-python` and exit with an error if no suitable system python is found.\n+\n+See also:\n+- #26953: Allow python3 system python\n+- #28657: Build Sage without \"python\"\n+- #28738: Docker [SageMath](SageMath) install fails\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-18T01:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434502",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,24 @@
+This ticket updates implementation and use of `build/bin/sage-system-python`.
+
+1. The script now prefers `python3` over `python`, and in fact checks several more executable names such as `python3.7`.
+
+2. Because `sage-download-file` needs the `urllib` module (which is for example not provided by Debian's `python3-minimal` package), it only accepts a python that provides it.
+
+3. A mistake from #28657 (as reported in #28738) is fixed - `src/bin/sage-location` should use Sage's python, not the system python.
+
+4. Error reporting is improved. Instead of messages such as (see #28738 or https://github.com/mkoeppe/sage/runs/412019418)
+
+```
+/sage/build/bin/sage-system-python: line 24: exec: : not found
+```
+it gives a clearer error message.
+
+5. In `configure`, we now call `sage-system-python` and exit with an error if no suitable system python is found.
+
+See also:
+- #26953: Allow python3 system python
+- #28657: Build Sage without "python"
+- #28738: Docker [SageMath](SageMath) install fails
 
 
 Comment: 1
``````




---

archive/issue_comments_434503.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2020-03-18T01:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434503",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_434504.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+This ticket updates implementation and use of `build/bin/sage-system-python`.\n+\n+1. The script now prefers `python3` over `python`, and in fact checks several more executable names such as `python3.7`.\n+\n+2. Because `sage-download-file` needs the `urllib` module (which is for example not provided by Debian's `python3-minimal` package), it only accepts a python that provides it.\n+\n+3. A mistake from #28657 (as reported in #28738) is fixed - `src/bin/sage-location` should use Sage's python, not the system python.\n+\n+4. Error reporting is improved, it gives a clearer error message instead of messages such as (see #28738 or https://github.com/mkoeppe/sage/runs/412019418)\n+\n+```\n+/sage/build/bin/sage-system-python: line 24: exec: : not found\n+```\n+\n+5. In `configure`, we now call `sage-system-python` and exit with an error if no suitable system python is found.\n+\n+See also:\n+- #26953: Allow python3 system python\n+- #28657: Build Sage without \"python\"\n+- #28738: Docker [SageMath](SageMath) install fails\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-18T01:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434504",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,23 @@
+This ticket updates implementation and use of `build/bin/sage-system-python`.
+
+1. The script now prefers `python3` over `python`, and in fact checks several more executable names such as `python3.7`.
+
+2. Because `sage-download-file` needs the `urllib` module (which is for example not provided by Debian's `python3-minimal` package), it only accepts a python that provides it.
+
+3. A mistake from #28657 (as reported in #28738) is fixed - `src/bin/sage-location` should use Sage's python, not the system python.
+
+4. Error reporting is improved, it gives a clearer error message instead of messages such as (see #28738 or https://github.com/mkoeppe/sage/runs/412019418)
+
+```
+/sage/build/bin/sage-system-python: line 24: exec: : not found
+```
+
+5. In `configure`, we now call `sage-system-python` and exit with an error if no suitable system python is found.
+
+See also:
+- #26953: Allow python3 system python
+- #28657: Build Sage without "python"
+- #28738: Docker [SageMath](SageMath) install fails
 
 
 Comment: 1
``````




---

archive/issue_comments_434505.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-19T00:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434505",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_434506.json:
```json
{
    "body": "<a id='comment:8'></a>Rebased on 9.1.beta8, needs review",
    "created_at": "2020-03-19T00:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434506",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Rebased on 9.1.beta8, needs review



---

archive/issue_comments_434507.json:
```json
{
    "body": "<a id='comment:9'></a>It looks okay to me, but others should look, too. I haven't done very thorough testing.",
    "created_at": "2020-03-19T01:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434507",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>It looks okay to me, but others should look, too. I haven't done very thorough testing.



---

archive/issue_comments_434508.json:
```json
{
    "body": "<a id='comment:11'></a>I think this eventually does the right thing, but if you're going to record a suitable system python in `configure.ac`, then why should `sage-system-python` try several different versions each time it's run? Couldn't we just move that check into `configure.ac`, and then have `sage-system-python` launch the version that `./configure` found?",
    "created_at": "2020-03-20T00:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434508",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:11'></a>I think this eventually does the right thing, but if you're going to record a suitable system python in `configure.ac`, then why should `sage-system-python` try several different versions each time it's run? Couldn't we just move that check into `configure.ac`, and then have `sage-system-python` launch the version that `./configure` found?



---

archive/issue_comments_434509.json:
```json
{
    "body": "<a id='comment:12'></a>The problem is that it needs to work also for bootstrap, at a time when even the configure script is not there.",
    "created_at": "2020-03-20T00:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434509",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>The problem is that it needs to work also for bootstrap, at a time when even the configure script is not there.



---

archive/issue_comments_434510.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 mkoeppe]:\n> The problem is that it needs to work also for bootstrap, at a time when even the configure script is not there.\n\n\nI am expecting this all to make sense and I don't think it's going to.\n\nPlacing \"python\" later in the list might do weird things on Gentoo, where `eselect python` is used to select the system python (what \"python\" does). If someone has selected python-3.6 but happens to have 3.8 installed, the script will choose 3.8 instead. I don't foresee a real problem here, just mentioning it for posterity.\n\nI would suggest `$()` in configure.ac over backticks again, but other than it looks OK.",
    "created_at": "2020-03-20T00:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434510",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>Replying to [comment:12 mkoeppe]:
> The problem is that it needs to work also for bootstrap, at a time when even the configure script is not there.


I am expecting this all to make sense and I don't think it's going to.

Placing "python" later in the list might do weird things on Gentoo, where `eselect python` is used to select the system python (what "python" does). If someone has selected python-3.6 but happens to have 3.8 installed, the script will choose 3.8 instead. I don't foresee a real problem here, just mentioning it for posterity.

I would suggest `$()` in configure.ac over backticks again, but other than it looks OK.



---

archive/issue_comments_434511.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-20T00:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434511",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_434512.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-03-20T00:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434512",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_434513.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2020-03-20T00:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434513",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_434514.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 mjo]:\n> Replying to [comment:12 mkoeppe]:\n> > The problem is that it needs to work also for bootstrap, at a time when even the configure script is not there.\n\n> \n> I am expecting this all to make sense and I don't think it's going to.\n\n\nRight :)\n\n> Placing \"python\" later in the list might do weird things on Gentoo, where `eselect python` is used to select the system python (what \"python\" does). If someone has selected python-3.6 but happens to have 3.8 installed, the script will choose 3.8 instead. I don't foresee a real problem here, just mentioning it for posterity.\n\n\nThat's fine. The `sage-system-python` -- if not abused (see #29355) -- is used in a very limited context only. \n\n> I would suggest `$()` in configure.ac over backticks again, but other than it looks OK.\n\n\nThanks, done.",
    "created_at": "2020-03-20T00:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434514",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Replying to [comment:13 mjo]:
> Replying to [comment:12 mkoeppe]:
> > The problem is that it needs to work also for bootstrap, at a time when even the configure script is not there.

> 
> I am expecting this all to make sense and I don't think it's going to.


Right :)

> Placing "python" later in the list might do weird things on Gentoo, where `eselect python` is used to select the system python (what "python" does). If someone has selected python-3.6 but happens to have 3.8 installed, the script will choose 3.8 instead. I don't foresee a real problem here, just mentioning it for posterity.


That's fine. The `sage-system-python` -- if not abused (see #29355) -- is used in a very limited context only. 

> I would suggest `$()` in configure.ac over backticks again, but other than it looks OK.


Thanks, done.



---

archive/issue_comments_434515.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-20T00:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434515",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_073751.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-25T22:48:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29090#event-73751"
}
```



---

archive/issue_comments_434516.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-25T22:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29090",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29090#issuecomment-434516",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
