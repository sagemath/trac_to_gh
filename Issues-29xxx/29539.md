# Issue 29539: Bug in saturation of elliptic curves over number fields

archive/issues_029302.json:
```json
{
    "body": "In #28488 the code for computing torsion subgroups of elliptic curves over number fields was upgraded and made much more efficient, specifically the function torsion_bound() in `ell_torsion.py`.  That code was tested extensively on a large number of curves, all base-changes of curves defined over QQ, which is (for efficiency) treated as a special case in that function.\n\nI am now running the new code on another large number of curves in the LMFDB and am running into problems which are not easily reproducible, causing run-time errors in lines 408-410 of this file, when the curve is reduced modulo primes.  Typically this only happens after processing hundreds of curves, and when the problematic curve is run by itself it works fine.\n\nI am investigating and will fix this.\n\nAlso using this ticket for more serious problems in saturation code.\n\n**Assignee:** @JohnCremona\n\n**Keywords:** elliptic curve saturation\n\n**Branch/Commit:** [ba9bb5356d61c03b428bf7d26326db8bb189b9c1](https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1)\n\n**Reviewer:** Volker Braun\n\n**Author:** John Cremona\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29539\n\n",
    "closed_at": "2020-08-12T19:53:46Z",
    "created_at": "2020-04-21T09:27:38Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Bug in saturation of elliptic curves over number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29539",
    "user": "https://github.com/JohnCremona"
}
```
In #28488 the code for computing torsion subgroups of elliptic curves over number fields was upgraded and made much more efficient, specifically the function torsion_bound() in `ell_torsion.py`.  That code was tested extensively on a large number of curves, all base-changes of curves defined over QQ, which is (for efficiency) treated as a special case in that function.

I am now running the new code on another large number of curves in the LMFDB and am running into problems which are not easily reproducible, causing run-time errors in lines 408-410 of this file, when the curve is reduced modulo primes.  Typically this only happens after processing hundreds of curves, and when the problematic curve is run by itself it works fine.

I am investigating and will fix this.

Also using this ticket for more serious problems in saturation code.

**Assignee:** @JohnCremona

**Keywords:** elliptic curve saturation

**Branch/Commit:** [ba9bb5356d61c03b428bf7d26326db8bb189b9c1](https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1)

**Reviewer:** Volker Braun

**Author:** John Cremona

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/29539





---

archive/issue_comments_578275.json:
```json
{
    "body": "<a id='comment:1'></a>\nI am also getting different errors from the saturation code, as previously fixed in #27387.  There, the probem was in consistently reducing a curve mod P and points on the curve mod P.\nI will try to fix both issues together: both involve reducing curves over number fields modulo primes.  Both are not deterministic, in that I can the same examples more than once and an error is not always raised.  This is not so surprising since in both cases we compute the cardinality and/or group structure and generators of al elliptic curve defined over a finite field, and the latter is done using random points.",
    "created_at": "2020-04-22T09:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578275",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:1'></a>
I am also getting different errors from the saturation code, as previously fixed in #27387.  There, the probem was in consistently reducing a curve mod P and points on the curve mod P.
I will try to fix both issues together: both involve reducing curves over number fields modulo primes.  Both are not deterministic, in that I can the same examples more than once and an error is not always raised.  This is not so surprising since in both cases we compute the cardinality and/or group structure and generators of al elliptic curve defined over a finite field, and the latter is done using random points.



---

archive/issue_comments_578276.json:
```json
{
    "body": "<a id='comment:2'></a>\nI think I have fixed the second bug, and will say what the problem is here before I forget.  When applying p-saturation to a list of points (which are independent points of infinite order) we first append to the list up to 2 torsion generators, just those (if any) whose order is divisible by p.  When the code does this (on line 449 of saturation.py) it forgot that the elements of E.torsion_subgroup().gens() are not actually points, even though they display as points, but elements of an abstract group structure.  To get the actual point from one of these, say T, you need to use T.element().  Later on, the torsion points added wrongly to the list i nthis way were not being correctly reduced modulo auxiliary primes Q.\n\nI have been stung by this several times before.  It is nice that the elements of E.torsion_subgroup() display just like actual points, and it is efficient that they are actually elements of a finite abelian group when it comes to asking their order, for example, but it leads to problems like this which are hard to diagnose.",
    "created_at": "2020-04-22T10:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578276",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:2'></a>
I think I have fixed the second bug, and will say what the problem is here before I forget.  When applying p-saturation to a list of points (which are independent points of infinite order) we first append to the list up to 2 torsion generators, just those (if any) whose order is divisible by p.  When the code does this (on line 449 of saturation.py) it forgot that the elements of E.torsion_subgroup().gens() are not actually points, even though they display as points, but elements of an abstract group structure.  To get the actual point from one of these, say T, you need to use T.element().  Later on, the torsion points added wrongly to the list i nthis way were not being correctly reduced modulo auxiliary primes Q.

I have been stung by this several times before.  It is nice that the elements of E.torsion_subgroup() display just like actual points, and it is efficient that they are actually elements of a finite abelian group when it comes to asking their order, for example, but it leads to problems like this which are hard to diagnose.



---

archive/issue_comments_578277.json:
```json
{
    "body": "<a id='comment:3'></a>\nAfter spending a huge amount of time on the saturation code, which will result in a simplification of the code (but not actual change to the algorithm) I finally hit on a real bug, and it is not in code I wrote at all but in the discrete_log_lambda function.  Example below.  It was very hard to track down sine when one does E.abelian_group() for E an elliptic curve over a finite field, then generators are not deterministic, and the bug only occurs for some choices of generators.\n\n```\nsage: F = GF(29)\nsage: E = EllipticCurve(F,[18,23,22,4,11])\nsage: G = E.abelian_group()\nsage: g = 8*G.gens()[0]; g; g.order()\n(20 : 4 : 1)\n5\nsage: [discrete_log_rho(i*g,g,ord=5,operation='+') for i in range(5)]\n[0, 1, 2, 3, 4]\nsage: [discrete_log(i*g,g,ord=5,operation='+') for i in range(5)]\n[0, 1, 2, 3, 4]\nsage: [discrete_log_lambda(i*g,g,bounds=(0,4),operation='+') for i in range(4)]\n[0, 1, 2, 3]\n```\nbut\n\n```\nsage: discrete_log_lambda(4*g,g,bounds=(0,4),operation='+')\n...\nValueError: Pollard Lambda failed to find a log\n```\nI think the issue is that some (but not all) of the discrete log variants have a parameter bounds which is a tuple (lb,ub) and the functions are inconsistent as to whether the range of log values is intended to be lb<=v<ub or lb<=v<=ub.",
    "created_at": "2020-05-19T08:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578277",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:3'></a>
After spending a huge amount of time on the saturation code, which will result in a simplification of the code (but not actual change to the algorithm) I finally hit on a real bug, and it is not in code I wrote at all but in the discrete_log_lambda function.  Example below.  It was very hard to track down sine when one does E.abelian_group() for E an elliptic curve over a finite field, then generators are not deterministic, and the bug only occurs for some choices of generators.

```
sage: F = GF(29)
sage: E = EllipticCurve(F,[18,23,22,4,11])
sage: G = E.abelian_group()
sage: g = 8*G.gens()[0]; g; g.order()
(20 : 4 : 1)
5
sage: [discrete_log_rho(i*g,g,ord=5,operation='+') for i in range(5)]
[0, 1, 2, 3, 4]
sage: [discrete_log(i*g,g,ord=5,operation='+') for i in range(5)]
[0, 1, 2, 3, 4]
sage: [discrete_log_lambda(i*g,g,bounds=(0,4),operation='+') for i in range(4)]
[0, 1, 2, 3]
```
but

```
sage: discrete_log_lambda(4*g,g,bounds=(0,4),operation='+')
...
ValueError: Pollard Lambda failed to find a log
```
I think the issue is that some (but not all) of the discrete log variants have a parameter bounds which is a tuple (lb,ub) and the functions are inconsistent as to whether the range of log values is intended to be lb<=v<ub or lb<=v<=ub.



---

archive/issue_comments_578278.json:
```json
{
    "body": "**Commit:** [5c43df322835578025208adb8d1c4e9615901649](https://github.com/sagemath/sagetrac-mirror/commit/5c43df322835578025208adb8d1c4e9615901649)",
    "created_at": "2020-05-29T09:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578278",
    "user": "https://github.com/JohnCremona"
}
```


**Commit:** [5c43df322835578025208adb8d1c4e9615901649](https://github.com/sagemath/sagetrac-mirror/commit/5c43df322835578025208adb8d1c4e9615901649)



---

archive/issue_comments_578279.json:
```json
{
    "body": "<a id='comment:4'></a>\nNot yet quite ready for review but the branch is here already.\n\nChanges in saturation code: much refactoring in saturation.py, with both code simplification and also some algorithmic enhancements:\n\n1. Reduction primes Q are degree 1 primes above rational primes q chosen to make the reduction simplest: not ramified and not dividing the index of the equation order (i.e. not dividing the discriminant of the defining polynomial of th base field).   With such q, Q can be found by factoring the defining polynomial and then the reduction of the curve can be defined directly over GF(q) by simply reducing the curve coefficients.  Secondly, q does not divide the denominators of the points being saturated, so that reducing the points is also simpler.\n\n2. Saturation is now carried out within a new class `EllipticCurveSaturator`.  This enables the information about the reduced curves and their cardinality to be re-used when p-saturating for many primes p, which is more efficient, since that information is stored within the class.\n\n3. I noticed a special case taking a long time, namely for curves with rational CM by a discriminant D, p-saturation when kronecker(D,p)=-1 was taking a long time, much longer than when kronecker(D,p)=+1.   This is because the mod-p representation is non-split Cartan which in turn means that the p-torsion is defined over a cyclic extension of degree `p^2-1` and hence the density of Q which are usable is `1/(p^2-1)`.  By only testing q such that q=1 (mod p) this is reduced to 1/(p+1) which is OK.  In th split case the density is 1/(p-1) anyway.  This step helped a lot in saturating curves over QQ(sqrt(D)) for D=-3,-4,-7,-8,-11 which are in the LMFDB.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/59bcbea535efad713815867883d210460908a3ac\">59bcbea</a></td><td><code>#29539: fixed saturation bug</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/121a21984d24a386ac86336041a0291a39bec9a4\">121a219</a></td><td><code>#29539: more work on saturation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/999fa92271220a18e984f98cbc9d107fa41d3aa2\">999fa92</a></td><td><code>saturation uses sieving even for 1 point except for p=2, as it is faster</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4e1cb12d4a28e2e46d08928ff0d5353b5929c8a5\">4e1cb12</a></td><td><code>elliptic curve point saturation: streamlined</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1eac719dd9e8f3f498e822aa627f3ad142c00dd6\">1eac719</a></td><td><code>final saturation dlog fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cde8a61ecb7925e466a24ddcc7a8bbde8aeea61b\">cde8a61</a></td><td><code>work on saturation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b97289f4853f32001d6ae8972c9e4bb9420a779\">7b97289</a></td><td><code>refactored saturation code into its own class</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5c43df322835578025208adb8d1c4e9615901649\">5c43df3</a></td><td><code>saturation: more efficient test of reductions for rational CM curves</code></td></tr></table>\n",
    "created_at": "2020-05-29T09:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578279",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:4'></a>
Not yet quite ready for review but the branch is here already.

Changes in saturation code: much refactoring in saturation.py, with both code simplification and also some algorithmic enhancements:

1. Reduction primes Q are degree 1 primes above rational primes q chosen to make the reduction simplest: not ramified and not dividing the index of the equation order (i.e. not dividing the discriminant of the defining polynomial of th base field).   With such q, Q can be found by factoring the defining polynomial and then the reduction of the curve can be defined directly over GF(q) by simply reducing the curve coefficients.  Secondly, q does not divide the denominators of the points being saturated, so that reducing the points is also simpler.

2. Saturation is now carried out within a new class `EllipticCurveSaturator`.  This enables the information about the reduced curves and their cardinality to be re-used when p-saturating for many primes p, which is more efficient, since that information is stored within the class.

3. I noticed a special case taking a long time, namely for curves with rational CM by a discriminant D, p-saturation when kronecker(D,p)=-1 was taking a long time, much longer than when kronecker(D,p)=+1.   This is because the mod-p representation is non-split Cartan which in turn means that the p-torsion is defined over a cyclic extension of degree `p^2-1` and hence the density of Q which are usable is `1/(p^2-1)`.  By only testing q such that q=1 (mod p) this is reduced to 1/(p+1) which is OK.  In th split case the density is 1/(p-1) anyway.  This step helped a lot in saturating curves over QQ(sqrt(D)) for D=-3,-4,-7,-8,-11 which are in the LMFDB.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/59bcbea535efad713815867883d210460908a3ac">59bcbea</a></td><td><code>#29539: fixed saturation bug</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/121a21984d24a386ac86336041a0291a39bec9a4">121a219</a></td><td><code>#29539: more work on saturation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/999fa92271220a18e984f98cbc9d107fa41d3aa2">999fa92</a></td><td><code>saturation uses sieving even for 1 point except for p=2, as it is faster</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4e1cb12d4a28e2e46d08928ff0d5353b5929c8a5">4e1cb12</a></td><td><code>elliptic curve point saturation: streamlined</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1eac719dd9e8f3f498e822aa627f3ad142c00dd6">1eac719</a></td><td><code>final saturation dlog fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cde8a61ecb7925e466a24ddcc7a8bbde8aeea61b">cde8a61</a></td><td><code>work on saturation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b97289f4853f32001d6ae8972c9e4bb9420a779">7b97289</a></td><td><code>refactored saturation code into its own class</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5c43df322835578025208adb8d1c4e9615901649">5c43df3</a></td><td><code>saturation: more efficient test of reductions for rational CM curves</code></td></tr></table>




---

archive/issue_comments_578280.json:
```json
{
    "body": "**Branch:** [u/cremona/29539](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/29539)",
    "created_at": "2020-05-29T09:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578280",
    "user": "https://github.com/JohnCremona"
}
```


**Branch:** [u/cremona/29539](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/29539)



---

archive/issue_comments_578281.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,3 +3,5 @@\n I am now running the new code on another large number of curves in the LMFDB and am running into problems which are not easily reproducible, causing run-time errors in lines 408-410 of this file, when the curve is reduced modulo primes.  Typically this only happens after processing hundreds of curves, and when the problematic curve is run by itself it works fine.\n \n I am investigating and will fix this.\n+\n+Also using this ticket for more serious problems in saturation code.\n``````\n",
    "created_at": "2020-05-29T09:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578281",
    "user": "https://github.com/JohnCremona"
}
```


**Description changed:**
``````diff
--- 
+++ 
@@ -3,3 +3,5 @@
 I am now running the new code on another large number of curves in the LMFDB and am running into problems which are not easily reproducible, causing run-time errors in lines 408-410 of this file, when the curve is reduced modulo primes.  Typically this only happens after processing hundreds of curves, and when the problematic curve is run by itself it works fine.
 
 I am investigating and will fix this.
+
+Also using this ticket for more serious problems in saturation code.
``````




---

archive/issue_comments_578282.json:
```json
{
    "body": "**Assignee:** @JohnCremona",
    "created_at": "2020-05-29T09:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578282",
    "user": "https://github.com/JohnCremona"
}
```


**Assignee:** @JohnCremona



---

archive/issue_comments_578283.json:
```json
{
    "body": "**Changing keywords** from \"elliptic curve torsin subgroup\" to \"elliptic curve saturation\".",
    "created_at": "2020-05-29T09:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578283",
    "user": "https://github.com/JohnCremona"
}
```


**Changing keywords** from "elliptic curve torsin subgroup" to "elliptic curve saturation".



---

archive/issue_events_085078.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "rename": {
        "from": "Bug in torsion subgroup of elliptic curves over number fields",
        "to": "Bug in saturation of elliptic curves over number fields"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29539#event-85078"
}
```




---

archive/issue_comments_578284.json:
```json
{
    "body": "**Changing commit** from \"[5c43df322835578025208adb8d1c4e9615901649](https://github.com/sagemath/sagetrac-mirror/commit/5c43df322835578025208adb8d1c4e9615901649)\" to \"[f64513892d082bbd5b94de76b0073732b2c7f0cf](https://github.com/sagemath/sagetrac-mirror/commit/f64513892d082bbd5b94de76b0073732b2c7f0cf)\".",
    "created_at": "2020-05-29T16:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578284",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[5c43df322835578025208adb8d1c4e9615901649](https://github.com/sagemath/sagetrac-mirror/commit/5c43df322835578025208adb8d1c4e9615901649)" to "[f64513892d082bbd5b94de76b0073732b2c7f0cf](https://github.com/sagemath/sagetrac-mirror/commit/f64513892d082bbd5b94de76b0073732b2c7f0cf)".



---

archive/issue_comments_578285.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f64513892d082bbd5b94de76b0073732b2c7f0cf\">f645138</a></td><td><code>#29539: move p_projections() out of the EllipticCurveSaturator class</code></td></tr></table>\n",
    "created_at": "2020-05-29T16:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578285",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f64513892d082bbd5b94de76b0073732b2c7f0cf">f645138</a></td><td><code>#29539: move p_projections() out of the EllipticCurveSaturator class</code></td></tr></table>




---

archive/issue_comments_578286.json:
```json
{
    "body": "**Changing commit** from \"[f64513892d082bbd5b94de76b0073732b2c7f0cf](https://github.com/sagemath/sagetrac-mirror/commit/f64513892d082bbd5b94de76b0073732b2c7f0cf)\" to \"[1783566c9992245adde7f3e55b87c112e7109877](https://github.com/sagemath/sagetrac-mirror/commit/1783566c9992245adde7f3e55b87c112e7109877)\".",
    "created_at": "2020-06-02T13:06:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[f64513892d082bbd5b94de76b0073732b2c7f0cf](https://github.com/sagemath/sagetrac-mirror/commit/f64513892d082bbd5b94de76b0073732b2c7f0cf)" to "[1783566c9992245adde7f3e55b87c112e7109877](https://github.com/sagemath/sagetrac-mirror/commit/1783566c9992245adde7f3e55b87c112e7109877)".



---

archive/issue_comments_578287.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1783566c9992245adde7f3e55b87c112e7109877\">1783566</a></td><td><code>#29539: added missing doctests</code></td></tr></table>\n",
    "created_at": "2020-06-02T13:06:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1783566c9992245adde7f3e55b87c112e7109877">1783566</a></td><td><code>#29539: added missing doctests</code></td></tr></table>




---

archive/issue_comments_578288.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis is now ready for review.\n\nI have to come clean on one matter.  The (stand-alone) function `p_projections(Eq, points, p)` in saturation.py still sometimes and un-reproducibly raises an error.  The function which calls this one catches that and uses a different reduction prime, so no fatal error is raised and everything works OK.  The error always occurs when p=2 and the 2-primary part of Eq.abelian_group() is not cyclic.  (Here Eq is an elliptic curve over GF(q), oints is a list of points on Eq, and p is a prime.) After multiplying the generators of Eq by the prime-to-p part of the group order one should still have 2 non-trivial generators and then use the part of the code for this case, which uses the Weil pairing.  But occasionally after that multiplication only one non-trivial generator remains, the code for the cyclic case runs, and fails when any of the points in the supplied list is not a multiple of the only generator.  I have so far been unable to find any example of this which is reproducible, and I was careful (I think) to clear caches.  But I want to move on.\n\nApat from this one issue (which has been there ever since this code was first written) the other changes made on this ticket are all worth having as they simplify and speed up saturation.  I have run this on several hundred thousand curves.  For example, i one run which is ongoing, after saturating 28656 curves over several quartic fields, I have seen the issue 5 times.\n\nFor the record, here is one example (https://www.lmfdb.org/EllipticCurve/4.4.18496.1/36.4/i/2)\n\n```\nsage: x = polygen(QQ)\nsage: K.<a> = NumberField(x^4 - 2*x^3 - 11*x^2 + 12*x + 2)\nsage: E = EllipticCurve([1, 2/9*a^3 - 1/3*a^2 - 19/9*a + 10/9, -1/9*a^3 + 2/3*a^2 + 14/9*a - 23/9, -2*a^3 - 5*a^2 + 4*a + 3, -89/9*a^3 - 56/3*a^2 + 301/9*a + 32/9])\nsage: points = [E([-5/9*a^3 + 1/3*a^2 + 52/9*a + 2/9 , 10/9*a^3 - 5/3*a^2 - 131/9*a - 4/9 ])]\n```\nwhere the output with debug=True was once\n\n```\nIn p_projections(G,Plist,p) with G = Additive abelian group isomorphic to Z/24 + Z/2 embedded in Abelian group of points on Elliptic Curve defined by y^2 + x*y + 37*y = x^3 + 7*x^2 + 12*x + 38 over Finite Field of size 47, Plist = [(25 : 30 : 1), (35 : 11 : 1)], p = 2\nm=3, n=48\ngens for 2-primary part of G: [(14 : 38 : 1)]\n3*points: [(0 : 9 : 1), (35 : 11 : 1)]\nCyclic case, taking dlogs to base (14 : 38 : 1) of order 8\n```\nHere the group structure is 24*2 so multiplying by 3 maps to the 2-primary part with structure 8*2, however multiplying the gens by 3 and then dropping any which are 0 here results in a list of length 1 not 2.\n\n```\nsage: from sage.schemes.elliptic_curves.saturation import EllipticCurveSaturator\nsage: saturator = EllipticCurveSaturator(E, verbose=True)\nsage: saturator.full_p_saturation(points, p=2)\n --starting full 2-saturation\nAdding 1 torsion generators before 2-saturation\nUsing sieve method to saturate...\nE has 2-torsion over Finite Field of size 47, projecting points\n --> [(13 : 1 : 1), (33 : 43 : 1)]\n --rank is now 1\n --rank is now 2\nReached full rank: points were 2-saturated\nRemoving the torsion generators after 2-saturation\nPoints were 2-saturated\n([(-5/9*a^3 + 1/3*a^2 + 52/9*a + 2/9 : 10/9*a^3 - 5/3*a^2 - 131/9*a - 4/9 : 1)],\n 0)\n```\n\nThe underlying reason for the lack of reproducibility is that Eq.abelian_group() uses random points.  I did some testing with all possible pairs of generators but had no luck.  So I am wondering if some code somewhere is overwriting the cached gens.",
    "created_at": "2020-06-02T13:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578288",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:7'></a>
This is now ready for review.

I have to come clean on one matter.  The (stand-alone) function `p_projections(Eq, points, p)` in saturation.py still sometimes and un-reproducibly raises an error.  The function which calls this one catches that and uses a different reduction prime, so no fatal error is raised and everything works OK.  The error always occurs when p=2 and the 2-primary part of Eq.abelian_group() is not cyclic.  (Here Eq is an elliptic curve over GF(q), oints is a list of points on Eq, and p is a prime.) After multiplying the generators of Eq by the prime-to-p part of the group order one should still have 2 non-trivial generators and then use the part of the code for this case, which uses the Weil pairing.  But occasionally after that multiplication only one non-trivial generator remains, the code for the cyclic case runs, and fails when any of the points in the supplied list is not a multiple of the only generator.  I have so far been unable to find any example of this which is reproducible, and I was careful (I think) to clear caches.  But I want to move on.

Apat from this one issue (which has been there ever since this code was first written) the other changes made on this ticket are all worth having as they simplify and speed up saturation.  I have run this on several hundred thousand curves.  For example, i one run which is ongoing, after saturating 28656 curves over several quartic fields, I have seen the issue 5 times.

For the record, here is one example (https://www.lmfdb.org/EllipticCurve/4.4.18496.1/36.4/i/2)

```
sage: x = polygen(QQ)
sage: K.<a> = NumberField(x^4 - 2*x^3 - 11*x^2 + 12*x + 2)
sage: E = EllipticCurve([1, 2/9*a^3 - 1/3*a^2 - 19/9*a + 10/9, -1/9*a^3 + 2/3*a^2 + 14/9*a - 23/9, -2*a^3 - 5*a^2 + 4*a + 3, -89/9*a^3 - 56/3*a^2 + 301/9*a + 32/9])
sage: points = [E([-5/9*a^3 + 1/3*a^2 + 52/9*a + 2/9 , 10/9*a^3 - 5/3*a^2 - 131/9*a - 4/9 ])]
```
where the output with debug=True was once

```
In p_projections(G,Plist,p) with G = Additive abelian group isomorphic to Z/24 + Z/2 embedded in Abelian group of points on Elliptic Curve defined by y^2 + x*y + 37*y = x^3 + 7*x^2 + 12*x + 38 over Finite Field of size 47, Plist = [(25 : 30 : 1), (35 : 11 : 1)], p = 2
m=3, n=48
gens for 2-primary part of G: [(14 : 38 : 1)]
3*points: [(0 : 9 : 1), (35 : 11 : 1)]
Cyclic case, taking dlogs to base (14 : 38 : 1) of order 8
```
Here the group structure is 24*2 so multiplying by 3 maps to the 2-primary part with structure 8*2, however multiplying the gens by 3 and then dropping any which are 0 here results in a list of length 1 not 2.

```
sage: from sage.schemes.elliptic_curves.saturation import EllipticCurveSaturator
sage: saturator = EllipticCurveSaturator(E, verbose=True)
sage: saturator.full_p_saturation(points, p=2)
 --starting full 2-saturation
Adding 1 torsion generators before 2-saturation
Using sieve method to saturate...
E has 2-torsion over Finite Field of size 47, projecting points
 --> [(13 : 1 : 1), (33 : 43 : 1)]
 --rank is now 1
 --rank is now 2
Reached full rank: points were 2-saturated
Removing the torsion generators after 2-saturation
Points were 2-saturated
([(-5/9*a^3 + 1/3*a^2 + 52/9*a + 2/9 : 10/9*a^3 - 5/3*a^2 - 131/9*a - 4/9 : 1)],
 0)
```

The underlying reason for the lack of reproducibility is that Eq.abelian_group() uses random points.  I did some testing with all possible pairs of generators but had no luck.  So I am wondering if some code somewhere is overwriting the cached gens.



---

archive/issue_comments_578289.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2020-06-02T13:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578289",
    "user": "https://github.com/JohnCremona"
}
```


**Changing status** from new to needs_review.



---

archive/issue_comments_578290.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2020-08-07T19:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578290",
    "user": "https://github.com/vbraun"
}
```


**Changing status** from needs_review to positive_review.



---

archive/issue_comments_578291.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2020-08-07T19:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578291",
    "user": "https://github.com/vbraun"
}
```


**Reviewer:** Volker Braun



---

archive/issue_comments_578292.json:
```json
{
    "body": "<a id='comment:8'></a>\nI'm getting the \n\n```\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/saturation.py\", line 417, in sage.schemes.elliptic_curves.saturation.dict\nFailed example:\n    full_p_saturation([P,Q+3*R,Q-4*R],7)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 715, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1139, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.elliptic_curves.saturation.dict[9]>\", line 1, in <module>\n        full_p_saturation([P,Q+Integer(3)*R,Q-Integer(4)*R],Integer(7))\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py\", line 460, in full_p_saturation\n        res = p_saturation(Plist, p, True, lin_combs, verbose)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py\", line 311, in p_saturation\n        vecs = projections(Q, p)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py\", line 297, in projections\n        return [vector(GF(p), [a(pt,gen) for pt in projPlist]) for gen in gg]\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py\", line 297, in <listcomp>\n        return [vector(GF(p), [a(pt,gen) for pt in projPlist]) for gen in gg]\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py\", line 297, in <listcomp>\n        return [vector(GF(p), [a(pt,gen) for pt in projPlist]) for gen in gg]\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py\", line 295, in a\n        return discrete_log_lambda(w,zeta,(0,p1),'*')\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/groups/generic.py\", line 944, in discrete_log_lambda\n        raise ValueError(\"Pollard Lambda failed to find a log\")\n    ValueError: Pollard Lambda failed to find a log\n**********************************************************************\n```\ntest failure randomly on the patchbots, hopefully this ticket will fix it ;-)",
    "created_at": "2020-08-07T19:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578292",
    "user": "https://github.com/vbraun"
}
```


<a id='comment:8'></a>
I'm getting the 

```
**********************************************************************
File "src/sage/schemes/elliptic_curves/saturation.py", line 417, in sage.schemes.elliptic_curves.saturation.dict
Failed example:
    full_p_saturation([P,Q+3*R,Q-4*R],7)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.saturation.dict[9]>", line 1, in <module>
        full_p_saturation([P,Q+Integer(3)*R,Q-Integer(4)*R],Integer(7))
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py", line 460, in full_p_saturation
        res = p_saturation(Plist, p, True, lin_combs, verbose)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py", line 311, in p_saturation
        vecs = projections(Q, p)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py", line 297, in projections
        return [vector(GF(p), [a(pt,gen) for pt in projPlist]) for gen in gg]
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py", line 297, in <listcomp>
        return [vector(GF(p), [a(pt,gen) for pt in projPlist]) for gen in gg]
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py", line 297, in <listcomp>
        return [vector(GF(p), [a(pt,gen) for pt in projPlist]) for gen in gg]
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/schemes/elliptic_curves/saturation.py", line 295, in a
        return discrete_log_lambda(w,zeta,(0,p1),'*')
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/groups/generic.py", line 944, in discrete_log_lambda
        raise ValueError("Pollard Lambda failed to find a log")
    ValueError: Pollard Lambda failed to find a log
**********************************************************************
```
test failure randomly on the patchbots, hopefully this ticket will fix it ;-)



---

archive/issue_comments_578293.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2020-08-08T08:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578293",
    "user": "https://github.com/vbraun"
}
```


**Changing status** from positive_review to needs_work.



---

archive/issue_comments_578294.json:
```json
{
    "body": "<a id='comment:9'></a>\nPDF documentation fails to build",
    "created_at": "2020-08-08T08:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578294",
    "user": "https://github.com/vbraun"
}
```


<a id='comment:9'></a>
PDF documentation fails to build



---

archive/issue_comments_578295.json:
```json
{
    "body": "<a id='comment:10'></a>\nYes, I do hope that this ticket will fix those random failures.\n\nI will look at the doc build issue.",
    "created_at": "2020-08-08T11:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578295",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:10'></a>
Yes, I do hope that this ticket will fix those random failures.

I will look at the doc build issue.



---

archive/issue_comments_578296.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [cremona](#comment%3A10):\n> Yes, I do hope that this ticket will fix those random failures.\n> \n> I will look at the doc build issue.\n\n\nGot it: there were 4 occurrences of \\F instead of \\GF in saturation.py.  I'll upload a corrected branch.",
    "created_at": "2020-08-09T09:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578296",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:11'></a>
Replying to [cremona](#comment%3A10):
> Yes, I do hope that this ticket will fix those random failures.
> 
> I will look at the doc build issue.


Got it: there were 4 occurrences of \F instead of \GF in saturation.py.  I'll upload a corrected branch.



---

archive/issue_comments_578297.json:
```json
{
    "body": "**Changing commit** from \"[1783566c9992245adde7f3e55b87c112e7109877](https://github.com/sagemath/sagetrac-mirror/commit/1783566c9992245adde7f3e55b87c112e7109877)\" to \"[ba9bb5356d61c03b428bf7d26326db8bb189b9c1](https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1)\".",
    "created_at": "2020-08-10T10:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[1783566c9992245adde7f3e55b87c112e7109877](https://github.com/sagemath/sagetrac-mirror/commit/1783566c9992245adde7f3e55b87c112e7109877)" to "[ba9bb5356d61c03b428bf7d26326db8bb189b9c1](https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1)".



---

archive/issue_comments_578298.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5c94971a8c4b3edda7df9693902f2221a7e85cec\">5c94971</a></td><td><code>Merge branch 'develop' into 29539</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1\">ba9bb53</a></td><td><code>fix finite field macro in saturation docstrings</code></td></tr></table>\n",
    "created_at": "2020-08-10T10:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578298",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5c94971a8c4b3edda7df9693902f2221a7e85cec">5c94971</a></td><td><code>Merge branch 'develop' into 29539</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1">ba9bb53</a></td><td><code>fix finite field macro in saturation docstrings</code></td></tr></table>




---

archive/issue_comments_578299.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2020-08-10T10:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578299",
    "user": "https://github.com/JohnCremona"
}
```


**Changing status** from needs_work to needs_review.



---

archive/issue_comments_578300.json:
```json
{
    "body": "<a id='comment:13'></a>\nThis had a positive review apart from the docstring issue which is now fixed.",
    "created_at": "2020-08-10T10:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578300",
    "user": "https://github.com/JohnCremona"
}
```


<a id='comment:13'></a>
This had a positive review apart from the docstring issue which is now fixed.



---

archive/issue_comments_578301.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2020-08-10T11:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578301",
    "user": "https://github.com/vbraun"
}
```


**Changing status** from needs_review to positive_review.



---

archive/issue_events_085079.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-12T19:53:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29539#event-85079"
}
```




---

archive/issue_comments_578302.json:
```json
{
    "body": "**Changing branch** from \"[u/cremona/29539](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/29539)\" to \"[ba9bb5356d61c03b428bf7d26326db8bb189b9c1](https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1)\".",
    "created_at": "2020-08-12T19:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578302",
    "user": "https://github.com/vbraun"
}
```


**Changing branch** from "[u/cremona/29539](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/29539)" to "[ba9bb5356d61c03b428bf7d26326db8bb189b9c1](https://github.com/sagemath/sagetrac-mirror/commit/ba9bb5356d61c03b428bf7d26326db8bb189b9c1)".



---

archive/issue_comments_578303.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2020-08-12T19:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29539#issuecomment-578303",
    "user": "https://github.com/vbraun"
}
```


**Resolution:** fixed
