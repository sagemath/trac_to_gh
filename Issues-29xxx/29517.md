# Issue 29517: register_as_coercion fails when no coercion map was already discovered

archive/issues_029280.json:
```json
{
    "body": "Compare:\n\n```\nsage: A.<a> = ZZ[]\nsage: B.<b> = ZZ[]\nsage: phi = A.hom([b])\nsage: phi.register_as_coercion()\n```\n\nwith:\n\n```\nsage: A.<a> = ZZ[]\nsage: B.<b> = ZZ[]\nsage: B.has_coerce_map_from(A)\nFalse\nsage: phi = A.hom([b])\nsage: phi.register_as_coercion()\nTraceback (most recent call last):\n...\nAssertionError: coercion from Univariate Polynomial Ring in a over Integer Ring to Univariate Polynomial Ring in b over Integer Ring already registered or discovered\n```\n\n\nCC:  @tscrim\n\nBranch/Commit: 1b1467b8d6ddeb999247eb00cf830917d926ed6f\n\nReviewer: Travis Scrimshaw\n\nAuthor: Xavier Caruso\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29517\n\n",
    "closed_at": "2020-04-18T08:35:03Z",
    "created_at": "2020-04-16T08:53:40Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "register_as_coercion fails when no coercion map was already discovered",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29517",
    "user": "https://github.com/xcaruso"
}
```
Compare:

```
sage: A.<a> = ZZ[]
sage: B.<b> = ZZ[]
sage: phi = A.hom([b])
sage: phi.register_as_coercion()
```

with:

```
sage: A.<a> = ZZ[]
sage: B.<b> = ZZ[]
sage: B.has_coerce_map_from(A)
False
sage: phi = A.hom([b])
sage: phi.register_as_coercion()
Traceback (most recent call last):
...
AssertionError: coercion from Univariate Polynomial Ring in a over Integer Ring to Univariate Polynomial Ring in b over Integer Ring already registered or discovered
```


CC:  @tscrim

Branch/Commit: 1b1467b8d6ddeb999247eb00cf830917d926ed6f

Reviewer: Travis Scrimshaw

Author: Xavier Caruso

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29517





---

archive/issue_comments_576883.json:
```json
{
    "body": "Changing branch from \"\" to \"u/caruso/register_coercion\"",
    "created_at": "2020-04-16T09:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576883",
    "user": "https://github.com/xcaruso"
}
```

Changing branch from "" to "u/caruso/register_coercion"



---

archive/issue_comments_576884.json:
```json
{
    "body": "Changing branch from \"u/caruso/register_coercion\" to \"\"",
    "created_at": "2020-04-16T09:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576884",
    "user": "https://github.com/xcaruso"
}
```

Changing branch from "u/caruso/register_coercion" to ""



---

archive/issue_comments_576885.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-16T09:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576885",
    "user": "https://github.com/xcaruso"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_576886.json:
```json
{
    "body": "Changing commit from \"\" to \"10ed24e3ed0b5440624d5f1a9b18d2f8f89d8126\"",
    "created_at": "2020-04-16T09:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576886",
    "user": "https://github.com/xcaruso"
}
```

Changing commit from "" to "10ed24e3ed0b5440624d5f1a9b18d2f8f89d8126"



---

archive/issue_comments_576887.json:
```json
{
    "body": "Changing branch from \"\" to \"u/caruso/register_coercion\"",
    "created_at": "2020-04-16T09:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576887",
    "user": "https://github.com/xcaruso"
}
```

Changing branch from "" to "u/caruso/register_coercion"



---

archive/issue_comments_576888.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[0e15a9e](https://git.sagemath.org/sage.git/commit/?id=0e15a9e63d86091692fff04c925ae16a95b6362d)|`better test in register_coercion`|",
    "created_at": "2020-04-16T09:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576888",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[0e15a9e](https://git.sagemath.org/sage.git/commit/?id=0e15a9e63d86091692fff04c925ae16a95b6362d)|`better test in register_coercion`|



---

archive/issue_comments_576889.json:
```json
{
    "body": "Changing commit from \"10ed24e3ed0b5440624d5f1a9b18d2f8f89d8126\" to \"0e15a9e63d86091692fff04c925ae16a95b6362d\"",
    "created_at": "2020-04-16T09:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "10ed24e3ed0b5440624d5f1a9b18d2f8f89d8126" to "0e15a9e63d86091692fff04c925ae16a95b6362d"



---

archive/issue_comments_576890.json:
```json
{
    "body": "<a id='comment:5'></a>\nDoctest failure here:\n\n```\nFile \"src/sage/categories/morphism.pyx\", line 269, in sage.categories.morphism.Morphism.register_as_coercion\nFailed example:\n    phi.register_as_coercion()\nExpected:\n    Traceback (most recent call last):\n    ...\n    AssertionError: coercion from Univariate Polynomial Ring in x over Integer Ring to Univariate Polynomial Ring in y over Integer Ring already registered or discovered\nGot:\n    <BLANKLINE>\n```\n\nI cannot remember if this behavior was intentional or not as we might not wanted to create a coercion after explicitly checking that there was not one as a safety check. However, even if that was the case, I think this is the more natural thing to permit since the user should really know what they are doing to add this.\n\nSo once the doctest is fixed, then you can set a positive review on my behalf.",
    "created_at": "2020-04-16T14:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576890",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Doctest failure here:

```
File "src/sage/categories/morphism.pyx", line 269, in sage.categories.morphism.Morphism.register_as_coercion
Failed example:
    phi.register_as_coercion()
Expected:
    Traceback (most recent call last):
    ...
    AssertionError: coercion from Univariate Polynomial Ring in x over Integer Ring to Univariate Polynomial Ring in y over Integer Ring already registered or discovered
Got:
    <BLANKLINE>
```

I cannot remember if this behavior was intentional or not as we might not wanted to create a coercion after explicitly checking that there was not one as a safety check. However, even if that was the case, I think this is the more natural thing to permit since the user should really know what they are doing to add this.

So once the doctest is fixed, then you can set a positive review on my behalf.



---

archive/issue_comments_576891.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2020-04-16T14:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576891",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_576892.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|\n|[1b1467b](https://git.sagemath.org/sage.git/commit/?id=1b1467b8d6ddeb999247eb00cf830917d926ed6f)|`modify a doctest`|",
    "created_at": "2020-04-16T14:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576892",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|
|[1b1467b](https://git.sagemath.org/sage.git/commit/?id=1b1467b8d6ddeb999247eb00cf830917d926ed6f)|`modify a doctest`|



---

archive/issue_comments_576893.json:
```json
{
    "body": "Changing commit from \"0e15a9e63d86091692fff04c925ae16a95b6362d\" to \"1b1467b8d6ddeb999247eb00cf830917d926ed6f\"",
    "created_at": "2020-04-16T14:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576893",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0e15a9e63d86091692fff04c925ae16a95b6362d" to "1b1467b8d6ddeb999247eb00cf830917d926ed6f"



---

archive/issue_comments_576894.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-16T14:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576894",
    "user": "https://github.com/xcaruso"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_576895.json:
```json
{
    "body": "<a id='comment:8'></a>\nMissing author name.",
    "created_at": "2020-04-16T14:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576895",
    "user": "https://github.com/slel"
}
```

<a id='comment:8'></a>
Missing author name.



---

archive/issue_comments_576896.json:
```json
{
    "body": "Changing author from \"\" to \"Xavier Caruso\"",
    "created_at": "2020-04-16T14:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576896",
    "user": "https://github.com/xcaruso"
}
```

Changing author from "" to "Xavier Caruso"



---

archive/issue_comments_576897.json:
```json
{
    "body": "Changing branch from \"u/caruso/register_coercion\" to \"1b1467b8d6ddeb999247eb00cf830917d926ed6f\"",
    "created_at": "2020-04-18T08:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576897",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/caruso/register_coercion" to "1b1467b8d6ddeb999247eb00cf830917d926ed6f"



---

archive/issue_comments_576898.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-18T08:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29517#issuecomment-576898",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_075279.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-18T08:35:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29517",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29517#event-75279"
}
```
