# Issue 29600: number_of_partitions returns wrong results under the Windows Subsystem for Linux

archive/issues_029363.json:
```json
{
    "body": "Currently, installing Sage under WSL 2 (Ubuntu 18.04) produces 8 doctests failures in `sage.combinat.partitions.number_of_partitions` for example:\n\n```\nFile \"src/sage/combinat/partitions.pyx\", line 72, in sage.combinat.partitions.number_of_partitions\nFailed example:\n    number_of_partitions( n - (n % 385) + 369) % 385 == 0\nExpected:\n    True\nGot:\n    False\n...\nFile \"src/sage/combinat/partitions.pyx\", line 95, in sage.combinat.partitions.number_of_partitions\nFailed example:\n    len([n for n in [1..500] if number_of_partitions(n) != Partitions(n).cardinality(algorithm='pari')])\nExpected:\n    0\nGot:\n    21\n```\n\nIn more detail:\n\nFailures for 9.1.rc0 and 9.0 (installed from binaries):\n\n```\nsage: [(i, number_of_partitions(i, algorithm='bober') - number_of_partitions(i)) for i in range(17000) if number_of_partitions(i, algorithm='bober') != number_of_partitions(i)]\n[(241, 1),\n (243, 1),\n (244, 1),\n (245, 1),\n (246, 1),\n (248, 1),\n (250, 1),\n (252, 1),\n (253, 1),\n (256, 2),\n (258, 2),\n (259, 3),\n (262, 1),\n (263, 1),\n (264, 3),\n (266, 4),\n (267, 4),\n (268, 1),\n (269, 5),\n (270, -1),\n (271, -1),\n (9894, -1),\n (9908, -1),\n (16564, -1),\n (16573, -1),\n (16672, -1),\n (16771, -1),\n (16789, -1),\n (16798, -1),\n (16802, -1),\n (16816, -1),\n (16820, -1),\n (16825, -1),\n (16914, -1),\n (16942, -1),\n (16946, -1),\n (16951, -1),\n (16969, -1)]\n```\n\nFailures for 8.1 (installed using `apt`):\n\n```\nsage: [(i, number_of_partitions(i, algorithm='bober') - number_of_partitions(i)) for i in range(17000) if number_of_partitions(i, algorithm='bober') != number_of_partitions(i)]\n[(239, 1),\n (242, 1),\n (248, 2),\n (249, 1),\n (250, 1),\n (251, 2),\n (252, 1),\n (253, 1),\n (256, -1),\n (258, 2),\n (259, 3),\n (260, 3),\n (261, 4),\n (262, -3),\n (263, -4),\n (264, 4),\n (265, 6),\n (266, -2),\n (267, 4),\n (268, 1),\n (269, 5),\n (270, -1),\n (271, 7),\n (9894, -1),\n (9908, -1),\n (16564, -1),\n (16573, -1),\n (16672, -1),\n (16771, -1),\n (16789, -1),\n (16798, -1),\n (16802, -1),\n (16816, -1),\n (16820, -1),\n (16825, -1),\n (16914, -1),\n (16942, -1),\n (16946, -1),\n (16951, -1),\n (16969, -1)]\n```\n\n\nSee also discussions on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/zuPzRgpSw3s) and ticket #28549.\n\nCC:  tmonteil @tscrim @mezzarobba @jdemeyer @dimpase @fredrik-johansson bober\n\nKeywords: number of partitions WSL\n\nBranch/Commit: [2c37f3dea474986ac7206a95687b3aeb907e8e86](https://github.com/sagemath/sagetrac-mirror/commit/2c37f3dea474986ac7206a95687b3aeb907e8e86)\n\nReviewer: Matthias Koeppe\n\nAuthor: Thierry Monteil\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29600\n\n",
    "closed_at": "2020-08-23T17:51:08Z",
    "created_at": "2020-04-27T06:23:30Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "number_of_partitions returns wrong results under the Windows Subsystem for Linux",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29600",
    "user": "https://github.com/soehms"
}
```
Currently, installing Sage under WSL 2 (Ubuntu 18.04) produces 8 doctests failures in `sage.combinat.partitions.number_of_partitions` for example:

```
File "src/sage/combinat/partitions.pyx", line 72, in sage.combinat.partitions.number_of_partitions
Failed example:
    number_of_partitions( n - (n % 385) + 369) % 385 == 0
Expected:
    True
Got:
    False
...
File "src/sage/combinat/partitions.pyx", line 95, in sage.combinat.partitions.number_of_partitions
Failed example:
    len([n for n in [1..500] if number_of_partitions(n) != Partitions(n).cardinality(algorithm='pari')])
Expected:
    0
Got:
    21
```

In more detail:

Failures for 9.1.rc0 and 9.0 (installed from binaries):

```
sage: [(i, number_of_partitions(i, algorithm='bober') - number_of_partitions(i)) for i in range(17000) if number_of_partitions(i, algorithm='bober') != number_of_partitions(i)]
[(241, 1),
 (243, 1),
 (244, 1),
 (245, 1),
 (246, 1),
 (248, 1),
 (250, 1),
 (252, 1),
 (253, 1),
 (256, 2),
 (258, 2),
 (259, 3),
 (262, 1),
 (263, 1),
 (264, 3),
 (266, 4),
 (267, 4),
 (268, 1),
 (269, 5),
 (270, -1),
 (271, -1),
 (9894, -1),
 (9908, -1),
 (16564, -1),
 (16573, -1),
 (16672, -1),
 (16771, -1),
 (16789, -1),
 (16798, -1),
 (16802, -1),
 (16816, -1),
 (16820, -1),
 (16825, -1),
 (16914, -1),
 (16942, -1),
 (16946, -1),
 (16951, -1),
 (16969, -1)]
```

Failures for 8.1 (installed using `apt`):

```
sage: [(i, number_of_partitions(i, algorithm='bober') - number_of_partitions(i)) for i in range(17000) if number_of_partitions(i, algorithm='bober') != number_of_partitions(i)]
[(239, 1),
 (242, 1),
 (248, 2),
 (249, 1),
 (250, 1),
 (251, 2),
 (252, 1),
 (253, 1),
 (256, -1),
 (258, 2),
 (259, 3),
 (260, 3),
 (261, 4),
 (262, -3),
 (263, -4),
 (264, 4),
 (265, 6),
 (266, -2),
 (267, 4),
 (268, 1),
 (269, 5),
 (270, -1),
 (271, 7),
 (9894, -1),
 (9908, -1),
 (16564, -1),
 (16573, -1),
 (16672, -1),
 (16771, -1),
 (16789, -1),
 (16798, -1),
 (16802, -1),
 (16816, -1),
 (16820, -1),
 (16825, -1),
 (16914, -1),
 (16942, -1),
 (16946, -1),
 (16951, -1),
 (16969, -1)]
```


See also discussions on [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/zuPzRgpSw3s) and ticket #28549.

CC:  tmonteil @tscrim @mezzarobba @jdemeyer @dimpase @fredrik-johansson bober

Keywords: number of partitions WSL

Branch/Commit: [2c37f3dea474986ac7206a95687b3aeb907e8e86](https://github.com/sagemath/sagetrac-mirror/commit/2c37f3dea474986ac7206a95687b3aeb907e8e86)

Reviewer: Matthias Koeppe

Author: Thierry Monteil

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29600





---

archive/issue_comments_579822.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis might be related to: https://github.com/microsoft/WSL/issues/830 (long double floating point calculations give inexact results)",
    "created_at": "2020-04-27T19:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579822",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
This might be related to: https://github.com/microsoft/WSL/issues/830 (long double floating point calculations give inexact results)



---

archive/issue_comments_579823.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe `./src/sage/combinat/partitions_c.cc` piece of `C` code was added into Sage in 2007. I guess it was invented because there was no fast enough existing wheel for that: the doctest of `number_of_partitions` function says it is `*very* fast`. Now, there is `flint`, which is still maintained and much faster:\n\n```\nsage: from sage.misc.sage_timeit import sage_timeit\nsage: tf = lambda i : sage_timeit('_=number_of_partitions({})'.format(i), globals() , preparse=True, number=1, seconds=True)\nsage: tb = lambda i : sage_timeit('_=number_of_partitions({}, algorithm=\"bober\")'.format(i), globals() , preparse=True, number=1, seconds=True)\nsage: [(i,tb(10^i)/tf(10^i)) for i in range(9)]\n[(0, 1.076654167643153),\n (1, 51.60920756939386),\n (2, 51.13886939147276),\n (3, 122.66713137190546),\n (4, 471.61390056849905),\n (5, 2741.5143212699077),\n (6, 18715.222483310186),\n (7, 170662.0538251338),\n (8, 1930629.845842312)]\n```\n\nSo, let me propose a backtrack version of Sage's motto: \"To maintain the bike, forget your own old wheels, replace them with subsequently invented ones\".\n\nWhy not just remove that piece of code ?\n\nNote that arb and flint implementations are inspired by Bober Sage implementation, see https://arxiv.org/abs/1205.5991",
    "created_at": "2020-04-27T23:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579823",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:3'></a>
The `./src/sage/combinat/partitions_c.cc` piece of `C` code was added into Sage in 2007. I guess it was invented because there was no fast enough existing wheel for that: the doctest of `number_of_partitions` function says it is `*very* fast`. Now, there is `flint`, which is still maintained and much faster:

```
sage: from sage.misc.sage_timeit import sage_timeit
sage: tf = lambda i : sage_timeit('_=number_of_partitions({})'.format(i), globals() , preparse=True, number=1, seconds=True)
sage: tb = lambda i : sage_timeit('_=number_of_partitions({}, algorithm="bober")'.format(i), globals() , preparse=True, number=1, seconds=True)
sage: [(i,tb(10^i)/tf(10^i)) for i in range(9)]
[(0, 1.076654167643153),
 (1, 51.60920756939386),
 (2, 51.13886939147276),
 (3, 122.66713137190546),
 (4, 471.61390056849905),
 (5, 2741.5143212699077),
 (6, 18715.222483310186),
 (7, 170662.0538251338),
 (8, 1930629.845842312)]
```

So, let me propose a backtrack version of Sage's motto: "To maintain the bike, forget your own old wheels, replace them with subsequently invented ones".

Why not just remove that piece of code ?

Note that arb and flint implementations are inspired by Bober Sage implementation, see https://arxiv.org/abs/1205.5991



---

archive/issue_comments_579824.json:
```json
{
    "body": "<a id='comment:4'></a>\n+1",
    "created_at": "2020-04-27T23:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579824",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
+1



---

archive/issue_comments_579825.json:
```json
{
    "body": "<a id='comment:5'></a>\nIf everyone agree, I can do the removal (let me CC people involved in #24667).",
    "created_at": "2020-04-27T23:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579825",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:5'></a>
If everyone agree, I can do the removal (let me CC people involved in #24667).



---

archive/issue_comments_579826.json:
```json
{
    "body": "<a id='comment:6'></a>\n-1\n\nI think it is good to keep it for testing purposes. In this case, I am pretty sure it is exposing an underlying bug rather than an issue with this code itself as nearly all of the main computations are outsourced. There might be some issue with a rounding mode not being handled correctly (a la point 9 in #24667). I think this warrants further investigation rather than sweeping the issue under the rug (or maybe out the door is the better analogy, but you should check the house to make sure things are getting in some other way).",
    "created_at": "2020-04-27T23:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579826",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
-1

I think it is good to keep it for testing purposes. In this case, I am pretty sure it is exposing an underlying bug rather than an issue with this code itself as nearly all of the main computations are outsourced. There might be some issue with a rounding mode not being handled correctly (a la point 9 in #24667). I think this warrants further investigation rather than sweeping the issue under the rug (or maybe out the door is the better analogy, but you should check the house to make sure things are getting in some other way).



---

archive/issue_comments_579827.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe bug is clearly in the ad-hoc float precision code in that file! It has ifdefs for the behavior of `long double`.",
    "created_at": "2020-04-28T00:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579827",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
The bug is clearly in the ad-hoc float precision code in that file! It has ifdefs for the behavior of `long double`.



---

archive/issue_comments_579828.json:
```json
{
    "body": "<a id='comment:8'></a>\nIt doesn't appear to be ad-hoc but due to architecture differences and the code assuming a particular behavior. So if that is indeed the problem, this could be showing any code within Sage that is using `long double`. From this, I think it is related [to this WSL issue](https://github.com/microsoft/WSL/issues/830).\n\ncc-ing Fredrik to also get his thoughts on this.",
    "created_at": "2020-04-28T01:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579828",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
It doesn't appear to be ad-hoc but due to architecture differences and the code assuming a particular behavior. So if that is indeed the problem, this could be showing any code within Sage that is using `long double`. From this, I think it is related [to this WSL issue](https://github.com/microsoft/WSL/issues/830).

cc-ing Fredrik to also get his thoughts on this.



---

archive/issue_comments_579829.json:
```json
{
    "body": "<a id='comment:9'></a>\nI dont get the argument. I am not suggesting to remove a doctest, but the actual code, so that if there is a bug in that code, well, it will disapear as well. If the proposal is to keep a test for `flint` implementation (besides self-tests), we should perhaps compare with `arb` implementation instead, which is proven to be correct (or even Gap implementation, to be sure that it was written by unrelated developers), with explicit doctests. If the issue comes from a known WSL bug, i am not sure that this legacy code should be kept just to show another instance of it.",
    "created_at": "2020-04-28T01:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579829",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:9'></a>
I dont get the argument. I am not suggesting to remove a doctest, but the actual code, so that if there is a bug in that code, well, it will disapear as well. If the proposal is to keep a test for `flint` implementation (besides self-tests), we should perhaps compare with `arb` implementation instead, which is proven to be correct (or even Gap implementation, to be sure that it was written by unrelated developers), with explicit doctests. If the issue comes from a known WSL bug, i am not sure that this legacy code should be kept just to show another instance of it.



---

archive/issue_comments_579830.json:
```json
{
    "body": "<a id='comment:10'></a>\nI won't be surprised if the bug in question also shows up on non-x86(_64) hardware. e.g. on ARM (which lacks that 80-bit extended precision).",
    "created_at": "2020-04-28T02:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579830",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
I won't be surprised if the bug in question also shows up on non-x86(_64) hardware. e.g. on ARM (which lacks that 80-bit extended precision).



---

archive/issue_comments_579831.json:
```json
{
    "body": "<a id='comment:11'></a>\n+1 for removal of outdated code, which is better served by a maintained external library.",
    "created_at": "2020-04-28T02:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579831",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
+1 for removal of outdated code, which is better served by a maintained external library.



---

archive/issue_comments_579832.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [tscrim](#comment%3A8):\n>... this could be showing any code within Sage that is using `long double`.\n\n\nThat's a very short list of places.\n\n```\n./libs/mpfr/__init__.pxd:23:    int mpfr_set_ld(mpfr_t rop, long double op, mpfr_rnd_t rnd)\n./libs/mpfr/__init__.pxd:42:    int mpfr_init_set_ld(mpfr_t rop, long double op, mpfr_rnd_t rnd)\n./libs/mpfr/__init__.pxd:50:    long double mpfr_get_ld(mpfr_t op, mpfr_rnd_t rnd)\n./libs/mpfr/__init__.pxd:53:    long double mpfr_get_ld_2exp(long *exp, mpfr_t op, mpfr_rnd_t rnd)\n./libs/mpfr/__init__.pxd:120:    int mpfr_cmp_ld(mpfr_t op1, long double op2)\n./libs/mpc/__init__.pxd:27:    int  mpc_pow_ld(mpc_ptr, mpc_srcptr, long double, mpc_rnd_t)\n./libs/mpc/__init__.pxd:48:    int  mpc_set_ld(mpc_ptr, long double, mpc_rnd_t)\n./libs/mpc/__init__.pxd:49:    int  mpc_set_ld_ld(mpc_ptr, long double, long double, mpc_rnd_t)\n./libs/gsl/math.pxd:36:    long double GSL_MAX_LDBL(long double a, long double b)\n./libs/gsl/math.pxd:37:    long double GSL_MIN_LDBL(long double a, long double b)\n./matrix/matrix_integer_dense.pyx:142:                'ld': 'long double',\n./matrix/matrix_integer_dense.pyx:2810:            - ``'ld'`` -- long doubles (fpLLL only)\n./matrix/matrix_integer_dense.pyx:3039:          - ``'ld'`` -- long doubles (fpLLL only)\n```",
    "created_at": "2020-04-28T03:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579832",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
Replying to [tscrim](#comment%3A8):
>... this could be showing any code within Sage that is using `long double`.


That's a very short list of places.

```
./libs/mpfr/__init__.pxd:23:    int mpfr_set_ld(mpfr_t rop, long double op, mpfr_rnd_t rnd)
./libs/mpfr/__init__.pxd:42:    int mpfr_init_set_ld(mpfr_t rop, long double op, mpfr_rnd_t rnd)
./libs/mpfr/__init__.pxd:50:    long double mpfr_get_ld(mpfr_t op, mpfr_rnd_t rnd)
./libs/mpfr/__init__.pxd:53:    long double mpfr_get_ld_2exp(long *exp, mpfr_t op, mpfr_rnd_t rnd)
./libs/mpfr/__init__.pxd:120:    int mpfr_cmp_ld(mpfr_t op1, long double op2)
./libs/mpc/__init__.pxd:27:    int  mpc_pow_ld(mpc_ptr, mpc_srcptr, long double, mpc_rnd_t)
./libs/mpc/__init__.pxd:48:    int  mpc_set_ld(mpc_ptr, long double, mpc_rnd_t)
./libs/mpc/__init__.pxd:49:    int  mpc_set_ld_ld(mpc_ptr, long double, long double, mpc_rnd_t)
./libs/gsl/math.pxd:36:    long double GSL_MAX_LDBL(long double a, long double b)
./libs/gsl/math.pxd:37:    long double GSL_MIN_LDBL(long double a, long double b)
./matrix/matrix_integer_dense.pyx:142:                'ld': 'long double',
./matrix/matrix_integer_dense.pyx:2810:            - ``'ld'`` -- long doubles (fpLLL only)
./matrix/matrix_integer_dense.pyx:3039:          - ``'ld'`` -- long doubles (fpLLL only)
```



---

archive/issue_comments_579833.json:
```json
{
    "body": "<a id='comment:13'></a>\nI propose removing the 'bober' implementation and supporting algorithm='pari' instead.\n\nPari's numbpart() was improved in the recent past and it's now twice as fast as Bober's code on my computer.",
    "created_at": "2020-04-28T08:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579833",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:13'></a>
I propose removing the 'bober' implementation and supporting algorithm='pari' instead.

Pari's numbpart() was improved in the recent past and it's now twice as fast as Bober's code on my computer.



---

archive/issue_comments_579834.json:
```json
{
    "body": "<a id='comment:14'></a>\nI don't think it is fair to call it outdated code. Since Pari's implementation is at least as fast as this (so we can use that to test against each other) and everyone seems intent on just sweeping the problem away, then go ahead and remove it.",
    "created_at": "2020-04-28T12:03:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579834",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
I don't think it is fair to call it outdated code. Since Pari's implementation is at least as fast as this (so we can use that to test against each other) and everyone seems intent on just sweeping the problem away, then go ahead and remove it.



---

archive/issue_comments_579835.json:
```json
{
    "body": "<a id='comment:15'></a>\n*Removing* sounds hard in my ears, as well. Wouldn't it be enough to print a warning on the first invocation of a functionality that uses `long double`? That could be done once per session which is running under WSL or some other platforms having similar problems.\n\nIndeed, there are not many of them:\n\n1. function `number_of_partitions` with option `algorithm='bober'`\n2. method `BKZ` of dense integer matrices with option `fp='ld'`\n3. method `LLL` of dense integer matrices with option `fp='ld'`\n\nSuch a warning should refer to the WSL issue 830 and make clear that wrong results are possible.",
    "created_at": "2020-04-28T20:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579835",
    "user": "https://github.com/soehms"
}
```

<a id='comment:15'></a>
*Removing* sounds hard in my ears, as well. Wouldn't it be enough to print a warning on the first invocation of a functionality that uses `long double`? That could be done once per session which is running under WSL or some other platforms having similar problems.

Indeed, there are not many of them:

1. function `number_of_partitions` with option `algorithm='bober'`
2. method `BKZ` of dense integer matrices with option `fp='ld'`
3. method `LLL` of dense integer matrices with option `fp='ld'`

Such a warning should refer to the WSL issue 830 and make clear that wrong results are possible.



---

archive/issue_comments_579836.json:
```json
{
    "body": "<a id='comment:16'></a>\nI don't see the point of maintaining obsolete code in Sage when there are multiple superior implementations in its standard libraries. It's one thing to have a 20-line reference implementation written in Sage, but in this case it's 2000 lines of C++ code that will be a future maintenance burden if it's a maintenance burden right now.\n\nDon't get me wrong, this code was a terrific addition to Sage when Jon wrote it (lots of credit to him), but it has already more than served its purpose by inspiring even better implementations :-)\n\nOf course, if Jon himself thinks the code should stay, I wouldn't argue with him.",
    "created_at": "2020-04-29T12:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579836",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:16'></a>
I don't see the point of maintaining obsolete code in Sage when there are multiple superior implementations in its standard libraries. It's one thing to have a 20-line reference implementation written in Sage, but in this case it's 2000 lines of C++ code that will be a future maintenance burden if it's a maintenance burden right now.

Don't get me wrong, this code was a terrific addition to Sage when Jon wrote it (lots of credit to him), but it has already more than served its purpose by inspiring even better implementations :-)

Of course, if Jon himself thinks the code should stay, I wouldn't argue with him.



---

archive/issue_comments_579837.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [fredrik.johansson](#comment%3A16):\n> I don't see the point of maintaining obsolete code in Sage when there are multiple superior implementations in its standard libraries.\n\n\nIn principal I agree! But that's a more general question which applies to many other cases, as well. I think, it's not necessary to decide this in the context of this ticket. At the moment, we are not maintaining the code. We are maintaining a WSL issue.\n\nWhat I want to say is: Shall we kill the messenger of the bad news, or shall we do something against the bad news?\n\nAnyway, I would agree if everyone would like to take the occasion to get rid of that code.",
    "created_at": "2020-04-29T14:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579837",
    "user": "https://github.com/soehms"
}
```

<a id='comment:17'></a>
Replying to [fredrik.johansson](#comment%3A16):
> I don't see the point of maintaining obsolete code in Sage when there are multiple superior implementations in its standard libraries.


In principal I agree! But that's a more general question which applies to many other cases, as well. I think, it's not necessary to decide this in the context of this ticket. At the moment, we are not maintaining the code. We are maintaining a WSL issue.

What I want to say is: Shall we kill the messenger of the bad news, or shall we do something against the bad news?

Anyway, I would agree if everyone would like to take the occasion to get rid of that code.



---

archive/issue_comments_579838.json:
```json
{
    "body": "<a id='comment:18'></a>\nNobody has worked on fixing this code, so let's please remove it for 9.2. Any takers?",
    "created_at": "2020-08-18T15:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579838",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Nobody has worked on fixing this code, so let's please remove it for 9.2. Any takers?



---

archive/issue_comments_579839.json:
```json
{
    "body": "<a id='comment:19'></a>\nI can take that one.",
    "created_at": "2020-08-18T16:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579839",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:19'></a>
I can take that one.



---

archive/issue_comments_579840.json:
```json
{
    "body": "<a id='comment:20'></a>\nI'm a bit late to this conversation.\n\nIn principle I agree that there is not much reason to leave this code in Sage given that it is so flaky and there is just about no good reason to use it.\n\nOn the other hand, if you actually want to trust WSL, it may still be worth trying to figure out what the actual problem is. The WSL ticket you point to seems to claim that floating point issues were fixed in WSL2, which is what you specifically mention as failing the tests. If they haven't been completely fixed then I would expect issues elsewhere.\n\nIf you get rid of the 4 lines starting at line 922, (long double ld_partial_sum = ...) and change level_two_precision to level_five_precision on line 873 (for (k = 1; current_precision > level_two_precision; k++)), I think you'll get a version that should work and doesn't use long doubles. (Maybe you get the same effect by setting level_two_precision = level_five_precision or long_double_precision = double_precision towards the top of the file, which is what appears to be done on some systems.)\n\nI don't think I ever put in any of those ifdefs, and the ternary operator that checks if LDBL_MANT_DIG == 106 looks quite strange. (Also, the whole thing reads rather strangely if you don't know that once upon a time it used quad doubles and double doubles.)",
    "created_at": "2020-08-19T07:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579840",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:20'></a>
I'm a bit late to this conversation.

In principle I agree that there is not much reason to leave this code in Sage given that it is so flaky and there is just about no good reason to use it.

On the other hand, if you actually want to trust WSL, it may still be worth trying to figure out what the actual problem is. The WSL ticket you point to seems to claim that floating point issues were fixed in WSL2, which is what you specifically mention as failing the tests. If they haven't been completely fixed then I would expect issues elsewhere.

If you get rid of the 4 lines starting at line 922, (long double ld_partial_sum = ...) and change level_two_precision to level_five_precision on line 873 (for (k = 1; current_precision > level_two_precision; k++)), I think you'll get a version that should work and doesn't use long doubles. (Maybe you get the same effect by setting level_two_precision = level_five_precision or long_double_precision = double_precision towards the top of the file, which is what appears to be done on some systems.)

I don't think I ever put in any of those ifdefs, and the ternary operator that checks if LDBL_MANT_DIG == 106 looks quite strange. (Also, the whole thing reads rather strangely if you don't know that once upon a time it used quad doubles and double doubles.)



---

archive/issue_comments_579841.json:
```json
{
    "body": "Changing branch from \"\" to \"u/tmonteil/number_of_partitions_returns_wrong_results_under_the_windows_subsystem_for_linux\"",
    "created_at": "2020-08-19T17:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579841",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing branch from "" to "u/tmonteil/number_of_partitions_returns_wrong_results_under_the_windows_subsystem_for_linux"



---

archive/issue_comments_579842.json:
```json
{
    "body": "Changing commit from \"\" to \"2c37f3dea474986ac7206a95687b3aeb907e8e86\"",
    "created_at": "2020-08-19T18:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579842",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing commit from "" to "2c37f3dea474986ac7206a95687b3aeb907e8e86"



---

archive/issue_comments_579843.json:
```json
{
    "body": "<a id='comment:22'></a>\nI uploaded a branch that removes the code and redirects its uses to the faster `flint` implementation. To be complete, i am thinking of an additional refactor commit on top of that branch that merges the code of `sage.combinat.partition.Partition_n.cardinality` and `sage.combinat.partition.number_of_partitions` which are kind of duplicated (with some algorithms missing in the later), and adds some cross-algorithm testing (note that we have `flint`, `pari` and `gap` implementations).\n\nNow, regarding whether we should merge that branch into Sage, i still do not understand how maintaining that code could benefit to the rest of Sage, even with respect to WSL2, and i do not understand how that piece of code could improve our trust of WSL2 with respect to the rest of Sage code. If the only point is to understand some floating-point subtleties of WSL2, then i am pretty sure that maintaining this code within Sage is not the right way (people who want to understand can think out of Sage source tree). If someone sees how this codes illustrates some WSL2 bug, it might be better to report upstream.\n\nThe ticket could be re-purposed to \"Refactor the computation of the number of partitions\".\n\n---\nNew commits:\n|                                                                                                                                          |                                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|\n|[f566a3e](https://github.com/sagemath/sagetrac-mirror/commit/f566a3e4109cc25b3bb68725518573f24ec24acd)|`#29600 : remove partitions_c.cc C code`|\n|[2c37f3d](https://github.com/sagemath/sagetrac-mirror/commit/2c37f3dea474986ac7206a95687b3aeb907e8e86)|`#29600 : remove sage.combinat.partitions.number_of_partitions and redirect calls to it`|",
    "created_at": "2020-08-19T18:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579843",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:22'></a>
I uploaded a branch that removes the code and redirects its uses to the faster `flint` implementation. To be complete, i am thinking of an additional refactor commit on top of that branch that merges the code of `sage.combinat.partition.Partition_n.cardinality` and `sage.combinat.partition.number_of_partitions` which are kind of duplicated (with some algorithms missing in the later), and adds some cross-algorithm testing (note that we have `flint`, `pari` and `gap` implementations).

Now, regarding whether we should merge that branch into Sage, i still do not understand how maintaining that code could benefit to the rest of Sage, even with respect to WSL2, and i do not understand how that piece of code could improve our trust of WSL2 with respect to the rest of Sage code. If the only point is to understand some floating-point subtleties of WSL2, then i am pretty sure that maintaining this code within Sage is not the right way (people who want to understand can think out of Sage source tree). If someone sees how this codes illustrates some WSL2 bug, it might be better to report upstream.

The ticket could be re-purposed to "Refactor the computation of the number of partitions".

---
New commits:
|                                                                                                                                          |                                        |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
|[f566a3e](https://github.com/sagemath/sagetrac-mirror/commit/f566a3e4109cc25b3bb68725518573f24ec24acd)|`#29600 : remove partitions_c.cc C code`|
|[2c37f3d](https://github.com/sagemath/sagetrac-mirror/commit/2c37f3dea474986ac7206a95687b3aeb907e8e86)|`#29600 : remove sage.combinat.partitions.number_of_partitions and redirect calls to it`|



---

archive/issue_comments_579844.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-08-19T18:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579844",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_579845.json:
```json
{
    "body": "Changing author from \"\" to \"Thierry Monteil\"",
    "created_at": "2020-08-19T18:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579845",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing author from "" to "Thierry Monteil"



---

archive/issue_comments_579846.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [tmonteil](#comment%3A22):\n> I uploaded a branch that removes the code and redirects its uses to the faster `flint` implementation. \n\n\nLooks good to me.\n\n> To be complete, i am thinking of an additional refactor commit on top of that branch that merges the code of `sage.combinat.partition.Partition_n.cardinality` and `sage.combinat.partition.number_of_partitions` which are kind of duplicated (with some algorithms missing in the later), and adds some cross-algorithm testing (note that we have `flint`, `pari` and `gap` implementations).\n\n\nI would suggest to use a follow-up ticket for this.\n\n> Now, regarding whether we should merge that branch into Sage, i still do not understand how maintaining that code could benefit to the rest of Sage [...]\n\n\nI would think it's definitely out of the scope of the Sage project to investigate hypothetical errors of other upstream libraries on WSL2 because of ABI problems.",
    "created_at": "2020-08-19T18:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579846",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Replying to [tmonteil](#comment%3A22):
> I uploaded a branch that removes the code and redirects its uses to the faster `flint` implementation. 


Looks good to me.

> To be complete, i am thinking of an additional refactor commit on top of that branch that merges the code of `sage.combinat.partition.Partition_n.cardinality` and `sage.combinat.partition.number_of_partitions` which are kind of duplicated (with some algorithms missing in the later), and adds some cross-algorithm testing (note that we have `flint`, `pari` and `gap` implementations).


I would suggest to use a follow-up ticket for this.

> Now, regarding whether we should merge that branch into Sage, i still do not understand how maintaining that code could benefit to the rest of Sage [...]


I would think it's definitely out of the scope of the Sage project to investigate hypothetical errors of other upstream libraries on WSL2 because of ABI problems.



---

archive/issue_comments_579847.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-08-19T18:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579847",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_579848.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-08-19T18:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579848",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_579849.json:
```json
{
    "body": "<a id='comment:25'></a>\nIf the patchbot light shows green, you can set this to positive review on my behalf",
    "created_at": "2020-08-19T18:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579849",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
If the patchbot light shows green, you can set this to positive review on my behalf



---

archive/issue_comments_579850.json:
```json
{
    "body": "<a id='comment:26'></a>\nThe patchbot doctest failure seems unrelated.",
    "created_at": "2020-08-19T23:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579850",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>
The patchbot doctest failure seems unrelated.



---

archive/issue_comments_579851.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-19T23:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579851",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_579852.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-23T17:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579852",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085293.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-23T17:51:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29600#event-85293"
}
```



---

archive/issue_comments_579853.json:
```json
{
    "body": "Changing branch from \"u/tmonteil/number_of_partitions_returns_wrong_results_under_the_windows_subsystem_for_linux\" to \"2c37f3dea474986ac7206a95687b3aeb907e8e86\"",
    "created_at": "2020-08-23T17:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29600#issuecomment-579853",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/tmonteil/number_of_partitions_returns_wrong_results_under_the_windows_subsystem_for_linux" to "2c37f3dea474986ac7206a95687b3aeb907e8e86"
