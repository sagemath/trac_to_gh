# Issue 29780: Still memory leaks with matrix operations over GF(2)

archive/issues_029543.json:
```json
{
    "body": "CC:  @pfasante @sn-d @nbruin tmonteil @fchapoton\n\nKeywords: memory leaks\n\nAccording to the ticket #26349, the bug should have been fixed in Release 9.1, but the provided code \n\n```\nn = 8\nX = zero_vector(GF(2), n)\nM = zero_matrix(GF(2), n, n)\n\nfor _ in range(10000000):\n    Y = M * X\n```\nstill leaks memory (using Ubuntu 18.04.4 LTS). There is no error message when trying to execute, but the memory consumption increases until the process crashes.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29780\n\n",
    "closed_at": "2020-06-21T22:37:29Z",
    "created_at": "2020-06-02T09:21:21Z",
    "labels": [
        "component: linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Still memory leaks with matrix operations over GF(2)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29780",
    "user": "https://github.com/cbe90"
}
```
CC:  @pfasante @sn-d @nbruin tmonteil @fchapoton

Keywords: memory leaks

According to the ticket #26349, the bug should have been fixed in Release 9.1, but the provided code 

```
n = 8
X = zero_vector(GF(2), n)
M = zero_matrix(GF(2), n, n)

for _ in range(10000000):
    Y = M * X
```
still leaks memory (using Ubuntu 18.04.4 LTS). There is no error message when trying to execute, but the memory consumption increases until the process crashes.

Issue created by migration from https://trac.sagemath.org/ticket/29780





---

archive/issue_comments_419132.json:
```json
{
    "body": "I can confirm that the leak is there. I remember checking when reviewing #26349 and did not see the leak.",
    "created_at": "2020-06-04T00:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419132",
    "user": "https://github.com/tscrim"
}
```

I can confirm that the leak is there. I remember checking when reviewing #26349 and did not see the leak.



---

archive/issue_comments_419133.json:
```json
{
    "body": "It is something specific to a matrix times a vector. I don't see the leak if I do `Y = M * M`.",
    "created_at": "2020-06-04T00:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419133",
    "user": "https://github.com/tscrim"
}
```

It is something specific to a matrix times a vector. I don't see the leak if I do `Y = M * M`.



---

archive/issue_comments_419134.json:
```json
{
    "body": "Okay, here is the problem:\n\n```sage\n        c._init(self._nrows, VS)\n        c._entries = mzd_init(1, self._nrows)\n```\nThe `c._init` already allocates `c._entries`. So this does a double allocation, and so the old allocation from `c._init` is the leak.",
    "created_at": "2020-06-04T00:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419134",
    "user": "https://github.com/tscrim"
}
```

Okay, here is the problem:

```sage
        c._init(self._nrows, VS)
        c._entries = mzd_init(1, self._nrows)
```
The `c._init` already allocates `c._entries`. So this does a double allocation, and so the old allocation from `c._init` is the leak.



---

archive/issue_comments_419135.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-04T00:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419135",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_419136.json:
```json
{
    "body": "Here is the fix (plus one local micro-optimization).\n\n---\nNew commits:",
    "created_at": "2020-06-04T00:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419136",
    "user": "https://github.com/tscrim"
}
```

Here is the fix (plus one local micro-optimization).

---
New commits:



---

archive/issue_comments_419137.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-06-04T00:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419137",
    "user": "https://github.com/tscrim"
}
```

Changing priority from major to critical.



---

archive/issue_comments_419138.json:
```json
{
    "body": "Green patchbot.",
    "created_at": "2020-06-10T22:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419138",
    "user": "https://github.com/tscrim"
}
```

Green patchbot.



---

archive/issue_comments_419139.json:
```json
{
    "body": "ok, but I am no expert.",
    "created_at": "2020-06-11T06:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419139",
    "user": "https://github.com/fchapoton"
}
```

ok, but I am no expert.



---

archive/issue_comments_419140.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-11T06:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419140",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_419141.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-06-11T13:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419141",
    "user": "https://github.com/tscrim"
}
```

Thank you.



---

archive/issue_comments_419142.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-21T22:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29780#issuecomment-419142",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_076235.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-21T22:37:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29780",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29780#event-76235"
}
```
