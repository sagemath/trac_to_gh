# Issue 29977: Make modular doctests ready for random seeds

archive/issues_029740.json:
```json
{
    "body": "This ticket makes\n\n```\nsage -t --long --random-seed=n src/sage/modular/\n```\npass for different values `n` than just `0`.\n\n**CC:**  @dimpase\n\n**Branch/Commit:** [a890c4d0b800bc014f2ccdcca7a87a71b280a6b8](https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8)\n\n**Reviewer:** Dima Pasechnik\n\n**Author:** Jonathan Kliem\n\n**Dependencies:** #32124\n\nIssue created by migration from https://trac.sagemath.org/ticket/29977\n\n",
    "closed_at": "2021-07-24T15:28:50Z",
    "created_at": "2020-06-24T21:31:56Z",
    "labels": [
        "component: doctest framework",
        "blocker",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "title": "Make modular doctests ready for random seeds",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/29977",
    "user": "https://github.com/kliem"
}
```
This ticket makes

```
sage -t --long --random-seed=n src/sage/modular/
```
pass for different values `n` than just `0`.

**CC:**  @dimpase

**Branch/Commit:** [a890c4d0b800bc014f2ccdcca7a87a71b280a6b8](https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8)

**Reviewer:** Dima Pasechnik

**Author:** Jonathan Kliem

**Dependencies:** #32124

Issue created by migration from https://trac.sagemath.org/ticket/29977





---

archive/issue_comments_477094.json:
```json
{
    "body": "<a id='comment:1'></a>\nI have a partial fix. After that at least the following need fixing\n\n```\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/arithgroup/arithgroup_perm.py  # 5 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/arithgroup/congroup_sl2z.py  # 3 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/dirichlet.py  # 2 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/hecke/algebra.py  # 1 doctest failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/modform/numerical.py  # 2 doctests failed\nsage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/overconvergent/hecke_series.py  # 1 doctest failed\n```",
    "created_at": "2020-06-24T21:32:43Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477094",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>
I have a partial fix. After that at least the following need fixing

```
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/arithgroup/arithgroup_perm.py  # 5 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/arithgroup/congroup_sl2z.py  # 3 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/dirichlet.py  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/hecke/algebra.py  # 1 doctest failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/modform/numerical.py  # 2 doctests failed
sage -t --long --random-seed=151058820726654196682836430928254760259 src/sage/modular/overconvergent/hecke_series.py  # 1 doctest failed
```



---

archive/issue_comments_477095.json:
```json
{
    "body": "**Dependencies:** #29962",
    "created_at": "2020-06-24T21:38:27Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477095",
    "user": "https://github.com/kliem"
}
```

**Dependencies:** #29962



---

archive/issue_comments_477096.json:
```json
{
    "body": "**Commit:** [48456b40531ada29e426a385a3666b847ce7c7aa](https://github.com/sagemath/sagetrac-mirror/commit/48456b40531ada29e426a385a3666b847ce7c7aa)",
    "created_at": "2020-06-24T21:42:15Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477096",
    "user": "https://github.com/kliem"
}
```

**Commit:** [48456b40531ada29e426a385a3666b847ce7c7aa](https://github.com/sagemath/sagetrac-mirror/commit/48456b40531ada29e426a385a3666b847ce7c7aa)



---

archive/issue_comments_477097.json:
```json
{
    "body": "**Branch:** [public/29977](https://github.com/sagemath/sagetrac-mirror/tree/public/29977)",
    "created_at": "2020-06-24T21:42:15Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477097",
    "user": "https://github.com/kliem"
}
```

**Branch:** [public/29977](https://github.com/sagemath/sagetrac-mirror/tree/public/29977)



---

archive/issue_comments_477098.json:
```json
{
    "body": "<a id='comment:3'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da1c6beec7d0bb6b972d88ecf9fb4eccbdf285a5\">da1c6be</a></td><td><code>start from a \"random\" random seed for doctesting</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7b836d789e034433d62f331f33fbc1821c0deaa\">b7b836d</a></td><td><code>make random seed reproducible</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eedbe5ebea9c2b9da79404013c566fe17d0a3e20\">eedbe5e</a></td><td><code>document random_seed</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/998b1b94ce1289ea92451a86e5f6191c37eaeb5a\">998b1b9</a></td><td><code>default random seed 0 for now</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d7b00e3fc2ebc1dc9982a2df91d15e3f12e9432\">1d7b00e</a></td><td><code>dash instead of underscore for command line options</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/48456b40531ada29e426a385a3666b847ce7c7aa\">48456b4</a></td><td><code>partially make modular fuzz ready</code></td></tr></table>\n",
    "created_at": "2020-06-24T21:42:15Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477098",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da1c6beec7d0bb6b972d88ecf9fb4eccbdf285a5">da1c6be</a></td><td><code>start from a "random" random seed for doctesting</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7b836d789e034433d62f331f33fbc1821c0deaa">b7b836d</a></td><td><code>make random seed reproducible</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eedbe5ebea9c2b9da79404013c566fe17d0a3e20">eedbe5e</a></td><td><code>document random_seed</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/998b1b94ce1289ea92451a86e5f6191c37eaeb5a">998b1b9</a></td><td><code>default random seed 0 for now</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d7b00e3fc2ebc1dc9982a2df91d15e3f12e9432">1d7b00e</a></td><td><code>dash instead of underscore for command line options</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/48456b40531ada29e426a385a3666b847ce7c7aa">48456b4</a></td><td><code>partially make modular fuzz ready</code></td></tr></table>




---

archive/issue_events_267631.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267631"
}
```



---

archive/issue_events_267632.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267632"
}
```



---

archive/issue_events_267633.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267633"
}
```



---

archive/issue_events_267634.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267634"
}
```



---

archive/issue_comments_477099.json:
```json
{
    "body": "<a id='comment:5'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477099",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_477100.json:
```json
{
    "body": "**Changing commit** from \"[48456b40531ada29e426a385a3666b847ce7c7aa](https://github.com/sagemath/sagetrac-mirror/commit/48456b40531ada29e426a385a3666b847ce7c7aa)\" to \"[20365ae3158ebc77e2c8ea70b1e08316af7b2f5d](https://github.com/sagemath/sagetrac-mirror/commit/20365ae3158ebc77e2c8ea70b1e08316af7b2f5d)\".",
    "created_at": "2021-06-30T10:28:52Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477100",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[48456b40531ada29e426a385a3666b847ce7c7aa](https://github.com/sagemath/sagetrac-mirror/commit/48456b40531ada29e426a385a3666b847ce7c7aa)" to "[20365ae3158ebc77e2c8ea70b1e08316af7b2f5d](https://github.com/sagemath/sagetrac-mirror/commit/20365ae3158ebc77e2c8ea70b1e08316af7b2f5d)".



---

archive/issue_comments_477101.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/20365ae3158ebc77e2c8ea70b1e08316af7b2f5d\">20365ae</a></td><td><code>make modular ready for fuzzed doctests</code></td></tr></table>\n",
    "created_at": "2021-06-30T10:28:52Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/20365ae3158ebc77e2c8ea70b1e08316af7b2f5d">20365ae</a></td><td><code>make modular ready for fuzzed doctests</code></td></tr></table>




---

archive/issue_events_267635.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-06-30T10:29:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267635"
}
```



---

archive/issue_comments_477102.json:
```json
{
    "body": "**Author:** Jonathan Kliem",
    "created_at": "2021-06-30T10:29:06Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477102",
    "user": "https://github.com/kliem"
}
```

**Author:** Jonathan Kliem



---

archive/issue_comments_477103.json:
```json
{
    "body": "**Changing dependencies** from \"#29962\" to \"\".",
    "created_at": "2021-06-30T12:00:27Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477103",
    "user": "https://github.com/kliem"
}
```

**Changing dependencies** from "#29962" to "".



---

archive/issue_comments_477104.json:
```json
{
    "body": "<a id='comment:9'></a>\nContinuing the discussion from ticket:30801#comment:202\nand following comments here.\n\nOne way to get compiler independent output\nwould be to sort according to string representation.",
    "created_at": "2021-07-02T06:15:04Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477104",
    "user": "https://github.com/slel"
}
```

<a id='comment:9'></a>
Continuing the discussion from ticket:30801#comment:202
and following comments here.

One way to get compiler independent output
would be to sort according to string representation.



---

archive/issue_comments_477105.json:
```json
{
    "body": "<a id='comment:10'></a>\nThat is actually a super easy fix.",
    "created_at": "2021-07-02T06:17:12Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477105",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>
That is actually a super easy fix.



---

archive/issue_comments_477106.json:
```json
{
    "body": "**Changing commit** from \"[20365ae3158ebc77e2c8ea70b1e08316af7b2f5d](https://github.com/sagemath/sagetrac-mirror/commit/20365ae3158ebc77e2c8ea70b1e08316af7b2f5d)\" to \"[54b325ed10094a7cc676b39973830e5cbf4b1b97](https://github.com/sagemath/sagetrac-mirror/commit/54b325ed10094a7cc676b39973830e5cbf4b1b97)\".",
    "created_at": "2021-07-02T07:31:47Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477106",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[20365ae3158ebc77e2c8ea70b1e08316af7b2f5d](https://github.com/sagemath/sagetrac-mirror/commit/20365ae3158ebc77e2c8ea70b1e08316af7b2f5d)" to "[54b325ed10094a7cc676b39973830e5cbf4b1b97](https://github.com/sagemath/sagetrac-mirror/commit/54b325ed10094a7cc676b39973830e5cbf4b1b97)".



---

archive/issue_comments_477107.json:
```json
{
    "body": "<a id='comment:11'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54b325ed10094a7cc676b39973830e5cbf4b1b97\">54b325e</a></td><td><code>sort groups of smooth characters by string for stable doctesting</code></td></tr></table>\n",
    "created_at": "2021-07-02T07:31:47Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477107",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54b325ed10094a7cc676b39973830e5cbf4b1b97">54b325e</a></td><td><code>sort groups of smooth characters by string for stable doctesting</code></td></tr></table>




---

archive/issue_comments_477108.json:
```json
{
    "body": "<a id='comment:12'></a>\nI came here from patchbots failure in `src/sage/modular/local_comp/local_comp.py` where the issue probably comes from the use of sets, so prehaps sorting the list is not needed, and it makes the examples less understandable. Did you try to just replace `set(Pi.characters())` with `Pi.characters()` instead of `sorted(Pi.characters(), key=str)` ?",
    "created_at": "2021-07-03T22:19:59Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477108",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:12'></a>
I came here from patchbots failure in `src/sage/modular/local_comp/local_comp.py` where the issue probably comes from the use of sets, so prehaps sorting the list is not needed, and it makes the examples less understandable. Did you try to just replace `set(Pi.characters())` with `Pi.characters()` instead of `sorted(Pi.characters(), key=str)` ?



---

archive/issue_comments_477109.json:
```json
{
    "body": "<a id='comment:13'></a>\nI don't know if it is stable. Dima decided to use sets for those, so I figured the order can be random.",
    "created_at": "2021-07-03T22:21:52Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477109",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>
I don't know if it is stable. Dima decided to use sets for those, so I figured the order can be random.



---

archive/issue_comments_477110.json:
```json
{
    "body": "<a id='comment:14'></a>\n@dimpase: Is there a reason you put the set around `Pi.characters`? Is the order unstable?",
    "created_at": "2021-07-03T22:26:45Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477110",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>
@dimpase: Is there a reason you put the set around `Pi.characters`? Is the order unstable?



---

archive/issue_comments_477111.json:
```json
{
    "body": "<a id='comment:15'></a>\nI made these changes to fix failing doctests. And it seemed to work. I have no idea why it didn't work in the end",
    "created_at": "2021-07-03T22:30:32Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477111",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>
I made these changes to fix failing doctests. And it seemed to work. I have no idea why it didn't work in the end



---

archive/issue_comments_477112.json:
```json
{
    "body": "<a id='comment:16'></a>\nI bet that the ordering changed with Pari upgrade, but it might be stable for a given Pari release.",
    "created_at": "2021-07-03T22:30:42Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477112",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:16'></a>
I bet that the ordering changed with Pari upgrade, but it might be stable for a given Pari release.



---

archive/issue_comments_477113.json:
```json
{
    "body": "<a id='comment:17'></a>\nIt's a problem of our api, I believe. `sorted(list(Pi.characters()))` doesn't do anything. This is how the doctests output sets and if sorting doesn't change the order, then it won't work.",
    "created_at": "2021-07-03T22:32:26Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477113",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>
It's a problem of our api, I believe. `sorted(list(Pi.characters()))` doesn't do anything. This is how the doctests output sets and if sorting doesn't change the order, then it won't work.



---

archive/issue_comments_477114.json:
```json
{
    "body": "<a id='comment:18'></a>\nafter pari 2.13 got positively reviewed, but not yet merged, a long coming #26635 got merged, and spoilt tests. So I tried to fix them.",
    "created_at": "2021-07-03T22:37:42Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477114",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>
after pari 2.13 got positively reviewed, but not yet merged, a long coming #26635 got merged, and spoilt tests. So I tried to fix them.



---

archive/issue_comments_477115.json:
```json
{
    "body": "<a id='comment:19'></a>\nI don't blame you. I'm just trying to explain why doctesting sets works usually fine, but not in this case. I also added you, to figure out, whether we need sorting at all. But apparently yes and apparently sorting by strings is an easy solution for now.",
    "created_at": "2021-07-03T22:40:00Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477115",
    "user": "https://github.com/kliem"
}
```

<a id='comment:19'></a>
I don't blame you. I'm just trying to explain why doctesting sets works usually fine, but not in this case. I also added you, to figure out, whether we need sorting at all. But apparently yes and apparently sorting by strings is an easy solution for now.



---

archive/issue_comments_477116.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [gh-kliem](#comment%3A19):\n> I don't blame you. I'm just trying to explain why doctesting sets works usually fine, but not in this case. I also added you, to figure out, whether we need sorting at all. But apparently yes and apparently sorting by strings is an easy solution for now.\n\n\nDo you have some evidence that we have to sort the lists ? The problem with sorting is that examples are not easy to understand for users (usually not involved in doctesting).",
    "created_at": "2021-07-03T22:49:26Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477116",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:20'></a>
Replying to [gh-kliem](#comment%3A19):
> I don't blame you. I'm just trying to explain why doctesting sets works usually fine, but not in this case. I also added you, to figure out, whether we need sorting at all. But apparently yes and apparently sorting by strings is an easy solution for now.


Do you have some evidence that we have to sort the lists ? The problem with sorting is that examples are not easy to understand for users (usually not involved in doctesting).



---

archive/issue_comments_477117.json:
```json
{
    "body": "<a id='comment:21'></a>\nOther than ticket:30801#comment:206 I don't have any evidence.\n\n`Pi.characters()` is stable on my machines. But `set(Pi.characters())` isn't. I'm asking you, whether there is a reason to use `set` instead of just leaving it. I'm assuming there is, because Dima changed it.\n\nIf `Pi.characters()` doesn't work, we need to either find a workaround (like sort by strings) or fix sorting.",
    "created_at": "2021-07-03T22:56:14Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477117",
    "user": "https://github.com/kliem"
}
```

<a id='comment:21'></a>
Other than ticket:30801#comment:206 I don't have any evidence.

`Pi.characters()` is stable on my machines. But `set(Pi.characters())` isn't. I'm asking you, whether there is a reason to use `set` instead of just leaving it. I'm assuming there is, because Dima changed it.

If `Pi.characters()` doesn't work, we need to either find a workaround (like sort by strings) or fix sorting.



---

archive/issue_comments_477118.json:
```json
{
    "body": "<a id='comment:22'></a>\non my machines, ironically, set() was stable.",
    "created_at": "2021-07-04T10:39:28Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477118",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
on my machines, ironically, set() was stable.



---

archive/issue_comments_477119.json:
```json
{
    "body": "<a id='comment:23'></a>\nYes, it is stable within the machine, because apparently the hash is stable (the order of the hash to be precise). That is the pretty print order of a set, if `sorted` does not do anything.\n\nOn my patchbot it is stable, but the other way around. So the patchbot is down until this is fixed (the problem was the whole issue with `setuptools_scm` which lead to the patchbot being down in the first place and now all tests need to pass).",
    "created_at": "2021-07-04T10:50:45Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477119",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'></a>
Yes, it is stable within the machine, because apparently the hash is stable (the order of the hash to be precise). That is the pretty print order of a set, if `sorted` does not do anything.

On my patchbot it is stable, but the other way around. So the patchbot is down until this is fixed (the problem was the whole issue with `setuptools_scm` which lead to the patchbot being down in the first place and now all tests need to pass).



---

archive/issue_comments_477120.json:
```json
{
    "body": "<a id='comment:24'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e6a697a3eb5d8a12feda9d3920b4830b618943ce\">e6a697a</a></td><td><code>truely ignore ignored bounds for ZZ.random_element</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/902f851e301962d232f8f5c5cc8f7065a7735547\">902f851</a></td><td><code>Merge branch 'public/32124' of git://trac.sagemath.org/sage into public/29977</code></td></tr></table>\n",
    "created_at": "2021-07-04T12:37:41Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477120",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e6a697a3eb5d8a12feda9d3920b4830b618943ce">e6a697a</a></td><td><code>truely ignore ignored bounds for ZZ.random_element</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/902f851e301962d232f8f5c5cc8f7065a7735547">902f851</a></td><td><code>Merge branch 'public/32124' of git://trac.sagemath.org/sage into public/29977</code></td></tr></table>




---

archive/issue_comments_477121.json:
```json
{
    "body": "**Changing commit** from \"[54b325ed10094a7cc676b39973830e5cbf4b1b97](https://github.com/sagemath/sagetrac-mirror/commit/54b325ed10094a7cc676b39973830e5cbf4b1b97)\" to \"[902f851e301962d232f8f5c5cc8f7065a7735547](https://github.com/sagemath/sagetrac-mirror/commit/902f851e301962d232f8f5c5cc8f7065a7735547)\".",
    "created_at": "2021-07-04T12:37:41Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477121",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[54b325ed10094a7cc676b39973830e5cbf4b1b97](https://github.com/sagemath/sagetrac-mirror/commit/54b325ed10094a7cc676b39973830e5cbf4b1b97)" to "[902f851e301962d232f8f5c5cc8f7065a7735547](https://github.com/sagemath/sagetrac-mirror/commit/902f851e301962d232f8f5c5cc8f7065a7735547)".



---

archive/issue_comments_477122.json:
```json
{
    "body": "**Dependencies:** #32124",
    "created_at": "2021-07-04T12:38:16Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477122",
    "user": "https://github.com/kliem"
}
```

**Dependencies:** #32124



---

archive/issue_comments_477123.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [tmonteil](#comment%3A12):\n> I came here from patchbots failure in `src/sage/modular/local_comp/local_comp.py`\n> where the issue probably comes from the use of sets, so perhaps\n> sorting the list is not needed, and it makes the examples less\n> understandable. Did you try to just replace `set(Pi.characters())`\n> with `Pi.characters()` instead of `sorted(Pi.characters(), key=str)`?\n\n\nSee comments ticket:30801#comment:202 and following.\n\nSorting by string does obscure the example a bit\nbut makes doctests pass with minimal disruption.\n\nThe following avoids sorting by string\nbut is a more disruptive change:\n\n```diff\n        A more complicated example (higher weight and nontrivial central character)::\n\n             sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]; f\n             q + j0*q^2 + 1/3*j0^3*q^3 - 1/3*j0^2*q^4 + O(q^6)\n             sage: Pi = LocalComponent(f, 5)\n-            sage: set(Pi.characters())\n-            {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,\n-             Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}\n-            sage: Pi.characters()[0].base_ring()\n-            Number Field in d with defining polynomial x^2 - j0*x + 1/3*j0^2 over its base field\n+            sage: chars = Pi.characters()\n+            sage: len(chars)\n+            2\n+            sage: a, b = chars\n+            sage: a.galois_conjugate() == b\n+            True\n+            sage: C = a.parent()\n+            sage: C\n+            Group of smooth characters\n+              of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0)\n+              with values in Number Field in d\n+              with defining polynomial x^2 - j0*x + 1/3*j0^2 over its base field\n+            sage: d = a.base_ring().gen()\n+            sage: s = C.number_field().gen()\n+            sage: j0 = a.base_ring().relative_polynomial().base_ring().gen()\n+            sage: a(5) == b(5) == 5\n+            True\n+            sage: {a(s), b(s)} == {(1/3*j0^2*d - 1/3*j0^3), (-1/3*j0^2*d)}\n+            True\n```\nAnother option would be to implement\na platform-independent sorting of characters.",
    "created_at": "2021-07-04T22:54:13Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477123",
    "user": "https://github.com/slel"
}
```

<a id='comment:26'></a>
Replying to [tmonteil](#comment%3A12):
> I came here from patchbots failure in `src/sage/modular/local_comp/local_comp.py`
> where the issue probably comes from the use of sets, so perhaps
> sorting the list is not needed, and it makes the examples less
> understandable. Did you try to just replace `set(Pi.characters())`
> with `Pi.characters()` instead of `sorted(Pi.characters(), key=str)`?


See comments ticket:30801#comment:202 and following.

Sorting by string does obscure the example a bit
but makes doctests pass with minimal disruption.

The following avoids sorting by string
but is a more disruptive change:

```diff
        A more complicated example (higher weight and nontrivial central character)::

             sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]; f
             q + j0*q^2 + 1/3*j0^3*q^3 - 1/3*j0^2*q^4 + O(q^6)
             sage: Pi = LocalComponent(f, 5)
-            sage: set(Pi.characters())
-            {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,
-             Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}
-            sage: Pi.characters()[0].base_ring()
-            Number Field in d with defining polynomial x^2 - j0*x + 1/3*j0^2 over its base field
+            sage: chars = Pi.characters()
+            sage: len(chars)
+            2
+            sage: a, b = chars
+            sage: a.galois_conjugate() == b
+            True
+            sage: C = a.parent()
+            sage: C
+            Group of smooth characters
+              of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0)
+              with values in Number Field in d
+              with defining polynomial x^2 - j0*x + 1/3*j0^2 over its base field
+            sage: d = a.base_ring().gen()
+            sage: s = C.number_field().gen()
+            sage: j0 = a.base_ring().relative_polynomial().base_ring().gen()
+            sage: a(5) == b(5) == 5
+            True
+            sage: {a(s), b(s)} == {(1/3*j0^2*d - 1/3*j0^3), (-1/3*j0^2*d)}
+            True
```
Another option would be to implement
a platform-independent sorting of characters.



---

archive/issue_comments_477124.json:
```json
{
    "body": "<a id='comment:27'></a>\nis there a way to efficiently check that the characters in question are characters, and their set is exhaustive in some sense?  \n\nanyhow the test for `len(chars)` above may be skipped.",
    "created_at": "2021-07-05T10:08:33Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477124",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
is there a way to efficiently check that the characters in question are characters, and their set is exhaustive in some sense?  

anyhow the test for `len(chars)` above may be skipped.



---

archive/issue_comments_477125.json:
```json
{
    "body": "<a id='comment:28'></a>\nI created #32134 for the `src/sage/modular/local_comp/local_comp.py` issue, as it is not related to the random seed (which is the purpose of this ticket).\n\nMy bet is that the order changed due to Pari upgrade, but it is constant for a given Pari version, hence we can use raw lists, not sets, nor sorting, nor cumbersome doctests.\n\nCould you please try that branch, and see if it passes for all of you.",
    "created_at": "2021-07-05T14:14:06Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477125",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:28'></a>
I created #32134 for the `src/sage/modular/local_comp/local_comp.py` issue, as it is not related to the random seed (which is the purpose of this ticket).

My bet is that the order changed due to Pari upgrade, but it is constant for a given Pari version, hence we can use raw lists, not sets, nor sorting, nor cumbersome doctests.

Could you please try that branch, and see if it passes for all of you.



---

archive/issue_comments_477126.json:
```json
{
    "body": "<a id='comment:29'></a>\ndid you try 32-bit as well as 64 bit?",
    "created_at": "2021-07-05T16:08:29Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477126",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>
did you try 32-bit as well as 64 bit?



---

archive/issue_comments_477127.json:
```json
{
    "body": "<a id='comment:30'></a>\nIndeed I added this issue to the ticket here because I mistakenly figured it was connected to random seeds. Whatever makes this issue get a positive review quickest, is what I would prefer. So a seperate ticket sounds indeed fine.\n\nI agree with Dima that only because it passes on a few computers, it doesn't tell you anything about general stability.",
    "created_at": "2021-07-05T16:17:58Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477127",
    "user": "https://github.com/kliem"
}
```

<a id='comment:30'></a>
Indeed I added this issue to the ticket here because I mistakenly figured it was connected to random seeds. Whatever makes this issue get a positive review quickest, is what I would prefer. So a seperate ticket sounds indeed fine.

I agree with Dima that only because it passes on a few computers, it doesn't tell you anything about general stability.



---

archive/issue_comments_477128.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [gh-kliem](#comment%3A30):\n> I agree with Dima that only because it passes on a few computers, it doesn't tell you anything about general stability.\n\n\nWhat i am lookinkg for is whether there was an issue on a single computer when we use lists instead of sets (i could not find any evidence in the various discussions).\n\nReplying to [dimpase](#comment%3A29):\n> did you try 32-bit as well as 64 bit?\n\n\nUnfortunately, i currently do not have any 32bit builder.\n\nLet us collect results of various builds on #32134.",
    "created_at": "2021-07-05T16:25:19Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477128",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:31'></a>
Replying to [gh-kliem](#comment%3A30):
> I agree with Dima that only because it passes on a few computers, it doesn't tell you anything about general stability.


What i am lookinkg for is whether there was an issue on a single computer when we use lists instead of sets (i could not find any evidence in the various discussions).

Replying to [dimpase](#comment%3A29):
> did you try 32-bit as well as 64 bit?


Unfortunately, i currently do not have any 32bit builder.

Let us collect results of various builds on #32134.



---

archive/issue_comments_477129.json:
```json
{
    "body": "<a id='comment:32'></a>\nIf the behaviour depends on the architecture, we can use the `# 64-bit` and `# 32-bit` tags.",
    "created_at": "2021-07-05T16:30:12Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477129",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:32'></a>
If the behaviour depends on the architecture, we can use the `# 64-bit` and `# 32-bit` tags.



---

archive/issue_comments_477130.json:
```json
{
    "body": "<a id='comment:33'></a>\nI much rather have some fix soon and a nice fix later.\n\nWe only have 3 patchbots at the moment and 3 are down exclusively because of this issue (I suspect one more that also had some interrupt).",
    "created_at": "2021-07-05T16:38:24Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477130",
    "user": "https://github.com/kliem"
}
```

<a id='comment:33'></a>
I much rather have some fix soon and a nice fix later.

We only have 3 patchbots at the moment and 3 are down exclusively because of this issue (I suspect one more that also had some interrupt).



---

archive/issue_comments_477131.json:
```json
{
    "body": "**Changing commit** from \"[902f851e301962d232f8f5c5cc8f7065a7735547](https://github.com/sagemath/sagetrac-mirror/commit/902f851e301962d232f8f5c5cc8f7065a7735547)\" to \"[a890c4d0b800bc014f2ccdcca7a87a71b280a6b8](https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8)\".",
    "created_at": "2021-07-06T07:19:34Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477131",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[902f851e301962d232f8f5c5cc8f7065a7735547](https://github.com/sagemath/sagetrac-mirror/commit/902f851e301962d232f8f5c5cc8f7065a7735547)" to "[a890c4d0b800bc014f2ccdcca7a87a71b280a6b8](https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8)".



---

archive/issue_comments_477132.json:
```json
{
    "body": "<a id='comment:34'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8\">a890c4d</a></td><td><code>one more test from modular</code></td></tr></table>\n",
    "created_at": "2021-07-06T07:19:34Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477132",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8">a890c4d</a></td><td><code>one more test from modular</code></td></tr></table>




---

archive/issue_events_267636.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-07-06T14:21:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267636"
}
```



---

archive/issue_events_267637.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-07-06T14:21:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267637"
}
```



---

archive/issue_comments_477133.json:
```json
{
    "body": "<a id='comment:35'></a>\nlgtm",
    "created_at": "2021-07-06T14:21:32Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477133",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>
lgtm



---

archive/issue_comments_477134.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2021-07-06T14:21:32Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477134",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_comments_477135.json:
```json
{
    "body": "<a id='comment:36'></a>\nThank you.",
    "created_at": "2021-07-06T14:46:01Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477135",
    "user": "https://github.com/kliem"
}
```

<a id='comment:36'></a>
Thank you.



---

archive/issue_events_267638.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/tmonteil",
    "created_at": "2021-07-20T00:53:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267638"
}
```



---

archive/issue_comments_477136.json:
```json
{
    "body": "<a id='comment:37'></a>\nSetting this to blocker so that we can restart patchbots.",
    "created_at": "2021-07-20T00:53:16Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477136",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:37'></a>
Setting this to blocker so that we can restart patchbots.



---

archive/issue_events_267639.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-24T15:28:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267639"
}
```



---

archive/issue_events_267640.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-24T15:28:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29977#event-267640"
}
```



---

archive/issue_comments_477137.json:
```json
{
    "body": "**Changing branch** from \"[public/29977](https://github.com/sagemath/sagetrac-mirror/tree/public/29977)\" to \"[a890c4d0b800bc014f2ccdcca7a87a71b280a6b8](https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8)\".",
    "created_at": "2021-07-24T15:28:50Z",
    "issue": "https://github.com/sagemath/sage/issues/29977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29977#issuecomment-477137",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/29977](https://github.com/sagemath/sagetrac-mirror/tree/public/29977)" to "[a890c4d0b800bc014f2ccdcca7a87a71b280a6b8](https://github.com/sagemath/sagetrac-mirror/commit/a890c4d0b800bc014f2ccdcca7a87a71b280a6b8)".
