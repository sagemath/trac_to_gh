# Issue 29310: "make distclean" should not run "./configure"

archive/issues_029073.json:
```json
{
    "body": "As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n\nThis would make things faster and more quiet.\n\nRelated:\n\n- #30258: Have configure run quiet if started by make in silent mode\n- #29097: Rename make targets SPKG-clean to SPKG-uninstall\n\n\nCC:  @jhpalmieri @mkoeppe @slel\n\nKeywords: quiet, speed\n\nReviewer: Matthias Koeppe\n\nAuthor: John Palmieri\n\nBranch: e28f0934ce9619c4eb13b45b015165d8804829c2\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29310\n\n",
    "closed_at": "2021-12-28T21:15:33Z",
    "created_at": "2020-03-10T22:30:11Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "\"make distclean\" should not run \"./configure\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29310",
    "user": "https://github.com/jhpalmieri"
}
```
As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.

This would make things faster and more quiet.

Related:

- #30258: Have configure run quiet if started by make in silent mode
- #29097: Rename make targets SPKG-clean to SPKG-uninstall


CC:  @jhpalmieri @mkoeppe @slel

Keywords: quiet, speed

Reviewer: Matthias Koeppe

Author: John Palmieri

Branch: e28f0934ce9619c4eb13b45b015165d8804829c2

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29310





---

archive/issue_comments_571566.json:
```json
{
    "body": "<a id='comment:1'></a>\nSee also: \n- #29098 - Merge build/make/deps into build/make/Makefile.in\n- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall\nwhich could be done at the same time.",
    "created_at": "2020-03-29T02:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571566",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
See also: 
- #29098 - Merge build/make/deps into build/make/Makefile.in
- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall
which could be done at the same time.



---

archive/issue_events_074580.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-15T14:58:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74580"
}
```



---

archive/issue_comments_571567.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis could presumably be fixed by #29316.",
    "created_at": "2020-04-18T20:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571567",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
This could presumably be fixed by #29316.



---

archive/issue_events_074581.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74581"
}
```



---

archive/issue_events_074582.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74582"
}
```



---

archive/issue_comments_571568.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [jhpalmieri](#comment%3A3):\n> This could presumably be fixed by #29316.\n\n\nApparently not.",
    "created_at": "2020-09-07T20:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571568",
    "user": "https://github.com/slel"
}
```

<a id='comment:5'></a>
Replying to [jhpalmieri](#comment%3A3):
> This could presumably be fixed by #29316.


Apparently not.



---

archive/issue_comments_571569.json:
```json
{
    "body": "Changing keywords from \"\" to \"quiet, speed\".",
    "created_at": "2020-09-07T20:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571569",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "quiet, speed".



---

archive/issue_comments_571570.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,9 @@\n As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n \n+This would make things faster and more quiet.\n+\n+Related:\n+\n+- #30258: Have configure run quiet if started by make in silent mode\n+- #29097: Rename make targets SPKG-clean to SPKG-uninstall\n+\n``````\n",
    "created_at": "2020-09-07T20:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571570",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,9 @@
 As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.
 
+This would make things faster and more quiet.
+
+Related:
+
+- #30258: Have configure run quiet if started by make in silent mode
+- #29097: Rename make targets SPKG-clean to SPKG-uninstall
+
``````




---

archive/issue_events_074583.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74583"
}
```



---

archive/issue_events_074584.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74584"
}
```



---

archive/issue_comments_571571.json:
```json
{
    "body": "<a id='comment:7'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571571",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_074585.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74585"
}
```



---

archive/issue_events_074586.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74586"
}
```



---

archive/issue_comments_571572.json:
```json
{
    "body": "<a id='comment:9'></a>\nAlso, in 9.4.beta5 I am getting with `make distclean`:\n\n```\n/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory\n```",
    "created_at": "2021-10-24T17:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571572",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Also, in 9.4.beta5 I am getting with `make distclean`:

```
/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory
```



---

archive/issue_comments_571573.json:
```json
{
    "body": "<a id='comment:10'></a>\nCan we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.",
    "created_at": "2021-10-27T20:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571573",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>
Can we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.



---

archive/issue_comments_571574.json:
```json
{
    "body": "<a id='comment:11'></a>\nI'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:\n\n```\n# Defer unknown targets to build/make/Makefile\n%::\n\t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n\t$(MAKE) build/make/Makefile --stop\n\t+build/bin/sage-logger \\\n\t\t\"cd build/make && ./install '$@'\" logs/install.log\n```\nSo that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:\n- `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`\n- `cd \"$(SAGE_SRC)\" && (do some stuff)`\n- `cd \"$(SAGE_ROOT)/build/pkgs/sagelib/src/\" && rm -rf build`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_docbuild/src\" && rm -rf build)`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_setup/src\" && rm -rf build)`\n- `cd \"$(SAGE_SRC)/doc\" && $(MAKE) clean`\n- `rm -rf \"$(SAGE_SHARE)/doc/sage\"`",
    "created_at": "2021-10-27T22:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571574",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
I'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:

```
# Defer unknown targets to build/make/Makefile
%::
	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
	$(MAKE) build/make/Makefile --stop
	+build/bin/sage-logger \
		"cd build/make && ./install '$@'" logs/install.log
```
So that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:
- `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`
- `cd "$(SAGE_SRC)" && (do some stuff)`
- `cd "$(SAGE_ROOT)/build/pkgs/sagelib/src/" && rm -rf build`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_docbuild/src" && rm -rf build)`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_setup/src" && rm -rf build)`
- `cd "$(SAGE_SRC)/doc" && $(MAKE) clean`
- `rm -rf "$(SAGE_SHARE)/doc/sage"`



---

archive/issue_comments_571575.json:
```json
{
    "body": "<a id='comment:12'></a>\nMoving the cleaning targets to the top-level Makefile could make sense.\n\nMost of the above lines really don't need configured variables.\n\nFor cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):\n\nAs you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).\n\nSo it only matters what is to be done when `SAGE_LOCAL` has been set to something else.\n\nTo run a line such as `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.\n\nI'm not sure about `rm -rf \"$(SAGE_SHARE)/doc/sage\"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.\n(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)",
    "created_at": "2021-10-29T02:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571575",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
Moving the cleaning targets to the top-level Makefile could make sense.

Most of the above lines really don't need configured variables.

For cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):

As you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).

So it only matters what is to be done when `SAGE_LOCAL` has been set to something else.

To run a line such as `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.

I'm not sure about `rm -rf "$(SAGE_SHARE)/doc/sage"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.
(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)



---

archive/issue_comments_571576.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/distclean\"",
    "created_at": "2021-10-29T05:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571576",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/distclean"



---

archive/issue_comments_571577.json:
```json
{
    "body": "<a id='comment:14'></a>\nHere is an attempt. A few comments:\n- I added the line `if [ -d \"$(SAGE_SRC)\" ]; then \\` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.\n- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.\n \n---\nNew commits:\n|                                                                                                                                          |                                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[c7cfd31](https://git.sagemath.org/sage.git/commit?id=c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)|`trac 29310: move various ...-clean targets to top-level Makefile`|",
    "created_at": "2021-10-29T05:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571577",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'></a>
Here is an attempt. A few comments:
- I added the line `if [ -d "$(SAGE_SRC)" ]; then \` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.
- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.
 
---
New commits:
|                                                                                                                                          |                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[c7cfd31](https://git.sagemath.org/sage.git/commit?id=c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)|`trac 29310: move various ...-clean targets to top-level Makefile`|



---

archive/issue_comments_571578.json:
```json
{
    "body": "Changing commit from \"\" to \"c7cfd313ace5d6ae7a847a8d6fb69d20951527d6\"",
    "created_at": "2021-10-29T05:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571578",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "c7cfd313ace5d6ae7a847a8d6fb69d20951527d6"



---

archive/issue_comments_571579.json:
```json
{
    "body": "<a id='comment:15'></a>\nOh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like\n\n```\nSAGE_ROOT = $$(pwd)\n\nclean-test:\n    echo $(SAGE_ROOT)\n```\nthen `make clean-test` would print\n\n```\necho $(pwd)\n/Users/palmieri/....\n```\nWith the current version, if I add the same target `clean-test`, then `make clean-test` prints\n\n```\necho /Users/...\n/Users/...\n```\nIt seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.",
    "created_at": "2021-10-29T05:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571579",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>
Oh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like

```
SAGE_ROOT = $$(pwd)

clean-test:
    echo $(SAGE_ROOT)
```
then `make clean-test` would print

```
echo $(pwd)
/Users/palmieri/....
```
With the current version, if I add the same target `clean-test`, then `make clean-test` prints

```
echo /Users/...
/Users/...
```
It seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.



---

archive/issue_comments_571580.json:
```json
{
    "body": "<a id='comment:16'></a>\nTry `$(CURDIR)`",
    "created_at": "2021-10-29T05:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571580",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Try `$(CURDIR)`



---

archive/issue_comments_571581.json:
```json
{
    "body": "Changing commit from \"c7cfd313ace5d6ae7a847a8d6fb69d20951527d6\" to \"d3d14055243d3ef2d20a061061be952aca82f34b\"",
    "created_at": "2021-10-29T16:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571581",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c7cfd313ace5d6ae7a847a8d6fb69d20951527d6" to "d3d14055243d3ef2d20a061061be952aca82f34b"



---

archive/issue_comments_571582.json:
```json
{
    "body": "<a id='comment:17'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[d3d1405](https://git.sagemath.org/sage.git/commit/?id=d3d14055243d3ef2d20a061061be952aca82f34b)|`trac 29310: use CURDIR`|",
    "created_at": "2021-10-29T16:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571582",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[d3d1405](https://git.sagemath.org/sage.git/commit/?id=d3d14055243d3ef2d20a061061be952aca82f34b)|`trac 29310: use CURDIR`|



---

archive/issue_comments_571583.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [mkoeppe](#comment%3A16):\n> Try `$(CURDIR)`\n\n\nThanks, done.",
    "created_at": "2021-10-29T16:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571583",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>
Replying to [mkoeppe](#comment%3A16):
> Try `$(CURDIR)`


Thanks, done.



---

archive/issue_events_074587.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74587"
}
```



---

archive/issue_events_074588.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74588"
}
```



---

archive/issue_comments_571584.json:
```json
{
    "body": "<a id='comment:20'></a>\nI think this is ready for review.",
    "created_at": "2021-12-16T00:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571584",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'></a>
I think this is ready for review.



---

archive/issue_comments_571585.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-16T00:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571585",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_571586.json:
```json
{
    "body": "Changing author from \"\" to \"John Palmieri\"",
    "created_at": "2021-12-16T00:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571586",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "" to "John Palmieri"



---

archive/issue_comments_571587.json:
```json
{
    "body": "<a id='comment:22'></a>\n\n```\n+SAGE_ROOT ?= $(CURDIR)\n+SAGE_SRC ?= $(SAGE_ROOT)/src\n```\nI think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here",
    "created_at": "2021-12-17T06:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571587",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>

```
+SAGE_ROOT ?= $(CURDIR)
+SAGE_SRC ?= $(SAGE_ROOT)/src
```
I think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here



---

archive/issue_comments_571588.json:
```json
{
    "body": "Changing commit from \"d3d14055243d3ef2d20a061061be952aca82f34b\" to \"67d69da24a88e4d357ce834cb7fd229b93bf770e\"",
    "created_at": "2021-12-17T19:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571588",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d3d14055243d3ef2d20a061061be952aca82f34b" to "67d69da24a88e4d357ce834cb7fd229b93bf770e"



---

archive/issue_comments_571589.json:
```json
{
    "body": "<a id='comment:23'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[f53be61](https://git.sagemath.org/sage.git/commit/?id=f53be617a02a63d21e5efdbae52a576a61561bf4)|`trac 29310: move various ...-clean targets to top-level Makefile`|\n|[3a7712e](https://git.sagemath.org/sage.git/commit/?id=3a7712e76582b2cae22f1156d678169471dba4cd)|`trac 29310: use CURDIR`|\n|[67d69da](https://git.sagemath.org/sage.git/commit/?id=67d69da24a88e4d357ce834cb7fd229b93bf770e)|`trac 29310: use \"=\" instead of \"?=\"`|",
    "created_at": "2021-12-17T19:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571589",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[f53be61](https://git.sagemath.org/sage.git/commit/?id=f53be617a02a63d21e5efdbae52a576a61561bf4)|`trac 29310: move various ...-clean targets to top-level Makefile`|
|[3a7712e](https://git.sagemath.org/sage.git/commit/?id=3a7712e76582b2cae22f1156d678169471dba4cd)|`trac 29310: use CURDIR`|
|[67d69da](https://git.sagemath.org/sage.git/commit/?id=67d69da24a88e4d357ce834cb7fd229b93bf770e)|`trac 29310: use "=" instead of "?="`|



---

archive/issue_comments_571590.json:
```json
{
    "body": "<a id='comment:24'></a>\nFixed, thanks.",
    "created_at": "2021-12-17T19:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571590",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:24'></a>
Fixed, thanks.



---

archive/issue_comments_571591.json:
```json
{
    "body": "<a id='comment:25'></a>\n\n```\n+clean:\n+\t@echo \"Deleting package build directories...\"\n+\tif [ -x \"$(SAGE_SRC)\"/bin/sage-env-config ]; then \\\n+\t    . \"$(SAGE_SRC)\"/bin/sage-env-config; \\\n+            rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"; \\\n+\tfi\n```\nThe reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.\n\nAlso, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...",
    "created_at": "2021-12-20T23:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571591",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>

```
+clean:
+	@echo "Deleting package build directories..."
+	if [ -x "$(SAGE_SRC)"/bin/sage-env-config ]; then \
+	    . "$(SAGE_SRC)"/bin/sage-env-config; \
+            rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
+	fi
```
The reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.

Also, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...



---

archive/issue_comments_571592.json:
```json
{
    "body": "Changing commit from \"67d69da24a88e4d357ce834cb7fd229b93bf770e\" to \"e28f0934ce9619c4eb13b45b015165d8804829c2\"",
    "created_at": "2021-12-21T03:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571592",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "67d69da24a88e4d357ce834cb7fd229b93bf770e" to "e28f0934ce9619c4eb13b45b015165d8804829c2"



---

archive/issue_comments_571593.json:
```json
{
    "body": "<a id='comment:26'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                          |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------|\n|[e28f093](https://git.sagemath.org/sage.git/commit/?id=e28f0934ce9619c4eb13b45b015165d8804829c2)|`trac 29310: use $$SAGE_LOCAL instead of $(SAGE_LOCAL) --`|",
    "created_at": "2021-12-21T03:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571593",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                          |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------|
|[e28f093](https://git.sagemath.org/sage.git/commit/?id=e28f0934ce9619c4eb13b45b015165d8804829c2)|`trac 29310: use $$SAGE_LOCAL instead of $(SAGE_LOCAL) --`|



---

archive/issue_comments_571594.json:
```json
{
    "body": "<a id='comment:27'></a>\nIt was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.",
    "created_at": "2021-12-21T03:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571594",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>
It was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.



---

archive/issue_comments_571595.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-23T05:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571595",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_571596.json:
```json
{
    "body": "<a id='comment:28'></a>\nLGTM and seems to work well.",
    "created_at": "2021-12-23T05:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571596",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
LGTM and seems to work well.



---

archive/issue_comments_571597.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-12-23T05:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571597",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_571598.json:
```json
{
    "body": "<a id='comment:30'></a>\nThank you!",
    "created_at": "2021-12-23T19:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571598",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:30'></a>
Thank you!



---

archive/issue_comments_571599.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/distclean\" to \"e28f0934ce9619c4eb13b45b015165d8804829c2\"",
    "created_at": "2021-12-28T21:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571599",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/distclean" to "e28f0934ce9619c4eb13b45b015165d8804829c2"



---

archive/issue_comments_571600.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-28T21:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571600",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074589.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-28T21:15:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74589"
}
```



---

archive/issue_events_074590.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-28T21:18:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74590"
}
```



---

archive/issue_events_074591.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-28T21:18:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29310#event-74591"
}
```



---

archive/issue_comments_571601.json:
```json
{
    "body": "Changing commit from \"e28f0934ce9619c4eb13b45b015165d8804829c2\" to \"\"",
    "created_at": "2021-12-28T21:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29310#issuecomment-571601",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "e28f0934ce9619c4eb13b45b015165d8804829c2" to ""
