# Issue 29310: "make distclean" should not run "./configure"

archive/issues_029073.json:
```json
{
    "assignees": [],
    "body": "As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n\nThis would make things faster and more quiet.\n\nRelated:\n\n- #30258: Have configure run quiet if started by make in silent mode\n- #29097: Rename make targets SPKG-clean to SPKG-uninstall\n\n\nCC:  @jhpalmieri @mkoeppe @slel\n\nKeywords: **quiet, speed**\n\nBranch: **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **John Palmieri**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29310_\n\n",
    "closed_at": "2021-12-28T21:15:33Z",
    "created_at": "2020-03-10T22:30:11Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "\"make distclean\" should not run \"./configure\"",
    "type": "issue",
    "updated_at": "2021-12-28T21:18:28Z",
    "url": "https://github.com/sagemath/sage/issues/29310",
    "user": "https://github.com/jhpalmieri"
}
```
As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.

This would make things faster and more quiet.

Related:

- #30258: Have configure run quiet if started by make in silent mode
- #29097: Rename make targets SPKG-clean to SPKG-uninstall


CC:  @jhpalmieri @mkoeppe @slel

Keywords: **quiet, speed**

Branch: **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**

Reviewer: **Matthias Koeppe**

Author: **John Palmieri**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/29310_





---

archive/issue_events_402949.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402949"
}
```



---

archive/issue_events_402950.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402950"
}
```



---

archive/issue_events_402951.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402951"
}
```



---

archive/issue_events_402952.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402952"
}
```



---

archive/issue_comments_459736.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nSee also: \n- #29098 - Merge build/make/deps into build/make/Makefile.in\n- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall\nwhich could be done at the same time.",
    "created_at": "2020-03-29T02:19:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459736",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>

See also: 
- #29098 - Merge build/make/deps into build/make/Makefile.in
- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall
which could be done at the same time.



---

archive/issue_events_402953.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-15T14:58:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402953"
}
```



---

archive/issue_events_402954.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-15T14:58:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402954"
}
```



---

archive/issue_comments_459737.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis could presumably be fixed by #29316.",
    "created_at": "2020-04-18T20:32:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459737",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:3" align="right">comment:3</div>

This could presumably be fixed by #29316.



---

archive/issue_events_402955.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402955"
}
```



---

archive/issue_events_402956.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402956"
}
```



---

archive/issue_comments_459738.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@jhpalmieri](#comment:3):\n> This could presumably be fixed by #29316.\n\nApparently not.",
    "created_at": "2020-09-07T20:39:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459738",
    "user": "https://github.com/slel"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@jhpalmieri](#comment:3):
> This could presumably be fixed by #29316.

Apparently not.



---

archive/issue_comments_459739.json:
```json
{
    "body": "Changed keywords from none to **quiet, speed**",
    "created_at": "2020-09-07T20:45:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459739",
    "user": "https://github.com/slel"
}
```

Changed keywords from none to **quiet, speed**



---

archive/issue_comments_459740.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,9 @@\n As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n \n+This would make things faster and more quiet.\n+\n+Related:\n+\n+- #30258: Have configure run quiet if started by make in silent mode\n+- #29097: Rename make targets SPKG-clean to SPKG-uninstall\n+\n``````\n",
    "created_at": "2020-09-07T20:45:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459740",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,9 @@
 As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.
 
+This would make things faster and more quiet.
+
+Related:
+
+- #30258: Have configure run quiet if started by make in silent mode
+- #29097: Rename make targets SPKG-clean to SPKG-uninstall
+
``````




---

archive/issue_events_402957.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402957"
}
```



---

archive/issue_events_402958.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402958"
}
```



---

archive/issue_comments_459741.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459741",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_402959.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402959"
}
```



---

archive/issue_events_402960.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402960"
}
```



---

archive/issue_comments_459742.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAlso, in 9.4.beta5 I am getting with `make distclean`:\n\n```\n/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory\n```",
    "created_at": "2021-10-24T17:56:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459742",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

Also, in 9.4.beta5 I am getting with `make distclean`:

```
/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory
```



---

archive/issue_comments_459743.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nCan we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.",
    "created_at": "2021-10-27T20:27:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459743",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

Can we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.



---

archive/issue_comments_459744.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:\n\n```\n# Defer unknown targets to build/make/Makefile\n%::\n\t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n\t$(MAKE) build/make/Makefile --stop\n\t+build/bin/sage-logger \\\n\t\t\"cd build/make && ./install '$@'\" logs/install.log\n```\nSo that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:\n- `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`\n- `cd \"$(SAGE_SRC)\" && (do some stuff)`\n- `cd \"$(SAGE_ROOT)/build/pkgs/sagelib/src/\" && rm -rf build`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_docbuild/src\" && rm -rf build)`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_setup/src\" && rm -rf build)`\n- `cd \"$(SAGE_SRC)/doc\" && $(MAKE) clean`\n- `rm -rf \"$(SAGE_SHARE)/doc/sage\"`",
    "created_at": "2021-10-27T22:00:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459744",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:11" align="right">comment:11</div>

I'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:

```
# Defer unknown targets to build/make/Makefile
%::
	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
	$(MAKE) build/make/Makefile --stop
	+build/bin/sage-logger \
		"cd build/make && ./install '$@'" logs/install.log
```
So that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:
- `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`
- `cd "$(SAGE_SRC)" && (do some stuff)`
- `cd "$(SAGE_ROOT)/build/pkgs/sagelib/src/" && rm -rf build`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_docbuild/src" && rm -rf build)`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_setup/src" && rm -rf build)`
- `cd "$(SAGE_SRC)/doc" && $(MAKE) clean`
- `rm -rf "$(SAGE_SHARE)/doc/sage"`



---

archive/issue_comments_459745.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nMoving the cleaning targets to the top-level Makefile could make sense.\n\nMost of the above lines really don't need configured variables.\n\nFor cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):\n\nAs you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).\n\nSo it only matters what is to be done when `SAGE_LOCAL` has been set to something else.\n\nTo run a line such as `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.\n\nI'm not sure about `rm -rf \"$(SAGE_SHARE)/doc/sage\"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.\n(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)",
    "created_at": "2021-10-29T02:32:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459745",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

Moving the cleaning targets to the top-level Makefile could make sense.

Most of the above lines really don't need configured variables.

For cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):

As you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).

So it only matters what is to be done when `SAGE_LOCAL` has been set to something else.

To run a line such as `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.

I'm not sure about `rm -rf "$(SAGE_SHARE)/doc/sage"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.
(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)



---

archive/issue_comments_459746.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)**",
    "created_at": "2021-10-29T05:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459746",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)**



---

archive/issue_comments_459747.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nHere is an attempt. A few comments:\n- I added the line `if [ -d \"$(SAGE_SRC)\" ]; then \\` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.\n- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.\n \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6\">c7cfd31</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr></table>\n",
    "created_at": "2021-10-29T05:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459747",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:14" align="right">comment:14</div>

Here is an attempt. A few comments:
- I added the line `if [ -d "$(SAGE_SRC)" ]; then \` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.
- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.
 
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6">c7cfd31</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr></table>




---

archive/issue_comments_459748.json:
```json
{
    "body": "Commit: **[`c7cfd31`](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)**",
    "created_at": "2021-10-29T05:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459748",
    "user": "https://github.com/jhpalmieri"
}
```

Commit: **[`c7cfd31`](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)**



---

archive/issue_comments_459749.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nOh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like\n\n```\nSAGE_ROOT = $$(pwd)\n\nclean-test:\n    echo $(SAGE_ROOT)\n```\nthen `make clean-test` would print\n\n```\necho $(pwd)\n/Users/palmieri/....\n```\nWith the current version, if I add the same target `clean-test`, then `make clean-test` prints\n\n```\necho /Users/...\n/Users/...\n```\nIt seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.",
    "created_at": "2021-10-29T05:26:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459749",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:15" align="right">comment:15</div>

Oh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like

```
SAGE_ROOT = $$(pwd)

clean-test:
    echo $(SAGE_ROOT)
```
then `make clean-test` would print

```
echo $(pwd)
/Users/palmieri/....
```
With the current version, if I add the same target `clean-test`, then `make clean-test` prints

```
echo /Users/...
/Users/...
```
It seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.



---

archive/issue_comments_459750.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nTry `$(CURDIR)`",
    "created_at": "2021-10-29T05:32:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459750",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

Try `$(CURDIR)`



---

archive/issue_comments_459751.json:
```json
{
    "body": "Changed commit from **[`c7cfd31`](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)** to **[`d3d1405`](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)**",
    "created_at": "2021-10-29T16:03:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459751",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c7cfd31`](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)** to **[`d3d1405`](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)**



---

archive/issue_comments_459752.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b\">d3d1405</a></td><td><code>trac 29310: use CURDIR</code></td></tr></table>\n",
    "created_at": "2021-10-29T16:03:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459752",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b">d3d1405</a></td><td><code>trac 29310: use CURDIR</code></td></tr></table>




---

archive/issue_comments_459753.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@mkoeppe](#comment:16):\n> Try `$(CURDIR)`\n\nThanks, done.",
    "created_at": "2021-10-29T16:04:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459753",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@mkoeppe](#comment:16):
> Try `$(CURDIR)`

Thanks, done.



---

archive/issue_events_402961.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402961"
}
```



---

archive/issue_events_402962.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402962"
}
```



---

archive/issue_comments_459754.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI think this is ready for review.",
    "created_at": "2021-12-16T00:05:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459754",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:20" align="right">comment:20</div>

I think this is ready for review.



---

archive/issue_events_402963.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-12-16T00:05:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402963"
}
```



---

archive/issue_comments_459755.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2021-12-16T00:06:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459755",
    "user": "https://github.com/jhpalmieri"
}
```

Author: **John Palmieri**



---

archive/issue_comments_459756.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\n\n```\n+SAGE_ROOT ?= $(CURDIR)\n+SAGE_SRC ?= $(SAGE_ROOT)/src\n```\nI think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here",
    "created_at": "2021-12-17T06:33:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459756",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>


```
+SAGE_ROOT ?= $(CURDIR)
+SAGE_SRC ?= $(SAGE_ROOT)/src
```
I think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here



---

archive/issue_comments_459757.json:
```json
{
    "body": "Changed commit from **[`d3d1405`](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)** to **[`67d69da`](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)**",
    "created_at": "2021-12-17T19:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459757",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d3d1405`](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)** to **[`67d69da`](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)**



---

archive/issue_comments_459758.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f53be617a02a63d21e5efdbae52a576a61561bf4\">f53be61</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a7712e76582b2cae22f1156d678169471dba4cd\">3a7712e</a></td><td><code>trac 29310: use CURDIR</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e\">67d69da</a></td><td><code>trac 29310: use \"=\" instead of \"?=\"</code></td></tr></table>\n",
    "created_at": "2021-12-17T19:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459758",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f53be617a02a63d21e5efdbae52a576a61561bf4">f53be61</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a7712e76582b2cae22f1156d678169471dba4cd">3a7712e</a></td><td><code>trac 29310: use CURDIR</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e">67d69da</a></td><td><code>trac 29310: use "=" instead of "?="</code></td></tr></table>




---

archive/issue_comments_459759.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nFixed, thanks.",
    "created_at": "2021-12-17T19:45:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459759",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:24" align="right">comment:24</div>

Fixed, thanks.



---

archive/issue_comments_459760.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n\n```\n+clean:\n+\t@echo \"Deleting package build directories...\"\n+\tif [ -x \"$(SAGE_SRC)\"/bin/sage-env-config ]; then \\\n+\t    . \"$(SAGE_SRC)\"/bin/sage-env-config; \\\n+            rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"; \\\n+\tfi\n```\nThe reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.\n\nAlso, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...",
    "created_at": "2021-12-20T23:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459760",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>


```
+clean:
+	@echo "Deleting package build directories..."
+	if [ -x "$(SAGE_SRC)"/bin/sage-env-config ]; then \
+	    . "$(SAGE_SRC)"/bin/sage-env-config; \
+            rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
+	fi
```
The reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.

Also, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...



---

archive/issue_comments_459761.json:
```json
{
    "body": "Changed commit from **[`67d69da`](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)** to **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**",
    "created_at": "2021-12-21T03:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459761",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`67d69da`](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)** to **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**



---

archive/issue_comments_459762.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2\">e28f093</a></td><td><code>trac 29310: use $$SAGE_LOCAL instead of $(SAGE_LOCAL) --</code></td></tr></table>\n",
    "created_at": "2021-12-21T03:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459762",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2">e28f093</a></td><td><code>trac 29310: use $$SAGE_LOCAL instead of $(SAGE_LOCAL) --</code></td></tr></table>




---

archive/issue_comments_459763.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nIt was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.",
    "created_at": "2021-12-21T03:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459763",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:27" align="right">comment:27</div>

It was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.



---

archive/issue_events_402964.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-23T05:14:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402964"
}
```



---

archive/issue_events_402965.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-23T05:14:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402965"
}
```



---

archive/issue_comments_459764.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nLGTM and seems to work well.",
    "created_at": "2021-12-23T05:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459764",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

LGTM and seems to work well.



---

archive/issue_comments_459765.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2021-12-23T05:32:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459765",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_459766.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThank you!",
    "created_at": "2021-12-23T19:06:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459766",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:30" align="right">comment:30</div>

Thank you!



---

archive/issue_comments_459767.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)** to **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**",
    "created_at": "2021-12-28T21:15:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459767",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)** to **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**



---

archive/issue_events_402966.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-28T21:15:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402966"
}
```



---

archive/issue_events_402967.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "da90b23cc93a49f16196664c0132bb5f15127b96",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-12-28T21:15:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402967"
}
```



---

archive/issue_events_402968.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-28T21:18:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402968"
}
```



---

archive/issue_events_402969.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-28T21:18:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-402969"
}
```



---

archive/issue_comments_459768.json:
```json
{
    "body": "Changed commit from **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)** to none",
    "created_at": "2021-12-28T21:18:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-459768",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[`e28f093`](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)** to none
