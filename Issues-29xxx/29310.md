# Issue 29310: "make distclean" should not run "./configure"

archive/issues_029073.json:
```json
{
    "assignees": [],
    "body": "As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n\nThis would make things faster and more quiet.\n\nRelated:\n\n- #30258: Have configure run quiet if started by make in silent mode\n- #29097: Rename make targets SPKG-clean to SPKG-uninstall\n\n\nCC:  @jhpalmieri @mkoeppe @slel\n\nKeywords: **quiet, speed**\n\nBranch: **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **John Palmieri**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29310_\n\n",
    "closed_at": "2021-12-28T21:15:33Z",
    "created_at": "2020-03-10T22:30:11Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "\"make distclean\" should not run \"./configure\"",
    "type": "issue",
    "updated_at": "2021-12-28T21:18:28Z",
    "url": "https://github.com/sagemath/sage/issues/29310",
    "user": "https://github.com/jhpalmieri"
}
```
As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.

This would make things faster and more quiet.

Related:

- #30258: Have configure run quiet if started by make in silent mode
- #29097: Rename make targets SPKG-clean to SPKG-uninstall


CC:  @jhpalmieri @mkoeppe @slel

Keywords: **quiet, speed**

Branch: **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**

Reviewer: **Matthias Koeppe**

Author: **John Palmieri**

_Issue created by migration from https://trac.sagemath.org/ticket/29310_





---

archive/issue_events_371349.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371349"
}
```



---

archive/issue_events_371350.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371350"
}
```



---

archive/issue_events_371351.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371351"
}
```



---

archive/issue_events_371352.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-03-10T22:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371352"
}
```



---

archive/issue_comments_462622.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nSee also: \n- #29098 - Merge build/make/deps into build/make/Makefile.in\n- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall\nwhich could be done at the same time.",
    "created_at": "2020-03-29T02:19:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462622",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'>Comment 1:</a>
See also: 
- #29098 - Merge build/make/deps into build/make/Makefile.in
- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall
which could be done at the same time.



---

archive/issue_events_371353.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-15T14:58:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371353"
}
```



---

archive/issue_events_371354.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-15T14:58:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371354"
}
```



---

archive/issue_comments_462623.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nThis could presumably be fixed by #29316.",
    "created_at": "2020-04-18T20:32:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462623",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'>Comment 3:</a>
This could presumably be fixed by #29316.



---

archive/issue_events_371355.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371355"
}
```



---

archive/issue_events_371356.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-29T16:37:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371356"
}
```



---

archive/issue_comments_462624.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@jhpalmieri](#comment%3A3):\n> This could presumably be fixed by #29316.\n\nApparently not.",
    "created_at": "2020-09-07T20:39:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462624",
    "user": "https://github.com/slel"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@jhpalmieri](#comment%3A3):
> This could presumably be fixed by #29316.

Apparently not.



---

archive/issue_comments_462625.json:
```json
{
    "body": "Changed keywords from **** to **quiet, speed**",
    "created_at": "2020-09-07T20:45:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462625",
    "user": "https://github.com/slel"
}
```

Changed keywords from **** to **quiet, speed**



---

archive/issue_comments_462626.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,9 @@\n As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n \n+This would make things faster and more quiet.\n+\n+Related:\n+\n+- #30258: Have configure run quiet if started by make in silent mode\n+- #29097: Rename make targets SPKG-clean to SPKG-uninstall\n+\n``````\n",
    "created_at": "2020-09-07T20:45:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462626",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,9 @@
 As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.
 
+This would make things faster and more quiet.
+
+Related:
+
+- #30258: Have configure run quiet if started by make in silent mode
+- #29097: Rename make targets SPKG-clean to SPKG-uninstall
+
``````




---

archive/issue_events_371357.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371357"
}
```



---

archive/issue_events_371358.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371358"
}
```



---

archive/issue_comments_462627.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462627",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'>Comment 7:</a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_371359.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371359"
}
```



---

archive/issue_events_371360.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371360"
}
```



---

archive/issue_comments_462628.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nAlso, in 9.4.beta5 I am getting with `make distclean`:\n\n```\n/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory\n```",
    "created_at": "2021-10-24T17:56:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462628",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'>Comment 9:</a>
Also, in 9.4.beta5 I am getting with `make distclean`:

```
/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory
```



---

archive/issue_comments_462629.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nCan we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.",
    "created_at": "2021-10-27T20:27:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462629",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'>Comment 10:</a>
Can we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.



---

archive/issue_comments_462630.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nI'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:\n\n```\n# Defer unknown targets to build/make/Makefile\n%::\n\t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n\t$(MAKE) build/make/Makefile --stop\n\t+build/bin/sage-logger \\\n\t\t\"cd build/make && ./install '$@'\" logs/install.log\n```\nSo that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:\n- `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`\n- `cd \"$(SAGE_SRC)\" && (do some stuff)`\n- `cd \"$(SAGE_ROOT)/build/pkgs/sagelib/src/\" && rm -rf build`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_docbuild/src\" && rm -rf build)`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_setup/src\" && rm -rf build)`\n- `cd \"$(SAGE_SRC)/doc\" && $(MAKE) clean`\n- `rm -rf \"$(SAGE_SHARE)/doc/sage\"`",
    "created_at": "2021-10-27T22:00:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462630",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'>Comment 11:</a>
I'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:

```
# Defer unknown targets to build/make/Makefile
%::
	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
	$(MAKE) build/make/Makefile --stop
	+build/bin/sage-logger \
		"cd build/make && ./install '$@'" logs/install.log
```
So that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:
- `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`
- `cd "$(SAGE_SRC)" && (do some stuff)`
- `cd "$(SAGE_ROOT)/build/pkgs/sagelib/src/" && rm -rf build`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_docbuild/src" && rm -rf build)`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_setup/src" && rm -rf build)`
- `cd "$(SAGE_SRC)/doc" && $(MAKE) clean`
- `rm -rf "$(SAGE_SHARE)/doc/sage"`



---

archive/issue_comments_462631.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nMoving the cleaning targets to the top-level Makefile could make sense.\n\nMost of the above lines really don't need configured variables.\n\nFor cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):\n\nAs you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).\n\nSo it only matters what is to be done when `SAGE_LOCAL` has been set to something else.\n\nTo run a line such as `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.\n\nI'm not sure about `rm -rf \"$(SAGE_SHARE)/doc/sage\"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.\n(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)",
    "created_at": "2021-10-29T02:32:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462631",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'>Comment 12:</a>
Moving the cleaning targets to the top-level Makefile could make sense.

Most of the above lines really don't need configured variables.

For cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):

As you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).

So it only matters what is to be done when `SAGE_LOCAL` has been set to something else.

To run a line such as `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.

I'm not sure about `rm -rf "$(SAGE_SHARE)/doc/sage"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.
(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)



---

archive/issue_comments_462632.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)**",
    "created_at": "2021-10-29T05:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462632",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)**



---

archive/issue_comments_462633.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nHere is an attempt. A few comments:\n- I added the line `if [ -d \"$(SAGE_SRC)\" ]; then \\` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.\n- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.\n \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6\">c7cfd31</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr></table>\n",
    "created_at": "2021-10-29T05:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462633",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'>Comment 14:</a>
Here is an attempt. A few comments:
- I added the line `if [ -d "$(SAGE_SRC)" ]; then \` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.
- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.
 
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6">c7cfd31</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr></table>




---

archive/issue_comments_462634.json:
```json
{
    "body": "Commit: **[c7cfd31](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)**",
    "created_at": "2021-10-29T05:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462634",
    "user": "https://github.com/jhpalmieri"
}
```

Commit: **[c7cfd31](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)**



---

archive/issue_comments_462635.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nOh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like\n\n```\nSAGE_ROOT = $$(pwd)\n\nclean-test:\n    echo $(SAGE_ROOT)\n```\nthen `make clean-test` would print\n\n```\necho $(pwd)\n/Users/palmieri/....\n```\nWith the current version, if I add the same target `clean-test`, then `make clean-test` prints\n\n```\necho /Users/...\n/Users/...\n```\nIt seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.",
    "created_at": "2021-10-29T05:26:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462635",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'>Comment 15:</a>
Oh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like

```
SAGE_ROOT = $$(pwd)

clean-test:
    echo $(SAGE_ROOT)
```
then `make clean-test` would print

```
echo $(pwd)
/Users/palmieri/....
```
With the current version, if I add the same target `clean-test`, then `make clean-test` prints

```
echo /Users/...
/Users/...
```
It seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.



---

archive/issue_comments_462636.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nTry `$(CURDIR)`",
    "created_at": "2021-10-29T05:32:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462636",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'>Comment 16:</a>
Try `$(CURDIR)`



---

archive/issue_comments_462637.json:
```json
{
    "body": "Changed commit from **[c7cfd31](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)** to **[d3d1405](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)**",
    "created_at": "2021-10-29T16:03:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462637",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c7cfd31](https://github.com/sagemath/sagetrac-mirror/commit/c7cfd313ace5d6ae7a847a8d6fb69d20951527d6)** to **[d3d1405](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)**



---

archive/issue_comments_462638.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b\">d3d1405</a></td><td><code>trac 29310: use CURDIR</code></td></tr></table>\n",
    "created_at": "2021-10-29T16:03:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462638",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>Comment 17:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b">d3d1405</a></td><td><code>trac 29310: use CURDIR</code></td></tr></table>




---

archive/issue_comments_462639.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nReplying to [@mkoeppe](#comment%3A16):\n> Try `$(CURDIR)`\n\nThanks, done.",
    "created_at": "2021-10-29T16:04:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462639",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'>Comment 18:</a>
Replying to [@mkoeppe](#comment%3A16):
> Try `$(CURDIR)`

Thanks, done.



---

archive/issue_events_371361.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371361"
}
```



---

archive/issue_events_371362.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371362"
}
```



---

archive/issue_comments_462640.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nI think this is ready for review.",
    "created_at": "2021-12-16T00:05:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462640",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'>Comment 20:</a>
I think this is ready for review.



---

archive/issue_events_371363.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-12-16T00:05:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371363"
}
```



---

archive/issue_comments_462641.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2021-12-16T00:06:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462641",
    "user": "https://github.com/jhpalmieri"
}
```

Author: **John Palmieri**



---

archive/issue_comments_462642.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\n\n```\n+SAGE_ROOT ?= $(CURDIR)\n+SAGE_SRC ?= $(SAGE_ROOT)/src\n```\nI think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here",
    "created_at": "2021-12-17T06:33:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462642",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'>Comment 22:</a>

```
+SAGE_ROOT ?= $(CURDIR)
+SAGE_SRC ?= $(SAGE_ROOT)/src
```
I think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here



---

archive/issue_comments_462643.json:
```json
{
    "body": "Changed commit from **[d3d1405](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)** to **[67d69da](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)**",
    "created_at": "2021-12-17T19:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462643",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d3d1405](https://github.com/sagemath/sagetrac-mirror/commit/d3d14055243d3ef2d20a061061be952aca82f34b)** to **[67d69da](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)**



---

archive/issue_comments_462644.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f53be617a02a63d21e5efdbae52a576a61561bf4\">f53be61</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a7712e76582b2cae22f1156d678169471dba4cd\">3a7712e</a></td><td><code>trac 29310: use CURDIR</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e\">67d69da</a></td><td><code>trac 29310: use \"=\" instead of \"?=\"</code></td></tr></table>\n",
    "created_at": "2021-12-17T19:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462644",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:23'>Comment 23:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f53be617a02a63d21e5efdbae52a576a61561bf4">f53be61</a></td><td><code>trac 29310: move various ...-clean targets to top-level Makefile</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a7712e76582b2cae22f1156d678169471dba4cd">3a7712e</a></td><td><code>trac 29310: use CURDIR</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e">67d69da</a></td><td><code>trac 29310: use "=" instead of "?="</code></td></tr></table>




---

archive/issue_comments_462645.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nFixed, thanks.",
    "created_at": "2021-12-17T19:45:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462645",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:24'>Comment 24:</a>
Fixed, thanks.



---

archive/issue_comments_462646.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\n\n```\n+clean:\n+\t@echo \"Deleting package build directories...\"\n+\tif [ -x \"$(SAGE_SRC)\"/bin/sage-env-config ]; then \\\n+\t    . \"$(SAGE_SRC)\"/bin/sage-env-config; \\\n+            rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"; \\\n+\tfi\n```\nThe reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.\n\nAlso, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...",
    "created_at": "2021-12-20T23:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462646",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'>Comment 25:</a>

```
+clean:
+	@echo "Deleting package build directories..."
+	if [ -x "$(SAGE_SRC)"/bin/sage-env-config ]; then \
+	    . "$(SAGE_SRC)"/bin/sage-env-config; \
+            rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
+	fi
```
The reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.

Also, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...



---

archive/issue_comments_462647.json:
```json
{
    "body": "Changed commit from **[67d69da](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)** to **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**",
    "created_at": "2021-12-21T03:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462647",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[67d69da](https://github.com/sagemath/sagetrac-mirror/commit/67d69da24a88e4d357ce834cb7fd229b93bf770e)** to **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**



---

archive/issue_comments_462648.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2\">e28f093</a></td><td><code>trac 29310: use $$SAGE_LOCAL instead of $(SAGE_LOCAL) --</code></td></tr></table>\n",
    "created_at": "2021-12-21T03:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462648",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:26'>Comment 26:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2">e28f093</a></td><td><code>trac 29310: use $$SAGE_LOCAL instead of $(SAGE_LOCAL) --</code></td></tr></table>




---

archive/issue_comments_462649.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nIt was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.",
    "created_at": "2021-12-21T03:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462649",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>Comment 27:</a>
It was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.



---

archive/issue_events_371364.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-23T05:14:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371364"
}
```



---

archive/issue_events_371365.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-23T05:14:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371365"
}
```



---

archive/issue_comments_462650.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nLGTM and seems to work well.",
    "created_at": "2021-12-23T05:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462650",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'>Comment 28:</a>
LGTM and seems to work well.



---

archive/issue_comments_462651.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2021-12-23T05:32:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462651",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_462652.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nThank you!",
    "created_at": "2021-12-23T19:06:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462652",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:30'>Comment 30:</a>
Thank you!



---

archive/issue_comments_462653.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)** to **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**",
    "created_at": "2021-12-28T21:15:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462653",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jhpalmieri/distclean](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/distclean)** to **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)**



---

archive/issue_events_371366.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-28T21:15:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371366"
}
```



---

archive/issue_events_371367.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "da90b23cc93a49f16196664c0132bb5f15127b96",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-12-28T21:15:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371367"
}
```



---

archive/issue_events_371368.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-28T21:18:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371368"
}
```



---

archive/issue_events_371369.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-28T21:18:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29310#event-371369"
}
```



---

archive/issue_comments_462654.json:
```json
{
    "body": "Changed commit from **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)** to none",
    "created_at": "2021-12-28T21:18:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29310#issuecomment-462654",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[e28f093](https://github.com/sagemath/sagetrac-mirror/commit/e28f0934ce9619c4eb13b45b015165d8804829c2)** to none
