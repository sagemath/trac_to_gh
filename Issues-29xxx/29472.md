# Issue 29472: Modify doctest such that they work with pari >= 2.11.3 and pari < 2.11.3

archive/issues_029235.json:
```json
{
    "assignees": [],
    "body": "As we allow sage to use a system pari from version 2.11.1 we modify the doctests such that they pass with both pari versions.\n\nAll of those failures are due to different choices of representation or to small differences in precision.\n\nCurrently, there are failing doctests in debian-sid [https://github.com/kliem/sage-test-27122/runs/560405581](https://github.com/kliem/sage-test-27122/runs/560405581), which is (correctly) not fixed by #29445 (debian sid uses pari (2.11.4~pre1-1), which contains no serious bug that we are aware of).\n\nFollow up: #29313.\n\n**CC:**  @mkoeppe @orlitzky @fchapoton\n\n**Branch/Commit:** [4f86bc37571a3c7912edb94d2976f857b93662b1](https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1)\n\n**Reviewer:** Dima Pasechnik\n\n**Author:** Jonathan Kliem\n\nIssue created by migration from https://trac.sagemath.org/ticket/29472\n\n",
    "closed_at": "2020-06-22T22:34:20Z",
    "created_at": "2020-04-06T16:07:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Modify doctest such that they work with pari >= 2.11.3 and pari < 2.11.3",
    "type": "issue",
    "updated_at": "2020-06-22T22:34:20Z",
    "url": "https://github.com/sagemath/sage/issues/29472",
    "user": "https://github.com/kliem"
}
```
As we allow sage to use a system pari from version 2.11.1 we modify the doctests such that they pass with both pari versions.

All of those failures are due to different choices of representation or to small differences in precision.

Currently, there are failing doctests in debian-sid [https://github.com/kliem/sage-test-27122/runs/560405581](https://github.com/kliem/sage-test-27122/runs/560405581), which is (correctly) not fixed by #29445 (debian sid uses pari (2.11.4~pre1-1), which contains no serious bug that we are aware of).

Follow up: #29313.

**CC:**  @mkoeppe @orlitzky @fchapoton

**Branch/Commit:** [4f86bc37571a3c7912edb94d2976f857b93662b1](https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1)

**Reviewer:** Dima Pasechnik

**Author:** Jonathan Kliem

Issue created by migration from https://trac.sagemath.org/ticket/29472





---

archive/issue_events_355658.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-06T16:07:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355658"
}
```



---

archive/issue_events_355659.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-06T16:07:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
    "label_color": "08517b",
    "label_name": "component: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355659"
}
```



---

archive/issue_events_355660.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-06T16:07:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355660"
}
```



---

archive/issue_comments_465977.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda\">ca4ee7d</a></td><td><code>modify doctests such that they work with various pari verions</code></td></tr></table>\n",
    "created_at": "2020-04-06T16:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465977",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda">ca4ee7d</a></td><td><code>modify doctests such that they work with various pari verions</code></td></tr></table>




---

archive/issue_comments_465978.json:
```json
{
    "body": "**Branch:** [public/29472](https://github.com/sagemath/sagetrac-mirror/tree/public/29472)",
    "created_at": "2020-04-06T16:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465978",
    "user": "https://github.com/kliem"
}
```

**Branch:** [public/29472](https://github.com/sagemath/sagetrac-mirror/tree/public/29472)



---

archive/issue_comments_465979.json:
```json
{
    "body": "**Commit:** [ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda](https://github.com/sagemath/sagetrac-mirror/commit/ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda)",
    "created_at": "2020-04-06T16:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465979",
    "user": "https://github.com/kliem"
}
```

**Commit:** [ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda](https://github.com/sagemath/sagetrac-mirror/commit/ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda)



---

archive/issue_comments_465980.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/98bfefda186e4c7992f7120b5956b5b41bfdcbb3\">98bfefd</a></td><td><code>small fix</code></td></tr></table>\n",
    "created_at": "2020-04-06T16:24:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465980",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/98bfefda186e4c7992f7120b5956b5b41bfdcbb3">98bfefd</a></td><td><code>small fix</code></td></tr></table>




---

archive/issue_comments_465981.json:
```json
{
    "body": "**Changing commit** from \"[ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda](https://github.com/sagemath/sagetrac-mirror/commit/ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda)\" to \"[98bfefda186e4c7992f7120b5956b5b41bfdcbb3](https://github.com/sagemath/sagetrac-mirror/commit/98bfefda186e4c7992f7120b5956b5b41bfdcbb3)\".",
    "created_at": "2020-04-06T16:24:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465981",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda](https://github.com/sagemath/sagetrac-mirror/commit/ca4ee7d644ff3ee45b2c6e6c9ae8b5a08c54abda)" to "[98bfefda186e4c7992f7120b5956b5b41bfdcbb3](https://github.com/sagemath/sagetrac-mirror/commit/98bfefda186e4c7992f7120b5956b5b41bfdcbb3)".



---

archive/issue_events_355661.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-06T16:25:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355661"
}
```



---

archive/issue_comments_465982.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis seems to work.\n\nThe failing doctests related to pari for debian sid are gone and the tests still pass e.g. on debian buster:\n\n[https://github.com/kliem/sage-test-27122/actions/runs/72102779](https://github.com/kliem/sage-test-27122/actions/runs/72102779)",
    "created_at": "2020-04-07T09:02:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465982",
    "user": "https://github.com/kliem"
}
```

<a id='comment:4'></a>
This seems to work.

The failing doctests related to pari for debian sid are gone and the tests still pass e.g. on debian buster:

[https://github.com/kliem/sage-test-27122/actions/runs/72102779](https://github.com/kliem/sage-test-27122/actions/runs/72102779)



---

archive/issue_comments_465983.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm surprised this works:\n\n```\nTESTS:\n\nWe test the above doctest. The representation depends on the PARI version::\n\n    sage: [x] = [K.uniformizer(P) for P,e in factor(K.ideal(7))]\n    sage: x in (t^2 + 3*t +1, t^2 - 4*t +1)\n    True\n```\n\nI thought that `::` cleared the global `K`. In any case, I would recommend reconstructing `K` here so that the test doesn't break if someone adds another example to the end of the `EXAMPLES:` block above it (and likewise for the other \"test the above doctest\" tests).",
    "created_at": "2020-04-10T12:52:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465983",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>
I'm surprised this works:

```
TESTS:

We test the above doctest. The representation depends on the PARI version::

    sage: [x] = [K.uniformizer(P) for P,e in factor(K.ideal(7))]
    sage: x in (t^2 + 3*t +1, t^2 - 4*t +1)
    True
```

I thought that `::` cleared the global `K`. In any case, I would recommend reconstructing `K` here so that the test doesn't break if someone adds another example to the end of the `EXAMPLES:` block above it (and likewise for the other "test the above doctest" tests).



---

archive/issue_comments_465984.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/855098cb2f1c8d88592c2cb021bdb1bf099121fd\">855098c</a></td><td><code>create the context for the tests locally</code></td></tr></table>\n",
    "created_at": "2020-04-10T13:31:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465984",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/855098cb2f1c8d88592c2cb021bdb1bf099121fd">855098c</a></td><td><code>create the context for the tests locally</code></td></tr></table>




---

archive/issue_comments_465985.json:
```json
{
    "body": "**Changing commit** from \"[98bfefda186e4c7992f7120b5956b5b41bfdcbb3](https://github.com/sagemath/sagetrac-mirror/commit/98bfefda186e4c7992f7120b5956b5b41bfdcbb3)\" to \"[855098cb2f1c8d88592c2cb021bdb1bf099121fd](https://github.com/sagemath/sagetrac-mirror/commit/855098cb2f1c8d88592c2cb021bdb1bf099121fd)\".",
    "created_at": "2020-04-10T13:31:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465985",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[98bfefda186e4c7992f7120b5956b5b41bfdcbb3](https://github.com/sagemath/sagetrac-mirror/commit/98bfefda186e4c7992f7120b5956b5b41bfdcbb3)" to "[855098cb2f1c8d88592c2cb021bdb1bf099121fd](https://github.com/sagemath/sagetrac-mirror/commit/855098cb2f1c8d88592c2cb021bdb1bf099121fd)".



---

archive/issue_comments_465986.json:
```json
{
    "body": "<a id='comment:8'></a>\nI do this in many places, as in \n\n```\n\nA polyhedron::\n\n    sage: P = polytopes.cube()\n\nThe f-vector::\n\n    sage: P.f_vector()\n    (1, 8, 12, 6, 1)\n```\n\nHowever, this can be really annoying when you have tests in the test section that rely on stuff way above. So I changed it. It is also easier to read the tests in that way.\n\nReplying to [@orlitzky](#comment%3A6):\n> I'm surprised this works:\n> \n> ```\n> TESTS:\n> \n> We test the above doctest. The representation depends on the PARI version::\n> \n>     sage: [x] = [K.uniformizer(P) for P,e in factor(K.ideal(7))]\n>     sage: x in (t^2 + 3*t +1, t^2 - 4*t +1)\n>     True\n> ```\n> \n> I thought that `::` cleared the global `K`. In any case, I would recommend reconstructing `K` here so that the test doesn't break if someone adds another example to the end of the `EXAMPLES:` block above it (and likewise for the other \"test the above doctest\" tests).",
    "created_at": "2020-04-10T13:34:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465986",
    "user": "https://github.com/kliem"
}
```

<a id='comment:8'></a>
I do this in many places, as in 

```

A polyhedron::

    sage: P = polytopes.cube()

The f-vector::

    sage: P.f_vector()
    (1, 8, 12, 6, 1)
```

However, this can be really annoying when you have tests in the test section that rely on stuff way above. So I changed it. It is also easier to read the tests in that way.

Replying to [@orlitzky](#comment%3A6):
> I'm surprised this works:
> 
> ```
> TESTS:
> 
> We test the above doctest. The representation depends on the PARI version::
> 
>     sage: [x] = [K.uniformizer(P) for P,e in factor(K.ideal(7))]
>     sage: x in (t^2 + 3*t +1, t^2 - 4*t +1)
>     True
> ```
> 
> I thought that `::` cleared the global `K`. In any case, I would recommend reconstructing `K` here so that the test doesn't break if someone adds another example to the end of the `EXAMPLES:` block above it (and likewise for the other "test the above doctest" tests).



---

archive/issue_comments_465987.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1\">4f86bc3</a></td><td><code>fix failing doctest</code></td></tr></table>\n",
    "created_at": "2020-04-10T15:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465987",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1">4f86bc3</a></td><td><code>fix failing doctest</code></td></tr></table>




---

archive/issue_comments_465988.json:
```json
{
    "body": "**Changing commit** from \"[855098cb2f1c8d88592c2cb021bdb1bf099121fd](https://github.com/sagemath/sagetrac-mirror/commit/855098cb2f1c8d88592c2cb021bdb1bf099121fd)\" to \"[4f86bc37571a3c7912edb94d2976f857b93662b1](https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1)\".",
    "created_at": "2020-04-10T15:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465988",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[855098cb2f1c8d88592c2cb021bdb1bf099121fd](https://github.com/sagemath/sagetrac-mirror/commit/855098cb2f1c8d88592c2cb021bdb1bf099121fd)" to "[4f86bc37571a3c7912edb94d2976f857b93662b1](https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1)".



---

archive/issue_comments_465989.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis doesn't need to be done any more if the ./configure script is going to reject anything other than a patched 2.11.3.",
    "created_at": "2020-04-11T21:00:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465989",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:10'></a>
This doesn't need to be done any more if the ./configure script is going to reject anything other than a patched 2.11.3.



---

archive/issue_comments_465990.json:
```json
{
    "body": "<a id='comment:11'></a>\nWas this the decision made to reject 2.11.2 as well? But yes, this ticket is not needed anymore if we only accept a patched 2.11.3 (Deban sid has 2.11.4 beta, which works also fine, but that's not the point). I'm still hoping that distributions will patch their packages, but who knows if that is going to happen.\n\nAlso by the automated testing we will catch on, if this is happening and we can still do this ticket then.\n\nAlso we really should make some general decisions what kind of doctest failures justify a reject and how we proceed if we don't reject.",
    "created_at": "2020-04-12T19:15:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465990",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>
Was this the decision made to reject 2.11.2 as well? But yes, this ticket is not needed anymore if we only accept a patched 2.11.3 (Deban sid has 2.11.4 beta, which works also fine, but that's not the point). I'm still hoping that distributions will patch their packages, but who knows if that is going to happen.

Also by the automated testing we will catch on, if this is happening and we can still do this ticket then.

Also we really should make some general decisions what kind of doctest failures justify a reject and how we proceed if we don't reject.



---

archive/issue_comments_465991.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [@kliem](#comment%3A11):\n> Was this the decision made to reject 2.11.2 as well? \n\nNo such decision has been made.\nI think you should make a decision which versions to support based on your knowledge about the details of these doctests.",
    "created_at": "2020-04-12T19:18:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465991",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
Replying to [@kliem](#comment%3A11):
> Was this the decision made to reject 2.11.2 as well? 

No such decision has been made.
I think you should make a decision which versions to support based on your knowledge about the details of these doctests.



---

archive/issue_comments_465992.json:
```json
{
    "body": "<a id='comment:13'></a>\nubuntu eoan has pari 2.11.2-2 and this seems to work perfectly fine with our doctests.\n\n[https://github.com/kliem/sage-test-27122/runs/560405517](https://github.com/kliem/sage-test-27122/runs/560405517)\n\nThe doctests in this ticket are all about representation, I have to admit that I trusted our code in some ways:\n\n- I haven't looked all the way into `optimized_representation`, but both choices seem fine to me,\n- `/src/sage/rings/polynomial/polynomial_quotient_ring.py`, `S.S_class_group([])`: from the documentation I understand that any `QQ`-base exchange is fine\n- for the global integral model I'm completely relying on `is_global_integral_model`\n\nSo for our doctests pari 2.11.2 or patched pari 2.11.3 work fine (or pari 2.11.4 beta). There are probably other bugs, but I have no clue.",
    "created_at": "2020-04-12T19:41:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465992",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>
ubuntu eoan has pari 2.11.2-2 and this seems to work perfectly fine with our doctests.

[https://github.com/kliem/sage-test-27122/runs/560405517](https://github.com/kliem/sage-test-27122/runs/560405517)

The doctests in this ticket are all about representation, I have to admit that I trusted our code in some ways:

- I haven't looked all the way into `optimized_representation`, but both choices seem fine to me,
- `/src/sage/rings/polynomial/polynomial_quotient_ring.py`, `S.S_class_group([])`: from the documentation I understand that any `QQ`-base exchange is fine
- for the global integral model I'm completely relying on `is_global_integral_model`

So for our doctests pari 2.11.2 or patched pari 2.11.3 work fine (or pari 2.11.4 beta). There are probably other bugs, but I have no clue.



---

archive/issue_comments_465993.json:
```json
{
    "body": "<a id='comment:14'></a>\nSince it only takes two people to make a change, and since there are two antipodal views on which changes should be made, it would be good to come to an agreement even if we have to vote on it on sage-devel. I'm de-motivated to work on this stuff when it's just Matthias and I who want to do opposite things, but I would suck it up if the consensus is against me.\n\nThe question is, essentially: should we have/add doctests for upstream bugs in/to the sage library?\n\nIf yes, we tend to force the latest (and possibly patched) versions of sage's dependencies, because every new version of a dependency likely fixes *some* math bug that we can add a doctest for. The upside is that we can ensure that users who download and build sage themselves (even if they have to build a bunch of custom SPKGs) get a known quantity.\n\nIf no, then we can accept slightly older system packages and sage's test suite will still pass. This saves a lot of time while building sage, but can delay bugfixes until distributions ship them or upgrade their packages. In other words, system dependencies are the responsibility of packagers, but if you don't like that you can use the SPKG instead.\n\nCase in point: this equivalence I posted on #29494 should be symmetric, but isn't.\n\n```\nsage: M1 = matrix(ZZ,[[16,6],[6,10]])\nsage: M2 = matrix(ZZ,[[4,3],[3,10]])\nsage: Q1 = QuadraticForm(M1)\nsage: Q2 = QuadraticForm(M2)\nsage: Q1.is_globally_equivalent_to(Q2)\nFalse\nsage: Q2.is_globally_equivalent_to(Q1)\nTrue\n```\n\nThat bug was fixed in pari-2.11.3. The first view says we should add a doctest for that, and thereafter bump the minimum required version of pari to the latest (patched) 2.11.3. The second view says that the bug is fixed upstream and isn't going to come back, so we don't need to test it in sagelib, and it's OK if users who have installed pari-2.11.2 on their system experience the bug until they upgrade (i.e. we should still let them use 2.11.2 if that's what they have).\n\nThis ticket is only relevant in that it emphasizes how doctests are a side-channel for introducing version constraints.",
    "created_at": "2020-04-12T20:10:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465993",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:14'></a>
Since it only takes two people to make a change, and since there are two antipodal views on which changes should be made, it would be good to come to an agreement even if we have to vote on it on sage-devel. I'm de-motivated to work on this stuff when it's just Matthias and I who want to do opposite things, but I would suck it up if the consensus is against me.

The question is, essentially: should we have/add doctests for upstream bugs in/to the sage library?

If yes, we tend to force the latest (and possibly patched) versions of sage's dependencies, because every new version of a dependency likely fixes *some* math bug that we can add a doctest for. The upside is that we can ensure that users who download and build sage themselves (even if they have to build a bunch of custom SPKGs) get a known quantity.

If no, then we can accept slightly older system packages and sage's test suite will still pass. This saves a lot of time while building sage, but can delay bugfixes until distributions ship them or upgrade their packages. In other words, system dependencies are the responsibility of packagers, but if you don't like that you can use the SPKG instead.

Case in point: this equivalence I posted on #29494 should be symmetric, but isn't.

```
sage: M1 = matrix(ZZ,[[16,6],[6,10]])
sage: M2 = matrix(ZZ,[[4,3],[3,10]])
sage: Q1 = QuadraticForm(M1)
sage: Q2 = QuadraticForm(M2)
sage: Q1.is_globally_equivalent_to(Q2)
False
sage: Q2.is_globally_equivalent_to(Q1)
True
```

That bug was fixed in pari-2.11.3. The first view says we should add a doctest for that, and thereafter bump the minimum required version of pari to the latest (patched) 2.11.3. The second view says that the bug is fixed upstream and isn't going to come back, so we don't need to test it in sagelib, and it's OK if users who have installed pari-2.11.2 on their system experience the bug until they upgrade (i.e. we should still let them use 2.11.2 if that's what they have).

This ticket is only relevant in that it emphasizes how doctests are a side-channel for introducing version constraints.



---

archive/issue_comments_465994.json:
```json
{
    "body": "<a id='comment:15'></a>\nI also think that a discussion on sage-devel -- on the general topic of the relation of sage-the-distribution and the sage doctests -- would be valuable. The specific decision on pari is not very important to me (though the bug on quadratic forms looks pretty serious to me).\n\nI would suggest to do this right after the 9.1 release, though, not now. \n\nA lot of spkg-configure tickets have been / are being merged in 9.1.  Developers who have not followed the last betas should get a chance to  familiarize themselves with the technical status of supporting distribution packages in the new release.",
    "created_at": "2020-04-12T20:42:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465994",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
I also think that a discussion on sage-devel -- on the general topic of the relation of sage-the-distribution and the sage doctests -- would be valuable. The specific decision on pari is not very important to me (though the bug on quadratic forms looks pretty serious to me).

I would suggest to do this right after the 9.1 release, though, not now. 

A lot of spkg-configure tickets have been / are being merged in 9.1.  Developers who have not followed the last betas should get a chance to  familiarize themselves with the technical status of supporting distribution packages in the new release.



---

archive/issue_events_355662.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-14T10:07:00Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355662"
}
```



---

archive/issue_events_355663.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-14T10:07:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355663"
}
```



---

archive/issue_events_355664.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-14T10:07:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355664"
}
```



---

archive/issue_events_355665.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-14T10:07:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355665"
}
```



---

archive/issue_comments_465995.json:
```json
{
    "body": "<a id='comment:16'></a>\nOk, let's wait and see how we decide on things.",
    "created_at": "2020-04-14T10:07:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465995",
    "user": "https://github.com/kliem"
}
```

<a id='comment:16'></a>
Ok, let's wait and see how we decide on things.



---

archive/issue_comments_465996.json:
```json
{
    "body": "<a id='comment:18'></a>\nOn this one it's probably not too muich work to make tests formatting-independent.\nI can give it a go, although I'm far from NT, so I might not know what happens in a particular place.",
    "created_at": "2020-06-18T13:56:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465996",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>
On this one it's probably not too muich work to make tests formatting-independent.
I can give it a go, although I'm far from NT, so I might not know what happens in a particular place.



---

archive/issue_comments_465997.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@dimpase](#comment%3A18):\n> On this one it's probably not too muich work to make tests formatting-independent.\n> I can give it a go, although I'm far from NT, so I might not know what happens in a particular place.\n\nMaking the tests more robust is valuable in and of itself, but the only reason this isn't done yet is because we weren't sure if it was going to be a waste of time. I think we should support a few recent versions of a package if there's no API breakage, but Matthias thinks we should add doctests (and ./configure tests) for upstream math bugs, essentially limiting support to the latest version. If we do that, then there's no reason to make the tests flexible, because the ./configure script will have to reject all but the latest version to keep the test suite working.\n\nAside: I'm terrified to review anything inside this dependency-branch-rebase house of cards.",
    "created_at": "2020-06-18T21:09:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465997",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:19'></a>
Replying to [@dimpase](#comment%3A18):
> On this one it's probably not too muich work to make tests formatting-independent.
> I can give it a go, although I'm far from NT, so I might not know what happens in a particular place.

Making the tests more robust is valuable in and of itself, but the only reason this isn't done yet is because we weren't sure if it was going to be a waste of time. I think we should support a few recent versions of a package if there's no API breakage, but Matthias thinks we should add doctests (and ./configure tests) for upstream math bugs, essentially limiting support to the latest version. If we do that, then there's no reason to make the tests flexible, because the ./configure script will have to reject all but the latest version to keep the test suite working.

Aside: I'm terrified to review anything inside this dependency-branch-rebase house of cards.



---

archive/issue_comments_465998.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@orlitzky](#comment%3A19):\n> ... essentially limiting support to the latest version ...\n\n... or distribution's version with backported patches ...",
    "created_at": "2020-06-19T00:59:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465998",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
Replying to [@orlitzky](#comment%3A19):
> ... essentially limiting support to the latest version ...

... or distribution's version with backported patches ...



---

archive/issue_comments_465999.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [@mkoeppe](#comment%3A20):\n> Replying to [@orlitzky](#comment%3A19):\n> > ... essentially limiting support to the latest version ...\n\n> ... or distribution's version with backported patches ...\n\nWhen we backport, it takes at least another 30 days (and requires several other developers to act) before those changes hit the stable tree, so that's not as simple as it sounds. But more to the point, I have better things to do than backport patches for hundreds of packages and file thousands of stabilization requests and track them throughout the day, all day, every day. That's what new versions are for, and it's already hard to keep up. Some critical fixes do have to be backported when a release is a complete dud, but it's just not feasible to backport every bugfix that can somehow affect sage. All of the time I and the other distribution developers spend pushing rocks up hills can't be spent on something more useful.",
    "created_at": "2020-06-19T02:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-465999",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:21'></a>
Replying to [@mkoeppe](#comment%3A20):
> Replying to [@orlitzky](#comment%3A19):
> > ... essentially limiting support to the latest version ...

> ... or distribution's version with backported patches ...

When we backport, it takes at least another 30 days (and requires several other developers to act) before those changes hit the stable tree, so that's not as simple as it sounds. But more to the point, I have better things to do than backport patches for hundreds of packages and file thousands of stabilization requests and track them throughout the day, all day, every day. That's what new versions are for, and it's already hard to keep up. Some critical fixes do have to be backported when a release is a complete dud, but it's just not feasible to backport every bugfix that can somehow affect sage. All of the time I and the other distribution developers spend pushing rocks up hills can't be spent on something more useful.



---

archive/issue_comments_466000.json:
```json
{
    "body": "<a id='comment:22'></a>\nOf course. With my comment above, I'm certainly not requesting any backports from you or the gentoo developers.",
    "created_at": "2020-06-19T02:25:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466000",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>
Of course. With my comment above, I'm certainly not requesting any backports from you or the gentoo developers.



---

archive/issue_comments_466001.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [@mkoeppe](#comment%3A22):\n> Of course. With my comment above, I'm certainly not requesting any backports from you or the gentoo developers.\n\nIntentionally or not, you're requesting backports from every distribution maintainer when you reject a system packages for lack of a bugfix.",
    "created_at": "2020-06-19T02:50:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466001",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:23'></a>
Replying to [@mkoeppe](#comment%3A22):
> Of course. With my comment above, I'm certainly not requesting any backports from you or the gentoo developers.

Intentionally or not, you're requesting backports from every distribution maintainer when you reject a system packages for lack of a bugfix.



---

archive/issue_comments_466002.json:
```json
{
    "body": "<a id='comment:24'></a>\nAs it is, the ticket still appears to be working.\n\nMathematically our own doctests are correct with pari 2.11.2 and pari 2.11.4 and this ticket merely acknowledges this.\n\nI think this ticket is still valuable, because now we can update pari to 2.11.4 without having to modify the doctests (and therefore leading to annoying failures with older versions). So the decision to update pari and to reject older version is then independent.",
    "created_at": "2020-06-19T08:06:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466002",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>
As it is, the ticket still appears to be working.

Mathematically our own doctests are correct with pari 2.11.2 and pari 2.11.4 and this ticket merely acknowledges this.

I think this ticket is still valuable, because now we can update pari to 2.11.4 without having to modify the doctests (and therefore leading to annoying failures with older versions). So the decision to update pari and to reject older version is then independent.



---

archive/issue_events_355666.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-19T08:06:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355666"
}
```



---

archive/issue_events_355667.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-19T08:06:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355667"
}
```



---

archive/issue_comments_466003.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2020-06-19T08:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466003",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_comments_466004.json:
```json
{
    "body": "<a id='comment:25'></a>\nok, testing!",
    "created_at": "2020-06-19T08:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466004",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
ok, testing!



---

archive/issue_events_355668.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-19T11:30:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355668"
}
```



---

archive/issue_events_355669.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-19T11:30:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355669"
}
```



---

archive/issue_comments_466005.json:
```json
{
    "body": "<a id='comment:26'></a>\nthis works well with system's pari 2.11.4 (as provided by Gentoo Linux).",
    "created_at": "2020-06-19T11:30:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466005",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
this works well with system's pari 2.11.4 (as provided by Gentoo Linux).



---

archive/issue_comments_466006.json:
```json
{
    "body": "<a id='comment:27'></a>\nThank you.",
    "created_at": "2020-06-19T11:37:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466006",
    "user": "https://github.com/kliem"
}
```

<a id='comment:27'></a>
Thank you.



---

archive/issue_comments_466007.json:
```json
{
    "body": "**Changing branch** from \"[public/29472](https://github.com/sagemath/sagetrac-mirror/tree/public/29472)\" to \"[4f86bc37571a3c7912edb94d2976f857b93662b1](https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1)\".",
    "created_at": "2020-06-22T22:34:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29472#issuecomment-466007",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/29472](https://github.com/sagemath/sagetrac-mirror/tree/public/29472)" to "[4f86bc37571a3c7912edb94d2976f857b93662b1](https://github.com/sagemath/sagetrac-mirror/commit/4f86bc37571a3c7912edb94d2976f857b93662b1)".



---

archive/issue_events_355670.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-22T22:34:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355670"
}
```



---

archive/issue_events_355671.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "0d23704b3f66b278d95b040ed22965691ca916f3",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-06-22T22:34:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29472",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29472#event-355671"
}
```
