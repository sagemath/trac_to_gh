# Issue 29893: Another speedup of hypergeometric trace formula

archive/issues_029656.json:
```json
{
    "body": "It seems that in earlier tickets meant to speed up the computation of the hypergeometric trace formula (especially #28902), the optimization of using symmetry in the trace formula for `p**f` when `f>1` did not get applied fully. Here we address this.\n\nThe status quo:\n\n```\nsage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp\nsage: H = Hyp(cyclotomic=([4,2,2],[3,3]))\nsage: time H.padic_H_value(next_prime(4096), 2, 1337)\nCPU times: user 47.9 s, sys: 456 ms, total: 48.4 s\nWall time: 48.4 s\n-5526\n```\nThis is already beating Magma (v2.24-9):\n\n```\n> H := HypergeometricData([4,2,2],[3,3]);\n> time HypergeometricTrace(H, 1/1337, 4099^2);\n-5526\nTime: 84.140\n```\nBut there is still room for improvement. (Restart Sage to suppress cacheing.)\n\n```\nsage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp\nsage: H = Hyp(cyclotomic=([4,2,2],[3,3]))\nsage: time H.padic_H_value(next_prime(4096), 2, 1337)\nCPU times: user 32.9 s, sys: 1.1 s, total: 34 s\nWall time: 34 s\n-5526\n```\n\nCC:  @roed314 @edgarcosta\n\nKeywords: hypergeometric trace formula\n\nBranch/Commit: ad2888b6047c8180a787e16832770315bfa11728\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Kiran Kedlaya\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29893\n\n",
    "closed_at": "2020-07-08T19:34:05Z",
    "created_at": "2020-06-18T13:53:31Z",
    "labels": [
        "component: modular forms"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Another speedup of hypergeometric trace formula",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29893",
    "user": "https://github.com/kedlaya"
}
```
It seems that in earlier tickets meant to speed up the computation of the hypergeometric trace formula (especially #28902), the optimization of using symmetry in the trace formula for `p**f` when `f>1` did not get applied fully. Here we address this.

The status quo:

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp
sage: H = Hyp(cyclotomic=([4,2,2],[3,3]))
sage: time H.padic_H_value(next_prime(4096), 2, 1337)
CPU times: user 47.9 s, sys: 456 ms, total: 48.4 s
Wall time: 48.4 s
-5526
```
This is already beating Magma (v2.24-9):

```
> H := HypergeometricData([4,2,2],[3,3]);
> time HypergeometricTrace(H, 1/1337, 4099^2);
-5526
Time: 84.140
```
But there is still room for improvement. (Restart Sage to suppress cacheing.)

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp
sage: H = Hyp(cyclotomic=([4,2,2],[3,3]))
sage: time H.padic_H_value(next_prime(4096), 2, 1337)
CPU times: user 32.9 s, sys: 1.1 s, total: 34 s
Wall time: 34 s
-5526
```

CC:  @roed314 @edgarcosta

Keywords: hypergeometric trace formula

Branch/Commit: ad2888b6047c8180a787e16832770315bfa11728

Reviewer: Frédéric Chapoton

Author: Kiran Kedlaya

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29893





---

archive/issue_comments_586636.json:
```json
{
    "body": "Changing branch from \"\" to \"u/kedlaya/speed_up_hgm_coeffs\"",
    "created_at": "2020-06-18T13:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586636",
    "user": "https://github.com/kedlaya"
}
```

Changing branch from "" to "u/kedlaya/speed_up_hgm_coeffs"



---

archive/issue_comments_586637.json:
```json
{
    "body": "<a id='comment:2'></a>needs review ?\n\n---\nNew commits:",
    "created_at": "2020-06-18T19:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586637",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>needs review ?

---
New commits:



---

archive/issue_comments_586638.json:
```json
{
    "body": "Changing commit from \"\" to \"3c99efe15890c7bd77ba5a8c7abb34ea007aef31\"",
    "created_at": "2020-06-18T19:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586638",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "3c99efe15890c7bd77ba5a8c7abb34ea007aef31"



---

archive/issue_comments_586639.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-19T03:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586639",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_586640.json:
```json
{
    "body": "Changing commit from \"3c99efe15890c7bd77ba5a8c7abb34ea007aef31\" to \"8a048d20bb331a5051e4e93c3335b7b2ac607812\"",
    "created_at": "2020-06-19T03:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586640",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3c99efe15890c7bd77ba5a8c7abb34ea007aef31" to "8a048d20bb331a5051e4e93c3335b7b2ac607812"



---

archive/issue_comments_586641.json:
```json
{
    "body": "<a id='comment:4'></a>I thought of another improvement: since we only implement parameter values in Q, I can consolidate from `q-1` to `p-1` terms in `hgm_coeffs`. This speeds things up some more:\n\n```\nsage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp\nsage: H = Hyp(cyclotomic=([4,2,2],[3,3]))\nsage: time H.padic_H_value(next_prime(4096), 2, 1337)\nCPU times: user 24 s, sys: 255 ms, total: 24.3 s\nWall time: 24.3 s\n-5526\n```\nAs a bonus, cacheing this result takes much less memory.\n\nLet me sleep on this a bit before putting this up for review, to see if I'm missing another easy trick.",
    "created_at": "2020-06-19T03:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586641",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:4'></a>I thought of another improvement: since we only implement parameter values in Q, I can consolidate from `q-1` to `p-1` terms in `hgm_coeffs`. This speeds things up some more:

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp
sage: H = Hyp(cyclotomic=([4,2,2],[3,3]))
sage: time H.padic_H_value(next_prime(4096), 2, 1337)
CPU times: user 24 s, sys: 255 ms, total: 24.3 s
Wall time: 24.3 s
-5526
```
As a bonus, cacheing this result takes much less memory.

Let me sleep on this a bit before putting this up for review, to see if I'm missing another easy trick.



---

archive/issue_comments_586642.json:
```json
{
    "body": "Changing author from \"\" to \"Kiran Kedlaya\"",
    "created_at": "2020-06-19T03:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586642",
    "user": "https://github.com/kedlaya"
}
```

Changing author from "" to "Kiran Kedlaya"



---

archive/issue_comments_586643.json:
```json
{
    "body": "<a id='comment:6'></a>patchbot complains about a little code style detail :\n\n```\n+src/sage/modular/hypergeometric_motive.py:1101:28: E701 multiple statements on one line (colon)\n+src/sage/modular/hypergeometric_motive.py:1229:30: E701 multiple statements on one line (colon)\n```\nso please break those two lines to make it happier",
    "created_at": "2020-06-19T09:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586643",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>patchbot complains about a little code style detail :

```
+src/sage/modular/hypergeometric_motive.py:1101:28: E701 multiple statements on one line (colon)
+src/sage/modular/hypergeometric_motive.py:1229:30: E701 multiple statements on one line (colon)
```
so please break those two lines to make it happier



---

archive/issue_comments_586644.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-19T13:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586644",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_586645.json:
```json
{
    "body": "Changing commit from \"8a048d20bb331a5051e4e93c3335b7b2ac607812\" to \"7a6acb2ce1b397fa836851954a598efc547ec9be\"",
    "created_at": "2020-06-19T13:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586645",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8a048d20bb331a5051e4e93c3335b7b2ac607812" to "7a6acb2ce1b397fa836851954a598efc547ec9be"



---

archive/issue_comments_586646.json:
```json
{
    "body": "<a id='comment:8'></a>needs review now ?",
    "created_at": "2020-06-22T12:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586646",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>needs review now ?



---

archive/issue_comments_586647.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-23T00:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586647",
    "user": "https://github.com/kedlaya"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_586648.json:
```json
{
    "body": "<a id='comment:9'></a>Let's go ahead and advance this to the review stage. Apparently there is some room for improvement on the side of computing the p-adic Gamma function, but that can be a separate ticket later.",
    "created_at": "2020-06-23T00:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586648",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:9'></a>Let's go ahead and advance this to the review stage. Apparently there is some room for improvement on the side of computing the p-adic Gamma function, but that can be a separate ticket later.



---

archive/issue_comments_586649.json:
```json
{
    "body": "<a id='comment:10'></a>ok, let it be",
    "created_at": "2020-06-23T06:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586649",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>ok, let it be



---

archive/issue_comments_586650.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2020-06-23T06:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586650",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "" to "Frédéric Chapoton"



---

archive/issue_comments_586651.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-23T06:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586651",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_586652.json:
```json
{
    "body": "<a id='comment:11'></a>Merge conflict",
    "created_at": "2020-06-27T10:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586652",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>Merge conflict



---

archive/issue_comments_586653.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-06-27T10:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586653",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_586654.json:
```json
{
    "body": "<a id='comment:12'></a>My fault, I should have merged #29778 into this branch. Rebase coming up...",
    "created_at": "2020-06-27T15:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586654",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:12'></a>My fault, I should have merged #29778 into this branch. Rebase coming up...



---

archive/issue_comments_586655.json:
```json
{
    "body": "Changing commit from \"7a6acb2ce1b397fa836851954a598efc547ec9be\" to \"\"",
    "created_at": "2020-06-27T15:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586655",
    "user": "https://github.com/kedlaya"
}
```

Changing commit from "7a6acb2ce1b397fa836851954a598efc547ec9be" to ""



---

archive/issue_comments_586656.json:
```json
{
    "body": "Changing branch from \"u/kedlaya/speed_up_hgm_coeffs\" to \"\"",
    "created_at": "2020-06-27T15:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586656",
    "user": "https://github.com/kedlaya"
}
```

Changing branch from "u/kedlaya/speed_up_hgm_coeffs" to ""



---

archive/issue_comments_586657.json:
```json
{
    "body": "Changing branch from \"\" to \"u/kedlaya/speed_up_hgm_coeffs_v2\"",
    "created_at": "2020-06-27T15:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586657",
    "user": "https://github.com/kedlaya"
}
```

Changing branch from "" to "u/kedlaya/speed_up_hgm_coeffs_v2"



---

archive/issue_comments_586658.json:
```json
{
    "body": "Changing commit from \"\" to \"ad2888b6047c8180a787e16832770315bfa11728\"",
    "created_at": "2020-06-27T15:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586658",
    "user": "https://github.com/kedlaya"
}
```

Changing commit from "" to "ad2888b6047c8180a787e16832770315bfa11728"



---

archive/issue_comments_586659.json:
```json
{
    "body": "<a id='comment:14'></a>New commits:",
    "created_at": "2020-06-27T15:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586659",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:14'></a>New commits:



---

archive/issue_comments_586660.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-27T15:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586660",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_586661.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-27T17:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586661",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_586662.json:
```json
{
    "body": "<a id='comment:15'></a>ok, green bot, and back to positive",
    "created_at": "2020-06-27T17:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586662",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>ok, green bot, and back to positive



---

archive/issue_comments_586663.json:
```json
{
    "body": "Changing branch from \"u/kedlaya/speed_up_hgm_coeffs_v2\" to \"ad2888b6047c8180a787e16832770315bfa11728\"",
    "created_at": "2020-07-08T19:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586663",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/kedlaya/speed_up_hgm_coeffs_v2" to "ad2888b6047c8180a787e16832770315bfa11728"



---

archive/issue_events_076654.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-08T19:34:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29893#event-76654"
}
```



---

archive/issue_comments_586664.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-08T19:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29893",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29893#issuecomment-586664",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
