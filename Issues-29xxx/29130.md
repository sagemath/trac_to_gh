# Issue 29130: Add nix package information, extend dockerfile generator to nix

archive/issues_028893.json:
```json
{
    "body": "This extends #29053, where it is done for debian/fedora/conda/arch.\n\nhttps://hub.docker.com/r/nixos/nix/\n\nhttps://wiki.sagemath.org/Distribution#Nix\n\nTo test: \n\n```\n  tox -e docker-nixos-minimal\n  tox -e docker-nixos-standard\n```\n\n\n\nCC:  @timokau @dimpase @kliem\n\nBranch/Commit: d4b2af2e29d691ec4af6828c9b2fd6a5516ed063\n\nReviewer: Jonathan Kliem\n\nAuthor: Matthias Koeppe\n\nDependencies: #30044\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29130\n\n",
    "closed_at": "2020-08-30T08:39:20Z",
    "created_at": "2020-01-31T23:45:36Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Add nix package information, extend dockerfile generator to nix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29130",
    "user": "https://github.com/mkoeppe"
}
```
This extends #29053, where it is done for debian/fedora/conda/arch.

https://hub.docker.com/r/nixos/nix/

https://wiki.sagemath.org/Distribution#Nix

To test: 

```
  tox -e docker-nixos-minimal
  tox -e docker-nixos-standard
```



CC:  @timokau @dimpase @kliem

Branch/Commit: d4b2af2e29d691ec4af6828c9b2fd6a5516ed063

Reviewer: Jonathan Kliem

Author: Matthias Koeppe

Dependencies: #30044

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29130





---

archive/issue_comments_435527.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n This extends #29053, where it is done for debian/fedora/conda/arch.\n+\n+https://hub.docker.com/r/nixos/nix/\n \n Comment: 1\n \n```\n",
    "created_at": "2020-02-01T01:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435527",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
 This extends #29053, where it is done for debian/fedora/conda/arch.
+
+https://hub.docker.com/r/nixos/nix/
 
 Comment: 1
 
```




---

archive/issue_comments_435528.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+This extends #29053, where it is done for debian/fedora/conda/arch.\n \n+https://hub.docker.com/r/nixos/nix/\n+\n+https://wiki.sagemath.org/Distribution#Nix\n \n Comment: 1\n \n```\n",
    "created_at": "2020-02-01T01:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435528",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,8 @@
+This extends #29053, where it is done for debian/fedora/conda/arch.
 
+https://hub.docker.com/r/nixos/nix/
+
+https://wiki.sagemath.org/Distribution#Nix
 
 Comment: 1
 
```




---

archive/issue_comments_435529.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-10T02:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435529",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435530.json:
```json
{
    "body": "<a id='comment:4'></a>This defines `docker-nixos-minimal`.\n\nFor `docker-nixos-standard`, need to add many package equivalences to `build/pkgs/*/distros/nix.txt`\n\n---\nNew commits:",
    "created_at": "2020-03-10T02:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435530",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>This defines `docker-nixos-minimal`.

For `docker-nixos-standard`, need to add many package equivalences to `build/pkgs/*/distros/nix.txt`

---
New commits:



---

archive/issue_comments_435531.json:
```json
{
    "body": "<a id='comment:5'></a>Regarding the package equivalents: All packages sage needs should be listed at the start of one of those files:\n\n- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/env-locations.nix\n- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagedoc.nix\n- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagelib.nix\n- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sage-env.nix\n\nOne caveat is that if you want to use system python packages, you either need to add them to PYTHONPATH manually or install them as a single python environment. That means instead of installing\n`python3`, `numpy`, `scipy`\nseparately, you'd install the \"package\" (or environment) `python3.withPackages (ps: with ps; [numpy scipy])`.\n\nI'm happy to help by explaining things, though I won't take the lead on this for now since sage-the-distribution isn't high priority for me right now (I have my hands full keeping the nix package running).",
    "created_at": "2020-03-10T13:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435531",
    "user": "https://github.com/timokau"
}
```

<a id='comment:5'></a>Regarding the package equivalents: All packages sage needs should be listed at the start of one of those files:

- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/env-locations.nix
- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagedoc.nix
- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagelib.nix
- https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sage-env.nix

One caveat is that if you want to use system python packages, you either need to add them to PYTHONPATH manually or install them as a single python environment. That means instead of installing
`python3`, `numpy`, `scipy`
separately, you'd install the "package" (or environment) `python3.withPackages (ps: with ps; [numpy scipy])`.

I'm happy to help by explaining things, though I won't take the lead on this for now since sage-the-distribution isn't high priority for me right now (I have my hands full keeping the nix package running).



---

archive/issue_comments_435532.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 gh-timokau]:\n> Regarding the package equivalents: All packages sage needs should be listed at the start of one of those files:\n> \n> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/env-locations.nix\n> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagedoc.nix\n> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagelib.nix\n> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sage-env.nix\n\n\nThanks.\n\n> One caveat is that if you want to use system python packages, ...\n\n\nFor now, we are not taking care of any Python packages.",
    "created_at": "2020-03-17T03:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435532",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Replying to [comment:5 gh-timokau]:
> Regarding the package equivalents: All packages sage needs should be listed at the start of one of those files:
> 
> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/env-locations.nix
> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagedoc.nix
> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sagelib.nix
> - https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/math/sage/sage-env.nix


Thanks.

> One caveat is that if you want to use system python packages, ...


For now, we are not taking care of any Python packages.



---

archive/issue_comments_435533.json:
```json
{
    "body": "<a id='comment:7'></a>pushing these forward to 9.2",
    "created_at": "2020-04-14T06:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435533",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>pushing these forward to 9.2



---

archive/issue_events_073881.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T06:38:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29130#event-73881"
}
```



---

archive/issue_comments_435534.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-15T20:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435534",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_435535.json:
```json
{
    "body": "<a id='comment:9'></a>Rebased on 9.2.beta1",
    "created_at": "2020-06-15T20:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435535",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Rebased on 9.2.beta1



---

archive/issue_comments_435536.json:
```json
{
    "body": "<a id='comment:10'></a>Starting points for people who want to help with this:\n\n- \u200bhttps://doc.sagemath.org/html/en/developer/portability_testing.html\n- \u200bhttps://researchseminars.org/talk/SageDays109/7/",
    "created_at": "2020-06-15T20:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435536",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Starting points for people who want to help with this:

- ​https://doc.sagemath.org/html/en/developer/portability_testing.html
- ​https://researchseminars.org/talk/SageDays109/7/



---

archive/issue_comments_435537.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-02T22:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435537",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435538.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-08-11T17:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435538",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_435539.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-11T18:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435539",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435540.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+This extends #29053, where it is done for debian/fedora/conda/arch.\n+\n+https://hub.docker.com/r/nixos/nix/\n+\n+https://wiki.sagemath.org/Distribution#Nix\n+\n+To test: \\`tox -e docker-nixos-standard\\`\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-08-11T18:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435540",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,11 @@
+This extends #29053, where it is done for debian/fedora/conda/arch.
+
+https://hub.docker.com/r/nixos/nix/
+
+https://wiki.sagemath.org/Distribution#Nix
+
+To test: \`tox -e docker-nixos-standard\`
+
 
 
 Comment: 1
```




---

archive/issue_comments_435541.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+This extends #29053, where it is done for debian/fedora/conda/arch.\n+\n+https://hub.docker.com/r/nixos/nix/\n+\n+https://wiki.sagemath.org/Distribution#Nix\n+\n+To test: \n+\n+\\`\\`\\`\n+  tox -e docker-nixos-minimal\n+  tox -e docker-nixos-standard\n+\\`\\`\\`\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-08-11T18:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435541",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,16 @@
+This extends #29053, where it is done for debian/fedora/conda/arch.
+
+https://hub.docker.com/r/nixos/nix/
+
+https://wiki.sagemath.org/Distribution#Nix
+
+To test: 
+
+\`\`\`
+  tox -e docker-nixos-minimal
+  tox -e docker-nixos-standard
+\`\`\`
+
 
 
 Comment: 1
```




---

archive/issue_comments_435542.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-11T18:56:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435542",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435543.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-11T19:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435543",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435544.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-11T19:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435544",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435545.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-11T19:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435545",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435546.json:
```json
{
    "body": "<a id='comment:20'></a>Let's get this in please",
    "created_at": "2020-08-24T17:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435546",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Let's get this in please



---

archive/issue_comments_435547.json:
```json
{
    "body": "<a id='comment:21'></a>I'm running a few tests here: https://github.com/kliem/sage/pull/24/checks",
    "created_at": "2020-08-24T20:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435547",
    "user": "https://github.com/kliem"
}
```

<a id='comment:21'></a>I'm running a few tests here: https://github.com/kliem/sage/pull/24/checks



---

archive/issue_comments_435548.json:
```json
{
    "body": "<a id='comment:22'></a>python3 isn't picked up, which isn't very surprising by the above comment. I guess this can be done in a future ticket.\n\nIt is not recognized that gcc contains a fortran compiler. But that is maybe also a future ticket.\n\n`libgd` fails to install, which is somewhat unfortunate as we could simply add the package `freetype` to the system, couldn't we?",
    "created_at": "2020-08-25T05:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435548",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>python3 isn't picked up, which isn't very surprising by the above comment. I guess this can be done in a future ticket.

It is not recognized that gcc contains a fortran compiler. But that is maybe also a future ticket.

`libgd` fails to install, which is somewhat unfortunate as we could simply add the package `freetype` to the system, couldn't we?



---

archive/issue_comments_435549.json:
```json
{
    "body": "<a id='comment:23'></a>This is pretty much good to go. I think only the last point should be handled here, shouldn't it?",
    "created_at": "2020-08-25T18:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435549",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'></a>This is pretty much good to go. I think only the last point should be handled here, shouldn't it?



---

archive/issue_comments_435550.json:
```json
{
    "body": "<a id='comment:24'></a>I added freetype. If you agree, this is a positive review.\n\n---\nNew commits:",
    "created_at": "2020-08-26T06:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435550",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>I added freetype. If you agree, this is a positive review.

---
New commits:



---

archive/issue_comments_435551.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-26T15:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435551",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435552.json:
```json
{
    "body": "<a id='comment:25'></a>Thank you!",
    "created_at": "2020-08-26T15:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435552",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Thank you!



---

archive/issue_comments_435553.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-30T08:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29130#issuecomment-435553",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073882.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-30T08:39:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29130",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29130#event-73882"
}
```
