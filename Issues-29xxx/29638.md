# Issue 29638: replace tuples by mpz vectors in free abelian monoids

archive/issues_029401.json:
```json
{
    "assignees": [],
    "body": "This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents as `mpz_t*` array (copied in part from `vector_integer_dense`). The file is cythonized for this. This makes multiplication much faster (from [comment:10](#comment:10)):\n\n```\nM = FreeAbelianMonoid('x', 5)\nL = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]\n%timeit _ = [a * b for a in L for b in L]\n1 loop, best of 5: 1.7 s per loop  -- (before)\n1 loop, best of 5: 282 ms per loop  -- (after)\n```\n\nAnother motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.\n\n\nCC:  @tscrim\n\nBranch/Commit: **[`ed94d9e`](https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton, Markus Wageringel**\n\nAuthor: **Markus Wageringel, Travis Scrimshaw**\n\nComponent: **commutative algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29638_\n\n",
    "closed_at": "2020-07-12T08:30:42Z",
    "created_at": "2020-05-03T10:23:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20commutative%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "replace tuples by mpz vectors in free abelian monoids",
    "type": "issue",
    "updated_at": "2020-07-12T08:30:42Z",
    "url": "https://github.com/sagemath/sage/issues/29638",
    "user": "https://github.com/mwageringel"
}
```
This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents as `mpz_t*` array (copied in part from `vector_integer_dense`). The file is cythonized for this. This makes multiplication much faster (from [comment:10](#comment:10)):

```
M = FreeAbelianMonoid('x', 5)
L = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]
%timeit _ = [a * b for a in L for b in L]
1 loop, best of 5: 1.7 s per loop  -- (before)
1 loop, best of 5: 282 ms per loop  -- (after)
```

Another motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.


CC:  @tscrim

Branch/Commit: **[`ed94d9e`](https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164)**

Reviewer: **Frédéric Chapoton, Markus Wageringel**

Author: **Markus Wageringel, Travis Scrimshaw**

Component: **commutative algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/29638_





---

archive/issue_events_404728.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-05-03T10:23:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404728"
}
```



---

archive/issue_events_404729.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-05-03T10:23:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20commutative%20algebra",
    "label_color": "0000ff",
    "label_name": "c: commutative algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404729"
}
```



---

archive/issue_events_404730.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-05-03T10:23:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404730"
}
```



---

archive/issue_events_404731.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-05-03T10:23:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404731"
}
```



---

archive/issue_events_404732.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-05-03T10:25:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404732"
}
```



---

archive/issue_comments_466665.json:
```json
{
    "body": "Branch: **[u/gh-mwageringel/29638](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/29638)**",
    "created_at": "2020-05-03T10:25:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466665",
    "user": "https://github.com/mwageringel"
}
```

Branch: **[u/gh-mwageringel/29638](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/29638)**



---

archive/issue_comments_466666.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/10bd4b950367c55122be34dc2e24cf41de572990\"><code>10bd4b9</code></a></td><td><code>29638: use ETuples in free abelian monoids</code></td></tr></table>\n",
    "created_at": "2020-05-03T10:25:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466666",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/10bd4b950367c55122be34dc2e24cf41de572990"><code>10bd4b9</code></a></td><td><code>29638: use ETuples in free abelian monoids</code></td></tr></table>




---

archive/issue_comments_466667.json:
```json
{
    "body": "Author: **Markus Wageringel**",
    "created_at": "2020-05-03T10:25:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466667",
    "user": "https://github.com/mwageringel"
}
```

Author: **Markus Wageringel**



---

archive/issue_comments_466668.json:
```json
{
    "body": "Commit: **[`10bd4b9`](https://github.com/sagemath/sagetrac-mirror/commit/10bd4b950367c55122be34dc2e24cf41de572990)**",
    "created_at": "2020-05-03T10:25:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466668",
    "user": "https://github.com/mwageringel"
}
```

Commit: **[`10bd4b9`](https://github.com/sagemath/sagetrac-mirror/commit/10bd4b950367c55122be34dc2e24cf41de572990)**



---

archive/issue_comments_466669.json:
```json
{
    "body": "Changed commit from **[`10bd4b9`](https://github.com/sagemath/sagetrac-mirror/commit/10bd4b950367c55122be34dc2e24cf41de572990)** to **[`efbbddc`](https://github.com/sagemath/sagetrac-mirror/commit/efbbddcfcd8f91f6ba0715df46b72986ec00dd75)**",
    "created_at": "2020-05-29T20:08:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466669",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`10bd4b9`](https://github.com/sagemath/sagetrac-mirror/commit/10bd4b950367c55122be34dc2e24cf41de572990)** to **[`efbbddc`](https://github.com/sagemath/sagetrac-mirror/commit/efbbddcfcd8f91f6ba0715df46b72986ec00dd75)**



---

archive/issue_comments_466670.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/efbbddcfcd8f91f6ba0715df46b72986ec00dd75\"><code>efbbddc</code></a></td><td><code>29638: use ETuples in free abelian monoids</code></td></tr></table>\n",
    "created_at": "2020-05-29T20:08:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466670",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/efbbddcfcd8f91f6ba0715df46b72986ec00dd75"><code>efbbddc</code></a></td><td><code>29638: use ETuples in free abelian monoids</code></td></tr></table>




---

archive/issue_comments_466671.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nRebased.",
    "created_at": "2020-05-29T20:08:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466671",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:3" align="right">comment:3</div>

Rebased.



---

archive/issue_comments_466672.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2020-06-04T18:32:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466672",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton**



---

archive/issue_comments_466673.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nLooks good, thanks for doing that. Maybe Travis will have a comment ?",
    "created_at": "2020-06-04T18:32:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466673",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:4" align="right">comment:4</div>

Looks good, thanks for doing that. Maybe Travis will have a comment ?



---

archive/issue_comments_466674.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n+1 for moving away from Python code. Did you try using **Z**<sup>n</sup> elements for the backend structure?",
    "created_at": "2020-06-04T22:45:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466674",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

+1 for moving away from Python code. Did you try using **Z**<sup>n</sup> elements for the backend structure?



---

archive/issue_comments_466675.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWell, `mpz` vectors (maybe C arrays?) would perhaps be ideal, but that would need this file to be Cythonized.",
    "created_at": "2020-06-04T22:46:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466675",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:6" align="right">comment:6</div>

Well, `mpz` vectors (maybe C arrays?) would perhaps be ideal, but that would need this file to be Cythonized.



---

archive/issue_comments_466676.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI am tempted to give a positive review as it is, because it is already a large improvement. Travis, do you agree ? What do you mean by \"using Z<sup>n</sup>\" ?",
    "created_at": "2020-06-05T10:30:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466676",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:7" align="right">comment:7</div>

I am tempted to give a positive review as it is, because it is already a large improvement. Travis, do you agree ? What do you mean by "using Z<sup>n</sup>" ?



---

archive/issue_comments_466677.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI am also thinking of giving it a positive review, but I just wanted to see if Markus had tested it before a positive review.\n\nAs you know, any free abelian group has a natural isomorphism with **Z**<sup>n</sup> with the ith generator mapping to e<sub>i</sub> with `*` -> `+`, and the monoid naturally lies inside of that. So I was wondering if it has been tested using the corresponding free module code and how that compared. If it hasn't been done, I can write the code to test it.",
    "created_at": "2020-06-05T11:13:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466677",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">comment:8</div>

I am also thinking of giving it a positive review, but I just wanted to see if Markus had tested it before a positive review.

As you know, any free abelian group has a natural isomorphism with **Z**<sup>n</sup> with the ith generator mapping to e<sub>i</sub> with `*` -> `+`, and the monoid naturally lies inside of that. So I was wondering if it has been tested using the corresponding free module code and how that compared. If it hasn't been done, I can write the code to test it.



---

archive/issue_comments_466678.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nNo, I have not tried using integer vectors. Though, I imagine that cythonizing the whole file could already give another speedup. I only chose ETuples because it seemed natural, as I sometimes use `FreeAbelianMonoid().algebra()` as a replacement for polynomial rings, as it is in the `ModulesWithBasis` category (maybe this axiom could be added to polynomial rings as well, in the future?).",
    "created_at": "2020-06-05T18:25:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466678",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:9" align="right">comment:9</div>

No, I have not tried using integer vectors. Though, I imagine that cythonizing the whole file could already give another speedup. I only chose ETuples because it seemed natural, as I sometimes use `FreeAbelianMonoid().algebra()` as a replacement for polynomial rings, as it is in the `ModulesWithBasis` category (maybe this axiom could be added to polynomial rings as well, in the future?).



---

archive/issue_comments_466679.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nSorry for not being able to get to this sooner. Here is a version unwrapping the dense integer vectors, with a fair amount of overlap with that implementation. Ideally we would refactor that out, but the lack of multiple inheritance in Cython makes that impossible.\n\nOn my machine:\n\n```\n1 loop, best of 5: 1.7 s per loop  -- Old\n\n1 loop, best of 5: 282 ms per loop  -- With my branch\n```\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0183b87f8d8947df6c96a1137130fe88d80b0e08\"><code>0183b87</code></a></td><td><code>Implementing free abelian monoid elements as C arrays of mpz_ints.</code></td></tr></table>\n",
    "created_at": "2020-06-22T08:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466679",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:10" align="right">comment:10</div>

Sorry for not being able to get to this sooner. Here is a version unwrapping the dense integer vectors, with a fair amount of overlap with that implementation. Ideally we would refactor that out, but the lack of multiple inheritance in Cython makes that impossible.

On my machine:

```
1 loop, best of 5: 1.7 s per loop  -- Old

1 loop, best of 5: 282 ms per loop  -- With my branch
```

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0183b87f8d8947df6c96a1137130fe88d80b0e08"><code>0183b87</code></a></td><td><code>Implementing free abelian monoid elements as C arrays of mpz_ints.</code></td></tr></table>




---

archive/issue_comments_466680.json:
```json
{
    "body": "Changed author from **Markus Wageringel** to **Markus Wageringel, Travis Scrimshaw**",
    "created_at": "2020-06-22T08:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466680",
    "user": "https://github.com/tscrim"
}
```

Changed author from **Markus Wageringel** to **Markus Wageringel, Travis Scrimshaw**



---

archive/issue_comments_466681.json:
```json
{
    "body": "Changed commit from **[`efbbddc`](https://github.com/sagemath/sagetrac-mirror/commit/efbbddcfcd8f91f6ba0715df46b72986ec00dd75)** to **[`0183b87`](https://github.com/sagemath/sagetrac-mirror/commit/0183b87f8d8947df6c96a1137130fe88d80b0e08)**",
    "created_at": "2020-06-22T08:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466681",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`efbbddc`](https://github.com/sagemath/sagetrac-mirror/commit/efbbddcfcd8f91f6ba0715df46b72986ec00dd75)** to **[`0183b87`](https://github.com/sagemath/sagetrac-mirror/commit/0183b87f8d8947df6c96a1137130fe88d80b0e08)**



---

archive/issue_comments_466682.json:
```json
{
    "body": "Changed branch from **[u/gh-mwageringel/29638](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/29638)** to **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)**",
    "created_at": "2020-06-22T08:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466682",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/gh-mwageringel/29638](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/29638)** to **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)**



---

archive/issue_comments_466683.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThis looks like a decent speedup. Would it be much slower to make `_element_vector` a `Vector_integer_dense` (or a sparse one)? This would avoid much of the duplication. I assume most of the speedup comes from the cythonization and assume the additional function call overhead would be small, but I might be wrong about this.",
    "created_at": "2020-06-22T17:46:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466683",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:11" align="right">comment:11</div>

This looks like a decent speedup. Would it be much slower to make `_element_vector` a `Vector_integer_dense` (or a sparse one)? This would avoid much of the duplication. I assume most of the speedup comes from the cythonization and assume the additional function call overhead would be small, but I might be wrong about this.



---

archive/issue_comments_466684.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSorry, I haven't had time yet to try it. It likely will slow it down a little bit because of the extra level of indirection and handling of an extra Element object, but it is worth seeing to reduce the duplication.",
    "created_at": "2020-06-24T23:07:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466684",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">comment:12</div>

Sorry, I haven't had time yet to try it. It likely will slow it down a little bit because of the extra level of indirection and handling of an extra Element object, but it is worth seeing to reduce the duplication.



---

archive/issue_comments_466685.json:
```json
{
    "body": "Changed commit from **[`0183b87`](https://github.com/sagemath/sagetrac-mirror/commit/0183b87f8d8947df6c96a1137130fe88d80b0e08)** to **[`fe46462`](https://github.com/sagemath/sagetrac-mirror/commit/fe46462ddb43b83766a762d510c39c5bb97075c1)**",
    "created_at": "2020-06-30T04:28:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466685",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`0183b87`](https://github.com/sagemath/sagetrac-mirror/commit/0183b87f8d8947df6c96a1137130fe88d80b0e08)** to **[`fe46462`](https://github.com/sagemath/sagetrac-mirror/commit/fe46462ddb43b83766a762d510c39c5bb97075c1)**



---

archive/issue_comments_466686.json:
```json
{
    "body": "Changed branch from **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)** to **[public/monoids/faster_free_abelian_monoid_elt_ZZ-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt_ZZ-29638)**",
    "created_at": "2020-06-30T04:28:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466686",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)** to **[public/monoids/faster_free_abelian_monoid_elt_ZZ-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt_ZZ-29638)**



---

archive/issue_comments_466687.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThere is about a 10% slowdown:\n\n```\nsage: %timeit _ = [a * b for a in L for b in L]\n1 loop, best of 5: 304 ms per loop  -- New branch\n```\n\n```\nsage: timeit(\"_ = [a * b for a in L for b in L]\", repeat=5)\n5 loops, best of 5: 427 ms per loop  -- New branch\n\n5 loops, best of 5: 384 ms per loop  -- Previous branch\n```\nSo it depends on how much you want the extra speed. IMO, the amount of duplication is not significant enough compared to the extra speed. It is just unfortunate that we cannot work around the class hierarchy (and don't have multiple inheritance) to have a common ABC.\n\nOf course, the next step after this would be doing the same treatment for free Abelian groups.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/beca95d1197c699eede026a1fae6405acc5a47e4\"><code>beca95d</code></a></td><td><code>Adding pxd file.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fe46462ddb43b83766a762d510c39c5bb97075c1\"><code>fe46462</code></a></td><td><code>Using ZZ module elements instead of rolling it directly.</code></td></tr></table>\n",
    "created_at": "2020-06-30T04:28:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466687",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:13" align="right">comment:13</div>

There is about a 10% slowdown:

```
sage: %timeit _ = [a * b for a in L for b in L]
1 loop, best of 5: 304 ms per loop  -- New branch
```

```
sage: timeit("_ = [a * b for a in L for b in L]", repeat=5)
5 loops, best of 5: 427 ms per loop  -- New branch

5 loops, best of 5: 384 ms per loop  -- Previous branch
```
So it depends on how much you want the extra speed. IMO, the amount of duplication is not significant enough compared to the extra speed. It is just unfortunate that we cannot work around the class hierarchy (and don't have multiple inheritance) to have a common ABC.

Of course, the next step after this would be doing the same treatment for free Abelian groups.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/beca95d1197c699eede026a1fae6405acc5a47e4"><code>beca95d</code></a></td><td><code>Adding pxd file.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fe46462ddb43b83766a762d510c39c5bb97075c1"><code>fe46462</code></a></td><td><code>Using ZZ module elements instead of rolling it directly.</code></td></tr></table>




---

archive/issue_comments_466688.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:\n\n```\nsage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort\nsage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort\n```\n\n\nOut of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?\n\nBy the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).",
    "created_at": "2020-07-05T12:26:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466688",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:14" align="right">comment:14</div>

Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:

```
sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort
sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort
```


Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?

By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).



---

archive/issue_events_404733.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-07-05T12:26:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404733"
}
```



---

archive/issue_events_404734.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-07-05T12:26:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404734"
}
```



---

archive/issue_comments_466689.json:
```json
{
    "body": "Changed branch from **[public/monoids/faster_free_abelian_monoid_elt_ZZ-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt_ZZ-29638)** to **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)**",
    "created_at": "2020-07-05T23:50:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466689",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[public/monoids/faster_free_abelian_monoid_elt_ZZ-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt_ZZ-29638)** to **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)**



---

archive/issue_comments_466690.json:
```json
{
    "body": "Changed commit from **[`fe46462`](https://github.com/sagemath/sagetrac-mirror/commit/fe46462ddb43b83766a762d510c39c5bb97075c1)** to **[`beca95d`](https://github.com/sagemath/sagetrac-mirror/commit/beca95d1197c699eede026a1fae6405acc5a47e4)**",
    "created_at": "2020-07-05T23:50:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466690",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`fe46462`](https://github.com/sagemath/sagetrac-mirror/commit/fe46462ddb43b83766a762d510c39c5bb97075c1)** to **[`beca95d`](https://github.com/sagemath/sagetrac-mirror/commit/beca95d1197c699eede026a1fae6405acc5a47e4)**



---

archive/issue_comments_466691.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@mwageringel](#comment:14):\n> Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:\n> \n> ```\n> sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort\n> sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort\n> ```\n\nStrange, I wasn't getting those. I will try again with the latest beta version.\n\n> Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?\n\nI think it is coming from the additional redirections and extra temporary objects (probably also the allocation as well).\n\n> By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).\n\nThere probably is a benefit from having both a sparse version if someone wants a free abelian monoid (or group) with say 10000 generators and utilize that sparseness. Although I would be a bit surprised if there was a good use case.",
    "created_at": "2020-07-05T23:50:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466691",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@mwageringel](#comment:14):
> Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:
> 
> ```
> sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort
> sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort
> ```

Strange, I wasn't getting those. I will try again with the latest beta version.

> Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?

I think it is coming from the additional redirections and extra temporary objects (probably also the allocation as well).

> By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).

There probably is a benefit from having both a sparse version if someone wants a free abelian monoid (or group) with say 10000 generators and utilize that sparseness. Although I would be a bit surprised if there was a good use case.



---

archive/issue_comments_466692.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nNope, I am still not getting those errors. Can you post the traceback of the errors and/or reproduce them locally on your computer?",
    "created_at": "2020-07-06T00:15:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466692",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:16" align="right">comment:16</div>

Nope, I am still not getting those errors. Can you post the traceback of the errors and/or reproduce them locally on your computer?



---

archive/issue_comments_466693.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThe problem can be reproduced like this, for example:\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: F._test_elements_eq_symmetric()\nfree(): invalid pointer\n------------------------------------------------------------------------\n...\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n/home/math/mwagerin/git/sage_compute/src/bin/sage-python: line 2: 756763 Aborted                 (core dumped) sage -python \"$@\"\n```\n\nIt can also be obtained like this:\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: any(F.an_element() == 0 for _ in range(10))\nfree(): invalid pointer\n```\n\nIt seems to come from the call to `_Integer_from_mpz` in `_repr_`, but I cannot see anything wrong with it.",
    "created_at": "2020-07-06T18:21:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466693",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:17" align="right">comment:17</div>

The problem can be reproduced like this, for example:

```
sage: F = FreeAbelianMonoid(6,'b')
sage: F._test_elements_eq_symmetric()
free(): invalid pointer
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/home/math/mwagerin/git/sage_compute/src/bin/sage-python: line 2: 756763 Aborted                 (core dumped) sage -python "$@"
```

It can also be obtained like this:

```
sage: F = FreeAbelianMonoid(6,'b')
sage: any(F.an_element() == 0 for _ in range(10))
free(): invalid pointer
```

It seems to come from the call to `_Integer_from_mpz` in `_repr_`, but I cannot see anything wrong with it.



---

archive/issue_comments_466694.json:
```json
{
    "body": "Changed commit from **[`beca95d`](https://github.com/sagemath/sagetrac-mirror/commit/beca95d1197c699eede026a1fae6405acc5a47e4)** to **[`70cb425`](https://github.com/sagemath/sagetrac-mirror/commit/70cb4257a4a2008ac1308fd55869b941244262bc)**",
    "created_at": "2020-07-06T23:00:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466694",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`beca95d`](https://github.com/sagemath/sagetrac-mirror/commit/beca95d1197c699eede026a1fae6405acc5a47e4)** to **[`70cb425`](https://github.com/sagemath/sagetrac-mirror/commit/70cb4257a4a2008ac1308fd55869b941244262bc)**



---

archive/issue_comments_466695.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/044d28a22f620ab5b564d95d5252b0649e4cd2ed\"><code>044d28a</code></a></td><td><code>Merge branch 'develop' into public/monoids/faster_free_abelian_monoid_elt-29638</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/70cb4257a4a2008ac1308fd55869b941244262bc\"><code>70cb425</code></a></td><td><code>Trying to fix `_repr_` crash and added latex output.</code></td></tr></table>\n",
    "created_at": "2020-07-06T23:00:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466695",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/044d28a22f620ab5b564d95d5252b0649e4cd2ed"><code>044d28a</code></a></td><td><code>Merge branch 'develop' into public/monoids/faster_free_abelian_monoid_elt-29638</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/70cb4257a4a2008ac1308fd55869b941244262bc"><code>70cb425</code></a></td><td><code>Trying to fix `_repr_` crash and added latex output.</code></td></tr></table>




---

archive/issue_comments_466696.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI still cannot reproduce them, but based on your message, that gave me an idea of something to try. Please test this.\n\nI also released there was no `_latex_`, so I quickly added that. There probably should be a common helper function for printing/latexing monomials with various options; I have definitely written a number of these methods in various places...",
    "created_at": "2020-07-06T23:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466696",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:19" align="right">comment:19</div>

I still cannot reproduce them, but based on your message, that gave me an idea of something to try. Please test this.

I also released there was no `_latex_`, so I quickly added that. There probably should be a common helper function for printing/latexing monomials with various options; I have definitely written a number of these methods in various places...



---

archive/issue_comments_466697.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI am also a bit confused why the `_repr_` would be called in those tests too; it is not like it is used in the hash...",
    "created_at": "2020-07-06T23:03:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466697",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">comment:20</div>

I am also a bit confused why the `_repr_` would be called in those tests too; it is not like it is used in the hash...



---

archive/issue_comments_466698.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI have rebuilt Sage from scratch, but the problem persists. This is on Ubuntu 20.04.\n\nIt can also be reproduced with the `_repr_` directly (I have added sig_on/sig_off):\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: [F.an_element()._repr_() for _ in range(30)]\nfree(): invalid pointer\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-bc2f259b5b12> in <module>()\n----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]\n\n<ipython-input-2-bc2f259b5b12> in <listcomp>(.0)\n----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()\n    204         cdef Integer val\n    205         for i in range(self._n):\n--> 206             sig_on()\n    207             val = _Integer_from_mpz(v[i])\n    208             sig_off()\n\nRuntimeError: Aborted\n```\n\nHere is a stack trace for the equality test, which shows that the `_repr_` is used in an error message:\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: any(F.an_element() == 0 for _ in range(10))\nfree(): invalid pointer\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-be4380b2bde6> in <module>()\n----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))\n\n<ipython-input-2-be4380b2bde6> in <genexpr>(.0)\n----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__richcmp__ (build/cythonized/sage/structure/element.c:10160)()\n   1115             return (<Element>self)._richcmp_(other, op)\n   1116         else:\n-> 1117             return coercion_model.richcmp(self, other, op)\n   1118\n   1119     cpdef _richcmp_(left, right, int op):\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19864)()\n   1971         # Coerce to a common parent\n   1972         try:\n-> 1973             x, y = self.canonical_coercion(x, y)\n   1974         except (TypeError, NotImplementedError):\n   1975             pass\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13208)()\n   1391                 self._record_exception()\n   1392\n-> 1393         raise TypeError(\"no common canonical parent for objects with parents: '%s' and '%s'\"%(xp, yp))\n   1394\n   1395\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid.py in __repr__(self)\n    203     def __repr__(self):\n    204         n = self.__ngens\n--> 205         return \"Free abelian monoid on %s generators %s\"%(n,self.gens())\n    206\n    207     def __call__(self, x):\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2435)()\n    192         except AttributeError:\n    193             return super().__repr__()\n--> 194         result = reprfunc()\n    195         if isinstance(result, str):\n    196             return result\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()\n    204         cdef Integer val\n    205         for i in range(self._n):\n--> 206             sig_on()\n    207             val = _Integer_from_mpz(v[i])\n    208             sig_off()\n\nRuntimeError: Aborted\n```",
    "created_at": "2020-07-07T19:24:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466698",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:21" align="right">comment:21</div>

I have rebuilt Sage from scratch, but the problem persists. This is on Ubuntu 20.04.

It can also be reproduced with the `_repr_` directly (I have added sig_on/sig_off):

```
sage: F = FreeAbelianMonoid(6,'b')
sage: [F.an_element()._repr_() for _ in range(30)]
free(): invalid pointer
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-bc2f259b5b12> in <module>()
----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]

<ipython-input-2-bc2f259b5b12> in <listcomp>(.0)
----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()
    204         cdef Integer val
    205         for i in range(self._n):
--> 206             sig_on()
    207             val = _Integer_from_mpz(v[i])
    208             sig_off()

RuntimeError: Aborted
```

Here is a stack trace for the equality test, which shows that the `_repr_` is used in an error message:

```
sage: F = FreeAbelianMonoid(6,'b')
sage: any(F.an_element() == 0 for _ in range(10))
free(): invalid pointer
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-be4380b2bde6> in <module>()
----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))

<ipython-input-2-be4380b2bde6> in <genexpr>(.0)
----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__richcmp__ (build/cythonized/sage/structure/element.c:10160)()
   1115             return (<Element>self)._richcmp_(other, op)
   1116         else:
-> 1117             return coercion_model.richcmp(self, other, op)
   1118
   1119     cpdef _richcmp_(left, right, int op):

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19864)()
   1971         # Coerce to a common parent
   1972         try:
-> 1973             x, y = self.canonical_coercion(x, y)
   1974         except (TypeError, NotImplementedError):
   1975             pass

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13208)()
   1391                 self._record_exception()
   1392
-> 1393         raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
   1394
   1395

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid.py in __repr__(self)
    203     def __repr__(self):
    204         n = self.__ngens
--> 205         return "Free abelian monoid on %s generators %s"%(n,self.gens())
    206
    207     def __call__(self, x):

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2435)()
    192         except AttributeError:
    193             return super().__repr__()
--> 194         result = reprfunc()
    195         if isinstance(result, str):
    196             return result

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()
    204         cdef Integer val
    205         for i in range(self._n):
--> 206             sig_on()
    207             val = _Integer_from_mpz(v[i])
    208             sig_off()

RuntimeError: Aborted
```



---

archive/issue_comments_466699.json:
```json
{
    "body": "<div id=\"comment:22\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cdebca73a7d4314994a96afa1bdd583b5bc80b96\"><code>cdebca7</code></a></td><td><code>Remove the redundant MonoidElement.__init__ call; some other small tweaks.</code></td></tr></table>\n",
    "created_at": "2020-07-08T01:28:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466699",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cdebca73a7d4314994a96afa1bdd583b5bc80b96"><code>cdebca7</code></a></td><td><code>Remove the redundant MonoidElement.__init__ call; some other small tweaks.</code></td></tr></table>




---

archive/issue_comments_466700.json:
```json
{
    "body": "Changed commit from **[`70cb425`](https://github.com/sagemath/sagetrac-mirror/commit/70cb4257a4a2008ac1308fd55869b941244262bc)** to **[`cdebca7`](https://github.com/sagemath/sagetrac-mirror/commit/cdebca73a7d4314994a96afa1bdd583b5bc80b96)**",
    "created_at": "2020-07-08T01:28:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466700",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`70cb425`](https://github.com/sagemath/sagetrac-mirror/commit/70cb4257a4a2008ac1308fd55869b941244262bc)** to **[`cdebca7`](https://github.com/sagemath/sagetrac-mirror/commit/cdebca73a7d4314994a96afa1bdd583b5bc80b96)**



---

archive/issue_comments_466701.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI am really perplexed by this. The only difference between this an dense integer vectors is the `_repr_`, which simply unrolls the call to `list`. I feel like this should also fail for you by replacing `F` with `ZZ^5`. I cannot see what the difference is. I made some other changes that I doubt will fix the problem, but are good do have done. Since I don't get the failure, it is really hard to figure this out. `:/` (I am running Ubuntu 18.04 LTS.)",
    "created_at": "2020-07-08T01:29:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466701",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:23" align="right">comment:23</div>

I am really perplexed by this. The only difference between this an dense integer vectors is the `_repr_`, which simply unrolls the call to `list`. I feel like this should also fail for you by replacing `F` with `ZZ^5`. I cannot see what the difference is. I made some other changes that I doubt will fix the problem, but are good do have done. Since I don't get the failure, it is really hard to figure this out. `:/` (I am running Ubuntu 18.04 LTS.)



---

archive/issue_comments_466702.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nYes, the problem indeed exists with ZZ-vectors as well. The compiler gives the warning\n\n```\n[sagelib-9.2.beta3] warning: sage/rings/integer.pxd:41:37: Declarations should not be declared inline.\n```\nso I tried to remove the `inline` from the pxd file (this is the same format as used for `smallInteger` in that file), but it does not change the underlying problem.\n\nHowever, the following change seems to fix the issue.\n\n```diff\ndiff --git a/src/sage/rings/integer.pxd b/src/sage/rings/integer.pxd\nindex e90abd6c1c..778fd1cf7b 100644\n--- a/src/sage/rings/integer.pxd\n+++ b/src/sage/rings/integer.pxd\n@@ -1,4 +1,5 @@\n from sage.libs.gmp.types cimport __mpz_struct, mpz_t, mpz_ptr\n+from sage.libs.gmp.mpz cimport mpz_set\n from sage.libs.ntl.types cimport ZZ_c\n\n from sage.structure.element cimport EuclideanDomainElement, RingElement\n@@ -38,7 +39,10 @@ cdef int mpz_set_str_python(mpz_ptr z, char* s, int base) except -1\n\n cdef Integer smallInteger(long value)\n\n-cdef inline Integer _Integer_from_mpz(mpz_t e)\n+cdef inline Integer _Integer_from_mpz(mpz_t e):\n+    cdef Integer z = Integer.__new__(Integer)\n+    mpz_set(z.value, e)\n+    return z\n\n cdef class int_to_Z(Morphism):\n     pass\ndiff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx\nindex 6ef08a3a5c..d3bd868ec7 100644\n--- a/src/sage/rings/integer.pyx\n+++ b/src/sage/rings/integer.pyx\n@@ -7480,11 +7480,6 @@ cdef integer(x):\n         return x\n     return Integer(x)\n\n-cdef inline Integer _Integer_from_mpz(mpz_t e):\n-    cdef Integer z = Integer.__new__(Integer)\n-    mpz_set(z.value, e)\n-    return z\n-\n def free_integer_pool():\n     cdef int i\n     cdef PyObject *o\n```\n\nThis passes all the tests for me now, but I am still a bit confused about the issue \u2013 particularly because it occured with some randomness.",
    "created_at": "2020-07-08T19:13:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466702",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:24" align="right">comment:24</div>

Yes, the problem indeed exists with ZZ-vectors as well. The compiler gives the warning

```
[sagelib-9.2.beta3] warning: sage/rings/integer.pxd:41:37: Declarations should not be declared inline.
```
so I tried to remove the `inline` from the pxd file (this is the same format as used for `smallInteger` in that file), but it does not change the underlying problem.

However, the following change seems to fix the issue.

```diff
diff --git a/src/sage/rings/integer.pxd b/src/sage/rings/integer.pxd
index e90abd6c1c..778fd1cf7b 100644
--- a/src/sage/rings/integer.pxd
+++ b/src/sage/rings/integer.pxd
@@ -1,4 +1,5 @@
 from sage.libs.gmp.types cimport __mpz_struct, mpz_t, mpz_ptr
+from sage.libs.gmp.mpz cimport mpz_set
 from sage.libs.ntl.types cimport ZZ_c

 from sage.structure.element cimport EuclideanDomainElement, RingElement
@@ -38,7 +39,10 @@ cdef int mpz_set_str_python(mpz_ptr z, char* s, int base) except -1

 cdef Integer smallInteger(long value)

-cdef inline Integer _Integer_from_mpz(mpz_t e)
+cdef inline Integer _Integer_from_mpz(mpz_t e):
+    cdef Integer z = Integer.__new__(Integer)
+    mpz_set(z.value, e)
+    return z

 cdef class int_to_Z(Morphism):
     pass
diff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx
index 6ef08a3a5c..d3bd868ec7 100644
--- a/src/sage/rings/integer.pyx
+++ b/src/sage/rings/integer.pyx
@@ -7480,11 +7480,6 @@ cdef integer(x):
         return x
     return Integer(x)

-cdef inline Integer _Integer_from_mpz(mpz_t e):
-    cdef Integer z = Integer.__new__(Integer)
-    mpz_set(z.value, e)
-    return z
-
 def free_integer_pool():
     cdef int i
     cdef PyObject *o
```

This passes all the tests for me now, but I am still a bit confused about the issue – particularly because it occured with some randomness.



---

archive/issue_comments_466703.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164\"><code>ed94d9e</code></a></td><td><code>Moving the function to the pxd file.</code></td></tr></table>\n",
    "created_at": "2020-07-09T01:55:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466703",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164"><code>ed94d9e</code></a></td><td><code>Moving the function to the pxd file.</code></td></tr></table>




---

archive/issue_comments_466704.json:
```json
{
    "body": "Changed commit from **[`cdebca7`](https://github.com/sagemath/sagetrac-mirror/commit/cdebca73a7d4314994a96afa1bdd583b5bc80b96)** to **[`ed94d9e`](https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164)**",
    "created_at": "2020-07-09T01:55:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466704",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`cdebca7`](https://github.com/sagemath/sagetrac-mirror/commit/cdebca73a7d4314994a96afa1bdd583b5bc80b96)** to **[`ed94d9e`](https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164)**



---

archive/issue_events_404735.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2020-07-09T02:00:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404735"
}
```



---

archive/issue_events_404736.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2020-07-09T02:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404736"
}
```



---

archive/issue_comments_466705.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThat is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?\n\nAnyways, I have pushed the change that works for you. It still works for me as well.",
    "created_at": "2020-07-09T02:00:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466705",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:26" align="right">comment:26</div>

That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?

Anyways, I have pushed the change that works for you. It still works for me as well.



---

archive/issue_events_404737.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-07-10T19:23:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404737"
}
```



---

archive/issue_events_404738.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-07-10T19:23:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404738"
}
```



---

archive/issue_comments_466706.json:
```json
{
    "body": "Changed reviewer from **Fr\u00e9d\u00e9ric Chapoton** to **Fr\u00e9d\u00e9ric Chapoton, Markus Wageringel**",
    "created_at": "2020-07-10T19:23:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466706",
    "user": "https://github.com/mwageringel"
}
```

Changed reviewer from **Frédéric Chapoton** to **Frédéric Chapoton, Markus Wageringel**



---

archive/issue_events_404739.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-07-10T19:23:09Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "title_is": "replace tuples by mpz vectors in free abelian monoids",
    "title_was": "replace tuples by ETuples in free abelian monoids",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404739"
}
```



---

archive/issue_comments_466707.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@tscrim](#comment:26):\n> That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?\n\nNo \u2013 just with that branch. Maybe it is a Cython bug, but I do no think I will be able to debug this much further.\n\n> Anyways, I have pushed the change that works for you. It still works for me as well.\n\nThank you. I think we can move forward with this now, so I am setting this to positive.",
    "created_at": "2020-07-10T19:23:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466707",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@tscrim](#comment:26):
> That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?

No – just with that branch. Maybe it is a Cython bug, but I do no think I will be able to debug this much further.

> Anyways, I have pushed the change that works for you. It still works for me as well.

Thank you. I think we can move forward with this now, so I am setting this to positive.



---

archive/issue_comments_466708.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,11 +1,11 @@\n-This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents in an `ETuple` instead of a tuple in order to make use of the cythonized arithmetics implemented for `ETuple`. This makes multiplication about twice as fast:\n+This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents as `mpz_t*` array (copied in part from `vector_integer_dense`). The file is cythonized for this. This makes multiplication much faster (from [comment:10](#comment:10)):\n \n ```\n M = FreeAbelianMonoid('x', 5)\n L = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]\n %timeit _ = [a * b for a in L for b in L]\n-# 1 loop, best of 5: 7.34 s per loop  (before)\n-# 1 loop, best of 5: 4.07 s per loop  (after)\n+1 loop, best of 5: 1.7 s per loop  -- (before)\n+1 loop, best of 5: 282 ms per loop  -- (after)\n ```\n \n Another motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.\n``````\n",
    "created_at": "2020-07-10T19:23:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466708",
    "user": "https://github.com/mwageringel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,11 +1,11 @@
-This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents in an `ETuple` instead of a tuple in order to make use of the cythonized arithmetics implemented for `ETuple`. This makes multiplication about twice as fast:
+This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents as `mpz_t*` array (copied in part from `vector_integer_dense`). The file is cythonized for this. This makes multiplication much faster (from [comment:10](#comment:10)):
 
 ```
 M = FreeAbelianMonoid('x', 5)
 L = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]
 %timeit _ = [a * b for a in L for b in L]
-# 1 loop, best of 5: 7.34 s per loop  (before)
-# 1 loop, best of 5: 4.07 s per loop  (after)
+1 loop, best of 5: 1.7 s per loop  -- (before)
+1 loop, best of 5: 282 ms per loop  -- (after)
 ```
 
 Another motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.
``````




---

archive/issue_events_404740.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-12T08:30:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404740"
}
```



---

archive/issue_events_404741.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "62618754a71b0e36057f2c0f6d408840c47dcab4",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-07-12T08:30:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29638#event-404741"
}
```



---

archive/issue_comments_466709.json:
```json
{
    "body": "Changed branch from **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)** to **[`ed94d9e`](https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164)**",
    "created_at": "2020-07-12T08:30:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29638#issuecomment-466709",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/monoids/faster_free_abelian_monoid_elt-29638](https://github.com/sagemath/sagetrac-mirror/tree/public/monoids/faster_free_abelian_monoid_elt-29638)** to **[`ed94d9e`](https://github.com/sagemath/sagetrac-mirror/commit/ed94d9edfabb97eb1a3fe46a06a447f26a8d8164)**
