# Issue 29139: *.pxi files might not be Python3-ready

archive/issues_028902.json:
```json
{
    "assignees": [],
    "body": "This manifests itself in `%%cython` magic, e.g.\n\n```\nsage: %%cython\n....: include \"sage/data_structures/bitset.pxi\"\n```\nleads to \n\n```\nRuntimeError: Error compiling Cython file:\n------------------------------------------------------------\n...\n    \"\"\"\n    if size <= 0:\n        raise ValueError(\"bitset capacity must be greater than 0\")\n\n    bits.size = size\n    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1\n                                                     ^\n------------------------------------------------------------\n\n/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/data_structures/bitset.pxi:84:54: Cannot assign type 'double' to 'mp_size_t'\n...\n```\n\nthis was reported on [sage-support](https://groups.google.com/d/msg/sage-support/akv4XU-vcbo/MPGYETpRAQAJ)\n\nWe fix this by setting `cdivision=True` as a default for loading cython. This is the same as when compiling sage.\n\nCC:  @fchapoton\n\nKeywords: **bitset, floor division**\n\nBranch/Commit: **[ff8ac09](https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7)**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Jonathan Kliem**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29139_\n\n",
    "closed_at": "2020-08-26T21:17:47Z",
    "created_at": "2020-02-02T11:49:37Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "*.pxi files might not be Python3-ready",
    "type": "issue",
    "updated_at": "2020-08-26T21:17:47Z",
    "url": "https://github.com/sagemath/sage/issues/29139",
    "user": "https://github.com/dimpase"
}
```
This manifests itself in `%%cython` magic, e.g.

```
sage: %%cython
....: include "sage/data_structures/bitset.pxi"
```
leads to 

```
RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...
    """
    if size <= 0:
        raise ValueError("bitset capacity must be greater than 0")

    bits.size = size
    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
                                                     ^
------------------------------------------------------------

/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/data_structures/bitset.pxi:84:54: Cannot assign type 'double' to 'mp_size_t'
...
```

this was reported on [sage-support](https://groups.google.com/d/msg/sage-support/akv4XU-vcbo/MPGYETpRAQAJ)

We fix this by setting `cdivision=True` as a default for loading cython. This is the same as when compiling sage.

CC:  @fchapoton

Keywords: **bitset, floor division**

Branch/Commit: **[ff8ac09](https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7)**

Reviewer: **Dima Pasechnik**

Author: **Jonathan Kliem**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/29139_





---

archive/issue_events_400539.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-02T11:49:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400539"
}
```



---

archive/issue_events_400540.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-02T11:49:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400540"
}
```



---

archive/issue_events_400541.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-02T11:49:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400541"
}
```



---

archive/issue_events_400542.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-02T11:49:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400542"
}
```



---

archive/issue_comments_456827.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,4 +23,4 @@\n ...\n ```\n \n-this was reported on sage-support\n+this was reported on [sage-support](https://groups.google.com/d/msg/sage-support/akv4XU-vcbo/MPGYETpRAQAJ)\n``````\n",
    "created_at": "2020-02-02T11:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456827",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,4 +23,4 @@
 ...
 ```
 
-this was reported on sage-support
+this was reported on [sage-support](https://groups.google.com/d/msg/sage-support/akv4XU-vcbo/MPGYETpRAQAJ)
``````




---

archive/issue_comments_456828.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\n\n```diff\n--- a/src/sage/data_structures/bitset.pxi\n+++ b/src/sage/data_structures/bitset.pxi\n@@ -81,7 +81,7 @@ cdef inline bint bitset_init(bitset_t bits, mp_bitcnt_t size) except -1:\n         raise ValueError(\"bitset capacity must be greater than 0\")\n \n     bits.size = size\n-    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1\n+    bits.limbs = (size - 1) // (8 * sizeof(mp_limb_t)) + 1\n     bits.bits = <mp_limb_t*>check_calloc(bits.limbs, sizeof(mp_limb_t))\n \n cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:\n@@ -96,7 +96,7 @@ cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:\n     if size <= 0:\n         raise ValueError(\"bitset capacity must be greater than 0\")\n \n-    cdef mp_size_t limbs_new = (size - 1) / (8 * sizeof(mp_limb_t)) + 1\n+    cdef mp_size_t limbs_new = (size - 1) // (8 * sizeof(mp_limb_t)) + 1\n     bits.bits = <mp_limb_t*>check_reallocarray(bits.bits, limbs_new, sizeof(mp_limb_t))\n     bits.size = size\n     bits.limbs = limbs_new\n```\nallow the command in the ticket description to pass, and the tests still pass.",
    "created_at": "2020-02-02T19:33:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456828",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:2" align="right">comment:2</div>


```diff
--- a/src/sage/data_structures/bitset.pxi
+++ b/src/sage/data_structures/bitset.pxi
@@ -81,7 +81,7 @@ cdef inline bint bitset_init(bitset_t bits, mp_bitcnt_t size) except -1:
         raise ValueError("bitset capacity must be greater than 0")
 
     bits.size = size
-    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
+    bits.limbs = (size - 1) // (8 * sizeof(mp_limb_t)) + 1
     bits.bits = <mp_limb_t*>check_calloc(bits.limbs, sizeof(mp_limb_t))
 
 cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:
@@ -96,7 +96,7 @@ cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:
     if size <= 0:
         raise ValueError("bitset capacity must be greater than 0")
 
-    cdef mp_size_t limbs_new = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
+    cdef mp_size_t limbs_new = (size - 1) // (8 * sizeof(mp_limb_t)) + 1
     bits.bits = <mp_limb_t*>check_reallocarray(bits.bits, limbs_new, sizeof(mp_limb_t))
     bits.size = size
     bits.limbs = limbs_new
```
allow the command in the ticket description to pass, and the tests still pass.



---

archive/issue_comments_456829.json:
```json
{
    "body": "Branch: **[public/29139](https://github.com/sagemath/sagetrac-mirror/tree/public/29139)**",
    "created_at": "2020-02-04T09:06:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456829",
    "user": "https://github.com/kliem"
}
```

Branch: **[public/29139](https://github.com/sagemath/sagetrac-mirror/tree/public/29139)**



---

archive/issue_comments_456830.json:
```json
{
    "body": "Commit: **[0399905](https://github.com/sagemath/sagetrac-mirror/commit/0399905d181705c34292df19ff2692995323f3bd)**",
    "created_at": "2020-02-04T09:06:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456830",
    "user": "https://github.com/kliem"
}
```

Commit: **[0399905](https://github.com/sagemath/sagetrac-mirror/commit/0399905d181705c34292df19ff2692995323f3bd)**



---

archive/issue_comments_456831.json:
```json
{
    "body": "Author: **Jonathan Kliem**",
    "created_at": "2020-02-04T09:06:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456831",
    "user": "https://github.com/kliem"
}
```

Author: **Jonathan Kliem**



---

archive/issue_events_400543.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-02-04T09:06:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400543"
}
```



---

archive/issue_comments_456832.json:
```json
{
    "body": "Changed keywords from none to **bitset, floor division**",
    "created_at": "2020-02-04T09:06:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456832",
    "user": "https://github.com/kliem"
}
```

Changed keywords from none to **bitset, floor division**



---

archive/issue_comments_456833.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nClearly, floor division was intended at that place.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0399905d181705c34292df19ff2692995323f3bd\">0399905</a></td><td><code>use floor division to determine allocation size in bitset.pxi</code></td></tr></table>\n",
    "created_at": "2020-02-04T09:06:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456833",
    "user": "https://github.com/kliem"
}
```

<div id="comment:3" align="right">comment:3</div>

Clearly, floor division was intended at that place.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0399905d181705c34292df19ff2692995323f3bd">0399905</a></td><td><code>use floor division to determine allocation size in bitset.pxi</code></td></tr></table>




---

archive/issue_comments_456834.json:
```json
{
    "body": "Changed author from **Jonathan Kliem** to **Chin-Hung Lin, Jonathan Kliem**",
    "created_at": "2020-02-04T09:19:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456834",
    "user": "https://github.com/kliem"
}
```

Changed author from **Jonathan Kliem** to **Chin-Hung Lin, Jonathan Kliem**



---

archive/issue_comments_456835.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAt least one more error with floor division.",
    "created_at": "2020-02-04T09:19:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456835",
    "user": "https://github.com/kliem"
}
```

<div id="comment:4" align="right">comment:4</div>

At least one more error with floor division.



---

archive/issue_events_400544.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-02-04T09:19:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400544"
}
```



---

archive/issue_events_400545.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-02-04T09:19:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400545"
}
```



---

archive/issue_comments_456836.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nCould you check (with %%cython magic) all the *.pxi files for this sort of problem?",
    "created_at": "2020-02-04T10:00:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456836",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:5" align="right">comment:5</div>

Could you check (with %%cython magic) all the *.pxi files for this sort of problem?



---

archive/issue_comments_456837.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nYes, I'm doing it right now.",
    "created_at": "2020-02-04T10:04:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456837",
    "user": "https://github.com/kliem"
}
```

<div id="comment:6" align="right">comment:6</div>

Yes, I'm doing it right now.



---

archive/issue_comments_456838.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nWhy does this happen? The variable `size` in the code has type `mp_bitcnt_t` which is a gmp typedef for `unsigned long`. The code thus only involves C types, so the `/`-division should return an integer. Changing this to `//`-division does not look like the correct solution to me, as it just cures a symptom.\n\nThe underlying problem might be in the `%%cython` magic itself.",
    "created_at": "2020-02-04T17:26:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456838",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:7" align="right">comment:7</div>

Why does this happen? The variable `size` in the code has type `mp_bitcnt_t` which is a gmp typedef for `unsigned long`. The code thus only involves C types, so the `/`-division should return an integer. Changing this to `//`-division does not look like the correct solution to me, as it just cures a symptom.

The underlying problem might be in the `%%cython` magic itself.



---

archive/issue_comments_456839.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThe problem is in the magic, no question about it, as \"normal\", non-interactive, use of these files is indeed OK. I proposed here a \"cheap\" way of fixing the problem, by merely making the code Python3-compatible. \n\nFeel free to dig into `%%cython`.",
    "created_at": "2020-02-04T17:38:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456839",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

The problem is in the magic, no question about it, as "normal", non-interactive, use of these files is indeed OK. I proposed here a "cheap" way of fixing the problem, by merely making the code Python3-compatible. 

Feel free to dig into `%%cython`.



---

archive/issue_comments_456840.json:
```json
{
    "body": "Changed commit from **[0399905](https://github.com/sagemath/sagetrac-mirror/commit/0399905d181705c34292df19ff2692995323f3bd)** to **[3ec6c1d](https://github.com/sagemath/sagetrac-mirror/commit/3ec6c1dbd36cffb8d74bae43090212852ceb7419)**",
    "created_at": "2020-02-05T09:31:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456840",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[0399905](https://github.com/sagemath/sagetrac-mirror/commit/0399905d181705c34292df19ff2692995323f3bd)** to **[3ec6c1d](https://github.com/sagemath/sagetrac-mirror/commit/3ec6c1dbd36cffb8d74bae43090212852ceb7419)**



---

archive/issue_comments_456841.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ec6c1dbd36cffb8d74bae43090212852ceb7419\">3ec6c1d</a></td><td><code>fixed some floor division errors, added doctests</code></td></tr></table>\n",
    "created_at": "2020-02-05T09:31:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456841",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ec6c1dbd36cffb8d74bae43090212852ceb7419">3ec6c1d</a></td><td><code>fixed some floor division errors, added doctests</code></td></tr></table>




---

archive/issue_events_400546.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-02-05T09:37:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400546"
}
```



---

archive/issue_events_400547.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-02-05T09:37:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400547"
}
```



---

archive/issue_comments_456842.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nAs mentioned, I found a few more instances.\n\nI looked into all `.pxi` files. However the files with corresponding header are really hard to test, e.g.\n\n`/matrix/matrix_modn_dense_template_header.pxi`\n`/matrix/matrix_modn_dense_template.pxi`\n\nIt is assumed that the header is included into a `pxd` file and the other into the corresponding `pyx` file. So I guess it is really not meant to work with `%%cython`.\n\nI got the test down to a few warnings but that was about it. Also it is annoying to search for the correct things to import first, as some of the `pxi` files assume lots of imports already.",
    "created_at": "2020-02-05T09:37:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456842",
    "user": "https://github.com/kliem"
}
```

<div id="comment:10" align="right">comment:10</div>

As mentioned, I found a few more instances.

I looked into all `.pxi` files. However the files with corresponding header are really hard to test, e.g.

`/matrix/matrix_modn_dense_template_header.pxi`
`/matrix/matrix_modn_dense_template.pxi`

It is assumed that the header is included into a `pxd` file and the other into the corresponding `pyx` file. So I guess it is really not meant to work with `%%cython`.

I got the test down to a few warnings but that was about it. Also it is annoying to search for the correct things to import first, as some of the `pxi` files assume lots of imports already.



---

archive/issue_comments_456843.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe issue can be reproduced by cythonizing this file\n\n```\n# file division.pyx\ncdef int a = -6\ncdef int b = 5\ncdef int c = 0\nc = a / b\n```\nwith this setup using `sage -python`:\n\n```\nfrom distutils.core import Extension\nfrom Cython.Build import cythonize\next = Extension(\"division\", sources=[\"division.pyx\"])\nres = cythonize([ext], compiler_directives=dict(language_level=3))\n```\n\nThe problem is a missing compiler directive `cdivision=True`, which enforces C semantics instead of Python semantics for division. The [Cython docs](https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives) say:\n\n> cdivision (True / False)\n\n>\n> If set to False, Cython will adjust the remainder and quotient operators C types to match those of Python ints (which differ when the operands have opposite signs) and raise a ZeroDivisionError when the right operand is 0. This has up to a 35% speed penalty. If set to True, no checks are performed. See CEP 516. Default is False.\n\nI am rather surprised that this does not mention anything about the division operator returning double instead of int with Python 3, so I can only assume that this tries to match Python 3 semantics now.\n\nThe directive is also set in `src/setup.py` for all of Sage, so I suggest to solve this by setting it in `sage.misc.cython` as well (and the other compiler directives might be worth checking, too):\n\n```diff\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -315,7 +315,8 @@ def cython(filename, verbose=0, compile_message=False,\n                     libraries=standard_libs,\n                     library_dirs=standard_libdirs)\n\n-    directives = dict(language_level=sys.version_info[0])\n+    directives = dict(language_level=sys.version_info[0],\n+                      cdivision=True)\n\n     try:\n         # Change directories to target_dir so that Cython produces the correct\n```\n\nIn the example above, the value of `c` changes from `-2` (Python floor) to `-1` (C truncation towards 0).\n\nThe compiler directive can also be set directly:\n\n```\nsage: %%cython\n....: # cython: cdivision=True\n....: include \"sage/data_structures/bitset.pxi\"\n```",
    "created_at": "2020-02-05T22:15:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456843",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:11" align="right">comment:11</div>

The issue can be reproduced by cythonizing this file

```
# file division.pyx
cdef int a = -6
cdef int b = 5
cdef int c = 0
c = a / b
```
with this setup using `sage -python`:

```
from distutils.core import Extension
from Cython.Build import cythonize
ext = Extension("division", sources=["division.pyx"])
res = cythonize([ext], compiler_directives=dict(language_level=3))
```

The problem is a missing compiler directive `cdivision=True`, which enforces C semantics instead of Python semantics for division. The [Cython docs](https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives) say:

> cdivision (True / False)

>
> If set to False, Cython will adjust the remainder and quotient operators C types to match those of Python ints (which differ when the operands have opposite signs) and raise a ZeroDivisionError when the right operand is 0. This has up to a 35% speed penalty. If set to True, no checks are performed. See CEP 516. Default is False.

I am rather surprised that this does not mention anything about the division operator returning double instead of int with Python 3, so I can only assume that this tries to match Python 3 semantics now.

The directive is also set in `src/setup.py` for all of Sage, so I suggest to solve this by setting it in `sage.misc.cython` as well (and the other compiler directives might be worth checking, too):

```diff
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -315,7 +315,8 @@ def cython(filename, verbose=0, compile_message=False,
                     libraries=standard_libs,
                     library_dirs=standard_libdirs)

-    directives = dict(language_level=sys.version_info[0])
+    directives = dict(language_level=sys.version_info[0],
+                      cdivision=True)

     try:
         # Change directories to target_dir so that Cython produces the correct
```

In the example above, the value of `c` changes from `-2` (Python floor) to `-1` (C truncation towards 0).

The compiler directive can also be set directly:

```
sage: %%cython
....: # cython: cdivision=True
....: include "sage/data_structures/bitset.pxi"
```



---

archive/issue_comments_456844.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?\n\nFor a start, you could do the change proposed plus enable `cdivision_warnings` and see if all doctests still pass. Long term this might be desirable, but it seems like a lot of work to me. Note that python division is still available for python objects:\n\n```\nsage: cython('''\n....: # cython: cdivision=True\n....: def test(a,b): return a/b\n....: ''')\nsage: test(2,3)\n2/3\n```\n\nI think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.",
    "created_at": "2020-02-06T07:03:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456844",
    "user": "https://github.com/kliem"
}
```

<div id="comment:12" align="right">comment:12</div>

I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?

For a start, you could do the change proposed plus enable `cdivision_warnings` and see if all doctests still pass. Long term this might be desirable, but it seems like a lot of work to me. Note that python division is still available for python objects:

```
sage: cython('''
....: # cython: cdivision=True
....: def test(a,b): return a/b
....: ''')
sage: test(2,3)
2/3
```

I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.



---

archive/issue_comments_456845.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@kliem](#comment:12):\n> I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?\n\nThe directive is already enabled for all of Sage, so I was suggesting to do the same for the `%%cython`-magic, for compatibility with the Sage library. Of course, Sage's default (`cdivision=True`) is different from Cython's default. We can only adhere to one of them when setting the default for the `%%cython`-magic, and both values have their justification. For use with code from the Sage library, it is desirable to enable it, but for use with external Cython code, this can be unexpected as it is not Cython's default.\n\nOne could argue that it is the responsibility of the user of the `%%cython`-magic to ensure that those compiler directives are set that are needed for the included code.\n\nThis also extends to other directives. For example, Sage is compiled with `language_level=\"3str\"`, but the `%%cython`-magic sets it to `2` or `3` depending on the Python version. I think it is wrong to assume that including code from the Sage library will just work without adjusting this setting.\n\n> I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.\n\nIndeed, we could add all compiler directives to the top of every Cython file. I am not sure if this is desirable from a maintainability point of view, as this duplicates code in a lot of places. Though, at least this has the advantage that one cannot accidentally compile a file with the wrong semantics.\n\nTo be honest, I do not know what the best thing to do here is.",
    "created_at": "2020-02-07T22:33:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456845",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@kliem](#comment:12):
> I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?

The directive is already enabled for all of Sage, so I was suggesting to do the same for the `%%cython`-magic, for compatibility with the Sage library. Of course, Sage's default (`cdivision=True`) is different from Cython's default. We can only adhere to one of them when setting the default for the `%%cython`-magic, and both values have their justification. For use with code from the Sage library, it is desirable to enable it, but for use with external Cython code, this can be unexpected as it is not Cython's default.

One could argue that it is the responsibility of the user of the `%%cython`-magic to ensure that those compiler directives are set that are needed for the included code.

This also extends to other directives. For example, Sage is compiled with `language_level="3str"`, but the `%%cython`-magic sets it to `2` or `3` depending on the Python version. I think it is wrong to assume that including code from the Sage library will just work without adjusting this setting.

> I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.

Indeed, we could add all compiler directives to the top of every Cython file. I am not sure if this is desirable from a maintainability point of view, as this duplicates code in a lot of places. Though, at least this has the advantage that one cannot accidentally compile a file with the wrong semantics.

To be honest, I do not know what the best thing to do here is.



---

archive/issue_comments_456846.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI don't think we should add compiler directives to every cython file.\n\nAnyway, my \"fix\" is merely a suggestion. If you or anyone wants to go down a different road that's totally fine with me. Just add your own branch and remove me as author. That's totally fine with me.",
    "created_at": "2020-02-10T09:01:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456846",
    "user": "https://github.com/kliem"
}
```

<div id="comment:14" align="right">comment:14</div>

I don't think we should add compiler directives to every cython file.

Anyway, my "fix" is merely a suggestion. If you or anyone wants to go down a different road that's totally fine with me. Just add your own branch and remove me as author. That's totally fine with me.



---

archive/issue_comments_456847.json:
```json
{
    "body": "Changed commit from **[3ec6c1d](https://github.com/sagemath/sagetrac-mirror/commit/3ec6c1dbd36cffb8d74bae43090212852ceb7419)** to **[e32a6dd](https://github.com/sagemath/sagetrac-mirror/commit/e32a6ddb7ac164052bc1797adf7960bc8fcc1e13)**",
    "created_at": "2020-04-01T15:11:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456847",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[3ec6c1d](https://github.com/sagemath/sagetrac-mirror/commit/3ec6c1dbd36cffb8d74bae43090212852ceb7419)** to **[e32a6dd](https://github.com/sagemath/sagetrac-mirror/commit/e32a6ddb7ac164052bc1797adf7960bc8fcc1e13)**



---

archive/issue_comments_456848.json:
```json
{
    "body": "Changed branch from **[public/29139](https://github.com/sagemath/sagetrac-mirror/tree/public/29139)** to **[public/29139-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29139-reb)**",
    "created_at": "2020-04-01T15:11:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456848",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/29139](https://github.com/sagemath/sagetrac-mirror/tree/public/29139)** to **[public/29139-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29139-reb)**



---

archive/issue_comments_456849.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b015ae2f1dd59b185fbe6c2feb53130cf378c109\">b015ae2</a></td><td><code>use floor division to determine allocation size in bitset.pxi</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6368310bdbe727a935bdbed745862abdf1faa3e0\">6368310</a></td><td><code>fixed some floor division errors, added doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e32a6ddb7ac164052bc1797adf7960bc8fcc1e13\">e32a6dd</a></td><td><code>removed doctests testing strange includes</code></td></tr></table>\n",
    "created_at": "2020-04-01T15:11:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456849",
    "user": "https://github.com/kliem"
}
```

<div id="comment:15"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b015ae2f1dd59b185fbe6c2feb53130cf378c109">b015ae2</a></td><td><code>use floor division to determine allocation size in bitset.pxi</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6368310bdbe727a935bdbed745862abdf1faa3e0">6368310</a></td><td><code>fixed some floor division errors, added doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e32a6ddb7ac164052bc1797adf7960bc8fcc1e13">e32a6dd</a></td><td><code>removed doctests testing strange includes</code></td></tr></table>




---

archive/issue_comments_456850.json:
```json
{
    "body": "Changed commit from **[e32a6dd](https://github.com/sagemath/sagetrac-mirror/commit/e32a6ddb7ac164052bc1797adf7960bc8fcc1e13)** to **[11432c5](https://github.com/sagemath/sagetrac-mirror/commit/11432c5e075a7fa494aee5bd75fb0e21b247ad10)**",
    "created_at": "2020-04-01T15:14:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456850",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e32a6dd](https://github.com/sagemath/sagetrac-mirror/commit/e32a6ddb7ac164052bc1797adf7960bc8fcc1e13)** to **[11432c5](https://github.com/sagemath/sagetrac-mirror/commit/11432c5e075a7fa494aee5bd75fb0e21b247ad10)**



---

archive/issue_comments_456851.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/11432c5e075a7fa494aee5bd75fb0e21b247ad10\">11432c5</a></td><td><code>undid changes in flint/nmod_poly_linkage.pxi</code></td></tr></table>\n",
    "created_at": "2020-04-01T15:14:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456851",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/11432c5e075a7fa494aee5bd75fb0e21b247ad10">11432c5</a></td><td><code>undid changes in flint/nmod_poly_linkage.pxi</code></td></tr></table>




---

archive/issue_comments_456852.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI removed long or meaningless doctest and undid some changes.\n\nI checked that I added floor division only in files, where floor division was used at least once before. So I think those changes should be made in order to make those files consistent.\n\n(I just wrote some code, where I needed `bitset.pxi` and it is annoying that you cannot include it unless you set `# cython: cdivion=True`, which creates other problems.)",
    "created_at": "2020-04-01T15:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456852",
    "user": "https://github.com/kliem"
}
```

<div id="comment:17" align="right">comment:17</div>

I removed long or meaningless doctest and undid some changes.

I checked that I added floor division only in files, where floor division was used at least once before. So I think those changes should be made in order to make those files consistent.

(I just wrote some code, where I needed `bitset.pxi` and it is annoying that you cannot include it unless you set `# cython: cdivion=True`, which creates other problems.)



---

archive/issue_events_400548.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-04-01T20:19:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400548"
}
```



---

archive/issue_events_400549.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-04-01T20:19:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400549"
}
```



---

archive/issue_comments_456853.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAdding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.\n\nReplacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.",
    "created_at": "2020-04-01T20:19:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456853",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:18" align="right">comment:18</div>

Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.

Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.



---

archive/issue_comments_456854.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a82786b03d9c749a3b0875280e997acac7546e3b\">a82786b</a></td><td><code>undo possible wrong floor division</code></td></tr></table>\n",
    "created_at": "2020-04-02T07:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456854",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a82786b03d9c749a3b0875280e997acac7546e3b">a82786b</a></td><td><code>undo possible wrong floor division</code></td></tr></table>




---

archive/issue_comments_456855.json:
```json
{
    "body": "Changed commit from **[11432c5](https://github.com/sagemath/sagetrac-mirror/commit/11432c5e075a7fa494aee5bd75fb0e21b247ad10)** to **[a82786b](https://github.com/sagemath/sagetrac-mirror/commit/a82786b03d9c749a3b0875280e997acac7546e3b)**",
    "created_at": "2020-04-02T07:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456855",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[11432c5](https://github.com/sagemath/sagetrac-mirror/commit/11432c5e075a7fa494aee5bd75fb0e21b247ad10)** to **[a82786b](https://github.com/sagemath/sagetrac-mirror/commit/a82786b03d9c749a3b0875280e997acac7546e3b)**



---

archive/issue_comments_456856.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9987fac9bf6b8e81006da342f84756b14da0dd25\">9987fac</a></td><td><code>undo possible wrong floor division</code></td></tr></table>\n",
    "created_at": "2020-04-02T07:12:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456856",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9987fac9bf6b8e81006da342f84756b14da0dd25">9987fac</a></td><td><code>undo possible wrong floor division</code></td></tr></table>




---

archive/issue_comments_456857.json:
```json
{
    "body": "Changed commit from **[a82786b](https://github.com/sagemath/sagetrac-mirror/commit/a82786b03d9c749a3b0875280e997acac7546e3b)** to **[9987fac](https://github.com/sagemath/sagetrac-mirror/commit/9987fac9bf6b8e81006da342f84756b14da0dd25)**",
    "created_at": "2020-04-02T07:12:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456857",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[a82786b](https://github.com/sagemath/sagetrac-mirror/commit/a82786b03d9c749a3b0875280e997acac7546e3b)** to **[9987fac](https://github.com/sagemath/sagetrac-mirror/commit/9987fac9bf6b8e81006da342f84756b14da0dd25)**



---

archive/issue_comments_456858.json:
```json
{
    "body": "Changed commit from **[9987fac](https://github.com/sagemath/sagetrac-mirror/commit/9987fac9bf6b8e81006da342f84756b14da0dd25)** to **[51d4110](https://github.com/sagemath/sagetrac-mirror/commit/51d41106885afd8a37fa86c801f88612ac69c510)**",
    "created_at": "2020-04-02T07:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456858",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9987fac](https://github.com/sagemath/sagetrac-mirror/commit/9987fac9bf6b8e81006da342f84756b14da0dd25)** to **[51d4110](https://github.com/sagemath/sagetrac-mirror/commit/51d41106885afd8a37fa86c801f88612ac69c510)**



---

archive/issue_comments_456859.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/51d41106885afd8a37fa86c801f88612ac69c510\">51d4110</a></td><td><code>undo possible wrong floor division</code></td></tr></table>\n",
    "created_at": "2020-04-02T07:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456859",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/51d41106885afd8a37fa86c801f88612ac69c510">51d4110</a></td><td><code>undo possible wrong floor division</code></td></tr></table>




---

archive/issue_events_400550.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-02T07:13:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400550"
}
```



---

archive/issue_events_400551.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-02T07:13:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400551"
}
```



---

archive/issue_comments_456860.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThanks. I finally understood the problem, I think.\n\nIn bitset.pxi this change is certainly justified as there is a check that `not size <= 0` just before that. Other than that there is only floor division in `bitset.pxi` (and given the nature of that file, it's not surprising). So this can be included no matter whether `cdivision` is set true or not. `binary_matrix.pxi` doesn't do any division and just includes `bitset.pxi`.\n\n`point_c.pxi` does exactly one division and that is of floats.\n\n`algebra_elements.pxi` does exactly one floor division.\n\nReplying to [@mwageringel](#comment:18):\n> Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.\n> \n> Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.",
    "created_at": "2020-04-02T07:20:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456860",
    "user": "https://github.com/kliem"
}
```

<div id="comment:23" align="right">comment:23</div>

Thanks. I finally understood the problem, I think.

In bitset.pxi this change is certainly justified as there is a check that `not size <= 0` just before that. Other than that there is only floor division in `bitset.pxi` (and given the nature of that file, it's not surprising). So this can be included no matter whether `cdivision` is set true or not. `binary_matrix.pxi` doesn't do any division and just includes `bitset.pxi`.

`point_c.pxi` does exactly one division and that is of floats.

`algebra_elements.pxi` does exactly one floor division.

Replying to [@mwageringel](#comment:18):
> Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.
> 
> Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.



---

archive/issue_comments_456861.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nSorry if this was not very clear before. This is the effect of `cdivision` on the division operations of integers:\n\n| cdivision     | False         | True                            |\n|:---------------:|:---------------:|:---------------------------------:|\n| `/`           | true division   |  truncating division towards 0    |\n| `//`          | floor division  |  truncating division towards 0    |\n\nSince sagelib is compiled with `cdivision=True`, the `//` operator is a priori different from floor division (which would be used by the cython magic).\n\nPersonally, I do not feel comfortable with giving this a positive review as compiling a file with two different `cdivision` directives does not make sense to me. If anyone else wants to review this though, please go ahead.",
    "created_at": "2020-04-03T19:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456861",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:24" align="right">comment:24</div>

Sorry if this was not very clear before. This is the effect of `cdivision` on the division operations of integers:

| cdivision     | False         | True                            |
|:---------------:|:---------------:|:---------------------------------:|
| `/`           | true division   |  truncating division towards 0    |
| `//`          | floor division  |  truncating division towards 0    |

Since sagelib is compiled with `cdivision=True`, the `//` operator is a priori different from floor division (which would be used by the cython magic).

Personally, I do not feel comfortable with giving this a positive review as compiling a file with two different `cdivision` directives does not make sense to me. If anyone else wants to review this though, please go ahead.



---

archive/issue_comments_456862.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThanks for the comment.\n\nHowever, the problem is not clear to me. (I'm totally fine with removing any tests from the ticket.)\n\nAt least in `bitset.pxi` there is only division of positive integers and anything else doesn't make sense. So in this case `/` with `cdivivision=True` and `//` either way are the same, aren't they?\n\nThe other thing we could do is just leave a comment in the beginning of `bitset.pxi` that one should set `cdivision=True` in order to include this file.",
    "created_at": "2020-04-03T19:41:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456862",
    "user": "https://github.com/kliem"
}
```

<div id="comment:25" align="right">comment:25</div>

Thanks for the comment.

However, the problem is not clear to me. (I'm totally fine with removing any tests from the ticket.)

At least in `bitset.pxi` there is only division of positive integers and anything else doesn't make sense. So in this case `/` with `cdivivision=True` and `//` either way are the same, aren't they?

The other thing we could do is just leave a comment in the beginning of `bitset.pxi` that one should set `cdivision=True` in order to include this file.



---

archive/issue_comments_456863.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThe main question is: Should Sage support compiling its pxi files with both cdivision settings?\n\nIf yes, then your changes are needed. I think you are probably right in that `bitsets.pxi` only uses division on integers that are positive, so this could work. My main concern is that the tests cannot sufficiently check whether this works correctly, so even though this works today, it could easily break in the future without getting noticed. Still, the new tests are better than nothing, so I would keep them in this case.\n\nIf no, then it is not necessary to replace `/` by `//` as they behave the same. In fact, I would argue it is better to keep the `/` in this case because the compile time error, when using the wrong cdivision setting, is a prominent indication that one's compilation setup needs adjusting.\n\nPreviously, I assumed that including the cython directive at the top the file could be used to enforce the correct setting, but I have just tried it and it does not seem to work for pxi files.",
    "created_at": "2020-04-04T11:16:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456863",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:26" align="right">comment:26</div>

The main question is: Should Sage support compiling its pxi files with both cdivision settings?

If yes, then your changes are needed. I think you are probably right in that `bitsets.pxi` only uses division on integers that are positive, so this could work. My main concern is that the tests cannot sufficiently check whether this works correctly, so even though this works today, it could easily break in the future without getting noticed. Still, the new tests are better than nothing, so I would keep them in this case.

If no, then it is not necessary to replace `/` by `//` as they behave the same. In fact, I would argue it is better to keep the `/` in this case because the compile time error, when using the wrong cdivision setting, is a prominent indication that one's compilation setup needs adjusting.

Previously, I assumed that including the cython directive at the top the file could be used to enforce the correct setting, but I have just tried it and it does not seem to work for pxi files.



---

archive/issue_comments_456864.json:
```json
{
    "body": "<div id=\"comment:27\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/86f83417973dae5669c04825950a0a1390234bae\">86f8341</a></td><td><code>removed doctests that imply that cdivision can be True or False</code></td></tr></table>\n",
    "created_at": "2020-04-04T12:57:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456864",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:27"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/86f83417973dae5669c04825950a0a1390234bae">86f8341</a></td><td><code>removed doctests that imply that cdivision can be True or False</code></td></tr></table>




---

archive/issue_comments_456865.json:
```json
{
    "body": "Changed commit from **[51d4110](https://github.com/sagemath/sagetrac-mirror/commit/51d41106885afd8a37fa86c801f88612ac69c510)** to **[86f8341](https://github.com/sagemath/sagetrac-mirror/commit/86f83417973dae5669c04825950a0a1390234bae)**",
    "created_at": "2020-04-04T12:57:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456865",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[51d4110](https://github.com/sagemath/sagetrac-mirror/commit/51d41106885afd8a37fa86c801f88612ac69c510)** to **[86f8341](https://github.com/sagemath/sagetrac-mirror/commit/86f83417973dae5669c04825950a0a1390234bae)**



---

archive/issue_comments_456866.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI'm seeing the advantage of the solution you suggested in comment 11.\n\nIf I load a file into sage, I want it to behave exactly like if it would have been compiled in sage from the start. At the moment this is not the case.\n\nHowever, we would probably have to post a thread on sage-devel to see if anyone speaks up against it.",
    "created_at": "2020-04-04T13:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456866",
    "user": "https://github.com/kliem"
}
```

<div id="comment:28" align="right">comment:28</div>

I'm seeing the advantage of the solution you suggested in comment 11.

If I load a file into sage, I want it to behave exactly like if it would have been compiled in sage from the start. At the moment this is not the case.

However, we would probably have to post a thread on sage-devel to see if anyone speaks up against it.



---

archive/issue_comments_456867.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nYes, feel free to post about this on sage-devel.",
    "created_at": "2020-04-05T12:49:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456867",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:29" align="right">comment:29</div>

Yes, feel free to post about this on sage-devel.



---

archive/issue_events_400552.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400552"
}
```



---

archive/issue_events_400553.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400553"
}
```



---

archive/issue_comments_456868.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nMoving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456868",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">comment:30</div>

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_456869.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nHave the open questions here been resolved?",
    "created_at": "2020-08-11T17:29:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456869",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">comment:31</div>

Have the open questions here been resolved?



---

archive/issue_comments_456870.json:
```json
{
    "body": "Changed author from **Chin-Hung Lin, Jonathan Kliem** to none",
    "created_at": "2020-08-11T20:41:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456870",
    "user": "https://github.com/kliem"
}
```

Changed author from **Chin-Hung Lin, Jonathan Kliem** to none



---

archive/issue_events_400554.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-08-11T20:41:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400554"
}
```



---

archive/issue_events_400555.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-08-11T20:41:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400555"
}
```



---

archive/issue_comments_456871.json:
```json
{
    "body": "Changed branch from **[public/29139-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29139-reb)** to none",
    "created_at": "2020-08-11T20:41:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456871",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/29139-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29139-reb)** to none



---

archive/issue_comments_456872.json:
```json
{
    "body": "Changed commit from **[86f8341](https://github.com/sagemath/sagetrac-mirror/commit/86f83417973dae5669c04825950a0a1390234bae)** to none",
    "created_at": "2020-08-11T20:41:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456872",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[86f8341](https://github.com/sagemath/sagetrac-mirror/commit/86f83417973dae5669c04825950a0a1390234bae)** to none



---

archive/issue_comments_456873.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -24,3 +24,5 @@\n ```\n \n this was reported on [sage-support](https://groups.google.com/d/msg/sage-support/akv4XU-vcbo/MPGYETpRAQAJ)\n+\n+We fix this by setting `cdivision=True` as a default for loading cython. This is the same as when compiling sage.\n``````\n",
    "created_at": "2020-08-21T19:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456873",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -24,3 +24,5 @@
 ```
 
 this was reported on [sage-support](https://groups.google.com/d/msg/sage-support/akv4XU-vcbo/MPGYETpRAQAJ)
+
+We fix this by setting `cdivision=True` as a default for loading cython. This is the same as when compiling sage.
``````




---

archive/issue_comments_456874.json:
```json
{
    "body": "<div id=\"comment:33\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7\">ff8ac09</a></td><td><code>set cdvision to true by default with cython magic</code></td></tr></table>\n",
    "created_at": "2020-08-21T19:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456874",
    "user": "https://github.com/kliem"
}
```

<div id="comment:33"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7">ff8ac09</a></td><td><code>set cdvision to true by default with cython magic</code></td></tr></table>




---

archive/issue_comments_456875.json:
```json
{
    "body": "Author: **Jonathan Kliem**",
    "created_at": "2020-08-21T19:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456875",
    "user": "https://github.com/kliem"
}
```

Author: **Jonathan Kliem**



---

archive/issue_comments_456876.json:
```json
{
    "body": "Branch: **[u/gh-kliem/cdivision_true_for_cython_magic](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/cdivision_true_for_cython_magic)**",
    "created_at": "2020-08-21T19:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456876",
    "user": "https://github.com/kliem"
}
```

Branch: **[u/gh-kliem/cdivision_true_for_cython_magic](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/cdivision_true_for_cython_magic)**



---

archive/issue_events_400556.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-08-21T19:00:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400556"
}
```



---

archive/issue_events_400557.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-08-21T19:00:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400557"
}
```



---

archive/issue_comments_456877.json:
```json
{
    "body": "Commit: **[ff8ac09](https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7)**",
    "created_at": "2020-08-21T19:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456877",
    "user": "https://github.com/kliem"
}
```

Commit: **[ff8ac09](https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7)**



---

archive/issue_comments_456878.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nCould you make the new doctest self-contained, in the sense that it has the correct cimports etc\n(I suppose it passes as a doctest due to previous calls to `cython()`)\n\n```\nsage: cython(''' \n....: cdef size_t foo = 3/2 \n....: ''') \n---------------------------------------------------------------------------\nCompileError                              Traceback (most recent call last)\n...\nRuntimeError: Error compiling Cython file:\n------------------------------------------------------------\n...\n\ncdef size_t foo = Integer(3)/Integer(2)\n                 ^\n------------------------------------------------------------\n\n_home_dima__sage_temp_hilbert_8791_tmp_xcshejsd_pyx_0.pyx:2:18: undeclared name not builtin: Integer\n```",
    "created_at": "2020-08-22T11:40:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456878",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:34" align="right">comment:34</div>

Could you make the new doctest self-contained, in the sense that it has the correct cimports etc
(I suppose it passes as a doctest due to previous calls to `cython()`)

```
sage: cython(''' 
....: cdef size_t foo = 3/2 
....: ''') 
---------------------------------------------------------------------------
CompileError                              Traceback (most recent call last)
...
RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...

cdef size_t foo = Integer(3)/Integer(2)
                 ^
------------------------------------------------------------

_home_dima__sage_temp_hilbert_8791_tmp_xcshejsd_pyx_0.pyx:2:18: undeclared name not builtin: Integer
```



---

archive/issue_comments_456879.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\ni.e. please do\n\n```\nsage: cython(''' \n....: from sage.rings.integer cimport Integer \n....: cdef size_t foo = 3/2 \n....: ''')                                                                                                                           \n```",
    "created_at": "2020-08-22T11:54:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456879",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:35" align="right">comment:35</div>

i.e. please do

```
sage: cython(''' 
....: from sage.rings.integer cimport Integer 
....: cdef size_t foo = 3/2 
....: ''')                                                                                                                           
```



---

archive/issue_comments_456880.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nThis looks like #30417.\n\nThis shouldn't be parsed as `Integer(3)/Integer(2)`.",
    "created_at": "2020-08-22T12:59:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456880",
    "user": "https://github.com/kliem"
}
```

<div id="comment:36" align="right">comment:36</div>

This looks like #30417.

This shouldn't be parsed as `Integer(3)/Integer(2)`.



---

archive/issue_comments_456881.json:
```json
{
    "body": "Dependencies: **#30417**",
    "created_at": "2020-08-22T13:01:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456881",
    "user": "https://github.com/kliem"
}
```

Dependencies: **#30417**



---

archive/issue_comments_456882.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nImagine all your cython integers being parsed as sage integers. This would be awful.\n\nThe failure of #30417 only happens in the normal sage shell not during doctesting.",
    "created_at": "2020-08-22T13:07:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456882",
    "user": "https://github.com/kliem"
}
```

<div id="comment:38" align="right">comment:38</div>

Imagine all your cython integers being parsed as sage integers. This would be awful.

The failure of #30417 only happens in the normal sage shell not during doctesting.



---

archive/issue_comments_456883.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nOK, good point.",
    "created_at": "2020-08-22T14:14:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456883",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:39" align="right">comment:39</div>

OK, good point.



---

archive/issue_comments_456884.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2020-08-22T14:14:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456884",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_events_400558.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-08-22T14:14:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400558"
}
```



---

archive/issue_events_400559.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-08-22T14:14:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400559"
}
```



---

archive/issue_comments_456885.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nShould I remove the dependency? Thinking about it, this ticket doesn't really depend on #30417, although you cannot reproduce the doctest yet in the interactive shell.",
    "created_at": "2020-08-22T16:03:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456885",
    "user": "https://github.com/kliem"
}
```

<div id="comment:40" align="right">comment:40</div>

Should I remove the dependency? Thinking about it, this ticket doesn't really depend on #30417, although you cannot reproduce the doctest yet in the interactive shell.



---

archive/issue_comments_456886.json:
```json
{
    "body": "Changed dependencies from **#30417** to none",
    "created_at": "2020-08-22T19:39:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456886",
    "user": "https://github.com/dimpase"
}
```

Changed dependencies from **#30417** to none



---

archive/issue_comments_456887.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\n#30417 is a blocker, anyway, so it's OK to remove it from deps, regardless.",
    "created_at": "2020-08-22T19:39:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456887",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:41" align="right">comment:41</div>

#30417 is a blocker, anyway, so it's OK to remove it from deps, regardless.



---

archive/issue_comments_456888.json:
```json
{
    "body": "Changed branch from **[u/gh-kliem/cdivision_true_for_cython_magic](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/cdivision_true_for_cython_magic)** to **[ff8ac09](https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7)**",
    "created_at": "2020-08-26T21:17:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29139#issuecomment-456888",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/gh-kliem/cdivision_true_for_cython_magic](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/cdivision_true_for_cython_magic)** to **[ff8ac09](https://github.com/sagemath/sagetrac-mirror/commit/ff8ac0980645c6cc2d913dee55b03575bfbe48b7)**



---

archive/issue_events_400560.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-26T21:17:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400560"
}
```



---

archive/issue_events_400561.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "3198f30e27fc0af80aba72e94098c4c6161ac350",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-08-26T21:17:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29139",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29139#event-400561"
}
```
