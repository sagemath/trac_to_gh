# Issue 29345: replace bashisms in m4/sage_spkg_collect.m4, m4/sage_spkg_enable.m4, build/pkgs/*/spkg-configure.m4, src/bin/sage-env, build/make/Makefile.in

archive/issues_029108.json:
```json
{
    "body": "Autoconf scripts should be POSIX sh rather than bash, but there are a few bashisms in m4/sage_spkg_collect.m4 and m4/sage_spkg_enable.m4:\n\n* The quoted newlines `$'\\n'`\n* The use of `VAR+=VALUE`\n\nSome of these should be straightforward to fix. The format\n\n```\nSAGE_BUILT_PACKAGES+=\"    $SPKG_NAME \\\\\"$'\\n'\n```\n\ncan be changed to\n\n```\nSAGE_BUILT_PACKAGES=\"$SAGE_BUILT_PACKAGES $SPKG_NAME\"\n```\n\nsince the newline is only used to make the `BUILT_PACKAGES` rule in the resulting Makefile look nice. Changing them to spaces doesn't change what the rule does. I'm not sure about\n\n```\nSAGE_PACKAGE_VERSIONS+=\"vers_$SPKG_NAME = $SPKG_VERSION\"$'\\n\n```\n\nand \n\n```\nSAGE_PACKAGE_DEPENDENCIES+=\"deps_$SPKG_NAME = $DEPS\"$'\\n'\n```\n\nthough, because those are inserted verbatim into the Makefile as rules, and the newlines probably matter.\n\n\n\nCC:  @dimpase @mkoeppe @embray @vbraun\n\nUpstream: Fixed upstream, in a later stable release.\n\nReviewer: Dima Pasechnik\n\nAuthor: Michael Orlitzky\n\nBranch: 0e66a0abc00d5bf5ac1496e13f4d2f4ef7fe29dc\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29345\n\n",
    "closed_at": "2020-06-21T22:37:08Z",
    "created_at": "2020-03-15T22:50:28Z",
    "labels": [
        "component: build: configure",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "replace bashisms in m4/sage_spkg_collect.m4, m4/sage_spkg_enable.m4, build/pkgs/*/spkg-configure.m4, src/bin/sage-env, build/make/Makefile.in",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29345",
    "user": "https://github.com/orlitzky"
}
```
Autoconf scripts should be POSIX sh rather than bash, but there are a few bashisms in m4/sage_spkg_collect.m4 and m4/sage_spkg_enable.m4:

* The quoted newlines `$'\n'`
* The use of `VAR+=VALUE`

Some of these should be straightforward to fix. The format

```
SAGE_BUILT_PACKAGES+="    $SPKG_NAME \\"$'\n'
```

can be changed to

```
SAGE_BUILT_PACKAGES="$SAGE_BUILT_PACKAGES $SPKG_NAME"
```

since the newline is only used to make the `BUILT_PACKAGES` rule in the resulting Makefile look nice. Changing them to spaces doesn't change what the rule does. I'm not sure about

```
SAGE_PACKAGE_VERSIONS+="vers_$SPKG_NAME = $SPKG_VERSION"$'\n
```

and 

```
SAGE_PACKAGE_DEPENDENCIES+="deps_$SPKG_NAME = $DEPS"$'\n'
```

though, because those are inserted verbatim into the Makefile as rules, and the newlines probably matter.



CC:  @dimpase @mkoeppe @embray @vbraun

Upstream: Fixed upstream, in a later stable release.

Reviewer: Dima Pasechnik

Author: Michael Orlitzky

Branch: 0e66a0abc00d5bf5ac1496e13f4d2f4ef7fe29dc

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29345





---

archive/issue_comments_411577.json:
```json
{
    "body": "<a id='comment:1'></a>I agree in general - do you actually run this with a CONFIG_SHELL other than bash? Is the other configure code clean?",
    "created_at": "2020-03-15T22:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411577",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>I agree in general - do you actually run this with a CONFIG_SHELL other than bash? Is the other configure code clean?



---

archive/issue_comments_411578.json:
```json
{
    "body": "<a id='comment:2'></a>This should probably be done on top of #29287, which touches the same file",
    "created_at": "2020-03-15T22:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411578",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>This should probably be done on top of #29287, which touches the same file



---

archive/issue_comments_411579.json:
```json
{
    "body": "<a id='comment:3'></a>Things seem to run OK with dash if I comment out the part of configure.ac that forces bash. Of course I can't be sure that it *works* until I have a suggestion for how to fix `SAGE_PACKAGE_VERSIONS` and `SAGE_PACKAGE_DEPENDENCIES`.",
    "created_at": "2020-03-15T23:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411579",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:3'></a>Things seem to run OK with dash if I comment out the part of configure.ac that forces bash. Of course I can't be sure that it *works* until I have a suggestion for how to fix `SAGE_PACKAGE_VERSIONS` and `SAGE_PACKAGE_DEPENDENCIES`.



---

archive/issue_comments_411580.json:
```json
{
    "body": "<a id='comment:4'></a>One way to address this is to make things a liitle more static (see #29114 - \"Only ./bootstrap should glob build/pkgs\"), also getting rid of GNU-make-isms and macrology in `build/make/Makefile`.\n\n`bootstrap` already emits macro calls for many packages into `m4/sage_spkg_configures.m4`, of three types.\n- m4_sinclude([build/pkgs/arb/spkg-configure.m4])\n- SAGE_SPKG_CONFIGURE_ARB\n- SAGE_SPKG_ENABLE([ninja_build], [optional])\nMight as well emit another line for every package that creates whatever is needed in the Makefile.",
    "created_at": "2020-03-16T01:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411580",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>One way to address this is to make things a liitle more static (see #29114 - "Only ./bootstrap should glob build/pkgs"), also getting rid of GNU-make-isms and macrology in `build/make/Makefile`.

`bootstrap` already emits macro calls for many packages into `m4/sage_spkg_configures.m4`, of three types.
- m4_sinclude([build/pkgs/arb/spkg-configure.m4])
- SAGE_SPKG_CONFIGURE_ARB
- SAGE_SPKG_ENABLE([ninja_build], [optional])
Might as well emit another line for every package that creates whatever is needed in the Makefile.



---

archive/issue_events_074713.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-09T23:11:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29345#event-74713"
}
```



---

archive/issue_comments_411581.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-30T00:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411581",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_411582.json:
```json
{
    "body": "<a id='comment:6'></a>The printf stuff is going to make anyone reading the code think we're stupid, but it works and didn't involve changing much code. I just completed a full build using `/bin/dash` as my shell.",
    "created_at": "2020-04-30T00:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411582",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>The printf stuff is going to make anyone reading the code think we're stupid, but it works and didn't involve changing much code. I just completed a full build using `/bin/dash` as my shell.



---

archive/issue_comments_411583.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-04-30T00:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411583",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_411584.json:
```json
{
    "body": "<a id='comment:8'></a>Nice on first glance. I'll be happy to do a full review after 9.1 is out",
    "created_at": "2020-04-30T01:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411584",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Nice on first glance. I'll be happy to do a full review after 9.1 is out



---

archive/issue_comments_411585.json:
```json
{
    "body": "<a id='comment:9'></a>it's a bit in vain, as there are bashisms or just \"bash required\" in several Sage packages.",
    "created_at": "2020-04-30T06:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411585",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>it's a bit in vain, as there are bashisms or just "bash required" in several Sage packages.



---

archive/issue_comments_411586.json:
```json
{
    "body": "<a id='comment:10'></a>regarding newline, perhaps https://stackoverflow.com/questions/21880891/newline-character-in-posix-shell says something.",
    "created_at": "2020-04-30T06:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411586",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>regarding newline, perhaps https://stackoverflow.com/questions/21880891/newline-character-in-posix-shell says something.



---

archive/issue_comments_411587.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 dimpase]:\n> it's a bit in vain, as there are bashisms or just \"bash required\" in several Sage packages.\n\n\nUltimately my goal is to not install any sage packages =)\n\nI'll always need bash installed for other stuff, but ./configure is noticeably faster with dash. It may be a \"micro-optimization\" but half of what I do lately is re-run ./configure.",
    "created_at": "2020-04-30T12:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411587",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:11'></a>Replying to [comment:9 dimpase]:
> it's a bit in vain, as there are bashisms or just "bash required" in several Sage packages.


Ultimately my goal is to not install any sage packages =)

I'll always need bash installed for other stuff, but ./configure is noticeably faster with dash. It may be a "micro-optimization" but half of what I do lately is re-run ./configure.



---

archive/issue_comments_411588.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 dimpase]:\n> regarding newline, perhaps https://stackoverflow.com/questions/21880891/newline-character-in-posix-shell says something. \n\n\nThe suggestion there is to print a newline and a space at the end of each line, and then remove the space afterwards. Since all of the lines in question are indented, what I did instead was switch to printing a newline and some spaces at the *beginning* of each line -- that way the newline is still followed by spaces (and therefore doesn't get dropped), but the spaces aren't \"extra\" and don't need to be removed.",
    "created_at": "2020-04-30T12:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411588",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:12'></a>Replying to [comment:10 dimpase]:
> regarding newline, perhaps https://stackoverflow.com/questions/21880891/newline-character-in-posix-shell says something. 


The suggestion there is to print a newline and a space at the end of each line, and then remove the space afterwards. Since all of the lines in question are indented, what I did instead was switch to printing a newline and some spaces at the *beginning* of each line -- that way the newline is still followed by spaces (and therefore doesn't get dropped), but the spaces aren't "extra" and don't need to be removed.



---

archive/issue_comments_411589.json:
```json
{
    "body": "<a id='comment:13'></a>needs rebase.",
    "created_at": "2020-05-06T11:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411589",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>needs rebase.



---

archive/issue_comments_411590.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-05-06T20:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411590",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_411591.json:
```json
{
    "body": "<a id='comment:15'></a>fixed, thanks",
    "created_at": "2020-05-06T20:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411591",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>fixed, thanks



---

archive/issue_comments_411592.json:
```json
{
    "body": "<a id='comment:16'></a>A interesting test (apart from using dash) would be to use ksh (on OpenBSD - trying this now for lolz) or zsh (the latter is the default on recent macOS, I am told).",
    "created_at": "2020-05-07T11:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411592",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>A interesting test (apart from using dash) would be to use ksh (on OpenBSD - trying this now for lolz) or zsh (the latter is the default on recent macOS, I am told).



---

archive/issue_comments_411593.json:
```json
{
    "body": "<a id='comment:17'></a>./configure fails with `/bin/sh -> /bin/zsh` at,\n\n```\nChecking whether SageMath should install SPKG mpir...\nchecking gmp.h usability... yes\nchecking gmp.h presence... yes\nchecking for gmp.h... yes\nchecking gmpxx.h usability... yes\nchecking gmpxx.h presence... yes\nchecking for gmpxx.h... yes\nchecking for library containing __gmpq_cmp_z... -lgmp\n./configure:break:10258: not in while, until, select, or repeat loop\n```\n\nSince it was executed via /bin/sh, I think zsh is already in bourne-shell compatibility mode.",
    "created_at": "2020-05-07T12:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411593",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:17'></a>./configure fails with `/bin/sh -> /bin/zsh` at,

```
Checking whether SageMath should install SPKG mpir...
checking gmp.h usability... yes
checking gmp.h presence... yes
checking for gmp.h... yes
checking gmpxx.h usability... yes
checking gmpxx.h presence... yes
checking for gmpxx.h... yes
checking for library containing __gmpq_cmp_z... -lgmp
./configure:break:10258: not in while, until, select, or repeat loop
```

Since it was executed via /bin/sh, I think zsh is already in bourne-shell compatibility mode.



---

archive/issue_comments_411594.json:
```json
{
    "body": "<a id='comment:18'></a>ksh also notices a stray break and prints a warning, no error.",
    "created_at": "2020-05-07T13:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411594",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>ksh also notices a stray break and prints a warning, no error.



---

archive/issue_comments_411595.json:
```json
{
    "body": "<a id='comment:19'></a>with ksh/openbsd, the ugly hack in spkg-install of lrcalc does not work, as copied over config.status gets really confused, and complains about `print` not found etc.\nThe following (needs autotools isntalled, obviously) fixes this:\n\n```diff\n-cp \"$SAGE_ROOT\"/config/config.* .\n+autoreconf -ivf\n```",
    "created_at": "2020-05-08T08:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411595",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>with ksh/openbsd, the ugly hack in spkg-install of lrcalc does not work, as copied over config.status gets really confused, and complains about `print` not found etc.
The following (needs autotools isntalled, obviously) fixes this:

```diff
-cp "$SAGE_ROOT"/config/config.* .
+autoreconf -ivf
```



---

archive/issue_comments_411596.json:
```json
{
    "body": "<a id='comment:20'></a>ditto (ksh/openbsd) - this is how givaro outputs its givaro.pc - which is of course broken this way\n\n```\n/------------------ givaro.pc ------------------------\nprefix=/home/dima/sagetrac-mirror/local\nexec_prefix=/home/dima/sagetrac-mirror/local\nlibdir=/home/dima/sagetrac-mirror/local/lib\nincludedir=/home/dima/sagetrac-mirror/local/include\n\nName: Givaro\nDescription: C++ library for arithmetic and algebraic computations\nURL: https://casys.gricad-pages.univ-grenoble-alpes.fr/givaro\nVersion: 4.1.1\nRequires:\nLibs: -L/home/dima/sagetrac-mirror/local/lib -lgivaro  -lgmp -lgmpxx\nCflags: -I${prefix}/include  \n\\-------------------------------------------------------\n```",
    "created_at": "2020-05-08T08:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411596",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>ditto (ksh/openbsd) - this is how givaro outputs its givaro.pc - which is of course broken this way

```
/------------------ givaro.pc ------------------------
prefix=/home/dima/sagetrac-mirror/local
exec_prefix=/home/dima/sagetrac-mirror/local
libdir=/home/dima/sagetrac-mirror/local/lib
includedir=/home/dima/sagetrac-mirror/local/include

Name: Givaro
Description: C++ library for arithmetic and algebraic computations
URL: https://casys.gricad-pages.univ-grenoble-alpes.fr/givaro
Version: 4.1.1
Requires:
Libs: -L/home/dima/sagetrac-mirror/local/lib -lgivaro  -lgmp -lgmpxx
Cflags: -I${prefix}/include  
\-------------------------------------------------------
```



---

archive/issue_comments_411597.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 dimpase]:\n> with ksh/openbsd, the ugly hack in spkg-install of lrcalc does not work, as copied over config.status gets really confused, and complains about `print` not found etc.\n> The following (needs autotools isntalled, obviously) fixes this:\n> \n> ```diff\n> -cp \"$SAGE_ROOT\"/config/config.* .\n> +autoreconf -ivf\n> ```\n\n\nThat commit mentions only `config.guess`, but it doesn't say what problem it was solving. Maybe copying `config.status` was unintentional.",
    "created_at": "2020-05-08T15:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411597",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:21'></a>Replying to [comment:19 dimpase]:
> with ksh/openbsd, the ugly hack in spkg-install of lrcalc does not work, as copied over config.status gets really confused, and complains about `print` not found etc.
> The following (needs autotools isntalled, obviously) fixes this:
> 
> ```diff
> -cp "$SAGE_ROOT"/config/config.* .
> +autoreconf -ivf
> ```


That commit mentions only `config.guess`, but it doesn't say what problem it was solving. Maybe copying `config.status` was unintentional.



---

archive/issue_comments_411598.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-08T16:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411598",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_411599.json:
```json
{
    "body": "<a id='comment:23'></a>New commits fix the `break` statements and probably lrcalc.",
    "created_at": "2020-05-08T16:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411599",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:23'></a>New commits fix the `break` statements and probably lrcalc.



---

archive/issue_comments_411600.json:
```json
{
    "body": "<a id='comment:24'></a>The is also a bug in `build/pkgs/cvxopt/spkg-install.in`, in\n\n```\n# Stolen from Gentoo\npkg_libs() {\n        pkg-config --libs-only-l $* | \\\n                sed -e 's:[ ]-l*\\(pthread\\|m\\)\\([ ]\\|$\\)::g' -e 's:[ ]*$::' | \\\n                tr ' ' '\\n' | sort -u | sed -e \"s:^-l\\(.*\\):\\1:g\" | \\\n                tr '\\n' ';' | sed -e 's:;$::'\n}\n```\nso that on ksh/openbsd I get `CVXOPT_BLAS_LIB=\"$(pkg_libs blas)\"`\ngets `;openblas` rather than `openblas`.\nNote that \n\n```\n(sage-buildsh) dima@sagemath:sagetrac-mirror$ pkg-config --libs-only-l blas\n -lopenblas\n```\noutputs a leading  space.\n\n```\n$ pkg-config --libs-only-l blas | sed -e 's:[ ]-l*\\(pthread\\|m\\)\\([ ]\\|$\\)::g' -e 's:[ ]*$::' | tr ' ' '\\n'\n\n-lopenblas\n```\nAnd so the latter outputs an extra blank line, leading to erroneous `;`.\nIt would suffice to remove the leading spaces from the output of `pkg-config`, say.",
    "created_at": "2020-05-10T10:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411600",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>The is also a bug in `build/pkgs/cvxopt/spkg-install.in`, in

```
# Stolen from Gentoo
pkg_libs() {
        pkg-config --libs-only-l $* | \
                sed -e 's:[ ]-l*\(pthread\|m\)\([ ]\|$\)::g' -e 's:[ ]*$::' | \
                tr ' ' '\n' | sort -u | sed -e "s:^-l\(.*\):\1:g" | \
                tr '\n' ';' | sed -e 's:;$::'
}
```
so that on ksh/openbsd I get `CVXOPT_BLAS_LIB="$(pkg_libs blas)"`
gets `;openblas` rather than `openblas`.
Note that 

```
(sage-buildsh) dima@sagemath:sagetrac-mirror$ pkg-config --libs-only-l blas
 -lopenblas
```
outputs a leading  space.

```
$ pkg-config --libs-only-l blas | sed -e 's:[ ]-l*\(pthread\|m\)\([ ]\|$\)::g' -e 's:[ ]*$::' | tr ' ' '\n'

-lopenblas
```
And so the latter outputs an extra blank line, leading to erroneous `;`.
It would suffice to remove the leading spaces from the output of `pkg-config`, say.



---

archive/issue_comments_411601.json:
```json
{
    "body": "<a id='comment:25'></a>The following does the job to fix the latter\n\n```diff\n--- a/build/pkgs/cvxopt/spkg-install.in\n+++ b/build/pkgs/cvxopt/spkg-install.in\n@@ -2,7 +2,7 @@ cd src\n \n # Stolen from Gentoo\n pkg_libs() {\n-       pkg-config --libs-only-l $* | \\\n+       pkg-config --libs-only-l $* | sed -e 's/^ *//g' | \\\n                sed -e 's:[ ]-l*\\(pthread\\|m\\)\\([ ]\\|$\\)::g' -e 's:[ ]*$::' | \\\n                tr ' ' '\\n' | sort -u | sed -e \"s:^-l\\(.*\\):\\1:g\" | \\\n                tr '\\n' ';' | sed -e 's:;$::'\n```",
    "created_at": "2020-05-10T10:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411601",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>The following does the job to fix the latter

```diff
--- a/build/pkgs/cvxopt/spkg-install.in
+++ b/build/pkgs/cvxopt/spkg-install.in
@@ -2,7 +2,7 @@ cd src
 
 # Stolen from Gentoo
 pkg_libs() {
-       pkg-config --libs-only-l $* | \
+       pkg-config --libs-only-l $* | sed -e 's/^ *//g' | \
                sed -e 's:[ ]-l*\(pthread\|m\)\([ ]\|$\)::g' -e 's:[ ]*$::' | \
                tr ' ' '\n' | sort -u | sed -e "s:^-l\(.*\):\1:g" | \
                tr '\n' ';' | sed -e 's:;$::'
```



---

archive/issue_comments_411602.json:
```json
{
    "body": "<a id='comment:26'></a>And here are already merged upstream fixes for comment:20 problem\n\nhttps://github.com/linbox-team/givaro/pull/157\n\nhttps://github.com/linbox-team/linbox/pull/255\n\nhttps://github.com/linbox-team/fflas-ffpack/pull/308",
    "created_at": "2020-05-10T10:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411602",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>And here are already merged upstream fixes for comment:20 problem

https://github.com/linbox-team/givaro/pull/157

https://github.com/linbox-team/linbox/pull/255

https://github.com/linbox-team/fflas-ffpack/pull/308



---

archive/issue_comments_411603.json:
```json
{
    "body": "<a id='comment:27'></a>Lol that's like ten pipelines just to parse a space delimited list and replace `-l` with `;`. I think this does the same thing, and works with bash, dash, ksh, zsh, and posh:\n\n```\n# The BLAS_LIB and LAPACK_LIB variables (among others) in cvxopt's setup.py\n# are passed in as colon-delimited strings. So, for example, if your blas\n# lib flags are \"-lblas -lcblas\", then cvxopt wants \"blas;cblas\". The\n# following function takes a package name, feeds it to pkg-config, and then\n# converts it to the proper format.\ncvxopt_libs() {\n    CVXOPT_LIBS=\"\"\n    SKIP_LIBS=\"pthread m\"\n    for PKGCONFIG_LIB in $(pkg-config --libs-only-l \"${1}\"); do\n\tfor SKIP_LIB in ${SKIP_LIBS}; do\n\t    if [ \"${PKGCONFIG_LIB}\" = \"-l${SKIP_LIB}\" ]; then\n\t\t# break out of the big loop if we're skipping this lib\n\t\tcontinue 2\n\t    fi\n\tdone\n\t# replace leading \"-l\" with \";\"\n\tCVXOPT_LIBS=\"${CVXOPT_LIBS};${PKGCONFIG_LIB#-l}\"\n    done\n    # strip the leading \";\" from \";foo;bar\" before output\n    echo \"${CVXOPT_LIBS#;}\"\n}\n```",
    "created_at": "2020-05-10T12:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411603",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:27'></a>Lol that's like ten pipelines just to parse a space delimited list and replace `-l` with `;`. I think this does the same thing, and works with bash, dash, ksh, zsh, and posh:

```
# The BLAS_LIB and LAPACK_LIB variables (among others) in cvxopt's setup.py
# are passed in as colon-delimited strings. So, for example, if your blas
# lib flags are "-lblas -lcblas", then cvxopt wants "blas;cblas". The
# following function takes a package name, feeds it to pkg-config, and then
# converts it to the proper format.
cvxopt_libs() {
    CVXOPT_LIBS=""
    SKIP_LIBS="pthread m"
    for PKGCONFIG_LIB in $(pkg-config --libs-only-l "${1}"); do
	for SKIP_LIB in ${SKIP_LIBS}; do
	    if [ "${PKGCONFIG_LIB}" = "-l${SKIP_LIB}" ]; then
		# break out of the big loop if we're skipping this lib
		continue 2
	    fi
	done
	# replace leading "-l" with ";"
	CVXOPT_LIBS="${CVXOPT_LIBS};${PKGCONFIG_LIB#-l}"
    done
    # strip the leading ";" from ";foo;bar" before output
    echo "${CVXOPT_LIBS#;}"
}
```



---

archive/issue_comments_411604.json:
```json
{
    "body": "<a id='comment:28'></a>care to add the latter to the branch?",
    "created_at": "2020-05-10T12:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411604",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>care to add the latter to the branch?



---

archive/issue_comments_411605.json:
```json
{
    "body": "<a id='comment:29'></a>Yeah I will after I'm sure that it works. I'll probably also update the Gentoo ebuild. Some ad-hoc testing shows differences between the two, but it looks like they're all mistakes in the existing version; some things aren't handled correctly after `-lpthread` or `-lm` are removed, for example:\n\n```\n$ pkg-config --libs-only-l librsvg-2.0\n-lrsvg-2 -lm -lgio-2.0 -lgdk_pixbuf-2.0 -lgobject-2.0 -lglib-2.0 -lcairo\n\n# sage/gentoo version\n$ ./orig.sh librsvg-2.0\ncairo;gdk_pixbuf-2.0;glib-2.0;gobject-2.0;rsvg-2-lgio-2.0\n\n# the new one\n$ ./cvxopt_libs.sh librsvg-2.0\nrsvg-2;gio-2.0;gdk_pixbuf-2.0;gobject-2.0;glib-2.0;cairo\n```",
    "created_at": "2020-05-10T13:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411605",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:29'></a>Yeah I will after I'm sure that it works. I'll probably also update the Gentoo ebuild. Some ad-hoc testing shows differences between the two, but it looks like they're all mistakes in the existing version; some things aren't handled correctly after `-lpthread` or `-lm` are removed, for example:

```
$ pkg-config --libs-only-l librsvg-2.0
-lrsvg-2 -lm -lgio-2.0 -lgdk_pixbuf-2.0 -lgobject-2.0 -lglib-2.0 -lcairo

# sage/gentoo version
$ ./orig.sh librsvg-2.0
cairo;gdk_pixbuf-2.0;glib-2.0;gobject-2.0;rsvg-2-lgio-2.0

# the new one
$ ./cvxopt_libs.sh librsvg-2.0
rsvg-2;gio-2.0;gdk_pixbuf-2.0;gobject-2.0;glib-2.0;cairo
```



---

archive/issue_comments_411606.json:
```json
{
    "body": "<a id='comment:30'></a>I opened #29677 to track OpenBSD quirks.",
    "created_at": "2020-05-12T09:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411606",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>I opened #29677 to track OpenBSD quirks.



---

archive/issue_comments_411607.json:
```json
{
    "body": "<a id='comment:31'></a>There are more issues with cvxopt in both Gentoo and Sage... for example, if you don't set one of the `*_LIB` variables, then it defaults to adding `/usr/lib` to your search path which will pick up the wrong libraries on most Gentoo systems (you want `/usr/lib64` instead). Passing in the empty string to override sort-of works, but not for the `*_INC_DIR` variables, meaning that we need special cases everywhere to do it right. I've opened an issue with cvxopt to see if they can make our lives easier by treating the empty string as \"no extra libs/paths\" rather than \"one extra lib/path consisting of the empty string.\"",
    "created_at": "2020-05-13T12:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411607",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:31'></a>There are more issues with cvxopt in both Gentoo and Sage... for example, if you don't set one of the `*_LIB` variables, then it defaults to adding `/usr/lib` to your search path which will pick up the wrong libraries on most Gentoo systems (you want `/usr/lib64` instead). Passing in the empty string to override sort-of works, but not for the `*_INC_DIR` variables, meaning that we need special cases everywhere to do it right. I've opened an issue with cvxopt to see if they can make our lives easier by treating the empty string as "no extra libs/paths" rather than "one extra lib/path consisting of the empty string."



---

archive/issue_comments_411608.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-13T21:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411608",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_411609.json:
```json
{
    "body": "<a id='comment:33'></a>The latest commit lets me build cvxopt against the suitesparse SPKG using ksh.\n\nNow that I'm familiar, I have a feeling that some more work is going to be needed on the suitesparse spkg-configure.m4 ticket to keep cvxopt working if suitesparse comes from the system. The new function I added should help if that proves true.",
    "created_at": "2020-05-13T21:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411609",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:33'></a>The latest commit lets me build cvxopt against the suitesparse SPKG using ksh.

Now that I'm familiar, I have a feeling that some more work is going to be needed on the suitesparse spkg-configure.m4 ticket to keep cvxopt working if suitesparse comes from the system. The new function I added should help if that proves true.



---

archive/issue_comments_411610.json:
```json
{
    "body": "<a id='comment:34'></a>Is this ready for review? Just checking.",
    "created_at": "2020-05-15T09:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411610",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>Is this ready for review? Just checking.



---

archive/issue_comments_411611.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-05-15T12:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411611",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_411612.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:34 dimpase]:\n> Is this ready for review? Just checking.\n\n\nYes, I've added one more commit with your pc-file patches for givaro, linbox, and fflas-ffpack. There are no more (known) problems with non-bash shells.",
    "created_at": "2020-05-15T12:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411612",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:36'></a>Replying to [comment:34 dimpase]:
> Is this ready for review? Just checking.


Yes, I've added one more commit with your pc-file patches for givaro, linbox, and fflas-ffpack. There are no more (known) problems with non-bash shells.



---

archive/issue_comments_411613.json:
```json
{
    "body": "<a id='comment:37'></a>OK to rebase this on top of #29098 (Merge build/make/deps into build/make/Makefile.in)?",
    "created_at": "2020-05-16T01:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411613",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>OK to rebase this on top of #29098 (Merge build/make/deps into build/make/Makefile.in)?



---

archive/issue_comments_411614.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 mkoeppe]:\n> OK to rebase this on top of #29098 (Merge build/make/deps into build/make/Makefile.in)?\n\n\nSure. I'm running a full build/ptestlong today to ensure that my new sympow package works with #29673. If you don't beat me to it, I'll rebase on Monday most likely.",
    "created_at": "2020-05-16T13:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411614",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:38'></a>Replying to [comment:37 mkoeppe]:
> OK to rebase this on top of #29098 (Merge build/make/deps into build/make/Makefile.in)?


Sure. I'm running a full build/ptestlong today to ensure that my new sympow package works with #29673. If you don't beat me to it, I'll rebase on Monday most likely.



---

archive/issue_comments_411615.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-05-18T13:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411615",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_411616.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-05-26T14:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411616",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_411617.json:
```json
{
    "body": "<a id='comment:42'></a>That last one is just a rebase onto the rebase in #29098.",
    "created_at": "2020-05-26T14:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411617",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:42'></a>That last one is just a rebase onto the rebase in #29098.



---

archive/issue_comments_411618.json:
```json
{
    "body": "<a id='comment:44'></a>oops, needs another rebase, over the beta0 that just came out.",
    "created_at": "2020-05-28T22:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411618",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:44'></a>oops, needs another rebase, over the beta0 that just came out.



---

archive/issue_comments_411619.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-05-30T12:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411619",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_411620.json:
```json
{
    "body": "<a id='comment:46'></a>Done again.",
    "created_at": "2020-05-30T12:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411620",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:46'></a>Done again.



---

archive/issue_comments_411621.json:
```json
{
    "body": "<a id='comment:47'></a>lgtm",
    "created_at": "2020-06-04T00:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411621",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>lgtm



---

archive/issue_comments_411622.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-04T00:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411622",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411623.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-06-15T11:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411623",
    "user": "https://github.com/dimpase"
}
```

Changing priority from major to critical.



---

archive/issue_comments_411624.json:
```json
{
    "body": "<a id='comment:49'></a>rebased over 9.2.beta1 - making this critical, as we're approaching a rebase hell state with this ticket not merged for 4 weeks.\n\n---\nLast 10 new commits:",
    "created_at": "2020-06-15T11:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411624",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:49'></a>rebased over 9.2.beta1 - making this critical, as we're approaching a rebase hell state with this ticket not merged for 4 weeks.

---
Last 10 new commits:



---

archive/issue_comments_411625.json:
```json
{
    "body": "<a id='comment:50'></a>0e66a0a is already merged on Volker's branch.",
    "created_at": "2020-06-15T13:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411625",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>0e66a0a is already merged on Volker's branch.



---

archive/issue_comments_411626.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-21T22:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411626",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074714.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-21T22:37:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29345#event-74714"
}
```



---

archive/issue_comments_411627.json:
```json
{
    "body": "<a id='comment:53'></a>Replying to [comment:23 mjo]:\n> New commits fix the `break` statements and probably lrcalc.\n\nno, lrcalc on OpenBSD is still broken due to this `print` issue. Probably we really need to run a modern autoconf on it and replace the resulting scripts.",
    "created_at": "2020-09-03T15:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29345#issuecomment-411627",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:53'></a>Replying to [comment:23 mjo]:
> New commits fix the `break` statements and probably lrcalc.

no, lrcalc on OpenBSD is still broken due to this `print` issue. Probably we really need to run a modern autoconf on it and replace the resulting scripts.
