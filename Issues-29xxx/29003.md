# Issue 29003: Install Sage-specific .pc files when running make, not configure

archive/issues_028766.json:
```json
{
    "body": "As noted in [this comment](https://trac.sagemath.org/ticket/27870#comment:81), if we generate any .pc files at configure time, rather than write them directly to `$SAGE_LOCAL` it would be preferable to write them somewhere in the sage source tree instead, then copy them into the relevant install target (i.e. `$SAGE_LOCAL`) only when running `make`.\n\nOne tricky aspect to this is at least some SPGKs require our generated .pc files to be installed in `$SAGE_LOCAL` to build properly.  Currently, one way around that is to add `$(PCFILES)` to the package's dependencies.  This is needed at the very least for numpy.\n\nA different workaround might be to modify `PKG_CONFIG_PATH` to include .pc files in the source tree.  I have not tried that yet.\n\nCC:  @dimpase @mkoeppe\n\nReviewer: Dima Pasechnik\n\nAuthor: Erik Bray\n\nBranch: c7fbc6582240c5b960e56a7d2af0e2bfb8ad3c25\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29003\n\n",
    "closed_at": "2020-01-20T21:18:07Z",
    "created_at": "2020-01-13T16:49:51Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Install Sage-specific .pc files when running make, not configure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29003",
    "user": "https://github.com/embray"
}
```
As noted in [this comment](https://trac.sagemath.org/ticket/27870#comment:81), if we generate any .pc files at configure time, rather than write them directly to `$SAGE_LOCAL` it would be preferable to write them somewhere in the sage source tree instead, then copy them into the relevant install target (i.e. `$SAGE_LOCAL`) only when running `make`.

One tricky aspect to this is at least some SPGKs require our generated .pc files to be installed in `$SAGE_LOCAL` to build properly.  Currently, one way around that is to add `$(PCFILES)` to the package's dependencies.  This is needed at the very least for numpy.

A different workaround might be to modify `PKG_CONFIG_PATH` to include .pc files in the source tree.  I have not tried that yet.

CC:  @dimpase @mkoeppe

Reviewer: Dima Pasechnik

Author: Erik Bray

Branch: c7fbc6582240c5b960e56a7d2af0e2bfb8ad3c25

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29003





---

archive/issue_comments_432536.json:
```json
{
    "body": "<a id='comment:1'></a>First attempt at this seems to work.\n\nI chose `src/lib/pkgconfig` as the path for .pc files to install from the source tree, as it has a nice congruence with `src/bin`.  But that was just a minor preference--this path could be anywhere in the source tree, or even outside it (e.g. for VPATH builds, should we ever get that working...)\n\n---\nNew commits:",
    "created_at": "2020-01-13T16:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432536",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>First attempt at this seems to work.

I chose `src/lib/pkgconfig` as the path for .pc files to install from the source tree, as it has a nice congruence with `src/bin`.  But that was just a minor preference--this path could be anywhere in the source tree, or even outside it (e.g. for VPATH builds, should we ever get that working...)

---
New commits:



---

archive/issue_comments_432537.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-13T16:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432537",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432538.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-13T17:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432538",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432539.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-13T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432539",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_432540.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 git]:\n> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n> |                                                                                                                                           |                                                                                                                                   |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|\n> |[854c899](https://git.sagemath.org/sage.git/commit/?id=854c8990d99a88aac87b06bf385943d4382d0c2f)|`Trac #29003: Create generated .pc files in the source tree and install them later instead of creating them directly in SAGE_LOCAL`|\n> |[62ac3cc](https://git.sagemath.org/sage.git/commit/?id=62ac3cc3bef11cdfdde88cfad9b5e594c94cfc78)|`Trac #29003: Also output generated gsl.pc to SAGE_SRC`|\n> |[e59f991](https://git.sagemath.org/sage.git/commit/?id=e59f9912f91f0033d0f4a73d165212b4a373311f)|`Trac #29003: Instead of making individual packages responsible for .pc files being installed, just include them as part of the standard 'toolchain'`|\n\n\nI think the approach in this version might be simplest, and is closer to the existing behavior.  The major difference now is that actually copying `.pc` files into `$SAGE_LOCAL` is deferred until `make` is run, rather than writing to `$SAGE_LOCAL` directly when running `configure`.",
    "created_at": "2020-01-13T17:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432540",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Replying to [comment:3 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> |                                                                                                                                           |                                                                                                                                   |
> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
> |[854c899](https://git.sagemath.org/sage.git/commit/?id=854c8990d99a88aac87b06bf385943d4382d0c2f)|`Trac #29003: Create generated .pc files in the source tree and install them later instead of creating them directly in SAGE_LOCAL`|
> |[62ac3cc](https://git.sagemath.org/sage.git/commit/?id=62ac3cc3bef11cdfdde88cfad9b5e594c94cfc78)|`Trac #29003: Also output generated gsl.pc to SAGE_SRC`|
> |[e59f991](https://git.sagemath.org/sage.git/commit/?id=e59f9912f91f0033d0f4a73d165212b4a373311f)|`Trac #29003: Instead of making individual packages responsible for .pc files being installed, just include them as part of the standard 'toolchain'`|


I think the approach in this version might be simplest, and is closer to the existing behavior.  The major difference now is that actually copying `.pc` files into `$SAGE_LOCAL` is deferred until `make` is run, rather than writing to `$SAGE_LOCAL` directly when running `configure`.



---

archive/issue_comments_432541.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-14T11:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432541",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432542.json:
```json
{
    "body": "<a id='comment:6'></a>testing",
    "created_at": "2020-01-14T12:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432542",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>testing



---

archive/issue_comments_432543.json:
```json
{
    "body": "<a id='comment:7'></a>OK, good, thanks!",
    "created_at": "2020-01-14T14:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432543",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>OK, good, thanks!



---

archive/issue_comments_432544.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-14T14:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432544",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_432545.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-20T21:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432545",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073455.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-20T21:18:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29003#event-73455"
}
```



---

archive/issue_comments_432546.json:
```json
{
    "body": "<a id='comment:9'></a>there is sometimes a permission problem, shouldn't that `cp -P` used to install these things be replaced by something more robust. \n\nsee e.g. #29071#comment:8",
    "created_at": "2020-01-24T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432546",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>there is sometimes a permission problem, shouldn't that `cp -P` used to install these things be replaced by something more robust. 

see e.g. #29071#comment:8



---

archive/issue_comments_432547.json:
```json
{
    "body": "<a id='comment:10'></a>by right, these *.pc files are package data, so they ought to be treated as such, no?",
    "created_at": "2020-01-24T12:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432547",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>by right, these *.pc files are package data, so they ought to be treated as such, no?



---

archive/issue_comments_432548.json:
```json
{
    "body": "<a id='comment:11'></a>$(PCFILES) must be cleanable, by `make clean` I guess.\nPleadse confirm. It caused a lot of pain on #29071",
    "created_at": "2020-01-26T12:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432548",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>$(PCFILES) must be cleanable, by `make clean` I guess.
Pleadse confirm. It caused a lot of pain on #29071



---

archive/issue_comments_432549.json:
```json
{
    "body": "<a id='comment:12'></a>the followup (cleaning of *.pc files) is on #29082",
    "created_at": "2020-01-26T12:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432549",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>the followup (cleaning of *.pc files) is on #29082



---

archive/issue_comments_432550.json:
```json
{
    "body": "<a id='comment:13'></a>... hotfix in #29121",
    "created_at": "2020-01-31T16:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29003",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29003#issuecomment-432550",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>... hotfix in #29121
