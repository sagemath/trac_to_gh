# Issue 29023: Meta-ticket: ./configure --enable-system-site-packages (optionally use system Python packages)

archive/issues_028786.json:
```json
{
    "body": "This is a followup on #27824: `spkg-configure.m4` for python3.\n\nIn the next step, we make it possible for users to enable use of system Python packages (site packages).\n\nIt is crucial to distinguish two categories of Python packages.\n\n**A. Python-implemented applications not running in the same process as sagelib**\n\nFor some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`\n\n- #30124 enables use of system packages for the Python packages `notebook` (#30124), `rst2ipynb`, and their dependencies. \n\n'''B. Packages that run in the same process as sagelib.``\n\nUse of these packages would be enabled by a new configure option `--enable-system-site-packages`. \n\nThis will set up the venv using `build/bin/sage-venv --system-site-packages`\n\n*Approach 1:*\n\n- #29665: `configure --enable-system-site-packages` via `spkg-configure.m4`\n\n*Approach 2:*\n\n- Separate the installation process of a Python package into several phases (makefile targets):\n\n  i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)\n\n  ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist\n\n  iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it\n\n  iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`\n\n  v) Install the wheel\n\nQuestions to be resolved:\n\n- ticket:32492#comment:17 -- installed packages are only considered by pip if they can also be found in an index.  As we use `--no-index`, the workaround in #32492 provides the directory `$SAGE_SPKG_WHEELS` as the index. \n\n  To be checked if the specific installed version of the package needs to be found in the index. If presence of any version (= spkg version) will cause pip to consider the installed version as a candidate for resolution, then we can just leave the decision whether to use the installed package or the spkg to the resolver and the pip upgrade-strategy. \n\n  If a package needs any special preparation for building a wheel such as setting of environment variables, we need to:\n\n  a) either invoke phase iv) explicitly (so wheels of such packages may be built but remain unused);\n\n  b) or try to move the environment settings to the general build environment; \n\n  c) or patch the Python package's build script instead, treating it like phase ii).\n\n- If we need a specific version (with patches that have not been upstreamed), should this be reflected in dependency information (`install-requires.txt`)?\n\n- Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n\nRelated/follow-up tickets:\n- #31543 Meta-ticket: Eliminate use of patches for Python packages\n- #29041 at `./bootstrap` time, generate `requirements.txt`, `constraints.txt`, `setup.cfg [install_requires]`, `Pipfile` from `build/pkgs`\n- #30578 Add `src/requirements.txt` and `src/setup.cfg [install_requires]` for installation of `sagelib` in a venv\n- #30371 In-place (editable) installs of `sagelib` in a venv\n\nTickets/issues for individual packages (moved here from #27330, will be obsolete with this ticket):\n* numpy\n* scipy\n* cypari (depends on pari)\n\n---\n\nReferences:\n\nhttps://packaging.python.org/discussions/install-requires-vs-requirements/\n\nPEP 508 -- Dependency specification for Python Software Packages | Python.org\u200b \nhttps://www.python.org/dev/peps/pep-0508/#pep440\n\nPEP 440 -- Version Identification and Dependency Specification | Python.org\n\u200bhttps://www.python.org/dev/peps/pep-0440/#local-version-segments\n\nhttps://python-poetry.org/docs/pyproject/#dependencies-and-dev-dependencies\n\n\n\n**CC:**  @tobihan tmonteil @orlitzky @timokau @kiwifb @isuruf @mezzarobba @embray @dimpase @thierry-FreeBSD @dkwo\n\nIssue created by migration from https://trac.sagemath.org/ticket/29023\n\n",
    "created_at": "2020-01-15T23:48:55Z",
    "labels": [
        "component: packages: standard",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "title": "Meta-ticket: ./configure --enable-system-site-packages (optionally use system Python packages)",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/29023",
    "user": "https://github.com/mkoeppe"
}
```
This is a followup on #27824: `spkg-configure.m4` for python3.

In the next step, we make it possible for users to enable use of system Python packages (site packages).

It is crucial to distinguish two categories of Python packages.

**A. Python-implemented applications not running in the same process as sagelib**

For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`

- #30124 enables use of system packages for the Python packages `notebook` (#30124), `rst2ipynb`, and their dependencies. 

'''B. Packages that run in the same process as sagelib.``

Use of these packages would be enabled by a new configure option `--enable-system-site-packages`. 

This will set up the venv using `build/bin/sage-venv --system-site-packages`

*Approach 1:*

- #29665: `configure --enable-system-site-packages` via `spkg-configure.m4`

*Approach 2:*

- Separate the installation process of a Python package into several phases (makefile targets):

  i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)

  ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist

  iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it

  iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`

  v) Install the wheel

Questions to be resolved:

- ticket:32492#comment:17 -- installed packages are only considered by pip if they can also be found in an index.  As we use `--no-index`, the workaround in #32492 provides the directory `$SAGE_SPKG_WHEELS` as the index. 

  To be checked if the specific installed version of the package needs to be found in the index. If presence of any version (= spkg version) will cause pip to consider the installed version as a candidate for resolution, then we can just leave the decision whether to use the installed package or the spkg to the resolver and the pip upgrade-strategy. 

  If a package needs any special preparation for building a wheel such as setting of environment variables, we need to:

  a) either invoke phase iv) explicitly (so wheels of such packages may be built but remain unused);

  b) or try to move the environment settings to the general build environment; 

  c) or patch the Python package's build script instead, treating it like phase ii).

- If we need a specific version (with patches that have not been upstreamed), should this be reflected in dependency information (`install-requires.txt`)?

- Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages

Related/follow-up tickets:
- #31543 Meta-ticket: Eliminate use of patches for Python packages
- #29041 at `./bootstrap` time, generate `requirements.txt`, `constraints.txt`, `setup.cfg [install_requires]`, `Pipfile` from `build/pkgs`
- #30578 Add `src/requirements.txt` and `src/setup.cfg [install_requires]` for installation of `sagelib` in a venv
- #30371 In-place (editable) installs of `sagelib` in a venv

Tickets/issues for individual packages (moved here from #27330, will be obsolete with this ticket):
* numpy
* scipy
* cypari (depends on pari)

---

References:

https://packaging.python.org/discussions/install-requires-vs-requirements/

PEP 508 -- Dependency specification for Python Software Packages | Python.org​ 
https://www.python.org/dev/peps/pep-0508/#pep440

PEP 440 -- Version Identification and Dependency Specification | Python.org
​https://www.python.org/dev/peps/pep-0440/#local-version-segments

https://python-poetry.org/docs/pyproject/#dependencies-and-dev-dependencies



**CC:**  @tobihan tmonteil @orlitzky @timokau @kiwifb @isuruf @mezzarobba @embray @dimpase @thierry-FreeBSD @dkwo

Issue created by migration from https://trac.sagemath.org/ticket/29023





---

archive/issue_comments_456213.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think there should be an option to disable the use of system packages. Sage's installation is already compilcated enough and I don't want a faulty package to mess up sage.",
    "created_at": "2020-04-05T18:21:36Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456213",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:1'></a>
I think there should be an option to disable the use of system packages. Sage's installation is already compilcated enough and I don't want a faulty package to mess up sage.



---

archive/issue_comments_456214.json:
```json
{
    "body": "<a id='comment:2'></a>\nYou can already do `./configure --with-system-python3=no` to avoid using the system's Python. Are you asking for something which allows the use of the system Python but not the system Python packages? Is it likely that there will be a good system Python installation which has faulty Python packages?",
    "created_at": "2020-04-05T18:27:49Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456214",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>
You can already do `./configure --with-system-python3=no` to avoid using the system's Python. Are you asking for something which allows the use of the system Python but not the system Python packages? Is it likely that there will be a good system Python installation which has faulty Python packages?



---

archive/issue_comments_456215.json:
```json
{
    "body": "<a id='comment:3'></a>\nI just found out about the ./configure --help option. --with-system-python3 is actually exactly what I meant.",
    "created_at": "2020-04-05T18:32:29Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456215",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:3'></a>
I just found out about the ./configure --help option. --with-system-python3 is actually exactly what I meant.



---

archive/issue_comments_456216.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,5 +2,6 @@\n - #29013: In a python3 build, install all Python packages into a venv\n - #27824: `spkg-configure.m4` for python3\n \n-In the next step, we enable use of system site packages.\n+In the next step, we enable use of system site packages using a new configure option ``--enable-system-site-packages``.\n \n+\n``````\n",
    "created_at": "2020-04-05T20:09:42Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456216",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,5 +2,6 @@
 - #29013: In a python3 build, install all Python packages into a venv
 - #27824: `spkg-configure.m4` for python3
 
-In the next step, we enable use of system site packages.
+In the next step, we enable use of system site packages using a new configure option ``--enable-system-site-packages``.
 
+
``````




---

archive/issue_comments_456217.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [gh-Volker-Weissmann](#comment%3A1):\n> I think there should be an option to disable the use of system packages. Sage's installation is already compilcated enough and I don't want a faulty package to mess up sage.\n\nThanks for the input. I've updated the ticket description.",
    "created_at": "2020-04-05T20:10:17Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456217",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Replying to [gh-Volker-Weissmann](#comment%3A1):
> I think there should be an option to disable the use of system packages. Sage's installation is already compilcated enough and I don't want a faulty package to mess up sage.

Thanks for the input. I've updated the ticket description.



---

archive/issue_comments_456218.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,6 +2,6 @@\n - #29013: In a python3 build, install all Python packages into a venv\n - #27824: `spkg-configure.m4` for python3\n \n-In the next step, we enable use of system site packages using a new configure option ``--enable-system-site-packages``.\n+In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n \n \n``````\n",
    "created_at": "2020-04-05T20:53:15Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456218",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,6 +2,6 @@
 - #29013: In a python3 build, install all Python packages into a venv
 - #27824: `spkg-configure.m4` for python3
 
-In the next step, we enable use of system site packages using a new configure option ``--enable-system-site-packages``.
+In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
 
 
``````




---

archive/issue_comments_456219.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think once python system packages are detected, the spkg-configure mechanism becomes interesting for packagers. Looking forward to this change.",
    "created_at": "2020-04-17T06:46:46Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456219",
    "user": "https://github.com/tobihan"
}
```

<a id='comment:7'></a>
I think once python system packages are detected, the spkg-configure mechanism becomes interesting for packagers. Looking forward to this change.



---

archive/issue_comments_456220.json:
```json
{
    "body": "<a id='comment:8'></a>\nI don't think python packages would be handled through spkg-configure. \nI think it's better to turn sagelib into a pip-installable package and provide standard prereq information -- see #29041 (at ./bootstrap time, generate src/requirements.txt, src/constraints.txt, src/setup.cfg [install_requires] from build/pkgs)",
    "created_at": "2020-04-17T18:49:46Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456220",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
I don't think python packages would be handled through spkg-configure. 
I think it's better to turn sagelib into a pip-installable package and provide standard prereq information -- see #29041 (at ./bootstrap time, generate src/requirements.txt, src/constraints.txt, src/setup.cfg [install_requires] from build/pkgs)



---

archive/issue_comments_456221.json:
```json
{
    "body": "<a id='comment:9'></a>\nI tried to create an experimental `spkg-configure.m4` for cvxopt in #29665, and it seems OK for me. Any comments?",
    "created_at": "2020-05-08T14:48:35Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456221",
    "user": "https://github.com/thierry-FreeBSD"
}
```

<a id='comment:9'></a>
I tried to create an experimental `spkg-configure.m4` for cvxopt in #29665, and it seems OK for me. Any comments?



---

archive/issue_comments_456222.json:
```json
{
    "body": "<a id='comment:10'></a>\nIf you take look at sage-env you see the line \n\nPYTHONUSERBASE=\"$DOT_SAGE/local\"\n\nbut I think it should be\n\nPYTHONUSERBASE=\"$SAGE_ROOT/local\"\n\n, because (at least on my machine) the folder $DOT_SAGE/local does not exist.",
    "created_at": "2020-05-08T14:57:14Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456222",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:10'></a>
If you take look at sage-env you see the line 

PYTHONUSERBASE="$DOT_SAGE/local"

but I think it should be

PYTHONUSERBASE="$SAGE_ROOT/local"

, because (at least on my machine) the folder $DOT_SAGE/local does not exist.



---

archive/issue_comments_456223.json:
```json
{
    "body": "<a id='comment:11'></a>\nThe way to enable system site packages is to use `--system-site-packages` when creating the venv.\n\nUsing PYTHONUSERBASE is not a suitable way forward.",
    "created_at": "2020-05-08T14:59:04Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456223",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
The way to enable system site packages is to use `--system-site-packages` when creating the venv.

Using PYTHONUSERBASE is not a suitable way forward.



---

archive/issue_comments_456224.json:
```json
{
    "body": "<a id='comment:12'></a>\n(And neither is an ad-hoc modification of PYTHONPATH proposed in #29665.)",
    "created_at": "2020-05-08T14:59:59Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456224",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
(And neither is an ad-hoc modification of PYTHONPATH proposed in #29665.)



---

archive/issue_comments_456225.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [gh-Volker-Weissmann](#comment%3A10):\n> the folder $DOT_SAGE/local does not exist.\n\n\nUsers create this folder if they want to install user packages, for example using `sage -pip install --user ...`",
    "created_at": "2020-05-08T15:06:31Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456225",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
Replying to [gh-Volker-Weissmann](#comment%3A10):
> the folder $DOT_SAGE/local does not exist.


Users create this folder if they want to install user packages, for example using `sage -pip install --user ...`



---

archive/issue_comments_456226.json:
```json
{
    "body": "<a id='comment:14'></a>\nOk. Thank you. I thought it was a bug. But this means that if you run\n\nsudo pip uninstall cython\npip install cython\n\ncou can't build sage.",
    "created_at": "2020-05-08T15:14:21Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456226",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:14'></a>
Ok. Thank you. I thought it was a bug. But this means that if you run

sudo pip uninstall cython
pip install cython

cou can't build sage.



---

archive/issue_comments_456227.json:
```json
{
    "body": "<a id='comment:15'></a>\nWell, isolating the Sage user installation scheme from the Python user installation scheme was done deliberately in the past to avoid possible breakage by incompatible installations.\n\nThis decision may have to be revisited at some point, but I don't think it's necessary for this ticket. \n\nSage's install scripts will continue to make sure that the Sage venv has all necessary packages - whether user of system site packages is enabled or not.",
    "created_at": "2020-05-08T15:26:09Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456227",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
Well, isolating the Sage user installation scheme from the Python user installation scheme was done deliberately in the past to avoid possible breakage by incompatible installations.

This decision may have to be revisited at some point, but I don't think it's necessary for this ticket. 

Sage's install scripts will continue to make sure that the Sage venv has all necessary packages - whether user of system site packages is enabled or not.



---

archive/issue_comments_456228.json:
```json
{
    "body": "<a id='comment:16'></a>\nJust a quick note that I plan to work on this for Sage 9.3, not earlier.",
    "created_at": "2020-05-08T15:33:41Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456228",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Just a quick note that I plan to work on this for Sage 9.3, not earlier.



---

archive/issue_events_257736.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-08T16:04:20Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "rename": {
        "from": "In a python 3 build, use system Python packages",
        "to": "Meta-ticket: In a python 3 build, use system Python packages"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257736"
}
```



---

archive/issue_comments_456229.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,4 +4,18 @@\n \n In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n \n+Questions to be resolved:\n+- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages\n+- Installing an upgraded/downgraded version of a package \n \n+Related:\n+- #29500: Install all Python packages using pip\n+\n+Tickets/issues for individual packages (moved here from #27330):\n+* numpy\n+* scipy\n+* cypari (depends on pari)\n+* cvxopt (experimental spkg-configure.m4 for a Python library) (#29665)\n+\n+\n+\n``````\n",
    "created_at": "2020-05-08T16:04:20Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456229",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,4 +4,18 @@
 
 In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
 
+Questions to be resolved:
+- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages
+- Installing an upgraded/downgraded version of a package 
 
+Related:
+- #29500: Install all Python packages using pip
+
+Tickets/issues for individual packages (moved here from #27330):
+* numpy
+* scipy
+* cypari (depends on pari)
+* cvxopt (experimental spkg-configure.m4 for a Python library) (#29665)
+
+
+
``````




---

archive/issue_comments_456230.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,7 +6,7 @@\n \n Questions to be resolved:\n - Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages\n-- Installing an upgraded/downgraded version of a package \n+- Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n Related:\n - #29500: Install all Python packages using pip\n``````\n",
    "created_at": "2020-05-08T16:06:27Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456230",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,7 +6,7 @@
 
 Questions to be resolved:
 - Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages
-- Installing an upgraded/downgraded version of a package 
+- Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
 Related:
 - #29500: Install all Python packages using pip
``````




---

archive/issue_comments_456231.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [mkoeppe](#comment%3A15):\n> Well, isolating the Sage user installation scheme from the Python user installation scheme was done deliberately in the past to avoid possible breakage by incompatible installations.\n\n\nIt's not always easy to know what the programmers thought. What is the best source to learn things like this? Reading the tickets?",
    "created_at": "2020-05-08T16:13:16Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456231",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:19'></a>
Replying to [mkoeppe](#comment%3A15):
> Well, isolating the Sage user installation scheme from the Python user installation scheme was done deliberately in the past to avoid possible breakage by incompatible installations.


It's not always easy to know what the programmers thought. What is the best source to learn things like this? Reading the tickets?



---

archive/issue_comments_456232.json:
```json
{
    "body": "<a id='comment:20'></a>\nThat, and asking questions on the sage-devel list, I suppose.",
    "created_at": "2020-05-08T16:19:06Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456232",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
That, and asking questions on the sage-devel list, I suppose.



---

archive/issue_comments_456233.json:
```json
{
    "body": "<a id='comment:21'></a>\nIn the case of PYTHONUSERBASE, comments in sage-env point to some relevant tickets.",
    "created_at": "2020-05-08T16:20:49Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456233",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
In the case of PYTHONUSERBASE, comments in sage-env point to some relevant tickets.



---

archive/issue_comments_456234.json:
```json
{
    "body": "<a id='comment:22'></a>\nThank you.",
    "created_at": "2020-05-08T16:28:03Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456234",
    "user": "https://github.com/Volker-Weissmann"
}
```

<a id='comment:22'></a>
Thank you.



---

archive/issue_comments_456235.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,7 +5,10 @@\n In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n \n Questions to be resolved:\n-- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages\n+- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages:\n+\n+  In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?\n+\n - Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n Related:\n``````\n",
    "created_at": "2020-05-08T16:41:10Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456235",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,7 +5,10 @@
 In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
 
 Questions to be resolved:
-- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages
+- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages:
+
+  In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?
+
 - Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
 Related:
``````




---

archive/issue_comments_456236.json:
```json
{
    "body": "<a id='comment:24'></a>\nBefore it makes sense to work on this, we should update all Python packages (#29141); in particular, `setuptools`, `pip`, ... (#29803)",
    "created_at": "2020-06-05T18:12:13Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456236",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
Before it makes sense to work on this, we should update all Python packages (#29141); in particular, `setuptools`, `pip`, ... (#29803)



---

archive/issue_events_257737.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-06-05T18:12:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257737"
}
```



---

archive/issue_comments_456237.json:
```json
{
    "body": "**Changing dependencies** from \"#27824\" to \"\".",
    "created_at": "2020-06-05T18:12:13Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456237",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#27824" to "".



---

archive/issue_comments_456238.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -20,5 +20,10 @@\n * cypari (depends on pari)\n * cvxopt (experimental spkg-configure.m4 for a Python library) (#29665)\n \n+---\n \n+References:\n \n+PEP 508 -- Dependency specification for Python Software Packages | Python.org\u200bhttps://www.python.org/dev/peps/pep-0508/#pep440\n+\n+PEP 440 -- Version Identification and Dependency Specification | Python.org\u200bhttps://www.python.org/dev/peps/pep-0440/#local-version-segments\n``````\n",
    "created_at": "2020-06-29T17:47:22Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456238",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -20,5 +20,10 @@
 * cypari (depends on pari)
 * cvxopt (experimental spkg-configure.m4 for a Python library) (#29665)
 
+---
 
+References:
 
+PEP 508 -- Dependency specification for Python Software Packages | Python.org​https://www.python.org/dev/peps/pep-0508/#pep440
+
+PEP 440 -- Version Identification and Dependency Specification | Python.org​https://www.python.org/dev/peps/pep-0440/#local-version-segments
``````




---

archive/issue_comments_456239.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -24,6 +24,12 @@\n \n References:\n \n-PEP 508 -- Dependency specification for Python Software Packages | Python.org\u200bhttps://www.python.org/dev/peps/pep-0508/#pep440\n+PEP 508 -- Dependency specification for Python Software Packages | Python.org\u200b \n+https://www.python.org/dev/peps/pep-0508/#pep440\n \n-PEP 440 -- Version Identification and Dependency Specification | Python.org\u200bhttps://www.python.org/dev/peps/pep-0440/#local-version-segments\n+PEP 440 -- Version Identification and Dependency Specification | Python.org\n+\u200bhttps://www.python.org/dev/peps/pep-0440/#local-version-segments\n+\n+https://python-poetry.org/docs/pyproject/#dependencies-and-dev-dependencies\n+\n+\n``````\n",
    "created_at": "2020-06-29T17:54:52Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456239",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -24,6 +24,12 @@
 
 References:
 
-PEP 508 -- Dependency specification for Python Software Packages | Python.org​https://www.python.org/dev/peps/pep-0508/#pep440
+PEP 508 -- Dependency specification for Python Software Packages | Python.org​ 
+https://www.python.org/dev/peps/pep-0508/#pep440
 
-PEP 440 -- Version Identification and Dependency Specification | Python.org​https://www.python.org/dev/peps/pep-0440/#local-version-segments
+PEP 440 -- Version Identification and Dependency Specification | Python.org
+​https://www.python.org/dev/peps/pep-0440/#local-version-segments
+
+https://python-poetry.org/docs/pyproject/#dependencies-and-dev-dependencies
+
+
``````




---

archive/issue_comments_456240.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -24,6 +24,8 @@\n \n References:\n \n+https://packaging.python.org/discussions/install-requires-vs-requirements/\n+\n PEP 508 -- Dependency specification for Python Software Packages | Python.org\u200b \n https://www.python.org/dev/peps/pep-0508/#pep440\n \n``````\n",
    "created_at": "2020-06-29T19:43:33Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456240",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -24,6 +24,8 @@
 
 References:
 
+https://packaging.python.org/discussions/install-requires-vs-requirements/
+
 PEP 508 -- Dependency specification for Python Software Packages | Python.org​ 
 https://www.python.org/dev/peps/pep-0508/#pep440
 
``````




---

archive/issue_comments_456241.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,13 +1,13 @@\n-This is a followup on \n-- #29013: In a python3 build, install all Python packages into a venv\n-- #27824: `spkg-configure.m4` for python3\n+This is a followup on #27824: `spkg-configure.m4` for python3.\n \n In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n \n Questions to be resolved:\n - Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages:\n \n-  In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?\n+  - #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG\n+\n+  - In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?\n \n - Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n``````\n",
    "created_at": "2020-06-29T19:51:17Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456241",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,13 +1,13 @@
-This is a followup on 
-- #29013: In a python3 build, install all Python packages into a venv
-- #27824: `spkg-configure.m4` for python3
+This is a followup on #27824: `spkg-configure.m4` for python3.
 
 In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
 
 Questions to be resolved:
 - Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages:
 
-  In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?
+  - #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG
+
+  - In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?
 
 - Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
``````




---

archive/issue_comments_456242.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,9 @@\n This is a followup on #27824: `spkg-configure.m4` for python3.\n+\n+#30124 enables use of system packages for the Python packages \n+`notebook` (#30124), `rst2ipynb`, and their dependencies.\n+These are special because they are Python-implemented applications; they do not run in the same process as `sagelib`.\n+\n \n In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n \n``````\n",
    "created_at": "2020-08-08T17:43:17Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456242",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,9 @@
 This is a followup on #27824: `spkg-configure.m4` for python3.
+
+#30124 enables use of system packages for the Python packages 
+`notebook` (#30124), `rst2ipynb`, and their dependencies.
+These are special because they are Python-implemented applications; they do not run in the same process as `sagelib`.
+
 
 In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
 
``````




---

archive/issue_comments_456243.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -17,7 +17,7 @@\n - Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n Related:\n-- #29500: Install all Python packages using pip\n+- #29500: Install all Python packages via pip wheel\n \n Tickets/issues for individual packages (moved here from #27330):\n * numpy\n``````\n",
    "created_at": "2020-10-22T15:47:41Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456243",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -17,7 +17,7 @@
 - Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
 Related:
-- #29500: Install all Python packages using pip
+- #29500: Install all Python packages via pip wheel
 
 Tickets/issues for individual packages (moved here from #27330):
 * numpy
``````




---

archive/issue_events_257738.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-22T15:47:41Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "rename": {
        "from": "Meta-ticket: In a python 3 build, use system Python packages",
        "to": "Meta-ticket: In a python 3 build, optionally use system Python packages"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257738"
}
```



---

archive/issue_comments_456244.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,25 +1,30 @@\n This is a followup on #27824: `spkg-configure.m4` for python3.\n-\n-#30124 enables use of system packages for the Python packages \n-`notebook` (#30124), `rst2ipynb`, and their dependencies.\n-These are special because they are Python-implemented applications; they do not run in the same process as `sagelib`.\n-\n \n In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n \n+The main approach is to record the supported versions of Python packages needed by Sage in new files - instead of using `spkg-configure.m4`:\n+\n+- #30719: Add build/pkgs/SPKG/install-requires.txt for all Python packages\n+- Optionally: #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG\n+\n+For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`\n+\n+- #30124 enables use of system packages for the Python packages \n+`notebook` (#30124), `rst2ipynb`, and their dependencies.\n+These are special because they are\n+\n Questions to be resolved:\n-- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages:\n \n-  - #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG\n+- If we need a specific version (with patches that have not been upstreamed), how should this be reflected in these files?\n \n-  - In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?\n+- Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n-- Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n+Related/follow-up tickets:\n+- #29041 at `./bootstrap` time, generate `requirements.txt`, `constraints.txt`, `setup.cfg [install_requires]`, `Pipfile` from `build/pkgs`\n+- #30578 Add `src/requirements.txt` and `src/setup.cfg [install_requires]` for installation of `sagelib` in a venv\n+- #30371 In-place (editable) installs of `sagelib` in a venv\n \n-Related:\n-- #29500: Install all Python packages via pip wheel\n-\n-Tickets/issues for individual packages (moved here from #27330):\n+Tickets/issues for individual packages (moved here from #27330, will be obsolete with this ticket):\n * numpy\n * scipy\n * cypari (depends on pari)\n``````\n",
    "created_at": "2020-11-11T20:01:10Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456244",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,25 +1,30 @@
 This is a followup on #27824: `spkg-configure.m4` for python3.
-
-#30124 enables use of system packages for the Python packages 
-`notebook` (#30124), `rst2ipynb`, and their dependencies.
-These are special because they are Python-implemented applications; they do not run in the same process as `sagelib`.
-
 
 In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
 
+The main approach is to record the supported versions of Python packages needed by Sage in new files - instead of using `spkg-configure.m4`:
+
+- #30719: Add build/pkgs/SPKG/install-requires.txt for all Python packages
+- Optionally: #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG
+
+For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`
+
+- #30124 enables use of system packages for the Python packages 
+`notebook` (#30124), `rst2ipynb`, and their dependencies.
+These are special because they are
+
 Questions to be resolved:
-- Use of `requirements.txt`/`contraints.txt` vs. `spkg-configure.m4` for Python packages:
 
-  - #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG
+- If we need a specific version (with patches that have not been upstreamed), how should this be reflected in these files?
 
-  - In particular: If we need a specific version (with patches that have not been upstreamed), how should this be reflected in `requirements.txt`/`contraints.txt`?
+- Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
-- Installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
+Related/follow-up tickets:
+- #29041 at `./bootstrap` time, generate `requirements.txt`, `constraints.txt`, `setup.cfg [install_requires]`, `Pipfile` from `build/pkgs`
+- #30578 Add `src/requirements.txt` and `src/setup.cfg [install_requires]` for installation of `sagelib` in a venv
+- #30371 In-place (editable) installs of `sagelib` in a venv
 
-Related:
-- #29500: Install all Python packages via pip wheel
-
-Tickets/issues for individual packages (moved here from #27330):
+Tickets/issues for individual packages (moved here from #27330, will be obsolete with this ticket):
 * numpy
 * scipy
 * cypari (depends on pari)
``````




---

archive/issue_comments_456245.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -9,9 +9,7 @@\n \n For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`\n \n-- #30124 enables use of system packages for the Python packages \n-`notebook` (#30124), `rst2ipynb`, and their dependencies.\n-These are special because they are\n+- #30124 enables use of system packages for the Python packages `notebook` (#30124), `rst2ipynb`, and their dependencies. \n \n Questions to be resolved:\n \n``````\n",
    "created_at": "2020-11-11T20:01:42Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456245",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -9,9 +9,7 @@
 
 For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`
 
-- #30124 enables use of system packages for the Python packages 
-`notebook` (#30124), `rst2ipynb`, and their dependencies.
-These are special because they are
+- #30124 enables use of system packages for the Python packages `notebook` (#30124), `rst2ipynb`, and their dependencies. 
 
 Questions to be resolved:
 
``````




---

archive/issue_events_257739.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-11T20:08:42Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "rename": {
        "from": "Meta-ticket: In a python 3 build, optionally use system Python packages",
        "to": "Meta-ticket: ./configure --enable-system-site-packages (optionally use system Python packages)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257739"
}
```



---

archive/issue_comments_456246.json:
```json
{
    "body": "<a id='comment:34'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456246",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_257740.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257740"
}
```



---

archive/issue_events_257741.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257741"
}
```



---

archive/issue_events_257742.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257742"
}
```



---

archive/issue_events_257743.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257743"
}
```



---

archive/issue_comments_456247.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,19 +1,48 @@\n This is a followup on #27824: `spkg-configure.m4` for python3.\n \n-In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.\n+In the next step, we make it possible for users to enable use of system Python packages (site packages).\n \n-The main approach is to record the supported versions of Python packages needed by Sage in new files - instead of using `spkg-configure.m4`:\n+It is crucial to distinguish two categories of Python packages.\n \n-- #30719: Add build/pkgs/SPKG/install-requires.txt for all Python packages\n-- Optionally: #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG\n+**A. Python-implemented applications not running in the same process as sagelib**\n \n For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`\n \n - #30124 enables use of system packages for the Python packages `notebook` (#30124), `rst2ipynb`, and their dependencies. \n \n+'''B. Packages that run in the same process as sagelib.``\n+\n+Use of these packages would be enabled by a new configure option `--enable-system-site-packages`. \n+\n+1. This will set up the venv using `build/bin/sage-venv --system-site-packages`\n+\n+2. Separate the installation process of a Python package into several phases (makefile targets):\n+\n+   i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)\n+\n+   ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist\n+\n+   iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it\n+\n+   iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`\n+\n+   v) Install the wheel\n+\n Questions to be resolved:\n \n-- If we need a specific version (with patches that have not been upstreamed), how should this be reflected in these files?\n+- ticket:32492#comment:17 -- installed packages are only considered by pip if they can also be found in an index.  As we use `--no-index`, the workaround in #32492 provides the directory `$SAGE_SPKG_WHEELS` as the index. \n+\n+  To be checked if the specific installed version of the package needs to be found in the index. If presence of any version (= spkg version) will cause pip to consider the installed version as a candidate for resolution, then we can just leave the decision whether to use the installed package or the spkg to the resolver and the pip upgrade-strategy. \n+\n+  If a package needs any special preparation for building a wheel such as setting of environment variables, we need to:\n+\n+  a) either invoke phase iv) explicitly (so wheels of such packages may be built but remain unused);\n+\n+  b) or try to move the environment settings to the general build environment; \n+\n+  c) or patch the Python package's build script instead, treating it like phase ii).\n+\n+- If we need a specific version (with patches that have not been upstreamed), should this be reflected in dependency information (`install-requires.txt`)?\n \n - Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n``````\n",
    "created_at": "2021-09-09T22:48:01Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456247",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,19 +1,48 @@
 This is a followup on #27824: `spkg-configure.m4` for python3.
 
-In the next step, we enable use of system site packages using a new configure option `--enable-system-site-packages`.
+In the next step, we make it possible for users to enable use of system Python packages (site packages).
 
-The main approach is to record the supported versions of Python packages needed by Sage in new files - instead of using `spkg-configure.m4`:
+It is crucial to distinguish two categories of Python packages.
 
-- #30719: Add build/pkgs/SPKG/install-requires.txt for all Python packages
-- Optionally: #30024: Add `build/pkgs/SPKG/requirements.txt` for all Python SPKG
+**A. Python-implemented applications not running in the same process as sagelib**
 
 For some specific packages that provide Python-implemented applications and do not run in the same process as `sagelib`, there are separate tickets that may use `spkg-configure.m4`
 
 - #30124 enables use of system packages for the Python packages `notebook` (#30124), `rst2ipynb`, and their dependencies. 
 
+'''B. Packages that run in the same process as sagelib.``
+
+Use of these packages would be enabled by a new configure option `--enable-system-site-packages`. 
+
+1. This will set up the venv using `build/bin/sage-venv --system-site-packages`
+
+2. Separate the installation process of a Python package into several phases (makefile targets):
+
+   i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)
+
+   ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist
+
+   iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it
+
+   iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`
+
+   v) Install the wheel
+
 Questions to be resolved:
 
-- If we need a specific version (with patches that have not been upstreamed), how should this be reflected in these files?
+- ticket:32492#comment:17 -- installed packages are only considered by pip if they can also be found in an index.  As we use `--no-index`, the workaround in #32492 provides the directory `$SAGE_SPKG_WHEELS` as the index. 
+
+  To be checked if the specific installed version of the package needs to be found in the index. If presence of any version (= spkg version) will cause pip to consider the installed version as a candidate for resolution, then we can just leave the decision whether to use the installed package or the spkg to the resolver and the pip upgrade-strategy. 
+
+  If a package needs any special preparation for building a wheel such as setting of environment variables, we need to:
+
+  a) either invoke phase iv) explicitly (so wheels of such packages may be built but remain unused);
+
+  b) or try to move the environment settings to the general build environment; 
+
+  c) or patch the Python package's build script instead, treating it like phase ii).
+
+- If we need a specific version (with patches that have not been upstreamed), should this be reflected in dependency information (`install-requires.txt`)?
 
 - Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
``````




---

archive/issue_comments_456248.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -47,6 +47,7 @@\n - Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages\n \n Related/follow-up tickets:\n+- #31543 Meta-ticket: Eliminate use of patches for Python packages\n - #29041 at `./bootstrap` time, generate `requirements.txt`, `constraints.txt`, `setup.cfg [install_requires]`, `Pipfile` from `build/pkgs`\n - #30578 Add `src/requirements.txt` and `src/setup.cfg [install_requires]` for installation of `sagelib` in a venv\n - #30371 In-place (editable) installs of `sagelib` in a venv\n``````\n",
    "created_at": "2021-09-10T07:06:31Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456248",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -47,6 +47,7 @@
 - Investigate pip's and other tools behavior when installing an upgraded/downgraded version of a package in the venv when the package is installed in the system site packages
 
 Related/follow-up tickets:
+- #31543 Meta-ticket: Eliminate use of patches for Python packages
 - #29041 at `./bootstrap` time, generate `requirements.txt`, `constraints.txt`, `setup.cfg [install_requires]`, `Pipfile` from `build/pkgs`
 - #30578 Add `src/requirements.txt` and `src/setup.cfg [install_requires]` for installation of `sagelib` in a venv
 - #30371 In-place (editable) installs of `sagelib` in a venv
``````




---

archive/issue_events_257744.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257744"
}
```



---

archive/issue_events_257745.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257745"
}
```



---

archive/issue_comments_456249.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,19 +14,25 @@\n \n Use of these packages would be enabled by a new configure option `--enable-system-site-packages`. \n \n-1. This will set up the venv using `build/bin/sage-venv --system-site-packages`\n+This will set up the venv using `build/bin/sage-venv --system-site-packages`\n \n-2. Separate the installation process of a Python package into several phases (makefile targets):\n+*Approach 1:*\n \n-   i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)\n+- #29665: `configure --enable-system-site-packages` via `spkg-configure.m4`\n \n-   ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist\n+*Approach 2:*\n \n-   iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it\n+- Separate the installation process of a Python package into several phases (makefile targets):\n \n-   iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`\n+  i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)\n \n-   v) Install the wheel\n+  ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist\n+\n+  iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it\n+\n+  iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`\n+\n+  v) Install the wheel\n \n Questions to be resolved:\n \n@@ -56,7 +62,6 @@\n * numpy\n * scipy\n * cypari (depends on pari)\n-* cvxopt (experimental spkg-configure.m4 for a Python library) (#29665)\n \n ---\n \n``````\n",
    "created_at": "2022-02-14T18:31:08Z",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29023#issuecomment-456249",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,19 +14,25 @@
 
 Use of these packages would be enabled by a new configure option `--enable-system-site-packages`. 
 
-1. This will set up the venv using `build/bin/sage-venv --system-site-packages`
+This will set up the venv using `build/bin/sage-venv --system-site-packages`
 
-2. Separate the installation process of a Python package into several phases (makefile targets):
+*Approach 1:*
 
-   i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)
+- #29665: `configure --enable-system-site-packages` via `spkg-configure.m4`
 
-   ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist
+*Approach 2:*
 
-   iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it
+- Separate the installation process of a Python package into several phases (makefile targets):
 
-   iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`
+  i) Downloading the spkg tarball (in most cases the tarball will already be an sdist, i.e., with embedded metadata)
 
-   v) Install the wheel
+  ii) (When patches are needed or the upstream tarball is not a real sdist:) Unpack, patch, make a new sdist
+
+  iii) Copy the sdist to `$SAGE_SPKG_WHEELS` or a new directory next to it
+
+  iv) Build a wheel and copy to `$SAGE_SPKG_WHEELS`
+
+  v) Install the wheel
 
 Questions to be resolved:
 
@@ -56,7 +62,6 @@
 * numpy
 * scipy
 * cypari (depends on pari)
-* cvxopt (experimental spkg-configure.m4 for a Python library) (#29665)
 
 ---
 
``````




---

archive/issue_events_257746.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257746"
}
```



---

archive/issue_events_257747.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257747"
}
```



---

archive/issue_events_257748.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257748"
}
```



---

archive/issue_events_257749.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29023",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29023#event-257749"
}
```
