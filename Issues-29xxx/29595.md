# Issue 29595: Improve iteration of multivariate polynomials

archive/issues_029358.json:
```json
{
    "body": "CC:  @mwageringel @fchapoton\n\nKeywords: multivariate polynomial iteration\n\nWe should take advantage of methods being able to now use `yield` in Cython and add a method to iterate over `(coefficient, exponent)` pairs as this can be useful (instead of monomials).\n\n---\n\nThis also improves the iteration speed over multivariate polynomials:\n\n```\nsage: RR.<x,y> = ZZ[]\nsage: pR = R.sum(x^i*y^j for i in range(100) for j in range(100))\nsage: %timeit for _ in pR: pass\n100 loops, best of 5: 5.75 ms per loop\n\nsage: S.<x,y> = QQbar[]\nsage: pS = S.sum(x^i*y^j for i in range(100) for j in range(100))\nsage: %timeit for _ in pS: pass\n100 loops, best of 5: 11.1 ms per loop\n\nsage: L.<w,z> = LaurentPolynomialRing(R)\nsage: pL = L.sum(w^i*z^j for i in range(50) for j in range(50))\nsage: %timeit for _ in pL: pass\n100 loops, best of 5: 13 ms per loop\n```\nvs before:\n\n```\nsage: %timeit for _ in pR: pass\n100 loops, best of 5: 6.42 ms per loop\n\nsage: %timeit for _ in pS: pass\n100 loops, best of 5: 11.3 ms per loop\n\nsage: %timeit for _ in pL: pass\n10 loops, best of 5: 81.8 ms per loop\n```\nThere won't be really any improvement in the generic implementation in terms of speed. However, the memory usage for all of these methods has been cut.\n\n---\n\nThis improves the speed of a number of auxiliary methods:\n\n```\nsage: %timeit pS.is_constant()\n1000000 loops, best of 5: 258 ns per loop\nsage: %timeit pS.is_monomial()\n1000000 loops, best of 5: 286 ns per loop\nsage: %timeit pS.is_generator()\n1000000 loops, best of 5: 273 ns per loop\nsage: %timeit S.zero().is_constant()\n1000000 loops, best of 5: 326 ns per loop\n\nsage: %timeit pL.is_monomial()\n1000000 loops, best of 5: 307 ns per loop\nsage: %timeit pL[5,5]\n1000000 loops, best of 5: 611 ns per loop\nsage: %timeit ~pL\n100 loops, best of 5: 9.03 ms per loop\n\nsage: M.<w,z> = LaurentPolynomialRing(ZZ)\nsage: pM = M.sum(w^i*z^j for i in range(50) for j in range(50))\nsage: %timeit hash(pM)\n1000 loops, best of 5: 1.84 ms per loop\n```\nvs before\n\n```\nsage: %timeit pS.is_constant()\n10000 loops, best of 5: 83.2 \u00b5s per loop\nsage: %timeit pS.is_monomial()\n10000 loops, best of 5: 81 \u00b5s per loop\nsage: %timeit pS.is_generator()\n10000 loops, best of 5: 82.8 \u00b5s per loop\nsage: %timeit S.zero().is_constant()\n1000000 loops, best of 5: 1.41 \u00b5s per loop\n\nsage: %timeit pL.is_monomial()\n100000 loops, best of 5: 15.2 \u00b5s per loop\nsage: %timeit pL[5,5]\n100000 loops, best of 5: 17.5 \u00b5s per loop\nsage: %timeit ~pL\n100 loops, best of 5: 9.46 ms per loop\n\nsage: %timeit hash(pM)\n100 loops, best of 5: 2.13 ms per loop\n```\n\n---\n\nWe add `is_term`, which was missing from libsingular multivariate polynomials. We also fix a bug that claims the 0 polynomial was a monomial:\n\n```\nsage: P.<x,y,z> = PolynomialRing(QQ)\nsage: P.zero().is_monomial()\nTrue\n```\n\n---\n\nAnother bug-fix is that exponents of generic MPolys were mutable and cached:\n\n```\nsage: pS.exponents().pop()\n(0, 0)\nsage: _ in pS.exponents()\nFalse\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29595\n\n",
    "closed_at": "2020-05-31T08:49:07Z",
    "created_at": "2020-04-27T03:15:29Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Improve iteration of multivariate polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29595",
    "user": "https://github.com/tscrim"
}
```
CC:  @mwageringel @fchapoton

Keywords: multivariate polynomial iteration

We should take advantage of methods being able to now use `yield` in Cython and add a method to iterate over `(coefficient, exponent)` pairs as this can be useful (instead of monomials).

---

This also improves the iteration speed over multivariate polynomials:

```
sage: RR.<x,y> = ZZ[]
sage: pR = R.sum(x^i*y^j for i in range(100) for j in range(100))
sage: %timeit for _ in pR: pass
100 loops, best of 5: 5.75 ms per loop

sage: S.<x,y> = QQbar[]
sage: pS = S.sum(x^i*y^j for i in range(100) for j in range(100))
sage: %timeit for _ in pS: pass
100 loops, best of 5: 11.1 ms per loop

sage: L.<w,z> = LaurentPolynomialRing(R)
sage: pL = L.sum(w^i*z^j for i in range(50) for j in range(50))
sage: %timeit for _ in pL: pass
100 loops, best of 5: 13 ms per loop
```
vs before:

```
sage: %timeit for _ in pR: pass
100 loops, best of 5: 6.42 ms per loop

sage: %timeit for _ in pS: pass
100 loops, best of 5: 11.3 ms per loop

sage: %timeit for _ in pL: pass
10 loops, best of 5: 81.8 ms per loop
```
There won't be really any improvement in the generic implementation in terms of speed. However, the memory usage for all of these methods has been cut.

---

This improves the speed of a number of auxiliary methods:

```
sage: %timeit pS.is_constant()
1000000 loops, best of 5: 258 ns per loop
sage: %timeit pS.is_monomial()
1000000 loops, best of 5: 286 ns per loop
sage: %timeit pS.is_generator()
1000000 loops, best of 5: 273 ns per loop
sage: %timeit S.zero().is_constant()
1000000 loops, best of 5: 326 ns per loop

sage: %timeit pL.is_monomial()
1000000 loops, best of 5: 307 ns per loop
sage: %timeit pL[5,5]
1000000 loops, best of 5: 611 ns per loop
sage: %timeit ~pL
100 loops, best of 5: 9.03 ms per loop

sage: M.<w,z> = LaurentPolynomialRing(ZZ)
sage: pM = M.sum(w^i*z^j for i in range(50) for j in range(50))
sage: %timeit hash(pM)
1000 loops, best of 5: 1.84 ms per loop
```
vs before

```
sage: %timeit pS.is_constant()
10000 loops, best of 5: 83.2 µs per loop
sage: %timeit pS.is_monomial()
10000 loops, best of 5: 81 µs per loop
sage: %timeit pS.is_generator()
10000 loops, best of 5: 82.8 µs per loop
sage: %timeit S.zero().is_constant()
1000000 loops, best of 5: 1.41 µs per loop

sage: %timeit pL.is_monomial()
100000 loops, best of 5: 15.2 µs per loop
sage: %timeit pL[5,5]
100000 loops, best of 5: 17.5 µs per loop
sage: %timeit ~pL
100 loops, best of 5: 9.46 ms per loop

sage: %timeit hash(pM)
100 loops, best of 5: 2.13 ms per loop
```

---

We add `is_term`, which was missing from libsingular multivariate polynomials. We also fix a bug that claims the 0 polynomial was a monomial:

```
sage: P.<x,y,z> = PolynomialRing(QQ)
sage: P.zero().is_monomial()
True
```

---

Another bug-fix is that exponents of generic MPolys were mutable and cached:

```
sage: pS.exponents().pop()
(0, 0)
sage: _ in pS.exponents()
False
```


Issue created by migration from https://trac.sagemath.org/ticket/29595





---

archive/issue_comments_415866.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-05-16T05:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415866",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_415867.json:
```json
{
    "body": "Changing component from algebra to performance.",
    "created_at": "2020-05-16T05:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415867",
    "user": "https://github.com/tscrim"
}
```

Changing component from algebra to performance.



---

archive/issue_comments_415868.json:
```json
{
    "body": "Okay, I might have gone a bit overboard at the end. However, some of these little methods get some major speedups. There might be some other places to optimize. Definitely converting the generic multivariate polynomials to Cython will help and/or pushing more stuff to the polydict backend.\n\nI was actually expecting a bit more of a speedup from the libsingular iterator, but I guess that just goes to show the speed of the builtin Python iterators. However, it still gets about a ~10% speedup, which is nice, beyond the memory savings.\n\n---\nNew commits:",
    "created_at": "2020-05-16T05:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415868",
    "user": "https://github.com/tscrim"
}
```

Okay, I might have gone a bit overboard at the end. However, some of these little methods get some major speedups. There might be some other places to optimize. Definitely converting the generic multivariate polynomials to Cython will help and/or pushing more stuff to the polydict backend.

I was actually expecting a bit more of a speedup from the libsingular iterator, but I guess that just goes to show the speed of the builtin Python iterators. However, it still gets about a ~10% speedup, which is nice, beyond the memory savings.

---
New commits:



---

archive/issue_comments_415869.json:
```json
{
    "body": "one failing doctest\n\n```\nFile \"src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\", line 3186, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__iter__\nFailed example:\n    list(R.zero())\nExpected nothing\nGot:\n    []\n```",
    "created_at": "2020-05-16T07:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415869",
    "user": "https://github.com/fchapoton"
}
```

one failing doctest

```
File "src/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 3186, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__iter__
Failed example:
    list(R.zero())
Expected nothing
Got:
    []
```



---

archive/issue_comments_415870.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-16T07:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415870",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415871.json:
```json
{
    "body": "Whoops; fixed.",
    "created_at": "2020-05-16T07:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415871",
    "user": "https://github.com/tscrim"
}
```

Whoops; fixed.



---

archive/issue_comments_415872.json:
```json
{
    "body": "Looks good. There remains \n\n```\n+        one = ring.base_ring()(1)\n```\nthat maybe could use `.one()` ?",
    "created_at": "2020-05-17T06:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415872",
    "user": "https://github.com/fchapoton"
}
```

Looks good. There remains 

```
+        one = ring.base_ring()(1)
```
that maybe could use `.one()` ?



---

archive/issue_comments_415873.json:
```json
{
    "body": "Replying to [comment:5 chapoton]:\n> Looks good. There remains \n> \n> ```\n> +        one = ring.base_ring()(1)\n> ```\n> that maybe could use `.one()` ?\n\n\nI saw that and I was a little hesitant about changing it as I couldn't remember if we could create polynomials with coefficients in Python types, such as `int`. However, from looking at it a bit more, it seems like this cannot happen, so I will change it.",
    "created_at": "2020-05-17T06:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415873",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:5 chapoton]:
> Looks good. There remains 
> 
> ```
> +        one = ring.base_ring()(1)
> ```
> that maybe could use `.one()` ?


I saw that and I was a little hesitant about changing it as I couldn't remember if we could create polynomials with coefficients in Python types, such as `int`. However, from looking at it a bit more, it seems like this cannot happen, so I will change it.



---

archive/issue_comments_415874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-18T01:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-18T01:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415876.json:
```json
{
    "body": "Done with some little bit of other cleanup/micro-optimizations.",
    "created_at": "2020-05-18T01:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415876",
    "user": "https://github.com/tscrim"
}
```

Done with some little bit of other cleanup/micro-optimizations.



---

archive/issue_comments_415877.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-18T07:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415877",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_415878.json:
```json
{
    "body": "ok, looks good. Nice improvement",
    "created_at": "2020-05-18T07:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415878",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good. Nice improvement



---

archive/issue_comments_415879.json:
```json
{
    "body": "Replying to [comment:11 chapoton]:\n> ok, looks good. Nice improvement\n\n\nThank you.",
    "created_at": "2020-05-19T00:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415879",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:11 chapoton]:
> ok, looks good. Nice improvement


Thank you.



---

archive/issue_comments_415880.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-05-21T17:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415880",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_415881.json:
```json
{
    "body": "merge conflict",
    "created_at": "2020-05-21T17:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415881",
    "user": "https://github.com/vbraun"
}
```

merge conflict



---

archive/issue_comments_415882.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-29T01:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415882",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_415883.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-05-29T01:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415883",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_415884.json:
```json
{
    "body": "Trivial rebase.",
    "created_at": "2020-05-29T01:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415884",
    "user": "https://github.com/tscrim"
}
```

Trivial rebase.



---

archive/issue_events_075575.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-05-31T08:49:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29595#event-75575"
}
```



---

archive/issue_comments_415885.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-31T08:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29595#issuecomment-415885",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
