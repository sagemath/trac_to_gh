# Issue 29936: Fix moebius_transform, midpoint and perpendicular_bisector

archive/issues_029699.json:
```json
{
    "assignees": [],
    "body": "We fix several related issues in hyperbolic geometry:\n\n- `moebius_transform` wrong in the orientation-reversing\n  (negative determinant) case\n- `midpoint` and `perpendicular_bisector`\n  gave different results for (a, b) and (b, a)\n\nFuzzing `geometry/hyperbolic_space/hyperbolic_geodesic.py`\ndoctests uncovered these issues. See #29935, #29962, #29963.\n\n\n```\nUHP = HyperbolicPlane().UHP()\nsage: g = UHP.random_geodesic()   # Good one\nsage: g.start(), g.end()\n(Point in UHP -9.26728445125634 + 7.15068223909426*I,\n Point in UHP -8.57515638592863 + 0.982992065975858*I)\nsage: g = UHP.random_geodesic()   # Bad one\nsage: g.start(), g.end()\n(Point in UHP -4.92591958004554 + 7.81075974592370*I,\n Point in UHP -8.44416583993011 + 3.87025183089797*I)\n```\n\n\nDepends on #29962\n\nCC:  @slel @orlitzky @tscrim @greglaun @sagetrac-jhonrubia6\n\nKeywords: **hyperbolic geodesic**\n\nBranch/Commit: **[`234604b`](https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2)**\n\nReviewer: **Samuel Leli\u00e8vre**\n\nAuthor: **Travis Scrimshaw**\n\nComponent: **geometry**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29936_\n\n",
    "closed_at": "2021-05-27T20:29:16Z",
    "created_at": "2020-06-22T15:12:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20geometry",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix moebius_transform, midpoint and perpendicular_bisector",
    "type": "issue",
    "updated_at": "2021-05-27T20:29:16Z",
    "url": "https://github.com/sagemath/sage/issues/29936",
    "user": "https://github.com/kliem"
}
```
We fix several related issues in hyperbolic geometry:

- `moebius_transform` wrong in the orientation-reversing
  (negative determinant) case
- `midpoint` and `perpendicular_bisector`
  gave different results for (a, b) and (b, a)

Fuzzing `geometry/hyperbolic_space/hyperbolic_geodesic.py`
doctests uncovered these issues. See #29935, #29962, #29963.


```
UHP = HyperbolicPlane().UHP()
sage: g = UHP.random_geodesic()   # Good one
sage: g.start(), g.end()
(Point in UHP -9.26728445125634 + 7.15068223909426*I,
 Point in UHP -8.57515638592863 + 0.982992065975858*I)
sage: g = UHP.random_geodesic()   # Bad one
sage: g.start(), g.end()
(Point in UHP -4.92591958004554 + 7.81075974592370*I,
 Point in UHP -8.44416583993011 + 3.87025183089797*I)
```


Depends on #29962

CC:  @slel @orlitzky @tscrim @greglaun @sagetrac-jhonrubia6

Keywords: **hyperbolic geodesic**

Branch/Commit: **[`234604b`](https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2)**

Reviewer: **Samuel Leli√®vre**

Author: **Travis Scrimshaw**

Component: **geometry**

_Issue created by migration from https://trac.sagemath.org/ticket/29936_





---

archive/issue_events_408982.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-22T15:12:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408982"
}
```



---

archive/issue_events_408983.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-22T15:12:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "c: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408983"
}
```



---

archive/issue_events_408984.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-22T15:12:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408984"
}
```



---

archive/issue_events_408985.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-22T15:12:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408985"
}
```



---

archive/issue_comments_473269.json:
```json
{
    "body": "Branch: **[public/29936](https://github.com/sagemath/sagetrac-mirror/tree/public/29936)**",
    "created_at": "2020-06-22T15:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473269",
    "user": "https://github.com/kliem"
}
```

Branch: **[public/29936](https://github.com/sagemath/sagetrac-mirror/tree/public/29936)**



---

archive/issue_comments_473270.json:
```json
{
    "body": "Author: **Jonathan Kliem**",
    "created_at": "2020-06-22T15:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473270",
    "user": "https://github.com/kliem"
}
```

Author: **Jonathan Kliem**



---

archive/issue_comments_473271.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe first thing is to use the flag `# abs tol` to obtain more meaningful doctest failures at random states. I get the following (not all during the same run):\n\n```\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 912, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesic.perpendicular_bisector\nFailed example:\n    abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())  # abs tol 1e-9\nExpected:\n    0\nGot:\n    0.309903204800636\nTolerance exceeded:\n    0 vs 0.309903204800636, tolerance 4e-1 > 1e-9\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1376, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP.perpendicular_bisector\nFailed example:\n    abs(c(g.intersection(h)[0]) - c(g.midpoint()))  # abs tol 1e-9\nExpected:\n    0\nGot:\n    9.74965482957673\nTolerance exceeded:\n    0 vs 9.74965482957673, tolerance 1e1 > 1e-9\n\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix\nFailed example:\n    abs(moebius_transform(A, p1))  # abs tol 1e-9\nExpected:\n    0\nGot:\n    1.82859072578637\nTolerance exceeded:\n    0 vs 1.82859072578637, tolerance 2e0 > 1e-9\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1916, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix\nFailed example:\n    abs(moebius_transform(A, p2) - 1)  # abs tol 1e-9\nExpected:\n    0\nGot:\n    0.619923876802936\nTolerance exceeded:\n    0 vs 0.619923876802936, tolerance 7e-1 > 1e-9\n```\n\nThis tells me that the preciseness that is claimed with the doctests is far from valid. \n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/23ed583462cad48b1c0cf47dbfc77752d3dd3be1\"><code>23ed583</code></a></td><td><code>fix doctest in hyperbolic_space/hyperbolic_point</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5283dc49042f5bfd45e2cfa92c567e6843b22f6d\"><code>5283dc4</code></a></td><td><code>use abs tol flag</code></td></tr></table>\n",
    "created_at": "2020-06-22T15:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473271",
    "user": "https://github.com/kliem"
}
```

<div id="comment:1" align="right">comment:1</div>

The first thing is to use the flag `# abs tol` to obtain more meaningful doctest failures at random states. I get the following (not all during the same run):

```
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 912, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesic.perpendicular_bisector
Failed example:
    abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())  # abs tol 1e-9
Expected:
    0
Got:
    0.309903204800636
Tolerance exceeded:
    0 vs 0.309903204800636, tolerance 4e-1 > 1e-9
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1376, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP.perpendicular_bisector
Failed example:
    abs(c(g.intersection(h)[0]) - c(g.midpoint()))  # abs tol 1e-9
Expected:
    0
Got:
    9.74965482957673
Tolerance exceeded:
    0 vs 9.74965482957673, tolerance 1e1 > 1e-9

**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix
Failed example:
    abs(moebius_transform(A, p1))  # abs tol 1e-9
Expected:
    0
Got:
    1.82859072578637
Tolerance exceeded:
    0 vs 1.82859072578637, tolerance 2e0 > 1e-9
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1916, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix
Failed example:
    abs(moebius_transform(A, p2) - 1)  # abs tol 1e-9
Expected:
    0
Got:
    0.619923876802936
Tolerance exceeded:
    0 vs 0.619923876802936, tolerance 7e-1 > 1e-9
```

This tells me that the preciseness that is claimed with the doctests is far from valid. 

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/23ed583462cad48b1c0cf47dbfc77752d3dd3be1"><code>23ed583</code></a></td><td><code>fix doctest in hyperbolic_space/hyperbolic_point</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5283dc49042f5bfd45e2cfa92c567e6843b22f6d"><code>5283dc4</code></a></td><td><code>use abs tol flag</code></td></tr></table>




---

archive/issue_comments_473272.json:
```json
{
    "body": "Commit: **[`5283dc4`](https://github.com/sagemath/sagetrac-mirror/commit/5283dc49042f5bfd45e2cfa92c567e6843b22f6d)**",
    "created_at": "2020-06-22T15:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473272",
    "user": "https://github.com/kliem"
}
```

Commit: **[`5283dc4`](https://github.com/sagemath/sagetrac-mirror/commit/5283dc49042f5bfd45e2cfa92c567e6843b22f6d)**



---

archive/issue_comments_473273.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI know very little about numerics. From what I remember it makes sense to consider the relative error as well:\n\n\n\n```\nsage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform\nsage: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP\nsage: UHP = HyperbolicPlane().UHP()\nsage: def foo():\n....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\n....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\n....:     a = abs(moebius_transform(A, p1))\n....:     b = abs((moebius_transform(A, p2) - 1))\n....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()\n....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)\n....: \nsage: max(foo()[1] for _ in range(1000))\n0.157952578757514\nsage: max(foo()[0] for _ in range(1000))\n0.0615941849084595\n```\n\nThe situation is far worse with the other two tests, which are essentially the same, if I understand correctly:\n\n```\nsage: def foo():\n....:     g = HyperbolicPlane().PD().random_geodesic()\n....:     h = g.perpendicular_bisector()\n....:     error = abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())\n....:     sum_of_norms = h.intersection(g)[0].coordinates().norm() + g.midpoint().coordinates().norm()\n....:     return min(error, error/sum_of_norms)\n....: \nsage: max(foo() for _ in range(10))\n0.908342722333419\n```",
    "created_at": "2020-06-22T16:19:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473273",
    "user": "https://github.com/kliem"
}
```

<div id="comment:2" align="right">comment:2</div>

I know very little about numerics. From what I remember it makes sense to consider the relative error as well:



```
sage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform
sage: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP
sage: UHP = HyperbolicPlane().UHP()
sage: def foo():
....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
....:     a = abs(moebius_transform(A, p1))
....:     b = abs((moebius_transform(A, p2) - 1))
....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()
....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)
....: 
sage: max(foo()[1] for _ in range(1000))
0.157952578757514
sage: max(foo()[0] for _ in range(1000))
0.0615941849084595
```

The situation is far worse with the other two tests, which are essentially the same, if I understand correctly:

```
sage: def foo():
....:     g = HyperbolicPlane().PD().random_geodesic()
....:     h = g.perpendicular_bisector()
....:     error = abs(h.intersection(g)[0].coordinates() - g.midpoint().coordinates())
....:     sum_of_norms = h.intersection(g)[0].coordinates().norm() + g.midpoint().coordinates().norm()
....:     return min(error, error/sum_of_norms)
....: 
sage: max(foo() for _ in range(10))
0.908342722333419
```



---

archive/issue_comments_473274.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b244c03bb763bde8a3b95fa2ce5c129562c3260\"><code>7b244c0</code></a></td><td><code>modify doctests to the extend that they hold with fuzz</code></td></tr></table>\n",
    "created_at": "2020-06-22T18:07:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473274",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b244c03bb763bde8a3b95fa2ce5c129562c3260"><code>7b244c0</code></a></td><td><code>modify doctests to the extend that they hold with fuzz</code></td></tr></table>




---

archive/issue_comments_473275.json:
```json
{
    "body": "Changed commit from **[`5283dc4`](https://github.com/sagemath/sagetrac-mirror/commit/5283dc49042f5bfd45e2cfa92c567e6843b22f6d)** to **[`7b244c0`](https://github.com/sagemath/sagetrac-mirror/commit/7b244c03bb763bde8a3b95fa2ce5c129562c3260)**",
    "created_at": "2020-06-22T18:07:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473275",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5283dc4`](https://github.com/sagemath/sagetrac-mirror/commit/5283dc49042f5bfd45e2cfa92c567e6843b22f6d)** to **[`7b244c0`](https://github.com/sagemath/sagetrac-mirror/commit/7b244c03bb763bde8a3b95fa2ce5c129562c3260)**



---

archive/issue_events_408986.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-22T18:15:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408986"
}
```



---

archive/issue_comments_473276.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI tested 10 times and not a single test failed. I hope that is good enough.",
    "created_at": "2020-06-22T18:15:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473276",
    "user": "https://github.com/kliem"
}
```

<div id="comment:4" align="right">comment:4</div>

I tested 10 times and not a single test failed. I hope that is good enough.



---

archive/issue_comments_473277.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,7 @@\n \n Also there is an equality in `geometry/hyperbolic_space/hyperbolic_point.py` that doesn't always hold.\n \n-We fix those tests to also hold at random state.\n+We modify precision to an extend that those tests do pass usually.\n+\n+Follow up:\n+  #29939 the problem.\n``````\n",
    "created_at": "2020-06-22T18:15:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473277",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,7 @@
 
 Also there is an equality in `geometry/hyperbolic_space/hyperbolic_point.py` that doesn't always hold.
 
-We fix those tests to also hold at random state.
+We modify precision to an extend that those tests do pass usually.
+
+Follow up:
+  #29939 the problem.
``````




---

archive/issue_events_408987.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-06-22T18:15:57Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "title_is": "Fix wrong precicion claims in geometry doctests",
    "title_was": "Fix precicion errors in geometry",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408987"
}
```



---

archive/issue_comments_473278.json:
```json
{
    "body": "Changed keywords from none to **hyperbolic geodesic, hyperbolic point**",
    "created_at": "2020-06-22T18:15:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473278",
    "user": "https://github.com/kliem"
}
```

Changed keywords from none to **hyperbolic geodesic, hyperbolic point**



---

archive/issue_events_408988.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-06-24T05:53:00Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "title_is": "Fix wrong precision claims in geometry doctests",
    "title_was": "Fix wrong precicion claims in geometry doctests",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408988"
}
```



---

archive/issue_comments_473279.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n-There are some claims in doctests of `geometry/hyperbolic_space/hyperbolic_geodesic.py` about precicion that simply don't hold unless you get lucky.\n+Some precision claims in doctests in `geometry/hyperbolic_space/hyperbolic_geodesic.py` only hold in lucky cases.\n \n-Also there is an equality in `geometry/hyperbolic_space/hyperbolic_point.py` that doesn't always hold.\n+Likewise, an equality in `geometry/hyperbolic_space/hyperbolic_point.py` doesn't always hold.\n \n-We modify precision to an extend that those tests do pass usually.\n+We add tolerance so those tests pass usually.\n \n Follow up:\n-  #29939 the problem.\n+- #29939 fix the precision problem\n``````\n",
    "created_at": "2020-06-24T05:53:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473279",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
-There are some claims in doctests of `geometry/hyperbolic_space/hyperbolic_geodesic.py` about precicion that simply don't hold unless you get lucky.
+Some precision claims in doctests in `geometry/hyperbolic_space/hyperbolic_geodesic.py` only hold in lucky cases.
 
-Also there is an equality in `geometry/hyperbolic_space/hyperbolic_point.py` that doesn't always hold.
+Likewise, an equality in `geometry/hyperbolic_space/hyperbolic_point.py` doesn't always hold.
 
-We modify precision to an extend that those tests do pass usually.
+We add tolerance so those tests pass usually.
 
 Follow up:
-  #29939 the problem.
+- #29939 fix the precision problem
``````




---

archive/issue_comments_473280.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n\nFor something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?",
    "created_at": "2020-07-12T19:34:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473280",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:6" align="right">comment:6</div>

I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.

For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?



---

archive/issue_comments_473281.json:
```json
{
    "body": "Dependencies: **#29962**",
    "created_at": "2020-07-12T19:55:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473281",
    "user": "https://github.com/kliem"
}
```

Dependencies: **#29962**



---

archive/issue_comments_473282.json:
```json
{
    "body": "Changed commit from **[`7b244c0`](https://github.com/sagemath/sagetrac-mirror/commit/7b244c03bb763bde8a3b95fa2ce5c129562c3260)** to **[`8292b04`](https://github.com/sagemath/sagetrac-mirror/commit/8292b04158fcc2f3e8fed87670026cbdfb418744)**",
    "created_at": "2020-07-12T20:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473282",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[`7b244c0`](https://github.com/sagemath/sagetrac-mirror/commit/7b244c03bb763bde8a3b95fa2ce5c129562c3260)** to **[`8292b04`](https://github.com/sagemath/sagetrac-mirror/commit/8292b04158fcc2f3e8fed87670026cbdfb418744)**



---

archive/issue_comments_473283.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nTheoretically, there is not need to base this on top of #29962. But basically #29962 discovers those problems. So the doctest works fine until you test it on top of #29962 with a different random seed than 0.\n\n---\nLast 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da1c6beec7d0bb6b972d88ecf9fb4eccbdf285a5\"><code>da1c6be</code></a></td><td><code>start from a \"random\" random seed for doctesting</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7b836d789e034433d62f331f33fbc1821c0deaa\"><code>b7b836d</code></a></td><td><code>make random seed reproducible</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eedbe5ebea9c2b9da79404013c566fe17d0a3e20\"><code>eedbe5e</code></a></td><td><code>document random_seed</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/998b1b94ce1289ea92451a86e5f6191c37eaeb5a\"><code>998b1b9</code></a></td><td><code>default random seed 0 for now</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d7b00e3fc2ebc1dc9982a2df91d15e3f12e9432\"><code>1d7b00e</code></a></td><td><code>dash instead of underscore for command line options</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b31e2d5dba166fdb4d8f9f6730df8cdb065ccae7\"><code>b31e2d5</code></a></td><td><code>Merge branch 'public/29962' of git://trac.sagemath.org/sage into public/29962-reb</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f30dd9b9e13cb8134b85a1165375ac8bdd1f683\"><code>2f30dd9</code></a></td><td><code>small fixes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b62f781647851a3f27ecc95ea4b98b53838da112\"><code>b62f781</code></a></td><td><code>doctests do not start from a random seed by default yet</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d99129f26f4a065f9f9e5e13c3d5120a029e89f\"><code>1d99129</code></a></td><td><code>fix merge conflict</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8292b04158fcc2f3e8fed87670026cbdfb418744\"><code>8292b04</code></a></td><td><code>Merge branch 'public/29962-reb2' of git://trac.sagemath.org/sage into public/29936-reb</code></td></tr></table>\n",
    "created_at": "2020-07-12T20:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473283",
    "user": "https://github.com/kliem"
}
```

<div id="comment:8" align="right">comment:8</div>

Theoretically, there is not need to base this on top of #29962. But basically #29962 discovers those problems. So the doctest works fine until you test it on top of #29962 with a different random seed than 0.

---
Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da1c6beec7d0bb6b972d88ecf9fb4eccbdf285a5"><code>da1c6be</code></a></td><td><code>start from a "random" random seed for doctesting</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7b836d789e034433d62f331f33fbc1821c0deaa"><code>b7b836d</code></a></td><td><code>make random seed reproducible</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eedbe5ebea9c2b9da79404013c566fe17d0a3e20"><code>eedbe5e</code></a></td><td><code>document random_seed</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/998b1b94ce1289ea92451a86e5f6191c37eaeb5a"><code>998b1b9</code></a></td><td><code>default random seed 0 for now</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d7b00e3fc2ebc1dc9982a2df91d15e3f12e9432"><code>1d7b00e</code></a></td><td><code>dash instead of underscore for command line options</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b31e2d5dba166fdb4d8f9f6730df8cdb065ccae7"><code>b31e2d5</code></a></td><td><code>Merge branch 'public/29962' of git://trac.sagemath.org/sage into public/29962-reb</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f30dd9b9e13cb8134b85a1165375ac8bdd1f683"><code>2f30dd9</code></a></td><td><code>small fixes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b62f781647851a3f27ecc95ea4b98b53838da112"><code>b62f781</code></a></td><td><code>doctests do not start from a random seed by default yet</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d99129f26f4a065f9f9e5e13c3d5120a029e89f"><code>1d99129</code></a></td><td><code>fix merge conflict</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8292b04158fcc2f3e8fed87670026cbdfb418744"><code>8292b04</code></a></td><td><code>Merge branch 'public/29962-reb2' of git://trac.sagemath.org/sage into public/29936-reb</code></td></tr></table>




---

archive/issue_comments_473284.json:
```json
{
    "body": "Changed branch from **[public/29936](https://github.com/sagemath/sagetrac-mirror/tree/public/29936)** to **[public/29936-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29936-reb)**",
    "created_at": "2020-07-12T20:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473284",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/29936](https://github.com/sagemath/sagetrac-mirror/tree/public/29936)** to **[public/29936-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29936-reb)**



---

archive/issue_comments_473285.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@orlitzky](#comment%3A6):\n> I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n\nI agree. That's why I opened #29939 to fix this.\n> \n> For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?\n\nI agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read. But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).",
    "created_at": "2020-07-12T20:05:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473285",
    "user": "https://github.com/kliem"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@orlitzky](#comment%3A6):
> I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.

I agree. That's why I opened #29939 to fix this.
> 
> For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?

I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read. But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).



---

archive/issue_comments_473286.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@kliem](#comment%3A9):\n> Replying to [@orlitzky](#comment%3A6):\n> > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n\n> I agree. That's why I opened #29939 to fix this.\n\nIt looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.\n\n> > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?\n\n> \n> I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.\n\nI disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.\n\n> But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).\n\nYou have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.",
    "created_at": "2020-07-12T23:40:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473286",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@kliem](#comment%3A9):
> Replying to [@orlitzky](#comment%3A6):
> > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.

> I agree. That's why I opened #29939 to fix this.

It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.

> > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?

> 
> I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.

I disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.

> But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).

You have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.



---

archive/issue_comments_473287.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@tscrim](#comment%3A10):\n> \n> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.\n\nThe original tests also fail if you introduce any randomness at all. I'm mainly concerned about the errors that Jonathan noticed right away, e.g.\n\n```\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix\nFailed example:\n    abs(moebius_transform(A, p1))  # abs tol 1e-9\nExpected:\n    0\nGot:\n    1.82859072578637\nTolerance exceeded:\n    0 vs 1.82859072578637, tolerance 2e0 > 1e-9\n```\n\nIf you have a method that's supposed to return zero but instead returns two, something other than numerical noise might be to blame. Can that test be re-run with a failing random seed, to see what a failing example looks like?",
    "created_at": "2020-07-13T01:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473287",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@tscrim](#comment%3A10):
> 
> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.

The original tests also fail if you introduce any randomness at all. I'm mainly concerned about the errors that Jonathan noticed right away, e.g.

```
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 1914, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicUHP._crossratio_matrix
Failed example:
    abs(moebius_transform(A, p1))  # abs tol 1e-9
Expected:
    0
Got:
    1.82859072578637
Tolerance exceeded:
    0 vs 1.82859072578637, tolerance 2e0 > 1e-9
```

If you have a method that's supposed to return zero but instead returns two, something other than numerical noise might be to blame. Can that test be re-run with a failing random seed, to see what a failing example looks like?



---

archive/issue_comments_473288.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@tscrim](#comment%3A10):\n> Replying to [@kliem](#comment%3A9):\n> > Replying to [@orlitzky](#comment%3A6):\n> > > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.\n\n> > I agree. That's why I opened #29939 to fix this.\n\n> \n> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.\n> \n> > > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?\n\n> > \n> > I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.\n\n> \n> I disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.\n> \n> > But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).\n\n> \n> You have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.\n\nI'm taking the minimum of the absolute and the relative error, because I want to be fair. This makes it much better. This is the original test:\n\n```\nsage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform\n....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP\n....: UHP = HyperbolicPlane().UHP()\n....: def foo():\n....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\n....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\n....:     a = abs(moebius_transform(A, p1))\n....:     b = abs((moebius_transform(A, p2) - 1))\n....:     return (a,b)\n....: \nsage: max(foo()[1] for _ in range(1000))\n19.6483996640312\nsage: max(foo()[0] for _ in range(1000))\n76.0110826766808\n```\n\nHere are examples that perform bad. I hope you see, why I chose to change the doctest to minimum of absolute and relative norm:\n\n```\nsage: (p1, p2, p3) = (-2.29920829511711 + 5.52937627459424*I, -2.37141010564321 + 5.57310680132109*I, 8.28221981185745 + 2.99165901130902*I)\nsage: A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\nsage: a = abs(moebius_transform(A, p1)); a\n105.706157025922\nsage: b = abs((moebius_transform(A, p2) - 1)); b\n105.113014884487\nsage: sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm(); sum_of_norms\n216.645504358830\n```",
    "created_at": "2020-07-13T05:07:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473288",
    "user": "https://github.com/kliem"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@tscrim](#comment%3A10):
> Replying to [@kliem](#comment%3A9):
> > Replying to [@orlitzky](#comment%3A6):
> > > I've added a few people to CC who may know how these tests are supposed to work. Those errors look pretty large to me.

> > I agree. That's why I opened #29939 to fix this.

> 
> It looks like you are comparing using relative tolerance, which if the values are close to 0, could cause large variations. Since you are taking things to be more random, it is quite possible you could divide by something close to 0. So I am not sure this is a bug as instead it could a problem that you have introduced by changing the doctests.
> 
> > > For something less substantial: I personally always try to limit my use of `abs tol` to the TESTS block (as opposed to EXAMPLES). The parsing of that comment is an internal detail of our doctest framework, and users who see it in the reference manual generally won't know what it means. Even those users who do understand it have to do a mental calculation when running the example to see if their output matches what is expected. Maybe you agree?

> > 
> > I agree. I moved that stuff to `TESTS`. Especially with the modified doctests, the tests are really hard to read.

> 
> I disagree. The problem is numerics and working with inexact fields. You cannot get around this. I don't exactly understand what your modified doctests are doing now other than they are comparing something relatively rather than absolutely.
> 
> > But I would argue that for some random stuff you cannot expect a good absolute error, but only a good relative error (and the minimum is needed, because you don't want to divide by zero).

> 
> You have two competing issues: large values want relative error, small values want absolute error. You have too much randomness now to deal with.

I'm taking the minimum of the absolute and the relative error, because I want to be fair. This makes it much better. This is the original test:

```
sage: from sage.geometry.hyperbolic_space.hyperbolic_isometry import moebius_transform
....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP
....: UHP = HyperbolicPlane().UHP()
....: def foo():
....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
....:     a = abs(moebius_transform(A, p1))
....:     b = abs((moebius_transform(A, p2) - 1))
....:     return (a,b)
....: 
sage: max(foo()[1] for _ in range(1000))
19.6483996640312
sage: max(foo()[0] for _ in range(1000))
76.0110826766808
```

Here are examples that perform bad. I hope you see, why I chose to change the doctest to minimum of absolute and relative norm:

```
sage: (p1, p2, p3) = (-2.29920829511711 + 5.52937627459424*I, -2.37141010564321 + 5.57310680132109*I, 8.28221981185745 + 2.99165901130902*I)
sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
sage: a = abs(moebius_transform(A, p1)); a
105.706157025922
sage: b = abs((moebius_transform(A, p2) - 1)); b
105.113014884487
sage: sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm(); sum_of_norms
216.645504358830
```



---

archive/issue_comments_473289.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nGiven those values, I think the original doctests are unacceptable. We know those exactness claims are wrong. Even if it succeeds with random seed 0, we shouldn't leave it as it is.",
    "created_at": "2020-07-13T05:12:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473289",
    "user": "https://github.com/kliem"
}
```

<div id="comment:13" align="right">comment:13</div>

Given those values, I think the original doctests are unacceptable. We know those exactness claims are wrong. Even if it succeeds with random seed 0, we shouldn't leave it as it is.



---

archive/issue_comments_473290.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nSo I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).\n\nFor the issue in the geodesic, the mathematics is correct:\n\n```\nsage: var('a0,a1,a2,b0,b1,b2')\n(a0, a1, a2, b0, b1, b2)\nsage: p0 = a0+b0*I\nsage: p1 = a1+b1*I\nsage: p2 = a2+b2*I\nsage: p0 = a0+b0*I\nsage: p1 = a1+b1*I\nsage: p2 = a2+b2*I\nsage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)\nsage: moebius_transform(A, p0)\n0\nsage: moebius_transform(A, p1).factor()\n1\nsage: moebius_transform(A, p2)\n+Infinity\n```\nSo I think the issue comes from this in the `moebius_transform` function:\n\n```python\n        if a * d - b * c < 0:\n            w = z.conjugate()  # Reverses orientation\n        else:\n            w = z\n```\nAt least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.\n\nThe problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.",
    "created_at": "2020-07-13T05:13:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473290",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">comment:14</div>

So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).

For the issue in the geodesic, the mathematics is correct:

```
sage: var('a0,a1,a2,b0,b1,b2')
(a0, a1, a2, b0, b1, b2)
sage: p0 = a0+b0*I
sage: p1 = a1+b1*I
sage: p2 = a2+b2*I
sage: p0 = a0+b0*I
sage: p1 = a1+b1*I
sage: p2 = a2+b2*I
sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)
sage: moebius_transform(A, p0)
0
sage: moebius_transform(A, p1).factor()
1
sage: moebius_transform(A, p2)
+Infinity
```
So I think the issue comes from this in the `moebius_transform` function:

```python
        if a * d - b * c < 0:
            w = z.conjugate()  # Reverses orientation
        else:
            w = z
```
At least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.

The problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.



---

archive/issue_comments_473291.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nSee also: https://en.wikipedia.org/wiki/M%C3%B6bius_transformation#Mapping_first_to_0,_1,_%E2%88%9E",
    "created_at": "2020-07-13T05:15:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473291",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

See also: https://en.wikipedia.org/wiki/M%C3%B6bius_transformation#Mapping_first_to_0,_1,_%E2%88%9E



---

archive/issue_comments_473292.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nNote that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.\n\nI still don't know what is going on with the perpendicular bisector.",
    "created_at": "2020-07-13T05:28:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473292",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:16" align="right">comment:16</div>

Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.

I still don't know what is going on with the perpendicular bisector.



---

archive/issue_comments_473293.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nWith the bisector, sometimes it is not intersecting the geodesic (but the completed versions do intersect perpendicularly). So that is why the test is failing, but I don't know why it is doing this.",
    "created_at": "2020-07-13T05:34:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473293",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

With the bisector, sometimes it is not intersecting the geodesic (but the completed versions do intersect perpendicularly). So that is why the test is failing, but I don't know why it is doing this.



---

archive/issue_comments_473294.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@tscrim](#comment%3A16):\n> Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.\n> \n> I still don't know what is going on with the perpendicular bisector.\n\nYou're right. It is a sign issue and not a precision issue:\n\n```\n....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP\n....: UHP = HyperbolicPlane().UHP()\n....: def foo():\n....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\n....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\n....:     a1 = abs(moebius_transform(A, p1))\n....:     a2 = abs(moebius_transform(A, p1.conjugate()))\n....:     a = min(a1, a2)\n....:     b1 = abs((moebius_transform(A, p2) - 1))\n....:     b2 = abs((moebius_transform(A, p2.conjugate()) - 1))\n....:     b = min(b1, b2)   \n....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()\n....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)\nsage: max(foo()[1] for _ in range(1000))\n3.32270874593069e-17\nsage: max(foo()[0] for _ in range(1000))\n0.000000000000000\n```\n\nIf you return just `a, b` (the absolute errors), you get:\n\n```\nsage: max(foo()[1] for _ in range(1000))\n2.79547014692442e-15\nsage: max(foo()[0] for _ in range(1000))\n0.000000000000000\n```\n\nI guess the absolute error works as well, because `The points are uniformly distributed over the rectangle [-10, 10] \\times [0, 10i]`.",
    "created_at": "2020-07-13T06:05:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473294",
    "user": "https://github.com/kliem"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@tscrim](#comment%3A16):
> Note that removing the `conjugate()` makes the test `RP*gP == gP` in `HyperbolicGeodesic.reflection_involution()` fail.
> 
> I still don't know what is going on with the perpendicular bisector.

You're right. It is a sign issue and not a precision issue:

```
....: from sage.geometry.hyperbolic_space.hyperbolic_geodesic import HyperbolicGeodesicUHP
....: UHP = HyperbolicPlane().UHP()
....: def foo():
....:     (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
....:     A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
....:     a1 = abs(moebius_transform(A, p1))
....:     a2 = abs(moebius_transform(A, p1.conjugate()))
....:     a = min(a1, a2)
....:     b1 = abs((moebius_transform(A, p2) - 1))
....:     b2 = abs((moebius_transform(A, p2.conjugate()) - 1))
....:     b = min(b1, b2)   
....:     sum_of_norms = A.norm() + p1.norm() + p2.norm() + p3.norm()
....:     return min(a, a/sum_of_norms), min(b, b/sum_of_norms)
sage: max(foo()[1] for _ in range(1000))
3.32270874593069e-17
sage: max(foo()[0] for _ in range(1000))
0.000000000000000
```

If you return just `a, b` (the absolute errors), you get:

```
sage: max(foo()[1] for _ in range(1000))
2.79547014692442e-15
sage: max(foo()[0] for _ in range(1000))
0.000000000000000
```

I guess the absolute error works as well, because `The points are uniformly distributed over the rectangle [-10, 10] \times [0, 10i]`.



---

archive/issue_comments_473295.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nSo the original doctests are fine up to a sign issue.",
    "created_at": "2020-07-13T06:06:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473295",
    "user": "https://github.com/kliem"
}
```

<div id="comment:19" align="right">comment:19</div>

So the original doctests are fine up to a sign issue.



---

archive/issue_comments_473296.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@tscrim](#comment%3A14):\n> So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).\n> \n> For the issue in the geodesic, the mathematics is correct:\n> \n> ```\n> sage: var('a0,a1,a2,b0,b1,b2')\n> (a0, a1, a2, b0, b1, b2)\n> sage: p0 = a0+b0*I\n> sage: p1 = a1+b1*I\n> sage: p2 = a2+b2*I\n> sage: p0 = a0+b0*I\n> sage: p1 = a1+b1*I\n> sage: p2 = a2+b2*I\n> sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)\n> sage: moebius_transform(A, p0)\n> 0\n> sage: moebius_transform(A, p1).factor()\n> 1\n> sage: moebius_transform(A, p2)\n> +Infinity\n> ```\n> So I think the issue comes from this in the `moebius_transform` function:\n> \n> ```python\n>         if a * d - b * c < 0:\n>             w = z.conjugate()  # Reverses orientation\n>         else:\n>             w = z\n> ```\n> At least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.\n> \n> The problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.\n\nI opened #29939 to fix this problem. But if we can fix this here that is fine with me to. If it would have been a precision problem, I don't think I would have been able to fix this. So this is why I opened a separate ticket.\n\nAnyway, I'm glad you figured out the actual problem.",
    "created_at": "2020-07-13T06:35:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473296",
    "user": "https://github.com/kliem"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@tscrim](#comment%3A14):
> So I agree with changing the test in `hyperbolic_point.py`: The equality test is perhaps a bit too narrow and needs to be expanded to allow for some fuzziness (up to some precision set globally).
> 
> For the issue in the geodesic, the mathematics is correct:
> 
> ```
> sage: var('a0,a1,a2,b0,b1,b2')
> (a0, a1, a2, b0, b1, b2)
> sage: p0 = a0+b0*I
> sage: p1 = a1+b1*I
> sage: p2 = a2+b2*I
> sage: p0 = a0+b0*I
> sage: p1 = a1+b1*I
> sage: p2 = a2+b2*I
> sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p0, p1, p2)
> sage: moebius_transform(A, p0)
> 0
> sage: moebius_transform(A, p1).factor()
> 1
> sage: moebius_transform(A, p2)
> +Infinity
> ```
> So I think the issue comes from this in the `moebius_transform` function:
> 
> ```python
>         if a * d - b * c < 0:
>             w = z.conjugate()  # Reverses orientation
>         else:
>             w = z
> ```
> At least, I only seem to notice it when the determinant of `A` has a negative real value. So if I remove the `conjugate()`, then the issue appears to be fixed.
> 
> The problem is not the doctests, which are correct and meaningful (testing the three points are indeed mapped to `0, 1, oo` in the UHP model). There is an honest bug and blaming the doctests means you have actually been trying to cover up a bug.

I opened #29939 to fix this problem. But if we can fix this here that is fine with me to. If it would have been a precision problem, I don't think I would have been able to fix this. So this is why I opened a separate ticket.

Anyway, I'm glad you figured out the actual problem.



---

archive/issue_comments_473297.json:
```json
{
    "body": "Changed branch from **[public/29936-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29936-reb)** to **[public/geometry/fix_hyperbolic_plane-29936](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/fix_hyperbolic_plane-29936)**",
    "created_at": "2020-07-13T08:18:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473297",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[public/29936-reb](https://github.com/sagemath/sagetrac-mirror/tree/public/29936-reb)** to **[public/geometry/fix_hyperbolic_plane-29936](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/fix_hyperbolic_plane-29936)**



---

archive/issue_comments_473298.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nSo the issue with the perp bisector comes from this:\n\n```\nsage: g = UHP.random_geodesic()   # Good one\nsage: g.start(), g.end()\n(Point in UHP -9.26728445125634 + 7.15068223909426*I,\n Point in UHP -8.57515638592863 + 0.982992065975858*I)\nsage: g = UHP.random_geodesic()   # Bad one\nsage: g.start(), g.end()\n(Point in UHP -4.92591958004554 + 7.81075974592370*I,\n Point in UHP -8.44416583993011 + 3.87025183089797*I)\n```\nIn particular, the completed geodesics always have the endpoints in order. I am not sure if this is the best fix, but it does fix that issue.\n\nHowever, I don't yet understand enough of the mathematics to fix the issue with the crossratio matrix.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2028478e2e1ffd9294b7a5b0e96626479ce7f546\"><code>2028478</code></a></td><td><code>Fixing perp bisector when coordinates out of order.</code></td></tr></table>\n",
    "created_at": "2020-07-13T08:18:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473298",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:21" align="right">comment:21</div>

So the issue with the perp bisector comes from this:

```
sage: g = UHP.random_geodesic()   # Good one
sage: g.start(), g.end()
(Point in UHP -9.26728445125634 + 7.15068223909426*I,
 Point in UHP -8.57515638592863 + 0.982992065975858*I)
sage: g = UHP.random_geodesic()   # Bad one
sage: g.start(), g.end()
(Point in UHP -4.92591958004554 + 7.81075974592370*I,
 Point in UHP -8.44416583993011 + 3.87025183089797*I)
```
In particular, the completed geodesics always have the endpoints in order. I am not sure if this is the best fix, but it does fix that issue.

However, I don't yet understand enough of the mathematics to fix the issue with the crossratio matrix.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2028478e2e1ffd9294b7a5b0e96626479ce7f546"><code>2028478</code></a></td><td><code>Fixing perp bisector when coordinates out of order.</code></td></tr></table>




---

archive/issue_events_408989.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2020-07-13T08:18:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408989"
}
```



---

archive/issue_events_408990.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2020-07-13T08:18:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408990"
}
```



---

archive/issue_comments_473299.json:
```json
{
    "body": "Changed commit from **[`8292b04`](https://github.com/sagemath/sagetrac-mirror/commit/8292b04158fcc2f3e8fed87670026cbdfb418744)** to **[`2028478`](https://github.com/sagemath/sagetrac-mirror/commit/2028478e2e1ffd9294b7a5b0e96626479ce7f546)**",
    "created_at": "2020-07-13T08:18:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473299",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`8292b04`](https://github.com/sagemath/sagetrac-mirror/commit/8292b04158fcc2f3e8fed87670026cbdfb418744)** to **[`2028478`](https://github.com/sagemath/sagetrac-mirror/commit/2028478e2e1ffd9294b7a5b0e96626479ce7f546)**



---

archive/issue_comments_473300.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,13 @@\n-Some precision claims in doctests in `geometry/hyperbolic_space/hyperbolic_geodesic.py` only hold in lucky cases.\n+Fuzzing doctests for `geometry/hyperbolic_space/hyperbolic_geodesic.py` revealed a sign error.\n \n-Likewise, an equality in `geometry/hyperbolic_space/hyperbolic_point.py` doesn't always hold.\n-\n-We add tolerance so those tests pass usually.\n-\n-Follow up:\n-- #29939 fix the precision problem\n+```\n+UHP = HyperbolicPlane().UHP()\n+sage: g = UHP.random_geodesic()   # Good one\n+sage: g.start(), g.end()\n+(Point in UHP -9.26728445125634 + 7.15068223909426*I,\n+ Point in UHP -8.57515638592863 + 0.982992065975858*I)\n+sage: g = UHP.random_geodesic()   # Bad one\n+sage: g.start(), g.end()\n+(Point in UHP -4.92591958004554 + 7.81075974592370*I,\n+ Point in UHP -8.44416583993011 + 3.87025183089797*I)\n+```\n``````\n",
    "created_at": "2020-07-13T09:12:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473300",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,13 @@
-Some precision claims in doctests in `geometry/hyperbolic_space/hyperbolic_geodesic.py` only hold in lucky cases.
+Fuzzing doctests for `geometry/hyperbolic_space/hyperbolic_geodesic.py` revealed a sign error.
 
-Likewise, an equality in `geometry/hyperbolic_space/hyperbolic_point.py` doesn't always hold.
-
-We add tolerance so those tests pass usually.
-
-Follow up:
-- #29939 fix the precision problem
+```
+UHP = HyperbolicPlane().UHP()
+sage: g = UHP.random_geodesic()   # Good one
+sage: g.start(), g.end()
+(Point in UHP -9.26728445125634 + 7.15068223909426*I,
+ Point in UHP -8.57515638592863 + 0.982992065975858*I)
+sage: g = UHP.random_geodesic()   # Bad one
+sage: g.start(), g.end()
+(Point in UHP -4.92591958004554 + 7.81075974592370*I,
+ Point in UHP -8.44416583993011 + 3.87025183089797*I)
+```
``````




---

archive/issue_comments_473301.json:
```json
{
    "body": "Changed keywords from **hyperbolic geodesic, hyperbolic point** to **hyperbolic geodesic**",
    "created_at": "2020-07-13T09:12:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473301",
    "user": "https://github.com/kliem"
}
```

Changed keywords from **hyperbolic geodesic, hyperbolic point** to **hyperbolic geodesic**



---

archive/issue_comments_473302.json:
```json
{
    "body": "Changed author from **Jonathan Kliem** to none",
    "created_at": "2020-07-13T09:12:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473302",
    "user": "https://github.com/kliem"
}
```

Changed author from **Jonathan Kliem** to none



---

archive/issue_events_408991.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-13T09:12:28Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "title_is": "Sign error in hyperbolic geodesic",
    "title_was": "Fix wrong precision claims in geometry doctests",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408991"
}
```



---

archive/issue_comments_473303.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI would rewrite the test along these lines:\n\n```\n+        Check the result is independent of the order::\n+\n+            sage: def works_both_ways(a, b):\n+            ....:     UHP = HyperbolicPlane().UHP()\n+            ....:     g = UHP.get_geodesic(a, b)\n+            ....:     h = UHP.get_geodesic(b, a)\n+            ....:     p = g.perpendicular_bisector()\n+            ....:     q = h.perpendicular_bisector()\n+            ....:     c = lambda x: x.coordinates()\n+            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)\n+            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)\n+            sage: works_both_ways(1 + I, 2 + 0.5*I)\n+            sage: works_both_ways(2 + I, 2 + 0.5*I)\n```",
    "created_at": "2020-07-13T09:54:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473303",
    "user": "https://github.com/slel"
}
```

<div id="comment:23" align="right">comment:23</div>

I would rewrite the test along these lines:

```
+        Check the result is independent of the order::
+
+            sage: def works_both_ways(a, b):
+            ....:     UHP = HyperbolicPlane().UHP()
+            ....:     g = UHP.get_geodesic(a, b)
+            ....:     h = UHP.get_geodesic(b, a)
+            ....:     p = g.perpendicular_bisector()
+            ....:     q = h.perpendicular_bisector()
+            ....:     c = lambda x: x.coordinates()
+            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)
+            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)
+            sage: works_both_ways(1 + I, 2 + 0.5*I)
+            sage: works_both_ways(2 + I, 2 + 0.5*I)
```



---

archive/issue_comments_473304.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThat is a better way to do the test. I will change that next chance I get (although it might not be until the end of the week).",
    "created_at": "2020-07-13T10:04:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473304",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:24" align="right">comment:24</div>

That is a better way to do the test. I will change that next chance I get (although it might not be until the end of the week).



---

archive/issue_comments_473305.json:
```json
{
    "body": "Reviewer: **Samuel Leli\u00e8vre**",
    "created_at": "2020-07-13T10:35:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473305",
    "user": "https://github.com/slel"
}
```

Reviewer: **Samuel Leli√®vre**



---

archive/issue_comments_473306.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nSome more suggestions.\n\nAdd trac ticket number to test:\n\n```\n+        Check the result is independent of the order (:trac:`29936`)::\n```\n\nRephrase comment?\n\n```\n-        # Since the complete geodesic p1 -> p2 always returns p1 < p2,\n-        #   we need to swap start and end when that happens\n+        # Completed geodesics always have endpoints in order,\n+        # so we swap start and end if needed.\n```\n\nDefine `S` immediately after the swap, since that's where `.complete()` happens.\n\n```\n+        S = self.complete()._to_std_geod(start)\n         d = self._model._dist_points(start, self._end.coordinates()) / 2\n-        S = self.complete()._to_std_geod(start)\n```\n\nAvoid detour to the symbolic ring.\n\n```\n-        s2 = sqrt(2) * 0.5\n+        s2 = sqrt(0.5)\n```",
    "created_at": "2020-07-13T10:35:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473306",
    "user": "https://github.com/slel"
}
```

<div id="comment:25" align="right">comment:25</div>

Some more suggestions.

Add trac ticket number to test:

```
+        Check the result is independent of the order (:trac:`29936`)::
```

Rephrase comment?

```
-        # Since the complete geodesic p1 -> p2 always returns p1 < p2,
-        #   we need to swap start and end when that happens
+        # Completed geodesics always have endpoints in order,
+        # so we swap start and end if needed.
```

Define `S` immediately after the swap, since that's where `.complete()` happens.

```
+        S = self.complete()._to_std_geod(start)
         d = self._model._dist_points(start, self._end.coordinates()) / 2
-        S = self.complete()._to_std_geod(start)
```

Avoid detour to the symbolic ring.

```
-        s2 = sqrt(2) * 0.5
+        s2 = sqrt(0.5)
```



---

archive/issue_comments_473307.json:
```json
{
    "body": "Author: **Travis Scrimshaw**",
    "created_at": "2020-07-13T10:35:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473307",
    "user": "https://github.com/slel"
}
```

Author: **Travis Scrimshaw**



---

archive/issue_comments_473308.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ad8102e43ff5417ea8be2ce6ced027260829a29e\"><code>ad8102e</code></a></td><td><code>Addressing reviewer comments.</code></td></tr></table>\n",
    "created_at": "2020-07-15T02:33:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473308",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ad8102e43ff5417ea8be2ce6ced027260829a29e"><code>ad8102e</code></a></td><td><code>Addressing reviewer comments.</code></td></tr></table>




---

archive/issue_comments_473309.json:
```json
{
    "body": "Changed commit from **[`2028478`](https://github.com/sagemath/sagetrac-mirror/commit/2028478e2e1ffd9294b7a5b0e96626479ce7f546)** to **[`ad8102e`](https://github.com/sagemath/sagetrac-mirror/commit/ad8102e43ff5417ea8be2ce6ced027260829a29e)**",
    "created_at": "2020-07-15T02:33:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473309",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2028478`](https://github.com/sagemath/sagetrac-mirror/commit/2028478e2e1ffd9294b7a5b0e96626479ce7f546)** to **[`ad8102e`](https://github.com/sagemath/sagetrac-mirror/commit/ad8102e43ff5417ea8be2ce6ced027260829a29e)**



---

archive/issue_comments_473310.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI managed to find a bit of time today. Here are the changes you requested although I used a different version of the comment.\n\nNow to figure out how to fix the issue in [comment:14](#comment%3A14) as some parts of the code that use `moebius_transformation` seem to use that conjugation...",
    "created_at": "2020-07-15T02:39:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473310",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:27" align="right">comment:27</div>

I managed to find a bit of time today. Here are the changes you requested although I used a different version of the comment.

Now to figure out how to fix the issue in [comment:14](#comment%3A14) as some parts of the code that use `moebius_transformation` seem to use that conjugation...



---

archive/issue_events_408992.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408992"
}
```



---

archive/issue_events_408993.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408993"
}
```



---

archive/issue_comments_473311.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473311",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_408994.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408994"
}
```



---

archive/issue_events_408995.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408995"
}
```



---

archive/issue_comments_473312.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThe patchbot's pyflakes plugin complains that `moebius_transform` is undefined.",
    "created_at": "2021-02-26T11:58:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473312",
    "user": "https://github.com/slel"
}
```

<div id="comment:30" align="right">comment:30</div>

The patchbot's pyflakes plugin complains that `moebius_transform` is undefined.



---

archive/issue_comments_473313.json:
```json
{
    "body": "<div id=\"comment:31\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3e6410bfe7722e951b51e498d8e9b01883414db9\"><code>3e6410b</code></a></td><td><code>Fixing perp bisector when coordinates out of order.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0ee202747c7cc2afe01c40a940eef8ad7f1b396\"><code>d0ee202</code></a></td><td><code>Addressing reviewer comments.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ead57105bf098e57e1795391d05a0d86f24520c\"><code>3ead571</code></a></td><td><code>Moebius transformations should not do conjugation.</code></td></tr></table>\n",
    "created_at": "2021-04-23T08:11:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473313",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3e6410bfe7722e951b51e498d8e9b01883414db9"><code>3e6410b</code></a></td><td><code>Fixing perp bisector when coordinates out of order.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0ee202747c7cc2afe01c40a940eef8ad7f1b396"><code>d0ee202</code></a></td><td><code>Addressing reviewer comments.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ead57105bf098e57e1795391d05a0d86f24520c"><code>3ead571</code></a></td><td><code>Moebius transformations should not do conjugation.</code></td></tr></table>




---

archive/issue_comments_473314.json:
```json
{
    "body": "Changed commit from **[`ad8102e`](https://github.com/sagemath/sagetrac-mirror/commit/ad8102e43ff5417ea8be2ce6ced027260829a29e)** to **[`3ead571`](https://github.com/sagemath/sagetrac-mirror/commit/3ead57105bf098e57e1795391d05a0d86f24520c)**",
    "created_at": "2021-04-23T08:11:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473314",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ad8102e`](https://github.com/sagemath/sagetrac-mirror/commit/ad8102e43ff5417ea8be2ce6ced027260829a29e)** to **[`3ead571`](https://github.com/sagemath/sagetrac-mirror/commit/3ead57105bf098e57e1795391d05a0d86f24520c)**



---

archive/issue_comments_473315.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nHere is a rebased branch that fixes the other problem. It is indeed related with the `moebius_tranformation`. That is really meant for isomorphisms of **CP**<sup>1</sup> with maps in PGL(2, **C**), so we should not do complex conjugation. Moreover, we cannot expect the determinant to be a real number unless we choose a good representative, but it is more numerically stable to not do more divisions than necessary. The orientation preserving maps of H<sup>2</sup> in the UHP model are for PGL(2, **R**), so there is a realness assumption of the determinant that we can apply, which means we can compare with `0`. Because of this, I moved the orientation reversing code directly into the model computations. This should now fix all of the issues noted above.",
    "created_at": "2021-04-23T08:16:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473315",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:32" align="right">comment:32</div>

Here is a rebased branch that fixes the other problem. It is indeed related with the `moebius_tranformation`. That is really meant for isomorphisms of **CP**<sup>1</sup> with maps in PGL(2, **C**), so we should not do complex conjugation. Moreover, we cannot expect the determinant to be a real number unless we choose a good representative, but it is more numerically stable to not do more divisions than necessary. The orientation preserving maps of H<sup>2</sup> in the UHP model are for PGL(2, **R**), so there is a realness assumption of the determinant that we can apply, which means we can compare with `0`. Because of this, I moved the orientation reversing code directly into the model computations. This should now fix all of the issues noted above.



---

archive/issue_events_408996.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-04-23T08:16:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408996"
}
```



---

archive/issue_events_408997.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-04-23T08:16:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408997"
}
```



---

archive/issue_comments_473316.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nWe also need the detour to the symbolic ring because sometimes a computation could be wanted in the symbolic ring and it makes checking for valid isometries much more stable.",
    "created_at": "2021-04-23T08:17:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473316",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:33" align="right">comment:33</div>

We also need the detour to the symbolic ring because sometimes a computation could be wanted in the symbolic ring and it makes checking for valid isometries much more stable.



---

archive/issue_comments_473317.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI missed one thing: to check a complex number is small, use its norm:\n\n```diff\n             sage: def works_both_ways(a, b):\n             ....:     UHP = HyperbolicPlane().UHP()\n             ....:     g = UHP.get_geodesic(a, b)\n             ....:     h = UHP.get_geodesic(b, a)\n             ....:     p = g.perpendicular_bisector()\n             ....:     q = h.perpendicular_bisector()\n             ....:     c = lambda x: x.coordinates()\n-            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)\n-            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)\n+            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))\n+            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))\n+            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9))\n```\n\nIndeed, `c(g.intersection(p)[0]) - c(g.midpoint())`\nis a complex number, and:\n\n```\nsage: I < 1e-9\nTrue\n```",
    "created_at": "2021-04-23T09:00:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473317",
    "user": "https://github.com/slel"
}
```

<div id="comment:34" align="right">comment:34</div>

I missed one thing: to check a complex number is small, use its norm:

```diff
             sage: def works_both_ways(a, b):
             ....:     UHP = HyperbolicPlane().UHP()
             ....:     g = UHP.get_geodesic(a, b)
             ....:     h = UHP.get_geodesic(b, a)
             ....:     p = g.perpendicular_bisector()
             ....:     q = h.perpendicular_bisector()
             ....:     c = lambda x: x.coordinates()
-            ....:     assert bool(c(g.intersection(p)[0]) - c(g.midpoint()) < 1e-9)
-            ....:     assert bool(c(h.intersection(q)[0]) - c(g.midpoint()) < 1e-9)
+            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))
+            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))
+            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9))
```

Indeed, `c(g.intersection(p)[0]) - c(g.midpoint())`
is a complex number, and:

```
sage: I < 1e-9
True
```



---

archive/issue_comments_473318.json:
```json
{
    "body": "<div id=\"comment:35\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8f00631626fa636d1979842a1e0b6761f1e2d399\"><code>8f00631</code></a></td><td><code>Better check for trac #29936.</code></td></tr></table>\n",
    "created_at": "2021-04-23T09:05:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473318",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:35"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8f00631626fa636d1979842a1e0b6761f1e2d399"><code>8f00631</code></a></td><td><code>Better check for trac #29936.</code></td></tr></table>




---

archive/issue_comments_473319.json:
```json
{
    "body": "Changed commit from **[`3ead571`](https://github.com/sagemath/sagetrac-mirror/commit/3ead57105bf098e57e1795391d05a0d86f24520c)** to **[`8f00631`](https://github.com/sagemath/sagetrac-mirror/commit/8f00631626fa636d1979842a1e0b6761f1e2d399)**",
    "created_at": "2021-04-23T09:05:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473319",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3ead571`](https://github.com/sagemath/sagetrac-mirror/commit/3ead57105bf098e57e1795391d05a0d86f24520c)** to **[`8f00631`](https://github.com/sagemath/sagetrac-mirror/commit/8f00631626fa636d1979842a1e0b6761f1e2d399)**



---

archive/issue_comments_473320.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nGood point, which uncovered that there is still an error in the second test...",
    "created_at": "2021-04-23T09:12:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473320",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:36" align="right">comment:36</div>

Good point, which uncovered that there is still an error in the second test...



---

archive/issue_events_408998.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-04-23T09:12:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408998"
}
```



---

archive/issue_events_408999.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-04-23T09:12:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-408999"
}
```



---

archive/issue_comments_473321.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nThere is an issue with the midpoints:\n\n```\nsage: UHP = HyperbolicPlane().UHP()\nsage: g = UHP.get_geodesic(2+I,2+0.5*I)\nsage: h = UHP.get_geodesic(2+0.5*I,2+I)\nsage: g.midpoint()\nPoint in UHP 2.00000000000000 + 1.41421356237309*I\nsage: h.midpoint()\nPoint in UHP 2.00000000000000 + 0.707106781186547*I\n```",
    "created_at": "2021-04-23T09:24:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473321",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:37" align="right">comment:37</div>

There is an issue with the midpoints:

```
sage: UHP = HyperbolicPlane().UHP()
sage: g = UHP.get_geodesic(2+I,2+0.5*I)
sage: h = UHP.get_geodesic(2+0.5*I,2+I)
sage: g.midpoint()
Point in UHP 2.00000000000000 + 1.41421356237309*I
sage: h.midpoint()
Point in UHP 2.00000000000000 + 0.707106781186547*I
```



---

archive/issue_comments_473322.json:
```json
{
    "body": "Changed commit from **[`8f00631`](https://github.com/sagemath/sagetrac-mirror/commit/8f00631626fa636d1979842a1e0b6761f1e2d399)** to **[`767a045`](https://github.com/sagemath/sagetrac-mirror/commit/767a045b913ac1858d8785f2f78a3aedcc0718fe)**",
    "created_at": "2021-04-24T05:00:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473322",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8f00631`](https://github.com/sagemath/sagetrac-mirror/commit/8f00631626fa636d1979842a1e0b6761f1e2d399)** to **[`767a045`](https://github.com/sagemath/sagetrac-mirror/commit/767a045b913ac1858d8785f2f78a3aedcc0718fe)**



---

archive/issue_comments_473323.json:
```json
{
    "body": "<div id=\"comment:38\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/767a045b913ac1858d8785f2f78a3aedcc0718fe\"><code>767a045</code></a></td><td><code>Fixing issue with UHP.midpoint() being order dependent.</code></td></tr></table>\n",
    "created_at": "2021-04-24T05:00:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473323",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:38"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/767a045b913ac1858d8785f2f78a3aedcc0718fe"><code>767a045</code></a></td><td><code>Fixing issue with UHP.midpoint() being order dependent.</code></td></tr></table>




---

archive/issue_comments_473324.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nThis now fixes the issue with `midpoint()`, which was the same issue as in the perp bisector.",
    "created_at": "2021-04-24T05:02:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473324",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:39" align="right">comment:39</div>

This now fixes the issue with `midpoint()`, which was the same issue as in the perp bisector.



---

archive/issue_events_409000.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-04-24T05:02:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409000"
}
```



---

archive/issue_events_409001.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-04-24T05:02:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409001"
}
```



---

archive/issue_comments_473325.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nWe test a bisector intersects a segment at its midpoint up to rounding error.\n\nTesting that in terms of relative hyperbolic distances would be cleaner.\n\nProposed replacement for the `works_both_ways` test:\n\n```diff\n-            sage: def works_both_ways(a, b):\n-            ....:     UHP = HyperbolicPlane().UHP()\n-            ....:     g = UHP.get_geodesic(a, b)\n-            ....:     h = UHP.get_geodesic(b, a)\n-            ....:     p = g.perpendicular_bisector()\n-            ....:     q = h.perpendicular_bisector()\n-            ....:     c = lambda x: x.coordinates()\n-            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))\n-            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))\n-            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9)), (error_ab, error_ba)\n-            sage: works_both_ways(1 + I, 2 + 0.5*I)\n-            sage: works_both_ways(2 + I, 2 + 0.5*I)\n+            sage: def bisector_gets_midpoint(a, b):\n+            ....:     UHP = HyperbolicPlane().UHP()\n+            ....:     g = UHP.get_geodesic(a, b)\n+            ....:     p = g.perpendicular_bisector()\n+            ....:     x, m = g.intersection(p)[0]), g.midpoint()\n+            ....:     return bool(x.dist(m) < 1e-9 * a.dist(b))\n+            sage: a, b, c = 1 + I, 2 + I, 2 + 0.5*I\n+            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]\n+            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)\n```\n\nThis also seems more readable to me. Sorry for the slow iterations.",
    "created_at": "2021-04-24T08:53:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473325",
    "user": "https://github.com/slel"
}
```

<div id="comment:40" align="right">comment:40</div>

We test a bisector intersects a segment at its midpoint up to rounding error.

Testing that in terms of relative hyperbolic distances would be cleaner.

Proposed replacement for the `works_both_ways` test:

```diff
-            sage: def works_both_ways(a, b):
-            ....:     UHP = HyperbolicPlane().UHP()
-            ....:     g = UHP.get_geodesic(a, b)
-            ....:     h = UHP.get_geodesic(b, a)
-            ....:     p = g.perpendicular_bisector()
-            ....:     q = h.perpendicular_bisector()
-            ....:     c = lambda x: x.coordinates()
-            ....:     error_ab = norm(c(g.intersection(p)[0]) - c(g.midpoint()))
-            ....:     error_ba = norm(c(h.intersection(q)[0]) - c(h.midpoint()))
-            ....:     assert(bool(error_ab < 1e-9) and bool(error_ba < 1e-9)), (error_ab, error_ba)
-            sage: works_both_ways(1 + I, 2 + 0.5*I)
-            sage: works_both_ways(2 + I, 2 + 0.5*I)
+            sage: def bisector_gets_midpoint(a, b):
+            ....:     UHP = HyperbolicPlane().UHP()
+            ....:     g = UHP.get_geodesic(a, b)
+            ....:     p = g.perpendicular_bisector()
+            ....:     x, m = g.intersection(p)[0]), g.midpoint()
+            ....:     return bool(x.dist(m) < 1e-9 * a.dist(b))
+            sage: a, b, c = 1 + I, 2 + I, 2 + 0.5*I
+            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]
+            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)
```

This also seems more readable to me. Sorry for the slow iterations.



---

archive/issue_comments_473326.json:
```json
{
    "body": "<div id=\"comment:41\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd2d756c73c0f6d2f9677dfec9338752fcaeb6c8\"><code>bd2d756</code></a></td><td><code>Doctest to check the distance in the hyperbolic metric.</code></td></tr></table>\n",
    "created_at": "2021-04-24T09:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473326",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:41"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd2d756c73c0f6d2f9677dfec9338752fcaeb6c8"><code>bd2d756</code></a></td><td><code>Doctest to check the distance in the hyperbolic metric.</code></td></tr></table>




---

archive/issue_comments_473327.json:
```json
{
    "body": "Changed commit from **[`767a045`](https://github.com/sagemath/sagetrac-mirror/commit/767a045b913ac1858d8785f2f78a3aedcc0718fe)** to **[`bd2d756`](https://github.com/sagemath/sagetrac-mirror/commit/bd2d756c73c0f6d2f9677dfec9338752fcaeb6c8)**",
    "created_at": "2021-04-24T09:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473327",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`767a045`](https://github.com/sagemath/sagetrac-mirror/commit/767a045b913ac1858d8785f2f78a3aedcc0718fe)** to **[`bd2d756`](https://github.com/sagemath/sagetrac-mirror/commit/bd2d756c73c0f6d2f9677dfec9338752fcaeb6c8)**



---

archive/issue_comments_473328.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nI agree that that version is more readable. I tweaked the input points to have floating point numbers as otherwise the code wants to do a really horrible (but exact) symbolic computation. I also made the distance check absolute instead of relative since they should be the same point.",
    "created_at": "2021-04-24T09:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473328",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:42" align="right">comment:42</div>

I agree that that version is more readable. I tweaked the input points to have floating point numbers as otherwise the code wants to do a really horrible (but exact) symbolic computation. I also made the distance check absolute instead of relative since they should be the same point.



---

archive/issue_comments_473329.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nThe gap between iterations is no problem. Thank you for taking the time to review this.",
    "created_at": "2021-04-24T09:22:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473329",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:43" align="right">comment:43</div>

The gap between iterations is no problem. Thank you for taking the time to review this.



---

archive/issue_comments_473330.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@tscrim](#comment%3A42):\n> made the distance check absolute instead of relative\n> since they should be the same point.\n\nFor short segments (say of length `1e-12`) we might\nprefer relative, but the current doctest uses segments\nof length on the order of one anyway, so I don't mind.\n\nI agree with you about doctesting with floating-point values.\nHow about this then:\n\n```diff\n-            sage: a, b, c = 1.0 + I, 2.0 + I, 2.0 + 0.5*I\n-            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]\n-            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)\n+            sage: c, d, e = CC(1, 1), CC(2, 1), CC(2, 0.5)\n+            sage: pairs = [(c, d), (d, c), (c, e), (e, c), (d, e), (e, d)]\n+            sage: all(bisector_gets_midpoint(a, b) for a, b in pairs)\n```\n\nIn `hyperbolic_isometry.py`, pyflakes complains:\n`'sage.rings.all.RR' imported but unused`.",
    "created_at": "2021-04-24T10:12:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473330",
    "user": "https://github.com/slel"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@tscrim](#comment%3A42):
> made the distance check absolute instead of relative
> since they should be the same point.

For short segments (say of length `1e-12`) we might
prefer relative, but the current doctest uses segments
of length on the order of one anyway, so I don't mind.

I agree with you about doctesting with floating-point values.
How about this then:

```diff
-            sage: a, b, c = 1.0 + I, 2.0 + I, 2.0 + 0.5*I
-            sage: pairs = [(a, b), (b, a), (a, c), (c, a), (b, c), (c, b)]
-            sage: all(bisector_gets_midpoint(x, y) for x, y in pairs)
+            sage: c, d, e = CC(1, 1), CC(2, 1), CC(2, 0.5)
+            sage: pairs = [(c, d), (d, c), (c, e), (e, c), (d, e), (e, d)]
+            sage: all(bisector_gets_midpoint(a, b) for a, b in pairs)
```

In `hyperbolic_isometry.py`, pyflakes complains:
`'sage.rings.all.RR' imported but unused`.



---

archive/issue_events_409002.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-04-24T10:31:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "title_is": "Fix moebius_transform, midpoint and perpendicular_bisector",
    "title_was": "Sign error in hyperbolic geodesic",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409002"
}
```



---

archive/issue_comments_473331.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n-Fuzzing doctests for `geometry/hyperbolic_space/hyperbolic_geodesic.py` revealed a sign error.\n+We fix several related issues in hyperbolic geometry:\n+\n+- `moebius_transform` wrong in the orientation-reversing\n+  (negative determinant) case\n+- `midpoint` and `perpendicular_bisector`\n+  gave different results for (a, b) and (b, a)\n+\n+Fuzzing `geometry/hyperbolic_space/hyperbolic_geodesic.py`\n+doctests uncovered these issues. See #29935, #29962, #29963.\n+\n \n ```\n UHP = HyperbolicPlane().UHP()\n@@ -11,3 +20,4 @@\n (Point in UHP -4.92591958004554 + 7.81075974592370*I,\n  Point in UHP -8.44416583993011 + 3.87025183089797*I)\n ```\n+\n``````\n",
    "created_at": "2021-04-24T10:31:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473331",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
-Fuzzing doctests for `geometry/hyperbolic_space/hyperbolic_geodesic.py` revealed a sign error.
+We fix several related issues in hyperbolic geometry:
+
+- `moebius_transform` wrong in the orientation-reversing
+  (negative determinant) case
+- `midpoint` and `perpendicular_bisector`
+  gave different results for (a, b) and (b, a)
+
+Fuzzing `geometry/hyperbolic_space/hyperbolic_geodesic.py`
+doctests uncovered these issues. See #29935, #29962, #29963.
+
 
 ```
 UHP = HyperbolicPlane().UHP()
@@ -11,3 +20,4 @@
 (Point in UHP -4.92591958004554 + 7.81075974592370*I,
  Point in UHP -8.44416583993011 + 3.87025183089797*I)
 ```
+
``````




---

archive/issue_comments_473332.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nI will make that change tomorrow.\n\nAh. right, I forgot to take care of that pyflakes issue...",
    "created_at": "2021-04-25T03:49:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473332",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:46" align="right">comment:46</div>

I will make that change tomorrow.

Ah. right, I forgot to take care of that pyflakes issue...



---

archive/issue_comments_473333.json:
```json
{
    "body": "Changed commit from **[`bd2d756`](https://github.com/sagemath/sagetrac-mirror/commit/bd2d756c73c0f6d2f9677dfec9338752fcaeb6c8)** to **[`234604b`](https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2)**",
    "created_at": "2021-04-25T23:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473333",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`bd2d756`](https://github.com/sagemath/sagetrac-mirror/commit/bd2d756c73c0f6d2f9677dfec9338752fcaeb6c8)** to **[`234604b`](https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2)**



---

archive/issue_comments_473334.json:
```json
{
    "body": "<div id=\"comment:47\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2\"><code>234604b</code></a></td><td><code>Last details of #29936.</code></td></tr></table>\n",
    "created_at": "2021-04-25T23:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473334",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:47"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2"><code>234604b</code></a></td><td><code>Last details of #29936.</code></td></tr></table>




---

archive/issue_comments_473335.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nFixed.",
    "created_at": "2021-04-25T23:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473335",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:48" align="right">comment:48</div>

Fixed.



---

archive/issue_comments_473336.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nGreen patchbot.",
    "created_at": "2021-05-05T03:40:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473336",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:49" align="right">comment:49</div>

Green patchbot.



---

archive/issue_events_409003.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-05-10T22:51:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409003"
}
```



---

archive/issue_events_409004.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-05-10T22:51:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409004"
}
```



---

archive/issue_comments_473337.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nGood to see these issues solved.",
    "created_at": "2021-05-10T22:51:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473337",
    "user": "https://github.com/slel"
}
```

<div id="comment:50" align="right">comment:50</div>

Good to see these issues solved.



---

archive/issue_comments_473338.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nThank you for the review.\n\nAt some point, when I have more free time, I want to implement higher dimensional hyperbolic space. Unfortunately other directly-applicable-to-my-research-code (and paper writing) takes priority...",
    "created_at": "2021-05-10T22:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473338",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:51" align="right">comment:51</div>

Thank you for the review.

At some point, when I have more free time, I want to implement higher dimensional hyperbolic space. Unfortunately other directly-applicable-to-my-research-code (and paper writing) takes priority...



---

archive/issue_events_409005.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:29:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409005"
}
```



---

archive/issue_events_409006.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "0d8373f53456f475b6b64ce9b565263202febb12",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-05-27T20:29:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29936#event-409006"
}
```



---

archive/issue_comments_473339.json:
```json
{
    "body": "Changed branch from **[public/geometry/fix_hyperbolic_plane-29936](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/fix_hyperbolic_plane-29936)** to **[`234604b`](https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2)**",
    "created_at": "2021-05-27T20:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29936",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29936#issuecomment-473339",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/geometry/fix_hyperbolic_plane-29936](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/fix_hyperbolic_plane-29936)** to **[`234604b`](https://github.com/sagemath/sagetrac-mirror/commit/234604b9faddb714d10b588325f258a0241304e2)**
