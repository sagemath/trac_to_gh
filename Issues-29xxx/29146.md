# Issue 29146: Meta-ticket: Refactor and improve system package related scripts, tox.ini, build/bin/write_dockerfile.sh

archive/issues_028909.json:
```json
{
    "body": "CC:  @embray @vbraun @dimpase @jhpalmieri @sheerluck @slel @tobiasdiez @seblabbe\n\nImprovements to low-level system packages scripts:\n- #30861, #30865, #30947, #30951, #30968: Refactor system package code in `tox.ini`, `build/bin/write_dockerfile.sh` by extending and using `sage_bootstrap`\n- #33873: Extend `build/bin/sage-print-system-package-command` so that it can provide all distribution-specific commands such as `apt-get install` for `build/bin/write_dockerfile.sh` \n- #29041 sage_bootstrap: Add command \"sage -package list --output={install-requires,requirements,pipfile,debian,....}\"\n- #33860 sage-package: Add commands \"dependencies\", \"trees\"\n\nImprovements to the system package database:\n- #29124 Add script packages build/pkgs/_prereq, build/pkgs/_toolchain, build/pkgs/_bootstrap\n- define shell quoting in files like `debian.txt`, handle options correctly when installing packages one by one, fix up passing installation options when `IGNORE_MISSING_PACKAGES=yes`\n\nImprovements to `tox docker`:\n- #29536 Make docker images from [GitHub](GitHub) CI workflow and regular Sage Docker images interoperable\n- optionally create a script for `docker run` instead of a `Dockerfile` (this gives more flexibility for multiarch - see #29143)\n- cache Docker images with system packages installed ... https://github.com/marketplace/actions/build-docker-images-using-cache\n- move log extraction code from tox.yml to tox.ini (#29530 did some preparation already)\n- system package installation should retry a few times when installation errors because of network errors occur. In particular for docker because an incomplete step will be cached\n- Make obtaining image from container of failing builds more robust: Use LABEL commands in dockerfiles, use `docker ps --filter label=.... ` to look up the container (https://docs.docker.com/engine/reference/commandline/ps/)\n- setenv/passenv SAGE_SERVER\n- Remove `TARGETS_PRE`/`TARGETS` distinction: Instead leave a stamp file and exit from make with an error to trigger the ADD of src/; for example, add `sagelib` dependency on `$(SAGE_SRC)/sage`, and add the rule to Makefile:\n\n```\n$(SAGE_SRC)/sage:\n\ttouch .need_src; exit 1\n```\n- use environment variable `MAKE` for docker builds as well, instead of asking users to pass the `USE_MAKEFLAGS` variable\n\nImprovements to `tox local`:\n- #31216: tox.ini (local): Add environment variables to skip system package installs, mechanism for a local interactive shell\n- #31064: `ci-cygwin*.yml`: delegate to `tox`, add more stages, use more specific `SAGE_LOCAL`\n- #21469: Enable VPATH builds (several independent build trees connected to one source tree)\n- #29416: tox.ini: Add local-copy\n- the complicated rule for the commands of `local` consists entirely of workarounds for things that should really be fixed/improved in our `Makefile`s:\n   - #30721: `build/make/Makefile.in`: `base-toolchain` should be a dependency of every non-base, non-toolchain package\n   - #32785: `tox.ini` and `build/bin/write-dockerfile.sh` use better defaults for `SAGE_CHECK_PACKAGES`; this should be moved to `build/make/Makefile.in` (`SAGE_CHECK_PACKAGES_DEFAULT_yes`).\n   - #31535 New make targets \"sagelib-sdist\", \"sage_docbuild-sdist\", ... and \"sagelib-tox-...\", ...\nOther improvements to `tox.ini`:\n- #32764: Make `tox -p auto` and `tox --listenvs` useful again (it does not understand the nested braces)\n- #31574: `tox.ini`, `build/bin/write-dockerfile.sh`: Do not use `make -k` by default\n\nImprovements to auto-generated parts of the manuals:\n- #29558 Autogenerated parts of installation guide\n- #29557 Add script package `_recommended` and generate \"recommended system packages\" info\n\nImprovements for messages at the end of a `./configure` run:\n- #29560 `sage-guess-package-system`: Ignore conda if no environment is activated\n- Perhaps `sage-guess-package-system` should report several package systems such as `conda ubuntu` or `homebrew cpan` when that makes sense\n- #29363 - At the end of `configure`, indicate which optional/experimental packages are configured to be installed\n- #30624: Improve wording and formatting of configure's recommendation message\n- #29372 - At the end of `configure`, show installation hints for disabled optional packages separately\n- Hints after ./configure: maybe sort and remove duplicates (https://groups.google.com/d/msg/sage-devel/EWTVN-Fmc8w/y9933Zo1AQAJ)\n- #32060 `configure`: Change defaults to `--with-system-gcc=force`, `--with-system-python3=force`\n- #29586: Improve configure's recommendations\n- #30863: refine definition of variable SAGE_NEED_SYSTEM_PACKAGES in m4/sage_spkg_collect.m4\n\nTickets regarding `sage_bootstrap`:\n- #20023 `sage_bootstrap`: Remove Python 2.6 support\n- #20104 `sage --package`: Add commands `list :standard:`, `update-latest` (for packages from PyPI), `upload`\n- #29919 Restore \"huge\" package type\n\nSee also: \n- #29060 Meta-ticket: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29146\n\n",
    "created_at": "2020-02-03T14:05:35Z",
    "labels": [
        "component: build",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: Refactor and improve system package related scripts, tox.ini, build/bin/write_dockerfile.sh",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29146",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @embray @vbraun @dimpase @jhpalmieri @sheerluck @slel @tobiasdiez @seblabbe

Improvements to low-level system packages scripts:
- #30861, #30865, #30947, #30951, #30968: Refactor system package code in `tox.ini`, `build/bin/write_dockerfile.sh` by extending and using `sage_bootstrap`
- #33873: Extend `build/bin/sage-print-system-package-command` so that it can provide all distribution-specific commands such as `apt-get install` for `build/bin/write_dockerfile.sh` 
- #29041 sage_bootstrap: Add command "sage -package list --output={install-requires,requirements,pipfile,debian,....}"
- #33860 sage-package: Add commands "dependencies", "trees"

Improvements to the system package database:
- #29124 Add script packages build/pkgs/_prereq, build/pkgs/_toolchain, build/pkgs/_bootstrap
- define shell quoting in files like `debian.txt`, handle options correctly when installing packages one by one, fix up passing installation options when `IGNORE_MISSING_PACKAGES=yes`

Improvements to `tox docker`:
- #29536 Make docker images from [GitHub](GitHub) CI workflow and regular Sage Docker images interoperable
- optionally create a script for `docker run` instead of a `Dockerfile` (this gives more flexibility for multiarch - see #29143)
- cache Docker images with system packages installed ... https://github.com/marketplace/actions/build-docker-images-using-cache
- move log extraction code from tox.yml to tox.ini (#29530 did some preparation already)
- system package installation should retry a few times when installation errors because of network errors occur. In particular for docker because an incomplete step will be cached
- Make obtaining image from container of failing builds more robust: Use LABEL commands in dockerfiles, use `docker ps --filter label=.... ` to look up the container (https://docs.docker.com/engine/reference/commandline/ps/)
- setenv/passenv SAGE_SERVER
- Remove `TARGETS_PRE`/`TARGETS` distinction: Instead leave a stamp file and exit from make with an error to trigger the ADD of src/; for example, add `sagelib` dependency on `$(SAGE_SRC)/sage`, and add the rule to Makefile:

```
$(SAGE_SRC)/sage:
	touch .need_src; exit 1
```
- use environment variable `MAKE` for docker builds as well, instead of asking users to pass the `USE_MAKEFLAGS` variable

Improvements to `tox local`:
- #31216: tox.ini (local): Add environment variables to skip system package installs, mechanism for a local interactive shell
- #31064: `ci-cygwin*.yml`: delegate to `tox`, add more stages, use more specific `SAGE_LOCAL`
- #21469: Enable VPATH builds (several independent build trees connected to one source tree)
- #29416: tox.ini: Add local-copy
- the complicated rule for the commands of `local` consists entirely of workarounds for things that should really be fixed/improved in our `Makefile`s:
   - #30721: `build/make/Makefile.in`: `base-toolchain` should be a dependency of every non-base, non-toolchain package
   - #32785: `tox.ini` and `build/bin/write-dockerfile.sh` use better defaults for `SAGE_CHECK_PACKAGES`; this should be moved to `build/make/Makefile.in` (`SAGE_CHECK_PACKAGES_DEFAULT_yes`).
   - #31535 New make targets "sagelib-sdist", "sage_docbuild-sdist", ... and "sagelib-tox-...", ...
Other improvements to `tox.ini`:
- #32764: Make `tox -p auto` and `tox --listenvs` useful again (it does not understand the nested braces)
- #31574: `tox.ini`, `build/bin/write-dockerfile.sh`: Do not use `make -k` by default

Improvements to auto-generated parts of the manuals:
- #29558 Autogenerated parts of installation guide
- #29557 Add script package `_recommended` and generate "recommended system packages" info

Improvements for messages at the end of a `./configure` run:
- #29560 `sage-guess-package-system`: Ignore conda if no environment is activated
- Perhaps `sage-guess-package-system` should report several package systems such as `conda ubuntu` or `homebrew cpan` when that makes sense
- #29363 - At the end of `configure`, indicate which optional/experimental packages are configured to be installed
- #30624: Improve wording and formatting of configure's recommendation message
- #29372 - At the end of `configure`, show installation hints for disabled optional packages separately
- Hints after ./configure: maybe sort and remove duplicates (https://groups.google.com/d/msg/sage-devel/EWTVN-Fmc8w/y9933Zo1AQAJ)
- #32060 `configure`: Change defaults to `--with-system-gcc=force`, `--with-system-python3=force`
- #29586: Improve configure's recommendations
- #30863: refine definition of variable SAGE_NEED_SYSTEM_PACKAGES in m4/sage_spkg_collect.m4

Tickets regarding `sage_bootstrap`:
- #20023 `sage_bootstrap`: Remove Python 2.6 support
- #20104 `sage --package`: Add commands `list :standard:`, `update-latest` (for packages from PyPI), `upload`
- #29919 Restore "huge" package type

See also: 
- #29060 Meta-ticket: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages


Issue created by migration from https://trac.sagemath.org/ticket/29146





---

archive/issue_events_073947.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-09T23:16:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73947"
}
```



---

archive/issue_comments_408795.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-15T19:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29146#issuecomment-408795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_073948.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T17:11:30Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73948"
}
```



---

archive/issue_events_073949.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T17:11:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73949"
}
```



---

archive/issue_comments_408796.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29146#issuecomment-408796",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_073950.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73950"
}
```



---

archive/issue_events_073951.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73951"
}
```



---

archive/issue_events_073952.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73952"
}
```



---

archive/issue_events_073953.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73953"
}
```



---

archive/issue_events_073954.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73954"
}
```



---

archive/issue_events_073955.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73955"
}
```



---

archive/issue_events_073956.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73956"
}
```



---

archive/issue_events_073957.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73957"
}
```



---

archive/issue_events_073958.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73958"
}
```



---

archive/issue_events_073959.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29146",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29146#event-73959"
}
```
