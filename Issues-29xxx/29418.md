# Issue 29418: sage-download-file: Fix certificate problems with https downloads from upstream_url when sage-system-python is XCode's python3 on macOS

archive/issues_029181.json:
```json
{
    "assignees": [],
    "body": "#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).\n\nMany upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. \n\nHowever, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\nhttps://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)\n\nWe add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n\nDevelopers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).\n\nWe note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.\n\n---\n\nOther possible workarounds considered:\n- switching from using urllib directly to the requests library\n- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n- using python instead of python3 on macOS as system python\n\nAs of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n\n```\n  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n    self._sslobj.do_handshake()\nOSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n```\n(see https://github.com/mkoeppe/sage/runs/538432620)\n\n\n\nCC:  @vbraun @dimpase @kiwifb @jhpalmieri @videlec @fchapoton @kliem\n\nBranch: **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)**\n\nReviewer: **Jonathan Kliem**\n\nAuthor: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29418_\n\n",
    "closed_at": "2020-04-12T15:34:25Z",
    "created_at": "2020-03-27T17:27:28Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage-download-file: Fix certificate problems with https downloads from upstream_url when sage-system-python is XCode's python3 on macOS",
    "type": "issue",
    "updated_at": "2020-11-23T02:03:56Z",
    "url": "https://github.com/sagemath/sage/issues/29418",
    "user": "https://github.com/mkoeppe"
}
```
#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).

Many upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. 

However, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)

We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).

Developers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).

We note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.

---

Other possible workarounds considered:
- switching from using urllib directly to the requests library
- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
- using python instead of python3 on macOS as system python

As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:

```
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
    self._sslobj.do_handshake()
OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
```
(see https://github.com/mkoeppe/sage/runs/538432620)



CC:  @vbraun @dimpase @kiwifb @jhpalmieri @videlec @fchapoton @kliem

Branch: **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)**

Reviewer: **Jonathan Kliem**

Author: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/29418_





---

archive/issue_events_372913.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-27T17:27:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372913"
}
```



---

archive/issue_events_372914.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-27T17:27:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372914"
}
```



---

archive/issue_events_372915.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-27T17:27:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372915"
}
```



---

archive/issue_events_372916.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-27T17:27:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372916"
}
```



---

archive/issue_comments_465158.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,3 +2,10 @@\n \n As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620\n \n+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n+\n+```\n+  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n+    self._sslobj.do_handshake()\n+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n+```\n``````\n",
    "created_at": "2020-03-27T17:34:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465158",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,3 +2,10 @@
 
 As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620
 
+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
+
+```
+  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
+    self._sslobj.do_handshake()
+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
+```
``````




---

archive/issue_comments_465159.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nhttps://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification",
    "created_at": "2020-03-27T17:35:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465159",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'>Comment 2:</a>
https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification



---

archive/issue_comments_465160.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nhttps://stackoverflow.com/questions/57630314/ssl-certificate-verify-failed-error-with-python3-on-macos-10-15",
    "created_at": "2020-03-27T17:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465160",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'>Comment 3:</a>
https://stackoverflow.com/questions/57630314/ssl-certificate-verify-failed-error-with-python3-on-macos-10-15



---

archive/issue_events_372917.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-27T18:14:48Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "title_is": "sage-download-file: Fix certificate problems with https downloads on macOS python3",
    "title_was": "sage-download-file: Add option --no-check-certificate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372917"
}
```



---

archive/issue_comments_465161.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,13 @@\n This is for downloading from an https `upstream_url` when the host is poorly configured.\n \n-As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620\n+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n+\n+We should work around this by either:\n+- switching from using urllib directly to the requests library\n+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n+- disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification), perhaps triggered by an option --no-check-certificate to sage-download-file\n+- using python instead of python3 on macOS as system python\n \n As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n \n@@ -9,3 +16,6 @@\n     self._sslobj.do_handshake()\n OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n ```\n+(see https://github.com/mkoeppe/sage/runs/538432620)\n+\n+\n``````\n",
    "created_at": "2020-03-27T18:14:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465161",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,13 @@
 This is for downloading from an https `upstream_url` when the host is poorly configured.
 
-As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620
+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
+
+We should work around this by either:
+- switching from using urllib directly to the requests library
+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
+- disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification), perhaps triggered by an option --no-check-certificate to sage-download-file
+- using python instead of python3 on macOS as system python
 
 As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
 
@@ -9,3 +16,6 @@
     self._sslobj.do_handshake()
 OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
 ```
+(see https://github.com/mkoeppe/sage/runs/538432620)
+
+
``````




---

archive/issue_comments_465162.json:
```json
{
    "body": "Branch: **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)**",
    "created_at": "2020-03-28T15:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465162",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)**



---

archive/issue_comments_465163.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nthat's why I suggested not to bother with MacOS/Xcode's python(3).\nCan't one get Python3 from python.org in MacOS by running a script?\n \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6\">bd24641</a></td><td><code>build/bin/sage-download-file: Add option --no-check-certificate</code></td></tr></table>\n",
    "created_at": "2020-03-28T15:42:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465163",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'>Comment 6:</a>
that's why I suggested not to bother with MacOS/Xcode's python(3).
Can't one get Python3 from python.org in MacOS by running a script?
 
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6">bd24641</a></td><td><code>build/bin/sage-download-file: Add option --no-check-certificate</code></td></tr></table>




---

archive/issue_comments_465164.json:
```json
{
    "body": "Commit: **[bd24641](https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6)**",
    "created_at": "2020-03-28T15:42:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465164",
    "user": "https://github.com/dimpase"
}
```

Commit: **[bd24641](https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6)**



---

archive/issue_comments_465165.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,12 +1,15 @@\n-This is for downloading from an https `upstream_url` when the host is poorly configured.\n+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n+\n+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when using `sage -i`. This is for enabling them to download from an https `upstream_url` when the host is poorly configured.\n \n In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n \n-We should work around this by either:\n+---\n+\n+Other possible workarounds considered:\n - switching from using urllib directly to the requests library\n - passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n-- disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification), perhaps triggered by an option --no-check-certificate to sage-download-file\n - using python instead of python3 on macOS as system python\n \n As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n``````\n",
    "created_at": "2020-03-28T15:42:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465165",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,12 +1,15 @@
-This is for downloading from an https `upstream_url` when the host is poorly configured.
+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).
+
+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when using `sage -i`. This is for enabling them to download from an https `upstream_url` when the host is poorly configured.
 
 In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
 https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
 
-We should work around this by either:
+---
+
+Other possible workarounds considered:
 - switching from using urllib directly to the requests library
 - passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
-- disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification), perhaps triggered by an option --no-check-certificate to sage-download-file
 - using python instead of python3 on macOS as system python
 
 As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
``````




---

archive/issue_comments_465166.json:
```json
{
    "body": "Changed commit from **[bd24641](https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6)** to none",
    "created_at": "2020-03-28T15:42:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465166",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[bd24641](https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6)** to none



---

archive/issue_events_372918.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-28T15:42:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372918"
}
```



---

archive/issue_comments_465167.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)** to none",
    "created_at": "2020-03-28T15:42:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465167",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)** to none



---

archive/issue_comments_465168.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2020-03-28T15:42:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465168",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_465169.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nReplying to [@dimpase](#comment%3A6):\n> that's why I suggested not to bother with MacOS/Xcode's python(3).\n> Can't one get Python3 from python.org in MacOS by running a script?\n\nPlease... the idea is to make Sage installation easier, not harder.",
    "created_at": "2020-03-28T15:43:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465169",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'>Comment 8:</a>
Replying to [@dimpase](#comment%3A6):
> that's why I suggested not to bother with MacOS/Xcode's python(3).
> Can't one get Python3 from python.org in MacOS by running a script?

Please... the idea is to make Sage installation easier, not harder.



---

archive/issue_comments_465170.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nOne often runs into these certificate errors also with random Linux images when I run them on Docker. So this workaround is valuable for the automatic testing in any case.",
    "created_at": "2020-03-28T15:45:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465170",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'>Comment 9:</a>
One often runs into these certificate errors also with random Linux images when I run them on Docker. So this workaround is valuable for the automatic testing in any case.



---

archive/issue_comments_465171.json:
```json
{
    "body": "Branch: **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)**",
    "created_at": "2020-03-28T15:46:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465171",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)**



---

archive/issue_comments_465172.json:
```json
{
    "body": "Commit: **[e143939](https://github.com/sagemath/sagetrac-mirror/commit/e143939a2d434211a7607c6f9830496bce34dacd)**",
    "created_at": "2020-03-28T16:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465172",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[e143939](https://github.com/sagemath/sagetrac-mirror/commit/e143939a2d434211a7607c6f9830496bce34dacd)**



---

archive/issue_comments_465173.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nTesting this at https://github.com/mkoeppe/sage/actions/runs/65346154\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6\">bd24641</a></td><td><code>build/bin/sage-download-file: Add option --no-check-certificate</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e143939a2d434211a7607c6f9830496bce34dacd\">e143939</a></td><td><code>build/bin/sage-spkg: Append to SAGE_DOWNLOAD_FILE_OPTIONS instead of overwriting it</code></td></tr></table>\n",
    "created_at": "2020-03-28T16:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465173",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'>Comment 11:</a>
Testing this at https://github.com/mkoeppe/sage/actions/runs/65346154

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd24641560065f4ea4cd78139c11b324b98303b6">bd24641</a></td><td><code>build/bin/sage-download-file: Add option --no-check-certificate</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e143939a2d434211a7607c6f9830496bce34dacd">e143939</a></td><td><code>build/bin/sage-spkg: Append to SAGE_DOWNLOAD_FILE_OPTIONS instead of overwriting it</code></td></tr></table>




---

archive/issue_comments_465174.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@mkoeppe](#comment%3A8):\n> Replying to [@dimpase](#comment%3A6):\n> > that's why I suggested not to bother with MacOS/Xcode's python(3).\n> > Can't one get Python3 from python.org in MacOS by running a script?\n\n> \n> Please... the idea is to make Sage installation easier, not harder.\n\nwell, it seems that using system's python would make a slighly cryptographically\nbroken Sagemath, one way or another.",
    "created_at": "2020-03-28T16:11:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465174",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@mkoeppe](#comment%3A8):
> Replying to [@dimpase](#comment%3A6):
> > that's why I suggested not to bother with MacOS/Xcode's python(3).
> > Can't one get Python3 from python.org in MacOS by running a script?

> 
> Please... the idea is to make Sage installation easier, not harder.

well, it seems that using system's python would make a slighly cryptographically
broken Sagemath, one way or another.



---

archive/issue_comments_465175.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@dimpase](#comment%3A12):\n> well, it seems that using system's python would make a slighly cryptographically\n> broken Sagemath, one way or another.\n\nThat's not a regression from the current status on macOS, see #29291 for example",
    "created_at": "2020-03-28T16:15:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465175",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@dimpase](#comment%3A12):
> well, it seems that using system's python would make a slighly cryptographically
> broken Sagemath, one way or another.

That's not a regression from the current status on macOS, see #29291 for example



---

archive/issue_comments_465176.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nAnd, of course, the present ticket is about `sage-system-python`, which is only used for bootstrapping and build. Unrelated to the use of a system python3 for venv (#27824), which has a completely separate test for what it accepts.",
    "created_at": "2020-03-28T17:24:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465176",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'>Comment 14:</a>
And, of course, the present ticket is about `sage-system-python`, which is only used for bootstrapping and build. Unrelated to the use of a system python3 for venv (#27824), which has a completely separate test for what it accepts.



---

archive/issue_comments_465177.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\noy gevalt, pythons everywhere!",
    "created_at": "2020-03-28T17:29:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465177",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'>Comment 15:</a>
oy gevalt, pythons everywhere!



---

archive/issue_events_372919.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-28T17:31:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "title_is": "sage-download-file: Fix certificate problems with https downloads when sage-system-python is XCode's python3 on macOS",
    "title_was": "sage-download-file: Fix certificate problems with https downloads on macOS python3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372919"
}
```



---

archive/issue_comments_465178.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@dimpase](#comment%3A15):\n> oy gevalt, pythons everywhere!\n\nThis will be addressed in #45678 \"switch Sage from Python to Julia\"",
    "created_at": "2020-03-28T17:33:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465178",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@dimpase](#comment%3A15):
> oy gevalt, pythons everywhere!

This will be addressed in #45678 "switch Sage from Python to Julia"



---

archive/issue_comments_465179.json:
```json
{
    "body": "Changed commit from **[e143939](https://github.com/sagemath/sagetrac-mirror/commit/e143939a2d434211a7607c6f9830496bce34dacd)** to **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)**",
    "created_at": "2020-03-29T14:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465179",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e143939](https://github.com/sagemath/sagetrac-mirror/commit/e143939a2d434211a7607c6f9830496bce34dacd)** to **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)**



---

archive/issue_comments_465180.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cf27321a6b984037f3bc4fb5ccc32c702d5bf2df\">cf27321</a></td><td><code>build/bin/sage-download-file: Add option --no-check-certificate</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde\">90ea00b</a></td><td><code>build/bin/sage-spkg: Append to SAGE_DOWNLOAD_FILE_OPTIONS instead of overwriting it</code></td></tr></table>\n",
    "created_at": "2020-03-29T14:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465180",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:18'>Comment 18:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cf27321a6b984037f3bc4fb5ccc32c702d5bf2df">cf27321</a></td><td><code>build/bin/sage-download-file: Add option --no-check-certificate</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde">90ea00b</a></td><td><code>build/bin/sage-spkg: Append to SAGE_DOWNLOAD_FILE_OPTIONS instead of overwriting it</code></td></tr></table>




---

archive/issue_comments_465181.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nRebased, needs review",
    "created_at": "2020-03-29T14:54:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465181",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'>Comment 19:</a>
Rebased, needs review



---

archive/issue_comments_465182.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nOkay, I'm really confused, or my Sage installation is broken, or both. If I use `./sage -i beautifulsoup4` with a build using the system Python on OS X, it fails, but not because of the issues here. Instead, I see this:\n\n```\nmake[2]: *** No rule to make target `/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/SYSTEM/sage-9.1.beta9/local/var/lib/sage/installed/beautifulsoup4-none', needed by `all-sage'.  Stop.\n```\nIf instead I run `make beautifulsoup4`, it succeeds. When I ran `./sage -i tornado` it didn't seem to even try to install it, but `./sage -f tornado` worked.\n\nSo: why does `./sage -i ...` not work? And what is the point of this ticket: what problem does it solve?",
    "created_at": "2020-04-08T20:32:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465182",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'>Comment 23:</a>
Okay, I'm really confused, or my Sage installation is broken, or both. If I use `./sage -i beautifulsoup4` with a build using the system Python on OS X, it fails, but not because of the issues here. Instead, I see this:

```
make[2]: *** No rule to make target `/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/SYSTEM/sage-9.1.beta9/local/var/lib/sage/installed/beautifulsoup4-none', needed by `all-sage'.  Stop.
```
If instead I run `make beautifulsoup4`, it succeeds. When I ran `./sage -i tornado` it didn't seem to even try to install it, but `./sage -f tornado` worked.

So: why does `./sage -i ...` not work? And what is the point of this ticket: what problem does it solve?



---

archive/issue_comments_465183.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\n`sage -i` was changed in #29113 -- unrelated to the present ticket",
    "created_at": "2020-04-08T21:04:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465183",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'>Comment 24:</a>
`sage -i` was changed in #29113 -- unrelated to the present ticket



---

archive/issue_comments_465184.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nCould you try if the problem goes away if you run `bootstrap`?",
    "created_at": "2020-04-08T21:05:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465184",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'>Comment 25:</a>
Could you try if the problem goes away if you run `bootstrap`?



---

archive/issue_comments_465185.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n \n-Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when using `sage -i`. This is for enabling them to download from an https `upstream_url` when the host is poorly configured.\n+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`). This is for enabling them to download from an https `upstream_url` when the host is poorly configured.\n \n In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n``````\n",
    "created_at": "2020-04-08T21:07:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465185",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).
 
-Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when using `sage -i`. This is for enabling them to download from an https `upstream_url` when the host is poorly configured.
+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`). This is for enabling them to download from an https `upstream_url` when the host is poorly configured.
 
 In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
 https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
``````




---

archive/issue_comments_465186.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nIf I run `bootstrap`, then running `./sage -i benzene` acts like `./sage -i tornado`: it doesn't install. There is a message\n\n```\nrunning ./configure '--enable-beautifulsoup4' '--enable-biopython'  '--enable-benzene'\n```\nand then if I search my terminal window for `benzene`, the only other hit is\n\n```\nbenzene-20130630:                            does not support check for system package; optional, use \"./configure --enable-benzene\" to install\n```\n\nI don't think I tested #29113 well enough when I was reviewing it.",
    "created_at": "2020-04-08T21:33:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465186",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>Comment 27:</a>
If I run `bootstrap`, then running `./sage -i benzene` acts like `./sage -i tornado`: it doesn't install. There is a message

```
running ./configure '--enable-beautifulsoup4' '--enable-biopython'  '--enable-benzene'
```
and then if I search my terminal window for `benzene`, the only other hit is

```
benzene-20130630:                            does not support check for system package; optional, use "./configure --enable-benzene" to install
```

I don't think I tested #29113 well enough when I was reviewing it.



---

archive/issue_comments_465187.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nThis fixes it for me:\n\n```diff\ndiff --git a/src/bin/sage b/src/bin/sage\nindex 10acddcd96..6ccff3789c 100755\n--- a/src/bin/sage\n+++ b/src/bin/sage\n@@ -404,7 +404,7 @@ if [ \"$1\" = '-i' ]; then\n         #   'CC=gcc -Wall' '--enable-e_antic'\n         CONFIG_CMD=\"./configure $(./config.status --config) $ENABLE_ARGS\"\n         echo >&2 \"running $CONFIG_CMD\"\n-        bash -c \"$CONFIG_CMD\" && $MAKE all-build\n+        bash -c \"$CONFIG_CMD\" && $MAKE $PACKAGES\n     else\n         echo \"New packages may have been installed.\"\n         echo \"Re-running configure and make in case any dependent packages need updating.\"\n```\n(or maybe it could be `$MAKE all-build $PACKAGES`?)\n\nBy the way, I still don't understand the goal of this ticket.",
    "created_at": "2020-04-08T21:36:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465187",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'>Comment 28:</a>
This fixes it for me:

```diff
diff --git a/src/bin/sage b/src/bin/sage
index 10acddcd96..6ccff3789c 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -404,7 +404,7 @@ if [ "$1" = '-i' ]; then
         #   'CC=gcc -Wall' '--enable-e_antic'
         CONFIG_CMD="./configure $(./config.status --config) $ENABLE_ARGS"
         echo >&2 "running $CONFIG_CMD"
-        bash -c "$CONFIG_CMD" && $MAKE all-build
+        bash -c "$CONFIG_CMD" && $MAKE $PACKAGES
     else
         echo "New packages may have been installed."
         echo "Re-running configure and make in case any dependent packages need updating."
```
(or maybe it could be `$MAKE all-build $PACKAGES`?)

By the way, I still don't understand the goal of this ticket.



---

archive/issue_comments_465188.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nLet's please take the issues with `sage -i` to the new ticket #29481. Thanks for catching this.",
    "created_at": "2020-04-08T23:24:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465188",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'>Comment 29:</a>
Let's please take the issues with `sage -i` to the new ticket #29481. Thanks for catching this.



---

archive/issue_comments_465189.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,9 +1,15 @@\n+#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).\n+\n+Many upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. \n+\n+However, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)\n+\n We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n \n-Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`). This is for enabling them to download from an https `upstream_url` when the host is poorly configured.\n+Developers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).\n \n-In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n-https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n+We note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.\n \n ---\n \n``````\n",
    "created_at": "2020-04-08T23:36:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465189",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,9 +1,15 @@
+#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).
+
+Many upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. 
+
+However, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)
+
 We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).
 
-Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`). This is for enabling them to download from an https `upstream_url` when the host is poorly configured.
+Developers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).
 
-In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
-https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
+We note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.
 
 ---
 
``````




---

archive/issue_events_372920.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-08T23:36:48Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "title_is": "sage-download-file: Fix certificate problems with https downloads from upstream_url when sage-system-python is XCode's python3 on macOS",
    "title_was": "sage-download-file: Fix certificate problems with https downloads when sage-system-python is XCode's python3 on macOS",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372920"
}
```



---

archive/issue_comments_465190.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nReplying to [@jhpalmieri](#comment%3A28):\n> By the way, I still don't understand the goal of this ticket.\n\nReworked the ticket description, please take a look",
    "created_at": "2020-04-08T23:37:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465190",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'>Comment 31:</a>
Replying to [@jhpalmieri](#comment%3A28):
> By the way, I still don't understand the goal of this ticket.

Reworked the ticket description, please take a look



---

archive/issue_comments_465191.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nReplying to [@mkoeppe](#comment%3A31):\n> Replying to [@jhpalmieri](#comment%3A28):\n> > By the way, I still don't understand the goal of this ticket.\n\n> \n> Reworked the ticket description, please take a look\n\nSorry, I wasn't clear enough. What system configuration and commands lead to the problem in the description? I can't reproduce the problem, so I can't tell if the solution here works.",
    "created_at": "2020-04-09T03:08:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465191",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:32'>Comment 32:</a>
Replying to [@mkoeppe](#comment%3A31):
> Replying to [@jhpalmieri](#comment%3A28):
> > By the way, I still don't understand the goal of this ticket.

> 
> Reworked the ticket description, please take a look

Sorry, I wasn't clear enough. What system configuration and commands lead to the problem in the description? I can't reproduce the problem, so I can't tell if the solution here works.



---

archive/issue_comments_465192.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nFrom what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.\n\nDo you have successfully tested this ticket?\n\nDo I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)\n\nAlso this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?",
    "created_at": "2020-04-09T08:00:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465192",
    "user": "https://github.com/kliem"
}
```

<a id='comment:33'>Comment 33:</a>
From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.

Do you have successfully tested this ticket?

Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)

Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?



---

archive/issue_comments_465193.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nReplying to [@kliem](#comment%3A33):\n> From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.\n\nThat's a correct description for macOS. But the problem also appears on Linux distributions if one does not install ca-certificates, or those are outdated.\n\n> Do you have successfully tested this ticket?\n\nYes, I have been using this as part of #29417 since end of March. \n\n> Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)\n\nThat's correct for the macOS tests using `tox local`. For the Linux tests with `tox docker` note that `/upstream` is in `.gitignore` (therefore in `.dockerignore`) and is therefore not provided to the container.\n\n> Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?\n\nThat's right, normal users would not use the `upstream_url` at all; it is a feature for developers only.",
    "created_at": "2020-04-09T15:37:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465193",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'>Comment 34:</a>
Replying to [@kliem](#comment%3A33):
> From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.

That's a correct description for macOS. But the problem also appears on Linux distributions if one does not install ca-certificates, or those are outdated.

> Do you have successfully tested this ticket?

Yes, I have been using this as part of #29417 since end of March. 

> Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)

That's correct for the macOS tests using `tox local`. For the Linux tests with `tox docker` note that `/upstream` is in `.gitignore` (therefore in `.dockerignore`) and is therefore not provided to the container.

> Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?

That's right, normal users would not use the `upstream_url` at all; it is a feature for developers only.



---

archive/issue_comments_465194.json:
```json
{
    "body": "Reviewer: **Jonathan Kliem**",
    "created_at": "2020-04-09T15:46:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465194",
    "user": "https://github.com/kliem"
}
```

Reviewer: **Jonathan Kliem**



---

archive/issue_events_372921.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-09T15:46:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372921"
}
```



---

archive/issue_events_372922.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-09T15:46:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372922"
}
```



---

archive/issue_comments_465195.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nLGTM.\n\nBtw, I have been using this ticket to test my tickets, e.g. here: https://github.com/kliem/sage-test-27122/actions/runs/72102779",
    "created_at": "2020-04-09T15:46:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465195",
    "user": "https://github.com/kliem"
}
```

<a id='comment:35'>Comment 35:</a>
LGTM.

Btw, I have been using this ticket to test my tickets, e.g. here: https://github.com/kliem/sage-test-27122/actions/runs/72102779



---

archive/issue_comments_465196.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nThank you!",
    "created_at": "2020-04-09T15:47:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465196",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'>Comment 36:</a>
Thank you!



---

archive/issue_events_372923.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-12T15:34:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372923"
}
```



---

archive/issue_events_372924.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "e8117be334277a61a3d926d7cb0bdc353ce35693",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-04-12T15:34:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29418#event-372924"
}
```



---

archive/issue_comments_465197.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)** to **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)**",
    "created_at": "2020-04-12T15:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465197",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_download_file__fix_certificate_problems_with_https_downloads_on_macos_python3)** to **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)**



---

archive/issue_comments_465198.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nFollow up: #30950",
    "created_at": "2020-11-23T02:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465198",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'>Comment 38:</a>
Follow up: #30950



---

archive/issue_comments_465199.json:
```json
{
    "body": "Changed commit from **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)** to none",
    "created_at": "2020-11-23T02:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29418#issuecomment-465199",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[90ea00b](https://github.com/sagemath/sagetrac-mirror/commit/90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde)** to none
