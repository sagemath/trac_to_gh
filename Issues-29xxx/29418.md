# Issue 29418: sage-download-file: Fix certificate problems with https downloads from upstream_url when sage-system-python is XCode's python3 on macOS

archive/issues_029181.json:
```json
{
    "body": "#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).\n\nMany upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. \n\nHowever, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\nhttps://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)\n\nWe add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n\nDevelopers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).\n\nWe note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.\n\n---\n\nOther possible workarounds considered:\n- switching from using urllib directly to the requests library\n- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n- using python instead of python3 on macOS as system python\n\nAs of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n\n```\n  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n    self._sslobj.do_handshake()\nOSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n```\n(see https://github.com/mkoeppe/sage/runs/538432620)\n\n\n\nCC:  @vbraun @dimpase @kiwifb @jhpalmieri @videlec @fchapoton @kliem\n\nReviewer: Jonathan Kliem\n\nAuthor: Matthias Koeppe\n\nBranch: 90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29418\n\n",
    "closed_at": "2020-04-12T15:34:25Z",
    "created_at": "2020-03-27T17:27:28Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "sage-download-file: Fix certificate problems with https downloads from upstream_url when sage-system-python is XCode's python3 on macOS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29418",
    "user": "https://github.com/mkoeppe"
}
```
#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).

Many upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. 

However, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)

We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).

Developers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).

We note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.

---

Other possible workarounds considered:
- switching from using urllib directly to the requests library
- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
- using python instead of python3 on macOS as system python

As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:

```
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
    self._sslobj.do_handshake()
OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
```
(see https://github.com/mkoeppe/sage/runs/538432620)



CC:  @vbraun @dimpase @kiwifb @jhpalmieri @videlec @fchapoton @kliem

Reviewer: Jonathan Kliem

Author: Matthias Koeppe

Branch: 90ea00b82c4d1ade6ba5c9bbecbc6388dbedefde

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29418





---

archive/issue_comments_440261.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,14 @@\n This is for downloading from an https `upstream_url` when the host is poorly configured.\n \n As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620\n+\n+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n+\n+```\n+  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n+    self._sslobj.do_handshake()\n+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n+```\n \n Comment: 1\n \n```\n",
    "created_at": "2020-03-27T17:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440261",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,14 @@
 This is for downloading from an https `upstream_url` when the host is poorly configured.
 
 As seen with `local-homebrew-macos-minimal` in https://github.com/mkoeppe/sage/runs/538432620
+
+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
+
+```
+  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
+    self._sslobj.do_handshake()
+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
+```
 
 Comment: 1
 
```




---

archive/issue_comments_440262.json:
```json
{
    "body": "<a id='comment:2'></a>https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification",
    "created_at": "2020-03-27T17:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440262",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification



---

archive/issue_comments_440263.json:
```json
{
    "body": "<a id='comment:3'></a>https://stackoverflow.com/questions/57630314/ssl-certificate-verify-failed-error-with-python3-on-macos-10-15",
    "created_at": "2020-03-27T17:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440263",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>https://stackoverflow.com/questions/57630314/ssl-certificate-verify-failed-error-with-python3-on-macos-10-15



---

archive/issue_comments_440264.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+This is for downloading from an https `upstream_url` when the host is poorly configured.\n+\n+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n+\n+We should work around this by either:\n+- switching from using urllib directly to the requests library\n+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n+- disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification), perhaps triggered by an option --no-check-certificate to sage-download-file\n+- using python instead of python3 on macOS as system python\n+\n+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n+\n+```\n+  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n+    self._sslobj.do_handshake()\n+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n+```\n+(see https://github.com/mkoeppe/sage/runs/538432620)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-03-27T18:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440264",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,23 @@
+This is for downloading from an https `upstream_url` when the host is poorly configured.
+
+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
+
+We should work around this by either:
+- switching from using urllib directly to the requests library
+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
+- disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification), perhaps triggered by an option --no-check-certificate to sage-download-file
+- using python instead of python3 on macOS as system python
+
+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
+
+```
+  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
+    self._sslobj.do_handshake()
+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
+```
+(see https://github.com/mkoeppe/sage/runs/538432620)
+
 
 
 Comment: 1
```




---

archive/issue_comments_440265.json:
```json
{
    "body": "<a id='comment:6'></a>that's why I suggested not to bother with MacOS/Xcode's python(3).\nCan't one get Python3 from python.org in MacOS by running a script?\n \n---\nNew commits:",
    "created_at": "2020-03-28T15:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440265",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>that's why I suggested not to bother with MacOS/Xcode's python(3).
Can't one get Python3 from python.org in MacOS by running a script?
 
---
New commits:



---

archive/issue_comments_440266.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,26 @@\n+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n+\n+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when using `sage -i`. This is for enabling them to download from an https `upstream_url` when the host is poorly configured.\n+\n+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n+\n+---\n+\n+Other possible workarounds considered:\n+- switching from using urllib directly to the requests library\n+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n+- using python instead of python3 on macOS as system python\n+\n+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n+\n+```\n+  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n+    self._sslobj.do_handshake()\n+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n+```\n+(see https://github.com/mkoeppe/sage/runs/538432620)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-03-28T15:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440266",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,26 @@
+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).
+
+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when using `sage -i`. This is for enabling them to download from an https `upstream_url` when the host is poorly configured.
+
+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
+
+---
+
+Other possible workarounds considered:
+- switching from using urllib directly to the requests library
+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
+- using python instead of python3 on macOS as system python
+
+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
+
+```
+  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
+    self._sslobj.do_handshake()
+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
+```
+(see https://github.com/mkoeppe/sage/runs/538432620)
+
 
 
 Comment: 1
```




---

archive/issue_comments_440267.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-28T15:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440267",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_440268.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 dimpase]:\n> that's why I suggested not to bother with MacOS/Xcode's python(3).\n> Can't one get Python3 from python.org in MacOS by running a script?\n\n\nPlease... the idea is to make Sage installation easier, not harder.",
    "created_at": "2020-03-28T15:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440268",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Replying to [comment:6 dimpase]:
> that's why I suggested not to bother with MacOS/Xcode's python(3).
> Can't one get Python3 from python.org in MacOS by running a script?


Please... the idea is to make Sage installation easier, not harder.



---

archive/issue_comments_440269.json:
```json
{
    "body": "<a id='comment:9'></a>One often runs into these certificate errors also with random Linux images when I run them on Docker. So this workaround is valuable for the automatic testing in any case.",
    "created_at": "2020-03-28T15:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440269",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>One often runs into these certificate errors also with random Linux images when I run them on Docker. So this workaround is valuable for the automatic testing in any case.



---

archive/issue_comments_440270.json:
```json
{
    "body": "<a id='comment:11'></a>Testing this at https://github.com/mkoeppe/sage/actions/runs/65346154\n\n---\nNew commits:",
    "created_at": "2020-03-28T16:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Testing this at https://github.com/mkoeppe/sage/actions/runs/65346154

---
New commits:



---

archive/issue_comments_440271.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:8 mkoeppe]:\n> Replying to [comment:6 dimpase]:\n> > that's why I suggested not to bother with MacOS/Xcode's python(3).\n> > Can't one get Python3 from python.org in MacOS by running a script?\n\n> \n> Please... the idea is to make Sage installation easier, not harder.\n\n\nwell, it seems that using system's python would make a slighly cryptographically\nbroken Sagemath, one way or another.",
    "created_at": "2020-03-28T16:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440271",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>Replying to [comment:8 mkoeppe]:
> Replying to [comment:6 dimpase]:
> > that's why I suggested not to bother with MacOS/Xcode's python(3).
> > Can't one get Python3 from python.org in MacOS by running a script?

> 
> Please... the idea is to make Sage installation easier, not harder.


well, it seems that using system's python would make a slighly cryptographically
broken Sagemath, one way or another.



---

archive/issue_comments_440272.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 dimpase]:\n> well, it seems that using system's python would make a slighly cryptographically\n> broken Sagemath, one way or another.\n\n\nThat's not a regression from the current status on macOS, see #29291 for example",
    "created_at": "2020-03-28T16:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440272",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Replying to [comment:12 dimpase]:
> well, it seems that using system's python would make a slighly cryptographically
> broken Sagemath, one way or another.


That's not a regression from the current status on macOS, see #29291 for example



---

archive/issue_comments_440273.json:
```json
{
    "body": "<a id='comment:14'></a>And, of course, the present ticket is about `sage-system-python`, which is only used for bootstrapping and build. Unrelated to the use of a system python3 for venv (#27824), which has a completely separate test for what it accepts.",
    "created_at": "2020-03-28T17:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440273",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>And, of course, the present ticket is about `sage-system-python`, which is only used for bootstrapping and build. Unrelated to the use of a system python3 for venv (#27824), which has a completely separate test for what it accepts.



---

archive/issue_comments_440274.json:
```json
{
    "body": "<a id='comment:15'></a>oy gevalt, pythons everywhere!",
    "created_at": "2020-03-28T17:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440274",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>oy gevalt, pythons everywhere!



---

archive/issue_comments_440275.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 dimpase]:\n> oy gevalt, pythons everywhere!\n\nThis will be addressed in #45678 \"switch Sage from Python to Julia\"",
    "created_at": "2020-03-28T17:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440275",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Replying to [comment:15 dimpase]:
> oy gevalt, pythons everywhere!

This will be addressed in #45678 "switch Sage from Python to Julia"



---

archive/issue_comments_440276.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-29T14:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440276",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440277.json:
```json
{
    "body": "<a id='comment:19'></a>Rebased, needs review",
    "created_at": "2020-03-29T14:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440277",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Rebased, needs review



---

archive/issue_comments_440278.json:
```json
{
    "body": "<a id='comment:23'></a>Okay, I'm really confused, or my Sage installation is broken, or both. If I use `./sage -i beautifulsoup4` with a build using the system Python on OS X, it fails, but not because of the issues here. Instead, I see this:\n\n```\nmake[2]: *** No rule to make target `/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/SYSTEM/sage-9.1.beta9/local/var/lib/sage/installed/beautifulsoup4-none', needed by `all-sage'.  Stop.\n```\nIf instead I run `make beautifulsoup4`, it succeeds. When I ran `./sage -i tornado` it didn't seem to even try to install it, but `./sage -f tornado` worked.\n\nSo: why does `./sage -i ...` not work? And what is the point of this ticket: what problem does it solve?",
    "created_at": "2020-04-08T20:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440278",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>Okay, I'm really confused, or my Sage installation is broken, or both. If I use `./sage -i beautifulsoup4` with a build using the system Python on OS X, it fails, but not because of the issues here. Instead, I see this:

```
make[2]: *** No rule to make target `/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/SYSTEM/sage-9.1.beta9/local/var/lib/sage/installed/beautifulsoup4-none', needed by `all-sage'.  Stop.
```
If instead I run `make beautifulsoup4`, it succeeds. When I ran `./sage -i tornado` it didn't seem to even try to install it, but `./sage -f tornado` worked.

So: why does `./sage -i ...` not work? And what is the point of this ticket: what problem does it solve?



---

archive/issue_comments_440279.json:
```json
{
    "body": "<a id='comment:24'></a>`sage -i` was changed in #29113 -- unrelated to the present ticket",
    "created_at": "2020-04-08T21:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440279",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>`sage -i` was changed in #29113 -- unrelated to the present ticket



---

archive/issue_comments_440280.json:
```json
{
    "body": "<a id='comment:25'></a>Could you try if the problem goes away if you run `bootstrap`?",
    "created_at": "2020-04-08T21:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440280",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Could you try if the problem goes away if you run `bootstrap`?



---

archive/issue_comments_440281.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,26 @@\n+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n+\n+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`). This is for enabling them to download from an https `upstream_url` when the host is poorly configured.\n+\n+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519\n+\n+---\n+\n+Other possible workarounds considered:\n+- switching from using urllib directly to the requests library\n+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n+- using python instead of python3 on macOS as system python\n+\n+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n+\n+```\n+  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n+    self._sslobj.do_handshake()\n+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n+```\n+(see https://github.com/mkoeppe/sage/runs/538432620)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-04-08T21:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440281",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,26 @@
+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).
+
+Users can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`). This is for enabling them to download from an https `upstream_url` when the host is poorly configured.
+
+In particular this happens with XCode's `python3` as the system python. This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519
+
+---
+
+Other possible workarounds considered:
+- switching from using urllib directly to the requests library
+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
+- using python instead of python3 on macOS as system python
+
+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
+
+```
+  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
+    self._sslobj.do_handshake()
+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
+```
+(see https://github.com/mkoeppe/sage/runs/538432620)
+
 
 
 Comment: 1
```




---

archive/issue_comments_440282.json:
```json
{
    "body": "<a id='comment:27'></a>If I run `bootstrap`, then running `./sage -i benzene` acts like `./sage -i tornado`: it doesn't install. There is a message\n\n```\nrunning ./configure '--enable-beautifulsoup4' '--enable-biopython'  '--enable-benzene'\n```\nand then if I search my terminal window for `benzene`, the only other hit is\n\n```\nbenzene-20130630:                            does not support check for system package; optional, use \"./configure --enable-benzene\" to install\n```\n\nI don't think I tested #29113 well enough when I was reviewing it.",
    "created_at": "2020-04-08T21:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440282",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>If I run `bootstrap`, then running `./sage -i benzene` acts like `./sage -i tornado`: it doesn't install. There is a message

```
running ./configure '--enable-beautifulsoup4' '--enable-biopython'  '--enable-benzene'
```
and then if I search my terminal window for `benzene`, the only other hit is

```
benzene-20130630:                            does not support check for system package; optional, use "./configure --enable-benzene" to install
```

I don't think I tested #29113 well enough when I was reviewing it.



---

archive/issue_comments_440283.json:
```json
{
    "body": "<a id='comment:28'></a>This fixes it for me:\n\n```diff\ndiff --git a/src/bin/sage b/src/bin/sage\nindex 10acddcd96..6ccff3789c 100755\n--- a/src/bin/sage\n+++ b/src/bin/sage\n@@ -404,7 +404,7 @@ if [ \"$1\" = '-i' ]; then\n         #   'CC=gcc -Wall' '--enable-e_antic'\n         CONFIG_CMD=\"./configure $(./config.status --config) $ENABLE_ARGS\"\n         echo >&2 \"running $CONFIG_CMD\"\n-        bash -c \"$CONFIG_CMD\" && $MAKE all-build\n+        bash -c \"$CONFIG_CMD\" && $MAKE $PACKAGES\n     else\n         echo \"New packages may have been installed.\"\n         echo \"Re-running configure and make in case any dependent packages need updating.\"\n```\n(or maybe it could be `$MAKE all-build $PACKAGES`?)\n\nBy the way, I still don't understand the goal of this ticket.",
    "created_at": "2020-04-08T21:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440283",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>This fixes it for me:

```diff
diff --git a/src/bin/sage b/src/bin/sage
index 10acddcd96..6ccff3789c 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -404,7 +404,7 @@ if [ "$1" = '-i' ]; then
         #   'CC=gcc -Wall' '--enable-e_antic'
         CONFIG_CMD="./configure $(./config.status --config) $ENABLE_ARGS"
         echo >&2 "running $CONFIG_CMD"
-        bash -c "$CONFIG_CMD" && $MAKE all-build
+        bash -c "$CONFIG_CMD" && $MAKE $PACKAGES
     else
         echo "New packages may have been installed."
         echo "Re-running configure and make in case any dependent packages need updating."
```
(or maybe it could be `$MAKE all-build $PACKAGES`?)

By the way, I still don't understand the goal of this ticket.



---

archive/issue_comments_440284.json:
```json
{
    "body": "<a id='comment:29'></a>Let's please take the issues with `sage -i` to the new ticket #29481. Thanks for catching this.",
    "created_at": "2020-04-08T23:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440284",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>Let's please take the issues with `sage -i` to the new ticket #29481. Thanks for catching this.



---

archive/issue_comments_440285.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,32 @@\n+#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).\n+\n+Many upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. \n+\n+However, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered \"wontfix\" by Apple as reported here:\n+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)\n+\n+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).\n+\n+Developers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).\n+\n+We note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.\n+\n+---\n+\n+Other possible workarounds considered:\n+- switching from using urllib directly to the requests library\n+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable\n+- using python instead of python3 on macOS as system python\n+\n+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:\n+\n+```\n+  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py\", line 1117, in do_handshake\n+    self._sslobj.do_handshake()\n+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)\n+```\n+(see https://github.com/mkoeppe/sage/runs/538432620)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-04-08T23:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440285",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,32 @@
+#26351 added an optional `upstream_url` field to `build/pkgs/*/checksums.ini`. It streamlines the procedure for testing upgrade tickets: Developers or automatic testing facilities can pass an extra flag `-o` to `sage-spkg` to allow downloading from upstream rather than from Sage mirrors (where the updated ticket will be made available later only).
+
+Many upstream package URLs use the `https` protocol - in contrast to the `http` protocol used when downloading from the Sage mirrors. The downloading is done via `build/bin/sage-download-file`, which uses the `urllib` module. It supports the https protocol. 
+
+However, SSL certificate problems are common on test systems. For example, if one uses XCode's `python3` as the system python, then `urllib` does not automatically uses the standard system certificates. (This is apparently a known issue -- which is considered "wontfix" by Apple as reported here:
+https://github.com/HandBrake/HandBrake/issues/2216#issuecomment-527114519)
+
+We add an option `--no-check-certificate` to `sage-download-file`, disabling certificate checking (https://stackoverflow.com/questions/36600583/python-3-urllib-ignore-ssl-certificate-verification).
+
+Developers can set this option using the environment variable SAGE_DOWNLOAD_FILE_OPTIONS when installing packages (either by `make` or by using `sage -i`).
+
+We note that even with SSL certificates disabled, there is still cryptographic protection because of the checksums recorded in `checksums.ini`.
+
+---
+
+Other possible workarounds considered:
+- switching from using urllib directly to the requests library
+- passing cafile=..., capath=... to urllib, perhaps coming from an environment variable
+- using python instead of python3 on macOS as system python
+
+As of #29090 (sage-system-python fixup) prefers `/usr/bin/python3` over `/usr/bin/python`, leading to:
+
+```
+  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ssl.py", line 1117, in do_handshake
+    self._sslobj.do_handshake()
+OSError: [Errno socket error] [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
+```
+(see https://github.com/mkoeppe/sage/runs/538432620)
+
 
 
 Comment: 1
```




---

archive/issue_comments_440286.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:28 jhpalmieri]:\n> By the way, I still don't understand the goal of this ticket.\n\n\nReworked the ticket description, please take a look",
    "created_at": "2020-04-08T23:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440286",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>Replying to [comment:28 jhpalmieri]:
> By the way, I still don't understand the goal of this ticket.


Reworked the ticket description, please take a look



---

archive/issue_comments_440287.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 mkoeppe]:\n> Replying to [comment:28 jhpalmieri]:\n> > By the way, I still don't understand the goal of this ticket.\n\n> \n> Reworked the ticket description, please take a look\n\n\nSorry, I wasn't clear enough. What system configuration and commands lead to the problem in the description? I can't reproduce the problem, so I can't tell if the solution here works.",
    "created_at": "2020-04-09T03:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440287",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:32'></a>Replying to [comment:31 mkoeppe]:
> Replying to [comment:28 jhpalmieri]:
> > By the way, I still don't understand the goal of this ticket.

> 
> Reworked the ticket description, please take a look


Sorry, I wasn't clear enough. What system configuration and commands lead to the problem in the description? I can't reproduce the problem, so I can't tell if the solution here works.



---

archive/issue_comments_440288.json:
```json
{
    "body": "<a id='comment:33'></a>From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.\n\nDo you have successfully tested this ticket?\n\nDo I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)\n\nAlso this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?",
    "created_at": "2020-04-09T08:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440288",
    "user": "https://github.com/kliem"
}
```

<a id='comment:33'></a>From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.

Do you have successfully tested this ticket?

Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)

Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?



---

archive/issue_comments_440289.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 gh-kliem]:\n> From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.\n\n\nThat's a correct description for macOS. But the problem also appears on Linux distributions if one does not install ca-certificates, or those are outdated.\n\n> Do you have successfully tested this ticket?\n\n\nYes, I have been using this as part of #29417 since end of March. \n\n> Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)\n\n\nThat's correct for the macOS tests using `tox local`. For the Linux tests with `tox docker` note that `/upstream` is in `.gitignore` (therefore in `.dockerignore`) and is therefore not provided to the container.\n\n> Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?\n\n\nThat's right, normal users would not use the `upstream_url` at all; it is a feature for developers only.",
    "created_at": "2020-04-09T15:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440289",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Replying to [comment:33 gh-kliem]:
> From what I understand this is a problem that only occurs when one has python3 from Xcode. This doesn't ship certify and never will (at least Apple doesn't have any intentions). So it is really difficult to establish an ssl connection with that.


That's a correct description for macOS. But the problem also appears on Linux distributions if one does not install ca-certificates, or those are outdated.

> Do you have successfully tested this ticket?


Yes, I have been using this as part of #29417 since end of March. 

> Do I understand correctly that the problem occurring could be theoretically fixed by manually downloading the correct packages into the upstream folder? (Yes this is not a good approach for testing environments.)


That's correct for the macOS tests using `tox local`. For the Linux tests with `tox docker` note that `/upstream` is in `.gitignore` (therefore in `.dockerignore`) and is therefore not provided to the container.

> Also this flag would never be needed for a normal user as long as the sage mirrors don't use ssl?


That's right, normal users would not use the `upstream_url` at all; it is a feature for developers only.



---

archive/issue_comments_440290.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-09T15:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440290",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_440291.json:
```json
{
    "body": "<a id='comment:35'></a>LGTM.\n\nBtw, I have been using this ticket to test my tickets, e.g. here: https://github.com/kliem/sage-test-27122/actions/runs/72102779",
    "created_at": "2020-04-09T15:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440291",
    "user": "https://github.com/kliem"
}
```

<a id='comment:35'></a>LGTM.

Btw, I have been using this ticket to test my tickets, e.g. here: https://github.com/kliem/sage-test-27122/actions/runs/72102779



---

archive/issue_comments_440292.json:
```json
{
    "body": "<a id='comment:36'></a>Thank you!",
    "created_at": "2020-04-09T15:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440292",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Thank you!



---

archive/issue_events_074987.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-12T15:34:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29418#event-74987"
}
```



---

archive/issue_comments_440293.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-12T15:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440293",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_440294.json:
```json
{
    "body": "<a id='comment:38'></a>Follow up: #30950",
    "created_at": "2020-11-23T02:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29418#issuecomment-440294",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Follow up: #30950
