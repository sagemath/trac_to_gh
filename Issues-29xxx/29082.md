# Issue 29082: Do not stage .pc files in src/lib/, clean old generated *.pc files at 'make distclean', fix 'permission denied' errors

archive/issues_028845.json:
```json
{
    "body": "#29003 introduced 2-stage installation of generated *.pc files, \nvia `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n \nAlso, in some installations, repeated installations this code leads to 'permission denied' errors when trying to overwrite read-only files:\n\n```\n  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc\n  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc\n  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc\n  [openblas-0.3.6.p0]   \n  [openblas-0.3.6.p0]   real\t8m40.259s\n  [openblas-0.3.6.p0]   user\t45m2.739s\n  [openblas-0.3.6.p0]   sys\t5m48.754s\n  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local\n  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied\n  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied\n  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied\n```\n\nThis ticket revises the installation as follows:\n\n- `configure` no longer creates .pc files in the build tree\n- Instead it creates rules in `make/Makefile` that create the .pc files in `SAGE_LOCAL`.\n- Before pc files are installed into `SAGE_LOCAL`, the targets are removed, to avoid permission problems\n\nThis ticket does not solve everything. There may still be problems when switching from a system library to an spkg-provided library. We will use the follow-up ticket #29387 (Complete solution for installing the generated *.pc files) to address this problem.\n\n\n\nCC:  @embray @mkoeppe @jhpalmieri @vbraun @kiwifb\n\nBranch/Commit: 329843baa9cecfb751e8afdb6b666f01930f0bf0\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29082\n\n",
    "closed_at": "2020-03-29T00:24:26Z",
    "created_at": "2020-01-26T12:40:13Z",
    "labels": [
        "component: build: configure",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Do not stage .pc files in src/lib/, clean old generated *.pc files at 'make distclean', fix 'permission denied' errors",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29082",
    "user": "https://github.com/dimpase"
}
```
#29003 introduced 2-stage installation of generated *.pc files, 
via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
 
Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to overwrite read-only files:

```
  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc
  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc
  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc
  [openblas-0.3.6.p0]   
  [openblas-0.3.6.p0]   real	8m40.259s
  [openblas-0.3.6.p0]   user	45m2.739s
  [openblas-0.3.6.p0]   sys	5m48.754s
  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local
  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied
  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied
  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied
```

This ticket revises the installation as follows:

- `configure` no longer creates .pc files in the build tree
- Instead it creates rules in `make/Makefile` that create the .pc files in `SAGE_LOCAL`.
- Before pc files are installed into `SAGE_LOCAL`, the targets are removed, to avoid permission problems

This ticket does not solve everything. There may still be problems when switching from a system library to an spkg-provided library. We will use the follow-up ticket #29387 (Complete solution for installing the generated *.pc files) to address this problem.



CC:  @embray @mkoeppe @jhpalmieri @vbraun @kiwifb

Branch/Commit: 329843baa9cecfb751e8afdb6b666f01930f0bf0

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29082





---

archive/issue_comments_566062.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-01-26T12:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566062",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_566063.json:
```json
{
    "body": "<a id='comment:2'></a>My suggestion would be to rewrite this as a script package instead of putting things into `src/`. This stuff really does not belong into `src/`.",
    "created_at": "2020-01-28T00:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566063",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>My suggestion would be to rewrite this as a script package instead of putting things into `src/`. This stuff really does not belong into `src/`.



---

archive/issue_comments_566064.json:
```json
{
    "body": "<a id='comment:3'></a>Added #29071 as a dependency as it touches the same files.",
    "created_at": "2020-01-28T01:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566064",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Added #29071 as a dependency as it touches the same files.



---

archive/issue_comments_566065.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#29071\"",
    "created_at": "2020-01-28T01:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566065",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#29071"



---

archive/issue_comments_566066.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,10 @@\n #29003 introduced 2-stage installation of generated *.pc files, \n via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n  \n-At least `make distclean` should clean them, possibly even `make clean`, not sure about this.\n+The generated files are for sage-the-distribution, not sagelib, so they belong into `build`, not `src`.\n+\n+Because `configure` (`config.status`) creates them, `make distclean` should clean them, but not `make clean`.\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-01-28T01:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566066",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,10 @@
 #29003 introduced 2-stage installation of generated *.pc files, 
 via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
  
-At least `make distclean` should clean them, possibly even `make clean`, not sure about this.
+The generated files are for sage-the-distribution, not sagelib, so they belong into `build`, not `src`.
+
+Because `configure` (`config.status`) creates them, `make distclean` should clean them, but not `make clean`.
+
 
 Comment: 1
 
``````




---

archive/issue_comments_566067.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2020-01-28T01:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566067",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_566068.json:
```json
{
    "body": "<a id='comment:5'></a>(deleted a comment that was intended for #29071.)",
    "created_at": "2020-01-28T01:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566068",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>(deleted a comment that was intended for #29071.)



---

archive/issue_comments_566069.json:
```json
{
    "body": "<a id='comment:6'></a>(deleted a comment that was intended for #29071.)",
    "created_at": "2020-01-28T01:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566069",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>(deleted a comment that was intended for #29071.)



---

archive/issue_comments_566070.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:2 mkoeppe]:\n> My suggestion would be to rewrite this as a script package instead of putting things into `src/`. This stuff really does not belong into `src/`.\n\n\nPerhaps we should just create `var/` next to `src/` and put these things there?",
    "created_at": "2020-01-28T09:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566070",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>Replying to [comment:2 mkoeppe]:
> My suggestion would be to rewrite this as a script package instead of putting things into `src/`. This stuff really does not belong into `src/`.


Perhaps we should just create `var/` next to `src/` and put these things there?



---

archive/issue_comments_566071.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+The generated files are for sage-the-distribution, not sagelib, so they belong into `build`, not `src`.\n+\n+Because `configure` (`config.status`) creates them, `make distclean` should clean them, if not `make clean`.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-01-28T09:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566071",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+The generated files are for sage-the-distribution, not sagelib, so they belong into `build`, not `src`.
+
+Because `configure` (`config.status`) creates them, `make distclean` should clean them, if not `make clean`.
 
 
 Comment: 1
``````




---

archive/issue_comments_566072.json:
```json
{
    "body": "<a id='comment:8'></a>No, I don't think so. These are configure-generated files of sage-the-distribution - like `build/make/Makefile`. There's no need for a new top level.\n\nLet me take care of this ticket after #29071 is done.",
    "created_at": "2020-01-28T12:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566072",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>No, I don't think so. These are configure-generated files of sage-the-distribution - like `build/make/Makefile`. There's no need for a new top level.

Let me take care of this ticket after #29071 is done.



---

archive/issue_comments_566073.json:
```json
{
    "body": "Changing dependencies from \"#29071\" to \"#29051, #29071, #29084\"",
    "created_at": "2020-01-29T00:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566073",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#29071" to "#29051, #29071, #29084"



---

archive/issue_comments_566074.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-01-29T02:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566074",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_566075.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/move__pc_file_from_src__to_build___clean_generated___pc_files_at__make_distclean_\"",
    "created_at": "2020-01-29T04:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566075",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/move__pc_file_from_src__to_build___clean_generated___pc_files_at__make_distclean_"



---

archive/issue_comments_566076.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+This ticket revises the 2-stage installation as follows:\n+- Because the generated files are for sage-the-distribution, not sagelib, so they belong into `build`, not `src`.\n+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.\n+- Special-purpose code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.\n+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-01-29T04:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566076",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+This ticket revises the 2-stage installation as follows:
+- Because the generated files are for sage-the-distribution, not sagelib, so they belong into `build`, not `src`.
+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.
+- Special-purpose code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.
+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.
 
 
 Comment: 1
``````




---

archive/issue_comments_566077.json:
```json
{
    "body": "<a id='comment:12'></a>Last 10 new commits:",
    "created_at": "2020-01-29T04:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566077",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Last 10 new commits:



---

archive/issue_comments_566078.json:
```json
{
    "body": "Changing commit from \"\" to \"2a01db11ef106d00217d3176a794850524467bcd\"",
    "created_at": "2020-01-29T04:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566078",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "2a01db11ef106d00217d3176a794850524467bcd"



---

archive/issue_comments_566079.json:
```json
{
    "body": "<a id='comment:13'></a>Branch is on top of #29051, #29071, #29084.\nThis is a first version, haven't tested much yet.",
    "created_at": "2020-01-29T04:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566079",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Branch is on top of #29051, #29071, #29084.
This is a first version, haven't tested much yet.



---

archive/issue_comments_566080.json:
```json
{
    "body": "<a id='comment:14'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/32449719",
    "created_at": "2020-01-29T04:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566080",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/32449719



---

archive/issue_comments_566081.json:
```json
{
    "body": "Changing dependencies from \"#29051, #29071, #29084\" to \"#29051, #29071, #29084, #26130, #29056\"",
    "created_at": "2020-01-30T01:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566081",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#29051, #29071, #29084" to "#29051, #29071, #29084, #26130, #29056"



---

archive/issue_comments_566082.json:
```json
{
    "body": "<a id='comment:16'></a>I will redo this on top of the hot fix - #29121.",
    "created_at": "2020-01-31T15:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566082",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>I will redo this on top of the hot fix - #29121.



---

archive/issue_comments_566083.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+This ticket revises the 2-stage installation as follows:\n+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.\n+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.\n+- Special-purpose code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.\n+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-02-16T20:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566083",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+This ticket revises the 2-stage installation as follows:
+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.
+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.
+- Special-purpose code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.
+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.
 
 
 Comment: 1
``````




---

archive/issue_comments_566084.json:
```json
{
    "body": "Changing commit from \"2a01db11ef106d00217d3176a794850524467bcd\" to \"2535c186176468a691627bdc0cff84d8387782a8\"",
    "created_at": "2020-02-16T20:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566084",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2a01db11ef106d00217d3176a794850524467bcd" to "2535c186176468a691627bdc0cff84d8387782a8"



---

archive/issue_comments_566085.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-16T20:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566085",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_566086.json:
```json
{
    "body": "Changing dependencies from \"#29051, #29071, #29084, #26130, #29056\" to \"\"",
    "created_at": "2020-02-16T20:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566086",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#29051, #29071, #29084, #26130, #29056" to ""



---

archive/issue_comments_566087.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-16T20:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566087",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_566088.json:
```json
{
    "body": "<a id='comment:19'></a>Rebased on 9.1.beta4",
    "created_at": "2020-02-16T20:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566088",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Rebased on 9.1.beta4



---

archive/issue_comments_566089.json:
```json
{
    "body": "Changing commit from \"2535c186176468a691627bdc0cff84d8387782a8\" to \"3f2060ebf71d3cd593efe44a751b1a8017af969b\"",
    "created_at": "2020-02-22T23:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566089",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2535c186176468a691627bdc0cff84d8387782a8" to "3f2060ebf71d3cd593efe44a751b1a8017af969b"



---

archive/issue_comments_566090.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-22T23:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566090",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566091.json:
```json
{
    "body": "<a id='comment:22'></a>Needs review.",
    "created_at": "2020-02-22T23:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566091",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Needs review.



---

archive/issue_comments_566092.json:
```json
{
    "body": "Changing commit from \"3f2060ebf71d3cd593efe44a751b1a8017af969b\" to \"d6b5677f0a51dd790377482f4608fd041fb0fbbe\"",
    "created_at": "2020-03-02T01:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566092",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3f2060ebf71d3cd593efe44a751b1a8017af969b" to "d6b5677f0a51dd790377482f4608fd041fb0fbbe"



---

archive/issue_comments_566093.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-02T01:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566094.json:
```json
{
    "body": "<a id='comment:24'></a>Agreed on the first two points in the description.\n\nDon't agree on sage_system_blas_facade and the changes to Makefile.in.  I don't see how it's \"special-purpose code\".  It's a quite generic solution that you seem to be *replacing* with \"special-purpose code\" that's very specific to openblas.  This ticket was needed for more than just blas.",
    "created_at": "2020-03-06T14:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566094",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>Agreed on the first two points in the description.

Don't agree on sage_system_blas_facade and the changes to Makefile.in.  I don't see how it's "special-purpose code".  It's a quite generic solution that you seem to be *replacing* with "special-purpose code" that's very specific to openblas.  This ticket was needed for more than just blas.



---

archive/issue_comments_566095.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-03-06T14:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566095",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_566096.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+This ticket revises the 2-stage installation as follows:\n+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.\n+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.\n+- Code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.\n+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-06T16:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566096",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+This ticket revises the 2-stage installation as follows:
+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.
+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.
+- Code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.
+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.
 
 
 Comment: 1
``````




---

archive/issue_comments_566097.json:
```json
{
    "body": "<a id='comment:27'></a>Is my ticket handling the `gsl.pc` correctly? Which packages use this file?",
    "created_at": "2020-03-07T03:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566097",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Is my ticket handling the `gsl.pc` correctly? Which packages use this file?



---

archive/issue_comments_566098.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,27 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to override read-only files:\n+\n+```\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc\n+  [openblas-0.3.6.p0]   \n+  [openblas-0.3.6.p0]   real\t8m40.259s\n+  [openblas-0.3.6.p0]   user\t45m2.739s\n+  [openblas-0.3.6.p0]   sys\t5m48.754s\n+  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied\n+```\n+\n+This ticket revises the 2-stage installation as follows:\n+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.\n+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.\n+- Code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.\n+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-14T01:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566098",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,27 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to override read-only files:
+
+```
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc
+  [openblas-0.3.6.p0]   
+  [openblas-0.3.6.p0]   real	8m40.259s
+  [openblas-0.3.6.p0]   user	45m2.739s
+  [openblas-0.3.6.p0]   sys	5m48.754s
+  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied
+```
+
+This ticket revises the 2-stage installation as follows:
+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.
+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.
+- Code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.
+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.
 
 
 Comment: 1
``````




---

archive/issue_comments_566099.json:
```json
{
    "body": "<a id='comment:29'></a>I also don't quite understand the need to create a special script package, instead of adjusting `build/make/Makefile.in`.\n\nIs there a technical problem?",
    "created_at": "2020-03-19T03:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566099",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>I also don't quite understand the need to create a special script package, instead of adjusting `build/make/Makefile.in`.

Is there a technical problem?



---

archive/issue_comments_566100.json:
```json
{
    "body": "<a id='comment:30'></a>It seemed to be an elegant solution when I wrote this a month ago",
    "created_at": "2020-03-19T03:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566100",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>It seemed to be an elegant solution when I wrote this a month ago



---

archive/issue_comments_566101.json:
```json
{
    "body": "<a id='comment:31'></a>It seems that your package handles more that blas/lapack pc files, no?\nPerhaps it just is wrongly named?",
    "created_at": "2020-03-19T03:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566101",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>It seems that your package handles more that blas/lapack pc files, no?
Perhaps it just is wrongly named?



---

archive/issue_comments_566102.json:
```json
{
    "body": "<a id='comment:32'></a>That's basically my question regarding gsl.pc above, I guess.",
    "created_at": "2020-03-19T03:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566102",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>That's basically my question regarding gsl.pc above, I guess.



---

archive/issue_comments_566103.json:
```json
{
    "body": "<a id='comment:33'></a>there is also a bug: PKG_CONFIG_PATH is pointing to the wrong directory, so these\nnewly installed pc files are not found:\n\n```\n(sage-sh) dima@fedora:sagetrac-mirror$ echo $PKG_CONFIG_PATH\n/home/dima/sagetrac-mirror/local/lib/pkgconfig:.\n(sage-sh) dima@fedora:sagetrac-mirror$ find . -name cblas.pc\n./build/pkgs/sage_system_blas_facade/src/cblas.pc\n./src/lib/pkgconfig/cblas.pc\n```",
    "created_at": "2020-03-19T04:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566103",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>there is also a bug: PKG_CONFIG_PATH is pointing to the wrong directory, so these
newly installed pc files are not found:

```
(sage-sh) dima@fedora:sagetrac-mirror$ echo $PKG_CONFIG_PATH
/home/dima/sagetrac-mirror/local/lib/pkgconfig:.
(sage-sh) dima@fedora:sagetrac-mirror$ find . -name cblas.pc
./build/pkgs/sage_system_blas_facade/src/cblas.pc
./src/lib/pkgconfig/cblas.pc
```



---

archive/issue_comments_566104.json:
```json
{
    "body": "<a id='comment:34'></a>oops, I mean, they are just not installed at all.\nPKG_CONFIG_PATH is correct, but pc files are not there, or anywhere, except the old location",
    "created_at": "2020-03-19T04:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566104",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>oops, I mean, they are just not installed at all.
PKG_CONFIG_PATH is correct, but pc files are not there, or anywhere, except the old location



---

archive/issue_comments_566105.json:
```json
{
    "body": "<a id='comment:35'></a>Feel free to make changes -- otherwise I can look into it tomorrow",
    "created_at": "2020-03-19T04:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566105",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Feel free to make changes -- otherwise I can look into it tomorrow



---

archive/issue_comments_566106.json:
```json
{
    "body": "<a id='comment:36'></a>What does `build/pkgs/sage_system_blas_facade/spkg-install` look like on your machine?",
    "created_at": "2020-03-19T04:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566106",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>What does `build/pkgs/sage_system_blas_facade/spkg-install` look like on your machine?



---

archive/issue_comments_566107.json:
```json
{
    "body": "<a id='comment:37'></a>here it is:\n\n{{{#! /usr/bin/env bash\nPCFILES=\"blas.pccblas.pclapack.pc\"\nSAGE_PKGCONFIG=\"$SAGE_LOCAL/lib/pkgconfig\"\nmkdir -p \"$SAGE_PKGCONFIG\"\nif [ -n \"$PCFILES\" ]; then\n   cd build/pkgs/sage_system_blas_facade/src && cp -P $PCFILES \"$SAGE_PKGCONFIG\"\nfi\n```\nalso note that the original openblas.pc is in SAGE_ROOT",
    "created_at": "2020-03-19T04:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566107",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>here it is:

{{{#! /usr/bin/env bash
PCFILES="blas.pccblas.pclapack.pc"
SAGE_PKGCONFIG="$SAGE_LOCAL/lib/pkgconfig"
mkdir -p "$SAGE_PKGCONFIG"
if [ -n "$PCFILES" ]; then
   cd build/pkgs/sage_system_blas_facade/src && cp -P $PCFILES "$SAGE_PKGCONFIG"
fi
```
also note that the original openblas.pc is in SAGE_ROOT



---

archive/issue_comments_566108.json:
```json
{
    "body": "<a id='comment:38'></a>Looks like some spaces are missing",
    "created_at": "2020-03-19T04:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566108",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Looks like some spaces are missing



---

archive/issue_comments_566109.json:
```json
{
    "body": "<a id='comment:39'></a>indeed, one needs\n\n```diff\n--- a/build/pkgs/openblas/spkg-configure.m4\n+++ b/build/pkgs/openblas/spkg-configure.m4\n@@ -37,7 +37,7 @@ SAGE_SPKG_CONFIGURE([openblas], [dnl CHECK\n        m4_foreach([blaslibnam], [blas, cblas, lapack], [\n         AS_IF([test x$sage_install_]blaslibnam[_pc = xyes], [\n          AC_CONFIG_LINKS([build/pkgs/sage_system_blas_facade/src/]blaslibnam[.pc:$OPENBLASPCDIR/openblas.pc])\n-         AS_VAR_APPEND([SAGE_SYSTEM_BLAS_FACADE_PC_FILES], blaslibnam[.pc])])\n+         AS_VAR_APPEND([SAGE_SYSTEM_BLAS_FACADE_PC_FILES], [blaslibnam[.pc]' '])])\n          AC_SUBST([SAGE_BLAS], [sage_system_blas_facade])\n        ])\n     ])\n```",
    "created_at": "2020-03-19T06:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566109",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>indeed, one needs

```diff
--- a/build/pkgs/openblas/spkg-configure.m4
+++ b/build/pkgs/openblas/spkg-configure.m4
@@ -37,7 +37,7 @@ SAGE_SPKG_CONFIGURE([openblas], [dnl CHECK
        m4_foreach([blaslibnam], [blas, cblas, lapack], [
         AS_IF([test x$sage_install_]blaslibnam[_pc = xyes], [
          AC_CONFIG_LINKS([build/pkgs/sage_system_blas_facade/src/]blaslibnam[.pc:$OPENBLASPCDIR/openblas.pc])
-         AS_VAR_APPEND([SAGE_SYSTEM_BLAS_FACADE_PC_FILES], blaslibnam[.pc])])
+         AS_VAR_APPEND([SAGE_SYSTEM_BLAS_FACADE_PC_FILES], [blaslibnam[.pc]' '])])
          AC_SUBST([SAGE_BLAS], [sage_system_blas_facade])
        ])
     ])
```



---

archive/issue_comments_566110.json:
```json
{
    "body": "<a id='comment:40'></a>but this does not make any difference. As far as I can see, `spkg-install` of `sage_system_blas_facade` never gets run - I'm lost in untangling the reason for this.",
    "created_at": "2020-03-19T13:39:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566110",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:40'></a>but this does not make any difference. As far as I can see, `spkg-install` of `sage_system_blas_facade` never gets run - I'm lost in untangling the reason for this.



---

archive/issue_comments_566111.json:
```json
{
    "body": "<a id='comment:41'></a>OK, I'll take care of it later today.",
    "created_at": "2020-03-19T13:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566111",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>OK, I'll take care of it later today.



---

archive/issue_comments_566112.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2020-03-19T15:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566112",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_566113.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#29287\"",
    "created_at": "2020-03-20T22:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566113",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#29287"



---

archive/issue_comments_566114.json:
```json
{
    "body": "<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-03-20T22:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566114",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_566115.json:
```json
{
    "body": "Changing commit from \"d6b5677f0a51dd790377482f4608fd041fb0fbbe\" to \"30d3b8245cbcee8c7b629dfebc9de213e89f7c86\"",
    "created_at": "2020-03-20T22:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566115",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d6b5677f0a51dd790377482f4608fd041fb0fbbe" to "30d3b8245cbcee8c7b629dfebc9de213e89f7c86"



---

archive/issue_comments_566116.json:
```json
{
    "body": "<a id='comment:45'></a>Branch is on top of #29287",
    "created_at": "2020-03-20T22:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566116",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>Branch is on top of #29287



---

archive/issue_comments_566117.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-21T02:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566117",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566118.json:
```json
{
    "body": "Changing commit from \"30d3b8245cbcee8c7b629dfebc9de213e89f7c86\" to \"7fd5e31fa51e0f9a662848450dbae37732468d6f\"",
    "created_at": "2020-03-21T02:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566118",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "30d3b8245cbcee8c7b629dfebc9de213e89f7c86" to "7fd5e31fa51e0f9a662848450dbae37732468d6f"



---

archive/issue_comments_566119.json:
```json
{
    "body": "Changing commit from \"7fd5e31fa51e0f9a662848450dbae37732468d6f\" to \"b493a32df5c9bb08613e370759412e55a2501676\"",
    "created_at": "2020-03-21T02:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566119",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7fd5e31fa51e0f9a662848450dbae37732468d6f" to "b493a32df5c9bb08613e370759412e55a2501676"



---

archive/issue_comments_566120.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-21T02:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566120",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566121.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2020-03-21T08:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566121",
    "user": "https://github.com/dimpase"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_566122.json:
```json
{
    "body": "<a id='comment:48'></a>this prevents building on Fedora after distclean",
    "created_at": "2020-03-21T08:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566122",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:48'></a>this prevents building on Fedora after distclean



---

archive/issue_comments_566123.json:
```json
{
    "body": "<a id='comment:49'></a>I'm working on a simpler version of this ticket.",
    "created_at": "2020-03-21T12:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566123",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>I'm working on a simpler version of this ticket.



---

archive/issue_comments_566124.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,28 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to overwrite read-only files:\n+\n+```\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc\n+  [openblas-0.3.6.p0]   \n+  [openblas-0.3.6.p0]   real\t8m40.259s\n+  [openblas-0.3.6.p0]   user\t45m2.739s\n+  [openblas-0.3.6.p0]   sys\t5m48.754s\n+  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied\n+```\n+\n+This ticket revises the 2-stage installation as follows:\n+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.\n+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.\n+- The pc files installed into `SAGE_LOCAL` are uninstalled when necessary - or it is ensured that they are properly overwritten.\n+- Code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.\n+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-21T12:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566124",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,28 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to overwrite read-only files:
+
+```
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc
+  [openblas-0.3.6.p0]   
+  [openblas-0.3.6.p0]   real	8m40.259s
+  [openblas-0.3.6.p0]   user	45m2.739s
+  [openblas-0.3.6.p0]   sys	5m48.754s
+  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied
+```
+
+This ticket revises the 2-stage installation as follows:
+- Because the generated files are for sage-the-distribution, not sagelib, they belong into `build`, not `src`.
+- Because `configure` (`config.status`) creates them, `make distclean` cleans them.
+- The pc files installed into `SAGE_LOCAL` are uninstalled when necessary - or it is ensured that they are properly overwritten.
+- Code in `build/make/Makefile.in` is removed in favor of creating a new type=script package `sage_system_blas_facade`, whose `spkg-install` does the installation to `SAGE_LOCAL`.
+- `openblas/spkg-configure.m4` sets `SAGE_BLAS=sage_system_blas_facade` if PC files are generated.
 
 
 Comment: 1
``````




---

archive/issue_comments_566125.json:
```json
{
    "body": "Changing dependencies from \"#29287\" to \"\"",
    "created_at": "2020-03-21T15:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566125",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#29287" to ""



---

archive/issue_comments_566126.json:
```json
{
    "body": "Changing commit from \"b493a32df5c9bb08613e370759412e55a2501676\" to \"705da6a06eaa69613f0c25149f7e9e2d21833371\"",
    "created_at": "2020-03-21T18:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566126",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b493a32df5c9bb08613e370759412e55a2501676" to "705da6a06eaa69613f0c25149f7e9e2d21833371"



---

archive/issue_comments_566127.json:
```json
{
    "body": "<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-21T18:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566127",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_566128.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-21T18:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566128",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_566129.json:
```json
{
    "body": "Changing commit from \"705da6a06eaa69613f0c25149f7e9e2d21833371\" to \"d86cd33c67e253dd17992a8a470a6391663892e2\"",
    "created_at": "2020-03-21T18:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566129",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "705da6a06eaa69613f0c25149f7e9e2d21833371" to "d86cd33c67e253dd17992a8a470a6391663892e2"



---

archive/issue_comments_566130.json:
```json
{
    "body": "<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-21T18:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566130",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566131.json:
```json
{
    "body": "<a id='comment:55'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-21T19:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566131",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:55'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566132.json:
```json
{
    "body": "Changing commit from \"d86cd33c67e253dd17992a8a470a6391663892e2\" to \"f5b4f625d6e3001f07123974b4d1f5356545ae03\"",
    "created_at": "2020-03-21T19:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566132",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d86cd33c67e253dd17992a8a470a6391663892e2" to "f5b4f625d6e3001f07123974b4d1f5356545ae03"



---

archive/issue_comments_566133.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-22T02:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566133",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_566134.json:
```json
{
    "body": "<a id='comment:56'></a>Error with gsl.pc for `local-homebrew-macos-standard` - https://github.com/mkoeppe/sage/runs/524361197",
    "created_at": "2020-03-22T02:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566134",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>Error with gsl.pc for `local-homebrew-macos-standard` - https://github.com/mkoeppe/sage/runs/524361197



---

archive/issue_comments_566135.json:
```json
{
    "body": "<a id='comment:57'></a>also `ubuntu-bionic-standard` (sagelib and cvxopt)",
    "created_at": "2020-03-22T02:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566135",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:57'></a>also `ubuntu-bionic-standard` (sagelib and cvxopt)



---

archive/issue_comments_566136.json:
```json
{
    "body": "<a id='comment:58'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-22T02:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566136",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:58'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566137.json:
```json
{
    "body": "Changing commit from \"f5b4f625d6e3001f07123974b4d1f5356545ae03\" to \"2a38a167ab0c6aa3f39d704eb4087d9adf36c85a\"",
    "created_at": "2020-03-22T02:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566137",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f5b4f625d6e3001f07123974b4d1f5356545ae03" to "2a38a167ab0c6aa3f39d704eb4087d9adf36c85a"



---

archive/issue_comments_566138.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-22T02:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566138",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_566139.json:
```json
{
    "body": "<a id='comment:60'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138",
    "created_at": "2020-03-22T02:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566139",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:60'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138



---

archive/issue_comments_566140.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,30 @@\n+#29003 introduced 2-stage installation of generated *.pc files, \n+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).\n+ \n+Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to overwrite read-only files:\n+\n+```\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc\n+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc\n+  [openblas-0.3.6.p0]   \n+  [openblas-0.3.6.p0]   real\t8m40.259s\n+  [openblas-0.3.6.p0]   user\t45m2.739s\n+  [openblas-0.3.6.p0]   sys\t5m48.754s\n+  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied\n+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied\n+```\n+\n+This ticket revises the installation as follows:\n+\n+- `configure` no longer creates .pc files in the build tree\n+- Instead it creates rules in `make/Makefile` that create the .pc files in `SAGE_LOCAL`.\n+- Before pc files are installed into `SAGE_LOCAL`, the targets are removed, to avoid permission problems\n+\n+This ticket does not solve everything. There may still be problems when switching from a system library to an spkg-provided library. We will use the follow-up ticket #29387 (Complete solution for installing the generated *.pc files) to address this problem.\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-03-22T03:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566140",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,30 @@
+#29003 introduced 2-stage installation of generated *.pc files, 
+via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
+ 
+Also, in some installations, repeated installations this code leads to 'permission denied' errors when trying to overwrite read-only files:
+
+```
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/blas.pc
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/cblas.pc
+  [openblas-0.3.6.p0]   Wrote /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/lib/pkgconfig/lapack.pc
+  [openblas-0.3.6.p0]   
+  [openblas-0.3.6.p0]   real	8m40.259s
+  [openblas-0.3.6.p0]   user	45m2.739s
+  [openblas-0.3.6.p0]   sys	5m48.754s
+  [openblas-0.3.6.p0]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/cblas.pc: Permission denied
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/blas.pc: Permission denied
+  [openblas-0.3.6.p0]   cp: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-minimal/local/./lib/pkgconfig/lapack.pc: Permission denied
+```
+
+This ticket revises the installation as follows:
+
+- `configure` no longer creates .pc files in the build tree
+- Instead it creates rules in `make/Makefile` that create the .pc files in `SAGE_LOCAL`.
+- Before pc files are installed into `SAGE_LOCAL`, the targets are removed, to avoid permission problems
+
+This ticket does not solve everything. There may still be problems when switching from a system library to an spkg-provided library. We will use the follow-up ticket #29387 (Complete solution for installing the generated *.pc files) to address this problem.
+
 
 
 Comment: 1
``````




---

archive/issue_comments_566141.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dima Pasechnik\"",
    "created_at": "2020-03-22T09:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566141",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Dima Pasechnik"



---

archive/issue_comments_566142.json:
```json
{
    "body": "<a id='comment:62'></a>OK, this does the needed job. Perhaps the make rules could be made less explicit, but OK.",
    "created_at": "2020-03-22T09:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566142",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:62'></a>OK, this does the needed job. Perhaps the make rules could be made less explicit, but OK.



---

archive/issue_comments_566143.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-22T09:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566143",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_566144.json:
```json
{
    "body": "<a id='comment:63'></a>Thanks!",
    "created_at": "2020-03-22T09:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566144",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:63'></a>Thanks!



---

archive/issue_comments_566145.json:
```json
{
    "body": "<a id='comment:65'></a>Make distclean deletes `src/lib/pkgconfig/.gitignore`",
    "created_at": "2020-03-23T23:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566145",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:65'></a>Make distclean deletes `src/lib/pkgconfig/.gitignore`



---

archive/issue_comments_566146.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-23T23:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566146",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_566147.json:
```json
{
    "body": "<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-23T23:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566147",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_566148.json:
```json
{
    "body": "Changing commit from \"2a38a167ab0c6aa3f39d704eb4087d9adf36c85a\" to \"329843baa9cecfb751e8afdb6b666f01930f0bf0\"",
    "created_at": "2020-03-23T23:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566148",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2a38a167ab0c6aa3f39d704eb4087d9adf36c85a" to "329843baa9cecfb751e8afdb6b666f01930f0bf0"



---

archive/issue_comments_566149.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-23T23:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566149",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_566150.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-24T03:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566150",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_566151.json:
```json
{
    "body": "<a id='comment:68'></a>ok. sorry for overlooking this.",
    "created_at": "2020-03-24T03:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566151",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:68'></a>ok. sorry for overlooking this.



---

archive/issue_comments_566152.json:
```json
{
    "body": "<a id='comment:69'></a>Thanks",
    "created_at": "2020-03-24T03:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566152",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:69'></a>Thanks



---

archive/issue_comments_566153.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-29T00:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566153",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073742.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-29T00:24:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29082#event-73742"
}
```



---

archive/issue_comments_566154.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/move__pc_file_from_src__to_build___clean_generated___pc_files_at__make_distclean_\" to \"329843baa9cecfb751e8afdb6b666f01930f0bf0\"",
    "created_at": "2020-03-29T00:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29082#issuecomment-566154",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/move__pc_file_from_src__to_build___clean_generated___pc_files_at__make_distclean_" to "329843baa9cecfb751e8afdb6b666f01930f0bf0"
