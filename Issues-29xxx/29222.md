# Issue 29222: Improvements to padic polylog

archive/issues_028985.json:
```json
{
    "body": "Two improvements for p-adic polylogarithms:\n\nPython2->3 broke range of a rational in a way that didn't trigger any doctest failures, fix it and add a doctest.\n\nAllow the user to specify the branch of the p-adic logarithm that is used, in the same way as for logarithm.\n\nCC:  @xcaruso\n\nKeywords: polylog, padic\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton, David Roe\n\nAuthor: Alex J. Best\n\nBranch: 528197349e2f6aee483ed2ebb5d18cc28b764ca7\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29222\n\n",
    "closed_at": "2021-06-06T13:19:28Z",
    "created_at": "2020-02-19T21:02:00Z",
    "labels": [
        "component: padics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Improvements to padic polylog",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29222",
    "user": "https://github.com/alexjbest"
}
```
Two improvements for p-adic polylogarithms:

Python2->3 broke range of a rational in a way that didn't trigger any doctest failures, fix it and add a doctest.

Allow the user to specify the branch of the p-adic logarithm that is used, in the same way as for logarithm.

CC:  @xcaruso

Keywords: polylog, padic

Reviewer: Frédéric Chapoton, David Roe

Author: Alex J. Best

Branch: 528197349e2f6aee483ed2ebb5d18cc28b764ca7

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29222





---

archive/issue_events_074263.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-15T14:58:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29222#event-74263"
}
```



---

archive/issue_comments_409860.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-16T22:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409860",
    "user": "https://github.com/alexjbest"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409861.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2020-04-16T22:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409861",
    "user": "https://github.com/alexjbest"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_409862.json:
```json
{
    "body": "<a id='comment:4'></a>one failing doctest, see bot report",
    "created_at": "2020-05-17T16:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409862",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>one failing doctest, see bot report



---

archive/issue_comments_409863.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-05-17T16:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409863",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_409864.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-17T17:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409864",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409865.json:
```json
{
    "body": "<a id='comment:7'></a>Ooops how did I miss that, thanks for the heads up.",
    "created_at": "2020-05-17T17:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409865",
    "user": "https://github.com/alexjbest"
}
```

<a id='comment:7'></a>Ooops how did I miss that, thanks for the heads up.



---

archive/issue_comments_409866.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-05-22T11:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409866",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_409867.json:
```json
{
    "body": "<a id='comment:8'></a>rather ask an expert of the field",
    "created_at": "2020-05-22T11:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409867",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>rather ask an expert of the field



---

archive/issue_comments_409868.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-27T20:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409869.json:
```json
{
    "body": "<a id='comment:11'></a>The two new `raise ValueError` should be doctested.",
    "created_at": "2020-05-28T09:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409869",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>The two new `raise ValueError` should be doctested.



---

archive/issue_comments_409870.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-30T21:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409870",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409871.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-30T21:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409871",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409872.json:
```json
{
    "body": "<a id='comment:14'></a>one doctest for the ValueError does not pass, and seems to trigger the other one instead",
    "created_at": "2020-06-04T19:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409872",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:14'></a>one doctest for the ValueError does not pass, and seems to trigger the other one instead



---

archive/issue_comments_409873.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-02T19:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409873",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_074264.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29222#event-74264"
}
```



---

archive/issue_events_074265.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29222#event-74265"
}
```



---

archive/issue_comments_409874.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-20T20:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409875.json:
```json
{
    "body": "<a id='comment:18'></a>There appears to be some memory leak type problems with the polylog functions as the code\n\n```\nfor p in prime_range(100):\n    K = Qp(p,prec=10)\n    print(p)\n    for t in K.teichmuller_system():\n        if t == 1:      \n            continue    \n        l = t.polylog(2)\n        print(p,l)\n```\neats more and more memory which isn't freed at the end.\n\nI don't think these problems were necessarily introduced in this ticket, but nevertheless I'd like to diagnose them if anyone has any suggestions how to find the leaks or advice about likely culprits in the code.",
    "created_at": "2020-10-20T21:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409875",
    "user": "https://github.com/alexjbest"
}
```

<a id='comment:18'></a>There appears to be some memory leak type problems with the polylog functions as the code

```
for p in prime_range(100):
    K = Qp(p,prec=10)
    print(p)
    for t in K.teichmuller_system():
        if t == 1:      
            continue    
        l = t.polylog(2)
        print(p,l)
```
eats more and more memory which isn't freed at the end.

I don't think these problems were necessarily introduced in this ticket, but nevertheless I'd like to diagnose them if anyone has any suggestions how to find the leaks or advice about likely culprits in the code.



---

archive/issue_comments_409876.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-10-20T21:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409876",
    "user": "https://github.com/alexjbest"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_409877.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-20T21:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_409878.json:
```json
{
    "body": "<a id='comment:20'></a>The memory leaks could be the same issue as #27536 it appears there are many `sage.rings.real_mpfr.RealNumber` left on the heap.",
    "created_at": "2020-11-13T22:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409878",
    "user": "https://github.com/alexjbest"
}
```

<a id='comment:20'></a>The memory leaks could be the same issue as #27536 it appears there are many `sage.rings.real_mpfr.RealNumber` left on the heap.



---

archive/issue_events_074266.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29222#event-74266"
}
```



---

archive/issue_events_074267.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29222#event-74267"
}
```



---

archive/issue_comments_409879.json:
```json
{
    "body": "<a id='comment:21'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409879",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_409880.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-04-28T21:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409880",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_409881.json:
```json
{
    "body": "<a id='comment:22'></a>Overall this looks good to me.\n\nHave you made any progress on the memory leak?  I don't have any suggestions off the top of my head.  I think it's fine to create another ticket for that issue.\n\nYou use the `.n()` numerical approximation extensively.  Would it be better to specify the precision of the real field to use?  I'm also not sure if people like seeing the symbolic expression in some cases.  Maybe have a precision parameter that defaults to 53, but if it's set to None uses symbolic logs?\n\nI'm happy giving this a positive review if you don't want to work on either of these.",
    "created_at": "2021-04-28T21:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409881",
    "user": "https://github.com/roed314"
}
```

<a id='comment:22'></a>Overall this looks good to me.

Have you made any progress on the memory leak?  I don't have any suggestions off the top of my head.  I think it's fine to create another ticket for that issue.

You use the `.n()` numerical approximation extensively.  Would it be better to specify the precision of the real field to use?  I'm also not sure if people like seeing the symbolic expression in some cases.  Maybe have a precision parameter that defaults to 53, but if it's set to None uses symbolic logs?

I'm happy giving this a positive review if you don't want to work on either of these.



---

archive/issue_comments_409882.json:
```json
{
    "body": "<a id='comment:23'></a>I haven't made progress on the leak, #27536 seems to have stalled too, so I think your suggestion of merging this as is and making a separate ticket sounds good.\n\nMost of the `.n()` parts are just for determining various cutoffs for correct precision bounds, for most of these numbers only the integer part of the result matters.\nI doubt anyone would want to look at them symbolically, or that more than 53 digits of precision would be needed. The motivation for the numerical approximations was that a lot of time was being wasted comparing various symbolic expressions to see which is larger, when comparing numerical approximations was far faster.\nI could write these sorts of things as `RR(gsl-1).log(p)` instead I suppose, but I don't think it would make too much difference?\n\nSo I don't propose making further changes, unless you have more thoughts on these two issues mentioned of course!",
    "created_at": "2021-05-10T22:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409882",
    "user": "https://github.com/alexjbest"
}
```

<a id='comment:23'></a>I haven't made progress on the leak, #27536 seems to have stalled too, so I think your suggestion of merging this as is and making a separate ticket sounds good.

Most of the `.n()` parts are just for determining various cutoffs for correct precision bounds, for most of these numbers only the integer part of the result matters.
I doubt anyone would want to look at them symbolically, or that more than 53 digits of precision would be needed. The motivation for the numerical approximations was that a lot of time was being wasted comparing various symbolic expressions to see which is larger, when comparing numerical approximations was far faster.
I could write these sorts of things as `RR(gsl-1).log(p)` instead I suppose, but I don't think it would make too much difference?

So I don't propose making further changes, unless you have more thoughts on these two issues mentioned of course!



---

archive/issue_comments_409883.json:
```json
{
    "body": "<a id='comment:24'></a>Sounds good to me.",
    "created_at": "2021-05-14T18:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409883",
    "user": "https://github.com/roed314"
}
```

<a id='comment:24'></a>Sounds good to me.



---

archive/issue_comments_409884.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2021-05-14T18:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409884",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_409885.json:
```json
{
    "body": "<a id='comment:25'></a>Leak issue now tracked at #31826.",
    "created_at": "2021-05-15T11:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409885",
    "user": "https://github.com/slel"
}
```

<a id='comment:25'></a>Leak issue now tracked at #31826.



---

archive/issue_comments_409886.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29222#issuecomment-409886",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074268.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-06T13:19:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29222",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29222#event-74268"
}
```
