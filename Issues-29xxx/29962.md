# Issue 29962: Introduce random-seed option to allow fuzzing of doctests

archive/issues_029725.json:
```json
{
    "body": "This is the first step towards #29935.\n\nWe introduce an option for doctests: `--random-seed`.\n\nThis allows specifying which seed to use for tests\ninvolving randomness.\n\nThe seed is displayed in the test log:\n\n```\nsage -t --long --random-seed=9876543210 src/sage/all.py \n...\nDoctesting 1 file.\nsage -t --long --random-seed=9876543210 src/sage/all.py\n    [16 tests, 0.73 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.8 seconds\n    cpu time: 0.7 seconds\n    cumulative wall time: 0.7 seconds\n```\n\nwhich makes it easy to re-run tests with the same seed.\n\nThe seed defaults to `0` for now:\n\n```\nsage -t --long src/sage/all.py \n...\nDoctesting 1 file.\nsage -t --long --random-seed=0 src/sage/all.py\n    [16 tests, 0.73 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.8 seconds\n    cpu time: 0.7 seconds\n    cumulative wall time: 0.7 seconds\n```\n\nbut the plan in #29935 is to eventually have\nthe random seed itself picked at random by default.\n\nCC:  @slel\n\nKeywords: doctests, random\n\nReviewer: Markus Wageringel, Matthias Koeppe\n\nAuthor: Jonathan Kliem\n\nBranch: 1d99129f26f4a065f9f9e5e13c3d5120a029e89f\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29962\n\n",
    "closed_at": "2020-07-19T07:24:18Z",
    "created_at": "2020-06-24T19:06:29Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Introduce random-seed option to allow fuzzing of doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29962",
    "user": "https://github.com/kliem"
}
```
This is the first step towards #29935.

We introduce an option for doctests: `--random-seed`.

This allows specifying which seed to use for tests
involving randomness.

The seed is displayed in the test log:

```
sage -t --long --random-seed=9876543210 src/sage/all.py 
...
Doctesting 1 file.
sage -t --long --random-seed=9876543210 src/sage/all.py
    [16 tests, 0.73 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
```

which makes it easy to re-run tests with the same seed.

The seed defaults to `0` for now:

```
sage -t --long src/sage/all.py 
...
Doctesting 1 file.
sage -t --long --random-seed=0 src/sage/all.py
    [16 tests, 0.73 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
```

but the plan in #29935 is to eventually have
the random seed itself picked at random by default.

CC:  @slel

Keywords: doctests, random

Reviewer: Markus Wageringel, Matthias Koeppe

Author: Jonathan Kliem

Branch: 1d99129f26f4a065f9f9e5e13c3d5120a029e89f

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29962





---

archive/issue_comments_421763.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-24T19:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421763",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421764.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2020-06-24T19:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421764",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_421765.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-24T19:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421765",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421766.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-24T19:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421766",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_421767.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-24T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421767",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421768.json:
```json
{
    "body": "<a id='comment:6'></a>Overall, this looks good to me. The following changes seem to be needed:\n\n```diff\n-    sage: subprocess.call([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--random-seed=0\", -random_seed.rst\"], **kwds)  # long time\n+    sage: subprocess.call([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--random-seed=0\", \"random_seed.rst\"], **kwds)  # long time\n```\n\n```diff\n-  - ``--random_seed[=seed]`` -- random seed for fuzzing doctests\n+  - ``--random-seed[=seed]`` -- random seed for fuzzing doctests\n```",
    "created_at": "2020-07-10T22:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421768",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:6'></a>Overall, this looks good to me. The following changes seem to be needed:

```diff
-    sage: subprocess.call(["sage", "-t", "--warn-long", "0", "--random-seed=0", -random_seed.rst"], **kwds)  # long time
+    sage: subprocess.call(["sage", "-t", "--warn-long", "0", "--random-seed=0", "random_seed.rst"], **kwds)  # long time
```

```diff
-  - ``--random_seed[=seed]`` -- random seed for fuzzing doctests
+  - ``--random-seed[=seed]`` -- random seed for fuzzing doctests
```



---

archive/issue_comments_421769.json:
```json
{
    "body": "<a id='comment:7'></a>The branch adds this to the documentation, which is not true for this ticket:\n\n```\n--- a/src/doc/en/developer/doctesting.rst\n+++ b/src/doc/en/developer/doctesting.rst\n...\n+Doctests start from a random seed::\n+\n+    [kliem@sage sage-9.2]$ sage -t src/sage/doctest/tests/random_seed.rst\n...\n+    sage -t --warn-long 89.5 --random-seed=112986622569797306072457879734474628454 src/sage/doctest/tests/random_seed.rst\n+    **********************************************************************\n```",
    "created_at": "2020-07-10T23:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421769",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>The branch adds this to the documentation, which is not true for this ticket:

```
--- a/src/doc/en/developer/doctesting.rst
+++ b/src/doc/en/developer/doctesting.rst
...
+Doctests start from a random seed::
+
+    [kliem@sage sage-9.2]$ sage -t src/sage/doctest/tests/random_seed.rst
...
+    sage -t --warn-long 89.5 --random-seed=112986622569797306072457879734474628454 src/sage/doctest/tests/random_seed.rst
+    **********************************************************************
```



---

archive/issue_comments_421770.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2020-07-11T05:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421770",
    "user": "https://github.com/kliem"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_421771.json:
```json
{
    "body": "<a id='comment:9'></a>From my side this is a positive review - if patchbot is green",
    "created_at": "2020-07-11T06:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421771",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>From my side this is a positive review - if patchbot is green



---

archive/issue_comments_421772.json:
```json
{
    "body": "<a id='comment:10'></a>Thanks. This successfully passes ptestlong.",
    "created_at": "2020-07-11T09:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421772",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:10'></a>Thanks. This successfully passes ptestlong.



---

archive/issue_comments_421773.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-11T09:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421773",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421774.json:
```json
{
    "body": "<a id='comment:11'></a>Thank you.",
    "created_at": "2020-07-11T09:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421774",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Thank you.



---

archive/issue_comments_421775.json:
```json
{
    "body": "<a id='comment:12'></a>Merge conflict",
    "created_at": "2020-07-11T23:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421775",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Merge conflict



---

archive/issue_comments_421776.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-07-11T23:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421776",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_421777.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-12T17:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421777",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_421778.json:
```json
{
    "body": "<a id='comment:13'></a>`sage -t --long --all` passes for me.\n\n---\nNew commits:",
    "created_at": "2020-07-12T17:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421778",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>`sage -t --long --all` passes for me.

---
New commits:



---

archive/issue_comments_421779.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-12T17:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421779",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421780.json:
```json
{
    "body": "<a id='comment:15'></a>Thank you.",
    "created_at": "2020-07-12T18:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421780",
    "user": "https://github.com/kliem"
}
```

<a id='comment:15'></a>Thank you.



---

archive/issue_comments_421781.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-19T07:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421781",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_076942.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-19T07:24:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29962#event-76942"
}
```



---

archive/issue_comments_421782.json:
```json
{
    "body": "<a id='comment:17'></a>What random seeds are allowed? Any integer?\nOf any sign? Arbitrarily large?",
    "created_at": "2020-08-23T15:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421782",
    "user": "https://github.com/slel"
}
```

<a id='comment:17'></a>What random seeds are allowed? Any integer?
Of any sign? Arbitrarily large?



---

archive/issue_comments_421783.json:
```json
{
    "body": "<a id='comment:18'></a>This is how we will eventually get the random seeds.\n\n```\nsage: import sage.misc.randstate as randstate                                   \nsage: randstate.set_random_seed()                                               \nsage: randstate.initial_seed()                                                  \n11032378495085541661748859066830408537\n```\n\nAt least that's the plan for now. Any random seed that you can feed into `set_random_seed` should work.\n\n(Edit: But I wouldn't be surprised if there are bugs somewhere with some strange random seed. There is no way, you can avoid all of them. But at least you can prepare for rather probable cases.)",
    "created_at": "2020-08-23T16:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421783",
    "user": "https://github.com/kliem"
}
```

<a id='comment:18'></a>This is how we will eventually get the random seeds.

```
sage: import sage.misc.randstate as randstate                                   
sage: randstate.set_random_seed()                                               
sage: randstate.initial_seed()                                                  
11032378495085541661748859066830408537
```

At least that's the plan for now. Any random seed that you can feed into `set_random_seed` should work.

(Edit: But I wouldn't be surprised if there are bugs somewhere with some strange random seed. There is no way, you can avoid all of them. But at least you can prepare for rather probable cases.)



---

archive/issue_comments_421784.json:
```json
{
    "body": "<a id='comment:19'></a>The `random_seed` docstring says seed \"must be coercible to a Python long\".\n\nIs that from `-2**127` to `2**127 - 1`?\nOr are 32-bit and 64-bit systems different there?\n\nAlso isn't \"long\" a Python 2 concept,\nwith only \"int\" existing in Python 3?\n\nCould we document the admissible range in a follow-up ticket, for non-experts like me?",
    "created_at": "2020-08-23T22:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421784",
    "user": "https://github.com/slel"
}
```

<a id='comment:19'></a>The `random_seed` docstring says seed "must be coercible to a Python long".

Is that from `-2**127` to `2**127 - 1`?
Or are 32-bit and 64-bit systems different there?

Also isn't "long" a Python 2 concept,
with only "int" existing in Python 3?

Could we document the admissible range in a follow-up ticket, for non-experts like me?



---

archive/issue_comments_421785.json:
```json
{
    "body": "<a id='comment:20'></a>And thanks for the work on varying random seeds when testing!",
    "created_at": "2020-08-23T22:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421785",
    "user": "https://github.com/slel"
}
```

<a id='comment:20'></a>And thanks for the work on varying random seeds when testing!



---

archive/issue_comments_421786.json:
```json
{
    "body": "<a id='comment:21'></a>I added this issue to #29935.\n\nThe idea was that once all parts of Sage are ready for it, the default would be to select a \"random\" random seed.",
    "created_at": "2020-08-24T06:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29962",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29962#issuecomment-421786",
    "user": "https://github.com/kliem"
}
```

<a id='comment:21'></a>I added this issue to #29935.

The idea was that once all parts of Sage are ready for it, the default would be to select a "random" random seed.
