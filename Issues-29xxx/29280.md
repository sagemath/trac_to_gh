# Issue 29280: expression parser should support unicode

archive/issues_029043.json:
```json
{
    "body": "This ticket fixes the `Tokenizer` in `sage.misc.parser` to handle unicode strings.\n\nFor example, this fixes these issues:\n\n```\nsage: SR('\u03bb + 2\u03bb')\n...\nSyntaxError: Malformed expression\n...\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xce in position 0: unexpected end of data\n\nsage: QQ['\u03bb']('\u03bb^2')\n...\nSyntaxError: Malformed expression\n```\n\nThis is solved by changing the tokenizer to work with Python strings instead of C-strings. This is also what Cython [recommends to do](http://docs.cython.org/en/latest/src/tutorial/strings.html#general-notes-about-c-strings). The C-strings were only used internally in the tokenizer, so this change should be unproblematic.\n\nNote that this is strictly about tokenizing/parsing of expressions, but not about validating input, even though some interfaces (like Maxima) might not support unicode. It is already possible to construct these expressions by different means, so the parser should support that as well.\n\n\nCC:  @rburing @nbruin @tscrim\n\nBranch/Commit: b83d9aece73a34499c28c3ec4783710e791f8aaf\n\nReviewer: Travis Scrimshaw\n\nAuthor: Markus Wageringel\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29280\n\n",
    "closed_at": "2020-07-10T19:34:23Z",
    "created_at": "2020-03-04T20:15:32Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "expression parser should support unicode",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29280",
    "user": "https://github.com/mwageringel"
}
```
This ticket fixes the `Tokenizer` in `sage.misc.parser` to handle unicode strings.

For example, this fixes these issues:

```
sage: SR('位 + 2位')
...
SyntaxError: Malformed expression
...
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xce in position 0: unexpected end of data

sage: QQ['位']('位^2')
...
SyntaxError: Malformed expression
```

This is solved by changing the tokenizer to work with Python strings instead of C-strings. This is also what Cython [recommends to do](http://docs.cython.org/en/latest/src/tutorial/strings.html#general-notes-about-c-strings). The C-strings were only used internally in the tokenizer, so this change should be unproblematic.

Note that this is strictly about tokenizing/parsing of expressions, but not about validating input, even though some interfaces (like Maxima) might not support unicode. It is already possible to construct these expressions by different means, so the parser should support that as well.


CC:  @rburing @nbruin @tscrim

Branch/Commit: b83d9aece73a34499c28c3ec4783710e791f8aaf

Reviewer: Travis Scrimshaw

Author: Markus Wageringel

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29280





---

archive/issue_comments_563881.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-mwageringel/29280\"",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563881",
    "user": "https://github.com/mwageringel"
}
```

Changing branch from "" to "u/gh-mwageringel/29280"



---

archive/issue_comments_563882.json:
```json
{
    "body": "Changing commit from \"\" to \"65f270aa96a82f48dd010d427b523d0667c94be4\"",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563882",
    "user": "https://github.com/mwageringel"
}
```

Changing commit from "" to "65f270aa96a82f48dd010d427b523d0667c94be4"



---

archive/issue_comments_563883.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563883",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_563884.json:
```json
{
    "body": "Changing author from \"\" to \"Markus Wageringel\"",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563884",
    "user": "https://github.com/mwageringel"
}
```

Changing author from "" to "Markus Wageringel"



---

archive/issue_comments_563885.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis passes the tests with both Python 2 and 3.\n\n---\nNew commits:\n|                                                                                                                                          |                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[65f270a](https://github.com/sagemath/sagetrac-mirror/commit/65f270aa96a82f48dd010d427b523d0667c94be4)|`29280: make expression parser unicode-compatible`|",
    "created_at": "2020-03-04T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563885",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:1'></a>
This passes the tests with both Python 2 and 3.

---
New commits:
|                                                                                                                                          |                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[65f270a](https://github.com/sagemath/sagetrac-mirror/commit/65f270aa96a82f48dd010d427b523d0667c94be4)|`29280: make expression parser unicode-compatible`|



---

archive/issue_comments_563886.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe Python 3 issue which the patchbot found looks like a false positive, caused by the occurence of `<>` in a string.",
    "created_at": "2020-03-06T18:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563886",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:2'></a>
The Python 3 issue which the patchbot found looks like a false positive, caused by the occurence of `<>` in a string.



---

archive/issue_comments_563887.json:
```json
{
    "body": "<a id='comment:3'></a>\nBatch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563887",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_events_091945.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29280#event-91945"
}
```



---

archive/issue_comments_563888.json:
```json
{
    "body": "<a id='comment:5'></a>\nDo you want to make `s` known as a `str` object in the preparser?\n\nAlso, you don't need to mark the tests a `# py3` since we are Python3 only now.",
    "created_at": "2020-07-04T21:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563888",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Do you want to make `s` known as a `str` object in the preparser?

Also, you don't need to mark the tests a `# py3` since we are Python3 only now.



---

archive/issue_comments_563889.json:
```json
{
    "body": "Changing commit from \"65f270aa96a82f48dd010d427b523d0667c94be4\" to \"b83d9aece73a34499c28c3ec4783710e791f8aaf\"",
    "created_at": "2020-07-05T13:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "65f270aa96a82f48dd010d427b523d0667c94be4" to "b83d9aece73a34499c28c3ec4783710e791f8aaf"



---

archive/issue_comments_563890.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------|\n|[b83d9ae](https://github.com/sagemath/sagetrac-mirror/commit/b83d9aece73a34499c28c3ec4783710e791f8aaf)|`29280: fix details`|",
    "created_at": "2020-07-05T13:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------|
|[b83d9ae](https://github.com/sagemath/sagetrac-mirror/commit/b83d9aece73a34499c28c3ec4783710e791f8aaf)|`29280: fix details`|



---

archive/issue_comments_563891.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks for the suggestions. I have updated the branch accordingly.",
    "created_at": "2020-07-05T13:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563891",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:7'></a>
Thanks for the suggestions. I have updated the branch accordingly.



---

archive/issue_comments_563892.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2020-07-05T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563892",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_563893.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-05T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563893",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_563894.json:
```json
{
    "body": "<a id='comment:8'></a>\nThank you.",
    "created_at": "2020-07-05T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563894",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
Thank you.



---

archive/issue_comments_563895.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-10T19:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563895",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_091946.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-10T19:34:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29280#event-91946"
}
```



---

archive/issue_comments_563896.json:
```json
{
    "body": "Changing branch from \"u/gh-mwageringel/29280\" to \"b83d9aece73a34499c28c3ec4783710e791f8aaf\"",
    "created_at": "2020-07-10T19:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29280#issuecomment-563896",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-mwageringel/29280" to "b83d9aece73a34499c28c3ec4783710e791f8aaf"
