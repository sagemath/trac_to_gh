# Issue 29644: spkg-configure.m4 for gap

archive/issues_029407.json:
```json
{
    "body": "CC:  @dimpase @orlitzky @slel @isuruf @antonio-rojas\n\nKeywords: gap; spkg-configure; system packages\n\nThis ticket adds an spkg-configure.m4 for gap, in order to use it from a system package if possible (see #27330).\n\nWith this, the installed gap is well detected, but for sagelib and gap packages to built, several paths must be modified:\n\n- GAP_ROOT_DIR in src/sage/env.py\n\n- GAP_ROOT in build/pkgs/gap_packages/spkg-install.in\n\n- gap directory in src/sage/libs/gap/util.pyx\n\n\nMoreover, the dependency on SAGE_LOCAL needs to be removed. Without it, one currently gets the following error\n\n```\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py\", line 520, in _start\n        raise RuntimeError(\"unable to start %s: %s\" % (self.name(), msg))\n    RuntimeError: unable to start gap: End Of File (EOF). Exception style platform.\n    Gap finished running /__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap -r -b -p -T -E -o 401m -s 401m -m 64m /__w/sagetrac-mirror/sagetrac-mirror/src/sage/ext_data/gap/sage.g\n    command: /__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap\n    args: ['/__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap', '-r', '-b', '-p', '-T', '-E', '-o', '401m', '-s', '401m', '-m', '64m', '/__w/sagetrac-mirror/sagetrac-mirror/src/sage/ext_data/gap/sage.g']\n    buffer (last 100 chars): b''\n    before (last 100 chars): b'Set the environment variable SAGE_LOCAL.\\r\\n'\n    after: <class 'pexpect.exceptions.EOF'>\n    match: None\n    match_index: None\n    exitstatus: 1\n    flag_eof: True\n    pid: 3124\n    child_fd: 26\n    closed: False\n    timeout: None\n    delimiter: <class 'pexpect.exceptions.EOF'>\n    logfile: None\n    logfile_read: None\n    logfile_send: None\n    maxread: 4194304\n    ignorecase: False\n    searchwindowsize: None\n    delaybeforesend: None\n    delayafterclose: 0.1\n    delayafterterminate: 0.1\n    searcher: searcher_re:\n        0: re.compile(b'gap> ')\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/29644\n\n",
    "created_at": "2020-05-04T09:52:49Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "spkg-configure.m4 for gap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29644",
    "user": "https://github.com/thierry-FreeBSD"
}
```
CC:  @dimpase @orlitzky @slel @isuruf @antonio-rojas

Keywords: gap; spkg-configure; system packages

This ticket adds an spkg-configure.m4 for gap, in order to use it from a system package if possible (see #27330).

With this, the installed gap is well detected, but for sagelib and gap packages to built, several paths must be modified:

- GAP_ROOT_DIR in src/sage/env.py

- GAP_ROOT in build/pkgs/gap_packages/spkg-install.in

- gap directory in src/sage/libs/gap/util.pyx


Moreover, the dependency on SAGE_LOCAL needs to be removed. Without it, one currently gets the following error

```
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/interfaces/expect.py", line 520, in _start
        raise RuntimeError("unable to start %s: %s" % (self.name(), msg))
    RuntimeError: unable to start gap: End Of File (EOF). Exception style platform.
    Gap finished running /__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap -r -b -p -T -E -o 401m -s 401m -m 64m /__w/sagetrac-mirror/sagetrac-mirror/src/sage/ext_data/gap/sage.g
    command: /__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap
    args: ['/__w/sagetrac-mirror/sagetrac-mirror/.tox/local-sudo-standard/local/bin/gap', '-r', '-b', '-p', '-T', '-E', '-o', '401m', '-s', '401m', '-m', '64m', '/__w/sagetrac-mirror/sagetrac-mirror/src/sage/ext_data/gap/sage.g']
    buffer (last 100 chars): b''
    before (last 100 chars): b'Set the environment variable SAGE_LOCAL.\r\n'
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: 1
    flag_eof: True
    pid: 3124
    child_fd: 26
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile(b'gap> ')
```

Issue created by migration from https://trac.sagemath.org/ticket/29644





---

archive/issue_comments_416745.json:
```json
{
    "body": "Attachment [spkg-configure.m4](tarball://root/attachments/some-uuid/ticket29644/spkg-configure.m4) by @thierry-FreeBSD created at 2020-05-04 17:49:58\n\nspkg-configure.m4 to be copied under build/pkgs/gap/",
    "created_at": "2020-05-04T17:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416745",
    "user": "https://github.com/thierry-FreeBSD"
}
```

Attachment [spkg-configure.m4](tarball://root/attachments/some-uuid/ticket29644/spkg-configure.m4) by @thierry-FreeBSD created at 2020-05-04 17:49:58

spkg-configure.m4 to be copied under build/pkgs/gap/



---

archive/issue_comments_416746.json:
```json
{
    "body": "system package information also needs to be added",
    "created_at": "2020-08-11T17:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416746",
    "user": "https://github.com/mkoeppe"
}
```

system package information also needs to be added



---

archive/issue_events_075758.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75758"
}
```



---

archive/issue_comments_416747.json:
```json
{
    "body": "Which systems have a usable gap?",
    "created_at": "2020-11-10T23:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416747",
    "user": "https://github.com/mkoeppe"
}
```

Which systems have a usable gap?



---

archive/issue_comments_416748.json:
```json
{
    "body": "I'm using it in the distro sage package with no issues, with the patch from #29314. The only potential problem I'm aware of is that our gap-packages contains all packages shipped in the upstream tarball - this can cause high memory usage if it's installed.",
    "created_at": "2020-11-11T10:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416748",
    "user": "https://github.com/antonio-rojas"
}
```

I'm using it in the distro sage package with no issues, with the patch from #29314. The only potential problem I'm aware of is that our gap-packages contains all packages shipped in the upstream tarball - this can cause high memory usage if it's installed.



---

archive/issue_comments_416749.json:
```json
{
    "body": "Replying to [comment:4 arojas]:\n> I'm using it in the distro sage package with no issues, with the patch from #29314. The only potential problem I'm aware of is that our gap-packages contains all packages shipped in the upstream tarball - this can cause high memory usage if it's installed.\n\n\nI don't think having all the GAP packages used causes any memory problems - the majority are not loaded by GAP by default (and even if they are, their memory footprint is very small).",
    "created_at": "2020-11-11T10:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416749",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:4 arojas]:
> I'm using it in the distro sage package with no issues, with the patch from #29314. The only potential problem I'm aware of is that our gap-packages contains all packages shipped in the upstream tarball - this can cause high memory usage if it's installed.


I don't think having all the GAP packages used causes any memory problems - the majority are not loaded by GAP by default (and even if they are, their memory footprint is very small).



---

archive/issue_comments_416750.json:
```json
{
    "body": "Thierry, can you push a branch here?\nOr would you prefer someone else to commit for you?\n\nThe file `spkg-configure.m4` you attached can be\ncommitted with you as the author using:\n\n```\n$ git commit --author=\"Your Name <your.name@example.com>\"\n```\nwith name and email found from your previous contributions using:\n\n```\n$ git log | grep \"Author: Thierry Thomas\"\n```",
    "created_at": "2021-03-22T01:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416750",
    "user": "https://github.com/slel"
}
```

Thierry, can you push a branch here?
Or would you prefer someone else to commit for you?

The file `spkg-configure.m4` you attached can be
committed with you as the author using:

```
$ git commit --author="Your Name <your.name@example.com>"
```
with name and email found from your previous contributions using:

```
$ git log | grep "Author: Thierry Thomas"
```



---

archive/issue_comments_416751.json:
```json
{
    "body": "Not sure how to address any of the tasks in the ticket description.\n\nBut here is Thierry's `spkg-configure.m4` and some distro info.\n\n---\nNew commits:",
    "created_at": "2021-03-22T02:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416751",
    "user": "https://github.com/slel"
}
```

Not sure how to address any of the tasks in the ticket description.

But here is Thierry's `spkg-configure.m4` and some distro info.

---
New commits:



---

archive/issue_events_075759.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T17:29:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75759"
}
```



---

archive/issue_events_075760.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T17:29:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75760"
}
```



---

archive/issue_comments_416752.json:
```json
{
    "body": "Replying to [comment:5 dimpase]:\n> I don't think having all the GAP packages used causes any memory problems - the majority are not loaded by GAP by default (and even if they are, their memory footprint is very small).\n\n\nThey are not loaded by GAP, but they are by Sage and it does cause problems - see #31761",
    "created_at": "2021-05-01T18:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416752",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:5 dimpase]:
> I don't think having all the GAP packages used causes any memory problems - the majority are not loaded by GAP by default (and even if they are, their memory footprint is very small).


They are not loaded by GAP, but they are by Sage and it does cause problems - see #31761



---

archive/issue_events_075761.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75761"
}
```



---

archive/issue_events_075762.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75762"
}
```



---

archive/issue_events_075763.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75763"
}
```



---

archive/issue_events_075764.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75764"
}
```



---

archive/issue_comments_416753.json:
```json
{
    "body": "We could get the gap root from\n\n```\n$ gap -q --nointeract --bare -r -c 'Display(KERNEL_INFO().GAP_ROOT_PATHS[1]);'\n/usr/share/gap/\n```\n\nThe code in `sage.libs.gap.util.gap_root()` tries to read the gap shell script to figure out the gap root but that doesn't work with the gap shell script shipped by gap. Moreover, it's only used when `sage.env.GAP_ROOT_DIR` is undefined, but this is hardcoded in `src/sage/env.py` to be `SAGE_SHARE/gap`.\n\nMaybe:\n\na. `build/pkgs/gap/spkg-configure.m4`: set `GAP_ROOT` using my suggestion above (while we are at it, check that running `gap` works, which is required by sage and I'm not sure is checked right now).\nb. maybe check that the gap root is ok e.g. by looking for the file `${GAP_ROOT}/sysinfo.gap`.\nc. if gap will not be used from system, unset `GAP_ROOT`\nd. `AC_SUBST(GAP_ROOT)`\ne. in `pkgs/sage-conf/sage_conf.py.in` add a line like\n\n```\nGAP_ROOT_DIR = \"@GAP_ROOT@\" or None\n```\n\nI'm not completely sure how to do (a) and (b) but it's probably easy for someone who understands autoconf.\n\nNote that when not using system gap, `GAP_ROOT_DIR` should be set to None so that the fallback defined in `src/sage/env.py` takes precedence (\"\" is not good enough). Alternatively, when gap will not be used from system, set `GAP_ROOT=\\$SAGE_LOCAL/share/gap` and then have `sage_conf.py` replace `$SAGE_LOCAL` as is done for other variables (and please remove the fallback from `src/sage/env.py`, there's too many different places where variables are set and each package seems to have a different way to do it).",
    "created_at": "2022-01-11T23:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416753",
    "user": "https://github.com/tornaria"
}
```

We could get the gap root from

```
$ gap -q --nointeract --bare -r -c 'Display(KERNEL_INFO().GAP_ROOT_PATHS[1]);'
/usr/share/gap/
```

The code in `sage.libs.gap.util.gap_root()` tries to read the gap shell script to figure out the gap root but that doesn't work with the gap shell script shipped by gap. Moreover, it's only used when `sage.env.GAP_ROOT_DIR` is undefined, but this is hardcoded in `src/sage/env.py` to be `SAGE_SHARE/gap`.

Maybe:

a. `build/pkgs/gap/spkg-configure.m4`: set `GAP_ROOT` using my suggestion above (while we are at it, check that running `gap` works, which is required by sage and I'm not sure is checked right now).
b. maybe check that the gap root is ok e.g. by looking for the file `${GAP_ROOT}/sysinfo.gap`.
c. if gap will not be used from system, unset `GAP_ROOT`
d. `AC_SUBST(GAP_ROOT)`
e. in `pkgs/sage-conf/sage_conf.py.in` add a line like

```
GAP_ROOT_DIR = "@GAP_ROOT@" or None
```

I'm not completely sure how to do (a) and (b) but it's probably easy for someone who understands autoconf.

Note that when not using system gap, `GAP_ROOT_DIR` should be set to None so that the fallback defined in `src/sage/env.py` takes precedence ("" is not good enough). Alternatively, when gap will not be used from system, set `GAP_ROOT=\$SAGE_LOCAL/share/gap` and then have `sage_conf.py` replace `$SAGE_LOCAL` as is done for other variables (and please remove the fallback from `src/sage/env.py`, there's too many different places where variables are set and each package seems to have a different way to do it).



---

archive/issue_comments_416754.json:
```json
{
    "body": "Replying to [comment:13 tornaria]:\n> We could get the gap root from\n> \n> ```\n> $ gap -q --nointeract --bare -r -c 'Display(KERNEL_INFO().GAP_ROOT_PATHS[1]);'\n> /usr/share/gap/\n> ```\n> \n\nDoesn't work for me on Debian 11:\n\n```\ndimpase@penguin:~/tmp$ gap -q --nointeract --bare -r -c 'Display(KERNEL_INFO().GAP_ROOT_PATHS[1]);'\n/home/dimpase/gap/\ndimpase@penguin:~/tmp$ ls /home/dimpase/gap\nls: cannot access '/home/dimpase/gap': No such file or directory\ndimpase@penguin:~/tmp$ which gap\n/usr/bin/gap\ndimpase@penguin:~/tmp$ gap\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   GAP 4.11.0 of 29-Feb-2020\n \u2502  GAP  \u2502   https://www.gap-system.org\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   Architecture: x86_64-pc-linux-gnu-default64-kv7\n Configuration:  gmp 6.2.1, GASMAN, readline\n Loading the library and packages ...\n Packages:   Alnuth 3.1.2, AtlasRep 2.1.0, AutPGrp 1.10.2, CTblLib 1.3.1, \n             FactInt 1.6.3, GAPDoc 1.6.3, IO 4.7.0, Polycyclic 2.15.1, PrimGrp 3.4.0, \n             SmallGrp 1.4.1, TomLib 1.2.9, TransGrp 2.0.6\n Try '??help' for help. See also '?copyright', '?cite' and '?authors'\ngap> \n```",
    "created_at": "2022-01-12T13:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416754",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:13 tornaria]:
> We could get the gap root from
> 
> ```
> $ gap -q --nointeract --bare -r -c 'Display(KERNEL_INFO().GAP_ROOT_PATHS[1]);'
> /usr/share/gap/
> ```
> 

Doesn't work for me on Debian 11:

```
dimpase@penguin:~/tmp$ gap -q --nointeract --bare -r -c 'Display(KERNEL_INFO().GAP_ROOT_PATHS[1]);'
/home/dimpase/gap/
dimpase@penguin:~/tmp$ ls /home/dimpase/gap
ls: cannot access '/home/dimpase/gap': No such file or directory
dimpase@penguin:~/tmp$ which gap
/usr/bin/gap
dimpase@penguin:~/tmp$ gap
 ┌───────┐   GAP 4.11.0 of 29-Feb-2020
 │  GAP  │   https://www.gap-system.org
 └───────┘   Architecture: x86_64-pc-linux-gnu-default64-kv7
 Configuration:  gmp 6.2.1, GASMAN, readline
 Loading the library and packages ...
 Packages:   Alnuth 3.1.2, AtlasRep 2.1.0, AutPGrp 1.10.2, CTblLib 1.3.1, 
             FactInt 1.6.3, GAPDoc 1.6.3, IO 4.7.0, Polycyclic 2.15.1, PrimGrp 3.4.0, 
             SmallGrp 1.4.1, TomLib 1.2.9, TransGrp 2.0.6
 Try '??help' for help. See also '?copyright', '?cite' and '?authors'
gap> 
```



---

archive/issue_comments_416755.json:
```json
{
    "body": "In case, here is my GAP_ROOT_PATHS:\n\n```\n  GAP_ROOT_PATHS := [ \"/home/dimpase/.gap/\", \"/home/dimpase/gap/\", \n      \"/usr/local/lib/gap/\", \"/usr/local/share/gap/\", \"/usr/lib/gap/\", \n      \"/usr/share/gap/\" ]\n```",
    "created_at": "2022-01-12T13:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416755",
    "user": "https://github.com/dimpase"
}
```

In case, here is my GAP_ROOT_PATHS:

```
  GAP_ROOT_PATHS := [ "/home/dimpase/.gap/", "/home/dimpase/gap/", 
      "/usr/local/lib/gap/", "/usr/local/share/gap/", "/usr/lib/gap/", 
      "/usr/share/gap/" ]
```



---

archive/issue_comments_416756.json:
```json
{
    "body": "What are `GAPInfo.UserGapRoot` and `KERNEL_INFO().GAP_ROOT_PATHS` with and without `-r`?\n\nHere I get:\n\n```\n$ gap --norepl --bare -b -c 'Display(GAPInfo.UserGapRoot); Display(KERNEL_INFO().GAP_ROOT_PATHS);'\n/home/tornaria/.gap\n[ \"/home/tornaria/.gap/\", \"/usr/share/gap/\" ]\n$ gap -r --norepl --bare -b -c 'Display(GAPInfo.UserGapRoot); Display(KERNEL_INFO().GAP_ROOT_PATHS);'\n/home/tornaria/.gap\n[ \"/usr/share/gap/\" ]\n```\nUsing `-r` prevents `UserGapRoot` to be prepended to `GAP_ROOT_PATHS`. It seems your `GAP_ROOT_PATHS` already has a user directory and other locations.\n\nWhich one is the \"real\" gap root? I think it should be either the one containing `sysinfo.gap` or else the one containing `lib/init.g`.\n\nAlternatively, use the whole list of `GAP_ROOT_PATHS`, so that sage passes all of them to gap when initializing the library. This would need to rework `sage.libs.gap.util.gap_root()` so it accepts multiple directories (and it's not necessary for all directories to exist, it suffices that at least one contains `lib/init.g`).\n\nTo get the complete list for `GAP_ROOT_PATHS` we can use this:\n\n```\n$ gap -q --nointeract --bare -r -c 'Display(JoinStringsWithSeparator(KERNEL_INFO().GAP_ROOT_PATHS,\";\"));'\n/usr/share/gap/\n```\nFor me it gives the same since I only have one path in the system gap root, but for you it should give all of them.",
    "created_at": "2022-01-12T15:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416756",
    "user": "https://github.com/tornaria"
}
```

What are `GAPInfo.UserGapRoot` and `KERNEL_INFO().GAP_ROOT_PATHS` with and without `-r`?

Here I get:

```
$ gap --norepl --bare -b -c 'Display(GAPInfo.UserGapRoot); Display(KERNEL_INFO().GAP_ROOT_PATHS);'
/home/tornaria/.gap
[ "/home/tornaria/.gap/", "/usr/share/gap/" ]
$ gap -r --norepl --bare -b -c 'Display(GAPInfo.UserGapRoot); Display(KERNEL_INFO().GAP_ROOT_PATHS);'
/home/tornaria/.gap
[ "/usr/share/gap/" ]
```
Using `-r` prevents `UserGapRoot` to be prepended to `GAP_ROOT_PATHS`. It seems your `GAP_ROOT_PATHS` already has a user directory and other locations.

Which one is the "real" gap root? I think it should be either the one containing `sysinfo.gap` or else the one containing `lib/init.g`.

Alternatively, use the whole list of `GAP_ROOT_PATHS`, so that sage passes all of them to gap when initializing the library. This would need to rework `sage.libs.gap.util.gap_root()` so it accepts multiple directories (and it's not necessary for all directories to exist, it suffices that at least one contains `lib/init.g`).

To get the complete list for `GAP_ROOT_PATHS` we can use this:

```
$ gap -q --nointeract --bare -r -c 'Display(JoinStringsWithSeparator(KERNEL_INFO().GAP_ROOT_PATHS,";"));'
/usr/share/gap/
```
For me it gives the same since I only have one path in the system gap root, but for you it should give all of them.



---

archive/issue_comments_416757.json:
```json
{
    "body": "Something like that seems to work as a fallback in case `GAP_ROOT_DIR` is not set:\n\n```\n--- sage-9.5.rc0/src/sage/libs/gap/util.pyx.orig\t2022-01-09 07:49:26.000000000 -0300\n+++ sage-9.5.rc0/src/sage/libs/gap/util.pyx\t2022-01-13 01:57:11.072897453 -0300\n@@ -178,6 +178,11 @@\n     if os.path.exists(sage.env.GAP_ROOT_DIR):\n         return sage.env.GAP_ROOT_DIR\n \n+    from sage.interfaces.gap import gap\n+    for gapdir in gap(\"KERNEL_INFO().GAP_ROOT_PATHS\").sage():\n+        if os.path.exists(os.path.join(gapdir, 'sysinfo.gap')):\n+            return gapdir\n+\n     # Attempt to figure out the appropriate GAP_ROOT by reading the\n     # local/bin/gap shell script; this is an ugly hack that exists for\n     # historical reasons; the best approach to setting where Sage looks for\n```\nThe drawback is that this will launch and keep running the gap interpreter. Maybe better to do a one-time run of gap just for this purpose (or run it at configure time as I proposed above).",
    "created_at": "2022-01-13T05:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416757",
    "user": "https://github.com/tornaria"
}
```

Something like that seems to work as a fallback in case `GAP_ROOT_DIR` is not set:

```
--- sage-9.5.rc0/src/sage/libs/gap/util.pyx.orig	2022-01-09 07:49:26.000000000 -0300
+++ sage-9.5.rc0/src/sage/libs/gap/util.pyx	2022-01-13 01:57:11.072897453 -0300
@@ -178,6 +178,11 @@
     if os.path.exists(sage.env.GAP_ROOT_DIR):
         return sage.env.GAP_ROOT_DIR
 
+    from sage.interfaces.gap import gap
+    for gapdir in gap("KERNEL_INFO().GAP_ROOT_PATHS").sage():
+        if os.path.exists(os.path.join(gapdir, 'sysinfo.gap')):
+            return gapdir
+
     # Attempt to figure out the appropriate GAP_ROOT by reading the
     # local/bin/gap shell script; this is an ugly hack that exists for
     # historical reasons; the best approach to setting where Sage looks for
```
The drawback is that this will launch and keep running the gap interpreter. Maybe better to do a one-time run of gap just for this purpose (or run it at configure time as I proposed above).



---

archive/issue_comments_416758.json:
```json
{
    "body": "Maybe this is better:\n\n```\n--- a/src/sage/libs/gap/util.pyx\n+++ b/src/sage/libs/gap/util.pyx\n@@ -23,6 +23,7 @@ from cysignals.signals cimport sig_on, sig_off\n import os\n import warnings\n import sage.env\n+import subprocess\n \n from .gap_includes cimport *\n from .element cimport *\n@@ -178,6 +179,16 @@ def gap_root():\n     if os.path.exists(sage.env.GAP_ROOT_DIR):\n         return sage.env.GAP_ROOT_DIR\n \n+    gap_expr = 'JoinStringsWithSeparator(KERNEL_INFO().GAP_ROOT_PATHS,\";\")'\n+    gap_root_paths = subprocess.getoutput(\n+        f\"gap -r -q --bare --nointeract -c 'Display({gap_expr});'\"\n+        ).strip().split(';')\n+\n+    for gapdir in gap_root_paths:\n+        if os.path.exists(os.path.join(gapdir, 'sysinfo.gap')):\n+            sage.env.GAP_ROOT_DIR = gapdir\n+            return gapdir\n+\n     # Attempt to figure out the appropriate GAP_ROOT by reading the\n     # local/bin/gap shell script; this is an ugly hack that exists for\n     # historical reasons; the best approach to setting where Sage looks for\n```\n\nAlso, `sage.env._get_shared_lib_path()` is broken in the sense that it looks for `libgap.so` but it should really look for `libgap.so*`. Indeed the soname for the library is `libgap.so.0` and the symlink `libgap.so -> libgap.so.0` is only provided by `gap-devel` package (which is installed when I build sage, but not necessarily when I run sage).\n\nSimple fix:\n\n```\n--- a/src/sage/env.py\n+++ b/src/sage/env.py\n@@ -293,7 +293,7 @@ def _get_shared_lib_path(*libnames: str) -> Optional[str]:\n             if sys.platform == 'darwin':\n                 ext = 'dylib'\n             else:\n-                ext = 'so'\n+                ext = 'so*'\n \n             if SAGE_LOCAL:\n                 search_directories.append(Path(SAGE_LOCAL) / 'lib')\n```\n\nOTOH, there's `sage.misc.compat.find_library`, maybe that could be used instead.\n\nFinally, there's a test in `src/sage_setup/optional_extension.py` that fails when gap is installed from system so\n\n```\n--- a/src/sage_setup/optional_extension.py\n+++ b/src/sage_setup/optional_extension.py\n@@ -80,7 +80,7 @@ def OptionalExtension(*args, **kwds):\n         sage: print(ext.__class__.__name__)\n         CythonizeExtension\n         sage: ext = OptionalExtension(\"foo\", [\"foo.c\"], package=\"gap\")\n-        sage: print(ext.__class__.__name__)\n+        sage: print(ext.__class__.__name__)     # not tested - fails with system gap\n         Extension\n     \"\"\"\n     try:\n```\n\nI also changed `GAP_ROOT_DIR` for `gap_root()` in\n`src/sage/libs/gap/saved_workspace.py`:\n\n```\n--- a/src/sage/libs/gap/saved_workspace.py\n+++ b/src/sage/libs/gap/saved_workspace.py\n@@ -8,7 +8,7 @@ workspaces.\n\n import os\n import glob\n-from sage.env import GAP_ROOT_DIR\n+from sage.libs.gap.util import gap_root\n from sage.interfaces.gap_workspace import gap_workspace_file\n\n\n@@ -31,7 +31,7 @@ def timestamp():\n     \"\"\"\n     libgap_dir = os.path.dirname(__file__)\n     libgap_files = glob.glob(os.path.join(libgap_dir, '*'))\n-    gap_packages = glob.glob(os.path.join(GAP_ROOT_DIR, 'pkg', '*'))\n+    gap_packages = glob.glob(os.path.join(gap_root(), 'pkg', '*'))\n     files = libgap_files + gap_packages\n     if len(files) == 0:\n         print('Unable to find LibGAP files.')\n```",
    "created_at": "2022-01-13T09:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416758",
    "user": "https://github.com/tornaria"
}
```

Maybe this is better:

```
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -23,6 +23,7 @@ from cysignals.signals cimport sig_on, sig_off
 import os
 import warnings
 import sage.env
+import subprocess
 
 from .gap_includes cimport *
 from .element cimport *
@@ -178,6 +179,16 @@ def gap_root():
     if os.path.exists(sage.env.GAP_ROOT_DIR):
         return sage.env.GAP_ROOT_DIR
 
+    gap_expr = 'JoinStringsWithSeparator(KERNEL_INFO().GAP_ROOT_PATHS,";")'
+    gap_root_paths = subprocess.getoutput(
+        f"gap -r -q --bare --nointeract -c 'Display({gap_expr});'"
+        ).strip().split(';')
+
+    for gapdir in gap_root_paths:
+        if os.path.exists(os.path.join(gapdir, 'sysinfo.gap')):
+            sage.env.GAP_ROOT_DIR = gapdir
+            return gapdir
+
     # Attempt to figure out the appropriate GAP_ROOT by reading the
     # local/bin/gap shell script; this is an ugly hack that exists for
     # historical reasons; the best approach to setting where Sage looks for
```

Also, `sage.env._get_shared_lib_path()` is broken in the sense that it looks for `libgap.so` but it should really look for `libgap.so*`. Indeed the soname for the library is `libgap.so.0` and the symlink `libgap.so -> libgap.so.0` is only provided by `gap-devel` package (which is installed when I build sage, but not necessarily when I run sage).

Simple fix:

```
--- a/src/sage/env.py
+++ b/src/sage/env.py
@@ -293,7 +293,7 @@ def _get_shared_lib_path(*libnames: str) -> Optional[str]:
             if sys.platform == 'darwin':
                 ext = 'dylib'
             else:
-                ext = 'so'
+                ext = 'so*'
 
             if SAGE_LOCAL:
                 search_directories.append(Path(SAGE_LOCAL) / 'lib')
```

OTOH, there's `sage.misc.compat.find_library`, maybe that could be used instead.

Finally, there's a test in `src/sage_setup/optional_extension.py` that fails when gap is installed from system so

```
--- a/src/sage_setup/optional_extension.py
+++ b/src/sage_setup/optional_extension.py
@@ -80,7 +80,7 @@ def OptionalExtension(*args, **kwds):
         sage: print(ext.__class__.__name__)
         CythonizeExtension
         sage: ext = OptionalExtension("foo", ["foo.c"], package="gap")
-        sage: print(ext.__class__.__name__)
+        sage: print(ext.__class__.__name__)     # not tested - fails with system gap
         Extension
     """
     try:
```

I also changed `GAP_ROOT_DIR` for `gap_root()` in
`src/sage/libs/gap/saved_workspace.py`:

```
--- a/src/sage/libs/gap/saved_workspace.py
+++ b/src/sage/libs/gap/saved_workspace.py
@@ -8,7 +8,7 @@ workspaces.

 import os
 import glob
-from sage.env import GAP_ROOT_DIR
+from sage.libs.gap.util import gap_root
 from sage.interfaces.gap_workspace import gap_workspace_file


@@ -31,7 +31,7 @@ def timestamp():
     """
     libgap_dir = os.path.dirname(__file__)
     libgap_files = glob.glob(os.path.join(libgap_dir, '*'))
-    gap_packages = glob.glob(os.path.join(GAP_ROOT_DIR, 'pkg', '*'))
+    gap_packages = glob.glob(os.path.join(gap_root(), 'pkg', '*'))
     files = libgap_files + gap_packages
     if len(files) == 0:
         print('Unable to find LibGAP files.')
```



---

archive/issue_comments_416759.json:
```json
{
    "body": "How about asking GAP people (or doing a PR) to provide an appropriate feature? Which one does really matter? The one with `sysinfo.gap` ?\n\nDid you look at how this is done in https://github.com/embray/gappy ?",
    "created_at": "2022-01-14T12:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416759",
    "user": "https://github.com/dimpase"
}
```

How about asking GAP people (or doing a PR) to provide an appropriate feature? Which one does really matter? The one with `sysinfo.gap` ?

Did you look at how this is done in https://github.com/embray/gappy ?



---

archive/issue_comments_416760.json:
```json
{
    "body": "Replying to [comment:19 dimpase]:\n> How about asking GAP people (or doing a PR) to provide an appropriate feature? Which one does really matter? The one with `sysinfo.gap` ?\n> \n> Did you look at how this is done in https://github.com/embray/gappy ?\n\n\nTL;DR: if the shared library for gap is in `/PATH/TO/lib/`, then try `GAP_ROOT=/PATH/TO/share/gap`. Decide the path is correct if a file `$GAP_ROOT/lib/init.g` exists.\n\nThis seems ok to me, in principle the path to the gap library is in `GAP_SO`.",
    "created_at": "2022-01-14T14:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416760",
    "user": "https://github.com/tornaria"
}
```

Replying to [comment:19 dimpase]:
> How about asking GAP people (or doing a PR) to provide an appropriate feature? Which one does really matter? The one with `sysinfo.gap` ?
> 
> Did you look at how this is done in https://github.com/embray/gappy ?


TL;DR: if the shared library for gap is in `/PATH/TO/lib/`, then try `GAP_ROOT=/PATH/TO/share/gap`. Decide the path is correct if a file `$GAP_ROOT/lib/init.g` exists.

This seems ok to me, in principle the path to the gap library is in `GAP_SO`.



---

archive/issue_comments_416761.json:
```json
{
    "body": "For `GAP_SO` see #33446 which intends to make it no longer necessary. The patch to `_get_shared_lib_path()` would not be used either.",
    "created_at": "2022-03-04T18:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416761",
    "user": "https://github.com/tornaria"
}
```

For `GAP_SO` see #33446 which intends to make it no longer necessary. The patch to `_get_shared_lib_path()` would not be used either.



---

archive/issue_events_075765.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75765"
}
```



---

archive/issue_events_075766.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75766"
}
```



---

archive/issue_comments_416762.json:
```json
{
    "body": "Notes about `GAP_ROOT_DIR`:\n\n- my patches in comment:17 and comment:18 are not good, because running `gap` at sage runtime is too costly (about 0.7s in my box, which would double sage initialization time).\n- sage installs all the gap packages in a single directory `$SAGE_LOCAL/share/gap`. However, system gap may have packages split in more than one location (e.g. debian uses `/usr/share/gap` and `/usr/lib/gap`, the latter to place compiled portions of packages).\n\nMaybe the `GAP_ROOT_DIR` variable should be replaced by a `GAP_ROOT_PATHS` variable to be determined at configure time with some magic. Distros could override this variable as usual.",
    "created_at": "2022-03-06T15:53:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29644#issuecomment-416762",
    "user": "https://github.com/tornaria"
}
```

Notes about `GAP_ROOT_DIR`:

- my patches in comment:17 and comment:18 are not good, because running `gap` at sage runtime is too costly (about 0.7s in my box, which would double sage initialization time).
- sage installs all the gap packages in a single directory `$SAGE_LOCAL/share/gap`. However, system gap may have packages split in more than one location (e.g. debian uses `/usr/share/gap` and `/usr/lib/gap`, the latter to place compiled portions of packages).

Maybe the `GAP_ROOT_DIR` variable should be replaced by a `GAP_ROOT_PATHS` variable to be determined at configure time with some magic. Distros could override this variable as usual.



---

archive/issue_events_075767.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75767"
}
```



---

archive/issue_events_075768.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29644",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29644#event-75768"
}
```
