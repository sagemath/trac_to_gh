# Issue 29071: verify if cblas.pc and lapack.pc should be replaced by links to openblas.pc

archive/issues_028834.json:
```json
{
    "body": "currently openblas's spkg-configure.pc unconditionally makes cblas.pc and lapack.pc copies of openblas.pc, which in some cases if incorrect, e.g. Arch Linux has libcblas linked to libopenblas\nand containing stuff missing in libopenblas, resulting in errors.\n\nthis has been reported on sage-devel\nhttps://groups.google.com/d/msg/sage-devel/pIOnFyFJMtM/_FbzM2OxCQAJ\n\nSo we should make these installations conditional.\n\nCC:  @isuruf @mkoeppe @antonio-rojas\n\nReviewer: Isuru Fernando, Matthias Koeppe\n\nAuthor: Dima Pasechnik\n\nBranch: 3a4524e4c82840fb023a0fd2af83d0a1c65292cd\n\nDependencies: #29051\n\nCommit: 3a4524e4c82840fb023a0fd2af83d0a1c65292cd\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29071\n\n",
    "closed_at": "2020-01-31T23:49:32Z",
    "created_at": "2020-01-23T17:18:01Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "verify if cblas.pc and lapack.pc should be replaced by links to openblas.pc",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29071",
    "user": "https://github.com/dimpase"
}
```
currently openblas's spkg-configure.pc unconditionally makes cblas.pc and lapack.pc copies of openblas.pc, which in some cases if incorrect, e.g. Arch Linux has libcblas linked to libopenblas
and containing stuff missing in libopenblas, resulting in errors.

this has been reported on sage-devel
https://groups.google.com/d/msg/sage-devel/pIOnFyFJMtM/_FbzM2OxCQAJ

So we should make these installations conditional.

CC:  @isuruf @mkoeppe @antonio-rojas

Reviewer: Isuru Fernando, Matthias Koeppe

Author: Dima Pasechnik

Branch: 3a4524e4c82840fb023a0fd2af83d0a1c65292cd

Dependencies: #29051

Commit: 3a4524e4c82840fb023a0fd2af83d0a1c65292cd

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29071





---

archive/issue_comments_407217.json:
```json
{
    "body": "<a id='comment:1'></a>> It depends on the fortran name mangling. For gfortran, one symbol would be dgeqrf_.\n\n\nwe can do an `AC_LINK_IFELSE()` test with a subroutine `dgeqef` call,\nand try to link it against libopenblas. this would be independent of Fortran compiler.\n\nhttp://www.netlib.org/lapack/explore-html/df/dc5/group__variants_g_ecomputational_ga3766ea903391b5cf9008132f7440ec7b.html",
    "created_at": "2020-01-23T19:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407217",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>> It depends on the fortran name mangling. For gfortran, one symbol would be dgeqrf_.


we can do an `AC_LINK_IFELSE()` test with a subroutine `dgeqef` call,
and try to link it against libopenblas. this would be independent of Fortran compiler.

http://www.netlib.org/lapack/explore-html/df/dc5/group__variants_g_ecomputational_ga3766ea903391b5cf9008132f7440ec7b.html



---

archive/issue_comments_407218.json:
```json
{
    "body": "<a id='comment:2'></a>And for cblas we can do `AC_CHECK_LIB()` on `cblas_dgemm`, as Antonio proposed.",
    "created_at": "2020-01-23T19:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407218",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>And for cblas we can do `AC_CHECK_LIB()` on `cblas_dgemm`, as Antonio proposed.



---

archive/issue_comments_407219.json:
```json
{
    "body": "<a id='comment:3'></a>You can also use `AC_FC_FUNC` to get the mangled name.",
    "created_at": "2020-01-23T19:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407219",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:3'></a>You can also use `AC_FC_FUNC` to get the mangled name.



---

archive/issue_comments_407220.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 isuruf]:\n> You can also use `AC_FC_FUNC` to get the mangled name.\n\nOK, that's better, thanks.",
    "created_at": "2020-01-23T19:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407220",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>Replying to [comment:3 isuruf]:
> You can also use `AC_FC_FUNC` to get the mangled name.

OK, that's better, thanks.



---

archive/issue_comments_407221.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-24T11:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407221",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_407222.json:
```json
{
    "body": "<a id='comment:5'></a>needs testing on Arch in particular.\n\n---\nNew commits:",
    "created_at": "2020-01-24T11:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407222",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>needs testing on Arch in particular.

---
New commits:



---

archive/issue_comments_407223.json:
```json
{
    "body": "<a id='comment:6'></a>trying now on arch",
    "created_at": "2020-01-24T12:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407223",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>trying now on arch



---

archive/issue_comments_407224.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-24T12:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_407225.json:
```json
{
    "body": "<a id='comment:8'></a>With the branch applied, I end up with the same permission issues as with `./configure --without-system-openblas`. That is to say\n\n```\nCopying package files from temporary location /opt/sage/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /opt/sage/local\ncp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/blas.pc': Permission denied\ncp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/cblas.pc': Permission denied\ncp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/lapack.pc': Permission denied\n```",
    "created_at": "2020-01-24T12:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407225",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>With the branch applied, I end up with the same permission issues as with `./configure --without-system-openblas`. That is to say

```
Copying package files from temporary location /opt/sage/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /opt/sage/local
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/blas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/cblas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/lapack.pc': Permission denied
```



---

archive/issue_comments_407226.json:
```json
{
    "body": "<a id='comment:9'></a>Is /opt/sage/local your $SAGE_LOCAL?\nIf so, could you try `rm -rf /opt/sage/local/pkgconfig/` ?",
    "created_at": "2020-01-24T12:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407226",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>Is /opt/sage/local your $SAGE_LOCAL?
If so, could you try `rm -rf /opt/sage/local/pkgconfig/` ?



---

archive/issue_comments_407227.json:
```json
{
    "body": "<a id='comment:10'></a>sorry, I meant `rm -rf /opt/sage/local/lib/pkgconfig/`",
    "created_at": "2020-01-24T12:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407227",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>sorry, I meant `rm -rf /opt/sage/local/lib/pkgconfig/`



---

archive/issue_comments_407228.json:
```json
{
    "body": "<a id='comment:11'></a>even more precisely, `rm -f /opt/sage/local/lib/pkgconfig/*blas.pc && rm -f /opt/sage/local/lib/pkgconfig/lapack.pc`",
    "created_at": "2020-01-24T12:38:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407228",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>even more precisely, `rm -f /opt/sage/local/lib/pkgconfig/*blas.pc && rm -f /opt/sage/local/lib/pkgconfig/lapack.pc`



---

archive/issue_comments_407229.json:
```json
{
    "body": "<a id='comment:12'></a>I presume you get permission problems while running `make`. This is due to #29003 - where the installation of these is done somewhat carelessly.",
    "created_at": "2020-01-24T12:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407229",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>I presume you get permission problems while running `make`. This is due to #29003 - where the installation of these is done somewhat carelessly.



---

archive/issue_comments_407230.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-24T13:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_407231.json:
```json
{
    "body": "<a id='comment:14'></a>When I do `make distclean` it does remove `local` entirely. At which step do you want me to try `rm XXX`?",
    "created_at": "2020-01-24T13:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407231",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>When I do `make distclean` it does remove `local` entirely. At which step do you want me to try `rm XXX`?



---

archive/issue_comments_407232.json:
```json
{
    "body": "<a id='comment:15'></a>the logic of this branch is still not 100% correct - if we end up installing OpenBLAS we should not install any *.pc files, i.e. should not run any `AC_CONFIG_LINKS`.",
    "created_at": "2020-01-24T13:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407232",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>the logic of this branch is still not 100% correct - if we end up installing OpenBLAS we should not install any *.pc files, i.e. should not run any `AC_CONFIG_LINKS`.



---

archive/issue_comments_407233.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 vdelecroix]:\n> When I do `make distclean` it does remove `local` entirely. At which step do you want me to try `rm XXX`?\n\n\nthese `rm` from comment:11 should be run after `./configure` and before `make`, assuming I understand what's going on.",
    "created_at": "2020-01-24T13:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407233",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>Replying to [comment:14 vdelecroix]:
> When I do `make distclean` it does remove `local` entirely. At which step do you want me to try `rm XXX`?


these `rm` from comment:11 should be run after `./configure` and before `make`, assuming I understand what's going on.



---

archive/issue_comments_407234.json:
```json
{
    "body": "<a id='comment:17'></a>By the way, please pull the branch again - comment:13 is rather important for Arch.",
    "created_at": "2020-01-24T13:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407234",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>By the way, please pull the branch again - comment:13 is rather important for Arch.



---

archive/issue_comments_407235.json:
```json
{
    "body": "<a id='comment:18'></a>After `./configure` there is no directory `local/lib/pkgconfig/`\n\n```\n$ ls -R local/\nlocal/:\nbin  etc  include  lib  lib64  share  var\n\nlocal/bin:\n\nlocal/etc:\n\nlocal/include:\n\nlocal/lib:\n\nlocal/share:\n\nlocal/var:\nlib\n\nlocal/var/lib:\nsage\n\nlocal/var/lib/sage:\ninstalled\n\nlocal/var/lib/sage/installed:\n```",
    "created_at": "2020-01-24T13:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407235",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>After `./configure` there is no directory `local/lib/pkgconfig/`

```
$ ls -R local/
local/:
bin  etc  include  lib  lib64  share  var

local/bin:

local/etc:

local/include:

local/lib:

local/share:

local/var:
lib

local/var/lib:
sage

local/var/lib/sage:
installed

local/var/lib/sage/installed:
```



---

archive/issue_comments_407236.json:
```json
{
    "body": "<a id='comment:19'></a>`local/lib/pkgconfig/` may or may not be present, it depends upon the state of the system.\n(e.g. if you did `make distclean` before `./configure` you won't have\n`local/` at all)\n\nNow, what happens if you run `make`? Do you still get the same error?",
    "created_at": "2020-01-24T14:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407236",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>`local/lib/pkgconfig/` may or may not be present, it depends upon the state of the system.
(e.g. if you did `make distclean` before `./configure` you won't have
`local/` at all)

Now, what happens if you run `make`? Do you still get the same error?



---

archive/issue_comments_407237.json:
```json
{
    "body": "<a id='comment:20'></a>It seems I got Arch running in an lxc container, so I guess I can polish it on my own.",
    "created_at": "2020-01-24T15:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407237",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>It seems I got Arch running in an lxc container, so I guess I can polish it on my own.



---

archive/issue_comments_407238.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-24T18:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407238",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_407239.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-24T22:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407239",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_407240.json:
```json
{
    "body": "<a id='comment:23'></a>with this last commit appears to work on Arch (with openblas from the system), all the way to the point of a broken scipy build - probably #29051.",
    "created_at": "2020-01-24T23:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407240",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>with this last commit appears to work on Arch (with openblas from the system), all the way to the point of a broken scipy build - probably #29051.



---

archive/issue_comments_407241.json:
```json
{
    "body": "<a id='comment:24'></a>If I'm reading the code correctly `openblas.pc` is not copied to `blas.pc` right in the Arch Linux case right?",
    "created_at": "2020-01-24T23:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407241",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:24'></a>If I'm reading the code correctly `openblas.pc` is not copied to `blas.pc` right in the Arch Linux case right?



---

archive/issue_comments_407242.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 isuruf]:\n> If I'm reading the code correctly `openblas.pc` is not copied to `blas.pc` right in the Arch Linux case right?\n\n\nit is copied (i.e. blas.pc becomes a link to openblas.pc), but on Arch it makes no difference, as they are also like this on the system\n\n```\n[dimpase@arch]$ file /usr/lib/pkgconfig/blas.pc \n/usr/lib/pkgconfig/blas.pc: symbolic link to openblas.pc\n```",
    "created_at": "2020-01-24T23:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407242",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>Replying to [comment:24 isuruf]:
> If I'm reading the code correctly `openblas.pc` is not copied to `blas.pc` right in the Arch Linux case right?


it is copied (i.e. blas.pc becomes a link to openblas.pc), but on Arch it makes no difference, as they are also like this on the system

```
[dimpase@arch]$ file /usr/lib/pkgconfig/blas.pc 
/usr/lib/pkgconfig/blas.pc: symbolic link to openblas.pc
```



---

archive/issue_comments_407243.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-24T23:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407243",
    "user": "https://github.com/isuruf"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_407244.json:
```json
{
    "body": "<a id='comment:26'></a>Thanks. I misread the code",
    "created_at": "2020-01-24T23:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407244",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:26'></a>Thanks. I misread the code



---

archive/issue_comments_407245.json:
```json
{
    "body": "<a id='comment:27'></a>with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)",
    "created_at": "2020-01-25T13:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407245",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)



---

archive/issue_comments_407246.json:
```json
{
    "body": "<a id='comment:28'></a>Does not work on my arch... At commit `2941411`, the build of `fflas-ffpack` failed with\n\n```\n../../../fflas-ffpack/fflas/fflas_fassign.inl: In function 'void FFLAS::fassign(const Field&, size_t, typename Field::ConstElement_ptr, size_t, typename Field::Element_ptr, size_t) [with Field = Givaro::Modular<f\nloat>; size_t = long unsigned int; typename Field::ConstElement_ptr = const float*; typename Field::Element_ptr = float*]':\n../../../fflas-ffpack/fflas/fflas_fassign.inl:75:9: error: 'openblas_set_num_threads' was not declared in this scope; did you mean 'omp_set_num_threads'?\n   75 |         openblas_set_num_threads(__FFLASFFPACK_OPENBLAS_NUM_THREADS);\n      |         ^~~~~~~~~~~~~~~~~~~~~~~~\n      |         omp_set_num_threads\n```",
    "created_at": "2020-01-25T16:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407246",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>Does not work on my arch... At commit `2941411`, the build of `fflas-ffpack` failed with

```
../../../fflas-ffpack/fflas/fflas_fassign.inl: In function 'void FFLAS::fassign(const Field&, size_t, typename Field::ConstElement_ptr, size_t, typename Field::Element_ptr, size_t) [with Field = Givaro::Modular<f
loat>; size_t = long unsigned int; typename Field::ConstElement_ptr = const float*; typename Field::Element_ptr = float*]':
../../../fflas-ffpack/fflas/fflas_fassign.inl:75:9: error: 'openblas_set_num_threads' was not declared in this scope; did you mean 'omp_set_num_threads'?
   75 |         openblas_set_num_threads(__FFLASFFPACK_OPENBLAS_NUM_THREADS);
      |         ^~~~~~~~~~~~~~~~~~~~~~~~
      |         omp_set_num_threads
```



---

archive/issue_comments_407247.json:
```json
{
    "body": "<a id='comment:29'></a>(trying now with `./configure --without-system-openblas`)",
    "created_at": "2020-01-25T16:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407247",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'></a>(trying now with `./configure --without-system-openblas`)



---

archive/issue_comments_407248.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 vdelecroix]:\n> (trying now with `./configure --without-system-openblas`)\n\n\nIn the above situation, `make` fails at building openblas with the same as usual\n\n```\ncp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/blas.pc': Permission denied\ncp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/cblas.pc': Permission denied\ncp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/lapack.pc': Permission denied\n```",
    "created_at": "2020-01-25T16:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407248",
    "user": "https://github.com/videlec"
}
```

<a id='comment:30'></a>Replying to [comment:29 vdelecroix]:
> (trying now with `./configure --without-system-openblas`)


In the above situation, `make` fails at building openblas with the same as usual

```
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/blas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/cblas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/lapack.pc': Permission denied
```



---

archive/issue_comments_407249.json:
```json
{
    "body": "<a id='comment:31'></a>That breaks configure if there is no system-wide fortran:\n\n```\nchecking for Fortran libraries of ... \nchecking for dummy main to link with Fortran libraries... none\nconfigure: error: in `/Users/buildbot-sage/slave/sage_git/build':\nconfigure: error: cannot compile a simple Fortran program\nSee `config.log' for more details\nchecking for Fortran name-mangling scheme... If you would like to try to build Sage anyway (to help porting),\nexport the variable 'SAGE_PORT' to something non-empty.\nmake[1]: *** [build/make/Makefile] Error 1\nmake: *** [base-toolchain] Error 2\nmake: Target `start' not remade because of errors.\n```",
    "created_at": "2020-01-25T17:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407249",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:31'></a>That breaks configure if there is no system-wide fortran:

```
checking for Fortran libraries of ... 
checking for dummy main to link with Fortran libraries... none
configure: error: in `/Users/buildbot-sage/slave/sage_git/build':
configure: error: cannot compile a simple Fortran program
See `config.log' for more details
checking for Fortran name-mangling scheme... If you would like to try to build Sage anyway (to help porting),
export the variable 'SAGE_PORT' to something non-empty.
make[1]: *** [build/make/Makefile] Error 1
make: *** [base-toolchain] Error 2
make: Target `start' not remade because of errors.
```



---

archive/issue_comments_407250.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-01-25T17:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407250",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_407251.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 vbraun]:\n> That breaks configure if there is no system-wide fortran:\n\n\ngood catch - so the gfortran is a dependency here.\n\nBut this also applies to many `spkg-configure.m4` tests that use a C++ compiler\nto run tests.",
    "created_at": "2020-01-25T18:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407251",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>Replying to [comment:31 vbraun]:
> That breaks configure if there is no system-wide fortran:


good catch - so the gfortran is a dependency here.

But this also applies to many `spkg-configure.m4` tests that use a C++ compiler
to run tests.



---

archive/issue_comments_407252.json:
```json
{
    "body": "<a id='comment:33'></a>by right, C, C++, and Fortran compilers are pre-reqs for many `spkg-configure.m4` tests,\nas testing with one compiler and then build another compiler and use it is dodgy.",
    "created_at": "2020-01-25T18:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407252",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>by right, C, C++, and Fortran compilers are pre-reqs for many `spkg-configure.m4` tests,
as testing with one compiler and then build another compiler and use it is dodgy.



---

archive/issue_comments_407253.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:27 dimpase]:\n> with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)\n\n\nI can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?",
    "created_at": "2020-01-26T09:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407253",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:34'></a>Replying to [comment:27 dimpase]:
> with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)


I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?



---

archive/issue_comments_407254.json:
```json
{
    "body": "<a id='comment:36'></a>Attachment [vdelecroix-29071-fflas_ffpack-2.4.3.log](tarball://root/attachments/some-uuid/ticket29071/vdelecroix-29071-fflas_ffpack-2.4.3.log) by @videlec created at 2020-01-26 09:59:33\n\nReplying to [comment:34 arojas]:\n> Replying to [comment:27 dimpase]:\n> > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)\n\n> \n> I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?\n\n\nHere they are\n- [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)\n- [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)",
    "created_at": "2020-01-26T09:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407254",
    "user": "https://github.com/videlec"
}
```

<a id='comment:36'></a>Attachment [vdelecroix-29071-fflas_ffpack-2.4.3.log](tarball://root/attachments/some-uuid/ticket29071/vdelecroix-29071-fflas_ffpack-2.4.3.log) by @videlec created at 2020-01-26 09:59:33

Replying to [comment:34 arojas]:
> Replying to [comment:27 dimpase]:
> > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)

> 
> I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?


Here they are
- [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)
- [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)



---

archive/issue_comments_407255.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:36 vdelecroix]:\n> Replying to [comment:34 arojas]:\n> > Replying to [comment:27 dimpase]:\n> > > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)\n\n> > \n> > I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?\n\n> \n> Here they are\n> - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)\n> - [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)\n\n\nI think your issue is caused by the same .pc stale symlinks that are making the build fail with sage's openblas. fflas-ffpack's spkg-install has `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"`, which should return `-lcblas` on Arch, but it is returning `-lopenblas` for you. The only reason I can think of is those symlinks. Can you delete them and try again?",
    "created_at": "2020-01-26T10:21:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407255",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:37'></a>Replying to [comment:36 vdelecroix]:
> Replying to [comment:34 arojas]:
> > Replying to [comment:27 dimpase]:
> > > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)

> > 
> > I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?

> 
> Here they are
> - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)
> - [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)


I think your issue is caused by the same .pc stale symlinks that are making the build fail with sage's openblas. fflas-ffpack's spkg-install has `LINBOX_BLAS="$(pkg-config --libs cblas)"`, which should return `-lcblas` on Arch, but it is returning `-lopenblas` for you. The only reason I can think of is those symlinks. Can you delete them and try again?



---

archive/issue_comments_407256.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 arojas]:\n> Replying to [comment:36 vdelecroix]:\n> > Replying to [comment:34 arojas]:\n> > > Replying to [comment:27 dimpase]:\n> > > > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)\n\n> > > \n> > > I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?\n\n> > \n> > Here they are\n> > - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)\n> > - [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)\n \n> \n> I think your issue is caused by the same .pc stale symlinks that are making the build fail with sage's openblas. fflas-ffpack's spkg-install has `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"`, which should return `-lcblas` on Arch, but it is returning `-lopenblas` for you. The only reason I can think of is those symlinks. Can you delete them and try again?\n\n\nIndeed\n\n```\n(sage-sh)$ pkg-config --libs cblas\n-lopenblas \n(sage-sh) vincent@mangouste:sage$ rm local/lib/pkgconfig/cblas.pc \n(sage-sh) vincent@mangouste:sage$ rm local/lib/pkgconfig/blas.pc \n(sage-sh) vincent@mangouste:sage$ pkg-config --libs cblas\n-lcblas \n```\nI just relaunched `make` after that...",
    "created_at": "2020-01-26T10:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407256",
    "user": "https://github.com/videlec"
}
```

<a id='comment:38'></a>Replying to [comment:37 arojas]:
> Replying to [comment:36 vdelecroix]:
> > Replying to [comment:34 arojas]:
> > > Replying to [comment:27 dimpase]:
> > > > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)

> > > 
> > > I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?

> > 
> > Here they are
> > - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)
> > - [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)
 
> 
> I think your issue is caused by the same .pc stale symlinks that are making the build fail with sage's openblas. fflas-ffpack's spkg-install has `LINBOX_BLAS="$(pkg-config --libs cblas)"`, which should return `-lcblas` on Arch, but it is returning `-lopenblas` for you. The only reason I can think of is those symlinks. Can you delete them and try again?


Indeed

```
(sage-sh)$ pkg-config --libs cblas
-lopenblas 
(sage-sh) vincent@mangouste:sage$ rm local/lib/pkgconfig/cblas.pc 
(sage-sh) vincent@mangouste:sage$ rm local/lib/pkgconfig/blas.pc 
(sage-sh) vincent@mangouste:sage$ pkg-config --libs cblas
-lcblas 
```
I just relaunched `make` after that...



---

archive/issue_comments_407257.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-26T10:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407257",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_407258.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-26T10:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407258",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_407259.json:
```json
{
    "body": "<a id='comment:40'></a>fixed the issue in comment:31",
    "created_at": "2020-01-26T10:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407259",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:40'></a>fixed the issue in comment:31



---

archive/issue_comments_407260.json:
```json
{
    "body": "<a id='comment:41'></a>The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.\n\nTo fix this, `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"` should be replaced with ` LINBOX_BLAS=\"$(pkg-config --libs blas cblas)\"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas\n\nDima, do you want to include this change here or should I open a new ticket?",
    "created_at": "2020-01-26T10:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407260",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:41'></a>The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.

To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas

Dima, do you want to include this change here or should I open a new ticket?



---

archive/issue_comments_407261.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 arojas]:\n> The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.\n> \n> To fix this, `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"` should be replaced with ` LINBOX_BLAS=\"$(pkg-config --libs blas cblas)\"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas\n> \n> Dima, do you want to include this change here or should I open a new ticket?\n\n\nlet's do a new ticket, as this is a rather different issue.",
    "created_at": "2020-01-26T10:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407261",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'></a>Replying to [comment:41 arojas]:
> The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> 
> To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas
> 
> Dima, do you want to include this change here or should I open a new ticket?


let's do a new ticket, as this is a rather different issue.



---

archive/issue_comments_407262.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:41 arojas]:\n> The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.\n> \n> To fix this, `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"` should be replaced with ` LINBOX_BLAS=\"$(pkg-config --libs blas cblas)\"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas\n\n\nOn my machine I got\n\n```\n(sage-sh)$ pkg-config --libs blas cblas\n-lopenblas \n```",
    "created_at": "2020-01-26T11:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407262",
    "user": "https://github.com/videlec"
}
```

<a id='comment:43'></a>Replying to [comment:41 arojas]:
> The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> 
> To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas


On my machine I got

```
(sage-sh)$ pkg-config --libs blas cblas
-lopenblas 
```



---

archive/issue_comments_407263.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:43 vdelecroix]:\n> Replying to [comment:41 arojas]:\n> > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.\n> > \n> > To fix this, `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"` should be replaced with ` LINBOX_BLAS=\"$(pkg-config --libs blas cblas)\"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas\n\n> \n> On my machine I got\n> \n> ```\n> (sage-sh)$ pkg-config --libs blas cblas\n> -lopenblas \n> ```\n\n\nThe above is coherent with the symlinks provided in Sage\n\n```\n(sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc\n```\nBut not with what I have in `/usr/lib/pkgconfig/`\n\n```\n$ ls -l /usr/lib/pkgconfig/ | grep blas\nlrwxrwxrwx 1 root root   11 20 ao\u00fbt  12:35 blas.pc -> openblas.pc\n-rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc\n-rw-r--r-- 1 root root  497 20 ao\u00fbt  12:35 openblas.pc\n```",
    "created_at": "2020-01-26T11:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407263",
    "user": "https://github.com/videlec"
}
```

<a id='comment:44'></a>Replying to [comment:43 vdelecroix]:
> Replying to [comment:41 arojas]:
> > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> > 
> > To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas

> 
> On my machine I got
> 
> ```
> (sage-sh)$ pkg-config --libs blas cblas
> -lopenblas 
> ```


The above is coherent with the symlinks provided in Sage

```
(sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```
But not with what I have in `/usr/lib/pkgconfig/`

```
$ ls -l /usr/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 root root   11 20 août  12:35 blas.pc -> openblas.pc
-rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc
-rw-r--r-- 1 root root  497 20 août  12:35 openblas.pc
```



---

archive/issue_comments_407264.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:44 vdelecroix]:\n> Replying to [comment:43 vdelecroix]:\n> > Replying to [comment:41 arojas]:\n> > > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.\n> > > \n> > > To fix this, `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"` should be replaced with ` LINBOX_BLAS=\"$(pkg-config --libs blas cblas)\"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas\n\n> > \n> > On my machine I got\n> > \n> > ```\n> > (sage-sh)$ pkg-config --libs blas cblas\n> > -lopenblas \n> > ```\n\n> \n> The above is coherent with the symlinks provided in Sage\n> \n> ```\n> (sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas\n> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc\n> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc\n> lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc\n> ```\n> But not with what I have in `/usr/lib/pkgconfig/`\n> \n> ```\n> $ ls -l /usr/lib/pkgconfig/ | grep blas\n> lrwxrwxrwx 1 root root   11 20 ao\u00fbt  12:35 blas.pc -> openblas.pc\n> -rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc\n> -rw-r--r-- 1 root root  497 20 ao\u00fbt  12:35 openblas.pc\n> ```\n\n\nThose links are no longer created on Arch, that's the point of this ticket",
    "created_at": "2020-01-26T11:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407264",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:45'></a>Replying to [comment:44 vdelecroix]:
> Replying to [comment:43 vdelecroix]:
> > Replying to [comment:41 arojas]:
> > > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> > > 
> > > To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas

> > 
> > On my machine I got
> > 
> > ```
> > (sage-sh)$ pkg-config --libs blas cblas
> > -lopenblas 
> > ```

> 
> The above is coherent with the symlinks provided in Sage
> 
> ```
> (sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
> ```
> But not with what I have in `/usr/lib/pkgconfig/`
> 
> ```
> $ ls -l /usr/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 root root   11 20 août  12:35 blas.pc -> openblas.pc
> -rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc
> -rw-r--r-- 1 root root  497 20 août  12:35 openblas.pc
> ```


Those links are no longer created on Arch, that's the point of this ticket



---

archive/issue_comments_407265.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:44 vdelecroix]:\n> Replying to [comment:43 vdelecroix]:\n> > Replying to [comment:41 arojas]:\n> > > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.\n> > > \n> > > To fix this, `LINBOX_BLAS=\"$(pkg-config --libs cblas)\"` should be replaced with ` LINBOX_BLAS=\"$(pkg-config --libs blas cblas)\"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas\n\n> > \n> > On my machine I got\n> > \n> > ```\n> > (sage-sh)$ pkg-config --libs blas cblas\n> > -lopenblas \n> > ```\n\n> \n> The above is coherent with the symlinks provided in Sage\n> \n> ```\n> (sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas\n> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc\n> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc\n> lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc\n> ```\n> But not with what I have in `/usr/lib/pkgconfig/`\n> \n> ```\n> $ ls -l /usr/lib/pkgconfig/ | grep blas\n> lrwxrwxrwx 1 root root   11 20 ao\u00fbt  12:35 blas.pc -> openblas.pc\n> -rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc\n> -rw-r--r-- 1 root root  497 20 ao\u00fbt  12:35 openblas.pc\n> ```\n\n\nRemoving the symlinks and setting them according to what is in `/usr/lib` seems to fix the issue\n\n```\n$ rm /opt/sage/local/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/cblas.pc\n$ ln -s /usr/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/\n$ ln -s /usr/lib/pkgconfig/cblas.pc /opt/sage/local/lib/pkgconfig/\n```",
    "created_at": "2020-01-26T12:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407265",
    "user": "https://github.com/videlec"
}
```

<a id='comment:46'></a>Replying to [comment:44 vdelecroix]:
> Replying to [comment:43 vdelecroix]:
> > Replying to [comment:41 arojas]:
> > > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> > > 
> > > To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas

> > 
> > On my machine I got
> > 
> > ```
> > (sage-sh)$ pkg-config --libs blas cblas
> > -lopenblas 
> > ```

> 
> The above is coherent with the symlinks provided in Sage
> 
> ```
> (sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
> ```
> But not with what I have in `/usr/lib/pkgconfig/`
> 
> ```
> $ ls -l /usr/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 root root   11 20 août  12:35 blas.pc -> openblas.pc
> -rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc
> -rw-r--r-- 1 root root  497 20 août  12:35 openblas.pc
> ```


Removing the symlinks and setting them according to what is in `/usr/lib` seems to fix the issue

```
$ rm /opt/sage/local/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/cblas.pc
$ ln -s /usr/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/
$ ln -s /usr/lib/pkgconfig/cblas.pc /opt/sage/local/lib/pkgconfig/
```



---

archive/issue_comments_407266.json:
```json
{
    "body": "<a id='comment:47'></a>After a `make distclean` and standing at commit `508ac7c` I see the same problem\n\n```\n$ ls -l /opt/sage/local/lib/pkgconfig/ | grep blas\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 blas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 cblas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 lapack.pc -> /usr/lib/pkgconfig/openblas.pc\n```",
    "created_at": "2020-01-26T12:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407266",
    "user": "https://github.com/videlec"
}
```

<a id='comment:47'></a>After a `make distclean` and standing at commit `508ac7c` I see the same problem

```
$ ls -l /opt/sage/local/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```



---

archive/issue_comments_407267.json:
```json
{
    "body": "<a id='comment:48'></a>have you run `./bootstrap && ./configure` ?\nIf yes, please post config.log (as attachement)",
    "created_at": "2020-01-26T12:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407267",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:48'></a>have you run `./bootstrap && ./configure` ?
If yes, please post config.log (as attachement)



---

archive/issue_comments_407268.json:
```json
{
    "body": "<a id='comment:49'></a>Wait, why do you do these:\n\n```\n$ ln -s /usr/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/\n$ ln -s /usr/lib/pkgconfig/cblas.pc /opt/sage/local/lib/pkgconfig/\n```\n\n?\n\nThis could only break stuff, if you do it after `make distclean`.",
    "created_at": "2020-01-26T12:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407268",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:49'></a>Wait, why do you do these:

```
$ ln -s /usr/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/
$ ln -s /usr/lib/pkgconfig/cblas.pc /opt/sage/local/lib/pkgconfig/
```

?

This could only break stuff, if you do it after `make distclean`.



---

archive/issue_comments_407269.json:
```json
{
    "body": "<a id='comment:50'></a>After `make distclean`, `./bootstrap`, `./configure` the build still fails at `fflas-ffpack` with the same\n\n```\nerror: 'openblas_set_num_threads' was not declared in this scope; did you mean 'omp_set_num_threads'?\n```\nAlso the blas symlinks are still pointing to openblas\n\n```\n$ ls -l local/lib/pkgconfig/ | grep blas\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 blas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 cblas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 lapack.pc -> /usr/lib/pkgconfig/openblas.pc\n```",
    "created_at": "2020-01-26T12:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407269",
    "user": "https://github.com/videlec"
}
```

<a id='comment:50'></a>After `make distclean`, `./bootstrap`, `./configure` the build still fails at `fflas-ffpack` with the same

```
error: 'openblas_set_num_threads' was not declared in this scope; did you mean 'omp_set_num_threads'?
```
Also the blas symlinks are still pointing to openblas

```
$ ls -l local/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```



---

archive/issue_comments_407270.json:
```json
{
    "body": "Attachment [vdelecroix-29071-config.log](tarball://root/attachments/some-uuid/ticket29071/vdelecroix-29071-config.log) by @videlec created at 2020-01-26 12:19:24",
    "created_at": "2020-01-26T12:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407270",
    "user": "https://github.com/videlec"
}
```

Attachment [vdelecroix-29071-config.log](tarball://root/attachments/some-uuid/ticket29071/vdelecroix-29071-config.log) by @videlec created at 2020-01-26 12:19:24



---

archive/issue_comments_407271.json:
```json
{
    "body": "<a id='comment:51'></a>Please also make sure there is nothing in `src/lib/pkgconfig` before running `./configure`. After running ./configure on Arch it should look like\n\n```\n$ ls src/lib/pkgconfig/\nblas.pc  gsl.pc\n```\n\nYou could have these stale stuff from older versions of this ticket or even before.",
    "created_at": "2020-01-26T12:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407271",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:51'></a>Please also make sure there is nothing in `src/lib/pkgconfig` before running `./configure`. After running ./configure on Arch it should look like

```
$ ls src/lib/pkgconfig/
blas.pc  gsl.pc
```

You could have these stale stuff from older versions of this ticket or even before.



---

archive/issue_comments_407272.json:
```json
{
    "body": "<a id='comment:52'></a>Here is [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)",
    "created_at": "2020-01-26T12:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407272",
    "user": "https://github.com/videlec"
}
```

<a id='comment:52'></a>Here is [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)



---

archive/issue_comments_407273.json:
```json
{
    "body": "<a id='comment:53'></a>Indeed\n\n```\n$ ls -l src/lib/pkgconfig/\ntotal 4\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 blas.pc -> /usr/lib/pkgconfig/openblas.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 11:51 cblas.pc -> /usr/lib/pkgconfig/openblas.pc\n-rw-r--r-- 1 vincent vincent 200 26 janv. 14:12 gsl.pc\nlrwxrwxrwx 1 vincent vincent  30 26 janv. 11:51 lapack.pc -> /usr/lib/pkgconfig/openblas.pc\n```",
    "created_at": "2020-01-26T12:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407273",
    "user": "https://github.com/videlec"
}
```

<a id='comment:53'></a>Indeed

```
$ ls -l src/lib/pkgconfig/
total 4
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:51 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
-rw-r--r-- 1 vincent vincent 200 26 janv. 14:12 gsl.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:51 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```



---

archive/issue_comments_407274.json:
```json
{
    "body": "<a id='comment:54'></a>Why isn't `src/lib/pkgconfig` properly cleaned?",
    "created_at": "2020-01-26T12:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407274",
    "user": "https://github.com/videlec"
}
```

<a id='comment:54'></a>Why isn't `src/lib/pkgconfig` properly cleaned?



---

archive/issue_comments_407275.json:
```json
{
    "body": "<a id='comment:55'></a>I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?",
    "created_at": "2020-01-26T12:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407275",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'></a>I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?



---

archive/issue_comments_407276.json:
```json
{
    "body": "<a id='comment:56'></a>Replying to [comment:55 dimpase]:\n> I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?\n\n\nThat `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.",
    "created_at": "2020-01-26T12:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407276",
    "user": "https://github.com/videlec"
}
```

<a id='comment:56'></a>Replying to [comment:55 dimpase]:
> I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?


That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.



---

archive/issue_comments_407277.json:
```json
{
    "body": "<a id='comment:57'></a>After removing `src/lib/pkgconfig` the build `fflas-ffpack` succeeded! Thank you.",
    "created_at": "2020-01-26T12:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407277",
    "user": "https://github.com/videlec"
}
```

<a id='comment:57'></a>After removing `src/lib/pkgconfig` the build `fflas-ffpack` succeeded! Thank you.



---

archive/issue_comments_407278.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:56 vdelecroix]:\n> Replying to [comment:55 dimpase]:\n> > I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?\n\n> \n> That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.\n\n\nI've opened a blocker #29082 to deal with cleaning of these files, sorry for this mess.",
    "created_at": "2020-01-26T12:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407278",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:58'></a>Replying to [comment:56 vdelecroix]:
> Replying to [comment:55 dimpase]:
> > I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?

> 
> That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.


I've opened a blocker #29082 to deal with cleaning of these files, sorry for this mess.



---

archive/issue_comments_407279.json:
```json
{
    "body": "<a id='comment:59'></a>Replying to [comment:58 dimpase]:\n> Replying to [comment:56 vdelecroix]:\n> > Replying to [comment:55 dimpase]:\n> > > I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?\n\n> > \n> > That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.\n\n> \n> I've opened a blocker #29082 to deal with cleaning of these files, sorry for this mess.\n\n\nYou did more good than bad :-) It is quite nice to have Sage using the libraries from the system!",
    "created_at": "2020-01-26T12:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407279",
    "user": "https://github.com/videlec"
}
```

<a id='comment:59'></a>Replying to [comment:58 dimpase]:
> Replying to [comment:56 vdelecroix]:
> > Replying to [comment:55 dimpase]:
> > > I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?

> > 
> > That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.

> 
> I've opened a blocker #29082 to deal with cleaning of these files, sorry for this mess.


You did more good than bad :-) It is quite nice to have Sage using the libraries from the system!



---

archive/issue_comments_407280.json:
```json
{
    "body": "<a id='comment:60'></a>Please also don't forget that you'll need (an equivalent of) #29051 to make the build succeed (without it scipy will fail).",
    "created_at": "2020-01-26T12:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407280",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:60'></a>Please also don't forget that you'll need (an equivalent of) #29051 to make the build succeed (without it scipy will fail).



---

archive/issue_comments_407281.json:
```json
{
    "body": "<a id='comment:62'></a>I have merged in #29051 and current beta.\n\n---\nNew commits:",
    "created_at": "2020-01-28T00:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407281",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:62'></a>I have merged in #29051 and current beta.

---
New commits:



---

archive/issue_comments_407282.json:
```json
{
    "body": "<a id='comment:63'></a>I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. \n\nAfter all, sage-the-distribution has a mechanism to install `gfortran` itself. We shouldn't break that.\n\nAs you can see at https://github.com/mkoeppe/sage/runs/411989461, with this ticket all \"minimal\" installs fail with `configure: error: in `/sage':\nconfigure: error: cannot compile a simple Fortran program`.",
    "created_at": "2020-01-28T01:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407282",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:63'></a>I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 

After all, sage-the-distribution has a mechanism to install `gfortran` itself. We shouldn't break that.

As you can see at https://github.com/mkoeppe/sage/runs/411989461, with this ticket all "minimal" installs fail with `configure: error: in `/sage':
configure: error: cannot compile a simple Fortran program`.



---

archive/issue_comments_407283.json:
```json
{
    "body": "<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-28T05:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407283",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_407284.json:
```json
{
    "body": "<a id='comment:66'></a>Replying to [comment:63 mkoeppe]:\n> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. \n\n\nFixed in d2b5e13.",
    "created_at": "2020-01-28T05:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407284",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:66'></a>Replying to [comment:63 mkoeppe]:
> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 


Fixed in d2b5e13.



---

archive/issue_comments_407285.json:
```json
{
    "body": "<a id='comment:67'></a>Tests see https://github.com/mkoeppe/sage/runs/412256169",
    "created_at": "2020-01-28T06:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407285",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:67'></a>Tests see https://github.com/mkoeppe/sage/runs/412256169



---

archive/issue_comments_407286.json:
```json
{
    "body": "<a id='comment:68'></a>Replying to [comment:63 mkoeppe]:\n> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. \n> \n> After all, sage-the-distribution has a mechanism to install `gfortran` itself. We shouldn't break that.\n> \n> As you can see at https://github.com/mkoeppe/sage/runs/411989461, with this ticket all \"minimal\" installs fail with `configure: error: in `/sage':\n> configure: error: cannot compile a simple Fortran program`.\n> \n\noops, I see, I only tested with `./configure --without-system-gfortran` - which worked just fine :-)",
    "created_at": "2020-01-28T08:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407286",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:68'></a>Replying to [comment:63 mkoeppe]:
> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 
> 
> After all, sage-the-distribution has a mechanism to install `gfortran` itself. We shouldn't break that.
> 
> As you can see at https://github.com/mkoeppe/sage/runs/411989461, with this ticket all "minimal" installs fail with `configure: error: in `/sage':
> configure: error: cannot compile a simple Fortran program`.
> 

oops, I see, I only tested with `./configure --without-system-gfortran` - which worked just fine :-)



---

archive/issue_comments_407287.json:
```json
{
    "body": "<a id='comment:69'></a>\n```\n+       if test \"$SAGE_HAVE_FC_FREEFORM\" = yes ; then dnl Have a suitable Fortran compiler\n```\n\ncould we please stick to `AS_IF` ?",
    "created_at": "2020-01-28T08:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407287",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:69'></a>
```
+       if test "$SAGE_HAVE_FC_FREEFORM" = yes ; then dnl Have a suitable Fortran compiler
```

could we please stick to `AS_IF` ?



---

archive/issue_comments_407288.json:
```json
{
    "body": "<a id='comment:70'></a>Replying to [comment:65 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                                                                             |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|\n> |[d2b5e13](https://git.sagemath.org/sage.git/commit/?id=d2b5e139875c8769d1b0dca0cc05512df3cdfcbe)|`configure.ac, build/pkgs/{openblas,gfortran}: Do not fail if there is no FC`|\n\n\nthis has broken recognition of gfortran on Debian 10.\n\nprobably cause arguments were shuffled around...",
    "created_at": "2020-01-28T11:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407288",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:70'></a>Replying to [comment:65 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                                                                             |
> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|
> |[d2b5e13](https://git.sagemath.org/sage.git/commit/?id=d2b5e139875c8769d1b0dca0cc05512df3cdfcbe)|`configure.ac, build/pkgs/{openblas,gfortran}: Do not fail if there is no FC`|


this has broken recognition of gfortran on Debian 10.

probably cause arguments were shuffled around...



---

archive/issue_comments_407289.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-01-28T11:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407289",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_407290.json:
```json
{
    "body": "<a id='comment:72'></a>I also don't get\n\n```\n+      # We already checked (in the initial portion of configure.ac)\n+      # whether the Fortran compiler accepts free-format source code (as\n```\nIMHO there is nothing either in configure.ac or build/pkgs/gcc/spkg-configure.m4 that\ndoes any Fortran checks.",
    "created_at": "2020-01-28T11:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407290",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:72'></a>I also don't get

```
+      # We already checked (in the initial portion of configure.ac)
+      # whether the Fortran compiler accepts free-format source code (as
```
IMHO there is nothing either in configure.ac or build/pkgs/gcc/spkg-configure.m4 that
does any Fortran checks.



---

archive/issue_comments_407291.json:
```json
{
    "body": "<a id='comment:73'></a>Replying to [comment:69 dimpase]:\n> {{{\n> +       if test \"$SAGE_HAVE_FC_FREEFORM\" = yes ; then dnl Have a suitable Fortran compiler\n> }}}\n> \n> could we please stick to `AS_IF` ?\n\n\nactually, I don't see the  point of this `if` at all. If we get there then it's already true, as it's inside the check for `gfortran` as a pre-req, in the scope of `SAGE_SPKG_DEPCHECK([gfortran], ...)`.\n`",
    "created_at": "2020-01-28T11:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407291",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:73'></a>Replying to [comment:69 dimpase]:
> {{{
> +       if test "$SAGE_HAVE_FC_FREEFORM" = yes ; then dnl Have a suitable Fortran compiler
> }}}
> 
> could we please stick to `AS_IF` ?


actually, I don't see the  point of this `if` at all. If we get there then it's already true, as it's inside the check for `gfortran` as a pre-req, in the scope of `SAGE_SPKG_DEPCHECK([gfortran], ...)`.
`



---

archive/issue_comments_407292.json:
```json
{
    "body": "<a id='comment:74'></a>The trouble is in `AC_FC_FUNC()`, which throws a fit if there is no Fortran compiler around, instead of just suffering in silence.",
    "created_at": "2020-01-28T12:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407292",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:74'></a>The trouble is in `AC_FC_FUNC()`, which throws a fit if there is no Fortran compiler around, instead of just suffering in silence.



---

archive/issue_comments_407293.json:
```json
{
    "body": "<a id='comment:75'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-28T12:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:75'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_407294.json:
```json
{
    "body": "<a id='comment:76'></a>Replying to [comment:72 dimpase]:\n> I also don't get\n> \n> ```\n> +      # We already checked (in the initial portion of configure.ac)\n> +      # whether the Fortran compiler accepts free-format source code (as\n> ```\n> IMHO there is nothing either in configure.ac or build/pkgs/gcc/spkg-configure.m4 that\n> does any Fortran checks.\n\n\nSorry, I forgot to include one commit on this branch.\nFixed.",
    "created_at": "2020-01-28T12:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407294",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:76'></a>Replying to [comment:72 dimpase]:
> I also don't get
> 
> ```
> +      # We already checked (in the initial portion of configure.ac)
> +      # whether the Fortran compiler accepts free-format source code (as
> ```
> IMHO there is nothing either in configure.ac or build/pkgs/gcc/spkg-configure.m4 that
> does any Fortran checks.


Sorry, I forgot to include one commit on this branch.
Fixed.



---

archive/issue_comments_407295.json:
```json
{
    "body": "<a id='comment:77'></a>Replying to [comment:74 dimpase]:\n> The trouble is in `AC_FC_FUNC()`, which throws a fit if there is no Fortran compiler around, instead of just suffering in silence. \n\nYes, exactly, and more specifically: Because of AC_REQUIRE and AC_DEFUN_ONCE one cannot easily make all things conditional that one would liike.",
    "created_at": "2020-01-28T12:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407295",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:77'></a>Replying to [comment:74 dimpase]:
> The trouble is in `AC_FC_FUNC()`, which throws a fit if there is no Fortran compiler around, instead of just suffering in silence. 

Yes, exactly, and more specifically: Because of AC_REQUIRE and AC_DEFUN_ONCE one cannot easily make all things conditional that one would liike.



---

archive/issue_comments_407296.json:
```json
{
    "body": "<a id='comment:78'></a>Replying to [comment:73 dimpase]:\n> Replying to [comment:69 dimpase]:\n> > {{{\n> > +       if test \"$SAGE_HAVE_FC_FREEFORM\" = yes ; then dnl Have a suitable Fortran compiler\n> > }}}\n> > \n> > could we please stick to `AS_IF` ?\n\n\nNo, they are unfortunately not equivalent because of autoconf's AC_PREREQ/AC_DEFUN_ONCE magic.",
    "created_at": "2020-01-28T12:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407296",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:78'></a>Replying to [comment:73 dimpase]:
> Replying to [comment:69 dimpase]:
> > {{{
> > +       if test "$SAGE_HAVE_FC_FREEFORM" = yes ; then dnl Have a suitable Fortran compiler
> > }}}
> > 
> > could we please stick to `AS_IF` ?


No, they are unfortunately not equivalent because of autoconf's AC_PREREQ/AC_DEFUN_ONCE magic.



---

archive/issue_comments_407297.json:
```json
{
    "body": "<a id='comment:79'></a>New commits:",
    "created_at": "2020-01-28T12:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407297",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:79'></a>New commits:



---

archive/issue_comments_407298.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-28T12:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407298",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_407299.json:
```json
{
    "body": "<a id='comment:80'></a>Replying to [comment:63 mkoeppe]:\n> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. \n\n\nFixed by `wrap AC_FC_FUNC so that it does not throw an error without Fortran`: [56541ae](https://git.sagemath.org/sage.git/commit?id=56541ae443c5cffaf5d943694c37f3b4afb5bca2)",
    "created_at": "2020-01-28T12:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407299",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:80'></a>Replying to [comment:63 mkoeppe]:
> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 


Fixed by `wrap AC_FC_FUNC so that it does not throw an error without Fortran`: [56541ae](https://git.sagemath.org/sage.git/commit?id=56541ae443c5cffaf5d943694c37f3b4afb5bca2)



---

archive/issue_comments_407300.json:
```json
{
    "body": "<a id='comment:81'></a>IMHO it's an autoconf bug/feature that `AC_FC_FUNC` errors out without Fortran, while e.g. `AC_FC_FREEFORM` does not.",
    "created_at": "2020-01-28T12:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407300",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:81'></a>IMHO it's an autoconf bug/feature that `AC_FC_FUNC` errors out without Fortran, while e.g. `AC_FC_FREEFORM` does not.



---

archive/issue_comments_407301.json:
```json
{
    "body": "<a id='comment:82'></a>Replying to [comment:81 dimpase]:\n> IMHO it's an autoconf bug/feature that `AC_FC_FUNC` errors out without Fortran, while e.g. `AC_FC_FREEFORM` does not.\n\nYes, I agree.",
    "created_at": "2020-01-28T13:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407301",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:82'></a>Replying to [comment:81 dimpase]:
> IMHO it's an autoconf bug/feature that `AC_FC_FUNC` errors out without Fortran, while e.g. `AC_FC_FREEFORM` does not.

Yes, I agree.



---

archive/issue_comments_407302.json:
```json
{
    "body": "<a id='comment:83'></a>Replying to [comment:80 dimpase]:\n> Replying to [comment:63 mkoeppe]:\n> > I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. \n\n> \n> Fixed by `wrap AC_FC_FUNC so that it does not throw an error without Fortran`: [56541ae](https://git.sagemath.org/sage.git/commit?id=56541ae443c5cffaf5d943694c37f3b4afb5bca2)\n\n\nGreat, a much easier fix than what I put together in \u200b8cf2a3b/\u200bc98c6b2.  \nTesting at https://github.com/mkoeppe/sage/actions/runs/32186055",
    "created_at": "2020-01-28T13:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407302",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:83'></a>Replying to [comment:80 dimpase]:
> Replying to [comment:63 mkoeppe]:
> > I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 

> 
> Fixed by `wrap AC_FC_FUNC so that it does not throw an error without Fortran`: [56541ae](https://git.sagemath.org/sage.git/commit?id=56541ae443c5cffaf5d943694c37f3b4afb5bca2)


Great, a much easier fix than what I put together in ​8cf2a3b/​c98c6b2.  
Testing at https://github.com/mkoeppe/sage/actions/runs/32186055



---

archive/issue_comments_407303.json:
```json
{
    "body": "<a id='comment:84'></a>Tests finished at https://github.com/mkoeppe/sage/actions/runs/32186055",
    "created_at": "2020-01-28T16:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407303",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:84'></a>Tests finished at https://github.com/mkoeppe/sage/actions/runs/32186055



---

archive/issue_comments_407304.json:
```json
{
    "body": "<a id='comment:85'></a>Looking good, and certainly fixes what was original reported on this ticket (fflas_ffpack on archlinux). The build error of fflas_ffpack on `debian-jessie-standard` (https://github.com/mkoeppe/sage/runs/412891766) is unrelated. It is good on all other configurations.",
    "created_at": "2020-01-28T16:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407304",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:85'></a>Looking good, and certainly fixes what was original reported on this ticket (fflas_ffpack on archlinux). The build error of fflas_ffpack on `debian-jessie-standard` (https://github.com/mkoeppe/sage/runs/412891766) is unrelated. It is good on all other configurations.



---

archive/issue_comments_407305.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-28T16:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407305",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_073707.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-31T23:49:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29071#event-73707"
}
```



---

archive/issue_comments_407306.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-31T23:49:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29071#issuecomment-407306",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
