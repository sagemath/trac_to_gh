# Issue 29866: closest_vector for IntegerLattice is broken

archive/issues_029629.json:
```json
{
    "body": "In this example we compute `v`, the closest vector to the vector `u`\nthat lies in the integer lattice `L`. Problem: `v` is not in `L`.\n\n```\nsage: from sage.modules.free_module_integer import IntegerLattice\nsage: M = matrix(ZZ, [[20957228, -4966110], [9411844, 19625639]])\nsage: L = IntegerLattice(M)\nsage: u = vector([-423434678248195, -18882583298608161305227077482])\nsage: v = L.closest_vector(u)\nsage: v in L\nFalse\nsage: MGAP = libgap(M)\nsage: vGAP = libgap(v)\nsage: libgap.SolutionIntMat(MGAP, vGAP)  # independent test that v is not in L\nfail\n```\n\nThis is a simplified version of\n[Taylor Huang's example posted on sage-devel](https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ).\n\nThis used to work in Sage 8.4, and was broken in 8.5.beta3 by the\nchange from `round(x, 6)` to `x.n(digits=6)` in #26648.\n\nThe sage-devel thread also reports the membership test to be broken:\n\n```\nfrom sage.modules.free_module_integer import IntegerLattice\ncoef = Matrix([-44429982080874270968379672793605458,\n    98931650854481334735580708522902113])\nbMat = Matrix([[20957228, -4966110], [9411844, 19625639]])\nL = IntegerLattice(bMat)\ncoef*bMat in L  # should be true, but returns False\nbMatGAP = libgap(bMat)\nv = libgap(coef*bMat)[0]\nsol = libgap.SolutionIntMat(bMatGAP, v); sol  # prints\n# [ -423434671769860, -18882583298608161305225815339 ]\nvector(sol.sage())*bMat == vector(coef*bMat)  # sanity check - prints True\n```\n\nbut this is merely a type \"error\", in the sense that `coef` is not a vector,\nbut a 1x2 matrix (a different type, and automatic conversion does not happen here).\nNot sure whether the latter warrants a fix.\n\n**CC:**  @malb @slel @fchapoton\n\n**Keywords:** round\n\n**Branch/Commit:** [99f0df74fa4b4b1c836b8b850ceeb516ef012d22](https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22)\n\n**Reviewer:** Matthias Koeppe, Samuel Leli\u00e8vre\n\n**Author:** Samuel Leli\u00e8vre, Dima Pasechnik\n\nIssue created by migration from https://trac.sagemath.org/ticket/29866\n\n",
    "closed_at": "2020-06-23T22:17:50Z",
    "created_at": "2020-06-15T08:03:36Z",
    "labels": [
        "component: number theory",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "closest_vector for IntegerLattice is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29866",
    "user": "https://github.com/dimpase"
}
```
In this example we compute `v`, the closest vector to the vector `u`
that lies in the integer lattice `L`. Problem: `v` is not in `L`.

```
sage: from sage.modules.free_module_integer import IntegerLattice
sage: M = matrix(ZZ, [[20957228, -4966110], [9411844, 19625639]])
sage: L = IntegerLattice(M)
sage: u = vector([-423434678248195, -18882583298608161305227077482])
sage: v = L.closest_vector(u)
sage: v in L
False
sage: MGAP = libgap(M)
sage: vGAP = libgap(v)
sage: libgap.SolutionIntMat(MGAP, vGAP)  # independent test that v is not in L
fail
```

This is a simplified version of
[Taylor Huang's example posted on sage-devel](https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ).

This used to work in Sage 8.4, and was broken in 8.5.beta3 by the
change from `round(x, 6)` to `x.n(digits=6)` in #26648.

The sage-devel thread also reports the membership test to be broken:

```
from sage.modules.free_module_integer import IntegerLattice
coef = Matrix([-44429982080874270968379672793605458,
    98931650854481334735580708522902113])
bMat = Matrix([[20957228, -4966110], [9411844, 19625639]])
L = IntegerLattice(bMat)
coef*bMat in L  # should be true, but returns False
bMatGAP = libgap(bMat)
v = libgap(coef*bMat)[0]
sol = libgap.SolutionIntMat(bMatGAP, v); sol  # prints
# [ -423434671769860, -18882583298608161305225815339 ]
vector(sol.sage())*bMat == vector(coef*bMat)  # sanity check - prints True
```

but this is merely a type "error", in the sense that `coef` is not a vector,
but a 1x2 matrix (a different type, and automatic conversion does not happen here).
Not sure whether the latter warrants a fix.

**CC:**  @malb @slel @fchapoton

**Keywords:** round

**Branch/Commit:** [99f0df74fa4b4b1c836b8b850ceeb516ef012d22](https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22)

**Reviewer:** Matthias Koeppe, Samuel Lelièvre

**Author:** Samuel Lelièvre, Dima Pasechnik

Issue created by migration from https://trac.sagemath.org/ticket/29866





---

archive/issue_comments_476352.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n ....: \n False\n ```\n-A simplified version of Taylor Huang's example posted on sage-devel\n+A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)\n``````\n",
    "created_at": "2020-06-15T14:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476352",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 ....: 
 False
 ```
-A simplified version of Taylor Huang's example posted on sage-devel
+A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)
``````




---

archive/issue_comments_476353.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,13 +1,14 @@\n-in this example a closest vector in L is not in L: \n+In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.\n+\n+Problem: `v` is not in `L`.\n \n ```\n sage: from sage.modules.free_module_integer import IntegerLattice\n-....: L0 = matrix(ZZ,[[20957228, -4966110],[ 9411844, 19625639]])\n-....: L = IntegerLattice(L0)\n-....: v0 = vector([-423434678248195, -18882583298608161305227077482])\n-....: cv = L.closest_vector(v0)\n-....: print(cv in L)\n-....: \n+sage: M = matrix(ZZ, [[20957228, -4966110], [9411844, 19625639]])\n+sage: L = IntegerLattice(M)\n+sage: u = vector([-423434678248195, -18882583298608161305227077482])\n+sage: v = L.closest_vector(u)\n+sage: print(v in L)\n False\n ```\n A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)\n``````\n",
    "created_at": "2020-06-16T00:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476353",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,13 +1,14 @@
-in this example a closest vector in L is not in L: 
+In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.
+
+Problem: `v` is not in `L`.
 
 ```
 sage: from sage.modules.free_module_integer import IntegerLattice
-....: L0 = matrix(ZZ,[[20957228, -4966110],[ 9411844, 19625639]])
-....: L = IntegerLattice(L0)
-....: v0 = vector([-423434678248195, -18882583298608161305227077482])
-....: cv = L.closest_vector(v0)
-....: print(cv in L)
-....: 
+sage: M = matrix(ZZ, [[20957228, -4966110], [9411844, 19625639]])
+sage: L = IntegerLattice(M)
+sage: u = vector([-423434678248195, -18882583298608161305227077482])
+sage: v = L.closest_vector(u)
+sage: print(v in L)
 False
 ```
 A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)
``````




---

archive/issue_comments_476354.json:
```json
{
    "body": "<a id='comment:3'></a>\nthis might be just a bug in membership testing\n\n```\nfrom sage.modules.free_module_integer import IntegerLattice\ncoef = Matrix([-44429982080874270968379672793605458, 98931650854481334735580708522902113])\nbMat = Matrix([[20957228, -4966110],[ 9411844, 19625639]])\nL = IntegerLattice(bMat)\ncoef*bMat in L\n```\nprints `False`. (cf. continutiation of the thread on sage-devel in ticket description)",
    "created_at": "2020-06-16T08:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476354",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
this might be just a bug in membership testing

```
from sage.modules.free_module_integer import IntegerLattice
coef = Matrix([-44429982080874270968379672793605458, 98931650854481334735580708522902113])
bMat = Matrix([[20957228, -4966110],[ 9411844, 19625639]])
L = IntegerLattice(bMat)
coef*bMat in L
```
prints `False`. (cf. continutiation of the thread on sage-devel in ticket description)



---

archive/issue_comments_476355.json:
```json
{
    "body": "<a id='comment:4'></a>\nHi, I'm the person who came up with these examples. I can be sure that it is not only about membership testing. I've checked my examples with Smith normal form and indeed some of the closest vectors returned is not in L. So both membership and closest_vector are broken.",
    "created_at": "2020-06-16T08:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476355",
    "user": "https://github.com/asd00012334"
}
```

<a id='comment:4'></a>
Hi, I'm the person who came up with these examples. I can be sure that it is not only about membership testing. I've checked my examples with Smith normal form and indeed some of the closest vectors returned is not in L. So both membership and closest_vector are broken.



---

archive/issue_comments_476356.json:
```json
{
    "body": "<a id='comment:5'></a>\nwe confirm that closest vector is broken, nothing to do with membership test bug\n\n```\nsage: MGAP=libgap(M)\nsage: vGAP=libgap(v)\nsage: libgap.SolutionIntMat(MGAP,vGAP)\nfail\n```",
    "created_at": "2020-06-16T08:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476356",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
we confirm that closest vector is broken, nothing to do with membership test bug

```
sage: MGAP=libgap(M)
sage: vGAP=libgap(v)
sage: libgap.SolutionIntMat(MGAP,vGAP)
fail
```



---

archive/issue_events_271062.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-16T08:48:00Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "rename": {
        "from": "closest_vector for IntegerLattice is broken",
        "to": "closest_vector for IntegerLattice and membership test are broken"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271062"
}
```



---

archive/issue_events_271063.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-16T08:48:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271063"
}
```



---

archive/issue_events_271064.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-16T08:48:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271064"
}
```



---

archive/issue_comments_476357.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,5 +10,23 @@\n sage: v = L.closest_vector(u)\n sage: print(v in L)\n False\n+sage: MGAP=libgap(M)\n+sage: vGAP=libgap(v)\n+sage: libgap.SolutionIntMat(MGAP,vGAP) # independent test that v is not in L\n+fail\n ```\n A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)\n+\n+Membership test is broken, too (same thread)\n+\n+```\n+from sage.modules.free_module_integer import IntegerLattice\n+coef = Matrix([-44429982080874270968379672793605458, 98931650854481334735580708522902113])\n+bMat = Matrix([[20957228, -4966110],[ 9411844, 19625639]])\n+L = IntegerLattice(bMat)\n+coef*bMat in L # prints false\n+bMatGAP=libgap(bMat)\n+v=libgap(coef*bMat)[0]\n+sol=libgap.SolutionIntMat(bMatGAP,v); sol # prints\n+# [ -423434671769860, -18882583298608161305225815339 ]\n+```\n``````\n",
    "created_at": "2020-06-16T08:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476357",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,5 +10,23 @@
 sage: v = L.closest_vector(u)
 sage: print(v in L)
 False
+sage: MGAP=libgap(M)
+sage: vGAP=libgap(v)
+sage: libgap.SolutionIntMat(MGAP,vGAP) # independent test that v is not in L
+fail
 ```
 A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)
+
+Membership test is broken, too (same thread)
+
+```
+from sage.modules.free_module_integer import IntegerLattice
+coef = Matrix([-44429982080874270968379672793605458, 98931650854481334735580708522902113])
+bMat = Matrix([[20957228, -4966110],[ 9411844, 19625639]])
+L = IntegerLattice(bMat)
+coef*bMat in L # prints false
+bMatGAP=libgap(bMat)
+v=libgap(coef*bMat)[0]
+sol=libgap.SolutionIntMat(bMatGAP,v); sol # prints
+# [ -423434671769860, -18882583298608161305225815339 ]
+```
``````




---

archive/issue_comments_476358.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -29,4 +29,5 @@\n v=libgap(coef*bMat)[0]\n sol=libgap.SolutionIntMat(bMatGAP,v); sol # prints\n # [ -423434671769860, -18882583298608161305225815339 ]\n+vector(sol.sage())*bMat==vector(coef*bMat) # sanity check - prints True\n ```\n``````\n",
    "created_at": "2020-06-16T08:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476358",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -29,4 +29,5 @@
 v=libgap(coef*bMat)[0]
 sol=libgap.SolutionIntMat(bMatGAP,v); sol # prints
 # [ -423434671769860, -18882583298608161305225815339 ]
+vector(sol.sage())*bMat==vector(coef*bMat) # sanity check - prints True
 ```
``````




---

archive/issue_comments_476359.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.\n+\n+These bugs are already in Sage 8.9 (i.e. still Python 2), as well as in the latest 9.2.beta1.\n \n Problem: `v` is not in `L`.\n \n``````\n",
    "created_at": "2020-06-16T09:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476359",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.
+
+These bugs are already in Sage 8.9 (i.e. still Python 2), as well as in the latest 9.2.beta1.
 
 Problem: `v` is not in `L`.
 
``````




---

archive/issue_comments_476360.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.\n \n These bugs are already in Sage 8.9 (i.e. still Python 2), as well as in the latest 9.2.beta1.\n+\n+However, closest_vector works in Sage 8.2 (membership test still broken, though).\n \n Problem: `v` is not in `L`.\n \n``````\n",
    "created_at": "2020-06-16T09:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476360",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
 In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.
 
 These bugs are already in Sage 8.9 (i.e. still Python 2), as well as in the latest 9.2.beta1.
+
+However, closest_vector works in Sage 8.2 (membership test still broken, though).
 
 Problem: `v` is not in `L`.
 
``````




---

archive/issue_comments_476361.json:
```json
{
    "body": "<a id='comment:10'></a>\nclosest vector got broken somewhere between Sage 8.4 (works) and 8.5 (does not).\nMembership test already broken in 8.2.",
    "created_at": "2020-06-16T09:15:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476361",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
closest vector got broken somewhere between Sage 8.4 (works) and 8.5 (does not).
Membership test already broken in 8.2.



---

archive/issue_comments_476362.json:
```json
{
    "body": "<a id='comment:11'></a>\nthe heavy lifting is done by fplll/fpylll.\n\n```\nPython 3.7.7 (default, May 30 2020, 01:27:43) \n[GCC 8.3.1 20190518] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from fpylll import CVP, IntegerMatrix\n>>> A = IntegerMatrix.from_matrix([[20957228, -4966110], [9411844, 19625639]])\n>>> t=(-423434678248195, -18882583298608161305227077482)\n>>> v0 = CVP.closest_vector(A, t)\n>>> v0\n(-423434681577544, -18882583298608161305224294058)\n```\n\n~~this is the same vector as computed by Sage code in the ticket description, oops. So the bug may be narrowed to fp(y)lll.~~\n\nThis vector is different from what Sage outputs, namely \n\n```\n(-423434671769860, -18882583298608161305225815339)\n```\nand may be verified to be in L by calling libgap, say, or just\ndirectly:\n\n```\nsage: vector((-423434681577544, -18882583298608161305224294058)) in L\nTrue\n```\n\nNote a comment on https://github.com/fplll/fpylll/issues/124 which says that the basis should be LLL-reduced for this to work correctly.",
    "created_at": "2020-06-16T09:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476362",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
the heavy lifting is done by fplll/fpylll.

```
Python 3.7.7 (default, May 30 2020, 01:27:43) 
[GCC 8.3.1 20190518] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from fpylll import CVP, IntegerMatrix
>>> A = IntegerMatrix.from_matrix([[20957228, -4966110], [9411844, 19625639]])
>>> t=(-423434678248195, -18882583298608161305227077482)
>>> v0 = CVP.closest_vector(A, t)
>>> v0
(-423434681577544, -18882583298608161305224294058)
```

~~this is the same vector as computed by Sage code in the ticket description, oops. So the bug may be narrowed to fp(y)lll.~~

This vector is different from what Sage outputs, namely 

```
(-423434671769860, -18882583298608161305225815339)
```
and may be verified to be in L by calling libgap, say, or just
directly:

```
sage: vector((-423434681577544, -18882583298608161305224294058)) in L
True
```

Note a comment on https://github.com/fplll/fpylll/issues/124 which says that the basis should be LLL-reduced for this to work correctly.



---

archive/issue_comments_476363.json:
```json
{
    "body": "<a id='comment:12'></a>\n~~Thus, in view of [comment:11](#comment%3A11) (corrected) the closest_vector bug is a Sage interface to fp(y)lll bug. ~~\n\nrather, Sage has a different implementation --- which seems to be unchanged since 2015 (i.e. much before Sage 8.5...)",
    "created_at": "2020-06-16T10:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476363",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>
~~Thus, in view of [comment:11](#comment%3A11) (corrected) the closest_vector bug is a Sage interface to fp(y)lll bug. ~~

rather, Sage has a different implementation --- which seems to be unchanged since 2015 (i.e. much before Sage 8.5...)



---

archive/issue_comments_476364.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.\n \n-These bugs are already in Sage 8.9 (i.e. still Python 2), as well as in the latest 9.2.beta1.\n+These bugs are already in Sage 8.1 (i.e. still Python 2), as well as in the latest 9.2.beta1.\n \n-However, closest_vector works in Sage 8.2 (membership test still broken, though).\n+However, closest_vector works in Sage 8.4, and is broken in 8.5 (membership test still broken, though).\n \n Problem: `v` is not in `L`.\n \n``````\n",
    "created_at": "2020-06-16T11:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476364",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
 In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.
 
-These bugs are already in Sage 8.9 (i.e. still Python 2), as well as in the latest 9.2.beta1.
+These bugs are already in Sage 8.1 (i.e. still Python 2), as well as in the latest 9.2.beta1.
 
-However, closest_vector works in Sage 8.2 (membership test still broken, though).
+However, closest_vector works in Sage 8.4, and is broken in 8.5 (membership test still broken, though).
 
 Problem: `v` is not in `L`.
 
``````




---

archive/issue_comments_476365.json:
```json
{
    "body": "<a id='comment:14'></a>\nThe containment is \"broken\", as the 1x2 matrix `coef*bMat` fails to be coersed to a vector.\nNamely, with the example in the \n\n```\nsage: vector(coef)*bMat in L\nTrue\nsage: vector(coef*bMat) in L\nTrue\nsage: coef*bMat in L\nFalse\nsage: M=matrix([1,1])\nsage: M*bMat in L\nFalse\n```\n\nso this is not really a bug, it's just a conversion issue, absence of automatic conversion.",
    "created_at": "2020-06-16T13:34:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476365",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>
The containment is "broken", as the 1x2 matrix `coef*bMat` fails to be coersed to a vector.
Namely, with the example in the 

```
sage: vector(coef)*bMat in L
True
sage: vector(coef*bMat) in L
True
sage: coef*bMat in L
False
sage: M=matrix([1,1])
sage: M*bMat in L
False
```

so this is not really a bug, it's just a conversion issue, absence of automatic conversion.



---

archive/issue_comments_476366.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -21,7 +21,7 @@\n ```\n A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)\n \n-Membership test is broken, too (same thread)\n+Membership test was reported broken, too (same thread)\n \n ```\n from sage.modules.free_module_integer import IntegerLattice\n@@ -35,3 +35,5 @@\n # [ -423434671769860, -18882583298608161305225815339 ]\n vector(sol.sage())*bMat==vector(coef*bMat) # sanity check - prints True\n ```\n+\n+but this is merely a type \"error\", in the sense that `coef` is not a vector, but a 1x2 matrix (a different type, and automatic conversion does not happen here). Not sure whether the latter warrants a fix. \n``````\n",
    "created_at": "2020-06-16T13:34:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476366",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -21,7 +21,7 @@
 ```
 A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)
 
-Membership test is broken, too (same thread)
+Membership test was reported broken, too (same thread)
 
 ```
 from sage.modules.free_module_integer import IntegerLattice
@@ -35,3 +35,5 @@
 # [ -423434671769860, -18882583298608161305225815339 ]
 vector(sol.sage())*bMat==vector(coef*bMat) # sanity check - prints True
 ```
+
+but this is merely a type "error", in the sense that `coef` is not a vector, but a 1x2 matrix (a different type, and automatic conversion does not happen here). Not sure whether the latter warrants a fix. 
``````




---

archive/issue_events_271065.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-16T13:34:54Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "rename": {
        "from": "closest_vector for IntegerLattice and membership test are broken",
        "to": "closest_vector for IntegerLattice is broken"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271065"
}
```



---

archive/issue_comments_476367.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis seems suspicious.\n\n```\nsage: from sage.modules.free_module_integer import IntegerLattice\nsage: a = vector(ZZ, [20957228, -4966110])\nsage: b = vector(ZZ, [9411844, 19625639])\nsage: L = IntegerLattice([a, b])\nsage: R = L.voronoi_relevant_vectors()\nsage: S = [-b, -a, b - a, b, a, a - b]\nsage: print([r - s for r, s in zip(R, S)])\n[(0, 0), (0, 0), (0, -1), (0, 0), (0, 0), (0, 1)]\nsage: print(R[-1]); print(a - b)\n(11545384, -24591748)\n(11545384, -24591749)\n```",
    "created_at": "2020-06-16T14:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476367",
    "user": "https://github.com/slel"
}
```

<a id='comment:15'></a>
This seems suspicious.

```
sage: from sage.modules.free_module_integer import IntegerLattice
sage: a = vector(ZZ, [20957228, -4966110])
sage: b = vector(ZZ, [9411844, 19625639])
sage: L = IntegerLattice([a, b])
sage: R = L.voronoi_relevant_vectors()
sage: S = [-b, -a, b - a, b, a, a - b]
sage: print([r - s for r, s in zip(R, S)])
[(0, 0), (0, 0), (0, -1), (0, 0), (0, 0), (0, 1)]
sage: print(R[-1]); print(a - b)
(11545384, -24591748)
(11545384, -24591749)
```



---

archive/issue_comments_476368.json:
```json
{
    "body": "<a id='comment:16'></a>\nnote that on Sage 8.4 (where closest_vector() still worked) this is\n\n```\n...\nsage: print([r - s for r, s in zip(R, S)])\n[(-2133540, 44217388), (11545384, -24591749), (-9411844, -19625639), (2133540, -44217388), (0, 0), (-2133540, 44217388)]\nsage: print(R[-1]); print(a - b)\n(9411844, 19625639)\n(11545384, -24591749)\n```",
    "created_at": "2020-06-16T14:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476368",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>
note that on Sage 8.4 (where closest_vector() still worked) this is

```
...
sage: print([r - s for r, s in zip(R, S)])
[(-2133540, 44217388), (11545384, -24591749), (-9411844, -19625639), (2133540, -44217388), (0, 0), (-2133540, 44217388)]
sage: print(R[-1]); print(a - b)
(9411844, 19625639)
(11545384, -24591749)
```



---

archive/issue_comments_476369.json:
```json
{
    "body": "<a id='comment:17'></a>\nIf fact, R computed in [comment:15](#comment%3A15) is the same as the one in [comment:16](#comment%3A16) (with Sage 8.4), but in a different order.",
    "created_at": "2020-06-16T14:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476369",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
If fact, R computed in [comment:15](#comment%3A15) is the same as the one in [comment:16](#comment%3A16) (with Sage 8.4), but in a different order.



---

archive/issue_comments_476370.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe voronoi cell is slightly off. It should be exactly `P` below.\n\n```\nsage: V = L.voronoi_cell()\nsage: ieqs = [(x^2 + y^2, 2*x, 2*y) for x, y in (-b, -a, a-b, b, a, b-a)]\nsage: P = Polyhedron(ieqs=ieqs)\nsage: VP = V.plot(fill='cyan', alpha=0.5) + P.plot(fill='magenta', alpha=0.5)\nsage: for v in V.vertices():\n....:     x, y = v.vector()\n....:     VP.show(xmin=x-1, xmax=x+1, ymin=y-1, ymax=y+1, figsize=3)\n```",
    "created_at": "2020-06-16T15:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476370",
    "user": "https://github.com/slel"
}
```

<a id='comment:18'></a>
The voronoi cell is slightly off. It should be exactly `P` below.

```
sage: V = L.voronoi_cell()
sage: ieqs = [(x^2 + y^2, 2*x, 2*y) for x, y in (-b, -a, a-b, b, a, b-a)]
sage: P = Polyhedron(ieqs=ieqs)
sage: VP = V.plot(fill='cyan', alpha=0.5) + P.plot(fill='magenta', alpha=0.5)
sage: for v in V.vertices():
....:     x, y = v.vector()
....:     VP.show(xmin=x-1, xmax=x+1, ymin=y-1, ymax=y+1, figsize=3)
```



---

archive/issue_comments_476371.json:
```json
{
    "body": "<a id='comment:19'></a>\nindeed, on Sage 9.2.beta1\n\n```\nsage: V.vertices()\n(A vertex at (-483879947381762629327/57254902852288, 315998472693125499957/28627451426144),\n A vertex at (483879947381762629327/57254902852288, -315998472693125499957/28627451426144),\n A vertex at (5728193175888805065973/458039243775532, 1390651404779390505975/229019621887766),\n A vertex at (-708599510920502622251/229019617181844, 1552002451289776620941/114509808590922),\n A vertex at (708599510920502622251/229019617181844, -1552002451289776620941/114509808590922),\n A vertex at (-5728193175888805065973/458039243775532, -1390651404779390505975/229019621887766))\n```\nbut on Sage 8.4\n\n```\nsage: V.vertices()\n(A vertex at (5728193175888805065973/458039243775532, 1390651404779390505975/229019621887766),\n A vertex at (3871039688862599879323/458039243775532, -2527988039232444116235/229019621887766),\n A vertex at (1417199267595526864965/458039243775532, -3104005018306403526499/229019621887766),\n A vertex at (-5728193175888805065973/458039243775532, -1390651404779390505975/229019621887766),\n A vertex at (-3871039688862599879323/458039243775532, 2527988039232444116235/229019621887766),\n A vertex at (-1417199267595526864965/458039243775532, 3104005018306403526499/229019621887766))\n```\nquite a bit different",
    "created_at": "2020-06-16T15:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476371",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
indeed, on Sage 9.2.beta1

```
sage: V.vertices()
(A vertex at (-483879947381762629327/57254902852288, 315998472693125499957/28627451426144),
 A vertex at (483879947381762629327/57254902852288, -315998472693125499957/28627451426144),
 A vertex at (5728193175888805065973/458039243775532, 1390651404779390505975/229019621887766),
 A vertex at (-708599510920502622251/229019617181844, 1552002451289776620941/114509808590922),
 A vertex at (708599510920502622251/229019617181844, -1552002451289776620941/114509808590922),
 A vertex at (-5728193175888805065973/458039243775532, -1390651404779390505975/229019621887766))
```
but on Sage 8.4

```
sage: V.vertices()
(A vertex at (5728193175888805065973/458039243775532, 1390651404779390505975/229019621887766),
 A vertex at (3871039688862599879323/458039243775532, -2527988039232444116235/229019621887766),
 A vertex at (1417199267595526864965/458039243775532, -3104005018306403526499/229019621887766),
 A vertex at (-5728193175888805065973/458039243775532, -1390651404779390505975/229019621887766),
 A vertex at (-3871039688862599879323/458039243775532, 2527988039232444116235/229019621887766),
 A vertex at (-1417199267595526864965/458039243775532, 3104005018306403526499/229019621887766))
```
quite a bit different



---

archive/issue_comments_476372.json:
```json
{
    "body": "<a id='comment:20'></a>\nI'll try bisecting Sage  8.4 and 8.5. Might take a while...",
    "created_at": "2020-06-16T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476372",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>
I'll try bisecting Sage  8.4 and 8.5. Might take a while...



---

archive/issue_comments_476373.json:
```json
{
    "body": "<a id='comment:21'></a>\nCould it be #26648 with this change to the function `diamond_cut`\nin `src/sage/modules/diamond_cutting.py`?\n\n```diff\n-                hv = [QQ(round(elmt, 6)) for elmt in hv]\n+                hv = [QQ(elmt.n(digits=6)) for elmt in hv]\n```",
    "created_at": "2020-06-16T22:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476373",
    "user": "https://github.com/slel"
}
```

<a id='comment:21'></a>
Could it be #26648 with this change to the function `diamond_cut`
in `src/sage/modules/diamond_cutting.py`?

```diff
-                hv = [QQ(round(elmt, 6)) for elmt in hv]
+                hv = [QQ(elmt.n(digits=6)) for elmt in hv]
```



---

archive/issue_comments_476374.json:
```json
{
    "body": "<a id='comment:22'></a>\ngood catch - this change is certainly bad. cf.\n\n```\nsage: r=5555.55555555555555555\nsage: round(r,6)\n5555.555556\nsage: r.n(digits=6)\n5555.56\n```\n\nwhy it's always 6 that suffices is another question, though",
    "created_at": "2020-06-16T22:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476374",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
good catch - this change is certainly bad. cf.

```
sage: r=5555.55555555555555555
sage: round(r,6)
5555.555556
sage: r.n(digits=6)
5555.56
```

why it's always 6 that suffices is another question, though



---

archive/issue_comments_476375.json:
```json
{
    "body": "<a id='comment:23'></a>\nyes, this fixes this error:\n\n```diff\n--- a/src/sage/modules/diamond_cutting.py\n+++ b/src/sage/modules/diamond_cutting.py\n@@ -154,6 +154,7 @@ def diamond_cut(V, GM, C, verbose=False):\n         (A vertex at (2), A vertex at (0))\n     \"\"\"\n     # coerce to floats\n+    from sage.misc.functional import round\n     GM = GM.n()\n     C = float(C)\n     if verbose:\n@@ -223,7 +224,8 @@ def diamond_cut(V, GM, C, verbose=False):\n                 cut_count += 1\n                 if verbose:\n                     print(\"\\n%d) Cut using normal vector %s\" % (cut_count, hv))\n-                hv = [QQ(elmt.n(digits=6)) for elmt in hv]\n+                hv = [QQ(round(elmt,6)) for elmt in hv]\n+                # hv = [QQ(elmt.n(digits=6)) for elmt in hv]\n                 inequalities.append(plane_inequality(hv))\n \n     if verbose:\n```",
    "created_at": "2020-06-16T22:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476375",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
yes, this fixes this error:

```diff
--- a/src/sage/modules/diamond_cutting.py
+++ b/src/sage/modules/diamond_cutting.py
@@ -154,6 +154,7 @@ def diamond_cut(V, GM, C, verbose=False):
         (A vertex at (2), A vertex at (0))
     """
     # coerce to floats
+    from sage.misc.functional import round
     GM = GM.n()
     C = float(C)
     if verbose:
@@ -223,7 +224,8 @@ def diamond_cut(V, GM, C, verbose=False):
                 cut_count += 1
                 if verbose:
                     print("\n%d) Cut using normal vector %s" % (cut_count, hv))
-                hv = [QQ(elmt.n(digits=6)) for elmt in hv]
+                hv = [QQ(round(elmt,6)) for elmt in hv]
+                # hv = [QQ(elmt.n(digits=6)) for elmt in hv]
                 inequalities.append(plane_inequality(hv))
 
     if verbose:
```



---

archive/issue_events_271066.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-06-16T23:41:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271066"
}
```



---

archive/issue_comments_476376.json:
```json
{
    "body": "**Commit:** [d734de1617b0ab38a60d7bc2e27f8e77107bede4](https://github.com/sagemath/sagetrac-mirror/commit/d734de1617b0ab38a60d7bc2e27f8e77107bede4)",
    "created_at": "2020-06-16T23:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476376",
    "user": "https://github.com/dimpase"
}
```

**Commit:** [d734de1617b0ab38a60d7bc2e27f8e77107bede4](https://github.com/sagemath/sagetrac-mirror/commit/d734de1617b0ab38a60d7bc2e27f8e77107bede4)



---

archive/issue_comments_476377.json:
```json
{
    "body": "<a id='comment:24'></a>\nI wonder how many more of these `round()` calls were butchered this way, or this was an one-off event.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d734de1617b0ab38a60d7bc2e27f8e77107bede4\">d734de1</a></td><td><code>the correct precision of 6 digits after dot</code></td></tr></table>\n",
    "created_at": "2020-06-16T23:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476377",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
I wonder how many more of these `round()` calls were butchered this way, or this was an one-off event.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d734de1617b0ab38a60d7bc2e27f8e77107bede4">d734de1</a></td><td><code>the correct precision of 6 digits after dot</code></td></tr></table>




---

archive/issue_comments_476378.json:
```json
{
    "body": "**Author:** Samuel Leli\u00e8vre, Dima Pasechnik",
    "created_at": "2020-06-16T23:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476378",
    "user": "https://github.com/dimpase"
}
```

**Author:** Samuel Lelièvre, Dima Pasechnik



---

archive/issue_comments_476379.json:
```json
{
    "body": "**Branch:** [u/dimpase/modules/corrround](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/modules/corrround)",
    "created_at": "2020-06-16T23:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476379",
    "user": "https://github.com/dimpase"
}
```

**Branch:** [u/dimpase/modules/corrround](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/modules/corrround)



---

archive/issue_comments_476380.json:
```json
{
    "body": "<a id='comment:25'></a>\nThe line\n\n```\nhv = [QQ(round(elmt, 6)) for elmt in hv]\n``` \nstill bothers me a lot. Why `6` there? Is it just waiting for an example with bigger numbers to break it again?",
    "created_at": "2020-06-17T08:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476380",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
The line

```
hv = [QQ(round(elmt, 6)) for elmt in hv]
``` 
still bothers me a lot. Why `6` there? Is it just waiting for an example with bigger numbers to break it again?



---

archive/issue_comments_476381.json:
```json
{
    "body": "<a id='comment:26'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1faa6aceeb6799ea31517c9b84b3e4164153e78d\">1faa6ac</a></td><td><code>get rid of conversion to floats and round()</code></td></tr></table>\n",
    "created_at": "2020-06-17T13:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476381",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1faa6aceeb6799ea31517c9b84b3e4164153e78d">1faa6ac</a></td><td><code>get rid of conversion to floats and round()</code></td></tr></table>




---

archive/issue_comments_476382.json:
```json
{
    "body": "**Changing commit** from \"[d734de1617b0ab38a60d7bc2e27f8e77107bede4](https://github.com/sagemath/sagetrac-mirror/commit/d734de1617b0ab38a60d7bc2e27f8e77107bede4)\" to \"[1faa6aceeb6799ea31517c9b84b3e4164153e78d](https://github.com/sagemath/sagetrac-mirror/commit/1faa6aceeb6799ea31517c9b84b3e4164153e78d)\".",
    "created_at": "2020-06-17T13:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476382",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[d734de1617b0ab38a60d7bc2e27f8e77107bede4](https://github.com/sagemath/sagetrac-mirror/commit/d734de1617b0ab38a60d7bc2e27f8e77107bede4)" to "[1faa6aceeb6799ea31517c9b84b3e4164153e78d](https://github.com/sagemath/sagetrac-mirror/commit/1faa6aceeb6799ea31517c9b84b3e4164153e78d)".



---

archive/issue_comments_476383.json:
```json
{
    "body": "<a id='comment:27'></a>\nthis should be robust now",
    "created_at": "2020-06-17T13:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476383",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
this should be robust now



---

archive/issue_comments_476384.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"round\".",
    "created_at": "2020-06-17T13:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476384",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "round".



---

archive/issue_comments_476385.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,10 +1,5 @@\n-In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.\n-\n-These bugs are already in Sage 8.1 (i.e. still Python 2), as well as in the latest 9.2.beta1.\n-\n-However, closest_vector works in Sage 8.4, and is broken in 8.5 (membership test still broken, though).\n-\n-Problem: `v` is not in `L`.\n+In this example we compute `v`, the closest vector to the vector `u`\n+that lies in the integer lattice `L`. Problem: `v` is not in `L`.\n \n ```\n sage: from sage.modules.free_module_integer import IntegerLattice\n@@ -12,28 +7,36 @@\n sage: L = IntegerLattice(M)\n sage: u = vector([-423434678248195, -18882583298608161305227077482])\n sage: v = L.closest_vector(u)\n-sage: print(v in L)\n+sage: v in L\n False\n-sage: MGAP=libgap(M)\n-sage: vGAP=libgap(v)\n-sage: libgap.SolutionIntMat(MGAP,vGAP) # independent test that v is not in L\n+sage: MGAP = libgap(M)\n+sage: vGAP = libgap(v)\n+sage: libgap.SolutionIntMat(MGAP, vGAP)  # independent test that v is not in L\n fail\n ```\n-A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)\n \n-Membership test was reported broken, too (same thread)\n+This is a simplified version of\n+[Taylor Huang's example posted on sage-devel](https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ).\n+\n+This used to work in Sage 8.4, and was broken in 8.5.beta3 by the\n+change from `round(x, 6)` to `x.n(digits=6)` in #26648.\n+\n+The sage-devel thread also reports the membership test to be broken:\n \n ```\n from sage.modules.free_module_integer import IntegerLattice\n-coef = Matrix([-44429982080874270968379672793605458, 98931650854481334735580708522902113])\n-bMat = Matrix([[20957228, -4966110],[ 9411844, 19625639]])\n+coef = Matrix([-44429982080874270968379672793605458,\n+    98931650854481334735580708522902113])\n+bMat = Matrix([[20957228, -4966110], [9411844, 19625639]])\n L = IntegerLattice(bMat)\n-coef*bMat in L # prints false\n-bMatGAP=libgap(bMat)\n-v=libgap(coef*bMat)[0]\n-sol=libgap.SolutionIntMat(bMatGAP,v); sol # prints\n+coef*bMat in L  # should be true, but returns False\n+bMatGAP = libgap(bMat)\n+v = libgap(coef*bMat)[0]\n+sol = libgap.SolutionIntMat(bMatGAP, v); sol  # prints\n # [ -423434671769860, -18882583298608161305225815339 ]\n-vector(sol.sage())*bMat==vector(coef*bMat) # sanity check - prints True\n+vector(sol.sage())*bMat == vector(coef*bMat)  # sanity check - prints True\n ```\n \n-but this is merely a type \"error\", in the sense that `coef` is not a vector, but a 1x2 matrix (a different type, and automatic conversion does not happen here). Not sure whether the latter warrants a fix. \n+but this is merely a type \"error\", in the sense that `coef` is not a vector,\n+but a 1x2 matrix (a different type, and automatic conversion does not happen here).\n+Not sure whether the latter warrants a fix.\n``````\n",
    "created_at": "2020-06-17T13:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476385",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,10 +1,5 @@
-In this example we compute `v`, the closest vector to the vector `u` that lies in the integer lattice `L`.
-
-These bugs are already in Sage 8.1 (i.e. still Python 2), as well as in the latest 9.2.beta1.
-
-However, closest_vector works in Sage 8.4, and is broken in 8.5 (membership test still broken, though).
-
-Problem: `v` is not in `L`.
+In this example we compute `v`, the closest vector to the vector `u`
+that lies in the integer lattice `L`. Problem: `v` is not in `L`.
 
 ```
 sage: from sage.modules.free_module_integer import IntegerLattice
@@ -12,28 +7,36 @@
 sage: L = IntegerLattice(M)
 sage: u = vector([-423434678248195, -18882583298608161305227077482])
 sage: v = L.closest_vector(u)
-sage: print(v in L)
+sage: v in L
 False
-sage: MGAP=libgap(M)
-sage: vGAP=libgap(v)
-sage: libgap.SolutionIntMat(MGAP,vGAP) # independent test that v is not in L
+sage: MGAP = libgap(M)
+sage: vGAP = libgap(v)
+sage: libgap.SolutionIntMat(MGAP, vGAP)  # independent test that v is not in L
 fail
 ```
-A simplified version of Taylor Huang's example posted on sage-devel (https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ)
 
-Membership test was reported broken, too (same thread)
+This is a simplified version of
+[Taylor Huang's example posted on sage-devel](https://groups.google.com/g/sage-devel/c/CtPAbZPjoeU/m/qj2IH7LxBAAJ).
+
+This used to work in Sage 8.4, and was broken in 8.5.beta3 by the
+change from `round(x, 6)` to `x.n(digits=6)` in #26648.
+
+The sage-devel thread also reports the membership test to be broken:
 
 ```
 from sage.modules.free_module_integer import IntegerLattice
-coef = Matrix([-44429982080874270968379672793605458, 98931650854481334735580708522902113])
-bMat = Matrix([[20957228, -4966110],[ 9411844, 19625639]])
+coef = Matrix([-44429982080874270968379672793605458,
+    98931650854481334735580708522902113])
+bMat = Matrix([[20957228, -4966110], [9411844, 19625639]])
 L = IntegerLattice(bMat)
-coef*bMat in L # prints false
-bMatGAP=libgap(bMat)
-v=libgap(coef*bMat)[0]
-sol=libgap.SolutionIntMat(bMatGAP,v); sol # prints
+coef*bMat in L  # should be true, but returns False
+bMatGAP = libgap(bMat)
+v = libgap(coef*bMat)[0]
+sol = libgap.SolutionIntMat(bMatGAP, v); sol  # prints
 # [ -423434671769860, -18882583298608161305225815339 ]
-vector(sol.sage())*bMat==vector(coef*bMat) # sanity check - prints True
+vector(sol.sage())*bMat == vector(coef*bMat)  # sanity check - prints True
 ```
 
-but this is merely a type "error", in the sense that `coef` is not a vector, but a 1x2 matrix (a different type, and automatic conversion does not happen here). Not sure whether the latter warrants a fix. 
+but this is merely a type "error", in the sense that `coef` is not a vector,
+but a 1x2 matrix (a different type, and automatic conversion does not happen here).
+Not sure whether the latter warrants a fix.
``````




---

archive/issue_comments_476386.json:
```json
{
    "body": "<a id='comment:28'></a>\nCould it be that the conversion to `QQ` was there for inexact vectors,\nsay vectors over `RDF` or `RR`?\n\nShould we add the example in the ticket description as a doctest?",
    "created_at": "2020-06-17T13:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476386",
    "user": "https://github.com/slel"
}
```

<a id='comment:28'></a>
Could it be that the conversion to `QQ` was there for inexact vectors,
say vectors over `RDF` or `RR`?

Should we add the example in the ticket description as a doctest?



---

archive/issue_comments_476387.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [slelievre](#comment%3A28):\n> Could it be that the conversion to `QQ` was there for inexact vectors,\n> say vectors over `RDF` or `RR`?\n\n\nfor IntegerLattice this looks irrelevant.\n\nprobably it was a dodgy old workaround, from pre-PPL days.\n> \n> Should we add the example in the ticket description as a doctest?\n\n\nOK, I can do this.",
    "created_at": "2020-06-17T13:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476387",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>
Replying to [slelievre](#comment%3A28):
> Could it be that the conversion to `QQ` was there for inexact vectors,
> say vectors over `RDF` or `RR`?


for IntegerLattice this looks irrelevant.

probably it was a dodgy old workaround, from pre-PPL days.
> 
> Should we add the example in the ticket description as a doctest?


OK, I can do this.



---

archive/issue_comments_476388.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [dimpase](#comment%3A29):\n> Replying to [slelievre](#comment%3A28):\n> > Could it be that the conversion to `QQ` was there for inexact vectors,\n> > say vectors over `RDF` or `RR`?\n\n> \n> for IntegerLattice this looks irrelevant.\n\n\nEven though we are working with an integer lattice, doesn't this\noffer to find the closest lattice point to a non-integer vector?",
    "created_at": "2020-06-17T17:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476388",
    "user": "https://github.com/slel"
}
```

<a id='comment:30'></a>
Replying to [dimpase](#comment%3A29):
> Replying to [slelievre](#comment%3A28):
> > Could it be that the conversion to `QQ` was there for inexact vectors,
> > say vectors over `RDF` or `RR`?

> 
> for IntegerLattice this looks irrelevant.


Even though we are working with an integer lattice, doesn't this
offer to find the closest lattice point to a non-integer vector?



---

archive/issue_comments_476389.json:
```json
{
    "body": "<a id='comment:31'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/685ac9bdb3b9451c97707add3118d63b1006f366\">685ac9b</a></td><td><code>adding test from trac #29866</code></td></tr></table>\n",
    "created_at": "2020-06-17T18:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476389",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/685ac9bdb3b9451c97707add3118d63b1006f366">685ac9b</a></td><td><code>adding test from trac #29866</code></td></tr></table>




---

archive/issue_comments_476390.json:
```json
{
    "body": "**Changing commit** from \"[1faa6aceeb6799ea31517c9b84b3e4164153e78d](https://github.com/sagemath/sagetrac-mirror/commit/1faa6aceeb6799ea31517c9b84b3e4164153e78d)\" to \"[685ac9bdb3b9451c97707add3118d63b1006f366](https://github.com/sagemath/sagetrac-mirror/commit/685ac9bdb3b9451c97707add3118d63b1006f366)\".",
    "created_at": "2020-06-17T18:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476390",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1faa6aceeb6799ea31517c9b84b3e4164153e78d](https://github.com/sagemath/sagetrac-mirror/commit/1faa6aceeb6799ea31517c9b84b3e4164153e78d)" to "[685ac9bdb3b9451c97707add3118d63b1006f366](https://github.com/sagemath/sagetrac-mirror/commit/685ac9bdb3b9451c97707add3118d63b1006f366)".



---

archive/issue_comments_476391.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [slelievre](#comment%3A30):\n> Replying to [dimpase](#comment%3A29):\n> > Replying to [slelievre](#comment%3A28):\n> > > Could it be that the conversion to `QQ` was there for inexact vectors,\n> > > say vectors over `RDF` or `RR`?\n\n> > \n> > for IntegerLattice this looks irrelevant.\n\n> \n> Even though we are working with an integer lattice, doesn't this\n> offer to find the closest lattice point to a non-integer vector?\n\n\nthe code we're changing only deals with the lattice, not with the vector we\nare finding a closest lattice point for.",
    "created_at": "2020-06-17T23:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476391",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>
Replying to [slelievre](#comment%3A30):
> Replying to [dimpase](#comment%3A29):
> > Replying to [slelievre](#comment%3A28):
> > > Could it be that the conversion to `QQ` was there for inexact vectors,
> > > say vectors over `RDF` or `RR`?

> > 
> > for IntegerLattice this looks irrelevant.

> 
> Even though we are working with an integer lattice, doesn't this
> offer to find the closest lattice point to a non-integer vector?


the code we're changing only deals with the lattice, not with the vector we
are finding a closest lattice point for.



---

archive/issue_comments_476392.json:
```json
{
    "body": "<a id='comment:33'></a>\nRight! One last thing, QQ is now imported but not used,\ncan you remove the import?",
    "created_at": "2020-06-17T23:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476392",
    "user": "https://github.com/slel"
}
```

<a id='comment:33'></a>
Right! One last thing, QQ is now imported but not used,
can you remove the import?



---

archive/issue_comments_476393.json:
```json
{
    "body": "<a id='comment:34'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22\">99f0df7</a></td><td><code>remove unused import</code></td></tr></table>\n",
    "created_at": "2020-06-18T07:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476393",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22">99f0df7</a></td><td><code>remove unused import</code></td></tr></table>




---

archive/issue_comments_476394.json:
```json
{
    "body": "**Changing commit** from \"[685ac9bdb3b9451c97707add3118d63b1006f366](https://github.com/sagemath/sagetrac-mirror/commit/685ac9bdb3b9451c97707add3118d63b1006f366)\" to \"[99f0df74fa4b4b1c836b8b850ceeb516ef012d22](https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22)\".",
    "created_at": "2020-06-18T07:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476394",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[685ac9bdb3b9451c97707add3118d63b1006f366](https://github.com/sagemath/sagetrac-mirror/commit/685ac9bdb3b9451c97707add3118d63b1006f366)" to "[99f0df74fa4b4b1c836b8b850ceeb516ef012d22](https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22)".



---

archive/issue_comments_476395.json:
```json
{
    "body": "<a id='comment:35'></a>\ndone",
    "created_at": "2020-06-18T07:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476395",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>
done



---

archive/issue_comments_476396.json:
```json
{
    "body": "<a id='comment:36'></a>\nplease review",
    "created_at": "2020-06-19T10:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476396",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>
please review



---

archive/issue_comments_476397.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2020-06-19T16:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476397",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_events_271067.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-06-19T16:49:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271067"
}
```



---

archive/issue_events_271068.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-06-19T16:49:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271068"
}
```



---

archive/issue_comments_476398.json:
```json
{
    "body": "<a id='comment:38'></a>\nThanks!",
    "created_at": "2020-06-19T21:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476398",
    "user": "https://github.com/slel"
}
```

<a id='comment:38'></a>
Thanks!



---

archive/issue_comments_476399.json:
```json
{
    "body": "**Changing reviewer** from \"Matthias Koeppe\" to \"Matthias Koeppe, Samuel Leli\u00e8vre\".",
    "created_at": "2020-06-19T21:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476399",
    "user": "https://github.com/slel"
}
```

**Changing reviewer** from "Matthias Koeppe" to "Matthias Koeppe, Samuel Lelièvre".



---

archive/issue_events_271069.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-23T22:17:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271069"
}
```



---

archive/issue_events_271070.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-23T22:17:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-271070"
}
```



---

archive/issue_comments_476400.json:
```json
{
    "body": "**Changing branch** from \"[u/dimpase/modules/corrround](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/modules/corrround)\" to \"[99f0df74fa4b4b1c836b8b850ceeb516ef012d22](https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22)\".",
    "created_at": "2020-06-23T22:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-476400",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/dimpase/modules/corrround](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/modules/corrround)" to "[99f0df74fa4b4b1c836b8b850ceeb516ef012d22](https://github.com/sagemath/sagetrac-mirror/commit/99f0df74fa4b4b1c836b8b850ceeb516ef012d22)".
