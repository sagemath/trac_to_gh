# Issue 29031: Actions cannot be pickled

archive/issues_028794.json:
```json
{
    "body": "CC:  @jdemeyer simonking @nbruin\n\nKeywords: actions\n\nWe cannot pickle actions:\n\n```\nsage: V = QQ^3\nsage: v = V((1, 2, 3))\nsage: cm = get_coercion_model()\nsage: a = cm.get_action(V, QQ, operator.mul)\nsage: dumps(a)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n[snip]\n/home/travis/sage-build/local/lib/python3.7/site-packages/sage/categories/functor.pyx in sage.categories.functor.Functor.__reduce__ (build/cythonized/sage/categories/functor.c:2242)()\n    212         \"\"\"\n    213         return (_Functor_unpickle,\n--> 214                 (self.__class__, list(self.__dict__.items()),\n    215                  self.__domain, self.__codomain))\n    216 \n\nAttributeError: 'sage.structure.coerce_actions.RightModuleAction' object has no attribute '__dict__'\n```\nThis might require some custom `__reduce__` methods unless we give the corresponding Cython classes a `__dict__`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29031\n\n",
    "closed_at": "2020-12-27T00:23:30Z",
    "created_at": "2020-01-17T08:22:49Z",
    "labels": [
        "component: pickling",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Actions cannot be pickled",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29031",
    "user": "https://github.com/tscrim"
}
```
CC:  @jdemeyer simonking @nbruin

Keywords: actions

We cannot pickle actions:

```
sage: V = QQ^3
sage: v = V((1, 2, 3))
sage: cm = get_coercion_model()
sage: a = cm.get_action(V, QQ, operator.mul)
sage: dumps(a)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
[snip]
/home/travis/sage-build/local/lib/python3.7/site-packages/sage/categories/functor.pyx in sage.categories.functor.Functor.__reduce__ (build/cythonized/sage/categories/functor.c:2242)()
    212         """
    213         return (_Functor_unpickle,
--> 214                 (self.__class__, list(self.__dict__.items()),
    215                  self.__domain, self.__codomain))
    216 

AttributeError: 'sage.structure.coerce_actions.RightModuleAction' object has no attribute '__dict__'
```
This might require some custom `__reduce__` methods unless we give the corresponding Cython classes a `__dict__`.

Issue created by migration from https://trac.sagemath.org/ticket/29031





---

archive/issue_comments_406441.json:
```json
{
    "body": "Simon, Jeroen, do you have any ideas on how to best do this?",
    "created_at": "2020-01-17T08:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406441",
    "user": "https://github.com/tscrim"
}
```

Simon, Jeroen, do you have any ideas on how to best do this?



---

archive/issue_comments_406442.json:
```json
{
    "body": "I don't have time right now to look into the code, but if I recall correctly, we have different (cython-)types for different actions. I.e., in each case it is hard-coded what the action does (for instance: \"apply the ._lmul_ method of the left factor to the the right factor\" or so).\n\nFrom what I recall, the input data for any action is the pair (acting parent, acted upon parent). Hence, something like\n\n```python\ndef __reduce__(self):\n    return type(self), (the two parents)\n```\nshould work.",
    "created_at": "2020-01-17T08:38:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406442",
    "user": "https://github.com/simon-king-jena"
}
```

I don't have time right now to look into the code, but if I recall correctly, we have different (cython-)types for different actions. I.e., in each case it is hard-coded what the action does (for instance: "apply the ._lmul_ method of the left factor to the the right factor" or so).

From what I recall, the input data for any action is the pair (acting parent, acted upon parent). Hence, something like

```python
def __reduce__(self):
    return type(self), (the two parents)
```
should work.



---

archive/issue_comments_406443.json:
```json
{
    "body": "Okay, so for this I was thinking `Functor` and its subclasses (in particular, `Action`) should mimic `Map` and have an `_extra_slots` and `_update_slots` methods. However, this doesn't work as I get errors of the form:\n\n```\nTypeError: sage.categories.functor.Functor.__new__(sage.structure.coerce_actions.LeftModuleAction)\nis not safe, use sage.structure.coerce_actions.LeftModuleAction.__new__()\n```\nand I don't know how to get around that with the current attempt (of course, I can fall back to custom `__reduce__` for each class). I also have another issue irregardless, the `weakref` in the `Action.US` slot, and I don't know how to get the object. Any ideas?",
    "created_at": "2020-01-18T16:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406443",
    "user": "https://github.com/tscrim"
}
```

Okay, so for this I was thinking `Functor` and its subclasses (in particular, `Action`) should mimic `Map` and have an `_extra_slots` and `_update_slots` methods. However, this doesn't work as I get errors of the form:

```
TypeError: sage.categories.functor.Functor.__new__(sage.structure.coerce_actions.LeftModuleAction)
is not safe, use sage.structure.coerce_actions.LeftModuleAction.__new__()
```
and I don't know how to get around that with the current attempt (of course, I can fall back to custom `__reduce__` for each class). I also have another issue irregardless, the `weakref` in the `Action.US` slot, and I don't know how to get the object. Any ideas?



---

archive/issue_comments_406444.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> Okay, so for this I was thinking `Functor` and its subclasses (in particular, `Action`) should mimic `Map` and have an `_extra_slots` and `_update_slots` methods. However, this doesn't work as I get errors of the form:\n> \n> ```\n> TypeError: sage.categories.functor.Functor.__new__(sage.structure.coerce_actions.LeftModuleAction)\n> is not safe, use sage.structure.coerce_actions.LeftModuleAction.__new__()\n> ```\n\nI think that's because actions have another memory layout. Looking at `coerce_action.pxd`, the problem is `ModuleAction`, so that would probably be the right spot to implement the custom `reduce`.\n\nThe fact that there's a weakref indicates the need for a custom reduce anyway, unless there's an established pattern recognized already (so that the reduce can exist higher up): the `US` slot is just a straight-up weakref, so you can dereference it with `self.US()`. If you get `None` than the acted-upon set was already garbage collected. Then the action is defunct and hence unpickleable.\n\nYou might be able to get away with the following on `Action`:\n\n```\ndef __reduce__(self):\n    return type(self), (self.G, self.underlying_set())\n```\nwhere `underlying_set` derefs the weakref and raises an error if defunct.\n\nIn the end, I think it's much safer to pickle these things with a call to the actual constructor than via a `new` and slot manipulations: it's much less implementation-dependent.\n\nFor the most part, I don't think these actions SHOULD be pickled anyway, but rather rediscovered. But because they should just be constructible from their actor and set, pickling them via a constructor is fairly straightforward.",
    "created_at": "2020-01-18T22:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406444",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:3 tscrim]:
> Okay, so for this I was thinking `Functor` and its subclasses (in particular, `Action`) should mimic `Map` and have an `_extra_slots` and `_update_slots` methods. However, this doesn't work as I get errors of the form:
> 
> ```
> TypeError: sage.categories.functor.Functor.__new__(sage.structure.coerce_actions.LeftModuleAction)
> is not safe, use sage.structure.coerce_actions.LeftModuleAction.__new__()
> ```

I think that's because actions have another memory layout. Looking at `coerce_action.pxd`, the problem is `ModuleAction`, so that would probably be the right spot to implement the custom `reduce`.

The fact that there's a weakref indicates the need for a custom reduce anyway, unless there's an established pattern recognized already (so that the reduce can exist higher up): the `US` slot is just a straight-up weakref, so you can dereference it with `self.US()`. If you get `None` than the acted-upon set was already garbage collected. Then the action is defunct and hence unpickleable.

You might be able to get away with the following on `Action`:

```
def __reduce__(self):
    return type(self), (self.G, self.underlying_set())
```
where `underlying_set` derefs the weakref and raises an error if defunct.

In the end, I think it's much safer to pickle these things with a call to the actual constructor than via a `new` and slot manipulations: it's much less implementation-dependent.

For the most part, I don't think these actions SHOULD be pickled anyway, but rather rediscovered. But because they should just be constructible from their actor and set, pickling them via a constructor is fairly straightforward.



---

archive/issue_comments_406445.json:
```json
{
    "body": "Thanks for the explanations. I agree that these particular actions should not be pickled, but I was using them as easy examples for when an action is stored as an attribute of an object. In particular, this came up in #25902. I will implement custom `__reduce__` for the relevant classes.",
    "created_at": "2020-01-19T03:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406445",
    "user": "https://github.com/tscrim"
}
```

Thanks for the explanations. I agree that these particular actions should not be pickled, but I was using them as easy examples for when an action is stored as an attribute of an object. In particular, this came up in #25902. I will implement custom `__reduce__` for the relevant classes.



---

archive/issue_comments_406446.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-19T04:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406446",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406447.json:
```json
{
    "body": "Okay, here is the branch with the custom `__reduce__` methods.\n\n---\nNew commits:",
    "created_at": "2020-01-19T04:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406447",
    "user": "https://github.com/tscrim"
}
```

Okay, here is the branch with the custom `__reduce__` methods.

---
New commits:



---

archive/issue_comments_406448.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406448",
    "user": "https://github.com/mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_events_073549.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29031#event-73549"
}
```



---

archive/issue_comments_406449.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-14T19:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406449",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406450.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-14T12:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406450",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_406451.json:
```json
{
    "body": "Looks good to me, but it inserts 5 typos. Can you please do the following changes (5 times)?\n\n```diff\n-is can \n+can\n```",
    "created_at": "2020-08-14T12:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406451",
    "user": "https://github.com/seblabbe"
}
```

Looks good to me, but it inserts 5 typos. Can you please do the following changes (5 times)?

```diff
-is can 
+can
```



---

archive/issue_events_073550.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29031#event-73550"
}
```



---

archive/issue_events_073551.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29031#event-73551"
}
```



---

archive/issue_comments_406452.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-15T20:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406452",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406453.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-12-15T20:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406453",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_406454.json:
```json
{
    "body": "I fixed the documentation typos that slabbe pointed out, so I'm setting this to positive review.",
    "created_at": "2020-12-15T20:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406454",
    "user": "https://github.com/roed314"
}
```

I fixed the documentation typos that slabbe pointed out, so I'm setting this to positive review.



---

archive/issue_comments_406455.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-27T00:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29031#issuecomment-406455",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_073552.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-27T00:23:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29031",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29031#event-73552"
}
```
