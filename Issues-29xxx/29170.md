# Issue 29170: Fix R installation errors related to gfortran

archive/issues_028933.json:
```json
{
    "assignees": [],
    "body": "As reported \n- for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ\n- for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ\n- for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ\n\nhttps://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n\n\n\nCC:  @dimpase @EmmanuelCharpentier @kiwifb @orlitzky @timokau\n\nBranch/Commit: **[`5fbea80`](https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216)**\n\nUpstream: **Not yet reported upstream; Will do shortly.**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29170_\n\n",
    "closed_at": "2020-03-25T22:48:55Z",
    "created_at": "2020-02-09T02:38:16Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix R installation errors related to gfortran",
    "type": "issue",
    "updated_at": "2020-03-25T22:48:55Z",
    "url": "https://github.com/sagemath/sage/issues/29170",
    "user": "https://github.com/mkoeppe"
}
```
As reported 
- for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ
- for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ
- for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ

https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html



CC:  @dimpase @EmmanuelCharpentier @kiwifb @orlitzky @timokau

Branch/Commit: **[`5fbea80`](https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216)**

Upstream: **Not yet reported upstream; Will do shortly.**

Reviewer: **Dima Pasechnik**

Author: **Matthias Koeppe**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/29170_





---

archive/issue_events_398006.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-02-09T02:38:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398006"
}
```



---

archive/issue_events_398007.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-02-09T02:38:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398007"
}
```



---

archive/issue_events_398008.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-02-09T02:38:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398008"
}
```



---

archive/issue_events_398009.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-02-09T02:38:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398009"
}
```



---

archive/issue_comments_457298.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\ngcc fix here (linked from the R link) https://gcc.gnu.org/bugzilla/show_bug.cgi?id=90329\n\nnot clear what they actually did - new option(s) added to gfortran?",
    "created_at": "2020-02-09T12:05:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457298",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:1" align="right">comment:1</div>

gcc fix here (linked from the R link) https://gcc.gnu.org/bugzilla/show_bug.cgi?id=90329

not clear what they actually did - new option(s) added to gfortran?



---

archive/issue_comments_457299.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nOk, I read that whole thread so no one else has to. Ultimately, this is due to broken code that needs to be updated. The GCC developers have done two things:\n\n* Added `-fc-prototypes-external`, to help people fix that broken code.\n* In the meantime, they have added a workaround in the form of the (on by default) `-ftail-call-workaround` flag (https://gcc.gnu.org/onlinedocs/gfortran/Code-Gen-Options.html). That keeps the broken code working for now, but the option will eventually be turned off and go away.\n\nThe workaround was backported all the way back to gcc-7.x, so really what we should be doing is telling everyone to use a new-enough gfortran. The workaround is in gcc-9.2, and based on the release dates, I presume it's also in 7.5, 8.4, and everything newer than that.\n\nWe can probably just update gfortran's spkg-configure.m4 to ensure a new-enough version. Maybe for now it would suffice to check if the `-ftail-call-workaround` flag is supported. That would rule out older compilers from before things were broken, but is easy to implement.",
    "created_at": "2020-03-16T03:34:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457299",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:3" align="right">comment:3</div>

Ok, I read that whole thread so no one else has to. Ultimately, this is due to broken code that needs to be updated. The GCC developers have done two things:

* Added `-fc-prototypes-external`, to help people fix that broken code.
* In the meantime, they have added a workaround in the form of the (on by default) `-ftail-call-workaround` flag (https://gcc.gnu.org/onlinedocs/gfortran/Code-Gen-Options.html). That keeps the broken code working for now, but the option will eventually be turned off and go away.

The workaround was backported all the way back to gcc-7.x, so really what we should be doing is telling everyone to use a new-enough gfortran. The workaround is in gcc-9.2, and based on the release dates, I presume it's also in 7.5, 8.4, and everything newer than that.

We can probably just update gfortran's spkg-configure.m4 to ensure a new-enough version. Maybe for now it would suffice to check if the `-ftail-call-workaround` flag is supported. That would rule out older compilers from before things were broken, but is easy to implement.



---

archive/issue_comments_457300.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nSee also: #29379 Upgrade R to 3.6.3 (which does not fix these errors)",
    "created_at": "2020-03-20T21:58:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457300",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

See also: #29379 Upgrade R to 3.6.3 (which does not fix these errors)



---

archive/issue_comments_457301.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSee also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)",
    "created_at": "2020-03-21T01:53:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457301",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)



---

archive/issue_comments_457302.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@mkoeppe](#comment:5):\n> See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)\n\nIIRC, the bugs in question (related to passing strings) are in \"canonical\" Fortran Lapack routines, and OpenBLAS does not amend Fortran code",
    "created_at": "2020-03-21T02:47:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457302",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@mkoeppe](#comment:5):
> See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)

IIRC, the bugs in question (related to passing strings) are in "canonical" Fortran Lapack routines, and OpenBLAS does not amend Fortran code



---

archive/issue_events_398010.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-21T14:03:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398010"
}
```



---

archive/issue_events_398011.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-21T14:03:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398011"
}
```



---

archive/issue_comments_457303.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,7 @@\n As reported \n - for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ\n - for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ\n+- for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ\n \n https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n \n``````\n",
    "created_at": "2020-03-21T14:03:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457303",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,7 @@
 As reported 
 - for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ
 - for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ
+- for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ
 
 https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html
 
``````




---

archive/issue_events_398012.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-21T14:03:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "title_is": "Fix R installation errors related to gfortran, or downgrade R to \"experimental\"",
    "title_was": "Fix R installation errors related to gfortran",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398012"
}
```



---

archive/issue_comments_457304.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nOur R 3.6.2 already contains checks in `configure` that are intended to address the problem with the Fortran ABI. On one of the failing platforms, however, I see:\n\n```\n[r-3.6.2.p0] checking if need -fno-optimize-sibling-calls for gfortran... yes\n[r-3.6.2.p0] checking for type of 'hidden' Fortran character lengths... \n[r-3.6.2.p0] checking for xmkmf... no\n```\nwhich looks suspicious (note - no result shown for the type)",
    "created_at": "2020-03-22T00:44:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457304",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

Our R 3.6.2 already contains checks in `configure` that are intended to address the problem with the Fortran ABI. On one of the failing platforms, however, I see:

```
[r-3.6.2.p0] checking if need -fno-optimize-sibling-calls for gfortran... yes
[r-3.6.2.p0] checking for type of 'hidden' Fortran character lengths... 
[r-3.6.2.p0] checking for xmkmf... no
```
which looks suspicious (note - no result shown for the type)



---

archive/issue_comments_457305.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nfrom config.log there:\n\n```\nconfigure:20320: checking for type of 'hidden' Fortran character lengths\n/usr/bin/ld: conftestf.o: relocation R_X86_64_32 against `.rodata' can not be used when making a PIE object; recompile with -fPIC\n/usr/bin/ld: final link failed: nonrepresentable section on output\ncollect2: error: ld returned 1 exit status\nconfigure:20384: result: \n```",
    "created_at": "2020-03-22T00:46:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457305",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">comment:10</div>

from config.log there:

```
configure:20320: checking for type of 'hidden' Fortran character lengths
/usr/bin/ld: conftestf.o: relocation R_X86_64_32 against `.rodata' can not be used when making a PIE object; recompile with -fPIC
/usr/bin/ld: final link failed: nonrepresentable section on output
collect2: error: ld returned 1 exit status
configure:20384: result: 
```



---

archive/issue_comments_457306.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nbug in R's ./configure ?",
    "created_at": "2020-03-22T00:49:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457306",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

bug in R's ./configure ?



---

archive/issue_comments_457307.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nIn any case missing error handling. I'm on it",
    "created_at": "2020-03-22T00:58:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457307",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

In any case missing error handling. I'm on it



---

archive/issue_comments_457308.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAdding `-fPIC` to CFLAGS & FCFLAGS seems to do the trick.",
    "created_at": "2020-03-22T01:24:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457308",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Adding `-fPIC` to CFLAGS & FCFLAGS seems to do the trick.



---

archive/issue_comments_457309.json:
```json
{
    "body": "Branch: **[u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_)**",
    "created_at": "2020-03-22T01:29:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457309",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_)**



---

archive/issue_comments_457310.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2020-03-22T01:29:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457310",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_457311.json:
```json
{
    "body": "Commit: **[`5fbea80`](https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216)**",
    "created_at": "2020-03-22T01:29:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457311",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`5fbea80`](https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216)**



---

archive/issue_comments_457312.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216\"><code>5fbea80</code></a></td><td><code>build/pkgs/r/spkg-install.in: Work around a failing R configure check for hidden Fortran character lengths</code></td></tr></table>\n",
    "created_at": "2020-03-22T01:29:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457312",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216"><code>5fbea80</code></a></td><td><code>build/pkgs/r/spkg-install.in: Work around a failing R configure check for hidden Fortran character lengths</code></td></tr></table>




---

archive/issue_comments_457313.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nTests run at https://github.com/mkoeppe/sage/actions/runs/60562504",
    "created_at": "2020-03-22T01:32:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457313",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

Tests run at https://github.com/mkoeppe/sage/actions/runs/60562504



---

archive/issue_comments_457314.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOne needs to check whether the latest R still has this issue, and notify upstream, if it does.",
    "created_at": "2020-03-22T01:39:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457314",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

One needs to check whether the latest R still has this issue, and notify upstream, if it does.



---

archive/issue_comments_457315.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nsee above - upgrading to the latest release 3.6.3 did not fix the problem. I'll check for unreleased fixes",
    "created_at": "2020-03-22T01:43:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457315",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

see above - upgrading to the latest release 3.6.3 did not fix the problem. I'll check for unreleased fixes



---

archive/issue_comments_457316.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nAlso in R trunk there is no error handling.",
    "created_at": "2020-03-22T01:45:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457316",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

Also in R trunk there is no error handling.



---

archive/issue_comments_457317.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nhttps://github.com/wch/r-source/blob/trunk/configure.ac#L1108\nIn this situation, the macro `R_PROG_FC_CHAR_LEN_T` (from `m4/R.m4`) produces an empty `$r_cv_prog_fc_char_len_t`, which causes the compilation errors. Error checking should be added either in the macro or in the macro call.\n\nUpstream does not have an open bug reporting system. Perhaps an R user can communicate this problem to upstream.",
    "created_at": "2020-03-22T01:54:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457317",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

https://github.com/wch/r-source/blob/trunk/configure.ac#L1108
In this situation, the macro `R_PROG_FC_CHAR_LEN_T` (from `m4/R.m4`) produces an empty `$r_cv_prog_fc_char_len_t`, which causes the compilation errors. Error checking should be added either in the macro or in the macro call.

Upstream does not have an open bug reporting system. Perhaps an R user can communicate this problem to upstream.



---

archive/issue_comments_457318.json:
```json
{
    "body": "Upstream: **Not yet reported upstream; Will do shortly.**",
    "created_at": "2020-03-22T02:01:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457318",
    "user": "https://github.com/dimpase"
}
```

Upstream: **Not yet reported upstream; Will do shortly.**



---

archive/issue_comments_457319.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nShouldn't R also handle the need to add `-fPIC` in its ./configure ?",
    "created_at": "2020-03-22T02:01:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457319",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

Shouldn't R also handle the need to add `-fPIC` in its ./configure ?



---

archive/issue_comments_457320.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI don't really understand what's happening there. It may have to do with the way we compile the gfortran spkg. Note all of the platforms where the failure occured use system gcc but a gfortran from our spkg.",
    "created_at": "2020-03-22T02:05:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457320",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

I don't really understand what's happening there. It may have to do with the way we compile the gfortran spkg. Note all of the platforms where the failure occured use system gcc but a gfortran from our spkg.



---

archive/issue_comments_457321.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nmaybe our gfortran doesn't have the needed workaround in, or perhaps there is a gfortran's default that needs to be turned on at gfortran's build time?",
    "created_at": "2020-03-22T02:10:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457321",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:23" align="right">comment:23</div>

maybe our gfortran doesn't have the needed workaround in, or perhaps there is a gfortran's default that needs to be turned on at gfortran's build time?



---

archive/issue_comments_457322.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nMaybe we should get rid of our gfortran instead of R, at least on the various linux distributions where there are other sane alternatives.",
    "created_at": "2020-03-22T02:11:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457322",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:24" align="right">comment:24</div>

Maybe we should get rid of our gfortran instead of R, at least on the various linux distributions where there are other sane alternatives.



---

archive/issue_comments_457323.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nthere are unfortunate souls that need Sage running on HPC systems, which often have quite outdated software and non-responsive or just absent sysadmins, and so they need to build Sage's toolchain.\n\nI'd spin out the toolchain in a separate package.",
    "created_at": "2020-03-22T02:17:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457323",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:25" align="right">comment:25</div>

there are unfortunate souls that need Sage running on HPC systems, which often have quite outdated software and non-responsive or just absent sysadmins, and so they need to build Sage's toolchain.

I'd spin out the toolchain in a separate package.



---

archive/issue_comments_457324.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI think this is a working fix. I would not want to get rid of the sage distribution's ability to install gfortran. Lots of poorly maintained Linux boxes in universities everywhere.\n\nAnd we already advertise the distribution packages for gfortran and R.",
    "created_at": "2020-03-22T02:17:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457324",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

I think this is a working fix. I would not want to get rid of the sage distribution's ability to install gfortran. Lots of poorly maintained Linux boxes in universities everywhere.

And we already advertise the distribution packages for gfortran and R.



---

archive/issue_events_398013.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-22T03:18:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398013"
}
```



---

archive/issue_comments_457325.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nTests run at https://github.com/mkoeppe/sage/actions/runs/60588138",
    "created_at": "2020-03-22T03:20:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457325",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138



---

archive/issue_comments_457326.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nThis seems to fix the problem. See for example for `ubuntu-bionic-minimal` at https://github.com/mkoeppe/sage/runs/524868489\n\nNeeds review",
    "created_at": "2020-03-22T15:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457326",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

This seems to fix the problem. See for example for `ubuntu-bionic-minimal` at https://github.com/mkoeppe/sage/runs/524868489

Needs review



---

archive/issue_comments_457327.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,15 @@\n+The R spkg does not build from source on many major platforms including ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal, linuxmint-19.3-minimal, archlinux-latest-minimal.\n+\n+On these systems, we use a system gcc with our gfortran 9.2.0.\n+\n As reported \n - for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ\n - for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ\n - for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ\n \n-https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n+The present ticket works around a failure in R's configure script. \n+\n+Related:\n+- https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n \n \n``````\n",
    "created_at": "2020-03-22T15:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457327",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,15 @@
+The R spkg does not build from source on many major platforms including ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal, linuxmint-19.3-minimal, archlinux-latest-minimal.
+
+On these systems, we use a system gcc with our gfortran 9.2.0.
+
 As reported 
 - for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ
 - for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ
 - for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ
 
-https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html
+The present ticket works around a failure in R's configure script. 
+
+Related:
+- https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html
 
 
``````




---

archive/issue_events_398014.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-22T15:15:18Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "title_is": "Fix R installation errors related to gfortran",
    "title_was": "Fix R installation errors related to gfortran, or downgrade R to \"experimental\"",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398014"
}
```



---

archive/issue_comments_457328.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2020-03-22T17:11:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457328",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_events_398015.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-03-22T17:11:39Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "title_is": "Fix R installation errors related to gfortran, or downgrade R to \"experimental\"",
    "title_was": "Fix R installation errors related to gfortran",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398015"
}
```



---

archive/issue_comments_457329.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,15 +1,8 @@\n-The R spkg does not build from source on many major platforms including ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal, linuxmint-19.3-minimal, archlinux-latest-minimal.\n-\n-On these systems, we use a system gcc with our gfortran 9.2.0.\n-\n As reported \n - for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ\n - for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ\n - for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ\n \n-The present ticket works around a failure in R's configure script. \n-\n-Related:\n-- https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n+https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n \n \n``````\n",
    "created_at": "2020-03-22T17:11:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457329",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,15 +1,8 @@
-The R spkg does not build from source on many major platforms including ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal, linuxmint-19.3-minimal, archlinux-latest-minimal.
-
-On these systems, we use a system gcc with our gfortran 9.2.0.
-
 As reported 
 - for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ
 - for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ
 - for 9.1.beta8 in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ
 
-The present ticket works around a failure in R's configure script. 
-
-Related:
-- https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html
+https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html
 
 
``````




---

archive/issue_events_398016.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-03-22T17:11:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398016"
}
```



---

archive/issue_events_398017.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-03-22T17:11:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398017"
}
```



---

archive/issue_comments_457330.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nok, it works.",
    "created_at": "2020-03-22T17:11:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457330",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:30" align="right">comment:30</div>

ok, it works.



---

archive/issue_events_398018.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-03-22T17:12:07Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "title_is": "Fix R installation errors related to gfortran",
    "title_was": "Fix R installation errors related to gfortran, or downgrade R to \"experimental\"",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398018"
}
```



---

archive/issue_comments_457331.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThanks!",
    "created_at": "2020-03-22T17:43:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457331",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

Thanks!



---

archive/issue_comments_457332.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\n`R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any \"normal\" autoconf macros for test programs, doing instead pure shell.",
    "created_at": "2020-03-22T18:04:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457332",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:33" align="right">comment:33</div>

`R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any "normal" autoconf macros for test programs, doing instead pure shell.



---

archive/issue_comments_457333.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@dimpase](#comment:33):\n> `R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any \"normal\" autoconf macros for test programs, doing instead pure shell.\n\nI think you're right and we would wind up with `-fPIC` added for this one check if they had used the autotools magic. Adding `-fPIC` globally works around the issue, but isn't a good long-term solution (Case 3 in https://wiki.gentoo.org/wiki/Project:AMD64/Fixing_-fPIC_Errors_Guide).\n\nSince the compile/link command is hard-coded into `R_PROG_FC_CHAR_LEN_T`, can we append `-fPIC` for just the one check? Then upstream should be able to either do the same thing, or use some autotools stuff to fix it in the future.",
    "created_at": "2020-03-23T18:27:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457333",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@dimpase](#comment:33):
> `R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any "normal" autoconf macros for test programs, doing instead pure shell.

I think you're right and we would wind up with `-fPIC` added for this one check if they had used the autotools magic. Adding `-fPIC` globally works around the issue, but isn't a good long-term solution (Case 3 in https://wiki.gentoo.org/wiki/Project:AMD64/Fixing_-fPIC_Errors_Guide).

Since the compile/link command is hard-coded into `R_PROG_FC_CHAR_LEN_T`, can we append `-fPIC` for just the one check? Then upstream should be able to either do the same thing, or use some autotools stuff to fix it in the future.



---

archive/issue_events_398019.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-25T22:48:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398019"
}
```



---

archive/issue_events_398020.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "3f19c4a8318661e37fb5c93862f2167f6e4dd8e3",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-03-25T22:48:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29170#event-398020"
}
```



---

archive/issue_comments_457334.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_)** to **[`5fbea80`](https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216)**",
    "created_at": "2020-03-25T22:48:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29170",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29170#issuecomment-457334",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/fix_r_installation_errors_related_to_gfortran__or_downgrade_r_to__experimental_)** to **[`5fbea80`](https://github.com/sagemath/sagetrac-mirror/commit/5fbea8059aff0c6d9994a13788ae71e49387d216)**
