# Issue 29585: Remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations

archive/issues_029348.json:
```json
{
    "assignees": [],
    "body": "Follow-up from #26018:\n\nDeclaring some Python packages as PYTHON_TOOLCHAIN helped somewhat, but there are more race conditions with the same failure mechanism: Some Python package byte-compiles modules from a half-installed package, and then finishing the installation of that fails.\n\nOf course, the high parallelization in my automatic runs on [GitHub](../wiki/GitHub) provoke these kinds of errors. But this should be fixed nevertheless.\n\nSee https://github.com/mkoeppe/sage/runs/618645992\n\n```\n  [backports_shutil_get_terminal_size-1.0.0.p1]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.py': File exists\n  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************\n  [backports_shutil_get_terminal_size-1.0.0.p1]   Error copying files for backports_shutil_get_terminal_size-1.0.0.p1.\n  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************\n  [backports_ssl_match_hostname-3.5.0.1.p0] error installing, exit status 1. End of log file:\n  [backports_shutil_get_terminal_size-1.0.0.p1] Full log file: /sage/logs/pkgs/backports_shutil_get_terminal_size-1.0.0.p1.log\n\n\n  [backports_ssl_match_hostname-3.5.0.1.p0]   Copying package files from temporary location /sage/local/var/tmp/sage/build/backports_ssl_match_hostname-3.5.0.1.p0/inst to /sage/local\n  [backports_ssl_match_hostname-3.5.0.1.p0]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.pyc': File exists\n  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************\n  [backports_ssl_match_hostname-3.5.0.1.p0]   Error copying files for backports_ssl_match_hostname-3.5.0.1.p0.\n  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************\n  [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log\n```\n\nAnother occurrence on Cygwin: https://github.com/mkoeppe/sage/runs/638920131?check_suite_focus=true\n\nAnother occurrence: #30831\n\nA new one thanks to recent `pip`'s opportunistic use of `tornado`: \n\n```\n  [tornado-6.0.4]   real\t0m11.342s\n  [tornado-6.0.4]   user\t0m2.041s\n  [tornado-6.0.4]   sys\t0m0.380s\n  [tornado-6.0.4]   Copying package files from temporary location /sage/local/var/tmp/sage/build/tornado-6.0.4/inst to /sage/local\n  [tornado-6.0.4]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/tornado/__pycache__': File exists\n  [tornado-6.0.4]   ************************************************************************\n```\nhttps://github.com/sagemath/sage/runs/2879682001\n\n**In this ticket,** we remove the `DESTDIR` staging for Python packages. It has been redundant since we moved to installing packages via wheels. \n\nAfter this change, the only file that is tracked in `$SAGE_LOCAL/var/lib/sage/installed/pynormaliz-2.14` is the wheel file:\n\n```\n    \"files\": [\n        \"var/lib/sage/wheels/PyNormaliz-2.14-cp39-cp39-macosx_11_0_x86_64.whl\"\n    ]\n}\n```\n\nUninstalling Python packages is now done via `pip`, by means of a new removal script called `spkg-piprm` installed in `$SAGE_LOCAL/var/lib/sage/scripts/SPKG/`.\n\n\n**CC:**  @jhpalmieri @dimpase @embray @kliem\n\n**Keywords:** sd111\n\n**Branch:** [c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)\n\n**Reviewer:** John Palmieri\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/29585\n\n",
    "closed_at": "2021-07-23T20:11:56Z",
    "created_at": "2020-04-26T02:48:42Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations",
    "type": "issue",
    "updated_at": "2021-08-18T16:56:56Z",
    "url": "https://github.com/sagemath/sage/issues/29585",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #26018:

Declaring some Python packages as PYTHON_TOOLCHAIN helped somewhat, but there are more race conditions with the same failure mechanism: Some Python package byte-compiles modules from a half-installed package, and then finishing the installation of that fails.

Of course, the high parallelization in my automatic runs on [GitHub](../wiki/GitHub) provoke these kinds of errors. But this should be fixed nevertheless.

See https://github.com/mkoeppe/sage/runs/618645992

```
  [backports_shutil_get_terminal_size-1.0.0.p1]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.py': File exists
  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************
  [backports_shutil_get_terminal_size-1.0.0.p1]   Error copying files for backports_shutil_get_terminal_size-1.0.0.p1.
  [backports_shutil_get_terminal_size-1.0.0.p1]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0] error installing, exit status 1. End of log file:
  [backports_shutil_get_terminal_size-1.0.0.p1] Full log file: /sage/logs/pkgs/backports_shutil_get_terminal_size-1.0.0.p1.log


  [backports_ssl_match_hostname-3.5.0.1.p0]   Copying package files from temporary location /sage/local/var/tmp/sage/build/backports_ssl_match_hostname-3.5.0.1.p0/inst to /sage/local
  [backports_ssl_match_hostname-3.5.0.1.p0]   cp: cannot create regular file '/sage/local/./lib/python2.7/site-packages/backports/__init__.pyc': File exists
  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0]   Error copying files for backports_ssl_match_hostname-3.5.0.1.p0.
  [backports_ssl_match_hostname-3.5.0.1.p0]   ************************************************************************
  [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log
```

Another occurrence on Cygwin: https://github.com/mkoeppe/sage/runs/638920131?check_suite_focus=true

Another occurrence: #30831

A new one thanks to recent `pip`'s opportunistic use of `tornado`: 

```
  [tornado-6.0.4]   real	0m11.342s
  [tornado-6.0.4]   user	0m2.041s
  [tornado-6.0.4]   sys	0m0.380s
  [tornado-6.0.4]   Copying package files from temporary location /sage/local/var/tmp/sage/build/tornado-6.0.4/inst to /sage/local
  [tornado-6.0.4]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/tornado/__pycache__': File exists
  [tornado-6.0.4]   ************************************************************************
```
https://github.com/sagemath/sage/runs/2879682001

**In this ticket,** we remove the `DESTDIR` staging for Python packages. It has been redundant since we moved to installing packages via wheels. 

After this change, the only file that is tracked in `$SAGE_LOCAL/var/lib/sage/installed/pynormaliz-2.14` is the wheel file:

```
    "files": [
        "var/lib/sage/wheels/PyNormaliz-2.14-cp39-cp39-macosx_11_0_x86_64.whl"
    ]
}
```

Uninstalling Python packages is now done via `pip`, by means of a new removal script called `spkg-piprm` installed in `$SAGE_LOCAL/var/lib/sage/scripts/SPKG/`.


**CC:**  @jhpalmieri @dimpase @embray @kliem

**Keywords:** sd111

**Branch:** [c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)

**Reviewer:** John Palmieri

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/29585





---

archive/issue_events_357164.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-26T02:48:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357164"
}
```



---

archive/issue_events_357165.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-26T02:48:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "08517b",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357165"
}
```



---

archive/issue_events_357166.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-26T02:48:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/critical",
    "label_color": "ff0000",
    "label_name": "critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357166"
}
```



---

archive/issue_events_357167.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-26T02:48:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357167"
}
```



---

archive/issue_comments_468431.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nVarious fixes are possible here:\n- More dependencies need to be added\n- Copying from the staging dir needs to make Python package directory creation atomic (by copying to a temp name in the destination directory, followed by an (atomic) mv of the directory)\n- It should be checked if current versions of pip are safe for concurrent use so we don't have to reinvent the wheel",
    "created_at": "2020-04-26T19:01:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468431",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'>**Comment 1:**</a>
Various fixes are possible here:
- More dependencies need to be added
- Copying from the staging dir needs to make Python package directory creation atomic (by copying to a temp name in the destination directory, followed by an (atomic) mv of the directory)
- It should be checked if current versions of pip are safe for concurrent use so we don't have to reinvent the wheel



---

archive/issue_comments_468432.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\nIn general, I think that package installation can't be atomic, since we need to move things to SAGE_LOCAL/lib and SAGE_LOCAL/include, and we can't just create a directory temp/lib and move it to SAGE_LOCAL without overwriting the existing one. But maybe this could work with Python packages. Rewrite `sdh_pip_install`?",
    "created_at": "2020-04-26T20:22:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468432",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'>**Comment 2:**</a>
In general, I think that package installation can't be atomic, since we need to move things to SAGE_LOCAL/lib and SAGE_LOCAL/include, and we can't just create a directory temp/lib and move it to SAGE_LOCAL without overwriting the existing one. But maybe this could work with Python packages. Rewrite `sdh_pip_install`?



---

archive/issue_comments_468433.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nYes, I mean specifically for Python packages.",
    "created_at": "2020-04-26T20:23:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468433",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'>**Comment 3:**</a>
Yes, I mean specifically for Python packages.



---

archive/issue_comments_468434.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nReplying to [@jhpalmieri](#comment%3A2):\n> Rewrite `sdh_pip_install`?\n\nI think the copy-from-staging-dir code could just deal with the Python directories specially. We are working around another problem (lib64) with that code already anyway.\n\nThis would solve it even for Python packages that are not installed using pip currently (#29500).",
    "created_at": "2020-04-26T20:39:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468434",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'>**Comment 4:**</a>
Replying to [@jhpalmieri](#comment%3A2):
> Rewrite `sdh_pip_install`?

I think the copy-from-staging-dir code could just deal with the Python directories specially. We are working around another problem (lib64) with that code already anyway.

This would solve it even for Python packages that are not installed using pip currently (#29500).



---

archive/issue_comments_468435.json:
```json
{
    "body": "<a id='comment:5'>**Comment 5:**</a>\nIn fact (when `SAGE_SUDO` is unset), the whole code should actually recursively move, instead of copy, directories. This will be much faster too (the staged directory is already on the same filesystem)",
    "created_at": "2020-04-26T21:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468435",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'>**Comment 5:**</a>
In fact (when `SAGE_SUDO` is unset), the whole code should actually recursively move, instead of copy, directories. This will be much faster too (the staged directory is already on the same filesystem)



---

archive/issue_comments_468436.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\n`mv` vs `cp` was discussed at #26011.\n\nSomething like the following (rough draft, untested)?\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 5cdd55db3f..0f8acf9b97 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -946,6 +946,12 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     # Generate installed file manifest\n     FILE_LIST=\"$(cd \"$PREFIX\" && find . -type f -o -type l | sed 's|^\\./||' | sort)\"\n \n+    if [ -d \"$PREFIX\"/lib/python*/site-packages/ ]; then\n+        echo \"This is a Python package: moving site-package directories atomically.\"\n+        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')\n+        $SAGE_SUDO mv \"$PREFIX\"/lib/python*/site-packages/* \"$SITE_PACKAGES\"\n+    fi\n+\n     # Copy files into $SAGE_LOCAL\n     $SAGE_SUDO cp -Rp \"$PREFIX/.\" \"$SAGE_LOCAL\"\n     if [ $? -ne 0 ]; then\n```",
    "created_at": "2020-04-26T21:40:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468436",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'>**Comment 6:**</a>
`mv` vs `cp` was discussed at #26011.

Something like the following (rough draft, untested)?

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 5cdd55db3f..0f8acf9b97 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -946,6 +946,12 @@ if [ -d "$SAGE_DESTDIR" ]; then
     # Generate installed file manifest
     FILE_LIST="$(cd "$PREFIX" && find . -type f -o -type l | sed 's|^\./||' | sort)"
 
+    if [ -d "$PREFIX"/lib/python*/site-packages/ ]; then
+        echo "This is a Python package: moving site-package directories atomically."
+        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')
+        $SAGE_SUDO mv "$PREFIX"/lib/python*/site-packages/* "$SITE_PACKAGES"
+    fi
+
     # Copy files into $SAGE_LOCAL
     $SAGE_SUDO cp -Rp "$PREFIX/." "$SAGE_LOCAL"
     if [ $? -ne 0 ]; then
```



---

archive/issue_comments_468437.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nReplying to [@jhpalmieri](#comment%3A6):\n> `mv` vs `cp` was discussed at #26011.\n\nThanks for the pointer. The `mv --recursive` that Erik is asking about in that thread, is exactly what would need to be implemented - best in Python (as also discussed in that thread).\n\n> Something like the following (rough draft, untested)?\n> \n> ```diff\n> diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\n> index 5cdd55db3f..0f8acf9b97 100755\n> --- a/build/bin/sage-spkg\n> +++ b/build/bin/sage-spkg\n> @@ -946,6 +946,12 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n>      # Generate installed file manifest\n>      FILE_LIST=\"$(cd \"$PREFIX\" && find . -type f -o -type l | sed 's|^\\./||' | sort)\"\n>  \n> +    if [ -d \"$PREFIX\"/lib/python*/site-packages/ ]; then\n> +        echo \"This is a Python package: moving site-package directories atomically.\"\n> +        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')\n> +        $SAGE_SUDO mv \"$PREFIX\"/lib/python*/site-packages/* \"$SITE_PACKAGES\"\n> +    fi\n> +\n>      # Copy files into $SAGE_LOCAL\n>      $SAGE_SUDO cp -Rp \"$PREFIX/.\" \"$SAGE_LOCAL\"\n>      if [ $? -ne 0 ]; then\n> ```\n\nThat could work, but I think I would prefer the more general solution.",
    "created_at": "2020-04-26T21:50:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468437",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'>**Comment 7:**</a>
Replying to [@jhpalmieri](#comment%3A6):
> `mv` vs `cp` was discussed at #26011.

Thanks for the pointer. The `mv --recursive` that Erik is asking about in that thread, is exactly what would need to be implemented - best in Python (as also discussed in that thread).

> Something like the following (rough draft, untested)?
> 
> ```diff
> diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
> index 5cdd55db3f..0f8acf9b97 100755
> --- a/build/bin/sage-spkg
> +++ b/build/bin/sage-spkg
> @@ -946,6 +946,12 @@ if [ -d "$SAGE_DESTDIR" ]; then
>      # Generate installed file manifest
>      FILE_LIST="$(cd "$PREFIX" && find . -type f -o -type l | sed 's|^\./||' | sort)"
>  
> +    if [ -d "$PREFIX"/lib/python*/site-packages/ ]; then
> +        echo "This is a Python package: moving site-package directories atomically."
> +        SITE_PACKAGES=$(python -c 'import site; print(site.getsitepackages()[0])')
> +        $SAGE_SUDO mv "$PREFIX"/lib/python*/site-packages/* "$SITE_PACKAGES"
> +    fi
> +
>      # Copy files into $SAGE_LOCAL
>      $SAGE_SUDO cp -Rp "$PREFIX/." "$SAGE_LOCAL"
>      if [ $? -ne 0 ]; then
> ```

That could work, but I think I would prefer the more general solution.



---

archive/issue_comments_468438.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nThis could be done in some 20 lines of code I guess that would take care of getting the intended concurrency semantics right. Basically try to move a source directory to the target, handling EEXIST and in that case recursing instead.",
    "created_at": "2020-04-26T21:55:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468438",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'>**Comment 8:**</a>
This could be done in some 20 lines of code I guess that would take care of getting the intended concurrency semantics right. Basically try to move a source directory to the target, handling EEXIST and in that case recursing instead.



---

archive/issue_comments_468439.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nThe new script would also \n- make sure that the permissions are correct (avoiding the problems with readonly files that we encountered in #29082); \n- handle the intended semantics of copying symlinks to directory over symlinks (as needed for `lib64`) and \n- issue warnings when concurrent writes to the same file (not directory) / writes to existing files are detected.",
    "created_at": "2020-04-26T22:22:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468439",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'>**Comment 9:**</a>
The new script would also 
- make sure that the permissions are correct (avoiding the problems with readonly files that we encountered in #29082); 
- handle the intended semantics of copying symlinks to directory over symlinks (as needed for `lib64`) and 
- issue warnings when concurrent writes to the same file (not directory) / writes to existing files are detected.



---

archive/issue_comments_468440.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nReference: https://rcrowley.org/2010/01/06/things-unix-can-do-atomically.html",
    "created_at": "2020-04-27T19:53:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468440",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'>**Comment 10:**</a>
Reference: https://rcrowley.org/2010/01/06/things-unix-can-do-atomically.html



---

archive/issue_comments_468441.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nHa, yes, I stumbled on that website, too.",
    "created_at": "2020-04-27T21:01:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468441",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'>**Comment 11:**</a>
Ha, yes, I stumbled on that website, too.



---

archive/issue_comments_468442.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -23,3 +23,6 @@\n   [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log\n ```\n \n+Another occurrence on Cygwin: https://github.com/mkoeppe/sage/runs/638920131?check_suite_focus=true\n+\n+\n``````\n",
    "created_at": "2020-05-02T20:37:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468442",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -23,3 +23,6 @@
   [backports_ssl_match_hostname-3.5.0.1.p0] Full log file: /sage/logs/pkgs/backports_ssl_match_hostname-3.5.0.1.p0.log
 ```
 
+Another occurrence on Cygwin: https://github.com/mkoeppe/sage/runs/638920131?check_suite_focus=true
+
+
``````




---

archive/issue_events_357168.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-05T17:58:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357168"
}
```



---

archive/issue_events_357169.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-05T17:58:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357169"
}
```



---

archive/issue_comments_468443.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nI think this sort of issue was solved a long time ago with `sage-pip-install`, and its use of `sage-flock` to prevent pip installing more than one package simultaneously.\n\nUnfortunately, with the switch to the DESTDIR system, while this is probably still helpful, it doesn't help during copying of files into SAGE_LOCAL.\n\nPerhaps the pip-lock should also be held when copying packages into $SAGE_LOCAL (don't even bother checking if it's an actual Python package; just prevent copying anything into $SAGE_LOCAL without holding the pip-lock).",
    "created_at": "2020-08-31T16:23:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468443",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'>**Comment 14:**</a>
I think this sort of issue was solved a long time ago with `sage-pip-install`, and its use of `sage-flock` to prevent pip installing more than one package simultaneously.

Unfortunately, with the switch to the DESTDIR system, while this is probably still helpful, it doesn't help during copying of files into SAGE_LOCAL.

Perhaps the pip-lock should also be held when copying packages into $SAGE_LOCAL (don't even bother checking if it's an actual Python package; just prevent copying anything into $SAGE_LOCAL without holding the pip-lock).



---

archive/issue_comments_468444.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\nIn 9.3 I hope to switch installation of all Python packages from DESTDIR to use pip wheel - see #29500.",
    "created_at": "2020-08-31T16:45:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468444",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'>**Comment 15:**</a>
In 9.3 I hope to switch installation of all Python packages from DESTDIR to use pip wheel - see #29500.



---

archive/issue_events_357170.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-08T17:31:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357170"
}
```



---

archive/issue_events_357171.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-08T17:31:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357171"
}
```



---

archive/issue_comments_468445.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -25,4 +25,5 @@\n \n Another occurrence on Cygwin: https://github.com/mkoeppe/sage/runs/638920131?check_suite_focus=true\n \n+Another occurrence: #30831\n \n``````\n",
    "created_at": "2020-11-02T22:53:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468445",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -25,4 +25,5 @@
 
 Another occurrence on Cygwin: https://github.com/mkoeppe/sage/runs/638920131?check_suite_focus=true
 
+Another occurrence: #30831
 
``````




---

archive/issue_comments_468446.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nHoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468446",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'>**Comment 18:**</a>
Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_468447.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468447",
    "user": "https://github.com/mkoeppe"
}
```

**Changing keywords** from "" to "sd111".



---

archive/issue_comments_468448.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468448",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'>**Comment 19:**</a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_357172.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357172"
}
```



---

archive/issue_events_357173.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357173"
}
```



---

archive/issue_comments_468449.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -27,3 +27,14 @@\n \n Another occurrence: #30831\n \n+A new one thanks to recent `pip`'s opportunistic use of `tornado`: \n+\n+```\n+  [tornado-6.0.4]   real\t0m11.342s\n+  [tornado-6.0.4]   user\t0m2.041s\n+  [tornado-6.0.4]   sys\t0m0.380s\n+  [tornado-6.0.4]   Copying package files from temporary location /sage/local/var/tmp/sage/build/tornado-6.0.4/inst to /sage/local\n+  [tornado-6.0.4]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/tornado/__pycache__': File exists\n+  [tornado-6.0.4]   ************************************************************************\n+```\n+https://github.com/sagemath/sage/runs/2879682001\n``````\n",
    "created_at": "2021-06-22T13:58:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468449",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -27,3 +27,14 @@
 
 Another occurrence: #30831
 
+A new one thanks to recent `pip`'s opportunistic use of `tornado`: 
+
+```
+  [tornado-6.0.4]   real	0m11.342s
+  [tornado-6.0.4]   user	0m2.041s
+  [tornado-6.0.4]   sys	0m0.380s
+  [tornado-6.0.4]   Copying package files from temporary location /sage/local/var/tmp/sage/build/tornado-6.0.4/inst to /sage/local
+  [tornado-6.0.4]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/tornado/__pycache__': File exists
+  [tornado-6.0.4]   ************************************************************************
+```
+https://github.com/sagemath/sage/runs/2879682001
``````




---

archive/issue_comments_468450.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -38,3 +38,17 @@\n   [tornado-6.0.4]   ************************************************************************\n ```\n https://github.com/sagemath/sage/runs/2879682001\n+\n+**In this ticket,** we remove the `DESTDIR` staging for Python packages. It has been redundant since we moved to installing packages via wheels. \n+\n+After this change, the only file that is tracked in `$SAGE_LOCAL/var/lib/sage/installed/pynormaliz-2.14` is the wheel file:\n+\n+```\n+    \"files\": [\n+        \"var/lib/sage/wheels/PyNormaliz-2.14-cp39-cp39-macosx_11_0_x86_64.whl\"\n+    ]\n+}\n+```\n+\n+Uninstalling Python packages is now done via pip.\n+\n``````\n",
    "created_at": "2021-06-22T16:38:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468450",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -38,3 +38,17 @@
   [tornado-6.0.4]   ************************************************************************
 ```
 https://github.com/sagemath/sage/runs/2879682001
+
+**In this ticket,** we remove the `DESTDIR` staging for Python packages. It has been redundant since we moved to installing packages via wheels. 
+
+After this change, the only file that is tracked in `$SAGE_LOCAL/var/lib/sage/installed/pynormaliz-2.14` is the wheel file:
+
+```
+    "files": [
+        "var/lib/sage/wheels/PyNormaliz-2.14-cp39-cp39-macosx_11_0_x86_64.whl"
+    ]
+}
+```
+
+Uninstalling Python packages is now done via pip.
+
``````




---

archive/issue_comments_468451.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir)",
    "created_at": "2021-06-22T21:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468451",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir)



---

archive/issue_comments_468452.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3b435d972a72feada67f65a8c96796952a91ac90\">3b435d9</a></td><td><code>build/bin/sage-dist-helpers (sdh_store_and_pip_install_wheel): Record name of installed distribution name</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/34bd4459deb61a8430733a3b88a96fd0dbede243\">34bd445</a></td><td><code>sdh_pip_uninstall (sdh_pip_uninstall): New helper functtion; use same flags in 'make SPKG-clean' for pip packages</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/49af8aa45b40ae471e4748a7f343f8050df6383e\">49af8aa</a></td><td><code>build/bin/sage-spkg, build/sage_bootstrap/uninstall.py: Prepare/install/use the spkg-piprm script</code></td></tr></table>\n",
    "created_at": "2021-06-23T00:04:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468452",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:23'>**Comment 23:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3b435d972a72feada67f65a8c96796952a91ac90">3b435d9</a></td><td><code>build/bin/sage-dist-helpers (sdh_store_and_pip_install_wheel): Record name of installed distribution name</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/34bd4459deb61a8430733a3b88a96fd0dbede243">34bd445</a></td><td><code>sdh_pip_uninstall (sdh_pip_uninstall): New helper functtion; use same flags in 'make SPKG-clean' for pip packages</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/49af8aa45b40ae471e4748a7f343f8050df6383e">49af8aa</a></td><td><code>build/bin/sage-spkg, build/sage_bootstrap/uninstall.py: Prepare/install/use the spkg-piprm script</code></td></tr></table>




---

archive/issue_comments_468453.json:
```json
{
    "body": "**Commit:** [49af8aa45b40ae471e4748a7f343f8050df6383e](https://github.com/sagemath/sagetrac-mirror/commit/49af8aa45b40ae471e4748a7f343f8050df6383e)",
    "created_at": "2021-06-23T00:04:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468453",
    "user": "https://github.com/sagetrac-git"
}
```

**Commit:** [49af8aa45b40ae471e4748a7f343f8050df6383e](https://github.com/sagemath/sagetrac-mirror/commit/49af8aa45b40ae471e4748a7f343f8050df6383e)



---

archive/issue_events_357174.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-23T00:06:48Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "rename": {
        "from": "More race conditions with Python package installations because of DESTDIR",
        "to": "Remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357174"
}
```



---

archive/issue_comments_468454.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2021-06-23T00:06:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468454",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_468455.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -50,5 +50,5 @@\n }\n ```\n \n-Uninstalling Python packages is now done via pip.\n+Uninstalling Python packages is now done via `pip`, by means of a new removal script called `spkg-piprm` installed in `$SAGE_LOCAL/var/lib/sage/scripts/SPKG/`.\n \n``````\n",
    "created_at": "2021-06-23T00:06:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468455",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -50,5 +50,5 @@
 }
 ```
 
-Uninstalling Python packages is now done via pip.
+Uninstalling Python packages is now done via `pip`, by means of a new removal script called `spkg-piprm` installed in `$SAGE_LOCAL/var/lib/sage/scripts/SPKG/`.
 
``````




---

archive/issue_events_357175.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-23T00:25:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357175"
}
```



---

archive/issue_comments_468456.json:
```json
{
    "body": "<a id='comment:27'>**Comment 27:**</a>\n- It would be good to document `sdh_pip_uninstall`, both at the top of the file and in the developer's guide.\n\n- Unindent the block in `sage-spkg` starting on line 449? The block right after the comment \"Extract the package\" \u2014\u00a0you deleted the enclosing `if` and `fi` but left the block indented.\n\n- Typo: \"pacakges\" on line 538 of `sage-spkg`.\n\n- Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?\n\nThe changes make sense, but it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.",
    "created_at": "2021-07-08T01:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468456",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>**Comment 27:**</a>
- It would be good to document `sdh_pip_uninstall`, both at the top of the file and in the developer's guide.

- Unindent the block in `sage-spkg` starting on line 449? The block right after the comment "Extract the package" — you deleted the enclosing `if` and `fi` but left the block indented.

- Typo: "pacakges" on line 538 of `sage-spkg`.

- Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?

The changes make sense, but it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.



---

archive/issue_comments_468457.json:
```json
{
    "body": "<a id='comment:28'>**Comment 28:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ecd49fb5900e8cc8139efc3c50b6f8aed14c16df\">ecd49fb</a></td><td><code>build/bin/sage-dist-helpers, src/doc/en/developer/packaging.rst: Document sdh_pip_uninstall</code></td></tr></table>\n",
    "created_at": "2021-07-08T01:15:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468457",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:28'>**Comment 28:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ecd49fb5900e8cc8139efc3c50b6f8aed14c16df">ecd49fb</a></td><td><code>build/bin/sage-dist-helpers, src/doc/en/developer/packaging.rst: Document sdh_pip_uninstall</code></td></tr></table>




---

archive/issue_comments_468458.json:
```json
{
    "body": "**Changing commit** from \"[49af8aa45b40ae471e4748a7f343f8050df6383e](https://github.com/sagemath/sagetrac-mirror/commit/49af8aa45b40ae471e4748a7f343f8050df6383e)\" to \"[ecd49fb5900e8cc8139efc3c50b6f8aed14c16df](https://github.com/sagemath/sagetrac-mirror/commit/ecd49fb5900e8cc8139efc3c50b6f8aed14c16df)\".",
    "created_at": "2021-07-08T01:15:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468458",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[49af8aa45b40ae471e4748a7f343f8050df6383e](https://github.com/sagemath/sagetrac-mirror/commit/49af8aa45b40ae471e4748a7f343f8050df6383e)" to "[ecd49fb5900e8cc8139efc3c50b6f8aed14c16df](https://github.com/sagemath/sagetrac-mirror/commit/ecd49fb5900e8cc8139efc3c50b6f8aed14c16df)".



---

archive/issue_comments_468459.json:
```json
{
    "body": "**Changing commit** from \"[ecd49fb5900e8cc8139efc3c50b6f8aed14c16df](https://github.com/sagemath/sagetrac-mirror/commit/ecd49fb5900e8cc8139efc3c50b6f8aed14c16df)\" to \"[c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)\".",
    "created_at": "2021-07-08T01:17:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468459",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[ecd49fb5900e8cc8139efc3c50b6f8aed14c16df](https://github.com/sagemath/sagetrac-mirror/commit/ecd49fb5900e8cc8139efc3c50b6f8aed14c16df)" to "[c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)".



---

archive/issue_comments_468460.json:
```json
{
    "body": "<a id='comment:29'>**Comment 29:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c\">c3eeb69</a></td><td><code>build/bin/sage-spkg: Fix typo in comment, unindent a block</code></td></tr></table>\n",
    "created_at": "2021-07-08T01:17:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468460",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:29'>**Comment 29:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c">c3eeb69</a></td><td><code>build/bin/sage-spkg: Fix typo in comment, unindent a block</code></td></tr></table>




---

archive/issue_comments_468461.json:
```json
{
    "body": "<a id='comment:30'>**Comment 30:**</a>\nReplying to [@jhpalmieri](#comment%3A27):\n> - Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?\n\nYes, exactly",
    "created_at": "2021-07-08T01:18:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468461",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'>**Comment 30:**</a>
Replying to [@jhpalmieri](#comment%3A27):
> - Was the variable `USE_LOCAL_SCRIPTS` essentially used to distinguish between old-stye and new-style packages?

Yes, exactly



---

archive/issue_comments_468462.json:
```json
{
    "body": "<a id='comment:31'>**Comment 31:**</a>\nReplying to [@jhpalmieri](#comment%3A27):\n> it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.\n\nBased on the failing runs that I have seen on GH Actions, I would estimate 1 in 30 to 1 in 200 runs fail...\n\nIn any case, there's another reason why we should make this change: Whenever a user uses `sage -pip install` to install any package, this can update various other Python packages as a side effect. So the installation records that the DESTDIR staging uses easily get out of sync with what's actually installed, making uninstallation by this method basically a gamble.",
    "created_at": "2021-07-08T01:23:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468462",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'>**Comment 31:**</a>
Replying to [@jhpalmieri](#comment%3A27):
> it's hard for me to test them because I can't reproduce the race conditions. I've tried `make -j20` on a pretty fast computer, but no luck so far.

Based on the failing runs that I have seen on GH Actions, I would estimate 1 in 30 to 1 in 200 runs fail...

In any case, there's another reason why we should make this change: Whenever a user uses `sage -pip install` to install any package, this can update various other Python packages as a side effect. So the installation records that the DESTDIR staging uses easily get out of sync with what's actually installed, making uninstallation by this method basically a gamble.



---

archive/issue_comments_468463.json:
```json
{
    "body": "<a id='comment:32'>**Comment 32:**</a>\nNot for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):\n\n```\nUninstalling existing 'numpy'\nRunning pip-uninstall script for 'numpy'\nWARNING: Skipping numpy as it is not installed.\nRemoving stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'\n```\nFor this ticket: if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?\n\nI also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior? Maybe I don't understand your last post about how uninstallation is supposed to work.",
    "created_at": "2021-07-08T02:54:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468463",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:32'>**Comment 32:**</a>
Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):

```
Uninstalling existing 'numpy'
Running pip-uninstall script for 'numpy'
WARNING: Skipping numpy as it is not installed.
Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'
```
For this ticket: if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?

I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior? Maybe I don't understand your last post about how uninstallation is supposed to work.



---

archive/issue_comments_468464.json:
```json
{
    "body": "<a id='comment:33'>**Comment 33:**</a>\nReplying to [@jhpalmieri](#comment%3A32):\n> I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior?\n\n`jupyterlab_widgets` and `nodejs` are script packages; we keep track of their installation by creating an empty stamp file in `...installed`.  The present ticket makes no changes to script packages.  There is no uninstallation procedure for script packages at all - only the stamp file is removed. (Only `sagelib-clean` and `sage_docbuild-clean` are defined directly in `build/make/Makefile.in`.)\n\n`jupyterlab` is a pip package; we do not keep installation records for them. The present ticket makes no changes to pip packages either.  Uninstallation is done using `sage --pip uninstall` (invoked by the makefile).",
    "created_at": "2021-07-08T03:59:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468464",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'>**Comment 33:**</a>
Replying to [@jhpalmieri](#comment%3A32):
> I also tried `make jupyterlab_widgets`, but it didn't write anything in `local/var/lib/sage/scripts`. This installed the packages `jupyterlab`, `nodejs`, and `jupyterlab_widgets`, at least according to the files in `logs/pkgs`, but there is no corresponding `jupyterlab` file in `local/var/lib/sage/installed`. The files for `nodejs` and `jupyterlab_widgets` are empty. `make jupyterlab-clean` did not remove `jupyterlab_widgets`. Is this the expected behavior?

`jupyterlab_widgets` and `nodejs` are script packages; we keep track of their installation by creating an empty stamp file in `...installed`.  The present ticket makes no changes to script packages.  There is no uninstallation procedure for script packages at all - only the stamp file is removed. (Only `sagelib-clean` and `sage_docbuild-clean` are defined directly in `build/make/Makefile.in`.)

`jupyterlab` is a pip package; we do not keep installation records for them. The present ticket makes no changes to pip packages either.  Uninstallation is done using `sage --pip uninstall` (invoked by the makefile).



---

archive/issue_comments_468465.json:
```json
{
    "body": "<a id='comment:34'>**Comment 34:**</a>\nReplying to [@jhpalmieri](#comment%3A32):\n> if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?\n\nNo, I don't think so. Neither our current build system (before the present ticket) nor `pip` do this. \n\n(Reinstallation of packages depending on `numpy` is instead triggered by a reinstallation of `numpy`.)",
    "created_at": "2021-07-08T04:01:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468465",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'>**Comment 34:**</a>
Replying to [@jhpalmieri](#comment%3A32):
> if I do `make numpy-clean`, should it also uninstall the packages that depend on numpy?

No, I don't think so. Neither our current build system (before the present ticket) nor `pip` do this. 

(Reinstallation of packages depending on `numpy` is instead triggered by a reinstallation of `numpy`.)



---

archive/issue_comments_468466.json:
```json
{
    "body": "<a id='comment:35'>**Comment 35:**</a>\nReplying to [@jhpalmieri](#comment%3A32):\n> Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):\n> \n> ```\n> Uninstalling existing 'numpy'\n> Running pip-uninstall script for 'numpy'\n> WARNING: Skipping numpy as it is not installed.\n> Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'\n> ```\n\nI think this warning will only show up if you switch between branches with and without this ticket.",
    "created_at": "2021-07-08T04:22:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468466",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'>**Comment 35:**</a>
Replying to [@jhpalmieri](#comment%3A32):
> Not for this ticket, but I really don't like the warning message here (when running `make numpy-clean`):
> 
> ```
> Uninstalling existing 'numpy'
> Running pip-uninstall script for 'numpy'
> WARNING: Skipping numpy as it is not installed.
> Removing stamp file '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta4/local/var/lib/sage/installed/numpy-1.20.3'
> ```

I think this warning will only show up if you switch between branches with and without this ticket.



---

archive/issue_comments_468467.json:
```json
{
    "body": "<a id='comment:36'>**Comment 36:**</a>\nIs `pip` better at atomic actions?",
    "created_at": "2021-07-13T03:04:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468467",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:36'>**Comment 36:**</a>
Is `pip` better at atomic actions?



---

archive/issue_comments_468468.json:
```json
{
    "body": "<a id='comment:37'>**Comment 37:**</a>\nReplying to [@jhpalmieri](#comment%3A36):\n> Is `pip` better at atomic actions?\n\nI don't know, but we do not depend on it to be because we are holding a lock while installing a wheel, in `build/bin/sage-pip-install`. This was added in #21672.",
    "created_at": "2021-07-13T03:28:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468468",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'>**Comment 37:**</a>
Replying to [@jhpalmieri](#comment%3A36):
> Is `pip` better at atomic actions?

I don't know, but we do not depend on it to be because we are holding a lock while installing a wheel, in `build/bin/sage-pip-install`. This was added in #21672.



---

archive/issue_events_357176.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-07-13T04:09:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357176"
}
```



---

archive/issue_events_357177.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-07-13T04:09:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357177"
}
```



---

archive/issue_comments_468469.json:
```json
{
    "body": "**Reviewer:** John Palmieri",
    "created_at": "2021-07-13T04:09:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468469",
    "user": "https://github.com/jhpalmieri"
}
```

**Reviewer:** John Palmieri



---

archive/issue_comments_468470.json:
```json
{
    "body": "<a id='comment:38'>**Comment 38:**</a>\nOkay, let's merge it so it gets more testing.",
    "created_at": "2021-07-13T04:09:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468470",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:38'>**Comment 38:**</a>
Okay, let's merge it so it gets more testing.



---

archive/issue_comments_468471.json:
```json
{
    "body": "<a id='comment:39'>**Comment 39:**</a>\nThanks!",
    "created_at": "2021-07-13T04:11:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468471",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'>**Comment 39:**</a>
Thanks!



---

archive/issue_events_357178.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-23T20:11:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357178"
}
```



---

archive/issue_events_357179.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "7e2e19731f5462e31b665590273719878b17d92f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-07-23T20:11:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29585#event-357179"
}
```



---

archive/issue_comments_468472.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir)\" to \"[c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)\".",
    "created_at": "2021-07-23T20:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468472",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/more_race_conditions_with_python_package_installations_because_of_destdir)" to "[c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)".



---

archive/issue_comments_468473.json:
```json
{
    "body": "<a id='comment:41'>**Comment 41:**</a>\nA crucial commit was missing on this branch. Follow-up in #32361.",
    "created_at": "2021-08-10T18:47:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468473",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'>**Comment 41:**</a>
A crucial commit was missing on this branch. Follow-up in #32361.



---

archive/issue_comments_468474.json:
```json
{
    "body": "**Changing commit** from \"[c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)\" to \"\".",
    "created_at": "2021-08-10T18:47:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468474",
    "user": "https://github.com/mkoeppe"
}
```

**Changing commit** from "[c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c](https://github.com/sagemath/sagetrac-mirror/commit/c3eeb69f78412ed0d8ad4c7aebdb834b512aad3c)" to "".



---

archive/issue_comments_468475.json:
```json
{
    "body": "<a id='comment:42'>**Comment 42:**</a>\nI'm at peace with this solution :)",
    "created_at": "2021-08-18T16:56:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29585#issuecomment-468475",
    "user": "https://github.com/embray"
}
```

<a id='comment:42'>**Comment 42:**</a>
I'm at peace with this solution :)
