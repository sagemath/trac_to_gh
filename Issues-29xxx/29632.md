# Issue 29632: segfault in `is_identity` morphism check over number fields

archive/issues_029395.json:
```json
{
    "body": "The following causes a segmentation fault for the identity morphism of polynomial rings over number fields:\n\n```\nsage: R.<x,y> = QuadraticField(-1)[]\nsage: f = R.hom(R.gens(), R)\nsage: f.is_identity()\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\n```\nThis does not happen for morphisms that are not the identity.\n\nThis bug was introduced between Sage 8.1 and 8.6.\n\nBranch/Commit: cc615da49f920606189225d7287c3c8d382dd32a\n\nReviewer: John Cremona, Markus Wageringel\n\nAuthor: Peter Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29632\n\n",
    "closed_at": "2021-03-07T17:06:24Z",
    "created_at": "2020-05-01T19:42:47Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "segfault in `is_identity` morphism check over number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29632",
    "user": "https://github.com/mwageringel"
}
```
The following causes a segmentation fault for the identity morphism of polynomial rings over number fields:

```
sage: R.<x,y> = QuadraticField(-1)[]
sage: f = R.hom(R.gens(), R)
sage: f.is_identity()
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
```
This does not happen for morphisms that are not the identity.

This bug was introduced between Sage 8.1 and 8.6.

Branch/Commit: cc615da49f920606189225d7287c3c8d382dd32a

Reviewer: John Cremona, Markus Wageringel

Author: Peter Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29632





---

archive/issue_events_085458.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29632#event-85458"
}
```



---

archive/issue_comments_580728.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe following also causes the crash:\n\n```\nsage: K.<a> = QuadraticField(-1)\nsage: R.<x,y> = K[]\nsage: h = y._lmul_(QQ.one())\n```",
    "created_at": "2021-02-20T11:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580728",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:2'></a>
The following also causes the crash:

```
sage: K.<a> = QuadraticField(-1)
sage: R.<x,y> = K[]
sage: h = y._lmul_(QQ.one())
```



---

archive/issue_comments_580729.json:
```json
{
    "body": "<a id='comment:3'></a>\nIn the original example this `_lmul_()` call happens in `sage.categories.morphism.Morphism._richcmp_()`.  The problem may be that the parent of the argument is not the scalar ring of the module element, but a smaller ring.",
    "created_at": "2021-02-20T11:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580729",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:3'></a>
In the original example this `_lmul_()` call happens in `sage.categories.morphism.Morphism._richcmp_()`.  The problem may be that the parent of the argument is not the scalar ring of the module element, but a smaller ring.



---

archive/issue_comments_580730.json:
```json
{
    "body": "Changing branch from \"\" to \"u/pbruin/ticket/29632-morphism_comparison\"",
    "created_at": "2021-02-22T07:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580730",
    "user": "https://github.com/pjbruin"
}
```

Changing branch from "" to "u/pbruin/ticket/29632-morphism_comparison"



---

archive/issue_comments_580731.json:
```json
{
    "body": "Changing author from \"\" to \"Peter Bruin\"",
    "created_at": "2021-02-22T07:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580731",
    "user": "https://github.com/pjbruin"
}
```

Changing author from "" to "Peter Bruin"



---

archive/issue_comments_580732.json:
```json
{
    "body": "<a id='comment:4'></a>\nHere is a patch.  According to documentation in `sage.structure.coerce_actions`, the `_lmul_()` and `_rmul_()` methods may assume that the input lies in the base ring, so we have to ensure this in the calling function.",
    "created_at": "2021-02-22T07:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580732",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:4'></a>
Here is a patch.  According to documentation in `sage.structure.coerce_actions`, the `_lmul_()` and `_rmul_()` methods may assume that the input lies in the base ring, so we have to ensure this in the calling function.



---

archive/issue_comments_580733.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-22T07:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580733",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_580734.json:
```json
{
    "body": "Changing commit from \"\" to \"b05dbc256c8fee1e5b4e3d7d60e6049a82ecfd99\"",
    "created_at": "2021-02-22T07:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580734",
    "user": "https://github.com/pjbruin"
}
```

Changing commit from "" to "b05dbc256c8fee1e5b4e3d7d60e6049a82ecfd99"



---

archive/issue_comments_580735.json:
```json
{
    "body": "<a id='comment:5'></a>\nNote: this does not fix the bug in #30938, so the branch there is still needed.",
    "created_at": "2021-02-22T07:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580735",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:5'></a>
Note: this does not fix the bug in #30938, so the branch there is still needed.



---

archive/issue_comments_580736.json:
```json
{
    "body": "<a id='comment:6'></a>\nI am not very confident reviewing pyx files but this looks fine and does fix the bug, and test pass.  OK!",
    "created_at": "2021-02-22T15:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580736",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'></a>
I am not very confident reviewing pyx files but this looks fine and does fix the bug, and test pass.  OK!



---

archive/issue_comments_580737.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Cremona\"",
    "created_at": "2021-02-22T15:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580737",
    "user": "https://github.com/JohnCremona"
}
```

Changing reviewer from "" to "John Cremona"



---

archive/issue_comments_580738.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-22T15:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580738",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_580739.json:
```json
{
    "body": "<a id='comment:7'></a>\nThank you for looking into this. I think maybe it would be safer to use a coercion here instead of a conversion? For example\n\n```diff\n-gens = [(<ModuleElement>e)._lmul_(B(x)) for x in gens]\n+gens = [(<ModuleElement>e)._lmul_(B._coerce_c(x)) for x in gens]\n```\nJust to be sure that no strange conversions are done.",
    "created_at": "2021-02-23T20:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580739",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:7'></a>
Thank you for looking into this. I think maybe it would be safer to use a coercion here instead of a conversion? For example

```diff
-gens = [(<ModuleElement>e)._lmul_(B(x)) for x in gens]
+gens = [(<ModuleElement>e)._lmul_(B._coerce_c(x)) for x in gens]
```
Just to be sure that no strange conversions are done.



---

archive/issue_comments_580740.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [gh-mwageringel](#comment%3A7):\n> Thank you for looking into this. I think maybe it would be safer to use a coercion here instead of a conversion? For example\n> \n> ```diff\n> -gens = [(<ModuleElement>e)._lmul_(B(x)) for x in gens]\n> +gens = [(<ModuleElement>e)._lmul_(B._coerce_c(x)) for x in gens]\n> ```\n> Just to be sure that no strange conversions are done.\n> \n\nSounds reasonable, but I prefer `B.coerce(x)` since `_coerce_c` is a remnant of the old coercion model.  Now running tests.",
    "created_at": "2021-02-24T19:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580740",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:8'></a>
Replying to [gh-mwageringel](#comment%3A7):
> Thank you for looking into this. I think maybe it would be safer to use a coercion here instead of a conversion? For example
> 
> ```diff
> -gens = [(<ModuleElement>e)._lmul_(B(x)) for x in gens]
> +gens = [(<ModuleElement>e)._lmul_(B._coerce_c(x)) for x in gens]
> ```
> Just to be sure that no strange conversions are done.
> 

Sounds reasonable, but I prefer `B.coerce(x)` since `_coerce_c` is a remnant of the old coercion model.  Now running tests.



---

archive/issue_comments_580741.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-02-24T19:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580741",
    "user": "https://github.com/pjbruin"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_580742.json:
```json
{
    "body": "Changing commit from \"b05dbc256c8fee1e5b4e3d7d60e6049a82ecfd99\" to \"cc615da49f920606189225d7287c3c8d382dd32a\"",
    "created_at": "2021-02-24T20:01:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580742",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b05dbc256c8fee1e5b4e3d7d60e6049a82ecfd99" to "cc615da49f920606189225d7287c3c8d382dd32a"



---

archive/issue_comments_580743.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[cc615da](https://github.com/sagemath/sagetrac-mirror/commit/cc615da49f920606189225d7287c3c8d382dd32a)|`Trac 29632: use coercion instead of conversion`|",
    "created_at": "2021-02-24T20:01:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[cc615da](https://github.com/sagemath/sagetrac-mirror/commit/cc615da49f920606189225d7287c3c8d382dd32a)|`Trac 29632: use coercion instead of conversion`|



---

archive/issue_comments_580744.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-24T20:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580744",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_580745.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-25T09:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580745",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_580746.json:
```json
{
    "body": "Changing reviewer from \"John Cremona\" to \"John Cremona, Markus Wageringel\"",
    "created_at": "2021-02-25T09:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580746",
    "user": "https://github.com/mwageringel"
}
```

Changing reviewer from "John Cremona" to "John Cremona, Markus Wageringel"



---

archive/issue_comments_580747.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [pbruin](#comment%3A8):\n> Sounds reasonable, but I prefer `B.coerce(x)` since `_coerce_c` is a remnant of the old coercion model.  Now running tests.\n\n\nOk, I did not know that. The tests passed, so I am setting this back to positive.",
    "created_at": "2021-02-25T09:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580747",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:12'></a>
Replying to [pbruin](#comment%3A8):
> Sounds reasonable, but I prefer `B.coerce(x)` since `_coerce_c` is a remnant of the old coercion model.  Now running tests.


Ok, I did not know that. The tests passed, so I am setting this back to positive.



---

archive/issue_comments_580748.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-07T17:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580748",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_580749.json:
```json
{
    "body": "Changing branch from \"u/pbruin/ticket/29632-morphism_comparison\" to \"cc615da49f920606189225d7287c3c8d382dd32a\"",
    "created_at": "2021-03-07T17:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29632#issuecomment-580749",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/pbruin/ticket/29632-morphism_comparison" to "cc615da49f920606189225d7287c3c8d382dd32a"



---

archive/issue_events_085459.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-07T17:06:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29632",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29632#event-85459"
}
```
