# Issue 29281: saving 3d plots to disk seems to be completely broken in sage-9.0

archive/issues_029044.json:
```json
{
    "body": "1. Type `sphere().save('a.png')`\n2. Get a stacktrace that looks very much like a Python3 porting mistake:\n\n```\n~$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: sphere().save('a.png')\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-1-fbbed3d16b26> in <module>()\n----> 1 sphere().save('a.png')\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save (build/cythonized/sage/plot/plot3d/base.c:21661)()\n   1635         elif ext in ['.bmp', '.png', '.gif', '.ppm', '.tiff', '.tif',\n   1636                      '.jpg', '.jpeg']:\n-> 1637             self.save_image(filename, **kwds)\n   1638         elif filename.endswith('.spt.zip'):\n   1639             scene = self._rich_repr_jmol(**kwds)\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save_image (build/cythonized/sage/plot/plot3d/base.c:21219)()\n   1564             raise ValueError('unknown image file type: {0}'.format(ext))\n   1565         if ext == '.png':\n-> 1566             self._save_image_png(filename, **kwds)\n   1567         else:\n   1568             png = tmp_filename(ext='.png')\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._save_image_png (build/cythonized/sage/plot/plot3d/base.c:20856)()\n   1526             render.png.save_as(filename)\n   1527         elif viewer == 'jmol':\n-> 1528             scene = self._rich_repr_jmol(**opts)\n   1529             scene.preview_png.save_as(filename)\n   1530         else:\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_jmol (build/cythonized/sage/plot/plot3d/base.c:7224)()\n    259         from sage.interfaces.jmoldata import JmolData\n    260         jdata = JmolData()\n--> 261         if not jdata.is_jvm_available():\n    262             # We can only use JMol to generate preview if a jvm is installed\n    263             from sage.repl.rich_output.output_graphics import OutputImagePng\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/interfaces/jmoldata.py in is_jvm_available(self)\n     68             return False\n     69 \n---> 70         java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n     71         return java_version_number >= 7\n     72 \n\nValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\n11'\nsage: \n```\n\nThis breaks SageTex, probably animation, etc...\n\nSee https://github.com/sagemathinc/cocalc/issues/4433\n\nAlso, there is another unrelated old ticket about plotting and 3d graphics: #21686\n\n\n\nBranch/Commit: [1f17926cce998f457af5097e2dd3937c3efdd5dd](https://github.com/sagemath/sagetrac-mirror/commit/1f17926cce998f457af5097e2dd3937c3efdd5dd)\n\nReviewer: William Stein\n\nAuthor: John Palmieri\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29281\n\n",
    "closed_at": "2020-03-11T23:46:16Z",
    "created_at": "2020-03-04T21:20:26Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "saving 3d plots to disk seems to be completely broken in sage-9.0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29281",
    "user": "https://github.com/williamstein"
}
```
1. Type `sphere().save('a.png')`
2. Get a stacktrace that looks very much like a Python3 porting mistake:

```
~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sphere().save('a.png')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-fbbed3d16b26> in <module>()
----> 1 sphere().save('a.png')

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save (build/cythonized/sage/plot/plot3d/base.c:21661)()
   1635         elif ext in ['.bmp', '.png', '.gif', '.ppm', '.tiff', '.tif',
   1636                      '.jpg', '.jpeg']:
-> 1637             self.save_image(filename, **kwds)
   1638         elif filename.endswith('.spt.zip'):
   1639             scene = self._rich_repr_jmol(**kwds)

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save_image (build/cythonized/sage/plot/plot3d/base.c:21219)()
   1564             raise ValueError('unknown image file type: {0}'.format(ext))
   1565         if ext == '.png':
-> 1566             self._save_image_png(filename, **kwds)
   1567         else:
   1568             png = tmp_filename(ext='.png')

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._save_image_png (build/cythonized/sage/plot/plot3d/base.c:20856)()
   1526             render.png.save_as(filename)
   1527         elif viewer == 'jmol':
-> 1528             scene = self._rich_repr_jmol(**opts)
   1529             scene.preview_png.save_as(filename)
   1530         else:

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_jmol (build/cythonized/sage/plot/plot3d/base.c:7224)()
    259         from sage.interfaces.jmoldata import JmolData
    260         jdata = JmolData()
--> 261         if not jdata.is_jvm_available():
    262             # We can only use JMol to generate preview if a jvm is installed
    263             from sage.repl.rich_output.output_graphics import OutputImagePng

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/interfaces/jmoldata.py in is_jvm_available(self)
     68             return False
     69 
---> 70         java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
     71         return java_version_number >= 7
     72 

ValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11'
sage: 
```

This breaks SageTex, probably animation, etc...

See https://github.com/sagemathinc/cocalc/issues/4433

Also, there is another unrelated old ticket about plotting and 3d graphics: #21686



Branch/Commit: [1f17926cce998f457af5097e2dd3937c3efdd5dd](https://github.com/sagemath/sagetrac-mirror/commit/1f17926cce998f457af5097e2dd3937c3efdd5dd)

Reviewer: William Stein

Author: John Palmieri

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/29281





---

archive/issue_comments_572030.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis works fine outside C*Calc. Did you try ?",
    "created_at": "2020-03-05T19:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572030",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
This works fine outside C*Calc. Did you try ?



---

archive/issue_comments_572031.json:
```json
{
    "body": "<a id='comment:2'></a>\nWorks for me, too. What does \"Enhanced for CoCalc\" mean in the Sage banner? Could some of the enhancements be involved?",
    "created_at": "2020-03-05T20:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572031",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>
Works for me, too. What does "Enhanced for CoCalc" mean in the Sage banner? Could some of the enhancements be involved?



---

archive/issue_comments_572032.json:
```json
{
    "body": "<a id='comment:3'></a>\nI think I have seen Harald say something about JAVA options in C*calc somewhere.",
    "created_at": "2020-03-05T20:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572032",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
I think I have seen Harald say something about JAVA options in C*calc somewhere.



---

archive/issue_comments_572033.json:
```json
{
    "body": "<a id='comment:4'></a>\nThanks for testing.  The error message in the stacktrace above is in some code to determine the java version; maybe our java runtime environment on cocalc behaves slightly differently than whatever you are testing on.  In the stacktrace, it is trying to turn 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\n11' into an int.  Maybe it needs to take only the 11 in the last line?  No clue...  I'll see if Harald has an idea, since he setup the Java environment.\n\n--\n\nI fixed a possibly similar issue here\n\nhttps://github.com/sagemathinc/cocalc-docker/issues/69#issuecomment-594981326\n\nwhere it turned out the permissions on the usr/local/sage/local/share/jmol directory were strangely wrong for normal user usage.   \n\nWhatever is happening with sage-9.0 might involve some similar permissions issue or something else (no clue).",
    "created_at": "2020-03-05T20:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572033",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:4'></a>
Thanks for testing.  The error message in the stacktrace above is in some code to determine the java version; maybe our java runtime environment on cocalc behaves slightly differently than whatever you are testing on.  In the stacktrace, it is trying to turn 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11' into an int.  Maybe it needs to take only the 11 in the last line?  No clue...  I'll see if Harald has an idea, since he setup the Java environment.

--

I fixed a possibly similar issue here

https://github.com/sagemathinc/cocalc-docker/issues/69#issuecomment-594981326

where it turned out the permissions on the usr/local/sage/local/share/jmol directory were strangely wrong for normal user usage.   

Whatever is happening with sage-9.0 might involve some similar permissions issue or something else (no clue).



---

archive/issue_comments_572034.json:
```json
{
    "body": "<a id='comment:5'></a>\nWhat does \"java -version\" say on your machine?",
    "created_at": "2020-03-05T20:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572034",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>
What does "java -version" say on your machine?



---

archive/issue_comments_572035.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis is what I see in Sage:\n\n```\nsage: from sage.cpython.string import bytes_to_str\nsage: import subprocess\nsage: import re\nsage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))\nsage: version\n'java version \"1.8.0_172\"\\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\\n'\nsage: print(version)\njava version \"1.8.0_172\"\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\n\nsage: int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n8\n```\nIt looks like something in this chain of commands is not working as expected.",
    "created_at": "2020-03-05T20:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572035",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>
This is what I see in Sage:

```
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess
sage: import re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
sage: version
'java version "1.8.0_172"\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\n'
sage: print(version)
java version "1.8.0_172"
Java(TM) SE Runtime Environment (build 1.8.0_172-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)

sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
8
```
It looks like something in this chain of commands is not working as expected.



---

archive/issue_comments_572036.json:
```json
{
    "body": "<a id='comment:7'></a>\nOn cocalc (as anybody can reproduce in any project):\n\n```\n~/cocalc/src/smc-webapp$ java -version\nPicked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version \"11.0.6\" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n~/cocalc/src/smc-webapp$ sage-9.0\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: from sage.cpython.string import bytes_to_str\nsage: import subprocess\nsage: import re\nsage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))\n....: \nsage: version\n'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\nopenjdk version \"11.0.6\" 2020-01-14\\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\\n'\nsage: print(version)\nPicked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version \"11.0.6\" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n\nsage: int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-7-67eb0f74af21> in <module>()\n----> 1 int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n\nValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\n11'\n```\n\nMaybe that regular expression isn't quite good enough...",
    "created_at": "2020-03-05T20:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572036",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>
On cocalc (as anybody can reproduce in any project):

```
~/cocalc/src/smc-webapp$ java -version
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)
~/cocalc/src/smc-webapp$ sage-9.0
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess
sage: import re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
....: 
sage: version
'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version "11.0.6" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n'
sage: print(version)
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)

sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-7-67eb0f74af21> in <module>()
----> 1 int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))

ValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11'
```

Maybe that regular expression isn't quite good enough...



---

archive/issue_comments_572037.json:
```json
{
    "body": "<a id='comment:8'></a>\nLook:\n\n```\nwstein@kucalc:~/cocalc-docker$ export _JAVA_OPTIONS=\"-Xms64m\"\nwstein@kucalc:~/cocalc-docker$ java -version\nPicked up _JAVA_OPTIONS: -Xms64m\nopenjdk version \"1.8.0_242\"\nOpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~16.04-b08)\nOpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)\n```\n\nSo anybody who happens to have the env variable _JAVA_OPTIONS set will find that saving 3d graphics to disk is broken in sage-9.0....",
    "created_at": "2020-03-05T20:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572037",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:8'></a>
Look:

```
wstein@kucalc:~/cocalc-docker$ export _JAVA_OPTIONS="-Xms64m"
wstein@kucalc:~/cocalc-docker$ java -version
Picked up _JAVA_OPTIONS: -Xms64m
openjdk version "1.8.0_242"
OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~16.04-b08)
OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)
```

So anybody who happens to have the env variable _JAVA_OPTIONS set will find that saving 3d graphics to disk is broken in sage-9.0....



---

archive/issue_comments_572038.json:
```json
{
    "body": "<a id='comment:9'></a>\nI don't know why it's using `re.sub` instead of `re.search`. Can you test this?\n\n```diff\ndiff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py\nindex 8f291fb954..86b21d9722 100644\n--- a/src/sage/interfaces/jmoldata.py\n+++ b/src/sage/interfaces/jmoldata.py\n@@ -67,7 +67,8 @@ class JmolData(SageObject):\n         except (subprocess.CalledProcessError, OSError):\n             return False\n \n-        java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n+        m = re.search(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', version)\n+        java_version_number = int(m.group(2))\n         return java_version_number >= 7\n \n     def export_image(self,\n```",
    "created_at": "2020-03-05T20:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572038",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>
I don't know why it's using `re.sub` instead of `re.search`. Can you test this?

```diff
diff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py
index 8f291fb954..86b21d9722 100644
--- a/src/sage/interfaces/jmoldata.py
+++ b/src/sage/interfaces/jmoldata.py
@@ -67,7 +67,8 @@ class JmolData(SageObject):
         except (subprocess.CalledProcessError, OSError):
             return False
 
-        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
+        m = re.search(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', version)
+        java_version_number = int(m.group(2))
         return java_version_number >= 7
 
     def export_image(self,
```



---

archive/issue_comments_572039.json:
```json
{
    "body": "<a id='comment:10'></a>\nOr a smaller change:\n\n```diff\ndiff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py\nindex 8f291fb954..40984bdc33 100644\n--- a/src/sage/interfaces/jmoldata.py\n+++ b/src/sage/interfaces/jmoldata.py\n@@ -67,7 +67,7 @@ class JmolData(SageObject):\n         except (subprocess.CalledProcessError, OSError):\n             return False\n \n-        java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n+        java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version, flags=re.S))\n         return java_version_number >= 7\n \n     def export_image(self,\n```",
    "created_at": "2020-03-05T20:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572039",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>
Or a smaller change:

```diff
diff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py
index 8f291fb954..40984bdc33 100644
--- a/src/sage/interfaces/jmoldata.py
+++ b/src/sage/interfaces/jmoldata.py
@@ -67,7 +67,7 @@ class JmolData(SageObject):
         except (subprocess.CalledProcessError, OSError):
             return False
 
-        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
+        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version, flags=re.S))
         return java_version_number >= 7
 
     def export_image(self,
```



---

archive/issue_comments_572040.json:
```json
{
    "body": "<a id='comment:11'></a>\nYes, your latter suggestion using flags works for me:\n\n```\n~/cocalc/src/smc-webapp$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: sage: from sage.cpython.string import bytes_to_str\n....: sage: import subprocess\n....: sage: import re\n....: sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))\n....: \nsage: int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version, flags=re.S))\n11\nsage: print(version)\nPicked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version \"11.0.6\" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n\n```",
    "created_at": "2020-03-05T21:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572040",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
Yes, your latter suggestion using flags works for me:

```
~/cocalc/src/smc-webapp$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sage: from sage.cpython.string import bytes_to_str
....: sage: import subprocess
....: sage: import re
....: sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
....: 
sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version, flags=re.S))
11
sage: print(version)
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)

```



---

archive/issue_comments_572041.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/jmol-regexp\"",
    "created_at": "2020-03-05T22:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572041",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/jmol-regexp"



---

archive/issue_comments_572042.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-05T22:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572042",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_572043.json:
```json
{
    "body": "Changing author from \"\" to \"John Palmieri\"",
    "created_at": "2020-03-05T22:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572043",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "" to "John Palmieri"



---

archive/issue_comments_572044.json:
```json
{
    "body": "Changing commit from \"\" to \"1f17926cce998f457af5097e2dd3937c3efdd5dd\"",
    "created_at": "2020-03-05T22:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572044",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "1f17926cce998f457af5097e2dd3937c3efdd5dd"



---

archive/issue_comments_572045.json:
```json
{
    "body": "<a id='comment:13'></a>\nThe flag `re.S` means that `.` matches that \"dot matches all\", including a newline. So in case \"java -version\" prints lines before `version \"...\"`, those lines are swallowed up by the `.` in `.*version`, which is what we want.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|\n|[1f17926](https://github.com/sagemath/sagetrac-mirror/commit/1f17926cce998f457af5097e2dd3937c3efdd5dd)|`trac 29281: modify regular expression when testing java veraion`|",
    "created_at": "2020-03-05T22:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572045",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
The flag `re.S` means that `.` matches that "dot matches all", including a newline. So in case "java -version" prints lines before `version "..."`, those lines are swallowed up by the `.` in `.*version`, which is what we want.

---
New commits:
|                                                                                                                                          |                                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
|[1f17926](https://github.com/sagemath/sagetrac-mirror/commit/1f17926cce998f457af5097e2dd3937c3efdd5dd)|`trac 29281: modify regular expression when testing java veraion`|



---

archive/issue_comments_572046.json:
```json
{
    "body": "<a id='comment:14'></a>\nPositive review since it works for me.  Thanks!",
    "created_at": "2020-03-05T22:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572046",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:14'></a>
Positive review since it works for me.  Thanks!



---

archive/issue_comments_572047.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-05T22:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572047",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_572048.json:
```json
{
    "body": "<a id='comment:16'></a>\nPlease fill out the reviewer name...",
    "created_at": "2020-03-05T23:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572048",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>
Please fill out the reviewer name...



---

archive/issue_comments_572049.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-05T23:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572049",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_572050.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-03-06T00:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572050",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_572051.json:
```json
{
    "body": "Changing reviewer from \"\" to \"William Stein\"",
    "created_at": "2020-03-06T00:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572051",
    "user": "https://github.com/williamstein"
}
```

Changing reviewer from "" to "William Stein"



---

archive/issue_comments_572052.json:
```json
{
    "body": "<a id='comment:18'></a>\nDone.  Sorry for forgetting that!",
    "created_at": "2020-03-06T00:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572052",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:18'></a>
Done.  Sorry for forgetting that!



---

archive/issue_comments_572053.json:
```json
{
    "body": "<a id='comment:19'></a>\nThis is a dup of #28648 \n\nI reported this in [October last year on the mailing list](https://groups.google.com/d/topic/sage-devel/TrQ9efDAdKc/discussion)",
    "created_at": "2020-03-06T11:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572053",
    "user": "https://github.com/haraldschilly"
}
```

<a id='comment:19'></a>
This is a dup of #28648 

I reported this in [October last year on the mailing list](https://groups.google.com/d/topic/sage-devel/TrQ9efDAdKc/discussion)



---

archive/issue_comments_572054.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/jmol-regexp\" to \"1f17926cce998f457af5097e2dd3937c3efdd5dd\"",
    "created_at": "2020-03-11T23:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572054",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/jmol-regexp" to "1f17926cce998f457af5097e2dd3937c3efdd5dd"



---

archive/issue_comments_572055.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-11T23:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29281#issuecomment-572055",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_084057.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-11T23:46:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29281",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29281#event-84057"
}
```
