# Issue 27518: some fixes and pep cleanup in number fields orders

archive/issues_027518.json:
```json
{
    "body": "CC:  roed tscrim cremona jdemeyer\n\nmost important change:\n\nSome orders are built inside a smaller number field.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27755\n\n",
    "created_at": "2019-05-01T09:20:18Z",
    "labels": [
        "number fields",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "some fixes and pep cleanup in number fields orders",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27518",
    "user": "chapoton"
}
```
CC:  roed tscrim cremona jdemeyer

most important change:

Some orders are built inside a smaller number field.

Issue created by migration from https://trac.sagemath.org/ticket/27755





---

archive/issue_comments_388227.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-05-01T09:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388227",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_388228.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-01T09:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388228",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_388229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-01T09:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388229",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_388230.json:
```json
{
    "body": "green bot, please review",
    "created_at": "2019-05-01T12:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388230",
    "user": "chapoton"
}
```

green bot, please review



---

archive/issue_comments_388231.json:
```json
{
    "body": "Why did it change from `V` to `W` here?\n\n```diff\n-                z = V.random_element()\n-                alpha = from_V(z)\n+                alpha = from_V(W.random_element())\n```\n\nSo I can say every other change is good except for the behavior change noted in the ticket description, which is this change:\n\n```diff\n-            # We move each element of W to this subfield.\n-            c = alpha.coordinates_in_terms_of_powers()\n+            # We move each generator of W to this subfield.\n+            K, _ = K.subfield(alpha, 'beta')\n+            gens = [K(x) for x in gens]\n+            V, from_V, to_V = K.vector_space()\n+            mod_gens = [to_V(x) for x in gens]\n+            ambient = ZZ**V.dimension()\n+            W = ambient.span(mod_gens)\n```\n\nFor this, I would like someone who knows the theory to look at this change.",
    "created_at": "2019-05-01T12:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388231",
    "user": "tscrim"
}
```

Why did it change from `V` to `W` here?

```diff
-                z = V.random_element()
-                alpha = from_V(z)
+                alpha = from_V(W.random_element())
```

So I can say every other change is good except for the behavior change noted in the ticket description, which is this change:

```diff
-            # We move each element of W to this subfield.
-            c = alpha.coordinates_in_terms_of_powers()
+            # We move each generator of W to this subfield.
+            K, _ = K.subfield(alpha, 'beta')
+            gens = [K(x) for x in gens]
+            V, from_V, to_V = K.vector_space()
+            mod_gens = [to_V(x) for x in gens]
+            ambient = ZZ**V.dimension()
+            W = ambient.span(mod_gens)
```

For this, I would like someone who knows the theory to look at this change.



---

archive/issue_comments_388232.json:
```json
{
    "body": "Well, I agree that an expert's eye is welcome, but this is just linear algebra.\n\nThis part of the code was just unused and plain wrong.\n\nDo you know who we should put in cc ?",
    "created_at": "2019-05-01T12:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388232",
    "user": "chapoton"
}
```

Well, I agree that an expert's eye is welcome, but this is just linear algebra.

This part of the code was just unused and plain wrong.

Do you know who we should put in cc ?



---

archive/issue_comments_388233.json:
```json
{
    "body": "John, Jeroen, could one of you have a quick look at this to make sure the change mentioned in comment:4 is okay (if you know about this part that is)?\n\n`@`chapoton This is a little too far outside my area to say confidently enough that it was wrong and this is the fix. However, if it is unused, then maybe this discussion is moot since that code will never be called.",
    "created_at": "2019-05-01T12:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388233",
    "user": "tscrim"
}
```

John, Jeroen, could one of you have a quick look at this to make sure the change mentioned in comment:4 is okay (if you know about this part that is)?

`@`chapoton This is a little too far outside my area to say confidently enough that it was wrong and this is the fix. However, if it is unused, then maybe this discussion is moot since that code will never be called.



---

archive/issue_comments_388234.json:
```json
{
    "body": "Well, now it is being used by the doctest whose output changed. Previously, the option `allow_subfield=True` was never changing the field at all.",
    "created_at": "2019-05-01T12:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388234",
    "user": "chapoton"
}
```

Well, now it is being used by the doctest whose output changed. Previously, the option `allow_subfield=True` was never changing the field at all.



---

archive/issue_comments_388235.json:
```json
{
    "body": "Replying to [comment:7 chapoton]:\n> Well, now it is being used by the doctest whose output changed. Previously, the option `change_field=True` was never changing the field at all.\n\nI see. I was misinterpreting what you meant by \"unused\".",
    "created_at": "2019-05-01T12:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388235",
    "user": "tscrim"
}
```

Replying to [comment:7 chapoton]:
> Well, now it is being used by the doctest whose output changed. Previously, the option `change_field=True` was never changing the field at all.

I see. I was misinterpreting what you meant by "unused".



---

archive/issue_comments_388236.json:
```json
{
    "body": "The changed code looks good to me but I have not tested it on examples.  The first change in Comment 4 is certainly necessary:  alpha must be an element whose coordinate vector lies in W as that is the span of the gens provided.  Otherwise it would be a random element of the big field K, and the whole point of this block of code is that the gens provided may lie in a proper subfield in which case the order returned is an order in that subfield.\n\nOne point caught my eye:  the coordinate vectors of the gens need not be vectors of integers (this is *not* the same as checking that the egns are algebraic integers since there is no reason to suppose that the vector space basis of K is an integral basis).  So W is defined to be the ZZ_span in ZZ^n of vectors which lie in QQ^n but not necessarily ZZ^n.  I hope that works as expected.",
    "created_at": "2019-05-01T15:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388236",
    "user": "cremona"
}
```

The changed code looks good to me but I have not tested it on examples.  The first change in Comment 4 is certainly necessary:  alpha must be an element whose coordinate vector lies in W as that is the span of the gens provided.  Otherwise it would be a random element of the big field K, and the whole point of this block of code is that the gens provided may lie in a proper subfield in which case the order returned is an order in that subfield.

One point caught my eye:  the coordinate vectors of the gens need not be vectors of integers (this is *not* the same as checking that the egns are algebraic integers since there is no reason to suppose that the vector space basis of K is an integral basis).  So W is defined to be the ZZ_span in ZZ^n of vectors which lie in QQ^n but not necessarily ZZ^n.  I hope that works as expected.



---

archive/issue_comments_388237.json:
```json
{
    "body": "Seems to work fine:\n\n```\nsage: ambient=ZZ**2\nsage: ambient.span([vector(QQ,[1/2,1/2])])\nFree module of degree 2 and rank 1 over Integer Ring\nEchelon basis matrix:\n[1/2 1/2]\nsage: ambient.span([vector(QQ,[1/2,1/2]),vector(QQ,[1/2,-1/2])])\nFree module of degree 2 and rank 2 over Integer Ring\nEchelon basis matrix:\n[1/2 1/2]\n[  0   1]\n```\n",
    "created_at": "2019-05-01T18:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388237",
    "user": "chapoton"
}
```

Seems to work fine:

```
sage: ambient=ZZ**2
sage: ambient.span([vector(QQ,[1/2,1/2])])
Free module of degree 2 and rank 1 over Integer Ring
Echelon basis matrix:
[1/2 1/2]
sage: ambient.span([vector(QQ,[1/2,1/2]),vector(QQ,[1/2,-1/2])])
Free module of degree 2 and rank 2 over Integer Ring
Echelon basis matrix:
[1/2 1/2]
[  0   1]
```




---

archive/issue_comments_388238.json:
```json
{
    "body": "review, please ?",
    "created_at": "2019-05-08T07:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388238",
    "user": "chapoton"
}
```

review, please ?



---

archive/issue_comments_388239.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-08T07:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388239",
    "user": "cremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_388240.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-12T21:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27518",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27518#issuecomment-388240",
    "user": "vbraun"
}
```

Resolution: fixed
