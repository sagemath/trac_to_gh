# Issue 27518: some fixes and pep cleanup in number fields orders

Issue created by migration from https://trac.sagemath.org/ticket/27755

Original creator: chapoton

Original creation time: 2019-05-01 09:20:18

CC:  roed tscrim cremona jdemeyer

most important change:

Some orders are built inside a smaller number field.


---

Comment by chapoton created at 2019-05-01 09:21:15

New commits:


---

Comment by chapoton created at 2019-05-01 09:21:15

Changing status from new to needs_review.


---

Comment by git created at 2019-05-01 09:25:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-05-01 12:08:51

green bot, please review


---

Comment by tscrim created at 2019-05-01 12:19:21

Why did it change from `V` to `W` here?

```diff
-                z = V.random_element()
-                alpha = from_V(z)
+                alpha = from_V(W.random_element())
```

So I can say every other change is good except for the behavior change noted in the ticket description, which is this change:

```diff
-            # We move each element of W to this subfield.
-            c = alpha.coordinates_in_terms_of_powers()
+            # We move each generator of W to this subfield.
+            K, _ = K.subfield(alpha, 'beta')
+            gens = [K(x) for x in gens]
+            V, from_V, to_V = K.vector_space()
+            mod_gens = [to_V(x) for x in gens]
+            ambient = ZZ**V.dimension()
+            W = ambient.span(mod_gens)
```

For this, I would like someone who knows the theory to look at this change.


---

Comment by chapoton created at 2019-05-01 12:21:26

Well, I agree that an expert's eye is welcome, but this is just linear algebra.

This part of the code was just unused and plain wrong.

Do you know who we should put in cc ?


---

Comment by tscrim created at 2019-05-01 12:28:48

John, Jeroen, could one of you have a quick look at this to make sure the change mentioned in comment:4 is okay (if you know about this part that is)?

`@`chapoton This is a little too far outside my area to say confidently enough that it was wrong and this is the fix. However, if it is unused, then maybe this discussion is moot since that code will never be called.


---

Comment by chapoton created at 2019-05-01 12:31:29

Well, now it is being used by the doctest whose output changed. Previously, the option `allow_subfield=True` was never changing the field at all.


---

Comment by tscrim created at 2019-05-01 12:36:19

Replying to [comment:7 chapoton]:
> Well, now it is being used by the doctest whose output changed. Previously, the option `change_field=True` was never changing the field at all.

I see. I was misinterpreting what you meant by "unused".


---

Comment by cremona created at 2019-05-01 15:09:12

The changed code looks good to me but I have not tested it on examples.  The first change in Comment 4 is certainly necessary:  alpha must be an element whose coordinate vector lies in W as that is the span of the gens provided.  Otherwise it would be a random element of the big field K, and the whole point of this block of code is that the gens provided may lie in a proper subfield in which case the order returned is an order in that subfield.

One point caught my eye:  the coordinate vectors of the gens need not be vectors of integers (this is *not* the same as checking that the egns are algebraic integers since there is no reason to suppose that the vector space basis of K is an integral basis).  So W is defined to be the ZZ_span in ZZ^n of vectors which lie in QQ^n but not necessarily ZZ^n.  I hope that works as expected.


---

Comment by chapoton created at 2019-05-01 18:33:08

Seems to work fine:

```
sage: ambient=ZZ**2
sage: ambient.span([vector(QQ,[1/2,1/2])])
Free module of degree 2 and rank 1 over Integer Ring
Echelon basis matrix:
[1/2 1/2]
sage: ambient.span([vector(QQ,[1/2,1/2]),vector(QQ,[1/2,-1/2])])
Free module of degree 2 and rank 2 over Integer Ring
Echelon basis matrix:
[1/2 1/2]
[  0   1]
```



---

Comment by chapoton created at 2019-05-08 07:18:25

review, please ?


---

Comment by cremona created at 2019-05-08 07:54:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-12 21:30:16

Resolution: fixed
