# Issue 24583: Upgrade to lcalc-1.3

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2018-02-22 14:29:48

CC:  rishi @timokau

lcalc is not actively maintained by the author. His latest version lcalc-1.3 was deposited at https://code.google.com/archive/p/l-calc/. This was recently imported to https://github.com/dimpase/lcalc to make it available.


---

Comment by rws created at 2018-02-22 14:30:29

Will update the description as soon as we have a tarball.


---

Comment by rws created at 2018-02-22 14:46:59

One problem worked around was that the use of FP type (double,mpfr,etc..) can be given to make but is not fixed in a header like with conf.h in other packages. I have hardcoded the type used until now (double) but this is an issue.
----
New commits:


---

Comment by rws created at 2018-02-22 15:10:19

This is the only error with the code in the pull request that is not cured by a slight increase in tolerance:

```
File "src/sage/libs/lcalc/lcalc_Lfunction.pyx", line 185, in sage.libs.lcalc.lcalc_Lfunction.Lfunction.hardy_z_function
Failed example:
    L.hardy_z_function(.4+.3*I)
Expected:
    0.2166144222685... - 0.00408187127850...*I
Got:
    0.0240947990422030 + 0.215308871779581*I
```



---

Comment by rws created at 2018-02-22 16:44:39

Note that `hardy_z_function` calls `...value(s, 0, "rotated pure")` but the `value` definition both in lcalc-1.23 and 1.3 does not check for the rotated pure return type argument. Member functions that do have special code for this argument are `value_via_Riemann_sum` or `value_via_gamma_sum`.


---

Comment by rws created at 2018-02-22 16:49:54

`@`rishi What's your opinion? Should we call a different value function? Do you have an example where you know the result of a nontrivial character from other means than lcalc?


---

Comment by rws created at 2018-02-23 07:37:47

I just see we can compare with arb: http://fredrikj.net/blog/2016/11/dirichlet-l-functions-in-arb/

It would be nice to have that in Sage, too. See #24823.


---

Comment by rws created at 2018-02-23 09:56:56

It seems I cannot reproduce lcalc-1.23 results of quadratic characters with arb, and the primitive ones only for L() values not Z():

```
#include "dirichlet.h"
#include "acb_dirichlet.h"

int main()
{
    dirichlet_group_t G;
    dirichlet_char_t chi;
    acb_t z, v, s;
    slong prec;
    FILE * fp = stdout;

    acb_init(z); acb_init(v); acb_init(s);
    dirichlet_group_init(G, 5);
    dirichlet_char_init(chi, G);
    dirichlet_char_log(chi, G, 1);
    prec = 53;

    acb_set_d_d(s, 0.4, 0.3);
    acb_dirichlet_l(v, s, G, chi, prec);
    acb_dirichlet_hardy_z(z, s, G, chi, 1, prec);
    arb_fprintn(fp, acb_realref(v), 15, ARB_STR_NO_RADIUS); fprintf(fp, " ");
    arb_fprintn(fp, acb_imagref(v), 15, ARB_STR_NO_RADIUS); fprintf(fp, "\n");
    arb_fprintn(fp, acb_realref(z), 15, ARB_STR_NO_RADIUS); fprintf(fp, " ");
    arb_fprintn(fp, acb_imagref(z), 15, ARB_STR_NO_RADIUS); fprintf(fp, "\n");
    dirichlet_group_clear(G);
    dirichlet_char_clear(chi);
    acb_clear(z); acb_clear(v); acb_clear(s);
}
```

out:

```
0.746399760988757 0.306435517808510
0.83536589483338 0.06481096520271
```

compare lcalc-1.23:

```
sage: chi = DirichletGroup(5)[1]
sage: L = Lfunction_from_character(chi, type="complex")
sage: L.value(.4+.3*I)
0.746399760988764 + 0.306435517808512*I
sage: L.hardy_z_function(.4+.3*I)
0.773263920478260 + 0.00234761924684610*I
```



---

Comment by jdemeyer created at 2018-02-23 11:19:55

Note that PARI/GP should also be able to do this computation, but I'm too lazy right now to check.


---

Comment by rws created at 2018-02-23 14:33:08

Replying to [comment:9 jdemeyer]:
> Note that PARI/GP should also be able to do this computation, but I'm too lazy right now to check.

That would be:

```
? lfun([znstar(5, 1), [1]], .4+.3*I)
%36 = 0.74639976098875732745027783743802269503 + 0.30643551780851000234523726566712518702*I
```

`lfunhardy` in current Sage's Pari only accepts real input. The doctest above has complex input; I have no idea about the usefulness of complex argument results.


---

Comment by rws created at 2018-02-23 15:29:32

Let's compare results for Z with real argument, say `0.4`.

With the `DirichletGroup(5)[1]` character, lcalc-1.23 as interfaced in Sage gives `0.851280933431727` with small imaginary component; lcalc-1.3 agrees `0.851280933431744`; Pari returns `0.80484991588823009664634764248195907182`, and arb `0.85128093343172`.

With the `DirichletGroup(5)[2]` character it's `0.300129189728995`, `0.300129189729034`, and `0.95412902109286908441627436043139472906` from Pari. So the problem is with complex input and with specific characters.


---

Comment by chapoton created at 2018-02-24 12:45:19

Changing keywords from "" to "lcalc".


---

Comment by @timokau created at 2018-07-29 19:23:53

Replying to [comment:5 rws]:
> Note that `hardy_z_function` calls `...value(s, 0, "rotated pure")` but the `value` definition both in lcalc-1.23 and 1.3 does not check for the rotated pure return type argument. Member functions that do have special code for this argument are `value_via_Riemann_sum` or `value_via_gamma_sum`.


Replying to [comment:8 rws]:
> It seems I cannot reproduce lcalc-1.23 results of quadratic characters with arb, and the primitive ones only for L() values not Z():
> ...


Sounds like that feature was pretty much always broken and that new doctest value is "just as good" (or just as bad) as the old one. Is that correct?


---

Comment by mjo created at 2021-06-23 03:16:20

I think we should close this in favor of #32037. Some of the test problems persist there, but I think that's the sort of bug we might overlook to get rid of our horribly outdated lcalc-1.23.


---

Comment by mjo created at 2021-06-23 03:16:20

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-23 17:57:50

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-06-24 07:10:36

Resolution: duplicate
