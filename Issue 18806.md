# Issue 18806: Move configuration part of build/make/install to configure

Issue created by migration from https://trac.sagemath.org/ticket/19043

Original creator: jdemeyer

Original creation time: 2015-08-16 21:20:54

Most of what `build/make/install` does really belongs in `configure`, in particular creating `build/make/Makefile`. This ticket moves that part to `configure` and adjusts the top-level build system to make this work.

There are two advantages:
1. Running `make` is a lot simpler and hence faster.
2. It allows using `./configure` to configure the list of packages (note that this ticket does not implement that, it just makes it possible to implement that in future tickets)

There is an important change for developers: any change to the list or versions of packages will require a run of `./configure` to take effect. Note that `./configure` will be re-run automatically if `./configure` itself changes, which happens with every Sage version. So there is no need to manually rerun `./configure` if you're just switching between versions.


---

Comment by jdemeyer created at 2015-08-16 21:40:55

New commits:


---

Comment by jdemeyer created at 2015-08-16 21:40:55

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-09-21 13:16:00

I would be willing to review this.


---

Comment by git created at 2015-09-21 15:32:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-21 15:41:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-09-21 15:44:11

Rebased. I know the git history looks funny, but you really should just review the result, not the individual commits.


---

Comment by tscrim created at 2015-09-21 17:28:47

I don't care about having a "perfect" history (and normally review the final diff from `develop`).

Overall it looks good from my testing. However, I'm not quite sure about this

> There is an important change for developers: any change to the list or versions of packages will require a run of `./configure` to take effect.

To make sure I understand correctly, does this mean that anytime we want to do a version bump of packages (or add one), we have to manually run `$SAGE_ROOT/configure`? If so, then I think we should put something about this in the spkg development guide. Also, is `configure` updated on beta version changes or just on stable releases?

Also is there a reason why you moved the "if root" test lower in the file? I would think we'd want such build failures to happen as early on as possible.


---

Comment by jdemeyer created at 2015-09-21 17:38:33

Replying to [comment:10 tscrim]:
> To make sure I understand correctly, does this mean that anytime we want to do a version bump of packages (or add one), we have to manually run `$SAGE_ROOT/configure`?
Yes.

> If so, then I think we should put something about this in the spkg development guide.
OK, I see your point. I'd rather make that a separate ticket, there might be other changes to the spkg development guide I want to make.

> Also, is `configure` updated on beta version changes or just on stable releases?
All releases, beta and stable. So in practice, you only really need to run `./configure` manually if you yourself are working on a package (as author or reviewer). If the package upgrade happens as part of a Sage version bump, no special action is needed.

> Also is there a reason why you moved the "if root" test lower in the file?
There is no real particular reason, it felt more logical to put it where it currently is.

> I would think we'd want such build failures to happen as early on as possible.
Why?


---

Comment by tscrim created at 2015-09-21 17:53:06

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 tscrim]:
> > To make sure I understand correctly, does this mean that anytime we want to do a version bump of packages (or add one), we have to manually run `$SAGE_ROOT/configure`?
> Yes.
> 
> > If so, then I think we should put something about this in the spkg development guide.
> OK, I see your point. I'd rather make that a separate ticket, there might be other changes to the spkg development guide I want to make.

Fair enough, but let's make that spkg dev guide update ticket a blocker.

> > Also, is `configure` updated on beta version changes or just on stable releases?
> All releases, beta and stable. So in practice, you only really need to run `./configure` manually if you yourself are working on a package (as author or reviewer). If the package upgrade happens as part of a Sage version bump, no special action is needed.

Thanks for the explanation.

> > Also is there a reason why you moved the "if root" test lower in the file?
> There is no real particular reason, it felt more logical to put it where it currently is.
> 
> > I would think we'd want such build failures to happen as early on as possible.
> Why?

I feel that some of those configuration steps could take some time, just to have it fail for an unrelated reason. However I don't really care about this; it was more out of curiosity.


---

Comment by tscrim created at 2015-09-21 17:53:06

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-09-22 09:55:13

Replying to [comment:12 tscrim]:
> Fair enough, but let's make that spkg dev guide update ticket a blocker.
I created #19267. I don't believe that pure documentation tickets should be blockers. But given that we have not yet reached the "rc" phase, I think there is still time.


---

Comment by vbraun created at 2015-09-22 14:49:13

Resolution: fixed


---

Comment by vbraun created at 2015-09-22 15:03:05

OSX doesn't build gcc any more with this ticket, but just fails with `configure: error: Exiting, since a Fortran compiler was not found.`

http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20full/builds/95/steps/compile_1/logs/stdio


---

Comment by vbraun created at 2015-09-22 15:03:05

Resolution changed from fixed to 


---

Comment by vbraun created at 2015-09-22 15:03:05

Changing status from closed to new.


---

Comment by jdemeyer created at 2015-09-22 15:32:09

Most likely, you didn't apply this branch properly: it needs an updated `upstream/configure-NNN.tar.gz` if the system you test it on doesn't have autotools.


---

Comment by jdemeyer created at 2015-09-22 15:32:09

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-09-22 15:32:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-09-22 15:39:46

I don't understand why `./bootstrap -d` wasn't run though in your logs. Is there anything funny in your build system affecting `configure`?


---

Comment by jdemeyer created at 2015-09-22 15:43:32

Or anything in your buildbot affecting timestamps as a whole? What happens if you replace `distclean` by `maintainer-clean`?


---

Comment by vbraun created at 2015-09-22 16:25:07

Its the same machine that you also have an account for. It compiles fine without this ticket. 

If this ticket needs an updated confball then it should be committed, too. The change in confball needs to be in some commit, otherwise the buildbot can't test it.


---

Comment by vbraun created at 2015-09-22 16:25:32

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-09-22 16:56:34

> If this ticket needs an updated confball then it should be committed, too.
It's the first time I hear this. I thought that was the job of the release manager when creating the sdist?


---

Comment by jdemeyer created at 2015-09-22 17:05:18

I need more information about the buildbot setup, otherwise I don't know what to do. From your logs, it looks like `./bootstrap` isn't even run, so just updating the confball won't help in that case.


---

Comment by jdemeyer created at 2015-09-22 17:15:36

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-09-22 17:15:36

Is this what you need?
----
New commits:


---

Comment by vbraun created at 2015-09-22 18:12:12

The confball is updated during release but ideally we can test a ticket before the release...

The buildbot just pulls the source and runs `make -j8 -k start` on the OSX machine.


---

Comment by vbraun created at 2015-09-22 19:10:15

Thats not the file:

```
$ md5 configure-114.tar.gz 
MD5 (configure-114.tar.gz) = 0413a0763d9b33111d11f03f720429a2
```



---

Comment by vbraun created at 2015-09-22 19:10:15

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-09-23 07:44:27

I will deal with it on #19266.
----
New commits:


---

Comment by tscrim created at 2015-09-23 13:51:01

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2015-09-23 13:51:01

Since the confball will be handled on #19266, we're back to positive review (I tested it with the one Jeroen provided after running a checksum fix).


---

Comment by jdemeyer created at 2015-09-23 14:44:47

Volker, can you please try to merge this in the next beta? Otherwise there will be a conflict with the `configure` version.


---

Comment by vbraun created at 2015-09-23 20:56:02

Resolution: fixed
