# Issue 32749: sage.misc.temporary_file: Move SAGE_TMP implementation here

archive/issues_032749.json:
```json
{
    "body": "CC:  @orlitzky @kiwifb\n\nWe move the code for creating the temporary directory to  `sage.misc.temporary_file`, removing the dependency on `sage.misc.misc` and `sage.misc.lazy_string`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32986\n\n",
    "created_at": "2021-12-06T20:26:55Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "sage.misc.temporary_file: Move SAGE_TMP implementation here",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32749",
    "user": "@mkoeppe"
}
```
CC:  @orlitzky @kiwifb

We move the code for creating the temporary directory to  `sage.misc.temporary_file`, removing the dependency on `sage.misc.misc` and `sage.misc.lazy_string`.

Issue created by migration from https://trac.sagemath.org/ticket/32986





---

archive/issue_comments_467127.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-07T00:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467127",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467128.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-07T00:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467128",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467129.json:
```json
{
    "body": "I'll need to revise this - ``@`functools.cache` is py>=3.9",
    "created_at": "2021-12-07T23:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467129",
    "user": "@mkoeppe"
}
```

I'll need to revise this - ``@`functools.cache` is py>=3.9



---

archive/issue_comments_467130.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-12-07T23:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467130",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_467131.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-07T23:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467131",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467132.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-12-07T23:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467132",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_467133.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-10T13:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467133",
    "user": "@kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467134.json:
```json
{
    "body": "LGTM. Tested through #32987.",
    "created_at": "2021-12-10T13:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467134",
    "user": "@kwankyu"
}
```

LGTM. Tested through #32987.



---

archive/issue_comments_467135.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-12-10T16:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467135",
    "user": "@mkoeppe"
}
```

Thanks!



---

archive/issue_comments_467136.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-01-30T23:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467136",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_467137.json:
```json
{
    "body": "With this ticket I'm seeing a lot of flakiness with maxima-related tests, e.g. \n\n```\nsage -t --long --warn-long 50.7 --random-seed=36889336955867588730901666695941730921 src/sage/interfaces/maxima_abstract.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_abstract.py\", line 314, in sage.interfaces.maxima_abstract.MaximaAbstract._commands\nFailed example:\n    sorted(maxima._commands(verbose=False))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.maxima_abstract.MaximaAbstract._commands[0]>\", line 1, in <module>\n        sorted(maxima._commands(verbose=False))\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 327, in _commands\n        [self.completions(chr(65+n), verbose=verbose)+\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 327, in <listcomp>\n        [self.completions(chr(65+n), verbose=verbose)+\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py\", line 296, in completions\n        cmd_list = self._eval_line('apropos(\"%s\")'%s, error_check=False)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py\", line 814, in _eval_line\n        self._expect_expr(self._display_prompt)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py\", line 731, in _expect_expr\n        i = self._expect.expect(expr)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py\", line 343, in expect\n        return self.expect_list(compiled_pattern_list,\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py\", line 372, in expect_list\n        return exp.expect_loop(timeout)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py\", line 179, in expect_loop\n        return self.eof(e)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py\", line 122, in eof\n        raise exc\n    pexpect.exceptions.EOF: End Of File (EOF). Exception style platform.\n    Maxima with PID 1795009 running /home/release/Sage/local/bin/maxima -p /home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp\n    command: /home/release/Sage/local/bin/maxima\n    args: ['/home/release/Sage/local/bin/maxima', '-p', '/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp']\n    buffer (last 100 chars): b''\n    before (last 100 chars): ''\n    after: <class 'pexpect.exceptions.EOF'>\n    match: None\n    match_index: None\n    exitstatus: None\n    flag_eof: True\n    pid: 1795009\n    child_fd: 20\n    closed: False\n    timeout: None\n    delimiter: <class 'pexpect.exceptions.EOF'>\n    logfile: None\n    logfile_read: None\n    logfile_send: None\n    maxread: 4194304\n    ignorecase: False\n    searchwindowsize: None\n    delaybeforesend: None\n    delayafterclose: 0.1\n    delayafterterminate: 0.1\n    searcher: searcher_re:\n        0: re.compile(b'<sage-display>')\n**********************************************************************\n```\n\nAlways disappears when testing individually, but running multiple maxima-using tests in parallel triggers them quite reliably. E.g.\n\n```\n./sage -t -p 8 --long src/sage/interfaces/maxima_abstract.py src/sage/dynamics/complex_dynamics/mandel_julia.py src/sage/interfaces/maxima.py src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py src/sage/coding/kasami_codes.pyx\n\n```\n",
    "created_at": "2022-01-30T23:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467137",
    "user": "@vbraun"
}
```

With this ticket I'm seeing a lot of flakiness with maxima-related tests, e.g. 

```
sage -t --long --warn-long 50.7 --random-seed=36889336955867588730901666695941730921 src/sage/interfaces/maxima_abstract.py
**********************************************************************
File "src/sage/interfaces/maxima_abstract.py", line 314, in sage.interfaces.maxima_abstract.MaximaAbstract._commands
Failed example:
    sorted(maxima._commands(verbose=False))
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.maxima_abstract.MaximaAbstract._commands[0]>", line 1, in <module>
        sorted(maxima._commands(verbose=False))
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 327, in _commands
        [self.completions(chr(65+n), verbose=verbose)+
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 327, in <listcomp>
        [self.completions(chr(65+n), verbose=verbose)+
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima_abstract.py", line 296, in completions
        cmd_list = self._eval_line('apropos("%s")'%s, error_check=False)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py", line 814, in _eval_line
        self._expect_expr(self._display_prompt)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/maxima.py", line 731, in _expect_expr
        i = self._expect.expect(expr)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py", line 343, in expect
        return self.expect_list(compiled_pattern_list,
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/spawnbase.py", line 372, in expect_list
        return exp.expect_loop(timeout)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py", line 179, in expect_loop
        return self.eof(e)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pexpect/expect.py", line 122, in eof
        raise exc
    pexpect.exceptions.EOF: End Of File (EOF). Exception style platform.
    Maxima with PID 1795009 running /home/release/Sage/local/bin/maxima -p /home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp
    command: /home/release/Sage/local/bin/maxima
    args: ['/home/release/Sage/local/bin/maxima', '-p', '/home/release/Sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/interfaces/sage-maxima.lisp']
    buffer (last 100 chars): b''
    before (last 100 chars): ''
    after: <class 'pexpect.exceptions.EOF'>
    match: None
    match_index: None
    exitstatus: None
    flag_eof: True
    pid: 1795009
    child_fd: 20
    closed: False
    timeout: None
    delimiter: <class 'pexpect.exceptions.EOF'>
    logfile: None
    logfile_read: None
    logfile_send: None
    maxread: 4194304
    ignorecase: False
    searchwindowsize: None
    delaybeforesend: None
    delayafterclose: 0.1
    delayafterterminate: 0.1
    searcher: searcher_re:
        0: re.compile(b'<sage-display>')
**********************************************************************
```

Always disappears when testing individually, but running multiple maxima-using tests in parallel triggers them quite reliably. E.g.

```
./sage -t -p 8 --long src/sage/interfaces/maxima_abstract.py src/sage/dynamics/complex_dynamics/mandel_julia.py src/sage/interfaces/maxima.py src/sage/tests/books/computational-mathematics-with-sagemath/sol/mpoly_doctest.py src/sage/coding/kasami_codes.pyx

```




---

archive/issue_comments_467138.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-06T22:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467138",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467139.json:
```json
{
    "body": "Confirmed the test failures when running in parallel. Not sure what's happening there, help welcome",
    "created_at": "2022-02-13T22:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467139",
    "user": "@mkoeppe"
}
```

Confirmed the test failures when running in parallel. Not sure what's happening there, help welcome



---

archive/issue_comments_467140.json:
```json
{
    "body": "The only thing I think could happen, should have been happening before this ticket. You mostly moved code around. May be there was always a potential race condition on the closing of `sage_tmp` and it just got enhanced.",
    "created_at": "2022-02-13T23:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467140",
    "user": "@kiwifb"
}
```

The only thing I think could happen, should have been happening before this ticket. You mostly moved code around. May be there was always a potential race condition on the closing of `sage_tmp` and it just got enhanced.



---

archive/issue_comments_467141.json:
```json
{
    "body": "The diff looks OK to me too, but over the past week or so I've realized that you can't trust anything that goes on in the expect interfaces. Using `lazy_string` adds a layer of unnecessary complexity too; there's no need to encode the PID into the tempfile path.\n\nI'm in the process of removing direct uses of `SAGE_TMP` anyway if you just want to wait. Afterwards it will be trivial to switch `tmp_filename()` and `tmp_dir()`, and `SAGE_TMP` can be removed from the misc module.",
    "created_at": "2022-02-14T00:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467141",
    "user": "@orlitzky"
}
```

The diff looks OK to me too, but over the past week or so I've realized that you can't trust anything that goes on in the expect interfaces. Using `lazy_string` adds a layer of unnecessary complexity too; there's no need to encode the PID into the tempfile path.

I'm in the process of removing direct uses of `SAGE_TMP` anyway if you just want to wait. Afterwards it will be trivial to switch `tmp_filename()` and `tmp_dir()`, and `SAGE_TMP` can be removed from the misc module.



---

archive/issue_comments_467142.json:
```json
{
    "body": "Color me unsurprised that I'm seeing random (both non-reproducible, and can't-possibly-be-related-to-anything-I-changed) pexpect failures on #33213 as well.",
    "created_at": "2022-02-16T12:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467142",
    "user": "@orlitzky"
}
```

Color me unsurprised that I'm seeing random (both non-reproducible, and can't-possibly-be-related-to-anything-I-changed) pexpect failures on #33213 as well.



---

archive/issue_comments_467143.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-05-01T01:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467143",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467144.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-05-04T18:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467144",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_467145.json:
```json
{
    "body": "Superseded by #33797/#33213",
    "created_at": "2022-05-04T18:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467145",
    "user": "@mkoeppe"
}
```

Superseded by #33797/#33213



---

archive/issue_comments_467146.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2022-07-08T14:13:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32749#issuecomment-467146",
    "user": "@fchapoton"
}
```

Resolution: duplicate
