# Issue 32400: Add sage.geometry.abc; deprecate is_Polyhedron, is_LatticePolytope, is_Cone, ...

archive/issues_032400.json:
```json
{
    "body": "CC:  @kliem @orlitzky @egourgoulhon\n\n\n```\n$ git grep 'def is_[A-Z]' src/sage/geometry/\nsrc/sage/geometry/cone.py:def is_Cone(x):\nsrc/sage/geometry/fan.py:def is_Fan(x):\nsrc/sage/geometry/lattice_polytope.py:def is_LatticePolytope(x):\nsrc/sage/geometry/lattice_polytope.py:def is_NefPartition(x):\nsrc/sage/geometry/point_collection.pyx:def is_PointCollection(x):\nsrc/sage/geometry/polyhedron/base.py:def is_Polyhedron(X):\nsrc/sage/geometry/toric_lattice.py:def is_ToricLattice(x):\nsrc/sage/geometry/toric_lattice.py:def is_ToricLatticeQuotient(x):\nsrc/sage/geometry/toric_lattice_element.pyx:def is_ToricLatticeElement(x):\n```\n\n\nA small number of uses outside of `sage.geometry` will need updating. `$ git grep 'geometry.*import.*is_[A-Z]' src/sage/`\n\n(Part of meta-ticket #32414)\n\nIssue created by migration from https://trac.sagemath.org/ticket/32637\n\n",
    "created_at": "2021-10-05T17:52:48Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Add sage.geometry.abc; deprecate is_Polyhedron, is_LatticePolytope, is_Cone, ...",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32400",
    "user": "@mkoeppe"
}
```
CC:  @kliem @orlitzky @egourgoulhon


```
$ git grep 'def is_[A-Z]' src/sage/geometry/
src/sage/geometry/cone.py:def is_Cone(x):
src/sage/geometry/fan.py:def is_Fan(x):
src/sage/geometry/lattice_polytope.py:def is_LatticePolytope(x):
src/sage/geometry/lattice_polytope.py:def is_NefPartition(x):
src/sage/geometry/point_collection.pyx:def is_PointCollection(x):
src/sage/geometry/polyhedron/base.py:def is_Polyhedron(X):
src/sage/geometry/toric_lattice.py:def is_ToricLattice(x):
src/sage/geometry/toric_lattice.py:def is_ToricLatticeQuotient(x):
src/sage/geometry/toric_lattice_element.pyx:def is_ToricLatticeElement(x):
```


A small number of uses outside of `sage.geometry` will need updating. `$ git grep 'geometry.*import.*is_[A-Z]' src/sage/`

(Part of meta-ticket #32414)

Issue created by migration from https://trac.sagemath.org/ticket/32637





---

archive/issue_comments_462206.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-17T21:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462206",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_462207.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-17T21:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462207",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_462208.json:
```json
{
    "body": "I worry that we're changing `is_Foo()` to mean \"does this object provide the interface defined by `abc.Foo`?\" But then `abc.Foo` doesn't declare any methods, properties, or data.\n\nOn the other hand, you don't want to put the implementation into the base class, because the whole point is to avoid importing the implementations to perform a typecheck. Nor does it make much sense to blindly add a million ``@`abstractmethod def foo(...): pass` lines to each ABC. I guess in lieu of an alternative, it has to be OK.\n\nI wonder if something ridiculous like this wouldn't also work as an interim hack:\n\n\n```\nsage: def is_Polyhedron(C):\n....:     return \"Polyhedron_base\" in [c.__name__ for c in C.__class__.__mro__]\n```\n\n\nYou can also check the (string) module name with `c.__module__` to avoid name clashes. But chances are, it's slower at runtime.",
    "created_at": "2021-10-18T00:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462208",
    "user": "@orlitzky"
}
```

I worry that we're changing `is_Foo()` to mean "does this object provide the interface defined by `abc.Foo`?" But then `abc.Foo` doesn't declare any methods, properties, or data.

On the other hand, you don't want to put the implementation into the base class, because the whole point is to avoid importing the implementations to perform a typecheck. Nor does it make much sense to blindly add a million ``@`abstractmethod def foo(...): pass` lines to each ABC. I guess in lieu of an alternative, it has to be OK.

I wonder if something ridiculous like this wouldn't also work as an interim hack:


```
sage: def is_Polyhedron(C):
....:     return "Polyhedron_base" in [c.__name__ for c in C.__class__.__mro__]
```


You can also check the (string) module name with `c.__module__` to avoid name clashes. But chances are, it's slower at runtime.



---

archive/issue_comments_462209.json:
```json
{
    "body": "Replying to [comment:5 mjo]:\n> I worry that we're changing `is_Foo()` to mean \"does this object provide the interface defined by `abc.Foo`?\" But then `abc.Foo` doesn't declare any methods, properties, or data.\n\nAs explained in #32414, \"each of the new abstract base classes is intended to have a unique direct implementation subclass. Attempting to define new hierarchies of abstract base classes is beyond the scope of this ticket. Also, the new classes do not define any methods.\".",
    "created_at": "2021-10-18T00:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462209",
    "user": "@mkoeppe"
}
```

Replying to [comment:5 mjo]:
> I worry that we're changing `is_Foo()` to mean "does this object provide the interface defined by `abc.Foo`?" But then `abc.Foo` doesn't declare any methods, properties, or data.

As explained in #32414, "each of the new abstract base classes is intended to have a unique direct implementation subclass. Attempting to define new hierarchies of abstract base classes is beyond the scope of this ticket. Also, the new classes do not define any methods.".



---

archive/issue_comments_462210.json:
```json
{
    "body": "Replying to [comment:5 mjo]:\n> I wonder if something ridiculous like this wouldn't also work as an interim hack:\n> {{{\n> sage: def is_Polyhedron(C):\n> ....:     return \"Polyhedron_base\" in [c.__name__ for c in C.__class__.__mro__]\n> }}}\nYeah, I'm not interested in a solution that looks like this",
    "created_at": "2021-10-18T00:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462210",
    "user": "@mkoeppe"
}
```

Replying to [comment:5 mjo]:
> I wonder if something ridiculous like this wouldn't also work as an interim hack:
> {{{
> sage: def is_Polyhedron(C):
> ....:     return "Polyhedron_base" in [c.__name__ for c in C.__class__.__mro__]
> }}}
Yeah, I'm not interested in a solution that looks like this



---

archive/issue_comments_462211.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> \n> As explained in #32414, \"each of the new abstract base classes is intended to have a unique direct implementation subclass. Attempting to define new hierarchies of abstract base classes is beyond the scope of this ticket. Also, the new classes do not define any methods.\".\n\nI saw that, but unless you plan to live forever and spend most of it monitoring trac, there's no technical means to enforce that restriction.",
    "created_at": "2021-10-18T00:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462211",
    "user": "@orlitzky"
}
```

Replying to [comment:6 mkoeppe]:
> 
> As explained in #32414, "each of the new abstract base classes is intended to have a unique direct implementation subclass. Attempting to define new hierarchies of abstract base classes is beyond the scope of this ticket. Also, the new classes do not define any methods.".

I saw that, but unless you plan to live forever and spend most of it monitoring trac, there's no technical means to enforce that restriction.



---

archive/issue_comments_462212.json:
```json
{
    "body": "Sounds like someone wants to write a decorator for these types of classes",
    "created_at": "2021-10-18T00:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462212",
    "user": "@mkoeppe"
}
```

Sounds like someone wants to write a decorator for these types of classes



---

archive/issue_comments_462213.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T00:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462213",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462214.json:
```json
{
    "body": "Replying to [comment:9 mkoeppe]:\n> Sounds like someone wants to write a decorator for these types of classes\n\nI don't know how to do it with a decorator, but I think a metaclass can ensure that a given class is only subclassed once. As an added bonus, the metaclass can explain why these exist and how they should be used (i.e. that they aren't really abstract base classes).\n\nThis example fails (as intended) the second time we subclass:\n\n\n```python\nclass TypeCheckWrapper(type):\n    _subclasses = 0\n\n    def __init__(cls, name, bases, clsdict):\n        if len(cls.mro()) > 2:\n            TypeCheckWrapper._subclasses += 1\n            if TypeCheckWrapper._subclasses > 1:\n                raise TypeError(\"TypeCheckWrapper with multiple subclasses\")\n        super(TypeCheckWrapper, cls).__init__(name, bases, clsdict)\n\nclass Polyhedron(metaclass=TypeCheckWrapper):\n    pass\n\nprint(\"Defined base class Polyhedron\")\n\nclass Cone(Polyhedron):\n    pass\n\nprint(\"Defined class Cone(Polyhedron)\")\n\nclass Polytope(Polyhedron):\n    pass\n\nprint(\"Defined class Polytope(Polyhedron)\")\n```\n",
    "created_at": "2021-10-18T01:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462214",
    "user": "@orlitzky"
}
```

Replying to [comment:9 mkoeppe]:
> Sounds like someone wants to write a decorator for these types of classes

I don't know how to do it with a decorator, but I think a metaclass can ensure that a given class is only subclassed once. As an added bonus, the metaclass can explain why these exist and how they should be used (i.e. that they aren't really abstract base classes).

This example fails (as intended) the second time we subclass:


```python
class TypeCheckWrapper(type):
    _subclasses = 0

    def __init__(cls, name, bases, clsdict):
        if len(cls.mro()) > 2:
            TypeCheckWrapper._subclasses += 1
            if TypeCheckWrapper._subclasses > 1:
                raise TypeError("TypeCheckWrapper with multiple subclasses")
        super(TypeCheckWrapper, cls).__init__(name, bases, clsdict)

class Polyhedron(metaclass=TypeCheckWrapper):
    pass

print("Defined base class Polyhedron")

class Cone(Polyhedron):
    pass

print("Defined class Cone(Polyhedron)")

class Polytope(Polyhedron):
    pass

print("Defined class Polytope(Polyhedron)")
```




---

archive/issue_comments_462215.json:
```json
{
    "body": "I think this discussion should go to a separate ticket. Note also that some of the ABCs added in other tickets of #32414 are actually extension classes, and using a metaclass there is probably tricky.",
    "created_at": "2021-10-18T01:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462215",
    "user": "@mkoeppe"
}
```

I think this discussion should go to a separate ticket. Note also that some of the ABCs added in other tickets of #32414 are actually extension classes, and using a metaclass there is probably tricky.



---

archive/issue_comments_462216.json:
```json
{
    "body": "A simple solution could be to just add a doctest for the MRO length. We enforce pretty much everything else with doctests as well.",
    "created_at": "2021-10-18T02:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462216",
    "user": "@mkoeppe"
}
```

A simple solution could be to just add a doctest for the MRO length. We enforce pretty much everything else with doctests as well.



---

archive/issue_comments_462217.json:
```json
{
    "body": "\n```\n    TESTS::\n\n        sage: import sage.geometry.abc\n        sage: len(sage.geometry.abc.Polyhedron.__subclasses__()) <= 1\n        True\n```\n",
    "created_at": "2021-10-18T02:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462217",
    "user": "@mkoeppe"
}
```


```
    TESTS::

        sage: import sage.geometry.abc
        sage: len(sage.geometry.abc.Polyhedron.__subclasses__()) <= 1
        True
```




---

archive/issue_comments_462218.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-10-18T02:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462218",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_462219.json:
```json
{
    "body": "How's this?",
    "created_at": "2021-10-18T02:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462219",
    "user": "@mkoeppe"
}
```

How's this?



---

archive/issue_comments_462220.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-18T03:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462220",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_462221.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-10-18T03:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462221",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_462222.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-19T02:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462222",
    "user": "@orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_462223.json:
```json
{
    "body": "We actually have a module (`sage.cpython.cython_metaclass`)  that hacks metaclasses into cython using undocumented internals. What could possibly go wrong?\n\nUsing doctests is good enough.",
    "created_at": "2021-10-19T02:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462223",
    "user": "@orlitzky"
}
```

We actually have a module (`sage.cpython.cython_metaclass`)  that hacks metaclasses into cython using undocumented internals. What could possibly go wrong?

Using doctests is good enough.



---

archive/issue_comments_462224.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-10-19T02:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462224",
    "user": "@mkoeppe"
}
```

Thanks!



---

archive/issue_comments_462225.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-20T23:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32400#issuecomment-462225",
    "user": "@vbraun"
}
```

Resolution: fixed
