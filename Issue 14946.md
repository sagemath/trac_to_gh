# Issue 14946: x in IntegralDomains() should refine category

archive/issues_014946.json:
```json
{
    "body": "CC:  simonking @nthiery\n\nCurrently, ``IntegerModRing`` refines its category if asked for membership in ``Fields()``:\n\n```\nsage: M = IntegerModRing(3)\nsage: M.category()\nJoin of Category of commutative rings ...\nsage: M in Fields()\nTrue\nsage: M.category()\nJoin of Category of fields ...\n```\n\n\nThe same does not happen for ``IntegralDomains()``:\n\n```\nsage: M = IntegerModRing(5)\nsage: M.category()\nJoin of Category of commutative rings ...\nsage: M in IntegralDomains()\nFalse\nsage: M.category()\nJoin of Category of commutative rings ...\n```\n\n\nThe changes on this ticket copy the logic from fields over to integral domains.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15183\n\n",
    "created_at": "2013-09-10T19:23:55Z",
    "labels": [
        "component: categories",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "x in IntegralDomains() should refine category",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14946",
    "user": "https://github.com/saraedum"
}
```
CC:  simonking @nthiery

Currently, ``IntegerModRing`` refines its category if asked for membership in ``Fields()``:

```
sage: M = IntegerModRing(3)
sage: M.category()
Join of Category of commutative rings ...
sage: M in Fields()
True
sage: M.category()
Join of Category of fields ...
```


The same does not happen for ``IntegralDomains()``:

```
sage: M = IntegerModRing(5)
sage: M.category()
Join of Category of commutative rings ...
sage: M in IntegralDomains()
False
sage: M.category()
Join of Category of commutative rings ...
```


The changes on this ticket copy the logic from fields over to integral domains.

Issue created by migration from https://trac.sagemath.org/ticket/15183





---

archive/issue_comments_190630.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-09-10T19:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190630",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_events_043800.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2013-09-10T19:54:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43800"
}
```



---

archive/issue_comments_190631.json:
```json
{
    "body": "Simon, I believe I mostly adapted your code from Fields. Do mind having a look at this?",
    "created_at": "2013-09-10T19:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190631",
    "user": "https://github.com/saraedum"
}
```

Simon, I believe I mostly adapted your code from Fields. Do mind having a look at this?



---

archive/issue_comments_190632.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-10T21:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190632",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_190633.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:",
    "created_at": "2013-09-10T21:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190633",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:



---

archive/issue_comments_190634.json:
```json
{
    "body": "Sorry, I uploaded the wrong branch to this ticket. Should be fixed now.",
    "created_at": "2013-09-10T21:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190634",
    "user": "https://github.com/saraedum"
}
```

Sorry, I uploaded the wrong branch to this ticket. Should be fixed now.



---

archive/issue_comments_190635.json:
```json
{
    "body": "The main problem for me is that it uses git, and as much as I know, the \"master\" branch in the trac-git version of Sage does not pass tests.\n\nHence, I currently have no version of Sage which I could use to test your changes. And besides, my knowledge of git is too little to really understand what has changed and what happened in a dependency.\n\nIn any case, are you really sure that `IntegralDomains()` needs the refinement? The reason for introducing the refinement in testing containment in `Fields()` was the fact that `Fields.__contains__` does some pretty custom things, that are really slow, unless the objects's category is properly initialised. Hence, the idea was to \"cache\" the result of the slow test by refining the category, so that next time the slow test will be avoided.\n\nBut `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?",
    "created_at": "2013-09-10T22:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190635",
    "user": "https://github.com/simon-king-jena"
}
```

The main problem for me is that it uses git, and as much as I know, the "master" branch in the trac-git version of Sage does not pass tests.

Hence, I currently have no version of Sage which I could use to test your changes. And besides, my knowledge of git is too little to really understand what has changed and what happened in a dependency.

In any case, are you really sure that `IntegralDomains()` needs the refinement? The reason for introducing the refinement in testing containment in `Fields()` was the fact that `Fields.__contains__` does some pretty custom things, that are really slow, unless the objects's category is properly initialised. Hence, the idea was to "cache" the result of the slow test by refining the category, so that next time the slow test will be avoided.

But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?



---

archive/issue_comments_190636.json:
```json
{
    "body": "Really, by the time you've established that `Z/nZ` is an integral domain, you can refine it to field anyway (which is an integral domain).",
    "created_at": "2013-09-10T22:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190636",
    "user": "https://github.com/nbruin"
}
```

Really, by the time you've established that `Z/nZ` is an integral domain, you can refine it to field anyway (which is an integral domain).



---

archive/issue_comments_190637.json:
```json
{
    "body": "Replying to [comment:11 SimonKing]:\n> The main problem for me is that it uses git, and as much as I know, the \"master\" branch in the trac-git version of Sage does not pass tests.\nI see.\n\n> Hence, I currently have no version of Sage which I could use to test your changes. And besides, my knowledge of git is too little to really understand what has changed and what happened in a dependency.\nYou could use `./sage --dev diff --base=dependencies` to see the changes introduced on the ticket itself. (with a recent version of #14482, like the one on this ticket, i.e., do `sage -b` before using this command)\n\n> In any case, are you really sure that `IntegralDomains()` needs the refinement? The reason for introducing the refinement in testing containment in `Fields()` was the fact that `Fields.__contains__` does some pretty custom things, that are really slow, unless the objects's category is properly initialised. Hence, the idea was to \"cache\" the result of the slow test by refining the category, so that next time the slow test will be avoided.\nWhat does `Fields.__contains__` do? It calls `.is_field()` which might be expensive (e.g. in the case Z/nZ). Integral domains should do the same, call `.is_integral_domain()` which is as expensive.\n\n> But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?\nI believe that's why the check `IntegerModRing(2) in IntegralDomains()` failed, right?",
    "created_at": "2013-09-11T10:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190637",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:11 SimonKing]:
> The main problem for me is that it uses git, and as much as I know, the "master" branch in the trac-git version of Sage does not pass tests.
I see.

> Hence, I currently have no version of Sage which I could use to test your changes. And besides, my knowledge of git is too little to really understand what has changed and what happened in a dependency.
You could use `./sage --dev diff --base=dependencies` to see the changes introduced on the ticket itself. (with a recent version of #14482, like the one on this ticket, i.e., do `sage -b` before using this command)

> In any case, are you really sure that `IntegralDomains()` needs the refinement? The reason for introducing the refinement in testing containment in `Fields()` was the fact that `Fields.__contains__` does some pretty custom things, that are really slow, unless the objects's category is properly initialised. Hence, the idea was to "cache" the result of the slow test by refining the category, so that next time the slow test will be avoided.
What does `Fields.__contains__` do? It calls `.is_field()` which might be expensive (e.g. in the case Z/nZ). Integral domains should do the same, call `.is_integral_domain()` which is as expensive.

> But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?
I believe that's why the check `IntegerModRing(2) in IntegralDomains()` failed, right?



---

archive/issue_comments_190638.json:
```json
{
    "body": "Replying to [comment:12 nbruin]:\n> Really, by the time you've established that `Z/nZ` is an integral domain, you can refine it to field anyway (which is an integral domain).\nSure, in the case of Z/nZ this is true. However, I tried to implement this on the level of categories, and I don't think that `IntegralDomains()` should try to refine to `Fields()`. One could of course implement this in `IntegerModRing` but I believe it is cleaner like this.",
    "created_at": "2013-09-11T10:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190638",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:12 nbruin]:
> Really, by the time you've established that `Z/nZ` is an integral domain, you can refine it to field anyway (which is an integral domain).
Sure, in the case of Z/nZ this is true. However, I tried to implement this on the level of categories, and I don't think that `IntegralDomains()` should try to refine to `Fields()`. One could of course implement this in `IntegerModRing` but I believe it is cleaner like this.



---

archive/issue_comments_190639.json:
```json
{
    "body": "Replying to [comment:13 saraedum]:\n> What does `Fields.__contains__` do? It calls `.is_field()`\n\nNo, it calls `sage.rings.ring._is_Field`, and this is where `.is_field()` might be called and the refinement might happen.\n\n> Integral domains should do the same, call `.is_integral_domain()` which is as expensive.\n> \n> > But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?\n> I believe that's why the check `IntegerModRing(2) in IntegralDomains()` failed, right?\n\nDo you suggest to introduce a custom `IntegralDomains.__contains__`?",
    "created_at": "2013-09-11T10:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190639",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:13 saraedum]:
> What does `Fields.__contains__` do? It calls `.is_field()`

No, it calls `sage.rings.ring._is_Field`, and this is where `.is_field()` might be called and the refinement might happen.

> Integral domains should do the same, call `.is_integral_domain()` which is as expensive.
> 
> > But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?
> I believe that's why the check `IntegerModRing(2) in IntegralDomains()` failed, right?

Do you suggest to introduce a custom `IntegralDomains.__contains__`?



---

archive/issue_comments_190640.json:
```json
{
    "body": "Replying to [comment:15 SimonKing]:\n> Replying to [comment:13 saraedum]:\n> > What does `Fields.__contains__` do? It calls `.is_field()`\n> \n> No, it calls `sage.rings.ring._is_Field`, and this is where `.is_field()` might be called and the refinement might happen.\nSorry, that's what I meant.\n\n> > Integral domains should do the same, call `.is_integral_domain()` which is as expensive.\n> > \n> > > But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?\n> > I believe that's why the check `IntegerModRing(2) in IntegralDomains()` failed, right?\n> \n> Do you suggest to introduce a custom `IntegralDomains.__contains__`?\nYes. This is what my patch does. Here is the diff: changeset:2282a39",
    "created_at": "2013-09-11T10:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190640",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:15 SimonKing]:
> Replying to [comment:13 saraedum]:
> > What does `Fields.__contains__` do? It calls `.is_field()`
> 
> No, it calls `sage.rings.ring._is_Field`, and this is where `.is_field()` might be called and the refinement might happen.
Sorry, that's what I meant.

> > Integral domains should do the same, call `.is_integral_domain()` which is as expensive.
> > 
> > > But `IntegralDomains` has no custom implementation of `__contains__`. So, could you elaborate a bit more on the reason of your suggestion?
> > I believe that's why the check `IntegerModRing(2) in IntegralDomains()` failed, right?
> 
> Do you suggest to introduce a custom `IntegralDomains.__contains__`?
Yes. This is what my patch does. Here is the diff: changeset:2282a39



---

archive/issue_comments_190641.json:
```json
{
    "body": "Can you tell me why the patchbot only found errors in TWO files, namely\n\n```\nsage -t --long src/sage/dev/sagedev.py  # 1 doctest failed\nsage -t --long src/sage/dev/patch.py  # 2 doctests failed\n```\n\n??\n\nOn my machine, I got many more errors. Or perhaps I am on the wrong branch. I currently have\n\n```\n$ git branch\n* master\n  public/sage-git/master\n  ticket/15120\n```\n\nwhere #15120 is supposed to fix some remaining tests. But I am not sure, perhaps one of the two branches above is not the sage-trac master. How can I find out whether my current branch pulls from github or from trac?",
    "created_at": "2013-09-11T11:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190641",
    "user": "https://github.com/simon-king-jena"
}
```

Can you tell me why the patchbot only found errors in TWO files, namely

```
sage -t --long src/sage/dev/sagedev.py  # 1 doctest failed
sage -t --long src/sage/dev/patch.py  # 2 doctests failed
```

??

On my machine, I got many more errors. Or perhaps I am on the wrong branch. I currently have

```
$ git branch
* master
  public/sage-git/master
  ticket/15120
```

where #15120 is supposed to fix some remaining tests. But I am not sure, perhaps one of the two branches above is not the sage-trac master. How can I find out whether my current branch pulls from github or from trac?



---

archive/issue_comments_190642.json:
```json
{
    "body": "Replying to [comment:17 SimonKing]:\n> Can you tell me why the patchbot only found errors in TWO files, namely\n> {{{\n> sage -t --long src/sage/dev/sagedev.py  # 1 doctest failed\n> sage -t --long src/sage/dev/patch.py  # 2 doctests failed\n> }}}\n> ??\nI'm not sure what the patchbot does. It might merge in a few changes for the doctests but I don't know.\n\n> On my machine, I got many more errors. Or perhaps I am on the wrong branch. I currently have\n> {{{\n> $ git branch\n> * master\n>   public/sage-git/master\n>   ticket/15120\n> }}}\n> where #15120 is supposed to fix some remaining tests. But I am not sure, perhaps one of the two branches above is not the sage-trac master. How can I find out whether my current branch pulls from github or from trac?\n`git branch -vv` shows where the branches pull from. You can of course also pull explicitely: `git pull http://trac.sagemath.org/sage.git public/sage-git/master`.",
    "created_at": "2013-09-11T11:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190642",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:17 SimonKing]:
> Can you tell me why the patchbot only found errors in TWO files, namely
> {{{
> sage -t --long src/sage/dev/sagedev.py  # 1 doctest failed
> sage -t --long src/sage/dev/patch.py  # 2 doctests failed
> }}}
> ??
I'm not sure what the patchbot does. It might merge in a few changes for the doctests but I don't know.

> On my machine, I got many more errors. Or perhaps I am on the wrong branch. I currently have
> {{{
> $ git branch
> * master
>   public/sage-git/master
>   ticket/15120
> }}}
> where #15120 is supposed to fix some remaining tests. But I am not sure, perhaps one of the two branches above is not the sage-trac master. How can I find out whether my current branch pulls from github or from trac?
`git branch -vv` shows where the branches pull from. You can of course also pull explicitely: `git pull http://trac.sagemath.org/sage.git public/sage-git/master`.



---

archive/issue_comments_190643.json:
```json
{
    "body": "Replying to [comment:18 saraedum]:\n> `git branch -vv` shows where the branches pull from.\n\nNot really.\n\n```\n$ git branch -vv\n* master                 b890215 [origin/public/sage-git/master] Merge branch 'ticket/14482' into public/sage-git/master\n  public/sage-git/master cf14c84 [origin/public/sage-git/master: behind 562] Merge branch 'ticket/14482' into public/sage-git/master\n  ticket/15120           6912669 Fix --new option for doctests.\n```\n\n\nNeither trac nor github are mentioned...\n\n> You can of course also pull explicitely: `git pull http://trac.sagemath.org/sage.git public/sage-git/master`.\n\nAm I correct that this would pull into my \"public/sage-git/master\" branch, but would not affect the other branch called \"master\"?\n\nI am sure that one branch was obtained from github and the other from trac, and it is a shame that it can't clearly (at least to my understanding) tell which is which.",
    "created_at": "2013-09-11T12:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190643",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:18 saraedum]:
> `git branch -vv` shows where the branches pull from.

Not really.

```
$ git branch -vv
* master                 b890215 [origin/public/sage-git/master] Merge branch 'ticket/14482' into public/sage-git/master
  public/sage-git/master cf14c84 [origin/public/sage-git/master: behind 562] Merge branch 'ticket/14482' into public/sage-git/master
  ticket/15120           6912669 Fix --new option for doctests.
```


Neither trac nor github are mentioned...

> You can of course also pull explicitely: `git pull http://trac.sagemath.org/sage.git public/sage-git/master`.

Am I correct that this would pull into my "public/sage-git/master" branch, but would not affect the other branch called "master"?

I am sure that one branch was obtained from github and the other from trac, and it is a shame that it can't clearly (at least to my understanding) tell which is which.



---

archive/issue_comments_190644.json:
```json
{
    "body": "Replying to [comment:19 SimonKing]:\n> Replying to [comment:18 saraedum]:\n> > `git branch -vv` shows where the branches pull from.\n> \n> Not really.\n> {{{\n> $ git branch -vv\n> * master                 b890215 [origin/public/sage-git/master] Merge branch 'ticket/14482' into public/sage-git/master\n>   public/sage-git/master cf14c84 [origin/public/sage-git/master: behind 562] Merge branch 'ticket/14482' into public/sage-git/master\n>   ticket/15120           6912669 Fix --new option for doctests.\n> }}}\nSo, `master` and `public/sage-git/master` pull from origin. To find out what is `origin`, type `git remote -v`.\n\n> > You can of course also pull explicitely: `git pull http://trac.sagemath.org/sage.git public/sage-git/master`.\n> \n> Am I correct that this would pull into my \"public/sage-git/master\" branch, but would not affect the other branch called \"master\"?\nThis would pull into the current branch, the one with the asterisk in `git branch`.\n\n> I am sure that one branch was obtained from github and the other from trac, and it is a shame that it can't clearly (at least to my understanding) tell which is which.\nIt seems that they both came from trac. At least their latest version does. It does not really matter where they originally came from.",
    "created_at": "2013-09-11T12:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190644",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:19 SimonKing]:
> Replying to [comment:18 saraedum]:
> > `git branch -vv` shows where the branches pull from.
> 
> Not really.
> {{{
> $ git branch -vv
> * master                 b890215 [origin/public/sage-git/master] Merge branch 'ticket/14482' into public/sage-git/master
>   public/sage-git/master cf14c84 [origin/public/sage-git/master: behind 562] Merge branch 'ticket/14482' into public/sage-git/master
>   ticket/15120           6912669 Fix --new option for doctests.
> }}}
So, `master` and `public/sage-git/master` pull from origin. To find out what is `origin`, type `git remote -v`.

> > You can of course also pull explicitely: `git pull http://trac.sagemath.org/sage.git public/sage-git/master`.
> 
> Am I correct that this would pull into my "public/sage-git/master" branch, but would not affect the other branch called "master"?
This would pull into the current branch, the one with the asterisk in `git branch`.

> I am sure that one branch was obtained from github and the other from trac, and it is a shame that it can't clearly (at least to my understanding) tell which is which.
It seems that they both came from trac. At least their latest version does. It does not really matter where they originally came from.



---

archive/issue_comments_190645.json:
```json
{
    "body": "Replying to [comment:20 saraedum]:\n> So, `master` and `public/sage-git/master` pull from origin. To find out what is `origin`, type `git remote -v`.\n\n\n```\ngit remote -v\norigin  ssh://git@trac.sagemath.org:2222/sage.git (fetch)\norigin  ssh://git@trac.sagemath.org:2222/sage.git (push)\n```\n\nSo, to my surprise, there is no github in it.",
    "created_at": "2013-09-11T12:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190645",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:20 saraedum]:
> So, `master` and `public/sage-git/master` pull from origin. To find out what is `origin`, type `git remote -v`.


```
git remote -v
origin  ssh://git@trac.sagemath.org:2222/sage.git (fetch)
origin  ssh://git@trac.sagemath.org:2222/sage.git (push)
```

So, to my surprise, there is no github in it.



---

archive/issue_events_043801.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43801"
}
```



---

archive/issue_events_043802.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43802"
}
```



---

archive/issue_comments_190646.json:
```json
{
    "body": "Okay guys, it looks like Nicolas says that category containment should *not* refine the category, and on the other hand Fields already do it. What do you decide ?\n\nNathann",
    "created_at": "2013-12-26T19:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190646",
    "user": "https://github.com/nathanncohen"
}
```

Okay guys, it looks like Nicolas says that category containment should *not* refine the category, and on the other hand Fields already do it. What do you decide ?

Nathann



---

archive/issue_comments_190647.json:
```json
{
    "body": "Just in case...\n\nNathann",
    "created_at": "2013-12-26T19:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190647",
    "user": "https://github.com/nathanncohen"
}
```

Just in case...

Nathann



---

archive/issue_comments_190648.json:
```json
{
    "body": "Replying to [comment:23 ncohen]:\n> Okay guys, it looks like Nicolas says that category containment should *not* refine the category,\n\nFor good reason! Category refinement involves changing the **class** of an object after creation, and actually after **usage**! Python lets you do those things, but really it is a dangerous hack.\n\nWe have seen cases in which the hash of a parent depends on the class of the parent. Hence, if a category refinement happens after (or while) using a parent P as key of a dictionary, it used to be possible that P was put in the wrong hash bucket of the dictionary. Fortunately, someone (I think it was Volker) added a security layer, so that now changing the class results in an error if it changes the hash.\n\nBut apart from hash, one often sees the following in `__cmp__` methods:\n\n```python\ndef __cmp__(self, other):\n    c = cmp(type(self),type(other))\n    if c:\n        return c\n    return cmp(<data for self>,<data for other>)\n```\n\nHence, if you add category refinement, comparison could break: Imagine you originally had `cmp(self,other)==0` and then did `self in IntegralDomains()` (triggering a category refinement) but didn't `other in IntegralDomains()`. Now, ask `cmp(self,other)`: The result will *not* be zero any more!\n\nMathematically, a category refinement should be fine, and one may think that the category framework is designed to be stable against category refinement (\"if you refine the category of P, then P may inherit different methods from the category framework than before, but these new methods will fit better.\"). However, some of these methods do caching. Hence, if P originally belongs to category C1 and it got some method `meth()` which did some caching, and then you refine P's category to be C2, so that P now inherits a *different* version of `meth()` that uses a different cache, then you have a mess.\n\nOne could argue that it is a bug if you *do* get a mess upon category refinement. But perhaps it is wise to not consciously ask for trouble...\n\n> and on the other hand Fields already do it.\n\nYes, I know, I have to take the full blame...\n\nBut the situation was different than the situation here!\n\nWhen I introduced category refinement for fields, `Fields.__contains__` used to be custom since a long time. This custom method was very very slow, but the default `__contains__` method couldn't be used unless all parents' categories were fully initialised. But then, the initialisation took too much time. Hence, I went for a compromise: Keep initialisation fast, and accept that the *first* `Fields()` containment test is slow; but in case of success, make sure that all further containment test will be quick.\n\nI was motivated by a concrete example that was important to a \"powerful\" Sage sub-community (you know, elliptic curves and so on): This example became way too slow after implementing the category framework for all rings. Reason: Initialisation of these rings took way too long, since for each ring it was needed to test whether the modulus is a prime number. Guided by this example (and a similar example for matrix spaces) I found that a \"lazy\" category initialisation can avoid certain severe regressions.\n\nHowever, here, things are different: As much as I understand, the suggestion is to let `IntegralDomains()` have a custom `__contains__` method, just because `Fields()` has a custom `__contains__` method too. But since `Category_singleton.__contains__` is very very fast, it should not be overridden by a custom `__contains__` without a very very good and compelling reason. It could actually be that some examples will become *slower* when the containment test will regress.\n\nPut differently: I haven't seen any concrete \"real world\" example that shows that we need lazy category initialisation for (some) integral domains. Without such example, I'd say we should better not open Pandora's box again.",
    "created_at": "2013-12-26T19:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190648",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:23 ncohen]:
> Okay guys, it looks like Nicolas says that category containment should *not* refine the category,

For good reason! Category refinement involves changing the **class** of an object after creation, and actually after **usage**! Python lets you do those things, but really it is a dangerous hack.

We have seen cases in which the hash of a parent depends on the class of the parent. Hence, if a category refinement happens after (or while) using a parent P as key of a dictionary, it used to be possible that P was put in the wrong hash bucket of the dictionary. Fortunately, someone (I think it was Volker) added a security layer, so that now changing the class results in an error if it changes the hash.

But apart from hash, one often sees the following in `__cmp__` methods:

```python
def __cmp__(self, other):
    c = cmp(type(self),type(other))
    if c:
        return c
    return cmp(<data for self>,<data for other>)
```

Hence, if you add category refinement, comparison could break: Imagine you originally had `cmp(self,other)==0` and then did `self in IntegralDomains()` (triggering a category refinement) but didn't `other in IntegralDomains()`. Now, ask `cmp(self,other)`: The result will *not* be zero any more!

Mathematically, a category refinement should be fine, and one may think that the category framework is designed to be stable against category refinement ("if you refine the category of P, then P may inherit different methods from the category framework than before, but these new methods will fit better."). However, some of these methods do caching. Hence, if P originally belongs to category C1 and it got some method `meth()` which did some caching, and then you refine P's category to be C2, so that P now inherits a *different* version of `meth()` that uses a different cache, then you have a mess.

One could argue that it is a bug if you *do* get a mess upon category refinement. But perhaps it is wise to not consciously ask for trouble...

> and on the other hand Fields already do it.

Yes, I know, I have to take the full blame...

But the situation was different than the situation here!

When I introduced category refinement for fields, `Fields.__contains__` used to be custom since a long time. This custom method was very very slow, but the default `__contains__` method couldn't be used unless all parents' categories were fully initialised. But then, the initialisation took too much time. Hence, I went for a compromise: Keep initialisation fast, and accept that the *first* `Fields()` containment test is slow; but in case of success, make sure that all further containment test will be quick.

I was motivated by a concrete example that was important to a "powerful" Sage sub-community (you know, elliptic curves and so on): This example became way too slow after implementing the category framework for all rings. Reason: Initialisation of these rings took way too long, since for each ring it was needed to test whether the modulus is a prime number. Guided by this example (and a similar example for matrix spaces) I found that a "lazy" category initialisation can avoid certain severe regressions.

However, here, things are different: As much as I understand, the suggestion is to let `IntegralDomains()` have a custom `__contains__` method, just because `Fields()` has a custom `__contains__` method too. But since `Category_singleton.__contains__` is very very fast, it should not be overridden by a custom `__contains__` without a very very good and compelling reason. It could actually be that some examples will become *slower* when the containment test will regress.

Put differently: I haven't seen any concrete "real world" example that shows that we need lazy category initialisation for (some) integral domains. Without such example, I'd say we should better not open Pandora's box again.



---

archive/issue_events_043803.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43803"
}
```



---

archive/issue_events_043804.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43804"
}
```



---

archive/issue_comments_190649.json:
```json
{
    "body": "So, does this ticket still need review? Should it be closed as wontfix?",
    "created_at": "2014-02-11T16:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190649",
    "user": "https://github.com/mezzarobba"
}
```

So, does this ticket still need review? Should it be closed as wontfix?



---

archive/issue_comments_190650.json:
```json
{
    "body": "Simon made a good point. I did this for consistency with Fields. I see now that it is better not to introduce this change.",
    "created_at": "2014-02-11T16:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190650",
    "user": "https://github.com/saraedum"
}
```

Simon made a good point. I did this for consistency with Fields. I see now that it is better not to introduce this change.



---

archive/issue_events_043805.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-02-11T16:45:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43805"
}
```



---

archive/issue_events_043806.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-02-11T16:45:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43806"
}
```



---

archive/issue_comments_190651.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-11T16:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190651",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_043807.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-02-11T21:23:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14946#event-43807"
}
```



---

archive/issue_comments_190652.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2014-02-11T21:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14946#issuecomment-190652",
    "user": "https://github.com/vbraun"
}
```

Resolution: wontfix
