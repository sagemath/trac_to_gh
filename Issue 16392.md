# Issue 16392: sage-fix-pkg-checksums munches build/pkgs/<packagename>/checksums

Issue created by migration from https://trac.sagemath.org/ticket/16629

Original creator: charpent

Original creation time: 2014-07-08 21:12:58

The current (as of sage-6.3.beta5) version of sage-fix-pkg-checksums replaces the package version in build/pkgs/<package-name>/package-version.txt and checksums.ini

An example of the result can be found in comment 27 of [http://trac.sagemath.org/ticket/16611](http://trac.sagemath.org/ticket/16611). It is also germane to [http://trac.sagemath.org/ticket/16489](http://trac.sagemath.org/ticket/16489).


---

Comment by charpent created at 2014-07-08 21:40:59

The proposed solution needs to be reviewed by someone more knowledgeable in the sage building system than I am.
----
New commits:


---

Comment by charpent created at 2014-07-08 21:40:59

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-07-08 22:16:16

French commit messages are verboten ;-)


---

Comment by vbraun created at 2014-07-08 22:29:13

Hmm "fubar"?

Having old tarballs in upstream/ is normal and shouldn't lead to endless warnings.

IMHO there shouldn't be any warnings, anything that is not correct ought to be a hard error. If we aren't strict about it we are bound to get track tickets with invalid checksums.ini.


---

Comment by vbraun created at 2014-07-08 22:29:13

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2014-07-08 22:48:16

Replying to [comment:4 vbraun]:
> Hmm "fubar"?

Wups. Oversight. Fixed...

> Having old tarballs in upstream/ is normal and shouldn't lead to endless warnings.

What do you mean ? 

> IMHO there shouldn't be any warnings, anything that is not correct ought to be a hard error. If we aren't strict about it we are bound to get track tickets with invalid checksums.ini.

Fix underway : orders rather than suggestions.


---

Comment by git created at 2014-07-08 22:54:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-08 22:57:58

"Tous vos ordres, Seigneur, seront exécutés" (Jean Racine) [ Hey, it's not a commit message... ]

Followed Volker's suggestions.


---

Comment by charpent created at 2014-07-08 22:57:58

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-07-12 00:23:52

I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. Yet I get: 

```
(sage-sh) vbraun@localhost:upstream$ sage-fix-pkg-checksums 
atlas-3.10.1.20140128.tar.bz2
Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.
Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.
```



---

Comment by charpent created at 2014-07-12 01:35:07

Replying to [comment:8 vbraun]:
> I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. Yet I get: 
> {{{
> (sage-sh) vbraun`@`localhost:upstream$ sage-fix-pkg-checksums 
> atlas-3.10.1.20140128.tar.bz2
> Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.
> Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.
> }}}
Hmmm... Now we have a conflict on intended usage(s) (and therefore designs) :
* The `builg/pkgs/<pkgname>/...` structure implies at most one version per package name.
* The relevant snippet of the [Developer's guide](http://www.sagemath.org/doc/developer/packaging.html#checksums) hints at a "batch" usage of `src/bin/sage-fix-pkg-checksums.`
So far, that's consistent with `upstream/` as *the* set of active (i. e. built by Sage's build system) Sage's external packages source tarballs.
* Your intended usage amounts to use `upstream/` as *a* cache of potential external packages, the set of *active* Sage external packages being determined otherwise.
    a. This might be the `build/pkgs/*/package-version.txt` set, in which case the `sage-fix-pkg-checksums` script should loop over this set and try to find a relevant tarball. At most, it might spit a warning (or fail) when no such tarball exists. No automatic rewriting possible.
    b. It might be an external file listing each package and the relevant version. That makes `build/pkgs/<pkgname>/package-version.txt` redundant (and a possible source of conflicts).
The case 1. is consistent, but needs a script like `sage-fix-one-pkg-checksum-Volkers-style` to generate the right checksums. As said before, the current batch-style script should loop on the `build/pkgs/...` tree.

In any case, it appears that the consistency of the proposed change (use `upstream/` as a cache and not as a reference set) needs modifying the use of this script (and, quite possibly, the rest of the build subsystem for external packages). Since I do not yet know my way in this system, fixing this is, for now, out of my reach. At a minimum, I need advice from someone knowing what it does.

By the way, what is wrong with an external (`.gitignore`d) directory and `mv` ing the right tarball at the right time ? An even lazier solution is, of course, to symlink the right tarball in `upstream/`, but I doubt one can get `git` to follow this transparently.

Since we are playing redesigning this subsystem, may I ask why we have to have `package-version.txt` and `checksums.ini` to describe different attributes of the same tarball ? Why not one file ?


---

Comment by vbraun created at 2014-07-12 01:39:58

The upstream/ directory has always been meant as a cache where possibly multiple versions of tarballs are stored, potentially even shared between different sage installations. This is also how the sage-fix-pkg-checksums script works right now, it looks for a tarball matching `build/pkgs/*/package-version.txt` and ignores the rest.

The split package-version.txt and checksums.ini is to make reading the version easier from scripts. I didn't vote for it...


---

Comment by charpent created at 2014-07-12 01:48:26

Replying to [comment:8 vbraun] with a bit of "esprit de l'escalier"...:
> I've got various tarball versions of most packages. I don't want to delete them because I might want to go back to an older ticket. 

Different branches, I suppose ? If so, why not let `git` track the change of tarball ?

> Yet I get: 
> {{{
> (sage-sh) vbraun`@`localhost:upstream$ sage-fix-pkg-checksums 
> atlas-3.10.1.20140128.tar.bz2
> Version mismatch between tarball 3.10.1.20140128 and directory build/pkgs/atlas.
> Newer version ? You must put 3.10.1.20140128.p0 in package-version.txt.
> }}}


---

Comment by vbraun created at 2014-07-12 03:19:40

I think I'm not clear, so let me try again. Git **does** track the package version, because `package-version.txt` is checked into the repository. For any given Sage commit, `build/pkgs/*/package-version.txt` is the only relevant set of tarball versions. The upstream/ directory content is irrelevant, and only used to cache downloaded tarballs.


---

Comment by jhpalmieri created at 2014-07-12 03:58:35

I agree with Volker that nothing in `upstream` should be tracked; we should be free to have tarballs for many versions of each package there. I mean, it might be nice to have a script which cleaned this directory up, deleting all out of date versions, but that would be (1) a very low priority (since you can just delete the whole directory if you have a good internet connection) and (2) for another ticket.


---

Comment by rws created at 2014-07-12 07:12:03

Replying to [comment:10 vbraun]:
> ... it looks for a tarball matching `build/pkgs/*/package-version.txt` and ignores the rest.
Minus the patchlevel, to be exact.


---

Comment by charpent created at 2014-07-12 08:15:48

Replying to [comment:12 vbraun]:
> I think I'm not clear, so let me try again. Git **does** track the package version, because `package-version.txt` is checked into the repository. For any given Sage commit, `build/pkgs/*/package-version.txt` is the only relevant set of tarball versions. The upstream/ directory content is irrelevant, and only used to cache downloaded tarballs.
> 

I beg to differ : From the current `sage-fix-pkg-checksum`, (as in the `develop` branch) :


```/usr/bin/env bash

# If any command-line arguments are present, treat them as files to be
# checksummed. If no arguments are present, all tarballs in
# $SAGE_ROOT/upstream are checksummed.
if [ $# -eq 0 ]; then
    cd "$SAGE_ROOT"
    set upstream/*.tar*
fi
```


In other words, the current version is driven by the content of `upstream/` if no argument is given. If an (some) argument(s) is|are given, it uses the beginning of each argument up to the first dash as a package name and whatever follows `tar` in this argument as the compression method. Therefore, this will produce the expected behaviour IF AND ONLY IF the script is passed tarball filenames.

It will also produce the expected result if given arguments *containing the package version*. But not with arguments containing the package name only : there is no information available to choose which version is to be documented in `build/pkgs/<pkgname>/package-version.txt|checksums.ini`.

A simple fix is to ignore package version mismatchs (i. e. removing the error message an the abort). In this case, the tarball ultimately documented in `build/pkgs/<pkgname>/checksums.ini` will be the one passed in argument, or the last matching the package name in the `upstream/` file list (lexicographic order).

Another possibility is to use `build/pkgs` ad the corresponding `package-version.txt` to get the necessary information, and search `upstream/` for a relevant tarball. In this case, one might find one tarball (and process it as before), none (one type of error) or more than one (another type of error).

Which one do you want ?


---

Comment by vbraun created at 2014-07-12 13:57:22

Replying to [comment:14 rws]:
> Minus the patchlevel, to be exact. 

Exactly, which is another reason for why the `package-version.txt` is the authorative version. Also, the Sage build process uses the `package-version.txt` timestamp to determine whether a package needs to be rebuilt, which is why you need to add the patch level here.

The `sage-fix-pkg-checksum` iterates over upstream/ and then ignores any entries for which there is no corresponding `build/pkgs/*/package-version.txt`. So that it can auto-generate the entire checksums.ini (though it trips over cases). E.g. hashdist has a much more sensible system of caching upstream sources.


---

Comment by git created at 2014-07-12 14:23:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-12 14:32:11

Okay. New commit ==> back to previous behaviour.

I still kept the ability to accept mixed-case tarball names (with no warning).

When called without arguments, the script will treat all tarballs. Therefore, for a given package, the last package treated (i. e. last in the lexicographic order) will be the one used for the final `checksums.ini` for that package. Is that what you wanted ?

When called with explicit tarball names, these tarballs will generate `checksums.ini`.

Status still `needs_review`.


---

Comment by vbraun created at 2014-07-13 05:00:19

No, the last in lex order is wrong. Version 3.9 is older than 3.10. Really, you need to get the version from the `package-version.txt` file.


---

Comment by git created at 2014-07-13 07:15:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-13 07:16:44

Done. I hope I've guessed the specs right this time...


---

Comment by vbraun created at 2014-07-16 19:55:29

The "fubar" file is still in the branch...


---

Comment by git created at 2014-07-16 20:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-16 20:56:09

Replying to [comment:22 vbraun]:
> The "fubar" file is still in the branch...

Re-wups ! I didn't saw *that* when I checked before committing/pushing. Should be good now.


---

Comment by jdemeyer created at 2014-09-17 10:40:46

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-17 10:40:46

Authors: please describe what this patch is supposed to do, because the previous description was wrong (`package-version.txt` isn't changed by `sage-fix-pkg-checksums`)  and confusing! It's easier to review when I know what this patch is supposed to achieve.

And fix the indentation please: no TABS, use indents of 4 spaces

And I would like to add an additional change:

```
upstream_pkg_name=${tarball%-*}
```

should become

```
upstream_pkg_name=${tarball%%-*}
```

to allow upstream versions with dashes (package-abc-1 should have package name "package" and version "abc-1").


---

Comment by git created at 2014-12-01 11:35:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-12-01 11:46:29

Replying to [comment:26 jdemeyer]:
> Authors: please describe what this patch is supposed to do, because the previous description was wrong (`package-version.txt` isn't changed by `sage-fix-pkg-checksums`)  and confusing! It's easier to review when I know what this patch is supposed to achieve.

Done

> And fix the indentation please: no TABS, use indents of 4 spaces

Also done. Although I wonder why this recommendation, which is sensible for python (and sage) programs, should apply to shell scripts, which are a horse of a totally different color...

> And I would like to add an additional change:
> {{{
> upstream_pkg_name=${tarball%-*}
> }}}
> should become
> {{{
> upstream_pkg_name=${tarball%%-*}
> }}}
> to allow upstream versions with dashes (package-abc-1 should have package name "package" and version "abc-1").

Also done (although I'm not sure of the pertinence...).

HTH,


---

Comment by charpent created at 2014-12-01 11:46:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-01 22:34:47

Replying to [ticket:16629 charpent]:
> The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the *literal* `"VERSION"` in `checksums.ini`, which is confusing and not helpful.
It's a feature, not a bug. It ensures that version info is stored in exactly one place, namely `package-version.txt`.


---

Comment by jdemeyer created at 2014-12-01 22:36:21

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-04-12 14:40:06

Replying to [comment:29 jdemeyer]:
> Replying to [ticket:16629 charpent]:
> > The current version of `sage-fix-pkg-checksums` incorrectly sets the package version to the *literal* `"VERSION"` in `checksums.ini`, which is confusing and not helpful.
> It's a feature, not a bug. It ensures that version info is stored in exactly one place, namely `package-version.txt`.
So, you think it's wontfix?


---

Comment by rws created at 2015-04-12 14:40:06

Changing status from needs_work to needs_info.


---

Comment by jdemeyer created at 2015-04-22 09:31:41

Changing status from needs_info to positive_review.


---

Comment by vbraun created at 2015-04-23 01:43:56

Resolution: wontfix
