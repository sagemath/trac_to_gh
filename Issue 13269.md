# Issue 13269: refactor gcd

archive/issues_013269.json:
```json
{
    "body": "Assignee: @aghitza\n\nCurrently, some classes define a `_gcd` method which is called by a `gcd` method of euclidean domain elements. Most elements already define `gcd` directly, and I see no real use in having this method in between.\n\nThe attached patch renames all `_gcd` methods to `gcd` and also streamlines the use of ``@`coerce_binop` on them.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13441\n\n",
    "created_at": "2012-09-08T22:09:15Z",
    "labels": [
        "component: basic arithmetic",
        "trivial"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "refactor gcd",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13269",
    "user": "https://github.com/saraedum"
}
```
Assignee: @aghitza

Currently, some classes define a `_gcd` method which is called by a `gcd` method of euclidean domain elements. Most elements already define `gcd` directly, and I see no real use in having this method in between.

The attached patch renames all `_gcd` methods to `gcd` and also streamlines the use of ``@`coerce_binop` on them.

Issue created by migration from https://trac.sagemath.org/ticket/13441





---

archive/issue_comments_162477.json:
```json
{
    "body": "I also removed `Polynomial_dense_mod_p`'s gcd since it cannot be called at all. (I'm running doctests now to verify this.)",
    "created_at": "2012-09-08T22:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162477",
    "user": "https://github.com/saraedum"
}
```

I also removed `Polynomial_dense_mod_p`'s gcd since it cannot be called at all. (I'm running doctests now to verify this.)



---

archive/issue_comments_162478.json:
```json
{
    "body": "Removed Rational's gcd since it was not used anymore (rational numbers rely on `QuotientFields.ElementMethods.gcd`).",
    "created_at": "2012-10-20T19:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162478",
    "user": "https://github.com/saraedum"
}
```

Removed Rational's gcd since it was not used anymore (rational numbers rely on `QuotientFields.ElementMethods.gcd`).



---

archive/issue_comments_162479.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-20T23:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162479",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162480.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2012-10-24T09:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162480",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_162481.json:
```json
{
    "body": "My main concern is with a speed penalty in doing gcds for rationals, polynomial_integer_dense_ntl, etc.  Have you compared the runtime of the gcds before and after your changes?\n\nI agree that it's conceptually nicer.",
    "created_at": "2012-10-24T09:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162481",
    "user": "https://github.com/roed314"
}
```

My main concern is with a speed penalty in doing gcds for rationals, polynomial_integer_dense_ntl, etc.  Have you compared the runtime of the gcds before and after your changes?

I agree that it's conceptually nicer.



---

archive/issue_comments_162482.json:
```json
{
    "body": "Without the patch I get:\n\n```\nsage: x,y=34912364,123324234\nsage: timeit('x.gcd(y)')\n625 loops, best of 3: 430 ns per loop\nsage: x,y=234/234525,4324525/12351\nsage: timeit('x.gcd(y)')\n625 loops, best of 3: 11.5 \u00b5s per loop\nsage: R.<T>=ZZ[]\nsage: x,y=123*T^2+23424*T+1231,1231451*T^3+65*T^2+352*T+234251\nsage: timeit('x.gcd(y)')\n625 loops, best of 3: 6.06 \u00b5s per loop\n```\n\n\nWith the patch:\n\n```\nsage: x,y=34912364,123324234\nsage: timeit('x.gcd(y)')\n625 loops, best of 3: 1.13 \u00b5s per loop\nsage: x,y=234/234525,4324525/12351\nsage: timeit('x.gcd(y)')\n625 loops, best of 3: 14.1 \u00b5s per loop\nsage: R.<T>=ZZ[]\nsage: x,y=123*T^2+23424*T+1231,1231451*T^3+65*T^2+352*T+234251\nsage: timeit('x.gcd(y)')\n625 loops, best of 3: 6.21 \u00b5s per loop\n```\n\n\nSo there is actually a speed penalty. This seems to be caused by a bug in `coerce_binop`:\n\n\n```\nsage: x.gcd\n<sage.structure.element.NamedBinopMethod object at 0x1bc255f0>\nsage: x.gcd\n<sage.structure.element.NamedBinopMethod object at 0x1bc27290>\n```\n\n\nI'm looking into this.",
    "created_at": "2012-11-14T18:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162482",
    "user": "https://github.com/saraedum"
}
```

Without the patch I get:

```
sage: x,y=34912364,123324234
sage: timeit('x.gcd(y)')
625 loops, best of 3: 430 ns per loop
sage: x,y=234/234525,4324525/12351
sage: timeit('x.gcd(y)')
625 loops, best of 3: 11.5 µs per loop
sage: R.<T>=ZZ[]
sage: x,y=123*T^2+23424*T+1231,1231451*T^3+65*T^2+352*T+234251
sage: timeit('x.gcd(y)')
625 loops, best of 3: 6.06 µs per loop
```


With the patch:

```
sage: x,y=34912364,123324234
sage: timeit('x.gcd(y)')
625 loops, best of 3: 1.13 µs per loop
sage: x,y=234/234525,4324525/12351
sage: timeit('x.gcd(y)')
625 loops, best of 3: 14.1 µs per loop
sage: R.<T>=ZZ[]
sage: x,y=123*T^2+23424*T+1231,1231451*T^3+65*T^2+352*T+234251
sage: timeit('x.gcd(y)')
625 loops, best of 3: 6.21 µs per loop
```


So there is actually a speed penalty. This seems to be caused by a bug in `coerce_binop`:


```
sage: x.gcd
<sage.structure.element.NamedBinopMethod object at 0x1bc255f0>
sage: x.gcd
<sage.structure.element.NamedBinopMethod object at 0x1bc27290>
```


I'm looking into this.



---

archive/issue_comments_162483.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-11-14T18:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162483",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_162484.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-11-14T18:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162484",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_162485.json:
```json
{
    "body": "Replying to [comment:10 saraedum]:\n> So there is actually a speed penalty. This seems to be caused by a bug in `coerce_binop`:\n> \n> {{{\n> sage: x.gcd\n> <sage.structure.element.NamedBinopMethod object at 0x1bc255f0>\n> sage: x.gcd\n> <sage.structure.element.NamedBinopMethod object at 0x1bc27290>\n> }}}\n\nThis is just how decorators work on methods (if they don't do tricks like cached_method) - the `__get__` has to create a new instance on every call.",
    "created_at": "2012-11-15T13:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162485",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:10 saraedum]:
> So there is actually a speed penalty. This seems to be caused by a bug in `coerce_binop`:
> 
> {{{
> sage: x.gcd
> <sage.structure.element.NamedBinopMethod object at 0x1bc255f0>
> sage: x.gcd
> <sage.structure.element.NamedBinopMethod object at 0x1bc27290>
> }}}

This is just how decorators work on methods (if they don't do tricks like cached_method) - the `__get__` has to create a new instance on every call.



---

archive/issue_comments_162486.json:
```json
{
    "body": "The speed problems seem to be resolved with the new patch:\n\nWithout the patch:\n\n```\nsage: x,y=34912364,123324234\nsage: sage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 427 ns per loop\nsage: sage: R.<t>=PolynomialRing(GF(3),implementation=\"NTL\")\nsage: sage: x,y=t^2-1,t-1\nsage: sage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 35.5 \u00b5s per loop\nage: sage: x,y=234/234525,4324525/12351\nsage: sage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 11.4 \u00b5s per loop\nage: sage: R.<t> = PolynomialRing(ZZ,implementation=\"NTL\")\nsage: sage: x,y=t^2-1,t-1\nsage: sage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 17.8 \u00b5s per loop\n```\n\n\nWith the patch:\n\n```\nsage: x,y=34912364,123324234\nsage: sage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 421 ns per loop\nsage: R.<t>=PolynomialRing(GF(3),implementation=\"NTL\")\nsage: x,y=t^2-1,t-1\nsage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 32.7 \u00b5s per loop\nsage: x,y=234/234525,4324525/12351\nsage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 11.5 \u00b5s per loop\nsage: R.<t> = PolynomialRing(ZZ,implementation=\"NTL\")\nsage: x,y=t^2-1,t-1\nsage: sage: timeit('x.gcd(y)')\n625 loops, best of 3: 17.3 \u00b5s per loop\n```\n\n\nLet's see what the patchbot thinks about it\u2026",
    "created_at": "2012-11-15T14:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162486",
    "user": "https://github.com/saraedum"
}
```

The speed problems seem to be resolved with the new patch:

Without the patch:

```
sage: x,y=34912364,123324234
sage: sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 427 ns per loop
sage: sage: R.<t>=PolynomialRing(GF(3),implementation="NTL")
sage: sage: x,y=t^2-1,t-1
sage: sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 35.5 µs per loop
age: sage: x,y=234/234525,4324525/12351
sage: sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 11.4 µs per loop
age: sage: R.<t> = PolynomialRing(ZZ,implementation="NTL")
sage: sage: x,y=t^2-1,t-1
sage: sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 17.8 µs per loop
```


With the patch:

```
sage: x,y=34912364,123324234
sage: sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 421 ns per loop
sage: R.<t>=PolynomialRing(GF(3),implementation="NTL")
sage: x,y=t^2-1,t-1
sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 32.7 µs per loop
sage: x,y=234/234525,4324525/12351
sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 11.5 µs per loop
sage: R.<t> = PolynomialRing(ZZ,implementation="NTL")
sage: x,y=t^2-1,t-1
sage: sage: timeit('x.gcd(y)')
625 loops, best of 3: 17.3 µs per loop
```


Let's see what the patchbot thinks about it…



---

archive/issue_comments_162487.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-11-15T14:50:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162487",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_162488.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-11-18T20:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162488",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_162489.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-11-18T21:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162489",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_162490.json:
```json
{
    "body": "Attachment [trac_13441.patch](tarball://root/attachments/some-uuid/ticket13441/trac_13441.patch) by @saraedum created at 2012-11-18 21:15:58",
    "created_at": "2012-11-18T21:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162490",
    "user": "https://github.com/saraedum"
}
```

Attachment [trac_13441.patch](tarball://root/attachments/some-uuid/ticket13441/trac_13441.patch) by @saraedum created at 2012-11-18 21:15:58



---

archive/issue_comments_162491.json:
```json
{
    "body": "The patchbot reported some problems with rational numbers. These should be fixed now.",
    "created_at": "2012-11-18T21:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162491",
    "user": "https://github.com/saraedum"
}
```

The patchbot reported some problems with rational numbers. These should be fixed now.



---

archive/issue_comments_162492.json:
```json
{
    "body": "Minor issue: the `INPUT:` bullets are indented one to many times (they should be level with the triple quotes and `INPUT:`). Thanks.",
    "created_at": "2012-11-25T08:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162492",
    "user": "https://github.com/tscrim"
}
```

Minor issue: the `INPUT:` bullets are indented one to many times (they should be level with the triple quotes and `INPUT:`). Thanks.



---

archive/issue_comments_162493.json:
```json
{
    "body": "A question: is there a good technical reason to make `gcd()` a method of `EuclideanDomains.ElementMethods` instead of `EuclideanDomainElement`?  To me it seems conceptually preferable to keep it a method of `EuclideanDomainElement`.\n\nTo be honest, I don't really see the (mathematical) point of having a category of Euclidean domains, at least not in its current form.  There would presumably need to be some condition requiring the \"quotient and remainder\" function to be compatible with morphisms in this category, and even then I wonder how useful it would be.  Again, maybe there is a good technical reason to have such a category?",
    "created_at": "2013-08-13T19:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162493",
    "user": "https://github.com/pjbruin"
}
```

A question: is there a good technical reason to make `gcd()` a method of `EuclideanDomains.ElementMethods` instead of `EuclideanDomainElement`?  To me it seems conceptually preferable to keep it a method of `EuclideanDomainElement`.

To be honest, I don't really see the (mathematical) point of having a category of Euclidean domains, at least not in its current form.  There would presumably need to be some condition requiring the "quotient and remainder" function to be compatible with morphisms in this category, and even then I wonder how useful it would be.  Again, maybe there is a good technical reason to have such a category?



---

archive/issue_comments_162494.json:
```json
{
    "body": "IMHO this is precisely what the category framework is about. We aren't talking about mathematical categories, but at non-inheritance framework to ensure consistency. There isn't much use in a stand-alone EuclideanDomains category, but it is definitely useful as a subcategory that you can slap on whenever you have a euclidean domain.\n\nAlas, the patch does not apply to Sage 6. Please rebase.",
    "created_at": "2013-12-23T13:22:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162494",
    "user": "https://github.com/vbraun"
}
```

IMHO this is precisely what the category framework is about. We aren't talking about mathematical categories, but at non-inheritance framework to ensure consistency. There isn't much use in a stand-alone EuclideanDomains category, but it is definitely useful as a subcategory that you can slap on whenever you have a euclidean domain.

Alas, the patch does not apply to Sage 6. Please rebase.



---

archive/issue_comments_162495.json:
```json
{
    "body": "rebased and converted to git branch; no other changes\n----\nNew commits:",
    "created_at": "2014-01-27T21:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162495",
    "user": "https://github.com/nilesjohnson"
}
```

rebased and converted to git branch; no other changes
----
New commits:



---

archive/issue_comments_162496.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-01-30T16:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162496",
    "user": "https://github.com/tscrim"
}
```

New commits:



---

archive/issue_comments_162497.json:
```json
{
    "body": "I made some review tweaks to the documentation (and it's now based off `develop`), so if you're happy with my changes, then go ahead and set this to positive review.",
    "created_at": "2014-01-30T16:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162497",
    "user": "https://github.com/tscrim"
}
```

I made some review tweaks to the documentation (and it's now based off `develop`), so if you're happy with my changes, then go ahead and set this to positive review.



---

archive/issue_comments_162498.json:
```json
{
    "body": "Replying to [comment:25 tscrim]:\n> I made some review tweaks to the documentation (and it's now based off `develop`)\n\nthanks!  \n\n> if you're happy with my changes, then go ahead and set this to positive review.\n\nI haven't reviewed this patch, just converted it to a git branch so I can work with it.  I can see that it seems to work, and that the documentation builds correctly and looks good.  But I haven't looked more closely at it; in particular I haven't verified the timing results.  I do give a positive review to your changes -- are you giving positive review to the earlier parts of the patch/branch?",
    "created_at": "2014-01-30T18:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162498",
    "user": "https://github.com/nilesjohnson"
}
```

Replying to [comment:25 tscrim]:
> I made some review tweaks to the documentation (and it's now based off `develop`)

thanks!  

> if you're happy with my changes, then go ahead and set this to positive review.

I haven't reviewed this patch, just converted it to a git branch so I can work with it.  I can see that it seems to work, and that the documentation builds correctly and looks good.  But I haven't looked more closely at it; in particular I haven't verified the timing results.  I do give a positive review to your changes -- are you giving positive review to the earlier parts of the patch/branch?



---

archive/issue_comments_162499.json:
```json
{
    "body": "I double-checked and I am getting the same times (up to noise), so then it's positive review all around.",
    "created_at": "2014-01-30T20:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162499",
    "user": "https://github.com/tscrim"
}
```

I double-checked and I am getting the same times (up to noise), so then it's positive review all around.



---

archive/issue_comments_162500.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-01-30T20:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162500",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162501.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-02T20:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13269#issuecomment-162501",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
