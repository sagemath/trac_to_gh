# Issue 27409: totallyreal_rel.py call to polredabs

Issue created by migration from https://trac.sagemath.org/ticket/27646

Original creator: jvoight

Original creation time: 2019-04-11 15:18:47

CC:  benjamin.linowitz@oberlin.edu

Keywords: pari, totallyreal, number fields

Reported by Ben Linowitz.  

I think something changed in pari's polredabs, and it is breaking the enumeration of totally real fields.
  
Running

```
enumerate_totallyreal_fields_all(6,10^6)
```

throws an error:

```
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-2-a56c359e898e> in <module>()
----> 1 enumerate_totallyreal_fields_all(Integer(6),Integer(10)**Integer(6),verbose=True)

/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)()
    352             True
    353         """
--> 354         return self.get_object()(*args, **kwds)
    355 
    356     def __repr__(self):

/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal_rel.py in enumerate_totallyreal_fields_all(n, B, verbose, return_seqs, return_pari_objects)
    963                     print("Taking F =", Sds[i][1])
    964                 F = NumberField(ZZx(Sds[i][1]), 't')
--> 965                 T = enumerate_totallyreal_fields_rel(F, n/d, B, verbose=verbose, return_seqs=return_seqs)
    966                 if return_seqs:
    967                     for i in range(4):

/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal_rel.py in enumerate_totallyreal_fields_rel(F, m, B, a, verbose, return_seqs, return_pari_objects)
    794                         # Find a minimal lattice element
    795                         counts[3] += 1
--> 796                         ng = pari([nf,zk]).polredabs()
    797 
    798                         # Check if K is contained in the list.

cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.polredabs()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()

PariError: incorrect type in nfbasic_init (t_VEC)
```


The totallyreal code hasn't changed in years, so is this a typing issue in pari?  What is strange is that it runs agreeably in other cases.  

Is it possibly related to the closed issue #27267?  It's precisely the same line in the code.


---

Comment by jdemeyer created at 2019-04-12 07:23:32

Replying to [ticket:27646 jvoight]:
> Is it possibly related to the closed issue #27267?  It's precisely the same line in the code.

I think it's the same code by accident. The error looks unrelated.


---

Comment by jdemeyer created at 2019-04-12 12:02:53

Changing component from interfaces to packages: standard.


---

Comment by slelievre created at 2019-04-13 23:16:36

Could be worth checking whether this still occurs with the branch at #27605.


---

Comment by jdemeyer created at 2019-04-14 08:29:53

I already checked but it's really unrelated to the trashcan. It just happens by pure coincidence that the same line of code is affected.


---

Comment by jvoight created at 2019-04-14 14:16:13

Thank you very much!  OK, this code to enumerate totally real fields only constructs monic polynomials--and the code used to run just fine--which means something else changed.  One basic worry is that the coercion from vectors to polynomials is done in a different order, or something else is wrong...


---

Comment by jvoight created at 2019-04-14 14:41:06

I think the issue is in line 778 of rings/number_field/totallyreal_rel.py: it computes a polynomial resultant (to go from the relative field to the absolute field), in this case the resultant of `x^2 + (t - 1)*x - 1 ` and ` t^3 - t^2 - 2*t + 1` with respect to `t`, which gives as output `-x^6 + 2*x^5 + 4*x^4 - 5*x^3 - 4*x^2 + 2*x + 1` which is not monic and therefore makes pari's `nfbasis` unhappy.  By construction, the polynomials entering into `polresultant` are monic (and integral), so the output should be monic up to sign.  I understand there are certain conventions with respect to resultants, so the best thing would be to add something in between lines 778 and 779 like

```
if nf[n] == -1:
    nf *= -1
```



---

Comment by chapoton created at 2019-05-01 15:33:53

New commits:


---

Comment by chapoton created at 2019-05-01 15:33:53

Changing status from new to needs_review.


---

Comment by jvoight created at 2019-05-02 01:12:10

Thanks!  

There were too many changes for me to review this quickly--looks like it was changes in spacing and formatting, so I'm not sure where the content was changed.  

I did confirm that the fix I suggested in line 778 is there, but I didn't test all of the changes.


---

Comment by chapoton created at 2019-05-02 06:49:28

Yes, sorry for this "formatting noise", I just could not resist fixing that.

The only serious change is

```
-        nf = nf.polresultant(nfF, parit)
+        nf = nf.polresultant(nfF, parit)  # either monic or -monic
+        if nf[n] == -1:
+            nf *= -1
```



---

Comment by chapoton created at 2019-05-02 06:50:34

One should add a doctest, but if possible a short-time one, not the original bug which seems to take many seconds.


---

Comment by chapoton created at 2019-05-02 19:09:07

possible smaller doctest:

```
sage: enumerate_totallyreal_fields_all(6,435000)
```

failing before the ticket just as the original doctest


---

Comment by jdemeyer created at 2019-05-03 08:02:21

OK, please add that doctest then.


---

Comment by jdemeyer created at 2019-05-03 08:02:21

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-05-03 09:08:17

Well, still takes 5 seconds, which is a lot...

```
File "src/sage/rings/number_field/totallyreal_rel.py", line 77, in sage.rings.number_field.totallyreal_rel
Warning, slow doctest:
    L = enumerate_totallyreal_fields_all(6,435000) # long time
Test ran for 4.90 s
```



---

Comment by jdemeyer created at 2019-05-03 09:11:38

It's OK for a `# long time` test.


---

Comment by git created at 2019-05-03 09:13:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-05-03 09:14:47

ok, doctest added and tagged


---

Comment by chapoton created at 2019-05-24 10:02:20

review, someone ?


---

Comment by jvoight created at 2019-05-24 21:37:14

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-05-25 09:45:23

The reviewer name is missing


---

Comment by vbraun created at 2019-05-25 09:45:23

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2019-05-25 13:32:07

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-05-28 21:07:52

Resolution: fixed
