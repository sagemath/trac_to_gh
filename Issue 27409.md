# Issue 27409: totallyreal_rel.py call to polredabs

archive/issues_027409.json:
```json
{
    "body": "CC:  benjamin.linowitz@oberlin.edu\n\nKeywords: pari, totallyreal, number fields\n\nReported by Ben Linowitz.  \n\nI think something changed in pari's polredabs, and it is breaking the enumeration of totally real fields.\n  \nRunning\n\n```\nenumerate_totallyreal_fields_all(6,10^6)\n```\n\nthrows an error:\n\n```\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n<ipython-input-2-a56c359e898e> in <module>()\n----> 1 enumerate_totallyreal_fields_all(Integer(6),Integer(10)**Integer(6),verbose=True)\n\n/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)()\n    352             True\n    353         \"\"\"\n--> 354         return self.get_object()(*args, **kwds)\n    355 \n    356     def __repr__(self):\n\n/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal_rel.py in enumerate_totallyreal_fields_all(n, B, verbose, return_seqs, return_pari_objects)\n    963                     print(\"Taking F =\", Sds[i][1])\n    964                 F = NumberField(ZZx(Sds[i][1]), 't')\n--> 965                 T = enumerate_totallyreal_fields_rel(F, n/d, B, verbose=verbose, return_seqs=return_seqs)\n    966                 if return_seqs:\n    967                     for i in range(4):\n\n/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal_rel.py in enumerate_totallyreal_fields_rel(F, m, B, a, verbose, return_seqs, return_pari_objects)\n    794                         # Find a minimal lattice element\n    795                         counts[3] += 1\n--> 796                         ng = pari([nf,zk]).polredabs()\n    797 \n    798                         # Check if K is contained in the list.\n\ncypari2/auto_gen.pxi in cypari2.gen.Gen_auto.polredabs()\n\ncypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()\n\nPariError: incorrect type in nfbasic_init (t_VEC)\n```\n\n\nThe totallyreal code hasn't changed in years, so is this a typing issue in pari?  What is strange is that it runs agreeably in other cases.  \n\nIs it possibly related to the closed issue #27267?  It's precisely the same line in the code.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27646\n\n",
    "created_at": "2019-04-11T15:18:47Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "totallyreal_rel.py call to polredabs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27409",
    "user": "https://github.com/jvoight"
}
```
CC:  benjamin.linowitz@oberlin.edu

Keywords: pari, totallyreal, number fields

Reported by Ben Linowitz.  

I think something changed in pari's polredabs, and it is breaking the enumeration of totally real fields.
  
Running

```
enumerate_totallyreal_fields_all(6,10^6)
```

throws an error:

```
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-2-a56c359e898e> in <module>()
----> 1 enumerate_totallyreal_fields_all(Integer(6),Integer(10)**Integer(6),verbose=True)

/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)()
    352             True
    353         """
--> 354         return self.get_object()(*args, **kwds)
    355 
    356     def __repr__(self):

/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal_rel.py in enumerate_totallyreal_fields_all(n, B, verbose, return_seqs, return_pari_objects)
    963                     print("Taking F =", Sds[i][1])
    964                 F = NumberField(ZZx(Sds[i][1]), 't')
--> 965                 T = enumerate_totallyreal_fields_rel(F, n/d, B, verbose=verbose, return_seqs=return_seqs)
    966                 if return_seqs:
    967                     for i in range(4):

/home/jvoight/sage-8.2/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal_rel.py in enumerate_totallyreal_fields_rel(F, m, B, a, verbose, return_seqs, return_pari_objects)
    794                         # Find a minimal lattice element
    795                         counts[3] += 1
--> 796                         ng = pari([nf,zk]).polredabs()
    797 
    798                         # Check if K is contained in the list.

cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.polredabs()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()

PariError: incorrect type in nfbasic_init (t_VEC)
```


The totallyreal code hasn't changed in years, so is this a typing issue in pari?  What is strange is that it runs agreeably in other cases.  

Is it possibly related to the closed issue #27267?  It's precisely the same line in the code.

Issue created by migration from https://trac.sagemath.org/ticket/27646





---

archive/issue_comments_386005.json:
```json
{
    "body": "Replying to [ticket:27646 jvoight]:\n> Is it possibly related to the closed issue #27267?  It's precisely the same line in the code.\n\nI think it's the same code by accident. The error looks unrelated.",
    "created_at": "2019-04-12T07:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386005",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:27646 jvoight]:
> Is it possibly related to the closed issue #27267?  It's precisely the same line in the code.

I think it's the same code by accident. The error looks unrelated.



---

archive/issue_comments_386006.json:
```json
{
    "body": "Changing component from interfaces to packages: standard.",
    "created_at": "2019-04-12T12:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386006",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from interfaces to packages: standard.



---

archive/issue_comments_386007.json:
```json
{
    "body": "Could be worth checking whether this still occurs with the branch at #27605.",
    "created_at": "2019-04-13T23:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386007",
    "user": "https://github.com/slel"
}
```

Could be worth checking whether this still occurs with the branch at #27605.



---

archive/issue_comments_386008.json:
```json
{
    "body": "I already checked but it's really unrelated to the trashcan. It just happens by pure coincidence that the same line of code is affected.",
    "created_at": "2019-04-14T08:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386008",
    "user": "https://github.com/jdemeyer"
}
```

I already checked but it's really unrelated to the trashcan. It just happens by pure coincidence that the same line of code is affected.



---

archive/issue_comments_386009.json:
```json
{
    "body": "Thank you very much!  OK, this code to enumerate totally real fields only constructs monic polynomials--and the code used to run just fine--which means something else changed.  One basic worry is that the coercion from vectors to polynomials is done in a different order, or something else is wrong...",
    "created_at": "2019-04-14T14:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386009",
    "user": "https://github.com/jvoight"
}
```

Thank you very much!  OK, this code to enumerate totally real fields only constructs monic polynomials--and the code used to run just fine--which means something else changed.  One basic worry is that the coercion from vectors to polynomials is done in a different order, or something else is wrong...



---

archive/issue_comments_386010.json:
```json
{
    "body": "I think the issue is in line 778 of rings/number_field/totallyreal_rel.py: it computes a polynomial resultant (to go from the relative field to the absolute field), in this case the resultant of `x^2 + (t - 1)*x - 1 ` and ` t^3 - t^2 - 2*t + 1` with respect to `t`, which gives as output `-x^6 + 2*x^5 + 4*x^4 - 5*x^3 - 4*x^2 + 2*x + 1` which is not monic and therefore makes pari's `nfbasis` unhappy.  By construction, the polynomials entering into `polresultant` are monic (and integral), so the output should be monic up to sign.  I understand there are certain conventions with respect to resultants, so the best thing would be to add something in between lines 778 and 779 like\n\n```\nif nf[n] == -1:\n    nf *= -1\n```\n",
    "created_at": "2019-04-14T14:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386010",
    "user": "https://github.com/jvoight"
}
```

I think the issue is in line 778 of rings/number_field/totallyreal_rel.py: it computes a polynomial resultant (to go from the relative field to the absolute field), in this case the resultant of `x^2 + (t - 1)*x - 1 ` and ` t^3 - t^2 - 2*t + 1` with respect to `t`, which gives as output `-x^6 + 2*x^5 + 4*x^4 - 5*x^3 - 4*x^2 + 2*x + 1` which is not monic and therefore makes pari's `nfbasis` unhappy.  By construction, the polynomials entering into `polresultant` are monic (and integral), so the output should be monic up to sign.  I understand there are certain conventions with respect to resultants, so the best thing would be to add something in between lines 778 and 779 like

```
if nf[n] == -1:
    nf *= -1
```




---

archive/issue_comments_386011.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-05-01T15:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386011",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_386012.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-01T15:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386012",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386013.json:
```json
{
    "body": "Thanks!  \n\nThere were too many changes for me to review this quickly--looks like it was changes in spacing and formatting, so I'm not sure where the content was changed.  \n\nI did confirm that the fix I suggested in line 778 is there, but I didn't test all of the changes.",
    "created_at": "2019-05-02T01:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386013",
    "user": "https://github.com/jvoight"
}
```

Thanks!  

There were too many changes for me to review this quickly--looks like it was changes in spacing and formatting, so I'm not sure where the content was changed.  

I did confirm that the fix I suggested in line 778 is there, but I didn't test all of the changes.



---

archive/issue_comments_386014.json:
```json
{
    "body": "Yes, sorry for this \"formatting noise\", I just could not resist fixing that.\n\nThe only serious change is\n\n```\n-        nf = nf.polresultant(nfF, parit)\n+        nf = nf.polresultant(nfF, parit)  # either monic or -monic\n+        if nf[n] == -1:\n+            nf *= -1\n```\n",
    "created_at": "2019-05-02T06:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386014",
    "user": "https://github.com/fchapoton"
}
```

Yes, sorry for this "formatting noise", I just could not resist fixing that.

The only serious change is

```
-        nf = nf.polresultant(nfF, parit)
+        nf = nf.polresultant(nfF, parit)  # either monic or -monic
+        if nf[n] == -1:
+            nf *= -1
```




---

archive/issue_comments_386015.json:
```json
{
    "body": "One should add a doctest, but if possible a short-time one, not the original bug which seems to take many seconds.",
    "created_at": "2019-05-02T06:50:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386015",
    "user": "https://github.com/fchapoton"
}
```

One should add a doctest, but if possible a short-time one, not the original bug which seems to take many seconds.



---

archive/issue_comments_386016.json:
```json
{
    "body": "possible smaller doctest:\n\n```\nsage: enumerate_totallyreal_fields_all(6,435000)\n```\n\nfailing before the ticket just as the original doctest",
    "created_at": "2019-05-02T19:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386016",
    "user": "https://github.com/fchapoton"
}
```

possible smaller doctest:

```
sage: enumerate_totallyreal_fields_all(6,435000)
```

failing before the ticket just as the original doctest



---

archive/issue_comments_386017.json:
```json
{
    "body": "OK, please add that doctest then.",
    "created_at": "2019-05-03T08:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386017",
    "user": "https://github.com/jdemeyer"
}
```

OK, please add that doctest then.



---

archive/issue_comments_386018.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-03T08:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386018",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_386019.json:
```json
{
    "body": "Well, still takes 5 seconds, which is a lot...\n\n```\nFile \"src/sage/rings/number_field/totallyreal_rel.py\", line 77, in sage.rings.number_field.totallyreal_rel\nWarning, slow doctest:\n    L = enumerate_totallyreal_fields_all(6,435000) # long time\nTest ran for 4.90 s\n```\n",
    "created_at": "2019-05-03T09:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386019",
    "user": "https://github.com/fchapoton"
}
```

Well, still takes 5 seconds, which is a lot...

```
File "src/sage/rings/number_field/totallyreal_rel.py", line 77, in sage.rings.number_field.totallyreal_rel
Warning, slow doctest:
    L = enumerate_totallyreal_fields_all(6,435000) # long time
Test ran for 4.90 s
```




---

archive/issue_comments_386020.json:
```json
{
    "body": "It's OK for a `# long time` test.",
    "created_at": "2019-05-03T09:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386020",
    "user": "https://github.com/jdemeyer"
}
```

It's OK for a `# long time` test.



---

archive/issue_comments_386021.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-03T09:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386021",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386022.json:
```json
{
    "body": "ok, doctest added and tagged",
    "created_at": "2019-05-03T09:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386022",
    "user": "https://github.com/fchapoton"
}
```

ok, doctest added and tagged



---

archive/issue_comments_386023.json:
```json
{
    "body": "review, someone ?",
    "created_at": "2019-05-24T10:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386023",
    "user": "https://github.com/fchapoton"
}
```

review, someone ?



---

archive/issue_comments_386024.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-05-24T21:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386024",
    "user": "https://github.com/jvoight"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_386025.json:
```json
{
    "body": "The reviewer name is missing",
    "created_at": "2019-05-25T09:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386025",
    "user": "https://github.com/vbraun"
}
```

The reviewer name is missing



---

archive/issue_comments_386026.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-05-25T09:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386026",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_386027.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-05-25T13:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386027",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_386028.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-28T21:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27409#issuecomment-386028",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_068605.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-28T21:07:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27409",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27409#event-68605"
}
```
