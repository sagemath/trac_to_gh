# Issue 14104: strange debug output

Issue created by migration from Trac.

Original creator: zimmerma

Original creation time: 2013-03-19 09:41:58

Assignee: burcin

with Sage 5.7 I get:

```
sage: a, q, k = var('a, q, k'); assume(q > 1)                            
sage: try:
....:     sum(a*q^k, k, 0, infinity)
....: except ValueError:
....:     0
....:     
#0: simplify_sum(expr='sum(q^k,k,0,inf))
#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))
0
```

Why do I get the `#0` and `#1` lines?

Paul

PS: this is one of the examples of our book (in french) about Sage at
http://sagebook.gforge.inria.fr/, and it makes our doctests fail.


---

Comment by kcrisman created at 2013-03-19 13:32:53

I get those sometimes too, but I don't recall them making doctests fail...  It's some kind of verbose Maxima thing.


---

Comment by kcrisman created at 2014-11-17 17:29:55

Changing assignee from burcin to was.


---

Comment by kcrisman created at 2014-11-17 17:29:55

Changing component from calculus to interfaces.


---

Comment by nbruin created at 2014-11-18 06:14:11

This is just what maxima does. It prints a bit of a stack backtrace:

```
(%i1) t(a):= if a = 0 then 1/0 else t(a-1);
                                           1
(%o1)                t(a) := if a = 0 then - else t(a - 1)
                                           0
(%i2) t(10);

expt: undefined: 0 to a negative exponent.
#0: t(a=0)(stdin line 0)
#1: t(a=1)(stdin line 0)
#2: t(a=2)(stdin line 0)
 -- an error. To debug this try: debugmode(true);
```

Apparently we're not turning this off.


---

Comment by nbruin created at 2014-11-18 07:46:20

Changing status from new to needs_review.


---

Comment by nbruin created at 2014-11-18 07:46:20

Thanks! that error finally make me find the better routine in maxima to execute maxima code while getting lisp errors rather than maxima's own funny throw/catch signalling. This simplifies code considerably.

for reference: the printing of 3 lines of traceback is hardcoded in `merror` (in the file `merror.lisp`), just prior to throwing the `macsyma-quit`. Previously we were just catching that throw, but the traceback would already have been printed. Instead, by using `with-$error` we make sure we end up in a different branch (by setting `errcatch` to T), which ensures `merror` will just raise the appropriate error.
----
New commits:


---

Comment by zimmerma created at 2014-11-18 08:03:50

> that error finally make me find the better routine in maxima to execute maxima code [...]

great!

Paul


---

Comment by kcrisman created at 2014-11-18 14:59:14

> > that error finally make me find the better routine in maxima to execute maxima code [...]
> 
> great!

Indeed!  Took me a while to figure out what was going on there but I agree this is probably better than printing the backtrace (though see [here](http://comments.gmane.org/gmane.comp.mathematics.maxima.general/40253) for some other discussion; we could have just commented that out in a patch).  The only downside is that it now talks only about ECL and not Maxima, which may be confusing for some folks.  What do you think?  Otherwise this is fine, modulo doctests...

```

sage -t src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 9388, in sage.symbolic.expression.Expression.solve
Failed example:
    solve(acot(x),x)
    TypeError: ECL says: cot: argument 0 isn't in the domain of cot.

**********************************************************************
File "src/sage/symbolic/expression.pyx", line 9393, in sage.symbolic.expression.Expression.solve
Failed example:
    solve(acot(x),x,to_poly_solve=True)
    TypeError: ECL says: cot: argument 0 isn't in the domain of cot.

**********************************************************************
1 item had failures:
```

This comes from

```

        TESTS:

        :trac:`7325` (solving inequalities)::

            sage: (x^2>1).solve(x)
            [[x < -1], [x > 1]]

        Catch error message from Maxima::

            sage: solve(acot(x),x)
            []

        ::

            sage: solve(acot(x),x,to_poly_solve=True)
            []
```

Amazingly, I personally am responsible for the [code](http://trac.sagemath.org/attachment/ticket/7745/trac_7745-upgrade-maxima.patch) that catches this.   Now that we have the lib etc., what do you think?  I think it's still okay that we catch an error in solve and just return that we can't do it, but in retrospect the way I did it was just enough to get by.


---

Comment by zimmerma created at 2014-11-18 15:06:57

my opinion is that it is better to get rid of those debug lines from Maxima,
that couldn't be caught at all before. Thanks.

Paul


---

Comment by nbruin created at 2014-11-18 17:12:33

Replying to [comment:11 kcrisman]:
> > > that error finally make me find the better routine in maxima to execute maxima code [...]
> > 
> > great!
> 
> The only downside is that it now talks only about ECL and not Maxima, which may be confusing for some folks.  What do you think?

I'm not so keen on the ECL says -- Maxima says bit. It makes debugging feel like marriage counselling. I only put that in when I was writing the error catching and I wanted to confirm which code was catching/producing the errors. We can of course regain this behaviour quite easily without patching merror or writing the horrible shim we had before. If errcatch is true then merror raises a very clearly marked condition (CL for exception) so we could just catch that and raise another error with the "Maxima says" thrown in. I'd rather stick to what maxima offers already, though.

> Amazingly, I personally am responsible for the [code](http://trac.sagemath.org/attachment/ticket/7745/trac_7745-upgrade-maxima.patch) that catches this.   Now that we have the lib etc., what do you think?  I think it's still okay that we catch an error in solve and just return that we can't do it, but in retrospect the way I did it was just enough to get by.

I would normally think it's not a good idea to catch that error so broadly -- you really only know *something* went wrong (and having Maxima in the error message hardly improves that -- Checking the "ECL" is hardly more generic). On the other hand, it's in solve. Those answers aren't trustworthy if there's no error either.


---

Comment by kcrisman created at 2014-11-18 17:36:03

> On the other hand, it's in solve. Those answers aren't trustworthy if there's no error either.
In this particular case, I guess we noticed that 

```
cot: argument 0 isn't in the domain of cot.
```

which is true, and so solve should give the empty solution.  Would it be fairly easy to change that solve code to catch this type of wording `argument 0 isn't in the domain` in which case presumably no solution _is_ correct?  Though...

```
(%i6) solve(x*acot(x),x);

cot: argument 0 isn't in the domain of cot.
(%i7) acot(0)
;
                                      %pi
(%o7)                                 ---
                                       2
```

which is not ideal.  I opened https://sourceforge.net/p/maxima/bugs/2844/ for this.

Anyway, one way or another that doctest failure needs to be dealt with, and so much the better if it improves the solve code.


---

Comment by kcrisman created at 2014-12-03 15:05:51

Anyway, one way or another we need to decide what to do with these doctests.


---

Comment by kcrisman created at 2014-12-03 15:05:51

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2022-10-10 12:28:15

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2022-10-10 12:28:15

trying again
----
New commits:


---

Comment by git created at 2022-10-10 13:30:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-11 08:56:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by zimmerma created at 2022-10-12 06:44:17

I get several doctesting failures when applying this patch to master, but they look unrelated:

```
Features detected for doctesting: 4ti2,gfan,graphviz,imagemagick,nauty,palp,pandoc,pdftocairo,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.misc.cython,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sagemath_doc_html,sphinx
pytest is not installed in the venv, skip checking tests that rely on it
```

Thus this seems ok for me.


---

Comment by zimmerma created at 2022-10-12 06:44:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-10-17 22:43:42

Resolution: fixed
