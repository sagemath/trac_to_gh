# Issue 26082: py3: patch six.add_metaclass to preserve wrapped class's __qualname__

archive/issues_026082.json:
```json
{
    "body": "CC:  chapoton\n\nThe current version of `six.add_metaclass` does not preserve the original class's `__qualname__` attribute (as it is not normally stored in the class's `__dict__`):\n\n\n\n```python\n>>> from six import add_metaclass\n>>> class A:\n...     class B:\n...         pass\n...\n>>> A.B\n<class '__main__.A.B'>\n>>> class MyMeta(type): pass\n...\n>>> class A:\n...     @add_metaclass(MyMeta)\n...     class B:\n...         pass\n...\n>>> A.B\n<class '__main__.B'>\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26319\n\n",
    "created_at": "2018-09-20T10:42:09Z",
    "labels": [
        "python3",
        "minor",
        "bug"
    ],
    "title": "py3: patch six.add_metaclass to preserve wrapped class's __qualname__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26082",
    "user": "embray"
}
```
CC:  chapoton

The current version of `six.add_metaclass` does not preserve the original class's `__qualname__` attribute (as it is not normally stored in the class's `__dict__`):



```python
>>> from six import add_metaclass
>>> class A:
...     class B:
...         pass
...
>>> A.B
<class '__main__.A.B'>
>>> class MyMeta(type): pass
...
>>> class A:
...     @add_metaclass(MyMeta)
...     class B:
...         pass
...
>>> A.B
<class '__main__.B'>
```


Issue created by migration from https://trac.sagemath.org/ticket/26319





---

archive/issue_comments_367808.json:
```json
{
    "body": "Here I just monkey-patch `six.add_metaclass` at Sage import time.  This shouldn't be a problem, and allows us to avoid updating every existing import of `six.add_metaclass`.\n\nI'm happy to update the imports instead of monkey-patch, but that carries with it the danger that if someone doesn't know to use `sage.misc.six.add_metaclass` they could repeat this mistake.\n\nAlternatively, we replace *all* imports of `six` with `sage.misc.six` and use only the latter.  That will require a bit of fancy-footwork to make `six.moves` work but it's doable.\n----\nNew commits:",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367808",
    "user": "embray"
}
```

Here I just monkey-patch `six.add_metaclass` at Sage import time.  This shouldn't be a problem, and allows us to avoid updating every existing import of `six.add_metaclass`.

I'm happy to update the imports instead of monkey-patch, but that carries with it the danger that if someone doesn't know to use `sage.misc.six.add_metaclass` they could repeat this mistake.

Alternatively, we replace *all* imports of `six` with `sage.misc.six` and use only the latter.  That will require a bit of fancy-footwork to make `six.moves` work but it's doable.
----
New commits:



---

archive/issue_comments_367809.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367809",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367810.json:
```json
{
    "body": "Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367810",
    "user": "embray"
}
```

Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_367811.json:
```json
{
    "body": "I almost forgot about this ticket, but I believe it will still fix some tests on Python 3.",
    "created_at": "2019-01-09T18:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367811",
    "user": "embray"
}
```

I almost forgot about this ticket, but I believe it will still fix some tests on Python 3.



---

archive/issue_comments_367812.json:
```json
{
    "body": "This is fixed by six 1.12.0, upgrade at #26969.",
    "created_at": "2019-01-10T10:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367812",
    "user": "jdemeyer"
}
```

This is fixed by six 1.12.0, upgrade at #26969.



---

archive/issue_comments_367813.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-01-10T10:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367813",
    "user": "jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_comments_367814.json:
```json
{
    "body": "There still seem to be some test failures on Python 3 related to this, but I can confirm that six 1.12.0 at least contains the basic fix for nested classes with add_metaclass.",
    "created_at": "2019-01-10T14:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367814",
    "user": "embray"
}
```

There still seem to be some test failures on Python 3 related to this, but I can confirm that six 1.12.0 at least contains the basic fix for nested classes with add_metaclass.



---

archive/issue_comments_367815.json:
```json
{
    "body": "Note that `six` also has `with_metaclass`. Presumably that needs to be patched too?",
    "created_at": "2019-01-10T14:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367815",
    "user": "jdemeyer"
}
```

Note that `six` also has `with_metaclass`. Presumably that needs to be patched too?



---

archive/issue_comments_367816.json:
```json
{
    "body": "I have a PR to fix two other bugs with `with_metaclass` at https://github.com/benjaminp/six/pull/211 but without feedback from upstream.",
    "created_at": "2019-01-10T14:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26082#issuecomment-367816",
    "user": "jdemeyer"
}
```

I have a PR to fix two other bugs with `with_metaclass` at https://github.com/benjaminp/six/pull/211 but without feedback from upstream.
