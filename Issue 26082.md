# Issue 26082: py3: patch six.add_metaclass to preserve wrapped class's __qualname__

Issue created by migration from https://trac.sagemath.org/ticket/26319

Original creator: embray

Original creation time: 2018-09-20 10:42:09

CC:  chapoton

The current version of `six.add_metaclass` does not preserve the original class's `__qualname__` attribute (as it is not normally stored in the class's `__dict__`):



```python
>>> from six import add_metaclass
>>> class A:
...     class B:
...         pass
...
>>> A.B
<class '__main__.A.B'>
>>> class MyMeta(type): pass
...
>>> class A:
...     @add_metaclass(MyMeta)
...     class B:
...         pass
...
>>> A.B
<class '__main__.B'>
```



---

Comment by embray created at 2018-09-20 10:49:15

Here I just monkey-patch `six.add_metaclass` at Sage import time.  This shouldn't be a problem, and allows us to avoid updating every existing import of `six.add_metaclass`.

I'm happy to update the imports instead of monkey-patch, but that carries with it the danger that if someone doesn't know to use `sage.misc.six.add_metaclass` they could repeat this mistake.

Alternatively, we replace _all_ imports of `six` with `sage.misc.six` and use only the latter.  That will require a bit of fancy-footwork to make `six.moves` work but it's doable.
----
New commits:


---

Comment by embray created at 2018-09-20 10:49:15

Changing status from new to needs_review.


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2019-01-09 18:28:22

I almost forgot about this ticket, but I believe it will still fix some tests on Python 3.


---

Comment by jdemeyer created at 2019-01-10 10:09:30

This is fixed by six 1.12.0, upgrade at #26969.


---

Comment by jdemeyer created at 2019-01-10 10:09:30

Resolution: duplicate


---

Comment by embray created at 2019-01-10 14:12:28

There still seem to be some test failures on Python 3 related to this, but I can confirm that six 1.12.0 at least contains the basic fix for nested classes with add_metaclass.


---

Comment by jdemeyer created at 2019-01-10 14:35:58

Note that `six` also has `with_metaclass`. Presumably that needs to be patched too?


---

Comment by jdemeyer created at 2019-01-10 14:44:40

I have a PR to fix two other bugs with `with_metaclass` at https://github.com/benjaminp/six/pull/211 but without feedback from upstream.
