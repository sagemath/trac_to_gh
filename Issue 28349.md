# Issue 28349: broken solving a linear system over GF(3)

archive/issues_028349.json:
```json
{
    "body": "In Sage 8.5, the following got broken\n\n```\nB=matrix(GF(3), 2,2,[1,0,1,0], sparse=True)\nv=vector(F, [1,1])\nB.solve_right(v)\n```\n\nraises\n\n```\nTypeError: Cannot convert sage.matrix.matrix_modn_sparse.Matrix_modn_sparse to sage.matrix.matrix_integer_sparse.Matrix_integer_sparse\n```\n\n\nas [reported on sage-support](https://groups.google.com/d/msg/sage-support/5o8ZMqZG5cw/Dt-cg25GCwAJ)\n\nThis still works in 8.4, as tested on cocalc, but is broken in later Sage versions\n\nIssue created by migration from https://trac.sagemath.org/ticket/28586\n\n",
    "created_at": "2019-10-10T01:30:01Z",
    "labels": [
        "linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "broken solving a linear system over GF(3)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28349",
    "user": "@dimpase"
}
```
In Sage 8.5, the following got broken

```
B=matrix(GF(3), 2,2,[1,0,1,0], sparse=True)
v=vector(F, [1,1])
B.solve_right(v)
```

raises

```
TypeError: Cannot convert sage.matrix.matrix_modn_sparse.Matrix_modn_sparse to sage.matrix.matrix_integer_sparse.Matrix_integer_sparse
```


as [reported on sage-support](https://groups.google.com/d/msg/sage-support/5o8ZMqZG5cw/Dt-cg25GCwAJ)

This still works in 8.4, as tested on cocalc, but is broken in later Sage versions

Issue created by migration from https://trac.sagemath.org/ticket/28586





---

archive/issue_comments_400343.json:
```json
{
    "body": "Corrected a typo in the sage code.",
    "created_at": "2019-10-10T03:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400343",
    "user": "@DaveWitteMorris"
}
```

Corrected a typo in the sage code.



---

archive/issue_comments_400344.json:
```json
{
    "body": "Ticket [ticket:24544] has a commit called \"fix matrix_modn_sparse\" (and this commit is also mentioned in ticket [ticket:23214]). To a naive observer, it seems that this could be related.",
    "created_at": "2019-10-10T05:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400344",
    "user": "@DaveWitteMorris"
}
```

Ticket [ticket:24544] has a commit called "fix matrix_modn_sparse" (and this commit is also mentioned in ticket [ticket:23214]). To a naive observer, it seems that this could be related.



---

archive/issue_comments_400345.json:
```json
{
    "body": "#24544 got into 8.4, which is still OK (I tested on cocalc).",
    "created_at": "2019-10-10T19:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400345",
    "user": "@dimpase"
}
```

#24544 got into 8.4, which is still OK (I tested on cocalc).



---

archive/issue_comments_400346.json:
```json
{
    "body": "however, #23214 is a prime suspect. Doing git bisect now, I reckon 8.5.beta2 should still be OK.",
    "created_at": "2019-10-10T19:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400346",
    "user": "@dimpase"
}
```

however, #23214 is a prime suspect. Doing git bisect now, I reckon 8.5.beta2 should still be OK.



---

archive/issue_comments_400347.json:
```json
{
    "body": "OK, this got in in Sage 8.5.beta3 (no error in beta2, but the error in beta3).\n\nSo this is most likely #23214.",
    "created_at": "2019-10-10T22:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400347",
    "user": "@dimpase"
}
```

OK, this got in in Sage 8.5.beta3 (no error in beta2, but the error in beta3).

So this is most likely #23214.



---

archive/issue_comments_400348.json:
```json
{
    "body": "The code for solving linear systems in `matrix_modn_sparse` is an exact copy/paste of the one in `matrix_integer_sparse`. Even the tests! This is the reason why it is a complete (untested) failure.\n\nTo make it works it is some work...\n- write the appropriate declarations for dense modular vectors and the solve interface in `libs/linbox/linbox.pxd`\n- write sage-linbox converters for dense modular vectors in `libs/linbox/conversion.pxd`\n- rewrite the solve interface to linbox in `matrix/matrix_modn_sparse.pyx`",
    "created_at": "2019-10-11T05:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400348",
    "user": "@videlec"
}
```

The code for solving linear systems in `matrix_modn_sparse` is an exact copy/paste of the one in `matrix_integer_sparse`. Even the tests! This is the reason why it is a complete (untested) failure.

To make it works it is some work...
- write the appropriate declarations for dense modular vectors and the solve interface in `libs/linbox/linbox.pxd`
- write sage-linbox converters for dense modular vectors in `libs/linbox/conversion.pxd`
- rewrite the solve interface to linbox in `matrix/matrix_modn_sparse.pyx`



---

archive/issue_comments_400349.json:
```json
{
    "body": "Hmm, what does this have to do with dense matrices/vectors?\nFor dense matrices solving still works, for any A in [True,False]:\n\n```\nsage: B=matrix(GF(3), 2,2,[1,0,1,0], sparse=False)\n....: v=vector(GF(3), [1,1], sparse=A)\n....: B.solve_right(v)\n....: \n....: \n(1, 0)\n```\n\n\n(as well as sparse and dense matrices over non-prime fields)",
    "created_at": "2019-10-11T12:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400349",
    "user": "@dimpase"
}
```

Hmm, what does this have to do with dense matrices/vectors?
For dense matrices solving still works, for any A in [True,False]:

```
sage: B=matrix(GF(3), 2,2,[1,0,1,0], sparse=False)
....: v=vector(GF(3), [1,1], sparse=A)
....: B.solve_right(v)
....: 
....: 
(1, 0)
```


(as well as sparse and dense matrices over non-prime fields)



---

archive/issue_comments_400350.json:
```json
{
    "body": "The dense matrix is the solution to the linear system not the equations. When you solve a linear system you rarely expect a sparse solution. This is why you need an interface to dense vector and matrices.",
    "created_at": "2019-10-11T15:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400350",
    "user": "@videlec"
}
```

The dense matrix is the solution to the linear system not the equations. When you solve a linear system you rarely expect a sparse solution. This is why you need an interface to dense vector and matrices.



---

archive/issue_comments_400351.json:
```json
{
    "body": "so the error happens in conversion of the answer obtained from the backend?",
    "created_at": "2019-10-11T16:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400351",
    "user": "@dimpase"
}
```

so the error happens in conversion of the answer obtained from the backend?



---

archive/issue_comments_400352.json:
```json
{
    "body": "No. Just read [comment:7]. The backend is never called.",
    "created_at": "2019-10-11T17:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400352",
    "user": "@videlec"
}
```

No. Just read [comment:7]. The backend is never called.



---

archive/issue_comments_400353.json:
```json
{
    "body": "Thanks. Do we actually have a specialised backend for solving sparse linear systems over GF(p), p prime?",
    "created_at": "2019-10-11T17:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400353",
    "user": "@dimpase"
}
```

Thanks. Do we actually have a specialised backend for solving sparse linear systems over GF(p), p prime?



---

archive/issue_comments_400354.json:
```json
{
    "body": "linbox does that. Sage used to have a dirty linbox interface in Cython (in Sage) and C++ (directly implemented in linbox) that was rewritten using Cython only (everything in Sage). There is a bunch of tickets about that. The solving of sparse systems over GF(p) was overlooked. That is my fault.",
    "created_at": "2019-10-11T17:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400354",
    "user": "@videlec"
}
```

linbox does that. Sage used to have a dirty linbox interface in Cython (in Sage) and C++ (directly implemented in linbox) that was rewritten using Cython only (everything in Sage). There is a bunch of tickets about that. The solving of sparse systems over GF(p) was overlooked. That is my fault.



---

archive/issue_comments_400355.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400355",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_400356.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28349",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28349#issuecomment-400356",
    "user": "@mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.
