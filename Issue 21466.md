# Issue 21466: Interface PARI precision in bits

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-10-14 11:30:04

CC:  defeo

PARI now stores its precision internally in bits (as opposed to decimal). This ticket adds an interface for the PARI precision in bits. It also removes the `PariInstance._real_precision` attribute.


---

Comment by jdemeyer created at 2016-10-14 14:22:50

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-14 14:22:50

New commits:


---

Comment by defeo created at 2016-10-19 09:59:11

Very interesting, I learned a lot on real precision in PARI.

I'm good with it, but wouldn't the "guide" be best put in `__init__`, so that it would be read by anyone who types `pari?`?


---

Comment by defeo created at 2016-10-19 11:19:24

Or maybe in `__init__.py`, so that `sage.libs.pari?` shows it.


---

Comment by defeo created at 2016-10-19 11:48:26

`set_real_precision()` returns the old precision. `set_real_precision_bits()` doesn't return anything. Couldn't we be more consistent here?


---

Comment by jdemeyer created at 2016-10-19 11:58:09

Replying to [comment:6 defeo]:
> `set_real_precision()` returns the old precision. `set_real_precision_bits()` doesn't return anything. Couldn't we be more consistent here?

I decided to not return the old value in `set_real_precision_bits()` because the PARI call does not return it either. If users really want the old value, they can still call `get_real_precision_bits()`.

I did not change `set_real_precision()` because we cannot do that without a deprecation.


---

Comment by defeo created at 2016-10-19 12:02:36

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 defeo]:
> > `set_real_precision()` returns the old precision. `set_real_precision_bits()` doesn't return anything. Couldn't we be more consistent here?
> 
> I decided to not return the old value in `set_real_precision_bits()` because the PARI call does not return it either. If users really want the old value, they can still call `get_real_precision_bits()`.
> 
> I did not change `set_real_precision()` because we cannot do that without a deprecation.

That was my guess. Let's put the deprecation, then?


---

Comment by jdemeyer created at 2016-10-19 12:08:01

Replying to [comment:8 defeo]:
> That was my guess. Let's put the deprecation, then?

Personally, I wouldn't bother. I don't see the harm in keeping both functions (with a slightly different interface).


---

Comment by defeo created at 2016-10-19 12:11:00

Sure, that's no big deal.

What about the docstrings?


---

Comment by jdemeyer created at 2016-10-19 12:17:27

Replying to [comment:10 defeo]:
> What about the docstrings?

I have to try to see what works. Ideally, I want the documentation easily findable both from the command line as well as when browsing the reference manual.


---

Comment by git created at 2016-10-19 14:41:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-10-21 09:36:42

Changing status from needs_review to positive_review.


---

Comment by defeo created at 2016-10-21 09:36:42

Ok, these fixes to the docs work *a minima*. If needed, we'll have time to rethink the organization of the docs when we externalize.


---

Comment by defeo created at 2016-10-21 09:38:07

Weird, the startup modules plugin is failing. Presumably not related to this?


---

Comment by jdemeyer created at 2016-10-21 09:39:35

The startup modules "failure" is from #20241.


---

Comment by vbraun created at 2016-10-31 02:36:12

On 32 bit 

```
4014sage -t --long src/sage/libs/pari/pari_instance.pyx
4015**********************************************************************
4016File "src/sage/libs/pari/pari_instance.pyx", line 185, in sage.libs.pari.pari_instance
4017Failed example:
4018    pari(1).sin(precision=150).sage()
4019Expected:
4020    0.841470984807896506652502321630298999622563060798371065673
4021Got:
4022    0.84147098480789650665250232163029899962256306080
4023**********************************************************************
4024File "src/sage/libs/pari/pari_instance.pyx", line 187, in sage.libs.pari.pari_instance
4025Failed example:
4026    pari(1).sin(precision=20).sage()
4027Expected:
4028    0.841470984807896507
4029Got:
4030    0.841470985
4031**********************************************************************
40321 item had failures:
4033   2 of  55 in sage.libs.pari.pari_instance
4034    [164 tests, 2 failures, 0.33 s]
```



---

Comment by vbraun created at 2016-10-31 02:36:12

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-10-31 08:04:38

Right, we should only pick precisions which are between 33 and 64 mod 64.


---

Comment by git created at 2016-11-02 11:21:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-11-02 11:21:50

Changing status from needs_work to needs_review.


---

Comment by defeo created at 2016-11-02 13:41:10

Wouldn't it be simpler and clearer to replace 180→192 and 40→64?


---

Comment by jdemeyer created at 2016-11-02 14:22:29

Replying to [comment:20 defeo]:
> Wouldn't it be simpler and clearer to replace 180→192 and 40→64?

That would defeat the whole point of that explanation. I want to explain that precision in PARI is not the same as precision in Sage.


---

Comment by defeo created at 2016-11-02 14:50:31

> That would defeat the whole point of that explanation. I want to explain that precision in PARI is not the same as precision in Sage.

That was my guess, but I think in this case the docstring misses the point: unless he counts the digits by hand, the user won't realize that the output is printed with 192 bits of precision instead of 180. Maybe adding a `parent(_)` to the docstring would help clarify? Something like this:


```
sage: pari(1).sin(precision=180).sage()
0.841470984807896506652502321630298999622563060798371065673
sage: x = pari(1).sin(precision=180)
sage: x
0.841470984807897
sage: x.bitprecision()
192
sage: x.sage()
0.841470984807896506652502321630298999622563060798371065673
sage: parent(_)
Real Field with 192 bits of precision
```


And maybe line 169 should print with 180 bits, to highlight the difference.

Also, in lines 182-183, when you write "real precision", there is confusion btw real as in reality and real as in real number (frankly, after re-reading for the 10th time that sentence, I'm not sure I understand it).


---

Comment by defeo created at 2016-11-02 14:52:57

Continuing the previous example, I'm confused by this:


```
sage: x = pari(1).sin(precision=180)
sage: x.precision()
5
```


what's the unit used by PARI?


---

Comment by jdemeyer created at 2016-11-02 18:17:15

Replying to [comment:22 defeo]:
> Also, in lines 182-183, when you write "real precision", there is confusion btw real as in reality and real as in real number (frankly, after re-reading for the 10th time that sentence, I'm not sure I understand it).

PARI uses the term "real precision" to mean precision of real numbers. I use it the same way.


---

Comment by jdemeyer created at 2016-11-02 18:23:03

Replying to [comment:23 defeo]:
> Continuing the previous example, I'm confused by this:
> 
> {{{
> sage: x = pari(1).sin(precision=180)
> sage: x.precision()
> 5
> }}}
> 
> what's the unit used by PARI?

In this case, words (i.e. units of 32 or 64 bits)


---

Comment by git created at 2016-11-02 20:16:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-11-03 00:40:38

Replying to [comment:25 jdemeyer]:
> Replying to [comment:23 defeo]:
> > Continuing the previous example, I'm confused by this:
> > 
> > {{{
> > sage: x = pari(1).sin(precision=180)
> > sage: x.precision()
> > 5
> > }}}
> > 
> > what's the unit used by PARI?
> 
> In this case, words (i.e. units of 32 or 64 bits)

?? 5*32=160. How does that fit with 192 bits of precision?


---

Comment by defeo created at 2016-11-03 00:48:20

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-11-03 07:53:55

Replying to [comment:28 defeo]:
> ?? 5*32=160. How does that fit with 192 bits of precision?

It's actually `(5 - 2) * 64 = 192`:


```
sage: from sage.libs.pari.pari_instance import prec_words_to_bits
....: prec_words_to_bits(5)
192
```



---

Comment by vbraun created at 2016-11-08 23:42:15

Resolution: fixed
