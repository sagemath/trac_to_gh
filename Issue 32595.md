# Issue 32595: cython: Eliminate use of custom patches

archive/issues_032595.json:
```json
{
    "body": "CC:  @orlitzky @kiwifb @antonio-rojas @slel\n\nAs noted in #29665#comment:86, our `cython` spkg uses custom patches:\n- https://github.com/sagemath/sage/tree/develop/build/pkgs/cython/patches\n\nWe should investigate whether they are still necessary.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32832\n\n",
    "created_at": "2021-11-06T17:41:04Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "cython: Eliminate use of custom patches",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32595",
    "user": "@mkoeppe"
}
```
CC:  @orlitzky @kiwifb @antonio-rojas @slel

As noted in #29665#comment:86, our `cython` spkg uses custom patches:
- https://github.com/sagemath/sage/tree/develop/build/pkgs/cython/patches

We should investigate whether they are still necessary.


Issue created by migration from https://trac.sagemath.org/ticket/32832





---

archive/issue_comments_464943.json:
```json
{
    "body": "Cython and cypari have patches that work in tandem to address #27267. Neither is really critical IMO, but the patches are not obsolete. The cython patch is a backport from the forthcoming cython-3.0, so we're using a feature from a future release.",
    "created_at": "2021-11-06T17:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464943",
    "user": "@orlitzky"
}
```

Cython and cypari have patches that work in tandem to address #27267. Neither is really critical IMO, but the patches are not obsolete. The cython patch is a backport from the forthcoming cython-3.0, so we're using a feature from a future release.



---

archive/issue_comments_464944.json:
```json
{
    "body": "I don't include the patch is sage-on-gentoo which lead to the only persistent doctest failure I have these days.\n\n```\nsage -t --long --random-seed=329662680874814688233998931907435318225 /usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx\n**********************************************************************\nFile \"/usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx\", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, ZZ, 2)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/cythonized/sage/cpython/dict_del_by_value.c:2442)\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n**********************************************************************\nFile \"/usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx\", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, QQ, 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[9]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, QQ, Integer(1))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/cythonized/sage/cpython/dict_del_by_value.c:2442)\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n**********************************************************************\n1 item had failures:\n```\n\nI have been waiting for that elusive cython 3.0 release, which would get rid of this, for several years now. What is happening with cython upstream?",
    "created_at": "2021-11-06T18:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464944",
    "user": "@kiwifb"
}
```

I don't include the patch is sage-on-gentoo which lead to the only persistent doctest failure I have these days.

```
sage -t --long --random-seed=329662680874814688233998931907435318225 /usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/cythonized/sage/cpython/dict_del_by_value.c:2442)
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, QQ, 1)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[9]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, QQ, Integer(1))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/cythonized/sage/cpython/dict_del_by_value.c:2442)
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
1 item had failures:
```

I have been waiting for that elusive cython 3.0 release, which would get rid of this, for several years now. What is happening with cython upstream?



---

archive/issue_comments_464945.json:
```json
{
    "body": "I have marked this dependent on the Cython 3.0 ticket #29863",
    "created_at": "2021-11-06T18:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464945",
    "user": "@mkoeppe"
}
```

I have marked this dependent on the Cython 3.0 ticket #29863



---

archive/issue_comments_464946.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> I don't include the patch is sage-on-gentoo which lead to the only persistent doctest failure I have these days.\n\nThat's the other patch, `hash.patch`, also a backport from cython-3.0. It was introduced in #26855 to fix a doctest failure with python3. But if that's all that's affected, we might be able to add `int()` in a few places to avoid the patch until cython-3.0 actually exists.\n\nThe trashcan patch shouldn't really be required per #27267#comment:55",
    "created_at": "2021-11-06T19:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464946",
    "user": "@orlitzky"
}
```

Replying to [comment:2 fbissey]:
> I don't include the patch is sage-on-gentoo which lead to the only persistent doctest failure I have these days.

That's the other patch, `hash.patch`, also a backport from cython-3.0. It was introduced in #26855 to fix a doctest failure with python3. But if that's all that's affected, we might be able to add `int()` in a few places to avoid the patch until cython-3.0 actually exists.

The trashcan patch shouldn't really be required per #27267#comment:55



---

archive/issue_comments_464947.json:
```json
{
    "body": "Never seen any other issues. If there are, they'd need to have new doctests associated to them.",
    "created_at": "2021-11-06T19:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464947",
    "user": "@kiwifb"
}
```

Never seen any other issues. If there are, they'd need to have new doctests associated to them.



---

archive/issue_comments_464948.json:
```json
{
    "body": "Replying to [comment:5 fbissey]:\n> Never seen any other issues. If there are, they'd need to have new doctests associated to them.\n\nThat patch/doctest is also blocking an spkg-configure.m4 for cython, so I'll see what I can do about it and post the branch here.",
    "created_at": "2021-11-06T21:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464948",
    "user": "@orlitzky"
}
```

Replying to [comment:5 fbissey]:
> Never seen any other issues. If there are, they'd need to have new doctests associated to them.

That patch/doctest is also blocking an spkg-configure.m4 for cython, so I'll see what I can do about it and post the branch here.



---

archive/issue_comments_464949.json:
```json
{
    "body": "Removing `hash.patch` was straightforward. Still waiting on ptestlong, but I expect it will pass.\n\nThe remaining `trashcan.patch` causes one main problem: when introducing `spkg-configure.m4` for python packages, we will need a patched cython if we're going to install the patched cypari SPKG. That isn't easy to detect, and the logic is backwards from the usual \"are my dependencies installed as SPKGs?\" check. We can hack something together for sure, but it will be a little ugly until cython-3.0 is released if we decide to keep the patch.\n\nFrom #27267 I gather that the stack size issue was only on cygwin. I know we try to support cygwin, but do we have even a single cygwin user? And if so, does he want to allocate 10,000 pari gens in a list? If not maybe we could tone that test down a bit for now to let it pass on cygwin, and then put back the `len(enumerate_totallyreal_fields_prim(2,2**15))` test when cython-3.0 is released.",
    "created_at": "2021-11-07T00:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464949",
    "user": "@orlitzky"
}
```

Removing `hash.patch` was straightforward. Still waiting on ptestlong, but I expect it will pass.

The remaining `trashcan.patch` causes one main problem: when introducing `spkg-configure.m4` for python packages, we will need a patched cython if we're going to install the patched cypari SPKG. That isn't easy to detect, and the logic is backwards from the usual "are my dependencies installed as SPKGs?" check. We can hack something together for sure, but it will be a little ugly until cython-3.0 is released if we decide to keep the patch.

From #27267 I gather that the stack size issue was only on cygwin. I know we try to support cygwin, but do we have even a single cygwin user? And if so, does he want to allocate 10,000 pari gens in a list? If not maybe we could tone that test down a bit for now to let it pass on cygwin, and then put back the `len(enumerate_totallyreal_fields_prim(2,2**15))` test when cython-3.0 is released.



---

archive/issue_comments_464950.json:
```json
{
    "body": "I don't think we should introduce regressions just to remove a patch.",
    "created_at": "2021-11-07T01:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464950",
    "user": "@mkoeppe"
}
```

I don't think we should introduce regressions just to remove a patch.



---

archive/issue_comments_464951.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-07T01:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464951",
    "user": "@orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_464952.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> I don't think we should introduce regressions just to remove a patch.\n\nOk, I have enough other things to do that I'm not desperate to add an spkg-configure for cypari. This is ready then. We'll be forced to remove the other patch during the cython-3.0 upgrade, so we don't have to keep this ticket around.",
    "created_at": "2021-11-07T01:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464952",
    "user": "@orlitzky"
}
```

Replying to [comment:8 mkoeppe]:
> I don't think we should introduce regressions just to remove a patch.

Ok, I have enough other things to do that I'm not desperate to add an spkg-configure for cypari. This is ready then. We'll be forced to remove the other patch during the cython-3.0 upgrade, so we don't have to keep this ticket around.



---

archive/issue_comments_464953.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-11-07T01:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464953",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_464954.json:
```json
{
    "body": "I have inquired with upstream whether we can a backport to 0.29.x - https://github.com/cython/cython/issues/2752",
    "created_at": "2021-11-07T01:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464954",
    "user": "@mkoeppe"
}
```

I have inquired with upstream whether we can a backport to 0.29.x - https://github.com/cython/cython/issues/2752



---

archive/issue_comments_464955.json:
```json
{
    "body": "Looks like is going into 0.29.25",
    "created_at": "2021-11-07T17:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464955",
    "user": "@mkoeppe"
}
```

Looks like is going into 0.29.25



---

archive/issue_comments_464956.json:
```json
{
    "body": "Cython 0.29.25 is out.\n\n- https://github.com/cython/cython/releases/tag/0.29.25",
    "created_at": "2021-12-06T03:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464956",
    "user": "@slel"
}
```

Cython 0.29.25 is out.

- https://github.com/cython/cython/releases/tag/0.29.25



---

archive/issue_comments_464957.json:
```json
{
    "body": "Changing keywords from \"\" to \"cython\".",
    "created_at": "2021-12-06T03:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464957",
    "user": "@slel"
}
```

Changing keywords from "" to "cython".



---

archive/issue_comments_464958.json:
```json
{
    "body": "I've opened #32985 for the cython update",
    "created_at": "2021-12-06T19:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464958",
    "user": "@mkoeppe"
}
```

I've opened #32985 for the cython update



---

archive/issue_comments_464959.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32595#issuecomment-464959",
    "user": "@mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
