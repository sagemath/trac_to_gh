# Issue 32595: cython: Eliminate use of custom patches

Issue created by migration from https://trac.sagemath.org/ticket/32832

Original creator: mkoeppe

Original creation time: 2021-11-06 17:41:04

CC:  mjo fbissey arojas slelievre

As noted in #29665#comment:86, our `cython` spkg uses custom patches:
- https://github.com/sagemath/sage/tree/develop/build/pkgs/cython/patches

We should investigate whether they are still necessary.



---

Comment by mjo created at 2021-11-06 17:51:59

Cython and cypari have patches that work in tandem to address #27267. Neither is really critical IMO, but the patches are not obsolete. The cython patch is a backport from the forthcoming cython-3.0, so we're using a feature from a future release.


---

Comment by fbissey created at 2021-11-06 18:23:26

I don't include the patch is sage-on-gentoo which lead to the only persistent doctest failure I have these days.

```
sage -t --long --random-seed=329662680874814688233998931907435318225 /usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/cythonized/sage/cpython/dict_del_by_value.c:2442)
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/cpython/dict_del_by_value.pyx", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, QQ, 1)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[9]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, QQ, Integer(1))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_9/cythonized/sage/cpython/dict_del_by_value.c:2442)
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
1 item had failures:
```

I have been waiting for that elusive cython 3.0 release, which would get rid of this, for several years now. What is happening with cython upstream?


---

Comment by mkoeppe created at 2021-11-06 18:49:56

I have marked this dependent on the Cython 3.0 ticket #29863


---

Comment by mjo created at 2021-11-06 19:06:49

Replying to [comment:2 fbissey]:
> I don't include the patch is sage-on-gentoo which lead to the only persistent doctest failure I have these days.

That's the other patch, `hash.patch`, also a backport from cython-3.0. It was introduced in #26855 to fix a doctest failure with python3. But if that's all that's affected, we might be able to add `int()` in a few places to avoid the patch until cython-3.0 actually exists.

The trashcan patch shouldn't really be required per #27267#comment:55


---

Comment by fbissey created at 2021-11-06 19:38:35

Never seen any other issues. If there are, they'd need to have new doctests associated to them.


---

Comment by mjo created at 2021-11-06 21:36:38

Replying to [comment:5 fbissey]:
> Never seen any other issues. If there are, they'd need to have new doctests associated to them.

That patch/doctest is also blocking an spkg-configure.m4 for cython, so I'll see what I can do about it and post the branch here.


---

Comment by mjo created at 2021-11-07 00:31:40

Removing `hash.patch` was straightforward. Still waiting on ptestlong, but I expect it will pass.

The remaining `trashcan.patch` causes one main problem: when introducing `spkg-configure.m4` for python packages, we will need a patched cython if we're going to install the patched cypari SPKG. That isn't easy to detect, and the logic is backwards from the usual "are my dependencies installed as SPKGs?" check. We can hack something together for sure, but it will be a little ugly until cython-3.0 is released if we decide to keep the patch.

From #27267 I gather that the stack size issue was only on cygwin. I know we try to support cygwin, but do we have even a single cygwin user? And if so, does he want to allocate 10,000 pari gens in a list? If not maybe we could tone that test down a bit for now to let it pass on cygwin, and then put back the `len(enumerate_totallyreal_fields_prim(2,2**15))` test when cython-3.0 is released.


---

Comment by mkoeppe created at 2021-11-07 01:13:38

I don't think we should introduce regressions just to remove a patch.


---

Comment by mjo created at 2021-11-07 01:23:36

Changing status from new to needs_review.


---

Comment by mjo created at 2021-11-07 01:23:36

Replying to [comment:8 mkoeppe]:
> I don't think we should introduce regressions just to remove a patch.

Ok, I have enough other things to do that I'm not desperate to add an spkg-configure for cypari. This is ready then. We'll be forced to remove the other patch during the cython-3.0 upgrade, so we don't have to keep this ticket around.


---

Comment by mkoeppe created at 2021-11-07 01:33:39

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2021-11-07 01:33:39

I have inquired with upstream whether we can a backport to 0.29.x - https://github.com/cython/cython/issues/2752


---

Comment by mkoeppe created at 2021-11-07 17:10:00

Looks like is going into 0.29.25


---

Comment by slelievre created at 2021-12-06 03:22:12

Cython 0.29.25 is out.

- https://github.com/cython/cython/releases/tag/0.29.25


---

Comment by slelievre created at 2021-12-06 03:22:12

Changing keywords from "" to "cython".


---

Comment by mkoeppe created at 2021-12-06 19:51:54

I've opened #32985 for the cython update


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
