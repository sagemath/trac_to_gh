# Issue 34436: change iterator for ordered set partitions

Issue created by migration from https://trac.sagemath.org/ticket/34673

Original creator: chapoton

Original creation time: 2022-10-17 16:02:17

CC:  vdelecroix tscrim

as suggested by

https://gitlab.com/modulispaces/admcycles/-/issues/100


---

Comment by chapoton created at 2022-10-17 16:02:47

New commits:


---

Comment by chapoton created at 2022-10-17 16:02:47

Changing status from new to needs_review.


---

Comment by chapoton created at 2022-10-17 19:16:16

hmm, in fact, it seems to make the timing even worse.. probably something bad happening in the element construction ?


---

Comment by git created at 2022-10-17 19:39:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-10-18 00:06:41

I think there are a number of ways to speed things up:

1. We do not store the `_base_set` with the element. This is something that belongs the parent.
2. Add a `check` argument to the `__init__` and pass that along; in particular, skip the check when iterating over elements.
3. Cythonize `multiset_permutation_next_lex` and `multiset_permutation_to_ordered_set_partition`.
4. Directly write the `convert` as Python code to avoid the extra Python function calls. Furthermore, already make the parts a `frozenset` or `Set` to avoid extra transient objects.


---

Comment by git created at 2022-10-18 06:55:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-10-18 06:58:11

Thanks Travis for the suggestions.

Trying to include the underlying set in the parent, I stumbled upon the "element_constructor" not doing the job of using the correct specific parent. This is not the first time I meet this kind of issue, but I am still unable to fix that.

Also, I would like to avoid using the sage `Set` at all, because it seems to be deadly slow.


---

Comment by git created at 2022-10-18 07:02:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-18 08:10:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-10-18 08:22:28

I don't quite understand your problem with `element_constructor`. Can you give me a little more detail?

I agree that we should avoid using `Set`, but we then require hashability for `frozenset`. This is desirable, and I don't see any real use-case otherwise. However, it is a slightly backwards incompatible change.

We will also need to special case the base set in `to_packed_word()` when the parent is `OrderedSetPartitions_all`. I also don't see a real use-case for such a parent.


---

Comment by git created at 2022-10-18 08:27:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-10-18 08:38:50

My problem is that currently

```
        sage: S = OrderedSetPartitions()
        sage: x = S([[3,5], [2], [1,4,6]])
        sage: x.parent()
        Ordered set partitions
```

whereas the parent should be `Ordered set partitions of {1,2,3,4,5,6`}


---

Comment by tscrim created at 2022-10-18 08:43:58

No, that is the correct answer. We have a parent that is the set of all ordered set partitions, no matter the base set.

Actually, I know a use case (answering the last part of comment:9): We need the union of `OrderedSetPartitions(n)` over all `n` to index the basis of `FQSym`.


---

Comment by tscrim created at 2022-10-18 08:45:33

The only issue is in `to_packed_word()`, right? Just check if the parent is `OrderedSetPartitions_all`, and in that case only, do we build the set as `frozenset(range(1, sum(len(p) for p in self)+1))`.


---

Comment by git created at 2022-10-18 08:57:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2022-10-18 08:58:35

thanks a lot. I have used a try-except in `base_set` method.

Now passing the doctests, with a twice faster but still very slow iterator.


---

Comment by tscrim created at 2022-10-18 09:44:50

One micro-optimization: The change

```diff
-        par = parent(self)
+        par = self.parent()
```

is slightly slower because the first is a Cython function call (that accesses the Cython slot) versus a Python method call:

```
sage: O = OrderedSetPartition()
sage: %timeit parent(O)
28 ns ± 0.415 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
sage: %timeit O.parent()
55.6 ns ± 0.234 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
```

Up to you if you want to revert it.

I just pushed another >2x speedup by avoiding the useless check (comment:4 point 2).

I do think it would be nice to get rid of the `Set`. I highly doubt anyone will be affected by that change. If anyone is affected, then we can just apologize to them and tell them to make their objects immutable. Iterating over `OrderedSetPartitions(7)` now, over 80% of the time is spent in `Set.__init__`.
----
New commits:


---

Comment by chapoton created at 2022-10-18 14:32:43

now using `parent(self)` again
----
New commits:


---

Comment by git created at 2022-10-18 19:23:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-10-18 19:25:21

now using `set` and `frozenset`, and so really much faster in iteration. :)

Some doctests are failing because of a modified order in the doctests. It is ok to change the doctests ?


---

Comment by tscrim created at 2022-10-19 00:01:41

Replying to [comment:19 Frédéric Chapoton]:
> now using `set` and `frozenset`, and so really much faster in iteration. :)

Yay!

> Some doctests are failing because of a modified order in the doctests. It is ok to change the doctests ?

Of course.


---

Comment by git created at 2022-10-19 06:38:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-10-19 06:38:55

doctests now fixed, also in wqsym


---

Comment by git created at 2022-10-19 13:39:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-10-20 00:44:04

We have to be a little more careful about the parent in `from_finite_word()` as it can lead to pollution of the `WQSym` elements having indices in different parents (which are not comparable).
----
New commits:


---

Comment by chapoton created at 2022-10-21 06:24:36

ok, if you say so. Looks good to me

Vincent suggested to check if the original code in sage could be made more efficient than our current proposal, once no longer using Set. This seems unlikely to me.


---

Comment by tscrim created at 2022-10-21 06:41:54

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-10-21 06:41:54

No, you already had an improvement even while using `Set` as I understood it.

We don't want to mix different parents for `WQSym` basis indices because then `<=` doesn't work. So, e.g., `leading_support()` fails.


---

Comment by vbraun created at 2022-10-30 10:30:59

Resolution: fixed
