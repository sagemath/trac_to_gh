# Issue 17684: faster matching polynomial

archive/issues_017684.json:
```json
{
    "body": "CC:  @videlec @nathanncohen\n\nAdded `matching_generating_poly`, modified `matching_polynomial`, added an option\nto `permanental_minor_polynomial`, which for some graphs is faster than the previous\nalgorithm.\n\n`matching_generating_poly` computes the matching generating polynomial\non (possibly weighted) graphs; this is used in `permanental_minor_polynomial`.\n\nThe algorithm (see [ButPer]) uses polynomials on nilpotent elements,\nimplemented in the class `Hobj` in matchpoly.pyx.\nThe idea is that the matching generating polynomial can be computed from\nthe product of terms\n`(1 + x w_{i j} \\eta_i \\eta_j)`, for all edges `(i, j)`\nwhere `w_{i j}` is the weight of the edge `(i, j)` and `\\eta_i^2 = \\eta_j^2=0`.\nThe term `1` corresponds to the absence of the dimer `(i,j)`,\nthe other term to its presence. A configuration with two adjacent dimers\ndoes not contribute due to nilpotency. The matching generating polynomial\nis given by the sum of the coefficients of the non-vanishing products of `\\eta`'s.\n\nWhile the result does not depend on the ordering of the edges in the above\nproduct, the speed of the algorithm depends on the ordering; in fact doing\nthe above product from left to right, one can set `\\eta_i=1` as soon\nas `\\eta_i` does not appear in the yet unused factors on the right, reducing\nin this way the number of terms.\nA greedy argument to order edges is contained in active_nodes.py\n\n\nThe Godsil algorithm is faster for small graphs, which take little time\nwith either algorithms; it becomes progressively slower as the number\nof vertices increases; e.g. on my computer\nfor `graphs.KnightGraph([4, n])`, the Godsil algorithm \nfor `n=5` is 25% faster, for `n=6` 5x slower, for `n=9` 4000x slower.\n\nThe new algorithm can be much faster than the `rook` algorithm for matching polynomials of bipartite graphs\n\n```\nsage: time BipartiteGraph(graphs.LadderGraph(30)).matching_polynomial()[0]\nWall time: 65.7 ms\n1346269\n```\n\nIt is also much faster than the previous algorithm (now called `bipartite`)\nfor computing the sum of the permanental minors, in the case of randomized band matrices\n\n```\nsage: from sage.matrix.matrix_misc import permanental_minor_polynomial\nsage: n, w = 20, 3\nsage: m = matrix([[i*j + 1 if abs(i-j) <= w else 0 for i in range(n)] for j in range(n)])\nsage: a = list(m); shuffle(a); b = zip(*a); shuffle(b); m1 = matrix(b)\nsage: time p1 = permanental_minor_polynomial(m1, algorithm='matching')\nWall time: 174 ms\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17921\n\n",
    "created_at": "2015-03-09T19:35:02Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "faster matching polynomial",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17684",
    "user": "https://trac.sagemath.org/admin/accounts/users/pernici"
}
```
CC:  @videlec @nathanncohen

Added `matching_generating_poly`, modified `matching_polynomial`, added an option
to `permanental_minor_polynomial`, which for some graphs is faster than the previous
algorithm.

`matching_generating_poly` computes the matching generating polynomial
on (possibly weighted) graphs; this is used in `permanental_minor_polynomial`.

The algorithm (see [ButPer]) uses polynomials on nilpotent elements,
implemented in the class `Hobj` in matchpoly.pyx.
The idea is that the matching generating polynomial can be computed from
the product of terms
`(1 + x w_{i j} \eta_i \eta_j)`, for all edges `(i, j)`
where `w_{i j}` is the weight of the edge `(i, j)` and `\eta_i^2 = \eta_j^2=0`.
The term `1` corresponds to the absence of the dimer `(i,j)`,
the other term to its presence. A configuration with two adjacent dimers
does not contribute due to nilpotency. The matching generating polynomial
is given by the sum of the coefficients of the non-vanishing products of `\eta`'s.

While the result does not depend on the ordering of the edges in the above
product, the speed of the algorithm depends on the ordering; in fact doing
the above product from left to right, one can set `\eta_i=1` as soon
as `\eta_i` does not appear in the yet unused factors on the right, reducing
in this way the number of terms.
A greedy argument to order edges is contained in active_nodes.py


The Godsil algorithm is faster for small graphs, which take little time
with either algorithms; it becomes progressively slower as the number
of vertices increases; e.g. on my computer
for `graphs.KnightGraph([4, n])`, the Godsil algorithm 
for `n=5` is 25% faster, for `n=6` 5x slower, for `n=9` 4000x slower.

The new algorithm can be much faster than the `rook` algorithm for matching polynomials of bipartite graphs

```
sage: time BipartiteGraph(graphs.LadderGraph(30)).matching_polynomial()[0]
Wall time: 65.7 ms
1346269
```

It is also much faster than the previous algorithm (now called `bipartite`)
for computing the sum of the permanental minors, in the case of randomized band matrices

```
sage: from sage.matrix.matrix_misc import permanental_minor_polynomial
sage: n, w = 20, 3
sage: m = matrix([[i*j + 1 if abs(i-j) <= w else 0 for i in range(n)] for j in range(n)])
sage: a = list(m); shuffle(a); b = zip(*a); shuffle(b); m1 = matrix(b)
sage: time p1 = permanental_minor_polynomial(m1, algorithm='matching')
Wall time: 174 ms
```



Issue created by migration from https://trac.sagemath.org/ticket/17921





---

archive/issue_comments_236100.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-11T15:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236100",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_236101.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-11T15:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236101",
    "user": "https://trac.sagemath.org/admin/accounts/users/pernici"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_236102.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-03-15T15:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236102",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_236103.json:
```json
{
    "body": "I clean the description of the ticket to make it readable. Could you try to make it understandable?",
    "created_at": "2015-03-15T15:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236103",
    "user": "https://github.com/videlec"
}
```

I clean the description of the ticket to make it readable. Could you try to make it understandable?



---

archive/issue_comments_236104.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-03-16T17:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236104",
    "user": "https://trac.sagemath.org/admin/accounts/users/pernici"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_236105.json:
```json
{
    "body": "I added an explanation on the use of nilpotent elements and two more examples.",
    "created_at": "2015-03-16T18:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236105",
    "user": "https://trac.sagemath.org/admin/accounts/users/pernici"
}
```

I added an explanation on the use of nilpotent elements and two more examples.



---

archive/issue_comments_236106.json:
```json
{
    "body": "The greedy argument to order edges in active_nodes.py orders edges in such a way that the graph\n`G_i` defined by `edges[:i]` has few nodes which have not the same degree as in `G` (active nodes).\nThis leads to few `\\eta_i` in the corresponding polynomial, so there are few terms.\nThe greedy algorithm adds edges without increasing the number of active nodes, if possible;\notherwise it adds a short path between two active nodes.\n\nThis algorithm can be probably improved using some\ngraph algorithm already in Sage, maybe an algorithm to reorder vertices used to visualize graphs.",
    "created_at": "2015-03-17T11:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236106",
    "user": "https://trac.sagemath.org/admin/accounts/users/pernici"
}
```

The greedy argument to order edges in active_nodes.py orders edges in such a way that the graph
`G_i` defined by `edges[:i]` has few nodes which have not the same degree as in `G` (active nodes).
This leads to few `\eta_i` in the corresponding polynomial, so there are few terms.
The greedy algorithm adds edges without increasing the number of active nodes, if possible;
otherwise it adds a short path between two active nodes.

This algorithm can be probably improved using some
graph algorithm already in Sage, maybe an algorithm to reorder vertices used to visualize graphs.



---

archive/issue_comments_236107.json:
```json
{
    "body": "Please try to get 100% coverage (`sage -coverage`) also in private methods. Please adhere to usual documentation guidelines: esp. start paragraphs with big caps, do not use `>>>` for examples.",
    "created_at": "2015-03-22T15:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236107",
    "user": "https://github.com/rwst"
}
```

Please try to get 100% coverage (`sage -coverage`) also in private methods. Please adhere to usual documentation guidelines: esp. start paragraphs with big caps, do not use `>>>` for examples.



---

archive/issue_comments_236108.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-24T21:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236108",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_236109.json:
```json
{
    "body": "failing doctests, see patchbot report\n\nplus very bad formatting of the doc",
    "created_at": "2015-03-24T21:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236109",
    "user": "https://github.com/fchapoton"
}
```

failing doctests, see patchbot report

plus very bad formatting of the doc



---

archive/issue_comments_236110.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-26T12:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236110",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_236111.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-26T12:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236111",
    "user": "https://trac.sagemath.org/admin/accounts/users/pernici"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_236112.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-02T10:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236112",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_236113.json:
```json
{
    "body": "I personally don't care about this ticket, but let me mention that it doesn't apply and that it should be rebased on top of #23126.",
    "created_at": "2017-06-02T10:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-236113",
    "user": "https://github.com/jdemeyer"
}
```

I personally don't care about this ticket, but let me mention that it doesn't apply and that it should be rebased on top of #23126.
