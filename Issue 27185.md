# Issue 27185: gfan and lcalc no longer build with old gcc

Issue created by migration from https://trac.sagemath.org/ticket/27422

Original creator: jdemeyer

Original creation time: 2019-03-04 16:38:37

CC:  fbissey embray

Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:

```
make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'
g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o
g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o
g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o
src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':
src/polynomialgcd.cpp:286:11: error: 'i' does not name a type
  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());
```

and

```
make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'
g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc
g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc
In file included from ../include/Lglobals.h:48:0,
                 from Lglobals.cc:23:
../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':
../include/Lcommon.h:71:8: error: 'i' does not name a type
   loop(i,this->N,N)
        ^
../include/Lcommon.h:51:30: note: in definition of macro 'loop'
 #define loop(i,m,n) for(auto i=(m); i!=(n); i++)
```



---

Comment by dimpase created at 2019-03-04 16:43:29

But the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?


---

Comment by jdemeyer created at 2019-03-04 17:18:12

Replying to [comment:3 dimpase]:
> But the `auto` is new C++, how did it work before?

Before #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.


---

Comment by dimpase created at 2019-03-04 17:25:03

Francois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.

Could you post the `sage-env-config` from one of these broken systems here?


---

Comment by jdemeyer created at 2019-03-04 17:41:13

After trying again, it now works correctly...

So maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?


---

Comment by dimpase created at 2019-03-04 17:57:22

Perhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.


---

Comment by jdemeyer created at 2019-03-04 19:13:09

This happened when upgrading from 8.6. I can try to again to see if I can reproduce it.


---

Comment by dimpase created at 2019-03-04 19:15:49

I can think of a number of ways to interpret  "upgrading". Please be more specific.


---

Comment by fbissey created at 2019-03-04 19:51:05

I am guessing just doing `make` after synchronising didn't run `configure`.


---

Comment by jdemeyer created at 2019-03-08 14:24:49

Resolution: worksforme


---

Comment by jdemeyer created at 2019-03-08 14:24:49

I cannot reproduce this.


---

Comment by jdemeyer created at 2019-03-11 09:33:36

I just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.


---

Comment by jdemeyer created at 2019-03-11 09:34:02

Replying to [comment:11 fbissey]:
> I am guessing just doing `make` after synchronising didn't run `configure`.

But it should according to the top-level `Makefile`.


---

Comment by fbissey created at 2019-03-11 09:44:21

Replying to [comment:14 jdemeyer]:
> Replying to [comment:11 fbissey]:
> > I am guessing just doing `make` after synchronising didn't run `configure`.
> 
> But it should according to the top-level `Makefile`.

The glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.


---

Comment by jdemeyer created at 2019-03-11 09:49:20

If I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.


---

Comment by dimpase created at 2019-03-11 11:12:00

I guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.

Once #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.


---

Comment by jdemeyer created at 2019-03-11 11:20:29

I tried to reproduce, but again I didn't manage.


---

Comment by jdemeyer created at 2019-03-11 11:21:56

Replying to [comment:17 dimpase]:
> Once #27212, #27258, and #27259 are in

Why are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.


---

Comment by dimpase created at 2019-03-11 11:26:29

I am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.


---

Comment by jdemeyer created at 2019-03-21 12:48:45

I think I finally figured out the root cause, I updated the description.


---

Comment by jdemeyer created at 2019-03-21 12:49:13

Resolution changed from worksforme to 


---

Comment by jdemeyer created at 2019-03-21 12:49:13

Changing status from closed to new.


---

Comment by embray created at 2019-03-21 13:10:31

I haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.


---

Comment by jdemeyer created at 2019-03-21 14:00:00

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-03-21 14:00:00

Replying to [comment:26 embray]:
> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.

I think there is a misunderstanding.

The problem is when _both_ `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.

I went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.
----
New commits:


---

Comment by vbraun created at 2019-03-23 22:18:44

Changing priority from blocker to major.


---

Comment by vbraun created at 2019-03-23 22:18:44

Imho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.


---

Comment by jdemeyer created at 2019-03-23 22:28:48

It's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?

In the end, you have the last word, but I would like you to reconsider this ticket.


---

Comment by jdemeyer created at 2019-03-23 22:28:48

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2019-03-23 22:30:14

If you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.


---

Comment by vbraun created at 2019-03-24 00:53:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-24 00:53:49

I see your point, but I also think its fairly low impact. The perfect is the enemy of the good...


---

Comment by embray created at 2019-03-25 10:08:08

Amusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.


---

Comment by dimpase created at 2019-03-25 10:17:33

This whole thing is totally insane - does it support `./configure --prefix=` ?

Shouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!
Why do we keep mixing up build trees with source...


---

Comment by dimpase created at 2019-03-25 10:17:33

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2019-03-25 10:23:19

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-03-25 10:23:19

Replying to [comment:35 dimpase]:
> This whole thing is totally insane - does it support `./configure --prefix=` ?

Of course it does, why should it not?

> Shouldn't `src/bin/sage-env-config` actually not be there at all?!

But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

I'm setting this back to needs_review since I don't really understand your complaint.


---

Comment by dimpase created at 2019-03-25 10:30:10

Replying to [comment:36 jdemeyer]:
> Replying to [comment:35 dimpase]:
> > This whole thing is totally insane - does it support `./configure --prefix=` ?
> 
> Of course it does, why should it not?
> 
> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!
> 
> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

Its place is not there, not in somewhere that is in the `$PATH`.
but rather in something like `$SAGE_LOCAL/config/` or so...

I hope this explains.

> 
> I'm setting this back to needs_review since I don't really understand your complaint.


---

Comment by jdemeyer created at 2019-03-25 10:32:11

Replying to [comment:37 dimpase]:
> Its place is not there, not in somewhere that is in the `$PATH`.
> but rather in something like `$SAGE_LOCAL/config/` or so...

But then you have a circular problem:

1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`

2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`


---

Comment by embray created at 2019-03-25 10:33:32

Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.


---

Comment by embray created at 2019-03-25 10:33:32

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-03-25 10:36:21

Replying to [comment:37 dimpase]:
> Replying to [comment:36 jdemeyer]:
> > Replying to [comment:35 dimpase]:
> > > This whole thing is totally insane - does it support `./configure --prefix=` ?
> > 
> > Of course it does, why should it not?
> > 
> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!
> > 
> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.
> 
> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

When running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)


---

Comment by jdemeyer created at 2019-03-25 10:38:30

I should also note that _after installation_ the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at _build time_, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.


---

Comment by dimpase created at 2019-03-25 10:41:02

Replying to [comment:38 jdemeyer]:
> Replying to [comment:37 dimpase]:
> > Its place is not there, not in somewhere that is in the `$PATH`.
> > but rather in something like `$SAGE_LOCAL/config/` or so...
> 
> But then you have a circular problem:
> 
> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`


You just said that this is available from `src/bin/sage-env-config`, no?


> 
> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`

No, this is in `src/bin/sage-env-config`, that's how you can find it.

Well, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.


---

Comment by dimpase created at 2019-03-25 10:48:29

Replying to [comment:39 embray]:
> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?



> 
> Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.

In this case "installed" ought to happen at the end, after the build is done and dusted.


---

Comment by embray created at 2019-03-25 10:59:12

Replying to [comment:43 dimpase]:
> Replying to [comment:39 embray]:
> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).
> 
> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?

No, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get "installed" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.


---

Comment by vbraun created at 2019-03-25 19:43:05

Resolution: fixed
