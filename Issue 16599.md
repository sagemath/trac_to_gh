# Issue 16599: __neg__ fails in CartesianProduct of CombinatorialFreeModule

archive/issues_016599.json:
```json
{
    "body": "CC:  @nthiery\n\n\n```\nsage: X=CombinatorialFreeModule(ZZ,ZZ)\nsage: Y=cartesian_product((X,X))\nsage: -Y.an_element()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-11-189fa298bf84> in <module>()\n----> 1 -Y.an_element()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __neg__(self)\n    920                     \"\"\"\n    921                     return self.parent()(\n--> 922                         -x for x in self.cartesian_factors())\n    923 \n    924         class Algebras(AlgebrasCategory):\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:8902)()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4203)()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4110)()\n\n/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in _element_constructor_(self, x)\n   1527                 except TypeError:\n   1528                     pass\n-> 1529             raise TypeError(\"do not know how to make x (= %s) an element of self (=%s)\"%(x,self))\n   1530 \n   1531     def _an_element_impl(self):\n\nTypeError: do not know how to make x (= <generator object <genexpr> at 0x7fd385148050>) an element of self (=Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16836\n\n",
    "created_at": "2014-08-16T05:47:25Z",
    "labels": [
        "component: categories",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "__neg__ fails in CartesianProduct of CombinatorialFreeModule",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16599",
    "user": "https://github.com/cnassau"
}
```
CC:  @nthiery


```
sage: X=CombinatorialFreeModule(ZZ,ZZ)
sage: Y=cartesian_product((X,X))
sage: -Y.an_element()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-189fa298bf84> in <module>()
----> 1 -Y.an_element()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/categories/additive_magmas.pyc in __neg__(self)
    920                     """
    921                     return self.parent()(
--> 922                         -x for x in self.cartesian_factors())
    923 
    924         class Algebras(AlgebrasCategory):

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:8902)()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4203)()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/structure/coerce_maps.so in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4110)()

/waste/cn/sage-git/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in _element_constructor_(self, x)
   1527                 except TypeError:
   1528                     pass
-> 1529             raise TypeError("do not know how to make x (= %s) an element of self (=%s)"%(x,self))
   1530 
   1531     def _an_element_impl(self):

TypeError: do not know how to make x (= <generator object <genexpr> at 0x7fd385148050>) an element of self (=Free module generated by Integer Ring over Integer Ring (+) Free module generated by Integer Ring over Integer Ring)
```


Issue created by migration from https://trac.sagemath.org/ticket/16836





---

archive/issue_comments_218557.json:
```json
{
    "body": "The fix appears to be quite simple:\n\n\n```diff\n--- a/src/sage/categories/additive_magmas.py\n+++ b/src/sage/categories/additive_magmas.py\n@@ -918,8 +918,8 @@ class AdditiveMagmas(Category_singleton):\n                             ...\n                             AssertionError\n                     \"\"\"\n-                    return self.parent()(\n-                        -x for x in self.cartesian_factors())\n+                    return self.parent()._cartesian_product_of_elements(\n+                       [-x for x in self.cartesian_factors()])\n```\n\n\nThis breaks a doctest, however:\n\n```\nFile \"src/sage/categories/additive_magmas.py\", line 903, in sage.categories.additive_magmas.AdditiveMagmas.AdditiveUnital.CartesianProducts.ElementMethods.__neg__\nFailed example:\n    -c\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: Value -42 in not in Non negative integers.\nGot:\n    (-1, -42, -1.00000000000000)\n```\n\n\nThe fix for that doctest would be to move a sanity check from `_neg_` to `CartesianProduct._cartesian_product_of_elements`. That then breaks a design-comment in the latter routine about being optimized for speed. \n\nAlternatively, the doctest could be removed (my choice). We don't want an implicit sanity-check whenever we negate an element of a cartesian product.\n\nThis is therefore the sort of code/bug that only the original author can fix.",
    "created_at": "2014-08-16T06:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218557",
    "user": "https://github.com/cnassau"
}
```

The fix appears to be quite simple:


```diff
--- a/src/sage/categories/additive_magmas.py
+++ b/src/sage/categories/additive_magmas.py
@@ -918,8 +918,8 @@ class AdditiveMagmas(Category_singleton):
                             ...
                             AssertionError
                     """
-                    return self.parent()(
-                        -x for x in self.cartesian_factors())
+                    return self.parent()._cartesian_product_of_elements(
+                       [-x for x in self.cartesian_factors()])
```


This breaks a doctest, however:

```
File "src/sage/categories/additive_magmas.py", line 903, in sage.categories.additive_magmas.AdditiveMagmas.AdditiveUnital.CartesianProducts.ElementMethods.__neg__
Failed example:
    -c
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Value -42 in not in Non negative integers.
Got:
    (-1, -42, -1.00000000000000)
```


The fix for that doctest would be to move a sanity check from `_neg_` to `CartesianProduct._cartesian_product_of_elements`. That then breaks a design-comment in the latter routine about being optimized for speed. 

Alternatively, the doctest could be removed (my choice). We don't want an implicit sanity-check whenever we negate an element of a cartesian product.

This is therefore the sort of code/bug that only the original author can fix.



---

archive/issue_comments_218558.json:
```json
{
    "body": "the attached patch fixes the problem in the indicated way: the offending doctest has been removed.\n\nafter all, the offendig behaviour (x in N, but -x not in N) is well known from the natural numbers, and not much of a problem.\n----\nNew commits:",
    "created_at": "2014-08-16T19:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218558",
    "user": "https://github.com/cnassau"
}
```

the attached patch fixes the problem in the indicated way: the offending doctest has been removed.

after all, the offendig behaviour (x in N, but -x not in N) is well known from the natural numbers, and not much of a problem.
----
New commits:



---

archive/issue_comments_218559.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-16T19:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218559",
    "user": "https://github.com/cnassau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_218560.json:
```json
{
    "body": "I've changed the priority to make sure this issue gets addressed in the next release.",
    "created_at": "2014-09-10T07:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218560",
    "user": "https://github.com/cnassau"
}
```

I've changed the priority to make sure this issue gets addressed in the next release.



---

archive/issue_comments_218561.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2014-09-10T07:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218561",
    "user": "https://github.com/cnassau"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_218562.json:
```json
{
    "body": "Not a blocker, but this has been on my todo list. I hope to get to this next week.",
    "created_at": "2014-09-10T07:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218562",
    "user": "https://github.com/tscrim"
}
```

Not a blocker, but this has been on my todo list. I hope to get to this next week.



---

archive/issue_comments_218563.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-18T12:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218563",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_218564.json:
```json
{
    "body": "Hello,\n\nCould you change\n\n```\nsage: F = CombinatorialFreeModule(ZZ, ['a','b'])\nsage: FF = cartesian_product((F,F))\nsage: -FF.an_element() # random - only test that negative can be taken\n```\n\nto something explicit like\n\n```\nsage: F = CombinatorialFreeModule(ZZ, ['a','b'])\nsage: a,b = F.gens()\nsage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])\nsage: c\n2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]\nsage: FF = cartesian_product((F,F))\nsage: c.parent() == FF\nTrue\nsage: -c\n-2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]\n```\n\n\nIMHO, the following fails but should work\n\n```\nsage: FF([a,b])\nTraceback (most recent call last)\n...\n\nTypeError: do not know how to make x (= [B['a'], B['b']])\nan element of self (=Free module generated by {'a', 'b'} over Integer Ring\n(+) Free module generated by {'a', 'b'} over Integer Ring)\n```\n\n\nVincent",
    "created_at": "2015-04-18T12:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218564",
    "user": "https://github.com/videlec"
}
```

Hello,

Could you change

```
sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
sage: FF = cartesian_product((F,F))
sage: -FF.an_element() # random - only test that negative can be taken
```

to something explicit like

```
sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
sage: a,b = F.gens()
sage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])
sage: c
2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]
sage: FF = cartesian_product((F,F))
sage: c.parent() == FF
True
sage: -c
-2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]
```


IMHO, the following fails but should work

```
sage: FF([a,b])
Traceback (most recent call last)
...

TypeError: do not know how to make x (= [B['a'], B['b']])
an element of self (=Free module generated by {'a', 'b'} over Integer Ring
(+) Free module generated by {'a', 'b'} over Integer Ring)
```


Vincent



---

archive/issue_comments_218565.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-19T09:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218565",
    "user": "https://github.com/cnassau"
}
```

New commits:



---

archive/issue_comments_218566.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> Could you change\n> {{{\n> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])\n> sage: FF = cartesian_product((F,F))\n> sage: -FF.an_element() # random - only test that negative can be taken\n> }}}\n> to something explicit like\n> {{{\n> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])\n> sage: a,b = F.gens()\n> sage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])\n> sage: c\n> 2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]\n> sage: FF = cartesian_product((F,F))\n> sage: c.parent() == FF\n> True\n> sage: -c\n> -2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]\n> }}}\n\nI have followed these suggestions; the doctest is now more explicit.\n \n> IMHO, the following fails but should work\n> {{{\n> sage: FF([a,b])\n> Traceback (most recent call last)\n> ...\n> \n> TypeError: do not know how to make x (= [B['a'], B['b']])\n> an element of self (=Free module generated by {'a', 'b'} over Integer Ring\n> (+) Free module generated by {'a', 'b'} over Integer Ring)\n> }}}\n\nI agree that this looks like a reasonable expectation, but I'm afraid that this might be a bit contentious since it would involve changes in the combinatorial heartland. I'd prefer to keep such matters out of this ticket which is essentially just a simple bugfix.\n\nThanks for taking the time to look into this ticket!\n\nCheers,\nChristian",
    "created_at": "2015-04-19T09:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218566",
    "user": "https://github.com/cnassau"
}
```

Replying to [comment:5 vdelecroix]:
> Could you change
> {{{
> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
> sage: FF = cartesian_product((F,F))
> sage: -FF.an_element() # random - only test that negative can be taken
> }}}
> to something explicit like
> {{{
> sage: F = CombinatorialFreeModule(ZZ, ['a','b'])
> sage: a,b = F.gens()
> sage: c = cartesian_product([a,b-2*a]) + cartesian_product([a,a])
> sage: c
> 2*B[(0, 'a')] - B[(1, 'a')] + B[(1, 'b')]
> sage: FF = cartesian_product((F,F))
> sage: c.parent() == FF
> True
> sage: -c
> -2*B[(0, 'a')] + B[(1, 'a')] - B[(1, 'b')]
> }}}

I have followed these suggestions; the doctest is now more explicit.
 
> IMHO, the following fails but should work
> {{{
> sage: FF([a,b])
> Traceback (most recent call last)
> ...
> 
> TypeError: do not know how to make x (= [B['a'], B['b']])
> an element of self (=Free module generated by {'a', 'b'} over Integer Ring
> (+) Free module generated by {'a', 'b'} over Integer Ring)
> }}}

I agree that this looks like a reasonable expectation, but I'm afraid that this might be a bit contentious since it would involve changes in the combinatorial heartland. I'd prefer to keep such matters out of this ticket which is essentially just a simple bugfix.

Thanks for taking the time to look into this ticket!

Cheers,
Christian



---

archive/issue_comments_218567.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-19T09:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218567",
    "user": "https://github.com/cnassau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_218568.json:
```json
{
    "body": "Hello Christian,\n\nI made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?\n\nBest,\nVincent\n\nPS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.\n----\nNew commits:",
    "created_at": "2015-04-19T10:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218568",
    "user": "https://github.com/videlec"
}
```

Hello Christian,

I made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?

Best,
Vincent

PS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.
----
New commits:



---

archive/issue_comments_218569.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-19T15:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218569",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_218570.json:
```json
{
    "body": "Hi Vincent,\n\n> I made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?\n\nI think getting an error when using `-42` or `-(42,whatever)` would definitely be misguided - these days that level of \"rigor\" is only appreciated by a small and diminishing group of mostly white-bearded Bourbakistas... \n\nChanging the parent, OTOH, might be a good idea. I have now changed the line again to choose the parent automatically. I'm not sure whether there's an impact on performance, though. For that reason I have also added a new `__neg__` for elements of the cartesian product of semigroups with guaranteed inverses; here the parent is clear and the old code seems appropriate. \n\n> PS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.\n\nYour warning came to late, I was already in the process of changing branches, athough not entirely deliberately. The new patch is now based on 6.7.beta1 ...  it seems.",
    "created_at": "2015-04-19T15:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218570",
    "user": "https://github.com/cnassau"
}
```

Hi Vincent,

> I made a small commit which forces a cast of each factor. In that case you get a `ValueError` when you try to negate `(1, 42, 1.)` in `ZZ x NN x RR`. Actually, wouldn't it be better that doing a negation convert it to an element of `ZZ x ZZ x RR`. What do you think?

I think getting an error when using `-42` or `-(42,whatever)` would definitely be misguided - these days that level of "rigor" is only appreciated by a small and diminishing group of mostly white-bearded Bourbakistas... 

Changing the parent, OTOH, might be a good idea. I have now changed the line again to choose the parent automatically. I'm not sure whether there's an impact on performance, though. For that reason I have also added a new `__neg__` for elements of the cartesian product of semigroups with guaranteed inverses; here the parent is clear and the old code seems appropriate. 

> PS: it would be cool if you worked on the last beta release (now `6.7.beta1`). It helps preventing merge conflicts and it avoids switching between Sage versions. Do not change it now! But when you restart the implementation like you did, just start it on the last beta.

Your warning came to late, I was already in the process of changing branches, athough not entirely deliberately. The new patch is now based on 6.7.beta1 ...  it seems.



---

archive/issue_comments_218571.json:
```json
{
    "body": "Not sure the old code is appropriate:\n\n```\nsage: NNSemiring = NonNegativeIntegerSemiring()\nsage: C = cartesian_product([ZZ,NNSemiring,RR])\nsage: -C([2,0,.4])\n(-2, 0, -0.400000000000000)\nsage: parent(_)\nThe cartesian product of (Integer Ring, Integer Ring,\n Real Field with 53 bits of precision)\n```\n\nThe problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!\n\nThe good way to do it is to implement a `negation_parent` in the coercion model similar to the `division_parent` that we have right now. This does choose for you the right parent when you do `x / y`.\n\n```\nsage: from sage.structure.element import get_coercion_model\nsage: cm = get_coercion_model()\nsage: cm.division_parent(ZZ)\nRational Field\nsage: cm.division_parent(QQ)\nRational Field\nsage: cm.division_parent(Zmod(14))\nRing of integers modulo 14\n```\n\nBut it is out of the scope of this ticket I guess.\n\nVincent",
    "created_at": "2015-04-19T16:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218571",
    "user": "https://github.com/videlec"
}
```

Not sure the old code is appropriate:

```
sage: NNSemiring = NonNegativeIntegerSemiring()
sage: C = cartesian_product([ZZ,NNSemiring,RR])
sage: -C([2,0,.4])
(-2, 0, -0.400000000000000)
sage: parent(_)
The cartesian product of (Integer Ring, Integer Ring,
 Real Field with 53 bits of precision)
```

The problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!

The good way to do it is to implement a `negation_parent` in the coercion model similar to the `division_parent` that we have right now. This does choose for you the right parent when you do `x / y`.

```
sage: from sage.structure.element import get_coercion_model
sage: cm = get_coercion_model()
sage: cm.division_parent(ZZ)
Rational Field
sage: cm.division_parent(QQ)
Rational Field
sage: cm.division_parent(Zmod(14))
Ring of integers modulo 14
```

But it is out of the scope of this ticket I guess.

Vincent



---

archive/issue_comments_218572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-19T16:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_218573.json:
```json
{
    "body": "Replying to [comment:12 vdelecroix]:\n> Not sure the old code is appropriate:\n> {{{\n> sage: NNSemiring = NonNegativeIntegerSemiring()\n> sage: C = cartesian_product([ZZ,NNSemiring,RR])\n> sage: -C([2,0,.4])\n> (-2, 0, -0.400000000000000)\n> sage: parent(_)\n> The cartesian product of (Integer Ring, Integer Ring,\n>  Real Field with 53 bits of precision)\n> }}}\n> The problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!\n\nGetting rid of it sounds like a clean solution. The latest commit now only implements a `__neg__` if all factors are guaranteed to have inverses.\n\nCheers,\nChristian",
    "created_at": "2015-04-19T16:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218573",
    "user": "https://github.com/cnassau"
}
```

Replying to [comment:12 vdelecroix]:
> Not sure the old code is appropriate:
> {{{
> sage: NNSemiring = NonNegativeIntegerSemiring()
> sage: C = cartesian_product([ZZ,NNSemiring,RR])
> sage: -C([2,0,.4])
> (-2, 0, -0.400000000000000)
> sage: parent(_)
> The cartesian product of (Integer Ring, Integer Ring,
>  Real Field with 53 bits of precision)
> }}}
> The problem is that `NN` is a facade (i.e. its elements are Integer whose with parent the Integer Ring). But when `NN` is a factor of a cartesian product it is not considered as being one. I would just remove completely this `__neg__` for magma elements or adopt my version. That would avoid many problems!

Getting rid of it sounds like a clean solution. The latest commit now only implements a `__neg__` if all factors are guaranteed to have inverses.

Cheers,
Christian



---

archive/issue_comments_218574.json:
```json
{
    "body": "Looks good. Could you get rid of this line\n\n```\n+from sage.categories.cartesian_product import cartesian_product\n```\n\n\nAnd if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.\n\nThen it should be ok.\n\nVincent",
    "created_at": "2015-04-19T16:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218574",
    "user": "https://github.com/videlec"
}
```

Looks good. Could you get rid of this line

```
+from sage.categories.cartesian_product import cartesian_product
```


And if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.

Then it should be ok.

Vincent



---

archive/issue_comments_218575.json:
```json
{
    "body": "Replying to [comment:15 vdelecroix]:\n> Looks good. Could you get rid of this line\n> {{{\n> +from sage.categories.cartesian_product import cartesian_product\n> }}}\n> \n> And if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.\n\nAlright, I've cleaned up the branch and removed that line. \n\nThanks for your time & Cheers,\nChristian",
    "created_at": "2015-04-19T16:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218575",
    "user": "https://github.com/cnassau"
}
```

Replying to [comment:15 vdelecroix]:
> Looks good. Could you get rid of this line
> {{{
> +from sage.categories.cartesian_product import cartesian_product
> }}}
> 
> And if you don't mind, you can clean the history by making all of this only one commit above 6.7.beta1.

Alright, I've cleaned up the branch and removed that line. 

Thanks for your time & Cheers,
Christian



---

archive/issue_comments_218576.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-19T16:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218576",
    "user": "https://github.com/cnassau"
}
```

New commits:



---

archive/issue_comments_218577.json:
```json
{
    "body": "Let it go!",
    "created_at": "2015-04-19T18:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218577",
    "user": "https://github.com/videlec"
}
```

Let it go!



---

archive/issue_comments_218578.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-19T18:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218578",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_218579.json:
```json
{
    "body": "Hi!\n\nSorry for dropping in so late; this issue dropped out of my mailbox.\n\nThanks for the fix and for the type-checking-free version for\ncartesian products of inverse additive magmas.\n\nThat being said, I'd like to keep the previous implementation (with\nthe fix) for unital magmas. There are cases where this feature can be\nuseful! This ticket is about a fix, not an API change.\n\nAlso, whenever possible:\n\n- Please keep existing doctests.\n- Please keep existing TODO's.\n\nGiven that it's late in the process, reinstating those can be in a\nfollow up ticket if you prefer. But before next release.\n\nTwo notes:\n\n- `an_element` is *not* random. I don't know why the test was marked\n  as such. But in any cases, using `an_element` is usually a nice\n  concise idiom to construct an element on which to do tests.\n\n- I am usually not a big fan of \"coercing silently to a larger\n  universe\". But don't have a strong opinion either. Anyway, this is\n  not directly related to this ticket.\n\n- About `F((xxx,xxx))`: converting from indices of the basis is a nice\n  syntactic sugar indeed. It can't be defined in full generality,\n  because in certain cases there can be ambiguity with coercion from\n  the base ring. For cartesian products, I guess there is no such\n  risk, so that's ok. In any cases that's for user interaction only;\n  in code, one should always use F.term((...)) for genericity and\n  speed.\n\nThanks again!\n                             Nicolas",
    "created_at": "2015-04-20T19:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218579",
    "user": "https://github.com/nthiery"
}
```

Hi!

Sorry for dropping in so late; this issue dropped out of my mailbox.

Thanks for the fix and for the type-checking-free version for
cartesian products of inverse additive magmas.

That being said, I'd like to keep the previous implementation (with
the fix) for unital magmas. There are cases where this feature can be
useful! This ticket is about a fix, not an API change.

Also, whenever possible:

- Please keep existing doctests.
- Please keep existing TODO's.

Given that it's late in the process, reinstating those can be in a
follow up ticket if you prefer. But before next release.

Two notes:

- `an_element` is *not* random. I don't know why the test was marked
  as such. But in any cases, using `an_element` is usually a nice
  concise idiom to construct an element on which to do tests.

- I am usually not a big fan of "coercing silently to a larger
  universe". But don't have a strong opinion either. Anyway, this is
  not directly related to this ticket.

- About `F((xxx,xxx))`: converting from indices of the basis is a nice
  syntactic sugar indeed. It can't be defined in full generality,
  because in certain cases there can be ambiguity with coercion from
  the base ring. For cartesian products, I guess there is no such
  risk, so that's ok. In any cases that's for user interaction only;
  in code, one should always use F.term((...)) for genericity and
  speed.

Thanks again!
                             Nicolas



---

archive/issue_comments_218580.json:
```json
{
    "body": "Hi,\n\nReplying to [comment:20 nthiery]:\n> That being said, I'd like to keep the previous implementation (with\n> the fix) for unital magmas. There are cases where this feature can be\n> useful! This ticket is about a fix, not an API change.\n\nIt was completely wrong with several respects that were discussed here... (the least being not working).\n\n> Also, whenever possible:\n> \n> - Please keep existing doctests.\n> - Please keep existing TODO's.\n\nTrue. I was a bit fast on that #18263.\n\n> Two notes:\n> \n> - `an_element` is *not* random. I don't know why the test was marked\n>   as such. But in any cases, using `an_element` is usually a nice\n>   concise idiom to construct an element on which to do tests.\n\nIt is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.\n\n> - About `F((xxx,xxx))`: converting from indices of the basis is a nice\n>   syntactic sugar indeed. It can't be defined in full generality,\n>   because in certain cases there can be ambiguity with coercion from\n>   the base ring. For cartesian products, I guess there is no such\n>   risk, so that's ok. In any cases that's for user interaction only;\n>   in code, one should always use F.term((...)) for genericity and\n>   speed.\n\nWhat is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?\n\nVincent",
    "created_at": "2015-04-20T20:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218580",
    "user": "https://github.com/videlec"
}
```

Hi,

Replying to [comment:20 nthiery]:
> That being said, I'd like to keep the previous implementation (with
> the fix) for unital magmas. There are cases where this feature can be
> useful! This ticket is about a fix, not an API change.

It was completely wrong with several respects that were discussed here... (the least being not working).

> Also, whenever possible:
> 
> - Please keep existing doctests.
> - Please keep existing TODO's.

True. I was a bit fast on that #18263.

> Two notes:
> 
> - `an_element` is *not* random. I don't know why the test was marked
>   as such. But in any cases, using `an_element` is usually a nice
>   concise idiom to construct an element on which to do tests.

It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.

> - About `F((xxx,xxx))`: converting from indices of the basis is a nice
>   syntactic sugar indeed. It can't be defined in full generality,
>   because in certain cases there can be ambiguity with coercion from
>   the base ring. For cartesian products, I guess there is no such
>   risk, so that's ok. In any cases that's for user interaction only;
>   in code, one should always use F.term((...)) for genericity and
>   speed.

What is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?

Vincent



---

archive/issue_comments_218581.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> It was completely wrong with several respects that were discussed here... (the least being not working).\n\nIt was indeed broken for cartesian products of free modules, but\nworking smoothly and with a well defined behaviour for the other\ncartesian products.\n\nNote by the way that `_neg_` was working smoothly:\n\n```\n    sage: X=CombinatorialFreeModule(ZZ,ZZ)\n    sage: sage: Y=cartesian_product((X,X))\n    sage: x = Y.an_element()\n    sage: x._neg_()\n    -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]\n```\n\n\nProbably we should be consistent, and either use `__neg__` in all\ncases or `_neg_` (which one does not really matter since anyway there\nis no real reason to involve coercion here).\n\n\n> It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.\n\nSo, apparently `an_element` was not implemented properly in\n`PermutationGroup`. By not random, I mean that the result of\n`an_element` is supposed to be reasonably stable over time, in\nparticular so that we can use it in tests. Maybe this should be made\nmore explicit in the specs of `an_element`. And progressively fixed\nwhere it not stable enough.\n\n> > - About `F((xxx,xxx))`: converting from indices of the basis is a nice\n> >   syntactic sugar indeed. It can't be defined in full generality,\n> >   because in certain cases there can be ambiguity with coercion from\n> >   the base ring. For cartesian products, I guess there is no such\n> >   risk, so that's ok. In any cases that's for user interaction only;\n> >   in code, one should always use F.term((...)) for genericity and\n> >   speed.\n> \n> What is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?\n\nSorry, I should have been specific: I was speaking about [comment:7],\nwith `F` being a free module, not the cartesian product indexing its\nbasis.\n\nAmiti\u00e9s,\n                             Nicolas",
    "created_at": "2015-04-20T20:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218581",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:21 vdelecroix]:
> It was completely wrong with several respects that were discussed here... (the least being not working).

It was indeed broken for cartesian products of free modules, but
working smoothly and with a well defined behaviour for the other
cartesian products.

Note by the way that `_neg_` was working smoothly:

```
    sage: X=CombinatorialFreeModule(ZZ,ZZ)
    sage: sage: Y=cartesian_product((X,X))
    sage: x = Y.an_element()
    sage: x._neg_()
    -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]
```


Probably we should be consistent, and either use `__neg__` in all
cases or `_neg_` (which one does not really matter since anyway there
is no real reason to involve coercion here).


> It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.

So, apparently `an_element` was not implemented properly in
`PermutationGroup`. By not random, I mean that the result of
`an_element` is supposed to be reasonably stable over time, in
particular so that we can use it in tests. Maybe this should be made
more explicit in the specs of `an_element`. And progressively fixed
where it not stable enough.

> > - About `F((xxx,xxx))`: converting from indices of the basis is a nice
> >   syntactic sugar indeed. It can't be defined in full generality,
> >   because in certain cases there can be ambiguity with coercion from
> >   the base ring. For cartesian products, I guess there is no such
> >   risk, so that's ok. In any cases that's for user interaction only;
> >   in code, one should always use F.term((...)) for genericity and
> >   speed.
> 
> What is this `term` feature? What is the difference with `_cartesian_product_of_elements`? Why not using `P.element_class(...)` for speed?

Sorry, I should have been specific: I was speaking about [comment:7],
with `F` being a free module, not the cartesian product indexing its
basis.

AmitiÃ©s,
                             Nicolas



---

archive/issue_comments_218582.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-21T00:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218582",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_218583.json:
```json
{
    "body": "Salut Nicolas,\n\nReplying to [comment:22 nthiery]:\n> Replying to [comment:21 vdelecroix]:\n> > It was completely wrong with several respects that were discussed here... (the least being not working).\n> \n> It was indeed broken for cartesian products of free modules, but\n> working smoothly and with a well defined behaviour for the other\n> cartesian products.\n> \n> Note by the way that `_neg_` was working smoothly:\n> {{{\n>     sage: X=CombinatorialFreeModule(ZZ,ZZ)\n>     sage: Y=cartesian_product((X,X))\n>     sage: x = Y.an_element()\n>     sage: x._neg_()\n>     -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]\n> }}}\n\nThis is indeed a bug! `_neg_` should be called but it wasn't!\n\n> Probably we should be consistent, and either use `__neg__` in all\n> cases or `_neg_` (which one does not really matter since anyway there\n> is no real reason to involve coercion here).\n\nI would just use `__neg__` everywhere. It is faster and consistent with Python.\n\n> > It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.\n> \n> So, apparently `an_element` was not implemented properly in\n> `PermutationGroup`.\n\nIt was. The problems were in `modules_with_basis`, `group_algebras`, etc\n\n> By not random, I mean that the result of\n> `an_element` is supposed to be reasonably stable over time, in\n> particular so that we can use it in tests. Maybe this should be made\n> more explicit in the specs of `an_element`. And progressively fixed\n> where it not stable enough.\n\nI am not sure I like example looking like\n\n```\nsage: F = MyBeautifulParent()\nsage: e = F.an_element()\nsage: ... play with e ...\n```\n\nIt is much more useful to document how to create elements! Nobody want to play with `.an_element`. It is useful in doctests but I would say only in the section `TESTS`.\n\nVincent",
    "created_at": "2015-04-21T10:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16599#issuecomment-218583",
    "user": "https://github.com/videlec"
}
```

Salut Nicolas,

Replying to [comment:22 nthiery]:
> Replying to [comment:21 vdelecroix]:
> > It was completely wrong with several respects that were discussed here... (the least being not working).
> 
> It was indeed broken for cartesian products of free modules, but
> working smoothly and with a well defined behaviour for the other
> cartesian products.
> 
> Note by the way that `_neg_` was working smoothly:
> {{{
>     sage: X=CombinatorialFreeModule(ZZ,ZZ)
>     sage: Y=cartesian_product((X,X))
>     sage: x = Y.an_element()
>     sage: x._neg_()
>     -3*B[(0, -1)] - 2*B[(0, 0)] - 2*B[(0, 1)]
> }}}

This is indeed a bug! `_neg_` should be called but it wasn't!

> Probably we should be consistent, and either use `__neg__` in all
> cases or `_neg_` (which one does not really matter since anyway there
> is no real reason to involve coercion here).

I would just use `__neg__` everywhere. It is faster and consistent with Python.

> > It is! Concrete examples: #18239. After modifying the `.list()` of the `PermutationGroup` and the `__hash__` of `PermutationGroupElement` it gets changed in a lot of places (`algebras/group_algebra.py`, `categories/enumerated_sets.py`, `categories/modules_with_basis.py`, ...). But I agree with you that it would have been simpler if they did not. Perhaps by not random you meant that it depends on the hash or on a particular order of something that does not have to be ordered.
> 
> So, apparently `an_element` was not implemented properly in
> `PermutationGroup`.

It was. The problems were in `modules_with_basis`, `group_algebras`, etc

> By not random, I mean that the result of
> `an_element` is supposed to be reasonably stable over time, in
> particular so that we can use it in tests. Maybe this should be made
> more explicit in the specs of `an_element`. And progressively fixed
> where it not stable enough.

I am not sure I like example looking like

```
sage: F = MyBeautifulParent()
sage: e = F.an_element()
sage: ... play with e ...
```

It is much more useful to document how to create elements! Nobody want to play with `.an_element`. It is useful in doctests but I would say only in the section `TESTS`.

Vincent
