# Issue 15030: Switch standard 2D plotting from `fast_float` to `fast_callable`

archive/issues_014793.json:
```json
{
    "body": "Switch the `plot` command to use `fast_callable` instead of `fast_float`. This will make commands like `plot(abs(log(x)), x)` work.\n\nKeywords: plot\n\nWork Issues: compare patch with alternative by ppurka\n\nReviewer: Ralf Stephan\n\nAuthor: Eviatar Bach\n\nBranch: 7a9e07abeaf14171706e407173a342810031e200\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15030\n\n",
    "closed_at": "2014-04-14T19:57:29Z",
    "created_at": "2013-08-10T09:39:20Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Switch standard 2D plotting from `fast_float` to `fast_callable`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15030",
    "user": "https://github.com/eviatarbach"
}
```
Switch the `plot` command to use `fast_callable` instead of `fast_float`. This will make commands like `plot(abs(log(x)), x)` work.

Keywords: plot

Work Issues: compare patch with alternative by ppurka

Reviewer: Ralf Stephan

Author: Eviatar Bach

Branch: 7a9e07abeaf14171706e407173a342810031e200

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15030





---

archive/issue_comments_236717.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [trac15030.patch](tarball://root/attachments/some-uuid/ticket15030/trac15030.patch) by @eviatarbach created at 2013-08-10 10:04:48\n\nThe patch changes `plot` to use `fast_callable`. It doesn't fix `contour_plot` or `plot3d`, for example, since that seems to be more involved, and should be fixed in a future patch.\n\nPatchbot apply trac15030.patch\u200b",
    "created_at": "2013-08-10T10:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236717",
    "user": "https://github.com/eviatarbach"
}
```

<a id='comment:1'></a>
Attachment [trac15030.patch](tarball://root/attachments/some-uuid/ticket15030/trac15030.patch) by @eviatarbach created at 2013-08-10 10:04:48

The patch changes `plot` to use `fast_callable`. It doesn't fix `contour_plot` or `plot3d`, for example, since that seems to be more involved, and should be fixed in a future patch.

Patchbot apply trac15030.patchâ€‹



---

archive/issue_comments_236718.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-10T10:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236718",
    "user": "https://github.com/eviatarbach"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_236719.json:
```json
{
    "body": "<a id='comment:2'></a>\nThanks for looking into this important issue!\n\nDid you check to see what the performance implications of your patch are? I assume that `fast_float` is faster than `fast_callable`, but that is not based on any data.",
    "created_at": "2013-08-16T07:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236719",
    "user": "https://github.com/tkluck"
}
```

<a id='comment:2'></a>
Thanks for looking into this important issue!

Did you check to see what the performance implications of your patch are? I assume that `fast_float` is faster than `fast_callable`, but that is not based on any data.



---

archive/issue_comments_236720.json:
```json
{
    "body": "<a id='comment:3'></a>\nYes, `fast_float` is slightly faster in my tests. However, I think the plan is to deprecate `fast_float` anyway; see #5572.",
    "created_at": "2013-08-16T23:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236720",
    "user": "https://github.com/eviatarbach"
}
```

<a id='comment:3'></a>
Yes, `fast_float` is slightly faster in my tests. However, I think the plan is to deprecate `fast_float` anyway; see #5572.



---

archive/issue_comments_236721.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis doesn't really fix #13559. Do you have an idea why? I thought this change to `fast_callable` should take care of that other ticket too.",
    "created_at": "2013-09-25T14:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236721",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:4'></a>
This doesn't really fix #13559. Do you have an idea why? I thought this change to `fast_callable` should take care of that other ticket too.



---

archive/issue_comments_236722.json:
```json
{
    "body": "<a id='comment:5'></a>\nI think it's because `plot` (look at the function `generate_plot_points` in `sage.plot.plot`) generates float points, and\n\n```\nsage: exp(1e5r)\nOverflowError: math range error\n```\n\nMaybe it should generate RealNumber points instead (I guess they should also be faster than floats for many functions, because MPFR functions are functions are fast)? In any case, that doesn't affect this ticket.",
    "created_at": "2013-09-26T05:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236722",
    "user": "https://github.com/eviatarbach"
}
```

<a id='comment:5'></a>
I think it's because `plot` (look at the function `generate_plot_points` in `sage.plot.plot`) generates float points, and

```
sage: exp(1e5r)
OverflowError: math range error
```

Maybe it should generate RealNumber points instead (I guess they should also be faster than floats for many functions, because MPFR functions are functions are fast)? In any case, that doesn't affect this ticket.



---

archive/issue_comments_236723.json:
```json
{
    "body": "<a id='comment:6'></a>\nHmm.. so, you are changing only the plots for symbolic expressions. This patch makes the symbolic expression plots about five times slower.\n\n```\nsage: timeit('plot(abs(log(x)), (x, -20, 20))') # with patch\n25 loops, best of 3: 18.5 ms per loop\n\nsage: timeit('plot(abs(log(x)), (x, -20, 20))') # without patch\n125 loops, best of 3: 3.58 ms per loop\n```\n\nWhat do you think of the following change which introduces only a factor of two slowdown? The main problem seems to be that the fast float stuff does not handle complex numbers, and so we can explicitly specify the domain as CDF. I am not sure what is the default domain.\n\n```\n+        from sage.ext.fast_callable import fast_callable\n+        from sage.rings.all import CDF\n+        return fast_callable(self, vars=vars, expect_one_var=True,\n+                             domain=CDF)\n```\n\nThe timeit results are as follows:\n\n```\nsage: timeit('plot(abs(log(x)), (x, -20, 20))')\n125 loops, best of 3: 6 ms per loop\n```\nA few doctests in `expression.pyx` fail, but they can be fixed (by changing their output).",
    "created_at": "2013-09-28T11:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236723",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:6'></a>
Hmm.. so, you are changing only the plots for symbolic expressions. This patch makes the symbolic expression plots about five times slower.

```
sage: timeit('plot(abs(log(x)), (x, -20, 20))') # with patch
25 loops, best of 3: 18.5 ms per loop

sage: timeit('plot(abs(log(x)), (x, -20, 20))') # without patch
125 loops, best of 3: 3.58 ms per loop
```

What do you think of the following change which introduces only a factor of two slowdown? The main problem seems to be that the fast float stuff does not handle complex numbers, and so we can explicitly specify the domain as CDF. I am not sure what is the default domain.

```
+        from sage.ext.fast_callable import fast_callable
+        from sage.rings.all import CDF
+        return fast_callable(self, vars=vars, expect_one_var=True,
+                             domain=CDF)
```

The timeit results are as follows:

```
sage: timeit('plot(abs(log(x)), (x, -20, 20))')
125 loops, best of 3: 6 ms per loop
```
A few doctests in `expression.pyx` fail, but they can be fixed (by changing their output).



---

archive/issue_events_043204.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15030#event-43204"
}
```



---

archive/issue_comments_236724.json:
```json
{
    "body": "Changing work_issues from \"\" to \"compare patch with alternative by ppurka\"",
    "created_at": "2014-04-03T09:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236724",
    "user": "https://github.com/rwst"
}
```

Changing work_issues from "" to "compare patch with alternative by ppurka"



---

archive/issue_comments_236725.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-04-03T09:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236725",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_236726.json:
```json
{
    "body": "Changing branch from \"\" to \"u/rws/switch_standard_2d_plotting_from__fast_float__to__fast_callable_\"",
    "created_at": "2014-04-13T16:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236726",
    "user": "https://github.com/rwst"
}
```

Changing branch from "" to "u/rws/switch_standard_2d_plotting_from__fast_float__to__fast_callable_"



---

archive/issue_comments_236727.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-04-13T16:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236727",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_236728.json:
```json
{
    "body": "Changing keywords from \"\" to \"plot\".",
    "created_at": "2014-04-13T16:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236728",
    "user": "https://github.com/rwst"
}
```

Changing keywords from "" to "plot".



---

archive/issue_comments_236729.json:
```json
{
    "body": "Changing commit from \"\" to \"7a9e07abeaf14171706e407173a342810031e200\"",
    "created_at": "2014-04-13T16:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236729",
    "user": "https://github.com/rwst"
}
```

Changing commit from "" to "7a9e07abeaf14171706e407173a342810031e200"



---

archive/issue_comments_236730.json:
```json
{
    "body": "<a id='comment:10'></a>\n\n```\n                                                           this patch    before\nsage: timeit('plot(abs(log(x)), (x, -20, 20))')            11.4 ms         2.4\nsage: timeit('circle((1,1), 1) + plot(x^2, (x,0,5))')       2.7 ms         2.3\nsage: timeit('plot(x^2,(x,300,500),ticks=[None,50000])')   10.8 ms         9.4\nsage: i = CDF.0      # define i this way for maximum speed.\nsage: timeit('plot(lambda t: arg(zeta(0.5+t*i)), 1,27,rgbcolor=(0.8,0,0))')\n                                                           52.2 ms        52.2\nsage: timeit('plot([sin(n*x) for n in [1..4]], (0, pi))')  10.4 ms        10.2\nsage: f = (2*x^3+2*x-1)/((x-2)*(x+1))\nsage: timeit('plot([f, 2*x+2], -7,7, fill = {0: [1]})')    11.2 ms        11.1\n```\nso, in my opinion, there is only a slowdown where the original behaviour was incorrect. It is not correct to say \"This patch makes the symbolic expression plots about five times slower.\"\n\nI rebased the patch on 6.2.beta7. LGTM and tests fine in `plot/` and `symbolic/`.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[7a9e07a](http://git.sagemath.org/sage.git/commit/?id=7a9e07abeaf14171706e407173a342810031e200)|`Trac 15030: replace fast_float with fast_callable in 2D plotting`|",
    "created_at": "2014-04-13T16:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236730",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>

```
                                                           this patch    before
sage: timeit('plot(abs(log(x)), (x, -20, 20))')            11.4 ms         2.4
sage: timeit('circle((1,1), 1) + plot(x^2, (x,0,5))')       2.7 ms         2.3
sage: timeit('plot(x^2,(x,300,500),ticks=[None,50000])')   10.8 ms         9.4
sage: i = CDF.0      # define i this way for maximum speed.
sage: timeit('plot(lambda t: arg(zeta(0.5+t*i)), 1,27,rgbcolor=(0.8,0,0))')
                                                           52.2 ms        52.2
sage: timeit('plot([sin(n*x) for n in [1..4]], (0, pi))')  10.4 ms        10.2
sage: f = (2*x^3+2*x-1)/((x-2)*(x+1))
sage: timeit('plot([f, 2*x+2], -7,7, fill = {0: [1]})')    11.2 ms        11.1
```
so, in my opinion, there is only a slowdown where the original behaviour was incorrect. It is not correct to say "This patch makes the symbolic expression plots about five times slower."

I rebased the patch on 6.2.beta7. LGTM and tests fine in `plot/` and `symbolic/`.

---
New commits:
|                                                                                                                                          |                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[7a9e07a](http://git.sagemath.org/sage.git/commit/?id=7a9e07abeaf14171706e407173a342810031e200)|`Trac 15030: replace fast_float with fast_callable in 2D plotting`|



---

archive/issue_comments_236731.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ralf Stephan\"",
    "created_at": "2014-04-13T16:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236731",
    "user": "https://github.com/rwst"
}
```

Changing reviewer from "" to "Ralf Stephan"



---

archive/issue_comments_236732.json:
```json
{
    "body": "Changing author from \"\" to \"Eviatar Bach\"",
    "created_at": "2014-04-13T16:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236732",
    "user": "https://github.com/rwst"
}
```

Changing author from "" to "Eviatar Bach"



---

archive/issue_comments_236733.json:
```json
{
    "body": "Changing branch from \"u/rws/switch_standard_2d_plotting_from__fast_float__to__fast_callable_\" to \"7a9e07abeaf14171706e407173a342810031e200\"",
    "created_at": "2014-04-14T19:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236733",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/rws/switch_standard_2d_plotting_from__fast_float__to__fast_callable_" to "7a9e07abeaf14171706e407173a342810031e200"



---

archive/issue_comments_236734.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-14T19:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236734",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_043205.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-14T19:57:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15030#event-43205"
}
```



---

archive/issue_comments_236735.json:
```json
{
    "body": "Changing commit from \"7a9e07abeaf14171706e407173a342810031e200\" to \"\"",
    "created_at": "2014-04-21T13:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236735",
    "user": "https://github.com/kcrisman"
}
```

Changing commit from "7a9e07abeaf14171706e407173a342810031e200" to ""



---

archive/issue_comments_236736.json:
```json
{
    "body": "<a id='comment:12'></a>\nNote that #13355 which is related, if not the same...\n\nAlso, anyone know how this impacts 3d plots?",
    "created_at": "2014-04-21T13:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236736",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:12'></a>
Note that #13355 which is related, if not the same...

Also, anyone know how this impacts 3d plots?



---

archive/issue_comments_236737.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [kcrisman](#comment%3A12):\n> Also, anyone know how this impacts 3d plots?\n\nI believe this has no impact on 3d plots. 3d plots from 2d objects goes via `.plot3d()` methods which usually just take the already generated data points. 3d plots created directly are not affected by this patch.",
    "created_at": "2014-05-11T07:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15030#issuecomment-236737",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:13'></a>
Replying to [kcrisman](#comment%3A12):
> Also, anyone know how this impacts 3d plots?

I believe this has no impact on 3d plots. 3d plots from 2d objects goes via `.plot3d()` methods which usually just take the already generated data points. 3d plots created directly are not affected by this patch.
