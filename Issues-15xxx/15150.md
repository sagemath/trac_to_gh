# Issue 15150: Problem with path security check if owned by a non-primary group

archive/issues_015150.json:
```json
{
    "body": "CC:  scmancuso\n\nConsider the following scenario:\n\n```\n$ cd /tmp\n$ mkdir U\n$ chmod 770 U\n$ cd U\n$ touch test.py\n$ umask 022\n$ sage -t test.py # this fails as expected\n$ umask 002\n$ sage -t test.py # this fails, but succeeds on non-OSX systems or other directories besides /tmp\n```\nSince OS X always sets the group of files in `/tmp` to `wheel`, this doesn' work.\n\nThis scenario is encountered whenever a user works in a directory that is owned and writeable by a group that is not the primary group of the user (and hence not the GID of sage when the user runs it).\n\nSee also\n[sage-support](https://groups.google.com/forum/?hl=en#!topic/sage-support/bmOxR3BgXBI) for a real-life situation where someone encountered that scenario.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15387\n\n",
    "created_at": "2013-11-08T23:01:17Z",
    "labels": [
        "component: porting",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Problem with path security check if owned by a non-primary group",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15150",
    "user": "https://github.com/nbruin"
}
```
CC:  scmancuso

Consider the following scenario:

```
$ cd /tmp
$ mkdir U
$ chmod 770 U
$ cd U
$ touch test.py
$ umask 022
$ sage -t test.py # this fails as expected
$ umask 002
$ sage -t test.py # this fails, but succeeds on non-OSX systems or other directories besides /tmp
```
Since OS X always sets the group of files in `/tmp` to `wheel`, this doesn' work.

This scenario is encountered whenever a user works in a directory that is owned and writeable by a group that is not the primary group of the user (and hence not the GID of sage when the user runs it).

See also
[sage-support](https://groups.google.com/forum/?hl=en#!topic/sage-support/bmOxR3BgXBI) for a real-life situation where someone encountered that scenario.

Issue created by migration from https://trac.sagemath.org/ticket/15387





---

archive/issue_comments_194176.json:
```json
{
    "body": "Changing component from misc to porting.",
    "created_at": "2013-11-11T10:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194176",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from misc to porting.



---

archive/issue_comments_194177.json:
```json
{
    "body": "I can confirm that the exact script executed on OSX outside /tmp does seem to work. Nonetheless, the original reporter of the problem (who is scmancuso?) seems to have a problem outside /tmp. I think he is running into exactly the same problem as with `/tmp`:\n- Having a directory writeable by `wheel` is basically safe: people with `wheel` permission are sort of `root` anyway.\n- In his situation, he considers `RESEARCH_GROUP` to be safe. He is probably a member of that group, but it's not his primary group.\n\nThe code only considers groups \"safe\" if the gid of the group equals the gid of the group-writeable current directory. I think this example shows that this is too restrictive and it is unnecessarily onerous to require the user in this situation to make the \"sage\" process \"setgrp\" to `RESEARCH_GROUP`\n\nTo illustrate the problem, let's assume that `everyone` (despite the name) is a \"trusted\" group to which I belong and for which I intentionally want to make the directory writeable:\n\n```\n$ mkdir U       #now the group of U is my primary gid.\n$ chmod 770 U\n$ umask 002\n$ cd U\n$ touch test.py\n$ ../sage -t test.py\nTHIS WORKS\n$ chgrp everyone . #this is a group I am a member of, but it's not my primary gid\n$ ../sage -t test.py\nRuntimeError: refusing to run doctests from the current directory '/scratch/nbruin/U' since untrusted users could put files in this directory, making it unsafe to run Sage code from\n```\nI think we simply don't have enough information to decide which groups are \"safe\" and which are not. In absence of a file that we can use as a model of the acceptable permissions, using \"umask\" is a possible substitute (although a bit of a misuse), but using the process GID as a substitute of the required GID of the current directory is simply not a good substitute. People don't have enough control over their primary GID and they can have good reasons to consider non-primary groups safe.",
    "created_at": "2013-11-11T22:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194177",
    "user": "https://github.com/nbruin"
}
```

I can confirm that the exact script executed on OSX outside /tmp does seem to work. Nonetheless, the original reporter of the problem (who is scmancuso?) seems to have a problem outside /tmp. I think he is running into exactly the same problem as with `/tmp`:
- Having a directory writeable by `wheel` is basically safe: people with `wheel` permission are sort of `root` anyway.
- In his situation, he considers `RESEARCH_GROUP` to be safe. He is probably a member of that group, but it's not his primary group.

The code only considers groups "safe" if the gid of the group equals the gid of the group-writeable current directory. I think this example shows that this is too restrictive and it is unnecessarily onerous to require the user in this situation to make the "sage" process "setgrp" to `RESEARCH_GROUP`

To illustrate the problem, let's assume that `everyone` (despite the name) is a "trusted" group to which I belong and for which I intentionally want to make the directory writeable:

```
$ mkdir U       #now the group of U is my primary gid.
$ chmod 770 U
$ umask 002
$ cd U
$ touch test.py
$ ../sage -t test.py
THIS WORKS
$ chgrp everyone . #this is a group I am a member of, but it's not my primary gid
$ ../sage -t test.py
RuntimeError: refusing to run doctests from the current directory '/scratch/nbruin/U' since untrusted users could put files in this directory, making it unsafe to run Sage code from
```
I think we simply don't have enough information to decide which groups are "safe" and which are not. In absence of a file that we can use as a model of the acceptable permissions, using "umask" is a possible substitute (although a bit of a misuse), but using the process GID as a substitute of the required GID of the current directory is simply not a good substitute. People don't have enough control over their primary GID and they can have good reasons to consider non-primary groups safe.



---

archive/issue_comments_194178.json:
```json
{
    "body": "One solution is to simply remove the lines:\n\n```\n+        /* Only keep group bit if the current group ID is the same as\n+         * the group of \"parent\" */\n+        if (getgid() != parent_stat.st_gid)\n+            arg_stat.st_mode &= 0707;\n```\nwith the rationale that the process gid is meant for the *system* to determine for which operations it should trust the *process*. It doesn't give information about which *other groups* this *process* should trust. That information is simply not available.\n\nAny alternatives?",
    "created_at": "2013-11-15T01:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194178",
    "user": "https://github.com/nbruin"
}
```

One solution is to simply remove the lines:

```
+        /* Only keep group bit if the current group ID is the same as
+         * the group of "parent" */
+        if (getgid() != parent_stat.st_gid)
+            arg_stat.st_mode &= 0707;
```
with the rationale that the process gid is meant for the *system* to determine for which operations it should trust the *process*. It doesn't give information about which *other groups* this *process* should trust. That information is simply not available.

Any alternatives?



---

archive/issue_comments_194179.json:
```json
{
    "body": "Replying to [comment:6 nbruin]:\n> Any alternatives?\n\nUse `getgroups()` to get **all** the groups that somebody is a member of.",
    "created_at": "2013-11-22T14:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194179",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 nbruin]:
> Any alternatives?

Use `getgroups()` to get **all** the groups that somebody is a member of.



---

archive/issue_comments_194180.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Replying to [comment:6 nbruin]:\n> > Any alternatives?\n\n> Use `getgroups()` to get **all** the groups that somebody is a member of.\n\nYes, that would solve the problem, but it's not clear to me that that is truly more secure than just ignoring the process group altogether. Imagine:\n\n```\n$ id\nuid=...(me) gid=...(wheel) groups=...(wheel),...(www_devel),...(unwashed_masses)\n$ ls -dl .\ndrwxrwx--x wheel unwashed_masses [...] ./\n$ umask 002\n$ sage -t module.py\n```\nThis user `me` has write permission anywhere where all members of `unwashed_masses` have write permission, but `me` has many more privileges as well. A longer `getgroups()` indicates a MORE privileged UID, so normally one would think one should be LESS liberal in executing code under that UID. Considering all the groups returned by `getgroups()` as trusted when `umask 002` is in effect would have exactly the opposite effect.\n\nTrust relations in security are often asymmetric and unfortunately it doesn't seem POSIX provides a way to obtain the information in the direction we are interested in (I don't think that information is formalized in the system).\n\nI am fine with doing the `getgroups()` check, because it is an improvement in terms of usability over what we have now and I think in most scenarios it will allow things that should be allowed.\n\nIt is a little less permissive than just not considering groups at all upon `umask 002`, so it may seem a little more secure, but I have trouble defining/justifying the security model it would be following, and programming the `getgroups()` thing is quite a bit more work. \n\nTherefore, my default would be just dropping the `getgid() != parent_stat.st_gid`.",
    "created_at": "2013-11-22T20:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194180",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 nbruin]:
> > Any alternatives?

> Use `getgroups()` to get **all** the groups that somebody is a member of.

Yes, that would solve the problem, but it's not clear to me that that is truly more secure than just ignoring the process group altogether. Imagine:

```
$ id
uid=...(me) gid=...(wheel) groups=...(wheel),...(www_devel),...(unwashed_masses)
$ ls -dl .
drwxrwx--x wheel unwashed_masses [...] ./
$ umask 002
$ sage -t module.py
```
This user `me` has write permission anywhere where all members of `unwashed_masses` have write permission, but `me` has many more privileges as well. A longer `getgroups()` indicates a MORE privileged UID, so normally one would think one should be LESS liberal in executing code under that UID. Considering all the groups returned by `getgroups()` as trusted when `umask 002` is in effect would have exactly the opposite effect.

Trust relations in security are often asymmetric and unfortunately it doesn't seem POSIX provides a way to obtain the information in the direction we are interested in (I don't think that information is formalized in the system).

I am fine with doing the `getgroups()` check, because it is an improvement in terms of usability over what we have now and I think in most scenarios it will allow things that should be allowed.

It is a little less permissive than just not considering groups at all upon `umask 002`, so it may seem a little more secure, but I have trouble defining/justifying the security model it would be following, and programming the `getgroups()` thing is quite a bit more work. 

Therefore, my default would be just dropping the `getgid() != parent_stat.st_gid`.



---

archive/issue_events_044716.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15150#event-44716"
}
```



---

archive/issue_events_044717.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15150#event-44717"
}
```



---

archive/issue_events_044718.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15150#event-44718"
}
```



---

archive/issue_events_044719.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15150#event-44719"
}
```



---

archive/issue_events_044720.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15150#event-44720"
}
```



---

archive/issue_comments_194181.json:
```json
{
    "body": "I'm finding this annoying too:\n\n```\n$ ll -Zd .\ndrwxrwxr-x. vbraun vbraun unconfined_u:object_r:user_home_t:s0 .\n$ sage\nsys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.\nUntrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Sage Version 6.4.beta6, Release Date: 2014-10-14                   \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```",
    "created_at": "2014-11-11T23:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194181",
    "user": "https://github.com/vbraun"
}
```

I'm finding this annoying too:

```
$ ll -Zd .
drwxrwxr-x. vbraun vbraun unconfined_u:object_r:user_home_t:s0 .
$ sage
sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.4.beta6, Release Date: 2014-10-14                   │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
```



---

archive/issue_comments_194182.json:
```json
{
    "body": "I'm not sure that your patch is the right solution, but the problem is that there is no \"right\" solution here. We simply cannot determine which groups are \"trusted\".\n\n---\nNew commits:",
    "created_at": "2014-11-20T09:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194182",
    "user": "https://github.com/jdemeyer"
}
```

I'm not sure that your patch is the right solution, but the problem is that there is no "right" solution here. We simply cannot determine which groups are "trusted".

---
New commits:



---

archive/issue_comments_194183.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> I'm finding this annoying too:\n> \n> ```\n> $ ll -Zd .\n> drwxrwxr-x. vbraun vbraun unconfined_u:object_r:user_home_t:s0 .\n> $ sage\n> sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.\n> Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory}}}\n\n\nWhat's your `id -a`?",
    "created_at": "2014-11-20T09:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15150#issuecomment-194183",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 vbraun]:
> I'm finding this annoying too:
> 
> ```
> $ ll -Zd .
> drwxrwxr-x. vbraun vbraun unconfined_u:object_r:user_home_t:s0 .
> $ sage
> sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
> Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory}}}


What's your `id -a`?
