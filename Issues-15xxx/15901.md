# Issue 15901: git-related doctest failures after moving sage installation

archive/issues_015664.json:
```json
{
    "body": "CC:  @ppurka\n\nKeywords: doctest, git, relocate\n\nI've compiled sage in `/local/data/krenn/sage-dev/sage-6.1.1` and then moved it to another directory. I am getting the following when testing sage:\n\n```\nFile \"src/sage/dev/test/config.py\", line 43, in sage.dev.test.config.DoctestConfig\nFailed example:\n    DoctestConfig()\nExpected:\n    Config('''\n    [trac]\n    username = doctest\n    ticket_cache = ...\n    [UI]\n    log_level = 1\n    [git]\n    ssh_key_set = True\n    repository_anonymous = remote_repository_undefined\n    repository = remote_repository_undefined\n    src = ...\n    dot_git = ...\n    [sagedev]\n    ''')\nGot:\n    warning: templates not found /local/data/krenn/sage-dev/sage-6.1.1/local/share/git-core/templates\n    Config('''\n    [trac]\n    username = doctest\n    ticket_cache = /home/krenn/.sage/temp/brown/8826/dir_0ABZH9/ticket_cache\n    [UI]\n    log_level = 1\n    [git]\n    ssh_key_set = True\n    repository_anonymous = remote_repository_undefined\n    repository = remote_repository_undefined\n    src = /home/blub/.sage/temp/brown/8826/dir_0ABZH9/repo\n    dot_git = /home/blub/.sage/temp/brown/8826/dir_0ABZH9/repo/.git\n    user.name = doctest\n    user.email = doc@test.test\n    user_email_set = True\n    [sagedev]\n    ''')\n```\nThere are a couple of other files with similar warnings.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15901\n\n",
    "closed_at": "2014-05-08T11:50:47Z",
    "created_at": "2014-03-06T16:50:31Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "git-related doctest failures after moving sage installation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15901",
    "user": "https://github.com/dkrenn"
}
```
CC:  @ppurka

Keywords: doctest, git, relocate

I've compiled sage in `/local/data/krenn/sage-dev/sage-6.1.1` and then moved it to another directory. I am getting the following when testing sage:

```
File "src/sage/dev/test/config.py", line 43, in sage.dev.test.config.DoctestConfig
Failed example:
    DoctestConfig()
Expected:
    Config('''
    [trac]
    username = doctest
    ticket_cache = ...
    [UI]
    log_level = 1
    [git]
    ssh_key_set = True
    repository_anonymous = remote_repository_undefined
    repository = remote_repository_undefined
    src = ...
    dot_git = ...
    [sagedev]
    ''')
Got:
    warning: templates not found /local/data/krenn/sage-dev/sage-6.1.1/local/share/git-core/templates
    Config('''
    [trac]
    username = doctest
    ticket_cache = /home/krenn/.sage/temp/brown/8826/dir_0ABZH9/ticket_cache
    [UI]
    log_level = 1
    [git]
    ssh_key_set = True
    repository_anonymous = remote_repository_undefined
    repository = remote_repository_undefined
    src = /home/blub/.sage/temp/brown/8826/dir_0ABZH9/repo
    dot_git = /home/blub/.sage/temp/brown/8826/dir_0ABZH9/repo/.git
    user.name = doctest
    user.email = doc@test.test
    user_email_set = True
    [sagedev]
    ''')
```
There are a couple of other files with similar warnings.

Issue created by migration from https://trac.sagemath.org/ticket/15901





---

archive/issue_comments_202486.json:
```json
{
    "body": "FYI: A manual fix is to use\n\n```\nrm local/var/lib/sage/installed/git-1.8.4.4\nmake\n```\nto rebuild git.",
    "created_at": "2014-03-26T16:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202486",
    "user": "https://github.com/dkrenn"
}
```

FYI: A manual fix is to use

```
rm local/var/lib/sage/installed/git-1.8.4.4
make
```
to rebuild git.



---

archive/issue_comments_202487.json:
```json
{
    "body": "Replying to [comment:1 dkrenn]:\n> FYI: A manual fix is to use\n> \n> ```\n> rm local/var/lib/sage/installed/git-1.8.4.4\n> make\n> ```\n> to rebuild git.\n\n\nOr just\n\n```\n./sage -f git\n```",
    "created_at": "2014-04-03T23:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202487",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:1 dkrenn]:
> FYI: A manual fix is to use
> 
> ```
> rm local/var/lib/sage/installed/git-1.8.4.4
> make
> ```
> to rebuild git.


Or just

```
./sage -f git
```



---

archive/issue_comments_202488.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-02T20:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202488",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_202489.json:
```json
{
    "body": "Here's an attempt at a patch. Works for me.\n\n---\nNew commits:",
    "created_at": "2014-05-02T20:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202489",
    "user": "https://github.com/jhpalmieri"
}
```

Here's an attempt at a patch. Works for me.

---
New commits:



---

archive/issue_comments_202490.json:
```json
{
    "body": "How do you compile sage after this?\n\n```\nsage --dev checkout --ticket 15901\nsage -btp --long src/sage/dev\n```\ndoes not work.\n\nEven the following doesn't work\n\n```\ncp {src,local}/bin/sage-env\nsage -btp --long src/sage/dev\n```",
    "created_at": "2014-05-03T13:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202490",
    "user": "https://github.com/ppurka"
}
```

How do you compile sage after this?

```
sage --dev checkout --ticket 15901
sage -btp --long src/sage/dev
```
does not work.

Even the following doesn't work

```
cp {src,local}/bin/sage-env
sage -btp --long src/sage/dev
```



---

archive/issue_comments_202491.json:
```json
{
    "body": "Replying to [comment:5 ppurka]:\n> How do you compile sage after this?\n\n\nYou have to touch the `src/sage/dev/[test/]` Python files (or remove their `.pyc` files).\n\n(I *think*.)",
    "created_at": "2014-05-03T13:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202491",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:5 ppurka]:
> How do you compile sage after this?


You have to touch the `src/sage/dev/[test/]` Python files (or remove their `.pyc` files).

(I *think*.)



---

archive/issue_comments_202492.json:
```json
{
    "body": "Ahem, or maybe something else... 8-)",
    "created_at": "2014-05-03T13:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202492",
    "user": "https://github.com/nexttime"
}
```

Ahem, or maybe something else... 8-)



---

archive/issue_comments_202493.json:
```json
{
    "body": "Hmm. I guess I should have said \"Worked for me yesterday on one machine.\" I can't get it to work today on a different machine (and haven't tried on the first one yet).",
    "created_at": "2014-05-03T16:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202493",
    "user": "https://github.com/jhpalmieri"
}
```

Hmm. I guess I should have said "Worked for me yesterday on one machine." I can't get it to work today on a different machine (and haven't tried on the first one yet).



---

archive/issue_comments_202494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-05T19:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202494",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202495.json:
```json
{
    "body": "Okay, here's another attempt. Please try this one. (I hope that just `sage -tp src/sage/dev` works. There are no changes to Python files, so `sage -b` should be unnecessary.)",
    "created_at": "2014-05-05T19:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202495",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, here's another attempt. Please try this one. (I hope that just `sage -tp src/sage/dev` works. There are no changes to Python files, so `sage -b` should be unnecessary.)



---

archive/issue_events_046771.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15901#event-46771"
}
```



---

archive/issue_comments_202496.json:
```json
{
    "body": "This must explain the failures in the first patchbot run of 6.2 (`http://patchbot.sagemath.org/ticket/0/`, 2014-05-06 20:45:32 +0100); I made a fresh Sage install for experimenting with the patchbot, but then decided to move it.  Patchbot is now running in the original location, but I'll try this patch on another copy.",
    "created_at": "2014-05-06T23:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202496",
    "user": "https://github.com/pjbruin"
}
```

This must explain the failures in the first patchbot run of 6.2 (`http://patchbot.sagemath.org/ticket/0/`, 2014-05-06 20:45:32 +0100); I made a fresh Sage install for experimenting with the patchbot, but then decided to move it.  Patchbot is now running in the original location, but I'll try this patch on another copy.



---

archive/issue_comments_202497.json:
```json
{
    "body": "The patchbot instance is now getting doctest failures in `sage/plot/plot.py`:\n\n```\nRuntimeError: Could not open facefile /home/pbruin/src/sage/local/lib/python2.7/site-packages/matplotlib-1.3.1-py2.7-linux-x86_64.egg/matplotlib/mpl-data/fonts/ttf/Vera.ttf; Cannot_Open_Resource\n```\nThe directory it is looking in is where my *other* Sage copy was before moving that copy to test this ticket!  The path seems to have been obtained from a cache living in my home directory: `~/.cache/matplotlib/fontList.cache`.  Does this mean that `sage-location` potentially has to worry about hardcoded paths existing in `$DOT_SAGE`?",
    "created_at": "2014-05-06T23:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202497",
    "user": "https://github.com/pjbruin"
}
```

The patchbot instance is now getting doctest failures in `sage/plot/plot.py`:

```
RuntimeError: Could not open facefile /home/pbruin/src/sage/local/lib/python2.7/site-packages/matplotlib-1.3.1-py2.7-linux-x86_64.egg/matplotlib/mpl-data/fonts/ttf/Vera.ttf; Cannot_Open_Resource
```
The directory it is looking in is where my *other* Sage copy was before moving that copy to test this ticket!  The path seems to have been obtained from a cache living in my home directory: `~/.cache/matplotlib/fontList.cache`.  Does this mean that `sage-location` potentially has to worry about hardcoded paths existing in `$DOT_SAGE`?



---

archive/issue_comments_202498.json:
```json
{
    "body": "Curiously, sometime after the above failures in `sage/plot`, my patchbot copy of Sage seems to have updated the paths in `~/.cache/matplotlib`.  Anyway, I can confirm that the failures in `sage/dev` are fixed by this patch.",
    "created_at": "2014-05-06T23:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202498",
    "user": "https://github.com/pjbruin"
}
```

Curiously, sometime after the above failures in `sage/plot`, my patchbot copy of Sage seems to have updated the paths in `~/.cache/matplotlib`.  Anyway, I can confirm that the failures in `sage/dev` are fixed by this patch.



---

archive/issue_comments_202499.json:
```json
{
    "body": "Replying to [comment:14 pbruin]:\n> I can confirm that the failures in `sage/dev` are fixed by this patch.\n... which should be enough for a positive review.  If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.",
    "created_at": "2014-05-07T19:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202499",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:14 pbruin]:
> I can confirm that the failures in `sage/dev` are fixed by this patch.
... which should be enough for a positive review.  If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.



---

archive/issue_comments_202500.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-07T19:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202500",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_202501.json:
```json
{
    "body": "Replying to [comment:15 pbruin]:\n> Replying to [comment:14 pbruin]:\n> > I can confirm that the failures in `sage/dev` are fixed by this patch.\n\n> ... which should be enough for a positive review.  If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.\n\nThen we should probably also change the ticket's title accordingly.",
    "created_at": "2014-05-07T19:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202501",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:15 pbruin]:
> Replying to [comment:14 pbruin]:
> > I can confirm that the failures in `sage/dev` are fixed by this patch.

> ... which should be enough for a positive review.  If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.

Then we should probably also change the ticket's title accordingly.



---

archive/issue_comments_202502.json:
```json
{
    "body": "Replying to [comment:15 pbruin]:\n> If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.\n\n\nThis really deserves its own ticket (and btw. is pretty unrelated to relocating Sage; just imagine having different versions of Sage running at the same time).\n\nIMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).",
    "created_at": "2014-05-07T19:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202502",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:15 pbruin]:
> If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.


This really deserves its own ticket (and btw. is pretty unrelated to relocating Sage; just imagine having different versions of Sage running at the same time).

IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).



---

archive/issue_comments_202503.json:
```json
{
    "body": "Replying to [comment:17 leif]:\n> IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).\n\n\n... or probably `$SAGE_LOCAL/var/{lib,tmp}/matplotlib/...`",
    "created_at": "2014-05-07T19:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202503",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:17 leif]:
> IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).


... or probably `$SAGE_LOCAL/var/{lib,tmp}/matplotlib/...`



---

archive/issue_comments_202504.json:
```json
{
    "body": "Does it need to be writeable? Anyway, it looks like we can modify this by setting the environment variable `XDG_CACHE_HOME`: see the functions `_get_cachedir` and `_get_xdg_cache_dir` in `sage/local/lib/python/site-packages/matplotlib-1.3.1-py2.7-macosx-10.8-x86_64.egg/matplotlib/__init__.py`. I also think this belongs on another ticket.",
    "created_at": "2014-05-07T19:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202504",
    "user": "https://github.com/jhpalmieri"
}
```

Does it need to be writeable? Anyway, it looks like we can modify this by setting the environment variable `XDG_CACHE_HOME`: see the functions `_get_cachedir` and `_get_xdg_cache_dir` in `sage/local/lib/python/site-packages/matplotlib-1.3.1-py2.7-macosx-10.8-x86_64.egg/matplotlib/__init__.py`. I also think this belongs on another ticket.



---

archive/issue_comments_202505.json:
```json
{
    "body": "Replying to [comment:17 leif]:\n> IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).\n\nIn fact that is where it used to be: I have an old directory `~/.sage/matplotlib-1.2.1/` lying around, containing `fontList.cache` and `tex.cache/`, just like `~/.cache/matplotlib/` looks now.",
    "created_at": "2014-05-07T19:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202505",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:17 leif]:
> IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).

In fact that is where it used to be: I have an old directory `~/.sage/matplotlib-1.2.1/` lying around, containing `fontList.cache` and `tex.cache/`, just like `~/.cache/matplotlib/` looks now.



---

archive/issue_comments_202506.json:
```json
{
    "body": "By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.",
    "created_at": "2014-05-07T19:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202506",
    "user": "https://github.com/jhpalmieri"
}
```

By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.



---

archive/issue_comments_202507.json:
```json
{
    "body": "Replying to [comment:21 jhpalmieri]:\n> By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.\n\n\nWell, setting up MPL's config dir based on its version in `sage-env` in turn can indeed break upon relocation... :-)\n\n(as it calls Python before `sage-location` is called, and the Python interpreter may try to load libraries that have moved, as I already mentioned elsewhere).",
    "created_at": "2014-05-07T20:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202507",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:21 jhpalmieri]:
> By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.


Well, setting up MPL's config dir based on its version in `sage-env` in turn can indeed break upon relocation... :-)

(as it calls Python before `sage-location` is called, and the Python interpreter may try to load libraries that have moved, as I already mentioned elsewhere).



---

archive/issue_comments_202508.json:
```json
{
    "body": "Replying to [comment:22 leif]:\n> Well, setting up MPL's config dir based on its version in `sage-env` in turn can indeed break upon relocation... :-)\n> \n> (as it calls Python before `sage-location` is called, and the Python interpreter may try to load libraries that have moved, as I already mentioned elsewhere).\n\n\nSee for example http://trac.sagemath.org/ticket/16044#comment:7 ff.\n\n(Note that IIRC `sage-location` currently wouldn't help there anyway, as  it doesn't mess with `install_name`s.)",
    "created_at": "2014-05-07T20:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202508",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:22 leif]:
> Well, setting up MPL's config dir based on its version in `sage-env` in turn can indeed break upon relocation... :-)
> 
> (as it calls Python before `sage-location` is called, and the Python interpreter may try to load libraries that have moved, as I already mentioned elsewhere).


See for example http://trac.sagemath.org/ticket/16044#comment:7 ff.

(Note that IIRC `sage-location` currently wouldn't help there anyway, as  it doesn't mess with `install_name`s.)



---

archive/issue_comments_202509.json:
```json
{
    "body": "Replying to [comment:21 jhpalmieri]:\n> By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.\n\nOn GNU/Linux x86_64, I don't seem to have any environment variables with names containing \"MPL\", neither in the normal shell nor in `sage -sh`.  This is despite `logs/pkgs/matplotlib-1.3.1.log saying\n\n```\nWhen Sage runs, MPLCONFIGDIR will be set to '$DOT_SAGE/matplotlib-1.3.1'.\n```",
    "created_at": "2014-05-07T20:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202509",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:21 jhpalmieri]:
> By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.

On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.  This is despite `logs/pkgs/matplotlib-1.3.1.log saying

```
When Sage runs, MPLCONFIGDIR will be set to '$DOT_SAGE/matplotlib-1.3.1'.
```



---

archive/issue_comments_202510.json:
```json
{
    "body": "Replying to [comment:24 pbruin]:\n> On GNU/Linux x86_64, I don't seem to have any environment variables with names containing \"MPL\", neither in the normal shell nor in `sage -sh`.\n\n\nTrue. B)\n\n```sh\n$ ./sage --sh -c 'env | grep MPL'; uname -sm\nLinux x86_64\n```",
    "created_at": "2014-05-07T20:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202510",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:24 pbruin]:
> On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.


True. B)

```sh
$ ./sage --sh -c 'env | grep MPL'; uname -sm
Linux x86_64
```



---

archive/issue_comments_202511.json:
```json
{
    "body": "Replying to [comment:25 leif]:\n> Replying to [comment:24 pbruin]:\n> > On GNU/Linux x86_64, I don't seem to have any environment variables with names containing \"MPL\", neither in the normal shell nor in `sage -sh`.\n\n> \n> True. B)\n  \nIt turns out that this is because the following command in `sage-env` fails (I removed the `2>/dev/null` at the end:\n\n```\n\"$SAGE_ROOT/local/bin/python\" -c 'import pkg_resources; pkg_resources.get_distribution(\"matplotlib\").version'\nTraceback (most recent call last):\n  File \"<string>\", line 1, in <module>\nzipimport.ZipImportError: can't decompress data; zlib not available\n```",
    "created_at": "2014-05-07T20:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202511",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:25 leif]:
> Replying to [comment:24 pbruin]:
> > On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.

> 
> True. B)
  
It turns out that this is because the following command in `sage-env` fails (I removed the `2>/dev/null` at the end:

```
"$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version'
Traceback (most recent call last):
  File "<string>", line 1, in <module>
zipimport.ZipImportError: can't decompress data; zlib not available
```



---

archive/issue_comments_202512.json:
```json
{
    "body": "Replying to [comment:26 pbruin]:\n> Replying to [comment:25 leif]:\n> > Replying to [comment:24 pbruin]:\n> > > On GNU/Linux x86_64, I don't seem to have any environment variables with names containing \"MPL\", neither in the normal shell nor in `sage -sh`.\n\n> > \n> > True. B)\n  \n> It turns out that this is because the following command in `sage-env` fails (I removed the `2>/dev/null` at the end:\n> {{{\n> \"$SAGE_ROOT/local/bin/python\" -c 'import pkg_resources; pkg_resources.get_distribution(\"matplotlib\").version'\n> Traceback (most recent call last):\n>   File \"<string>\", line 1, in <module>\n> zipimport.ZipImportError: can't decompress data; zlib not available\n> }}}\n\n\nI'm getting\n\n```\n.../local/bin/python: error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory\n```\n\nSo apparently `LD_LIBRARY_PATH` isn't set up properly to that time.",
    "created_at": "2014-05-07T20:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202512",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:26 pbruin]:
> Replying to [comment:25 leif]:
> > Replying to [comment:24 pbruin]:
> > > On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.

> > 
> > True. B)
  
> It turns out that this is because the following command in `sage-env` fails (I removed the `2>/dev/null` at the end:
> {{{
> "$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version'
> Traceback (most recent call last):
>   File "<string>", line 1, in <module>
> zipimport.ZipImportError: can't decompress data; zlib not available
> }}}


I'm getting

```
.../local/bin/python: error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory
```

So apparently `LD_LIBRARY_PATH` isn't set up properly to that time.



---

archive/issue_comments_202513.json:
```json
{
    "body": "The problem in comment:26 was on 6.2.rc0; with 6.2 on a different system I get\n\n```\nTraceback (most recent call last):\n...\nImportError: cannot import name MAXREPEAT\n```\nI guess the `MPLCONFIGDIR`-relevant part of `sage-env` should be moved down to a point where all required setting up has been done.",
    "created_at": "2014-05-07T20:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202513",
    "user": "https://github.com/pjbruin"
}
```

The problem in comment:26 was on 6.2.rc0; with 6.2 on a different system I get

```
Traceback (most recent call last):
...
ImportError: cannot import name MAXREPEAT
```
I guess the `MPLCONFIGDIR`-relevant part of `sage-env` should be moved down to a point where all required setting up has been done.



---

archive/issue_comments_202514.json:
```json
{
    "body": "Oh, just noticed:\n\n```sh\n# Use a matplotlib config directory specific to Sage and specific to\n# the version number of matplotlib, by setting the environment\n# variable MPLCONFIGDIR. Note that we can't find the version number by\n# importing matplotlib, because that could create matplotlib's standard\n# config directory. So we use pkg_resources.\n\"$SAGE_ROOT/local/bin/python\" -c 'import pkg_resources; pkg_resources.get_distribution(\"matplotlib\").version' 2>/dev/null\nif [ $? -eq 0 ]; then\n    MPLVERSION=`\"$SAGE_ROOT/local/bin/python\" -c 'import pkg_resources; print pkg_resources.get_distribution(\"matplotlib\").version'`\n    MPLCONFIGDIR=\"$DOT_SAGE/matplotlib-$MPLVERSION\"\n    export MPLCONFIGDIR\n    # The directory is created when Sage starts (see sage.misc.misc).\nfi\n\n# Add some directories to $LD_LIBRARY_PATH:\n# * lib/openmpi is needed for openmpi.\n# * lib/R/lib is needed for R in case the Sage install is moved.\n# * lib32 and lib64 are needed for GCC, see #12405.\nfor d in lib/openmpi lib/R/lib lib32 lib64 lib; do\n    libdir=\"$SAGE_LOCAL/$d\"\n    # Add only existing directories\n    if [ -d \"$libdir\" ]; then\n        [ -z \"$LD_LIBRARY_PATH\" ] || LD_LIBRARY_PATH=\":${LD_LIBRARY_PATH}\"\n        LD_LIBRARY_PATH=\"${libdir}$LD_LIBRARY_PATH\"\n    fi\ndone\nexport LD_LIBRARY_PATH\n```\n\n`>8-O`",
    "created_at": "2014-05-07T20:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202514",
    "user": "https://github.com/nexttime"
}
```

Oh, just noticed:

```sh
# Use a matplotlib config directory specific to Sage and specific to
# the version number of matplotlib, by setting the environment
# variable MPLCONFIGDIR. Note that we can't find the version number by
# importing matplotlib, because that could create matplotlib's standard
# config directory. So we use pkg_resources.
"$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version' 2>/dev/null
if [ $? -eq 0 ]; then
    MPLVERSION=`"$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; print pkg_resources.get_distribution("matplotlib").version'`
    MPLCONFIGDIR="$DOT_SAGE/matplotlib-$MPLVERSION"
    export MPLCONFIGDIR
    # The directory is created when Sage starts (see sage.misc.misc).
fi

# Add some directories to $LD_LIBRARY_PATH:
# * lib/openmpi is needed for openmpi.
# * lib/R/lib is needed for R in case the Sage install is moved.
# * lib32 and lib64 are needed for GCC, see #12405.
for d in lib/openmpi lib/R/lib lib32 lib64 lib; do
    libdir="$SAGE_LOCAL/$d"
    # Add only existing directories
    if [ -d "$libdir" ]; then
        [ -z "$LD_LIBRARY_PATH" ] || LD_LIBRARY_PATH=":${LD_LIBRARY_PATH}"
        LD_LIBRARY_PATH="${libdir}$LD_LIBRARY_PATH"
    fi
done
export LD_LIBRARY_PATH
```

`>8-O`



---

archive/issue_comments_202515.json:
```json
{
    "body": "(I meant to say it's done right *after* we try to call `python`; I've slightly edited the snippet.)",
    "created_at": "2014-05-07T21:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202515",
    "user": "https://github.com/nexttime"
}
```

(I meant to say it's done right *after* we try to call `python`; I've slightly edited the snippet.)



---

archive/issue_comments_202516.json:
```json
{
    "body": "I created #16305 for this.",
    "created_at": "2014-05-07T21:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202516",
    "user": "https://github.com/pjbruin"
}
```

I created #16305 for this.



---

archive/issue_comments_202517.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-08T11:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15901#issuecomment-202517",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_046772.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-08T11:50:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15901",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15901#event-46772"
}
```
