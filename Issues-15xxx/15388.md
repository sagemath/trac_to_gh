# Issue 15388: log of NaN in RealField and ComplexField results in infinite loop

archive/issues_015151.json:
```json
{
    "body": "If you have a RealField or ComplexField NaN value and attempt to compute log, the fact that NaN is considered < 0 results in RealField.log calling ComplexField.log, but then ComplexField.log calls RealField.log again, but again on the values NaN for the absolute value. This results in an infinite loop. Example code for the code: \n\nx = RealField()(NaN)\nx.log() # Results in infinite loop\n\nThis patch fixes the log function in RealField and ComplexField to return NaN if fed a number which is NaN (in either the real or the imaginary coordinate). \n\nAssignee: Paul Fili\n\nCC:  atowsley\n\nKeywords: sage-days55\n\nReviewer: Benjamin Hutz\n\nAuthor: Paul Fili, Adam Towsley\n\nMerged: sage-5.13.beta3\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15388\n\n",
    "closed_at": "2013-11-14T07:54:21Z",
    "created_at": "2013-11-09T15:46:09Z",
    "labels": [
        "component: numerical",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "log of NaN in RealField and ComplexField results in infinite loop",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15388",
    "user": "https://github.com/pfili"
}
```
If you have a RealField or ComplexField NaN value and attempt to compute log, the fact that NaN is considered < 0 results in RealField.log calling ComplexField.log, but then ComplexField.log calls RealField.log again, but again on the values NaN for the absolute value. This results in an infinite loop. Example code for the code: 

x = RealField()(NaN)
x.log() # Results in infinite loop

This patch fixes the log function in RealField and ComplexField to return NaN if fed a number which is NaN (in either the real or the imaginary coordinate). 

Assignee: Paul Fili

CC:  atowsley

Keywords: sage-days55

Reviewer: Benjamin Hutz

Author: Paul Fili, Adam Towsley

Merged: sage-5.13.beta3

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15388





---

archive/issue_comments_241536.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-11-09T16:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241536",
    "user": "https://github.com/pfili"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_241537.json:
```json
{
    "body": "<a id='comment:3'></a>\nA couple things\n\n1) the patch needs a commit message\n\n2) the patch name should be trac_15388_<description>.patch\n\n3) Please add a doctest to each log function to demonstrate the fix\n\n4) lines 2063, 2064 which are commented out look like they can just be removed as they add no value to the code",
    "created_at": "2013-11-10T00:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241537",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:3'></a>
A couple things

1) the patch needs a commit message

2) the patch name should be trac_15388_<description>.patch

3) Please add a doctest to each log function to demonstrate the fix

4) lines 2063, 2064 which are commented out look like they can just be removed as they add no value to the code



---

archive/issue_comments_241538.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-11-10T00:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241538",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_241539.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ben Hutz\"",
    "created_at": "2013-11-10T00:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241539",
    "user": "https://github.com/bhutz"
}
```

Changing reviewer from "" to "Ben Hutz"



---

archive/issue_comments_241540.json:
```json
{
    "body": "<a id='comment:5'></a>\nlong doctest looks fine with this, so I'm happy with the code change, just make the minor changes suggested above.\n\nJust to note, I had a few unrelated longtest failures on 5.12 that failed both with and without the patch.\n\n```\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/cmdline.py  # 11 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/calculus/desolvers.py  # 8 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/constructions/calculus.rst  # 4 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/prep/Quickstarts/Differential-Equations.rst  # 2 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/interpreter.py  # 1 doctest failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/trace.py  # 2 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/interrupt.pyx  # Time out\n```",
    "created_at": "2013-11-10T02:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241540",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:5'></a>
long doctest looks fine with this, so I'm happy with the code change, just make the minor changes suggested above.

Just to note, I had a few unrelated longtest failures on 5.12 that failed both with and without the patch.

```
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/cmdline.py  # 11 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/calculus/desolvers.py  # 8 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/constructions/calculus.rst  # 4 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/prep/Quickstarts/Differential-Equations.rst  # 2 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/interpreter.py  # 1 doctest failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/trace.py  # 2 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/interrupt.pyx  # Time out
```



---

archive/issue_comments_241541.json:
```json
{
    "body": "<a id='comment:7'></a>\nIt is probably best not to have an example involving NaN in the log's documentation, as it is such a basic function and this case is rather exceptional. (Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.)",
    "created_at": "2013-11-10T15:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241541",
    "user": "https://github.com/pfili"
}
```

<a id='comment:7'></a>
It is probably best not to have an example involving NaN in the log's documentation, as it is such a basic function and this case is rather exceptional. (Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.)



---

archive/issue_comments_241542.json:
```json
{
    "body": "<a id='comment:8'></a>\nWe have made the changes Ben suggested, except for adding a doctest, which seems undesirable as noted above.",
    "created_at": "2013-11-10T15:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241542",
    "user": "https://github.com/pfili"
}
```

<a id='comment:8'></a>
We have made the changes Ben suggested, except for adding a doctest, which seems undesirable as noted above.



---

archive/issue_comments_241543.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-10T15:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241543",
    "user": "https://github.com/pfili"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_241544.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis looks good.",
    "created_at": "2013-11-10T16:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241544",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:10'></a>
This looks good.



---

archive/issue_comments_241545.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-10T16:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241545",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_241546.json:
```json
{
    "body": "Changing work_issues from \"\" to \"doctest\"",
    "created_at": "2013-11-10T22:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241546",
    "user": "https://github.com/jdemeyer"
}
```

Changing work_issues from "" to "doctest"



---

archive/issue_comments_241547.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-11-10T22:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241547",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_241548.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [paulfili](#comment%3A7):\n> Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.\n\nWhich is exactly why a doctest is needed.",
    "created_at": "2013-11-10T22:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241548",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [paulfili](#comment%3A7):
> Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.

Which is exactly why a doctest is needed.



---

archive/issue_comments_241549.json:
```json
{
    "body": "<a id='comment:12'></a>\nI have added a doctest that explains the behavior for NaN.",
    "created_at": "2013-11-12T00:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241549",
    "user": "https://github.com/pfili"
}
```

<a id='comment:12'></a>
I have added a doctest that explains the behavior for NaN.



---

archive/issue_comments_241550.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-12T00:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241550",
    "user": "https://github.com/pfili"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_241551.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-12T01:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241551",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_241552.json:
```json
{
    "body": "<a id='comment:13'></a>\nOk. This still looks fine and now we have the doctests.",
    "created_at": "2013-11-12T01:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241552",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:13'></a>
Ok. This still looks fine and now we have the doctests.



---

archive/issue_comments_241553.json:
```json
{
    "body": "<a id='comment:14'></a>\nYou should add a meaningful commit message (use `hg qrefresh -e` for that)",
    "created_at": "2013-11-12T07:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241553",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
You should add a meaningful commit message (use `hg qrefresh -e` for that)



---

archive/issue_comments_241554.json:
```json
{
    "body": "Changing work_issues from \"doctest\" to \"\"",
    "created_at": "2013-11-12T07:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241554",
    "user": "https://github.com/jdemeyer"
}
```

Changing work_issues from "doctest" to ""



---

archive/issue_comments_241555.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-11-12T07:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241555",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_241556.json:
```json
{
    "body": "Fixes the behavior of log(NaN) in real and complex fields",
    "created_at": "2013-11-12T16:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241556",
    "user": "https://github.com/pfili"
}
```

Fixes the behavior of log(NaN) in real and complex fields



---

archive/issue_comments_241557.json:
```json
{
    "body": "<a id='comment:15'></a>\nAttachment [trac_15388_nan_fix.patch](tarball://root/attachments/some-uuid/ticket15388/trac_15388_nan_fix.patch) by @pfili created at 2013-11-12 16:06:19\n\nCommit message has been added.",
    "created_at": "2013-11-12T16:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241557",
    "user": "https://github.com/pfili"
}
```

<a id='comment:15'></a>
Attachment [trac_15388_nan_fix.patch](tarball://root/attachments/some-uuid/ticket15388/trac_15388_nan_fix.patch) by @pfili created at 2013-11-12 16:06:19

Commit message has been added.



---

archive/issue_comments_241558.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-12T16:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241558",
    "user": "https://github.com/pfili"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_241559.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-13T12:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241559",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_241560.json:
```json
{
    "body": "<a id='comment:16'></a>\nok. still looks good, but with a commit message this time.",
    "created_at": "2013-11-13T12:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241560",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:16'></a>
ok. still looks good, but with a commit message this time.



---

archive/issue_comments_241561.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-11-14T07:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241561",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_058902.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-14T07:54:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15388#event-58902"
}
```



---

archive/issue_comments_241562.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.13.beta3\"",
    "created_at": "2013-11-14T07:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241562",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.13.beta3"



---

archive/issue_comments_241563.json:
```json
{
    "body": "Changing reviewer from \"Ben Hutz\" to \"Benjamin Hutz\"",
    "created_at": "2013-12-15T08:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15388#issuecomment-241563",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "Ben Hutz" to "Benjamin Hutz"
