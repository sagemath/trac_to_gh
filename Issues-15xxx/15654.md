# Issue 15654: PARI discriminant speed depends on stack size

archive/issues_015417.json:
```json
{
    "body": "This is weird and bad:\n\n```\nsage: x = polygen(ZpFM(3,10))\nsage: p = ((x-1)^50 + x)._pari_init_()\nsage: %time pari(p).poldisc()\nCPU times: user 52.73 s, sys: 0.00 s, total: 52.73 s\nWall time: 52.82 s\n2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)\nsage: pari.allocatemem(2<<20)\nPARI stack size set to 2097152 bytes\nsage: %time pari(p).poldisc()\nCPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s\nWall time: 0.08 s\n2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)\n```\n\n**Upstream**: [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507)\n\nCC:  @pjbruin\n\nUpstream: Reported upstream. Developers deny it's a bug.\n\nReviewer: David Roe\n\nAuthor: Jeroen Demeyer\n\nBranch: u/jdemeyer/ticket/15654\n\nDependencies: #15653\n\nCommit: a955e45e17cdbd40d24a103ef7903c5f970b24a3\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15654\n\n",
    "closed_at": "2014-02-02T16:57:19Z",
    "created_at": "2014-01-09T14:03:17Z",
    "labels": [
        "component: performance",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "PARI discriminant speed depends on stack size",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15654",
    "user": "https://github.com/jdemeyer"
}
```
This is weird and bad:

```
sage: x = polygen(ZpFM(3,10))
sage: p = ((x-1)^50 + x)._pari_init_()
sage: %time pari(p).poldisc()
CPU times: user 52.73 s, sys: 0.00 s, total: 52.73 s
Wall time: 52.82 s
2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)
sage: pari.allocatemem(2<<20)
PARI stack size set to 2097152 bytes
sage: %time pari(p).poldisc()
CPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s
Wall time: 0.08 s
2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)
```

**Upstream**: [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507)

CC:  @pjbruin

Upstream: Reported upstream. Developers deny it's a bug.

Reviewer: David Roe

Author: Jeroen Demeyer

Branch: u/jdemeyer/ticket/15654

Dependencies: #15653

Commit: a955e45e17cdbd40d24a103ef7903c5f970b24a3

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15654





---

archive/issue_comments_212150.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,6 +15,8 @@\n \n The problem isn't PARI itself (given the speed of `gp`), it's somehow the PARI interface in Sage.\n \n+This happens both before and after the various PARI cleanup tickets in Sage 6.1.\n+\n Comment: 1\n \n Summary: Extremely slow PARI discriminants\n``````\n",
    "created_at": "2014-01-09T14:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212150",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,6 +15,8 @@
 
 The problem isn't PARI itself (given the speed of `gp`), it's somehow the PARI interface in Sage.
 
+This happens both before and after the various PARI cleanup tickets in Sage 6.1.
+
 Comment: 1
 
 Summary: Extremely slow PARI discriminants
``````




---

archive/issue_comments_212151.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,19 @@\n+This is weird and bad:\n \n+```\n+sage: x = polygen(ZpFM(3,10))\n+sage: p = ((x-1)^50 + x)._pari_init_()\n+sage: %time pari(p).poldisc()\n+CPU times: user 52.73 s, sys: 0.00 s, total: 52.73 s\n+Wall time: 52.82 s\n+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)\n+sage: pari.allocatemem(2<<20)\n+PARI stack size set to 2097152 bytes\n+sage: %time pari(p).poldisc()\n+CPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s\n+Wall time: 0.08 s\n+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2014-01-09T14:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212151",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,19 @@
+This is weird and bad:
 
+```
+sage: x = polygen(ZpFM(3,10))
+sage: p = ((x-1)^50 + x)._pari_init_()
+sage: %time pari(p).poldisc()
+CPU times: user 52.73 s, sys: 0.00 s, total: 52.73 s
+Wall time: 52.82 s
+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)
+sage: pari.allocatemem(2<<20)
+PARI stack size set to 2097152 bytes
+sage: %time pari(p).poldisc()
+CPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s
+Wall time: 0.08 s
+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_212152.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+This is weird and bad:\n \n+```\n+sage: x = polygen(ZpFM(3,10))\n+sage: p = ((x-1)^50 + x)._pari_init_()\n+sage: %time pari(p).poldisc()\n+CPU times: user 52.73 s, sys: 0.00 s, total: 52.73 s\n+Wall time: 52.82 s\n+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)\n+sage: pari.allocatemem(2<<20)\n+PARI stack size set to 2097152 bytes\n+sage: %time pari(p).poldisc()\n+CPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s\n+Wall time: 0.08 s\n+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)\n+```\n+\n+**Upstream**: [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507)\n \n Comment: 1\n \n``````\n",
    "created_at": "2014-01-09T14:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212152",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
+This is weird and bad:
 
+```
+sage: x = polygen(ZpFM(3,10))
+sage: p = ((x-1)^50 + x)._pari_init_()
+sage: %time pari(p).poldisc()
+CPU times: user 52.73 s, sys: 0.00 s, total: 52.73 s
+Wall time: 52.82 s
+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)
+sage: pari.allocatemem(2<<20)
+PARI stack size set to 2097152 bytes
+sage: %time pari(p).poldisc()
+CPU times: user 0.08 s, sys: 0.00 s, total: 0.08 s
+Wall time: 0.08 s
+2*3 + 3^4 + 2*3^6 + 3^7 + 2*3^8 + 2*3^9 + O(3^10)
+```
+
+**Upstream**: [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1507)
 
 Comment: 1
 
``````




---

archive/issue_comments_212153.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-09T16:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212153",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_212154.json:
```json
{
    "body": "<a id='comment:7'></a>New commits:",
    "created_at": "2014-01-09T16:06:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212154",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>New commits:



---

archive/issue_comments_212155.json:
```json
{
    "body": "<a id='comment:8'></a>This solution works well for Sage, maybe not for PARI/GP upstream.",
    "created_at": "2014-01-09T16:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212155",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>This solution works well for Sage, maybe not for PARI/GP upstream.



---

archive/issue_comments_212156.json:
```json
{
    "body": "<a id='comment:9'></a>I'm fine with this change.  I'm not yet familiar with reviewing SPKG changes using the new directory layout.  Why is SPKG.txt deleted in this commit?\n\nMore generally, are there other places in Sage where we should be more aggressive about increasing the Pari stack size?  If someone is using Pari nontrivially, our current stack size seems too small.  Should we increase the stack whenever a user does certain operations signaling that they're going to be using Pari extensively (e.g. create a number field of degree larger than 4, take the discriminant of a polynomial of large degree...)?",
    "created_at": "2014-01-10T00:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212156",
    "user": "https://github.com/roed314"
}
```

<a id='comment:9'></a>I'm fine with this change.  I'm not yet familiar with reviewing SPKG changes using the new directory layout.  Why is SPKG.txt deleted in this commit?

More generally, are there other places in Sage where we should be more aggressive about increasing the Pari stack size?  If someone is using Pari nontrivially, our current stack size seems too small.  Should we increase the stack whenever a user does certain operations signaling that they're going to be using Pari extensively (e.g. create a number field of degree larger than 4, take the discriminant of a polynomial of large degree...)?



---

archive/issue_comments_212157.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 roed]:\n> I'm fine with this change.  I'm not yet familiar with reviewing SPKG changes using the new directory layout.  Why is SPKG.txt deleted in this commit?\n\nNot all of `SPKG.txt`, just the changelog.",
    "created_at": "2014-01-10T06:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212157",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [comment:9 roed]:
> I'm fine with this change.  I'm not yet familiar with reviewing SPKG changes using the new directory layout.  Why is SPKG.txt deleted in this commit?

Not all of `SPKG.txt`, just the changelog.



---

archive/issue_comments_212158.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 roed]:\n> More generally, are there other places in Sage where we should be more aggressive about increasing the Pari stack size?  If someone is using Pari nontrivially, our current stack size seems too small.  Should we increase the stack whenever a user does certain operations signaling that they're going to be using Pari extensively (e.g. create a number field of degree larger than 4, take the discriminant of a polynomial of large degree...)?\n\nWe could *detect* the problem by adding some code to `gerepile...()` to count the number of garbage collections. We could for example give a warning if more than N happen per second (for a suitable value of N).",
    "created_at": "2014-01-10T08:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212158",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:9 roed]:
> More generally, are there other places in Sage where we should be more aggressive about increasing the Pari stack size?  If someone is using Pari nontrivially, our current stack size seems too small.  Should we increase the stack whenever a user does certain operations signaling that they're going to be using Pari extensively (e.g. create a number field of degree larger than 4, take the discriminant of a polynomial of large degree...)?

We could *detect* the problem by adding some code to `gerepile...()` to count the number of garbage collections. We could for example give a warning if more than N happen per second (for a suitable value of N).



---

archive/issue_comments_212159.json:
```json
{
    "body": "<a id='comment:12'></a>See #15659.",
    "created_at": "2014-01-10T09:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212159",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>See #15659.



---

archive/issue_comments_212160.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:9 roed]:\n> More generally, are there other places in Sage where we should be more aggressive about increasing the Pari stack size?\n\nYes, see #15660.",
    "created_at": "2014-01-10T10:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212160",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:9 roed]:
> More generally, are there other places in Sage where we should be more aggressive about increasing the Pari stack size?

Yes, see #15660.



---

archive/issue_comments_212161.json:
```json
{
    "body": "<a id='comment:14'></a>Cool.  I'm doctesting this ticket and will then give it a positive review.",
    "created_at": "2014-01-10T10:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212161",
    "user": "https://github.com/roed314"
}
```

<a id='comment:14'></a>Cool.  I'm doctesting this ticket and will then give it a positive review.



---

archive/issue_comments_212162.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-01-12T00:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212162",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_212163.json:
```json
{
    "body": "<a id='comment:15'></a>Looks good.",
    "created_at": "2014-01-12T00:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212163",
    "user": "https://github.com/roed314"
}
```

<a id='comment:15'></a>Looks good.



---

archive/issue_comments_212164.json:
```json
{
    "body": "<a id='comment:16'></a>Ok, this is not \"critical\"",
    "created_at": "2014-01-13T16:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212164",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Ok, this is not "critical"



---

archive/issue_events_045909.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15654#event-45909"
}
```



---

archive/issue_comments_212165.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-02T16:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15654#issuecomment-212165",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_045910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-02-02T16:57:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15654",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15654#event-45910"
}
```
