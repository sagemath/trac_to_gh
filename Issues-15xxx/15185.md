# Issue 15185: Clean up interface to the PARI library

archive/issues_014948.json:
```json
{
    "body": "Keywords: pari\n\nThe file `sage/libs/pari/gen.pyx` is too big and contains too many different things.  For clarity and maintainability, it should be split into two parts:\n- `gen.pyx` containing the class `gen`;\n- `pari_instance.pyx` containing the class `PariInstance` and some utility functions;\nMore cleaning-up will be done in #15461.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15185\n\n",
    "closed_at": "2013-12-20T15:50:51Z",
    "created_at": "2013-09-11T14:35:35Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "Clean up interface to the PARI library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15185",
    "user": "https://github.com/pjbruin"
}
```
Keywords: pari

The file `sage/libs/pari/gen.pyx` is too big and contains too many different things.  For clarity and maintainability, it should be split into two parts:
- `gen.pyx` containing the class `gen`;
- `pari_instance.pyx` containing the class `PariInstance` and some utility functions;
More cleaning-up will be done in #15461.

Issue created by migration from https://trac.sagemath.org/ticket/15185





---

archive/issue_comments_190682.json:
```json
{
    "body": "The `t0GEN` stuff is #11868.",
    "created_at": "2013-10-03T10:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190682",
    "user": "https://github.com/jdemeyer"
}
```

The `t0GEN` stuff is #11868.



---

archive/issue_events_043814.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-18T07:22:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15185#event-43814"
}
```



---

archive/issue_comments_190683.json:
```json
{
    "body": "I think this ticket is a typical \"patchbomb\" which should be avoided. In particular, the replacing of the global variables `t0`... and the re-organizing of the `.py(x)` files are both big changes which should be on different tickets. For the former, I already created #11868 for this.",
    "created_at": "2013-11-23T11:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190683",
    "user": "https://github.com/jdemeyer"
}
```

I think this ticket is a typical "patchbomb" which should be avoided. In particular, the replacing of the global variables `t0`... and the re-organizing of the `.py(x)` files are both big changes which should be on different tickets. For the former, I already created #11868 for this.



---

archive/issue_comments_190684.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> I think this ticket is a typical \"patchbomb\" which should be avoided.\n\nI know.  The problem is that when I started this clean-up operation, it wasn't clear what the end result was going to look like.  I created this ticket -- and the list of separate issues -- only after reaching a state that worked again, and didn't know about #11868.  Cutting it up into separate tickets is easier said than done; it will probably become more manageable by using Git, but it will still take a lot of effort.",
    "created_at": "2013-11-23T20:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190684",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:7 jdemeyer]:
> I think this ticket is a typical "patchbomb" which should be avoided.

I know.  The problem is that when I started this clean-up operation, it wasn't clear what the end result was going to look like.  I created this ticket -- and the list of separate issues -- only after reaching a state that worked again, and didn't know about #11868.  Cutting it up into separate tickets is easier said than done; it will probably become more manageable by using Git, but it will still take a lot of effort.



---

archive/issue_comments_190685.json:
```json
{
    "body": "As a first step I split off the changes eliminating the global GEN variables as a patch on #11868.  This will certainly have to be rebased, but that had to be done anyway because of #10018.",
    "created_at": "2013-11-24T02:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190685",
    "user": "https://github.com/pjbruin"
}
```

As a first step I split off the changes eliminating the global GEN variables as a patch on #11868.  This will certainly have to be rebased, but that had to be done anyway because of #10018.



---

archive/issue_comments_190686.json:
```json
{
    "body": "To ease rebasing and reviewing, I recommend you to make this ticket absolutely minimal (only move stuff, nothing else): everything which can be done on a different ticket, should be done so.",
    "created_at": "2013-11-26T14:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190686",
    "user": "https://github.com/jdemeyer"
}
```

To ease rebasing and reviewing, I recommend you to make this ticket absolutely minimal (only move stuff, nothing else): everything which can be done on a different ticket, should be done so.



---

archive/issue_comments_190687.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> To ease rebasing and reviewing, I recommend you to make this ticket absolutely minimal (only move stuff, nothing else): everything which can be done on a different ticket, should be done so.\n\nThat is more or less my plan, after #11868 is finished.",
    "created_at": "2013-11-26T14:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190687",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:10 jdemeyer]:
> To ease rebasing and reviewing, I recommend you to make this ticket absolutely minimal (only move stuff, nothing else): everything which can be done on a different ticket, should be done so.

That is more or less my plan, after #11868 is finished.



---

archive/issue_comments_190688.json:
```json
{
    "body": "Are we sure we really want to do this? I'm afraid that performance is going to be worse because Cython has an overhead when calling functions in a different module.",
    "created_at": "2013-12-06T21:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190688",
    "user": "https://github.com/jdemeyer"
}
```

Are we sure we really want to do this? I'm afraid that performance is going to be worse because Cython has an overhead when calling functions in a different module.



---

archive/issue_comments_190689.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Are we sure we really want to do this? I'm afraid that performance is going to be worse because Cython has an overhead when calling functions in a different module.\n\nIs this because the ``@`cython.final` decorator on an extension type `T` currently does not forbid subtyping `T` in a different Cython module (so that methods can be called directly in the same module, but only via a vtab in a different module)?\n\nIf this is what you mean, could the overhead be avoided by making `new_gen()` and `clear_stack()` (which will be responsible for most of the cross-module calls) functions instead of methods?",
    "created_at": "2013-12-08T16:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190689",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:13 jdemeyer]:
> Are we sure we really want to do this? I'm afraid that performance is going to be worse because Cython has an overhead when calling functions in a different module.

Is this because the ``@`cython.final` decorator on an extension type `T` currently does not forbid subtyping `T` in a different Cython module (so that methods can be called directly in the same module, but only via a vtab in a different module)?

If this is what you mean, could the overhead be avoided by making `new_gen()` and `clear_stack()` (which will be responsible for most of the cross-module calls) functions instead of methods?



---

archive/issue_comments_190690.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-12-11T01:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190690",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_190691.json:
```json
{
    "body": "Here is a new branch which moves `PariInstance` to a separate file and otherwise is close to minimal.\n\nIt is true that the Cython-generated code has some overhead in for the cross-module method calls.  I think it is very small, but I will try to do some timings.  Depending on the outcome, it might be reasonable to duplicate a small amount of code to avoid these cross-module calls.  I think it is better to do that as part of #15461, though.\n\n---\nNew commits:",
    "created_at": "2013-12-11T01:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190691",
    "user": "https://github.com/pjbruin"
}
```

Here is a new branch which moves `PariInstance` to a separate file and otherwise is close to minimal.

It is true that the Cython-generated code has some overhead in for the cross-module method calls.  I think it is very small, but I will try to do some timings.  Depending on the outcome, it might be reasonable to duplicate a small amount of code to avoid these cross-module calls.  I think it is better to do that as part of #15461, though.

---
New commits:



---

archive/issue_comments_190692.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-11T02:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190692",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_190693.json:
```json
{
    "body": "Additional commit needs review. Apart from this, everything looks fine.\n\n---\nNew commits:",
    "created_at": "2013-12-16T11:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190693",
    "user": "https://github.com/jdemeyer"
}
```

Additional commit needs review. Apart from this, everything looks fine.

---
New commits:



---

archive/issue_comments_190694.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-16T13:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190694",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_190695.json:
```json
{
    "body": "I wasn't sure whether `allocatemem()` should already be removed from the global namespace (it was only deprecated recently), and whether `from sage.libs.pari.all import ...` is better than specifying the precise module, but I'm definitely OK with these changes.",
    "created_at": "2013-12-16T13:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190695",
    "user": "https://github.com/pjbruin"
}
```

I wasn't sure whether `allocatemem()` should already be removed from the global namespace (it was only deprecated recently), and whether `from sage.libs.pari.all import ...` is better than specifying the precise module, but I'm definitely OK with these changes.



---

archive/issue_events_043815.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15185#event-43815"
}
```



---

archive/issue_events_043816.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15185#event-43816"
}
```



---

archive/issue_comments_190696.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-20T15:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15185#issuecomment-190696",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_043817.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-20T15:50:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15185",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15185#event-43817"
}
```
