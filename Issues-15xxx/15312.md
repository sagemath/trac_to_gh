# Issue 15312: Fix use of freed memory in Symmetrica

archive/issues_015075.json:
```json
{
    "assignees": [],
    "body": "The following bug seems to appear on Macs only (linux machines do not seem to be effected).\n\nTo begin with, let's do a change of basis in a small degree:\n\n```\n    sage: p = SymmetricFunctions(QQ).powersum()\n    sage: s = SymmetricFunctions(QQ).schur()\n    sage: s(p[2,2])\n    s[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]\n```\nNow let's do one in a larger degree:\n\n```\n    sage: time g = s(p([1]*47))\n    Time: CPU 19.16 s, Wall: 20.91 s\n```\nNow let's do that first one again:\n\n```\n    sage: s(p[2,2])\n    s[1, 1, 1, 1] - s[2, 1, 1] + 4571483302*s[2, 2] - s[3, 1] + s[4]\n```\nThat's not the correct answer ! And the next time you ask Sage, it\ngives different, still incorrect, answers:\n\n```\n    sage: s(p[2,2])\n    s[1, 1, 1, 1] - s[2, 1, 1] + 4614252243*s[2, 2] - s[3, 1] + s[4]\n    sage: s(p[2,2])\n    s[1, 1, 1, 1] - s[2, 1, 1] + 4634718110*s[2, 2] - s[3, 1] + s[4]\n    sage: s(p[2,2])\n    s[1, 1, 1, 1] - s[2, 1, 1] + 4631047636*s[2, 2] - s[3, 1] + s[4]\n```\n\nIn [this discussion](https://groups.google.com/d/topic/sage-combinat-devel/fWMuS4R5M9Q/discussion) on sage-combinat-devel, Anne noticed that the problem is \"not symmetrica per se, but some wrapper functions around symmetrica, as the following example shows\":\n\n```\nsage: f = eval('symmetrica.t_POWSYM_SCHUR')\nsage: f({Partition([2,2]):Integer(1)})\ns[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]\nsage: time g = f({Partition([1]*47):Integer(1)})\nTime: CPU 13.03 s, Wall: 13.04 s\nsage: f({Partition([2,2]):Integer(1)})\ns[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]\nsage: Sym = SymmetricFunctions(QQ)\nsage: p = Sym.power()\nsage: s = Sym.schur()\nsage: s(p[2,2])\ns[1, 1, 1, 1] - s[2, 1, 1] + 4631790164*s[2, 2] - s[3, 1] + s[4]\nsage: f({Partition([2,2]):Integer(1)})\ns[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]\n```\n\nAnd Travis commented that:\n\n> When (random) big numbers appear like that, it almost always is an integer overflow. I suspect the communication with Symmetrica goes through the native integer. Is this correct? If so, then that's where I'd say the problem lies.\n\nThis is a bug which is carried over from #13413 .  When we realized that there are actually two bugs and one has been corrected, these tickets were split.\n\n**spkg**: [http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg](http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg)\n\n**apply**: [attachment: trac_15312_doctest-mz.patch](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz)\n\nDepends on #13413\n\nCC:  @sagetrac-sage-combinat @saliola @anneschilling @zabrocki @mguaypaq @darijgr @tscrim @mwhansen @jdemeyer\n\nKeywords: **symmetric functions, symmetrica**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Mike Zabrocki**\n\nMerged: **sage-5.13.beta2**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15312_\n\n",
    "closed_at": "2013-10-31T19:18:07Z",
    "created_at": "2013-10-20T18:24:35Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/memleak"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.13",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix use of freed memory in Symmetrica",
    "type": "issue",
    "updated_at": "2013-10-31T19:18:07Z",
    "url": "https://github.com/sagemath/sage/issues/15312",
    "user": "https://github.com/zabrocki"
}
```
The following bug seems to appear on Macs only (linux machines do not seem to be effected).

To begin with, let's do a change of basis in a small degree:

```
    sage: p = SymmetricFunctions(QQ).powersum()
    sage: s = SymmetricFunctions(QQ).schur()
    sage: s(p[2,2])
    s[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]
```
Now let's do one in a larger degree:

```
    sage: time g = s(p([1]*47))
    Time: CPU 19.16 s, Wall: 20.91 s
```
Now let's do that first one again:

```
    sage: s(p[2,2])
    s[1, 1, 1, 1] - s[2, 1, 1] + 4571483302*s[2, 2] - s[3, 1] + s[4]
```
That's not the correct answer ! And the next time you ask Sage, it
gives different, still incorrect, answers:

```
    sage: s(p[2,2])
    s[1, 1, 1, 1] - s[2, 1, 1] + 4614252243*s[2, 2] - s[3, 1] + s[4]
    sage: s(p[2,2])
    s[1, 1, 1, 1] - s[2, 1, 1] + 4634718110*s[2, 2] - s[3, 1] + s[4]
    sage: s(p[2,2])
    s[1, 1, 1, 1] - s[2, 1, 1] + 4631047636*s[2, 2] - s[3, 1] + s[4]
```

In [this discussion](https://groups.google.com/d/topic/sage-combinat-devel/fWMuS4R5M9Q/discussion) on sage-combinat-devel, Anne noticed that the problem is "not symmetrica per se, but some wrapper functions around symmetrica, as the following example shows":

```
sage: f = eval('symmetrica.t_POWSYM_SCHUR')
sage: f({Partition([2,2]):Integer(1)})
s[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]
sage: time g = f({Partition([1]*47):Integer(1)})
Time: CPU 13.03 s, Wall: 13.04 s
sage: f({Partition([2,2]):Integer(1)})
s[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]
sage: Sym = SymmetricFunctions(QQ)
sage: p = Sym.power()
sage: s = Sym.schur()
sage: s(p[2,2])
s[1, 1, 1, 1] - s[2, 1, 1] + 4631790164*s[2, 2] - s[3, 1] + s[4]
sage: f({Partition([2,2]):Integer(1)})
s[1, 1, 1, 1] - s[2, 1, 1] + 2*s[2, 2] - s[3, 1] + s[4]
```

And Travis commented that:

> When (random) big numbers appear like that, it almost always is an integer overflow. I suspect the communication with Symmetrica goes through the native integer. Is this correct? If so, then that's where I'd say the problem lies.

This is a bug which is carried over from #13413 .  When we realized that there are actually two bugs and one has been corrected, these tickets were split.

**spkg**: [http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg](http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg)

**apply**: [attachment: trac_15312_doctest-mz.patch](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz)

Depends on #13413

CC:  @sagetrac-sage-combinat @saliola @anneschilling @zabrocki @mguaypaq @darijgr @tscrim @mwhansen @jdemeyer

Keywords: **symmetric functions, symmetrica**

Reviewer: **Jeroen Demeyer**

Author: **Mike Zabrocki**

Merged: **sage-5.13.beta2**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/15312_





---

archive/issue_events_215723.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-20T18:24:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "milestone_number": null,
    "milestone_title": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215723"
}
```



---

archive/issue_events_215724.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-20T18:24:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215724"
}
```



---

archive/issue_events_215725.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-20T18:24:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215725"
}
```



---

archive/issue_events_215726.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-20T18:24:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215726"
}
```



---

archive/issue_comments_189594.json:
```json
{
    "body": "Changed keywords from none to **symmetric functions, symmetrica**",
    "created_at": "2013-10-20T18:27:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189594",
    "user": "https://github.com/zabrocki"
}
```

Changed keywords from none to **symmetric functions, symmetrica**



---

archive/issue_events_215727.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-20T18:27:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "d73a4a",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215727"
}
```



---

archive/issue_comments_189595.json:
```json
{
    "body": "Attachment: **[symmetrica-test.py.gz](https://github.com/sagemath/sage/files/ticket15312/symmetrica-test.py.gz)**",
    "created_at": "2013-10-20T18:30:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189595",
    "user": "https://github.com/zabrocki"
}
```

Attachment: **[symmetrica-test.py.gz](https://github.com/sagemath/sage/files/ticket15312/symmetrica-test.py.gz)**



---

archive/issue_comments_189596.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThe attachement `symmetrica-test.py` is a test file that is described in [Comment 3](https://github.com/sagemath/sage/issues/13413#comment:3) of #13413",
    "created_at": "2013-10-20T18:35:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189596",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:2" align="right">comment:2</div>

The attachement `symmetrica-test.py` is a test file that is described in [Comment 3](https://github.com/sagemath/sage/issues/13413#comment:3) of #13413



---

archive/issue_comments_189597.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI want to get this bug resolved too.  The bug in #13413 sent me into a bit of panic because I realized that very few calculations using the symmetric function package weren't questionable (sorry for the double negative).  I now have slightly more confidence in symmetric function calculations, but only a little more than before.\n\nI started reading Matheiu's comment carefully and he states : \"the problem appears at size 47\".  However I ran his program on my computer (OS 10.8.5 with 2.6 GHz Intel Core i7 processor) and on a mac in my office with copies of sage that had #13413 applied and not.  The error seemed to appear somewhere between degree 47 and 51 depending on some non-deterministic effect.  Mostly it was starting at 48.",
    "created_at": "2013-10-20T19:39:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189597",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:3" align="right">comment:3</div>

I want to get this bug resolved too.  The bug in #13413 sent me into a bit of panic because I realized that very few calculations using the symmetric function package weren't questionable (sorry for the double negative).  I now have slightly more confidence in symmetric function calculations, but only a little more than before.

I started reading Matheiu's comment carefully and he states : "the problem appears at size 47".  However I ran his program on my computer (OS 10.8.5 with 2.6 GHz Intel Core i7 processor) and on a mac in my office with copies of sage that had #13413 applied and not.  The error seemed to appear somewhere between degree 47 and 51 depending on some non-deterministic effect.  Mostly it was starting at 48.



---

archive/issue_comments_189598.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nTo help identify the problem I need to know precisely what steps trigger the error:\n\n```\nsage: from sage.libs.symmetrica.all import t_POWSYM_SCHUR as PS\nsage: g = PS({Partition([1]*50):ZZ(1)})\nsage: PS({Partition([1]*4):ZZ(1)})\ns[1, 1, 1, 1] + 3*s[2, 1, 1] + 2*s[2, 2] + 3*s[3, 1] + s[4]\nsage: PS({Partition([1]*4):QQ(1)})\ns[1, 1, 1, 1] + 3*s[2, 1, 1] + 2*s[2, 2] + 508150636*s[3, 1] + s[4]\n```\nSo it seems that POWSYM to SCHUR over the integers has no visible problems, but POWSYM to SCHUR over the rationals is having the overflow, but only after we've done a sufficiently large calculation (over the integers or rationals).\n\nI'm having a hard time identifying the problem inside of the symmetrica package because if you create a c program with a command `scan(POW_SYM,a);` then it allows you to enter a power symmetric function with all kinds of coefficients, but none of them are rational.\n\n```\nenter kind of object\ninteger     [1]vector      [2]partition   [3]bruch       [4]permutation [6]\nskewpart    [7]tableaux    [8]polynom     [9]schurfunk  [10]matrix     [11]\nhomsym     [13]schubert   [14]kostka     [16]symchar    [18]word       [19]\nlist       [20]longint    [22]powersum   [28]mon. sym.  [29]groupalg.  [32]\nelm. sym.  [33]fin. field [35]reihe      [36]cyclotomic [41]monopoly   [42]\nradical    [43]bitvector  [44]laurent    [45]barperm    [46]\nwhat kind:? 1\n```",
    "created_at": "2013-10-20T21:43:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189598",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:4" align="right">comment:4</div>

To help identify the problem I need to know precisely what steps trigger the error:

```
sage: from sage.libs.symmetrica.all import t_POWSYM_SCHUR as PS
sage: g = PS({Partition([1]*50):ZZ(1)})
sage: PS({Partition([1]*4):ZZ(1)})
s[1, 1, 1, 1] + 3*s[2, 1, 1] + 2*s[2, 2] + 3*s[3, 1] + s[4]
sage: PS({Partition([1]*4):QQ(1)})
s[1, 1, 1, 1] + 3*s[2, 1, 1] + 2*s[2, 2] + 508150636*s[3, 1] + s[4]
```
So it seems that POWSYM to SCHUR over the integers has no visible problems, but POWSYM to SCHUR over the rationals is having the overflow, but only after we've done a sufficiently large calculation (over the integers or rationals).

I'm having a hard time identifying the problem inside of the symmetrica package because if you create a c program with a command `scan(POW_SYM,a);` then it allows you to enter a power symmetric function with all kinds of coefficients, but none of them are rational.

```
enter kind of object
integer     [1]vector      [2]partition   [3]bruch       [4]permutation [6]
skewpart    [7]tableaux    [8]polynom     [9]schurfunk  [10]matrix     [11]
homsym     [13]schubert   [14]kostka     [16]symchar    [18]word       [19]
list       [20]longint    [22]powersum   [28]mon. sym.  [29]groupalg.  [32]
elm. sym.  [33]fin. field [35]reihe      [36]cyclotomic [41]monopoly   [42]
radical    [43]bitvector  [44]laurent    [45]barperm    [46]
what kind:? 1
```



---

archive/issue_comments_189599.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n\"bruch\" means \"fraction\" in German, so maybe that is what a rational should be?",
    "created_at": "2013-10-20T21:45:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189599",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:5" align="right">comment:5</div>

"bruch" means "fraction" in German, so maybe that is what a rational should be?



---

archive/issue_comments_189600.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThanks for that one.  I should have tried it since I didn't know what it was.  I thought `bruch` was not quite breakfast and not quite lunch, but it comes with a slice of canteloupe at the end. You don't get completely what you would at breakfast, but you get a good meal.",
    "created_at": "2013-10-20T21:49:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189600",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:6" align="right">comment:6</div>

Thanks for that one.  I should have tried it since I didn't know what it was.  I thought `bruch` was not quite breakfast and not quite lunch, but it comes with a slice of canteloupe at the end. You don't get completely what you would at breakfast, but you get a good meal.



---

archive/issue_comments_189601.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOk.  I think that I can recreate the error in Symmetrica now.\n\nHere is my test.c program:\n\n```\n\n#include \"def.h\"\n#include \"macro.h\"\n\nANFANG\nscan(POW_SYM,a);\nt_POWSYM_SCHUR(a, b);\nfreeall(a);\nfreeall(b);\na=callocobject();\nb=callocobject();\nscan(POW_SYM,a);\nt_POWSYM_SCHUR(a, b);\nprintln(b);\nENDE\n```\nIn the first `scan` I enter a power sum `p_{1^50}` with coefficient integer 1.  In the second `scan` I enter `p_{1^5}` with a bruch coefficient of `1/1` and my output is:\n\n```\n-6917520240879580904 11111   -20.752587.120249.330592  1112   -27.670133.758739.499376 \n 113   -20.752613.517859.918472  122   -20.752587.120249.330592  14   -20.752613.517859.918472 \n 23  -6917520240879580904 5  \n```",
    "created_at": "2013-10-20T22:09:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189601",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:7" align="right">comment:7</div>

Ok.  I think that I can recreate the error in Symmetrica now.

Here is my test.c program:

```

#include "def.h"
#include "macro.h"

ANFANG
scan(POW_SYM,a);
t_POWSYM_SCHUR(a, b);
freeall(a);
freeall(b);
a=callocobject();
b=callocobject();
scan(POW_SYM,a);
t_POWSYM_SCHUR(a, b);
println(b);
ENDE
```
In the first `scan` I enter a power sum `p_{1^50}` with coefficient integer 1.  In the second `scan` I enter `p_{1^5}` with a bruch coefficient of `1/1` and my output is:

```
-6917520240879580904 11111   -20.752587.120249.330592  1112   -27.670133.758739.499376 
 113   -20.752613.517859.918472  122   -20.752587.120249.330592  14   -20.752613.517859.918472 
 23  -6917520240879580904 5  
```



---

archive/issue_comments_189602.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nJust to make sure that it really is the first calculation that is messing things up, I tried running the same program with a power sum `p_{1^5}` with coefficient integer `1` and in the second `scan` I enter `p_{1^5}` with a bruch coefficient of `1/1`.  In this case my output is as expected:\n\n```\n1 11111  4 1112  6 113  5 122  4 14  5 23  1 5 \n```\n\nI don't have a fix, but it seems to be a garbage collection error and a problem with Macs.",
    "created_at": "2013-10-20T22:19:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189602",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:8" align="right">comment:8</div>

Just to make sure that it really is the first calculation that is messing things up, I tried running the same program with a power sum `p_{1^5}` with coefficient integer `1` and in the second `scan` I enter `p_{1^5}` with a bruch coefficient of `1/1`.  In this case my output is as expected:

```
1 11111  4 1112  6 113  5 122  4 14  5 23  1 5 
```

I don't have a fix, but it seems to be a garbage collection error and a problem with Macs.



---

archive/issue_comments_189603.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI get the same sort of problem with the following test.c program.  This seems to show that the problem is with the 'freeall' and not with the fact that I reuse the `a` and `b` variables.  `ANFANG` is making a bunch of calls to `callocobject` for variables `a` through `h` and `ENDE` is doing a bunch of `freeall` calls for the same variables.\n\n```\n#include \"def.h\"\n#include \"macro.h\"\n\nANFANG\nscan(POW_SYM,a); \nt_POWSYM_SCHUR(a, b); \nfreeall(a);\nfreeall(b);\nscan(POW_SYM,c); \nt_POWSYM_SCHUR(c, d); \nprintln(d); \na = callocobject();\nb = callocobject();\nENDE\n```",
    "created_at": "2013-10-21T11:49:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189603",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:9" align="right">comment:9</div>

I get the same sort of problem with the following test.c program.  This seems to show that the problem is with the 'freeall' and not with the fact that I reuse the `a` and `b` variables.  `ANFANG` is making a bunch of calls to `callocobject` for variables `a` through `h` and `ENDE` is doing a bunch of `freeall` calls for the same variables.

```
#include "def.h"
#include "macro.h"

ANFANG
scan(POW_SYM,a); 
t_POWSYM_SCHUR(a, b); 
freeall(a);
freeall(b);
scan(POW_SYM,c); 
t_POWSYM_SCHUR(c, d); 
println(d); 
a = callocobject();
b = callocobject();
ENDE
```



---

archive/issue_comments_189604.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI should remark that if move the `freeall(a)` and `freeall(b)` lines after the `println(d)` statement then I do not get the same error.\n\nThis leads me to believe that if `c` has rational (bruch) coefficients that it is because when the program starts to allocate the memory for the bruch coefficients that certain bits are not being initialized to 0 and they need to be.  I don't know why this error would be triggered only when `b` uses up a lot of memory.  Maybe if `b` is something huge then the the memory collection reuses memory and if `b` is small then the allocation of `c` and `d` memory is 'clean' and is initialized to 0 already.\n\nI should also remark that the coefficients that are printed out in the `println(d)` are not random (as we are seeing in sage) in that if I insert several copies of `println(d)` in the program they always printout the same random numbers.",
    "created_at": "2013-10-21T12:09:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189604",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:10" align="right">comment:10</div>

I should remark that if move the `freeall(a)` and `freeall(b)` lines after the `println(d)` statement then I do not get the same error.

This leads me to believe that if `c` has rational (bruch) coefficients that it is because when the program starts to allocate the memory for the bruch coefficients that certain bits are not being initialized to 0 and they need to be.  I don't know why this error would be triggered only when `b` uses up a lot of memory.  Maybe if `b` is something huge then the the memory collection reuses memory and if `b` is small then the allocation of `c` and `d` memory is 'clean' and is initialized to 0 already.

I should also remark that the coefficients that are printed out in the `println(d)` are not random (as we are seeing in sage) in that if I insert several copies of `println(d)` in the program they always printout the same random numbers.



---

archive/issue_comments_189605.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHere is something integeresting<sup>(tm)</sup>, if I put the `freeall(a)` and `freeall(b)` **after** the `scan(POW_SYM,c)` line then I get the correct answers.  As in...\n\n```\n#include \"def.h\"\n#include \"macro.h\"\n\nANFANG\nscan(POW_SYM,a);\nt_POWSYM_SCHUR(a, b);\nscan(POW_SYM,c);\nfreeall(a);\nfreeall(b);\nt_POWSYM_SCHUR(c, d);\nprintln(d);\nprintln(d);\na = callocobject();\nb = callocobject();\nENDE\n```\n\nThis means that the problem seems to be in the initialization of `c` (through the `scan`) and *not* in the calculation of `d`.",
    "created_at": "2013-10-21T13:47:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189605",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:11" align="right">comment:11</div>

Here is something integeresting<sup>(tm)</sup>, if I put the `freeall(a)` and `freeall(b)` **after** the `scan(POW_SYM,c)` line then I get the correct answers.  As in...

```
#include "def.h"
#include "macro.h"

ANFANG
scan(POW_SYM,a);
t_POWSYM_SCHUR(a, b);
scan(POW_SYM,c);
freeall(a);
freeall(b);
t_POWSYM_SCHUR(c, d);
println(d);
println(d);
a = callocobject();
b = callocobject();
ENDE
```

This means that the problem seems to be in the initialization of `c` (through the `scan`) and *not* in the calculation of `d`.



---

archive/issue_comments_189606.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSchur enough, if the lines after `t_POWSYM_SCHUR(a, b);` are:\n\n```\nfreeall(a);\nfreeall(b);\nscan(POW_SYM,c);\nprintln(c);\n```\nThen the output of `c` is `-8070441737306486504 11111`.",
    "created_at": "2013-10-21T14:07:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189606",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:12" align="right">comment:12</div>

Schur enough, if the lines after `t_POWSYM_SCHUR(a, b);` are:

```
freeall(a);
freeall(b);
scan(POW_SYM,c);
println(c);
```
Then the output of `c` is `-8070441737306486504 11111`.



---

archive/issue_comments_189607.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI'm getting closer.  When my program is simply:\n\n```\n#include \"def.h\"\n#include \"macro.h\"\n\nANFANG\nscan(POW_SYM,a); \nt_POWSYM_SCHUR(a, b); \nfreeall(a);\nfreeall(b);\nscan_bruch(c); \nprintln(c);\na = callocobject();\nb = callocobject();\nENDE\n```\nand my input for `a` is `p_{1^50}` with coefficient integer `1` and my input for `c` is `1/1` then when it prints out `c` I see `2305851790110509326`.",
    "created_at": "2013-10-21T14:19:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189607",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:13" align="right">comment:13</div>

I'm getting closer.  When my program is simply:

```
#include "def.h"
#include "macro.h"

ANFANG
scan(POW_SYM,a); 
t_POWSYM_SCHUR(a, b); 
freeall(a);
freeall(b);
scan_bruch(c); 
println(c);
a = callocobject();
b = callocobject();
ENDE
```
and my input for `a` is `p_{1^50}` with coefficient integer `1` and my input for `c` is `1/1` then when it prints out `c` I see `2305851790110509326`.



---

archive/issue_comments_189608.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThe error seems to be if the denominator is `1`.  If my input for `c` is a fraction where the denominator is not `1` (e.g. `1/2` or `7/12`) then the output is correct.  If my input for `c` is `1/1` or `14/7` then my output for `c` is some random integer (like `-1152912740476237544`).",
    "created_at": "2013-10-21T14:29:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189608",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:14" align="right">comment:14</div>

The error seems to be if the denominator is `1`.  If my input for `c` is a fraction where the denominator is not `1` (e.g. `1/2` or `7/12`) then the output is correct.  If my input for `c` is `1/1` or `14/7` then my output for `c` is some random integer (like `-1152912740476237544`).



---

archive/issue_comments_189609.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI can also trigger this error by `scan`ing two bruch's and adding them together and then using as input any two rational numbers that add to a whole number.  Their sum seems to be a random integer.",
    "created_at": "2013-10-21T14:39:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189609",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:15" align="right">comment:15</div>

I can also trigger this error by `scan`ing two bruch's and adding them together and then using as input any two rational numbers that add to a whole number.  Their sum seems to be a random integer.



---

archive/issue_comments_189610.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nGuess where the most German is used in the C code?  Anne or Darij, can I assume that a good place to to look for this bug in the functions that begin with the word *kuerzen* in the `bruch.c` file?",
    "created_at": "2013-10-21T14:47:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189610",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:16" align="right">comment:16</div>

Guess where the most German is used in the C code?  Anne or Darij, can I assume that a good place to to look for this bug in the functions that begin with the word *kuerzen* in the `bruch.c` file?



---

archive/issue_comments_189611.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOK, the following just looks wrong to me and it is in `kuerzen_integer_integer` and this same issue seems to appear in several places.\n\n```\n    ggterg = ggt_i(S_B_UI(bruch),S_B_OI(bruch));\n\n    if (ggterg == S_B_UI(bruch)) {\n        freeself_bruch(bruch);\n        M_I_I(S_B_OI(bruch) / ggterg,bruch);\n        goto ende;\n        }\n```\n\nIt seems to say\n(1) calculate the gcd of the numerator (`S_B_OI(bruch)`) and the denominator (`S_B_UI(bruch)`) (2) if the gcd is equal to the denominator then `freeself_bruch(bruch)` and then divide ... and at this point I scream '''wait! don't touch `S_B_OI(bruch)` because `bruch` is already free!\n\nSo I want to change this to the following:\n\n```\n    ggterg = ggt_i(S_B_UI(bruch),S_B_OI(bruch));\n\n    if (ggterg == S_B_UI(bruch)) {\n        tmp = S_B_OI(bruch);\n        freeself_bruch(bruch);\n        M_I_I(tmp / ggterg,bruch);\n        goto ende;\n        }\n```\n\nWhen I do this...guess what!?!?!  I don't seem to see the random integer in the output when I use the test.c from comment 13.  I think that this means I have found the bug.",
    "created_at": "2013-10-21T15:19:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189611",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:17" align="right">comment:17</div>

OK, the following just looks wrong to me and it is in `kuerzen_integer_integer` and this same issue seems to appear in several places.

```
    ggterg = ggt_i(S_B_UI(bruch),S_B_OI(bruch));

    if (ggterg == S_B_UI(bruch)) {
        freeself_bruch(bruch);
        M_I_I(S_B_OI(bruch) / ggterg,bruch);
        goto ende;
        }
```

It seems to say
(1) calculate the gcd of the numerator (`S_B_OI(bruch)`) and the denominator (`S_B_UI(bruch)`) (2) if the gcd is equal to the denominator then `freeself_bruch(bruch)` and then divide ... and at this point I scream '''wait! don't touch `S_B_OI(bruch)` because `bruch` is already free!

So I want to change this to the following:

```
    ggterg = ggt_i(S_B_UI(bruch),S_B_OI(bruch));

    if (ggterg == S_B_UI(bruch)) {
        tmp = S_B_OI(bruch);
        freeself_bruch(bruch);
        M_I_I(tmp / ggterg,bruch);
        goto ende;
        }
```

When I do this...guess what!?!?!  I don't seem to see the random integer in the output when I use the test.c from comment 13.  I think that this means I have found the bug.



---

archive/issue_comments_189612.json:
```json
{
    "body": "Attachment: **[bruch.c.gz](https://github.com/sagemath/sage/files/ticket15312/bruch.c.gz)**",
    "created_at": "2013-10-21T15:34:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189612",
    "user": "https://github.com/zabrocki"
}
```

Attachment: **[bruch.c.gz](https://github.com/sagemath/sage/files/ticket15312/bruch.c.gz)**



---

archive/issue_comments_189613.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nOK.  I have added a file called bruch.c and this should replace the file bruch.c that is currently in the spkg.  Sorry, I probably should have done a diff of some kind rather than the file itself, but its too late now.\n\nJeroen, can you please replace this in the spkg?  As far as I can tell, the 8 or so lines that I changed fixes the original Symmetrica bug.",
    "created_at": "2013-10-21T15:43:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189613",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:18" align="right">comment:18</div>

OK.  I have added a file called bruch.c and this should replace the file bruch.c that is currently in the spkg.  Sorry, I probably should have done a diff of some kind rather than the file itself, but its too late now.

Jeroen, can you please replace this in the spkg?  As far as I can tell, the 8 or so lines that I changed fixes the original Symmetrica bug.



---

archive/issue_comments_189614.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nOK, I'm not a complete NULL.  I can create my own spkg.\n\n[symmetrica-2.0.p9.spkg](http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg)\n\nMy initial tests seem to indicate that this will fix the bug.\n\nApply: trac_15312_doctest-mz.patch\u200b",
    "created_at": "2013-10-21T18:11:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189614",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:19" align="right">comment:19</div>

OK, I'm not a complete NULL.  I can create my own spkg.

[symmetrica-2.0.p9.spkg](http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg)

My initial tests seem to indicate that this will fix the bug.

Apply: trac_15312_doctest-mz.patchâ€‹



---

archive/issue_comments_189615.json:
```json
{
    "body": "Author: **Mike Zabrocki**",
    "created_at": "2013-10-21T18:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189615",
    "user": "https://github.com/zabrocki"
}
```

Author: **Mike Zabrocki**



---

archive/issue_comments_189616.json:
```json
{
    "body": "Dependencies: **#13413**",
    "created_at": "2013-10-21T18:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189616",
    "user": "https://github.com/zabrocki"
}
```

Dependencies: **#13413**



---

archive/issue_events_215728.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-21T18:15:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215728"
}
```



---

archive/issue_comments_189617.json:
```json
{
    "body": "Attachment: **[bruch.diff.gz](https://github.com/sagemath/sage/files/ticket15312/bruch.diff.gz)**",
    "created_at": "2013-10-21T19:44:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189617",
    "user": "https://github.com/zabrocki"
}
```

Attachment: **[bruch.diff.gz](https://github.com/sagemath/sage/files/ticket15312/bruch.diff.gz)**



---

archive/issue_comments_189618.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThe file *bruch.diff* is the only change in the spkg from #13413.",
    "created_at": "2013-10-21T19:46:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189618",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:22" align="right">comment:22</div>

The file *bruch.diff* is the only change in the spkg from #13413.



---

archive/issue_comments_189619.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -56,3 +56,7 @@\n > When (random) big numbers appear like that, it almost always is an integer overflow. I suspect the communication with Symmetrica goes through the native integer. Is this correct? If so, then that's where I'd say the problem lies.\n \n This is a bug which is carried over from #13413 .  When we realized that there are actually two bugs and one has been corrected, these tickets were split.\n+\n+**spkg**: [http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg](http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg)\n+\n+**apply**: [attachment: trac_15312_doctest-mz.patch](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz)\n``````\n",
    "created_at": "2013-10-22T10:33:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189619",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -56,3 +56,7 @@
 > When (random) big numbers appear like that, it almost always is an integer overflow. I suspect the communication with Symmetrica goes through the native integer. Is this correct? If so, then that's where I'd say the problem lies.
 
 This is a bug which is carried over from #13413 .  When we realized that there are actually two bugs and one has been corrected, these tickets were split.
+
+**spkg**: [http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg](http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg)
+
+**apply**: [attachment: trac_15312_doctest-mz.patch](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz)
``````




---

archive/issue_comments_189620.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nYou should **never** change files directly in the `src/` directory in a spkg. Add a patch in the `patches/` directory and document what you did in `SPKG.txt`. Commit all changes and please put up a diff of the full spkg (such a diff should look like [attachment:symmetrica-2.0.p8.diff:ticket:13413).\n\nSee [http://sagemath.org/doc/developer/patching_spkgs.html](http://sagemath.org/doc/developer/patching_spkgs.html)",
    "created_at": "2013-10-22T10:37:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189620",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

You should **never** change files directly in the `src/` directory in a spkg. Add a patch in the `patches/` directory and document what you did in `SPKG.txt`. Commit all changes and please put up a diff of the full spkg (such a diff should look like [attachment:symmetrica-2.0.p8.diff:ticket:13413).

See [http://sagemath.org/doc/developer/patching_spkgs.html](http://sagemath.org/doc/developer/patching_spkgs.html)



---

archive/issue_events_215729.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-22T10:37:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215729"
}
```



---

archive/issue_events_215730.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-22T10:37:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215730"
}
```



---

archive/issue_comments_189621.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nAre you sure the change that you made is ok now? Are you sure that the memory that `tmp` points to isn't freed by `freeself_bruch(bruch)`? Would it not be even safer to free `bruch` even later?",
    "created_at": "2013-10-22T10:41:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189621",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

Are you sure the change that you made is ok now? Are you sure that the memory that `tmp` points to isn't freed by `freeself_bruch(bruch)`? Would it not be even safer to free `bruch` even later?



---

archive/issue_comments_189622.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\ntmp is a uint32_t and not a pointer -- that's what the `S_B_UI` does.",
    "created_at": "2013-10-22T11:13:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189622",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:26" align="right">comment:26</div>

tmp is a uint32_t and not a pointer -- that's what the `S_B_UI` does.



---

archive/issue_comments_189623.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nYou're right, it's not a pointer, so it's safe.",
    "created_at": "2013-10-22T11:36:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189623",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

You're right, it's not a pointer, so it's safe.



---

archive/issue_comments_189624.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI've changed the spkg and included a diff file.  Does it look ok now?  The diff file doesn't quite have the same header information as yours.\n\nIn looking for other instances of this bug, I noticed that other places (e.g. `kuerzen_longint_integer`) have a similar fix that looks like it was corrected before my time.\n\n```\n            INT wi = S_B_OI(bruch);\n            freeself_bruch(bruch);\n            M_I_I(wi,bruch);\n```",
    "created_at": "2013-10-22T12:00:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189624",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:28" align="right">comment:28</div>

I've changed the spkg and included a diff file.  Does it look ok now?  The diff file doesn't quite have the same header information as yours.

In looking for other instances of this bug, I noticed that other places (e.g. `kuerzen_longint_integer`) have a similar fix that looks like it was corrected before my time.

```
            INT wi = S_B_OI(bruch);
            freeself_bruch(bruch);
            M_I_I(wi,bruch);
```



---

archive/issue_comments_189625.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n1) The changes inside the spkg need to be committed (`hg commit`):\n\n```\njdemeyer@boxen:~/spkg/symmetrica-2.0.p9$ hg status\nM SPKG.txt\n? patches/bruch.patch\n```\n\n2) The directory `src/` should be reverted to the **exact** contents it had before, including timestamps (in practice, simply remove `src/` and copy it from the previous spkg):\n\n```\njdemeyer@boxen:~/spkg/symmetrica-2.0.p9$ ls -l src/b*\n-rw-r--r-- 1 jdemeyer jdemeyer 23190 Dec  6  2007 src/bar.c\n-rw-r--r-- 1 jdemeyer jdemeyer  3467 Dec  7  2007 src/bar.doc\n-rw-r--r-- 1 jdemeyer jdemeyer 35117 Dec  6  2007 src/bi.c\n-rw-r--r-- 1 jdemeyer jdemeyer   348 Dec  7  2007 src/bi.doc\n-rw-r--r-- 1 jdemeyer jdemeyer 77748 Dec  6  2007 src/boe.c\n-rw-r--r-- 1 jdemeyer jdemeyer  7150 Dec  7  2007 src/boe.doc\n-rw-r--r-- 1 jdemeyer jdemeyer 59384 Oct 21 21:38 src/bruch.c\n-rw-r--r-- 1 jdemeyer jdemeyer  2122 Dec  7  2007 src/bruch.doc\n```\n\n3) The spkg doesn't install, because of problems with the filenames inside `bruch.patch`:\n\n```\n$ ./sage -i http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg\n[...]\ncan't find file to patch at input line 3\nPerhaps you used the wrong -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|--- ../src/bruch.c     2013-10-21 15:38:23.000000000 -0400\n|+++ ../../symmetrica-2.0.p9/src/bruch.c        2013-10-21 13:35:00.000000000 -0400\n--------------------------\n```",
    "created_at": "2013-10-22T12:14:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189625",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

1) The changes inside the spkg need to be committed (`hg commit`):

```
jdemeyer@boxen:~/spkg/symmetrica-2.0.p9$ hg status
M SPKG.txt
? patches/bruch.patch
```

2) The directory `src/` should be reverted to the **exact** contents it had before, including timestamps (in practice, simply remove `src/` and copy it from the previous spkg):

```
jdemeyer@boxen:~/spkg/symmetrica-2.0.p9$ ls -l src/b*
-rw-r--r-- 1 jdemeyer jdemeyer 23190 Dec  6  2007 src/bar.c
-rw-r--r-- 1 jdemeyer jdemeyer  3467 Dec  7  2007 src/bar.doc
-rw-r--r-- 1 jdemeyer jdemeyer 35117 Dec  6  2007 src/bi.c
-rw-r--r-- 1 jdemeyer jdemeyer   348 Dec  7  2007 src/bi.doc
-rw-r--r-- 1 jdemeyer jdemeyer 77748 Dec  6  2007 src/boe.c
-rw-r--r-- 1 jdemeyer jdemeyer  7150 Dec  7  2007 src/boe.doc
-rw-r--r-- 1 jdemeyer jdemeyer 59384 Oct 21 21:38 src/bruch.c
-rw-r--r-- 1 jdemeyer jdemeyer  2122 Dec  7  2007 src/bruch.doc
```

3) The spkg doesn't install, because of problems with the filenames inside `bruch.patch`:

```
$ ./sage -i http://garsia.math.yorku.ca/~zabrocki/symmetrica-2.0.p9.spkg
[...]
can't find file to patch at input line 3
Perhaps you used the wrong -p or --strip option?
The text leading up to this was:
--------------------------
|--- ../src/bruch.c     2013-10-21 15:38:23.000000000 -0400
|+++ ../../symmetrica-2.0.p9/src/bruch.c        2013-10-21 13:35:00.000000000 -0400
--------------------------
```



---

archive/issue_comments_189626.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nMike: excellent analysis of the problem by the way!",
    "created_at": "2013-10-22T12:17:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189626",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Mike: excellent analysis of the problem by the way!



---

archive/issue_events_215731.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-22T12:22:16Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "title_is": "Fix use of freed memory in Symmetrica",
    "title_was": "fix integer overflow (?) in conversion of powersums to Schur functions",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215731"
}
```



---

archive/issue_comments_189627.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI've fixed the spkg and I think it is all right now.  The src directory has the original time stamps.  I committed the changes and `hg status` is fine.  The spkg installs (not sure what I did wrong there, but should be ok now).  What did you do to create the diff file?",
    "created_at": "2013-10-22T13:12:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189627",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:32" align="right">comment:32</div>

I've fixed the spkg and I think it is all right now.  The src directory has the original time stamps.  I committed the changes and `hg status` is fine.  The spkg installs (not sure what I did wrong there, but should be ok now).  What did you do to create the diff file?



---

archive/issue_comments_189628.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@zabrocki](#comment%3A32):\n> What did you do to create the diff file?\n\nAfter committing, `hg export tip`.",
    "created_at": "2013-10-22T13:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189628",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@zabrocki](#comment%3A32):
> What did you do to create the diff file?

After committing, `hg export tip`.



---

archive/issue_comments_189629.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2013-10-22T13:19:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189629",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_189630.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nIn [attachment: trac_15312_doctest-mz.patch](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz), you are missing a `::`",
    "created_at": "2013-10-22T13:19:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189630",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

In [attachment: trac_15312_doctest-mz.patch](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz), you are missing a `::`



---

archive/issue_comments_189631.json:
```json
{
    "body": "Attachment: **[trac_15312_doctest-mz.patch.gz](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz)**",
    "created_at": "2013-10-22T13:32:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189631",
    "user": "https://github.com/zabrocki"
}
```

Attachment: **[trac_15312_doctest-mz.patch.gz](https://github.com/sagemath/sage/files/ticket15312/trac_15312_doctest-mz.patch.gz)**



---

archive/issue_comments_189632.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nAttachment: **[symmetrica-2.0.p9.diff.gz](https://github.com/sagemath/sage/files/ticket15312/symmetrica-2.0.p9.diff.gz)**",
    "created_at": "2013-10-22T13:34:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189632",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:35" align="right">comment:35</div>

Attachment: **[symmetrica-2.0.p9.diff.gz](https://github.com/sagemath/sage/files/ticket15312/symmetrica-2.0.p9.diff.gz)**



---

archive/issue_events_215732.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-22T13:34:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215732"
}
```



---

archive/issue_events_215733.json:
```json
{
    "actor": "https://github.com/zabrocki",
    "created_at": "2013-10-22T13:34:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215733"
}
```



---

archive/issue_events_215734.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-22T13:45:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215734"
}
```



---

archive/issue_events_215735.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-22T13:45:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215735"
}
```



---

archive/issue_comments_189633.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nThank you!  Having this fixed is a load off of my mind.",
    "created_at": "2013-10-22T14:18:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189633",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:37" align="right">comment:37</div>

Thank you!  Having this fixed is a load off of my mind.



---

archive/issue_events_215736.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-31T19:18:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215736"
}
```



---

archive/issue_events_215737.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-10-31T19:18:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15312#event-215737"
}
```



---

archive/issue_comments_189634.json:
```json
{
    "body": "Merged: **sage-5.13.beta2**",
    "created_at": "2013-10-31T19:18:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15312#issuecomment-189634",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.13.beta2**
