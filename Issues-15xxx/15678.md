# Issue 15678: add discrete Gaussian samplers to Sage

archive/issues_015678.json:
```json
{
    "body": "Keywords: sd59\n\nThis ticket adds samplers for discrete Gaussian distributions to Sage.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15915\n\n",
    "closed_at": "2014-09-10T21:45:17Z",
    "created_at": "2014-03-10T12:52:46Z",
    "labels": [
        "component: statistics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "add discrete Gaussian samplers to Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15678",
    "user": "https://github.com/malb"
}
```
Keywords: sd59

This ticket adds samplers for discrete Gaussian distributions to Sage.

Issue created by migration from https://trac.sagemath.org/ticket/15915





---

archive/issue_comments_202635.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-03-10T12:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202635",
    "user": "https://github.com/malb"
}
```

New commits:



---

archive/issue_comments_202636.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-12T16:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202636",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202637.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-14T14:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202637",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202638.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-15T11:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202638",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202639.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2014-03-15T11:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202639",
    "user": "https://github.com/malb"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_202640.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-03-15T11:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202640",
    "user": "https://github.com/malb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_202641.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-27T16:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202641",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202642.json:
```json
{
    "body": "Daniel Cabarcas looked at the C part of the code, here is what he said (and my reply which I sent via e-mail)\n\n> I looked at the code and I think it is an important improvement over what we had \n> before. I looked in detail at the uniform+table and the uniform+online versions and I > think they are correct. I don't know the details of the logtable algorithms so I \n> didn't looked at the corresponding code. I have a few comments so far:\n\n\n> The name of the library is DGS for discrete Gaussian samplers. However, all \n> implementations are over the integers, and not over a more general lattice. I was \n> wondering if it would be wiser to call it discrete Gaussian over the integers, \n> foreseeing implementations over other lattices.\n\n\nMy idea was to include the discrete Gaussian sampler over lattices (+ cosets)\ninto this implementation. Hence the name. However, for that I needed to do #15976 first. I plan to go back to the samplers over the lattices once both tickets\nare merged (and I can rely on them).\n\n> Have you consider implementing other samplers? if you are looking for speed \n> Knuth-Yao is quite impressive, and if you are looking for a time-memory tradeoff the > discrete Ziggurat algorithm is nice. Moreover, in terms of flexibility of the library > design, do you think it would be easy to add other samplers in the future which \n> require perhaps other parameters?\n\n\nI haven't thought about Knuth-Yao or Ziggurat, do you have any good references at hand? I'm happy to implement more samplers, might as well be comprehensive. I was also thinking about extending the logtable approach to arbitrary Gaussian parameters sigma.\n\nAs for the interface, I guess I should check the two algorithms you mentioned above to see what would need to be generalised. If other parameters are needed in the future I can simply add another constructor which accepts those parameters, that was my thinking anyway.\n\n> I was wondering about the source of randomness. You use standard c functions, which > \n> is probably ok for many tests. However, you know for sure how critical is the source \n> of randomness in crypto implementations. Moreover, there are huge differences in \n> speed between the standard random c function and a secure random function, thus, for \n> testing efficiency of Gaussian samplers it is crucial to have the flexibility to \n> choose your source of randomness. For this reason, in some implementation we did, we \n> had the source of randomness as a parameter. Perhaps, you'd like to consider doing \n> that.\n\n\nI currently have two versions, one using GMP's randstate and one using libc. GMP should give cryptographically strong pseudorandom numbers. In my experience the difference in running time is - as you write - pretty much down to how long it takes to sample random numbers, so I figured I offer one with a good random number generator and one with a fast which is good enough for testing.",
    "created_at": "2014-03-29T14:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202642",
    "user": "https://github.com/malb"
}
```

Daniel Cabarcas looked at the C part of the code, here is what he said (and my reply which I sent via e-mail)

> I looked at the code and I think it is an important improvement over what we had 
> before. I looked in detail at the uniform+table and the uniform+online versions and I > think they are correct. I don't know the details of the logtable algorithms so I 
> didn't looked at the corresponding code. I have a few comments so far:


> The name of the library is DGS for discrete Gaussian samplers. However, all 
> implementations are over the integers, and not over a more general lattice. I was 
> wondering if it would be wiser to call it discrete Gaussian over the integers, 
> foreseeing implementations over other lattices.


My idea was to include the discrete Gaussian sampler over lattices (+ cosets)
into this implementation. Hence the name. However, for that I needed to do #15976 first. I plan to go back to the samplers over the lattices once both tickets
are merged (and I can rely on them).

> Have you consider implementing other samplers? if you are looking for speed 
> Knuth-Yao is quite impressive, and if you are looking for a time-memory tradeoff the > discrete Ziggurat algorithm is nice. Moreover, in terms of flexibility of the library > design, do you think it would be easy to add other samplers in the future which 
> require perhaps other parameters?


I haven't thought about Knuth-Yao or Ziggurat, do you have any good references at hand? I'm happy to implement more samplers, might as well be comprehensive. I was also thinking about extending the logtable approach to arbitrary Gaussian parameters sigma.

As for the interface, I guess I should check the two algorithms you mentioned above to see what would need to be generalised. If other parameters are needed in the future I can simply add another constructor which accepts those parameters, that was my thinking anyway.

> I was wondering about the source of randomness. You use standard c functions, which > 
> is probably ok for many tests. However, you know for sure how critical is the source 
> of randomness in crypto implementations. Moreover, there are huge differences in 
> speed between the standard random c function and a secure random function, thus, for 
> testing efficiency of Gaussian samplers it is crucial to have the flexibility to 
> choose your source of randomness. For this reason, in some implementation we did, we 
> had the source of randomness as a parameter. Perhaps, you'd like to consider doing 
> that.


I currently have two versions, one using GMP's randstate and one using libc. GMP should give cryptographically strong pseudorandom numbers. In my experience the difference in running time is - as you write - pretty much down to how long it takes to sample random numbers, so I figured I offer one with a good random number generator and one with a fast which is good enough for testing.



---

archive/issue_comments_202643.json:
```json
{
    "body": "So, any volunteer reviewers for the Sage part?",
    "created_at": "2014-03-29T14:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202643",
    "user": "https://github.com/malb"
}
```

So, any volunteer reviewers for the Sage part?



---

archive/issue_events_046816.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46816"
}
```



---

archive/issue_comments_202644.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-13T15:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202644",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202645.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-13T16:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202645",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202646.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-14T09:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202646",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202647.json:
```json
{
    "body": "```\nsage -t --long src/sage/rings/integer_ring.pyx  # 1 doctest failed\nsage -t --long src/sage/crypto/lwe.py  # 23 doctests failed\n```",
    "created_at": "2014-05-19T05:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202647",
    "user": "https://github.com/rwst"
}
```

```
sage -t --long src/sage/rings/integer_ring.pyx  # 1 doctest failed
sage -t --long src/sage/crypto/lwe.py  # 23 doctests failed
```



---

archive/issue_comments_202648.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-19T05:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202648",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_202649.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-19T13:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202649",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202650.json:
```json
{
    "body": "Doctests fixed.",
    "created_at": "2014-05-19T13:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202650",
    "user": "https://github.com/malb"
}
```

Doctests fixed.



---

archive/issue_comments_202651.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-05-19T13:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202651",
    "user": "https://github.com/malb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_202652.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-06-25T01:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_202653.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T19:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202654.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd59\".",
    "created_at": "2014-06-25T19:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202654",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "" to "sd59".



---

archive/issue_comments_202655.json:
```json
{
    "body": "Some comments at https://github.com/sagemath/sage/pull/18 (I didn't look at the .c files yet.)",
    "created_at": "2014-06-25T20:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202655",
    "user": "https://github.com/robertwb"
}
```

Some comments at https://github.com/sagemath/sage/pull/18 (I didn't look at the .c files yet.)



---

archive/issue_comments_202656.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T21:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202656",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202657.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-26T00:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202658.json:
```json
{
    "body": "I don't feel able to review all the code, but testing it seems to work ok.\n\nI just think it would make sense for the samplers over the polynomials to accept the polynomial ring as an input.",
    "created_at": "2014-06-26T04:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202658",
    "user": "https://github.com/miguelmarco"
}
```

I don't feel able to review all the code, but testing it seems to work ok.

I just think it would make sense for the samplers over the polynomials to accept the polynomial ring as an input.



---

archive/issue_comments_202659.json:
```json
{
    "body": "Replying to [comment:22 mmarco]:\n> I just think it would make sense for the samplers over the polynomials to accept the polynomial ring as an input.\n\n\n\nAlready taken care off :)",
    "created_at": "2014-06-26T14:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202659",
    "user": "https://github.com/malb"
}
```

Replying to [comment:22 mmarco]:
> I just think it would make sense for the samplers over the polynomials to accept the polynomial ring as an input.



Already taken care off :)



---

archive/issue_comments_202660.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-27T18:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202661.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-27T19:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202662.json:
```json
{
    "body": "Some comments/questions:\n\nIn the `fmpz_poly` linkage: What is the except -2 good for? Do these flint methods return -2 on error? Shouldn't you use sig_on()/sig_off() rather?\n\nWhat is the reason for the following in `Polynomial_integer_dense_flint`?\n\n```\n- elif not isinstance(x, list):\n-    x = [x] # constant polynomials\n+ else:\n+    try:\n+       x = list(x)\n+    except TypeError:\n+       x = [x] # constant polynomials\n```\n\nIn `polynomial_quotient_ring.py`, why don't you use `r\"\"\"` so you can write `\\ZZ`? Also, there are now a lot of unicode characters; even though you put an encoding in the header, my vim does not understand these characters (strangely) and they also confused the patchbot.\n\nI stopped reading at `dgs.h`. Would you mind relicensing this as GPLv2+? Should such things not be in an SPKG? I wonder if the amount of documentation is sufficient for including it directly in Sage and also if anybody can really review this (I cannot review that part I'm afraid.)",
    "created_at": "2014-06-28T07:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202662",
    "user": "https://github.com/saraedum"
}
```

Some comments/questions:

In the `fmpz_poly` linkage: What is the except -2 good for? Do these flint methods return -2 on error? Shouldn't you use sig_on()/sig_off() rather?

What is the reason for the following in `Polynomial_integer_dense_flint`?

```
- elif not isinstance(x, list):
-    x = [x] # constant polynomials
+ else:
+    try:
+       x = list(x)
+    except TypeError:
+       x = [x] # constant polynomials
```

In `polynomial_quotient_ring.py`, why don't you use `r"""` so you can write `\ZZ`? Also, there are now a lot of unicode characters; even though you put an encoding in the header, my vim does not understand these characters (strangely) and they also confused the patchbot.

I stopped reading at `dgs.h`. Would you mind relicensing this as GPLv2+? Should such things not be in an SPKG? I wonder if the amount of documentation is sufficient for including it directly in Sage and also if anybody can really review this (I cannot review that part I'm afraid.)



---

archive/issue_comments_202663.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-06-28T07:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202663",
    "user": "https://github.com/saraedum"
}
```

New commits:



---

archive/issue_comments_202664.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-06-28T07:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202664",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_202665.json:
```json
{
    "body": "It seems you were working off the wrong branch. Your branch has \n\n   `polynomial_quotient_integer_dense_flint.pyx`\n\nin it, which it shouldn't ... oh, looks like I pushed to the wrong branch at some point. Sorry, I'll fix that.",
    "created_at": "2014-06-28T14:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202665",
    "user": "https://github.com/malb"
}
```

It seems you were working off the wrong branch. Your branch has 

   `polynomial_quotient_integer_dense_flint.pyx`

in it, which it shouldn't ... oh, looks like I pushed to the wrong branch at some point. Sorry, I'll fix that.



---

archive/issue_comments_202666.json:
```json
{
    "body": "Replying to [comment:26 saraedum]:\n> Some comments/questions:\n> \n> In the `fmpz_poly` linkage: What is the except -2 good for? Do these flint methods return -2 on error? Shouldn't you use sig_on()/sig_off() rather?\n\n\nIt's the standard signature of `clement_*` functions used by polynomial templates. Specifiying -2 there allows to throw exceptions in C functions. This code wasn't meant to be in this ticket, though, see above. My apologies. The code in question belonged to #16574 but has been removed.\n \n> What is the reason for the following in `Polynomial_integer_dense_flint`?\n> \n> ```\n> - elif not isinstance(x, list):\n> -    x = [x] # constant polynomials\n> + else:\n> +    try:\n> +       x = list(x)\n> +    except TypeError:\n> +       x = [x] # constant polynomials\n> ```\n\n\nThis code wasn't meant to be in this ticket, my apologoies. It belongs in #16574. It allows `R(tuple(x))` and `R(vector(x))` to go through. \n\n> In `polynomial_quotient_ring.py`, why don't you use `r\"\"\"` so you can write `\\ZZ`? \n\n\nI could do that, I find the other notation more straight-forward, is there a particular reason why one is preferable to the other?\n\n> Also, there are now a lot of unicode characters; even though you put an encoding in the header, my vim does not understand these characters (strangely) and they also confused the patchbot.\n\n\nI can remove them but that'd make the code less readable IMHO.\n \n> I stopped reading at `dgs.h`. Would you mind relicensing this as GPLv2+? \n\n\nI have no strong feelings either way, what would be the advantage? I am quite happy with the code being BSD, it's not very sophisticated and BSD licensing it allows anyone to use it.\n\n> Should such things not be in an SPKG? \n\n\nThe C code really does only one thing, so an SPKG would be a bit of an overkill. Also, SPKG's take votes and extra bureaucracy. I'd like to avoid that, it's hard enough to get this stuff reviewed.\n\n> I wonder if the amount of documentation is sufficient for including it directly in Sage and also if anybody can really review this (I cannot review that part I'm afraid.)\n\n\nDaniel Cabarcas reviewed the C part. I can add more documentation.",
    "created_at": "2014-06-28T14:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202666",
    "user": "https://github.com/malb"
}
```

Replying to [comment:26 saraedum]:
> Some comments/questions:
> 
> In the `fmpz_poly` linkage: What is the except -2 good for? Do these flint methods return -2 on error? Shouldn't you use sig_on()/sig_off() rather?


It's the standard signature of `clement_*` functions used by polynomial templates. Specifiying -2 there allows to throw exceptions in C functions. This code wasn't meant to be in this ticket, though, see above. My apologies. The code in question belonged to #16574 but has been removed.
 
> What is the reason for the following in `Polynomial_integer_dense_flint`?
> 
> ```
> - elif not isinstance(x, list):
> -    x = [x] # constant polynomials
> + else:
> +    try:
> +       x = list(x)
> +    except TypeError:
> +       x = [x] # constant polynomials
> ```


This code wasn't meant to be in this ticket, my apologoies. It belongs in #16574. It allows `R(tuple(x))` and `R(vector(x))` to go through. 

> In `polynomial_quotient_ring.py`, why don't you use `r"""` so you can write `\ZZ`? 


I could do that, I find the other notation more straight-forward, is there a particular reason why one is preferable to the other?

> Also, there are now a lot of unicode characters; even though you put an encoding in the header, my vim does not understand these characters (strangely) and they also confused the patchbot.


I can remove them but that'd make the code less readable IMHO.
 
> I stopped reading at `dgs.h`. Would you mind relicensing this as GPLv2+? 


I have no strong feelings either way, what would be the advantage? I am quite happy with the code being BSD, it's not very sophisticated and BSD licensing it allows anyone to use it.

> Should such things not be in an SPKG? 


The C code really does only one thing, so an SPKG would be a bit of an overkill. Also, SPKG's take votes and extra bureaucracy. I'd like to avoid that, it's hard enough to get this stuff reviewed.

> I wonder if the amount of documentation is sufficient for including it directly in Sage and also if anybody can really review this (I cannot review that part I'm afraid.)


Daniel Cabarcas reviewed the C part. I can add more documentation.



---

archive/issue_comments_202667.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-06-28T18:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202667",
    "user": "https://github.com/malb"
}
```

New commits:



---

archive/issue_comments_202668.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-28T22:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202668",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202669.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-06-28T22:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202669",
    "user": "https://github.com/malb"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_202670.json:
```json
{
    "body": "Based on discussions locally at SD59 and the latest check in I am setting this back to *needs review*.",
    "created_at": "2014-06-28T22:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202670",
    "user": "https://github.com/malb"
}
```

Based on discussions locally at SD59 and the latest check in I am setting this back to *needs review*.



---

archive/issue_comments_202671.json:
```json
{
    "body": "A few questions (line numbers are all in the version I pushed):\n\n* Should it really be x-2 in line 518 of dgs_gauss.h?\n\n* What is the TODO in dgs_gauss_dp.c?\n\n* `self->c_r = 0.0;` after an abort() in line 114 and 130 of dgs_gaus_dp.c?\n\n* What is \"this B\" in line 186 of discrete_gaussian_lattice.py?",
    "created_at": "2014-06-29T06:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202671",
    "user": "https://github.com/saraedum"
}
```

A few questions (line numbers are all in the version I pushed):

* Should it really be x-2 in line 518 of dgs_gauss.h?

* What is the TODO in dgs_gauss_dp.c?

* `self->c_r = 0.0;` after an abort() in line 114 and 130 of dgs_gaus_dp.c?

* What is "this B" in line 186 of discrete_gaussian_lattice.py?



---

archive/issue_comments_202672.json:
```json
{
    "body": "Replying to [comment:35 saraedum]:\n> A few questions (line numbers are all in the version I pushed):\n> \n> * Should it really be x-2 in line 518 of dgs_gauss.h?\n\n\nIt should read x-c, fixed.\n\n> * What is the TODO in dgs_gauss_dp.c?\n\n\nThis was a left-over, removed.\n \n> * `self->c_r = 0.0;` after an abort() in line 114 and 130 of dgs_gaus_dp.c?\n\n\nRemoved.\n \n> * What is \"this B\" in line 186 of discrete_gaussian_lattice.py?\n\n\nself.B, fixed this.\n\n---\nNew commits:",
    "created_at": "2014-06-29T17:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202672",
    "user": "https://github.com/malb"
}
```

Replying to [comment:35 saraedum]:
> A few questions (line numbers are all in the version I pushed):
> 
> * Should it really be x-2 in line 518 of dgs_gauss.h?


It should read x-c, fixed.

> * What is the TODO in dgs_gauss_dp.c?


This was a left-over, removed.
 
> * `self->c_r = 0.0;` after an abort() in line 114 and 130 of dgs_gaus_dp.c?


Removed.
 
> * What is "this B" in line 186 of discrete_gaussian_lattice.py?


self.B, fixed this.

---
New commits:



---

archive/issue_comments_202673.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-29T18:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202673",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_202674.json:
```json
{
    "body": "PDF docs don't build\n\n```\n! Missing $ inserted.\n<inserted text> \n                $\nl.2746 \n       \n? \n! Emergency stop.\n<inserted text> \n                $\nl.2746 \n```\nin ./src/doc/output/latex/en/reference/stats/stats.log",
    "created_at": "2014-06-30T03:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202674",
    "user": "https://github.com/vbraun"
}
```

PDF docs don't build

```
! Missing $ inserted.
<inserted text> 
                $
l.2746 
       
? 
! Emergency stop.
<inserted text> 
                $
l.2746 
```
in ./src/doc/output/latex/en/reference/stats/stats.log



---

archive/issue_comments_202675.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-06-30T03:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202675",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_202676.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-30T14:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202676",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202677.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-06-30T14:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202677",
    "user": "https://github.com/malb"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_202678.json:
```json
{
    "body": "Fixed. Setting it back to \"positive review\" (?)",
    "created_at": "2014-06-30T14:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202678",
    "user": "https://github.com/malb"
}
```

Fixed. Setting it back to "positive review" (?)



---

archive/issue_comments_202679.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-30T16:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202679",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_046817.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-30T16:33:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46817"
}
```



---

archive/issue_comments_202680.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2014-07-01T01:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202680",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_046818.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-01T01:04:34Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46818"
}
```



---

archive/issue_comments_202681.json:
```json
{
    "body": "Various builbots report:\n\n```\nsage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 263, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__\nFailed example:\n    min(l), max(l), abs(mean(l)-2.5) < 0.01\nExpected:\n    (-2, 7, True)\nGot:\n    (-3, 7, True)\n```\nAlso, on 32-bit linux:\n\n```\n\nsage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 38, in sage.stats.distributions.discrete_gaussian_integer\nFailed example:\n    x=0; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\nExpected:\n    (13350, 13298)\nGot:\n    (13355, 13298)\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 40, in sage.stats.distributions.discrete_gaussian_integer\nFailed example:\n    x=4; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\nExpected:\n    (5543, 5467)\nGot:\n    (5479, 5467)\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 42, in sage.stats.distributions.discrete_gaussian_integer\nFailed example:\n    x=-10; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))\nExpected:\n    (46, 51)\nGot:\n    (53, 51)\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 68, in sage.stats.distributions.discrete_gaussian_integer\nFailed example:\n    mean(l).n() # long time\nExpected:\n    0.48678000000...\nGot:\n    0.486650000000000\n**********************************************************************\n1 item had failures:\n   4 of  21 in sage.stats.distributions.discrete_gaussian_integer\n    [88 tests, 4 failures, 7.06 s]\nsage -t --long src/sage/schemes/toric/variety.py\n    [499 tests, 9.23 s]\nsage -t --long src/sage/stats/distributions/discrete_gaussian_polynomial.py\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_polynomial.py\", line 70, in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler\nFailed example:\n    [gs() for _ in xrange(3)]\nExpected:\n    [4*x^7 + 4*x^6 - 2*x^5 + x^4 + 4*x^2 - 2*x + 7, 5*x^7 - 4*x^6 + 3*x^4 - 4*x^3 + x^2 - 4, 2*x^7 + 2*x^6 + x^5 + 2*x^3 - 3*x^2 + x]\nGot:\n    [4*x^7 + 4*x^6 - 4*x^5 + 2*x^4 + x^3 - 4*x + 7, -5*x^6 + 4*x^5 - 3*x^3 + 4*x^2 + x, 2*x^7 + 2*x^6 + 2*x^5 - x^4 - 2*x^2 + 3*x + 1]\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_polynomial.py\", line 97, in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler.__init__\nFailed example:\n    [gs() for _ in xrange(3)]\nExpected:\n    [4*x^7 + 4*x^6 - 2*x^5 + x^4 + 4*x^2 - 2*x + 7, 5*x^7 - 4*x^6 + 3*x^4 - 4*x^3 + x^2 - 4, 2*x^7 + 2*x^6 + x^5 + 2*x^3 - 3*x^2 + x]\nGot:\n    [4*x^7 + 4*x^6 - 4*x^5 + 2*x^4 + x^3 - 4*x + 7, -5*x^6 + 4*x^5 - 3*x^3 + 4*x^2 + x, 2*x^7 + 2*x^6 + 2*x^5 - x^4 - 2*x^2 + 3*x + 1]\n**********************************************************************\n2 items had failures:\n   1 of   5 in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler\n   1 of   5 in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler.__init__\n    [18 tests, 2 failures, 0.76 s]\n```\nAlso some crypto stuff failed, though I don't know if it is related\n\n```\n4 items had failures:\n   4 of  15 in sage.crypto.lwe\n   1 of   7 in sage.crypto.lwe.RingLWE.__call__\n   2 of   7 in sage.crypto.lwe.balance_sample\n   3 of   7 in sage.crypto.lwe.samples\n    [100 tests, 10 failures, 0.60 s]\n```\nSee http://build.sagemath.org/sage/builders/%20%20fast%20Oxford%20arando%20%28Ubuntu%2013.04%20i686%29%20incremental/builds/172/steps/shell_4/logs/stdio",
    "created_at": "2014-07-01T01:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202681",
    "user": "https://github.com/vbraun"
}
```

Various builbots report:

```
sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 263, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__
Failed example:
    min(l), max(l), abs(mean(l)-2.5) < 0.01
Expected:
    (-2, 7, True)
Got:
    (-3, 7, True)
```
Also, on 32-bit linux:

```

sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 38, in sage.stats.distributions.discrete_gaussian_integer
Failed example:
    x=0; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
Expected:
    (13350, 13298)
Got:
    (13355, 13298)
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 40, in sage.stats.distributions.discrete_gaussian_integer
Failed example:
    x=4; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
Expected:
    (5543, 5467)
Got:
    (5479, 5467)
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 42, in sage.stats.distributions.discrete_gaussian_integer
Failed example:
    x=-10; l.count(x), ZZ(round(n*exp(-x^2/(2*sigma^2))/norm_factor))
Expected:
    (46, 51)
Got:
    (53, 51)
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 68, in sage.stats.distributions.discrete_gaussian_integer
Failed example:
    mean(l).n() # long time
Expected:
    0.48678000000...
Got:
    0.486650000000000
**********************************************************************
1 item had failures:
   4 of  21 in sage.stats.distributions.discrete_gaussian_integer
    [88 tests, 4 failures, 7.06 s]
sage -t --long src/sage/schemes/toric/variety.py
    [499 tests, 9.23 s]
sage -t --long src/sage/stats/distributions/discrete_gaussian_polynomial.py
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_polynomial.py", line 70, in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler
Failed example:
    [gs() for _ in xrange(3)]
Expected:
    [4*x^7 + 4*x^6 - 2*x^5 + x^4 + 4*x^2 - 2*x + 7, 5*x^7 - 4*x^6 + 3*x^4 - 4*x^3 + x^2 - 4, 2*x^7 + 2*x^6 + x^5 + 2*x^3 - 3*x^2 + x]
Got:
    [4*x^7 + 4*x^6 - 4*x^5 + 2*x^4 + x^3 - 4*x + 7, -5*x^6 + 4*x^5 - 3*x^3 + 4*x^2 + x, 2*x^7 + 2*x^6 + 2*x^5 - x^4 - 2*x^2 + 3*x + 1]
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_polynomial.py", line 97, in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler.__init__
Failed example:
    [gs() for _ in xrange(3)]
Expected:
    [4*x^7 + 4*x^6 - 2*x^5 + x^4 + 4*x^2 - 2*x + 7, 5*x^7 - 4*x^6 + 3*x^4 - 4*x^3 + x^2 - 4, 2*x^7 + 2*x^6 + x^5 + 2*x^3 - 3*x^2 + x]
Got:
    [4*x^7 + 4*x^6 - 4*x^5 + 2*x^4 + x^3 - 4*x + 7, -5*x^6 + 4*x^5 - 3*x^3 + 4*x^2 + x, 2*x^7 + 2*x^6 + 2*x^5 - x^4 - 2*x^2 + 3*x + 1]
**********************************************************************
2 items had failures:
   1 of   5 in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler
   1 of   5 in sage.stats.distributions.discrete_gaussian_polynomial.DiscreteGaussianPolynomialSampler.__init__
    [18 tests, 2 failures, 0.76 s]
```
Also some crypto stuff failed, though I don't know if it is related

```
4 items had failures:
   4 of  15 in sage.crypto.lwe
   1 of   7 in sage.crypto.lwe.RingLWE.__call__
   2 of   7 in sage.crypto.lwe.balance_sample
   3 of   7 in sage.crypto.lwe.samples
    [100 tests, 10 failures, 0.60 s]
```
See http://build.sagemath.org/sage/builders/%20%20fast%20Oxford%20arando%20%28Ubuntu%2013.04%20i686%29%20incremental/builds/172/steps/shell_4/logs/stdio



---

archive/issue_comments_202682.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2014-07-01T01:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202682",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_202683.json:
```json
{
    "body": "Replying to [comment:44 vbraun]:\n> Various builbots report:\n> \n> ```\n> sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx\n> **********************************************************************\n> File \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 263, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__\n> Failed example:\n>     min(l), max(l), abs(mean(l)-2.5) < 0.01\n> Expected:\n>     (-2, 7, True)\n> Got:\n>     (-3, 7, True)\n> ```\n\n\nOn what kind of machine is this on? I cannot reproduce it on either 64 or 32 bit Linux.\n\n> Also, on 32-bit linux:\n\n\nI can reproduce those and am currenly testing a fix (some default value was machine dependent).\n\n> Also some crypto stuff failed, though I don't know if it is related\n> \n> ```\n> 4 items had failures:\n>    4 of  15 in sage.crypto.lwe\n>    1 of   7 in sage.crypto.lwe.RingLWE.__call__\n>    2 of   7 in sage.crypto.lwe.balance_sample\n>    3 of   7 in sage.crypto.lwe.samples\n>     [100 tests, 10 failures, 0.60 s]\n> ```\n\n\nThese are related, thanks.",
    "created_at": "2014-07-01T18:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202683",
    "user": "https://github.com/malb"
}
```

Replying to [comment:44 vbraun]:
> Various builbots report:
> 
> ```
> sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx
> **********************************************************************
> File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 263, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__
> Failed example:
>     min(l), max(l), abs(mean(l)-2.5) < 0.01
> Expected:
>     (-2, 7, True)
> Got:
>     (-3, 7, True)
> ```


On what kind of machine is this on? I cannot reproduce it on either 64 or 32 bit Linux.

> Also, on 32-bit linux:


I can reproduce those and am currenly testing a fix (some default value was machine dependent).

> Also some crypto stuff failed, though I don't know if it is related
> 
> ```
> 4 items had failures:
>    4 of  15 in sage.crypto.lwe
>    1 of   7 in sage.crypto.lwe.RingLWE.__call__
>    2 of   7 in sage.crypto.lwe.balance_sample
>    3 of   7 in sage.crypto.lwe.samples
>     [100 tests, 10 failures, 0.60 s]
> ```


These are related, thanks.



---

archive/issue_comments_202684.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2014-07-01T18:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202684",
    "user": "https://github.com/malb"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_202685.json:
```json
{
    "body": "I should have fixed the 32-bit issues. \n\nI would guess these additional patches **need review** again as they are not mere documentation/doctest fixes, but changes to the code.\n\nI set the ticket to **needs info** because the first doctest failure is still unaccounted for (see above).\n\n---\nLast 10 new commits:",
    "created_at": "2014-07-01T18:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202685",
    "user": "https://github.com/malb"
}
```

I should have fixed the 32-bit issues. 

I would guess these additional patches **need review** again as they are not mere documentation/doctest fixes, but changes to the code.

I set the ticket to **needs info** because the first doctest failure is still unaccounted for (see above).

---
Last 10 new commits:



---

archive/issue_comments_202686.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-01T19:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202686",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202687.json:
```json
{
    "body": "Hi Volker, any idea how I could reproduce that first doctest failure? I don't get it on the 64-bit and 32-bit Linux systems I tried.",
    "created_at": "2014-07-07T09:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202687",
    "user": "https://github.com/malb"
}
```

Hi Volker, any idea how I could reproduce that first doctest failure? I don't get it on the 64-bit and 32-bit Linux systems I tried.



---

archive/issue_comments_202688.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-04T17:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202688",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202689.json:
```json
{
    "body": "Replying to [comment:48 malb]:\n> Hi Volker, any idea how I could reproduce that first doctest failure? I don't get it on the 64-bit and 32-bit Linux systems I tried.\n\n\nIt seems my question slipped through the cracks.",
    "created_at": "2014-08-04T17:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202689",
    "user": "https://github.com/malb"
}
```

Replying to [comment:48 malb]:
> Hi Volker, any idea how I could reproduce that first doctest failure? I don't get it on the 64-bit and 32-bit Linux systems I tried.


It seems my question slipped through the cracks.



---

archive/issue_events_046819.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46819"
}
```



---

archive/issue_events_046820.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46820"
}
```



---

archive/issue_comments_202690.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-11T10:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202690",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_202691.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-08-12T13:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202691",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_046821.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-08-12T13:18:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46821"
}
```



---

archive/issue_comments_202692.json:
```json
{
    "body": "I got this failure now on arando (32-bit linux). It worked on the previous test run, so the failure is non-deterministic. Try running tests in a loop to reproduce.\n\n```\nsage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx\n**********************************************************************\nFile \"src/sage/stats/distributions/discrete_gaussian_integer.pyx\", line 251, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__\nFailed example:\n    min(l) == 0-2*1.0, max(l) == 0+2*1.0, abs(mean(l)) < 0.01\nExpected:\n    (True, True, True)\nGot:\n    (True, True, False)\n**********************************************************************\n1 item had failures:\n   1 of  48 in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__\n    [88 tests, 1 failure, 7.14 s]\n```",
    "created_at": "2014-08-13T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202692",
    "user": "https://github.com/vbraun"
}
```

I got this failure now on arando (32-bit linux). It worked on the previous test run, so the failure is non-deterministic. Try running tests in a loop to reproduce.

```
sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 251, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__
Failed example:
    min(l) == 0-2*1.0, max(l) == 0+2*1.0, abs(mean(l)) < 0.01
Expected:
    (True, True, True)
Got:
    (True, True, False)
**********************************************************************
1 item had failures:
   1 of  48 in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianIntegerSampler.__init__
    [88 tests, 1 failure, 7.14 s]
```



---

archive/issue_comments_202693.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2014-08-13T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202693",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_202694.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2014-08-13T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202694",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_046822.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-08-13T10:41:54Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46822"
}
```



---

archive/issue_comments_202695.json:
```json
{
    "body": "Hi, thanks for providing this. I've just committed a \"fix\". With precision='dp' results are not reproducible (our random seed does not control C's random()). I clarified this a bit more in the documentation and increased the allowed bound. Unfortunately, on the only 32-bit machine I have access to, I cannot reproduce the doctest failure, so I can ask you to run it again?",
    "created_at": "2014-08-13T14:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202695",
    "user": "https://github.com/malb"
}
```

Hi, thanks for providing this. I've just committed a "fix". With precision='dp' results are not reproducible (our random seed does not control C's random()). I clarified this a bit more in the documentation and increased the allowed bound. Unfortunately, on the only 32-bit machine I have access to, I cannot reproduce the doctest failure, so I can ask you to run it again?



---

archive/issue_comments_202696.json:
```json
{
    "body": "The name `DiscreteGaussianIntegerSampler` might be a bit confusing to some people: at first reading it seems you're sampling from the Gaussian integers (which are discrete).\n\nWouldn't `DiscreteGaussianDistributionSampler` be a more descriptive name? I get the impression that Discrete Gaussian Distribution is normally used for the distributions on the integers you're referring to.\n\nThe fact that you truncate at `tau*sigma` also seems to disqualify this from legitimately being called \"sampling from a discrete gaussian distribution\", but I hope this is standard abuse of terminology in the field (and the difference is hard to see).\n\nIt also suggests that if the rejection rate is high (it would be for larger values of `tau`) it might be worth sampling from a binomial distribution with adapted rejection rates. The shape should be much closer to your desired distribution and hence should lead to a much lower rejection rate. It depends a bit on whether the new rejection probabilities are sufficiently easy to compute to be worth it.",
    "created_at": "2014-08-18T15:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202696",
    "user": "https://github.com/nbruin"
}
```

The name `DiscreteGaussianIntegerSampler` might be a bit confusing to some people: at first reading it seems you're sampling from the Gaussian integers (which are discrete).

Wouldn't `DiscreteGaussianDistributionSampler` be a more descriptive name? I get the impression that Discrete Gaussian Distribution is normally used for the distributions on the integers you're referring to.

The fact that you truncate at `tau*sigma` also seems to disqualify this from legitimately being called "sampling from a discrete gaussian distribution", but I hope this is standard abuse of terminology in the field (and the difference is hard to see).

It also suggests that if the rejection rate is high (it would be for larger values of `tau`) it might be worth sampling from a binomial distribution with adapted rejection rates. The shape should be much closer to your desired distribution and hence should lead to a much lower rejection rate. It depends a bit on whether the new rejection probabilities are sufficiently easy to compute to be worth it.



---

archive/issue_comments_202697.json:
```json
{
    "body": "Replying to [comment:56 nbruin]:\n> The name `DiscreteGaussianIntegerSampler` might be a bit confusing to some people: at first reading it seems you're sampling from the Gaussian integers (which are discrete).\n> Wouldn't `DiscreteGaussianDistributionSampler` be a more descriptive name? I get the impression that Discrete Gaussian Distribution is normally used for the distributions on the integers you're referring to.\n\n\nThe name was chosen to allow for samplers over lattices and polynomial rings as well: `DiscreteGaussianLatticeSampler` and `DiscreteGaussianPolynomialSampler`.\n\nI can change it to `DiscreteGaussianDistributionIntegerSampler` or something if I get a commitment that this change is reviewed in a timely fashion. This patch has had a hard time getting reviewed so I am not opening it up again lightly.\n\n> The fact that you truncate at `tau*sigma` also seems to disqualify this from legitimately being called \"sampling from a discrete gaussian distribution\", but I hope this is standard abuse of terminology in the field (and the difference is hard to see).\n\n\nThe difference is hard to see due to the tail bound. Roughly: Pr[x <- D | |x| > C*sigma] <= 2/(C sqrt(2*pi)) * exp(-C<sup>2</sup>/2). This is also the standard approach in the literature.\n\n> It also suggests that if the rejection rate is high (it would be for larger values of `tau`) it might be worth sampling from a binomial distribution with adapted rejection rates. The shape should be much closer to your desired distribution and hence should lead to a much lower rejection rate. It depends a bit on whether the new rejection probabilities are sufficiently easy to compute to be worth it.\n\n\nSampling from other distributions has been considered in the literature. The \"sigma2+logtable\" algorithm is a result of such an investigation in:\n\n   [DDLL13] L\u00e9o Ducas, Alain Durmus, Tancr\u00e8de Lepoint and Vadim\nLyubashevsky. *Lattice Signatures and Bimodal Gaussians*; in Advances in\n   Cryptology \u2013 CRYPTO 2013; Lecture Notes in Computer Science Volume 8042,\n   2013, pp 40-56 http://www.di.ens.fr/~lyubash/papers/bimodal.pdf",
    "created_at": "2014-08-18T16:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202697",
    "user": "https://github.com/malb"
}
```

Replying to [comment:56 nbruin]:
> The name `DiscreteGaussianIntegerSampler` might be a bit confusing to some people: at first reading it seems you're sampling from the Gaussian integers (which are discrete).
> Wouldn't `DiscreteGaussianDistributionSampler` be a more descriptive name? I get the impression that Discrete Gaussian Distribution is normally used for the distributions on the integers you're referring to.


The name was chosen to allow for samplers over lattices and polynomial rings as well: `DiscreteGaussianLatticeSampler` and `DiscreteGaussianPolynomialSampler`.

I can change it to `DiscreteGaussianDistributionIntegerSampler` or something if I get a commitment that this change is reviewed in a timely fashion. This patch has had a hard time getting reviewed so I am not opening it up again lightly.

> The fact that you truncate at `tau*sigma` also seems to disqualify this from legitimately being called "sampling from a discrete gaussian distribution", but I hope this is standard abuse of terminology in the field (and the difference is hard to see).


The difference is hard to see due to the tail bound. Roughly: Pr[x <- D | |x| > C*sigma] <= 2/(C sqrt(2*pi)) * exp(-C<sup>2</sup>/2). This is also the standard approach in the literature.

> It also suggests that if the rejection rate is high (it would be for larger values of `tau`) it might be worth sampling from a binomial distribution with adapted rejection rates. The shape should be much closer to your desired distribution and hence should lead to a much lower rejection rate. It depends a bit on whether the new rejection probabilities are sufficiently easy to compute to be worth it.


Sampling from other distributions has been considered in the literature. The "sigma2+logtable" algorithm is a result of such an investigation in:

   [DDLL13] Lo Ducas, Alain Durmus, Tancrde Lepoint and Vadim
Lyubashevsky. *Lattice Signatures and Bimodal Gaussians*; in Advances in
   Cryptology  CRYPTO 2013; Lecture Notes in Computer Science Volume 8042,
   2013, pp 40-56 http://www.di.ens.fr/~lyubash/papers/bimodal.pdf



---

archive/issue_comments_202698.json:
```json
{
    "body": "Running `sage -t --global-iterations 100 src/sage/stats/distributions/discrete_gaussian_integer.pyx` on 32-bit Archlinux passes.\n\nHere are the last circa 210 lines of output in abbreviated form:\n\n```\n...\nsage -t src/sage/stats/distributions/discrete_gaussian_integer.pyx\n   [82 tests, 16.02 s]\n----------------------------------------------------------------------\nDoctests interrupted: 1/1 files tested\nDoctests interrupted: 2/1 files tested\n...\nDoctests interrupted: 98/1 files tested\nDoctests interrupted: 99/1 files tested\n----------------------------------------------------------------------\nTotal time for all tests: 16.1 seconds\n    cpu time: 1625.9 seconds\n    cumulative wall time: 1627.1 seconds\nsage -t src/sage/stats/distributions/discrete_gaussian_integer.pyx\n    [82 tests, 15.99 s]\n----------------------------------------------------------------------\nDoctests interrupted: 1/1 files tested\nDoctests interrupted: 2/1 files tested\n...\nDoctests interrupted: 98/1 files tested\nDoctests interrupted: 99/1 files tested\n----------------------------------------------------------------------\nTotal time for all tests: 16.1 seconds\n    cpu time: 1641.9 seconds\n    cumulative wall time: 1643.1 seconds\n```\n\nApart from this ticket's branch, I have also merged those of tickets #15316 and #16480, as I need those for building.",
    "created_at": "2014-08-18T23:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202698",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

Running `sage -t --global-iterations 100 src/sage/stats/distributions/discrete_gaussian_integer.pyx` on 32-bit Archlinux passes.

Here are the last circa 210 lines of output in abbreviated form:

```
...
sage -t src/sage/stats/distributions/discrete_gaussian_integer.pyx
   [82 tests, 16.02 s]
----------------------------------------------------------------------
Doctests interrupted: 1/1 files tested
Doctests interrupted: 2/1 files tested
...
Doctests interrupted: 98/1 files tested
Doctests interrupted: 99/1 files tested
----------------------------------------------------------------------
Total time for all tests: 16.1 seconds
    cpu time: 1625.9 seconds
    cumulative wall time: 1627.1 seconds
sage -t src/sage/stats/distributions/discrete_gaussian_integer.pyx
    [82 tests, 15.99 s]
----------------------------------------------------------------------
Doctests interrupted: 1/1 files tested
Doctests interrupted: 2/1 files tested
...
Doctests interrupted: 98/1 files tested
Doctests interrupted: 99/1 files tested
----------------------------------------------------------------------
Total time for all tests: 16.1 seconds
    cpu time: 1641.9 seconds
    cumulative wall time: 1643.1 seconds
```

Apart from this ticket's branch, I have also merged those of tickets #15316 and #16480, as I need those for building.



---

archive/issue_comments_202699.json:
```json
{
    "body": "Thanks for running those. As far as I can tell, this means for you, too, doctests pass.",
    "created_at": "2014-08-19T09:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202699",
    "user": "https://github.com/malb"
}
```

Thanks for running those. As far as I can tell, this means for you, too, doctests pass.



---

archive/issue_comments_202700.json:
```json
{
    "body": "I renamed `DiscreteGaussianIntegerSampler` to `DiscreteGaussianDistributionIntegerSampler`. Nils, can you review this commit?",
    "created_at": "2014-08-19T10:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202700",
    "user": "https://github.com/malb"
}
```

I renamed `DiscreteGaussianIntegerSampler` to `DiscreteGaussianDistributionIntegerSampler`. Nils, can you review this commit?



---

archive/issue_comments_202701.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-19T10:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202701",
    "user": "https://github.com/malb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_202702.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2014-08-26T15:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202702",
    "user": "https://github.com/malb"
}
```

Last 10 new commits:



---

archive/issue_comments_202703.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-09T22:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202703",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_046823.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-10T21:45:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15678#event-46823"
}
```



---

archive/issue_comments_202704.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-10T21:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202704",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_202705.json:
```json
{
    "body": "See #16968 for a follow-up",
    "created_at": "2014-09-11T15:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15678#issuecomment-202705",
    "user": "https://github.com/vbraun"
}
```

See #16968 for a follow-up
