# Issue 15506: Fix another "recursion depth exceeded" in memory deallocation for weak dictionaries

archive/issues_015269.json:
```json
{
    "assignees": [],
    "body": "See: http://trac.sagemath.org/ticket/10963?replyto=174#comment:159 and follow up for details\n\nThis is a follow up to #13394 #15069, and a blocker for #10963.\n\n\nDepends on #15432\n\nCC:  @sagetrac-sage-combinat @vbraun @jdemeyer @simon-king-jena\n\nComponent: **performance**\n\nAuthor: **Nils Bruin**\n\nBranch/Commit: **[u/SimonKing/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15506) @ [`6147777`](https://github.com/sagemath/sagetrac-mirror/commit/614777716fa30b68fd22322435cc273430209f7d)**\n\nReviewer: **Simon King**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15506_\n\n",
    "closed_at": "2013-12-24T20:24:08Z",
    "created_at": "2013-12-10T06:27:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/performance",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix another \"recursion depth exceeded\" in memory deallocation for weak dictionaries",
    "type": "issue",
    "updated_at": "2013-12-24T20:24:08Z",
    "url": "https://github.com/sagemath/sage/issues/15506",
    "user": "https://github.com/nthiery"
}
```
See: http://trac.sagemath.org/ticket/10963?replyto=174#comment:159 and follow up for details

This is a follow up to #13394 #15069, and a blocker for #10963.


Depends on #15432

CC:  @sagetrac-sage-combinat @vbraun @jdemeyer @simon-king-jena

Component: **performance**

Author: **Nils Bruin**

Branch/Commit: **[u/SimonKing/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15506) @ [`6147777`](https://github.com/sagemath/sagetrac-mirror/commit/614777716fa30b68fd22322435cc273430209f7d)**

Reviewer: **Simon King**

_Issue created by migration from https://trac.sagemath.org/ticket/15506_





---

archive/issue_events_218885.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2013-12-10T06:27:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "milestone_number": null,
    "milestone_title": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218885"
}
```



---

archive/issue_events_218886.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2013-12-10T06:27:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/performance",
    "label_color": "696969",
    "label_name": "performance",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218886"
}
```



---

archive/issue_events_218887.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2013-12-10T06:27:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218887"
}
```



---

archive/issue_events_218888.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2013-12-10T06:27:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218888"
}
```



---

archive/issue_comments_193390.json:
```json
{
    "body": "Branch: **[u/nbruin/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15506)**",
    "created_at": "2013-12-10T08:06:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193390",
    "user": "https://github.com/nbruin"
}
```

Branch: **[u/nbruin/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15506)**



---

archive/issue_comments_193391.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThis should do the trick for `WeakValueDictionary`. Merge #15367 to get the same benefit for `MonoDict` and `TripleDict`.\n\nCode that verifies the problem has been solved:\n\n```\nsage: class A: pass\nsage: from sage.misc.weak_dict import WeakValueDictionary\nsage: a=A(); prev=a;\nsage: M=WeakValueDictionary()\nsage: for i in range(10^3+10): newA = A(); M[newA] = prev; prev = newA\nsage: del a\n```\nThis used to fail, but with the code on this branch it works.\n\n---\nNew commits:\n<table><tr><td><code>[5de9c7c](https://github.com/sagemath/sagetrac-mirror/commit/5de9c7c)</code></td><td><code>trac 15506: ensure that WeakValueDictionary deletes entries via a list, so that we benefit from Python's trashcan</code></td></tr></table>\n",
    "created_at": "2013-12-10T08:10:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193391",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2" align="right">comment:2</div>

This should do the trick for `WeakValueDictionary`. Merge #15367 to get the same benefit for `MonoDict` and `TripleDict`.

Code that verifies the problem has been solved:

```
sage: class A: pass
sage: from sage.misc.weak_dict import WeakValueDictionary
sage: a=A(); prev=a;
sage: M=WeakValueDictionary()
sage: for i in range(10^3+10): newA = A(); M[newA] = prev; prev = newA
sage: del a
```
This used to fail, but with the code on this branch it works.

---
New commits:
<table><tr><td><code>[5de9c7c](https://github.com/sagemath/sagetrac-mirror/commit/5de9c7c)</code></td><td><code>trac 15506: ensure that WeakValueDictionary deletes entries via a list, so that we benefit from Python's trashcan</code></td></tr></table>




---

archive/issue_comments_193392.json:
```json
{
    "body": "Commit: **[`5de9c7c`](https://github.com/sagemath/sagetrac-mirror/commit/5de9c7c33caab20a44a8ba955d3b12548f2f0c25)**",
    "created_at": "2013-12-10T08:10:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193392",
    "user": "https://github.com/nbruin"
}
```

Commit: **[`5de9c7c`](https://github.com/sagemath/sagetrac-mirror/commit/5de9c7c33caab20a44a8ba955d3b12548f2f0c25)**



---

archive/issue_comments_193393.json:
```json
{
    "body": "Changed commit from **[`5de9c7c`](https://github.com/sagemath/sagetrac-mirror/commit/5de9c7c33caab20a44a8ba955d3b12548f2f0c25)** to **[`e23ec99`](https://github.com/sagemath/sagetrac-mirror/commit/e23ec990e914edea0cff655ff188716279b33afc)**",
    "created_at": "2013-12-10T08:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193393",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5de9c7c`](https://github.com/sagemath/sagetrac-mirror/commit/5de9c7c33caab20a44a8ba955d3b12548f2f0c25)** to **[`e23ec99`](https://github.com/sagemath/sagetrac-mirror/commit/e23ec990e914edea0cff655ff188716279b33afc)**



---

archive/issue_comments_193394.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><code>[e23ec99](https://github.com/sagemath/sagetrac-mirror/commit/e23ec99)</code></td><td><code>Merge branch 'ticket/15432' into ticket/15506</code></td></tr><tr><td><code>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</code></td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr><tr><td><code>[8b70d1d](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d)</code></td><td><code>trac #15432: also equip iteration context with a weak reference</code></td></tr><tr><td><code>[9bb9241](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241)</code></td><td><code>trac #15432: use a callback class object holding a weak reference for sage.misc.weak_dict.WeakValueDictionary</code></td></tr></table>\n",
    "created_at": "2013-12-10T08:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193394",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><code>[e23ec99](https://github.com/sagemath/sagetrac-mirror/commit/e23ec99)</code></td><td><code>Merge branch 'ticket/15432' into ticket/15506</code></td></tr><tr><td><code>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</code></td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr><tr><td><code>[8b70d1d](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d)</code></td><td><code>trac #15432: also equip iteration context with a weak reference</code></td></tr><tr><td><code>[9bb9241](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241)</code></td><td><code>trac #15432: use a callback class object holding a weak reference for sage.misc.weak_dict.WeakValueDictionary</code></td></tr></table>




---

archive/issue_comments_193395.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nOops... while we're at it, we should merge #15432 as well. Do I need to merge #15367 into this branch as well or do we leave that separate?",
    "created_at": "2013-12-10T08:24:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193395",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

Oops... while we're at it, we should merge #15432 as well. Do I need to merge #15367 into this branch as well or do we leave that separate?



---

archive/issue_comments_193396.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThat was quick :-) Thank you Nils!\n\nIs there a reason for not putting the above code that verifies the solution as a doctest?\n\nOther than that, what shall we do? Backport this ticket and its dependencies to mercurial, or move #10963 to git?",
    "created_at": "2013-12-10T08:29:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193396",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:5" align="right">comment:5</div>

That was quick :-) Thank you Nils!

Is there a reason for not putting the above code that verifies the solution as a doctest?

Other than that, what shall we do? Backport this ticket and its dependencies to mercurial, or move #10963 to git?



---

archive/issue_comments_193397.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@nthiery](#comment%3A5):\n> Is there a reason for not putting the above code that verifies the solution as a doctest?\n\nNo, if you want to add a doctest, go ahead.\n> Backport this ticket and its dependencies to mercurial, or move #10963 to git?\n\nI have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.",
    "created_at": "2013-12-10T08:34:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193397",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@nthiery](#comment%3A5):
> Is there a reason for not putting the above code that verifies the solution as a doctest?

No, if you want to add a doctest, go ahead.
> Backport this ticket and its dependencies to mercurial, or move #10963 to git?

I have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.



---

archive/issue_comments_193398.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@nbruin](#comment%3A6):\n> Replying to [@nthiery](#comment%3A5):\n> > Is there a reason for not putting the above code that verifies the solution as a doctest?\n\n> No, if you want to add a doctest, go ahead.\n\n\n> > Backport this ticket and its dependencies to mercurial, or move #10963 to git?\n\n> I have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.\n\nI am fine with both, as long as it goes quickly. Volker, Jeroen, what do you think from a release management point of view?",
    "created_at": "2013-12-10T08:44:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193398",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@nbruin](#comment%3A6):
> Replying to [@nthiery](#comment%3A5):
> > Is there a reason for not putting the above code that verifies the solution as a doctest?

> No, if you want to add a doctest, go ahead.


> > Backport this ticket and its dependencies to mercurial, or move #10963 to git?

> I have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.

I am fine with both, as long as it goes quickly. Volker, Jeroen, what do you think from a release management point of view?



---

archive/issue_comments_193399.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI don't see a good reason to force this ticket in Sage 5.13. So it should not be a blocker and should be postponed to Sage 6.0 which means git.",
    "created_at": "2013-12-10T08:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193399",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

I don't see a good reason to force this ticket in Sage 5.13. So it should not be a blocker and should be postponed to Sage 6.0 which means git.



---

archive/issue_events_218889.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-10T08:46:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "milestone_number": null,
    "milestone_title": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218889"
}
```



---

archive/issue_events_218890.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-10T08:46:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "milestone_number": null,
    "milestone_title": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218890"
}
```



---

archive/issue_events_218891.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-10T08:46:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218891"
}
```



---

archive/issue_events_218892.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-10T08:46:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218892"
}
```



---

archive/issue_events_218893.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-12-16T23:13:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218893"
}
```



---

archive/issue_events_218894.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "milestone_number": null,
    "milestone_title": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218894"
}
```



---

archive/issue_events_218895.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218895"
}
```



---

archive/issue_comments_193400.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\ncan we get this reviewed? ;-)",
    "created_at": "2013-12-17T20:17:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193400",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">comment:12</div>

can we get this reviewed? ;-)



---

archive/issue_comments_193401.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@vbraun](#comment%3A12):\n> can we get this reviewed? ;-)\n\nI suppose this is independent of the patch:\n\n```\nFile \"src/sage/dev/sagedev.py\", line 89, in sage.dev.sagedev.SageDev\nFailed example:\n    dev._sagedev\nException raised:\n    Traceback (most recent call last):\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.dev.sagedev.SageDev[0]>\", line 1, in <module>\n        dev._sagedev\n      File \"lazy_import.pyx\", line 312, in sage.misc.lazy_import.LazyImport.__getattr__ (sage/misc/lazy_import.c:2402)\n      File \"lazy_import.pyx\", line 248, in sage.misc.lazy_import.LazyImport._get_object (sage/misc/lazy_import.c:1885)\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev_wrapper.py\", line 250, in <module>\n        dev = SageDevWrapper(SageDev())\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev.py\", line 171, in __init__\n        self.__branch_to_ticket = SavingDict(ticket_file)\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py\", line 116, in __init__\n        self._write()\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py\", line 236, in _write\n        assert os.path.abspath(self._filename).startswith(SAGE_TMP), error\n    AssertionError: write attempt to a saving_dict in a doctest\n```",
    "created_at": "2013-12-17T20:21:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193401",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@vbraun](#comment%3A12):
> can we get this reviewed? ;-)

I suppose this is independent of the patch:

```
File "src/sage/dev/sagedev.py", line 89, in sage.dev.sagedev.SageDev
Failed example:
    dev._sagedev
Exception raised:
    Traceback (most recent call last):
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.dev.sagedev.SageDev[0]>", line 1, in <module>
        dev._sagedev
      File "lazy_import.pyx", line 312, in sage.misc.lazy_import.LazyImport.__getattr__ (sage/misc/lazy_import.c:2402)
      File "lazy_import.pyx", line 248, in sage.misc.lazy_import.LazyImport._get_object (sage/misc/lazy_import.c:1885)
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev_wrapper.py", line 250, in <module>
        dev = SageDevWrapper(SageDev())
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev.py", line 171, in __init__
        self.__branch_to_ticket = SavingDict(ticket_file)
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py", line 116, in __init__
        self._write()
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py", line 236, in _write
        assert os.path.abspath(self._filename).startswith(SAGE_TMP), error
    AssertionError: write attempt to a saving_dict in a doctest
```



---

archive/issue_comments_193402.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nIs it really needed to additionally import this during startup:\n\n```\n+New:\n+    sage.combinat.binary_recurrence_sequences\n+    sage.libs.pari.handle_error\n+    sage.misc.weak_dict\n```\nI am particularly talking about binary recurrence sequences.",
    "created_at": "2013-12-17T20:23:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193402",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:14" align="right">comment:14</div>

Is it really needed to additionally import this during startup:

```
+New:
+    sage.combinat.binary_recurrence_sequences
+    sage.libs.pari.handle_error
+    sage.misc.weak_dict
```
I am particularly talking about binary recurrence sequences.



---

archive/issue_comments_193403.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nHas this really been introduced by this branch:\n\n```\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:37 +    sage: R100 = RealField(100) # pr\u00c3\u00a9cision : 100 bits.$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:43 +    sage: Rdefaut = RealField()  # pr\u00c3\u00a9cision par d\u00c3\u00a9faut de 53 bits$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:64 +    sage: x = 1.0         # x appartient \u00c3  RealField()$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:65 +    sage: x = 0.1e+1      # idem : x appartient \u00c3  RealField()$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:67 +    sage: x = RDF(1)      # x est un flottant double pr\u00c3\u00a9cision machine$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:68 +    sage: x = RDF(1.)     # idem : x est un flottant double pr\u00c3\u00a9cision$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:72 +    sage: x = R(1)        # x est un flottant de pr\u00c3\u00a9cision 20 bits$\n```\nOr is this from #14320?",
    "created_at": "2013-12-17T20:25:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193403",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

Has this really been introduced by this branch:

```
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:37 +    sage: R100 = RealField(100) # prÃ©cision : 100 bits.$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:43 +    sage: Rdefaut = RealField()  # prÃ©cision par dÃ©faut de 53 bits$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:64 +    sage: x = 1.0         # x appartient Ã  RealField()$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:65 +    sage: x = 0.1e+1      # idem : x appartient Ã  RealField()$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:67 +    sage: x = RDF(1)      # x est un flottant double prÃ©cision machine$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:68 +    sage: x = RDF(1.)     # idem : x est un flottant double prÃ©cision$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:72 +    sage: x = R(1)        # x est un flottant de prÃ©cision 20 bits$
```
Or is this from #14320?



---

archive/issue_comments_193404.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nConcerning additional imports and Calcul-math things:\n\nNone of that is directly effected by commits on this ticket, so it has to from the state of \"master\" on which this branch is based.\n\nThis ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)",
    "created_at": "2013-12-17T21:07:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193404",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

Concerning additional imports and Calcul-math things:

None of that is directly effected by commits on this ticket, so it has to from the state of "master" on which this branch is based.

This ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)



---

archive/issue_comments_193405.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@nbruin](#comment%3A16):\n> Concerning additional imports and Calcul-math things:\n> \n> None of that is directly effected by commits on this ticket, so it has to from the state of \"master\" on which this branch is based.\n\nOK, so, it is a bug in the plugins.\n\n> This ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)\n\nAnd now I am really confused.\n\nIn #15432, you introduce a weak reference from the callback to the weak value dictionary. Namely, on #15432, you point out that when passing the weak value dictionary to the callback via a closure then there are examples requiring many garbage collections to clear a weak value dictionary.\n\nNow, you revert this change. Can you explain why you did so? Doesn't this re-introduce the problem that you fixed in #15432? If not: Why not? And why did you merge #15432 into this branch? What is left from #15432 in the HEAD of this branch?",
    "created_at": "2013-12-18T16:51:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193405",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@nbruin](#comment%3A16):
> Concerning additional imports and Calcul-math things:
> 
> None of that is directly effected by commits on this ticket, so it has to from the state of "master" on which this branch is based.

OK, so, it is a bug in the plugins.

> This ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)

And now I am really confused.

In #15432, you introduce a weak reference from the callback to the weak value dictionary. Namely, on #15432, you point out that when passing the weak value dictionary to the callback via a closure then there are examples requiring many garbage collections to clear a weak value dictionary.

Now, you revert this change. Can you explain why you did so? Doesn't this re-introduce the problem that you fixed in #15432? If not: Why not? And why did you merge #15432 into this branch? What is left from #15432 in the HEAD of this branch?



---

archive/issue_comments_193406.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nHm. I just tested that the problematic behaviour (namely: Numerous garbage collection cycles required to clear the dict) does not occur with your branch. Could it perhaps be the case that I was (again) reading in a wrong way the diff shown by trac?",
    "created_at": "2013-12-18T16:56:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193406",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">comment:18</div>

Hm. I just tested that the problematic behaviour (namely: Numerous garbage collection cycles required to clear the dict) does not occur with your branch. Could it perhaps be the case that I was (again) reading in a wrong way the diff shown by trac?



---

archive/issue_comments_193407.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@simon-king-jena](#comment%3A17):\n> And why did you merge #15432 into this branch?\n\nI figured that this was the new way to express a \"dependency\" on another ticket. It results in the branch I would have ended up with if I had started this ticket based on the branch there.\n\n> What is left from #15432 in the HEAD of this branch?\n\nEverything, I think. I really just merged and it did so without conflict. Certainly all the commits listed at #15432 show up in the history here.",
    "created_at": "2013-12-18T17:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193407",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@simon-king-jena](#comment%3A17):
> And why did you merge #15432 into this branch?

I figured that this was the new way to express a "dependency" on another ticket. It results in the branch I would have ended up with if I had started this ticket based on the branch there.

> What is left from #15432 in the HEAD of this branch?

Everything, I think. I really just merged and it did so without conflict. Certainly all the commits listed at #15432 show up in the history here.



---

archive/issue_comments_193408.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThen perhaps I was misreading what trac showed me as diff.\n\nI now took #15432, merged with master, and compare it with the branch from here, merged with master.\n\nThese are the differences I see with `git diff ticket/15432 ticket/15506`:\n\n- You put certain to-be-deleted things into tuples, in order to use Python's trashcan.\n- You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.\n\nSo, are these the changes I have to review here?\n\nBest regards,\nSimon",
    "created_at": "2013-12-18T17:25:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193408",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

Then perhaps I was misreading what trac showed me as diff.

I now took #15432, merged with master, and compare it with the branch from here, merged with master.

These are the differences I see with `git diff ticket/15432 ticket/15506`:

- You put certain to-be-deleted things into tuples, in order to use Python's trashcan.
- You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.

So, are these the changes I have to review here?

Best regards,
Simon



---

archive/issue_comments_193409.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@simon-king-jena](#comment%3A20):\n\n> These are the differences I see with `git diff ticket/15432 ticket/15506`:\n> \n> - You put certain to-be-deleted things into tuples, in order to use Python's trashcan.\n\nCorrect (isn't it a list rather than a tuple? Doesn't matter for our purposes, though).\n\n> - You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.\n\nThat's from #15432. It's more than speed: it also saves us from having to keep a weakened reference in the IterationContext, so it makes it easier to avoid circular references. I was actually surprised to see the complication that a context produced here.\n\nIn addition to these changes, #15432 also introduces an WeakKeyDictionary eraser class to make it possible to keep a weak reference (and avoid circular references).\n\nI'd recommend just reviewing all of this here and be done with it (unless you feel any of this is controversial of course)",
    "created_at": "2013-12-18T18:24:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193409",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@simon-king-jena](#comment%3A20):

> These are the differences I see with `git diff ticket/15432 ticket/15506`:
> 
> - You put certain to-be-deleted things into tuples, in order to use Python's trashcan.

Correct (isn't it a list rather than a tuple? Doesn't matter for our purposes, though).

> - You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.

That's from #15432. It's more than speed: it also saves us from having to keep a weakened reference in the IterationContext, so it makes it easier to avoid circular references. I was actually surprised to see the complication that a context produced here.

In addition to these changes, #15432 also introduces an WeakKeyDictionary eraser class to make it possible to keep a weak reference (and avoid circular references).

I'd recommend just reviewing all of this here and be done with it (unless you feel any of this is controversial of course)



---

archive/issue_comments_193410.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nSimon, are you still reviewing this and #15432? The list of commits in question is https://github.com/sagemath/sagetrac-mirror/commits/u%2Fnbruin%2Fticket%2F15506&qt=range&q=develop..u%2Fnbruin%2Fticket%2F15506",
    "created_at": "2013-12-22T17:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193410",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:22" align="right">comment:22</div>

Simon, are you still reviewing this and #15432? The list of commits in question is https://github.com/sagemath/sagetrac-mirror/commits/u%2Fnbruin%2Fticket%2F15506&qt=range&q=develop..u%2Fnbruin%2Fticket%2F15506



---

archive/issue_comments_193411.json:
```json
{
    "body": "Dependencies: **#15432**",
    "created_at": "2013-12-22T17:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193411",
    "user": "https://github.com/vbraun"
}
```

Dependencies: **#15432**



---

archive/issue_comments_193412.json:
```json
{
    "body": "Author: **Nils Bruin**",
    "created_at": "2013-12-22T17:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193412",
    "user": "https://github.com/vbraun"
}
```

Author: **Nils Bruin**



---

archive/issue_comments_193413.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nSince #15432 is a dependency, I'll review this first. I am building the #15432-branch right now (after merging the develop branch).",
    "created_at": "2013-12-22T17:11:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193413",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

Since #15432 is a dependency, I'll review this first. I am building the #15432-branch right now (after merging the develop branch).



---

archive/issue_comments_193414.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAm I right that I don't need to push a merge with my review-commit from #15432, since there is no merge conflict?",
    "created_at": "2013-12-23T21:14:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193414",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

Am I right that I don't need to push a merge with my review-commit from #15432, since there is no merge conflict?



---

archive/issue_comments_193415.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nYes, if there is no conflict then you don't have to merge.",
    "created_at": "2013-12-23T21:15:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193415",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

Yes, if there is no conflict then you don't have to merge.



---

archive/issue_comments_193416.json:
```json
{
    "body": "Reviewer: **Simon King**",
    "created_at": "2013-12-23T22:50:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193416",
    "user": "https://github.com/simon-king-jena"
}
```

Reviewer: **Simon King**



---

archive/issue_events_218896.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-12-23T22:50:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218896"
}
```



---

archive/issue_events_218897.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-12-23T22:50:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218897"
}
```



---

archive/issue_comments_193417.json:
```json
{
    "body": "Changed branch from **[u/nbruin/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15506)** to **[u/SimonKing/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15506)**",
    "created_at": "2013-12-23T22:50:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193417",
    "user": "https://github.com/simon-king-jena"
}
```

Changed branch from **[u/nbruin/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15506)** to **[u/SimonKing/ticket/15506](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15506)**



---

archive/issue_comments_193418.json:
```json
{
    "body": "Changed commit from **[`e23ec99`](https://github.com/sagemath/sagetrac-mirror/commit/e23ec990e914edea0cff655ff188716279b33afc)** to **[`6147777`](https://github.com/sagemath/sagetrac-mirror/commit/614777716fa30b68fd22322435cc273430209f7d)**",
    "created_at": "2013-12-23T22:50:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193418",
    "user": "https://github.com/simon-king-jena"
}
```

Changed commit from **[`e23ec99`](https://github.com/sagemath/sagetrac-mirror/commit/e23ec990e914edea0cff655ff188716279b33afc)** to **[`6147777`](https://github.com/sagemath/sagetrac-mirror/commit/614777716fa30b68fd22322435cc273430209f7d)**



---

archive/issue_comments_193419.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI have added the example from commit:2 as a doc test (otherwise the fix wouldn't be tested against).\n\nAll tests pass (including the new one), and the code makes sense. I only wonder if we can use Python's trashcan in a different more efficient way (such as to avoid the creation of a list of length two during deletion of a dictionary item). But I think this ticket is about fixing a bug in the first place, and if we see the need for yet more efficiency, we can open another ticket.\n\nI.e.: Positive review.",
    "created_at": "2013-12-23T22:50:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193419",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

I have added the example from commit:2 as a doc test (otherwise the fix wouldn't be tested against).

All tests pass (including the new one), and the code makes sense. I only wonder if we can use Python's trashcan in a different more efficient way (such as to avoid the creation of a list of length two during deletion of a dictionary item). But I think this ticket is about fixing a bug in the first place, and if we see the need for yet more efficiency, we can open another ticket.

I.e.: Positive review.



---

archive/issue_comments_193420.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nYeah, that's a nice Chrismas present :-) Thanks Simon, thanks Nils!",
    "created_at": "2013-12-24T07:33:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15506#issuecomment-193420",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:27" align="right">comment:27</div>

Yeah, that's a nice Chrismas present :-) Thanks Simon, thanks Nils!



---

archive/issue_events_218898.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-24T20:24:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218898"
}
```



---

archive/issue_events_218899.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "0e8f0b704d0b6aa6a2f479d4d25b1cc6a84025ff",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2013-12-24T20:24:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15506",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15506#event-218899"
}
```
