# Issue 15114: disallow dangerous coercions to RIF

archive/issues_014877.json:
```json
{
    "body": "Remove the following coercions because they make interval arithmetic much less trustworthy.\n* `RealField` --> `RealIntervalField`\n* `float` --> `ComplexIntervalField`\n* `SR` --> `ComplexIntervalField`\n\nFor example, one could easily do the following by accident.\n\n```\n    sage: iv = 1 + 2^(-55) + 0. + RIF(1)\n    sage: iv.lower(), iv.upper()\n    (2.00000000000000, 2.00000000000000)\n```\n\nSee also [this topic on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/zfg0PhFR_qA)\n\nAlready removed in other tickets:\n* `ComplexField` --> `ComplexIntervalField`\n\nCC:  @videlec @mezzarobba @dkrenn @cheuberg @bhutz @JohnCremona @pjbruin\n\nKeywords: RIF RR interval coercion\n\nBranch/Commit: 3c7644f483a64f33159a1632e3b2426436a9cf50\n\nReviewer: Vincent Delecroix\n\nAuthor: Marc Mezzarobba\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15114\n\n",
    "closed_at": "2021-02-20T10:46:39Z",
    "created_at": "2013-08-28T09:59:55Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "disallow dangerous coercions to RIF",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15114",
    "user": "https://github.com/mstreng"
}
```
Remove the following coercions because they make interval arithmetic much less trustworthy.
* `RealField` --> `RealIntervalField`
* `float` --> `ComplexIntervalField`
* `SR` --> `ComplexIntervalField`

For example, one could easily do the following by accident.

```
    sage: iv = 1 + 2^(-55) + 0. + RIF(1)
    sage: iv.lower(), iv.upper()
    (2.00000000000000, 2.00000000000000)
```

See also [this topic on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/zfg0PhFR_qA)

Already removed in other tickets:
* `ComplexField` --> `ComplexIntervalField`

CC:  @videlec @mezzarobba @dkrenn @cheuberg @bhutz @JohnCremona @pjbruin

Keywords: RIF RR interval coercion

Branch/Commit: 3c7644f483a64f33159a1632e3b2426436a9cf50

Reviewer: Vincent Delecroix

Author: Marc Mezzarobba

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15114





---

archive/issue_comments_202528.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n Remove the following coercions because they make interval arithmetic much less trustworthy.\n-* RR --> RIF\n-* CC --> CIF\n-* RealField --> RealIntervalField\n-* ComplexField --> ComplexIntervalField\n+* `RR` --> `RIF`\n+* `CC` --> `CIF`\n+* `RealField` --> `RealIntervalField`\n+* `ComplexField` --> `ComplexIntervalField`\n \n For example, one could easily do the following by accident.\n \n``````\n",
    "created_at": "2013-08-28T17:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202528",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
 Remove the following coercions because they make interval arithmetic much less trustworthy.
-* RR --> RIF
-* CC --> CIF
-* RealField --> RealIntervalField
-* ComplexField --> ComplexIntervalField
+* `RR` --> `RIF`
+* `CC` --> `CIF`
+* `RealField` --> `RealIntervalField`
+* `ComplexField` --> `ComplexIntervalField`
 
 For example, one could easily do the following by accident.
 
``````




---

archive/issue_events_043528.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43528"
}
```



---

archive/issue_comments_202529.json:
```json
{
    "body": "<a id='comment:4'></a>I think this change will cause many more problems than it solves.\n\nIn practice: I expect this will break a lot of existing code. I often use the RR --> RIF coercion intentionally, because it makes it more convenient to do exactly what I want. For instance:\n\n* In an interval branch-and-bound code, cell widths in a geometric decomposition are expressed as reciprocal powers of two, which can be efficiently stored and used as EXACT floating-point numbers. Combining these in arithmetic operations with intervals gives the same results as explicitly converting them to RIF, without having to do the explicit conversion.\n\n* Interval arithmetic is a fast way to obtain approximate bounds on floating-point calculations over ranges of parameters, by simply replacing the parameter of interest with an interval. To do this without RR --> RIF, one would have to add explicit conversions of *all* other parameters appearing in combination with this parameter *everywhere* it occurs.\n\nIn theory: I think the motivation is flawed. The change was proposed to avoid accidental coercion of exact ring values to RIF via potentially inexact RR. But the problem in this case is the first step, not the second, and reflects the need for a direct coercion from the exact ring to RIF. In such a case, the lack of such a coercion is the bug. Whereas each value in RR *does* have a valid coercion to RIF, and the lack of this coercion would also be a bug.\n\nRealistically, I think anyone who is actually \n\n1. using RIF to do reliable computing *and* \n2. coercing values from other exact rings that *don't* have direct coercions to RIF *and* are not expressible exactly in RR,\n\nis going to be sufficiently aware of the potential problem that they will handle/check the conversion explicitly. Better to expect this than to inconvenience many users who use this coercion in far less arcane circumstances.",
    "created_at": "2014-03-14T19:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202529",
    "user": "https://trac.sagemath.org/admin/accounts/users/tcoffee"
}
```

<a id='comment:4'></a>I think this change will cause many more problems than it solves.

In practice: I expect this will break a lot of existing code. I often use the RR --> RIF coercion intentionally, because it makes it more convenient to do exactly what I want. For instance:

* In an interval branch-and-bound code, cell widths in a geometric decomposition are expressed as reciprocal powers of two, which can be efficiently stored and used as EXACT floating-point numbers. Combining these in arithmetic operations with intervals gives the same results as explicitly converting them to RIF, without having to do the explicit conversion.

* Interval arithmetic is a fast way to obtain approximate bounds on floating-point calculations over ranges of parameters, by simply replacing the parameter of interest with an interval. To do this without RR --> RIF, one would have to add explicit conversions of *all* other parameters appearing in combination with this parameter *everywhere* it occurs.

In theory: I think the motivation is flawed. The change was proposed to avoid accidental coercion of exact ring values to RIF via potentially inexact RR. But the problem in this case is the first step, not the second, and reflects the need for a direct coercion from the exact ring to RIF. In such a case, the lack of such a coercion is the bug. Whereas each value in RR *does* have a valid coercion to RIF, and the lack of this coercion would also be a bug.

Realistically, I think anyone who is actually 

1. using RIF to do reliable computing *and* 
2. coercing values from other exact rings that *don't* have direct coercions to RIF *and* are not expressible exactly in RR,

is going to be sufficiently aware of the potential problem that they will handle/check the conversion explicitly. Better to expect this than to inconvenience many users who use this coercion in far less arcane circumstances.



---

archive/issue_comments_202530.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 tcoffee]:\n> I think this change will cause many more problems than it solves.\n\n\nThanks for the comments. I mentioned them in the sage-devel thread where the original discussion took place. Let's move the discussion there.",
    "created_at": "2014-03-18T15:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202530",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:5'></a>Replying to [comment:4 tcoffee]:
> I think this change will cause many more problems than it solves.


Thanks for the comments. I mentioned them in the sage-devel thread where the original discussion took place. Let's move the discussion there.



---

archive/issue_events_043529.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43529"
}
```



---

archive/issue_events_043530.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43530"
}
```



---

archive/issue_events_043531.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43531"
}
```



---

archive/issue_events_043532.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43532"
}
```



---

archive/issue_comments_202531.json:
```json
{
    "body": "<a id='comment:10'></a>Does your branch pass the tests? I tried doing something similar a while ago (see `u/mmezzarobba/wip/coerce_RR_RIF`), but I had to make additional changes, and, more importantly, I concluded that this should wait for #22029 if we don't want comparisons between floating-point numbers and intervals to give very misleading results.\n\n---\nNew commits:",
    "created_at": "2017-02-04T13:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202531",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:10'></a>Does your branch pass the tests? I tried doing something similar a while ago (see `u/mmezzarobba/wip/coerce_RR_RIF`), but I had to make additional changes, and, more importantly, I concluded that this should wait for #22029 if we don't want comparisons between floating-point numbers and intervals to give very misleading results.

---
New commits:



---

archive/issue_comments_202532.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 mmezzarobba]:\n> Does your branch pass the tests? I tried doing something similar a while ago (see `u/mmezzarobba/wip/coerce_RR_RIF`), but I had to make additional changes, and, more importantly, I concluded that this should wait for #22029 if we don't want comparisons between floating-point numbers and intervals to give very misleading results.\n\n\nI am cleaning up my SageMath-versions and found this partial work. As no branch was attached to this ticket, I've uploaded it. So it will, for sure, need some work.",
    "created_at": "2017-02-04T13:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202532",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:11'></a>Replying to [comment:10 mmezzarobba]:
> Does your branch pass the tests? I tried doing something similar a while ago (see `u/mmezzarobba/wip/coerce_RR_RIF`), but I had to make additional changes, and, more importantly, I concluded that this should wait for #22029 if we don't want comparisons between floating-point numbers and intervals to give very misleading results.


I am cleaning up my SageMath-versions and found this partial work. As no branch was attached to this ticket, I've uploaded it. So it will, for sure, need some work.



---

archive/issue_comments_202533.json:
```json
{
    "body": "Replying to [ticket:15114 mstreng]:\n> For example, one could easily do the following by accident.\n> \n> ```\n>     sage: iv = 1 + 2^(-55) + 0. + RIF(1)\n>     sage: iv.lower(), iv.upper()\n>     (2.00000000000000, 2.00000000000000)\n> ```\n\n\nWhat's wrong with this? I honestly don't really see a problem with coercion `RR` -> `RIF`.",
    "created_at": "2017-12-16T12:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202533",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:15114 mstreng]:
> For example, one could easily do the following by accident.
> 
> ```
>     sage: iv = 1 + 2^(-55) + 0. + RIF(1)
>     sage: iv.lower(), iv.upper()
>     (2.00000000000000, 2.00000000000000)
> ```


What's wrong with this? I honestly don't really see a problem with coercion `RR` -> `RIF`.



---

archive/issue_comments_202534.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:\n> Replying to [ticket:15114 mstreng]:\n> > For example, one could easily do the following by accident.\n> > \n> > ```\n> >     sage: iv = 1 + 2^(-55) + 0. + RIF(1)\n> >     sage: iv.lower(), iv.upper()\n> >     (2.00000000000000, 2.00000000000000)\n> > ```\n\n> \n> What's wrong with this? I honestly don't really see a problem with coercion `RR` -> `RIF`.\n\n\nWith `RIF` you always have guaranteed results, with `RR` you do not. `RIF` should be as safe as possible to ensure that you actually have proven results. Just compare\n\n```\nsage: r1 = RIF(1/3) + (2.0).cos()\nsage: r2 = RIF(1/3) + RIF(2).cos()\nsage: r1.endpoints()\n(-0.0828135032138091, -0.0828135032138090)\nsage: r2.endpoints()\n(-0.0828135032138091, -0.0828135032138089)\n```\n\nFor me it is similar to the way coercions are implemented between `RealField`. It goes from more precision to less precision so that you have no artificial big precision in your result.\n\nIn conclusion: if any coercion, it should be the other way around (by taking the center).",
    "created_at": "2017-12-16T13:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202534",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:
> Replying to [ticket:15114 mstreng]:
> > For example, one could easily do the following by accident.
> > 
> > ```
> >     sage: iv = 1 + 2^(-55) + 0. + RIF(1)
> >     sage: iv.lower(), iv.upper()
> >     (2.00000000000000, 2.00000000000000)
> > ```

> 
> What's wrong with this? I honestly don't really see a problem with coercion `RR` -> `RIF`.


With `RIF` you always have guaranteed results, with `RR` you do not. `RIF` should be as safe as possible to ensure that you actually have proven results. Just compare

```
sage: r1 = RIF(1/3) + (2.0).cos()
sage: r2 = RIF(1/3) + RIF(2).cos()
sage: r1.endpoints()
(-0.0828135032138091, -0.0828135032138090)
sage: r2.endpoints()
(-0.0828135032138091, -0.0828135032138089)
```

For me it is similar to the way coercions are implemented between `RealField`. It goes from more precision to less precision so that you have no artificial big precision in your result.

In conclusion: if any coercion, it should be the other way around (by taking the center).



---

archive/issue_comments_202535.json:
```json
{
    "body": "<a id='comment:14'></a>I think a lot depends on how you model mathematically elements of interval fields. There are two ways to interpret them: either as real numbers with some uncertainty or actually as intervals of real numbers.\n\nIn the \"interval\" model, the coercion RR -> RIF makes sense: you identify a real number with a singleton, which is a special case of an interval. On the other hand, the \"choose the middle point map\" RIF -> RR is neither natural (the middle point is an arbitrary choice) nor a morphism, which are two requirements for a coercion.\n\nIn the \"real number with uncertainty\" model, you could see RIF -> RR as the forgetful map which keeps the real number but forgets about the uncertainty. In that case, this map is more natural than the opposite.\n\nFor me, it is pretty clear that MPFI is really meant to model intervals while arb models real numbers with uncertainty.",
    "created_at": "2017-12-16T22:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202535",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>I think a lot depends on how you model mathematically elements of interval fields. There are two ways to interpret them: either as real numbers with some uncertainty or actually as intervals of real numbers.

In the "interval" model, the coercion RR -> RIF makes sense: you identify a real number with a singleton, which is a special case of an interval. On the other hand, the "choose the middle point map" RIF -> RR is neither natural (the middle point is an arbitrary choice) nor a morphism, which are two requirements for a coercion.

In the "real number with uncertainty" model, you could see RIF -> RR as the forgetful map which keeps the real number but forgets about the uncertainty. In that case, this map is more natural than the opposite.

For me, it is pretty clear that MPFI is really meant to model intervals while arb models real numbers with uncertainty.



---

archive/issue_comments_202536.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:\n> For me, it is pretty clear that MPFI is really meant to model intervals\n\n\nI sort of agree, but still, the key property is that operations on MPFI intervals return over-approximations of the set of possible results (in particular, they round the endpoints of the results in the correct direction), and having a coercion from plain floating-point numbers would effectively break that.\n\nWhat would make sense to me if you want \u201dintervals of real numbers\u201d with a coercion from the corresponding real numbers themselves would be a separate parent `Intervals(R)` explicitly parametrized by the parent `R` = `RR`, `QQ`, `SR`... where the endpoints live.",
    "created_at": "2017-12-17T09:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202536",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:
> For me, it is pretty clear that MPFI is really meant to model intervals


I sort of agree, but still, the key property is that operations on MPFI intervals return over-approximations of the set of possible results (in particular, they round the endpoints of the results in the correct direction), and having a coercion from plain floating-point numbers would effectively break that.

What would make sense to me if you want ”intervals of real numbers” with a coercion from the corresponding real numbers themselves would be a separate parent `Intervals(R)` explicitly parametrized by the parent `R` = `RR`, `QQ`, `SR`... where the endpoints live.



---

archive/issue_comments_202537.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 mmezzarobba]:\n> What would make sense to me if you want \u201dintervals of real numbers\u201d\n\n\n`RealIntervalField` is exactly that for `RR`\n\n> with a coercion from the corresponding real numbers themselves\n\n\nSo, is this an argument in favor of the coercion `RR` -> `RIF`?",
    "created_at": "2017-12-17T18:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202537",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:15 mmezzarobba]:
> What would make sense to me if you want ”intervals of real numbers”


`RealIntervalField` is exactly that for `RR`

> with a coercion from the corresponding real numbers themselves


So, is this an argument in favor of the coercion `RR` -> `RIF`?



---

archive/issue_comments_202538.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 jdemeyer]:\n> Replying to [comment:15 mmezzarobba]:\n> > What would make sense to me if you want \u201dintervals of real numbers\u201d\n\n> \n> `RealIntervalField` is exactly that for `RR`\n\n\nNo: operations in `RIF` round the upper bound of their result up and the lower bound down. They don't just defer to operations in `RR`.\n\n> > with a coercion from the corresponding real numbers themselves\n\n> \n> So, is this an argument in favor of the coercion `RR` -> `RIF`?\n\n\nCertainly not.",
    "created_at": "2017-12-17T19:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202538",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:17'></a>Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 mmezzarobba]:
> > What would make sense to me if you want ”intervals of real numbers”

> 
> `RealIntervalField` is exactly that for `RR`


No: operations in `RIF` round the upper bound of their result up and the lower bound down. They don't just defer to operations in `RR`.

> > with a coercion from the corresponding real numbers themselves

> 
> So, is this an argument in favor of the coercion `RR` -> `RIF`?


Certainly not.



---

archive/issue_comments_202539.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 mmezzarobba]:\n> Replying to [comment:16 jdemeyer]:\n> > Replying to [comment:15 mmezzarobba]:\n> > > What would make sense to me if you want \u201dintervals of real numbers\u201d\n\n> > \n> > `RealIntervalField` is exactly that for `RR`\n\n> \n> No: operations in `RIF` round the upper bound of their result up and the lower bound down.\n\n\nYes, obviously because that's the right thing to do.\n\n> They don't just defer to operations in `RR`.\n\n\nTechnically not, but that is just an implementation detail. `RIF` is the set of intervals over `RR`. Whether it's implemented by operations in `RR` or by a separate library (MPFI in this case) doesn't really matter.",
    "created_at": "2017-12-17T19:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202539",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:17 mmezzarobba]:
> Replying to [comment:16 jdemeyer]:
> > Replying to [comment:15 mmezzarobba]:
> > > What would make sense to me if you want ”intervals of real numbers”

> > 
> > `RealIntervalField` is exactly that for `RR`

> 
> No: operations in `RIF` round the upper bound of their result up and the lower bound down.


Yes, obviously because that's the right thing to do.

> They don't just defer to operations in `RR`.


Technically not, but that is just an implementation detail. `RIF` is the set of intervals over `RR`. Whether it's implemented by operations in `RR` or by a separate library (MPFI in this case) doesn't really matter.



---

archive/issue_comments_202540.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:13 vdelecroix]:\n> > What's wrong with this? I honestly don't really see a problem with coercion `RR` -> `RIF`.\n\n> \n> With `RIF` you always have guaranteed results, with `RR` you do not. `RIF` should be as safe as possible to ensure that you actually have proven results. [...]\n> For me it is similar to the way coercions are implemented between `RealField`. It goes from more precision to less precision so that you have no artificial big precision in your result.\n> \n> In conclusion: if any coercion, it should be the other way around (by taking the center).\n\n\nHuge +1. (Having **reliable** numerical computations is a (the) major application of interval arithmetic.)",
    "created_at": "2017-12-18T15:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202540",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:19'></a>Replying to [comment:13 vdelecroix]:
> > What's wrong with this? I honestly don't really see a problem with coercion `RR` -> `RIF`.

> 
> With `RIF` you always have guaranteed results, with `RR` you do not. `RIF` should be as safe as possible to ensure that you actually have proven results. [...]
> For me it is similar to the way coercions are implemented between `RealField`. It goes from more precision to less precision so that you have no artificial big precision in your result.
> 
> In conclusion: if any coercion, it should be the other way around (by taking the center).


Huge +1. (Having **reliable** numerical computations is a (the) major application of interval arithmetic.)



---

archive/issue_comments_202541.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:14 jdemeyer]:\n> For me, it is pretty clear that MPFI is really meant to model intervals\n\n\nIt is not to me. I found [various](https://members.loria.fr/PZimmermann/IEEE1788-MPFI.pdf)  [texts](https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.78.9885&rep=rep1&type=pdf) (by MPFI developers) that motivate why MPFI exists and they all start by saying things about \"guaranteeing results\" and \"certified enclosures\" for floating point real arithmetic. And if an automatic silent coercion mixes a guaranteed result with a non-guaranteed result, this is bad.\n\nPeople prove theorems using `RealIntervalField` as \"real numbers that are guaranteed to be in a certain interval\", and I would personally trust such theorems much less if they use software that allows automatic accidental coercions from RR to RIF. The reason: a mistake or bug could introduce a (non-guaranteed-correct) element of RR and the coercion will silently add it to your RIF element, which now could have an incorrect error bound.\n\nI did not know that people also use the outward-rounding RIF for \"arithmetic with intervals\" without caring about guaranteed inclusion. I understand that for them it is convenient that the following works:\n\n```\nsage: I = RIF(pi, 2*pi)\nsage: p = RR(pi)\nsage: I + p\n1.?e1\n```\nto get the interval [5, 8]. However, it is hardly any extra work to do the direct thing that the coercion model currently does for you, which is:\n\n```\nsage: I + RIF(p)\n1.?e1\n```\nAnd we can also implement additional functions, e.g.\n\n```\nsage: I.translate(p)\nsage: I.add(p)\n```\n\nSo I am very much in favour of removing automatic coercions between RR and RIF. Perhaps with a `DeprecationWarning` if possible.",
    "created_at": "2017-12-18T15:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202541",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:21'></a>Replying to [comment:14 jdemeyer]:
> For me, it is pretty clear that MPFI is really meant to model intervals


It is not to me. I found [various](https://members.loria.fr/PZimmermann/IEEE1788-MPFI.pdf)  [texts](https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.78.9885&rep=rep1&type=pdf) (by MPFI developers) that motivate why MPFI exists and they all start by saying things about "guaranteeing results" and "certified enclosures" for floating point real arithmetic. And if an automatic silent coercion mixes a guaranteed result with a non-guaranteed result, this is bad.

People prove theorems using `RealIntervalField` as "real numbers that are guaranteed to be in a certain interval", and I would personally trust such theorems much less if they use software that allows automatic accidental coercions from RR to RIF. The reason: a mistake or bug could introduce a (non-guaranteed-correct) element of RR and the coercion will silently add it to your RIF element, which now could have an incorrect error bound.

I did not know that people also use the outward-rounding RIF for "arithmetic with intervals" without caring about guaranteed inclusion. I understand that for them it is convenient that the following works:

```
sage: I = RIF(pi, 2*pi)
sage: p = RR(pi)
sage: I + p
1.?e1
```
to get the interval [5, 8]. However, it is hardly any extra work to do the direct thing that the coercion model currently does for you, which is:

```
sage: I + RIF(p)
1.?e1
```
And we can also implement additional functions, e.g.

```
sage: I.translate(p)
sage: I.add(p)
```

So I am very much in favour of removing automatic coercions between RR and RIF. Perhaps with a `DeprecationWarning` if possible.



---

archive/issue_comments_202542.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 mstreng]:\n> So I am very much in favour of removing automatic coercions between RR and RIF. Perhaps with a `DeprecationWarning` if possible.\n\n\nIf it is considered a bug, then no deprecation is needed...",
    "created_at": "2017-12-18T15:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202542",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:22'></a>Replying to [comment:21 mstreng]:
> So I am very much in favour of removing automatic coercions between RR and RIF. Perhaps with a `DeprecationWarning` if possible.


If it is considered a bug, then no deprecation is needed...



---

archive/issue_comments_202543.json:
```json
{
    "body": "<a id='comment:24'></a>The problem with this ticket is that various places in Sage use this coercion. In particular `QQbar`:\n\n```\n**********************************************************************\nFile \"src/sage/rings/number_field/number_field.py\", line 1513, in sage.rings.number_field.number_field.NumberField_generic.construction\nFailed example:\n    K.<a> = NumberField(x^3-5,embedding=0)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 517, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 920, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.number_field.number_field.NumberField_generic.construction[14]>\", line 1, in <module>\n        K = NumberField(x**Integer(3)-Integer(5),embedding=Integer(0), names=('a',)); (a,) = K._first_ngens(1)\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.py\", line 529, in NumberField\n        return NumberField_version2(polynomial=polynomial, name=name, check=check, embedding=embedding, latex_name=latex_name, assume_disc_small=assume_disc_small, maximize_at_primes=maximize_at_primes, structure=structure)\n      File \"sage/structure/factory.pyx\", line 364, in sage.structure.factory.UniqueFactory.__call__ (build/cythonized/sage/structure/factory.c:1964)\n        return self.get_object(version, key, kwds)\n      File \"sage/structure/factory.pyx\", line 403, in sage.structure.factory.UniqueFactory.get_object (build/cythonized/sage/structure/factory.c:2197)\n        cache_key = _cache_key(cache_key)\n      File \"sage/misc/cachefunc.pyx\", line 642, in sage.misc.cachefunc.cache_key (build/cythonized/sage/misc/cachefunc.c:3189)\n        o = cache_key_unhashable(o)\n      File \"sage/misc/cachefunc.pyx\", line 651, in sage.misc.cachefunc.cache_key_unhashable (build/cythonized/sage/misc/cachefunc.c:3503)\n        return tuple(cache_key(item) for item in o)\n      File \"sage/misc/cachefunc.pyx\", line 651, in genexpr (build/cythonized/sage/misc/cachefunc.c:3398)\n        return tuple(cache_key(item) for item in o)\n      File \"sage/misc/cachefunc.pyx\", line 642, in sage.misc.cachefunc.cache_key (build/cythonized/sage/misc/cachefunc.c:3189)\n        o = cache_key_unhashable(o)\n      File \"sage/misc/cachefunc.pyx\", line 651, in sage.misc.cachefunc.cache_key_unhashable (build/cythonized/sage/misc/cachefunc.c:3503)\n        return tuple(cache_key(item) for item in o)\n      File \"sage/misc/cachefunc.pyx\", line 651, in genexpr (build/cythonized/sage/misc/cachefunc.c:3398)\n        return tuple(cache_key(item) for item in o)\n      File \"sage/misc/cachefunc.pyx\", line 642, in sage.misc.cachefunc.cache_key (build/cythonized/sage/misc/cachefunc.c:3189)\n        o = cache_key_unhashable(o)\n      File \"sage/misc/cachefunc.pyx\", line 653, in sage.misc.cachefunc.cache_key_unhashable (build/cythonized/sage/misc/cachefunc.c:3558)\n        k = o._cache_key()\n      File \"sage/structure/element.pyx\", line 1059, in sage.structure.element.Element._cache_key (build/cythonized/sage/structure/element.c:9948)\n        return(self.parent(),str(self))\n      File \"sage/structure/sage_object.pyx\", line 237, in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2778)\n        result = repr_func()\n      File \"sage/rings/real_lazy.pyx\", line 748, in sage.rings.real_lazy.LazyFieldElement._repr_ (build/cythonized/sage/rings/real_lazy.c:9768)\n        return str(self.approx())\n      File \"sage/rings/real_lazy.pyx\", line 772, in sage.rings.real_lazy.LazyFieldElement.approx (build/cythonized/sage/rings/real_lazy.c:9863)\n        return self.eval(self._parent.interval_field())\n      File \"sage/rings/real_lazy.pyx\", line 1640, in sage.rings.real_lazy.LazyAlgebraic.eval (build/cythonized/sage/rings/real_lazy.c:18796)\n        roots = self._poly.roots(ring = AA if isinstance(self._parent, RealLazyField_class) else QQbar)\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 7540, in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:68834)\n        rts = real_roots(self, retval='algebraic_real')\n      File \"sage/rings/polynomial/real_roots.pyx\", line 4155, in sage.rings.polynomial.real_roots.real_roots (build/cythonized/sage/rings/polynomial/real_roots.c:49563)\n        return [(AA.polynomial_root(r[1], r[0]), r[2]) for r in intv_roots]\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 997, in polynomial_root\n        return AlgebraicReal(ANRoot(poly, interval, multiplicity))\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 5830, in __init__\n        self._interval = self.refine_interval(interval, 64)\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 5992, in refine_interval\n        return self._real_refine_interval(interval, prec)\n      File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 6096, in _real_refine_interval\n        new_range = uinfo['endpoint'] - uinfo['value'] / slope\n      File \"sage/structure/element.pyx\", line 1369, in sage.structure.element.Element.__sub__ (build/cythonized/sage/structure/element.c:11538)\n        return coercion_model.bin_op(left, right, sub)\n      File \"sage/structure/coerce.pyx\", line 1133, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:10655)\n        raise bin_op_exception(op, x, y)\n    TypeError: unsupported operand parent(s) for -: 'Real Field with 64 bits of precision and rounding RNDU' and 'Real Interval Field with 64 bits of precision'\n```",
    "created_at": "2017-12-19T12:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202543",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>The problem with this ticket is that various places in Sage use this coercion. In particular `QQbar`:

```
**********************************************************************
File "src/sage/rings/number_field/number_field.py", line 1513, in sage.rings.number_field.number_field.NumberField_generic.construction
Failed example:
    K.<a> = NumberField(x^3-5,embedding=0)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.number_field.number_field.NumberField_generic.construction[14]>", line 1, in <module>
        K = NumberField(x**Integer(3)-Integer(5),embedding=Integer(0), names=('a',)); (a,) = K._first_ngens(1)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.py", line 529, in NumberField
        return NumberField_version2(polynomial=polynomial, name=name, check=check, embedding=embedding, latex_name=latex_name, assume_disc_small=assume_disc_small, maximize_at_primes=maximize_at_primes, structure=structure)
      File "sage/structure/factory.pyx", line 364, in sage.structure.factory.UniqueFactory.__call__ (build/cythonized/sage/structure/factory.c:1964)
        return self.get_object(version, key, kwds)
      File "sage/structure/factory.pyx", line 403, in sage.structure.factory.UniqueFactory.get_object (build/cythonized/sage/structure/factory.c:2197)
        cache_key = _cache_key(cache_key)
      File "sage/misc/cachefunc.pyx", line 642, in sage.misc.cachefunc.cache_key (build/cythonized/sage/misc/cachefunc.c:3189)
        o = cache_key_unhashable(o)
      File "sage/misc/cachefunc.pyx", line 651, in sage.misc.cachefunc.cache_key_unhashable (build/cythonized/sage/misc/cachefunc.c:3503)
        return tuple(cache_key(item) for item in o)
      File "sage/misc/cachefunc.pyx", line 651, in genexpr (build/cythonized/sage/misc/cachefunc.c:3398)
        return tuple(cache_key(item) for item in o)
      File "sage/misc/cachefunc.pyx", line 642, in sage.misc.cachefunc.cache_key (build/cythonized/sage/misc/cachefunc.c:3189)
        o = cache_key_unhashable(o)
      File "sage/misc/cachefunc.pyx", line 651, in sage.misc.cachefunc.cache_key_unhashable (build/cythonized/sage/misc/cachefunc.c:3503)
        return tuple(cache_key(item) for item in o)
      File "sage/misc/cachefunc.pyx", line 651, in genexpr (build/cythonized/sage/misc/cachefunc.c:3398)
        return tuple(cache_key(item) for item in o)
      File "sage/misc/cachefunc.pyx", line 642, in sage.misc.cachefunc.cache_key (build/cythonized/sage/misc/cachefunc.c:3189)
        o = cache_key_unhashable(o)
      File "sage/misc/cachefunc.pyx", line 653, in sage.misc.cachefunc.cache_key_unhashable (build/cythonized/sage/misc/cachefunc.c:3558)
        k = o._cache_key()
      File "sage/structure/element.pyx", line 1059, in sage.structure.element.Element._cache_key (build/cythonized/sage/structure/element.c:9948)
        return(self.parent(),str(self))
      File "sage/structure/sage_object.pyx", line 237, in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2778)
        result = repr_func()
      File "sage/rings/real_lazy.pyx", line 748, in sage.rings.real_lazy.LazyFieldElement._repr_ (build/cythonized/sage/rings/real_lazy.c:9768)
        return str(self.approx())
      File "sage/rings/real_lazy.pyx", line 772, in sage.rings.real_lazy.LazyFieldElement.approx (build/cythonized/sage/rings/real_lazy.c:9863)
        return self.eval(self._parent.interval_field())
      File "sage/rings/real_lazy.pyx", line 1640, in sage.rings.real_lazy.LazyAlgebraic.eval (build/cythonized/sage/rings/real_lazy.c:18796)
        roots = self._poly.roots(ring = AA if isinstance(self._parent, RealLazyField_class) else QQbar)
      File "sage/rings/polynomial/polynomial_element.pyx", line 7540, in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:68834)
        rts = real_roots(self, retval='algebraic_real')
      File "sage/rings/polynomial/real_roots.pyx", line 4155, in sage.rings.polynomial.real_roots.real_roots (build/cythonized/sage/rings/polynomial/real_roots.c:49563)
        return [(AA.polynomial_root(r[1], r[0]), r[2]) for r in intv_roots]
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 997, in polynomial_root
        return AlgebraicReal(ANRoot(poly, interval, multiplicity))
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 5830, in __init__
        self._interval = self.refine_interval(interval, 64)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 5992, in refine_interval
        return self._real_refine_interval(interval, prec)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6096, in _real_refine_interval
        new_range = uinfo['endpoint'] - uinfo['value'] / slope
      File "sage/structure/element.pyx", line 1369, in sage.structure.element.Element.__sub__ (build/cythonized/sage/structure/element.c:11538)
        return coercion_model.bin_op(left, right, sub)
      File "sage/structure/coerce.pyx", line 1133, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:10655)
        raise bin_op_exception(op, x, y)
    TypeError: unsupported operand parent(s) for -: 'Real Field with 64 bits of precision and rounding RNDU' and 'Real Interval Field with 64 bits of precision'
```



---

archive/issue_comments_202544.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:22 dkrenn]:\n> If it is considered a bug, then no deprecation is needed...\n\n\nIt's documented behaviour so it's maybe a [misfeature](http://catb.org/jargon/html/M/misfeature.html) but not a bug.\n\nAnyway, it seems that most people think that the coercion `RR` -> `RIF` is a misfeature, so I'm willing to remove it in #24371. However, I don't want to deal with the fall-out so if somebody wants to fix [comment:24], please go ahead. It's hard to tell if that's the only issue because that one issue in `QQbar` causes so many doctest failures.",
    "created_at": "2017-12-19T12:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202544",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>Replying to [comment:22 dkrenn]:
> If it is considered a bug, then no deprecation is needed...


It's documented behaviour so it's maybe a [misfeature](http://catb.org/jargon/html/M/misfeature.html) but not a bug.

Anyway, it seems that most people think that the coercion `RR` -> `RIF` is a misfeature, so I'm willing to remove it in #24371. However, I don't want to deal with the fall-out so if somebody wants to fix [comment:24], please go ahead. It's hard to tell if that's the only issue because that one issue in `QQbar` causes so many doctest failures.



---

archive/issue_comments_202545.json:
```json
{
    "body": "<a id='comment:26'></a>To everybody who is supporting this ticket: please be aware that fixing it will lead to issues like #24410 for `RIF` too.",
    "created_at": "2017-12-21T10:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202545",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>To everybody who is supporting this ticket: please be aware that fixing it will lead to issues like #24410 for `RIF` too.



---

archive/issue_comments_202546.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 jdemeyer]:\n> To everybody who is supporting this ticket: please be aware that fixing it will lead to issues like #24410 for `RIF` too.\n\n\nObtaining a `TypeError` for comparison between `RR` and `RIF` is perfectly acceptable to me (but somehow annoying).",
    "created_at": "2017-12-21T10:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202546",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'></a>Replying to [comment:26 jdemeyer]:
> To everybody who is supporting this ticket: please be aware that fixing it will lead to issues like #24410 for `RIF` too.


Obtaining a `TypeError` for comparison between `RR` and `RIF` is perfectly acceptable to me (but somehow annoying).



---

archive/issue_comments_202547.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:26 jdemeyer]:\n> To everybody who is supporting this ticket: please be aware that fixing it will lead to issues like #24410 for `RIF` too.\n\n\nThat what [comment:10 comment #10] above is about.",
    "created_at": "2017-12-21T12:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202547",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:28'></a>Replying to [comment:26 jdemeyer]:
> To everybody who is supporting this ticket: please be aware that fixing it will lead to issues like #24410 for `RIF` too.


That what [comment:10 comment #10] above is about.



---

archive/issue_comments_202548.json:
```json
{
    "body": "<a id='comment:29'></a>Jeroen: This is the ticket I was talking about at breakfast. I agree that there is an argument for keeping the coercion in place, but I think the cons outweigh the pros, and most people seem to agree. Also, I seem to remember that #21991 and perhaps a couple of other tickets were going to depend on this one, but I don't remember the details.",
    "created_at": "2019-02-13T09:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202548",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:29'></a>Jeroen: This is the ticket I was talking about at breakfast. I agree that there is an argument for keeping the coercion in place, but I think the cons outweigh the pros, and most people seem to agree. Also, I seem to remember that #21991 and perhaps a couple of other tickets were going to depend on this one, but I don't remember the details.



---

archive/issue_comments_202549.json:
```json
{
    "body": "<a id='comment:30'></a>I don't immediately see how this is related to #22029.",
    "created_at": "2019-02-13T09:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202549",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>I don't immediately see how this is related to #22029.



---

archive/issue_comments_202550.json:
```json
{
    "body": "<a id='comment:31'></a>The link is not immediate. What happens is that\n* before #22029, \u201cinterval < float\u201d comparisons gave reasonable (though possibly non-rigorous) results thanks to the coercion that this ticket wants to remove,\n* with the coercion removed but without #22029, they would silently return nonsense (compare by id),\n* they can now (correctly, I'd argue) throw an error if we remove the coercion.",
    "created_at": "2019-02-13T10:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202550",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:31'></a>The link is not immediate. What happens is that
* before #22029, “interval < float” comparisons gave reasonable (though possibly non-rigorous) results thanks to the coercion that this ticket wants to remove,
* with the coercion removed but without #22029, they would silently return nonsense (compare by id),
* they can now (correctly, I'd argue) throw an error if we remove the coercion.



---

archive/issue_events_043533.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2020-11-26T09:52:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43533"
}
```



---

archive/issue_events_043534.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2020-11-26T09:52:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43534"
}
```



---

archive/issue_comments_202551.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,20 @@\n+Remove the following coercions because they make interval arithmetic much less trustworthy.\n+* `RealField` --> `RealIntervalField`\n+* `float` --> `ComplexIntervalField`\n+* `SR` --> `ComplexIntervalField`\n \n+For example, one could easily do the following by accident.\n+\n+```\n+    sage: iv = 1 + 2^(-55) + 0. + RIF(1)\n+    sage: iv.lower(), iv.upper()\n+    (2.00000000000000, 2.00000000000000)\n+```\n+\n+See also [this topic on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/zfg0PhFR_qA)\n+\n+Already removed in other tickets:\n+* `ComplexField` --> `ComplexIntervalField`\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-11-26T09:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202551",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,20 @@
+Remove the following coercions because they make interval arithmetic much less trustworthy.
+* `RealField` --> `RealIntervalField`
+* `float` --> `ComplexIntervalField`
+* `SR` --> `ComplexIntervalField`
 
+For example, one could easily do the following by accident.
+
+```
+    sage: iv = 1 + 2^(-55) + 0. + RIF(1)
+    sage: iv.lower(), iv.upper()
+    (2.00000000000000, 2.00000000000000)
+```
+
+See also [this topic on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/zfg0PhFR_qA)
+
+Already removed in other tickets:
+* `ComplexField` --> `ComplexIntervalField`
 
 Comment: 1
 
``````




---

archive/issue_comments_202552.json:
```json
{
    "body": "<a id='comment:32'></a>New commits:",
    "created_at": "2020-11-26T09:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202552",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:32'></a>New commits:



---

archive/issue_comments_202553.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-11-26T10:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_202554.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-11-26T10:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202554",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_202555.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-26T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202555",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_202556.json:
```json
{
    "body": "<a id='comment:35'></a>I could not test everything locally due to version issues with pari and giac, so the patchbot may still uncover problems, but this is starting to take shape, and comments are already welcome.\n\n`@`bhutz: You may want to check the commit touching `binary_form_reduce`. I don't think I broke anything, but the way intervals are used in the parts I had to modify looks a bit strange to me.\n\n`@`cremona, `@`pbruin: Same remark regarding the changes to `elliptic_curves.height`.",
    "created_at": "2020-11-26T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202556",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:35'></a>I could not test everything locally due to version issues with pari and giac, so the patchbot may still uncover problems, but this is starting to take shape, and comments are already welcome.

`@`bhutz: You may want to check the commit touching `binary_form_reduce`. I don't think I broke anything, but the way intervals are used in the parts I had to modify looks a bit strange to me.

`@`cremona, `@`pbruin: Same remark regarding the changes to `elliptic_curves.height`.



---

archive/issue_comments_202557.json:
```json
{
    "body": "<a id='comment:36'></a>I see no problems with the minor code changes to elliptic curve heights, though I don't think that any of the affected functions was written by me.",
    "created_at": "2020-11-26T12:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202557",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:36'></a>I see no problems with the minor code changes to elliptic curve heights, though I don't think that any of the affected functions was written by me.



---

archive/issue_comments_202558.json:
```json
{
    "body": "<a id='comment:37'></a>I don't think I contributed much to this precise code either, but the changes certainly look fine to me.",
    "created_at": "2020-11-26T12:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202558",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:37'></a>I don't think I contributed much to this precise code either, but the changes certainly look fine to me.



---

archive/issue_comments_202559.json:
```json
{
    "body": "<a id='comment:38'></a>Thank you both for your comments. John: indeed, `git blame` did not tell the whole story. If I understand correctly, you committed the code but it was originally written by Robert Bradshaw.",
    "created_at": "2020-11-26T13:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202559",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:38'></a>Thank you both for your comments. John: indeed, `git blame` did not tell the whole story. If I understand correctly, you committed the code but it was originally written by Robert Bradshaw.



---

archive/issue_comments_202560.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:38 mmezzarobba]:\n> Thank you both for your comments. John: indeed, `git blame` did not tell the whole story. If I understand correctly, you committed the code but it was originally written by Robert Bradshaw.\n\nThat agrees with my memory.  heegner.py was from his thesis, I think, and he rewrote the unpleasant complex interval stuff from a script I had in (I think) gp.",
    "created_at": "2020-11-26T14:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202560",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:39'></a>Replying to [comment:38 mmezzarobba]:
> Thank you both for your comments. John: indeed, `git blame` did not tell the whole story. If I understand correctly, you committed the code but it was originally written by Robert Bradshaw.

That agrees with my memory.  heegner.py was from his thesis, I think, and he rewrote the unpleasant complex interval stuff from a script I had in (I think) gp.



---

archive/issue_comments_202561.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-11-26T14:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202561",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_202562.json:
```json
{
    "body": "<a id='comment:41'></a>The changes in binary_form_reduce.py look fine to me. The use of .lower() and .upper() I expect should have been there in the first place and we've just never come across an example where being that careful with the errors mattered.",
    "created_at": "2020-11-26T20:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202562",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:41'></a>The changes in binary_form_reduce.py look fine to me. The use of .lower() and .upper() I expect should have been there in the first place and we've just never come across an example where being that careful with the errors mattered.



---

archive/issue_comments_202563.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 bhutz]:\n> The changes in binary_form_reduce.py look fine to me. The use of .lower() and .upper() I expect should have been there in the first place and we've just never come across an example where being that careful with the errors mattered.\n\n\nThank you.\n\nAll tests pass now, reviewers welcome!",
    "created_at": "2020-11-27T10:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202563",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:42'></a>Replying to [comment:41 bhutz]:
> The changes in binary_form_reduce.py look fine to me. The use of .lower() and .upper() I expect should have been there in the first place and we've just never come across an example where being that careful with the errors mattered.


Thank you.

All tests pass now, reviewers welcome!



---

archive/issue_comments_202564.json:
```json
{
    "body": "<a id='comment:43'></a>This is great. I am positively surprised for seeing only few changes for making this happen!\n\nThe only trouble I see is that it might break user code without deprecation notice.",
    "created_at": "2020-11-27T19:43:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202564",
    "user": "https://github.com/videlec"
}
```

<a id='comment:43'></a>This is great. I am positively surprised for seeing only few changes for making this happen!

The only trouble I see is that it might break user code without deprecation notice.



---

archive/issue_comments_202565.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:43 vdelecroix]:\n> This is great. I am positively surprised for seeing only few changes for making this happen!\n\n\nThe switch to Python\u00a03 (and, I think, also the change to make `i` an element of \u211a[i] that you recently reviewed) went a long way toward solving the worst issues I found the first time I tried. But it is good news in any case!\n\n> The only trouble I see is that it might break user code without deprecation notice.\n\n\nI agree. But I don't know what to to to ease the transition. Do you see a way to display a deprecation warning when a coercion map is used while keeping the corresponding conversion map working?\n\nThat being said, between the issues it indirectly causes and the inconsistency with other interval fields, I would almost call the existence of this coercion a bug.",
    "created_at": "2020-11-28T09:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202565",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:44'></a>Replying to [comment:43 vdelecroix]:
> This is great. I am positively surprised for seeing only few changes for making this happen!


The switch to Python 3 (and, I think, also the change to make `i` an element of ℚ[i] that you recently reviewed) went a long way toward solving the worst issues I found the first time I tried. But it is good news in any case!

> The only trouble I see is that it might break user code without deprecation notice.


I agree. But I don't know what to to to ease the transition. Do you see a way to display a deprecation warning when a coercion map is used while keeping the corresponding conversion map working?

That being said, between the issues it indirectly causes and the inconsistency with other interval fields, I would almost call the existence of this coercion a bug.



---

archive/issue_comments_202566.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:44 mmezzarobba]:\n> Replying to [comment:43 vdelecroix]:\n> > This is great. I am positively surprised for seeing only few changes for making this happen!\n\n> \n> The switch to Python\u00a03 (and, I think, also the change to make `i` an element of \u211a[i] that you recently reviewed) went a long way toward solving the worst issues I found the first time I tried. But it is good news in any case!\n> \n> > The only trouble I see is that it might break user code without deprecation notice.\n\n> \n> I agree. But I don't know what to to to ease the transition. Do you see a way to display a deprecation warning when a coercion map is used while keeping the corresponding conversion map working?\n\n\nOne possibility would be to support the operations (with a warning) without having the coercions. One cumbersome way to do this is to implement custom `__add__`, `__mul__`, etc\n\n```\nclass Interval:\n    def __add__(self, other):\n        if self is an interval and other a floating point:\n            warn(\"don't do that\")\n            return old_behavior(self, other)\n        else:\n            return Element.__add__(self, other)\n```\nBut I don't see a simple way to do it in order to also handle functorial constructions such as vectors or polynomials. Though, given the changes you had to do in the doctests, I think it makes sense to only consider scalars.\n \n> That being said, between the issues it indirectly causes and the inconsistency with other interval fields, I would almost call the existence of this coercion a bug.\n\n\nAgreed, but https://xkcd.com/1172/",
    "created_at": "2020-11-28T09:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202566",
    "user": "https://github.com/videlec"
}
```

<a id='comment:45'></a>Replying to [comment:44 mmezzarobba]:
> Replying to [comment:43 vdelecroix]:
> > This is great. I am positively surprised for seeing only few changes for making this happen!

> 
> The switch to Python 3 (and, I think, also the change to make `i` an element of ℚ[i] that you recently reviewed) went a long way toward solving the worst issues I found the first time I tried. But it is good news in any case!
> 
> > The only trouble I see is that it might break user code without deprecation notice.

> 
> I agree. But I don't know what to to to ease the transition. Do you see a way to display a deprecation warning when a coercion map is used while keeping the corresponding conversion map working?


One possibility would be to support the operations (with a warning) without having the coercions. One cumbersome way to do this is to implement custom `__add__`, `__mul__`, etc

```
class Interval:
    def __add__(self, other):
        if self is an interval and other a floating point:
            warn("don't do that")
            return old_behavior(self, other)
        else:
            return Element.__add__(self, other)
```
But I don't see a simple way to do it in order to also handle functorial constructions such as vectors or polynomials. Though, given the changes you had to do in the doctests, I think it makes sense to only consider scalars.
 
> That being said, between the issues it indirectly causes and the inconsistency with other interval fields, I would almost call the existence of this coercion a bug.


Agreed, but https://xkcd.com/1172/



---

archive/issue_comments_202567.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:45 vdelecroix]:\n> One possibility would be to support the operations (with a warning) without having the coercions. One cumbersome way to do this is to implement custom `__add__`\n\n\nUnless we do it for floating-point types too (which would be a bit invasive), it will work for `interval + float` but `float + interval` will still fail.",
    "created_at": "2020-11-28T12:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202567",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:46'></a>Replying to [comment:45 vdelecroix]:
> One possibility would be to support the operations (with a warning) without having the coercions. One cumbersome way to do this is to implement custom `__add__`


Unless we do it for floating-point types too (which would be a bit invasive), it will work for `interval + float` but `float + interval` will still fail.



---

archive/issue_comments_202568.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-12-19T18:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_202569.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:46 mmezzarobba]:\n> Replying to [comment:45 vdelecroix]:\n> > One possibility would be to support the operations (with a warning) without having the coercions. One cumbersome way to do this is to implement custom `__add__`\n\n> \n> Unless we do it for floating-point types too (which would be a bit invasive), it will work for `interval + float` but `float + interval` will still fail.\n\n\nOk, for lack of a better option, I have done that\u2014for `RealNumber`s only. It was... painful.",
    "created_at": "2020-12-19T18:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202569",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:48'></a>Replying to [comment:46 mmezzarobba]:
> Replying to [comment:45 vdelecroix]:
> > One possibility would be to support the operations (with a warning) without having the coercions. One cumbersome way to do this is to implement custom `__add__`

> 
> Unless we do it for floating-point types too (which would be a bit invasive), it will work for `interval + float` but `float + interval` will still fail.


Ok, for lack of a better option, I have done that—for `RealNumber`s only. It was... painful.



---

archive/issue_comments_202570.json:
```json
{
    "body": "<a id='comment:49'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-21T16:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202570",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:49'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_202571.json:
```json
{
    "body": "<a id='comment:50'></a>Rebased to fix a merge conflict due to whitespace changes...",
    "created_at": "2021-01-21T16:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202571",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:50'></a>Rebased to fix a merge conflict due to whitespace changes...



---

archive/issue_comments_202572.json:
```json
{
    "body": "<a id='comment:51'></a>Vincent, do you think you will finish the review, or should I look for someone willing to take over?",
    "created_at": "2021-01-23T17:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202572",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:51'></a>Vincent, do you think you will finish the review, or should I look for someone willing to take over?



---

archive/issue_comments_202573.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-28T11:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202573",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_202574.json:
```json
{
    "body": "<a id='comment:53'></a>Great, thank you!",
    "created_at": "2021-01-28T13:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202574",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:53'></a>Great, thank you!



---

archive/issue_comments_202575.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-02-20T10:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15114#issuecomment-202575",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_043535.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-20T10:46:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15114",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15114#event-43535"
}
```
