# Issue 15561: freetype 2.3.5 is too old for some fonts of current systems.

archive/issues_015324.json:
```json
{
    "body": "The now-current freetype library has problems with newer fonts. This forbids its uses in some applications on machines having system fonts not supported by this version.\n\nThis was diagnosed on sage's R (see [this thread](https://groups.google.com/forum/#!topic/sage-support/FnTEcpfg6wE)) by Volker Braun.\n\nA stopgap measure is to upgrade freetype to a more forgiving version of freetype, hence this ticket.\n\nThe current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.  \n\nNew tarball: http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2\n\n**Keywords:** r-project graphics interfaces\n\n**Branch:** [u/charpent/ticket/15561](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/ticket/15561)\n\n**Commit:** [c70498bb446188823dcb355b474938f3a8acfb8f](https://github.com/sagemath/sagetrac-mirror/commit/c70498bb446188823dcb355b474938f3a8acfb8f)\n\n**Reviewer:** Volker Braun\n\n**Author:** Emmanuel Charpentier, Volker Braun\n\n**Dependencies:** #15539\n\nIssue created by migration from https://trac.sagemath.org/ticket/15561\n\n",
    "closed_at": "2013-12-27T14:07:31Z",
    "created_at": "2013-12-21T07:49:59Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "freetype 2.3.5 is too old for some fonts of current systems.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15561",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
The now-current freetype library has problems with newer fonts. This forbids its uses in some applications on machines having system fonts not supported by this version.

This was diagnosed on sage's R (see [this thread](https://groups.google.com/forum/#!topic/sage-support/FnTEcpfg6wE)) by Volker Braun.

A stopgap measure is to upgrade freetype to a more forgiving version of freetype, hence this ticket.

The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.  

New tarball: http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2

**Keywords:** r-project graphics interfaces

**Branch:** [u/charpent/ticket/15561](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/ticket/15561)

**Commit:** [c70498bb446188823dcb355b474938f3a8acfb8f](https://github.com/sagemath/sagetrac-mirror/commit/c70498bb446188823dcb355b474938f3a8acfb8f)

**Reviewer:** Volker Braun

**Author:** Emmanuel Charpentier, Volker Braun

**Dependencies:** #15539

Issue created by migration from https://trac.sagemath.org/ticket/15561





---

archive/issue_comments_198562.json:
```json
{
    "body": "**Branch:** [u/charpent/ticket/15561](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/ticket/15561)",
    "created_at": "2013-12-21T14:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198562",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Branch:** [u/charpent/ticket/15561](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/ticket/15561)



---

archive/issue_comments_198563.json:
```json
{
    "body": "**Commit:** [f570a62601eea75502fa2bab4431643fa1cbc2c7](https://github.com/sagemath/sagetrac-mirror/commit/f570a62601eea75502fa2bab4431643fa1cbc2c7)",
    "created_at": "2013-12-21T15:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198563",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Commit:** [f570a62601eea75502fa2bab4431643fa1cbc2c7](https://github.com/sagemath/sagetrac-mirror/commit/f570a62601eea75502fa2bab4431643fa1cbc2c7)



---

archive/issue_events_140580.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-21T15:31:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140580"
}
```



---

archive/issue_comments_198564.json:
```json
{
    "body": "<a id='comment:2'></a>\nfreetype 2.5.2 installs flawlessly IFF libpng12 is patched to avoid a test for setting up error catching via setjmp in libpng12 (which freetype 2.5.2 does anyway).\n\nThe resulting sage passes make ptestlong and is able to draw a curve (from sage -R in console). So I think that this ticket is ready for review.\n\nSince it installs a newer version of a standard package and paches another onte, I think that it should be reviewed on various system (at least Mac OS X and/or Cygwin, which seem to be the most difficult cases) before clearing it.",
    "created_at": "2013-12-21T15:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198564",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:2'></a>
freetype 2.5.2 installs flawlessly IFF libpng12 is patched to avoid a test for setting up error catching via setjmp in libpng12 (which freetype 2.5.2 does anyway).

The resulting sage passes make ptestlong and is able to draw a curve (from sage -R in console). So I think that this ticket is ready for review.

Since it installs a newer version of a standard package and paches another onte, I think that it should be reviewed on various system (at least Mac OS X and/or Cygwin, which seem to be the most difficult cases) before clearing it.



---

archive/issue_events_140581.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-22T08:43:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140581"
}
```



---

archive/issue_events_140582.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-22T08:43:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140582"
}
```



---

archive/issue_comments_198565.json:
```json
{
    "body": "<a id='comment:3'></a>\nI have two problems with this branch :\n\n1) I seem to be unable to get this code back on an sage tree on another machine :\n\n```\nsage -dev checkout --ticket 15561\nsage -dev diff\n```\ngives me an empty diff...\n\n2) I added a new freetype tarball in upstream and deleted the previous one. None of this appears in the branch, at least as displayed on the trac page.\n\nI'll have to beg some help on sage-support...",
    "created_at": "2013-12-22T08:43:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198565",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:3'></a>
I have two problems with this branch :

1) I seem to be unable to get this code back on an sage tree on another machine :

```
sage -dev checkout --ticket 15561
sage -dev diff
```
gives me an empty diff...

2) I added a new freetype tarball in upstream and deleted the previous one. None of this appears in the branch, at least as displayed on the trac page.

I'll have to beg some help on sage-support...



---

archive/attachments_020480.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "freetype-2.5.2.tar.bz2",
    "asset_url": "tarball://root/attachments/some-uuid/ticket15561/freetype-2.5.2.tar.bz2",
    "created_at": "2013-12-22T13:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.bz2",
    "user": "https://github.com/EmmanuelCharpentier"
}
```



---

archive/issue_comments_198566.json:
```json
{
    "body": "source tarball of the new versioj of freetype",
    "created_at": "2013-12-22T13:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198566",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

source tarball of the new versioj of freetype



---

archive/issue_comments_198567.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis branch requires the [tarball](http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2)\u00a0of the new version of freetype, which is also attached to this ticket.",
    "created_at": "2013-12-22T13:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198567",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:4'></a>
This branch requires the [tarball](http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2) of the new version of freetype, which is also attached to this ticket.



---

archive/issue_comments_198568.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,4 +2,6 @@\n \n This was diagnosed on sage's R (see [this thread](https://groups.google.com/forum/#!topic/sage-support/FnTEcpfg6wE)) by Volker Braun.\n \n-A stopgap measure would be to upgrade freetype to a more forgiving version of freetype, hence this ticket.\n+A stopgap measure is to upgrade freetype to a more forgiving version of freetype, hence this ticket.\n+\n+The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.\n``````\n",
    "created_at": "2013-12-22T15:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198568",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,4 +2,6 @@
 
 This was diagnosed on sage's R (see [this thread](https://groups.google.com/forum/#!topic/sage-support/FnTEcpfg6wE)) by Volker Braun.
 
-A stopgap measure would be to upgrade freetype to a more forgiving version of freetype, hence this ticket.
+A stopgap measure is to upgrade freetype to a more forgiving version of freetype, hence this ticket.
+
+The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.
``````




---

archive/issue_comments_198569.json:
```json
{
    "body": "<a id='comment:5'></a>\nOkay, I am satisfied that my push ***was*** successful, and that the ansence of the new upstream tarball was intended. So I'm putting it up for review again.",
    "created_at": "2013-12-22T15:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198569",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:5'></a>
Okay, I am satisfied that my push ***was*** successful, and that the ansence of the new upstream tarball was intended. So I'm putting it up for review again.



---

archive/issue_events_140583.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-22T15:33:08Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "rename": {
        "from": "freetype 2.3.5 is too old for some fonts",
        "to": "freetype 2.3.5 is too old for some fonts of current systems."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140583"
}
```



---

archive/issue_events_140584.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-22T15:33:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140584"
}
```



---

archive/issue_events_140585.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-22T15:33:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140585"
}
```



---

archive/issue_comments_198570.json:
```json
{
    "body": "<a id='comment:6'></a>\nOkay, I am satisfied that my push ***was*** successful, and that the ansence of the new upstream tarball was intended. So I'm putting it up for review again.",
    "created_at": "2013-12-22T15:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198570",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:6'></a>
Okay, I am satisfied that my push ***was*** successful, and that the ansence of the new upstream tarball was intended. So I'm putting it up for review again.



---

archive/issue_comments_198571.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,4 +4,6 @@\n \n A stopgap measure is to upgrade freetype to a more forgiving version of freetype, hence this ticket.\n \n-The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.\n+The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.  \n+\n+New tarball: http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2\n``````\n",
    "created_at": "2013-12-22T17:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198571",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,4 +4,6 @@
 
 A stopgap measure is to upgrade freetype to a more forgiving version of freetype, hence this ticket.
 
-The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.
+The current freetype tarball hits a snag in libpng, because it uses setjmp for exception handling, which triggers a compiler error due to this settinng up been made twice. So a small patch to the current libpng is part of this branch.  
+
+New tarball: http://download.savannah.gnu.org/releases/freetype/freetype-2.5.2.tar.bz2
``````




---

archive/issue_comments_198572.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2013-12-23T12:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198572",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_events_140586.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-23T12:16:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140586"
}
```



---

archive/issue_events_140587.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-23T12:16:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140587"
}
```



---

archive/issue_comments_198573.json:
```json
{
    "body": "**Dependencies:** #15539",
    "created_at": "2013-12-23T15:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198573",
    "user": "https://github.com/vbraun"
}
```

**Dependencies:** #15539



---

archive/issue_comments_198574.json:
```json
{
    "body": "<a id='comment:9'></a>\nBreaks PIL, so I'm setting #15539 as dep",
    "created_at": "2013-12-23T15:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198574",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>
Breaks PIL, so I'm setting #15539 as dep



---

archive/issue_comments_198575.json:
```json
{
    "body": "<a id='comment:10'></a>\nBuild errors:\n* http://build.sagemath.org/sage/builders/%20%20fast%20UW%20redhawk%20%28Ubuntu%2010.04%20x86_64%29%20incremental/builds/27/steps/compile/logs/freetype\n* http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26/steps/compile/logs/freetype",
    "created_at": "2013-12-23T15:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198575",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
Build errors:
* http://build.sagemath.org/sage/builders/%20%20fast%20UW%20redhawk%20%28Ubuntu%2010.04%20x86_64%29%20incremental/builds/27/steps/compile/logs/freetype
* http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26/steps/compile/logs/freetype



---

archive/issue_events_140588.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-23T15:36:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140588"
}
```



---

archive/issue_events_140589.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-23T15:36:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140589"
}
```



---

archive/issue_comments_198576.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [vbraun](#comment%3A10):\n\n> Build errors: * http://build.sagemath.org/sage/builders/%20%20fast%20UW%20redhawk%20%28Ubuntu%2010.04%20x86_64%29%20incremental/builds/27/steps/compile/logs/freetype * http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26/steps/compile/logs/freetype\n\n\nAhiii ! That's the snag in libpng that triggered me to patch pngconf.h. How can i check that this patch has been applied ? This error (horror ?) originates in a code section that I #defined around...\n\nEdit, Dec 25 : I see *another* build problem with PIL and freetype. but I could diagnose it only by creating a new sage tree and git'ing !#15661 directly : adding #15561 to an already compiled tree does not force recompilation of PIL.\n\nThe problem :\u00a0\n\n```\n[ ... ]\n\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/charpent/sagebis/sage/local/include/freetype2 -IlibImaging -I/home/charpent/sagebis/sage/local/include -I/usr/include -I/home/charpent/sagebis/sage/local/include/python2.7 -c _imagingft.c -o build/temp.linux-x86_64-2.7/_imagingft.o\n_imagingft.c:68:31: fatal error: freetype/fterrors.h: Aucun fichier ou dossier de ce type\n\u00a0#include <freetype/fterrors.h>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 ^\ncompilation terminated.\nerror: command 'gcc' failed with exit status 1\n\n[ ... ]\n```\nThis happens twice (PIL attemps compilation with and without Tkinter support). This is caused by the fact that the directory containing freetype headers is no longer local/include/freetype but local/include/freetype2.\n\nSince Pillow is now accepted in the next sage, my plan is :\n\n* start a new tree\n* fetch the Pillow branch (for rebase ?)\n* fetch !#15561 and adjust it.\n\nYour thoughts ?",
    "created_at": "2013-12-23T18:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198576",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:11'></a>
Replying to [vbraun](#comment%3A10):

> Build errors: * http://build.sagemath.org/sage/builders/%20%20fast%20UW%20redhawk%20%28Ubuntu%2010.04%20x86_64%29%20incremental/builds/27/steps/compile/logs/freetype * http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26/steps/compile/logs/freetype


Ahiii ! That's the snag in libpng that triggered me to patch pngconf.h. How can i check that this patch has been applied ? This error (horror ?) originates in a code section that I #defined around...

Edit, Dec 25 : I see *another* build problem with PIL and freetype. but I could diagnose it only by creating a new sage tree and git'ing !#15661 directly : adding #15561 to an already compiled tree does not force recompilation of PIL.

The problem : 

```
[ ... ]

gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/charpent/sagebis/sage/local/include/freetype2 -IlibImaging -I/home/charpent/sagebis/sage/local/include -I/usr/include -I/home/charpent/sagebis/sage/local/include/python2.7 -c _imagingft.c -o build/temp.linux-x86_64-2.7/_imagingft.o
_imagingft.c:68:31: fatal error: freetype/fterrors.h: Aucun fichier ou dossier de ce type
 #include <freetype/fterrors.h>
                               ^
compilation terminated.
error: command 'gcc' failed with exit status 1

[ ... ]
```
This happens twice (PIL attemps compilation with and without Tkinter support). This is caused by the fact that the directory containing freetype headers is no longer local/include/freetype but local/include/freetype2.

Since Pillow is now accepted in the next sage, my plan is :

* start a new tree
* fetch the Pillow branch (for rebase ?)
* fetch !#15561 and adjust it.

Your thoughts ?



---

archive/issue_comments_198577.json:
```json
{
    "body": "<a id='comment:12'></a>\nAnother question : should I merge #15539 and #15561 (and test with Pillow instead of PIL) ?",
    "created_at": "2013-12-23T18:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198577",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:12'></a>
Another question : should I merge #15539 and #15561 (and test with Pillow instead of PIL) ?



---

archive/issue_comments_198578.json:
```json
{
    "body": "<a id='comment:13'></a>\nYou should merge in the Pillow ticket, but its not ready yet (i.e. doesn't build).",
    "created_at": "2013-12-23T20:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198578",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>
You should merge in the Pillow ticket, but its not ready yet (i.e. doesn't build).



---

archive/issue_comments_198579.json:
```json
{
    "body": "<a id='comment:14'></a>\nYou need to bump the libpng patchlevel to force a rebuild (libpng/package-version.txt). Otherwise it won't be built.",
    "created_at": "2013-12-23T22:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198579",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>
You need to bump the libpng patchlevel to force a rebuild (libpng/package-version.txt). Otherwise it won't be built.



---

archive/issue_comments_198580.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [vbraun](#comment%3A14):\n\n> You need to bump the libpng patchlevel to force a rebuild (libpng/package-version.txt). Otherwise it won't be built.\n\n\nThis I do not understand : #15561 ***does*** bump libpng (from 1.2.35.p5 to 1.2.25p6) and freetype (from 2.3.5.p4 to 2.5.2.p0) ; #15539 does ***not*** touch libpng nor freetype (it *uses* them ***as is***). Is there another proposed branch that bumps libpng ? If so, how can I find it ?",
    "created_at": "2013-12-25T09:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198580",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:15'></a>
Replying to [vbraun](#comment%3A14):

> You need to bump the libpng patchlevel to force a rebuild (libpng/package-version.txt). Otherwise it won't be built.


This I do not understand : #15561 ***does*** bump libpng (from 1.2.35.p5 to 1.2.25p6) and freetype (from 2.3.5.p4 to 2.5.2.p0) ; #15539 does ***not*** touch libpng nor freetype (it *uses* them ***as is***). Is there another proposed branch that bumps libpng ? If so, how can I find it ?



---

archive/issue_comments_198581.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [vbraun](#comment%3A13):\n\n> You should merge in the Pillow ticket, but its not ready yet (i.e. doesn't build).\n\n\nWould that be a merge (i. e. creating a branch incorporating changes both from #15539 an #15561) or a rebase (i. e. creating a patch that *assumes* that #15539 has been incorporated) ?\n\nNow that 15539 is closed as \"fixed\", rebasing sounds logical. What do you advise ?",
    "created_at": "2013-12-25T09:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198581",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:16'></a>
Replying to [vbraun](#comment%3A13):

> You should merge in the Pillow ticket, but its not ready yet (i.e. doesn't build).


Would that be a merge (i. e. creating a branch incorporating changes both from #15539 an #15561) or a rebase (i. e. creating a patch that *assumes* that #15539 has been incorporated) ?

Now that 15539 is closed as "fixed", rebasing sounds logical. What do you advise ?



---

archive/issue_comments_198582.json:
```json
{
    "body": "<a id='comment:17'></a>\nYou should always merge (and never rebase) branches that are already published on trac, since somebody else might have used that already as a base for their own branch.\n\nHere is the full buildbot log: http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26\n\nIt did compile libpng-1.2.35.p6, so thats your ticket.",
    "created_at": "2013-12-25T13:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198582",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>
You should always merge (and never rebase) branches that are already published on trac, since somebody else might have used that already as a base for their own branch.

Here is the full buildbot log: http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26

It did compile libpng-1.2.35.p6, so thats your ticket.



---

archive/issue_comments_198583.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [vbraun](#comment%3A17):\n\n> You should always merge (and never rebase) branches that are already published on trac, since somebody else might have used that already as a base for their own branch. \n\n\nOkay. Can't say I fully understand it yet, but I did that.\n\n> Here is the full buildbot log: http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26 It did compile libpng-1.2.35.p6, so thats your ticket.\n\n\nIndeed ! Don't understand it either. I just restarted a clean tree, used git (not sage's scripts) to fetch Pillow and #15561 in separate local branches, merged Pillow in 15561 and compiled (successfully).\n\nIn the full buildbot log, the error points at pngconf.h line 328. That's the place where the error takes places while using the *unpatched* pngconf.h ; with the patched pngconf.h, the error should take place on line 334.\n\nIs it possible that buildbot's freetype compilation might pickup an unpatched (possibly system's) pngconf.h ? If so, how to prevent this from happening ?",
    "created_at": "2013-12-25T19:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198583",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:18'></a>
Replying to [vbraun](#comment%3A17):

> You should always merge (and never rebase) branches that are already published on trac, since somebody else might have used that already as a base for their own branch. 


Okay. Can't say I fully understand it yet, but I did that.

> Here is the full buildbot log: http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/26 It did compile libpng-1.2.35.p6, so thats your ticket.


Indeed ! Don't understand it either. I just restarted a clean tree, used git (not sage's scripts) to fetch Pillow and #15561 in separate local branches, merged Pillow in 15561 and compiled (successfully).

In the full buildbot log, the error points at pngconf.h line 328. That's the place where the error takes places while using the *unpatched* pngconf.h ; with the patched pngconf.h, the error should take place on line 334.

Is it possible that buildbot's freetype compilation might pickup an unpatched (possibly system's) pngconf.h ? If so, how to prevent this from happening ?



---

archive/issue_comments_198584.json:
```json
{
    "body": "<a id='comment:19'></a>\nLooking at build/deps, the freetype package does not depend on libpng so will potentially build at the same time. Might be a race condition.",
    "created_at": "2013-12-25T19:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198584",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
Looking at build/deps, the freetype package does not depend on libpng so will potentially build at the same time. Might be a race condition.



---

archive/issue_comments_198585.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [vbraun](#comment%3A19):\n\n> Looking at build/deps, the freetype package does not depend on libpng so will potentially build at the same time. Might be a race condition.\n\n\nOuch ! Freetype depends on libpng, but libpng needs to be patched *first*, which means it can't be patched by freetype's branch, if I understand that correctly. The only way out I see is :\n\n1. create a new branch patching libpng in a ticket #xx\n2. wait for #xx to get reviewed and getting to state \"fixed\", and\n3. modify #15561 to depend on #xx.\n\nI don't see how this can be made in one ticket. Do you have different thoughts ?",
    "created_at": "2013-12-25T20:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198585",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:20'></a>
Replying to [vbraun](#comment%3A19):

> Looking at build/deps, the freetype package does not depend on libpng so will potentially build at the same time. Might be a race condition.


Ouch ! Freetype depends on libpng, but libpng needs to be patched *first*, which means it can't be patched by freetype's branch, if I understand that correctly. The only way out I see is :

1. create a new branch patching libpng in a ticket #xx
2. wait for #xx to get reviewed and getting to state "fixed", and
3. modify #15561 to depend on #xx.

I don't see how this can be made in one ticket. Do you have different thoughts ?



---

archive/issue_comments_198586.json:
```json
{
    "body": "<a id='comment:21'></a>\nNo, you can do everything in your current branch.",
    "created_at": "2013-12-25T20:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198586",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:21'></a>
No, you can do everything in your current branch.



---

archive/issue_comments_198587.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [vbraun](#comment%3A21):\n\n> No, you can do everything in your current branch.\n\n\nI don't see how to. Care to enlighten the dummy of the day ?",
    "created_at": "2013-12-25T20:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198587",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:22'></a>
Replying to [vbraun](#comment%3A21):

> No, you can do everything in your current branch.


I don't see how to. Care to enlighten the dummy of the day ?



---

archive/issue_comments_198588.json:
```json
{
    "body": "<a id='comment:23'></a>\nIf that race is actually the problem then you only have to add the dependency to `build/deps`. Then libpng will be built first (and patched as part of its build process), and then freetype will be built afterward. I think I'm missing the problem here, but in any case that should work (TM).",
    "created_at": "2013-12-25T20:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198588",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>
If that race is actually the problem then you only have to add the dependency to `build/deps`. Then libpng will be built first (and patched as part of its build process), and then freetype will be built afterward. I think I'm missing the problem here, but in any case that should work (TM).



---

archive/issue_comments_198589.json:
```json
{
    "body": "<a id='comment:24'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c70498b\">c70498b</a></td><td><code>buid/deps : added a dependency of freetype on libpng in order to work around a build-time race condition.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bedf0d8\">bedf0d8</a></td><td><code>Merge branch 'pillow' into ticket/15561</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f005905\">f005905</a></td><td><code>pillow: depends on setuptools</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/adc90ce\">adc90ce</a></td><td><code>Pillow -> pillow</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8987381\">8987381</a></td><td><code>remove PIL (it has been replaced by Pillow)</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c055bd\">2c055bd</a></td><td><code>Pillow: fix patch to work against 2.2.2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6690d97\">6690d97</a></td><td><code>doc: remove now unused environment variables</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3778f42\">3778f42</a></td><td><code>Pillow: re-resolve #9864</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6df0adb\">6df0adb</a></td><td><code>replace PIL with Pillow</code></td></tr></table>\n",
    "created_at": "2013-12-25T21:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198589",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c70498b">c70498b</a></td><td><code>buid/deps : added a dependency of freetype on libpng in order to work around a build-time race condition.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bedf0d8">bedf0d8</a></td><td><code>Merge branch 'pillow' into ticket/15561</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f005905">f005905</a></td><td><code>pillow: depends on setuptools</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/adc90ce">adc90ce</a></td><td><code>Pillow -> pillow</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8987381">8987381</a></td><td><code>remove PIL (it has been replaced by Pillow)</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c055bd">2c055bd</a></td><td><code>Pillow: fix patch to work against 2.2.2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6690d97">6690d97</a></td><td><code>doc: remove now unused environment variables</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3778f42">3778f42</a></td><td><code>Pillow: re-resolve #9864</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6df0adb">6df0adb</a></td><td><code>replace PIL with Pillow</code></td></tr></table>




---

archive/issue_comments_198590.json:
```json
{
    "body": "**Changing commit** from \"[f570a62601eea75502fa2bab4431643fa1cbc2c7](https://github.com/sagemath/sagetrac-mirror/commit/f570a62601eea75502fa2bab4431643fa1cbc2c7)\" to \"[c70498bb446188823dcb355b474938f3a8acfb8f](https://github.com/sagemath/sagetrac-mirror/commit/c70498bb446188823dcb355b474938f3a8acfb8f)\".",
    "created_at": "2013-12-25T21:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198590",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f570a62601eea75502fa2bab4431643fa1cbc2c7](https://github.com/sagemath/sagetrac-mirror/commit/f570a62601eea75502fa2bab4431643fa1cbc2c7)" to "[c70498bb446188823dcb355b474938f3a8acfb8f](https://github.com/sagemath/sagetrac-mirror/commit/c70498bb446188823dcb355b474938f3a8acfb8f)".



---

archive/issue_events_140590.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-25T21:31:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140590"
}
```



---

archive/issue_events_140591.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2013-12-25T21:31:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140591"
}
```



---

archive/issue_comments_198591.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [vbraun](#comment%3A23):\n\n> If that race is actually the problem then you only have to add the dependency to `build/deps` . Then libpng will be built first (and patched as part of its build process), and then freetype will be built afterward. I think I'm missing the problem here, but in any case that should work (TM).\n\n\nOkay. I did that, pushed the commit and updated status to \"needs review\". I'm curious about the buildbot's behaviour...\n\nEdit, a bit later : the resulting tree passes the '(make distclean ; make )' test in an enviroment where MAKE is \"make -j8\". So it *can* be built in a parallel setting.",
    "created_at": "2013-12-25T21:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15561#issuecomment-198591",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:26'></a>
Replying to [vbraun](#comment%3A23):

> If that race is actually the problem then you only have to add the dependency to `build/deps` . Then libpng will be built first (and patched as part of its build process), and then freetype will be built afterward. I think I'm missing the problem here, but in any case that should work (TM).


Okay. I did that, pushed the commit and updated status to "needs review". I'm curious about the buildbot's behaviour...

Edit, a bit later : the resulting tree passes the '(make distclean ; make )' test in an enviroment where MAKE is "make -j8". So it *can* be built in a parallel setting.



---

archive/issue_events_140592.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-27T14:07:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140592"
}
```



---

archive/issue_events_140593.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-27T14:07:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15561",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15561#event-140593"
}
```
