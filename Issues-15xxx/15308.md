# Issue 15308: init.sage file is not read when starting the notebook

archive/issues_015071.json:
```json
{
    "body": "See http://ask.sagemath.org/question/3084/notebook-and-initsage. This problem seems to have been introduced in #14523.\n\nCC:  @vbraun @ppurka @novoselt\n\nUpstream: Completely fixed; Fix reported upstream\n\nReviewer: Karl-Dieter Crisman\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15308\n\n",
    "closed_at": "2015-02-12T21:17:18Z",
    "created_at": "2013-10-19T22:28:52Z",
    "labels": [
        "component: notebook",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "init.sage file is not read when starting the notebook",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15308",
    "user": "https://github.com/jhpalmieri"
}
```
See http://ask.sagemath.org/question/3084/notebook-and-initsage. This problem seems to have been introduced in #14523.

CC:  @vbraun @ppurka @novoselt

Upstream: Completely fixed; Fix reported upstream

Reviewer: Karl-Dieter Crisman

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15308





---

archive/issue_events_044362.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44362"
}
```



---

archive/issue_events_044363.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44363"
}
```



---

archive/issue_events_044364.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44364"
}
```



---

archive/issue_comments_242822.json:
```json
{
    "body": "<a id='comment:3'></a>An example of output caused by this bug is:\n\nTraceback (most recent call last):    #The OrthogonalCurvilinearOutput.sage file will output the coefficients and differential operators defined \n  File \"\", line 1, in <module>\n    \n  File \"/tmp/tmpPnuBJt/___code___.py\", line 7, in <module>\n    attach('CartesianCoord.sage')\n  File \"lazy_import.pyx\", line 358, in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:3000)\n  File \"/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/attached_files.py\", line 344, in attach\n    load(filename, globals(), attach=True)\n  File \"/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/preparser.py\", line 1769, in load\n    execfile(preparse_file_named(fpath), globals)\n  File \"/home/sagedev/.sage/temp/ubuntu/18360/CartesianCoord.sage6m7Baj.py\", line 18, in <module>\n    var('q_1,q_2,q_3,x_1,x_2,x_3')\nNameError: name 'var' is not defined",
    "created_at": "2014-05-19T01:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242822",
    "user": "https://trac.sagemath.org/admin/accounts/users/RJBarker"
}
```

<a id='comment:3'></a>An example of output caused by this bug is:

Traceback (most recent call last):    #The OrthogonalCurvilinearOutput.sage file will output the coefficients and differential operators defined 
  File "", line 1, in <module>
    
  File "/tmp/tmpPnuBJt/___code___.py", line 7, in <module>
    attach('CartesianCoord.sage')
  File "lazy_import.pyx", line 358, in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:3000)
  File "/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/attached_files.py", line 344, in attach
    load(filename, globals(), attach=True)
  File "/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/preparser.py", line 1769, in load
    execfile(preparse_file_named(fpath), globals)
  File "/home/sagedev/.sage/temp/ubuntu/18360/CartesianCoord.sage6m7Baj.py", line 18, in <module>
    var('q_1,q_2,q_3,x_1,x_2,x_3')
NameError: name 'var' is not defined



---

archive/issue_comments_242823.json:
```json
{
    "body": "<a id='comment:4'></a>Afaik attach doesn't work on the notebook.\n\nYour problem seems to be that `init.sage` is evaluated before Sage is started. A workaround might be to use a `.py` file starting with `from sage.all import *`",
    "created_at": "2014-05-19T10:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242823",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>Afaik attach doesn't work on the notebook.

Your problem seems to be that `init.sage` is evaluated before Sage is started. A workaround might be to use a `.py` file starting with `from sage.all import *`



---

archive/issue_events_044365.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44365"
}
```



---

archive/issue_events_044366.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44366"
}
```



---

archive/issue_comments_242824.json:
```json
{
    "body": "Changing component from misc to notebook.",
    "created_at": "2014-10-24T13:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242824",
    "user": "https://github.com/kcrisman"
}
```

Changing component from misc to notebook.



---

archive/issue_comments_242825.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Reported upstream. Developers acknowledge bug.\"",
    "created_at": "2014-10-24T13:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242825",
    "user": "https://github.com/kcrisman"
}
```

Changing upstream from "N/A" to "Reported upstream. Developers acknowledge bug."



---

archive/issue_comments_242826.json:
```json
{
    "body": "<a id='comment:6'></a>Upstream at https://github.com/sagemath/sagenb/issues/251 though I'm not sure if it's identical to the init.sage issue.",
    "created_at": "2014-10-24T13:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242826",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:6'></a>Upstream at https://github.com/sagemath/sagenb/issues/251 though I'm not sure if it's identical to the init.sage issue.



---

archive/issue_comments_242827.json:
```json
{
    "body": "<a id='comment:7'></a>I appear to have a fix upstream; comments welcome there.  Somehow the change in #14523 in the definition of `attach` from \n\n```\n    import preparser \n        for filename in files: \n        preparser.load(filename, globals(), attach=True) \n```\nto\n\n```\n    try:\n        ipy = get_ipython()\n    except NameError:\n        ipy = None\n    global attached\n    for filename in files:\n        if ipy:\n            code = load_wrap(filename, attach=True)\n            ipy.run_cell(code)\n        else:\n            load(filename, globals(), attach=True)\n```\ndid this.  Probably that should really be fixed in Sage, but I don't want to mess around with two fixes.\n\nCan anyone think of why either adding that global (which one would think wouldn't clobber `all` globals, such as `Integer`?) or having the command-line code would be a problem?  Really, neither one should in principle cause a problem.  But it does.",
    "created_at": "2014-12-03T18:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242827",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:7'></a>I appear to have a fix upstream; comments welcome there.  Somehow the change in #14523 in the definition of `attach` from 

```
    import preparser 
        for filename in files: 
        preparser.load(filename, globals(), attach=True) 
```
to

```
    try:
        ipy = get_ipython()
    except NameError:
        ipy = None
    global attached
    for filename in files:
        if ipy:
            code = load_wrap(filename, attach=True)
            ipy.run_cell(code)
        else:
            load(filename, globals(), attach=True)
```
did this.  Probably that should really be fixed in Sage, but I don't want to mess around with two fixes.

Can anyone think of why either adding that global (which one would think wouldn't clobber `all` globals, such as `Integer`?) or having the command-line code would be a problem?  Really, neither one should in principle cause a problem.  But it does.



---

archive/issue_comments_242828.json:
```json
{
    "body": "<a id='comment:8'></a>Indeed, a little more testing shows that `globals()` is definitely not the usual Sage globals at that point - it is just the globals for that module, including the things that were imported like `os` and the builtins.  E.g.\n\n```\n'{\\'load\\': <function load at 0x1054cc488>, \\'load_attach_path\\': <function load_attach_path at 0x110d99e60>, \\'reload_attached_files_if_modified\\': <function reload_attached_files_if_modified at 0x110d9f2a8>, ...\n \\'__doc__\\': \\'\\\\nKeep track of attached files\\\\n\\\\nTESTS::\\\\n\\\\n    sage: attach(\\\\\\'http://wstein.org/loadtest.py\\\\\\')\\\\n    Traceback (most recent call last):\\\\n    ...\\\\n    ...\n \\'load_wrap\\': <function load_wrap at 0x1054cc500>, \\'load_attach_mode\\': <function load_attach_mode at 0x110d99de8>, \n\\'__builtins__\\': {\\'bytearray\\': <type \\'bytearray\\'>, \\'IndexError\\': <type \\'exceptions.IndexError\\'>, ...}, \n...\n\\'os\\': <module \\'os\\' from \\'/Users/.../sage/local/lib/python/os.pyc\\'>, \\'modified_file_iterator\\': <function modified_file_iterator at 0x110d9f230>}'\n```\nZoinks!",
    "created_at": "2014-12-03T18:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242828",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'></a>Indeed, a little more testing shows that `globals()` is definitely not the usual Sage globals at that point - it is just the globals for that module, including the things that were imported like `os` and the builtins.  E.g.

```
'{\'load\': <function load at 0x1054cc488>, \'load_attach_path\': <function load_attach_path at 0x110d99e60>, \'reload_attached_files_if_modified\': <function reload_attached_files_if_modified at 0x110d9f2a8>, ...
 \'__doc__\': \'\\nKeep track of attached files\\n\\nTESTS::\\n\\n    sage: attach(\\\'http://wstein.org/loadtest.py\\\')\\n    Traceback (most recent call last):\\n    ...\\n    ...
 \'load_wrap\': <function load_wrap at 0x1054cc500>, \'load_attach_mode\': <function load_attach_mode at 0x110d99de8>, 
\'__builtins__\': {\'bytearray\': <type \'bytearray\'>, \'IndexError\': <type \'exceptions.IndexError\'>, ...}, 
...
\'os\': <module \'os\' from \'/Users/.../sage/local/lib/python/os.pyc\'>, \'modified_file_iterator\': <function modified_file_iterator at 0x110d9f230>}'
```
Zoinks!



---

archive/issue_comments_242829.json:
```json
{
    "body": "<a id='comment:9'></a>From [the Python doc](https://docs.python.org/2/library/functions.html):\n> Remember that at module level, globals and locals are the same dictionary.\n\nBut on the other hand nothing really changed.  Except maybe that it was in a Cython file, and now is in a Python file?",
    "created_at": "2014-12-03T19:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242829",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:9'></a>From [the Python doc](https://docs.python.org/2/library/functions.html):
> Remember that at module level, globals and locals are the same dictionary.

But on the other hand nothing really changed.  Except maybe that it was in a Cython file, and now is in a Python file?



---

archive/issue_comments_242830.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. Developers acknowledge bug.\" to \"Completely fixed; Fix reported upstream\"",
    "created_at": "2014-12-10T17:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242830",
    "user": "https://github.com/kcrisman"
}
```

Changing upstream from "Reported upstream. Developers acknowledge bug." to "Completely fixed; Fix reported upstream"



---

archive/issue_comments_242831.json:
```json
{
    "body": "<a id='comment:10'></a>Fix upstream at https://github.com/sagemath/sagenb/pull/267",
    "created_at": "2014-12-10T17:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242831",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:10'></a>Fix upstream at https://github.com/sagemath/sagenb/pull/267



---

archive/issue_comments_242832.json:
```json
{
    "body": "<a id='comment:11'></a>This is 100% ready to go, just need a reviewer upstream!",
    "created_at": "2014-12-17T21:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242832",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:11'></a>This is 100% ready to go, just need a reviewer upstream!



---

archive/issue_comments_242833.json:
```json
{
    "body": "<a id='comment:12'></a>This was fixed and is now in a merged package.",
    "created_at": "2015-02-12T15:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242833",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:12'></a>This was fixed and is now in a merged package.



---

archive/issue_events_044367.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2015-02-12T15:15:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44367"
}
```



---

archive/issue_events_044368.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2015-02-12T15:15:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44368"
}
```



---

archive/issue_comments_242834.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-12T15:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242834",
    "user": "https://github.com/kcrisman"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242835.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Karl-Dieter Crisman\"",
    "created_at": "2015-02-12T15:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242835",
    "user": "https://github.com/kcrisman"
}
```

Changing reviewer from "" to "Karl-Dieter Crisman"



---

archive/issue_comments_242836.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-12T15:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242836",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_044369.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-12T21:17:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15308#event-44369"
}
```



---

archive/issue_comments_242837.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-12T21:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15308#issuecomment-242837",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
