# Issue 15316: Make gf2x respect SAGE_FAT_BINARY and use --libdir

archive/issues_015079.json:
```json
{
    "body": "When SAGE_FAT_BINARY is set we should pick a generic value for hwdir.\nWe should also use --libdir so that gf2x works ok on OpenSuse and similar systems.\n\n**Upstream**: [https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979](https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979)\n\nKeywords: spkg gf2x\n\nBranch/Commit: 969de52313ee407d874e9f7b318111c144de534e\n\nReviewer: Jeroen Demeyer, Jean-Pierre Flori\n\nAuthor: Jean-Pierre Flori, Erik Massop\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15316\n\n",
    "closed_at": "2014-11-14T21:01:47Z",
    "created_at": "2013-10-22T11:35:17Z",
    "labels": [
        "component: packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Make gf2x respect SAGE_FAT_BINARY and use --libdir",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15316",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
When SAGE_FAT_BINARY is set we should pick a generic value for hwdir.
We should also use --libdir so that gf2x works ok on OpenSuse and similar systems.

**Upstream**: [https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979](https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979)

Keywords: spkg gf2x

Branch/Commit: 969de52313ee407d874e9f7b318111c144de534e

Reviewer: Jeroen Demeyer, Jean-Pierre Flori

Author: Jean-Pierre Flori, Erik Massop

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15316





---

archive/issue_comments_206007.json:
```json
{
    "body": "Changing keywords from \"\" to \"spkg gf2x\".",
    "created_at": "2014-01-06T19:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206007",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing keywords from "" to "spkg gf2x".



---

archive/issue_comments_206008.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-06T19:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206008",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_206009.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2014-01-06T19:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206009",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_206010.json:
```json
{
    "body": "<a id='comment:2'></a>I'm not entirely sure how portable `ln -sf` is. I recommend changing it to a `rm -f` + `ln -s` instead.",
    "created_at": "2014-01-06T20:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206010",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>I'm not entirely sure how portable `ln -sf` is. I recommend changing it to a `rm -f` + `ln -s` instead.



---

archive/issue_comments_206011.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-06T21:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206011",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_206012.json:
```json
{
    "body": "<a id='comment:4'></a>Done.",
    "created_at": "2014-01-06T21:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206012",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:4'></a>Done.



---

archive/issue_comments_206013.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-01-11T21:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206013",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206014.json:
```json
{
    "body": "<a id='comment:5'></a>Given that all x86_64 processors support SSE2, why should we disable that? We should disable it for i386, but not for x86_64.\n\nAnother small comment: I don't like\n\n```\necho \"Disabling optimizations.\"\n```\nWhy not make it\n\n```\necho \"Building a generic gf2x library.\"\n```",
    "created_at": "2014-01-11T21:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206014",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Given that all x86_64 processors support SSE2, why should we disable that? We should disable it for i386, but not for x86_64.

Another small comment: I don't like

```
echo "Disabling optimizations."
```
Why not make it

```
echo "Building a generic gf2x library."
```



---

archive/issue_comments_206015.json:
```json
{
    "body": "<a id='comment:6'></a>For SSE2, I said the same thing to gf2x devs and they told me sse2 was not part of the x86_64.\nSee https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979\n\nThe other point is I was too lazy to check if the system was actually 32 or 64 bits in spkg-install.",
    "created_at": "2014-01-11T23:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206015",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:6'></a>For SSE2, I said the same thing to gf2x devs and they told me sse2 was not part of the x86_64.
See https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979

The other point is I was too lazy to check if the system was actually 32 or 64 bits in spkg-install.



---

archive/issue_comments_206016.json:
```json
{
    "body": "<a id='comment:7'></a>Perhaps SSE2 is not part of the official standard, but at least all x86_64 CPUs support it, so it would say it is \"de facto\" standard. Also GCC will generate SSE+SSE2 code by default on x86_64, which is a very strong precedent.\n\nIs this not just a matter of **not** replacing the symlink?",
    "created_at": "2014-01-13T10:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206016",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Perhaps SSE2 is not part of the official standard, but at least all x86_64 CPUs support it, so it would say it is "de facto" standard. Also GCC will generate SSE+SSE2 code by default on x86_64, which is a very strong precedent.

Is this not just a matter of **not** replacing the symlink?



---

archive/issue_comments_206017.json:
```json
{
    "body": "<a id='comment:8'></a>The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.",
    "created_at": "2014-01-13T10:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206017",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.



---

archive/issue_comments_206018.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 jdemeyer]:\n> Perhaps SSE2 is not part of the official standard, but at least all x86_64 CPUs support it, so it would say it is \"de facto\" standard. Also GCC will generate SSE+SSE2 code by default on x86_64, which is a very strong precedent.\n\nI agree, and that's what I defended upstream, but Emmanuel didn't hear it that way...\n> \n> Is this not just a matter of **not** replacing the symlink?\n\nIn fact, if SSE2 is enabled, then we don't even need to replace the symlinks.\n\nApart from the feedback from upstream which does not want to provide a build system with an option to disable optimizations which would build an SSE2 lib but without further optimizations on x86_64, but just one which would simply point to the generic32/64 folders (so no assembly at all whatever the platform) when enabled.\n\nThe other issue is that I did not feel the need to add a bunch of code to spkg-install tyo detect if the system targeted is 32/64 bits, x86 or sparc or whatever, and then pass the correct value to the \"hwdir\" var (let's say x86, x86_64 and so on depending on the system, which is what I asked for upstream but got as a response: \"we'll pass generic32/64 and nothing more depending on the bit length\"), when passing unconditionnaly \"--disable-sse2 --disable-pclmul\" would more or less do the trick (except for the fact it broke the build on x86_64...).\nIndeed this would really fit in the upstream autotools project, not within our spkg-install script.\nBut you nearly convinced me to submit that upstream....",
    "created_at": "2014-01-13T10:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206018",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:9'></a>Replying to [comment:7 jdemeyer]:
> Perhaps SSE2 is not part of the official standard, but at least all x86_64 CPUs support it, so it would say it is "de facto" standard. Also GCC will generate SSE+SSE2 code by default on x86_64, which is a very strong precedent.

I agree, and that's what I defended upstream, but Emmanuel didn't hear it that way...
> 
> Is this not just a matter of **not** replacing the symlink?

In fact, if SSE2 is enabled, then we don't even need to replace the symlinks.

Apart from the feedback from upstream which does not want to provide a build system with an option to disable optimizations which would build an SSE2 lib but without further optimizations on x86_64, but just one which would simply point to the generic32/64 folders (so no assembly at all whatever the platform) when enabled.

The other issue is that I did not feel the need to add a bunch of code to spkg-install tyo detect if the system targeted is 32/64 bits, x86 or sparc or whatever, and then pass the correct value to the "hwdir" var (let's say x86, x86_64 and so on depending on the system, which is what I asked for upstream but got as a response: "we'll pass generic32/64 and nothing more depending on the bit length"), when passing unconditionnaly "--disable-sse2 --disable-pclmul" would more or less do the trick (except for the fact it broke the build on x86_64...).
Indeed this would really fit in the upstream autotools project, not within our spkg-install script.
But you nearly convinced me to submit that upstream....



---

archive/issue_comments_206019.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 jdemeyer]:\n> The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.\n\nNice.\nI'll push that upstream, but how \"official\" is this document?\nIn fact when upstream told me SSE2 was not required I was not sure what and where the official ABI could be...",
    "created_at": "2014-01-13T10:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206019",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:10'></a>Replying to [comment:8 jdemeyer]:
> The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.

Nice.
I'll push that upstream, but how "official" is this document?
In fact when upstream told me SSE2 was not required I was not sure what and where the official ABI could be...



---

archive/issue_comments_206020.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 jpflori]:\n> Replying to [comment:8 jdemeyer]:\n> > The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.\n\n> Nice.\n> I'll push that upstream, but how \"official\" is this document?\n> In fact when upstream told me SSE2 was not required I was not sure what and where the official ABI could be...\n\nHum, the about page:\n* http://www.x86-64.org/about.html\nmakes it look more official than what the site design made me orignalmly think.",
    "created_at": "2014-01-13T10:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206020",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:11'></a>Replying to [comment:10 jpflori]:
> Replying to [comment:8 jdemeyer]:
> > The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.

> Nice.
> I'll push that upstream, but how "official" is this document?
> In fact when upstream told me SSE2 was not required I was not sure what and where the official ABI could be...

Hum, the about page:
* http://www.x86-64.org/about.html
makes it look more official than what the site design made me orignalmly think.



---

archive/issue_comments_206021.json:
```json
{
    "body": "<a id='comment:12'></a>I think you should discuss the ABI thing with upstream and see what they say.",
    "created_at": "2014-01-13T10:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206021",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>I think you should discuss the ABI thing with upstream and see what they say.



---

archive/issue_comments_206022.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:\n> I think you should discuss the ABI thing with upstream and see what they say.\n\nSure, I'll bump the discussion there, pointing to the exact page you spotted and hopefully their position will shift.\nI'll also directly provide a patch to implement what I (and apprently you) would like to see in.\n\nIn between I'll provide these changes here.",
    "created_at": "2014-01-13T10:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206022",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:
> I think you should discuss the ABI thing with upstream and see what they say.

Sure, I'll bump the discussion there, pointing to the exact page you spotted and hopefully their position will shift.
I'll also directly provide a patch to implement what I (and apprently you) would like to see in.

In between I'll provide these changes here.



---

archive/issue_comments_206023.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-13T14:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206023",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_206024.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-01-13T14:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206024",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206025.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-When SAGE_FAT_BINARY is set we should pass --disable-sse2 --disable-pclmul to configure.\n+When SAGE_FAT_BINARY is set we should pick a generic value for hwdir.\n We should also use --libdir so that gf2x works ok on OpenSuse and similar systems.\n \n Comment: 1\n```\n",
    "created_at": "2014-01-13T14:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206025",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-When SAGE_FAT_BINARY is set we should pass --disable-sse2 --disable-pclmul to configure.
+When SAGE_FAT_BINARY is set we should pick a generic value for hwdir.
 We should also use --libdir so that gf2x works ok on OpenSuse and similar systems.
 
 Comment: 1
```




---

archive/issue_comments_206026.json:
```json
{
    "body": "<a id='comment:15'></a>I've tried to tweak the install script to pick up a correct generic value for hwdir depending on cpu/os.",
    "created_at": "2014-01-13T14:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206026",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:15'></a>I've tried to tweak the install script to pick up a correct generic value for hwdir depending on cpu/os.



---

archive/issue_comments_206027.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-01-13T14:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206027",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206028.json:
```json
{
    "body": "<a id='comment:16'></a>Hum, that's not enough to prevent the use of specific optimizations flags passed to gcc...",
    "created_at": "2014-01-13T14:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206028",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:16'></a>Hum, that's not enough to prevent the use of specific optimizations flags passed to gcc...



---

archive/issue_comments_206029.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-13T15:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206029",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_206030.json:
```json
{
    "body": "<a id='comment:18'></a>Why this?\n\n```\nAll other platforms currently supported should build 32 bit by default\n```\nI would simply leave non-x86 platform alone.",
    "created_at": "2014-01-13T16:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206030",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Why this?

```
All other platforms currently supported should build 32 bit by default
```
I would simply leave non-x86 platform alone.



---

archive/issue_comments_206031.json:
```json
{
    "body": "<a id='comment:19'></a>Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.",
    "created_at": "2014-01-13T16:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206031",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.



---

archive/issue_comments_206032.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 jdemeyer]:\n> Why this?\n> \n> ```\n> All other platforms currently supported should build 32 bit by default\n> ```\n\nBecause it seemed to me it was the case.\nI thought of:\n* Solaris/Linux on sparc* where the default is 32 bit (as per what gcc does) unless SAGE64 is passed (by the way the current filtering might be wrong on Solaris on top of x86_64...).\n* ARM (only 32 bit at the moment, but not even really officially supported anyway).\n* Cygwin should only be x86/x86_64 (does Windows even run on something else?) so is taken care of.\n* Darwin on PPC[!64]/PowerPC (and even PPC64 in fact) which is only supported 32 bit by Sage.\n* non-Darwin ppc64 (let's say POWER? system) are 64 bits.\n* don\"t really know on what FreeBSD can run on, but it's not officially supported, and x86/x86_64.\n\nHum, I forgot (linux) itanium which happens to be 64 bit (only I'd say?)...\n\nAll that to say, that my original point was to avoid to develop an overly complicated test script which shouldn't really belong within the install script imho.",
    "created_at": "2014-01-13T16:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206032",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:20'></a>Replying to [comment:18 jdemeyer]:
> Why this?
> 
> ```
> All other platforms currently supported should build 32 bit by default
> ```

Because it seemed to me it was the case.
I thought of:
* Solaris/Linux on sparc* where the default is 32 bit (as per what gcc does) unless SAGE64 is passed (by the way the current filtering might be wrong on Solaris on top of x86_64...).
* ARM (only 32 bit at the moment, but not even really officially supported anyway).
* Cygwin should only be x86/x86_64 (does Windows even run on something else?) so is taken care of.
* Darwin on PPC[!64]/PowerPC (and even PPC64 in fact) which is only supported 32 bit by Sage.
* non-Darwin ppc64 (let's say POWER? system) are 64 bits.
* don"t really know on what FreeBSD can run on, but it's not officially supported, and x86/x86_64.

Hum, I forgot (linux) itanium which happens to be 64 bit (only I'd say?)...

All that to say, that my original point was to avoid to develop an overly complicated test script which shouldn't really belong within the install script imho.



---

archive/issue_comments_206033.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:18 jdemeyer]:\n> I would simply leave non-x86 platform alone.\n\nIndeed, this could work as gf2x is smart enough to detect what unsigned long length the compiler use and pick a correct generic* directory.",
    "created_at": "2014-01-13T16:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206033",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:21'></a>Replying to [comment:18 jdemeyer]:
> I would simply leave non-x86 platform alone.

Indeed, this could work as gf2x is smart enough to detect what unsigned long length the compiler use and pick a correct generic* directory.



---

archive/issue_comments_206034.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:19 jdemeyer]:\n> Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.\n\nI'm fed up with overkill patches produced by autoreconfing and don't have access to a machine where your nice autotools spkg is installed (and even with it, autoreconfing can still be a hell sometimes).",
    "created_at": "2014-01-13T16:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206034",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:22'></a>Replying to [comment:19 jdemeyer]:
> Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.

I'm fed up with overkill patches produced by autoreconfing and don't have access to a machine where your nice autotools spkg is installed (and even with it, autoreconfing can still be a hell sometimes).



---

archive/issue_comments_206035.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-13T16:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206035",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_206036.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 jpflori]:\n> Replying to [comment:19 jdemeyer]:\n> > Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.\n\n> I'm fed up with overkill patches produced by autoreconfing and don't have access to a machine where your nice autotools spkg is installed (and even with it, autoreconfing can still be a hell sometimes).\nAlso note that is quite exactly what autoreconfing would produce (with all the bullshit removed) or so I hope.\nI can provide the configure.ac corrsepondig part, which is basically upstream except for the SSE2 on x86_64 part.",
    "created_at": "2014-01-13T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206036",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:24'></a>Replying to [comment:22 jpflori]:
> Replying to [comment:19 jdemeyer]:
> > Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.

> I'm fed up with overkill patches produced by autoreconfing and don't have access to a machine where your nice autotools spkg is installed (and even with it, autoreconfing can still be a hell sometimes).
Also note that is quite exactly what autoreconfing would produce (with all the bullshit removed) or so I hope.
I can provide the configure.ac corrsepondig part, which is basically upstream except for the SSE2 on x86_64 part.



---

archive/issue_comments_206037.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 jpflori]:\n> I can provide the configure.ac corrsepondig part\n\nPlease do.",
    "created_at": "2014-01-14T08:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206037",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>Replying to [comment:24 jpflori]:
> I can provide the configure.ac corrsepondig part

Please do.



---

archive/issue_comments_206038.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:22 jpflori]:\n> and even with it, autoreconfing can still be a hell sometimes.\n\nThat's usually because upstream uses a distro-specific version of autotools. For vanilla versions of autotools, the output that you get with the autotools spkg should be identical to the one in the package.",
    "created_at": "2014-01-14T08:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206038",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:22 jpflori]:
> and even with it, autoreconfing can still be a hell sometimes.

That's usually because upstream uses a distro-specific version of autotools. For vanilla versions of autotools, the output that you get with the autotools spkg should be identical to the one in the package.



---

archive/issue_comments_206039.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n+When SAGE_FAT_BINARY is set we should pick a generic value for hwdir.\n+We should also use --libdir so that gf2x works ok on OpenSuse and similar systems.\n \n+**Upstream**: [https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979](https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979)\n \n Comment: 1\n \n```\n",
    "created_at": "2014-01-14T11:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206039",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,7 @@
+When SAGE_FAT_BINARY is set we should pick a generic value for hwdir.
+We should also use --libdir so that gf2x works ok on OpenSuse and similar systems.
 
+**Upstream**: [https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979](https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979)
 
 Comment: 1
 
```




---

archive/issue_comments_206040.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:26 jdemeyer]:\n> Replying to [comment:22 jpflori]:\n> > and even with it, autoreconfing can still be a hell sometimes.\n\n> That's usually because upstream uses a distro-specific version of autotools. For vanilla versions of autotools, the output that you get with the autotools spkg should be identical to the one in the package.\nOn a side note, would you consider updateing the autotools spkg and gitify it?\n\nI'm currently crafting a proper patch, and while at it I'll aslo include the fixes for SSE2 checks.",
    "created_at": "2014-01-14T11:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206040",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:28'></a>Replying to [comment:26 jdemeyer]:
> Replying to [comment:22 jpflori]:
> > and even with it, autoreconfing can still be a hell sometimes.

> That's usually because upstream uses a distro-specific version of autotools. For vanilla versions of autotools, the output that you get with the autotools spkg should be identical to the one in the package.
On a side note, would you consider updateing the autotools spkg and gitify it?

I'm currently crafting a proper patch, and while at it I'll aslo include the fixes for SSE2 checks.



---

archive/issue_comments_206041.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-14T11:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206041",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_206042.json:
```json
{
    "body": "<a id='comment:30'></a>Now it seems that as acinclude.m4 is patched (before configure), autotools want to rerun some magic stuff.\nShould we manually touch Makefiles?",
    "created_at": "2014-01-14T11:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206042",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:30'></a>Now it seems that as acinclude.m4 is patched (before configure), autotools want to rerun some magic stuff.
Should we manually touch Makefiles?



---

archive/issue_comments_206043.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 jpflori]:\n> Should we manually touch Makefiles?\n\nSure, why not?",
    "created_at": "2014-01-14T12:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206043",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>Replying to [comment:30 jpflori]:
> Should we manually touch Makefiles?

Sure, why not?



---

archive/issue_comments_206044.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 jdemeyer]:\n> Replying to [comment:30 jpflori]:\n> > Should we manually touch Makefiles?\n\n> Sure, why not?\nBecause:\n* it's more work,\n* it's a pain to maintain as it will be additional code within spkg-install (unless I introduce empty chunks touching these Makefiles in the same patch file touching acinclude.m4 but it feels hackish),\n* I'm lazy :)",
    "created_at": "2014-01-14T13:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206044",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:32'></a>Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 jpflori]:
> > Should we manually touch Makefiles?

> Sure, why not?
Because:
* it's more work,
* it's a pain to maintain as it will be additional code within spkg-install (unless I introduce empty chunks touching these Makefiles in the same patch file touching acinclude.m4 but it feels hackish),
* I'm lazy :)



---

archive/issue_comments_206045.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-14T14:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206045",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_206046.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-01-14T14:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206046",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206047.json:
```json
{
    "body": "<a id='comment:35'></a>I'm confused because it seems that you're solving the same problem twice:\n1. You supply the `hwdir` option to configure\n2. You supply the `--disable-hardware-specific-code` option to configure\n\nWouldn't either of these two work by itself?\n\nA more serious issue is that you should not assume that SSE2 code can be *compiled* properly, the compiler and assembler need to support it. Hardware support and software support are orthogonal. On `x86_64`, you may assume hardware support but you still need `CHECK_SSE2_SUPPORT()` to check for software support.",
    "created_at": "2014-01-14T14:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206047",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>I'm confused because it seems that you're solving the same problem twice:
1. You supply the `hwdir` option to configure
2. You supply the `--disable-hardware-specific-code` option to configure

Wouldn't either of these two work by itself?

A more serious issue is that you should not assume that SSE2 code can be *compiled* properly, the compiler and assembler need to support it. Hardware support and software support are orthogonal. On `x86_64`, you may assume hardware support but you still need `CHECK_SSE2_SUPPORT()` to check for software support.



---

archive/issue_comments_206048.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-01-14T14:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206048",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206049.json:
```json
{
    "body": "<a id='comment:37'></a>Hang on, working on a patch...",
    "created_at": "2014-01-14T15:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206049",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Hang on, working on a patch...



---

archive/issue_comments_206050.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:35 jdemeyer]:\n> I'm confused because it seems that you're solving the same problem twice:\n> 1. You supply the `hwdir` option to configure\n> 2. You supply the `--disable-hardware-specific-code` option to configure\n> \n> Wouldn't either of these two work by itself?\n\nNot right now.\nWith \"--disable-hardware-specific-code\" you only use the generic32, generic64 targets.\nWith only hwdir set, the configure script still checks whether SSE2 and pclmul are supported and can add the corresponding flags to CFLAGS.\n> \n> A more serious issue is that you should not assume that SSE2 code can be *compiled* properly, the compiler and assembler need to support it. Hardware support and software support are orthogonal. On `x86_64`, you may assume hardware support but you still need `CHECK_SSE2_SUPPORT()` to check for software support.\n\nI agree with the hardware/software dichotomy.\nThe problem is that the CHECK_SSE2_SUPPORT macro does not only checks for SSE2 support but can add things to CFLAGS (for example on 32 bits where -msse2 is needed)... so we cannot just call it unconditionally and that's why it is not called upstream when \"--disable-hardware-specific-code\" is passed, and the upstream choice to only use generic32/64 seems the right one.\n\nIf we want to use the x86_64 hwdir (with sse2) for sage generic builds, we should still pass \"--disable-hardware-specific-code\" to ensure pclmul is not used, nor sse2 on x86, but still call CHECK_SSE2_SUPPORT() on x86_64 and if that succeeds, set hwdir to x86_64.\n\nThe other solution is to modify the symlinks as before so that the x86_64 does not require sse2 (but could still use plain assembly).",
    "created_at": "2014-01-14T15:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206050",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:38'></a>Replying to [comment:35 jdemeyer]:
> I'm confused because it seems that you're solving the same problem twice:
> 1. You supply the `hwdir` option to configure
> 2. You supply the `--disable-hardware-specific-code` option to configure
> 
> Wouldn't either of these two work by itself?

Not right now.
With "--disable-hardware-specific-code" you only use the generic32, generic64 targets.
With only hwdir set, the configure script still checks whether SSE2 and pclmul are supported and can add the corresponding flags to CFLAGS.
> 
> A more serious issue is that you should not assume that SSE2 code can be *compiled* properly, the compiler and assembler need to support it. Hardware support and software support are orthogonal. On `x86_64`, you may assume hardware support but you still need `CHECK_SSE2_SUPPORT()` to check for software support.

I agree with the hardware/software dichotomy.
The problem is that the CHECK_SSE2_SUPPORT macro does not only checks for SSE2 support but can add things to CFLAGS (for example on 32 bits where -msse2 is needed)... so we cannot just call it unconditionally and that's why it is not called upstream when "--disable-hardware-specific-code" is passed, and the upstream choice to only use generic32/64 seems the right one.

If we want to use the x86_64 hwdir (with sse2) for sage generic builds, we should still pass "--disable-hardware-specific-code" to ensure pclmul is not used, nor sse2 on x86, but still call CHECK_SSE2_SUPPORT() on x86_64 and if that succeeds, set hwdir to x86_64.

The other solution is to modify the symlinks as before so that the x86_64 does not require sse2 (but could still use plain assembly).



---

archive/issue_comments_206051.json:
```json
{
    "body": "<a id='comment:39'></a>Did upstream accept your `--disable-hardware-specific-code` patch?",
    "created_at": "2014-01-14T15:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206051",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>Did upstream accept your `--disable-hardware-specific-code` patch?



---

archive/issue_comments_206052.json:
```json
{
    "body": "<a id='comment:40'></a>Simplified version of the patches, seems to work (at first sight).",
    "created_at": "2014-01-14T15:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206052",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>Simplified version of the patches, seems to work (at first sight).



---

archive/issue_comments_206053.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-01-14T15:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206053",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206054.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:39 jdemeyer]:\n> Did upstream accept your `--disable-hardware-specific-code` patch?\n\nHummm, this patch is upstream (see commit numbers in SPKG.txt, 162 ands 167 IIRC). \nOnly the x86_64 part which assumes SSE2 support is mine.",
    "created_at": "2014-01-14T15:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206054",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:41'></a>Replying to [comment:39 jdemeyer]:
> Did upstream accept your `--disable-hardware-specific-code` patch?

Hummm, this patch is upstream (see commit numbers in SPKG.txt, 162 ands 167 IIRC). 
Only the x86_64 part which assumes SSE2 support is mine.



---

archive/issue_comments_206055.json:
```json
{
    "body": "<a id='comment:43'></a>I didn't realize the patch was upstream, so perhaps I shouldn't have changed it. Anyway, I'm going to leave this for today...\n\n---\nNew commits:",
    "created_at": "2014-01-14T16:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206055",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>I didn't realize the patch was upstream, so perhaps I shouldn't have changed it. Anyway, I'm going to leave this for today...

---
New commits:



---

archive/issue_comments_206056.json:
```json
{
    "body": "<a id='comment:44'></a>In fact I'm happier with your patch than with what upstream provided, so you could even transfer it upstream.\n\nAnd note that your patch touch configure.ac after configure.",
    "created_at": "2014-01-14T16:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206056",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:44'></a>In fact I'm happier with your patch than with what upstream provided, so you could even transfer it upstream.

And note that your patch touch configure.ac after configure.



---

archive/issue_comments_206057.json:
```json
{
    "body": "<a id='comment:45'></a>About the patch order: you're touching `configure` anyway...",
    "created_at": "2014-01-14T16:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206057",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>About the patch order: you're touching `configure` anyway...



---

archive/issue_comments_206058.json:
```json
{
    "body": "<a id='comment:46'></a>Oops, I mistakenly changed the branch name.\n\nAbout the patch order: I'd say your patch is the last one so configure.ac will have a more recent timestamp than configure which is what we want to avoid, isn't it? (ok in real life I don't know what granularity timestamps have, so if it is one second, timestamps should be the same).\n\n---\nNew commits:",
    "created_at": "2014-01-14T16:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206058",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:46'></a>Oops, I mistakenly changed the branch name.

About the patch order: I'd say your patch is the last one so configure.ac will have a more recent timestamp than configure which is what we want to avoid, isn't it? (ok in real life I don't know what granularity timestamps have, so if it is one second, timestamps should be the same).

---
New commits:



---

archive/issue_comments_206059.json:
```json
{
    "body": "<a id='comment:47'></a>For the autotools package: see #15123.",
    "created_at": "2014-01-14T17:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206059",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>For the autotools package: see #15123.



---

archive/issue_comments_206060.json:
```json
{
    "body": "<a id='comment:48'></a>Your branch fails on ppc64.\nIn fact mine does as well in a similar way but only when SAGE_FAT_BINARY=yes..\nApparently the tuning process tries to build sse2 code.\n\nAnd this won't work if the compiler does not support SSE2:\n\n```\n++ CHECK_SSE2_SUPPORT()\n++ if test x$enable_hardware_specific_code = xyes; then\n++ CHECK_PCLMUL_SUPPORT()\n++ fi\n++ if test x$gf2x_cv_cc_supports_pclmul != xyes ; then\n+ hwdir=x86_64\n```\nbecause the x86_64 dir cannot be used without sse2 support (and that's why you could and still can not build on x86_64 with --disable-sse2).",
    "created_at": "2014-01-15T22:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206060",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:48'></a>Your branch fails on ppc64.
In fact mine does as well in a similar way but only when SAGE_FAT_BINARY=yes..
Apparently the tuning process tries to build sse2 code.

And this won't work if the compiler does not support SSE2:

```
++ CHECK_SSE2_SUPPORT()
++ if test x$enable_hardware_specific_code = xyes; then
++ CHECK_PCLMUL_SUPPORT()
++ fi
++ if test x$gf2x_cv_cc_supports_pclmul != xyes ; then
+ hwdir=x86_64
```
because the x86_64 dir cannot be used without sse2 support (and that's why you could and still can not build on x86_64 with --disable-sse2).



---

archive/issue_comments_206061.json:
```json
{
    "body": "<a id='comment:49'></a>The matter is surely that\n\n```\nAM_CONDITIONAL([GF2X_SSE2_AVAILABLE],[test \"x$gf2x_cv_cc_supports_sse2\" != xno])\nAM_CONDITIONAL([GF2X_PCLMUL_AVAILABLE],[test \"x$gf2x_cv_cc_supports_pclmul\" != xno])\n```\nbehaves wrongly because the _supports_ vars are left undefined.",
    "created_at": "2014-01-15T22:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206061",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:49'></a>The matter is surely that

```
AM_CONDITIONAL([GF2X_SSE2_AVAILABLE],[test "x$gf2x_cv_cc_supports_sse2" != xno])
AM_CONDITIONAL([GF2X_PCLMUL_AVAILABLE],[test "x$gf2x_cv_cc_supports_pclmul" != xno])
```
behaves wrongly because the _supports_ vars are left undefined.



---

archive/issue_comments_206062.json:
```json
{
    "body": "<a id='comment:50'></a>Yes, the `!= xno` should be replaced by `= xyes` I guess.",
    "created_at": "2014-01-15T22:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206062",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>Yes, the `!= xno` should be replaced by `= xyes` I guess.



---

archive/issue_comments_206063.json:
```json
{
    "body": "<a id='comment:51'></a>A better and more flexible solution could be to decorrelate the sse2/pclmul tests and the definitions of HAVE_*_SUPPORT.\nJust as \n\n```\nAM_CONDITIONAL([GF2X_PCLMUL_AVAILABLE],[test \"x$gf2x_cv_cc_supports_pclmul\" != xno])\n```\nwhich is in configure.ac, the following which is in acinclude.m4 within the SSE2 support macro could be in configure.ac.\n\n```\n if test \"$gf2x_cv_cc_supports_sse2\" != \"no\" ;then\n  AC_DEFINE([HAVE_SSE2_SUPPORT],[1],[Define if sse-2 code as present in the source tree is supported by the compiler])\n fi\n```",
    "created_at": "2014-01-15T22:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206063",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:51'></a>A better and more flexible solution could be to decorrelate the sse2/pclmul tests and the definitions of HAVE_*_SUPPORT.
Just as 

```
AM_CONDITIONAL([GF2X_PCLMUL_AVAILABLE],[test "x$gf2x_cv_cc_supports_pclmul" != xno])
```
which is in configure.ac, the following which is in acinclude.m4 within the SSE2 support macro could be in configure.ac.

```
 if test "$gf2x_cv_cc_supports_sse2" != "no" ;then
  AC_DEFINE([HAVE_SSE2_SUPPORT],[1],[Define if sse-2 code as present in the source tree is supported by the compiler])
 fi
```



---

archive/issue_comments_206064.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:50 jdemeyer]:\n> Yes, the `!= xno` should be replaced by `= xyes` I guess.\n\nThat would also do the trick.",
    "created_at": "2014-01-15T22:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206064",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:52'></a>Replying to [comment:50 jdemeyer]:
> Yes, the `!= xno` should be replaced by `= xyes` I guess.

That would also do the trick.



---

archive/issue_comments_206065.json:
```json
{
    "body": "<a id='comment:53'></a>Replying to [comment:46 jpflori]:\n> About the patch order: I'd say your patch is the last one so configure.ac will have a more recent timestamp than configure which is what we want to avoid, isn't it? (ok in real life I don't know what granularity timestamps have, so if it is one second, timestamps should be the same).\n\n\nCould you clarify this as I'm apparently mistaken of why configure.ac should usually be patched before configure?",
    "created_at": "2014-01-16T10:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206065",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:53'></a>Replying to [comment:46 jpflori]:
> About the patch order: I'd say your patch is the last one so configure.ac will have a more recent timestamp than configure which is what we want to avoid, isn't it? (ok in real life I don't know what granularity timestamps have, so if it is one second, timestamps should be the same).


Could you clarify this as I'm apparently mistaken of why configure.ac should usually be patched before configure?



---

archive/issue_comments_206066.json:
```json
{
    "body": "<a id='comment:54'></a>I've implemented the changes suggested above.\n\n---\nNew commits:",
    "created_at": "2014-01-28T18:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206066",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:54'></a>I've implemented the changes suggested above.

---
New commits:



---

archive/issue_events_044392.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15316#event-44392"
}
```



---

archive/issue_comments_206067.json:
```json
{
    "body": "<a id='comment:56'></a>Jeroen, any chance you could review this one?",
    "created_at": "2014-03-30T14:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206067",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:56'></a>Jeroen, any chance you could review this one?



---

archive/issue_events_044393.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15316#event-44393"
}
```



---

archive/issue_events_044394.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15316#event-44394"
}
```



---

archive/issue_comments_206068.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-06-16T14:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206068",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206069.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:52 jpflori]:\n> Replying to [comment:50 jdemeyer]:\n> > Yes, the `!= xno` should be replaced by `= xyes` I guess.\n\n> That would also do the trick.\n\nNot quite: $gf2x_cv_cc_supports_sse2 can be \"requires -msse2\", and $gf2x_cv_cc_supports_pclmul can be \"requires -mpclmul\".\n\nSeems more sane to me to run CHECK_SSE2_SUPPORT and CHECK_PCLMUL_SUPPORT always, so that the case  where gf2x_cv_cc_supports_sse2/pclmul is undefined does not occur, with enable_sse2=no and enable_pclmul=no as appropriate.",
    "created_at": "2014-06-16T14:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206069",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

<a id='comment:58'></a>Replying to [comment:52 jpflori]:
> Replying to [comment:50 jdemeyer]:
> > Yes, the `!= xno` should be replaced by `= xyes` I guess.

> That would also do the trick.

Not quite: $gf2x_cv_cc_supports_sse2 can be "requires -msse2", and $gf2x_cv_cc_supports_pclmul can be "requires -mpclmul".

Seems more sane to me to run CHECK_SSE2_SUPPORT and CHECK_PCLMUL_SUPPORT always, so that the case  where gf2x_cv_cc_supports_sse2/pclmul is undefined does not occur, with enable_sse2=no and enable_pclmul=no as appropriate.



---

archive/issue_comments_206070.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-06-19T09:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206070",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206071.json:
```json
{
    "body": "<a id='comment:60'></a>By seperating enabling of sse2/pclmul support from checking for support, configure can now run CHECK_(SSE2|PCLMUL)_SUPPORT always, avoiding the case where $gfx_cv_cc_support_(sse|pclmul) is not defined.\n\nI'm afraid the patches are all different again. I imported upstream [svn](https://github.com/nesciens/gf2x/tree/svn) and the upstream [tarballs](https://github.com/nesciens/gf2x/tree/tarballs) into [a git repository](https://github.com/nesciens/gf2x), then applied the changes in several topic branches ([cygwin](https://github.com/nesciens/gf2x/tree/cygwin), [hardware-specific](https://github.com/nesciens/gf2x/tree/hardware-specific), [sse2](https://github.com/nesciens/gf2x/tree/sse2), and [tr](https://github.com/nesciens/gf2x/tree/tr)), merge --squash'ed those branches into [single commits](https://github.com/nesciens/gf2x/commits/sage), updated autotooled files (running autoreconf and reverse applying autoreconf's effect on upstream tarball), and finally ran git format-patch to obtain the patch series.",
    "created_at": "2014-06-19T09:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206071",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

<a id='comment:60'></a>By seperating enabling of sse2/pclmul support from checking for support, configure can now run CHECK_(SSE2|PCLMUL)_SUPPORT always, avoiding the case where $gfx_cv_cc_support_(sse|pclmul) is not defined.

I'm afraid the patches are all different again. I imported upstream [svn](https://github.com/nesciens/gf2x/tree/svn) and the upstream [tarballs](https://github.com/nesciens/gf2x/tree/tarballs) into [a git repository](https://github.com/nesciens/gf2x), then applied the changes in several topic branches ([cygwin](https://github.com/nesciens/gf2x/tree/cygwin), [hardware-specific](https://github.com/nesciens/gf2x/tree/hardware-specific), [sse2](https://github.com/nesciens/gf2x/tree/sse2), and [tr](https://github.com/nesciens/gf2x/tree/tr)), merge --squash'ed those branches into [single commits](https://github.com/nesciens/gf2x/commits/sage), updated autotooled files (running autoreconf and reverse applying autoreconf's effect on upstream tarball), and finally ran git format-patch to obtain the patch series.



---

archive/issue_comments_206072.json:
```json
{
    "body": "<a id='comment:61'></a>It's not so easy to see what the last commit actually does and unfortunately I have no time to play around applying different sets of patches to the src we distribute, diff the result and play with strange archs, compilers.\n\nSo my question is: what dirs will be used on x86_64 when the compiler support emitting sse2 instructions and when it does not and when the blabla-hardware-blabla flag is passed?",
    "created_at": "2014-06-19T14:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206072",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:61'></a>It's not so easy to see what the last commit actually does and unfortunately I have no time to play around applying different sets of patches to the src we distribute, diff the result and play with strange archs, compilers.

So my question is: what dirs will be used on x86_64 when the compiler support emitting sse2 instructions and when it does not and when the blabla-hardware-blabla flag is passed?



---

archive/issue_comments_206073.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-06-19T17:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206073",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206074.json:
```json
{
    "body": "<a id='comment:62'></a>With --enable-hardware-specific-code (the default), it depends on whether code with sse2/pclmul can be **compiled and executed**.\n\n|cpu   |execute sse2 |execute pclmul |dir          |\n|:------:|:-------------:|:---------------:|:-------------:|\n|x86_64  |yes            |yes              |x86_64_pclmul  |\n|x86_64  |no             |yes              |x86_64_pclmul  |\n|x86_64  |yes            |no               |x86_64         |\n|x86_64  |no             |no               |generic64      |\nWith --disable-hardware-specific-code: generic64.\n\nHmm, according to the discussion above that latter should be x86_64 instead of generic64, right? I'll fiddle with this some more.\n\nI'm thinking of having the options --enable-sse2 and --enable-pclmul with values \"no\"/\"hostcpu\"/\"native\"/\"yes\", with as default the value of --enable-hardware-specific-code which would itself defaults to \"native\". Value \"hostcpu\" would enable minimally for this $host_cpu (for x86_64 this would be sse2 yes and pclmul no). Value \"native\" would try to compile and execute. Having calculated the final values for --enable-sse2 and --enable-pclmul, sse2 and pclmul would be enabled based on these values. Configure would error out if the compiler lacks support.\n\nThe default directory would be selected based on $host_cpu and whether sse2 and pclmul are enabled. When the directory is forced, insufficient sse2/pclmul might be enabled and configure would error out.",
    "created_at": "2014-06-19T17:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206074",
    "user": "https://trac.sagemath.org/admin/accounts/users/emassop"
}
```

<a id='comment:62'></a>With --enable-hardware-specific-code (the default), it depends on whether code with sse2/pclmul can be **compiled and executed**.

|cpu   |execute sse2 |execute pclmul |dir          |
|:------:|:-------------:|:---------------:|:-------------:|
|x86_64  |yes            |yes              |x86_64_pclmul  |
|x86_64  |no             |yes              |x86_64_pclmul  |
|x86_64  |yes            |no               |x86_64         |
|x86_64  |no             |no               |generic64      |
With --disable-hardware-specific-code: generic64.

Hmm, according to the discussion above that latter should be x86_64 instead of generic64, right? I'll fiddle with this some more.

I'm thinking of having the options --enable-sse2 and --enable-pclmul with values "no"/"hostcpu"/"native"/"yes", with as default the value of --enable-hardware-specific-code which would itself defaults to "native". Value "hostcpu" would enable minimally for this $host_cpu (for x86_64 this would be sse2 yes and pclmul no). Value "native" would try to compile and execute. Having calculated the final values for --enable-sse2 and --enable-pclmul, sse2 and pclmul would be enabled based on these values. Configure would error out if the compiler lacks support.

The default directory would be selected based on $host_cpu and whether sse2 and pclmul are enabled. When the directory is forced, insufficient sse2/pclmul might be enabled and configure would error out.



---

archive/issue_comments_206075.json:
```json
{
    "body": "<a id='comment:63'></a>That's basically upstream choice: use generic when the hardware flag is passed.\nFrom my discussion with Emmanuel, it's basically because they don't care.\nI (and Jeroen?) found it disappointing because the x86_64 spec includes sse2 and quickly and easily came up with our patches which on x86_64 tested if the compiler supports sse2 and if so use the x86_64 folder.\n(Note that this folder uses sse2 instruction, so you cannot use it if the compiler does not support sse2.)",
    "created_at": "2014-06-19T21:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206075",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:63'></a>That's basically upstream choice: use generic when the hardware flag is passed.
From my discussion with Emmanuel, it's basically because they don't care.
I (and Jeroen?) found it disappointing because the x86_64 spec includes sse2 and quickly and easily came up with our patches which on x86_64 tested if the compiler supports sse2 and if so use the x86_64 folder.
(Note that this folder uses sse2 instruction, so you cannot use it if the compiler does not support sse2.)



---

archive/issue_events_044395.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15316#event-44395"
}
```



---

archive/issue_events_044396.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15316#event-44396"
}
```



---

archive/issue_comments_206076.json:
```json
{
    "body": "<a id='comment:65'></a>I'm basically ok with Erik last changes.\n\nI'll just clean up the git branch to current standards and give it positive review.",
    "created_at": "2014-11-12T10:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206076",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:65'></a>I'm basically ok with Erik last changes.

I'll just clean up the git branch to current standards and give it positive review.



---

archive/issue_comments_206077.json:
```json
{
    "body": "<a id='comment:66'></a>New commits:",
    "created_at": "2014-11-12T10:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206077",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:66'></a>New commits:



---

archive/issue_comments_206078.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-11-12T10:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206078",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206079.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-12T10:16:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206079",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_206080.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-14T21:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15316#issuecomment-206080",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_044397.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-11-14T21:01:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15316",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15316#event-44397"
}
```
