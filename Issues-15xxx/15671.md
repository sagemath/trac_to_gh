# Issue 15671: Improve handling of memory errors in integer.pyx

archive/issues_015434.json:
```json
{
    "assignees": [],
    "body": "with Sage 6.0 and the following program:\n\n```\ndef search(p):\n   R = RealField(p)\n   m = 2^(2*p)+2^(p+1)-1\n   l = []\n   for a in range(2^p):\n      for b in range(2^p):\n         for e in range(2):\n            l.append(a*b*2^e)\n   l = uniq(l)\n   l.sort()\n   n = len(l)\n   i = j = 0\n   while i < n and l[i]-l[j] < m:\n      i += 1\n   sol = 0\n   while i < n:\n      if l[i]-l[j]==m:\n         sol += 1\n      j += 1\n      while i < n and l[i]-l[j] < m:\n         i += 1\n   print \"sol=\", sol\n```\nI get:\n\n```\nsage: search(15)\nsig_error() without sig_on()\n------------------------------------------------------------------------\n------------------------------------------------------------------------\nAttaching gdb to process id 404.\n```\n\nBranch/Commit: **[`b23509d`](https://github.com/sagemath/sagetrac-mirror/commit/b23509d7256cc3a8f2cbe13bc3956c6e3302aaec)**\n\nReviewer: **Jeroen Demeyer, Peter Bruin**\n\nAuthor: **Peter Bruin, Jeroen Demeyer**\n\nComponent: **cython**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15671_\n\n",
    "closed_at": "2015-05-08T13:10:45Z",
    "created_at": "2014-01-13T21:21:48Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20cython",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Improve handling of memory errors in integer.pyx",
    "type": "issue",
    "updated_at": "2015-05-08T13:10:45Z",
    "url": "https://github.com/sagemath/sage/issues/15671",
    "user": "https://github.com/zimmermann6"
}
```
with Sage 6.0 and the following program:

```
def search(p):
   R = RealField(p)
   m = 2^(2*p)+2^(p+1)-1
   l = []
   for a in range(2^p):
      for b in range(2^p):
         for e in range(2):
            l.append(a*b*2^e)
   l = uniq(l)
   l.sort()
   n = len(l)
   i = j = 0
   while i < n and l[i]-l[j] < m:
      i += 1
   sol = 0
   while i < n:
      if l[i]-l[j]==m:
         sol += 1
      j += 1
      while i < n and l[i]-l[j] < m:
         i += 1
   print "sol=", sol
```
I get:

```
sage: search(15)
sig_error() without sig_on()
------------------------------------------------------------------------
------------------------------------------------------------------------
Attaching gdb to process id 404.
```

Branch/Commit: **[`b23509d`](https://github.com/sagemath/sagetrac-mirror/commit/b23509d7256cc3a8f2cbe13bc3956c6e3302aaec)**

Reviewer: **Jeroen Demeyer, Peter Bruin**

Author: **Peter Bruin, Jeroen Demeyer**

Component: **cython**

_Issue created by migration from https://trac.sagemath.org/ticket/15671_





---

archive/issue_events_224561.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2014-01-13T21:21:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224561"
}
```



---

archive/issue_events_224562.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2014-01-13T21:21:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20cython",
    "label_color": "000080",
    "label_name": "c: cython",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224562"
}
```



---

archive/issue_events_224563.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2014-01-13T21:21:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224563"
}
```



---

archive/issue_events_224564.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2014-01-13T21:21:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224564"
}
```



---

archive/issue_comments_197048.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe problem seems to lie in `sage/rings/integer.pyx:fast_tp_new()`, where the call to `mpz_alloc()` is not surrounded by `sig_on()...sig_off()`.  This should be fixed, but it probably won't help in this specific example, because Sage runs hopelessly out of memory.  I tried it twice with the `sig_on()...sig_off()` added, and Sage still crashes, just not with the same error message; once it was killed by IPython with a `MemoryError`, once by Sage's `c_lib/src/interrupt.c:sigdie()`, presumably because another out of memory error occurs during signal handling.",
    "created_at": "2014-01-13T22:22:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197048",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

The problem seems to lie in `sage/rings/integer.pyx:fast_tp_new()`, where the call to `mpz_alloc()` is not surrounded by `sig_on()...sig_off()`.  This should be fixed, but it probably won't help in this specific example, because Sage runs hopelessly out of memory.  I tried it twice with the `sig_on()...sig_off()` added, and Sage still crashes, just not with the same error message; once it was killed by IPython with a `MemoryError`, once by Sage's `c_lib/src/interrupt.c:sigdie()`, presumably because another out of memory error occurs during signal handling.



---

archive/issue_comments_197049.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThat `mpz_alloc()` allocated very little memory (8 bytes on a 64-bit system). If allocating even 8 bytes fails, you are going to run into trouble anyway.",
    "created_at": "2014-01-14T10:52:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197049",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

That `mpz_alloc()` allocated very little memory (8 bytes on a 64-bit system). If allocating even 8 bytes fails, you are going to run into trouble anyway.



---

archive/issue_comments_197050.json:
```json
{
    "body": "Author: **Peter Bruin**",
    "created_at": "2014-01-15T17:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197050",
    "user": "https://github.com/pjbruin"
}
```

Author: **Peter Bruin**



---

archive/issue_comments_197051.json:
```json
{
    "body": "Branch: **[u/pbruin/15671-mpz_alloc_sig_on](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-mpz_alloc_sig_on)**",
    "created_at": "2014-01-15T17:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197051",
    "user": "https://github.com/pjbruin"
}
```

Branch: **[u/pbruin/15671-mpz_alloc_sig_on](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-mpz_alloc_sig_on)**



---

archive/issue_comments_197052.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHere is the fix, not to actually solve any memory problems, just to increase the probability that the user gets a somewhat informative error message.",
    "created_at": "2014-01-15T17:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197052",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

Here is the fix, not to actually solve any memory problems, just to increase the probability that the user gets a somewhat informative error message.



---

archive/issue_comments_197053.json:
```json
{
    "body": "Commit: **[`d303ab6`](https://github.com/sagemath/sagetrac-mirror/commit/d303ab632c54217bc8a4cc48af997962ed7f8172)**",
    "created_at": "2014-01-15T17:05:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197053",
    "user": "https://github.com/pjbruin"
}
```

Commit: **[`d303ab6`](https://github.com/sagemath/sagetrac-mirror/commit/d303ab632c54217bc8a4cc48af997962ed7f8172)**



---

archive/issue_events_224565.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-01-15T17:05:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224565"
}
```



---

archive/issue_comments_197054.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nPeter, your fix looks good to me, however if a complete run of doctests is needed, I won't have time in the near future.\n\nPaul",
    "created_at": "2014-01-15T17:18:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197054",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:4" align="right">comment:4</div>

Peter, your fix looks good to me, however if a complete run of doctests is needed, I won't have time in the near future.

Paul



---

archive/issue_events_224566.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224566"
}
```



---

archive/issue_events_224567.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224567"
}
```



---

archive/issue_events_224568.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224568"
}
```



---

archive/issue_events_224569.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224569"
}
```



---

archive/issue_comments_197055.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nCuriously, this innocent-looking fix causes three doctests to fail with a `SystemError`, see the [patchbot report](http://patchbot.sagemath.org/log/15671/debian/wheezy/sid/x86_64/3.2.0-57-generic/selmer/2014-05-09%2018:21:24%20+0100?short):\n\n```\nsage -t --long src/sage/structure/parent.pyx  # 1 doctest failed\nsage -t --long src/sage/rings/integer.pyx  # 1 doctest failed\nsage -t --long src/sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed\n```",
    "created_at": "2014-05-09T17:17:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197055",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:7" align="right">comment:7</div>

Curiously, this innocent-looking fix causes three doctests to fail with a `SystemError`, see the [patchbot report](http://patchbot.sagemath.org/log/15671/debian/wheezy/sid/x86_64/3.2.0-57-generic/selmer/2014-05-09%2018:21:24%20+0100?short):

```
sage -t --long src/sage/structure/parent.pyx  # 1 doctest failed
sage -t --long src/sage/rings/integer.pyx  # 1 doctest failed
sage -t --long src/sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed
```



---

archive/issue_events_224570.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-09T17:17:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224570"
}
```



---

archive/issue_events_224571.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-09T17:17:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224571"
}
```



---

archive/issue_events_224572.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224572"
}
```



---

archive/issue_events_224573.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224573"
}
```



---

archive/issue_events_224574.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-08-18T22:40:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224574"
}
```



---

archive/issue_events_224575.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-08-18T22:40:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224575"
}
```



---

archive/issue_comments_197056.json:
```json
{
    "body": "Changed author from **Peter Bruin** to **Peter Bruin, Jeroen Demeyer**",
    "created_at": "2014-08-18T22:40:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197056",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Peter Bruin** to **Peter Bruin, Jeroen Demeyer**



---

archive/issue_comments_197057.json:
```json
{
    "body": "Changed branch from **[u/pbruin/15671-mpz_alloc_sig_on](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-mpz_alloc_sig_on)** to **[u/jdemeyer/ticket/15671](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/15671)**",
    "created_at": "2014-08-18T22:40:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197057",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/pbruin/15671-mpz_alloc_sig_on](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-mpz_alloc_sig_on)** to **[u/jdemeyer/ticket/15671](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/15671)**



---

archive/issue_comments_197058.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/84ef4e5fc1bb75cc74ea9147e36efc243dc1a6ab\"><code>84ef4e5</code></a></td><td><code>Add back deleted declaration for richcmpfunc</code></td></tr></table>\n",
    "created_at": "2014-08-18T23:13:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197058",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/84ef4e5fc1bb75cc74ea9147e36efc243dc1a6ab"><code>84ef4e5</code></a></td><td><code>Add back deleted declaration for richcmpfunc</code></td></tr></table>




---

archive/issue_comments_197059.json:
```json
{
    "body": "Changed commit from **[`d303ab6`](https://github.com/sagemath/sagetrac-mirror/commit/d303ab632c54217bc8a4cc48af997962ed7f8172)** to **[`84ef4e5`](https://github.com/sagemath/sagetrac-mirror/commit/84ef4e5fc1bb75cc74ea9147e36efc243dc1a6ab)**",
    "created_at": "2014-08-18T23:13:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197059",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d303ab6`](https://github.com/sagemath/sagetrac-mirror/commit/d303ab632c54217bc8a4cc48af997962ed7f8172)** to **[`84ef4e5`](https://github.com/sagemath/sagetrac-mirror/commit/84ef4e5fc1bb75cc74ea9147e36efc243dc1a6ab)**



---

archive/issue_events_224576.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-11-27T23:05:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224576"
}
```



---

archive/issue_events_224577.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-11-27T23:05:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224577"
}
```



---

archive/issue_comments_197060.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nMerge conflict because of #16910, which replaced the `mpz_alloc()` in question by `sage_malloc()`.\n\nI tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors.  First try:\n\n```\nsage: search(15)\nsig_error() without sig_on()\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff74560d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6\n(gdb) bt\n#0  0x00007ffff74560d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6\n#1  0x00007ffff745983b in abort () from /lib/x86_64-linux-gnu/libc.so.6\n#2  0x00007fffeb373082 in sig_error () from /home/bruinpj/src/sage/local/lib/libcsage.so\n#3  0x00007fffeb373171 in alloc_error () from /home/bruinpj/src/sage/local/lib/libcsage.so\n#4  0x00007fffeb3731f8 in sage_gmp_realloc () from /home/bruinpj/src/sage/local/lib/libcsage.so\n#5  0x00007fffeb124f21 in __gmpz_realloc (m=0x1b48dfc0, new_alloc=2) at realloc.c:33\n#6  0x00007fffeb121e70 in __gmpz_mul_si (prod=0x1b48dfc0, mult=0x1b48df50, small_mult=2445144) at mul_i.h:67\n#7  0x00007fffe35185b2 in __pyx_f_4sage_5rings_7integer_7Integer__mul_long (__pyx_v_self=0x1b48df30, __pyx_v_n=2445144) at build/cythonized/sage/rings/integer.c:12409\n#8  0x00007fffe73c4c73 in __pyx_pf_4sage_9structure_7element_11RingElement_10__mul__ (__pyx_v_right=<sage.rings.integer.Integer at remote 0x1b48df30>, __pyx_v_left=\n    2445144) at build/cythonized/sage/structure/element.c:16796\n...\nUnhandled SIGABRT: An abort() occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nSage will now terminate.\n```\nSecond try:\n\n```\nsage: search(15)\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00007ffff756a1e7 in ?? () from /lib/x86_64-linux-gnu/libc.so.6\n(gdb) bt\n#0  0x00007ffff756a1e7 in ?? () from /lib/x86_64-linux-gnu/libc.so.6\n#1  0x00007fffe3512bc5 in __pyx_f_4sage_5rings_7integer_fast_tp_new (__pyx_v_t=<optimized out>, __pyx_v_a=<optimized out>, __pyx_v_k=<optimized out>)\n    at /usr/include/x86_64-linux-gnu/bits/string3.h:52\n#2  0x00007fffe3532684 in __pyx_pf_4sage_5rings_7integer_7Integer_72__pow__ (__pyx_v_self=<sage.rings.integer.Integer at remote 0x7fffbc5a7ab0>, __pyx_v_n=1,\n    __pyx_v_modulus=<optimized out>) at build/cythonized/sage/rings/integer.c:13906\n#3  0x00007ffff7a43832 in ternary_op (v=<sage.rings.integer.Integer at remote 0x7fffbc5a7ab0>, w=1, z=None, op_slot=48, op_name=<optimized out>)\n    at Objects/abstract.c:1065\n...\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nSage will now terminate.\n```",
    "created_at": "2014-11-27T23:05:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197060",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

Merge conflict because of #16910, which replaced the `mpz_alloc()` in question by `sage_malloc()`.

I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors.  First try:

```
sage: search(15)
sig_error() without sig_on()

Program received signal SIGABRT, Aborted.
0x00007ffff74560d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6
(gdb) bt
#0  0x00007ffff74560d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007ffff745983b in abort () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007fffeb373082 in sig_error () from /home/bruinpj/src/sage/local/lib/libcsage.so
#3  0x00007fffeb373171 in alloc_error () from /home/bruinpj/src/sage/local/lib/libcsage.so
#4  0x00007fffeb3731f8 in sage_gmp_realloc () from /home/bruinpj/src/sage/local/lib/libcsage.so
#5  0x00007fffeb124f21 in __gmpz_realloc (m=0x1b48dfc0, new_alloc=2) at realloc.c:33
#6  0x00007fffeb121e70 in __gmpz_mul_si (prod=0x1b48dfc0, mult=0x1b48df50, small_mult=2445144) at mul_i.h:67
#7  0x00007fffe35185b2 in __pyx_f_4sage_5rings_7integer_7Integer__mul_long (__pyx_v_self=0x1b48df30, __pyx_v_n=2445144) at build/cythonized/sage/rings/integer.c:12409
#8  0x00007fffe73c4c73 in __pyx_pf_4sage_9structure_7element_11RingElement_10__mul__ (__pyx_v_right=<sage.rings.integer.Integer at remote 0x1b48df30>, __pyx_v_left=
    2445144) at build/cythonized/sage/structure/element.c:16796
...
Unhandled SIGABRT: An abort() occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
```
Second try:

```
sage: search(15)

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff756a1e7 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
(gdb) bt
#0  0x00007ffff756a1e7 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007fffe3512bc5 in __pyx_f_4sage_5rings_7integer_fast_tp_new (__pyx_v_t=<optimized out>, __pyx_v_a=<optimized out>, __pyx_v_k=<optimized out>)
    at /usr/include/x86_64-linux-gnu/bits/string3.h:52
#2  0x00007fffe3532684 in __pyx_pf_4sage_5rings_7integer_7Integer_72__pow__ (__pyx_v_self=<sage.rings.integer.Integer at remote 0x7fffbc5a7ab0>, __pyx_v_n=1,
    __pyx_v_modulus=<optimized out>) at build/cythonized/sage/rings/integer.c:13906
#3  0x00007ffff7a43832 in ternary_op (v=<sage.rings.integer.Integer at remote 0x7fffbc5a7ab0>, w=1, z=None, op_slot=48, op_name=<optimized out>)
    at Objects/abstract.c:1065
...
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
```



---

archive/issue_comments_197061.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@pjbruin](#comment:13):\n> I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors.\n\nThis is to be expected, see [comment:2].",
    "created_at": "2014-11-28T06:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197061",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@pjbruin](#comment:13):
> I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors.

This is to be expected, see [comment:2].



---

archive/issue_comments_197062.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@pjbruin](#comment:13):\n> I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors\n\nSorry, I understand what you mean. You get 2 different errors which are also different from the error that was initially reported.",
    "created_at": "2014-11-28T06:19:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197062",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@pjbruin](#comment:13):
> I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors

Sorry, I understand what you mean. You get 2 different errors which are also different from the error that was initially reported.



---

archive/issue_comments_197063.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nWe should indeed put `sig_on()`/`sig_off()` in many more places, but I'm afraid people will worry about the performance impact (there is a very small but still measurable slow-down with `sig_on()`).",
    "created_at": "2014-11-28T06:25:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197063",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

We should indeed put `sig_on()`/`sig_off()` in many more places, but I'm afraid people will worry about the performance impact (there is a very small but still measurable slow-down with `sig_on()`).



---

archive/issue_comments_197064.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nProposal: introduce new Sage functions `sage_malloc_check()` which raises `MemoryError` when the allocation failed and use that to fix this issue.",
    "created_at": "2014-11-28T06:28:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197064",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Proposal: introduce new Sage functions `sage_malloc_check()` which raises `MemoryError` when the allocation failed and use that to fix this issue.



---

archive/issue_comments_197065.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jdemeyer](#comment:16):\n> We should indeed put `sig_on()`/`sig_off()` in many more places, but I'm afraid people will worry about the performance impact (there is a very small but still measurable slow-down with `sig_on()`).\n\nIndeed, it seems that at least in the first run we explicitly do not use `sig_on()`:\n\n```python\ncdef ModuleElement _mul_long(self, long n):\n    \"\"\"\n    Fast path for multiplying a C long.\n    ...\n    \"\"\"\n    cdef Integer x = <Integer>PY_NEW(Integer)\n    if mpz_size(self.value) > 100000:\n        sig_on()\n        mpz_mul_si(x.value, self.value, n)\n        sig_off()\n    else:\n        mpz_mul_si(x.value, self.value, n)\n    return x\n```\n\nIn the second one, `fast_tp_new()` does not check the result of an allocation:\n\n```python\n\n    new = PyObject_MALLOC( sizeof_Integer )\n    ...\n    memcpy(new, (<void*>global_dummy_Integer), sizeof_Integer )\n```\nThe signal happens in `memcpy()`; I guess `PyObject_MALLOC()` returned `NULL`.\n\n(Both fragments are from `integer.pyx`.)",
    "created_at": "2014-11-28T06:58:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197065",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jdemeyer](#comment:16):
> We should indeed put `sig_on()`/`sig_off()` in many more places, but I'm afraid people will worry about the performance impact (there is a very small but still measurable slow-down with `sig_on()`).

Indeed, it seems that at least in the first run we explicitly do not use `sig_on()`:

```python
cdef ModuleElement _mul_long(self, long n):
    """
    Fast path for multiplying a C long.
    ...
    """
    cdef Integer x = <Integer>PY_NEW(Integer)
    if mpz_size(self.value) > 100000:
        sig_on()
        mpz_mul_si(x.value, self.value, n)
        sig_off()
    else:
        mpz_mul_si(x.value, self.value, n)
    return x
```

In the second one, `fast_tp_new()` does not check the result of an allocation:

```python

    new = PyObject_MALLOC( sizeof_Integer )
    ...
    memcpy(new, (<void*>global_dummy_Integer), sizeof_Integer )
```
The signal happens in `memcpy()`; I guess `PyObject_MALLOC()` returned `NULL`.

(Both fragments are from `integer.pyx`.)



---

archive/issue_comments_197066.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jdemeyer](#comment:17):\n> Proposal: introduce new Sage functions `sage_malloc_check()` which raises `MemoryError` when the allocation failed and use that to fix this issue.\n\nNow that you introduced `check_malloc()` in #10257 (merged in 6.6.beta1), could we use that function here?  In `fast_tp_new()`, we could presumably at least replace the `sage_malloc()` that allocates `new.value` by `check_malloc()`; what about the `PyObject_Malloc()` that allocates `new` itself?",
    "created_at": "2015-05-06T19:49:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197066",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jdemeyer](#comment:17):
> Proposal: introduce new Sage functions `sage_malloc_check()` which raises `MemoryError` when the allocation failed and use that to fix this issue.

Now that you introduced `check_malloc()` in #10257 (merged in 6.6.beta1), could we use that function here?  In `fast_tp_new()`, we could presumably at least replace the `sage_malloc()` that allocates `new.value` by `check_malloc()`; what about the `PyObject_Malloc()` that allocates `new` itself?



---

archive/issue_comments_197067.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/322ee2377078fc072e0a07f68305a3ff5adcd65c\"><code>322ee23</code></a></td><td><code>Error handling in tp_new function</code></td></tr></table>\n",
    "created_at": "2015-05-06T21:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197067",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/322ee2377078fc072e0a07f68305a3ff5adcd65c"><code>322ee23</code></a></td><td><code>Error handling in tp_new function</code></td></tr></table>




---

archive/issue_comments_197068.json:
```json
{
    "body": "Changed commit from **[`84ef4e5`](https://github.com/sagemath/sagetrac-mirror/commit/84ef4e5fc1bb75cc74ea9147e36efc243dc1a6ab)** to **[`322ee23`](https://github.com/sagemath/sagetrac-mirror/commit/322ee2377078fc072e0a07f68305a3ff5adcd65c)**",
    "created_at": "2015-05-06T21:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197068",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`84ef4e5`](https://github.com/sagemath/sagetrac-mirror/commit/84ef4e5fc1bb75cc74ea9147e36efc243dc1a6ab)** to **[`322ee23`](https://github.com/sagemath/sagetrac-mirror/commit/322ee2377078fc072e0a07f68305a3ff5adcd65c)**



---

archive/issue_events_224578.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-06T21:01:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224578"
}
```



---

archive/issue_events_224579.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-06T21:01:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224579"
}
```



---

archive/issue_comments_197069.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket/15671](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/15671)** to **[u/pbruin/15671-integer_memory_error](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-integer_memory_error)**",
    "created_at": "2015-05-06T21:53:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197069",
    "user": "https://github.com/pjbruin"
}
```

Changed branch from **[u/jdemeyer/ticket/15671](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/15671)** to **[u/pbruin/15671-integer_memory_error](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-integer_memory_error)**



---

archive/issue_events_224580.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2015-05-06T21:53:00Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "title_is": "Improve handling of memory errors in integer.pyx",
    "title_was": "sig_error() without sig_on()",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224580"
}
```



---

archive/issue_comments_197070.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThe new commit makes a few more changes (hopefully improvements) to memory error handling in `integer.pyx`.",
    "created_at": "2015-05-06T21:53:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197070",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:22" align="right">comment:22</div>

The new commit makes a few more changes (hopefully improvements) to memory error handling in `integer.pyx`.



---

archive/issue_comments_197071.json:
```json
{
    "body": "Changed commit from **[`322ee23`](https://github.com/sagemath/sagetrac-mirror/commit/322ee2377078fc072e0a07f68305a3ff5adcd65c)** to **[`b23509d`](https://github.com/sagemath/sagetrac-mirror/commit/b23509d7256cc3a8f2cbe13bc3956c6e3302aaec)**",
    "created_at": "2015-05-06T21:53:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197071",
    "user": "https://github.com/pjbruin"
}
```

Changed commit from **[`322ee23`](https://github.com/sagemath/sagetrac-mirror/commit/322ee2377078fc072e0a07f68305a3ff5adcd65c)** to **[`b23509d`](https://github.com/sagemath/sagetrac-mirror/commit/b23509d7256cc3a8f2cbe13bc3956c6e3302aaec)**



---

archive/issue_events_224581.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-08T08:07:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224581"
}
```



---

archive/issue_events_224582.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-08T08:07:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "milestone_number": null,
    "milestone_title": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224582"
}
```



---

archive/issue_comments_197072.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer, Peter Bruin**",
    "created_at": "2015-05-08T08:07:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197072",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer, Peter Bruin**



---

archive/issue_events_224583.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-08T08:07:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224583"
}
```



---

archive/issue_events_224584.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-08T08:07:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224584"
}
```



---

archive/issue_comments_197073.json:
```json
{
    "body": "Changed branch from **[u/pbruin/15671-integer_memory_error](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-integer_memory_error)** to **[`b23509d`](https://github.com/sagemath/sagetrac-mirror/commit/b23509d7256cc3a8f2cbe13bc3956c6e3302aaec)**",
    "created_at": "2015-05-08T13:10:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15671#issuecomment-197073",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/pbruin/15671-integer_memory_error](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15671-integer_memory_error)** to **[`b23509d`](https://github.com/sagemath/sagetrac-mirror/commit/b23509d7256cc3a8f2cbe13bc3956c6e3302aaec)**



---

archive/issue_events_224585.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-08T13:10:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224585"
}
```



---

archive/issue_events_224586.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "1ffac79dadd91c66da8b4f0050fa9573432eefe1",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-05-08T13:10:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15671",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15671#event-224586"
}
```
