# Issue 15045: ATLAS: multiple definition of `ATL_SetAtomicCount'

archive/issues_014808.json:
```json
{
    "assignees": [],
    "body": "This non-reproducible problem which can occur during the ATLAS build (with atlas-3.10.1.p3.spkg from #14754) was supposed to be fixed but it actually is not fixed:\n\n```\nmake[5]: Entering directory `/home/buildbot/build/sage/lena-1/lena_full/build/sage-5.12.beta1/spkg/build/atlas-3.10.1.p3/ATLAS-build/lib'\ngcc -fPIC -m64 -shared -o libsatlas.so  \\\n           -Wl,\"rpath-link /home/buildbot/build/sage/lena-1/lena_full/build/sage-5.12.beta1/local/lib\" \\\n           -Wl,--whole-archive liblapack.a libf77blas.a libcblas.a libatlas.a -Wl,--no-whole-archive -L/usr/local/gcc-4.7.0/x86_64-Linux-k10-fc/lib/gcc/x86_64-unknown-linux-gnu/4.7.0/../../../../lib64 -lgfortran  -lc -lpthread -lm -lgcc\n/usr/local/binutils-2.22/x86_64-Linux-k10-fc-gcc-4.6.2-rh/bin/ld: cannot find rpath-link /home/buildbot/build/sage/lena-1/lena_full/build/sage-5.12.beta1/local/lib: No such file or directory\nlibatlas.a(ATL_SetAtomicCount_mut.o): In function `ATL_SetAtomicCount':\nATL_SetAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_SetAtomicCount'\nlibatlas.a(ATL_SetAtomicCount_arch.o):ATL_SetAtomicCount_arch.c:(.text+0x0): first defined here\nlibatlas.a(ATL_ResetAtomicCount_mut.o): In function `ATL_ResetAtomicCount':\nATL_ResetAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_ResetAtomicCount'\nlibatlas.a(ATL_ResetAtomicCount_amd64.o):(.text+0x0): first defined here\nlibatlas.a(ATL_DecAtomicCount_mut.o): In function `ATL_DecAtomicCount':\nATL_DecAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_DecAtomicCount'\nlibatlas.a(ATL_DecAtomicCount_amd64.o):(.text+0x0): first defined here\nlibatlas.a(ATL_FreeAtomicCount_mut.o): In function `ATL_FreeAtomicCount':\nATL_FreeAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_FreeAtomicCount'\nlibatlas.a(ATL_FreeAtomicCount_arch.o):ATL_FreeAtomicCount_arch.c:(.text+0x0): first defined here\ncollect2: error: ld returned 1 exit status\nmake[5]: *** [GCCTRY] Error 1\n```\n\n[full ATLAS build log](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/174/steps/shell_5/logs/atlas)\n\nUpstream: [http://sourceforge.net/p/math-atlas/support-requests/907/](http://sourceforge.net/p/math-atlas/support-requests/907/)\n\nNew spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p5.spkg\n\nUpstream: **Reported upstream. No feedback yet.**\n\nCC:  @jpflori\n\nComponent: **packages: standard**\n\nAuthor: **Volker Braun**\n\nReviewer: **Nils Bruin**\n\nMerged: **sage-5.12.beta5**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15045_\n\n",
    "closed_at": "2013-09-04T08:07:03Z",
    "created_at": "2013-08-14T16:17:09Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.12",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "ATLAS: multiple definition of `ATL_SetAtomicCount'",
    "type": "issue",
    "updated_at": "2013-09-04T08:07:03Z",
    "url": "https://github.com/sagemath/sage/issues/15045",
    "user": "https://github.com/jdemeyer"
}
```
This non-reproducible problem which can occur during the ATLAS build (with atlas-3.10.1.p3.spkg from #14754) was supposed to be fixed but it actually is not fixed:

```
make[5]: Entering directory `/home/buildbot/build/sage/lena-1/lena_full/build/sage-5.12.beta1/spkg/build/atlas-3.10.1.p3/ATLAS-build/lib'
gcc -fPIC -m64 -shared -o libsatlas.so  \
           -Wl,"rpath-link /home/buildbot/build/sage/lena-1/lena_full/build/sage-5.12.beta1/local/lib" \
           -Wl,--whole-archive liblapack.a libf77blas.a libcblas.a libatlas.a -Wl,--no-whole-archive -L/usr/local/gcc-4.7.0/x86_64-Linux-k10-fc/lib/gcc/x86_64-unknown-linux-gnu/4.7.0/../../../../lib64 -lgfortran  -lc -lpthread -lm -lgcc
/usr/local/binutils-2.22/x86_64-Linux-k10-fc-gcc-4.6.2-rh/bin/ld: cannot find rpath-link /home/buildbot/build/sage/lena-1/lena_full/build/sage-5.12.beta1/local/lib: No such file or directory
libatlas.a(ATL_SetAtomicCount_mut.o): In function `ATL_SetAtomicCount':
ATL_SetAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_SetAtomicCount'
libatlas.a(ATL_SetAtomicCount_arch.o):ATL_SetAtomicCount_arch.c:(.text+0x0): first defined here
libatlas.a(ATL_ResetAtomicCount_mut.o): In function `ATL_ResetAtomicCount':
ATL_ResetAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_ResetAtomicCount'
libatlas.a(ATL_ResetAtomicCount_amd64.o):(.text+0x0): first defined here
libatlas.a(ATL_DecAtomicCount_mut.o): In function `ATL_DecAtomicCount':
ATL_DecAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_DecAtomicCount'
libatlas.a(ATL_DecAtomicCount_amd64.o):(.text+0x0): first defined here
libatlas.a(ATL_FreeAtomicCount_mut.o): In function `ATL_FreeAtomicCount':
ATL_FreeAtomicCount_mut.c:(.text+0x0): multiple definition of `ATL_FreeAtomicCount'
libatlas.a(ATL_FreeAtomicCount_arch.o):ATL_FreeAtomicCount_arch.c:(.text+0x0): first defined here
collect2: error: ld returned 1 exit status
make[5]: *** [GCCTRY] Error 1
```

[full ATLAS build log](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/174/steps/shell_5/logs/atlas)

Upstream: [http://sourceforge.net/p/math-atlas/support-requests/907/](http://sourceforge.net/p/math-atlas/support-requests/907/)

New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p5.spkg

Upstream: **Reported upstream. No feedback yet.**

CC:  @jpflori

Component: **packages: standard**

Author: **Volker Braun**

Reviewer: **Nils Bruin**

Merged: **sage-5.12.beta5**

_Issue created by migration from https://trac.sagemath.org/ticket/15045_





---

archive/issue_events_211607.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-14T16:17:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211607"
}
```



---

archive/issue_events_211608.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-14T16:17:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211608"
}
```



---

archive/issue_events_211609.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-14T16:17:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211609"
}
```



---

archive/issue_events_211610.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-14T16:17:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211610"
}
```



---

archive/issue_comments_184688.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI'm pretty sure this is http://sourceforge.net/p/math-atlas/support-requests/907/",
    "created_at": "2013-08-14T19:21:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184688",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:1" align="right">comment:1</div>

I'm pretty sure this is http://sourceforge.net/p/math-atlas/support-requests/907/



---

archive/issue_comments_184689.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,3 +23,5 @@\n ```\n \n [full ATLAS build log](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/174/steps/shell_5/logs/atlas)\n+\n+New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p4.spkg\n``````\n",
    "created_at": "2013-08-14T19:41:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184689",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,3 +23,5 @@
 ```
 
 [full ATLAS build log](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/174/steps/shell_5/logs/atlas)
+
+New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p4.spkg
``````




---

archive/issue_events_211611.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-08-14T19:41:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211611"
}
```



---

archive/issue_comments_184690.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIts probably not something that is reproducable on modern hardware, so progress upstream has been slow.\n\nFor now, I propose we just plow ahead and fall back to static libraries.",
    "created_at": "2013-08-14T19:41:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184690",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:2" align="right">comment:2</div>

Its probably not something that is reproducable on modern hardware, so progress upstream has been slow.

For now, I propose we just plow ahead and fall back to static libraries.



---

archive/issue_comments_184691.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2013-08-14T19:41:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184691",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_comments_184692.json:
```json
{
    "body": "Attachment: **[atlas-p3-p4.diff.gz](https://github.com/sagemath/sage/files/ticket15045/atlas-p3-p4.diff.gz)**\n\ndiff for review only",
    "created_at": "2013-08-14T19:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184692",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[atlas-p3-p4.diff.gz](https://github.com/sagemath/sage/files/ticket15045/atlas-p3-p4.diff.gz)**

diff for review only



---

archive/issue_comments_184693.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -24,4 +24,6 @@\n \n [full ATLAS build log](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/174/steps/shell_5/logs/atlas)\n \n+Upstream: [http://sourceforge.net/p/math-atlas/support-requests/907/](http://sourceforge.net/p/math-atlas/support-requests/907/)\n+\n New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p4.spkg\n``````\n",
    "created_at": "2013-08-15T08:02:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184693",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -24,4 +24,6 @@
 
 [full ATLAS build log](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/174/steps/shell_5/logs/atlas)
 
+Upstream: [http://sourceforge.net/p/math-atlas/support-requests/907/](http://sourceforge.net/p/math-atlas/support-requests/907/)
+
 New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p4.spkg
``````




---

archive/issue_comments_184694.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2013-08-15T08:02:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184694",
    "user": "https://github.com/jdemeyer"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_184695.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@vbraun](#comment%3A2):\n> Its probably not something that is reproducable on modern hardware\n\n2009 might not meet your definition of \"modern\", but it's far from ancient either.",
    "created_at": "2013-08-15T08:05:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184695",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@vbraun](#comment%3A2):
> Its probably not something that is reproducable on modern hardware

2009 might not meet your definition of "modern", but it's far from ancient either.



---

archive/issue_comments_184696.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@vbraun](#comment%3A2):\n> For now, I propose we just plow ahead and fall back to static libraries. \n\nIf static libraries always work, why don't we always only use static libraries?\n\nConversely, if static libraries don't always work, wouldn't this \"fall back\" cause other problems?",
    "created_at": "2013-08-19T12:36:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184696",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@vbraun](#comment%3A2):
> For now, I propose we just plow ahead and fall back to static libraries. 

If static libraries always work, why don't we always only use static libraries?

Conversely, if static libraries don't always work, wouldn't this "fall back" cause other problems?



---

archive/issue_comments_184697.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nBecause static libraries suck.\n\nIt won't cause other problems for now. If we want to use the upstream shared libraries (with a different naming convention than the static libraries) then we'll run into troubles. But by then we hopefully have found a way to not hardcode atlas/blas/lapack library names in the Sage build system.",
    "created_at": "2013-08-19T13:17:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184697",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

Because static libraries suck.

It won't cause other problems for now. If we want to use the upstream shared libraries (with a different naming convention than the static libraries) then we'll run into troubles. But by then we hopefully have found a way to not hardcode atlas/blas/lapack library names in the Sage build system.



---

archive/issue_comments_184698.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIt still feels bad to build the shared libraries \"sometimes\" depending on some non-deterministic condition. If static libraries work (even if they don't work so well), I think it's better to stick with them in all cases.",
    "created_at": "2013-08-19T21:52:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184698",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

It still feels bad to build the shared libraries "sometimes" depending on some non-deterministic condition. If static libraries work (even if they don't work so well), I think it's better to stick with them in all cases.



---

archive/issue_comments_184699.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI would agree with you if we would want to stick with a hard-coded ATLAS in Sage until the end of time. But IMHO we should work towards a more configurable solution that will just fall back to reference / openblas as appropriate if atlas doesn't build. And perhaps not build atlas by default if it takes too long. And then static libraries would be a huge pain in the butt.",
    "created_at": "2013-08-20T09:54:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184699",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">comment:8</div>

I would agree with you if we would want to stick with a hard-coded ATLAS in Sage until the end of time. But IMHO we should work towards a more configurable solution that will just fall back to reference / openblas as appropriate if atlas doesn't build. And perhaps not build atlas by default if it takes too long. And then static libraries would be a huge pain in the butt.



---

archive/issue_comments_184700.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@vbraun](#comment%3A8):\n> But IMHO we should work towards a more configurable solution that will just fall back to reference / openblas as appropriate if atlas doesn't build. And perhaps not build atlas by default if it takes too long. And then static libraries would be a huge pain in the butt.\n\nIf you want to work towards that goal, then the problem on this ticket must be fixed in a proper way anyway. I don't see how using shared libraries \"sometimes\" is closer to the stated goal than \"never\" using shared libraries.\n\nI am particularly bothered that the choice is non-deterministic and difficult to predict, so Sage builds on the same machine will be substantially different (one with shared ATLAS and one with static ATLAS).",
    "created_at": "2013-08-20T10:05:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184700",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@vbraun](#comment%3A8):
> But IMHO we should work towards a more configurable solution that will just fall back to reference / openblas as appropriate if atlas doesn't build. And perhaps not build atlas by default if it takes too long. And then static libraries would be a huge pain in the butt.

If you want to work towards that goal, then the problem on this ticket must be fixed in a proper way anyway. I don't see how using shared libraries "sometimes" is closer to the stated goal than "never" using shared libraries.

I am particularly bothered that the choice is non-deterministic and difficult to predict, so Sage builds on the same machine will be substantially different (one with shared ATLAS and one with static ATLAS).



---

archive/issue_comments_184701.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nOnce we have an alternative to ATLAS that we can use, we disable the static library fallback for ATLAS. Its easy. Until then, we have this crutch. I agree that its ugly as sin but not shipping the new ATLAS would be a mistake imho.\n\nI just don't want to work on changing the blas build system in Sage until we have switched to git. It'll be much easier if I don't have to copy tarballs around just for a change to the build script.",
    "created_at": "2013-08-20T10:26:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184701",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:10" align="right">comment:10</div>

Once we have an alternative to ATLAS that we can use, we disable the static library fallback for ATLAS. Its easy. Until then, we have this crutch. I agree that its ugly as sin but not shipping the new ATLAS would be a mistake imho.

I just don't want to work on changing the blas build system in Sage until we have switched to git. It'll be much easier if I don't have to copy tarballs around just for a change to the build script.



---

archive/issue_comments_184702.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@vbraun](#comment%3A10):\n> Once we have an alternative to ATLAS that we can use, we disable the static library fallback for ATLAS. Its easy. Until then, we have this crutch. I agree that its ugly as sin but not shipping the new ATLAS would be a mistake imho.\n\nI am not saying that we shouldn't ship the new ATLAS. I am proposing to *always* use the static ATLAS libraries always instead of only when the linker problem appears.",
    "created_at": "2013-08-20T10:37:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184702",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@vbraun](#comment%3A10):
> Once we have an alternative to ATLAS that we can use, we disable the static library fallback for ATLAS. Its easy. Until then, we have this crutch. I agree that its ugly as sin but not shipping the new ATLAS would be a mistake imho.

I am not saying that we shouldn't ship the new ATLAS. I am proposing to *always* use the static ATLAS libraries always instead of only when the linker problem appears.



---

archive/issue_comments_184703.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jdemeyer](#comment%3A11):\n> I am not saying that we shouldn't ship the new ATLAS. I am proposing to *always* use the static ATLAS libraries always instead of only when the linker problem appears.\n\nI think that just means more changes to undo later. And mind you the shared libraries build apparently fine on most systems, its just some AMD platforms where presumably the performance impact of holding mutexes is different.",
    "created_at": "2013-08-20T10:50:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184703",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jdemeyer](#comment%3A11):
> I am not saying that we shouldn't ship the new ATLAS. I am proposing to *always* use the static ATLAS libraries always instead of only when the linker problem appears.

I think that just means more changes to undo later. And mind you the shared libraries build apparently fine on most systems, its just some AMD platforms where presumably the performance impact of holding mutexes is different.



---

archive/issue_comments_184704.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@vbraun](#comment%3A12):\n> I think that just means more changes to undo later.\n\nReally? If you comment out the current approach, then it's essentially just removing `#` characters. That together with hg or git should work easily.",
    "created_at": "2013-08-20T12:25:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184704",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@vbraun](#comment%3A12):
> I think that just means more changes to undo later.

Really? If you comment out the current approach, then it's essentially just removing `#` characters. That together with hg or git should work easily.



---

archive/issue_comments_184705.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@vbraun](#comment%3A12):\n> And mind you the shared libraries build apparently fine on most systems, its just some AMD platforms where presumably the performance impact of holding mutexes is different.\n\nSo far, Sage has worked equally well for all CPUs of a given architecture, let's keep it that way.",
    "created_at": "2013-08-20T12:27:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184705",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@vbraun](#comment%3A12):
> And mind you the shared libraries build apparently fine on most systems, its just some AMD platforms where presumably the performance impact of holding mutexes is different.

So far, Sage has worked equally well for all CPUs of a given architecture, let's keep it that way.



---

archive/issue_comments_184706.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAs long as the library names are the same (which is currently the case) it does not make a difference for the build system if the library is shared or static. Deliberately disabling shared libraries would just mean to make it suck for everybody, and not just for the small percentage where its the only option. In other words, I'm against it ;-)",
    "created_at": "2013-08-20T13:20:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184706",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:15" align="right">comment:15</div>

As long as the library names are the same (which is currently the case) it does not make a difference for the build system if the library is shared or static. Deliberately disabling shared libraries would just mean to make it suck for everybody, and not just for the small percentage where its the only option. In other words, I'm against it ;-)



---

archive/issue_comments_184707.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@vbraun](#comment%3A15):\n> In other words, I'm against it ;-)\n\nAnd I'm against more special cases (especially non-deterministic) in the Sage build system ;-)",
    "created_at": "2013-08-20T14:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184707",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@vbraun](#comment%3A15):
> In other words, I'm against it ;-)

And I'm against more special cases (especially non-deterministic) in the Sage build system ;-)



---

archive/issue_comments_184708.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nNoted, but the ATLAS spkg has always been trying different ways to build and falling back if they fail. Which always sucked, but the problem is that we don't have a deterministic alternative to deploy.",
    "created_at": "2013-08-20T15:08:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184708",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:17" align="right">comment:17</div>

Noted, but the ATLAS spkg has always been trying different ways to build and falling back if they fail. Which always sucked, but the problem is that we don't have a deterministic alternative to deploy.



---

archive/issue_events_211612.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-22T11:31:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211612"
}
```



---

archive/issue_events_211613.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-22T11:31:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211613"
}
```



---

archive/issue_comments_184709.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@vbraun](#comment%3A17):\n> Noted, but the ATLAS spkg has always been trying different ways to build and falling back if they fail.\n\nThose \"different ways\" only were about tuning parameters and CPU instruction sets, right? Which is far less fundamental than static vs. dynamic libraries.\n\nImagine we go with your solution and in the future somebody decides to change the Sage build system or some package such that it only works for a dynamic ATLAS library. Initial testing might reveal that everything works, even though it doesn't work in case your ATLAS spkg decides to use static libraries. This is what I want to avoid.",
    "created_at": "2013-08-22T11:31:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184709",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@vbraun](#comment%3A17):
> Noted, but the ATLAS spkg has always been trying different ways to build and falling back if they fail.

Those "different ways" only were about tuning parameters and CPU instruction sets, right? Which is far less fundamental than static vs. dynamic libraries.

Imagine we go with your solution and in the future somebody decides to change the Sage build system or some package such that it only works for a dynamic ATLAS library. Initial testing might reveal that everything works, even though it doesn't work in case your ATLAS spkg decides to use static libraries. This is what I want to avoid.



---

archive/issue_comments_184710.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI disagree. Pretty much the only way to achieve your scenario would be to hardcode the shared library file name somewhere. But those already differ on Linux vs. OSX.\n\nWhat I'm mainly objecting to is the basic premise that we should keep this monstrosity alive for any longer than necessary. Things have to be fixed either in ATLAS or by fixing the Sage BLAS build system. As soon as that is done, we can switch off the static library fallback again.",
    "created_at": "2013-08-22T12:30:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184710",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

I disagree. Pretty much the only way to achieve your scenario would be to hardcode the shared library file name somewhere. But those already differ on Linux vs. OSX.

What I'm mainly objecting to is the basic premise that we should keep this monstrosity alive for any longer than necessary. Things have to be fixed either in ATLAS or by fixing the Sage BLAS build system. As soon as that is done, we can switch off the static library fallback again.



---

archive/issue_comments_184711.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@vbraun](#comment%3A19):\n> Pretty much the only way to achieve your scenario would be to hardcode the shared library file name somewhere.\n\nIf there is no observable difference between shared and static libraries, then why do you care so much about shared libraries?\n\n> What I'm mainly objecting to is the basic premise that we should keep this monstrosity alive for any longer than necessary.\n\nThe problem is that it needs to be kept alive in any case precisely because of this ticket.",
    "created_at": "2013-08-22T15:55:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184711",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@vbraun](#comment%3A19):
> Pretty much the only way to achieve your scenario would be to hardcode the shared library file name somewhere.

If there is no observable difference between shared and static libraries, then why do you care so much about shared libraries?

> What I'm mainly objecting to is the basic premise that we should keep this monstrosity alive for any longer than necessary.

The problem is that it needs to be kept alive in any case precisely because of this ticket.



---

archive/issue_comments_184712.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThere is no difference at the linker command line. There is of course a price to be paid later in that you can never benefit from blas/atlas upgrades if you have linked statically.\n\nThis ticket is just a workaround until we have a better fix. Unless you think we don't need a workaround for now, in which case I'm happy to wait for either upstream to fix it or we have switched to git...",
    "created_at": "2013-08-22T17:08:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184712",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:21" align="right">comment:21</div>

There is no difference at the linker command line. There is of course a price to be paid later in that you can never benefit from blas/atlas upgrades if you have linked statically.

This ticket is just a workaround until we have a better fix. Unless you think we don't need a workaround for now, in which case I'm happy to wait for either upstream to fix it or we have switched to git...



---

archive/issue_comments_184713.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI asked `sage-devel` about what to do, since we're clearly not going to agree...",
    "created_at": "2013-08-24T12:36:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184713",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

I asked `sage-devel` about what to do, since we're clearly not going to agree...



---

archive/issue_comments_184714.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nFor [atlas issue 907](http://sourceforge.net/p/math-atlas/support-requests/907/), the relevant code would be:\n\n`ATLAS/tune/threads/tune_count.c:242`\n\n```\n      if (tmut < tldec*1.02)\n      {\n         printf(\"\\nNO REAL ADVANTAGE TO ASSEMBLY, FORCING USE OF MUTEX\\n\");\n         ATL_assert(!system(\"make iForceUseMutex\"));\n      }\n```\n\nLooking at \n`ATLAS/makes/Make.ttune:159`\n\n```\niFind_atomic_arch :\n        if $(MAKE) xprobe_atomic_amd64 ; then \\\n           cp $(myTHRdir)/ATL_*AtomicCount_arch.c . ; \\\n           cp $(myTHRdir)/ATL_ResetAtomicCount_amd64.S \\\n              ATL_ResetAtomicCount_arch.S ; \\\n           cp $(myTHRdir)/ATL_DecAtomicCount_amd64.S \\\n              ATL_DecAtomicCount_arch.S ; \\\n           rm $(BLDdir)/src/threads/atomic.inc ; \\\n           echo \"aobj = ATL_SetAtomicCount_arch.o ATL_ResetAtomicCount_amd64.o ATL_DecAtomicCount_amd64.o ATL_FreeAtomicCount_arch.o\" > $(BLDdir)/src/threads/atomic.inc ;\n           .... lines elided ....\n        fi\n        - rm -f $(BLDdir)/src/threads/lib.grd\n        $(MAKE) tlib\n\n```\n`ATLAS/makes/Make.ttune:205`\n\n```\niForceUseMutex:\n        rm $(BLDdir)/src/threads/atomic.inc\n        echo \"aobj = ATL_SetAtomicCount_mut.o ATL_ResetAtomicCount_mut.o ATL_DecAtomicCount_mut.o ATL_FreeAtomicCount_mut.o\" > $(BLDdir)/src/threads/atomic.inc\n```\n\nThe file `atomic.inc` is only touched in `Make.ttune`, always in the style above. The file is only used in `ATLAS/makes/Make.thr`, where it is included to get `aobj` defined, which is then included in `obj` to build a library.\n\nI suspect the problem is that `make iForceUseMutex` doesn't actually rebuild the library, which does happen in `make iFind_atomic_arch`. So, when we do\n\n```\niTune_atomic :\n        if $(MAKE) mutcnt ; then \\\n           if $(MAKE) iFind_atomic_arch ; then \\\n              $(MAKE) xtune_count ; ./xtune_count -r 1000000 -o yes; \\\n           fi ; \\\n        else \\\n           $(MAKE) iFind_atomic_arch ; \\\n        fi\n```\nhich presumably runs the code in `tune_count.c`, we end up with a built library that has the architecture-specific bits in it, but an `aobj` that reflects otherwise. Probably, the make system runs into these things another time and then tries to include the same definitions another time in the library.\n\nPerhaps just patch the system?\n\n```diff\nATLAS/tune/threads/tune_count.c:244\n-         printf(\"\\nNO REAL ADVANTAGE TO ASSEMBLY, FORCING USE OF MUTEX\\n\");\n-         ATL_assert(!system(\"make iForceUseMutex\"));\n+         printf(\"\\nNO REAL ADVANTAGE TO ASSEMBLY, BUT WE LEAVE IT IN ANYWAY\\n\");\n```\nI think there is some hope that this will eliminate the (rare) build fails.",
    "created_at": "2013-08-24T20:45:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184714",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:23" align="right">comment:23</div>

For [atlas issue 907](http://sourceforge.net/p/math-atlas/support-requests/907/), the relevant code would be:

`ATLAS/tune/threads/tune_count.c:242`

```
      if (tmut < tldec*1.02)
      {
         printf("\nNO REAL ADVANTAGE TO ASSEMBLY, FORCING USE OF MUTEX\n");
         ATL_assert(!system("make iForceUseMutex"));
      }
```

Looking at 
`ATLAS/makes/Make.ttune:159`

```
iFind_atomic_arch :
        if $(MAKE) xprobe_atomic_amd64 ; then \
           cp $(myTHRdir)/ATL_*AtomicCount_arch.c . ; \
           cp $(myTHRdir)/ATL_ResetAtomicCount_amd64.S \
              ATL_ResetAtomicCount_arch.S ; \
           cp $(myTHRdir)/ATL_DecAtomicCount_amd64.S \
              ATL_DecAtomicCount_arch.S ; \
           rm $(BLDdir)/src/threads/atomic.inc ; \
           echo "aobj = ATL_SetAtomicCount_arch.o ATL_ResetAtomicCount_amd64.o ATL_DecAtomicCount_amd64.o ATL_FreeAtomicCount_arch.o" > $(BLDdir)/src/threads/atomic.inc ;
           .... lines elided ....
        fi
        - rm -f $(BLDdir)/src/threads/lib.grd
        $(MAKE) tlib

```
`ATLAS/makes/Make.ttune:205`

```
iForceUseMutex:
        rm $(BLDdir)/src/threads/atomic.inc
        echo "aobj = ATL_SetAtomicCount_mut.o ATL_ResetAtomicCount_mut.o ATL_DecAtomicCount_mut.o ATL_FreeAtomicCount_mut.o" > $(BLDdir)/src/threads/atomic.inc
```

The file `atomic.inc` is only touched in `Make.ttune`, always in the style above. The file is only used in `ATLAS/makes/Make.thr`, where it is included to get `aobj` defined, which is then included in `obj` to build a library.

I suspect the problem is that `make iForceUseMutex` doesn't actually rebuild the library, which does happen in `make iFind_atomic_arch`. So, when we do

```
iTune_atomic :
        if $(MAKE) mutcnt ; then \
           if $(MAKE) iFind_atomic_arch ; then \
              $(MAKE) xtune_count ; ./xtune_count -r 1000000 -o yes; \
           fi ; \
        else \
           $(MAKE) iFind_atomic_arch ; \
        fi
```
hich presumably runs the code in `tune_count.c`, we end up with a built library that has the architecture-specific bits in it, but an `aobj` that reflects otherwise. Probably, the make system runs into these things another time and then tries to include the same definitions another time in the library.

Perhaps just patch the system?

```diff
ATLAS/tune/threads/tune_count.c:244
-         printf("\nNO REAL ADVANTAGE TO ASSEMBLY, FORCING USE OF MUTEX\n");
-         ATL_assert(!system("make iForceUseMutex"));
+         printf("\nNO REAL ADVANTAGE TO ASSEMBLY, BUT WE LEAVE IT IN ANYWAY\n");
```
I think there is some hope that this will eliminate the (rare) build fails.



---

archive/issue_comments_184715.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI definitely cannot work on that at the moment but this is reallyt reminiscent of [#10508 comment:455](https://github.com/sagemath/sage/issues/10508#comment:455)\n\n\nOk, I just read the ticket description, and our zorkaround was working because of our custo\u00f1 way of building shared libraries.\n\nNow that we also build the upstream shared libraries, our workaround is not enough anymore....",
    "created_at": "2013-08-25T03:11:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184715",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:24" align="right">comment:24</div>

I definitely cannot work on that at the moment but this is reallyt reminiscent of [#10508 comment:455](https://github.com/sagemath/sage/issues/10508#comment:455)


Ok, I just read the ticket description, and our zorkaround was working because of our custoñ way of building shared libraries.

Now that we also build the upstream shared libraries, our workaround is not enough anymore....



---

archive/issue_comments_184716.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nFrom what I remember the main problem is that ATLAS builds a (static) lib for tuning, and then just update it to get the final (static) library so it ends up including two objects files with the same symbols (because of the ato\u00f1ic.inc \u00f1agic which does notinclude the same pieces of code in tyhe tuning and in the final phases, and because old object files of the tuning phase are still lurking around when the final phase is going on).\n\nIt presumably does so because updating the static archive is faster than rebuilding everything from scratch.\n\nSo another solution would be to erase the static lib built for tuning (and the corresponding object files) when the tuning phase is finished and let everything be built again when the real building phase starts.",
    "created_at": "2013-08-25T03:15:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184716",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:25" align="right">comment:25</div>

From what I remember the main problem is that ATLAS builds a (static) lib for tuning, and then just update it to get the final (static) library so it ends up including two objects files with the same symbols (because of the atoñic.inc ñagic which does notinclude the same pieces of code in tyhe tuning and in the final phases, and because old object files of the tuning phase are still lurking around when the final phase is going on).

It presumably does so because updating the static archive is faster than rebuilding everything from scratch.

So another solution would be to erase the static lib built for tuning (and the corresponding object files) when the tuning phase is finished and let everything be built again when the real building phase starts.



---

archive/issue_comments_184717.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nSee [#10508 comment:446](https://github.com/sagemath/sage/issues/10508#comment:446) which might be clearer than the above :)",
    "created_at": "2013-08-25T03:17:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184717",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:26" align="right">comment:26</div>

See [#10508 comment:446](https://github.com/sagemath/sage/issues/10508#comment:446) which might be clearer than the above :)



---

archive/issue_comments_184718.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@nbruin](#comment%3A23):\n> `ATLAS/tune/threads/tune_count.c:242`\n> \n> ```\n>       if (tmut < tldec*1.02)\n>       {\n>          printf(\"\\nNO REAL ADVANTAGE TO ASSEMBLY, FORCING USE OF MUTEX\\n\");\n>          ATL_assert(!system(\"make iForceUseMutex\"));\n>       }\n> ```\n\nSo would it be a plan to\n- check that this check is the culprit of (at least some) failure by patching it to be `tmut < tldec*1000` and verifying that on relevant hardware ALTAS now reliably fails to build\n- patch atlas to NOT run `make iForceUseMutex` at this point and ship with that. Perhaps patch it as:\n\n```\nprintf(\"\\nASSEMBLY/MUTEX ratio is %d, but we'll stick with assembly anyway\\n\",tldec/tmut);\n```\nso that our logfiles at least tells us what the performance penalty is (well, there's none because ATLAS doesn't build dynamic libs without).",
    "created_at": "2013-08-26T04:50:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184718",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@nbruin](#comment%3A23):
> `ATLAS/tune/threads/tune_count.c:242`
> 
> ```
>       if (tmut < tldec*1.02)
>       {
>          printf("\nNO REAL ADVANTAGE TO ASSEMBLY, FORCING USE OF MUTEX\n");
>          ATL_assert(!system("make iForceUseMutex"));
>       }
> ```

So would it be a plan to
- check that this check is the culprit of (at least some) failure by patching it to be `tmut < tldec*1000` and verifying that on relevant hardware ALTAS now reliably fails to build
- patch atlas to NOT run `make iForceUseMutex` at this point and ship with that. Perhaps patch it as:

```
printf("\nASSEMBLY/MUTEX ratio is %d, but we'll stick with assembly anyway\n",tldec/tmut);
```
so that our logfiles at least tells us what the performance penalty is (well, there's none because ATLAS doesn't build dynamic libs without).



---

archive/issue_comments_184719.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI've made the change to force `iForceUseMutex` and that indeed reproduces the bug reliably. I made the change that Nils suggested and always use the assembly version (never `iForceUseMutex`), this fixes it for me.",
    "created_at": "2013-08-30T20:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184719",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:28" align="right">comment:28</div>

I've made the change to force `iForceUseMutex` and that indeed reproduces the bug reliably. I made the change that Nils suggested and always use the assembly version (never `iForceUseMutex`), this fixes it for me.



---

archive/issue_comments_184720.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,4 +26,4 @@\n \n Upstream: [http://sourceforge.net/p/math-atlas/support-requests/907/](http://sourceforge.net/p/math-atlas/support-requests/907/)\n \n-New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p4.spkg\n+New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p5.spkg\n``````\n",
    "created_at": "2013-08-30T20:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184720",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,4 +26,4 @@
 
 Upstream: [http://sourceforge.net/p/math-atlas/support-requests/907/](http://sourceforge.net/p/math-atlas/support-requests/907/)
 
-New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p4.spkg
+New spkg: http://boxen.math.washington.edu/home/vbraun/spkg/atlas-3.10.1.p5.spkg
``````




---

archive/issue_events_211614.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-08-30T20:09:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211614"
}
```



---

archive/issue_events_211615.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-08-30T20:09:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211615"
}
```



---

archive/issue_comments_184721.json:
```json
{
    "body": "Attachment: **[atlas-p4-p5.diff.gz](https://github.com/sagemath/sage/files/ticket15045/atlas-p4-p5.diff.gz)**\n\ndiff for review only",
    "created_at": "2013-08-30T20:10:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184721",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[atlas-p4-p5.diff.gz](https://github.com/sagemath/sage/files/ticket15045/atlas-p4-p5.diff.gz)**

diff for review only



---

archive/issue_comments_184722.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nCongratulations on getting this fixed.\n\nJust for the record: I think the mutex code can still get built on platforms where no assembly alternative is available. In that case, I don't think we should particularly expect conflicting symbols either, because there are no other implementations available that the mutex code can conflict with in that case.\n\nThis is why I figured it was best to patch the code that takes action depending on the tuning result and not the target in the makefile.\n\nThe comment in the SPKG.txt doesn't strictly contradict this, but I had to read the comment a second time to convince myself of that.",
    "created_at": "2013-08-30T21:12:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184722",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:29" align="right">comment:29</div>

Congratulations on getting this fixed.

Just for the record: I think the mutex code can still get built on platforms where no assembly alternative is available. In that case, I don't think we should particularly expect conflicting symbols either, because there are no other implementations available that the mutex code can conflict with in that case.

This is why I figured it was best to patch the code that takes action depending on the tuning result and not the target in the makefile.

The comment in the SPKG.txt doesn't strictly contradict this, but I had to read the comment a second time to convince myself of that.



---

archive/issue_comments_184723.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nNils: do you want to formally review this ticket?",
    "created_at": "2013-09-02T12:09:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184723",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Nils: do you want to formally review this ticket?



---

archive/issue_comments_184724.json:
```json
{
    "body": "Reviewer: **Nils Bruin**",
    "created_at": "2013-09-02T16:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184724",
    "user": "https://github.com/nbruin"
}
```

Reviewer: **Nils Bruin**



---

archive/issue_comments_184725.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI have no idea what p4 is about but the change from p4 to p5 as posted on this ticket looks pretty reasonable. I haven't built or downloaded this new package, but other people have and it's a blocker, so a positive review helps things along.",
    "created_at": "2013-09-02T16:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184725",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:31" align="right">comment:31</div>

I have no idea what p4 is about but the change from p4 to p5 as posted on this ticket looks pretty reasonable. I haven't built or downloaded this new package, but other people have and it's a blocker, so a positive review helps things along.



---

archive/issue_events_211616.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-09-02T16:57:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211616"
}
```



---

archive/issue_events_211617.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-09-02T16:57:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211617"
}
```



---

archive/issue_events_211618.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-09-04T08:07:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211618"
}
```



---

archive/issue_events_211619.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-09-04T08:07:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15045#event-211619"
}
```



---

archive/issue_comments_184726.json:
```json
{
    "body": "Merged: **sage-5.12.beta5**",
    "created_at": "2013-09-04T08:07:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15045#issuecomment-184726",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.12.beta5**
