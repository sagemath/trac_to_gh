# Issue 15305: Allow natural morphism between tensor products

archive/issues_015068.json:
```json
{
    "assignees": [],
    "body": "Given modules `A1, A2, B1, B2` with coercions `A1 -> B1` and `A2 -> B2`, there is the natural coercion `A1 # A2 -> B1 # B2` as the tensor of the factor coercions. This ticket implements the above coercion as a natural coercion for `CombinatorialFreeModule_Tensor`.\n\nApply: [attachment: trac_15305-coercion_tensor_products-ts.patch.gz](https://github.com/sagemath/sage/files/ticket15305/trac_15305-coercion_tensor_products-ts.patch.gz)\n\nDepends on #15309\n\nAssignee: **sage-combinat**\n\nCC:  sage-combinat @nthiery @simon-king-jena nborie\n\nKeywords: **tensor product coercion, days54**\n\nReviewer: **Nicolas Borie, Travis Scrimshaw**\n\nAuthor: **Travis Scrimshaw, Nicolas Borie**\n\nMerged: **sage-5.13.beta3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15305_\n\n",
    "closed_at": "2013-11-09T15:30:25Z",
    "created_at": "2013-10-18T22:43:59Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20coercion",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.13",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Allow natural morphism between tensor products",
    "type": "issue",
    "updated_at": "2013-11-09T15:30:25Z",
    "url": "https://github.com/sagemath/sage/issues/15305",
    "user": "https://github.com/tscrim"
}
```
Given modules `A1, A2, B1, B2` with coercions `A1 -> B1` and `A2 -> B2`, there is the natural coercion `A1 # A2 -> B1 # B2` as the tensor of the factor coercions. This ticket implements the above coercion as a natural coercion for `CombinatorialFreeModule_Tensor`.

Apply: [attachment: trac_15305-coercion_tensor_products-ts.patch.gz](https://github.com/sagemath/sage/files/ticket15305/trac_15305-coercion_tensor_products-ts.patch.gz)

Depends on #15309

Assignee: **sage-combinat**

CC:  sage-combinat @nthiery @simon-king-jena nborie

Keywords: **tensor product coercion, days54**

Reviewer: **Nicolas Borie, Travis Scrimshaw**

Author: **Travis Scrimshaw, Nicolas Borie**

Merged: **sage-5.13.beta3**

_Issue created by migration from https://trac.sagemath.org/ticket/15305_





---

archive/issue_events_193125.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-10-18T22:43:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "milestone_number": null,
    "milestone_title": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193125"
}
```



---

archive/issue_events_193126.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-10-18T22:43:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20coercion",
    "label_color": "0000ff",
    "label_name": "component: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193126"
}
```



---

archive/issue_events_193127.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-10-18T22:43:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193127"
}
```



---

archive/issue_events_193128.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-10-18T22:43:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193128"
}
```



---

archive/issue_events_193129.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-10-18T22:46:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193129"
}
```



---

archive/issue_comments_191918.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nThanks Travis, that was a long awaited feature.\n\nFor the test, rather than isinstance(x, CombinatorialFreeModules_Tensor), it would be prefera ble to use x in ModulesWithBasis(...).TensorProducts().\n\nNicolas B.: you had code to do exactly that, and implementing at that occasion tensor product of morphisms; could you review this patch, and merge with your code?\n\nThanks!\n                                                  Nicolas",
    "created_at": "2013-10-19T09:41:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191918",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:2'>Comment 2:</a>
Thanks Travis, that was a long awaited feature.

For the test, rather than isinstance(x, CombinatorialFreeModules_Tensor), it would be prefera ble to use x in ModulesWithBasis(...).TensorProducts().

Nicolas B.: you had code to do exactly that, and implementing at that occasion tensor product of morphisms; could you review this patch, and merge with your code?

Thanks!
                                                  Nicolas



---

archive/issue_comments_191919.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nI've commuted this patch past #15309 and made the change Nicolas T. suggested.",
    "created_at": "2013-10-25T14:48:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191919",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'>Comment 3:</a>
I've commuted this patch past #15309 and made the change Nicolas T. suggested.



---

archive/issue_comments_191920.json:
```json
{
    "body": "Dependencies: **#15309**",
    "created_at": "2013-10-25T14:48:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191920",
    "user": "https://github.com/tscrim"
}
```

Dependencies: **#15309**



---

archive/issue_comments_191921.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nDidn't factor out everything into #15289. Nicolas B. do you have your code on the combinat queue?\n\nBest,\n\nTravis",
    "created_at": "2013-11-02T05:34:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191921",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'>Comment 4:</a>
Didn't factor out everything into #15289. Nicolas B. do you have your code on the combinat queue?

Best,

Travis



---

archive/issue_comments_191922.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nHi,\n\nNo, the code that Nicolas was speaking about was a patch on my last (and died) laptop. I do not have it now but I wrote it (8 months ago) and I probably installed a copy on the Remi Maurice desktop at Marne. I will try to check that on this Monday.\n\nI am also compiling the last version of Sage... I will have a look on that shortly.\n\nCheers,\nNicolas B.",
    "created_at": "2013-11-02T10:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191922",
    "user": "https://github.com/sagetrac-nborie"
}
```

<a id='comment:5'>Comment 5:</a>
Hi,

No, the code that Nicolas was speaking about was a patch on my last (and died) laptop. I do not have it now but I wrote it (8 months ago) and I probably installed a copy on the Remi Maurice desktop at Marne. I will try to check that on this Monday.

I am also compiling the last version of Sage... I will have a look on that shortly.

Cheers,
Nicolas B.



---

archive/issue_comments_191923.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nOk, I have read your patch and it look close to I did times ago...\n\nIn fact, the good way to do this is :\n\n- Make tensor constructor accept a tuple of module morphisms such that if foo and bar are two morphisms between parents inheriting from combinatorialFreeModule :\ntensor( (foo, bar) ) return the module morphism from tensor( (foo.domain(), bar.domain()) ) to tensor( (foo.codomain(), bar.codomain()) ) (and doing what you think so hard)\n\n- Use this improved constructor to return the tensor of coercions\n\nEven I had this advise from Nicolas T., I did not implemented it this way. I choose an approach like you do. I try to remember why but I completely forget why I did not the nice way. The reason can be laziness from me or a technical issue. I completely forget...\n\nI'll try to test your patch on my stack of combinatorial Hopf algebras this week end...\n\nCheers, Nicolas B.",
    "created_at": "2013-11-02T11:50:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191923",
    "user": "https://github.com/sagetrac-nborie"
}
```

<a id='comment:6'>Comment 6:</a>
Ok, I have read your patch and it look close to I did times ago...

In fact, the good way to do this is :

- Make tensor constructor accept a tuple of module morphisms such that if foo and bar are two morphisms between parents inheriting from combinatorialFreeModule :
tensor( (foo, bar) ) return the module morphism from tensor( (foo.domain(), bar.domain()) ) to tensor( (foo.codomain(), bar.codomain()) ) (and doing what you think so hard)

- Use this improved constructor to return the tensor of coercions

Even I had this advise from Nicolas T., I did not implemented it this way. I choose an approach like you do. I try to remember why but I completely forget why I did not the nice way. The reason can be laziness from me or a technical issue. I completely forget...

I'll try to test your patch on my stack of combinatorial Hopf algebras this week end...

Cheers, Nicolas B.



---

archive/issue_comments_191924.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nI accidentally uploaded an old version of the patch. Here's the correct one.\n\nI'll wait until Tuesday before looking into defining tensor morphisms.",
    "created_at": "2013-11-02T21:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191924",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'>Comment 7:</a>
I accidentally uploaded an old version of the patch. Here's the correct one.

I'll wait until Tuesday before looking into defining tensor morphisms.



---

archive/issue_comments_191925.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nAfter a second look,\n\nMy code did things exactly like you do (I mean I have no more interesting proposition). For your current implementation, we win a 20% speedup without using the constructor CartesianProduct and just iterate on ``im`` instead of CP for the return of the morphism subfunction.\n\nAbout design, I had a discussion with R\u00e9mi Maurice (king of combinatorial Hopf algebras implementation in Marne). Your patch and also the drafty one I did have the same problem : we check the existence of \"natural\" morphism by looking for coercion on atomic parent composing domain and codomain position-wise. This doesn't catch everything from far... Even we forgive about permutation of atoms in tensor product, this cut in atoms is the best solution we currently have. This make the following problem:\n\n```\nsage: C1 = CombinatorialFreeModule(ZZ, ZZ)\nsage: S1 = C1.tensor(C1)\nsage: f = S1.module_morphism(on_basis = lambda x : C1.monomial(x[0])+C1.monomial(x[1]), codomain=C1)\nsage: f.register_as_coercion()\nsage: C1(S1.an_element())\n3*B[-1] + 9*B[0] + 2*B[1]\nsage: S2 = S1.tensor(S1)\nsage: S2.has_coerce_map_from(S1)\nFalse\n```\nIf A tensor A has coercion to B, we don't cath the \"natural\" coercion from (A tensor A) tensor (A tensor A) to B tensor B.\n\nThat said, this ticket doesn't intend to solve the full research of coercion between any couple of (tensor)combinatorial free module and this could be very fun to have it rapidly in Sage since things like \n\n```\nsage: P = SymmetricFunctions(QQ).p(); P\nSymmetric Functions over Rational Field in the powersum basis\nsage: M = SymmetricFunctions(QQ).m(); M\nSymmetric Functions over Rational Field in the monomial basis\nsage: E = SymmetricFunctions(QQ).e(); E\nSymmetric Functions over Rational Field in the elementary basis\nsage: S = SymmetricFunctions(QQ).s(); S\nSymmetric Functions over Rational Field in the Schur basis\nsage: A = tensor((P, S))\nsage: B = tensor((E, M))\nsage: A(B.an_element())\n2*p[] # s[] + 2*p[] # s[1] - 3*p[] # s[1, 1] + 3*p[] # s[2]\n```\nare very nice.\n\nFor the test of all permutations on atoms of a tensor product and each parenthesis configuration on atoms and perhaps a coercion..... We think it is not a good thing to check such loud thing every time. For these cases (in which most of the time, the user know very well which is the permutation and the packaging of the atoms for (co)domain), we should have a nice tensor constructor which accept a tuple of morphisms (and after the construction, we forgive the parenthesis cutting into atoms new domain and new codomain). This should leave in a different ticket letting all current tensor product in Sage benefit from this enhancement.\n\nSo, even I really love semantic, I would prefer a speedup version of your patch without the CartesianProduct constructor.\n\nDo you agree with that ?\nSorry for my English, I hope I am not too much confusing...\n\nCheers and thanks for your work.\n\nNicolas B.",
    "created_at": "2013-11-05T21:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191925",
    "user": "https://github.com/sagetrac-nborie"
}
```

<a id='comment:8'>Comment 8:</a>
After a second look,

My code did things exactly like you do (I mean I have no more interesting proposition). For your current implementation, we win a 20% speedup without using the constructor CartesianProduct and just iterate on ``im`` instead of CP for the return of the morphism subfunction.

About design, I had a discussion with Rémi Maurice (king of combinatorial Hopf algebras implementation in Marne). Your patch and also the drafty one I did have the same problem : we check the existence of "natural" morphism by looking for coercion on atomic parent composing domain and codomain position-wise. This doesn't catch everything from far... Even we forgive about permutation of atoms in tensor product, this cut in atoms is the best solution we currently have. This make the following problem:

```
sage: C1 = CombinatorialFreeModule(ZZ, ZZ)
sage: S1 = C1.tensor(C1)
sage: f = S1.module_morphism(on_basis = lambda x : C1.monomial(x[0])+C1.monomial(x[1]), codomain=C1)
sage: f.register_as_coercion()
sage: C1(S1.an_element())
3*B[-1] + 9*B[0] + 2*B[1]
sage: S2 = S1.tensor(S1)
sage: S2.has_coerce_map_from(S1)
False
```
If A tensor A has coercion to B, we don't cath the "natural" coercion from (A tensor A) tensor (A tensor A) to B tensor B.

That said, this ticket doesn't intend to solve the full research of coercion between any couple of (tensor)combinatorial free module and this could be very fun to have it rapidly in Sage since things like 

```
sage: P = SymmetricFunctions(QQ).p(); P
Symmetric Functions over Rational Field in the powersum basis
sage: M = SymmetricFunctions(QQ).m(); M
Symmetric Functions over Rational Field in the monomial basis
sage: E = SymmetricFunctions(QQ).e(); E
Symmetric Functions over Rational Field in the elementary basis
sage: S = SymmetricFunctions(QQ).s(); S
Symmetric Functions over Rational Field in the Schur basis
sage: A = tensor((P, S))
sage: B = tensor((E, M))
sage: A(B.an_element())
2*p[] # s[] + 2*p[] # s[1] - 3*p[] # s[1, 1] + 3*p[] # s[2]
```
are very nice.

For the test of all permutations on atoms of a tensor product and each parenthesis configuration on atoms and perhaps a coercion..... We think it is not a good thing to check such loud thing every time. For these cases (in which most of the time, the user know very well which is the permutation and the packaging of the atoms for (co)domain), we should have a nice tensor constructor which accept a tuple of morphisms (and after the construction, we forgive the parenthesis cutting into atoms new domain and new codomain). This should leave in a different ticket letting all current tensor product in Sage benefit from this enhancement.

So, even I really love semantic, I would prefer a speedup version of your patch without the CartesianProduct constructor.

Do you agree with that ?
Sorry for my English, I hope I am not too much confusing...

Cheers and thanks for your work.

Nicolas B.



---

archive/issue_comments_191926.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [nborie](#comment%3A8):\n> My code did things exactly like you do (I mean I have no more interesting proposition). For your current implementation, we win a 20% speedup without using the constructor CartesianProduct and just iterate on ``im`` instead of CP for the return of the morphism subfunction.\n\nCould you post the code snippet? I'm using the `CartesianProduct` to iterate over all of the terms to do the expansion, and I'd like to see how you worked around this.\n\n> About design, I had a discussion with R\u00e9mi Maurice (king of combinatorial Hopf algebras implementation in Marne). Your patch and also the drafty one I did have the same problem : we check the existence of \"natural\" morphism by looking for coercion on atomic parent composing domain and codomain position-wise. This doesn't catch everything from far...\n\n>\n> ...\n>\n> If A tensor A has coercion to B, we don't cath the \"natural\" coercion from (A tensor A) tensor (A tensor A) to B tensor B.\n>\n> ...\n>\n> For these cases (in which most of the time, the user know very well which is the permutation and the packaging of the atoms for (co)domain), we should have a nice tensor constructor which accept a tuple of morphisms (and after the construction, we forgive the parenthesis cutting into atoms new domain and new codomain). This should leave in a different ticket letting all current tensor product in Sage benefit from this enhancement.\n\nI agree that this misses many natural maps and would definitely be a nice feature to have. I also agree that this should wait for a later ticket (since I'm just using this to make thing easier for #15311).\n\nThanks,\n\nTravis",
    "created_at": "2013-11-05T21:51:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191926",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [nborie](#comment%3A8):
> My code did things exactly like you do (I mean I have no more interesting proposition). For your current implementation, we win a 20% speedup without using the constructor CartesianProduct and just iterate on ``im`` instead of CP for the return of the morphism subfunction.

Could you post the code snippet? I'm using the `CartesianProduct` to iterate over all of the terms to do the expansion, and I'd like to see how you worked around this.

> About design, I had a discussion with Rémi Maurice (king of combinatorial Hopf algebras implementation in Marne). Your patch and also the drafty one I did have the same problem : we check the existence of "natural" morphism by looking for coercion on atomic parent composing domain and codomain position-wise. This doesn't catch everything from far...

>
> ...
>
> If A tensor A has coercion to B, we don't cath the "natural" coercion from (A tensor A) tensor (A tensor A) to B tensor B.
>
> ...
>
> For these cases (in which most of the time, the user know very well which is the permutation and the packaging of the atoms for (co)domain), we should have a nice tensor constructor which accept a tuple of morphisms (and after the construction, we forgive the parenthesis cutting into atoms new domain and new codomain). This should leave in a different ticket letting all current tensor product in Sage benefit from this enhancement.

I agree that this misses many natural maps and would definitely be a nice feature to have. I also agree that this should wait for a later ticket (since I'm just using this to make thing easier for #15311).

Thanks,

Travis



---

archive/issue_comments_191927.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nI try to just remove CartesianProduct replacing\n\n```\ndef tensor_morphism(t): \n    im = [M(R._sets[i].monomial(t[i])) for i,M in enumerate(self._sets)] \n    C = CartesianProduct(*im)\n    return self.sum_of_terms([(tuple(x[0] for x in cp), B.prod(x[1] for x in cp)) \n                             for cp in C])\n```\nby\n\n```\ndef tensor_morphism(t): \n    im = [M(R._sets[i].monomial(t[i])) for i,M in enumerate(self._sets)] \n    return self.sum_of_terms([(tuple(x[0] for x in cp), B.prod(x[1] for x in cp)) \n                              for cp in im])\n```\nI hope this does not change the result..\n\nFor curiosity, I attach also the old patch I've made a year ago for R\u00e9mi Maurice...\n\nCheers,\n\nNicolas B.",
    "created_at": "2013-11-05T22:01:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191927",
    "user": "https://github.com/sagetrac-nborie"
}
```

<a id='comment:10'>Comment 10:</a>
I try to just remove CartesianProduct replacing

```
def tensor_morphism(t): 
    im = [M(R._sets[i].monomial(t[i])) for i,M in enumerate(self._sets)] 
    C = CartesianProduct(*im)
    return self.sum_of_terms([(tuple(x[0] for x in cp), B.prod(x[1] for x in cp)) 
                             for cp in C])
```
by

```
def tensor_morphism(t): 
    im = [M(R._sets[i].monomial(t[i])) for i,M in enumerate(self._sets)] 
    return self.sum_of_terms([(tuple(x[0] for x in cp), B.prod(x[1] for x in cp)) 
                              for cp in im])
```
I hope this does not change the result..

For curiosity, I attach also the old patch I've made a year ago for Rémi Maurice...

Cheers,

Nicolas B.



---

archive/issue_comments_191928.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nAttachment: **[coercion_for_tensor_product-nb.patch.gz](https://github.com/sagemath/sage/files/ticket15305/coercion_for_tensor_product-nb.patch.gz)**\n\nFor patchbot : \n\napply trac_15305-coercion_tensor_products-ts.patch",
    "created_at": "2013-11-05T22:03:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191928",
    "user": "https://github.com/sagetrac-nborie"
}
```

<a id='comment:11'>Comment 11:</a>
Attachment: **[coercion_for_tensor_product-nb.patch.gz](https://github.com/sagemath/sage/files/ticket15305/coercion_for_tensor_product-nb.patch.gz)**

For patchbot : 

apply trac_15305-coercion_tensor_products-ts.patch



---

archive/issue_comments_191929.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nHere are some timings with my patch (no CP changes):\n\n```\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 1.01 ms per loop\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 1.01 ms per loop\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 1.04 ms per loop\n```\nWith your patch:\n\n```\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 482 us per loop\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 489 us per loop\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 485 us per loop\n```\nSo I'll use your patch with some minor changes.",
    "created_at": "2013-11-05T22:36:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191929",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'>Comment 12:</a>
Here are some timings with my patch (no CP changes):

```
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 1.01 ms per loop
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 1.01 ms per loop
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 1.04 ms per loop
```
With your patch:

```
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 482 us per loop
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 489 us per loop
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 485 us per loop
```
So I'll use your patch with some minor changes.



---

archive/issue_comments_191930.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [nborie](#comment%3A10):\n> \n> ```\n> def tensor_morphism(t): \n>     im = [M(R._sets[i].monomial(t[i])) for i,M in enumerate(self._sets)] \n>     return self.sum_of_terms([(tuple(x[0] for x in cp), B.prod(x[1] for x in cp)) \n>                               for cp in im])\n> ```\n\nIn the above, M(...) calls a conversion morphism from R._sets[i] to M. More often than not, that morphism will be a module_morphism, and thus have a \"on_basis\" method. So if we request once for all the morphism, on could rewrite it as just phi.on_basis(t[i]), avoiding a lot of the overhead.\n\nBtw: doing this might be easier if one extracts a \"tensor_product_of_morphisms\" function.",
    "created_at": "2013-11-05T23:08:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191930",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [nborie](#comment%3A10):
> 
> ```
> def tensor_morphism(t): 
>     im = [M(R._sets[i].monomial(t[i])) for i,M in enumerate(self._sets)] 
>     return self.sum_of_terms([(tuple(x[0] for x in cp), B.prod(x[1] for x in cp)) 
>                               for cp in im])
> ```

In the above, M(...) calls a conversion morphism from R._sets[i] to M. More often than not, that morphism will be a module_morphism, and thus have a "on_basis" method. So if we request once for all the morphism, on could rewrite it as just phi.on_basis(t[i]), avoiding a lot of the overhead.

Btw: doing this might be easier if one extracts a "tensor_product_of_morphisms" function.



---

archive/issue_comments_191931.json:
```json
{
    "body": "Attachment: **[trac_15305-coercion_tensor_products-ts.patch.gz](https://github.com/sagemath/sage/files/ticket15305/trac_15305-coercion_tensor_products-ts.patch.gz)**",
    "created_at": "2013-11-05T23:13:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191931",
    "user": "https://github.com/tscrim"
}
```

Attachment: **[trac_15305-coercion_tensor_products-ts.patch.gz](https://github.com/sagemath/sage/files/ticket15305/trac_15305-coercion_tensor_products-ts.patch.gz)**



---

archive/issue_comments_191932.json:
```json
{
    "body": "Reviewer: **Nicolas Borie, Travis Scrimshaw**",
    "created_at": "2013-11-05T23:15:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191932",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Nicolas Borie, Travis Scrimshaw**



---

archive/issue_comments_191933.json:
```json
{
    "body": "Changed author from **Travis Scrimshaw** to **Travis Scrimshaw, Nicolas Borie**",
    "created_at": "2013-11-05T23:15:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191933",
    "user": "https://github.com/tscrim"
}
```

Changed author from **Travis Scrimshaw** to **Travis Scrimshaw, Nicolas Borie**



---

archive/issue_comments_191934.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nNew version timings\n\n```\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 316 us per loop\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 317 us per loop\nsage: %timeit S2(S.an_element())\n1000 loops, best of 3: 321 us per loop\n```\nAlthough it returns a `NotImplementedError` when the coercion is not defined, which is the wrong kind of error, but at least it is an error. I'll see if I can fix this.\n\nI found this funny:\n\n```\nsage -t free_module.py\n    [666 tests, 1.09 s]\n```\n\nFor patchbot:\n\nApply: trac_15305-coercion_tensor_products-ts.patch",
    "created_at": "2013-11-05T23:15:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191934",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'>Comment 14:</a>
New version timings

```
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 316 us per loop
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 317 us per loop
sage: %timeit S2(S.an_element())
1000 loops, best of 3: 321 us per loop
```
Although it returns a `NotImplementedError` when the coercion is not defined, which is the wrong kind of error, but at least it is an error. I'll see if I can fix this.

I found this funny:

```
sage -t free_module.py
    [666 tests, 1.09 s]
```

For patchbot:

Apply: trac_15305-coercion_tensor_products-ts.patch



---

archive/issue_comments_191935.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n Given modules `A1, A2, B1, B2` with coercions `A1 -> B1` and `A2 -> B2`, there is the natural coercion `A1 # A2 -> B1 # B2` as the tensor of the factor coercions. This ticket implements the above coercion as a natural coercion for `CombinatorialFreeModule_Tensor`.\n+\n+Apply: [attachment: trac_15305-coercion_tensor_products-ts.patch.gz](https://github.com/sagemath/sage/files/ticket15305/trac_15305-coercion_tensor_products-ts.patch.gz)\n``````\n",
    "created_at": "2013-11-05T23:15:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191935",
    "user": "https://github.com/tscrim"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 Given modules `A1, A2, B1, B2` with coercions `A1 -> B1` and `A2 -> B2`, there is the natural coercion `A1 # A2 -> B1 # B2` as the tensor of the factor coercions. This ticket implements the above coercion as a natural coercion for `CombinatorialFreeModule_Tensor`.
+
+Apply: [attachment: trac_15305-coercion_tensor_products-ts.patch.gz](https://github.com/sagemath/sage/files/ticket15305/trac_15305-coercion_tensor_products-ts.patch.gz)
``````




---

archive/issue_comments_191936.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nWell, this is a correct error of sorts:\n\n```\nsage: C = CombinatorialFreeModule(ZZ, Set([1,2]))\nsage: T = tensor((C,C))\nsage: T._basis_keys\nImage of Cartesian product of {1, 2}, {1, 2} by <type 'tuple'>\nsage: type(_)\n<class 'sage.combinat.combinat.MapCombinatorialClass'>\n```\nbecause `MapCombinatorialClass` doesn't have a `__contains__()` method and it's trying to do a conversion (via `_element_constructor_()`) since there is no coercion.\n\nI've added you to the authors since the main part of the code is yours and we'll \"cross review\" this. I'm happy with the current state of the patch.\n\nFor patchbot:\n\nApply: trac_15305-coercion_tensor_products-ts.patch",
    "created_at": "2013-11-05T23:25:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191936",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'>Comment 15:</a>
Well, this is a correct error of sorts:

```
sage: C = CombinatorialFreeModule(ZZ, Set([1,2]))
sage: T = tensor((C,C))
sage: T._basis_keys
Image of Cartesian product of {1, 2}, {1, 2} by <type 'tuple'>
sage: type(_)
<class 'sage.combinat.combinat.MapCombinatorialClass'>
```
because `MapCombinatorialClass` doesn't have a `__contains__()` method and it's trying to do a conversion (via `_element_constructor_()`) since there is no coercion.

I've added you to the authors since the main part of the code is yours and we'll "cross review" this. I'm happy with the current state of the patch.

For patchbot:

Apply: trac_15305-coercion_tensor_products-ts.patch



---

archive/issue_events_193130.json:
```json
{
    "actor": "https://github.com/sagetrac-nborie",
    "created_at": "2013-11-06T10:39:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193130"
}
```



---

archive/issue_events_193131.json:
```json
{
    "actor": "https://github.com/sagetrac-nborie",
    "created_at": "2013-11-06T10:39:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193131"
}
```



---

archive/issue_comments_191937.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nI had not test the whole Sage (Patchbot dosen't want to run tests...) but at least the whole Combinat and categories...\n\nNevertheless, I hope the green mark will be coming soon and I am pretty sure it is on the way. The current state of the patch seems good and it makes what we want exactly. I did use Sage 5.12 with the dependency to review that. There are also now nice tests on this enhancement.\n\nOk, perfect for me.\n\nThanks you very very much for this work. My original fix has been implemented during the Sage days at Providence (9 month ago???) and I lazily never took the time to finalize that (I say that keeping my armor Nicolas T., don't kick me...). In this time of fpsac submission, thanks very much Travis for having finalize it. I am a little ghostly on the Sage trac the last months (position audition and teaching...).\n\nCheers, \n\nNicolas B.",
    "created_at": "2013-11-06T10:39:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191937",
    "user": "https://github.com/sagetrac-nborie"
}
```

<a id='comment:16'>Comment 16:</a>
I had not test the whole Sage (Patchbot dosen't want to run tests...) but at least the whole Combinat and categories...

Nevertheless, I hope the green mark will be coming soon and I am pretty sure it is on the way. The current state of the patch seems good and it makes what we want exactly. I did use Sage 5.12 with the dependency to review that. There are also now nice tests on this enhancement.

Ok, perfect for me.

Thanks you very very much for this work. My original fix has been implemented during the Sage days at Providence (9 month ago???) and I lazily never took the time to finalize that (I say that keeping my armor Nicolas T., don't kick me...). In this time of fpsac submission, thanks very much Travis for having finalize it. I am a little ghostly on the Sage trac the last months (position audition and teaching...).

Cheers, 

Nicolas B.



---

archive/issue_comments_191938.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nThanks for getting to me your version of the patch and for doing the review.",
    "created_at": "2013-11-06T17:13:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191938",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'>Comment 17:</a>
Thanks for getting to me your version of the patch and for doing the review.



---

archive/issue_comments_191939.json:
```json
{
    "body": "Changed keywords from **tensor product coercion** to **tensor product coercion, days54**",
    "created_at": "2013-11-06T18:50:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191939",
    "user": "https://github.com/tscrim"
}
```

Changed keywords from **tensor product coercion** to **tensor product coercion, days54**



---

archive/issue_comments_191940.json:
```json
{
    "body": "Merged: **sage-5.13.beta3**",
    "created_at": "2013-11-09T15:30:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15305#issuecomment-191940",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.13.beta3**



---

archive/issue_events_193132.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-09T15:30:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193132"
}
```



---

archive/issue_events_193133.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-09T15:30:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15305",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15305#event-193133"
}
```
