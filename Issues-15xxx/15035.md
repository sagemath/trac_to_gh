# Issue 15035: removing redundant set/iter conversions in graph backend

archive/issues_014798.json:
```json
{
    "body": "Hello,\n\nthis patch speeds up neighbor iterator method when the original graph is not directed. The speed up is achieved by removing unnecessary set conversions in the graph backend.\n(as seen on a figure in ticket [http://trac.sagemath.org/ticket/13730](http://trac.sagemath.org/ticket/13730).)\n\nBefore:\n\n```\nsage: G = graphs.RandomBarabasiAlbert(1000,2)\nsage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]\n100 loops, best of 3: 7.8 ms per loop\n\n```\n\nAfter:\n\n```\nsage: G = graphs.RandomBarabasiAlbert(1000,2)\nsage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]\n100 loops, best of 3: 3.58 ms per loop\n\n```\n\n\nAPPLY:\n* [attachment:nbrspeedup_5_12beta3.patch]\n* [attachment:trac_15035-rev.patch\u200b]\n\n**CC:**  @nathanncohen azi\n\n**Reviewer:** Nathann Cohen, Jernej Azarija\n\n**Author:** Uros Slana\n\n**Merged:** sage-5.12.beta5\n\nIssue created by migration from https://trac.sagemath.org/ticket/15035\n\n",
    "closed_at": "2013-09-02T10:25:24Z",
    "created_at": "2013-08-11T16:42:22Z",
    "labels": [
        "component: graph theory",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "removing redundant set/iter conversions in graph backend",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15035",
    "user": "https://github.com/lobiCode"
}
```
Hello,

this patch speeds up neighbor iterator method when the original graph is not directed. The speed up is achieved by removing unnecessary set conversions in the graph backend.
(as seen on a figure in ticket [http://trac.sagemath.org/ticket/13730](http://trac.sagemath.org/ticket/13730).)

Before:

```
sage: G = graphs.RandomBarabasiAlbert(1000,2)
sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
100 loops, best of 3: 7.8 ms per loop

```

After:

```
sage: G = graphs.RandomBarabasiAlbert(1000,2)
sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
100 loops, best of 3: 3.58 ms per loop

```


APPLY:
* [attachment:nbrspeedup_5_12beta3.patch]
* [attachment:trac_15035-rev.patch​]

**CC:**  @nathanncohen azi

**Reviewer:** Nathann Cohen, Jernej Azarija

**Author:** Uros Slana

**Merged:** sage-5.12.beta5

Issue created by migration from https://trac.sagemath.org/ticket/15035





---

archive/attachments_020154.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "nbrspeedup.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket15035/nbrspeedup.patch",
    "created_at": "2013-08-11T18:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```



---

archive/issue_comments_227758.json:
```json
{
    "body": "<a id='comment:1'></a>\nHello!\n\nI have discussed this with slani, reviewed it and tested it. I think the patch is good to go and would like to give it a positive review, but I give you (Nathann) the last word on this!\n\nWhat do you think?",
    "created_at": "2013-08-11T18:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227758",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

<a id='comment:1'></a>
Hello!

I have discussed this with slani, reviewed it and tested it. I think the patch is good to go and would like to give it a positive review, but I give you (Nathann) the last word on this!

What do you think?



---

archive/issue_comments_227759.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-08-12T09:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227759",
    "user": "https://github.com/nathanncohen"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_227760.json:
```json
{
    "body": "<a id='comment:2'></a>\nWell `O_O`\n\nI was worried that removing this \"iter(set(\" would create problems with multiple edges, but the code from sparse_graph already avoids that... `:-P`\n\nI would say \"good to go\", while crossing my fingers with the hope that no code which is not doctested will be reported as broken in a couple of weeks `:-P`\n\nDid you run the tests on the whole Sage library ? Some guys create weird graphs outside of the graph/ folder, and there may be changes to make there too.\n\nNathann",
    "created_at": "2013-08-12T09:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227760",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:2'></a>
Well `O_O`

I was worried that removing this "iter(set(" would create problems with multiple edges, but the code from sparse_graph already avoids that... `:-P`

I would say "good to go", while crossing my fingers with the hope that no code which is not doctested will be reported as broken in a couple of weeks `:-P`

Did you run the tests on the whole Sage library ? Some guys create weird graphs outside of the graph/ folder, and there may be changes to make there too.

Nathann



---

archive/issue_comments_227761.json:
```json
{
    "body": "<a id='comment:3'></a>\nYes, we've made sure that at least the default backend does not return duplicated neighbors in case of multiple edges.\n\nI've now also ran the tests on the whole library. A bunch of things fails but none appears to be relate to the change of this patch :-)\n\n\n\n```\nsage -t sage-5.10.beta1/devel/sage/sage/tests/cmdline.py  # 3 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/stats/r.py  # 1 doctest failed\nsage -t sage-5.10.beta1/devel/sage/sage/misc/sageinspect.py  # 1 doctest failed\nsage -t sage-5.10.beta1/devel/sage/sage/misc/interpreter.py  # 2 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/interfaces/interface.py  # 4 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/interfaces/r.py  # 186 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/interfaces/expect.py  # 7 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/ambient_module.py  # 1 doctest failed\nsage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/hecke_operator.py  # Killed due to segmentation fault\nsage -t sage-5.10.beta1/devel/sage/sage/modular/modsym/ambient.py  # 2 doctests failed\n```\n\n\nThat said I'll mark this with a positive review and add the relevant ticket information.",
    "created_at": "2013-08-12T11:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227761",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

<a id='comment:3'></a>
Yes, we've made sure that at least the default backend does not return duplicated neighbors in case of multiple edges.

I've now also ran the tests on the whole library. A bunch of things fails but none appears to be relate to the change of this patch :-)



```
sage -t sage-5.10.beta1/devel/sage/sage/tests/cmdline.py  # 3 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/stats/r.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/misc/sageinspect.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/misc/interpreter.py  # 2 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/interface.py  # 4 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/r.py  # 186 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/expect.py  # 7 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/ambient_module.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/hecke_operator.py  # Killed due to segmentation fault
sage -t sage-5.10.beta1/devel/sage/sage/modular/modsym/ambient.py  # 2 doctests failed
```


That said I'll mark this with a positive review and add the relevant ticket information.



---

archive/issue_comments_227762.json:
```json
{
    "body": "**Reviewer:** Nathann Cohen, Jernej Azarija",
    "created_at": "2013-08-12T11:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227762",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

**Reviewer:** Nathann Cohen, Jernej Azarija



---

archive/issue_comments_227763.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-08-12T11:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227763",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_227764.json:
```json
{
    "body": "**Author:** Uros Slana",
    "created_at": "2013-08-12T11:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227764",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

**Author:** Uros Slana



---

archive/issue_comments_227765.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,7 +15,7 @@\n After:\n \n ```\n-sage: G = graphs.RandomBarabasiAlbert(10**6,2)\n+sage: G = graphs.RandomBarabasiAlbert(1000,2)\n sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]\n 100 loops, best of 3: 3.58 ms per loop\n \n``````\n",
    "created_at": "2013-08-12T20:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227765",
    "user": "https://github.com/lobiCode"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,7 +15,7 @@
 After:
 
 ```
-sage: G = graphs.RandomBarabasiAlbert(10**6,2)
+sage: G = graphs.RandomBarabasiAlbert(1000,2)
 sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
 100 loops, best of 3: 3.58 ms per loop
 
``````




---

archive/issue_comments_227766.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2013-08-20T13:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227766",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_227767.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis needs to be rebased to sage-5.12.beta2.",
    "created_at": "2013-08-20T13:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227767",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
This needs to be rebased to sage-5.12.beta2.



---

archive/issue_comments_227768.json:
```json
{
    "body": "<a id='comment:7'></a>\nI just rebased this patch and oddly, when it is applied the doctest \n\n```\n    sage: g = graphs.JohnsonGraph(7, 3)\n    sage: g.is_hamiltonian()\n```\n\nfrom `generators/families.py` takes forever `O_o`\n\nNathann",
    "created_at": "2013-08-20T16:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227768",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>
I just rebased this patch and oddly, when it is applied the doctest 

```
    sage: g = graphs.JohnsonGraph(7, 3)
    sage: g.is_hamiltonian()
```

from `generators/families.py` takes forever `O_o`

Nathann



---

archive/issue_comments_227769.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnd you're sure it's because of this patch?",
    "created_at": "2013-08-20T18:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227769",
    "user": "https://trac.sagemath.org/admin/accounts/users/azi"
}
```

<a id='comment:8'></a>
And you're sure it's because of this patch?



---

archive/issue_comments_227770.json:
```json
{
    "body": "<a id='comment:9'></a>\nHello!\n\nI rebased this patch to sage-5.12.beta3 and it passes all graph tests.\n\nBest,\n\nUros\n\nP.S.\nIt's also works for hamiltonian cycle test.\n\n```\nsage: g = graphs.JohnsonGraph(7, 3)\nsage: %timeit g.is_hamiltonian()\n10 loops, best of 3: 50.9 ms per loop\n```",
    "created_at": "2013-08-27T23:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227770",
    "user": "https://github.com/lobiCode"
}
```

<a id='comment:9'></a>
Hello!

I rebased this patch to sage-5.12.beta3 and it passes all graph tests.

Best,

Uros

P.S.
It's also works for hamiltonian cycle test.

```
sage: g = graphs.JohnsonGraph(7, 3)
sage: %timeit g.is_hamiltonian()
10 loops, best of 3: 50.9 ms per loop
```



---

archive/attachments_020155.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "nbrspeedup_5_12beta3.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket15035/nbrspeedup_5_12beta3.patch",
    "created_at": "2013-08-27T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/lobiCode"
}
```



---

archive/issue_comments_227771.json:
```json
{
    "body": "<a id='comment:10'></a>\n",
    "created_at": "2013-08-27T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227771",
    "user": "https://github.com/lobiCode"
}
```

<a id='comment:10'></a>




---

archive/issue_comments_227772.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-08-27T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227772",
    "user": "https://github.com/lobiCode"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_227773.json:
```json
{
    "body": "<a id='comment:11'></a>\nWell... Of course it was still hanging on my computer, and a couple of hours later I now have a patch fixing the `traveling_salesman` method which had a problem with those f.... non-integer vertices `>_<`\n\nIf you agree with this additional patch you can set the ticket to `positive_review`.\n\nNathann",
    "created_at": "2013-08-28T09:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227773",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:11'></a>
Well... Of course it was still hanging on my computer, and a couple of hours later I now have a patch fixing the `traveling_salesman` method which had a problem with those f.... non-integer vertices `>_<`

If you agree with this additional patch you can set the ticket to `positive_review`.

Nathann



---

archive/attachments_020156.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_15035-rev.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket15035/trac_15035-rev.patch",
    "created_at": "2013-08-28T09:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/nathanncohen"
}
```



---

archive/issue_comments_227774.json:
```json
{
    "body": "",
    "created_at": "2013-08-28T09:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227774",
    "user": "https://github.com/nathanncohen"
}
```





---

archive/issue_comments_227775.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-08-28T09:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227775",
    "user": "https://github.com/lobiCode"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_227776.json:
```json
{
    "body": "<a id='comment:13'></a>\nWhich patch(es) need to be applied?",
    "created_at": "2013-08-29T08:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227776",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Which patch(es) need to be applied?



---

archive/issue_comments_227777.json:
```json
{
    "body": "<a id='comment:14'></a>\nSorryyyyyyyyyyyyyyyyyyyyyy !!!\n\nApply nbrspeedup_5_12beta3.patch, trac_15035-rev.patch\u200b",
    "created_at": "2013-08-29T08:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227777",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:14'></a>
Sorryyyyyyyyyyyyyyyyyyyyyy !!!

Apply nbrspeedup_5_12beta3.patch, trac_15035-rev.patch​



---

archive/issue_comments_227778.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -22,4 +22,6 @@\n ```\n \n \n-\n+APPLY:\n+* [attachment:nbrspeedup_5_12beta3.patch]\n+* [attachment:trac_15035-rev.patch\u200b]\n``````\n",
    "created_at": "2013-08-29T08:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227778",
    "user": "https://github.com/nathanncohen"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -22,4 +22,6 @@
 ```
 
 
-
+APPLY:
+* [attachment:nbrspeedup_5_12beta3.patch]
+* [attachment:trac_15035-rev.patch​]
``````




---

archive/issue_events_049205.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-09-02T10:25:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15035#event-49205"
}
```



---

archive/issue_comments_227779.json:
```json
{
    "body": "**Merged:** sage-5.12.beta5",
    "created_at": "2013-09-02T10:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15035#issuecomment-227779",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.12.beta5
