# Issue 15432: Use a callback with a weak reference to WeakValueDictionary

archive/issues_015195.json:
```json
{
    "assignees": [],
    "body": "Following http://bugs.python.org/issue417795, we should probably only reference the dict weakly from the callback object to avoid unnecessary circular references.\n\nAs we found in [#15367 comment:39](https://github.com/sagemath/sage/issues/15367#comment:39), if an object C involved in a reference cycle becomes unreachable as a side effect of circular GC (e.g., a callback somewhere), the object C will only be collected by GC in the next round. A non-circularly referenced object C would have its reference count hit 0 and would be collected immediately. That is already a good reason to try and avoid circular references, even now that Python does clean them up eventually.\n\nSee also [#13394 comment:19](https://github.com/sagemath/sage/issues/13394#comment:19) (reasoning the validity of using a strongly referencing closure should be fine in theory -- this didn't take into account the practical consideration above).\n\nCC:  @simon-king-jena\n\nBranch/Commit: **[u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432) @ [`13112a9`](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)**\n\nReviewer: **Simon King**\n\nAuthor: **Nils Bruin**\n\nComponent: **memleak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15432_\n\n",
    "closed_at": "2013-12-24T20:24:09Z",
    "created_at": "2013-11-17T20:07:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/memleak",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use a callback with a weak reference to WeakValueDictionary",
    "type": "issue",
    "updated_at": "2013-12-24T20:24:09Z",
    "url": "https://github.com/sagemath/sage/issues/15432",
    "user": "https://github.com/nbruin"
}
```
Following http://bugs.python.org/issue417795, we should probably only reference the dict weakly from the callback object to avoid unnecessary circular references.

As we found in [#15367 comment:39](https://github.com/sagemath/sage/issues/15367#comment:39), if an object C involved in a reference cycle becomes unreachable as a side effect of circular GC (e.g., a callback somewhere), the object C will only be collected by GC in the next round. A non-circularly referenced object C would have its reference count hit 0 and would be collected immediately. That is already a good reason to try and avoid circular references, even now that Python does clean them up eventually.

See also [#13394 comment:19](https://github.com/sagemath/sage/issues/13394#comment:19) (reasoning the validity of using a strongly referencing closure should be fine in theory -- this didn't take into account the practical consideration above).

CC:  @simon-king-jena

Branch/Commit: **[u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432) @ [`13112a9`](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)**

Reviewer: **Simon King**

Author: **Nils Bruin**

Component: **memleak**

_Issue created by migration from https://trac.sagemath.org/ticket/15432_





---

archive/issue_events_220764.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-11-17T20:07:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "milestone_number": null,
    "milestone_title": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220764"
}
```



---

archive/issue_events_220765.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-11-17T20:07:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "d73a4a",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220765"
}
```



---

archive/issue_events_220766.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-11-17T20:07:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220766"
}
```



---

archive/issue_events_220767.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-11-17T20:07:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220767"
}
```



---

archive/issue_comments_192016.json:
```json
{
    "body": "Branch: **[u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)**",
    "created_at": "2013-11-17T20:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192016",
    "user": "https://github.com/nbruin"
}
```

Branch: **[u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)**



---

archive/issue_comments_192017.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><code>[9bb9241](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241)</code></td><td><code>trac #15432: use a callback class object holding a weak reference for sage.misc.weak_dict.WeakValueDictionary</code></td></tr></table>\n",
    "created_at": "2013-11-17T20:16:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192017",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><code>[9bb9241](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241)</code></td><td><code>trac #15432: use a callback class object holding a weak reference for sage.misc.weak_dict.WeakValueDictionary</code></td></tr></table>




---

archive/issue_comments_192018.json:
```json
{
    "body": "Commit: **[`9bb9241`](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)**",
    "created_at": "2013-11-17T20:16:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192018",
    "user": "https://github.com/nbruin"
}
```

Commit: **[`9bb9241`](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)**



---

archive/issue_events_220768.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-11-17T20:16:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220768"
}
```



---

archive/issue_comments_192019.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nJust to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?",
    "created_at": "2013-11-17T21:32:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192019",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Just to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?



---

archive/issue_comments_192020.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@simon-king-jena](#comment:3):\n> Just to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?\n\nThe branch here descends directly from master, which recently had 5.13beta3 merged. Therefore, as posted, this ticket has no dependencies. Since it only touches one file, that isn't even present in the branch for #15367 (its branch split off before 5.13beta3 merger), I expect no merge problems with that ticket.\n\nI actually have a bit of trouble coming up with an example that shows a difference in behaviour for WeakValueDictionary (before this ticket it's not weakly refererrable, making examples particularly tricky). With the following code:\n\n```\n%cpaste\nimport gc\nfrom sage.misc.weak_dict import WeakValueDictionary\nfrom sage.structure.coerce_dict import MonoDict\ndef Nobj(t):\n    return len([1 for o in gc.get_objects() if isinstance(o,t)])\ndef TestTcollect(T,args=()):\n    N=Nobj(T)\n    print \"Number of T-objects before we start:\",N\n    L=[T(*args) for i in range(100)]\n    M=MonoDict(11)\n    for i in range(len(L)-1):\n        M[L[i]]=L[i+1]\n    Nnew=Nobj(T)\n    print \"Number of T-objects after list construction:\",Nnew\n    print \"Throwing away references:\"\n    del L\n    Nnew=Nobj(T)\n    if Nnew == N:\n        print \"no GC required to get rid of objects\";\n    j=0\n    while Nnew>N:\n        j+=1\n        _=gc.collect()\n        Ntemp=Nobj(T)\n        if Ntemp >= Nnew:\n            raise RuntimeError(\"we're not collecting at all!\")\n        Nnew=Ntemp\n    print \"number of collects required:\",j\nclass dd(dict):\n    \"a weakly reffable and easily recognized dict class\"\n    pass\nclass selfref(object):\n    def __init__(self):\n        self.D=self\n--\n```\nI'm getting with a self-referencing class:\n\n```\nsage: TestTcollect(selfref)\nNumber of T-objects before we start: 0\nNumber of T-objects after list construction: 100\nThrowing away references:\nnumber of collects required: 100\n```\nThe test doesn't work for dict itself (they have their own freelist etc. so\nthe object count you get back can't be trusted), but we can do it on a subclass:\n\n```\nsage: TestTcollect(dd)\nNumber of T-objects before we start: 0\nNumber of T-objects after list construction: 100\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nFor this patched `WeakValueDictionary` we're still getting problematic behaviour:\n\n```\nsage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)\nNumber of T-objects before we start: 29\nNumber of T-objects after list construction: 129\nThrowing away references:\nnumber of collects required: 100\n```\nWhereas python's own is clean:\n\n```\nsage: TestTcollect(weakref.WeakValueDictionary)\nNumber of T-objects before we start: 3\nNumber of T-objects after list construction: 103\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nAs is (at least our old) `TripleDict`:\n\n```\nsage: TestTcollect(sage.structure.coerce_dict.TripleDict,(11,))\nNumber of T-objects before we start: 180\nNumber of T-objects after list construction: 280\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nSo my guess is that we've overlooked another self reference in\nWeakValueDictionary.\n\nNote that our previous `sage.misc.weak_dict.WeakValueDictionary` wasn't weakly\nreferrable so this test doesn't apply in that case.",
    "created_at": "2013-11-17T23:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192020",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@simon-king-jena](#comment:3):
> Just to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?

The branch here descends directly from master, which recently had 5.13beta3 merged. Therefore, as posted, this ticket has no dependencies. Since it only touches one file, that isn't even present in the branch for #15367 (its branch split off before 5.13beta3 merger), I expect no merge problems with that ticket.

I actually have a bit of trouble coming up with an example that shows a difference in behaviour for WeakValueDictionary (before this ticket it's not weakly refererrable, making examples particularly tricky). With the following code:

```
%cpaste
import gc
from sage.misc.weak_dict import WeakValueDictionary
from sage.structure.coerce_dict import MonoDict
def Nobj(t):
    return len([1 for o in gc.get_objects() if isinstance(o,t)])
def TestTcollect(T,args=()):
    N=Nobj(T)
    print "Number of T-objects before we start:",N
    L=[T(*args) for i in range(100)]
    M=MonoDict(11)
    for i in range(len(L)-1):
        M[L[i]]=L[i+1]
    Nnew=Nobj(T)
    print "Number of T-objects after list construction:",Nnew
    print "Throwing away references:"
    del L
    Nnew=Nobj(T)
    if Nnew == N:
        print "no GC required to get rid of objects";
    j=0
    while Nnew>N:
        j+=1
        _=gc.collect()
        Ntemp=Nobj(T)
        if Ntemp >= Nnew:
            raise RuntimeError("we're not collecting at all!")
        Nnew=Ntemp
    print "number of collects required:",j
class dd(dict):
    "a weakly reffable and easily recognized dict class"
    pass
class selfref(object):
    def __init__(self):
        self.D=self
--
```
I'm getting with a self-referencing class:

```
sage: TestTcollect(selfref)
Number of T-objects before we start: 0
Number of T-objects after list construction: 100
Throwing away references:
number of collects required: 100
```
The test doesn't work for dict itself (they have their own freelist etc. so
the object count you get back can't be trusted), but we can do it on a subclass:

```
sage: TestTcollect(dd)
Number of T-objects before we start: 0
Number of T-objects after list construction: 100
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
For this patched `WeakValueDictionary` we're still getting problematic behaviour:

```
sage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)
Number of T-objects before we start: 29
Number of T-objects after list construction: 129
Throwing away references:
number of collects required: 100
```
Whereas python's own is clean:

```
sage: TestTcollect(weakref.WeakValueDictionary)
Number of T-objects before we start: 3
Number of T-objects after list construction: 103
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
As is (at least our old) `TripleDict`:

```
sage: TestTcollect(sage.structure.coerce_dict.TripleDict,(11,))
Number of T-objects before we start: 180
Number of T-objects after list construction: 280
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
So my guess is that we've overlooked another self reference in
WeakValueDictionary.

Note that our previous `sage.misc.weak_dict.WeakValueDictionary` wasn't weakly
referrable so this test doesn't apply in that case.



---

archive/issue_comments_192021.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><code>[8b70d1d](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d)</code></td><td><code>trac #15432: also equip iteration context with a weak reference</code></td></tr></table>\n",
    "created_at": "2013-11-17T23:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192021",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><code>[8b70d1d](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d)</code></td><td><code>trac #15432: also equip iteration context with a weak reference</code></td></tr></table>




---

archive/issue_comments_192022.json:
```json
{
    "body": "Changed commit from **[`9bb9241`](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)** to **[`8b70d1d`](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)**",
    "created_at": "2013-11-17T23:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192022",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9bb9241`](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)** to **[`8b70d1d`](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)**



---

archive/issue_comments_192023.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAnd of course there is another circular reference from the `_IterationContext`. Making that weak as well makes the thing collectable, so with the new branch we get that `TestTcollect` works as desired.\n\nNote that if you have objects chained by keys in a `WeakValueDictionary`, immediate collectibility of the chain could depend on the WeakValueDictionary not keeping circular references to itself.\n\nSo, I think this patch could have real effect of memory footprint in sage code.",
    "created_at": "2013-11-17T23:34:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192023",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

And of course there is another circular reference from the `_IterationContext`. Making that weak as well makes the thing collectable, so with the new branch we get that `TestTcollect` works as desired.

Note that if you have objects chained by keys in a `WeakValueDictionary`, immediate collectibility of the chain could depend on the WeakValueDictionary not keeping circular references to itself.

So, I think this patch could have real effect of memory footprint in sage code.



---

archive/issue_comments_192024.json:
```json
{
    "body": "Changed commit from **[`8b70d1d`](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)** to **[`4ac6866`](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)**",
    "created_at": "2013-11-18T00:09:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192024",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8b70d1d`](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)** to **[`4ac6866`](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)**



---

archive/issue_comments_192025.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><code>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</code></td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>\n",
    "created_at": "2013-11-18T00:09:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192025",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><code>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</code></td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>




---

archive/issue_comments_192026.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIncidentally, I think we can do away with the `_IterationContext` by using a `try/finally`:\n\n```\ncython(\"\"\"\ndef gen():\n    try:\n        while True:\n            yield 1\n    finally:\n        print \"finally clause executed\"\n\"\"\")\nsage: G=gen()\nsage: G.next()\n1\nsage: del G\nfinally clause executed\nsage: G=gen()\nsage: del G  #code is never entered, so `try/finally` clause is also not encountered\n```\nSo instead of using a `with` context manager, I think we can get away with writing our iterators as\n\n```\n        cdef PyObject *key, *wr\n        cdef Py_ssize_t pos = 0\n        try:\n            self._enter_iter()\n            while PyDict_Next(self, &pos, &key, &wr):\n                #this check doesn't really say anything: by the time\n                #the key makes it to the customer, it may have already turned\n                #invalid. It's a cheap check, though.\n                if PyWeakref_GetObject(wr)!=Py_None:\n                    yield <object>key\n        finally:\n            self._exit_iter()\n```\nwhere `_enter_iter` and `_exit_iter` can be the `__enter__` and `__exit__` methods on `_IterationContext`, adapted to be methods of `WeakValueDictionary` immediately. That saves us a weakref and an extra class (see pushed commit).\n\n---\nNew commits:\n<table><tr><td><code>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</code></td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>\n",
    "created_at": "2013-11-18T00:11:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192026",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

Incidentally, I think we can do away with the `_IterationContext` by using a `try/finally`:

```
cython("""
def gen():
    try:
        while True:
            yield 1
    finally:
        print "finally clause executed"
""")
sage: G=gen()
sage: G.next()
1
sage: del G
finally clause executed
sage: G=gen()
sage: del G  #code is never entered, so `try/finally` clause is also not encountered
```
So instead of using a `with` context manager, I think we can get away with writing our iterators as

```
        cdef PyObject *key, *wr
        cdef Py_ssize_t pos = 0
        try:
            self._enter_iter()
            while PyDict_Next(self, &pos, &key, &wr):
                #this check doesn't really say anything: by the time
                #the key makes it to the customer, it may have already turned
                #invalid. It's a cheap check, though.
                if PyWeakref_GetObject(wr)!=Py_None:
                    yield <object>key
        finally:
            self._exit_iter()
```
where `_enter_iter` and `_exit_iter` can be the `__enter__` and `__exit__` methods on `_IterationContext`, adapted to be methods of `WeakValueDictionary` immediately. That saves us a weakref and an extra class (see pushed commit).

---
New commits:
<table><tr><td><code>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</code></td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>




---

archive/issue_events_220769.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "milestone_number": null,
    "milestone_title": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220769"
}
```



---

archive/issue_events_220770.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220770"
}
```



---

archive/issue_comments_192027.json:
```json
{
    "body": "Author: **Nils Bruin**",
    "created_at": "2013-12-22T17:03:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192027",
    "user": "https://github.com/vbraun"
}
```

Author: **Nils Bruin**



---

archive/issue_comments_192028.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe code looks good, and using a cdef method instead of a Python context is very likely to be faster (I am not going to benchmark, though). I am running the tests now and will give a positive review if stuff passes.",
    "created_at": "2013-12-22T17:16:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192028",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

The code looks good, and using a cdef method instead of a Python context is very likely to be faster (I am not going to benchmark, though). I am running the tests now and will give a positive review if stuff passes.



---

archive/issue_comments_192029.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nDid I do something wrong? With the branch, I still get\n\n```\nsage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)\nNumber of T-objects before we start: 29\nNumber of T-objects after list construction: 129\nThrowing away references:\nnumber of collects required: 100\n```",
    "created_at": "2013-12-22T19:35:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192029",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

Did I do something wrong? With the branch, I still get

```
sage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)
Number of T-objects before we start: 29
Number of T-objects after list construction: 129
Throwing away references:
number of collects required: 100
```



---

archive/issue_comments_192030.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nQuestion: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of \"number of collects required: 0\")?",
    "created_at": "2013-12-22T19:39:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192030",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of "number of collects required: 0")?



---

archive/issue_comments_192031.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@simon-king-jena](#comment:13):\n> Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of \"number of collects required: 0\")?\n\nCorrect.",
    "created_at": "2013-12-23T07:17:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192031",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@simon-king-jena](#comment:13):
> Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of "number of collects required: 0")?

Correct.



---

archive/issue_comments_192032.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@nbruin](#comment:14):\n> Replying to [@simon-king-jena](#comment:13):\n> > Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of \"number of collects required: 0\")?\n\n> Correct.\n\nReally? But it doesn't, see [comment:12](#comment:12).",
    "created_at": "2013-12-23T10:48:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192032",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@nbruin](#comment:14):
> Replying to [@simon-king-jena](#comment:13):
> > Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of "number of collects required: 0")?

> Correct.

Really? But it doesn't, see [comment:12](#comment:12).



---

archive/issue_comments_192033.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nStrange. For whatever reason, my local version of your branch has been commit 9bb9241, not 4ac686. So, I am trying `sage --dev pull --ticket=15432` now, in the hope that it works.",
    "created_at": "2013-12-23T16:20:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192033",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

Strange. For whatever reason, my local version of your branch has been commit 9bb9241, not 4ac686. So, I am trying `sage --dev pull --ticket=15432` now, in the hope that it works.



---

archive/issue_comments_192034.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\n`sage --dev checkout --ticket=15432` keeps giving me the wrong commit, by the way. What shall I do? Is `pull` the right thing to do here?",
    "created_at": "2013-12-23T16:27:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192034",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

`sage --dev checkout --ticket=15432` keeps giving me the wrong commit, by the way. What shall I do? Is `pull` the right thing to do here?



---

archive/issue_comments_192035.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAnyway, the `sage --dev pull` was automatically merging your branch into my local version of the \"develop\" branch, and I think this is what I wanted to end up with. Now I can continue with the review.",
    "created_at": "2013-12-23T16:35:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192035",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">comment:18</div>

Anyway, the `sage --dev pull` was automatically merging your branch into my local version of the "develop" branch, and I think this is what I wanted to end up with. Now I can continue with the review.



---

archive/issue_comments_192036.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nPull pulls (=fetches & merges) into the current branch, whatever that currently is.",
    "created_at": "2013-12-23T16:40:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192036",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

Pull pulls (=fetches & merges) into the current branch, whatever that currently is.



---

archive/issue_comments_192037.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\n`sage --dev checkout --ticket=15432` works for me, for the record.",
    "created_at": "2013-12-23T16:43:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192037",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:20" align="right">comment:20</div>

`sage --dev checkout --ticket=15432` works for me, for the record.



---

archive/issue_comments_192038.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nHooray! After pulling the correct commit, I get\n\n```\nsage: TestTcollect(weakref.WeakValueDictionary)\nNumber of T-objects before we start: 3\nNumber of T-objects after list construction: 103\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nand the answer came a lot faster than before. All tests pass, and the patch (i.e., the diff between the develop branch and this branch after merging with the develop branch) looks reasonable to me. \n\nHence, I can *almost* give it a positive review. How can I do a review patch? Is it possible to make some changes and then do `sage --dev push`, or what is to do for the equivalent of a review patch?",
    "created_at": "2013-12-23T20:04:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192038",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Hooray! After pulling the correct commit, I get

```
sage: TestTcollect(weakref.WeakValueDictionary)
Number of T-objects before we start: 3
Number of T-objects after list construction: 103
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
and the answer came a lot faster than before. All tests pass, and the patch (i.e., the diff between the develop branch and this branch after merging with the develop branch) looks reasonable to me. 

Hence, I can *almost* give it a positive review. How can I do a review patch? Is it possible to make some changes and then do `sage --dev push`, or what is to do for the equivalent of a review patch?



---

archive/issue_comments_192039.json:
```json
{
    "body": "Reviewer: **Simon King**",
    "created_at": "2013-12-23T20:04:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192039",
    "user": "https://github.com/simon-king-jena"
}
```

Reviewer: **Simon King**



---

archive/issue_comments_192040.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nPS: Shall I revert the merge with the develop branch before creating the review \"patch\"?",
    "created_at": "2013-12-23T20:05:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192040",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

PS: Shall I revert the merge with the develop branch before creating the review "patch"?



---

archive/issue_comments_192041.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nYes to both.\n* If you made an unnecessary merge, revert it first (`git reset --hard HEAD~`) \n* for your review patch you just add another commit and then replace the branch (either manually with git or with `sage -dev push`)",
    "created_at": "2013-12-23T20:09:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192041",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:23" align="right">comment:23</div>

Yes to both.
* If you made an unnecessary merge, revert it first (`git reset --hard HEAD~`) 
* for your review patch you just add another commit and then replace the branch (either manually with git or with `sage -dev push`)



---

archive/issue_comments_192042.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nHow can I do the job without the dev script? I.e., how to do it manually with git?",
    "created_at": "2013-12-23T20:45:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192042",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

How can I do the job without the dev script? I.e., how to do it manually with git?



---

archive/issue_comments_192043.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n* edit\n* `git add <filename>`\n* `git commit -m 'commit message'`\n* `git push trac HEAD:u/SimonKing/weak_callback`\n\nSee also the developer guide (in Sage, not the old one that is still on www.sagemath.org)",
    "created_at": "2013-12-23T20:50:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192043",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

* edit
* `git add <filename>`
* `git commit -m 'commit message'`
* `git push trac HEAD:u/SimonKing/weak_callback`

See also the developer guide (in Sage, not the old one that is still on www.sagemath.org)



---

archive/issue_comments_192044.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@vbraun](#comment:25):\n> * edit\n> * `git add <filename>`\n> * `git commit -m 'commit message'`\n> * `git push trac HEAD:u/SimonKing/weak_callback`\n> \n> See also the developer guide (in Sage, not the old one that is still on www.sagemath.org)\n\nThank you! I already found the guide (but I did `git push --set-upstream trac HEAD:u/SimonKing/ticket/15432`, hope this is fine, too). It takes rather long to complete, though.",
    "created_at": "2013-12-23T20:54:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192044",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@vbraun](#comment:25):
> * edit
> * `git add <filename>`
> * `git commit -m 'commit message'`
> * `git push trac HEAD:u/SimonKing/weak_callback`
> 
> See also the developer guide (in Sage, not the old one that is still on www.sagemath.org)

Thank you! I already found the guide (but I did `git push --set-upstream trac HEAD:u/SimonKing/ticket/15432`, hope this is fine, too). It takes rather long to complete, though.



---

archive/issue_comments_192045.json:
```json
{
    "body": "Changed commit from **[`4ac6866`](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)** to **[`13112a9`](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)**",
    "created_at": "2013-12-23T20:55:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192045",
    "user": "https://github.com/simon-king-jena"
}
```

Changed commit from **[`4ac6866`](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)** to **[`13112a9`](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)**



---

archive/issue_comments_192046.json:
```json
{
    "body": "Changed branch from **[u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)** to **[u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432)**",
    "created_at": "2013-12-23T20:55:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15432#issuecomment-192046",
    "user": "https://github.com/simon-king-jena"
}
```

Changed branch from **[u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)** to **[u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432)**



---

archive/issue_events_220771.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-12-23T20:55:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220771"
}
```



---

archive/issue_events_220772.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-12-23T20:55:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220772"
}
```



---

archive/issue_events_220773.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-24T20:24:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220773"
}
```



---

archive/issue_events_220774.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "29cfa6ec57623d64dbc14a01366f4e39df912e18",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2013-12-24T20:24:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15432",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15432#event-220774"
}
```
