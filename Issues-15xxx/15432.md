# Issue 15432: Use a callback with a weak reference to WeakValueDictionary

archive/issues_015195.json:
```json
{
    "body": "Following http://bugs.python.org/issue417795, we should probably only reference the dict weakly from the callback object to avoid unnecessary circular references.\n\nAs we found in ticket:15367#comment:39, if an object C involved in a reference cycle becomes unreachable as a side effect of circular GC (e.g., a callback somewhere), the object C will only be collected by GC in the next round. A non-circularly referenced object C would have its reference count hit 0 and would be collected immediately. That is already a good reason to try and avoid circular references, even now that Python does clean them up eventually.\n\nSee also ticket:13394#comment:19 (reasoning the validity of using a strongly referencing closure should be fine in theory -- this didn't take into account the practical consideration above).\n\n**CC:**  simonking\n\n**Branch:** [u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432)\n\n**Commit:** [13112a9a5b664bcbd467cc6c9b197ae809ab44fb](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)\n\n**Reviewer:** Simon King\n\n**Author:** Nils Bruin\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15432\n\n",
    "closed_at": "2013-12-24T20:24:09Z",
    "created_at": "2013-11-17T20:07:53Z",
    "labels": [
        "component: memleak"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "Use a callback with a weak reference to WeakValueDictionary",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15432",
    "user": "https://github.com/nbruin"
}
```
Following http://bugs.python.org/issue417795, we should probably only reference the dict weakly from the callback object to avoid unnecessary circular references.

As we found in ticket:15367#comment:39, if an object C involved in a reference cycle becomes unreachable as a side effect of circular GC (e.g., a callback somewhere), the object C will only be collected by GC in the next round. A non-circularly referenced object C would have its reference count hit 0 and would be collected immediately. That is already a good reason to try and avoid circular references, even now that Python does clean them up eventually.

See also ticket:13394#comment:19 (reasoning the validity of using a strongly referencing closure should be fine in theory -- this didn't take into account the practical consideration above).

**CC:**  simonking

**Branch:** [u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432)

**Commit:** [13112a9a5b664bcbd467cc6c9b197ae809ab44fb](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)

**Reviewer:** Simon King

**Author:** Nils Bruin

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/15432





---

archive/issue_comments_250667.json:
```json
{
    "body": "**Branch:** [u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)",
    "created_at": "2013-11-17T20:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250667",
    "user": "https://github.com/nbruin"
}
```

**Branch:** [u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)



---

archive/issue_comments_250668.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td>[9bb9241](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241)</td><td><code>trac #15432: use a callback class object holding a weak reference for sage.misc.weak_dict.WeakValueDictionary</code></td></tr></table>\n",
    "created_at": "2013-11-17T20:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250668",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td>[9bb9241](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241)</td><td><code>trac #15432: use a callback class object holding a weak reference for sage.misc.weak_dict.WeakValueDictionary</code></td></tr></table>




---

archive/issue_comments_250669.json:
```json
{
    "body": "**Commit:** [9bb9241572468d4bc0563f06fe6fffcc8b12c345](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)",
    "created_at": "2013-11-17T20:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250669",
    "user": "https://github.com/nbruin"
}
```

**Commit:** [9bb9241572468d4bc0563f06fe6fffcc8b12c345](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)



---

archive/issue_comments_250670.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-11-17T20:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250670",
    "user": "https://github.com/nbruin"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_250671.json:
```json
{
    "body": "<a id='comment:3'></a>\nJust to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?",
    "created_at": "2013-11-17T21:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250671",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Just to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?



---

archive/issue_comments_250672.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [SimonKing](#comment%3A3):\n> Just to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?\n\n\nThe branch here descends directly from master, which recently had 5.13beta3 merged. Therefore, as posted, this ticket has no dependencies. Since it only touches one file, that isn't even present in the branch for #15367 (its branch split off before 5.13beta3 merger), I expect no merge problems with that ticket.\n\nI actually have a bit of trouble coming up with an example that shows a difference in behaviour for WeakValueDictionary (before this ticket it's not weakly refererrable, making examples particularly tricky). With the following code:\n\n```\n%cpaste\nimport gc\nfrom sage.misc.weak_dict import WeakValueDictionary\nfrom sage.structure.coerce_dict import MonoDict\ndef Nobj(t):\n    return len([1 for o in gc.get_objects() if isinstance(o,t)])\ndef TestTcollect(T,args=()):\n    N=Nobj(T)\n    print \"Number of T-objects before we start:\",N\n    L=[T(*args) for i in range(100)]\n    M=MonoDict(11)\n    for i in range(len(L)-1):\n        M[L[i]]=L[i+1]\n    Nnew=Nobj(T)\n    print \"Number of T-objects after list construction:\",Nnew\n    print \"Throwing away references:\"\n    del L\n    Nnew=Nobj(T)\n    if Nnew == N:\n        print \"no GC required to get rid of objects\";\n    j=0\n    while Nnew>N:\n        j+=1\n        _=gc.collect()\n        Ntemp=Nobj(T)\n        if Ntemp >= Nnew:\n            raise RuntimeError(\"we're not collecting at all!\")\n        Nnew=Ntemp\n    print \"number of collects required:\",j\nclass dd(dict):\n    \"a weakly reffable and easily recognized dict class\"\n    pass\nclass selfref(object):\n    def __init__(self):\n        self.D=self\n--\n```\nI'm getting with a self-referencing class:\n\n```\nsage: TestTcollect(selfref)\nNumber of T-objects before we start: 0\nNumber of T-objects after list construction: 100\nThrowing away references:\nnumber of collects required: 100\n```\nThe test doesn't work for dict itself (they have their own freelist etc. so\nthe object count you get back can't be trusted), but we can do it on a subclass:\n\n```\nsage: TestTcollect(dd)\nNumber of T-objects before we start: 0\nNumber of T-objects after list construction: 100\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nFor this patched `WeakValueDictionary` we're still getting problematic behaviour:\n\n```\nsage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)\nNumber of T-objects before we start: 29\nNumber of T-objects after list construction: 129\nThrowing away references:\nnumber of collects required: 100\n```\nWhereas python's own is clean:\n\n```\nsage: TestTcollect(weakref.WeakValueDictionary)\nNumber of T-objects before we start: 3\nNumber of T-objects after list construction: 103\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nAs is (at least our old) `TripleDict`:\n\n```\nsage: TestTcollect(sage.structure.coerce_dict.TripleDict,(11,))\nNumber of T-objects before we start: 180\nNumber of T-objects after list construction: 280\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nSo my guess is that we've overlooked another self reference in\nWeakValueDictionary.\n\nNote that our previous `sage.misc.weak_dict.WeakValueDictionary` wasn't weakly\nreferrable so this test doesn't apply in that case.",
    "created_at": "2013-11-17T23:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250672",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>
Replying to [SimonKing](#comment%3A3):
> Just to make sure: Is there a dependency for this ticket? It seems that we need #13394 (which is merged). But #15367 is orthogonal, isn't it?


The branch here descends directly from master, which recently had 5.13beta3 merged. Therefore, as posted, this ticket has no dependencies. Since it only touches one file, that isn't even present in the branch for #15367 (its branch split off before 5.13beta3 merger), I expect no merge problems with that ticket.

I actually have a bit of trouble coming up with an example that shows a difference in behaviour for WeakValueDictionary (before this ticket it's not weakly refererrable, making examples particularly tricky). With the following code:

```
%cpaste
import gc
from sage.misc.weak_dict import WeakValueDictionary
from sage.structure.coerce_dict import MonoDict
def Nobj(t):
    return len([1 for o in gc.get_objects() if isinstance(o,t)])
def TestTcollect(T,args=()):
    N=Nobj(T)
    print "Number of T-objects before we start:",N
    L=[T(*args) for i in range(100)]
    M=MonoDict(11)
    for i in range(len(L)-1):
        M[L[i]]=L[i+1]
    Nnew=Nobj(T)
    print "Number of T-objects after list construction:",Nnew
    print "Throwing away references:"
    del L
    Nnew=Nobj(T)
    if Nnew == N:
        print "no GC required to get rid of objects";
    j=0
    while Nnew>N:
        j+=1
        _=gc.collect()
        Ntemp=Nobj(T)
        if Ntemp >= Nnew:
            raise RuntimeError("we're not collecting at all!")
        Nnew=Ntemp
    print "number of collects required:",j
class dd(dict):
    "a weakly reffable and easily recognized dict class"
    pass
class selfref(object):
    def __init__(self):
        self.D=self
--
```
I'm getting with a self-referencing class:

```
sage: TestTcollect(selfref)
Number of T-objects before we start: 0
Number of T-objects after list construction: 100
Throwing away references:
number of collects required: 100
```
The test doesn't work for dict itself (they have their own freelist etc. so
the object count you get back can't be trusted), but we can do it on a subclass:

```
sage: TestTcollect(dd)
Number of T-objects before we start: 0
Number of T-objects after list construction: 100
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
For this patched `WeakValueDictionary` we're still getting problematic behaviour:

```
sage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)
Number of T-objects before we start: 29
Number of T-objects after list construction: 129
Throwing away references:
number of collects required: 100
```
Whereas python's own is clean:

```
sage: TestTcollect(weakref.WeakValueDictionary)
Number of T-objects before we start: 3
Number of T-objects after list construction: 103
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
As is (at least our old) `TripleDict`:

```
sage: TestTcollect(sage.structure.coerce_dict.TripleDict,(11,))
Number of T-objects before we start: 180
Number of T-objects after list construction: 280
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
So my guess is that we've overlooked another self reference in
WeakValueDictionary.

Note that our previous `sage.misc.weak_dict.WeakValueDictionary` wasn't weakly
referrable so this test doesn't apply in that case.



---

archive/issue_comments_250673.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td>[8b70d1d](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d)</td><td><code>trac #15432: also equip iteration context with a weak reference</code></td></tr></table>\n",
    "created_at": "2013-11-17T23:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250673",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td>[8b70d1d](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d)</td><td><code>trac #15432: also equip iteration context with a weak reference</code></td></tr></table>




---

archive/issue_comments_250674.json:
```json
{
    "body": "**Changing commit** from \"[9bb9241572468d4bc0563f06fe6fffcc8b12c345](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)\" to \"[8b70d1d8f68fdfe6ae020c37a43e91031c6fe952](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)\".",
    "created_at": "2013-11-17T23:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250674",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9bb9241572468d4bc0563f06fe6fffcc8b12c345](https://github.com/sagemath/sagetrac-mirror/commit/9bb9241572468d4bc0563f06fe6fffcc8b12c345)" to "[8b70d1d8f68fdfe6ae020c37a43e91031c6fe952](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)".



---

archive/issue_comments_250675.json:
```json
{
    "body": "<a id='comment:6'></a>\nAnd of course there is another circular reference from the `_IterationContext`. Making that weak as well makes the thing collectable, so with the new branch we get that `TestTcollect` works as desired.\n\nNote that if you have objects chained by keys in a `WeakValueDictionary`, immediate collectibility of the chain could depend on the WeakValueDictionary not keeping circular references to itself.\n\nSo, I think this patch could have real effect of memory footprint in sage code.",
    "created_at": "2013-11-17T23:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250675",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>
And of course there is another circular reference from the `_IterationContext`. Making that weak as well makes the thing collectable, so with the new branch we get that `TestTcollect` works as desired.

Note that if you have objects chained by keys in a `WeakValueDictionary`, immediate collectibility of the chain could depend on the WeakValueDictionary not keeping circular references to itself.

So, I think this patch could have real effect of memory footprint in sage code.



---

archive/issue_comments_250676.json:
```json
{
    "body": "**Changing commit** from \"[8b70d1d8f68fdfe6ae020c37a43e91031c6fe952](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)\" to \"[4ac686619284500adaf201c397a82a9b7409e41f](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)\".",
    "created_at": "2013-11-18T00:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250676",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8b70d1d8f68fdfe6ae020c37a43e91031c6fe952](https://github.com/sagemath/sagetrac-mirror/commit/8b70d1d8f68fdfe6ae020c37a43e91031c6fe952)" to "[4ac686619284500adaf201c397a82a9b7409e41f](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)".



---

archive/issue_comments_250677.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>\n",
    "created_at": "2013-11-18T00:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250677",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>




---

archive/issue_comments_250678.json:
```json
{
    "body": "<a id='comment:8'></a>\nIncidentally, I think we can do away with the `_IterationContext` by using a `try/finally`:\n\n```\ncython(\"\"\"\ndef gen():\n    try:\n        while True:\n            yield 1\n    finally:\n        print \"finally clause executed\"\n\"\"\")\nsage: G=gen()\nsage: G.next()\n1\nsage: del G\nfinally clause executed\nsage: G=gen()\nsage: del G  #code is never entered, so `try/finally` clause is also not encountered\n```\nSo instead of using a `with` context manager, I think we can get away with writing our iterators as\n\n```\n        cdef PyObject *key, *wr\n        cdef Py_ssize_t pos = 0\n        try:\n            self._enter_iter()\n            while PyDict_Next(self, &pos, &key, &wr):\n                #this check doesn't really say anything: by the time\n                #the key makes it to the customer, it may have already turned\n                #invalid. It's a cheap check, though.\n                if PyWeakref_GetObject(wr)!=Py_None:\n                    yield <object>key\n        finally:\n            self._exit_iter()\n```\nwhere `_enter_iter` and `_exit_iter` can be the `__enter__` and `__exit__` methods on `_IterationContext`, adapted to be methods of `WeakValueDictionary` immediately. That saves us a weakref and an extra class (see pushed commit).\n\n---\n**New commits:**\n<table><tr><td>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>\n",
    "created_at": "2013-11-18T00:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250678",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>
Incidentally, I think we can do away with the `_IterationContext` by using a `try/finally`:

```
cython("""
def gen():
    try:
        while True:
            yield 1
    finally:
        print "finally clause executed"
""")
sage: G=gen()
sage: G.next()
1
sage: del G
finally clause executed
sage: G=gen()
sage: del G  #code is never entered, so `try/finally` clause is also not encountered
```
So instead of using a `with` context manager, I think we can get away with writing our iterators as

```
        cdef PyObject *key, *wr
        cdef Py_ssize_t pos = 0
        try:
            self._enter_iter()
            while PyDict_Next(self, &pos, &key, &wr):
                #this check doesn't really say anything: by the time
                #the key makes it to the customer, it may have already turned
                #invalid. It's a cheap check, though.
                if PyWeakref_GetObject(wr)!=Py_None:
                    yield <object>key
        finally:
            self._exit_iter()
```
where `_enter_iter` and `_exit_iter` can be the `__enter__` and `__exit__` methods on `_IterationContext`, adapted to be methods of `WeakValueDictionary` immediately. That saves us a weakref and an extra class (see pushed commit).

---
**New commits:**
<table><tr><td>[4ac6866](https://github.com/sagemath/sagetrac-mirror/commit/4ac6866)</td><td><code>trac #15432: Code context manager in iterator via try/finally. This saves an entire class and some reference management.Z</code></td></tr></table>




---

archive/issue_events_051423.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15432#event-51423"
}
```



---

archive/issue_comments_250679.json:
```json
{
    "body": "**Author:** Nils Bruin",
    "created_at": "2013-12-22T17:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250679",
    "user": "https://github.com/vbraun"
}
```

**Author:** Nils Bruin



---

archive/issue_comments_250680.json:
```json
{
    "body": "<a id='comment:11'></a>\nThe code looks good, and using a cdef method instead of a Python context is very likely to be faster (I am not going to benchmark, though). I am running the tests now and will give a positive review if stuff passes.",
    "created_at": "2013-12-22T17:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250680",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>
The code looks good, and using a cdef method instead of a Python context is very likely to be faster (I am not going to benchmark, though). I am running the tests now and will give a positive review if stuff passes.



---

archive/issue_comments_250681.json:
```json
{
    "body": "<a id='comment:12'></a>\nDid I do something wrong? With the branch, I still get\n\n```\nsage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)\nNumber of T-objects before we start: 29\nNumber of T-objects after list construction: 129\nThrowing away references:\nnumber of collects required: 100\n```",
    "created_at": "2013-12-22T19:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250681",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
Did I do something wrong? With the branch, I still get

```
sage: TestTcollect(sage.misc.weak_dict.WeakValueDictionary)
Number of T-objects before we start: 29
Number of T-objects after list construction: 129
Throwing away references:
number of collects required: 100
```



---

archive/issue_comments_250682.json:
```json
{
    "body": "<a id='comment:13'></a>\nQuestion: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of \"number of collects required: 0\")?",
    "created_at": "2013-12-22T19:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250682",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of "number of collects required: 0")?



---

archive/issue_comments_250683.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [SimonKing](#comment%3A13):\n> Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of \"number of collects required: 0\")?\n\nCorrect.",
    "created_at": "2013-12-23T07:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250683",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:14'></a>
Replying to [SimonKing](#comment%3A13):
> Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of "number of collects required: 0")?

Correct.



---

archive/issue_comments_250684.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [nbruin](#comment%3A14):\n> Replying to [SimonKing](#comment%3A13):\n> > Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of \"number of collects required: 0\")?\n\n> Correct.\n\nReally? But it doesn't, see [comment:12](#comment%3A12).",
    "created_at": "2013-12-23T10:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250684",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>
Replying to [nbruin](#comment%3A14):
> Replying to [SimonKing](#comment%3A13):
> > Question: What exactly is the purpose of this ticket? Is the `TestTcollect` example supposed to be fixed (in the sense of "number of collects required: 0")?

> Correct.

Really? But it doesn't, see [comment:12](#comment%3A12).



---

archive/issue_comments_250685.json:
```json
{
    "body": "<a id='comment:16'></a>\nStrange. For whatever reason, my local version of your branch has been commit 9bb9241, not 4ac686. So, I am trying `sage --dev pull --ticket=15432` now, in the hope that it works.",
    "created_at": "2013-12-23T16:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250685",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>
Strange. For whatever reason, my local version of your branch has been commit 9bb9241, not 4ac686. So, I am trying `sage --dev pull --ticket=15432` now, in the hope that it works.



---

archive/issue_comments_250686.json:
```json
{
    "body": "<a id='comment:17'></a>\n`sage --dev checkout --ticket=15432` keeps giving me the wrong commit, by the way. What shall I do? Is `pull` the right thing to do here?",
    "created_at": "2013-12-23T16:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250686",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>
`sage --dev checkout --ticket=15432` keeps giving me the wrong commit, by the way. What shall I do? Is `pull` the right thing to do here?



---

archive/issue_comments_250687.json:
```json
{
    "body": "<a id='comment:18'></a>\nAnyway, the `sage --dev pull` was automatically merging your branch into my local version of the \"develop\" branch, and I think this is what I wanted to end up with. Now I can continue with the review.",
    "created_at": "2013-12-23T16:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250687",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
Anyway, the `sage --dev pull` was automatically merging your branch into my local version of the "develop" branch, and I think this is what I wanted to end up with. Now I can continue with the review.



---

archive/issue_comments_250688.json:
```json
{
    "body": "<a id='comment:19'></a>\nPull pulls (=fetches & merges) into the current branch, whatever that currently is.",
    "created_at": "2013-12-23T16:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250688",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
Pull pulls (=fetches & merges) into the current branch, whatever that currently is.



---

archive/issue_comments_250689.json:
```json
{
    "body": "<a id='comment:20'></a>\n`sage --dev checkout --ticket=15432` works for me, for the record.",
    "created_at": "2013-12-23T16:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250689",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>
`sage --dev checkout --ticket=15432` works for me, for the record.



---

archive/issue_comments_250690.json:
```json
{
    "body": "<a id='comment:21'></a>\nHooray! After pulling the correct commit, I get\n\n```\nsage: TestTcollect(weakref.WeakValueDictionary)\nNumber of T-objects before we start: 3\nNumber of T-objects after list construction: 103\nThrowing away references:\nno GC required to get rid of objects\nnumber of collects required: 0\n```\nand the answer came a lot faster than before. All tests pass, and the patch (i.e., the diff between the develop branch and this branch after merging with the develop branch) looks reasonable to me. \n\nHence, I can *almost* give it a positive review. How can I do a review patch? Is it possible to make some changes and then do `sage --dev push`, or what is to do for the equivalent of a review patch?",
    "created_at": "2013-12-23T20:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250690",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>
Hooray! After pulling the correct commit, I get

```
sage: TestTcollect(weakref.WeakValueDictionary)
Number of T-objects before we start: 3
Number of T-objects after list construction: 103
Throwing away references:
no GC required to get rid of objects
number of collects required: 0
```
and the answer came a lot faster than before. All tests pass, and the patch (i.e., the diff between the develop branch and this branch after merging with the develop branch) looks reasonable to me. 

Hence, I can *almost* give it a positive review. How can I do a review patch? Is it possible to make some changes and then do `sage --dev push`, or what is to do for the equivalent of a review patch?



---

archive/issue_comments_250691.json:
```json
{
    "body": "**Reviewer:** Simon King",
    "created_at": "2013-12-23T20:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250691",
    "user": "https://github.com/simon-king-jena"
}
```

**Reviewer:** Simon King



---

archive/issue_comments_250692.json:
```json
{
    "body": "<a id='comment:22'></a>\nPS: Shall I revert the merge with the develop branch before creating the review \"patch\"?",
    "created_at": "2013-12-23T20:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250692",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>
PS: Shall I revert the merge with the develop branch before creating the review "patch"?



---

archive/issue_comments_250693.json:
```json
{
    "body": "<a id='comment:23'></a>\nYes to both.\n* If you made an unnecessary merge, revert it first (`git reset --hard HEAD~`) \n* for your review patch you just add another commit and then replace the branch (either manually with git or with `sage -dev push`)",
    "created_at": "2013-12-23T20:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250693",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>
Yes to both.
* If you made an unnecessary merge, revert it first (`git reset --hard HEAD~`) 
* for your review patch you just add another commit and then replace the branch (either manually with git or with `sage -dev push`)



---

archive/issue_comments_250694.json:
```json
{
    "body": "<a id='comment:24'></a>\nHow can I do the job without the dev script? I.e., how to do it manually with git?",
    "created_at": "2013-12-23T20:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250694",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>
How can I do the job without the dev script? I.e., how to do it manually with git?



---

archive/issue_comments_250695.json:
```json
{
    "body": "<a id='comment:25'></a>\n* edit\n* `git add <filename>`\n* `git commit -m 'commit message'`\n* `git push trac HEAD:u/SimonKing/weak_callback`\n\nSee also the developer guide (in Sage, not the old one that is still on www.sagemath.org)",
    "created_at": "2013-12-23T20:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250695",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>
* edit
* `git add <filename>`
* `git commit -m 'commit message'`
* `git push trac HEAD:u/SimonKing/weak_callback`

See also the developer guide (in Sage, not the old one that is still on www.sagemath.org)



---

archive/issue_comments_250696.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [vbraun](#comment%3A25):\n> * edit\n> * `git add <filename>`\n> * `git commit -m 'commit message'`\n> * `git push trac HEAD:u/SimonKing/weak_callback`\n> \n> See also the developer guide (in Sage, not the old one that is still on www.sagemath.org)\n\n\nThank you! I already found the guide (but I did `git push --set-upstream trac HEAD:u/SimonKing/ticket/15432`, hope this is fine, too). It takes rather long to complete, though.",
    "created_at": "2013-12-23T20:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250696",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:26'></a>
Replying to [vbraun](#comment%3A25):
> * edit
> * `git add <filename>`
> * `git commit -m 'commit message'`
> * `git push trac HEAD:u/SimonKing/weak_callback`
> 
> See also the developer guide (in Sage, not the old one that is still on www.sagemath.org)


Thank you! I already found the guide (but I did `git push --set-upstream trac HEAD:u/SimonKing/ticket/15432`, hope this is fine, too). It takes rather long to complete, though.



---

archive/issue_comments_250697.json:
```json
{
    "body": "**Changing commit** from \"[4ac686619284500adaf201c397a82a9b7409e41f](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)\" to \"[13112a9a5b664bcbd467cc6c9b197ae809ab44fb](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)\".",
    "created_at": "2013-12-23T20:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250697",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing commit** from "[4ac686619284500adaf201c397a82a9b7409e41f](https://github.com/sagemath/sagetrac-mirror/commit/4ac686619284500adaf201c397a82a9b7409e41f)" to "[13112a9a5b664bcbd467cc6c9b197ae809ab44fb](https://github.com/sagemath/sagetrac-mirror/commit/13112a9a5b664bcbd467cc6c9b197ae809ab44fb)".



---

archive/issue_comments_250698.json:
```json
{
    "body": "**Changing branch** from \"[u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)\" to \"[u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432)\".",
    "created_at": "2013-12-23T20:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250698",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing branch** from "[u/nbruin/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/ticket/15432)" to "[u/SimonKing/ticket/15432](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/ticket/15432)".



---

archive/issue_comments_250699.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-12-23T20:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250699",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_051424.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-24T20:24:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15432#event-51424"
}
```



---

archive/issue_comments_250700.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2013-12-24T20:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15432#issuecomment-250700",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed
