# Issue 15618: Use the correct categories for coercion and conversion maps

archive/issues_015381.json:
```json
{
    "body": "The following examples show that some convert_maps are incorrectly assumed to be homomorphisms:\n\n```\nsage: f = ZZ.convert_map_from(QQ)\nsage: f.parent()\nSet of Homomorphisms from Rational Field to Integer Ring\n```\n\n```\nsage: f = ZZ.convert_map_from(GF(2))\nsage: f.parent() \nSet of field embeddings from Finite Field of size 2 to Integer Ring\n```\n\n```\nsage: f = GF(11).convert_map_from(GF(7))\nsage: f\nConversion map:\n  From: Finite Field of size 7\n  To:   Finite Field of size 11\nsage: f.parent()\nSet of field embeddings from Finite Field of size 7 to Finite Field of size 11\n```\nThis has the effect of constructing an element of a set that is in fact empty.  A conversion map should in general only be a morphisms in the category of sets with partial maps, because it is not necessarily defined everywhere.  (In case it *is* defined everywhere, it may of course be placed in the category of sets.)\n\nThis ticket fixes the problem in two steps:\n- use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;\n- make internal (\"reference-weakened\") coercion and conversion maps remember their category (the fact that this didn't work was revealed by the above change).\n\nSee also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms\n\n\nCC:  jpflori simonking @JohnCremona @nthiery\n\nKeywords: conversion map\n\nReviewer: Jean-Pierre Flori, Nils Bruin\n\nAuthor: Peter Bruin\n\nBranch: 54a6ecae11f902b11ad651c67af021af6ed2da21\n\nDependencies: #16401, #16402, #17364\n\nCommit: 54a6ecae11f902b11ad651c67af021af6ed2da21\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15618\n\n",
    "closed_at": "2014-12-15T17:50:49Z",
    "created_at": "2014-01-02T00:26:45Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Use the correct categories for coercion and conversion maps",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15618",
    "user": "https://github.com/pjbruin"
}
```
The following examples show that some convert_maps are incorrectly assumed to be homomorphisms:

```
sage: f = ZZ.convert_map_from(QQ)
sage: f.parent()
Set of Homomorphisms from Rational Field to Integer Ring
```

```
sage: f = ZZ.convert_map_from(GF(2))
sage: f.parent() 
Set of field embeddings from Finite Field of size 2 to Integer Ring
```

```
sage: f = GF(11).convert_map_from(GF(7))
sage: f
Conversion map:
  From: Finite Field of size 7
  To:   Finite Field of size 11
sage: f.parent()
Set of field embeddings from Finite Field of size 7 to Finite Field of size 11
```
This has the effect of constructing an element of a set that is in fact empty.  A conversion map should in general only be a morphisms in the category of sets with partial maps, because it is not necessarily defined everywhere.  (In case it *is* defined everywhere, it may of course be placed in the category of sets.)

This ticket fixes the problem in two steps:
- use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;
- make internal ("reference-weakened") coercion and conversion maps remember their category (the fact that this didn't work was revealed by the above change).

See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms


CC:  jpflori simonking @JohnCremona @nthiery

Keywords: conversion map

Reviewer: Jean-Pierre Flori, Nils Bruin

Author: Peter Bruin

Branch: 54a6ecae11f902b11ad651c67af021af6ed2da21

Dependencies: #16401, #16402, #17364

Commit: 54a6ecae11f902b11ad651c67af021af6ed2da21

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15618





---

archive/issue_events_045727.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15618#event-45727"
}
```



---

archive/issue_comments_198129.json:
```json
{
    "body": "<a id='comment:3'></a>In the attached branch, I tried to make `DefaultConvertMap` return a morphism in the category of schemes with partial maps.  Unfortunately, a recent change in #14711 (where certain references in the coercion system were made into weak references) makes the map forget its parent `Homset`, and hence in which category it lives.\n\nExample (cf. the code producing the debugging output):\n\n```\nsage: ZZ.convert_map_from(CC)\nold parent = Set of Morphisms from Complex Field with 53 bits of precision to Integer Ring in Category of sets with partial maps\nnew parent = Set of Homomorphisms from Complex Field with 53 bits of precision to Integer Ring\nConversion map:\n  From: Complex Field with 53 bits of precision\n  To:   Integer Ring\n```",
    "created_at": "2014-04-22T22:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198129",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:3'></a>In the attached branch, I tried to make `DefaultConvertMap` return a morphism in the category of schemes with partial maps.  Unfortunately, a recent change in #14711 (where certain references in the coercion system were made into weak references) makes the map forget its parent `Homset`, and hence in which category it lives.

Example (cf. the code producing the debugging output):

```
sage: ZZ.convert_map_from(CC)
old parent = Set of Morphisms from Complex Field with 53 bits of precision to Integer Ring in Category of sets with partial maps
new parent = Set of Homomorphisms from Complex Field with 53 bits of precision to Integer Ring
Conversion map:
  From: Complex Field with 53 bits of precision
  To:   Integer Ring
```



---

archive/issue_events_045728.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15618#event-45728"
}
```



---

archive/issue_events_045729.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15618#event-45729"
}
```



---

archive/issue_comments_198130.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-05-09T10:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198130",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_198131.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2014-05-09T10:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198131",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_198132.json:
```json
{
    "body": "<a id='comment:6'></a>Basically works, needs documentation and there are various failing doctests.",
    "created_at": "2014-05-09T10:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198132",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:6'></a>Basically works, needs documentation and there are various failing doctests.



---

archive/issue_comments_198133.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-09T19:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198133",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198134.json:
```json
{
    "body": "<a id='comment:8'></a>Remaining doctest failures (the first is due to #16311):\n\n```\nsage -t --long src/sage/structure/sage_object.pyx  # 1 doctest failed\nsage -t --long src/sage/groups/additive_abelian/additive_abelian_wrapper.py  # 2 doctests failed\n```",
    "created_at": "2014-05-09T19:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198134",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:8'></a>Remaining doctest failures (the first is due to #16311):

```
sage -t --long src/sage/structure/sage_object.pyx  # 1 doctest failed
sage -t --long src/sage/groups/additive_abelian/additive_abelian_wrapper.py  # 2 doctests failed
```



---

archive/issue_comments_198135.json:
```json
{
    "body": "<a id='comment:9'></a>This dependency is needed to get the category right for finite field embeddings.",
    "created_at": "2014-05-26T13:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198135",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:9'></a>This dependency is needed to get the category right for finite field embeddings.



---

archive/issue_comments_198136.json:
```json
{
    "body": "<a id='comment:10'></a>Needed to get the category right for homesets whose domain is a FGP_Module.",
    "created_at": "2014-05-26T22:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198136",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:10'></a>Needed to get the category right for homesets whose domain is a FGP_Module.



---

archive/issue_comments_198137.json:
```json
{
    "body": "<a id='comment:11'></a>After #16401 and #16402, the only remaining problem is an unpickling failure of 3 old pickles:\n\n```\nFile \"src/sage/structure/sage_object.pyx\", line 1346, in sage.structure.sage_object.unpickle_all\nFailed example:\n    sage.structure.sage_object.unpickle_all()  # (4s on sage.math, 2011)\nExpected:\n    doctest:... DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.\n    See http://trac.sagemath.org/4260 for details.\n    Successfully unpickled ... objects.\n    Failed to unpickle 0 objects.\nGot:\n    doctest:1: DeprecationWarning: OrderedAlphabet is deprecated; use Alphabet instead.\n    See http://trac.sagemath.org/8920 for details.\n    doctest:839: DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.\n    See http://trac.sagemath.org/4260 for details.\n     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj')\n     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_cover__.sobj')\n     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj')\n    Failed:\n    _class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj\n    _type__sage_rings_morphism_RingHomomorphism_cover__.sobj\n    _type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj\n    ----------------------------------------------------------------------\n    ** This error is probably due to an old pickle failing to unpickle.\n    ** See sage.structure.sage_object.register_unpickle_override for\n    ** how to override the default unpickling methods for (old) pickles.\n    ** NOTE: pickles should never be removed from the pickle_jar!\n    ----------------------------------------------------------------------\n    Successfully unpickled 583 objects.\n    Failed to unpickle 3 objects.\n```",
    "created_at": "2014-05-26T23:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198137",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:11'></a>After #16401 and #16402, the only remaining problem is an unpickling failure of 3 old pickles:

```
File "src/sage/structure/sage_object.pyx", line 1346, in sage.structure.sage_object.unpickle_all
Failed example:
    sage.structure.sage_object.unpickle_all()  # (4s on sage.math, 2011)
Expected:
    doctest:... DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    See http://trac.sagemath.org/4260 for details.
    Successfully unpickled ... objects.
    Failed to unpickle 0 objects.
Got:
    doctest:1: DeprecationWarning: OrderedAlphabet is deprecated; use Alphabet instead.
    See http://trac.sagemath.org/8920 for details.
    doctest:839: DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    See http://trac.sagemath.org/4260 for details.
     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj')
     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_cover__.sobj')
     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj')
    Failed:
    _class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj
    _type__sage_rings_morphism_RingHomomorphism_cover__.sobj
    _type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj
    ----------------------------------------------------------------------
    ** This error is probably due to an old pickle failing to unpickle.
    ** See sage.structure.sage_object.register_unpickle_override for
    ** how to override the default unpickling methods for (old) pickles.
    ** NOTE: pickles should never be removed from the pickle_jar!
    ----------------------------------------------------------------------
    Successfully unpickled 583 objects.
    Failed to unpickle 3 objects.
```



---

archive/issue_comments_198138.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-27T01:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198138",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198139.json:
```json
{
    "body": "<a id='comment:13'></a>The new commit solves the unpickling problem, all tests now pass.  (The pickles weren't necessarily broken, my patch was trying to access the category of partially-unpickled homsets.)",
    "created_at": "2014-05-27T01:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198139",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>The new commit solves the unpickling problem, all tests now pass.  (The pickles weren't necessarily broken, my patch was trying to access the category of partially-unpickled homsets.)



---

archive/issue_comments_198140.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-27T12:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198140",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198141.json:
```json
{
    "body": "<a id='comment:15'></a>Note to reviewer(s): the branches of the dependencies (#16401, #16402) are not merged in this branch.",
    "created_at": "2014-05-27T12:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198141",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:15'></a>Note to reviewer(s): the branches of the dependencies (#16401, #16402) are not merged in this branch.



---

archive/issue_comments_198142.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-05-27T12:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198142",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_198143.json:
```json
{
    "body": "<a id='comment:16'></a>In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.\n\nThe alternative branch (including #16401 and #16402) is\n`u/pbruin/15618-convert_map_category` ([diff](http://git.sagemath.org/sage.git/diff/?id2=a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3&id=25198d0723bd1355c6d40bb275126dc2bb8d61ad), [commits](http://git.sagemath.org/sage.git/log/?h=25198d0723bd1355c6d40bb275126dc2bb8d61ad&qt=range&q=a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3..25198d0723bd1355c6d40bb275126dc2bb8d61ad)).",
    "created_at": "2014-05-27T21:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198143",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:16'></a>In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.

The alternative branch (including #16401 and #16402) is
`u/pbruin/15618-convert_map_category` ([diff](http://git.sagemath.org/sage.git/diff/?id2=a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3&id=25198d0723bd1355c6d40bb275126dc2bb8d61ad), [commits](http://git.sagemath.org/sage.git/log/?h=25198d0723bd1355c6d40bb275126dc2bb8d61ad&qt=range&q=a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3..25198d0723bd1355c6d40bb275126dc2bb8d61ad)).



---

archive/issue_comments_198144.json:
```json
{
    "body": "<a id='comment:17'></a>The dependencies are merged in this branch, for the benefit of reviewers and the patchbot.  The current branch is now simply one commit behind the branch `u/pbruin/15618-convert_map_category` of comment:16.",
    "created_at": "2014-05-31T18:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198144",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:17'></a>The dependencies are merged in this branch, for the benefit of reviewers and the patchbot.  The current branch is now simply one commit behind the branch `u/pbruin/15618-convert_map_category` of comment:16.



---

archive/issue_events_045730.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15618#event-45730"
}
```



---

archive/issue_events_045731.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15618#event-45731"
}
```



---

archive/issue_comments_198145.json:
```json
{
    "body": "<a id='comment:19'></a>(Setting the branch back to `u/pbruin/15618-DefaultConvertMap` since the dependencies have now been merged into `develop` and the previous branch would not merge automatically.)",
    "created_at": "2014-11-17T11:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198145",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>(Setting the branch back to `u/pbruin/15618-DefaultConvertMap` since the dependencies have now been merged into `develop` and the previous branch would not merge automatically.)



---

archive/issue_comments_198146.json:
```json
{
    "body": "<a id='comment:20'></a>This looks like an improvement to me.\n\nBut it gives me a bunch of failures (on top of 6.5.beta0):\n\n```\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/homset.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/scheme.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/projective/projective_homset.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/spec.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/morphism.py  # 19 doctests failed\nsage -t --long --warn-long 156.2 src/sage/schemes/affine/affine_homset.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/categories/schemes.py  # 4 doctests failed\n```",
    "created_at": "2014-11-17T14:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198146",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:20'></a>This looks like an improvement to me.

But it gives me a bunch of failures (on top of 6.5.beta0):

```
sage -t --long --warn-long 156.2 src/sage/schemes/generic/homset.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/generic/scheme.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/projective/projective_homset.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/generic/spec.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/generic/morphism.py  # 19 doctests failed
sage -t --long --warn-long 156.2 src/sage/schemes/affine/affine_homset.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/categories/schemes.py  # 4 doctests failed
```



---

archive/issue_comments_198147.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-11-17T14:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198147",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_198148.json:
```json
{
    "body": "<a id='comment:21'></a>All errors seem to be of the following form:\n\n```\nf = S(g)\n...\nValueError: Set of morphisms\n      From: Spectrum of ...\n      To:   Spectrum of ... is not in Category of sets with partial maps\n```",
    "created_at": "2014-11-17T16:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198148",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:21'></a>All errors seem to be of the following form:

```
f = S(g)
...
ValueError: Set of morphisms
      From: Spectrum of ...
      To:   Spectrum of ... is not in Category of sets with partial maps
```



---

archive/issue_comments_198149.json:
```json
{
    "body": "<a id='comment:22'></a>I guess #10668 is the culprit.\n\n`@`Nicolas: any trivial fix for this?",
    "created_at": "2014-11-17T16:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198149",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:22'></a>I guess #10668 is the culprit.

`@`Nicolas: any trivial fix for this?



---

archive/issue_comments_198150.json:
```json
{
    "body": "<a id='comment:23'></a>The problem seems to be that the category `Schemes().Homsets()` does not have `Sets()` as a supercategory:\n\n```\nsage: Sets().Homsets().all_super_categories()\n[Category of homsets of sets,\n Category of homsets,\n Category of sets,\n Category of sets with partial maps,\n Category of objects]\nsage: Schemes().Homsets().all_super_categories()\n[Category of homsets of schemes,\n Category of objects]\n```",
    "created_at": "2014-11-17T18:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198150",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:23'></a>The problem seems to be that the category `Schemes().Homsets()` does not have `Sets()` as a supercategory:

```
sage: Sets().Homsets().all_super_categories()
[Category of homsets of sets,
 Category of homsets,
 Category of sets,
 Category of sets with partial maps,
 Category of objects]
sage: Schemes().Homsets().all_super_categories()
[Category of homsets of schemes,
 Category of objects]
```



---

archive/issue_comments_198151.json:
```json
{
    "body": "<a id='comment:24'></a>I kind of think the same thing.\n\nFor sure, also getting Nicolas' mind would be helpful :)",
    "created_at": "2014-11-17T19:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198151",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:24'></a>I kind of think the same thing.

For sure, also getting Nicolas' mind would be helpful :)



---

archive/issue_comments_198152.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-11-17T20:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198152",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198153.json:
```json
{
    "body": "<a id='comment:26'></a>The last commit seems to fix the bugs.\n\nNicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?",
    "created_at": "2014-11-17T20:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198153",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:26'></a>The last commit seems to fix the bugs.

Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?



---

archive/issue_comments_198154.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-11-17T20:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198154",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198155.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-11-17T20:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198155",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_198156.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-11-17T21:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198156",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_198157.json:
```json
{
    "body": "<a id='comment:30'></a>I think it is better to solve that problem on a new ticket.  This is now #17359.",
    "created_at": "2014-11-17T21:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198157",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:30'></a>I think it is better to solve that problem on a new ticket.  This is now #17359.



---

archive/issue_comments_198158.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:16 pbruin]:\n> In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.\n\nSince the alternative branch `u/pbruin/15618-convert_map_category` may still be relevant (to prevent potential memory leaks), I rebased it ([diff](http://git.sagemath.org/sage.git/diff/?id2=4cd153a457b2b47ee4fefe64d305d04c6c5f39a6&id=b2b22ea6eefe5754a05ca866931f5725918a466b), [commits](http://git.sagemath.org/sage.git/log/?q=4cd153a457b2b47ee4fefe64d305d04c6c5f39a6..b2b22ea6eefe5754a05ca866931f5725918a466b&h=b2b22ea6eefe5754a05ca866931f5725918a466b&qt=range)).",
    "created_at": "2014-11-17T22:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198158",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:31'></a>Replying to [comment:16 pbruin]:
> In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.

Since the alternative branch `u/pbruin/15618-convert_map_category` may still be relevant (to prevent potential memory leaks), I rebased it ([diff](http://git.sagemath.org/sage.git/diff/?id2=4cd153a457b2b47ee4fefe64d305d04c6c5f39a6&id=b2b22ea6eefe5754a05ca866931f5725918a466b), [commits](http://git.sagemath.org/sage.git/log/?q=4cd153a457b2b47ee4fefe64d305d04c6c5f39a6..b2b22ea6eefe5754a05ca866931f5725918a466b&h=b2b22ea6eefe5754a05ca866931f5725918a466b&qt=range)).



---

archive/issue_comments_198159.json:
```json
{
    "body": "<a id='comment:32'></a>Just this line:\n\n```\nif category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))\n```\nis a memory leak:\n\n```\nsage: import gc\nsage: from collections import Counter\nsage: gc.collect()\n93\nsage: pre={id(a) for a in gc.get_objects()}\nsage: \nsage: for p in prime_range(20000):\n....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))\n....:     \nsage: gc.collect()\n0\nsage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)\nsage: post\nCounter({\"<type 'tuple'>\": 314633, \"<type 'dict'>\": 106360, \"<type 'list'>\": 88464, \"<type 'cell'>\": 67894, \"<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>\": 52032, \"<type 'weakref'>\": 40733, \"<class 'weakref.KeyedRef'>\": 36193, \"<type 'function'>\": 33947, \"<type 'staticmethod'>\": 33947, \"<type 'builtin_function_or_method'>\": 33938, \"<type 'sage.misc.cachefunc.CachedMethodCaller'>\": 33937, \"<type 'frozenset'>\": 33933, \"<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>\": 33932, \"<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>\": 25868, \"<type 'sage.structure.coerce_dict.MonoDict'>\": 4522, \"<type 'sage.structure.coerce_dict.MonoDictEraser'>\": 4522, \"<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.bimodules.Bimodules_with_category'>\": 2262, \"<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras.Algebras_with_category'>\": 2262, \"<class 'sage.categories.left_modules.LeftModules_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>\": 2262, \"<class 'sage.categories.right_modules.RightModules_with_category'>\": 2262, \"<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>\": 2262, \"<class 'sage.categories.modules.Modules_with_category'>\": 2262, \"<type 'sage.structure.coerce_dict.TripleDict'>\": 2261, \"<class 'sage.rings.ideal.Ideal_pid'>\": 2261, \"<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>\": 2261, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>\": 2261, \"<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>\": 2261, \"<type 'sage.structure.coerce_dict.TripleDictEraser'>\": 2261, \"<type 'instancemethod'>\": 2261, \"<class 'sage.structure.dynamic_class.DynamicMetaclass'>\": 15, \"<class '_ast.Call'>\": 3, \"<type 'sage.misc.constant_function.ConstantFunction'>\": 2, \"<class '_ast.Name'>\": 2, \"<type 'frame'>\": 1, \"<type 'set'>\": 1, \"<class '_ast.comprehension'>\": 1, \"<class '_ast.Interactive'>\": 1, \"<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>\": 1, \"<class '_ast.Module'>\": 1, \"<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>\": 1, \"<type 'listiterator'>\": 1, \"<type 'generator'>\": 1, \"<class '_ast.Assign'>\": 1, \"<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>\": 1})\n```\nThe problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:\n\n```\nsage: GF(3)['x'].category()\nJoin of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)\n```\n(as you can see, the category doesn't explicitly link to `GF(3)` anymore)\nAdmittedly:\n\n```\nsage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()\nCategory of finite dimensional algebras with basis over Finite Field of size 3\n```\nso the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.",
    "created_at": "2014-11-17T23:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198159",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:32'></a>Just this line:

```
if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))
```
is a memory leak:

```
sage: import gc
sage: from collections import Counter
sage: gc.collect()
93
sage: pre={id(a) for a in gc.get_objects()}
sage: 
sage: for p in prime_range(20000):
....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))
....:     
sage: gc.collect()
0
sage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)
sage: post
Counter({"<type 'tuple'>": 314633, "<type 'dict'>": 106360, "<type 'list'>": 88464, "<type 'cell'>": 67894, "<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>": 52032, "<type 'weakref'>": 40733, "<class 'weakref.KeyedRef'>": 36193, "<type 'function'>": 33947, "<type 'staticmethod'>": 33947, "<type 'builtin_function_or_method'>": 33938, "<type 'sage.misc.cachefunc.CachedMethodCaller'>": 33937, "<type 'frozenset'>": 33933, "<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>": 33932, "<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>": 25868, "<type 'sage.structure.coerce_dict.MonoDict'>": 4522, "<type 'sage.structure.coerce_dict.MonoDictEraser'>": 4522, "<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>": 2262, "<class 'sage.categories.bimodules.Bimodules_with_category'>": 2262, "<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.algebras.Algebras_with_category'>": 2262, "<class 'sage.categories.left_modules.LeftModules_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>": 2262, "<class 'sage.categories.right_modules.RightModules_with_category'>": 2262, "<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>": 2262, "<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>": 2262, "<class 'sage.categories.modules.Modules_with_category'>": 2262, "<type 'sage.structure.coerce_dict.TripleDict'>": 2261, "<class 'sage.rings.ideal.Ideal_pid'>": 2261, "<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>": 2261, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>": 2261, "<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>": 2261, "<type 'sage.structure.coerce_dict.TripleDictEraser'>": 2261, "<type 'instancemethod'>": 2261, "<class 'sage.structure.dynamic_class.DynamicMetaclass'>": 15, "<class '_ast.Call'>": 3, "<type 'sage.misc.constant_function.ConstantFunction'>": 2, "<class '_ast.Name'>": 2, "<type 'frame'>": 1, "<type 'set'>": 1, "<class '_ast.comprehension'>": 1, "<class '_ast.Interactive'>": 1, "<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>": 1, "<class '_ast.Module'>": 1, "<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>": 1, "<type 'listiterator'>": 1, "<type 'generator'>": 1, "<class '_ast.Assign'>": 1, "<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>": 1})
```
The problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:

```
sage: GF(3)['x'].category()
Join of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)
```
(as you can see, the category doesn't explicitly link to `GF(3)` anymore)
Admittedly:

```
sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()
Category of finite dimensional algebras with basis over Finite Field of size 3
```
so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.



---

archive/issue_comments_198160.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:26 pbruin]:\n> The last commit seems to fix the bugs.\n> \n> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?\n\nThanks for cc'ing Nicolas as I forgot to do so!",
    "created_at": "2014-11-18T08:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198160",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:33'></a>Replying to [comment:26 pbruin]:
> The last commit seems to fix the bugs.
> 
> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?

Thanks for cc'ing Nicolas as I forgot to do so!



---

archive/issue_comments_198161.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:32 nbruin]:\n> Just this line:\n> \n> ```\n> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))\n> ```\n> is a memory leak:\n> \n> ```\n> sage: import gc\n> sage: from collections import Counter\n> sage: gc.collect()\n> 93\n> sage: pre={id(a) for a in gc.get_objects()}\n> sage: \n> sage: for p in prime_range(20000):\n> ....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))\n> ....:     \n> sage: gc.collect()\n> 0\n> sage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)\n> sage: post\n> Counter({\"<type 'tuple'>\": 314633, \"<type 'dict'>\": 106360, \"<type 'list'>\": 88464, \"<type 'cell'>\": 67894, \"<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>\": 52032, \"<type 'weakref'>\": 40733, \"<class 'weakref.KeyedRef'>\": 36193, \"<type 'function'>\": 33947, \"<type 'staticmethod'>\": 33947, \"<type 'builtin_function_or_method'>\": 33938, \"<type 'sage.misc.cachefunc.CachedMethodCaller'>\": 33937, \"<type 'frozenset'>\": 33933, \"<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>\": 33932, \"<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>\": 25868, \"<type 'sage.structure.coerce_dict.MonoDict'>\": 4522, \"<type 'sage.structure.coerce_dict.MonoDictEraser'>\": 4522, \"<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.bimodules.Bimodules_with_category'>\": 2262, \"<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras.Algebras_with_category'>\": 2262, \"<class 'sage.categories.left_modules.LeftModules_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>\": 2262, \"<class 'sage.categories.right_modules.RightModules_with_category'>\": 2262, \"<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>\": 2262, \"<class 'sage.categories.modules.Modules_with_category'>\": 2262, \"<type 'sage.structure.coerce_dict.TripleDict'>\": 2261, \"<class 'sage.rings.ideal.Ideal_pid'>\": 2261, \"<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>\": 2261, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>\": 2261, \"<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>\": 2261, \"<type 'sage.structure.coerce_dict.TripleDictEraser'>\": 2261, \"<type 'instancemethod'>\": 2261, \"<class 'sage.structure.dynamic_class.DynamicMetaclass'>\": 15, \"<class '_ast.Call'>\": 3, \"<type 'sage.misc.constant_function.ConstantFunction'>\": 2, \"<class '_ast.Name'>\": 2, \"<type 'frame'>\": 1, \"<type 'set'>\": 1, \"<class '_ast.comprehension'>\": 1, \"<class '_ast.Interactive'>\": 1, \"<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>\": 1, \"<class '_ast.Module'>\": 1, \"<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>\": 1, \"<type 'listiterator'>\": 1, \"<type 'generator'>\": 1, \"<class '_ast.Assign'>\": 1, \"<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>\": 1})\n> ```\n> The problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:\n> \n> ```\n> sage: GF(3)['x'].category()\n> Join of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)\n> ```\n> (as you can see, the category doesn't explicitly link to `GF(3)` anymore)\n> Admittedly:\n> \n> ```\n> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()\n> Category of finite dimensional algebras with basis over Finite Field of size 3\n> ```\n> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.\n\nFor clarity, I would suggest to open another ticket for that.\nAnd make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)",
    "created_at": "2014-11-18T08:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198161",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:34'></a>Replying to [comment:32 nbruin]:
> Just this line:
> 
> ```
> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))
> ```
> is a memory leak:
> 
> ```
> sage: import gc
> sage: from collections import Counter
> sage: gc.collect()
> 93
> sage: pre={id(a) for a in gc.get_objects()}
> sage: 
> sage: for p in prime_range(20000):
> ....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))
> ....:     
> sage: gc.collect()
> 0
> sage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)
> sage: post
> Counter({"<type 'tuple'>": 314633, "<type 'dict'>": 106360, "<type 'list'>": 88464, "<type 'cell'>": 67894, "<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>": 52032, "<type 'weakref'>": 40733, "<class 'weakref.KeyedRef'>": 36193, "<type 'function'>": 33947, "<type 'staticmethod'>": 33947, "<type 'builtin_function_or_method'>": 33938, "<type 'sage.misc.cachefunc.CachedMethodCaller'>": 33937, "<type 'frozenset'>": 33933, "<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>": 33932, "<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>": 25868, "<type 'sage.structure.coerce_dict.MonoDict'>": 4522, "<type 'sage.structure.coerce_dict.MonoDictEraser'>": 4522, "<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>": 2262, "<class 'sage.categories.bimodules.Bimodules_with_category'>": 2262, "<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.algebras.Algebras_with_category'>": 2262, "<class 'sage.categories.left_modules.LeftModules_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>": 2262, "<class 'sage.categories.right_modules.RightModules_with_category'>": 2262, "<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>": 2262, "<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>": 2262, "<class 'sage.categories.modules.Modules_with_category'>": 2262, "<type 'sage.structure.coerce_dict.TripleDict'>": 2261, "<class 'sage.rings.ideal.Ideal_pid'>": 2261, "<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>": 2261, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>": 2261, "<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>": 2261, "<type 'sage.structure.coerce_dict.TripleDictEraser'>": 2261, "<type 'instancemethod'>": 2261, "<class 'sage.structure.dynamic_class.DynamicMetaclass'>": 15, "<class '_ast.Call'>": 3, "<type 'sage.misc.constant_function.ConstantFunction'>": 2, "<class '_ast.Name'>": 2, "<type 'frame'>": 1, "<type 'set'>": 1, "<class '_ast.comprehension'>": 1, "<class '_ast.Interactive'>": 1, "<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>": 1, "<class '_ast.Module'>": 1, "<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>": 1, "<type 'listiterator'>": 1, "<type 'generator'>": 1, "<class '_ast.Assign'>": 1, "<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>": 1})
> ```
> The problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:
> 
> ```
> sage: GF(3)['x'].category()
> Join of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)
> ```
> (as you can see, the category doesn't explicitly link to `GF(3)` anymore)
> Admittedly:
> 
> ```
> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()
> Category of finite dimensional algebras with basis over Finite Field of size 3
> ```
> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.

For clarity, I would suggest to open another ticket for that.
And make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)



---

archive/issue_comments_198162.json:
```json
{
    "body": "<a id='comment:35'></a>Unless it's solved by Peter's alternative branch of course.",
    "created_at": "2014-11-18T09:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198162",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:35'></a>Unless it's solved by Peter's alternative branch of course.



---

archive/issue_comments_198163.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:34 jpflori]:\n> For clarity, I would suggest to open another ticket for that.\n> And make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)\n\n\nPerhaps use #17360 for that. Please do glance through the rest of your code to check if similar changes are warranted (which can then be implemented either here, on #17360, or another follow-on ticket)",
    "created_at": "2014-11-18T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198163",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:36'></a>Replying to [comment:34 jpflori]:
> For clarity, I would suggest to open another ticket for that.
> And make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)


Perhaps use #17360 for that. Please do glance through the rest of your code to check if similar changes are warranted (which can then be implemented either here, on #17360, or another follow-on ticket)



---

archive/issue_comments_198164.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:26 pbruin]:\n> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.\n\n\nCool.\n\n> However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?\n\n\nThanks for spotting this as this was a bug. See #17364.",
    "created_at": "2014-11-18T15:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198164",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:37'></a>Replying to [comment:26 pbruin]:
> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.


Cool.

> However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?


Thanks for spotting this as this was a bug. See #17364.



---

archive/issue_comments_198165.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:32 nbruin]:\n> Just this line:\n> \n> ```\n> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))\n> ```\n> is a memory leak:\n\n[...]\n> Admittedly:\n> \n> ```\n> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()\n> Category of finite dimensional algebras with basis over Finite Field of size 3\n> ```\n> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.\n\n\nThis change is necessary because otherwise we get errors if the provided `category` (which is `SetsWithPartialMaps()` in some cases) is not a subcategory of `FiniteDimensionalAlgebrasWithBasis(self.base_ring())`.  Logically, the choice whether the homset should be of type `FiniteDimensionalAlgebraHomset` should depend on the category, not vice versa.\n\nThis ticket does not make the memory leak (much) worse, because in most cases `B` will be a `FiniteDimensionalAlgebra` anyway, in which case the same category is constructed.\n\nI also tested (using your example and in addition constructing `A.coerce_map_from(GF(p))` for each `A` in the loop) that the current branch does not cause additional memory leaks, and that the existing leak is fixed by #17360 both before and after applying my branch.  Thus the alternative branch (comment:31) doesn't seem to be needed.",
    "created_at": "2014-11-21T11:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198165",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:39'></a>Replying to [comment:32 nbruin]:
> Just this line:
> 
> ```
> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))
> ```
> is a memory leak:

[...]
> Admittedly:
> 
> ```
> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()
> Category of finite dimensional algebras with basis over Finite Field of size 3
> ```
> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.


This change is necessary because otherwise we get errors if the provided `category` (which is `SetsWithPartialMaps()` in some cases) is not a subcategory of `FiniteDimensionalAlgebrasWithBasis(self.base_ring())`.  Logically, the choice whether the homset should be of type `FiniteDimensionalAlgebraHomset` should depend on the category, not vice versa.

This ticket does not make the memory leak (much) worse, because in most cases `B` will be a `FiniteDimensionalAlgebra` anyway, in which case the same category is constructed.

I also tested (using your example and in addition constructing `A.coerce_map_from(GF(p))` for each `A` in the loop) that the current branch does not cause additional memory leaks, and that the existing leak is fixed by #17360 both before and after applying my branch.  Thus the alternative branch (comment:31) doesn't seem to be needed.



---

archive/issue_comments_198166.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-12-08T10:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198166",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_198167.json:
```json
{
    "body": "<a id='comment:40'></a>I agree this does not make the leak much worse.\nAnd the leak should be fixed in #17360.",
    "created_at": "2014-12-08T10:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198167",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:40'></a>I agree this does not make the leak much worse.
And the leak should be fixed in #17360.



---

archive/issue_events_045732.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-12-15T17:50:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15618#event-45732"
}
```



---

archive/issue_comments_198168.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-12-15T17:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15618#issuecomment-198168",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
