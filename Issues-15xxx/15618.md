# Issue 15618: Use the correct categories for coercion and conversion maps

archive/issues_015381.json:
```json
{
    "assignees": [],
    "body": "The following examples show that some convert_maps are incorrectly assumed to be homomorphisms:\n\n```\nsage: f = ZZ.convert_map_from(QQ)\nsage: f.parent()\nSet of Homomorphisms from Rational Field to Integer Ring\n```\n\n```\nsage: f = ZZ.convert_map_from(GF(2))\nsage: f.parent() \nSet of field embeddings from Finite Field of size 2 to Integer Ring\n```\n\n```\nsage: f = GF(11).convert_map_from(GF(7))\nsage: f\nConversion map:\n  From: Finite Field of size 7\n  To:   Finite Field of size 11\nsage: f.parent()\nSet of field embeddings from Finite Field of size 7 to Finite Field of size 11\n```\nThis has the effect of constructing an element of a set that is in fact empty.  A conversion map should in general only be a morphisms in the category of sets with partial maps, because it is not necessarily defined everywhere.  (In case it *is* defined everywhere, it may of course be placed in the category of sets.)\n\nThis ticket fixes the problem in two steps:\n- use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;\n- make internal (\"reference-weakened\") coercion and conversion maps remember their category (the fact that this didn't work was revealed by the above change).\n\nSee also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms\n\n\nDepends on #16401\nDepends on #16402\nDepends on #17364\n\nCC:  @jpflori @simon-king-jena @JohnCremona @nthiery\n\nKeywords: **conversion map**\n\nBranch/Commit: **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**\n\nReviewer: **Jean-Pierre Flori, Nils Bruin**\n\nAuthor: **Peter Bruin**\n\nComponent: **coercion**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15618_\n\n",
    "closed_at": "2014-12-15T17:50:49Z",
    "created_at": "2014-01-02T00:26:45Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20coercion",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use the correct categories for coercion and conversion maps",
    "type": "issue",
    "updated_at": "2014-12-15T17:50:49Z",
    "url": "https://github.com/sagemath/sage/issues/15618",
    "user": "https://github.com/pjbruin"
}
```
The following examples show that some convert_maps are incorrectly assumed to be homomorphisms:

```
sage: f = ZZ.convert_map_from(QQ)
sage: f.parent()
Set of Homomorphisms from Rational Field to Integer Ring
```

```
sage: f = ZZ.convert_map_from(GF(2))
sage: f.parent() 
Set of field embeddings from Finite Field of size 2 to Integer Ring
```

```
sage: f = GF(11).convert_map_from(GF(7))
sage: f
Conversion map:
  From: Finite Field of size 7
  To:   Finite Field of size 11
sage: f.parent()
Set of field embeddings from Finite Field of size 7 to Finite Field of size 11
```
This has the effect of constructing an element of a set that is in fact empty.  A conversion map should in general only be a morphisms in the category of sets with partial maps, because it is not necessarily defined everywhere.  (In case it *is* defined everywhere, it may of course be placed in the category of sets.)

This ticket fixes the problem in two steps:
- use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;
- make internal ("reference-weakened") coercion and conversion maps remember their category (the fact that this didn't work was revealed by the above change).

See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms


Depends on #16401
Depends on #16402
Depends on #17364

CC:  @jpflori @simon-king-jena @JohnCremona @nthiery

Keywords: **conversion map**

Branch/Commit: **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**

Reviewer: **Jean-Pierre Flori, Nils Bruin**

Author: **Peter Bruin**

Component: **coercion**

_Issue created by migration from https://trac.sagemath.org/ticket/15618_





---

archive/issue_events_220675.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-01-02T00:26:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220675"
}
```



---

archive/issue_events_220676.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-01-02T00:26:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20coercion",
    "label_color": "0000ff",
    "label_name": "c: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220676"
}
```



---

archive/issue_events_220677.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-01-02T00:26:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220677"
}
```



---

archive/issue_events_220678.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-01-02T00:26:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220678"
}
```



---

archive/issue_events_220679.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220679"
}
```



---

archive/issue_events_220680.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220680"
}
```



---

archive/issue_comments_195949.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n-The following example shows that at least some convert_maps are incorrectly assumed to be homomorphisms:\n+The following examples show that some convert_maps are incorrectly assumed to be homomorphisms:\n+\n+```\n+sage: f = ZZ.convert_map_from(QQ)\n+sage: f.parent()\n+Set of Homomorphisms from Rational Field to Integer Ring\n+```\n+\n+```\n+sage: f = ZZ.convert_map_from(GF(2))\n+sage: f.parent() \n+Set of field embeddings from Finite Field of size 2 to Integer Ring\n+```\n \n ```\n sage: f = GF(11).convert_map_from(GF(7))\n@@ -11,7 +23,7 @@\n ```\n This has the effect of constructing an element of a set that is in fact empty.\n \n-Moreover, conversions should in general not be maps, because they are not necessarily defined everywhere.\n+Moreover, conversions should in general only be assumed to be partial maps, because they are not necessarily defined everywhere.\n \n See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms\n \n``````\n",
    "created_at": "2014-04-22T22:48:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195949",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,16 @@
-The following example shows that at least some convert_maps are incorrectly assumed to be homomorphisms:
+The following examples show that some convert_maps are incorrectly assumed to be homomorphisms:
+
+```
+sage: f = ZZ.convert_map_from(QQ)
+sage: f.parent()
+Set of Homomorphisms from Rational Field to Integer Ring
+```
+
+```
+sage: f = ZZ.convert_map_from(GF(2))
+sage: f.parent() 
+Set of field embeddings from Finite Field of size 2 to Integer Ring
+```
 
 ```
 sage: f = GF(11).convert_map_from(GF(7))
@@ -11,7 +23,7 @@
 ```
 This has the effect of constructing an element of a set that is in fact empty.
 
-Moreover, conversions should in general not be maps, because they are not necessarily defined everywhere.
+Moreover, conversions should in general only be assumed to be partial maps, because they are not necessarily defined everywhere.
 
 See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms
 
``````




---

archive/issue_comments_195950.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nIn the attached branch, I tried to make `DefaultConvertMap` return a morphism in the category of schemes with partial maps.  Unfortunately, a recent change in #14711 (where certain references in the coercion system were made into weak references) makes the map forget its parent `Homset`, and hence in which category it lives.\n\nExample (cf. the code producing the debugging output):\n\n```\nsage: ZZ.convert_map_from(CC)\nold parent = Set of Morphisms from Complex Field with 53 bits of precision to Integer Ring in Category of sets with partial maps\nnew parent = Set of Homomorphisms from Complex Field with 53 bits of precision to Integer Ring\nConversion map:\n  From: Complex Field with 53 bits of precision\n  To:   Integer Ring\n```",
    "created_at": "2014-04-22T22:59:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195950",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

In the attached branch, I tried to make `DefaultConvertMap` return a morphism in the category of schemes with partial maps.  Unfortunately, a recent change in #14711 (where certain references in the coercion system were made into weak references) makes the map forget its parent `Homset`, and hence in which category it lives.

Example (cf. the code producing the debugging output):

```
sage: ZZ.convert_map_from(CC)
old parent = Set of Morphisms from Complex Field with 53 bits of precision to Integer Ring in Category of sets with partial maps
new parent = Set of Homomorphisms from Complex Field with 53 bits of precision to Integer Ring
Conversion map:
  From: Complex Field with 53 bits of precision
  To:   Integer Ring
```



---

archive/issue_comments_195951.json:
```json
{
    "body": "Commit: **[`e772cb7`](https://github.com/sagemath/sagetrac-mirror/commit/e772cb79d115b7ed494fc1ac4eaff9120da37711)**",
    "created_at": "2014-04-22T22:59:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195951",
    "user": "https://github.com/pjbruin"
}
```

Commit: **[`e772cb7`](https://github.com/sagemath/sagetrac-mirror/commit/e772cb79d115b7ed494fc1ac4eaff9120da37711)**



---

archive/issue_comments_195952.json:
```json
{
    "body": "Branch: **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)**",
    "created_at": "2014-04-22T22:59:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195952",
    "user": "https://github.com/pjbruin"
}
```

Branch: **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)**



---

archive/issue_events_220681.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220681"
}
```



---

archive/issue_events_220682.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220682"
}
```



---

archive/issue_comments_195953.json:
```json
{
    "body": "Changed commit from **[`e772cb7`](https://github.com/sagemath/sagetrac-mirror/commit/e772cb79d115b7ed494fc1ac4eaff9120da37711)** to **[`d0e43bc`](https://github.com/sagemath/sagetrac-mirror/commit/d0e43bc8bedb2ea6877001c49abb4a56a6b1e145)**",
    "created_at": "2014-05-09T10:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195953",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`e772cb7`](https://github.com/sagemath/sagetrac-mirror/commit/e772cb79d115b7ed494fc1ac4eaff9120da37711)** to **[`d0e43bc`](https://github.com/sagemath/sagetrac-mirror/commit/d0e43bc8bedb2ea6877001c49abb4a56a6b1e145)**



---

archive/issue_comments_195954.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0e48aa939db26a4f51ea831dc9c542e9fe0c5feb\"><code>0e48aa9</code></a></td><td><code>make DefaultConvertMap a morphism in SetsWithPartialMaps()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d92ec909915dd2014000c5dc0c3828320aad557d\"><code>d92ec90</code></a></td><td><code>add Map._category_for and Map._set_parent()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0e43bc8bedb2ea6877001c49abb4a56a6b1e145\"><code>d0e43bc</code></a></td><td><code>Trac 15618: fix category of the Q_to_Z morphism</code></td></tr></table>\n",
    "created_at": "2014-05-09T10:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195954",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0e48aa939db26a4f51ea831dc9c542e9fe0c5feb"><code>0e48aa9</code></a></td><td><code>make DefaultConvertMap a morphism in SetsWithPartialMaps()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d92ec909915dd2014000c5dc0c3828320aad557d"><code>d92ec90</code></a></td><td><code>add Map._category_for and Map._set_parent()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0e43bc8bedb2ea6877001c49abb4a56a6b1e145"><code>d0e43bc</code></a></td><td><code>Trac 15618: fix category of the Q_to_Z morphism</code></td></tr></table>




---

archive/issue_events_220683.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-09T10:52:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220683"
}
```



---

archive/issue_comments_195955.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nBasically works, needs documentation and there are various failing doctests.",
    "created_at": "2014-05-09T10:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195955",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

Basically works, needs documentation and there are various failing doctests.



---

archive/issue_comments_195956.json:
```json
{
    "body": "Changed commit from **[`d0e43bc`](https://github.com/sagemath/sagetrac-mirror/commit/d0e43bc8bedb2ea6877001c49abb4a56a6b1e145)** to **[`d96f19e`](https://github.com/sagemath/sagetrac-mirror/commit/d96f19ef8b9b418ed974d130de22f73e7e7979e0)**",
    "created_at": "2014-05-09T19:26:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195956",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d0e43bc`](https://github.com/sagemath/sagetrac-mirror/commit/d0e43bc8bedb2ea6877001c49abb4a56a6b1e145)** to **[`d96f19e`](https://github.com/sagemath/sagetrac-mirror/commit/d96f19ef8b9b418ed974d130de22f73e7e7979e0)**



---

archive/issue_comments_195957.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d96f19ef8b9b418ed974d130de22f73e7e7979e0\"><code>d96f19e</code></a></td><td><code>Trac 15618: do not change category in FiniteDimensionalAlgebra._Hom_()</code></td></tr></table>\n",
    "created_at": "2014-05-09T19:26:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195957",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d96f19ef8b9b418ed974d130de22f73e7e7979e0"><code>d96f19e</code></a></td><td><code>Trac 15618: do not change category in FiniteDimensionalAlgebra._Hom_()</code></td></tr></table>




---

archive/issue_comments_195958.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nRemaining doctest failures (the first is due to #16311):\n\n```\nsage -t --long src/sage/structure/sage_object.pyx  # 1 doctest failed\nsage -t --long src/sage/groups/additive_abelian/additive_abelian_wrapper.py  # 2 doctests failed\n```",
    "created_at": "2014-05-09T19:27:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195958",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

Remaining doctest failures (the first is due to #16311):

```
sage -t --long src/sage/structure/sage_object.pyx  # 1 doctest failed
sage -t --long src/sage/groups/additive_abelian/additive_abelian_wrapper.py  # 2 doctests failed
```



---

archive/issue_comments_195959.json:
```json
{
    "body": "Dependencies: **#16401**",
    "created_at": "2014-05-26T13:25:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195959",
    "user": "https://github.com/pjbruin"
}
```

Dependencies: **#16401**



---

archive/issue_comments_195960.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThis dependency is needed to get the category right for finite field embeddings.",
    "created_at": "2014-05-26T13:25:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195960",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:9" align="right">comment:9</div>

This dependency is needed to get the category right for finite field embeddings.



---

archive/issue_comments_195961.json:
```json
{
    "body": "Changed dependencies from **#16401** to **#16401, #16402**",
    "created_at": "2014-05-26T22:16:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195961",
    "user": "https://github.com/pjbruin"
}
```

Changed dependencies from **#16401** to **#16401, #16402**



---

archive/issue_comments_195962.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nNeeded to get the category right for homesets whose domain is a FGP_Module.",
    "created_at": "2014-05-26T22:16:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195962",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:10" align="right">comment:10</div>

Needed to get the category right for homesets whose domain is a FGP_Module.



---

archive/issue_comments_195963.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nAfter #16401 and #16402, the only remaining problem is an unpickling failure of 3 old pickles:\n\n```\nFile \"src/sage/structure/sage_object.pyx\", line 1346, in sage.structure.sage_object.unpickle_all\nFailed example:\n    sage.structure.sage_object.unpickle_all()  # (4s on sage.math, 2011)\nExpected:\n    doctest:... DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.\n    See http://trac.sagemath.org/4260 for details.\n    Successfully unpickled ... objects.\n    Failed to unpickle 0 objects.\nGot:\n    doctest:1: DeprecationWarning: OrderedAlphabet is deprecated; use Alphabet instead.\n    See http://trac.sagemath.org/8920 for details.\n    doctest:839: DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.\n    See http://trac.sagemath.org/4260 for details.\n     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj')\n     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_cover__.sobj')\n     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj')\n    Failed:\n    _class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj\n    _type__sage_rings_morphism_RingHomomorphism_cover__.sobj\n    _type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj\n    ----------------------------------------------------------------------\n    ** This error is probably due to an old pickle failing to unpickle.\n    ** See sage.structure.sage_object.register_unpickle_override for\n    ** how to override the default unpickling methods for (old) pickles.\n    ** NOTE: pickles should never be removed from the pickle_jar!\n    ----------------------------------------------------------------------\n    Successfully unpickled 583 objects.\n    Failed to unpickle 3 objects.\n```",
    "created_at": "2014-05-26T23:03:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195963",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:11" align="right">comment:11</div>

After #16401 and #16402, the only remaining problem is an unpickling failure of 3 old pickles:

```
File "src/sage/structure/sage_object.pyx", line 1346, in sage.structure.sage_object.unpickle_all
Failed example:
    sage.structure.sage_object.unpickle_all()  # (4s on sage.math, 2011)
Expected:
    doctest:... DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    See http://trac.sagemath.org/4260 for details.
    Successfully unpickled ... objects.
    Failed to unpickle 0 objects.
Got:
    doctest:1: DeprecationWarning: OrderedAlphabet is deprecated; use Alphabet instead.
    See http://trac.sagemath.org/8920 for details.
    doctest:839: DeprecationWarning: This class is replaced by Matrix_modn_dense_float/Matrix_modn_dense_double.
    See http://trac.sagemath.org/4260 for details.
     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj')
     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_cover__.sobj')
     * unpickle failure: load('/home/pbruin/.sage/temp/selmer/22153/dir_6q6dfL//pickle_jar/_type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj')
    Failed:
    _class__sage_modular_hecke_degenmap_DegeneracyMap__.sobj
    _type__sage_rings_morphism_RingHomomorphism_cover__.sobj
    _type__sage_rings_morphism_RingHomomorphism_from_quotient__.sobj
    ----------------------------------------------------------------------
    ** This error is probably due to an old pickle failing to unpickle.
    ** See sage.structure.sage_object.register_unpickle_override for
    ** how to override the default unpickling methods for (old) pickles.
    ** NOTE: pickles should never be removed from the pickle_jar!
    ----------------------------------------------------------------------
    Successfully unpickled 583 objects.
    Failed to unpickle 3 objects.
```



---

archive/issue_comments_195964.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d261a37914aec9a0b7949fd526881003d3214f62\"><code>d261a37</code></a></td><td><code>Trac 15618: delay setting _category_for to avoid unpickling trouble</code></td></tr></table>\n",
    "created_at": "2014-05-27T01:38:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195964",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d261a37914aec9a0b7949fd526881003d3214f62"><code>d261a37</code></a></td><td><code>Trac 15618: delay setting _category_for to avoid unpickling trouble</code></td></tr></table>




---

archive/issue_comments_195965.json:
```json
{
    "body": "Changed commit from **[`d96f19e`](https://github.com/sagemath/sagetrac-mirror/commit/d96f19ef8b9b418ed974d130de22f73e7e7979e0)** to **[`d261a37`](https://github.com/sagemath/sagetrac-mirror/commit/d261a37914aec9a0b7949fd526881003d3214f62)**",
    "created_at": "2014-05-27T01:38:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195965",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d96f19e`](https://github.com/sagemath/sagetrac-mirror/commit/d96f19ef8b9b418ed974d130de22f73e7e7979e0)** to **[`d261a37`](https://github.com/sagemath/sagetrac-mirror/commit/d261a37914aec9a0b7949fd526881003d3214f62)**



---

archive/issue_comments_195966.json:
```json
{
    "body": "Author: **Peter Bruin**",
    "created_at": "2014-05-27T01:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195966",
    "user": "https://github.com/pjbruin"
}
```

Author: **Peter Bruin**



---

archive/issue_events_220684.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-27T01:52:40Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "title_is": "Use the correct categories for coercion and conversion maps",
    "title_was": "convert_map should not be a map",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220684"
}
```



---

archive/issue_comments_195967.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe new commit solves the unpickling problem, all tests now pass.  (The pickles weren't necessarily broken, my patch was trying to access the category of partially-unpickled homsets.)",
    "created_at": "2014-05-27T01:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195967",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

The new commit solves the unpickling problem, all tests now pass.  (The pickles weren't necessarily broken, my patch was trying to access the category of partially-unpickled homsets.)



---

archive/issue_comments_195968.json:
```json
{
    "body": "Work Issues: **add doctests**",
    "created_at": "2014-05-27T01:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195968",
    "user": "https://github.com/pjbruin"
}
```

Work Issues: **add doctests**



---

archive/issue_comments_195969.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,5 +25,9 @@\n \n Moreover, conversions should in general only be assumed to be partial maps, because they are not necessarily defined everywhere.\n \n+This ticket fixes the problem in two steps:\n+- use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;\n+- make internal (\"reference-weakened\") coercion and conversion maps remember their category (the fact that this didn't work is only revealed by the above change).\n+\n See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms\n \n``````\n",
    "created_at": "2014-05-27T01:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195969",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,5 +25,9 @@
 
 Moreover, conversions should in general only be assumed to be partial maps, because they are not necessarily defined everywhere.
 
+This ticket fixes the problem in two steps:
+- use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;
+- make internal ("reference-weakened") coercion and conversion maps remember their category (the fact that this didn't work is only revealed by the above change).
+
 See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms
 
``````




---

archive/issue_comments_195970.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21\"><code>54a6eca</code></a></td><td><code>Trac 15618: add doctests</code></td></tr></table>\n",
    "created_at": "2014-05-27T12:35:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195970",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21"><code>54a6eca</code></a></td><td><code>Trac 15618: add doctests</code></td></tr></table>




---

archive/issue_comments_195971.json:
```json
{
    "body": "Changed commit from **[`d261a37`](https://github.com/sagemath/sagetrac-mirror/commit/d261a37914aec9a0b7949fd526881003d3214f62)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**",
    "created_at": "2014-05-27T12:35:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195971",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d261a37`](https://github.com/sagemath/sagetrac-mirror/commit/d261a37914aec9a0b7949fd526881003d3214f62)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**



---

archive/issue_comments_195972.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nNote to reviewer(s): the branches of the dependencies (#16401, #16402) are not merged in this branch.",
    "created_at": "2014-05-27T12:41:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195972",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

Note to reviewer(s): the branches of the dependencies (#16401, #16402) are not merged in this branch.



---

archive/issue_comments_195973.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -21,13 +21,11 @@\n sage: f.parent()\n Set of field embeddings from Finite Field of size 7 to Finite Field of size 11\n ```\n-This has the effect of constructing an element of a set that is in fact empty.\n-\n-Moreover, conversions should in general only be assumed to be partial maps, because they are not necessarily defined everywhere.\n+This has the effect of constructing an element of a set that is in fact empty.  A conversion map should in general only be a morphisms in the category of sets with partial maps, because it is not necessarily defined everywhere.  (In case it *is* defined everywhere, it may of course be placed in the category of sets.)\n \n This ticket fixes the problem in two steps:\n - use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;\n-- make internal (\"reference-weakened\") coercion and conversion maps remember their category (the fact that this didn't work is only revealed by the above change).\n+- make internal (\"reference-weakened\") coercion and conversion maps remember their category (the fact that this didn't work was revealed by the above change).\n \n See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms\n \n``````\n",
    "created_at": "2014-05-27T12:41:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195973",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -21,13 +21,11 @@
 sage: f.parent()
 Set of field embeddings from Finite Field of size 7 to Finite Field of size 11
 ```
-This has the effect of constructing an element of a set that is in fact empty.
-
-Moreover, conversions should in general only be assumed to be partial maps, because they are not necessarily defined everywhere.
+This has the effect of constructing an element of a set that is in fact empty.  A conversion map should in general only be a morphisms in the category of sets with partial maps, because it is not necessarily defined everywhere.  (In case it *is* defined everywhere, it may of course be placed in the category of sets.)
 
 This ticket fixes the problem in two steps:
 - use `SetsWithPartialMaps` as the category for `DefaultConvertMap`;
-- make internal ("reference-weakened") coercion and conversion maps remember their category (the fact that this didn't work is only revealed by the above change).
+- make internal ("reference-weakened") coercion and conversion maps remember their category (the fact that this didn't work was revealed by the above change).
 
 See also https://groups.google.com/forum/#!topic/sage-devel/Z4iNgVMFoms
 
``````




---

archive/issue_events_220685.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-27T12:41:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220685"
}
```



---

archive/issue_events_220686.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-27T12:41:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220686"
}
```



---

archive/issue_comments_195974.json:
```json
{
    "body": "Changed work issues from **add doctests** to none",
    "created_at": "2014-05-27T12:41:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195974",
    "user": "https://github.com/pjbruin"
}
```

Changed work issues from **add doctests** to none



---

archive/issue_comments_195975.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nIn the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.\n\nThe alternative branch (including #16401 and #16402) is\n`u/pbruin/15618-convert_map_category` ([diff](https://github.com/sagemath/sagetrac-mirror/compare/a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3...25198d0723bd1355c6d40bb275126dc2bb8d61ad), [commits](https://github.com/sagemath/sagetrac-mirror/commits/25198d0723bd1355c6d40bb275126dc2bb8d61ad&qt=range&q=a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3..25198d0723bd1355c6d40bb275126dc2bb8d61ad)).",
    "created_at": "2014-05-27T21:33:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195975",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.

The alternative branch (including #16401 and #16402) is
`u/pbruin/15618-convert_map_category` ([diff](https://github.com/sagemath/sagetrac-mirror/compare/a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3...25198d0723bd1355c6d40bb275126dc2bb8d61ad), [commits](https://github.com/sagemath/sagetrac-mirror/commits/25198d0723bd1355c6d40bb275126dc2bb8d61ad&qt=range&q=a3c4cf39c3625a311d72bf0c88e9bfbd028d74f3..25198d0723bd1355c6d40bb275126dc2bb8d61ad)).



---

archive/issue_comments_195976.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThe dependencies are merged in this branch, for the benefit of reviewers and the patchbot.  The current branch is now simply one commit behind the branch `u/pbruin/15618-convert_map_category` of [comment:16](#comment%3A16).",
    "created_at": "2014-05-31T18:04:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195976",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:17" align="right">comment:17</div>

The dependencies are merged in this branch, for the benefit of reviewers and the patchbot.  The current branch is now simply one commit behind the branch `u/pbruin/15618-convert_map_category` of [comment:16](#comment%3A16).



---

archive/issue_comments_195977.json:
```json
{
    "body": "Changed commit from **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)** to **[`1ae3601`](https://github.com/sagemath/sagetrac-mirror/commit/1ae3601bdb7e02d9a554b7c6e837751e1cd62b5a)**",
    "created_at": "2014-05-31T18:04:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195977",
    "user": "https://github.com/pjbruin"
}
```

Changed commit from **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)** to **[`1ae3601`](https://github.com/sagemath/sagetrac-mirror/commit/1ae3601bdb7e02d9a554b7c6e837751e1cd62b5a)**



---

archive/issue_comments_195978.json:
```json
{
    "body": "Changed branch from **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)** to **[u/pbruin/15618-with-dependencies](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-with-dependencies)**",
    "created_at": "2014-05-31T18:04:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195978",
    "user": "https://github.com/pjbruin"
}
```

Changed branch from **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)** to **[u/pbruin/15618-with-dependencies](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-with-dependencies)**



---

archive/issue_events_220687.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220687"
}
```



---

archive/issue_events_220688.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220688"
}
```



---

archive/issue_comments_195979.json:
```json
{
    "body": "Changed commit from **[`1ae3601`](https://github.com/sagemath/sagetrac-mirror/commit/1ae3601bdb7e02d9a554b7c6e837751e1cd62b5a)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**",
    "created_at": "2014-11-17T11:22:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195979",
    "user": "https://github.com/pjbruin"
}
```

Changed commit from **[`1ae3601`](https://github.com/sagemath/sagetrac-mirror/commit/1ae3601bdb7e02d9a554b7c6e837751e1cd62b5a)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**



---

archive/issue_comments_195980.json:
```json
{
    "body": "Changed branch from **[u/pbruin/15618-with-dependencies](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-with-dependencies)** to **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)**",
    "created_at": "2014-11-17T11:22:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195980",
    "user": "https://github.com/pjbruin"
}
```

Changed branch from **[u/pbruin/15618-with-dependencies](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-with-dependencies)** to **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)**



---

archive/issue_comments_195981.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\n(Setting the branch back to `u/pbruin/15618-DefaultConvertMap` since the dependencies have now been merged into `develop` and the previous branch would not merge automatically.)",
    "created_at": "2014-11-17T11:22:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195981",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

(Setting the branch back to `u/pbruin/15618-DefaultConvertMap` since the dependencies have now been merged into `develop` and the previous branch would not merge automatically.)



---

archive/issue_comments_195982.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThis looks like an improvement to me.\n\nBut it gives me a bunch of failures (on top of 6.5.beta0):\n\n```\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/homset.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/scheme.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/projective/projective_homset.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/spec.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/schemes/generic/morphism.py  # 19 doctests failed\nsage -t --long --warn-long 156.2 src/sage/schemes/affine/affine_homset.py  # 1 doctest failed\nsage -t --long --warn-long 156.2 src/sage/categories/schemes.py  # 4 doctests failed\n```",
    "created_at": "2014-11-17T14:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195982",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:20" align="right">comment:20</div>

This looks like an improvement to me.

But it gives me a bunch of failures (on top of 6.5.beta0):

```
sage -t --long --warn-long 156.2 src/sage/schemes/generic/homset.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/generic/scheme.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/projective/projective_homset.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/generic/spec.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/schemes/generic/morphism.py  # 19 doctests failed
sage -t --long --warn-long 156.2 src/sage/schemes/affine/affine_homset.py  # 1 doctest failed
sage -t --long --warn-long 156.2 src/sage/categories/schemes.py  # 4 doctests failed
```



---

archive/issue_events_220689.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2014-11-17T14:46:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220689"
}
```



---

archive/issue_events_220690.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2014-11-17T14:46:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220690"
}
```



---

archive/issue_comments_195983.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nAll errors seem to be of the following form:\n\n```\nf = S(g)\n...\nValueError: Set of morphisms\n      From: Spectrum of ...\n      To:   Spectrum of ... is not in Category of sets with partial maps\n```",
    "created_at": "2014-11-17T16:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195983",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:21" align="right">comment:21</div>

All errors seem to be of the following form:

```
f = S(g)
...
ValueError: Set of morphisms
      From: Spectrum of ...
      To:   Spectrum of ... is not in Category of sets with partial maps
```



---

archive/issue_comments_195984.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI guess #10668 is the culprit.\n\n`@`Nicolas: any trivial fix for this?",
    "created_at": "2014-11-17T16:37:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195984",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:22" align="right">comment:22</div>

I guess #10668 is the culprit.

`@`Nicolas: any trivial fix for this?



---

archive/issue_comments_195985.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThe problem seems to be that the category `Schemes().Homsets()` does not have `Sets()` as a supercategory:\n\n```\nsage: Sets().Homsets().all_super_categories()\n[Category of homsets of sets,\n Category of homsets,\n Category of sets,\n Category of sets with partial maps,\n Category of objects]\nsage: Schemes().Homsets().all_super_categories()\n[Category of homsets of schemes,\n Category of objects]\n```",
    "created_at": "2014-11-17T18:39:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195985",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:23" align="right">comment:23</div>

The problem seems to be that the category `Schemes().Homsets()` does not have `Sets()` as a supercategory:

```
sage: Sets().Homsets().all_super_categories()
[Category of homsets of sets,
 Category of homsets,
 Category of sets,
 Category of sets with partial maps,
 Category of objects]
sage: Schemes().Homsets().all_super_categories()
[Category of homsets of schemes,
 Category of objects]
```



---

archive/issue_comments_195986.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI kind of think the same thing.\n\nFor sure, also getting Nicolas' mind would be helpful :)",
    "created_at": "2014-11-17T19:00:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195986",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:24" align="right">comment:24</div>

I kind of think the same thing.

For sure, also getting Nicolas' mind would be helpful :)



---

archive/issue_comments_195987.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/02702bd61441ea5779f07d660fdfbec489649b16\"><code>02702bd</code></a></td><td><code>Merge branch 'develop' into ticket/15618-DefaultConvertMap</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bb452a7f168890c3dbeaf049c5a4537e5827cb0e\"><code>bb452a7</code></a></td><td><code>Trac 15618: remove incorrect class Schemes.Homsets</code></td></tr></table>\n",
    "created_at": "2014-11-17T20:16:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195987",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/02702bd61441ea5779f07d660fdfbec489649b16"><code>02702bd</code></a></td><td><code>Merge branch 'develop' into ticket/15618-DefaultConvertMap</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bb452a7f168890c3dbeaf049c5a4537e5827cb0e"><code>bb452a7</code></a></td><td><code>Trac 15618: remove incorrect class Schemes.Homsets</code></td></tr></table>




---

archive/issue_comments_195988.json:
```json
{
    "body": "Changed commit from **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)** to **[`bb452a7`](https://github.com/sagemath/sagetrac-mirror/commit/bb452a7f168890c3dbeaf049c5a4537e5827cb0e)**",
    "created_at": "2014-11-17T20:16:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195988",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)** to **[`bb452a7`](https://github.com/sagemath/sagetrac-mirror/commit/bb452a7f168890c3dbeaf049c5a4537e5827cb0e)**



---

archive/issue_comments_195989.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThe last commit seems to fix the bugs.\n\nNicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?",
    "created_at": "2014-11-17T20:25:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195989",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:26" align="right">comment:26</div>

The last commit seems to fix the bugs.

Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?



---

archive/issue_comments_195990.json:
```json
{
    "body": "<div id=\"comment:27\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b3cc973ebd7c453847e71031c63f10715866fe2c\"><code>b3cc973</code></a></td><td><code>Trac 15618: fix typesetting</code></td></tr></table>\n",
    "created_at": "2014-11-17T20:26:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195990",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:27"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b3cc973ebd7c453847e71031c63f10715866fe2c"><code>b3cc973</code></a></td><td><code>Trac 15618: fix typesetting</code></td></tr></table>




---

archive/issue_comments_195991.json:
```json
{
    "body": "Changed commit from **[`bb452a7`](https://github.com/sagemath/sagetrac-mirror/commit/bb452a7f168890c3dbeaf049c5a4537e5827cb0e)** to **[`b3cc973`](https://github.com/sagemath/sagetrac-mirror/commit/b3cc973ebd7c453847e71031c63f10715866fe2c)**",
    "created_at": "2014-11-17T20:26:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195991",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`bb452a7`](https://github.com/sagemath/sagetrac-mirror/commit/bb452a7f168890c3dbeaf049c5a4537e5827cb0e)** to **[`b3cc973`](https://github.com/sagemath/sagetrac-mirror/commit/b3cc973ebd7c453847e71031c63f10715866fe2c)**



---

archive/issue_events_220691.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-11-17T20:28:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220691"
}
```



---

archive/issue_events_220692.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-11-17T20:28:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220692"
}
```



---

archive/issue_comments_195992.json:
```json
{
    "body": "Changed commit from **[`b3cc973`](https://github.com/sagemath/sagetrac-mirror/commit/b3cc973ebd7c453847e71031c63f10715866fe2c)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**",
    "created_at": "2014-11-17T21:55:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195992",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b3cc973`](https://github.com/sagemath/sagetrac-mirror/commit/b3cc973ebd7c453847e71031c63f10715866fe2c)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**



---

archive/issue_comments_195993.json:
```json
{
    "body": "<div id=\"comment:29\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-11-17T21:55:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195993",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:29"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_195994.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nI think it is better to solve that problem on a new ticket.  This is now #17359.",
    "created_at": "2014-11-17T21:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195994",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:30" align="right">comment:30</div>

I think it is better to solve that problem on a new ticket.  This is now #17359.



---

archive/issue_comments_195995.json:
```json
{
    "body": "Changed dependencies from **#16401, #16402** to **#16401, #16402, #17359**",
    "created_at": "2014-11-17T21:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195995",
    "user": "https://github.com/pjbruin"
}
```

Changed dependencies from **#16401, #16402** to **#16401, #16402, #17359**



---

archive/issue_comments_195996.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@pjbruin](#comment%3A16):\n> In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.\n\nSince the alternative branch `u/pbruin/15618-convert_map_category` may still be relevant (to prevent potential memory leaks), I rebased it ([diff](https://github.com/sagemath/sagetrac-mirror/compare/4cd153a457b2b47ee4fefe64d305d04c6c5f39a6...b2b22ea6eefe5754a05ca866931f5725918a466b), [commits](https://github.com/sagemath/sagetrac-mirror/compare/4cd153a457b2b47ee4fefe64d305d04c6c5f39a6...b2b22ea6eefe5754a05ca866931f5725918a466b)).",
    "created_at": "2014-11-17T22:44:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195996",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@pjbruin](#comment%3A16):
> In the current branch, there is a new `Map._category_for` attribute that is always a strong reference.  I later thought that instead of this, it might be better to treat `category_for` in an analogous way to `domain`, i.e. to make it an attribute that can be either a `ConstantFunction` or to a `weakref`.  I'm undecided for the moment, so I'm keeping the original branch in the ticket description.

Since the alternative branch `u/pbruin/15618-convert_map_category` may still be relevant (to prevent potential memory leaks), I rebased it ([diff](https://github.com/sagemath/sagetrac-mirror/compare/4cd153a457b2b47ee4fefe64d305d04c6c5f39a6...b2b22ea6eefe5754a05ca866931f5725918a466b), [commits](https://github.com/sagemath/sagetrac-mirror/compare/4cd153a457b2b47ee4fefe64d305d04c6c5f39a6...b2b22ea6eefe5754a05ca866931f5725918a466b)).



---

archive/issue_comments_195997.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nJust this line:\n\n```\nif category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))\n```\nis a memory leak:\n\n```\nsage: import gc\nsage: from collections import Counter\nsage: gc.collect()\n93\nsage: pre={id(a) for a in gc.get_objects()}\nsage: \nsage: for p in prime_range(20000):\n....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))\n....:     \nsage: gc.collect()\n0\nsage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)\nsage: post\nCounter({\"<type 'tuple'>\": 314633, \"<type 'dict'>\": 106360, \"<type 'list'>\": 88464, \"<type 'cell'>\": 67894, \"<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>\": 52032, \"<type 'weakref'>\": 40733, \"<class 'weakref.KeyedRef'>\": 36193, \"<type 'function'>\": 33947, \"<type 'staticmethod'>\": 33947, \"<type 'builtin_function_or_method'>\": 33938, \"<type 'sage.misc.cachefunc.CachedMethodCaller'>\": 33937, \"<type 'frozenset'>\": 33933, \"<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>\": 33932, \"<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>\": 25868, \"<type 'sage.structure.coerce_dict.MonoDict'>\": 4522, \"<type 'sage.structure.coerce_dict.MonoDictEraser'>\": 4522, \"<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.bimodules.Bimodules_with_category'>\": 2262, \"<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras.Algebras_with_category'>\": 2262, \"<class 'sage.categories.left_modules.LeftModules_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>\": 2262, \"<class 'sage.categories.right_modules.RightModules_with_category'>\": 2262, \"<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>\": 2262, \"<class 'sage.categories.modules.Modules_with_category'>\": 2262, \"<type 'sage.structure.coerce_dict.TripleDict'>\": 2261, \"<class 'sage.rings.ideal.Ideal_pid'>\": 2261, \"<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>\": 2261, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>\": 2261, \"<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>\": 2261, \"<type 'sage.structure.coerce_dict.TripleDictEraser'>\": 2261, \"<type 'instancemethod'>\": 2261, \"<class 'sage.structure.dynamic_class.DynamicMetaclass'>\": 15, \"<class '_ast.Call'>\": 3, \"<type 'sage.misc.constant_function.ConstantFunction'>\": 2, \"<class '_ast.Name'>\": 2, \"<type 'frame'>\": 1, \"<type 'set'>\": 1, \"<class '_ast.comprehension'>\": 1, \"<class '_ast.Interactive'>\": 1, \"<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>\": 1, \"<class '_ast.Module'>\": 1, \"<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>\": 1, \"<type 'listiterator'>\": 1, \"<type 'generator'>\": 1, \"<class '_ast.Assign'>\": 1, \"<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>\": 1})\n```\nThe problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:\n\n```\nsage: GF(3)['x'].category()\nJoin of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)\n```\n(as you can see, the category doesn't explicitly link to `GF(3)` anymore)\nAdmittedly:\n\n```\nsage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()\nCategory of finite dimensional algebras with basis over Finite Field of size 3\n```\nso the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.",
    "created_at": "2014-11-17T23:11:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195997",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:32" align="right">comment:32</div>

Just this line:

```
if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))
```
is a memory leak:

```
sage: import gc
sage: from collections import Counter
sage: gc.collect()
93
sage: pre={id(a) for a in gc.get_objects()}
sage: 
sage: for p in prime_range(20000):
....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))
....:     
sage: gc.collect()
0
sage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)
sage: post
Counter({"<type 'tuple'>": 314633, "<type 'dict'>": 106360, "<type 'list'>": 88464, "<type 'cell'>": 67894, "<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>": 52032, "<type 'weakref'>": 40733, "<class 'weakref.KeyedRef'>": 36193, "<type 'function'>": 33947, "<type 'staticmethod'>": 33947, "<type 'builtin_function_or_method'>": 33938, "<type 'sage.misc.cachefunc.CachedMethodCaller'>": 33937, "<type 'frozenset'>": 33933, "<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>": 33932, "<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>": 25868, "<type 'sage.structure.coerce_dict.MonoDict'>": 4522, "<type 'sage.structure.coerce_dict.MonoDictEraser'>": 4522, "<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>": 2262, "<class 'sage.categories.bimodules.Bimodules_with_category'>": 2262, "<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.algebras.Algebras_with_category'>": 2262, "<class 'sage.categories.left_modules.LeftModules_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>": 2262, "<class 'sage.categories.right_modules.RightModules_with_category'>": 2262, "<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>": 2262, "<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>": 2262, "<class 'sage.categories.modules.Modules_with_category'>": 2262, "<type 'sage.structure.coerce_dict.TripleDict'>": 2261, "<class 'sage.rings.ideal.Ideal_pid'>": 2261, "<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>": 2261, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>": 2261, "<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>": 2261, "<type 'sage.structure.coerce_dict.TripleDictEraser'>": 2261, "<type 'instancemethod'>": 2261, "<class 'sage.structure.dynamic_class.DynamicMetaclass'>": 15, "<class '_ast.Call'>": 3, "<type 'sage.misc.constant_function.ConstantFunction'>": 2, "<class '_ast.Name'>": 2, "<type 'frame'>": 1, "<type 'set'>": 1, "<class '_ast.comprehension'>": 1, "<class '_ast.Interactive'>": 1, "<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>": 1, "<class '_ast.Module'>": 1, "<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>": 1, "<type 'listiterator'>": 1, "<type 'generator'>": 1, "<class '_ast.Assign'>": 1, "<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>": 1})
```
The problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:

```
sage: GF(3)['x'].category()
Join of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)
```
(as you can see, the category doesn't explicitly link to `GF(3)` anymore)
Admittedly:

```
sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()
Category of finite dimensional algebras with basis over Finite Field of size 3
```
so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.



---

archive/issue_comments_195998.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@pjbruin](#comment%3A26):\n> The last commit seems to fix the bugs.\n> \n> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?\n\nThanks for cc'ing Nicolas as I forgot to do so!",
    "created_at": "2014-11-18T08:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195998",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@pjbruin](#comment%3A26):
> The last commit seems to fix the bugs.
> 
> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.  However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?

Thanks for cc'ing Nicolas as I forgot to do so!



---

archive/issue_comments_195999.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@nbruin](#comment%3A32):\n> Just this line:\n> \n> ```\n> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))\n> ```\n> is a memory leak:\n> \n> ```\n> sage: import gc\n> sage: from collections import Counter\n> sage: gc.collect()\n> 93\n> sage: pre={id(a) for a in gc.get_objects()}\n> sage: \n> sage: for p in prime_range(20000):\n> ....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))\n> ....:     \n> sage: gc.collect()\n> 0\n> sage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)\n> sage: post\n> Counter({\"<type 'tuple'>\": 314633, \"<type 'dict'>\": 106360, \"<type 'list'>\": 88464, \"<type 'cell'>\": 67894, \"<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>\": 52032, \"<type 'weakref'>\": 40733, \"<class 'weakref.KeyedRef'>\": 36193, \"<type 'function'>\": 33947, \"<type 'staticmethod'>\": 33947, \"<type 'builtin_function_or_method'>\": 33938, \"<type 'sage.misc.cachefunc.CachedMethodCaller'>\": 33937, \"<type 'frozenset'>\": 33933, \"<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>\": 33932, \"<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>\": 25868, \"<type 'sage.structure.coerce_dict.MonoDict'>\": 4522, \"<type 'sage.structure.coerce_dict.MonoDictEraser'>\": 4522, \"<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.bimodules.Bimodules_with_category'>\": 2262, \"<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras.Algebras_with_category'>\": 2262, \"<class 'sage.categories.left_modules.LeftModules_with_category'>\": 2262, \"<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>\": 2262, \"<class 'sage.categories.right_modules.RightModules_with_category'>\": 2262, \"<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>\": 2262, \"<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>\": 2262, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>\": 2262, \"<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>\": 2262, \"<class 'sage.categories.modules.Modules_with_category'>\": 2262, \"<type 'sage.structure.coerce_dict.TripleDict'>\": 2261, \"<class 'sage.rings.ideal.Ideal_pid'>\": 2261, \"<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>\": 2261, \"<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>\": 2261, \"<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>\": 2261, \"<type 'sage.structure.coerce_dict.TripleDictEraser'>\": 2261, \"<type 'instancemethod'>\": 2261, \"<class 'sage.structure.dynamic_class.DynamicMetaclass'>\": 15, \"<class '_ast.Call'>\": 3, \"<type 'sage.misc.constant_function.ConstantFunction'>\": 2, \"<class '_ast.Name'>\": 2, \"<type 'frame'>\": 1, \"<type 'set'>\": 1, \"<class '_ast.comprehension'>\": 1, \"<class '_ast.Interactive'>\": 1, \"<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>\": 1, \"<class '_ast.Module'>\": 1, \"<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>\": 1, \"<type 'listiterator'>\": 1, \"<type 'generator'>\": 1, \"<class '_ast.Assign'>\": 1, \"<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>\": 1})\n> ```\n> The problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:\n> \n> ```\n> sage: GF(3)['x'].category()\n> Join of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)\n> ```\n> (as you can see, the category doesn't explicitly link to `GF(3)` anymore)\n> Admittedly:\n> \n> ```\n> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()\n> Category of finite dimensional algebras with basis over Finite Field of size 3\n> ```\n> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.\n\nFor clarity, I would suggest to open another ticket for that.\nAnd make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)",
    "created_at": "2014-11-18T08:59:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-195999",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@nbruin](#comment%3A32):
> Just this line:
> 
> ```
> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))
> ```
> is a memory leak:
> 
> ```
> sage: import gc
> sage: from collections import Counter
> sage: gc.collect()
> 93
> sage: pre={id(a) for a in gc.get_objects()}
> sage: 
> sage: for p in prime_range(20000):
> ....:         A =  FiniteDimensionalAlgebrasWithBasis(GF(p))
> ....:     
> sage: gc.collect()
> 0
> sage: post=Counter(str(type(a)) for a in gc.get_objects() if id(a) not in pre)
> sage: post
> Counter({"<type 'tuple'>": 314633, "<type 'dict'>": 106360, "<type 'list'>": 88464, "<type 'cell'>": 67894, "<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>": 52032, "<type 'weakref'>": 40733, "<class 'weakref.KeyedRef'>": 36193, "<type 'function'>": 33947, "<type 'staticmethod'>": 33947, "<type 'builtin_function_or_method'>": 33938, "<type 'sage.misc.cachefunc.CachedMethodCaller'>": 33937, "<type 'frozenset'>": 33933, "<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>": 33932, "<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>": 25868, "<type 'sage.structure.coerce_dict.MonoDict'>": 4522, "<type 'sage.structure.coerce_dict.MonoDictEraser'>": 4522, "<class 'sage.categories.unital_algebras.UnitalAlgebras_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces.WithBasis_with_category'>": 2262, "<class 'sage.categories.bimodules.Bimodules_with_category'>": 2262, "<class 'sage.categories.unital_algebras.UnitalAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.algebras.Algebras_with_category'>": 2262, "<class 'sage.categories.left_modules.LeftModules_with_category'>": 2262, "<class 'sage.categories.vector_spaces.VectorSpaces_with_category'>": 2262, "<class 'sage.categories.right_modules.RightModules_with_category'>": 2262, "<class 'sage.categories.finite_dimensional_algebras_with_basis.FiniteDimensionalAlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.modules_with_basis.ModulesWithBasis_with_category'>": 2262, "<class 'sage.categories.algebras_with_basis.AlgebrasWithBasis_with_category'>": 2262, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis_with_category'>": 2262, "<class 'sage.categories.associative_algebras.AssociativeAlgebras_with_category'>": 2262, "<class 'sage.categories.modules.Modules_with_category'>": 2262, "<type 'sage.structure.coerce_dict.TripleDict'>": 2261, "<class 'sage.rings.ideal.Ideal_pid'>": 2261, "<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>": 2261, "<class 'sage.categories.magmatic_algebras.MagmaticAlgebras_with_category'>": 2261, "<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>": 2261, "<type 'sage.structure.coerce_dict.TripleDictEraser'>": 2261, "<type 'instancemethod'>": 2261, "<class 'sage.structure.dynamic_class.DynamicMetaclass'>": 15, "<class '_ast.Call'>": 3, "<type 'sage.misc.constant_function.ConstantFunction'>": 2, "<class '_ast.Name'>": 2, "<type 'frame'>": 1, "<type 'set'>": 1, "<class '_ast.comprehension'>": 1, "<class '_ast.Interactive'>": 1, "<class 'sage.categories.finite_dimensional_modules_with_basis.FiniteDimensionalModulesWithBasis_with_category'>": 1, "<class '_ast.Module'>": 1, "<type 'sage.categories.category_singleton.Category_contains_method_by_parent_class'>": 1, "<type 'listiterator'>": 1, "<type 'generator'>": 1, "<class '_ast.Assign'>": 1, "<class 'sage.categories.modules.Modules.FiniteDimensional_with_category'>": 1})
> ```
> The problem is that categories themselves have infinite life, so one should not instantiate parametrized categories unless one really has to. To this end we now have:
> 
> ```
> sage: GF(3)['x'].category()
> Join of Category of euclidean domains and Category of commutative algebras over (finite fields and subquotients of monoids and quotients of semigroups)
> ```
> (as you can see, the category doesn't explicitly link to `GF(3)` anymore)
> Admittedly:
> 
> ```
> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()
> Category of finite dimensional algebras with basis over Finite Field of size 3
> ```
> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.

For clarity, I would suggest to open another ticket for that.
And make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)



---

archive/issue_comments_196000.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nUnless it's solved by Peter's alternative branch of course.",
    "created_at": "2014-11-18T09:02:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196000",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:35" align="right">comment:35</div>

Unless it's solved by Peter's alternative branch of course.



---

archive/issue_comments_196001.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@jpflori](#comment%3A34):\n> For clarity, I would suggest to open another ticket for that.\n> And make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)\n\nPerhaps use #17360 for that. Please do glance through the rest of your code to check if similar changes are warranted (which can then be implemented either here, on #17360, or another follow-on ticket)",
    "created_at": "2014-11-18T09:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196001",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@jpflori](#comment%3A34):
> For clarity, I would suggest to open another ticket for that.
> And make it a dependency here (or not if we consider the situation is not worsened by the current ticket.)

Perhaps use #17360 for that. Please do glance through the rest of your code to check if similar changes are warranted (which can then be implemented either here, on #17360, or another follow-on ticket)



---

archive/issue_comments_196002.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@pjbruin](#comment%3A26):\n> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.\n\nCool.\n\n> However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?\n\nThanks for spotting this as this was a bug. See #17364.",
    "created_at": "2014-11-18T15:59:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196002",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@pjbruin](#comment%3A26):
> Nicolas: I think we can safely remove the `Schemes.Homsets` class with its `extra_super_categories` method, as in this commit.

Cool.

> However, is it the intended behaviour that the former *presence* of this class + method caused `Schemes().Homsets()` to acquire *fewer* supercategories?  What is the explanation for this?

Thanks for spotting this as this was a bug. See #17364.



---

archive/issue_comments_196003.json:
```json
{
    "body": "Changed dependencies from **#16401, #16402, #17359** to **#16401, #16402, #17364**",
    "created_at": "2014-11-19T08:59:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196003",
    "user": "https://github.com/pjbruin"
}
```

Changed dependencies from **#16401, #16402, #17359** to **#16401, #16402, #17364**



---

archive/issue_comments_196004.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@nbruin](#comment%3A32):\n> Just this line:\n> \n> ```\n> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))\n> ```\n> is a memory leak:\n\n[...]\n> Admittedly:\n> \n> ```\n> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()\n> Category of finite dimensional algebras with basis over Finite Field of size 3\n> ```\n> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.\n\nThis change is necessary because otherwise we get errors if the provided `category` (which is `SetsWithPartialMaps()` in some cases) is not a subcategory of `FiniteDimensionalAlgebrasWithBasis(self.base_ring())`.  Logically, the choice whether the homset should be of type `FiniteDimensionalAlgebraHomset` should depend on the category, not vice versa.\n\nThis ticket does not make the memory leak (much) worse, because in most cases `B` will be a `FiniteDimensionalAlgebra` anyway, in which case the same category is constructed.\n\nI also tested (using your example and in addition constructing `A.coerce_map_from(GF(p))` for each `A` in the loop) that the current branch does not cause additional memory leaks, and that the existing leak is fixed by #17360 both before and after applying my branch.  Thus the alternative branch (comment:31) doesn't seem to be needed.",
    "created_at": "2014-11-21T11:20:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196004",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@nbruin](#comment%3A32):
> Just this line:
> 
> ```
> if category.is_subcategory(FiniteDimensionalAlgebrasWithBasis(self.base_ring()))
> ```
> is a memory leak:

[...]
> Admittedly:
> 
> ```
> sage: FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])]).category()
> Category of finite dimensional algebras with basis over Finite Field of size 3
> ```
> so the memory leak already exists for `FiniteDimensionalAlgebra` in general. However, since you're introducing the line here, you should probably argue why you're not making the problem worse and/or open a ticket about the memory leak in general.

This change is necessary because otherwise we get errors if the provided `category` (which is `SetsWithPartialMaps()` in some cases) is not a subcategory of `FiniteDimensionalAlgebrasWithBasis(self.base_ring())`.  Logically, the choice whether the homset should be of type `FiniteDimensionalAlgebraHomset` should depend on the category, not vice versa.

This ticket does not make the memory leak (much) worse, because in most cases `B` will be a `FiniteDimensionalAlgebra` anyway, in which case the same category is constructed.

I also tested (using your example and in addition constructing `A.coerce_map_from(GF(p))` for each `A` in the loop) that the current branch does not cause additional memory leaks, and that the existing leak is fixed by #17360 both before and after applying my branch.  Thus the alternative branch (comment:31) doesn't seem to be needed.



---

archive/issue_events_220693.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2014-12-08T10:55:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220693"
}
```



---

archive/issue_events_220694.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2014-12-08T10:55:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220694"
}
```



---

archive/issue_comments_196005.json:
```json
{
    "body": "Reviewer: **Jean-Pierre Flori, Nils Bruin**",
    "created_at": "2014-12-08T10:55:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196005",
    "user": "https://github.com/jpflori"
}
```

Reviewer: **Jean-Pierre Flori, Nils Bruin**



---

archive/issue_comments_196006.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nI agree this does not make the leak much worse.\nAnd the leak should be fixed in #17360.",
    "created_at": "2014-12-08T10:55:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196006",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:40" align="right">comment:40</div>

I agree this does not make the leak much worse.
And the leak should be fixed in #17360.



---

archive/issue_events_220695.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-12-15T17:50:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220695"
}
```



---

archive/issue_events_220696.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "978f623b62cd1b56f54e1cb62bf41dcb0c05acf0",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2014-12-15T17:50:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15618#event-220696"
}
```



---

archive/issue_comments_196007.json:
```json
{
    "body": "Changed branch from **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**",
    "created_at": "2014-12-15T17:50:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15618#issuecomment-196007",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/pbruin/15618-DefaultConvertMap](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/15618-DefaultConvertMap)** to **[`54a6eca`](https://github.com/sagemath/sagetrac-mirror/commit/54a6ecae11f902b11ad651c67af021af6ed2da21)**
