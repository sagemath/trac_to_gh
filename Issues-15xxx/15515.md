# Issue 15515: Change graphics_filename() to return a tmp_filename() except from the notebook

archive/issues_015278.json:
```json
{
    "body": "The function `graphics_filename()` in `sage/misc/temporary_file.py` was created for the notebook. When used in other places, it is unsafe (race condition + creates predicatable filenames) and can clutter the current working directory with files. Therefore, we should use `tmp_filename()` in `graphics_filename()` except when `EMBEDDED_MODE` is `True`. This also simplifies the logic in various `show()` methods.\n\nReviewer: Martin von Gagern\n\nAuthor: Jeroen Demeyer\n\nBranch: 69b285d7fb1ebf189aea0b7cde311880ec884d6d\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15515\n\n",
    "closed_at": "2014-07-11T04:19:38Z",
    "created_at": "2013-12-12T16:47:53Z",
    "labels": [
        "component: misc",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Change graphics_filename() to return a tmp_filename() except from the notebook",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15515",
    "user": "https://github.com/jdemeyer"
}
```
The function `graphics_filename()` in `sage/misc/temporary_file.py` was created for the notebook. When used in other places, it is unsafe (race condition + creates predicatable filenames) and can clutter the current working directory with files. Therefore, we should use `tmp_filename()` in `graphics_filename()` except when `EMBEDDED_MODE` is `True`. This also simplifies the logic in various `show()` methods.

Reviewer: Martin von Gagern

Author: Jeroen Demeyer

Branch: 69b285d7fb1ebf189aea0b7cde311880ec884d6d

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15515





---

archive/issue_comments_209514.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The function `graphics_filename()` in `sage/misc/temporary_file.py` was created for the notebook and should only be used in the notebook (where it can be used in a safe, controlled, way).\n+The function `graphics_filename()` in `sage/misc/temporary_file.py` was mainly created for the notebook and is potentially unsafe when used during doctests.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2013-12-12T16:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209514",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The function `graphics_filename()` in `sage/misc/temporary_file.py` was created for the notebook and should only be used in the notebook (where it can be used in a safe, controlled, way).
+The function `graphics_filename()` in `sage/misc/temporary_file.py` was mainly created for the notebook and is potentially unsafe when used during doctests.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_209515.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+The function `graphics_filename()` in `sage/misc/temporary_file.py` was mainly created for the notebook. When used in other places, it is unsafe (race condition + creates predicatable filenames) and can clutter the current working directory with files.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2013-12-12T17:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209515",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+The function `graphics_filename()` in `sage/misc/temporary_file.py` was mainly created for the notebook. When used in other places, it is unsafe (race condition + creates predicatable filenames) and can clutter the current working directory with files.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_209516.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+The function `graphics_filename()` in `sage/misc/temporary_file.py` was created for the notebook. When used in other places, it is unsafe (race condition + creates predicatable filenames) and can clutter the current working directory with files. Therefore, we should use `tmp_filename()` in `graphics_filename()` except when `EMBEDDED_MODE` is `True`. This also simplifies the logic in various `show()` methods.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2013-12-12T17:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209516",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+The function `graphics_filename()` in `sage/misc/temporary_file.py` was created for the notebook. When used in other places, it is unsafe (race condition + creates predicatable filenames) and can clutter the current working directory with files. Therefore, we should use `tmp_filename()` in `graphics_filename()` except when `EMBEDDED_MODE` is `True`. This also simplifies the logic in various `show()` methods.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_209517.json:
```json
{
    "body": "<a id='comment:4'></a>Attachment [doctest_no_graphics_filename.patch](tarball://root/attachments/some-uuid/ticket15515/doctest_no_graphics_filename.patch) by @jdemeyer created at 2013-12-20 15:40:40",
    "created_at": "2013-12-20T15:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209517",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Attachment [doctest_no_graphics_filename.patch](tarball://root/attachments/some-uuid/ticket15515/doctest_no_graphics_filename.patch) by @jdemeyer created at 2013-12-20 15:40:40



---

archive/issue_comments_209518.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-12-20T15:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209518",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_events_045321.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15515#event-45321"
}
```



---

archive/issue_events_045322.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15515#event-45322"
}
```



---

archive/issue_events_045323.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15515#event-45323"
}
```



---

archive/issue_comments_209519.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-12T06:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209519",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_209520.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2014-05-12T06:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209520",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_209521.json:
```json
{
    "body": "<a id='comment:9'></a>rws, do you care about this patch, would you review it? I can rebase the patch, but only if I know that somebody is interested in reviewing it.",
    "created_at": "2014-05-12T08:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209521",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>rws, do you care about this patch, would you review it? I can rebase the patch, but only if I know that somebody is interested in reviewing it.



---

archive/issue_comments_209522.json:
```json
{
    "body": "<a id='comment:10'></a>No, I don't care about the notebook.",
    "created_at": "2014-05-12T08:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209522",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>No, I don't care about the notebook.



---

archive/issue_comments_209523.json:
```json
{
    "body": "<a id='comment:11'></a>Oh it's not the notebook. Yes, I do care.",
    "created_at": "2014-05-12T08:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209523",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>Oh it's not the notebook. Yes, I do care.



---

archive/issue_comments_209524.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-07-03T22:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209524",
    "user": "https://github.com/gagern"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_209525.json:
```json
{
    "body": "<a id='comment:12'></a>Rebased this. Funny, I was coding something along the same lines at the moment, before comment:34:ticket:16533 made me aware of this ticket here.\n\n[My own modifications](http://git.sagemath.org/sage.git/log/?h=u/gagern/feature/graphics_filename-passthrough) (which I have just modified to build on this here) also move some other tasks into that function, namely passing a caller-provided filename back (either unaltered or with added suffix) unless it is `None`. That way, one can simply do `graphics_filename(filename=filename)` without worrying whether the user specified a file name or not.\n\nBut since I might end up reviewing your commit, I probably should file my own as a separate ticket\u2026 I haven't looked at *all* your modifications yet, but I notice that [code in plot3d/base.pyx](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/plot/plot3d/base.pyx?id=6.3.beta1#n1131) is still pretty broken with regard to `graphics_filename`: they call it to generate some name, then strip the original extension and add an assortment of other extensions. That's just asking for a name clash. And if `SAGE_TMP` would happen to be world writable (although I can't imagine how that might be), then a security relevant race condition would be very likely.\n\nIf I were to fix this, I would be using my own code for this. Jeroen, could we review one another's code for this?\n\nI guess I'd also like to use this function (with my own additions) all over the place for animations. Doing that would fix #16608 as well, would be a useful basis for my next stab at #16533, and would make [005b83f](http://git.sagemath.org/sage.git/commit/?id=005b83f2379d786b88f9a6b194dd334c038ea8ca) from #16571 superfluous as well.\n\n---\nNew commits:",
    "created_at": "2014-07-03T22:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209525",
    "user": "https://github.com/gagern"
}
```

<a id='comment:12'></a>Rebased this. Funny, I was coding something along the same lines at the moment, before comment:34:ticket:16533 made me aware of this ticket here.

[My own modifications](http://git.sagemath.org/sage.git/log/?h=u/gagern/feature/graphics_filename-passthrough) (which I have just modified to build on this here) also move some other tasks into that function, namely passing a caller-provided filename back (either unaltered or with added suffix) unless it is `None`. That way, one can simply do `graphics_filename(filename=filename)` without worrying whether the user specified a file name or not.

But since I might end up reviewing your commit, I probably should file my own as a separate ticket… I haven't looked at *all* your modifications yet, but I notice that [code in plot3d/base.pyx](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/plot/plot3d/base.pyx?id=6.3.beta1#n1131) is still pretty broken with regard to `graphics_filename`: they call it to generate some name, then strip the original extension and add an assortment of other extensions. That's just asking for a name clash. And if `SAGE_TMP` would happen to be world writable (although I can't imagine how that might be), then a security relevant race condition would be very likely.

If I were to fix this, I would be using my own code for this. Jeroen, could we review one another's code for this?

I guess I'd also like to use this function (with my own additions) all over the place for animations. Doing that would fix #16608 as well, would be a useful basis for my next stab at #16533, and would make [005b83f](http://git.sagemath.org/sage.git/commit/?id=005b83f2379d786b88f9a6b194dd334c038ea8ca) from #16571 superfluous as well.

---
New commits:



---

archive/issue_comments_209526.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 gagern]:\n> If I were to fix this, I would be using my own code for this. Jeroen, could we review one another's code for this?\n\n\nYes, but not before the end of July. Please remind me then in case I forget.",
    "created_at": "2014-07-04T04:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209526",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 gagern]:
> If I were to fix this, I would be using my own code for this. Jeroen, could we review one another's code for this?


Yes, but not before the end of July. Please remind me then in case I forget.



---

archive/issue_comments_209527.json:
```json
{
    "body": "<a id='comment:14'></a>I had a closer look at the code. Decided to restore explicit arguments in two cases because they might have been used as positional arguments, not keyword arguments, so we'd break backward compatibility. This is in response to the discussion staring at comment:25:ticket:16533. If we want to deprecate them properly, I'd suggest doing so along the lines of #16607.\n\nApart from that, the changes all look good. I'm doing the build, doc build, long test suite and so on tests now, and will push this change and set positive review once I'm done, unless any problems pop up.",
    "created_at": "2014-07-10T06:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209527",
    "user": "https://github.com/gagern"
}
```

<a id='comment:14'></a>I had a closer look at the code. Decided to restore explicit arguments in two cases because they might have been used as positional arguments, not keyword arguments, so we'd break backward compatibility. This is in response to the discussion staring at comment:25:ticket:16533. If we want to deprecate them properly, I'd suggest doing so along the lines of #16607.

Apart from that, the changes all look good. I'm doing the build, doc build, long test suite and so on tests now, and will push this change and set positive review once I'm done, unless any problems pop up.



---

archive/issue_comments_209528.json:
```json
{
    "body": "<a id='comment:15'></a>I just filed #16640 for the Graphics3d problem, since that may be harder to fix, but is already a problem without this change here applied to it, so it should be dealt with independently. Once it has been dealt with, that code can also be changed to use `graphics_filename` in all cases, instead of only the embedded case.",
    "created_at": "2014-07-10T07:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209528",
    "user": "https://github.com/gagern"
}
```

<a id='comment:15'></a>I just filed #16640 for the Graphics3d problem, since that may be harder to fix, but is already a problem without this change here applied to it, so it should be dealt with independently. Once it has been dealt with, that code can also be changed to use `graphics_filename` in all cases, instead of only the embedded case.



---

archive/issue_comments_209529.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-10T10:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209529",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_209530.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-07-10T10:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209530",
    "user": "https://github.com/gagern"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_209531.json:
```json
{
    "body": "<a id='comment:17'></a>OK, now even the old API with positional parameters is restored. Everything looks good: look at the code, interactive experiments, doctests, documentation build. I hope it's OK if I give this a positive review even though the last commit is mine. After all, its a minor change, mostly restoring previous code.",
    "created_at": "2014-07-10T10:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209531",
    "user": "https://github.com/gagern"
}
```

<a id='comment:17'></a>OK, now even the old API with positional parameters is restored. Everything looks good: look at the code, interactive experiments, doctests, documentation build. I hope it's OK if I give this a positive review even though the last commit is mine. After all, its a minor change, mostly restoring previous code.



---

archive/issue_comments_209532.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-07-11T04:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209532",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_045324.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-11T04:19:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15515#event-45324"
}
```



---

archive/issue_comments_209533.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:13 jdemeyer]:\n>> Jeroen, could we review one another's code for this?\n\n> Yes, but not before the end of July. Please remind me then in case I forget.\n\nJeroen, can you please have a look at #16640? Of course I'll welcome reviews for [all my other modifications](http://trac.sagemath.org/query?status=needs_review&author=~Gagern&group=component) as well, but that ticket is closely related to what you did here.",
    "created_at": "2014-09-05T07:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15515",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15515#issuecomment-209533",
    "user": "https://github.com/gagern"
}
```

<a id='comment:19'></a>Replying to [comment:13 jdemeyer]:
>> Jeroen, could we review one another's code for this?

> Yes, but not before the end of July. Please remind me then in case I forget.

Jeroen, can you please have a look at #16640? Of course I'll welcome reviews for [all my other modifications](http://trac.sagemath.org/query?status=needs_review&author=~Gagern&group=component) as well, but that ticket is closely related to what you did here.
