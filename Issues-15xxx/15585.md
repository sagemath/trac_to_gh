# Issue 15585: Random failure in SimplicialComplex.is_cohen_macaulay

archive/issues_015348.json:
```json
{
    "body": "CC:  @jdemeyer @roed314 @seblabbe\n\nKeywords: random_fail\n\nThis is fairly unlikely but occasionally comes up on the buildbot:\n\n```\nsage -t --long src/sage/homology/simplicial_complex.py\n**********************************************************************\nFile \"src/sage/homology/simplicial_complex.py\", line 2236, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay\nFailed example:\n    S.is_cohen_macaulay(ncpus=3)\nExpected:\n    False\nGot:\n    [Errno 2] No such file or directory: '/home/buildbot/build/sage/snapperkob/sage_git/dot_sage/temp/snapperkob/10634/dir_n0BDmn/10759.out'\n    False\n```\n\nThis is because a race condition in ``@`parallel`. This is a parallel generator which forks processes, each process handling one item of the generator. The output of each finished process is stored as pickle in a working directory and then `yield`ed by the main process.\n\nWhen the generator is closed (for example, the generator is used as argument to `all()` and a `False` condition is found), the following happens in a `finally` block:\n\n1. The working directory is removed.\n\n2. The remaining processes are killed.\n\nThis is a race condition because it can happen that a subprocess finishes between these steps. Then that process wants to write its output in the deleted directory. The fix is obvious: first kill the processes, then delete the directory.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15585\n\n",
    "closed_at": "2017-07-26T22:13:04Z",
    "created_at": "2013-12-25T12:32:04Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Random failure in SimplicialComplex.is_cohen_macaulay",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15585",
    "user": "https://github.com/vbraun"
}
```
CC:  @jdemeyer @roed314 @seblabbe

Keywords: random_fail

This is fairly unlikely but occasionally comes up on the buildbot:

```
sage -t --long src/sage/homology/simplicial_complex.py
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2236, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay
Failed example:
    S.is_cohen_macaulay(ncpus=3)
Expected:
    False
Got:
    [Errno 2] No such file or directory: '/home/buildbot/build/sage/snapperkob/sage_git/dot_sage/temp/snapperkob/10634/dir_n0BDmn/10759.out'
    False
```

This is because a race condition in ``@`parallel`. This is a parallel generator which forks processes, each process handling one item of the generator. The output of each finished process is stored as pickle in a working directory and then `yield`ed by the main process.

When the generator is closed (for example, the generator is used as argument to `all()` and a `False` condition is found), the following happens in a `finally` block:

1. The working directory is removed.

2. The remaining processes are killed.

This is a race condition because it can happen that a subprocess finishes between these steps. Then that process wants to write its output in the deleted directory. The fix is obvious: first kill the processes, then delete the directory.

Issue created by migration from https://trac.sagemath.org/ticket/15585





---

archive/issue_comments_197518.json:
```json
{
    "body": "Full log (but really nothing interesting) at http://build.sagemath.org/sage/builders/%20%20fast%20AIMS%20snapperkob%20%28Ubuntu%2012.04%20x86_64%29%20incremental/builds/28/steps/shell_3/logs/stdio",
    "created_at": "2013-12-25T12:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197518",
    "user": "https://github.com/vbraun"
}
```

Full log (but really nothing interesting) at http://build.sagemath.org/sage/builders/%20%20fast%20AIMS%20snapperkob%20%28Ubuntu%2012.04%20x86_64%29%20incremental/builds/28/steps/shell_3/logs/stdio



---

archive/issue_comments_197519.json:
```json
{
    "body": "My guess would be that forke'd process writes temp file, and parent tries to read it after the fork quits. That is inherently racy since the sage cleaner will attempt to delete the child's temp files as it has another pid.",
    "created_at": "2013-12-25T12:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197519",
    "user": "https://github.com/vbraun"
}
```

My guess would be that forke'd process writes temp file, and parent tries to read it after the fork quits. That is inherently racy since the sage cleaner will attempt to delete the child's temp files as it has another pid.



---

archive/issue_events_045583.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45583"
}
```



---

archive/issue_events_045584.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45584"
}
```



---

archive/issue_events_045585.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45585"
}
```



---

archive/issue_comments_197520.json:
```json
{
    "body": "Changing keywords from \"\" to \"random_fail\".",
    "created_at": "2014-07-25T05:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197520",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "" to "random_fail".



---

archive/issue_events_045586.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45586"
}
```



---

archive/issue_events_045587.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45587"
}
```



---

archive/issue_comments_197521.json:
```json
{
    "body": "Still happens occasionally",
    "created_at": "2015-11-09T04:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197521",
    "user": "https://github.com/vbraun"
}
```

Still happens occasionally



---

archive/issue_comments_197522.json:
```json
{
    "body": "Seen this today for the first ever I think.  (Sage 7.3.rc0)",
    "created_at": "2016-07-31T09:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197522",
    "user": "https://github.com/nexttime"
}
```

Seen this today for the first ever I think.  (Sage 7.3.rc0)



---

archive/issue_comments_197523.json:
```json
{
    "body": "Replying to [comment:8 leif]:\n> Seen this today for the first ever I think.  (Sage 7.3.rc0)\n\n\nP.S.:  Same error, different test:\n\n```\nsage -t --long --warn-long 68.2 src/sage/homology/simplicial_complex.py\n**********************************************************************\nFile \"src/sage/homology/simplicial_complex.py\", line 2813, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay\nFailed example:\n    X.is_cohen_macaulay(ZZ)\nExpected:\n    False\nGot:\n    [Errno 2] No such file or directory: '/home/leif/.sage/temp/tunguska/16183/dir_5o8pnH/16223.out'\n    False\n**********************************************************************\n```",
    "created_at": "2016-07-31T09:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197523",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:8 leif]:
> Seen this today for the first ever I think.  (Sage 7.3.rc0)


P.S.:  Same error, different test:

```
sage -t --long --warn-long 68.2 src/sage/homology/simplicial_complex.py
**********************************************************************
File "src/sage/homology/simplicial_complex.py", line 2813, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay
Failed example:
    X.is_cohen_macaulay(ZZ)
Expected:
    False
Got:
    [Errno 2] No such file or directory: '/home/leif/.sage/temp/tunguska/16183/dir_5o8pnH/16223.out'
    False
**********************************************************************
```



---

archive/issue_comments_197524.json:
```json
{
    "body": "I've seen this a few times recently, too.",
    "created_at": "2016-07-31T17:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197524",
    "user": "https://github.com/jhpalmieri"
}
```

I've seen this a few times recently, too.



---

archive/issue_events_045588.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-17T09:25:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45588"
}
```



---

archive/issue_events_045589.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2016-08-17T09:25:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45589"
}
```



---

archive/issue_comments_197525.json:
```json
{
    "body": "still there in 7.5 and [7.6.betas](https://groups.google.com/d/msg/sage-release/TMI3trb0G74/8z7F8V52DgAJ).",
    "created_at": "2017-02-02T16:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197525",
    "user": "https://github.com/dimpase"
}
```

still there in 7.5 and [7.6.betas](https://groups.google.com/d/msg/sage-release/TMI3trb0G74/8z7F8V52DgAJ).



---

archive/issue_events_045590.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-02-02T16:14:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45590"
}
```



---

archive/issue_events_045591.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-02-02T16:14:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45591"
}
```



---

archive/issue_comments_197526.json:
```json
{
    "body": "I wonder if it would help if the tests all used just 1 CPU.",
    "created_at": "2017-02-24T20:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197526",
    "user": "https://github.com/jhpalmieri"
}
```

I wonder if it would help if the tests all used just 1 CPU.



---

archive/issue_comments_197527.json:
```json
{
    "body": "Replying to [comment:13 jhpalmieri]:\n> I wonder if it would help if the tests all used just 1 CPU.\n\n\nMaybe, but that's not fixing the problem, just hiding it.\n\nIf you want to \"fix\" the problem but not hide it, just add `# known bug`.",
    "created_at": "2017-02-25T07:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197527",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 jhpalmieri]:
> I wonder if it would help if the tests all used just 1 CPU.


Maybe, but that's not fixing the problem, just hiding it.

If you want to "fix" the problem but not hide it, just add `# known bug`.



---

archive/issue_comments_197528.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Replying to [comment:13 jhpalmieri]:\n> > I wonder if it would help if the tests all used just 1 CPU.\n\n> \n> Maybe, but that's not fixing the problem, just hiding it.\n> \n> If you want to \"fix\" the problem but not hide it, just add `# known bug`.\n\n\nat least it would be good to know what part of the code in question writes temp files with extension .out\n(In my admittedly limited experience with parallel code I never saw slaves doing any file I/O; if they do they ought to clean up after themselves, otherwise there is not telling as to what will happen)",
    "created_at": "2017-02-25T12:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197528",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 jhpalmieri]:
> > I wonder if it would help if the tests all used just 1 CPU.

> 
> Maybe, but that's not fixing the problem, just hiding it.
> 
> If you want to "fix" the problem but not hide it, just add `# known bug`.


at least it would be good to know what part of the code in question writes temp files with extension .out
(In my admittedly limited experience with parallel code I never saw slaves doing any file I/O; if they do they ought to clean up after themselves, otherwise there is not telling as to what will happen)



---

archive/issue_comments_197529.json:
```json
{
    "body": "It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.",
    "created_at": "2017-02-25T15:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197529",
    "user": "https://github.com/jhpalmieri"
}
```

It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.



---

archive/issue_comments_197530.json:
```json
{
    "body": "Replying to [comment:16 jhpalmieri]:\n> It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.\n\n\nAs a rule, I get it on a gentoo linux laptop, running on a 4-core Intel i7, and the usual ext4 file systems on an SSD.",
    "created_at": "2017-02-26T20:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197530",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:16 jhpalmieri]:
> It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.


As a rule, I get it on a gentoo linux laptop, running on a 4-core Intel i7, and the usual ext4 file systems on an SSD.



---

archive/issue_comments_197531.json:
```json
{
    "body": "See #22462.",
    "created_at": "2017-02-27T16:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197531",
    "user": "https://github.com/jdemeyer"
}
```

See #22462.



---

archive/issue_comments_197532.json:
```json
{
    "body": "Replying to [comment:16 jhpalmieri]:\n> It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.\n\n\nI almost always get this problem when running `MAKE='make -j8' make ptestlong` on a Ubuntu 16.04, with 8 cpus, with file system ext4.\n\nI am now running `make testlong` in serially to see the difference.",
    "created_at": "2017-07-04T15:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197532",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:16 jhpalmieri]:
> It would be also nice to know what kinds of systems produce the error: OS, number of CPUs, file system, etc.


I almost always get this problem when running `MAKE='make -j8' make ptestlong` on a Ubuntu 16.04, with 8 cpus, with file system ext4.

I am now running `make testlong` in serially to see the difference.



---

archive/issue_comments_197533.json:
```json
{
    "body": "> I am now running `make testlong` in serially to see the difference.\n\n\nI get `All tests passed!` with `make testlong`.",
    "created_at": "2017-07-05T19:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197533",
    "user": "https://github.com/seblabbe"
}
```

> I am now running `make testlong` in serially to see the difference.


I get `All tests passed!` with `make testlong`.



---

archive/issue_comments_197534.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-07T08:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197534",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_197535.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-07-07T08:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197535",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_197536.json:
```json
{
    "body": "On a machine that almost always gives the error on `is_cohen_macaulay`, I get `All tests passed!` on a single run of `MAKE='make -j6' make ptestlong`.",
    "created_at": "2017-07-11T13:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197536",
    "user": "https://github.com/seblabbe"
}
```

On a machine that almost always gives the error on `is_cohen_macaulay`, I get `All tests passed!` on a single run of `MAKE='make -j6' make ptestlong`.



---

archive/issue_comments_197537.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-11T16:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197537",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_197538.json:
```json
{
    "body": "On a second run of `make ptestlong`, I still do not get the error. -> Great! Positive review.",
    "created_at": "2017-07-11T16:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197538",
    "user": "https://github.com/seblabbe"
}
```

On a second run of `make ptestlong`, I still do not get the error. -> Great! Positive review.



---

archive/issue_comments_197539.json:
```json
{
    "body": "Thanks for investigating this.  I've been seeing this problem too, but thought it was a weird case of the sage-cleaner being overly aggressive for some reason.",
    "created_at": "2017-07-17T08:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197539",
    "user": "https://github.com/embray"
}
```

Thanks for investigating this.  I've been seeing this problem too, but thought it was a weird case of the sage-cleaner being overly aggressive for some reason.



---

archive/issue_comments_197540.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-26T22:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15585#issuecomment-197540",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_045592.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-26T22:13:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15585",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15585#event-45592"
}
```
