# Issue 15808: Remove genus2reduction

archive/issues_015571.json:
```json
{
    "body": "genus2reduction has been ported to the PARI library and is available as the PARI function `genus2red()`. We should remove the package and use the new PARI function instead.\n\nBranch/Commit: f35c94473e316c01c968f2a43027868c517815a2\n\nReviewer: Peter Bruin\n\nAuthor: Jeroen Demeyer\n\nDependencies: #15767\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15808\n\n",
    "closed_at": "2014-10-09T22:30:39Z",
    "created_at": "2014-02-11T09:55:16Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Remove genus2reduction",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15808",
    "user": "https://github.com/jdemeyer"
}
```
genus2reduction has been ported to the PARI library and is available as the PARI function `genus2red()`. We should remove the package and use the new PARI function instead.

Branch/Commit: f35c94473e316c01c968f2a43027868c517815a2

Reviewer: Peter Bruin

Author: Jeroen Demeyer

Dependencies: #15767

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15808





---

archive/issue_events_046488.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15808#event-46488"
}
```



---

archive/issue_events_046489.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15808#event-46489"
}
```



---

archive/issue_events_046490.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15808#event-46490"
}
```



---

archive/issue_comments_200989.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-09-18T12:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_200990.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-18T12:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200990",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_200991.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-19T13:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200991",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_200992.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-09-19T13:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_200993.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-09-19T13:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200993",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_200994.json:
```json
{
    "body": "<a id='comment:10'></a>There is an `EXAMPLES:` missing a double `::`",
    "created_at": "2014-09-21T19:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200994",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>There is an `EXAMPLES:` missing a double `::`



---

archive/issue_comments_200995.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-21T20:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_200996.json:
```json
{
    "body": "<a id='comment:12'></a>There was a pyflakes warning about a missing definition. I made a correction in a function call for that reason.\n\nAlso made a few pep8 changes.\n\n---\nNew commits:",
    "created_at": "2014-10-05T19:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200996",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>There was a pyflakes warning about a missing definition. I made a correction in a function call for that reason.

Also made a few pep8 changes.

---
New commits:



---

archive/issue_comments_200997.json:
```json
{
    "body": "<a id='comment:13'></a>Do you have a reference for the following manipulations?\n\n```python\nif minimal_equation.degree() == 5:\n    minimal_disc *= minimal_equation[5]**2\n# Multiply with suitable power of 2 of the form 2^(2*(d-1) - 12)\nb = 2 * (minimal_equation.degree() - 1)\nk = QQ((12 - minimal_disc.valuation(2), b)).ceil()\nminimal_disc >>= 12 - b*k\nminimal_disc = ZZ(minimal_disc)\n```\nIs the power of 2 in fact important, given that this is supposed to output the minimal discriminant away from 2?",
    "created_at": "2014-10-07T11:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200997",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>Do you have a reference for the following manipulations?

```python
if minimal_equation.degree() == 5:
    minimal_disc *= minimal_equation[5]**2
# Multiply with suitable power of 2 of the form 2^(2*(d-1) - 12)
b = 2 * (minimal_equation.degree() - 1)
k = QQ((12 - minimal_disc.valuation(2), b)).ceil()
minimal_disc >>= 12 - b*k
minimal_disc = ZZ(minimal_disc)
```
Is the power of 2 in fact important, given that this is supposed to output the minimal discriminant away from 2?



---

archive/issue_comments_200998.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 pbruin]:\n> Do you have a reference for the following manipulations?\n\nThey are based on looking at the PARI source code. But I must admit that I don't understand everything 100% clearly.\n\nThe line\n\n```\nif minimal_equation.degree() == 5:\n    minimal_disc *= minimal_equation[5]**2\n```\nis based on\n\n```\n  RgX_to_6(polr, &a0,&a1,&a2,&a3,&a4,&a5,&a6);\n  I.j10 = !signe(a0)? mulii(sqri(a1), ZX_disc(polr)): ZX_disc(polr);\n```\n\nThe factor `2^(-12)` comes from\n\n```\nI.j10 = gmul2n(I.j10,-12);\n```\nand the multiplication by `2^(2*(d-1))` comes from\n\n```\ndd = polval(polr,gen_2) & (~1); /* = 2 floor(val/2) */\npolr = gmul2n(polr, -dd);\n```\nwhich multiplies the whole polynomial by a power of 4.\nMultiplying a polynomial of degree `d` by a constant `c` multiplies the discriminant by `c^(d-1)`.\n\n> Is the power of 2 in fact important?\n\nI have no idea. I tried to reproduce as best as possible the output of the old `genus2reduction` program. That is also the reason why I emulated the `raw()` method and wrote to `divisors_to_string()` function: to check for myself if the new output was the same as the old output. Modulo some small details, this seems indeed to be the case.",
    "created_at": "2014-10-07T12:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200998",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:13 pbruin]:
> Do you have a reference for the following manipulations?

They are based on looking at the PARI source code. But I must admit that I don't understand everything 100% clearly.

The line

```
if minimal_equation.degree() == 5:
    minimal_disc *= minimal_equation[5]**2
```
is based on

```
  RgX_to_6(polr, &a0,&a1,&a2,&a3,&a4,&a5,&a6);
  I.j10 = !signe(a0)? mulii(sqri(a1), ZX_disc(polr)): ZX_disc(polr);
```

The factor `2^(-12)` comes from

```
I.j10 = gmul2n(I.j10,-12);
```
and the multiplication by `2^(2*(d-1))` comes from

```
dd = polval(polr,gen_2) & (~1); /* = 2 floor(val/2) */
polr = gmul2n(polr, -dd);
```
which multiplies the whole polynomial by a power of 4.
Multiplying a polynomial of degree `d` by a constant `c` multiplies the discriminant by `c^(d-1)`.

> Is the power of 2 in fact important?

I have no idea. I tried to reproduce as best as possible the output of the old `genus2reduction` program. That is also the reason why I emulated the `raw()` method and wrote to `divisors_to_string()` function: to check for myself if the new output was the same as the old output. Modulo some small details, this seems indeed to be the case.



---

archive/issue_comments_200999.json:
```json
{
    "body": "<a id='comment:15'></a>I'm not absolutely sure either, but from the last bit of PARI code you quoted, the following change seems to stay closer to the original:\n\n```diff\ndiff --git a/src/sage/interfaces/genus2reduction.py b/src/sage/interfaces/genus2reduction.py\nindex 73d41d6..01c4019 100644\n--- a/src/sage/interfaces/genus2reduction.py\n+++ b/src/sage/interfaces/genus2reduction.py\n@@ -514,9 +514,9 @@ class Genus2reduction(SageObject):\n         minimal_disc = QQ(res[2].poldisc()).abs()\n         if minimal_equation.degree() == 5:\n             minimal_disc *= minimal_equation[5]**2\n-        # Multiply with suitable power of 2 of the form 2^(2*(d-1) - 12)\n+        # Multiply with suitable power of 2 of the form 2^(2*d - 12)\n         b = 2 * (minimal_equation.degree() - 1)\n-        k = QQ((12 - minimal_disc.valuation(2), b)).ceil()\n+        k = min(a.valuation(2) for a in Q**2 + 4*P) & ~1\n         minimal_disc >>= 12 - b*k\n         minimal_disc = ZZ(minimal_disc)\n \n```\nThis does not affect any doctests in `genus2reduction.py`.",
    "created_at": "2014-10-07T16:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-200999",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:15'></a>I'm not absolutely sure either, but from the last bit of PARI code you quoted, the following change seems to stay closer to the original:

```diff
diff --git a/src/sage/interfaces/genus2reduction.py b/src/sage/interfaces/genus2reduction.py
index 73d41d6..01c4019 100644
--- a/src/sage/interfaces/genus2reduction.py
+++ b/src/sage/interfaces/genus2reduction.py
@@ -514,9 +514,9 @@ class Genus2reduction(SageObject):
         minimal_disc = QQ(res[2].poldisc()).abs()
         if minimal_equation.degree() == 5:
             minimal_disc *= minimal_equation[5]**2
-        # Multiply with suitable power of 2 of the form 2^(2*(d-1) - 12)
+        # Multiply with suitable power of 2 of the form 2^(2*d - 12)
         b = 2 * (minimal_equation.degree() - 1)
-        k = QQ((12 - minimal_disc.valuation(2), b)).ceil()
+        k = min(a.valuation(2) for a in Q**2 + 4*P) & ~1
         minimal_disc >>= 12 - b*k
         minimal_disc = ZZ(minimal_disc)
 
```
This does not affect any doctests in `genus2reduction.py`.



---

archive/issue_comments_201000.json:
```json
{
    "body": "<a id='comment:16'></a>Actually my version above is certainly wrong, because it is not invariant under scaling of the variables in the original equation.  However, your formula seems to mean that the 2-adic valuation of the minimal discriminant is bounded on the set of all genus 2 curves, which I can hardly believe, since it isn't even true for elliptic curves.",
    "created_at": "2014-10-07T16:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201000",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:16'></a>Actually my version above is certainly wrong, because it is not invariant under scaling of the variables in the original equation.  However, your formula seems to mean that the 2-adic valuation of the minimal discriminant is bounded on the set of all genus 2 curves, which I can hardly believe, since it isn't even true for elliptic curves.



---

archive/issue_comments_201001.json:
```json
{
    "body": "<a id='comment:17'></a>We can also decide to give up trying to imitate the original program perfectly and allow the power of 2 to be different.  I am attaching a patch that does this.\n\nI also think you used an incorrect criterion to decide when the 2-part of the conductor was not computed.  For example, one of the current doctests has the line\n\n```\nConductor (away from 2): 954\n```\nNote that the \"away from 2\" part should only be there if the returned conductor is odd.  According to the PARI documentation, we should check if 2 appears to the power -1 in the factorisation (fake at 2 in this case) of the conductor.  This is fixed by the last part of the patch.",
    "created_at": "2014-10-07T16:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201001",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:17'></a>We can also decide to give up trying to imitate the original program perfectly and allow the power of 2 to be different.  I am attaching a patch that does this.

I also think you used an incorrect criterion to decide when the 2-part of the conductor was not computed.  For example, one of the current doctests has the line

```
Conductor (away from 2): 954
```
Note that the "away from 2" part should only be there if the returned conductor is odd.  According to the PARI documentation, we should check if 2 appears to the power -1 in the factorisation (fake at 2 in this case) of the conductor.  This is fixed by the last part of the patch.



---

archive/issue_comments_201002.json:
```json
{
    "body": "<a id='comment:18'></a>Attachment [discriminant.patch](tarball://root/attachments/some-uuid/ticket15808/discriminant.patch) by @jdemeyer created at 2014-10-08 10:22:08\n\nWhat you say (and your patch) makes sense.",
    "created_at": "2014-10-08T10:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201002",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Attachment [discriminant.patch](tarball://root/attachments/some-uuid/ticket15808/discriminant.patch) by @jdemeyer created at 2014-10-08 10:22:08

What you say (and your patch) makes sense.



---

archive/issue_comments_201003.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:16 pbruin]:\n> However, your formula seems to mean that the 2-adic valuation of the minimal discriminant is bounded on the set of all genus 2 curves, which I can hardly believe, since it isn't even true for elliptic curves.\n\nAfter thinking about this some more, perhaps my code is correct but it depends on the interpretation of \"Minimal Discriminant (away from 2)\". If you interpret it as \"smallest positive integer which occurs as discriminant of a model of the given curve over Z[1/2]\", then my code might be correct.",
    "created_at": "2014-10-08T13:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201003",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Replying to [comment:16 pbruin]:
> However, your formula seems to mean that the 2-adic valuation of the minimal discriminant is bounded on the set of all genus 2 curves, which I can hardly believe, since it isn't even true for elliptic curves.

After thinking about this some more, perhaps my code is correct but it depends on the interpretation of "Minimal Discriminant (away from 2)". If you interpret it as "smallest positive integer which occurs as discriminant of a model of the given curve over Z[1/2]", then my code might be correct.



---

archive/issue_comments_201004.json:
```json
{
    "body": "<a id='comment:21'></a>New commits:",
    "created_at": "2014-10-08T13:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201004",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>New commits:



---

archive/issue_comments_201005.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:19 jdemeyer]:\n> Replying to [comment:16 pbruin]:\n> > However, your formula seems to mean that the 2-adic valuation of the minimal discriminant is bounded on the set of all genus 2 curves, which I can hardly believe, since it isn't even true for elliptic curves.\n\n> After thinking about this some more, perhaps my code is correct but it depends on the interpretation of \"Minimal Discriminant (away from 2)\". If you interpret it as \"smallest positive integer which occurs as discriminant of a model of the given curve over Z[1/2]\", then my code might be correct.\nPossibly, but I would be surprised if this definition coincides with the one used by the original `genus2reduction` program.  Anyway, I don't think it makes sense to spend too much time on finding a nice definition for \"minimal discriminant away from 2\", so any power of 2 in the \"minimal discriminant away from 2\" is fine with me.",
    "created_at": "2014-10-08T17:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201005",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:22'></a>Replying to [comment:19 jdemeyer]:
> Replying to [comment:16 pbruin]:
> > However, your formula seems to mean that the 2-adic valuation of the minimal discriminant is bounded on the set of all genus 2 curves, which I can hardly believe, since it isn't even true for elliptic curves.

> After thinking about this some more, perhaps my code is correct but it depends on the interpretation of "Minimal Discriminant (away from 2)". If you interpret it as "smallest positive integer which occurs as discriminant of a model of the given curve over Z[1/2]", then my code might be correct.
Possibly, but I would be surprised if this definition coincides with the one used by the original `genus2reduction` program.  Anyway, I don't think it makes sense to spend too much time on finding a nice definition for "minimal discriminant away from 2", so any power of 2 in the "minimal discriminant away from 2" is fine with me.



---

archive/issue_comments_201006.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-08T17:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201006",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_046491.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-09T22:30:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15808#event-46491"
}
```



---

archive/issue_comments_201007.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-09T22:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15808#issuecomment-201007",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
