# Issue 15200: _evalf_ handling of backends

archive/issues_014963.json:
```json
{
    "body": "As per Burcin, with the option of the `algorithm` keyword for `_evalf_` in #12289,\n\n```\nATM, if you implement different backends, you need to write a lot of\nboilerplate code in _evalf_() to parse the algorithm argument, do the\nright thing if it is not given etc. Can we have a default _evalf_\nmethod, which dispatches to _evalf_<system>_ methods if they exist and\nraise error if not? Perhaps we can also figure out how to annotate\nthese methods to indicate if they support arbitrary precision\nevaluation or not.\n```\n\nCC:  @burcin @kcrisman\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/15200\n\n",
    "created_at": "2013-09-15T18:27:46Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "_evalf_ handling of backends",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15200",
    "user": "https://github.com/eviatarbach"
}
```
As per Burcin, with the option of the `algorithm` keyword for `_evalf_` in #12289,

```
ATM, if you implement different backends, you need to write a lot of
boilerplate code in _evalf_() to parse the algorithm argument, do the
right thing if it is not given etc. Can we have a default _evalf_
method, which dispatches to _evalf_<system>_ methods if they exist and
raise error if not? Perhaps we can also figure out how to annotate
these methods to indicate if they support arbitrary precision
evaluation or not.
```

CC:  @burcin @kcrisman

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/15200





---

archive/issue_comments_190854.json:
```json
{
    "body": "<a id='comment:2'></a>I think \"the right thing if it is not given\" is resort to a method `_evalf_default_`. In cases where `_evalf_` has already been defined, overwriting the `_evalf_` which this patch would define, this will not change anything. The only problem is that for most functions the `algorithm` keyword won't do anything. I can't think of any good solution to this (such as raising a warning or error) that wouldn't involve modifying all the existing symbolic functions.",
    "created_at": "2013-09-15T18:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15200#issuecomment-190854",
    "user": "https://github.com/eviatarbach"
}
```

<a id='comment:2'></a>I think "the right thing if it is not given" is resort to a method `_evalf_default_`. In cases where `_evalf_` has already been defined, overwriting the `_evalf_` which this patch would define, this will not change anything. The only problem is that for most functions the `algorithm` keyword won't do anything. I can't think of any good solution to this (such as raising a warning or error) that wouldn't involve modifying all the existing symbolic functions.



---

archive/issue_comments_190855.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [trac15200.patch](tarball://root/attachments/some-uuid/ticket15200/trac15200.patch) by @eviatarbach created at 2013-09-16 01:56:25\n\nThis patch works for `BuiltinFunction`. Unfortunately it breaks `GinacFunction` (since they often don't define an `_evalf_` method, they don't overwrite the `_evalf_` in the base class) and gives an error as in #14743 on startup:\n\n```\nException AttributeError: \"'builtin_function_or_method' object has no attribute 'func_code'\" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored\n```",
    "created_at": "2013-09-16T01:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15200#issuecomment-190855",
    "user": "https://github.com/eviatarbach"
}
```

<a id='comment:3'></a>Attachment [trac15200.patch](tarball://root/attachments/some-uuid/ticket15200/trac15200.patch) by @eviatarbach created at 2013-09-16 01:56:25

This patch works for `BuiltinFunction`. Unfortunately it breaks `GinacFunction` (since they often don't define an `_evalf_` method, they don't overwrite the `_evalf_` in the base class) and gives an error as in #14743 on startup:

```
Exception AttributeError: "'builtin_function_or_method' object has no attribute 'func_code'" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored
```



---

archive/issue_events_043883.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15200#event-43883"
}
```



---

archive/issue_events_043884.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15200#event-43884"
}
```



---

archive/issue_events_043885.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15200#event-43885"
}
```



---

archive/issue_events_043886.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15200#event-43886"
}
```



---

archive/issue_events_043887.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15200#event-43887"
}
```



---

archive/issue_comments_190856.json:
```json
{
    "body": "<a id='comment:7'></a>I think the best solution would be to hardcode a set of common algorithm/parent choices like:\n\n```python\ndef _evalf_(self, *args, parent=None, algorithm=None):\n    if hasattr(self, '_evalf_scipy_') and (some_condition_on_parent_and_algorithm):\n        return parent(self._evalf_scipy_(*args))\n    if hasattr(self, '_evalf_mpmath_') and (some_condition_on_parent_and_algorithm):\n        return parent(self._evalf_mpmath_(*args))\n    [...]\n    return self._evalf_default_(*args, parent=parent, algorithm=algorithm)\n```",
    "created_at": "2014-10-13T08:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15200#issuecomment-190856",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>I think the best solution would be to hardcode a set of common algorithm/parent choices like:

```python
def _evalf_(self, *args, parent=None, algorithm=None):
    if hasattr(self, '_evalf_scipy_') and (some_condition_on_parent_and_algorithm):
        return parent(self._evalf_scipy_(*args))
    if hasattr(self, '_evalf_mpmath_') and (some_condition_on_parent_and_algorithm):
        return parent(self._evalf_mpmath_(*args))
    [...]
    return self._evalf_default_(*args, parent=parent, algorithm=algorithm)
```



---

archive/issue_comments_190857.json:
```json
{
    "body": "<a id='comment:10'></a>I had a look at Eviatar's patch and got some ideas. First,\n\nReplying to [comment:7 jdemeyer]:\n> I think the best solution would be to hardcode a set of common algorithm/parent choices like:\n\n`@`Jeroen:\n1. Does this mean you would find any mechanism doing recognition of implemented algorithms or call dispatch that exists apart from your hardcoded solution dangerous/superfluous/..?\n2. What is your opinion regarding such a mechanism dealing with `eval` (i.e., non-fp) algorithms? This concerns #17489, with possible implementation in #17531. (This may be fast in `__call__`, with only a dictionary lookup.)",
    "created_at": "2015-02-04T15:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15200#issuecomment-190857",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>I had a look at Eviatar's patch and got some ideas. First,

Replying to [comment:7 jdemeyer]:
> I think the best solution would be to hardcode a set of common algorithm/parent choices like:

`@`Jeroen:
1. Does this mean you would find any mechanism doing recognition of implemented algorithms or call dispatch that exists apart from your hardcoded solution dangerous/superfluous/..?
2. What is your opinion regarding such a mechanism dealing with `eval` (i.e., non-fp) algorithms? This concerns #17489, with possible implementation in #17531. (This may be fast in `__call__`, with only a dictionary lookup.)



---

archive/issue_comments_190858.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 rws]:\n> 1. Does this mean you would find any mechanism doing recognition of implemented algorithms or call dispatch that exists apart from your hardcoded solution dangerous/superfluous/..?\n  \nNo, but I think the generic solution should work for most functions.\n\n> 2. What is your opinion regarding such a mechanism dealing with `eval` (i.e., non-fp) algorithms?\n  \nI would propose to use this only for `_evalf_` but possibly extend `_evalf_` to non-fp arguments. See also the discussion about `NumberTheoreticFunction` (whatever the name) in #17489.",
    "created_at": "2015-02-04T16:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15200",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15200#issuecomment-190858",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:10 rws]:
> 1. Does this mean you would find any mechanism doing recognition of implemented algorithms or call dispatch that exists apart from your hardcoded solution dangerous/superfluous/..?
  
No, but I think the generic solution should work for most functions.

> 2. What is your opinion regarding such a mechanism dealing with `eval` (i.e., non-fp) algorithms?
  
I would propose to use this only for `_evalf_` but possibly extend `_evalf_` to non-fp arguments. See also the discussion about `NumberTheoreticFunction` (whatever the name) in #17489.
