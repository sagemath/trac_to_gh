# Issue 15423: Add auto-rebasing mechanism for Cygwin

archive/issues_015186.json:
```json
{
    "body": "As explained in the old description, it is often necessary when building Sage on Cygwin to *rebase* its DLLs.  This is the process of updating the default base addresses in memory at which a list of DLLs are loaded, such that none of those DLLs overlap each other in memory (in the normal case that they do overlap, Windows relocates them, but this frequently leads to fork errors in Cygwin).\n\nThis ticket solves the problem by running the `sage-rebase.sh` script as part of the `sage-spkg` script at the end of every package installation.  It also runs `sage-rebase.sh` after `make sagelib` for the same reason.  Although running it after installing each package is generally unnecessary, *sometimes* it is necessary.  For example, after installing Python, it's necessary to rebase to ensure that Python works, as it will be used later in the build process.  Since rebasing doesn't actually add much overhead in terms of time, it's fine to just do it always (on Cygwin).\n\nNote that this also uses `sage-rebase.sh` versus `sage-rebaseall.sh`.  The difference is that the former only updates DLLs in Sage itself (i.e. under `$SAGE_LOCAL`) whereas the latter also rebases all DLLs in the Cygwin installation.  Because of this, the latter cannot be run from inside Cygwin--all Cygwin processes must be stopped first.  Obviously this would be too disruptive to the normal Sage build process, so we don't do that.  It's also unnecessary.  As long as `rebaseall` is run once after installing Cygwin and all build dependencies, it will build a database of known DLLs and their base addresses and sizes, which can be referenced when rebasing new DLLs.  Since building Sage doesn't affect any of the Cygwin system DLLs there's no need to rerun `rebaseall` during a build of Sage.\n\nFixing this is necessary for unattended Sage builds to succeed--otherwise the build will fail several times and require manual rebasing before proceeding.\n\n### Old Description\nWith Sage 5.12 (plus a few updated spkg, all of them available on trac), building Sage on Cygwin(32) is no harder than on Linux except for the need of rebasing a few times during the build process.\nThis could be automated in the following way\n* try to build\n* if that fails and we're on Cygwin,\n* grep the failing logs for error messages cuased by fork issues\n* if all erros are caused by fork issues:\n  * rebase (using the oblivious option which can be run from bash, I think the script we included some time ago are ok),\n  * go back to step one\n* if not fails as usual\n\nHaving this would open the way to a buildbot or a patchbot for Cygwin.\n\nAssignee: @embray\n\nCC:  @kcrisman @dimpase @jdemeyer jpflori @tscrim\n\nBranch/Commit: 5e494ad504d2f86b56c1c956518ad7d48807f51c\n\nReviewer: Jean-Pierre Flori, Jeroen Demeyer\n\nAuthor: Erik Bray\n\nDependencies: #20986\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15423\n\n",
    "closed_at": "2017-05-20T20:07:57Z",
    "created_at": "2013-11-15T14:47:12Z",
    "labels": [
        "component: porting: cygwin",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Add auto-rebasing mechanism for Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15423",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
As explained in the old description, it is often necessary when building Sage on Cygwin to *rebase* its DLLs.  This is the process of updating the default base addresses in memory at which a list of DLLs are loaded, such that none of those DLLs overlap each other in memory (in the normal case that they do overlap, Windows relocates them, but this frequently leads to fork errors in Cygwin).

This ticket solves the problem by running the `sage-rebase.sh` script as part of the `sage-spkg` script at the end of every package installation.  It also runs `sage-rebase.sh` after `make sagelib` for the same reason.  Although running it after installing each package is generally unnecessary, *sometimes* it is necessary.  For example, after installing Python, it's necessary to rebase to ensure that Python works, as it will be used later in the build process.  Since rebasing doesn't actually add much overhead in terms of time, it's fine to just do it always (on Cygwin).

Note that this also uses `sage-rebase.sh` versus `sage-rebaseall.sh`.  The difference is that the former only updates DLLs in Sage itself (i.e. under `$SAGE_LOCAL`) whereas the latter also rebases all DLLs in the Cygwin installation.  Because of this, the latter cannot be run from inside Cygwin--all Cygwin processes must be stopped first.  Obviously this would be too disruptive to the normal Sage build process, so we don't do that.  It's also unnecessary.  As long as `rebaseall` is run once after installing Cygwin and all build dependencies, it will build a database of known DLLs and their base addresses and sizes, which can be referenced when rebasing new DLLs.  Since building Sage doesn't affect any of the Cygwin system DLLs there's no need to rerun `rebaseall` during a build of Sage.

Fixing this is necessary for unattended Sage builds to succeed--otherwise the build will fail several times and require manual rebasing before proceeding.

### Old Description
With Sage 5.12 (plus a few updated spkg, all of them available on trac), building Sage on Cygwin(32) is no harder than on Linux except for the need of rebasing a few times during the build process.
This could be automated in the following way
* try to build
* if that fails and we're on Cygwin,
* grep the failing logs for error messages cuased by fork issues
* if all erros are caused by fork issues:
  * rebase (using the oblivious option which can be run from bash, I think the script we included some time ago are ok),
  * go back to step one
* if not fails as usual

Having this would open the way to a buildbot or a patchbot for Cygwin.

Assignee: @embray

CC:  @kcrisman @dimpase @jdemeyer jpflori @tscrim

Branch/Commit: 5e494ad504d2f86b56c1c956518ad7d48807f51c

Reviewer: Jean-Pierre Flori, Jeroen Demeyer

Author: Erik Bray

Dependencies: #20986

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15423





---

archive/issue_events_044903.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44903"
}
```



---

archive/issue_events_044904.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44904"
}
```



---

archive/issue_events_044905.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44905"
}
```



---

archive/issue_events_044906.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44906"
}
```



---

archive/issue_events_044907.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44907"
}
```



---

archive/issue_events_044908.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-13T10:25:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44908"
}
```



---

archive/issue_events_044909.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-13T10:25:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44909"
}
```



---

archive/issue_comments_194742.json:
```json
{
    "body": "<a id='comment:4'></a>I've found it simpler (and I have a patch) to just always rebase after every package build.  It doesn't actually add much noticeable overhead.  One thing I might want to do before pushing my patch is also make it so the `--quiet` flag can be passed through to rebase, since otherwise this sometimes generates a bit of noise that isn't helpful.\n\nI would say this is almost necessary for Cygwin builds; especially in an automated context like running the patchbot.",
    "created_at": "2017-04-13T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194742",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I've found it simpler (and I have a patch) to just always rebase after every package build.  It doesn't actually add much noticeable overhead.  One thing I might want to do before pushing my patch is also make it so the `--quiet` flag can be passed through to rebase, since otherwise this sometimes generates a bit of noise that isn't helpful.

I would say this is almost necessary for Cygwin builds; especially in an automated context like running the patchbot.



---

archive/issue_comments_194743.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2017-04-13T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194743",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_194744.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2017-04-21T12:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194744",
    "user": "https://github.com/embray"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_194745.json:
```json
{
    "body": "<a id='comment:6'></a>New method for rebasing DLLs continuously during Sage build, which should solve this issue.  I've updated the ticket description to explain exactly what this does and why, but I left the old description just for comparison.\n\n---\nNew commits:",
    "created_at": "2017-05-05T14:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194745",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>New method for rebasing DLLs continuously during Sage build, which should solve this issue.  I've updated the ticket description to explain exactly what this does and why, but I left the old description just for comparison.

---
New commits:



---

archive/issue_comments_194746.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-05T14:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194746",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_194747.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-05T14:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194747",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_194748.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-05T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194748",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_194749.json:
```json
{
    "body": "<a id='comment:9'></a>Looks like that last commit has a merge conflict.",
    "created_at": "2017-05-05T14:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194749",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Looks like that last commit has a merge conflict.



---

archive/issue_comments_194750.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-05T14:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194750",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_194751.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-05T14:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194751",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_194752.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-17T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194752",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_194753.json:
```json
{
    "body": "<a id='comment:12'></a>LGTM",
    "created_at": "2017-05-17T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194753",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:12'></a>LGTM



---

archive/issue_comments_194754.json:
```json
{
    "body": "<a id='comment:13'></a>In `src/Makefile.in`, is this really needed for the rebase script to work?\n\n```\n    (cd $(srcdir)                                       \\\n     && export SAGE_ROOT=/doesnotexist                          \\\n           SAGE_SRC=/doesnotexist                           \\\n           SAGE_SRC_ROOT=/doesnotexist                          \\\n           SAGE_DOC_SRC=/doesnotexist                           \\\n           SAGE_BUILD_DIR=/doesnotexist                         \\\n           SAGE_PKGS=$(abs_top_srcdir)/build/pkgs                   \\\n           SAGE_CYTHONIZED=$(abs_builddir)/build/cythonized             \\\n```\n\nIf not, it would be cleaner to write the rebase script on a new line instead of continuing with `&&`.\n\nMinor comment which you might as well fix: you don't need the parentheses `(cd ... && ...)`. Those just create an extra subprocess for no reason.",
    "created_at": "2017-05-17T11:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194754",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>In `src/Makefile.in`, is this really needed for the rebase script to work?

```
    (cd $(srcdir)                                       \
     && export SAGE_ROOT=/doesnotexist                          \
           SAGE_SRC=/doesnotexist                           \
           SAGE_SRC_ROOT=/doesnotexist                          \
           SAGE_DOC_SRC=/doesnotexist                           \
           SAGE_BUILD_DIR=/doesnotexist                         \
           SAGE_PKGS=$(abs_top_srcdir)/build/pkgs                   \
           SAGE_CYTHONIZED=$(abs_builddir)/build/cythonized             \
```

If not, it would be cleaner to write the rebase script on a new line instead of continuing with `&&`.

Minor comment which you might as well fix: you don't need the parentheses `(cd ... && ...)`. Those just create an extra subprocess for no reason.



---

archive/issue_comments_194755.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2017-05-17T11:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194755",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_194756.json:
```json
{
    "body": "<a id='comment:14'></a>Nah the rebase script does only care about SAGE_LOCAL.",
    "created_at": "2017-05-17T12:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194756",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:14'></a>Nah the rebase script does only care about SAGE_LOCAL.



---

archive/issue_comments_194757.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-05-18T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194757",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_194758.json:
```json
{
    "body": "<a id='comment:16'></a>New commits:",
    "created_at": "2017-05-18T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194758",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>New commits:



---

archive/issue_comments_194759.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-18T08:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194759",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_194760.json:
```json
{
    "body": "<a id='comment:17'></a>Ok, let's go with jeroen solution.",
    "created_at": "2017-05-18T08:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194760",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:17'></a>Ok, let's go with jeroen solution.



---

archive/issue_comments_194761.json:
```json
{
    "body": "<a id='comment:18'></a>You're right, this is fine.",
    "created_at": "2017-05-18T08:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194761",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>You're right, this is fine.



---

archive/issue_events_044910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-20T20:07:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15423#event-44910"
}
```



---

archive/issue_comments_194762.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-20T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15423#issuecomment-194762",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
