# Issue 15919: unrank via R[i] conflicts with notation for constructing polynomial rings in CartesianProduct

archive/issues_015682.json:
```json
{
    "assignees": [],
    "body": "\n```\nFF = IntegerModRing(29)\ntester = FF._tester()\nlist(tester.some_elements(CartesianProduct(FF, FF, FF)))\n```\nThis should give a list of 3-arrays of elements of Z/29. Instead I get:\n\n```\nsage: FF = IntegerModRing(29)\nsage: tester = FF._tester()\nsage: list(tester.some_elements(CartesianProduct(FF, FF, FF)))\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-3-5d7e71a13340> in <module>()\n----> 1 list(tester.some_elements(CartesianProduct(FF, FF, FF)))\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/misc/sage_unittest.pyc in some_elements(self, S)\n    498             if n > self._max_runs:\n    499                 from random import sample\n--> 500                 S = sample(S, self._max_runs)\n    501         except (TypeError, AttributeError):\n    502             # We already can't tell what the length of n is, so\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python/random.pyc in sample(self, population, k)\n    342                         j = _int(random() * n)\n    343                     selected_add(j)\n--> 344                     result[i] = population[j]\n    345             except (TypeError, KeyError):   # handle (at least) sets\n    346                 if isinstance(population, list):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/combinat.pyc in __getitem__(self, i)\n   1220             ValueError: the value must be between 0 and 2 inclusive\n   1221         \"\"\"\n-> 1222         return self.unrank(i)\n   1223 \n   1224     def __str__(self):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)\n    258             raise IndexError(\"x larger than the size of the Cartesian Product\")\n    259         positions.reverse()\n--> 260         return [L[i] for L,i in zip(self.iters, positions)]\n    261 \n    262     def random_element(self):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)\n    859 \n    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n--> 861             return PolynomialRing(self, elts)\n    862 \n    863     class ElementMethods:\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)\n    467                 raise TypeError(\"if second arguments is a string with no commas, then there must be no other non-optional arguments\")\n    468             name = arg1\n--> 469             R = _single_variate(base_ring, name, sparse, implementation)\n    470         else:\n    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)\n    518 def _single_variate(base_ring, name, sparse, implementation):\n    519     import sage.rings.polynomial.polynomial_ring as m\n--> 520     name = normalize_names(1, name)\n    521     key = (base_ring, name, sparse, implementation if not sparse else None)\n    522     R = _get_from_cache(key)\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()\n\nValueError: first letter of variable name must be a letter\n```\nAnd 29 is the smallest number where this seems to throw this error; also, it doesn't fail if I only take the cartesian product of two copies of the field.\n\nI get a similar error if I do `CartesianProduct(FF, FF).unrank(3)`, and this has been around for a while (not just since beta4):\n\n```\nsage: FF = IntegerModRing(3)\nsage: CartesianProduct(FF, FF).unrank(3)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-15-98d0a571cc61> in <module>()\n----> 1 CartesianProduct(FF, FF).unrank(Integer(3))\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)\n    258             raise IndexError(\"x larger than the size of the Cartesian Product\")\n    259         positions.reverse()\n--> 260         return [L[i] for L,i in zip(self.iters, positions)]\n    261 \n    262     def random_element(self):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)\n    859 \n    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n--> 861             return PolynomialRing(self, elts)\n    862 \n    863     class ElementMethods:\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)\n    467                 raise TypeError(\"if second arguments is a string with no commas, then there must be no other non-optional arguments\")\n    468             name = arg1\n--> 469             R = _single_variate(base_ring, name, sparse, implementation)\n    470         else:\n    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)\n    518 def _single_variate(base_ring, name, sparse, implementation):\n    519     import sage.rings.polynomial.polynomial_ring as m\n--> 520     name = normalize_names(1, name)\n    521     key = (base_ring, name, sparse, implementation if not sparse else None)\n    522     R = _get_from_cache(key)\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()\n\nValueError: first letter of variable name must be a letter\n```\nSo it seems that both bugs are due to the fancy `R[x]` syntax for polynomial rings conflicting with the `R[i]` syntax for the i-th element of an enumerated set `R`, and #8389 didn't cause the error, but at most exposed it better.\n\nThis reworks the `unrank` function in `sage.combinat.ranker` and uses it for the Cartesian product (this doesn't work for `ZZ`, see #16239). In followup tickets, we also want to be more systematic about using unrank in `TestSuite` and do better construction of `some_elements()` #16244.\n\nCC:  @mezzarobba @sagetrac-sage-combinat\n\nKeywords: **notation, algebra, polynomial**\n\nBranch/Commit: **[`79d4698`](https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Nicolas M. Thi\u00e9ry**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/15919_\n\n",
    "closed_at": "2014-05-08T08:02:30Z",
    "created_at": "2014-03-12T04:51:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "unrank via R[i] conflicts with notation for constructing polynomial rings in CartesianProduct",
    "type": "issue",
    "updated_at": "2014-05-08T08:02:30Z",
    "url": "https://github.com/sagemath/sage/issues/15919",
    "user": "https://github.com/darijgr"
}
```

```
FF = IntegerModRing(29)
tester = FF._tester()
list(tester.some_elements(CartesianProduct(FF, FF, FF)))
```
This should give a list of 3-arrays of elements of Z/29. Instead I get:

```
sage: FF = IntegerModRing(29)
sage: tester = FF._tester()
sage: list(tester.some_elements(CartesianProduct(FF, FF, FF)))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-3-5d7e71a13340> in <module>()
----> 1 list(tester.some_elements(CartesianProduct(FF, FF, FF)))

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/misc/sage_unittest.pyc in some_elements(self, S)
    498             if n > self._max_runs:
    499                 from random import sample
--> 500                 S = sample(S, self._max_runs)
    501         except (TypeError, AttributeError):
    502             # We already can't tell what the length of n is, so

/home/darij/gitsage/sage-5.13.beta1/local/lib/python/random.pyc in sample(self, population, k)
    342                         j = _int(random() * n)
    343                     selected_add(j)
--> 344                     result[i] = population[j]
    345             except (TypeError, KeyError):   # handle (at least) sets
    346                 if isinstance(population, list):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/combinat.pyc in __getitem__(self, i)
   1220             ValueError: the value must be between 0 and 2 inclusive
   1221         """
-> 1222         return self.unrank(i)
   1223 
   1224     def __str__(self):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)
    258             raise IndexError("x larger than the size of the Cartesian Product")
    259         positions.reverse()
--> 260         return [L[i] for L,i in zip(self.iters, positions)]
    261 
    262     def random_element(self):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)
    859 
    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
--> 861             return PolynomialRing(self, elts)
    862 
    863     class ElementMethods:

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)
    467                 raise TypeError("if second arguments is a string with no commas, then there must be no other non-optional arguments")
    468             name = arg1
--> 469             R = _single_variate(base_ring, name, sparse, implementation)
    470         else:
    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)
    518 def _single_variate(base_ring, name, sparse, implementation):
    519     import sage.rings.polynomial.polynomial_ring as m
--> 520     name = normalize_names(1, name)
    521     key = (base_ring, name, sparse, implementation if not sparse else None)
    522     R = _get_from_cache(key)

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()

ValueError: first letter of variable name must be a letter
```
And 29 is the smallest number where this seems to throw this error; also, it doesn't fail if I only take the cartesian product of two copies of the field.

I get a similar error if I do `CartesianProduct(FF, FF).unrank(3)`, and this has been around for a while (not just since beta4):

```
sage: FF = IntegerModRing(3)
sage: CartesianProduct(FF, FF).unrank(3)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-15-98d0a571cc61> in <module>()
----> 1 CartesianProduct(FF, FF).unrank(Integer(3))

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)
    258             raise IndexError("x larger than the size of the Cartesian Product")
    259         positions.reverse()
--> 260         return [L[i] for L,i in zip(self.iters, positions)]
    261 
    262     def random_element(self):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)
    859 
    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
--> 861             return PolynomialRing(self, elts)
    862 
    863     class ElementMethods:

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)
    467                 raise TypeError("if second arguments is a string with no commas, then there must be no other non-optional arguments")
    468             name = arg1
--> 469             R = _single_variate(base_ring, name, sparse, implementation)
    470         else:
    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)
    518 def _single_variate(base_ring, name, sparse, implementation):
    519     import sage.rings.polynomial.polynomial_ring as m
--> 520     name = normalize_names(1, name)
    521     key = (base_ring, name, sparse, implementation if not sparse else None)
    522     R = _get_from_cache(key)

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()

ValueError: first letter of variable name must be a letter
```
So it seems that both bugs are due to the fancy `R[x]` syntax for polynomial rings conflicting with the `R[i]` syntax for the i-th element of an enumerated set `R`, and #8389 didn't cause the error, but at most exposed it better.

This reworks the `unrank` function in `sage.combinat.ranker` and uses it for the Cartesian product (this doesn't work for `ZZ`, see #16239). In followup tickets, we also want to be more systematic about using unrank in `TestSuite` and do better construction of `some_elements()` #16244.

CC:  @mezzarobba @sagetrac-sage-combinat

Keywords: **notation, algebra, polynomial**

Branch/Commit: **[`79d4698`](https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8)**

Reviewer: **Travis Scrimshaw**

Author: **Nicolas M. Thiéry**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/15919_





---

archive/issue_events_227274.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-03-12T04:51:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227274"
}
```



---

archive/issue_events_227275.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-03-12T04:51:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227275"
}
```



---

archive/issue_events_227276.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-03-12T04:51:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227276"
}
```



---

archive/issue_events_227277.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2014-03-12T04:51:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227277"
}
```



---

archive/issue_comments_201838.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI think the bug is in unrank, not in the fact that rings use `__getitem__` in a funny way. The problem is that a Cartesian product can easily be constructed from iterables, and then should probably be iterable itself, but iterables are not necessarily indexable:\n\n```\nsage: V={1,2,3}\nsage: CartesianProduct(V,V).unrank(2)\nTypeError: 'set' object does not support indexing\nsage: [i for i in CartesianProduct(V,V)]\n[[1, 1], [1, 2], [1, 3], [2, 1], [2, 2], [2, 3], [3, 1], [3, 2], [3, 3]]\n```\nThe function \"unrank\" should only be applied to indexable cartesian products, i.e., cartesian products of indexables. That's not the same as iterables. In particular,\n\nSo the problem is really in `tester.some_elements`. Indeed, the offending code:\n\n```\n        try:\n            n = _len(S)\n            if n > self._max_runs:\n                from random import sample\n                S = sample(S, self._max_runs)\n        except (TypeError, AttributeError):\n```\ntries `sample` on `S`, which apparently leads to calls of the type `S[i]`. As you can see, the code is prepared to fail, but doesn't expect that to happen with a `ValueError`. I think this just shows that it's a bit callous to just try and index a structure and hope for the best.",
    "created_at": "2014-03-12T05:23:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201838",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2" align="right">comment:2</div>

I think the bug is in unrank, not in the fact that rings use `__getitem__` in a funny way. The problem is that a Cartesian product can easily be constructed from iterables, and then should probably be iterable itself, but iterables are not necessarily indexable:

```
sage: V={1,2,3}
sage: CartesianProduct(V,V).unrank(2)
TypeError: 'set' object does not support indexing
sage: [i for i in CartesianProduct(V,V)]
[[1, 1], [1, 2], [1, 3], [2, 1], [2, 2], [2, 3], [3, 1], [3, 2], [3, 3]]
```
The function "unrank" should only be applied to indexable cartesian products, i.e., cartesian products of indexables. That's not the same as iterables. In particular,

So the problem is really in `tester.some_elements`. Indeed, the offending code:

```
        try:
            n = _len(S)
            if n > self._max_runs:
                from random import sample
                S = sample(S, self._max_runs)
        except (TypeError, AttributeError):
```
tries `sample` on `S`, which apparently leads to calls of the type `S[i]`. As you can see, the code is prepared to fail, but doesn't expect that to happen with a `ValueError`. I think this just shows that it's a bit callous to just try and index a structure and hope for the best.



---

archive/issue_comments_201839.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHmm. So Sets are not required to define getitem in a reasonable way? Good to know.",
    "created_at": "2014-03-12T05:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201839",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:3" align="right">comment:3</div>

Hmm. So Sets are not required to define getitem in a reasonable way? Good to know.



---

archive/issue_comments_201840.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nNicolas Thi\u00e9ry suggested deprecating `R[n]` in favor of `R.unrank(n)` at least when `R` is a ring (see [#8389 comment:13](https://github.com/sagemath/sage/issues/8389#comment:13)), and I tend to agree. If you don't, could you please leave a comment at #15885?",
    "created_at": "2014-03-12T12:07:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201840",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:4" align="right">comment:4</div>

Nicolas Thiéry suggested deprecating `R[n]` in favor of `R.unrank(n)` at least when `R` is a ring (see [#8389 comment:13](https://github.com/sagemath/sage/issues/8389#comment:13)), and I tend to agree. If you don't, could you please leave a comment at #15885?



---

archive/issue_comments_201841.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI agree too if we can do this quickly enough. This is causing problems in #10963...",
    "created_at": "2014-03-12T13:39:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201841",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:5" align="right">comment:5</div>

I agree too if we can do this quickly enough. This is causing problems in #10963...



---

archive/issue_comments_201842.json:
```json
{
    "body": "Branch: **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)**",
    "created_at": "2014-03-13T12:37:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201842",
    "user": "https://github.com/nthiery"
}
```

Branch: **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)**



---

archive/issue_comments_201843.json:
```json
{
    "body": "Commit: **[`a4f7fc3`](https://github.com/sagemath/sagetrac-mirror/commit/a4f7fc34ad7d2ebebee5def1f7366a8bad9d0d83)**",
    "created_at": "2014-03-13T12:47:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201843",
    "user": "https://github.com/nthiery"
}
```

Commit: **[`a4f7fc3`](https://github.com/sagemath/sagetrac-mirror/commit/a4f7fc34ad7d2ebebee5def1f7366a8bad9d0d83)**



---

archive/issue_comments_201844.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe above branch takes a first step toward using more systematically the unrank protocol, in that case in `CartesianProduct`. This should improve the situation and could be deemed good enough for now, but is certainly not a final solution. Also, the unrank function I introduced might be too paranoid: it makes CartesianProduct.unrank work only with lists, tuples, Parents, xranges; there might be other inputs that are used around. All tests pass though (haven't tried long tests yet).\n\nI agree with Nils though: the sampling in the TestSuite should not be using [i] to do unranking, and probably should just assume that the object is iterable, and not necessarily unrankable. I'll have a look unless someone beats me to it.\n\nThe third alternative, explored by Darij in his branch, is to reinstate temporarily the notation FF[i] for unranking for IntegerModRing and friends.\n\nWhat do you think?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a4f7fc34ad7d2ebebee5def1f7366a8bad9d0d83\"><code>a4f7fc3</code></a></td><td><code>15919: a first step toward using more systematically the unrank protocol</code></td></tr></table>\n",
    "created_at": "2014-03-13T12:47:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201844",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:7" align="right">comment:7</div>

The above branch takes a first step toward using more systematically the unrank protocol, in that case in `CartesianProduct`. This should improve the situation and could be deemed good enough for now, but is certainly not a final solution. Also, the unrank function I introduced might be too paranoid: it makes CartesianProduct.unrank work only with lists, tuples, Parents, xranges; there might be other inputs that are used around. All tests pass though (haven't tried long tests yet).

I agree with Nils though: the sampling in the TestSuite should not be using [i] to do unranking, and probably should just assume that the object is iterable, and not necessarily unrankable. I'll have a look unless someone beats me to it.

The third alternative, explored by Darij in his branch, is to reinstate temporarily the notation FF[i] for unranking for IntegerModRing and friends.

What do you think?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a4f7fc34ad7d2ebebee5def1f7366a8bad9d0d83"><code>a4f7fc3</code></a></td><td><code>15919: a first step toward using more systematically the unrank protocol</code></td></tr></table>




---

archive/issue_events_227278.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2014-04-21T17:19:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227278"
}
```



---

archive/issue_comments_201845.json:
```json
{
    "body": "Changed commit from **[`a4f7fc3`](https://github.com/sagemath/sagetrac-mirror/commit/a4f7fc34ad7d2ebebee5def1f7366a8bad9d0d83)** to **[`d9b5fcd`](https://github.com/sagemath/sagetrac-mirror/commit/d9b5fcd5df001b38300788a963279bc0c8edf4b6)**",
    "created_at": "2014-04-22T19:36:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201845",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`a4f7fc3`](https://github.com/sagemath/sagetrac-mirror/commit/a4f7fc34ad7d2ebebee5def1f7366a8bad9d0d83)** to **[`d9b5fcd`](https://github.com/sagemath/sagetrac-mirror/commit/d9b5fcd5df001b38300788a963279bc0c8edf4b6)**



---

archive/issue_comments_201846.json:
```json
{
    "body": "Changed branch from **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)** to **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)**",
    "created_at": "2014-04-22T19:36:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201846",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)** to **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)**



---

archive/issue_comments_201847.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHey Nicolas,\n\nI've expanded upon what `unrank` can accept (all iterables, even if not in enumerated sets, should now work). I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5dfb2a2b25e60b0aa46006ecf73a6dc9ac014d46\"><code>5dfb2a2</code></a></td><td><code>Merge branch 'u/nthiery/ticket/15919' of trac.sagemath.org:sage into u/tscrim/ticket/15919</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9b8d022b2651e7f5b40f4a8364c2f29ffb3b55f1\"><code>9b8d022</code></a></td><td><code>Expanded what unrank can handle.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d9b5fcd5df001b38300788a963279bc0c8edf4b6\"><code>d9b5fcd</code></a></td><td><code>Added warning about iterator objects.</code></td></tr></table>\n",
    "created_at": "2014-04-22T19:36:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201847",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:9" align="right">comment:9</div>

Hey Nicolas,

I've expanded upon what `unrank` can accept (all iterables, even if not in enumerated sets, should now work). I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5dfb2a2b25e60b0aa46006ecf73a6dc9ac014d46"><code>5dfb2a2</code></a></td><td><code>Merge branch 'u/nthiery/ticket/15919' of trac.sagemath.org:sage into u/tscrim/ticket/15919</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9b8d022b2651e7f5b40f4a8364c2f29ffb3b55f1"><code>9b8d022</code></a></td><td><code>Expanded what unrank can handle.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d9b5fcd5df001b38300788a963279bc0c8edf4b6"><code>d9b5fcd</code></a></td><td><code>Added warning about iterator objects.</code></td></tr></table>




---

archive/issue_comments_201848.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nNot a review, just a tiny remark: the colon before the doctest in `cartesian_product.py` should be doubled.",
    "created_at": "2014-04-23T11:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201848",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:10" align="right">comment:10</div>

Not a review, just a tiny remark: the colon before the doctest in `cartesian_product.py` should be doubled.



---

archive/issue_comments_201849.json:
```json
{
    "body": "Changed commit from **[`d9b5fcd`](https://github.com/sagemath/sagetrac-mirror/commit/d9b5fcd5df001b38300788a963279bc0c8edf4b6)** to **[`2a5eaa5`](https://github.com/sagemath/sagetrac-mirror/commit/2a5eaa5afc10079d97a122e50372eb19c06d390a)**",
    "created_at": "2014-04-23T12:25:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201849",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d9b5fcd`](https://github.com/sagemath/sagetrac-mirror/commit/d9b5fcd5df001b38300788a963279bc0c8edf4b6)** to **[`2a5eaa5`](https://github.com/sagemath/sagetrac-mirror/commit/2a5eaa5afc10079d97a122e50372eb19c06d390a)**



---

archive/issue_comments_201850.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2a5eaa5afc10079d97a122e50372eb19c06d390a\"><code>2a5eaa5</code></a></td><td><code>Fixed double-colon.</code></td></tr></table>\n",
    "created_at": "2014-04-23T12:25:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201850",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2a5eaa5afc10079d97a122e50372eb19c06d390a"><code>2a5eaa5</code></a></td><td><code>Fixed double-colon.</code></td></tr></table>




---

archive/issue_comments_201851.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nHi Travis!\n\nThanks for the improvement! I made one further step, in particular to\navoid trapping too many exceptions; typical situation: a parent L that implements\nunranking as L[i] and raises an \"out of bound\" value error.\n\nI am still unhappy about the `unrank(ZZ,i)` returning something completely wrong (Integer Ring). In case a parent is iterable, I wonder if I would not prefer to prefer the Iterable strategy, and only use `__getitem__` if everything else has failed.\n\nCheers,\n                                        Nicolas",
    "created_at": "2014-04-25T16:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201851",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:12" align="right">comment:12</div>

Hi Travis!

Thanks for the improvement! I made one further step, in particular to
avoid trapping too many exceptions; typical situation: a parent L that implements
unranking as L[i] and raises an "out of bound" value error.

I am still unhappy about the `unrank(ZZ,i)` returning something completely wrong (Integer Ring). In case a parent is iterable, I wonder if I would not prefer to prefer the Iterable strategy, and only use `__getitem__` if everything else has failed.

Cheers,
                                        Nicolas



---

archive/issue_comments_201852.json:
```json
{
    "body": "Changed branch from **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)** to **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)**",
    "created_at": "2014-04-25T17:02:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201852",
    "user": "https://github.com/nthiery"
}
```

Changed branch from **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)** to **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)**



---

archive/issue_comments_201853.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@tscrim](#comment:9):\n> I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?\n\n+1. Let's focus here on what's needed for #10963.\n  \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f9b59fac8d518a946debc3555a43bdfaea4f1f90\"><code>f9b59fa</code></a></td><td><code>Merge branch 'develop=6.2.rc0' into ticket/15919-unrank</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bbd22f1422f7b643a55afabeb44cfd8204b7dd3b\"><code>bbd22f1</code></a></td><td><code>- Use `__getitem__` only on sequences and Parents not in EnumeratedSets</code></td></tr></table>\n",
    "created_at": "2014-04-25T17:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201853",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@tscrim](#comment:9):
> I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?

+1. Let's focus here on what's needed for #10963.
  
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f9b59fac8d518a946debc3555a43bdfaea4f1f90"><code>f9b59fa</code></a></td><td><code>Merge branch 'develop=6.2.rc0' into ticket/15919-unrank</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bbd22f1422f7b643a55afabeb44cfd8204b7dd3b"><code>bbd22f1</code></a></td><td><code>- Use `__getitem__` only on sequences and Parents not in EnumeratedSets</code></td></tr></table>




---

archive/issue_comments_201854.json:
```json
{
    "body": "Changed commit from **[`2a5eaa5`](https://github.com/sagemath/sagetrac-mirror/commit/2a5eaa5afc10079d97a122e50372eb19c06d390a)** to **[`bbd22f1`](https://github.com/sagemath/sagetrac-mirror/commit/bbd22f1422f7b643a55afabeb44cfd8204b7dd3b)**",
    "created_at": "2014-04-25T17:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201854",
    "user": "https://github.com/nthiery"
}
```

Changed commit from **[`2a5eaa5`](https://github.com/sagemath/sagetrac-mirror/commit/2a5eaa5afc10079d97a122e50372eb19c06d390a)** to **[`bbd22f1`](https://github.com/sagemath/sagetrac-mirror/commit/bbd22f1422f7b643a55afabeb44cfd8204b7dd3b)**



---

archive/issue_comments_201855.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAh shoot, the sampling issue actually occurs with #10963.\n\nAt this point I am tempted to remove the sampling altogether in\nInstanceTester.some_elements, and instead have it always return a list\n(or iterator?) of the first max_run elements (or less if `S` does not\nhave that many). Then, the only requirement on `S` would be to be\niterable.\n\nThe code would then just be:\n\n```\n    def some_elements(self, S=None):\n        if S is None:\n            if self._elements is None:\n                S = self._instance.some_elements()\n            else:\n                S = self._elements\n        import itertools\n        return list(itertools.islice(S,0,self._max_runs))\n```\n\nI am now running the tests with #10963 and this change.\n\nCheers,\n                                     Nicolas",
    "created_at": "2014-04-25T17:52:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201855",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:15" align="right">comment:15</div>

Ah shoot, the sampling issue actually occurs with #10963.

At this point I am tempted to remove the sampling altogether in
InstanceTester.some_elements, and instead have it always return a list
(or iterator?) of the first max_run elements (or less if `S` does not
have that many). Then, the only requirement on `S` would be to be
iterable.

The code would then just be:

```
    def some_elements(self, S=None):
        if S is None:
            if self._elements is None:
                S = self._instance.some_elements()
            else:
                S = self._elements
        import itertools
        return list(itertools.islice(S,0,self._max_runs))
```

I am now running the tests with #10963 and this change.

Cheers,
                                     Nicolas



---

archive/issue_comments_201856.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nWith just this change (and not the rest of the stuff in this branch), #10963 passes all tests.\n\nAt this point, I am tempted to split this ticket into two tickets:\n- One about fixing TestSuite/InstanceTester.some_elements to not use indexed access (sufficient for #10963)\n- One toward using the unrank protocol more systematically (in that case in CartesianProduct)\n\nWhat do you think?",
    "created_at": "2014-04-25T19:30:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201856",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:16" align="right">comment:16</div>

With just this change (and not the rest of the stuff in this branch), #10963 passes all tests.

At this point, I am tempted to split this ticket into two tickets:
- One about fixing TestSuite/InstanceTester.some_elements to not use indexed access (sufficient for #10963)
- One toward using the unrank protocol more systematically (in that case in CartesianProduct)

What do you think?



---

archive/issue_comments_201857.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\n(Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get \"most\" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.\n\nI'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).\n\nBest,\n\nTravis",
    "created_at": "2014-04-26T05:11:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201857",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

(Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get "most" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.

I'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).

Best,

Travis



---

archive/issue_comments_201858.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d2d335a2e833dfa58589a6453cd011ce05ccb4b\"><code>5d2d335</code></a></td><td><code>Merge branch 'develop' into u/tscrim/ticket/15919</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/382b9ff1fb969c6f9e01318c654a0e57cc74c89a\"><code>382b9ff</code></a></td><td><code>Merge branch 'u/nthiery/ticket/15919' of trac.sagemath.org:sage into u/tscrim/ticket/15919</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8\"><code>79d4698</code></a></td><td><code>Some last very minor tweaks to ranker.py.</code></td></tr></table>\n",
    "created_at": "2014-04-26T05:11:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201858",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d2d335a2e833dfa58589a6453cd011ce05ccb4b"><code>5d2d335</code></a></td><td><code>Merge branch 'develop' into u/tscrim/ticket/15919</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/382b9ff1fb969c6f9e01318c654a0e57cc74c89a"><code>382b9ff</code></a></td><td><code>Merge branch 'u/nthiery/ticket/15919' of trac.sagemath.org:sage into u/tscrim/ticket/15919</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8"><code>79d4698</code></a></td><td><code>Some last very minor tweaks to ranker.py.</code></td></tr></table>




---

archive/issue_comments_201859.json:
```json
{
    "body": "Changed branch from **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)** to **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)**",
    "created_at": "2014-04-26T05:11:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201859",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/nthiery/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/ticket/15919)** to **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)**



---

archive/issue_comments_201860.json:
```json
{
    "body": "Changed commit from **[`bbd22f1`](https://github.com/sagemath/sagetrac-mirror/commit/bbd22f1422f7b643a55afabeb44cfd8204b7dd3b)** to **[`79d4698`](https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8)**",
    "created_at": "2014-04-26T05:11:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201860",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`bbd22f1`](https://github.com/sagemath/sagetrac-mirror/commit/bbd22f1422f7b643a55afabeb44cfd8204b7dd3b)** to **[`79d4698`](https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8)**



---

archive/issue_comments_201861.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@tscrim](#comment:17):\n> (Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get \"most\" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.\n\nOk, glad to see we are on the same line. I have created #16244 for\njust this piece. I'll push my little change there later.\n\n> I'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).\n\nOk, I am happy with your change. So I guess this can be positive reviewed. There remains to update the description of this ticket to better reflect what has actually been done, and refer to the other ticket for the actual solution of the original issue.",
    "created_at": "2014-04-26T18:52:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201861",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@tscrim](#comment:17):
> (Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get "most" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.

Ok, glad to see we are on the same line. I have created #16244 for
just this piece. I'll push my little change there later.

> I'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).

Ok, I am happy with your change. So I guess this can be positive reviewed. There remains to update the description of this ticket to better reflect what has actually been done, and refer to the other ticket for the actual solution of the original issue.



---

archive/issue_events_227279.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-04-26T19:27:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227279"
}
```



---

archive/issue_events_227280.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-04-26T19:27:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227280"
}
```



---

archive/issue_events_227281.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2014-04-26T19:27:00Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "title_is": "unrank via R[i] conflicts with notation for constructing polynomial rings in CartesianProduct",
    "title_was": "Notation S[i] for i-th element of enumerated set S conflicts with notation R[x] for polynomial ring",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227281"
}
```



---

archive/issue_comments_201862.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -121,3 +121,5 @@\n ValueError: first letter of variable name must be a letter\n ```\n So it seems that both bugs are due to the fancy `R[x]` syntax for polynomial rings conflicting with the `R[i]` syntax for the i-th element of an enumerated set `R`, and #8389 didn't cause the error, but at most exposed it better.\n+\n+This reworks the `unrank` function in `sage.combinat.ranker` and uses it for the Cartesian product (this doesn't work for `ZZ`, see #16239). In followup tickets, we also want to be more systematic about using unrank in `TestSuite` and do better construction of `some_elements()` #16244.\n``````\n",
    "created_at": "2014-04-26T19:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201862",
    "user": "https://github.com/tscrim"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -121,3 +121,5 @@
 ValueError: first letter of variable name must be a letter
 ```
 So it seems that both bugs are due to the fancy `R[x]` syntax for polynomial rings conflicting with the `R[i]` syntax for the i-th element of an enumerated set `R`, and #8389 didn't cause the error, but at most exposed it better.
+
+This reworks the `unrank` function in `sage.combinat.ranker` and uses it for the Cartesian product (this doesn't work for `ZZ`, see #16239). In followup tickets, we also want to be more systematic about using unrank in `TestSuite` and do better construction of `some_elements()` #16244.
``````




---

archive/issue_comments_201863.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nDone and done.",
    "created_at": "2014-04-26T19:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201863",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">comment:20</div>

Done and done.



---

archive/issue_comments_201864.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2014-04-26T19:27:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201864",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_201865.json:
```json
{
    "body": "Author: **Nicolas M. Thi\u00e9ry**",
    "created_at": "2014-04-26T19:27:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201865",
    "user": "https://github.com/tscrim"
}
```

Author: **Nicolas M. Thiéry**



---

archive/issue_comments_201866.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThanks Travis!",
    "created_at": "2014-04-26T21:16:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201866",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:22" align="right">comment:22</div>

Thanks Travis!



---

archive/issue_comments_201867.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThe only thing that somewhat worries me is the speed. Before:\n\n```\nsage: T = range(20)\nsage: C = CartesianProduct(T,T,T)\nsage: %timeit C.unrank(3)\n100000 loops, best of 3: 15 \u00b5s per loop\n```\nAfter:\n\n```\nsage: T = range(20)\nsage: C = CartesianProduct(T,T,T)\nsage: %timeit C.unrank(3)\n10000 loops, best of 3: 35.5 \u00b5s per loop\n```\n(These timings are fairly independent on the 20 and the 3...)\n\nI don't know how often this unranking is used, though, and whether these \u00b5s add up...",
    "created_at": "2014-04-27T05:50:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201867",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:23" align="right">comment:23</div>

The only thing that somewhat worries me is the speed. Before:

```
sage: T = range(20)
sage: C = CartesianProduct(T,T,T)
sage: %timeit C.unrank(3)
100000 loops, best of 3: 15 µs per loop
```
After:

```
sage: T = range(20)
sage: C = CartesianProduct(T,T,T)
sage: %timeit C.unrank(3)
10000 loops, best of 3: 35.5 µs per loop
```
(These timings are fairly independent on the 20 and the 3...)

I don't know how often this unranking is used, though, and whether these µs add up...



---

archive/issue_comments_201868.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@darijgr](#comment:23):\n> The only thing that somewhat worries me is the speed. Before:\n> ...\n> I don't know how often this unranking is used, though, and whether these \u00b5s add up...\n\nAh good point; the `isinstance` and `in EnumeratedSets` checks cause a little\noverhead which is non negligible for inputs that have super fast\nunranking (like lists).\n\nMy impression is that this unranking is not used much. If it really\nbecame a bottleneck, a reasonable fix would be to have\nCartesianProduct build unranking functions once for all upon the first\nunrank (I started toying with this in\nu/nthiery/15919-unrank-unrank-from), so that the above checks would be\ndone only once.\n\nBesides, things should eventually resolve by themselves as CartesianProduct gets\nprogressively replaced by cartesian_product (for which the inputs are\nparents, or coerced into parents), and parents implement more\nsystematically the unrank protocol.\n\nSo altogether, in this balance between overhead and correctness, I\nwould lean here toward correctness. What do you think?",
    "created_at": "2014-04-27T22:18:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201868",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@darijgr](#comment:23):
> The only thing that somewhat worries me is the speed. Before:
> ...
> I don't know how often this unranking is used, though, and whether these µs add up...

Ah good point; the `isinstance` and `in EnumeratedSets` checks cause a little
overhead which is non negligible for inputs that have super fast
unranking (like lists).

My impression is that this unranking is not used much. If it really
became a bottleneck, a reasonable fix would be to have
CartesianProduct build unranking functions once for all upon the first
unrank (I started toying with this in
u/nthiery/15919-unrank-unrank-from), so that the above checks would be
done only once.

Besides, things should eventually resolve by themselves as CartesianProduct gets
progressively replaced by cartesian_product (for which the inputs are
parents, or coerced into parents), and parents implement more
systematically the unrank protocol.

So altogether, in this balance between overhead and correctness, I
would lean here toward correctness. What do you think?



---

archive/issue_comments_201869.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI am not suggesting to go against correctness! My original idea on this ticket was to de-prioritize the notation `R[x]` for a polynomial ring or a subalgebra generated by `x`, because that notation is really syntactic sugar. So it's speed vs. convenience. But looking at Travis's posts I am no longer sure if this would have fixed all issues. Anyway, since unrank and CartesianProduct aren't very much used together, this is not an issue.",
    "created_at": "2014-04-28T00:03:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201869",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:25" align="right">comment:25</div>

I am not suggesting to go against correctness! My original idea on this ticket was to de-prioritize the notation `R[x]` for a polynomial ring or a subalgebra generated by `x`, because that notation is really syntactic sugar. So it's speed vs. convenience. But looking at Travis's posts I am no longer sure if this would have fixed all issues. Anyway, since unrank and CartesianProduct aren't very much used together, this is not an issue.



---

archive/issue_comments_201870.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@darijgr](#comment:25):\n> I am not suggesting to go against correctness!\n\nOops, sorry if my wording involuntarily implied this :-) I just meant\nthat I was ready paying a little speed overhead as a price for a\nsolution of the problem. And I agree the problem worked on this ticket\n(being cleaner with unrank versus `__getitem__`) has deviated from the\noriginal one. Not so bad since I believe this + #16244 fixes\nreasonably the original problem.\n\nUnless someone raises an objection now, this is good to go!\n\nThanks to both of you.",
    "created_at": "2014-04-28T08:13:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201870",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@darijgr](#comment:25):
> I am not suggesting to go against correctness!

Oops, sorry if my wording involuntarily implied this :-) I just meant
that I was ready paying a little speed overhead as a price for a
solution of the problem. And I agree the problem worked on this ticket
(being cleaner with unrank versus `__getitem__`) has deviated from the
original one. Not so bad since I believe this + #16244 fixes
reasonably the original problem.

Unless someone raises an objection now, this is good to go!

Thanks to both of you.



---

archive/issue_events_227282.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227282"
}
```



---

archive/issue_events_227283.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227283"
}
```



---

archive/issue_comments_201871.json:
```json
{
    "body": "Changed branch from **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)** to **[`79d4698`](https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8)**",
    "created_at": "2014-05-08T08:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15919#issuecomment-201871",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/tscrim/ticket/15919](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/ticket/15919)** to **[`79d4698`](https://github.com/sagemath/sagetrac-mirror/commit/79d469861431ac8d6be5ad4edeace1c6ac8a62c8)**



---

archive/issue_events_227284.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-08T08:02:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227284"
}
```



---

archive/issue_events_227285.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "9490e5ee5c91bb6870a90061625e2f9818a28516",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2014-05-08T08:02:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15919",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15919#event-227285"
}
```
