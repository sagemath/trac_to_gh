# Issue 15138: BuiltinFunction._is_registered is giving false negatives

archive/issues_014901.json:
```json
{
    "body": "This is easily encountered by the following:\n\n```python\nsage: loads(dumps(sin)) == sin # derives from GinacFunction\nTrue\nsage: loads(dumps(cot)) == cot # should also be True\nFalse\n```\n\n**Branch/Commit:** [4c04c344e42858e0722b19bc9cc83a265b1a9a61](https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61)\n\n**Reviewer:** Ralf Stephan\n\n**Author:** R. Andrew Ohana\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15138\n\n",
    "closed_at": "2014-04-01T16:54:06Z",
    "created_at": "2013-09-02T02:01:07Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "BuiltinFunction._is_registered is giving false negatives",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15138",
    "user": "https://github.com/ohanar"
}
```
This is easily encountered by the following:

```python
sage: loads(dumps(sin)) == sin # derives from GinacFunction
True
sage: loads(dumps(cot)) == cot # should also be True
False
```

**Branch/Commit:** [4c04c344e42858e0722b19bc9cc83a265b1a9a61](https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61)

**Reviewer:** Ralf Stephan

**Author:** R. Andrew Ohana

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/15138





---

archive/issue_comments_243665.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe following seems to fix the issue:\n\n```diff\n@@ -853,18 +853,12 @@ cdef class BuiltinFunction(Function):\n \n         # if match, get operator from function table\n         global sfunction_serial_dict\n-        if serial != -1 and sfunction_serial_dict.has_key(self._name) and \\\n-                sfunction_serial_dict[self._name].__class__ == self.__class__:\n+        if serial != -1 and sfunction_serial_dict.has_key(serial) and \\\n+                sfunction_serial_dict[serial].__class__ == self.__class__:\n                     # if the returned function is of the same type\n                     self._serial = serial\n                     return True\n \n-        # search the function table to check if any of this type\n-        for key, val in sfunction_serial_dict.iteritems():\n-            if key == self._name and val.__class__ == self.__class__:\n-                self._serial = key\n-                return True\n-\n         return False\n \n     def __reduce__(self):\n```\n\n\nI don't know the code, so I don't know what other implications this change might have (I didn't run the test suite).",
    "created_at": "2013-09-02T02:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243665",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:2'></a>
The following seems to fix the issue:

```diff
@@ -853,18 +853,12 @@ cdef class BuiltinFunction(Function):
 
         # if match, get operator from function table
         global sfunction_serial_dict
-        if serial != -1 and sfunction_serial_dict.has_key(self._name) and \
-                sfunction_serial_dict[self._name].__class__ == self.__class__:
+        if serial != -1 and sfunction_serial_dict.has_key(serial) and \
+                sfunction_serial_dict[serial].__class__ == self.__class__:
                     # if the returned function is of the same type
                     self._serial = serial
                     return True
 
-        # search the function table to check if any of this type
-        for key, val in sfunction_serial_dict.iteritems():
-            if key == self._name and val.__class__ == self.__class__:
-                self._serial = key
-                return True
-
         return False
 
     def __reduce__(self):
```


I don't know the code, so I don't know what other implications this change might have (I didn't run the test suite).



---

archive/issue_events_050031.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15138#event-50031"
}
```



---

archive/issue_comments_243666.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2014-02-22T14:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243666",
    "user": "https://github.com/rwst"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_243667.json:
```json
{
    "body": "**Branch:** [u/rws/ticket/15138](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/ticket/15138)",
    "created_at": "2014-03-27T10:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243667",
    "user": "https://github.com/rwst"
}
```

**Branch:** [u/rws/ticket/15138](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/ticket/15138)



---

archive/issue_comments_243668.json:
```json
{
    "body": "**Author:** R. Andrew Ohana",
    "created_at": "2014-03-27T10:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243668",
    "user": "https://github.com/rwst"
}
```

**Author:** R. Andrew Ohana



---

archive/issue_comments_243669.json:
```json
{
    "body": "**Reviewer:** Ralf Stephan",
    "created_at": "2014-03-27T10:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243669",
    "user": "https://github.com/rwst"
}
```

**Reviewer:** Ralf Stephan



---

archive/issue_comments_243670.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2014-03-27T10:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243670",
    "user": "https://github.com/rwst"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_243671.json:
```json
{
    "body": "**Commit:** [4c04c344e42858e0722b19bc9cc83a265b1a9a61](https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61)",
    "created_at": "2014-03-27T10:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243671",
    "user": "https://github.com/rwst"
}
```

**Commit:** [4c04c344e42858e0722b19bc9cc83a265b1a9a61](https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61)



---

archive/issue_comments_243672.json:
```json
{
    "body": "<a id='comment:5'></a>\nCannot see any problems, long tests fine in symbolic. I adapted the patch to newer code, added a doctest for this.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61\">4c04c34</a></td><td><code>Trac #15138: reviewer's patch: adapt to new code, add doctest</code></td></tr></table>\n",
    "created_at": "2014-03-27T10:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243672",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>
Cannot see any problems, long tests fine in symbolic. I adapted the patch to newer code, added a doctest for this.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61">4c04c34</a></td><td><code>Trac #15138: reviewer's patch: adapt to new code, add doctest</code></td></tr></table>




---

archive/issue_comments_243673.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2014-04-01T16:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243673",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_comments_243674.json:
```json
{
    "body": "**Changing branch** from \"[u/rws/ticket/15138](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/ticket/15138)\" to \"[4c04c344e42858e0722b19bc9cc83a265b1a9a61](https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61)\".",
    "created_at": "2014-04-01T16:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15138#issuecomment-243674",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/rws/ticket/15138](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/ticket/15138)" to "[4c04c344e42858e0722b19bc9cc83a265b1a9a61](https://github.com/sagemath/sagetrac-mirror/commit/4c04c344e42858e0722b19bc9cc83a265b1a9a61)".



---

archive/issue_events_050032.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-01T16:54:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15138",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15138#event-50032"
}
```
