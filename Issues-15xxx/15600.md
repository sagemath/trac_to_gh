# Issue 15600: Skip polredbest() for large extensions in exact computations in QQbar

archive/issues_015363.json:
```json
{
    "body": "`QQbar` and `AA` are very slow, to the point of often being unusable. There are many reasons to that (see #18333), including computations being triggered when they shouldn't, internal operations that construct elements of large degree, and incomplete of caching in some places. Yet the most visible issue by far is that, each time a new extension is constructed internally, we try to optimize its representation using PARI's `polredbest()`. This is bad, since `polredbest()` can easily take days for moderately large extensions, and only made worse by other issues that lead to lots of large extensions being created.\n\nThe reasons I can see to call `polredbest()` are:\n* to limit the creation of isomorphic number fields (but with no guarantee that we'll avoid it completely),\n* to speed up subsequent computations in these number fields,\n* and perhaps also, in simple cases, to make the elements more readable.\nNone of these is worth letting simple computations hang forever.\n\nThis ticket restricts the optimization step using `polredbest()` to cases where (based on the size of the defining polynomial) it can be expected to finish in reasonable time.\n\nCC:  @jdemeyer @gagern @videlec @cheuberg\n\nReviewer: Vincent Delecroix\n\nAuthor: Marc Mezzarobba\n\nBranch: beb66ebbee4f61a7febfa3a27d6359ac39a62636\n\nCommit: beb66ebbee4f61a7febfa3a27d6359ac39a62636\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/15600\n\n",
    "closed_at": "2019-01-01T09:51:24Z",
    "created_at": "2013-12-28T11:13:58Z",
    "labels": [
        "component: performance",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Skip polredbest() for large extensions in exact computations in QQbar",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15600",
    "user": "https://github.com/mezzarobba"
}
```
`QQbar` and `AA` are very slow, to the point of often being unusable. There are many reasons to that (see #18333), including computations being triggered when they shouldn't, internal operations that construct elements of large degree, and incomplete of caching in some places. Yet the most visible issue by far is that, each time a new extension is constructed internally, we try to optimize its representation using PARI's `polredbest()`. This is bad, since `polredbest()` can easily take days for moderately large extensions, and only made worse by other issues that lead to lots of large extensions being created.

The reasons I can see to call `polredbest()` are:
* to limit the creation of isomorphic number fields (but with no guarantee that we'll avoid it completely),
* to speed up subsequent computations in these number fields,
* and perhaps also, in simple cases, to make the elements more readable.
None of these is worth letting simple computations hang forever.

This ticket restricts the optimization step using `polredbest()` to cases where (based on the size of the defining polynomial) it can be expected to finish in reasonable time.

CC:  @jdemeyer @gagern @videlec @cheuberg

Reviewer: Vincent Delecroix

Author: Marc Mezzarobba

Branch: beb66ebbee4f61a7febfa3a27d6359ac39a62636

Commit: beb66ebbee4f61a7febfa3a27d6359ac39a62636

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/15600





---

archive/issue_comments_197805.json:
```json
{
    "body": "<a id='comment:1'></a>I don't think this is the right solution, using caching would be a better idea I think. In fact, in the code there are various places with\n\n```\n# XXX need more caching here\n```",
    "created_at": "2013-12-28T11:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197805",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>I don't think this is the right solution, using caching would be a better idea I think. In fact, in the code there are various places with

```
# XXX need more caching here
```



---

archive/issue_comments_197806.json:
```json
{
    "body": "<a id='comment:2'></a>I agree that QQbar *also* needs more caching. (And not only in the marked places. For instance, look how many times `nfinit` is called by `sage_input(pol.roots(...,ring=QQbar), verify=True)`: it seems to me that lots of expensive purely algebraic computations could be performed only once when we have `AlgebraicGenerator`s corresponding to several roots of the same irreducible polynomial.)\n\nBut even with caching, is it reasonable to spend tens of seconds optimizing the representation of an extension that may be used only once to check that some expression is zero?",
    "created_at": "2013-12-28T12:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197806",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:2'></a>I agree that QQbar *also* needs more caching. (And not only in the marked places. For instance, look how many times `nfinit` is called by `sage_input(pol.roots(...,ring=QQbar), verify=True)`: it seems to me that lots of expensive purely algebraic computations could be performed only once when we have `AlgebraicGenerator`s corresponding to several roots of the same irreducible polynomial.)

But even with caching, is it reasonable to spend tens of seconds optimizing the representation of an extension that may be used only once to check that some expression is zero?



---

archive/issue_comments_197807.json:
```json
{
    "body": "<a id='comment:3'></a>I asked Karim Belabas. Here is what I understand of his answer:\n* the cost of `polredbest` for a polynomial of degree `n` with coefficients of bit size `B` is roughly `n^5 B^2`;\n* the best it can do is to reduce the cost of subsequent computations in the extension by a factor of roughly `B^2`;\n* it is essentially never worth calling it on polynomials of moderately large degree;\n* ...except before performing very expensive operations (typically `bnfinit()`) on the extension, when there is reason to expect that it will find a defining polynomial of very small height.\n\nOn a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large. Karim suggested that the Pari function `rnfpolredbest` could be useful in this case.",
    "created_at": "2014-01-15T17:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197807",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>I asked Karim Belabas. Here is what I understand of his answer:
* the cost of `polredbest` for a polynomial of degree `n` with coefficients of bit size `B` is roughly `n^5 B^2`;
* the best it can do is to reduce the cost of subsequent computations in the extension by a factor of roughly `B^2`;
* it is essentially never worth calling it on polynomials of moderately large degree;
* ...except before performing very expensive operations (typically `bnfinit()`) on the extension, when there is reason to expect that it will find a defining polynomial of very small height.

On a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large. Karim suggested that the Pari function `rnfpolredbest` could be useful in this case.



---

archive/issue_events_045652.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45652"
}
```



---

archive/issue_events_045653.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45653"
}
```



---

archive/issue_events_045654.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45654"
}
```



---

archive/issue_events_045655.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45655"
}
```



---

archive/issue_events_045656.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45656"
}
```



---

archive/issue_comments_197808.json:
```json
{
    "body": "<a id='comment:7'></a>I agree that dropping that function seems a reasonable approach to the problem at hand. In particular, if we follow the idea from #17886 then operations within a single number field would become even rarer, so the benefit of a reduced basis would be less as well.\n\nAs a middle ground, it might be possible to do the reduction lazily, once it looks as if there would be a sufficient number of operations performed in the same number field to justify the time spent for this computation. But since implementing this could be a major effort, I'm not really suggesting this approach, just mentioning it as an idea if there is too much objection to dropping the reduction altogether.\n\nHere is one example which doesn't complete in over 6 hours, due to the call to `polredbest`. I had this as the motivating example for #17896 which looks like a duplicate of this one here.\n\n```\nsage: x,y = polygens(QQ,\"x,y\")\nsage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422\nsage: p2 = p1(x=(x-1)^2)\nsage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()\nsage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]\nsage: ival = CIF((0.77, 0.78), (-0.08, -0.07))\nsage: z, = [r for r in p4.roots(QQbar, False) if r in ival]\nsage: %time z.exactify()\n```",
    "created_at": "2015-04-18T19:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197808",
    "user": "https://github.com/gagern"
}
```

<a id='comment:7'></a>I agree that dropping that function seems a reasonable approach to the problem at hand. In particular, if we follow the idea from #17886 then operations within a single number field would become even rarer, so the benefit of a reduced basis would be less as well.

As a middle ground, it might be possible to do the reduction lazily, once it looks as if there would be a sufficient number of operations performed in the same number field to justify the time spent for this computation. But since implementing this could be a major effort, I'm not really suggesting this approach, just mentioning it as an idea if there is too much objection to dropping the reduction altogether.

Here is one example which doesn't complete in over 6 hours, due to the call to `polredbest`. I had this as the motivating example for #17896 which looks like a duplicate of this one here.

```
sage: x,y = polygens(QQ,"x,y")
sage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422
sage: p2 = p1(x=(x-1)^2)
sage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()
sage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]
sage: ival = CIF((0.77, 0.78), (-0.08, -0.07))
sage: z, = [r for r in p4.roots(QQbar, False) if r in ival]
sage: %time z.exactify()
```



---

archive/issue_events_045657.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-12-23T08:02:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45657"
}
```



---

archive/issue_events_045658.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-12-23T08:02:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45658"
}
```



---

archive/issue_comments_197809.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-23T08:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197809",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_197810.json:
```json
{
    "body": "<a id='comment:8'></a>I'd like to revive this ticket. It's been five years, and (in spite of a bit of progress on related issues), there is still no other viable solution. While the change suggested here will not make QQbar very fast, it can at least make it usable.\n\n---\nNew commits:",
    "created_at": "2018-12-23T08:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197810",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:8'></a>I'd like to revive this ticket. It's been five years, and (in spite of a bit of progress on related issues), there is still no other viable solution. While the change suggested here will not make QQbar very fast, it can at least make it usable.

---
New commits:



---

archive/issue_comments_197811.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:3 mmezzarobba]:\n> On a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large.\n\n\nAs we realized with Pascal Molin, this is related in particular to #26898. What used to happen is that hashing an algebraic number \u03b1 would trigger the exact computation, not just of\u00a0\u03b1 itself, but of the *real and imaginary parts* of \u03b1\u00a0*+\u00a0\u03b2* for some \u03b2\u00a0\u2208\u00a0\u211a[i]...",
    "created_at": "2018-12-23T08:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197811",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:9'></a>Replying to [comment:3 mmezzarobba]:
> On a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large.


As we realized with Pascal Molin, this is related in particular to #26898. What used to happen is that hashing an algebraic number α would trigger the exact computation, not just of α itself, but of the *real and imaginary parts* of α *+ β* for some β ∈ ℚ[i]...



---

archive/issue_comments_197812.json:
```json
{
    "body": "<a id='comment:10'></a>Just a copy of the example in #21095 that never terminates\n\n```\nsage: x = polygen(ZZ)\nsage: p = 67*x^4 - 33*x^3 + 94*x^2 - 30*x + 57\nsage: r = p.roots(QQbar, multiplicities=False)\nsage: r[0].abs().exactify()  # <- takes forever\n```",
    "created_at": "2018-12-23T09:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197812",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>Just a copy of the example in #21095 that never terminates

```
sage: x = polygen(ZZ)
sage: p = 67*x^4 - 33*x^3 + 94*x^2 - 30*x + 57
sage: r = p.roots(QQbar, multiplicities=False)
sage: r[0].abs().exactify()  # <- takes forever
```



---

archive/issue_comments_197813.json:
```json
{
    "body": "<a id='comment:11'></a>Do you have some timings that make you decide about this threshold?",
    "created_at": "2018-12-23T09:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197813",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Do you have some timings that make you decide about this threshold?



---

archive/issue_comments_197814.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 vdelecroix]:\n> Do you have some timings that make you decide about this threshold?\n\n\nNothing rigorous. But for instance, degree 40 with 30-bit coefficients seems to take a second or two, degree 60 (still with 30-bit coeffs) ~9s, and  degree 80 more than 30s.",
    "created_at": "2018-12-23T10:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197814",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:12'></a>Replying to [comment:11 vdelecroix]:
> Do you have some timings that make you decide about this threshold?


Nothing rigorous. But for instance, degree 40 with 30-bit coefficients seems to take a second or two, degree 60 (still with 30-bit coeffs) ~9s, and  degree 80 more than 30s.



---

archive/issue_comments_197815.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-25T10:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197815",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197816.json:
```json
{
    "body": "<a id='comment:14'></a>This is a good move! Thanks.",
    "created_at": "2018-12-31T08:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197816",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>This is a good move! Thanks.



---

archive/issue_comments_197817.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-31T08:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197817",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_045659.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-12-31T08:19:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45659"
}
```



---

archive/issue_events_045660.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-12-31T08:19:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45660"
}
```



---

archive/issue_comments_197818.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-01T09:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15600#issuecomment-197818",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_045661.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-01T09:51:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15600",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15600#event-45661"
}
```
