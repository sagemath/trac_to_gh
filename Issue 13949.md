# Issue 13949: Add Unicode support to the doctesting framework

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-02-20 22:03:46

Assignee: mvngu

CC:  leif embray jdemeyer hivert

Support
1. Doctest (i.e. `sage:`) lines containing non-ASCII characters.
1. Doctest results containing non-ASCII characters.
1. Print statements outputting non-ASCII characters inside doctests.
1. Source files with a [PEP 0263](http://www.python.org/dev/peps/pep-0263/) encoding declaration.


---

Attachment


---

Comment by fbissey created at 2013-03-19 23:15:02

I just tried this patch on the suspicion it could help with the test weirdness I reported in 5.9.beta0 on sage-release

```
sage -t --long devel/sage-main/sage/misc/interpreter.py
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 150, in 
sage.misc.interpreter.sage_prompt
Failed example:
    shell.run_cell('sage_prompt()')
Expected:
    u'sage'
Got:
    u'sage'
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 187, in 
sage.misc.interpreter.SageInteractiveShell.system_raw
Failed example:
    shell.system_raw('R --version')
Expected:
    R version ...
Got:
    WARNING: ignoring environment value of R_HOME
    R version 2.15.2 (2012-10-26) -- "Trick or Treat"
    Copyright (C) 2012 The R Foundation for Statistical Computing
    ISBN 3-900051-07-0
    Platform: x86_64-unknown-linux-gnu (64-bit)
    <BLANKLINE>
    R is free software and comes with ABSOLUTELY NO WARRANTY.
    You are welcome to redistribute it under the terms of the
    GNU General Public License versions 2 or 3.
    For more information about these matters see
    http://www.gnu.org/licenses/.
    <BLANKLINE>
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 566, in 
sage.misc.interpreter.interface_shell_embed
Failed example:
    shell.run_cell('List( [1..10], IsPrime )')
Expected:
    [ false, true, true, false, true, false, true, false, false, false ]
Got:
    [ false, true, true, false, true, false, true, false, false, false ]
**********************************************************************
3 items had failures:
   1 of  15 in sage.misc.interpreter.SageInteractiveShell.system_raw
   1 of   4 in sage.misc.interpreter.interface_shell_embed
   1 of   4 in sage.misc.interpreter.sage_prompt
    [107 tests, 3 failures, 2.4 s]
```

The R error was fixed by unsetting R_HOME before running the test. Then I applied the patch and here is the result

```
sage -t --long devel/sage-main/sage/misc/interpreter.py
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 150, in sage.misc.interpreter.sage_prompt
Failed example:
    shell.run_cell('sage_prompt()')
Expected:
    u'sage'
Got:
    u'sage'
    ---------------------------------------------------------------------------
    AttributeError                            Traceback (most recent call last)
    <ipython-input-1-e17c2c2153ac> in <module>()
    ----> 1 sage_prompt()
    
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
        240             self.update_user_ns(result)
        241             self.log_output(format_dict)
    --> 242             self.finish_displayhook()
        243 
        244     def flush(self):
    <BLANKLINE>
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in finish_displayhook(self)
        224         """Finish up all displayhook activities."""
        225         io.stdout.write(self.shell.separate_out2)
    --> 226         io.stdout.flush()
        227 
        228     def __call__(self, result=None):
    <BLANKLINE>
    AttributeError: IOStream instance has no attribute 'flush'
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 566, in sage.misc.interpreter.interface_shell_embed
Failed example:
    shell.run_cell('List( [1..10], IsPrime )')
Expected:
    [ false, true, true, false, true, false, true, false, false, false ]
Got:
    [ false, true, true, false, true, false, true, false, false, false ]
    ---------------------------------------------------------------------------
    AttributeError                            Traceback (most recent call last)
    <ipython-input-1-a772973ec1ce> in <module>()
    ----> 1 sage.misc.all.logstr("""[ false, true, true, false, true, false, true, false, false, false ]""")
    
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
        240             self.update_user_ns(result)
        241             self.log_output(format_dict)
    --> 242             self.finish_displayhook()
        243 
        244     def flush(self):
    <BLANKLINE>
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in finish_displayhook(self)
        224         """Finish up all displayhook activities."""
        225         io.stdout.write(self.shell.separate_out2)
    --> 226         io.stdout.flush()
        227 
        228     def __call__(self, result=None):
    <BLANKLINE>
    AttributeError: IOStream instance has no attribute 'flush'
**********************************************************************
2 items had failures:
   1 of   4 in sage.misc.interpreter.interface_shell_embed
   1 of   4 in sage.misc.interpreter.sage_prompt
    [107 tests, 2 failures, 3.0 s]
```



---

Comment by roed created at 2013-03-28 22:44:55

Changing assignee from mvngu to roed.


---

Comment by roed created at 2013-03-28 22:44:55

Changing component from doctest to doctest framework.


---

Comment by jdemeyer created at 2016-08-12 09:17:05

Changing keywords from "" to "python3".


---

Comment by chapoton created at 2016-11-10 20:13:58

just made a branch from the old patch, not tried to test it
----
New commits:


---

Comment by git created at 2017-01-18 10:59:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-01-18 16:15:02

I have repaired a detail, but this is not working, in several distinct ways.

This seems to be broken on lines having unicode characters in comments such as:

```
sage: 0 + 0    # c'est trop bête
```


Some doctests come from the notebook, I made a pull request.

A failing doctest in src/sage/misc/rest_index_of_methods.py
is related to the presence of "Lov\xc3\xa1sz theta"


---

Comment by chapoton created at 2017-01-18 16:53:52

seems that something like that is hurting us (in forker):

```
sage: md=hashlib.md5()
sage: md.update(u'été')
---------------------------------------------------------------------------
UnicodeEncodeError                        Traceback (most recent call last)
<ipython-input-9-6a9959b36b47> in <module>()
----> 1 md.update(u'été')

UnicodeEncodeError: 'ascii' codec can't encode character u'\xe9' in position 0: ordinal not in range(128)
```

solution: encode ?

```
sage: md.update(u'été'.encode('utf8'))
```



---

Comment by chapoton created at 2017-01-18 17:01:06

* another problem in src/sage/misc/cachefunc.pyx with a mu:

```
398:    625 loops, best of 3: 1.3 µs per loop
```

and same in 
src/sage/combinat/designs/evenly_distributed_sets.pyx
and in src/sage/structure/list_clone_timings.py

* in src/sage_setup/autogen/pari/doc.py, some unicode strings with no u:

```
113:    doc = doc.replace("`@`[pm]", "±")
115:    doc = doc.replace("`@`[agrave]", "à")
116:    doc = doc.replace("`@`[aacute]", "á")
117:    doc = doc.replace("`@`[eacute]", "é")
118:    doc = doc.replace("`@`[ouml]", "ö")
119:    doc = doc.replace("`@`[uuml]", "ü")
120:    doc = doc.replace("\\'{a}", "á")
```



---

Comment by git created at 2017-01-19 12:25:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-04-26 12:56:28

This should be taken care of.


---

Comment by git created at 2017-04-30 18:24:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-01 12:08:30

Changing keywords from "python3" to "python3, unicode".


---

Comment by embray created at 2017-05-02 08:23:41

Looks fine to me, though I did not test it.  I'm amazed there isn't anything in the stdlib to check the PEP 263 coding line, but if there is I couldn't find it.

This will be nice to have.  It reminds me of my thought the other day to propose adding a few unicode constants (and the ability to tab-complete them easily) to Sage (e.g. for pi).  Has that been proposed before?


---

Comment by chapoton created at 2017-05-02 10:06:21

I have not tested either, so far. May launch my patchbot on the branch later.


---

Comment by chapoton created at 2017-05-03 08:32:54

The patchbot is not happy at all !

One example of failure:

```
File "src/doc/ja/a_tour_of_sage/index.rst", line 39, in doc.ja.a_tour_of_sage.index
Failed example:
    x = var('x')   # 記号変数を定義
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 520, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 896, in compile_and_execute
        self.update_digests(example)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 783, in update_digests
        self.running_global_digest.update(s)
    UnicodeEncodeError: 'ascii' codec can't encode characters in position 20-26: ordinal not in range(128)
```


Another kind of example:

```
File "src/sage/ext/fast_callable.pyx", line 34, in sage.ext.fast_callable
Failed example:
    timeit('wilk.subs(x=30)') # random, long time
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 520, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 883, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.fast_callable[5]>", line 1, in <module>
        timeit('wilk.subs(x=30)') # random, long time
      File "sage/misc/sage_timeit_class.pyx", line 118, in sage.misc.sage_timeit_class.SageTimeit.__call__ (build/cythonized/sage/misc/sage_timeit_class.c:1411)
        print(self.eval(code, globals, preparse=preparse, **kwds))
      File "/home/chapoton/sage/local/lib/python2.7/codecs.py", line 369, in write
        data, consumed = self.encode(object, self.errors)
    UnicodeDecodeError: 'ascii' codec can't decode byte 0xc2 in position 26: ordinal not in range(128)
```



---

Comment by embray created at 2017-05-03 08:57:03

To be clear, is that a problem with the patchbot or the doctest runner itself?  It seems more like the latter, but the question is does this happen when running the tests outside the patchbot?


---

Comment by fbissey created at 2017-05-03 09:21:24

Somewhat reminiscent of #22756#comment:14 although the japanese stuff is definitely unicode and should be recognized as such by python.


---

Comment by chapoton created at 2017-05-03 10:02:55

just fails in the same way outside of the patchbot


---

Comment by git created at 2017-05-03 12:21:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-03 12:40:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-03 15:41:12

Less failing doctests, but still **many**. Is there an expert that could help ?


---

Comment by embray created at 2017-05-04 14:24:04

Depends on exactly what expertise is needed, but I'll have a look.


---

Comment by embray created at 2017-05-04 14:27:02

Replying to [comment:29 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[be11f06](https://git.sagemath.org/sage.git/commit/?id=be11f06e98fc93888967ae991f4ea91ce33c50e0)||`trac 14153 fixing some doctests`||

Regarding this commit, and others like it--is this not going to be a problem on Python 3, where the strings won't be repr'd as `u'...'`?

In other projects I've modified the doctest checker to ignore the `u` marker in strings by default.  If a test needs to explicitly check whether or not a string is unicode there are other ways.  But most of the time that isn't relevant.


---

Comment by git created at 2017-06-20 11:45:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-07-12 14:49:35

still very broken..
----
New commits:


---

Comment by git created at 2017-07-13 15:32:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-13 18:51:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-07-14 08:25:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-14 11:11:34

here is another tentative
----
New commits:


---

Comment by git created at 2017-07-14 13:32:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-14 17:24:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-14 17:56:27

There remains only one failing doctest in the r interface.


---

Comment by git created at 2017-07-14 18:01:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-15 09:45:48

**Green Bot** ! Please review !

I am not sure that this is the definitive fix, but at least good progress.

This needs to be tested also on Mac and Cygwin, and this I cannot do.


---

Comment by chapoton created at 2017-07-15 20:17:49

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-07-15 20:17:49

Changing priority from minor to major.


---

Comment by chapoton created at 2017-07-18 18:12:35

ping, anybody ?


---

Comment by fbissey created at 2017-07-19 01:28:43

Testing on OS X. But it overall looks good.


---

Comment by embray created at 2017-07-19 08:56:56

I don't think there's anything about this that specifically needs testing on Cygwin.  I've never encountered any issues on Cygwin particularly pertaining to unicode in Python.


---

Comment by chapoton created at 2017-07-19 08:59:52

ok, well. Then please review.


---

Comment by embray created at 2017-07-19 09:02:10

This is maybe a minor point, but here:


```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 9a5d982..705b718 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
`@``@` -514,7 +514,9 `@``@` class SageDocTestRunner(doctest.DocTestRunner):
             finally:
                 if self.debugger is not None:
                     self.debugger.set_continue() # ==== Example Finished ====
-            got = self._fakeout.getvalue()  # the actual output
+            got = self._fakeout.getvalue().decode('utf-8')
+            # the actual output
+
```


it might be good if this were wrapped in a try/except, and fall back on latin1 if utf-8 decoding fails, like:


```
got = self._fakeout.getvalue()
try:
    got = got.decode('utf-8')
except UnicodeDecodeError:
    got = got.decode('latin1')
```


Of course this _shouldn't_ happen, but in the off chance some test produces garbage output, this will at least prevent the doctest runner from crashing with a `UnicodeDecodeError`.  Instead you'll get _some_ text, likely wrong, that can still be compared to the expected result.


---

Comment by embray created at 2017-07-19 09:08:14

Likewise here:


```diff
diff --git a/src/sage/interfaces/r.py b/src/sage/interfaces/r.py
index 9db603f..e9096df 100644
--- a/src/sage/interfaces/r.py
+++ b/src/sage/interfaces/r.py
`@``@` -668,7 +668,7 `@``@` class R(ExtraTabCompletion, Expect):
             ...
             ImportError: ...
         """
-        ret = self.eval('require("%s")'%library_name)
+        ret = self.eval('require("%s")'%library_name).decode('utf-8')
         # try hard to parse the message string in a locale-independent way
         if ' library(' in ret:       # locale-independent key-word
             raise ImportError("%s"%ret)
```


In this case I'm not really sure what the best thing is to do if there's an encoding error, but it should probably be handled.  Will have to give that more thought.  Basically any time you're decoding bytes coming from an external source it's important not to assume they'll always have the expected encoding :(


---

Comment by embray created at 2017-07-19 09:10:49

The rest makes sense to me.  I haven't done a thorough investigation into all the places where Sage needs better unicode handling, and I'm sure this isn't exhaustive either, but I know you've done a lot of testing.  The next issue is just what the patchbots will say....


---

Comment by chapoton created at 2017-07-19 09:14:27

patchbots said green already..

*EDIT* oh, no.. I missed the last report.


---

Comment by git created at 2017-07-19 11:04:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-20 18:48:28

Damn, some of the patchbots see some problems with the gap interface, that I do not see locally..


---

Comment by chapoton created at 2017-07-20 18:48:28

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2017-07-21 03:21:50

All clear on OS X as far as I can tell.


---

Comment by embray created at 2017-07-21 08:24:07

Replying to [comment:55 chapoton]:
> Damn, some of the patchbots see some problems with the gap interface, that I do not see locally..

It probably has something to do with their locale settings.  This is why I suggested not just assuming `.decode('utf-8')` will work :)  Now the question is, how exactly does GAP determine what encoding to use...


---

Comment by embray created at 2017-07-21 08:27:17

Ah, I forgot to point that out here:


```diff
diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py
index dd7b27f..7e765a1 100644
--- a/src/sage/interfaces/gap.py
+++ b/src/sage/interfaces/gap.py
`@``@` -188,6 +188,7 `@``@` from sage.interfaces.tab_completion import ExtraTabCompletion
 from sage.structure.element import ModuleElement
 import re
 import os
+import io
 import pexpect
 import time
 import platform
`@``@` -1339,7 +1340,7 `@``@` class Gap(Gap_generic):
             (sline,) = match.groups()
             if self.is_remote():
                 self._get_tmpfile()
-            F = open(self._local_tmpfile(),"r")
+            F = io.open(self._local_tmpfile(), "r", encoding='utf-8')
             help = F.read()
             if pager:
                 from IPython.core.page import page
```


Let's see if we can determine what encoding GAP is actually using...


---

Comment by chapoton created at 2017-07-21 08:44:22

Maybe we should force the value of `"GAPInfo.TermEncoding"` ?

see https://www.gap-system.org/Manuals/pkg/GAPDoc-1.5.1/doc/chap5.html

Maybe using `GAPInfo.TermEncoding := "UTF-8";`

I know nothing of GAP, some input from a GAP expert could be useful here..


---

Comment by chapoton created at 2017-07-21 09:05:23

I can reproduce the failing doctests locally by adding one line

```
         self.eval('SetGAPDocTextTheme("none")')
+        self.eval('GAPInfo.TermEncoding := "latin1";')
         self.eval(r'\$SAGE.tempfile := "%s";'%tmp_to_use)
```



---

Comment by git created at 2017-07-21 09:09:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-21 09:10:12

not sure at all that this is a good solution..


---

Comment by embray created at 2017-07-21 09:31:45

Interesting.  It's not clear to me where `TermEncoding` is used in the process of displaying some help docs.  But if you were able to reproduce by setting that then it must be involved somewhere, somehow...


---

Comment by chapoton created at 2017-07-21 09:33:50

see the section `5.3-2 GAPDoc2Text` in the link ​https://www.gap-system.org/Manuals/pkg/GAPDoc-1.5.1/doc/chap5.html

I think this explain what GAP does when its doc is required as a text.


---

Comment by embray created at 2017-07-21 09:50:06

Great, that should explain it then.

Hmm--maybe rather than forcing `TermEncoding` to a specific value we should read `TermEncoding` and use that to determine how to decode text from GAP.


---

Comment by git created at 2017-07-21 11:18:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-21 11:25:55

indeed, here is a try..


---

Comment by chapoton created at 2017-07-21 11:26:49

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-07-25 06:37:15

bot seems to be stable-green, please review


---

Comment by chapoton created at 2017-07-31 20:29:06

ping ? Jeroen ? Erik ?


---

Comment by vbraun created at 2017-08-05 15:20:59

Can you replace the unconditional except: with something more sensible? Probably just name = str(name) instead of the entire try/except + assertion. Rest lgtm


---

Comment by git created at 2017-08-05 15:36:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-08-05 15:37:59

Thanks Volker for having a look.

I have made a more precise except. I guess one could also have removed the try-except.


---

Comment by chapoton created at 2017-08-06 19:52:58

bot is morally green


---

Comment by roed created at 2017-08-06 20:00:52

Changing status from needs_review to positive_review.


---

Comment by roed created at 2017-08-06 20:00:52

Looks good.  Sorry that this review took so long!


---

Comment by roed created at 2017-08-11 02:16:36

Sorry for the typo Volker!


---

Comment by vbraun created at 2017-08-11 18:18:15

Resolution: fixed
