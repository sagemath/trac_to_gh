# Issue 13949: Add Unicode support to the doctesting framework

archive/issues_013949.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  leif embray jdemeyer hivert\n\nSupport\n1. Doctest (i.e. `sage:`) lines containing non-ASCII characters.\n2. Doctest results containing non-ASCII characters.\n3. Print statements outputting non-ASCII characters inside doctests.\n4. Source files with a [PEP 0263](http://www.python.org/dev/peps/pep-0263/) encoding declaration.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14153\n\n",
    "created_at": "2013-02-20T22:03:46Z",
    "labels": [
        "doctest",
        "minor",
        "bug"
    ],
    "title": "Add Unicode support to the doctesting framework",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13949",
    "user": "jdemeyer"
}
```
Assignee: mvngu

CC:  leif embray jdemeyer hivert

Support
1. Doctest (i.e. `sage:`) lines containing non-ASCII characters.
2. Doctest results containing non-ASCII characters.
3. Print statements outputting non-ASCII characters inside doctests.
4. Source files with a [PEP 0263](http://www.python.org/dev/peps/pep-0263/) encoding declaration.

Issue created by migration from https://trac.sagemath.org/ticket/14153





---

archive/issue_comments_174006.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-03-19T11:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174006",
    "user": "leif"
}
```

Attachment



---

archive/issue_comments_174007.json:
```json
{
    "body": "I just tried this patch on the suspicion it could help with the test weirdness I reported in 5.9.beta0 on sage-release\n\n```\nsage -t --long devel/sage-main/sage/misc/interpreter.py\n**********************************************************************\nFile \"devel/sage-main/sage/misc/interpreter.py\", line 150, in \nsage.misc.interpreter.sage_prompt\nFailed example:\n    shell.run_cell('sage_prompt()')\nExpected:\n    u'sage'\nGot:\n    u'sage'\n**********************************************************************\nFile \"devel/sage-main/sage/misc/interpreter.py\", line 187, in \nsage.misc.interpreter.SageInteractiveShell.system_raw\nFailed example:\n    shell.system_raw('R --version')\nExpected:\n    R version ...\nGot:\n    WARNING: ignoring environment value of R_HOME\n    R version 2.15.2 (2012-10-26) -- \"Trick or Treat\"\n    Copyright (C) 2012 The R Foundation for Statistical Computing\n    ISBN 3-900051-07-0\n    Platform: x86_64-unknown-linux-gnu (64-bit)\n    <BLANKLINE>\n    R is free software and comes with ABSOLUTELY NO WARRANTY.\n    You are welcome to redistribute it under the terms of the\n    GNU General Public License versions 2 or 3.\n    For more information about these matters see\n    http://www.gnu.org/licenses/.\n    <BLANKLINE>\n**********************************************************************\nFile \"devel/sage-main/sage/misc/interpreter.py\", line 566, in \nsage.misc.interpreter.interface_shell_embed\nFailed example:\n    shell.run_cell('List( [1..10], IsPrime )')\nExpected:\n    [ false, true, true, false, true, false, true, false, false, false ]\nGot:\n    [ false, true, true, false, true, false, true, false, false, false ]\n**********************************************************************\n3 items had failures:\n   1 of  15 in sage.misc.interpreter.SageInteractiveShell.system_raw\n   1 of   4 in sage.misc.interpreter.interface_shell_embed\n   1 of   4 in sage.misc.interpreter.sage_prompt\n    [107 tests, 3 failures, 2.4 s]\n```\n\nThe R error was fixed by unsetting R_HOME before running the test. Then I applied the patch and here is the result\n\n```\nsage -t --long devel/sage-main/sage/misc/interpreter.py\n**********************************************************************\nFile \"devel/sage-main/sage/misc/interpreter.py\", line 150, in sage.misc.interpreter.sage_prompt\nFailed example:\n    shell.run_cell('sage_prompt()')\nExpected:\n    u'sage'\nGot:\n    u'sage'\n    ---------------------------------------------------------------------------\n    AttributeError                            Traceback (most recent call last)\n    <ipython-input-1-e17c2c2153ac> in <module>()\n    ----> 1 sage_prompt()\n    \n    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)\n        240             self.update_user_ns(result)\n        241             self.log_output(format_dict)\n    --> 242             self.finish_displayhook()\n        243 \n        244     def flush(self):\n    <BLANKLINE>\n    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in finish_displayhook(self)\n        224         \"\"\"Finish up all displayhook activities.\"\"\"\n        225         io.stdout.write(self.shell.separate_out2)\n    --> 226         io.stdout.flush()\n        227 \n        228     def __call__(self, result=None):\n    <BLANKLINE>\n    AttributeError: IOStream instance has no attribute 'flush'\n**********************************************************************\nFile \"devel/sage-main/sage/misc/interpreter.py\", line 566, in sage.misc.interpreter.interface_shell_embed\nFailed example:\n    shell.run_cell('List( [1..10], IsPrime )')\nExpected:\n    [ false, true, true, false, true, false, true, false, false, false ]\nGot:\n    [ false, true, true, false, true, false, true, false, false, false ]\n    ---------------------------------------------------------------------------\n    AttributeError                            Traceback (most recent call last)\n    <ipython-input-1-a772973ec1ce> in <module>()\n    ----> 1 sage.misc.all.logstr(\"\"\"[ false, true, true, false, true, false, true, false, false, false ]\"\"\")\n    \n    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)\n        240             self.update_user_ns(result)\n        241             self.log_output(format_dict)\n    --> 242             self.finish_displayhook()\n        243 \n        244     def flush(self):\n    <BLANKLINE>\n    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in finish_displayhook(self)\n        224         \"\"\"Finish up all displayhook activities.\"\"\"\n        225         io.stdout.write(self.shell.separate_out2)\n    --> 226         io.stdout.flush()\n        227 \n        228     def __call__(self, result=None):\n    <BLANKLINE>\n    AttributeError: IOStream instance has no attribute 'flush'\n**********************************************************************\n2 items had failures:\n   1 of   4 in sage.misc.interpreter.interface_shell_embed\n   1 of   4 in sage.misc.interpreter.sage_prompt\n    [107 tests, 2 failures, 3.0 s]\n```\n",
    "created_at": "2013-03-19T23:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174007",
    "user": "fbissey"
}
```

I just tried this patch on the suspicion it could help with the test weirdness I reported in 5.9.beta0 on sage-release

```
sage -t --long devel/sage-main/sage/misc/interpreter.py
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 150, in 
sage.misc.interpreter.sage_prompt
Failed example:
    shell.run_cell('sage_prompt()')
Expected:
    u'sage'
Got:
    u'sage'
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 187, in 
sage.misc.interpreter.SageInteractiveShell.system_raw
Failed example:
    shell.system_raw('R --version')
Expected:
    R version ...
Got:
    WARNING: ignoring environment value of R_HOME
    R version 2.15.2 (2012-10-26) -- "Trick or Treat"
    Copyright (C) 2012 The R Foundation for Statistical Computing
    ISBN 3-900051-07-0
    Platform: x86_64-unknown-linux-gnu (64-bit)
    <BLANKLINE>
    R is free software and comes with ABSOLUTELY NO WARRANTY.
    You are welcome to redistribute it under the terms of the
    GNU General Public License versions 2 or 3.
    For more information about these matters see
    http://www.gnu.org/licenses/.
    <BLANKLINE>
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 566, in 
sage.misc.interpreter.interface_shell_embed
Failed example:
    shell.run_cell('List( [1..10], IsPrime )')
Expected:
    [ false, true, true, false, true, false, true, false, false, false ]
Got:
    [ false, true, true, false, true, false, true, false, false, false ]
**********************************************************************
3 items had failures:
   1 of  15 in sage.misc.interpreter.SageInteractiveShell.system_raw
   1 of   4 in sage.misc.interpreter.interface_shell_embed
   1 of   4 in sage.misc.interpreter.sage_prompt
    [107 tests, 3 failures, 2.4 s]
```

The R error was fixed by unsetting R_HOME before running the test. Then I applied the patch and here is the result

```
sage -t --long devel/sage-main/sage/misc/interpreter.py
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 150, in sage.misc.interpreter.sage_prompt
Failed example:
    shell.run_cell('sage_prompt()')
Expected:
    u'sage'
Got:
    u'sage'
    ---------------------------------------------------------------------------
    AttributeError                            Traceback (most recent call last)
    <ipython-input-1-e17c2c2153ac> in <module>()
    ----> 1 sage_prompt()
    
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
        240             self.update_user_ns(result)
        241             self.log_output(format_dict)
    --> 242             self.finish_displayhook()
        243 
        244     def flush(self):
    <BLANKLINE>
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in finish_displayhook(self)
        224         """Finish up all displayhook activities."""
        225         io.stdout.write(self.shell.separate_out2)
    --> 226         io.stdout.flush()
        227 
        228     def __call__(self, result=None):
    <BLANKLINE>
    AttributeError: IOStream instance has no attribute 'flush'
**********************************************************************
File "devel/sage-main/sage/misc/interpreter.py", line 566, in sage.misc.interpreter.interface_shell_embed
Failed example:
    shell.run_cell('List( [1..10], IsPrime )')
Expected:
    [ false, true, true, false, true, false, true, false, false, false ]
Got:
    [ false, true, true, false, true, false, true, false, false, false ]
    ---------------------------------------------------------------------------
    AttributeError                            Traceback (most recent call last)
    <ipython-input-1-a772973ec1ce> in <module>()
    ----> 1 sage.misc.all.logstr("""[ false, true, true, false, true, false, true, false, false, false ]""")
    
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
        240             self.update_user_ns(result)
        241             self.log_output(format_dict)
    --> 242             self.finish_displayhook()
        243 
        244     def flush(self):
    <BLANKLINE>
    /home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in finish_displayhook(self)
        224         """Finish up all displayhook activities."""
        225         io.stdout.write(self.shell.separate_out2)
    --> 226         io.stdout.flush()
        227 
        228     def __call__(self, result=None):
    <BLANKLINE>
    AttributeError: IOStream instance has no attribute 'flush'
**********************************************************************
2 items had failures:
   1 of   4 in sage.misc.interpreter.interface_shell_embed
   1 of   4 in sage.misc.interpreter.sage_prompt
    [107 tests, 2 failures, 3.0 s]
```




---

archive/issue_comments_174008.json:
```json
{
    "body": "Changing assignee from mvngu to roed.",
    "created_at": "2013-03-28T22:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174008",
    "user": "roed"
}
```

Changing assignee from mvngu to roed.



---

archive/issue_comments_174009.json:
```json
{
    "body": "Changing component from doctest to doctest framework.",
    "created_at": "2013-03-28T22:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174009",
    "user": "roed"
}
```

Changing component from doctest to doctest framework.



---

archive/issue_comments_174010.json:
```json
{
    "body": "Changing keywords from \"\" to \"python3\".",
    "created_at": "2016-08-12T09:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174010",
    "user": "jdemeyer"
}
```

Changing keywords from "" to "python3".



---

archive/issue_comments_174011.json:
```json
{
    "body": "just made a branch from the old patch, not tried to test it\n----\nNew commits:",
    "created_at": "2016-11-10T20:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174011",
    "user": "chapoton"
}
```

just made a branch from the old patch, not tried to test it
----
New commits:



---

archive/issue_comments_174012.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-01-18T10:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174012",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174013.json:
```json
{
    "body": "I have repaired a detail, but this is not working, in several distinct ways.\n\nThis seems to be broken on lines having unicode characters in comments such as:\n\n```\nsage: 0 + 0    # c'est trop b\u00eate\n```\n\n\nSome doctests come from the notebook, I made a pull request.\n\nA failing doctest in src/sage/misc/rest_index_of_methods.py\nis related to the presence of \"Lov\\xc3\\xa1sz theta\"",
    "created_at": "2017-01-18T16:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174013",
    "user": "chapoton"
}
```

I have repaired a detail, but this is not working, in several distinct ways.

This seems to be broken on lines having unicode characters in comments such as:

```
sage: 0 + 0    # c'est trop bête
```


Some doctests come from the notebook, I made a pull request.

A failing doctest in src/sage/misc/rest_index_of_methods.py
is related to the presence of "Lov\xc3\xa1sz theta"



---

archive/issue_comments_174014.json:
```json
{
    "body": "seems that something like that is hurting us (in forker):\n\n```\nsage: md=hashlib.md5()\nsage: md.update(u'\u00e9t\u00e9')\n---------------------------------------------------------------------------\nUnicodeEncodeError                        Traceback (most recent call last)\n<ipython-input-9-6a9959b36b47> in <module>()\n----> 1 md.update(u'\u00e9t\u00e9')\n\nUnicodeEncodeError: 'ascii' codec can't encode character u'\\xe9' in position 0: ordinal not in range(128)\n```\n\nsolution: encode ?\n\n```\nsage: md.update(u'\u00e9t\u00e9'.encode('utf8'))\n```\n",
    "created_at": "2017-01-18T16:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174014",
    "user": "chapoton"
}
```

seems that something like that is hurting us (in forker):

```
sage: md=hashlib.md5()
sage: md.update(u'été')
---------------------------------------------------------------------------
UnicodeEncodeError                        Traceback (most recent call last)
<ipython-input-9-6a9959b36b47> in <module>()
----> 1 md.update(u'été')

UnicodeEncodeError: 'ascii' codec can't encode character u'\xe9' in position 0: ordinal not in range(128)
```

solution: encode ?

```
sage: md.update(u'été'.encode('utf8'))
```




---

archive/issue_comments_174015.json:
```json
{
    "body": "* another problem in src/sage/misc/cachefunc.pyx with a mu:\n\n```\n398:    625 loops, best of 3: 1.3 \u00b5s per loop\n```\n\nand same in \nsrc/sage/combinat/designs/evenly_distributed_sets.pyx\nand in src/sage/structure/list_clone_timings.py\n\n* in src/sage_setup/autogen/pari/doc.py, some unicode strings with no u:\n\n```\n113:    doc = doc.replace(\"@[pm]\", \"\u00b1\")\n115:    doc = doc.replace(\"@[agrave]\", \"\u00e0\")\n116:    doc = doc.replace(\"@[aacute]\", \"\u00e1\")\n117:    doc = doc.replace(\"@[eacute]\", \"\u00e9\")\n118:    doc = doc.replace(\"@[ouml]\", \"\u00f6\")\n119:    doc = doc.replace(\"@[uuml]\", \"\u00fc\")\n120:    doc = doc.replace(\"\\\\'{a}\", \"\u00e1\")\n```\n",
    "created_at": "2017-01-18T17:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174015",
    "user": "chapoton"
}
```

* another problem in src/sage/misc/cachefunc.pyx with a mu:

```
398:    625 loops, best of 3: 1.3 µs per loop
```

and same in 
src/sage/combinat/designs/evenly_distributed_sets.pyx
and in src/sage/structure/list_clone_timings.py

* in src/sage_setup/autogen/pari/doc.py, some unicode strings with no u:

```
113:    doc = doc.replace("@[pm]", "±")
115:    doc = doc.replace("@[agrave]", "à")
116:    doc = doc.replace("@[aacute]", "á")
117:    doc = doc.replace("@[eacute]", "é")
118:    doc = doc.replace("@[ouml]", "ö")
119:    doc = doc.replace("@[uuml]", "ü")
120:    doc = doc.replace("\\'{a}", "á")
```




---

archive/issue_comments_174016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-01-19T12:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174016",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174017.json:
```json
{
    "body": "This should be taken care of.",
    "created_at": "2017-04-26T12:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174017",
    "user": "chapoton"
}
```

This should be taken care of.



---

archive/issue_comments_174018.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-30T18:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174018",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174019.json:
```json
{
    "body": "Changing keywords from \"python3\" to \"python3, unicode\".",
    "created_at": "2017-05-01T12:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174019",
    "user": "chapoton"
}
```

Changing keywords from "python3" to "python3, unicode".



---

archive/issue_comments_174020.json:
```json
{
    "body": "Looks fine to me, though I did not test it.  I'm amazed there isn't anything in the stdlib to check the PEP 263 coding line, but if there is I couldn't find it.\n\nThis will be nice to have.  It reminds me of my thought the other day to propose adding a few unicode constants (and the ability to tab-complete them easily) to Sage (e.g. for pi).  Has that been proposed before?",
    "created_at": "2017-05-02T08:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174020",
    "user": "embray"
}
```

Looks fine to me, though I did not test it.  I'm amazed there isn't anything in the stdlib to check the PEP 263 coding line, but if there is I couldn't find it.

This will be nice to have.  It reminds me of my thought the other day to propose adding a few unicode constants (and the ability to tab-complete them easily) to Sage (e.g. for pi).  Has that been proposed before?



---

archive/issue_comments_174021.json:
```json
{
    "body": "I have not tested either, so far. May launch my patchbot on the branch later.",
    "created_at": "2017-05-02T10:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174021",
    "user": "chapoton"
}
```

I have not tested either, so far. May launch my patchbot on the branch later.



---

archive/issue_comments_174022.json:
```json
{
    "body": "The patchbot is not happy at all !\n\nOne example of failure:\n\n```\nFile \"src/doc/ja/a_tour_of_sage/index.rst\", line 39, in doc.ja.a_tour_of_sage.index\nFailed example:\n    x = var('x')   # \u8a18\u53f7\u5909\u6570\u3092\u5b9a\u7fa9\nException raised:\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 520, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 896, in compile_and_execute\n        self.update_digests(example)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 783, in update_digests\n        self.running_global_digest.update(s)\n    UnicodeEncodeError: 'ascii' codec can't encode characters in position 20-26: ordinal not in range(128)\n```\n\n\nAnother kind of example:\n\n```\nFile \"src/sage/ext/fast_callable.pyx\", line 34, in sage.ext.fast_callable\nFailed example:\n    timeit('wilk.subs(x=30)') # random, long time\nException raised:\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 520, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 883, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.ext.fast_callable[5]>\", line 1, in <module>\n        timeit('wilk.subs(x=30)') # random, long time\n      File \"sage/misc/sage_timeit_class.pyx\", line 118, in sage.misc.sage_timeit_class.SageTimeit.__call__ (build/cythonized/sage/misc/sage_timeit_class.c:1411)\n        print(self.eval(code, globals, preparse=preparse, **kwds))\n      File \"/home/chapoton/sage/local/lib/python2.7/codecs.py\", line 369, in write\n        data, consumed = self.encode(object, self.errors)\n    UnicodeDecodeError: 'ascii' codec can't decode byte 0xc2 in position 26: ordinal not in range(128)\n```\n",
    "created_at": "2017-05-03T08:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174022",
    "user": "chapoton"
}
```

The patchbot is not happy at all !

One example of failure:

```
File "src/doc/ja/a_tour_of_sage/index.rst", line 39, in doc.ja.a_tour_of_sage.index
Failed example:
    x = var('x')   # 記号変数を定義
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 520, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 896, in compile_and_execute
        self.update_digests(example)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 783, in update_digests
        self.running_global_digest.update(s)
    UnicodeEncodeError: 'ascii' codec can't encode characters in position 20-26: ordinal not in range(128)
```


Another kind of example:

```
File "src/sage/ext/fast_callable.pyx", line 34, in sage.ext.fast_callable
Failed example:
    timeit('wilk.subs(x=30)') # random, long time
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 520, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 883, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.fast_callable[5]>", line 1, in <module>
        timeit('wilk.subs(x=30)') # random, long time
      File "sage/misc/sage_timeit_class.pyx", line 118, in sage.misc.sage_timeit_class.SageTimeit.__call__ (build/cythonized/sage/misc/sage_timeit_class.c:1411)
        print(self.eval(code, globals, preparse=preparse, **kwds))
      File "/home/chapoton/sage/local/lib/python2.7/codecs.py", line 369, in write
        data, consumed = self.encode(object, self.errors)
    UnicodeDecodeError: 'ascii' codec can't decode byte 0xc2 in position 26: ordinal not in range(128)
```




---

archive/issue_comments_174023.json:
```json
{
    "body": "To be clear, is that a problem with the patchbot or the doctest runner itself?  It seems more like the latter, but the question is does this happen when running the tests outside the patchbot?",
    "created_at": "2017-05-03T08:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174023",
    "user": "embray"
}
```

To be clear, is that a problem with the patchbot or the doctest runner itself?  It seems more like the latter, but the question is does this happen when running the tests outside the patchbot?



---

archive/issue_comments_174024.json:
```json
{
    "body": "Somewhat reminiscent of #22756#comment:14 although the japanese stuff is definitely unicode and should be recognized as such by python.",
    "created_at": "2017-05-03T09:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174024",
    "user": "fbissey"
}
```

Somewhat reminiscent of #22756#comment:14 although the japanese stuff is definitely unicode and should be recognized as such by python.



---

archive/issue_comments_174025.json:
```json
{
    "body": "just fails in the same way outside of the patchbot",
    "created_at": "2017-05-03T10:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174025",
    "user": "chapoton"
}
```

just fails in the same way outside of the patchbot



---

archive/issue_comments_174026.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-03T12:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174026",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174027.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-03T12:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174027",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174028.json:
```json
{
    "body": "Less failing doctests, but still **many**. Is there an expert that could help ?",
    "created_at": "2017-05-03T15:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174028",
    "user": "chapoton"
}
```

Less failing doctests, but still **many**. Is there an expert that could help ?



---

archive/issue_comments_174029.json:
```json
{
    "body": "Depends on exactly what expertise is needed, but I'll have a look.",
    "created_at": "2017-05-04T14:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174029",
    "user": "embray"
}
```

Depends on exactly what expertise is needed, but I'll have a look.



---

archive/issue_comments_174030.json:
```json
{
    "body": "Replying to [comment:29 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[be11f06](https://git.sagemath.org/sage.git/commit/?id=be11f06e98fc93888967ae991f4ea91ce33c50e0)||`trac 14153 fixing some doctests`||\n\nRegarding this commit, and others like it--is this not going to be a problem on Python 3, where the strings won't be repr'd as `u'...'`?\n\nIn other projects I've modified the doctest checker to ignore the `u` marker in strings by default.  If a test needs to explicitly check whether or not a string is unicode there are other ways.  But most of the time that isn't relevant.",
    "created_at": "2017-05-04T14:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174030",
    "user": "embray"
}
```

Replying to [comment:29 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[be11f06](https://git.sagemath.org/sage.git/commit/?id=be11f06e98fc93888967ae991f4ea91ce33c50e0)||`trac 14153 fixing some doctests`||

Regarding this commit, and others like it--is this not going to be a problem on Python 3, where the strings won't be repr'd as `u'...'`?

In other projects I've modified the doctest checker to ignore the `u` marker in strings by default.  If a test needs to explicitly check whether or not a string is unicode there are other ways.  But most of the time that isn't relevant.



---

archive/issue_comments_174031.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-06-20T11:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174031",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_174032.json:
```json
{
    "body": "still very broken..\n----\nNew commits:",
    "created_at": "2017-07-12T14:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174032",
    "user": "chapoton"
}
```

still very broken..
----
New commits:



---

archive/issue_comments_174033.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-13T15:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174033",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174034.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-13T18:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174034",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_174035.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T08:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174035",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174036.json:
```json
{
    "body": "here is another tentative\n----\nNew commits:",
    "created_at": "2017-07-14T11:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174036",
    "user": "chapoton"
}
```

here is another tentative
----
New commits:



---

archive/issue_comments_174037.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T13:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174037",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174038.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T17:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174038",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174039.json:
```json
{
    "body": "There remains only one failing doctest in the r interface.",
    "created_at": "2017-07-14T17:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174039",
    "user": "chapoton"
}
```

There remains only one failing doctest in the r interface.



---

archive/issue_comments_174040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T18:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174040",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174041.json:
```json
{
    "body": "**Green Bot** ! Please review !\n\nI am not sure that this is the definitive fix, but at least good progress.\n\nThis needs to be tested also on Mac and Cygwin, and this I cannot do.",
    "created_at": "2017-07-15T09:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174041",
    "user": "chapoton"
}
```

**Green Bot** ! Please review !

I am not sure that this is the definitive fix, but at least good progress.

This needs to be tested also on Mac and Cygwin, and this I cannot do.



---

archive/issue_comments_174042.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-15T20:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174042",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_174043.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2017-07-15T20:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174043",
    "user": "chapoton"
}
```

Changing priority from minor to major.



---

archive/issue_comments_174044.json:
```json
{
    "body": "ping, anybody ?",
    "created_at": "2017-07-18T18:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174044",
    "user": "chapoton"
}
```

ping, anybody ?



---

archive/issue_comments_174045.json:
```json
{
    "body": "Testing on OS X. But it overall looks good.",
    "created_at": "2017-07-19T01:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174045",
    "user": "fbissey"
}
```

Testing on OS X. But it overall looks good.



---

archive/issue_comments_174046.json:
```json
{
    "body": "I don't think there's anything about this that specifically needs testing on Cygwin.  I've never encountered any issues on Cygwin particularly pertaining to unicode in Python.",
    "created_at": "2017-07-19T08:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174046",
    "user": "embray"
}
```

I don't think there's anything about this that specifically needs testing on Cygwin.  I've never encountered any issues on Cygwin particularly pertaining to unicode in Python.



---

archive/issue_comments_174047.json:
```json
{
    "body": "ok, well. Then please review.",
    "created_at": "2017-07-19T08:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174047",
    "user": "chapoton"
}
```

ok, well. Then please review.



---

archive/issue_comments_174048.json:
```json
{
    "body": "This is maybe a minor point, but here:\n\n\n```diff\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex 9a5d982..705b718 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -514,7 +514,9 @@ class SageDocTestRunner(doctest.DocTestRunner):\n             finally:\n                 if self.debugger is not None:\n                     self.debugger.set_continue() # ==== Example Finished ====\n-            got = self._fakeout.getvalue()  # the actual output\n+            got = self._fakeout.getvalue().decode('utf-8')\n+            # the actual output\n+\n```\n\n\nit might be good if this were wrapped in a try/except, and fall back on latin1 if utf-8 decoding fails, like:\n\n\n```\ngot = self._fakeout.getvalue()\ntry:\n    got = got.decode('utf-8')\nexcept UnicodeDecodeError:\n    got = got.decode('latin1')\n```\n\n\nOf course this *shouldn't* happen, but in the off chance some test produces garbage output, this will at least prevent the doctest runner from crashing with a `UnicodeDecodeError`.  Instead you'll get *some* text, likely wrong, that can still be compared to the expected result.",
    "created_at": "2017-07-19T09:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174048",
    "user": "embray"
}
```

This is maybe a minor point, but here:


```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 9a5d982..705b718 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -514,7 +514,9 @@ class SageDocTestRunner(doctest.DocTestRunner):
             finally:
                 if self.debugger is not None:
                     self.debugger.set_continue() # ==== Example Finished ====
-            got = self._fakeout.getvalue()  # the actual output
+            got = self._fakeout.getvalue().decode('utf-8')
+            # the actual output
+
```


it might be good if this were wrapped in a try/except, and fall back on latin1 if utf-8 decoding fails, like:


```
got = self._fakeout.getvalue()
try:
    got = got.decode('utf-8')
except UnicodeDecodeError:
    got = got.decode('latin1')
```


Of course this *shouldn't* happen, but in the off chance some test produces garbage output, this will at least prevent the doctest runner from crashing with a `UnicodeDecodeError`.  Instead you'll get *some* text, likely wrong, that can still be compared to the expected result.



---

archive/issue_comments_174049.json:
```json
{
    "body": "Likewise here:\n\n\n```diff\ndiff --git a/src/sage/interfaces/r.py b/src/sage/interfaces/r.py\nindex 9db603f..e9096df 100644\n--- a/src/sage/interfaces/r.py\n+++ b/src/sage/interfaces/r.py\n@@ -668,7 +668,7 @@ class R(ExtraTabCompletion, Expect):\n             ...\n             ImportError: ...\n         \"\"\"\n-        ret = self.eval('require(\"%s\")'%library_name)\n+        ret = self.eval('require(\"%s\")'%library_name).decode('utf-8')\n         # try hard to parse the message string in a locale-independent way\n         if ' library(' in ret:       # locale-independent key-word\n             raise ImportError(\"%s\"%ret)\n```\n\n\nIn this case I'm not really sure what the best thing is to do if there's an encoding error, but it should probably be handled.  Will have to give that more thought.  Basically any time you're decoding bytes coming from an external source it's important not to assume they'll always have the expected encoding :(",
    "created_at": "2017-07-19T09:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174049",
    "user": "embray"
}
```

Likewise here:


```diff
diff --git a/src/sage/interfaces/r.py b/src/sage/interfaces/r.py
index 9db603f..e9096df 100644
--- a/src/sage/interfaces/r.py
+++ b/src/sage/interfaces/r.py
@@ -668,7 +668,7 @@ class R(ExtraTabCompletion, Expect):
             ...
             ImportError: ...
         """
-        ret = self.eval('require("%s")'%library_name)
+        ret = self.eval('require("%s")'%library_name).decode('utf-8')
         # try hard to parse the message string in a locale-independent way
         if ' library(' in ret:       # locale-independent key-word
             raise ImportError("%s"%ret)
```


In this case I'm not really sure what the best thing is to do if there's an encoding error, but it should probably be handled.  Will have to give that more thought.  Basically any time you're decoding bytes coming from an external source it's important not to assume they'll always have the expected encoding :(



---

archive/issue_comments_174050.json:
```json
{
    "body": "The rest makes sense to me.  I haven't done a thorough investigation into all the places where Sage needs better unicode handling, and I'm sure this isn't exhaustive either, but I know you've done a lot of testing.  The next issue is just what the patchbots will say....",
    "created_at": "2017-07-19T09:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174050",
    "user": "embray"
}
```

The rest makes sense to me.  I haven't done a thorough investigation into all the places where Sage needs better unicode handling, and I'm sure this isn't exhaustive either, but I know you've done a lot of testing.  The next issue is just what the patchbots will say....



---

archive/issue_comments_174051.json:
```json
{
    "body": "patchbots said green already..\n\n**EDIT** oh, no.. I missed the last report.",
    "created_at": "2017-07-19T09:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174051",
    "user": "chapoton"
}
```

patchbots said green already..

**EDIT** oh, no.. I missed the last report.



---

archive/issue_comments_174052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-19T11:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174052",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174053.json:
```json
{
    "body": "Damn, some of the patchbots see some problems with the gap interface, that I do not see locally..",
    "created_at": "2017-07-20T18:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174053",
    "user": "chapoton"
}
```

Damn, some of the patchbots see some problems with the gap interface, that I do not see locally..



---

archive/issue_comments_174054.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-20T18:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174054",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_174055.json:
```json
{
    "body": "All clear on OS X as far as I can tell.",
    "created_at": "2017-07-21T03:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174055",
    "user": "fbissey"
}
```

All clear on OS X as far as I can tell.



---

archive/issue_comments_174056.json:
```json
{
    "body": "Replying to [comment:55 chapoton]:\n> Damn, some of the patchbots see some problems with the gap interface, that I do not see locally..\n\nIt probably has something to do with their locale settings.  This is why I suggested not just assuming `.decode('utf-8')` will work :)  Now the question is, how exactly does GAP determine what encoding to use...",
    "created_at": "2017-07-21T08:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174056",
    "user": "embray"
}
```

Replying to [comment:55 chapoton]:
> Damn, some of the patchbots see some problems with the gap interface, that I do not see locally..

It probably has something to do with their locale settings.  This is why I suggested not just assuming `.decode('utf-8')` will work :)  Now the question is, how exactly does GAP determine what encoding to use...



---

archive/issue_comments_174057.json:
```json
{
    "body": "Ah, I forgot to point that out here:\n\n\n```diff\ndiff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py\nindex dd7b27f..7e765a1 100644\n--- a/src/sage/interfaces/gap.py\n+++ b/src/sage/interfaces/gap.py\n@@ -188,6 +188,7 @@ from sage.interfaces.tab_completion import ExtraTabCompletion\n from sage.structure.element import ModuleElement\n import re\n import os\n+import io\n import pexpect\n import time\n import platform\n@@ -1339,7 +1340,7 @@ class Gap(Gap_generic):\n             (sline,) = match.groups()\n             if self.is_remote():\n                 self._get_tmpfile()\n-            F = open(self._local_tmpfile(),\"r\")\n+            F = io.open(self._local_tmpfile(), \"r\", encoding='utf-8')\n             help = F.read()\n             if pager:\n                 from IPython.core.page import page\n```\n\n\nLet's see if we can determine what encoding GAP is actually using...",
    "created_at": "2017-07-21T08:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174057",
    "user": "embray"
}
```

Ah, I forgot to point that out here:


```diff
diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py
index dd7b27f..7e765a1 100644
--- a/src/sage/interfaces/gap.py
+++ b/src/sage/interfaces/gap.py
@@ -188,6 +188,7 @@ from sage.interfaces.tab_completion import ExtraTabCompletion
 from sage.structure.element import ModuleElement
 import re
 import os
+import io
 import pexpect
 import time
 import platform
@@ -1339,7 +1340,7 @@ class Gap(Gap_generic):
             (sline,) = match.groups()
             if self.is_remote():
                 self._get_tmpfile()
-            F = open(self._local_tmpfile(),"r")
+            F = io.open(self._local_tmpfile(), "r", encoding='utf-8')
             help = F.read()
             if pager:
                 from IPython.core.page import page
```


Let's see if we can determine what encoding GAP is actually using...



---

archive/issue_comments_174058.json:
```json
{
    "body": "Maybe we should force the value of `\"GAPInfo.TermEncoding\"` ?\n\nsee https://www.gap-system.org/Manuals/pkg/GAPDoc-1.5.1/doc/chap5.html\n\nMaybe using `GAPInfo.TermEncoding := \"UTF-8\";`\n\nI know nothing of GAP, some input from a GAP expert could be useful here..",
    "created_at": "2017-07-21T08:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174058",
    "user": "chapoton"
}
```

Maybe we should force the value of `"GAPInfo.TermEncoding"` ?

see https://www.gap-system.org/Manuals/pkg/GAPDoc-1.5.1/doc/chap5.html

Maybe using `GAPInfo.TermEncoding := "UTF-8";`

I know nothing of GAP, some input from a GAP expert could be useful here..



---

archive/issue_comments_174059.json:
```json
{
    "body": "I can reproduce the failing doctests locally by adding one line\n\n```\n         self.eval('SetGAPDocTextTheme(\"none\")')\n+        self.eval('GAPInfo.TermEncoding := \"latin1\";')\n         self.eval(r'\\$SAGE.tempfile := \"%s\";'%tmp_to_use)\n```\n",
    "created_at": "2017-07-21T09:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174059",
    "user": "chapoton"
}
```

I can reproduce the failing doctests locally by adding one line

```
         self.eval('SetGAPDocTextTheme("none")')
+        self.eval('GAPInfo.TermEncoding := "latin1";')
         self.eval(r'\$SAGE.tempfile := "%s";'%tmp_to_use)
```




---

archive/issue_comments_174060.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-21T09:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174060",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174061.json:
```json
{
    "body": "not sure at all that this is a good solution..",
    "created_at": "2017-07-21T09:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174061",
    "user": "chapoton"
}
```

not sure at all that this is a good solution..



---

archive/issue_comments_174062.json:
```json
{
    "body": "Interesting.  It's not clear to me where `TermEncoding` is used in the process of displaying some help docs.  But if you were able to reproduce by setting that then it must be involved somewhere, somehow...",
    "created_at": "2017-07-21T09:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174062",
    "user": "embray"
}
```

Interesting.  It's not clear to me where `TermEncoding` is used in the process of displaying some help docs.  But if you were able to reproduce by setting that then it must be involved somewhere, somehow...



---

archive/issue_comments_174063.json:
```json
{
    "body": "see the section `5.3-2 GAPDoc2Text` in the link \u200bhttps://www.gap-system.org/Manuals/pkg/GAPDoc-1.5.1/doc/chap5.html\n\nI think this explain what GAP does when its doc is required as a text.",
    "created_at": "2017-07-21T09:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174063",
    "user": "chapoton"
}
```

see the section `5.3-2 GAPDoc2Text` in the link ​https://www.gap-system.org/Manuals/pkg/GAPDoc-1.5.1/doc/chap5.html

I think this explain what GAP does when its doc is required as a text.



---

archive/issue_comments_174064.json:
```json
{
    "body": "Great, that should explain it then.\n\nHmm--maybe rather than forcing `TermEncoding` to a specific value we should read `TermEncoding` and use that to determine how to decode text from GAP.",
    "created_at": "2017-07-21T09:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174064",
    "user": "embray"
}
```

Great, that should explain it then.

Hmm--maybe rather than forcing `TermEncoding` to a specific value we should read `TermEncoding` and use that to determine how to decode text from GAP.



---

archive/issue_comments_174065.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-21T11:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174065",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174066.json:
```json
{
    "body": "indeed, here is a try..",
    "created_at": "2017-07-21T11:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174066",
    "user": "chapoton"
}
```

indeed, here is a try..



---

archive/issue_comments_174067.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-21T11:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174067",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_174068.json:
```json
{
    "body": "bot seems to be stable-green, please review",
    "created_at": "2017-07-25T06:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174068",
    "user": "chapoton"
}
```

bot seems to be stable-green, please review



---

archive/issue_comments_174069.json:
```json
{
    "body": "ping ? Jeroen ? Erik ?",
    "created_at": "2017-07-31T20:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174069",
    "user": "chapoton"
}
```

ping ? Jeroen ? Erik ?



---

archive/issue_comments_174070.json:
```json
{
    "body": "Can you replace the unconditional except: with something more sensible? Probably just name = str(name) instead of the entire try/except + assertion. Rest lgtm",
    "created_at": "2017-08-05T15:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174070",
    "user": "vbraun"
}
```

Can you replace the unconditional except: with something more sensible? Probably just name = str(name) instead of the entire try/except + assertion. Rest lgtm



---

archive/issue_comments_174071.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-05T15:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174071",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_174072.json:
```json
{
    "body": "Thanks Volker for having a look.\n\nI have made a more precise except. I guess one could also have removed the try-except.",
    "created_at": "2017-08-05T15:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174072",
    "user": "chapoton"
}
```

Thanks Volker for having a look.

I have made a more precise except. I guess one could also have removed the try-except.



---

archive/issue_comments_174073.json:
```json
{
    "body": "bot is morally green",
    "created_at": "2017-08-06T19:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174073",
    "user": "chapoton"
}
```

bot is morally green



---

archive/issue_comments_174074.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-06T20:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174074",
    "user": "roed"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_174075.json:
```json
{
    "body": "Looks good.  Sorry that this review took so long!",
    "created_at": "2017-08-06T20:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174075",
    "user": "roed"
}
```

Looks good.  Sorry that this review took so long!



---

archive/issue_comments_174076.json:
```json
{
    "body": "Sorry for the typo Volker!",
    "created_at": "2017-08-11T02:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174076",
    "user": "roed"
}
```

Sorry for the typo Volker!



---

archive/issue_comments_174077.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-11T18:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13949#issuecomment-174077",
    "user": "vbraun"
}
```

Resolution: fixed
