# Issue 33209: To determine `GAP_SO` sage.env looks for `libgap.so` but it should look for `libgap.so*`

Issue created by migration from https://trac.sagemath.org/ticket/33446

Original creator: tornaria

Original creation time: 2022-03-02 02:38:25

CC:  dimpase mjo was

My system (void linux) only has

```
$ ls -l /usr/lib/libgap.so*
lrwxrwxrwx 1 root root      15 Jan 14 11:14 /usr/lib/libgap.so.0 -> libgap.so.0.0.0
-rwxr-xr-x 1 root root 2080920 Jan 14 11:14 /usr/lib/libgap.so.0.0.0
```

installed. Indeed, the symlink `/usr/lib/libgap.so -> libgap.so.0.0.0` is shipped in `gap-devel` which is not needed to run sagemath at all.

This is because the implementation of the function `sage.env._get_shared_lib_path()` will look for `libgap.so` instead of `libgap.so*`. The fix is trivial:

```
--- a/src/sage/env.py
+++ b/src/sage/env.py
@@ -293,7 +293,7 @@ def _get_shared_lib_path(*libnames: str) -> Optional[str]:
             if sys.platform == 'darwin':
                 ext = 'dylib'
             else:
-                ext = 'so'
+                ext = 'so*'
 
             if SAGE_LOCAL:
                 search_directories.append(Path(SAGE_LOCAL) / 'lib')
```


Note that this function is only used once in `sage.env` to set `GAP_SO`.

Without the fix above my `GAP_SO` is set to `None` and I get failures like

```
sage: libgap.eval("2+2")
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
Input In [1], in <module>
----> 1 libgap.eval("2+2")
...
TypeError: expected str, NoneType found
```



---

Comment by tornaria created at 2022-03-02 02:42:58

Changing status from new to needs_review.


---

Comment by tornaria created at 2022-03-02 02:42:58

New commits:


---

Comment by mkoeppe created at 2022-03-02 07:37:03

I'd guess there'a potential for a regression here on Linux systems that have multiple versions of the shared library installed.


---

Comment by tornaria created at 2022-03-02 12:08:50

Replying to [comment:2 mkoeppe]:
> I'd guess there'a potential for a regression here on Linux systems that have multiple versions of the shared library installed. 

I don't understand why libgap needs to be `dlopen()`, since it is already linked in. The relevant tickets for that hack are #26930 and ticket:22626#comment:424, but it's not clear to me how to reproduce the claimed failure without the hack.

In any case if there are multiple versions of the shared library installed, nothing guarantees that the correct one is loaded. It seems like a "more correct" way to find the shared library that is actually already loaded would be based on something like:

```
sage: sage.libs.gap.libgap.__loader__.path
'/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/libs/gap/libgap.cpython-310-x86_64-linux-gnu.so'
sage: os.system("ldd %s | grep libgap" % sage.libs.gap.libgap.__loader__.path)
	libgap.so.0 => /usr/lib/libgap.so.0 (0x00007fd15418f000)
0
```

I'm not sure how portable is `ldd` (an alternative is `objdump -p` but that requires binutils which is not otherwise required to run sagemath).

----

One possibility is to skip the hack altogether when `GAP_SO` is unset. That seems to work ok, but I'm not quite convinced. The hack is either needed or not needed, and making it depend on some circumstantial detail (e.g. whether `gap-devel` is installed in the system or not) seems wrong.


---

Comment by mjo created at 2022-03-02 16:24:22

Why isn't `libgap.so` installed with the rest of the package? You need it for `$CC ... -lgap` to work, so I think it should be part of the "normal" installation.


---

Comment by mkoeppe created at 2022-03-02 17:06:43

On some distributions, the `.so` symlink is only packaged in a `-devel` package.
`@`tornaria is building distribution packages for use at runtime - these should not depend on the `-devel` package.


---

Comment by mjo created at 2022-03-02 17:28:49

Replying to [comment:6 mkoeppe]:
> On some distributions, the `.so` symlink is only packaged in a `-devel` package.
> `@`tornaria is building distribution packages for use at runtime - these should not depend on the `-devel` package.

I understand the problem, but the libtool version number is an implementation detail here. The user-facing library is `libgap.so`. While it's technically true that you can use gap itself without `libgap.so` because the symlink is followed at link-time and "libgap.so.0.0.0" is recorded into whatever you're linking... if the GAP package is meant to provide `libgap` in a usable way, it doesn't.

The bottom line is that it's a lot of trouble to save however much space a symlink takes up. I'd change the distro package if it were up to me. Typically, a `-devel` package includes additional headers, but the libraries themselves are included in the non-devel package. Trying to work around that in sage by at implementation details could cause other unexpected problems that aren't worth the space of a symlink on a few machines.


---

Comment by mkoeppe created at 2022-03-02 17:30:56

Replying to [comment:7 mjo]:
> The user-facing library is `libgap.so`.

Only at build time, not at runtime.


---

Comment by mkoeppe created at 2022-03-02 17:32:01

Replying to [comment:7 mjo]:
> Trying to work around that in sage by at implementation details could cause other unexpected problems that aren't worth the space of a symlink on a few machines.

Beyond the scope of our project to change packaging practices of major distributions


---

Comment by mjo created at 2022-03-02 17:34:16

Replying to [comment:8 mkoeppe]:
> Replying to [comment:7 mjo]:
> > The user-facing library is `libgap.so`.
> 
> Only at build time, not at runtime.

There is some subtler distinction to be made here, but my point is that the distro package in question isn't usable by anyone who wants to _build_ software that links to libgap. I think that should be fixed, independent of this issue. And then as a side effect, this problem just happens to disappear.


---

Comment by mjo created at 2022-03-02 17:38:00

Replying to [comment:9 mkoeppe]:
> Replying to [comment:7 mjo]:
> > Trying to work around that in sage by at implementation details could cause other unexpected problems that aren't worth the space of a symlink on a few machines.
> 
> Beyond the scope of our project to change packaging practices of major distributions

Given that most major distros have at least one developer with a presence here... if there's a solution that's better for everyone and requires only a minor tweak to a distro package rather than piling more hacks onto what's already a hack within sage, I think we should be thankful for our good luck.


---

Comment by mkoeppe created at 2022-03-02 17:39:53

Replying to [comment:10 mjo]:
> Replying to [comment:8 mkoeppe]:
> > Replying to [comment:7 mjo]:
> > > The user-facing library is `libgap.so`.
> > 
> > Only at build time, not at runtime.
> 
> There is some subtler distinction to be made here, but my point is that the distro package in question isn't usable by anyone who wants to _build_ software that links to libgap. 

I think you are missing that the point is that the runtime package of Sage does not have to depend on the dev package of gap, only on the runtime package gap.


---

Comment by mjo created at 2022-03-02 17:43:11

Replying to [comment:12 mkoeppe]:
> 
> I think you are missing that the point is that the runtime package of Sage does not have to depend on the dev package of gap, only on the runtime package gap.

I'm not. I'm saying that the runtime package should include the symlink that makes libgap accessible via the expected name. That's all that's needed to fix this.


---

Comment by mkoeppe created at 2022-03-02 19:30:06

Replying to [comment:7 mjo]:
> While it's technically true that you can use gap itself without `libgap.so` because the symlink is followed at link-time and "libgap.so.0.0.0" is recorded into whatever you're linking...

What you are dismissing here as an implementation detail is really at the core of how binary distributions work: Multiple versions of a shared library can be present on a system, and binaries shipped by package link to the correct version of the shared library; there cannot be a notion of "current version" at runtime.


---

Comment by mjo created at 2022-03-02 20:44:25

Replying to [comment:14 mkoeppe]:
> 
> What you are dismissing here as an implementation detail is really at the core of how binary distributions work: Multiple versions of a shared library can be present on a system, and binaries shipped by package link to the correct version of the shared library; there cannot be a notion of "current version" at runtime.

That's... just how it works. It has nothing in particular to do with binary distributions, and is also why globbing for `libgap.so*` won't work.

If you want my real answer, we should stop `dlopen()`ing libraries and remove all hard-coded library paths from sage. Short of that you're always going to get either unreliable hacks or required rebuilds. In this case the sage package would have to be rebuilt if a new version of libgap comes with incompatible changes. The gentoo package format has a way to automate that and I'd guess that binary distro infrastructure does too. It kinda sucks but it's the simple and reliable way to work around our existing problems, unless someone wants to tackle all of the `dlopen()` insanity.


---

Comment by mjo created at 2022-03-02 20:54:36

I also see that the gap library is versioned upstream, so if the distro package is installing it as `libgap.so.0.0.0` on purpose, that makes any theorizing about multiple versions extra pointless.


---

Comment by tornaria created at 2022-03-02 20:59:21

In the end, the only "correct" way to proceed is to figure out the actual soname that the gap extension module in sagemath was linked with, namely:

```
$ objdump -p /usr/lib/python3.10/site-packages/sage/libs/gap/libgap.so | grep NEEDED.*libgap
  NEEDED               libgap.so.0
```

This is telling you that you must look for `libgap.so.0`, not for `libgap.so` since that (a) may not be installed (b) may point to a different version of the library.

The path to the extension module itself can be had with

```
sage: sage.libs.gap.libgap.__loader__.path
'/usr/lib/python3.10/site-packages/sage/libs/gap/libgap.so'
```

This should be portable, but `objdump` may not be available at runtime (part of binutils). Using `ldd` may be better:

```
$ ldd /usr/lib/python3.10/site-packages/sage/libs/gap/libgap.so | grep libgap
	libgap.so.0 => /usr/lib/libgap.so.0 (0x00007f964dd21000)
```


Of course it would be much better to just avoid using `dlopen()`, assuming the bug in gap leading to this ugly hack has been fixed upstream (see https://github.com/markuspf/gap/issues/1 for the explanation).


---

Comment by mkoeppe created at 2022-03-02 21:03:34

Replying to [comment:17 tornaria]:
> the only "correct" way to proceed is to figure out the actual soname that the gap extension module in sagemath was linked with

+1


---

Comment by tornaria created at 2022-03-02 21:05:16

Replying to [comment:16 mjo]:
> I also see that the gap library is versioned upstream, so if the distro package is installing it as `libgap.so.0.0.0` on purpose, that makes any theorizing about multiple versions extra pointless.

Upstream uses `libgap.so.0` as the soname. In theory if they ever change the library in a backwards-incompatible way they should bump the soname. Let's say they release gap 5 using `libgap.so.1` as the soname. Then I may have both libraries installed (`libgap.so.0` and `libgap.so.1`) but at most one `libgap.so` symlink. And regardless of what this links points to (or whether it exists) the correct library to `dlopen()` is the same that is in the NEEDED section in the gap extension modules -- i.e. the version that sagemath was linked against.

I also believe that `dlopen()` does not need a full path, in fact you can use `dlopen()` with just the soname which I presume would search for the library in the same paths as the dynamic linker does.


---

Comment by tornaria created at 2022-03-02 21:13:36

In fact one way to get the soname for a library may be using `ctypes.util.find_library()` but I'm not sure it would do the right thing when multiple libraries are available:

```
sage: import ctypes.util
sage: ctypes.util.find_library("gap")
'libgap.so.0.0.0'
sage: import sage.misc.compat
sage: sage.misc.compat.find_library("gap")
'libgap.so.0.0.0'
```



---

Comment by fbissey created at 2022-03-02 22:01:13

That would still need to be somewhat parsed https://docs.python.org/3/library/ctypes.html#finding-shared-libraries - on linux it uses whatever is available to find an answer and will look into `LD_LIBRARY_PATH`, although the wording suggests it is done only if no results is returned without taking it into account, which seems dumb to me. But on OS X you get a fully qualified name as an answer, probably because `installed_name` values are paths themselves. I don't remember the code but surely we also do something on OS X?


---

Comment by mjo created at 2022-03-02 22:09:51

Replying to [comment:19 tornaria]:
> 
> I also believe that `dlopen()` does not need a full path, 

On OSX it does. We ran into that problem with libSingular.


---

Comment by mjo created at 2022-03-02 22:11:32

Replying to [comment:20 tornaria]:
> In fact one way to get the soname for a library may be using `ctypes.util.find_library()` but I'm not sure it would do the right thing when multiple libraries are available:

It doesn't, it chooses the most recent one.


---

Comment by fbissey created at 2022-03-02 22:17:31

If we are so worried about mixing up versions because of potential incompatibility, surely we should lock on a specific version of the library in the first place? Playing the devil's advocate there.


---

Comment by tornaria created at 2022-03-03 00:56:46

Replying to [comment:24 fbissey]:
> If we are so worried about mixing up versions because of potential incompatibility, surely we should lock on a specific version of the library in the first place? Playing the devil's advocate there.

Sure, that's what linking does; in the case of dynamic linking this is done by recording the "soname" of the library in the "needed" section. If we must use `dlopen()` we should strive to match the semantics of the dynamic linker for consistency (both in terms of using the same soname and the same search paths).

In particular, the soname is the precise granularity of the "lock on a specific version" that should be used. For example, if a new version of gap changes `libgap.so.0.0.0` to `libgap.so.0.1.0` but the soname stays `libgap.so.0` that would be an indication that the new library is backwards compatible and it shouldn't be necessary to rebuild sagemath. If the symlink is fully resolved at build time and `GAP_SO` is hardcoded to `libgap.so.0.0.0` this will break.

Again, it'd be much easier to avoid using `dlopen()` altogether. That depends on whether https://github.com/markuspf/gap/issues/1 is fixed. I don't have gap with compiled packages to test (a compiled package would have some *.so file that should have `libgap.so.0` in the needed section -- the bug is that it doesn't).


---

Comment by tornaria created at 2022-03-03 01:42:06

Here's how to reproduce (in sagemath-9.5) the original bug for which the `dlopen()` hack is needed:

1. build sage 9.5 from scratch, and also build optional package `gap_packages`:

```
$ ./configure --disable-doc
...
$ make -j36 build
...
$ make -j36 gap_packages
...
```


2. set `GAP_SO = ""` before using `libgap`, this disables "the hack":

```
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5, Release Date: 2022-01-30                     │
│ Using Python 3.10.2. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: sage.env.GAP_SO = ""    # This disables the hack
sage: libgap.LoadPackage("io")
#W dlopen() error: /home/tornaria/src/sage/sage-9.5/local/share/gap/pkg/io-4.7.0/bin/x86_64-pc-linux-gnu-default64-kv7/io.so: undefined symbol: ChangedBags
Panic in src/modules.c:893: Failed to load needed dynamic module /home/tornaria/src/sage/sage-9.5/local/share/gap/pkg/io-4.7.0/bin/x86_64-pc-linux-gnu-default64-kv7/io.so, error code 1
```

As explained in https://github.com/markuspf/gap/issues/1 this is because the gap compiled package (io.so) is missing a needed libgap.so.0:

```
$ ldd local/lib/gap/pkg/io-4.7.0/bin/x86_64-pc-linux-gnu-default64-kv7/io.so
        linux-vdso.so.1 (0x00007ffe2595c000)
        libc.so.6 => /usr/lib/libc.so.6 (0x00007f8d7bf19000)
        /usr/lib64/ld-linux-x86-64.so.2 (0x00007f8d7c102000)
```

The problem is that in fact `io.so` uses some symbols that are exported in `libgap.so.0` without adding that to its needed section. The hack is to reload `libgap.so.0` with `RTLD_GLOBAL` so that all the symbols in `libgap.so.0` are placed in the global symbol table where `io.so` can have them.

If we don't disable "the hack" then the io.so package can be loaded ok:

```
$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5, Release Date: 2022-01-30                     │
│ Using Python 3.10.2. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: libgap.LoadPackage("io")
true
```


This looks to me a real bug in libgap which should be fixed upstream... As explained in the github issue above, when running `gap` as a program (instead of a library) the problem doesn't arise since `gap` the program contains the whole of `libgap` (instead of being dynamically linked) so that all the required symbols are already in the global symbol table.


---

Comment by fbissey created at 2022-03-03 04:29:11

That's interesting. In Gentoo, I explicitly patch packages like `io` to link to `libgap.so`. In fact I even patched all the package tooling from `gap` like `gac` and `Makefile.gappkg` so packages that use those do not need to be patched as much as possible and still get linked with `libgap`.

Sounds to me like you are telling me, I can give the hack the boot on Gentoo if I want too.


---

Comment by fbissey created at 2022-03-03 04:43:26

As a quick and dirty fix that probably should be included inside the `gap_packages` spkg. Does

```
LIBS="-lgap" make -j36 gap_packages
```

fix the problem of stuff like `io`. It is the kind of stuff I was doing https://github.com/cschwan/sage-on-gentoo/blob/master/dev-gap/io/io-4.7.0.ebuild#L32 before patching the build system https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/gap-core/files/gap-core-4.11.1-gac.patch#L56 (and #L60).


---

Comment by arojas created at 2022-03-03 09:25:52

Replying to [comment:27 fbissey]:
> That's interesting. In Gentoo, I explicitly patch packages like `io` to link to `libgap.so`. In fact I even patched all the package tooling from `gap` like `gac` and `Makefile.gappkg` so packages that use those do not need to be patched as much as possible and still get linked with `libgap`.

Same on Arch:

https://github.com/archlinux/svntogit-community/blob/packages/gap/trunk/PKGBUILD#L64

I think this is someting that needs to be fixed on the gap side.


---

Comment by fbissey created at 2022-03-03 09:28:07

I just finished a test build with

```
diff --git a/build/pkgs/gap_packages/spkg-install.in b/build/pkgs/gap_packages/spkg-install.in
index 168e6b1153..61c753bb53 100644
--- a/build/pkgs/gap_packages/spkg-install.in
+++ b/build/pkgs/gap_packages/spkg-install.in
@@ -71,7 +71,7 @@ do
     CFLAGS="$CFLAGS -Wno-implicit-function-declaration"
     export CFLAGS
     cd "$PKG_SRC_DIR/$pkg"
-    ./configure "$GAP_ROOT"
+    ./configure "$GAP_ROOT" LIBS="-lgap"
     sdh_make -j1
     install_compiled_pkg "$pkg"
     cd "$PKG_SRC_DIR"
@@ -95,7 +95,7 @@ for pkg in nq-* io-* digraphs-* semigroups-*
 do
     echo "Building GAP package $pkg"
     cd "$PKG_SRC_DIR/$pkg"
-    sdh_configure --with-gaproot="$GAP_ROOT" ${pararr[$parind]}
+    sdh_configure --with-gaproot="$GAP_ROOT" ${pararr[$parind]} LIBS="-lgap"
     ((parind+=1))
     sdh_make -j1
     install_compiled_pkg "$pkg"
```

and 

```
ldd -r local/lib/gap/pkg/io-4.7.0/bin/x86_64-pc-linux-gnu-default64-kv7/io.so 
	linux-vdso.so.1 (0x00007ffc04fa2000)
	libgap.so.0 => /home/fbissey/sandbox/git-personal/sage/local/lib/libgap.so.0 (0x00007fc5b6d0a000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fc5b6c71000)
	libz.so.1 => /lib64/libz.so.1 (0x00007fc5b6c57000)
	libreadline.so.8 => /lib64/libreadline.so.8 (0x00007fc5b6bff000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fc5b6abf000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fc5b6ab9000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007fc5b6ab2000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fc5b68f7000)
	libtinfow.so.6 => /lib64/libtinfow.so.6 (0x00007fc5b68bb000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fc5b783f000)
```

just as I thought it would.


---

Comment by fbissey created at 2022-03-03 09:32:08

And I should add

```
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.6.beta3, Release Date: 2022-02-27               │
│ Using Python 3.10.0. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage.env.GAP_SO = ""
sage: libgap.LoadPackage("io")
true
```



---

Comment by tornaria created at 2022-03-03 15:12:59

It occurred to me that since the gap extension modules in sage already link to "the correct" `libgap` using the dynamic linker, using `dlopen()` on one of these extension modules would be a workaround that avoid the need for `GAP_SO` altogether. Indeed:

```
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -229,7 +229,7 @@ cdef initialize():
     # this isn't portable
 
     cdef void* handle
-    libgapname = str_to_bytes(sage.env.GAP_SO)
+    libgapname = str_to_bytes(__loader__.path)
     handle = dlopen(libgapname, RTLD_NOW | RTLD_GLOBAL)
     if handle is NULL:
         raise RuntimeError(
```


With this patch loading gap packages works without the need for `GAP_SO`:

```
$ ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5, Release Date: 2022-01-30                     │
│ Using Python 3.10.2. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: print(sage.env.GAP_SO)
None
sage: libgap.LoadPackage("io")
true
sage:
```


Explanation:
 - `__loader__.path` here is a shortcut for `sage.libs.gap.util.__loader__.path` which contains the full path to the `sage.libs.gap.util` extension module (should be something like `$SAGE_LOCAL/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/libs/gap/util.cpython-310-x86_64-linux-gnu.so` for a normal install of sage, may be `/usr/lib/python3.10/site-packages/sage/libs/gap/util.so` for a system install of sage).
 - apply "the hack" (reload using `dlopen()` with `RTLD_GLOBAL`) to this extension module instead of `GAP_SO`.
 - since the extension module is linked to "the correct" libgap (via NEEDED section, etc) this will also reload libgap in the global symbol table.

Notes:
 - the error message should be reworked (or else, it's probably safe to get rid of)
 - there is another user of `GAP_SO` in `sage.interfaces.gap_workspace`, where it is used to link the workspace save name to the actual libgap -- I'm not sure why is that important (see #31404#comment:40 and a801e6d). I should point out that since in principle `GAP_SO` will always be `$SAGE_LOCAL/lib/libgap.so.0.0.0` for a normal sage install, there's really not much of a difference in using `SAGE_LOCAL` instead. I don't understand the need for this in the workspace name, it traces back to 40e41cd2118b from 2007.
 - maybe the same trick works for singular and we can get rid of `LIBSINGULAR_PATH` as well.


---

Comment by fbissey created at 2022-03-03 19:49:54

Anything that get rid of the `GAP_SO` hack is a good thing (TM). If someone could test that it works on OS X we should go for the latest. Although, we can apply all the separate measures that can fix it in a single drop to make sure the thing is killed.


---

Comment by tornaria created at 2022-03-04 02:14:09

I replaced the previous patch by two commits to do what I said before: one for gap, one for singular.

For me everything seems to be working fine after this on glibc. I will later test on musl (I assume all glibc systems should be similar, but musl may be different). Can someone test in macos, and maybe cygwin? (although "the hack" for singular is disabled in cygwin, why? it's not for gap).

If this works we can then remove `LIBSINGULAR_PATH` and `GAP_SO` from `sage.env` and `singular/spkg-configure.m4`.
----
New commits:


---

Comment by mkoeppe created at 2022-03-04 02:56:40

Replying to [comment:34 tornaria]:
> "the hack" for singular is disabled in cygwin, why?

Because we found out that it's not needed on Cygwin - #32954.


---

Comment by fbissey created at 2022-03-04 04:15:47

Going down that route, I think we should just eliminate `GAP_SO` and `LIBSINGULAR_PATH`, which means removing them from `env.py` and dealing with this strange bit in `sage/interfaces/gap_workspace.py`

```
    if GAP_SO:
        h = hashlib.sha1(GAP_SO.encode('utf-8')).hexdigest()
    else:
        h = 'unknown'
    return os.path.join(dir, '%s-%s-%s' % (system, name, h))
```

I am sure when can find something else to hash.


---

Comment by mkoeppe created at 2022-03-04 05:20:47

The current branch seems to work well on macOS (x86_64) with singular from SPKG.


---

Comment by tornaria created at 2022-03-04 16:26:40

Replying to [comment:35 mkoeppe]:
> Replying to [comment:34 tornaria]:
> > "the hack" for singular is disabled in cygwin, why?
> 
> Because we found out that it's not needed on Cygwin - #32954.
> 

Is it the case that all symbols are global on cygwin? If so there is no need to `dlopen(RTLD_GLOBAL)` at all, neither for singular nor for gap.

OTOH, I understand this is skipped on cygwin because figuring out the singular soname is difficult. Since this is not a problem now, it may as well be done unconditionally.


---

Comment by tornaria created at 2022-03-04 16:57:22

Changing status from needs_review to needs_work.


---

Comment by tornaria created at 2022-03-04 16:57:22

Replying to [comment:36 fbissey]:
> Going down that route, I think we should just eliminate `GAP_SO` and `LIBSINGULAR_PATH`, which means removing them from `env.py` and dealing with this strange bit in `sage/interfaces/gap_workspace.py`
> {{{
>     if GAP_SO:
>         h = hashlib.sha1(GAP_SO.encode('utf-8')).hexdigest()
>     else:
>         h = 'unknown'
>     return os.path.join(dir, '%s-%s-%s' % (system, name, h))
> }}}
> I am sure when can find something else to hash.


I think reverting [a801e6d](https://git.sagemath.org/sage.git/commit?id=a801e6d) should be ok, i.e. back to hashing SAGE_LOCAL.

Background:
 - the hash of SAGE_ROOT (later changed to SAGE_LOCAL) in the workspace filename was introduced by wstein in [40e41cd](https://git.sagemath.org/sage.git/commit?id=40e41cd2118b4b581fbdc14ef68c53c828c14262) and [76b1b00](https://git.sagemath.org/sage.git/commit?id=76b1b000e86aa99dc29a5a6bf84151a567be0d68) in 2007.
 - I think the intent is that if one has different installations of sage, they don't mix up the gap workspace (which IIUC is only for caching purposes), I guess in case different versions of sage use the gap workspace in different/incompatible ways.
 - Using GAP_SO is almost equivalent to using SAGE_LOCAL for bundled gap (GAP_SO = SAGE_LOCAL + "lib/libgap.so.0.0.0"), but it may be worse for system gap (pending #29644) in the sense that all different installations of sage will have the same GAP_SO
 - If the intent of [a801e6d](https://git.sagemath.org/sage.git/commit?id=a801e6d) is catching changes in the version of gap, well it seems upstream doesn't change the library version often (it's stuck in 0.0.0). Moreover, sage.libs.gap.saved_workspace has a different way to track changes in gap, namely by looking at the timestamp of files in the gap root directory it may decide that gap has changed and the workspace needs to be reset. Anyway that check doesn't seem completely ok but if there's any issue with that it should be addressed there and not with the library version that doesn't really change.
 - It may be wise to ask wstein about his motivation for this, just in case.


---

Comment by tornaria created at 2022-03-04 18:25:49

Replying to [comment:36 fbissey]:
> I am sure when can find something else to hash.

Other possibilities tied to gap:

```
sage: libgap.eval("KERNEL_INFO().KERNEL_VERSION")
"4.11.1"
sage: libgap.eval("KERNEL_INFO().RELEASEDAY")
"2021-03-02"
sage: libgap.eval("KERNEL_INFO().BUILD_VERSION")
"4.11.1"
sage: libgap.eval("KERNEL_INFO().BUILD_DATETIME")
"2021-03-02 16:21:26+0000"
sage: libgap.eval("KERNEL_INFO().GAP_ARCHITECTURE")
"x86_64-unknown-linux-gnu-default64-kv7"
sage: libgap.eval("KERNEL_INFO().KERNEL_API_VERSION")
7000
```


About the rationale for hash(SAGE_LOCAL) wstein told me:
> My guess is that different versions of Gap have (or had) completely incompatible workspace files.  It just seems unlikely they would be backward and forward compatible between potentially wildly different versions of Gap.   Different Sage installs could easily have very different versions of Gap in them.

I also asked him "if I use two different versions of sage which use the same gap, wouldn't there be a problem if they share the same gap workspace?" to which he said:
> I think it would be OK because the relevant version of gap is the same, but I'm not sure either.

----

To be safe, maybe combine KERNEL_VERSION and GAP_ARCHITECTURE from above together with SAGE_LOCAL. Perhaps add sage.env.HOSTNAME to the filename.


---

Comment by mkoeppe created at 2022-03-04 18:56:38

Replying to [comment:38 tornaria]:
> Replying to [comment:35 mkoeppe]:
> > Replying to [comment:34 tornaria]:
> > > "the hack" for singular is disabled in cygwin, why?
> > 
> > Because we found out that it's not needed on Cygwin - #32954.
> 
> Is it the case that all symbols are global on cygwin?

No, that's not the mechanism. Singular uses a different mechanism on the Cygwin platform to provide its modules. Everything is already linked into the library libSingular.

On the Cygwin platform, all symbols must be resolved at link time. See #30814 (`--no-undefined`)

I don't know what GAP does and whether anyone has even successfully used `gap_packages` on the Cygwin platform.


---

Comment by git created at 2022-03-06 15:14:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tornaria created at 2022-03-06 15:27:15

Changing status from needs_work to needs_review.


---

Comment by tornaria created at 2022-03-06 15:27:15

In the last commit I change theh workspace filename to be computed as follows:

```
    data = SAGE_LOCAL
    sysinfo = os.path.join(GAP_ROOT_DIR, "sysinfo.gap")
    if os.path.exists(sysinfo):
        data += subprocess.getoutput(f'. {sysinfo} && echo ":$GAP_VERSION:GAParch"')
    h = hashlib.sha1(data.encode('utf-8')).hexdigest()
    return os.path.join(dir, '%s-%s-%s-%s' % (system, name, HOSTNAME, h))
```


I realized it's NOT reasonable to run gap code as suggested above, since it would double the initialization time for sage (gap is slow to start).

It turns out that the gap root should contain a file `sysinfo.gap` which can be sourced from shell and contains gap version, etc. so I just did that.

I doubt there will be a way to eliminate the need for `GAP_ROOT_DIR` but that is matter for #29644.


---

Comment by mkoeppe created at 2022-05-01 01:31:31

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-05-01 01:31:31

merge conflict


---

Comment by git created at 2022-10-16 15:39:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tornaria created at 2022-10-16 15:51:40

I rebased everything on 9.8.beta1.

I am still unsure what to do about `gap_workspace_file()` and whether the last commit is ok.

I think it would be better to use stuff from `KERNEL_INFO()` as mentioned in comment:40. The problem with that is that `gap_workspace_file()` is called on sage startup and initializing gap is slow. The solution could be to delay calling `gap_workspace_file()` until it is actually used (at which point gap or libgap will be initialized anyway).

For the short run, what is here seems better (with or without the last commit). Right now I still have to patch stuff for void linux since we don't ship `/usr/lib/libgap.so` with runtime packages (and it is a pain since everything will work ok if `gap-devel` happens to be installed, which is the case when building, so the failure tends to be missed).


---

Comment by dimpase created at 2022-11-01 12:05:09

Could you rebase this on GAP 4.12 - the update has been positively reviewed in #34391 ?


---

Comment by git created at 2022-11-12 15:29:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by tornaria created at 2022-11-12 15:31:34

Rebased on top of #34391. I added a commit so `sysinfo.gap` is searched both in `GAP_LIB_DIR` and in `GAP_SHARE_DIR`. Also: use the content of those variables instead of `SAGE_LOCAL`.


---

Comment by tornaria created at 2022-11-12 16:04:52

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-12-05 00:31:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2022-12-07 21:26:04

let's get #34391 in first - it's a bit hard to review now.


---

Comment by tornaria created at 2022-12-08 01:16:36

Replying to [comment:55 Dima Pasechnik]:
> let's get #34391 in first - it's a bit hard to review now.

Sure, but just for the record: the head of #34391 is
 - ​29383be	backport GAP PR 5235
and my branch here is linearly rebased on top of that.

I could squash some of the commits together if that makes it easier to review (ec2476b + 4768b99 + 126b0de are part of the same change, in a sense). That would leave 5 clearly defined commits.


---

Comment by dimpase created at 2022-12-09 11:02:25

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-12-09 11:02:25

looks good - also tested on macOS
