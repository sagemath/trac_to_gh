# Issue 32512: Enable gitpod integration

Issue created by migration from https://trac.sagemath.org/ticket/32749

Original creator: @tobiasdiez

Original creation time: 2021-10-23 21:07:38

CC:  mkoeppe saraedum mderickx

[Gitpod](https://www.gitpod.io/) allows one to setup a complete dev environment in the cloud. It is free to use for up to 50 hours per month. In this ticket the config necessary for making this work with sagemath is added. 

You can try this out by going to https://gitpod.io/#https://github.com/sagemath/sagetrac-mirror/tree/public/build%2Fgitpod. 

It currently takes a bit more than 1 hour until everything is setup. After this ticket is merged, we can enable the automatic prebuild using a github app (https://www.gitpod.io/docs/prebuilds#on-github). With this enabled, every push to the develop branch would trigger a prebuild of the complete environment (including the build of all dependencies and cythonizion) so that one has a up-to-date code env in a matter of a few seconds.


----

While setting things up, I noticed a few issues. Not sure if they are known problems or even by design. Please let me know if I should open a ticket for them to improve things.
- gitpod has brew installed on linux by default. Sagemath thinks this is the primary package manager and, e.g., configure suggests to run `brew xyz` to install new packages.
- gitpod comes also with pyenv preinstalled. This breaks the build unless one sets `pyenv global system`. Otherwise all python packages will be installed in the python env set by pyenv.
- Curretly gitpod prebuild has a time limit of 1 hour (with the plan to increase it in the future). To improve our build time I propose to add a new `make` option that uses prebuilt wheels from pypi instead of compiling everything locally.


---

Comment by mkoeppe created at 2021-10-23 22:03:32

Use of linuxbrew is entirely untested; see #29159


---

Comment by mkoeppe created at 2021-10-23 22:07:43

The problem with `ecl` is clearly due to a broken `ecl` package in linuxbrew - it tries to use a nonexisting compiler.


---

Comment by mkoeppe created at 2021-10-23 22:09:17

Probably `build/bin/sage-guess-package-system` should be changed so that `brew` is only tested after the Linux package managers.


---

Comment by git created at 2021-10-24 12:32:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-24 12:36:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-24 12:43:24

Thanks for the feedback. I've now removed the linuxbrew install of ecl and opened tickets for the other things. So this is now ready for review.


---

Comment by @tobiasdiez created at 2021-10-24 12:43:24

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-10-24 17:24:37

Does it work?


---

Comment by mkoeppe created at 2021-10-24 17:26:00

Consider opening a bug report against the ecl packaging on linuxbrew


---

Comment by mkoeppe created at 2021-10-24 17:30:33

Let's resolve the `pyenv` issues in #29285


---

Comment by @tobiasdiez created at 2021-10-24 22:06:38

Replying to [comment:9 mkoeppe]:
> Does it work?

Yes! You can also test this out using the above link. Currently one has to wait for the build to finish. This waiting time can be removed by activating the github integration after this ticket is merged.


---

Comment by @tobiasdiez created at 2021-10-24 22:07:23

Replying to [comment:10 mkoeppe]:
> Consider opening a bug report against the ecl packaging on linuxbrew

Will do after this ticket is merged (since I can then reference the gitpod workspace as a reproducible example).


---

Comment by mkoeppe created at 2021-10-24 22:34:44

It is asking: "We noticed a new virtual environment has been created. Do you want to select it for the workspace folder?"

Add the correct answer to the documentation?


---

Comment by mkoeppe created at 2021-10-24 22:36:52

Maybe you want to use `make V=0` so that there's less output during build?


---

Comment by mkoeppe created at 2021-10-24 22:44:09

Does this need Sage's Jupyter notebook or does it bring its own?

`configure --disable-notebook` can be used to avoid building notebook and its many Python deps


---

Comment by mkoeppe created at 2021-10-24 22:56:00

Given that the preinstalled linux is old and the linuxbrew has some broken packages, one could wonder whether it would be better to use `conda` to set up a richer environment with much shorter time for building.
The scipy people seem to be doing that - https://scipy.github.io/devdocs/dev/contributor/quickstart_gitpod.html - but I haven't looked at any details.


---

Comment by mkoeppe created at 2021-10-25 02:33:31

The build on Gitpod finished for me, but then the workspace timed out; on opening it again, starting `./sage` fails with 
`ImportError: libzmq.so.5: cannot open shared object file: No such file or directory`.
Am I doing something wrong?


---

Comment by @tobiasdiez created at 2021-10-25 07:49:40

Replying to [comment:15 mkoeppe]:
> It is asking: "We noticed a new virtual environment has been created. Do you want to select it for the workspace folder?"
> 
> Add the correct answer to the documentation?

This will be no longer necessary once we have added the VS config.


---

Comment by @tobiasdiez created at 2021-10-25 07:50:59

Replying to [comment:16 mkoeppe]:
> Maybe you want to use `make V=0` so that there's less output during build?

Normally the user wouldn't see this, and everything that is printed during the init stage would become the prebuilt log that can be viewed in the admin interface. So I think its fine to have it more detailed, in case something goes wrong.


---

Comment by @tobiasdiez created at 2021-10-25 07:55:53

Replying to [comment:18 mkoeppe]:
> Given that the preinstalled linux is old and the linuxbrew has some broken packages, one could wonder whether it would be better to use `conda` to set up a richer environment with much shorter time for building.
> The scipy people seem to be doing that - https://scipy.github.io/devdocs/dev/contributor/quickstart_gitpod.html - but I haven't looked at any details.

That might indeed something to consider. I would keep it for now using plain ubuntu to get some experience how it goes with the prebuilt. We can change it to conda later if necessary.


---

Comment by @tobiasdiez created at 2021-10-25 07:59:50

Replying to [comment:19 mkoeppe]:
> The build on Gitpod finished for me, but then the workspace timed out; on opening it again, starting `./sage` fails with 
> `ImportError: libzmq.so.5: cannot open shared object file: No such file or directory`.
> Am I doing something wrong?
> 

I can confirm this. 

I also sometimes had other problems with re-started workspaces. For example, when the build was interrupted then next time `make` tried to install packages (e.g. python) that were using system packages during the first run and thus didn't needed to run. I'm not sure ifs a bug with gitpod (i.e. some important files are not correctly restored) or an issue with sage's build system. Do you have an idea what's going wrong?


---

Comment by @tobiasdiez created at 2021-10-25 08:00:53

Replying to [comment:17 mkoeppe]:
> Does this need Sage's Jupyter notebook or does it bring its own?
> 
> `configure --disable-notebook` can be used to avoid building notebook and its many Python deps

If you want to use VS codes Jupyter notebook integration, jupyter needs to be installed in the venv used.


---

Comment by git created at 2021-10-25 12:10:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-25 12:59:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-25 14:34:24

Replying to [comment:23 gh-tobiasdiez]:
> Replying to [comment:19 mkoeppe]:
> > The build on Gitpod finished for me, but then the workspace timed out; on opening it again, starting `./sage` fails with 
> > `ImportError: libzmq.so.5: cannot open shared object file: No such file or directory`.
> > Am I doing something wrong?
> > 
> 
> I can confirm this. 
> 
> I also sometimes had other problems with re-started workspaces. For example, when the build was interrupted then next time `make` tried to install packages (e.g. python) that were using system packages during the first run and thus didn't needed to run. I'm not sure ifs a bug with gitpod (i.e. some important files are not correctly restored) or an issue with sage's build system. Do you have an idea what's going wrong?

That was in fact my mistake. Only stuff under the workspace directory is restored by gitpod. Thus, the apt-get installed packages got lost. I've now moved the system setup into a dockerfile which should fix this.


---

Comment by @tobiasdiez created at 2021-10-27 09:49:42

As a follow-up to reduce the build duration, is it possible to build certain libraries (say `make ecl`), store the result somewhere in the docker image and then on `make build` reuse the previously built ecl?


---

Comment by mkoeppe created at 2021-11-13 20:22:51

Sorry that I haven't had the time to look at the new version in the past weeks. If this is ready for testing by developers, I'd suggest that you post on sage-devel to invite people to try it out.


---

Comment by @tobiasdiez created at 2021-11-17 21:08:54

No worries!

It's working for me and ready for review. However, it currently needs to build everything on each start of the workspace. Thus, that's not very friendly for other devs to try out. But after it is merged and the Gitpod github action is activated, the workspaces are prebuild and thus instantly ready. That's then a better point to advertise it on the developer mailing list.

(Caveat: Currently gitpod only allows prebuilds of up to 1h; I'm not sure if we manage this)


---

Comment by git created at 2021-11-26 15:12:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-26 15:14:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-28 14:41:26

do you know if gitpod allows sharing these prebuilds across accounts?


---

Comment by @tobiasdiez created at 2021-11-28 17:20:18

Normally, the prebuilds are build centrally by a github application that notifies gitpod about changes to certain branches (currently only the default branch). These prebuilds are then used by everyone that starts a new environment based on these branches.

But you do can share a workspace, see https://www.gitpod.io/docs/sharing-and-collaboration. Thus, say you update a dependency in a workspace and this leads to errors, then you can make a snapshot and share it with other developers so that can investigate the issue.


---

Comment by git created at 2021-12-08 22:10:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 12:05:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 15:24:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 16:40:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 18:01:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 18:04:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 19:08:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 21:33:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 21:40:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 22:14:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 22:40:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 22:44:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 22:48:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 22:58:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 23:23:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 23:34:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-10 11:21:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-10 12:59:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-10 15:01:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-10 21:25:56

I've moved the compilation of most non-python packages to the docker file (as they are relatively constant) to minimize the time one has to wait until the gitpod workspace is completely initialized.


---

Comment by mkoeppe created at 2021-12-23 20:40:01

This could be much simplified by just configuring `sage-prebuild` and the actual build to use the same prefix (`configure --prefix=...`).


---

Comment by mkoeppe created at 2021-12-23 20:40:41

-1 on hardcoding (again) the list of Debian packages. We have infrastructure for that - use it


---

Comment by mkoeppe created at 2021-12-23 20:41:56

Overall I think it's too slow to fit well in the "ephemeral workspace" philosophy of gitpod


---

Comment by mkoeppe created at 2021-12-23 20:44:08

I'd suggest to integrate with the Docker image stuff described in `docker/README.md` - a lot of work has been done there to make incremental builds fast.


---

Comment by @tobiasdiez created at 2021-12-25 19:56:58

Replying to [comment:55 mkoeppe]:
> This could be much simplified by just configuring `sage-prebuild` and the actual build to use the same prefix (`configure --prefix=...`).

Could you please expand on this idea. Since the current code already use the `prefix` idea:
> RUN ./configure --prefix=/home/gitpod/sage-prebuild

Note also that the final build (in gitpod.yml) should preferably use a normal build (without a special prefix) to be as close as possible to a "normal" dev setup.


---

Comment by @tobiasdiez created at 2021-12-25 19:58:20

Replying to [comment:56 mkoeppe]:
> -1 on hardcoding (again) the list of Debian packages. We have infrastructure for that - use it

Okay, but I couldn't figure out how to use this in a Docker file that needs to be static (and not be generated). What do you propose to do?


---

Comment by @tobiasdiez created at 2021-12-25 19:59:45

Replying to [comment:58 mkoeppe]:
> I'd suggest to integrate with the Docker image stuff described in `docker/README.md` - a lot of work has been done there to make incremental builds fast.

The dockerbuild here is however not meant to be incremental. It's build once and then is reused as a basis for every workspace. It also needs to run below 1h as this is current timeout of gitpod.


---

Comment by @tobiasdiez created at 2021-12-25 20:03:04

Replying to [comment:57 mkoeppe]:
> Overall I think it's too slow to fit well in the "ephemeral workspace" philosophy of gitpod

It's only slow currently as the whole build of sage is triggered everytime a workspace is started. Once this ticket is merged, one could activate gitpods 'prebuild' feature that does this in the background automatically, so that starting the workspace is a matter of seconds (which are mainly spent to load the custom docker image + the prebuild files). See the ticket description.


---

Comment by mkoeppe created at 2021-12-25 20:10:34

Replying to [comment:59 gh-tobiasdiez]:
> Replying to [comment:55 mkoeppe]:
> > This could be much simplified by just configuring `sage-prebuild` and the actual build to use the same prefix (`configure --prefix=...`).
> 
> Could you please expand on this idea. Since the current code already use the `prefix` idea:
> > RUN ./configure --prefix=/home/gitpod/sage-prebuild

Change this to `./configure --prefix=/home/gitpod/sage-local`

and change `./configure -enable-editable` in `.gitpod.yml` to `./configure --prefix=/home/gitpod/sage-local --enable-editable`

> Note also that the final build (in gitpod.yml) should preferably use a normal build (without a special prefix) to be as close as possible to a "normal" dev setup. 

Using `--prefix` is normal - it's step 4 of our install instructions in README.md


---

Comment by mkoeppe created at 2021-12-25 20:37:49

Replying to [comment:61 gh-tobiasdiez]:
> Replying to [comment:58 mkoeppe]:
> > I'd suggest to integrate with the Docker image stuff described in `docker/README.md` - a lot of work has been done there to make incremental builds fast.
> 
> The dockerbuild here is however not meant to be incremental. It's build once and then is reused as a basis for every workspace. It also needs to run below 1h as this is current timeout of gitpod.

Is there a particular reason why you cannot use the existing Docker build https://hub.docker.com/r/sagemath/sagemath/tags


---

Comment by @tobiasdiez created at 2021-12-27 20:25:58

Replying to [comment:63 mkoeppe]:
> Replying to [comment:59 gh-tobiasdiez]:
> > Replying to [comment:55 mkoeppe]:
> > > This could be much simplified by just configuring `sage-prebuild` and the actual build to use the same prefix (`configure --prefix=...`).
> > 
> > Could you please expand on this idea. Since the current code already use the `prefix` idea:
> > > RUN ./configure --prefix=/home/gitpod/sage-prebuild
> 
> Change this to `./configure --prefix=/home/gitpod/sage-local`
> 
> and change `./configure -enable-editable` in `.gitpod.yml` to `./configure --prefix=/home/gitpod/sage-local --enable-editable`

That's a good suggestion. Sadly gitpod only preserves changes to the workspace folder during prebuilds, so the the `make` in `.gitpod.yml` needs to write everything in the local workspace folder and not in some global/system folder. https://www.gitpod.io/docs/prebuilds#workspace-directory-only


---

Comment by @tobiasdiez created at 2021-12-27 20:33:23

Replying to [comment:64 mkoeppe]:
> Replying to [comment:61 gh-tobiasdiez]:
> > Replying to [comment:58 mkoeppe]:
> > > I'd suggest to integrate with the Docker image stuff described in `docker/README.md` - a lot of work has been done there to make incremental builds fast.
> > 
> > The dockerbuild here is however not meant to be incremental. It's build once and then is reused as a basis for every workspace. It also needs to run below 1h as this is current timeout of gitpod.
> 
> Is there a particular reason why you cannot use the existing Docker build https://hub.docker.com/r/sagemath/sagemath/tags

First of all, the end goal is different: the gitpod docker serves as a developer enviroment, and the existing docker config is a means to distribute sage. Concretely, gitpod has a hard timeout of 1h, so everything is optimized to fit into this timeframe (for example, only a handful of non-python packages are built). Also the current docker seems to use a very minimal installation of system packages, while the gitpod image tries to install all relevant system packages; the base image is also different. It seems to be also hard to reuse an existing docker file with gitpod, since one only can specify a dockerfile and not the exact docker build command (in particular not the specific target / build stage). But in the end, there is also not much code duplication between the docker images, so I don't think thats a big issue.


---

Comment by mkoeppe created at 2021-12-27 21:41:35

Replying to [comment:65 gh-tobiasdiez]:
> Sadly gitpod only preserves changes to the workspace folder during prebuilds, so the the `make` in `.gitpod.yml` needs to write everything in the local workspace folder and not in some global/system folder.

Is all of `/home/gitpod` in the workspace?


---

Comment by mkoeppe created at 2021-12-27 21:43:04

Replying to [comment:62 gh-tobiasdiez]:
> Replying to [comment:57 mkoeppe]:
> > Overall I think it's too slow to fit well in the "ephemeral workspace" philosophy of gitpod
> 
> It's only slow currently as the whole build of sage is triggered everytime a workspace is started. Once this ticket is merged, one could activate gitpods 'prebuild' feature [...] 

Why does this have to wait for the ticket being merged? Can it not be done from an arbitrary branch?


---

Comment by @tobiasdiez created at 2021-12-28 12:46:21

Replying to [comment:67 mkoeppe]:
> Replying to [comment:65 gh-tobiasdiez]:
> > Sadly gitpod only preserves changes to the workspace folder during prebuilds, so the the `make` in `.gitpod.yml` needs to write everything in the local workspace folder and not in some global/system folder.
> 
> Is all of `/home/gitpod` in the workspace?

The "workspace" is in `/workspace/sagetrac-mirror`, and only changes to this folder are preserved in prebuilds. On the other hand, the docker image can change system folders such as `/home/gitpod` and those changes are accessible during the prebuild. I couldn't find out a way to change something in `/workspace` using the docker image (gitpod also handles the git checkout for you etc).


---

Comment by @tobiasdiez created at 2021-12-28 12:50:19

Replying to [comment:68 mkoeppe]:
> Replying to [comment:62 gh-tobiasdiez]:
> > Replying to [comment:57 mkoeppe]:
> > > Overall I think it's too slow to fit well in the "ephemeral workspace" philosophy of gitpod
> > 
> > It's only slow currently as the whole build of sage is triggered everytime a workspace is started. Once this ticket is merged, one could activate gitpods 'prebuild' feature [...] 
> 
> Why does this have to wait for the ticket being merged? Can it not be done from an arbitrary branch?

What needs to be done is to activate the gitpod app for github on the org level. This could be done also before this ticket is merged, but I'm not sure if it would pick up the gitpod config or if that one needs to be present in the default branch.

The prebuild can be configured to run for certain branches, see https://www.gitpod.io/docs/prebuilds#github-specific-configuration. Currently, it uses the default config which enables prebuilds only for the default branch (= develop).


---

Comment by mkoeppe created at 2021-12-28 18:49:11

Would https://www.gitpod.io/docs/prebuilds#manual-prebuilds work, or does this also depend on the org-level activation?


---

Comment by git created at 2021-12-28 19:32:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-28 19:32:52

Replying to [comment:60 gh-tobiasdiez]:
> Replying to [comment:56 mkoeppe]:
> > -1 on hardcoding (again) the list of Debian packages. We have infrastructure for that - use it
> 
> Okay, but I couldn't figure out how to use this in a Docker file that needs to be static (and not be generated). 

I've pushed a change that implements it, take a look


---

Comment by mkoeppe created at 2021-12-28 19:35:24

(I've only tested this locally with `DOCKER_BUILDKIT=0 docker build . -f docker/.gitpod.Dockerfile ` to the end of the configure run)


---

Comment by @tobiasdiez created at 2021-12-29 12:17:57

Thanks, this looks good but for some reason the docker build on gitpod doesn't succeed. Still have to investigate why (maybe some system package is not installed and now needs to be built, which increases the built time too much?).

For the record, these are the system packages that are installed now

```
#9 2.646 The following additional packages will be installed:
#9 2.646   binutils-common binutils-x86-64-linux-gnu cmake-data fflas-ffpack-common
#9 2.646   gcc-10-base gettext-base gfortran-9 libamd2 libarchive13 libatlas3-base
#9 2.646   libatomic1 libbinutils libblas-dev libblas3 libboost1.71-dev libbraiding0
#9 2.646   libbrial-groebner3 libbrial3 libbtf1 libcamd2 libcc1-0 libccolamd2 libcdd0d
#9 2.646   libcholmod3 libcliquer1 libcolamd2 libcroco3 libctf0 libcurl4 libcxsparse3
#9 2.646   libdrm-amdgpu1 libdrm-common libdrm-intel1 libdrm-nouveau2 libdrm-radeon1
#9 2.646   libdrm2 libec5 libecm1 libecm1-dev libecm1-dev-common libflint-2.5.2
#9 2.646   libflint-arb2 libfltk-gl1.3 libfltk-images1.3 libfltk1.3 libgc1c2 libgcc-s1
#9 2.646   libgd3 libgf2x3 libgfortran-9-dev libgfortran5 libgiac0 libgivaro9 libgl1
#9 2.646   libgl1-mesa-dri libgl2ps1.4 libglapi-mesa libglpk40 libglvnd0 libglx-mesa0
#9 2.646   libglx0 libgomp1 libgraphblas3 libgsl23 libgslcblas0 libhomfly0 libiml0
#9 2.646   libitm1 libjsoncpp1 libklu1 liblapack-dev liblapack3 libldl2 liblfunction0
#9 2.646   libllvm12 liblrcalc1 liblsan0 libm4ri-0.0.20200125 libm4ri-dev
#9 2.646   libm4rie-0.0.20200125 libmetis5 libmongoose2 libmpfi-dev-common libmpfi0
#9 2.646   libnauty2 libnorm-dev libnorm1 libntl43 libopenblas-pthread-dev libopenblas0
#9 2.646   libopenblas0-pthread libpaper-utils libpaper1 libpari-gmp-tls6 libpciaccess0
#9 2.646   libpcre16-3 libpcre3 libpcre32-3 libpcrecpp0v5 libpgm-5.2-0 libpgm-dev
#9 2.646   libplanarity0 libppl-c4 libppl14 libpython3.8 libpython3.8-dev
#9 2.650   libpython3.8-minimal libpython3.8-stdlib libquadmath0 librbio2 librhash0
#9 2.650   librw0 libsensors-config libsensors5 libsingular4-dev-common libsingular4m1
#9 2.650   libsodium-dev libsodium23 libspqr2 libssl1.1 libstdc++6
#9 2.650   libsuitesparseconfig5 libsymmetrica2 libtachyon-mt-0 libtcl8.6 libtk8.6
#9 2.650   libtsan0 libubsan1 libumfpack5 libuv1 libvpx-dev libvpx6 libvulkan1
#9 2.650   libx11-xcb1 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-present0
#9 2.650   libxcb-sync1 libxcb-xfixes0 libxcursor1 libxfixes3 libxft2 libxinerama1
#9 2.650   libxmuu1 libxpm-dev libxpm4 libxshmfence1 libxss1 libxxf86vm1 libzmq5
#9 2.650   libzn-poly-0.9 pari-gp python3-lib2to3 python3.8 python3.8-minimal
#9 2.650   r-base-core singular-data singular-modules singular-ui sympow-data
#9 2.650   tachyon-bin-nox xauth xdg-utils
```



---

Comment by dimpase created at 2021-12-29 12:31:57

why does it want `libatlas3-base` ? Besides, `flint-2.5.2` is too old.
One should also be able to install `mpfr`, `mpc` - assuming they are not too old.


---

Comment by @tobiasdiez created at 2021-12-29 12:47:32

Thanks for looking into this.
mpfr and mpc are probably already installed (in the gitpod base image). At least configure says 

```
#18 41.11 mpc-1.1.0:                                   using system package; SPKG will not be installed
#18 41.15 mpfi-1.5.2:                                  using system package; SPKG will not be installed
#18 41.19 mpfr-4.0.1.p0:                               using system package; SPKG will not be installed
```



---

Comment by git created at 2021-12-29 18:55:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-30 05:54:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-30 06:05:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-12-30 07:24:43

Unfortunately `/workspace/sage-local` does not seem to make it from the prebuild to the running image


---

Comment by git created at 2021-12-30 07:31:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-30 07:44:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-12-30 09:05:51

This seems to work now


---

Comment by @tobiasdiez created at 2021-12-30 12:48:03

Thanks! But now the sage-local folder is outside of the actual workspace (which seems to be something like `workspace/<some name based on the branch/repo>`). Do you really think that the solution with the prefix + symbolic link + moving around sage-local is easier than setting a few env variables?

Maybe it would make sense to introduce a `base-prefix` setting that can be set to find packages installed there, but which doesn't overwrite the `prefix`. That could be also handy for the multi-stage github action.


---

Comment by @tobiasdiez created at 2021-12-30 12:50:58

I think also the `mv` command should be in `init` and not `before` as the latter is invoked also after a prebuild and would thus overwrite the changes to sage-local during the prebuild. https://www.gitpod.io/docs/config-start-tasks


---

Comment by mkoeppe created at 2021-12-30 16:37:02

Replying to [comment:85 gh-tobiasdiez]:
> Thanks! But now the sage-local folder is outside of the actual workspace (which seems to be something like `workspace/<some name based on the branch/repo>`). 

Are you saying that `/workspace` is not the workspace?


---

Comment by git created at 2021-12-30 16:47:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-30 16:49:38

Replying to [comment:85 gh-tobiasdiez]:
> Do you really think that the solution with the prefix + symbolic link + moving around sage-local is easier than setting a few env variables?

Yes, because it avoids the complexity - visible to developers - of having a third tier of packages between system packages and SPKGs.


---

Comment by mkoeppe created at 2021-12-30 17:01:52

Apart from these details:

Even with the 1 hour saved by pushing package builds into the prebuild phase saved, the initialization of the workspace still takes much too long for this whole thing to be convenient enough.

I see two directions how to fix this:
- Orchestrate the prebuild on our own on GH Actions - so that we are not constrained by the gitpod time limit of 1h. This could maybe use the incremental build infrastructure from our `docker/Dockerfile` (`sagemath-dev`) -- just replacing `FROM ubuntu:focal as run-time-dependencies` by `FROM gitpod/workspace-full`... 

- Use conda to provide most packages. Then the prebuild easily fits into the 1 hour time limit.


---

Comment by @tobiasdiez created at 2021-12-30 17:02:37

Replying to [comment:87 mkoeppe]:
> Replying to [comment:85 gh-tobiasdiez]:
> > Thanks! But now the sage-local folder is outside of the actual workspace (which seems to be something like `workspace/<some name based on the branch/repo>`). 
> 
> Are you saying that `/workspace` is not the workspace? 

Yes, the source code was placed somewhere like `/workspace/sagetrac-mirror` if I remember correctly. Cannot check currently as the recent changes triggered a rebuild of the docker image.


---

Comment by mkoeppe created at 2021-12-30 17:08:57

I think from https://www.gitpod.io/docs/checkout-location it's clear that `/workspace` is the workspace. Yes, the source is cloned into a subdirectory of it, but all of `/workspace` is saved.


---

Comment by @tobiasdiez created at 2021-12-30 17:13:29

Replying to [comment:90 mkoeppe]:
> Even with the 1 hour saved by pushing package builds into the prebuild phase saved, the initialization of the workspace still takes much too long for this whole thing to be convenient enough.

To make sure we are talking about the same thing: the docker image builds most system (non-python) packages, while the prebuild (everything in `init`) mostly builds the python packages and compiles sage. Both builds have currently a timeout of 1h (so in total the build can take 2h).

What takes most time in the second prebuild phase is the compilation of scipy (and of maxima). That's why I proposed to use pypi wheels #32754.


---

Comment by @tobiasdiez created at 2021-12-30 17:16:24

Replying to [comment:92 mkoeppe]:
> I think from https://www.gitpod.io/docs/checkout-location it's clear that `/workspace` is the workspace. Yes, the source is cloned into a subdirectory of it, but all of `/workspace` is saved.

It's probably a question of what a "workspace" folder is, but at least only `/workspace/sagetrac-mirror` was shown in the right source file browser. Of course everything in `/workspace` is available but people need to use bash commands to investigate it. Then one could also put sage-local directly in `/home/gitpod/sage-local`.


---

Comment by mkoeppe created at 2021-12-30 17:17:40

Replying to [comment:93 gh-tobiasdiez]:
> What takes most time in the second prebuild phase 
(you mean the `init` script)
> is the compilation of scipy (and of maxima).
... also the build of sagelib itself from scratch takes pretty long.


---

Comment by mkoeppe created at 2021-12-30 17:18:42

Replying to [comment:95 gh-tobiasdiez]:
> Then one could also put sage-local directly in `/home/gitpod/sage-local`.

Didn't you explain to me that stuff outside of `/workspace` is not saved?


---

Comment by @tobiasdiez created at 2021-12-30 18:27:21

Replying to [comment:96 mkoeppe]:
> Replying to [comment:93 gh-tobiasdiez]:
> > What takes most time in the second prebuild phase 
> (you mean the `init` script)

Yes

> > is the compilation of scipy (and of maxima).
> ... also the build of sagelib itself from scratch takes pretty long.

Yes, but that's something you probably cannot optimize/outsource. And I think scipy took longer to compile for me.


---

Comment by @tobiasdiez created at 2021-12-30 18:29:08

Replying to [comment:97 mkoeppe]:
> Replying to [comment:95 gh-tobiasdiez]:
> > Then one could also put sage-local directly in `/home/gitpod/sage-local`.
> 
> Didn't you explain to me that stuff outside of `/workspace` is not saved?

Yes, sorry, I've forgotten about this one :-). Still, the issue of not having sage-local in the IDE remains.


---

Comment by mkoeppe created at 2021-12-30 19:56:46

Replying to [comment:99 gh-tobiasdiez]:
> the issue of not having sage-local in the IDE remains.

There are the symlinks `prefix` and `venv`, which can be used


---

Comment by mkoeppe created at 2021-12-30 19:59:54

Replying to [comment:98 gh-tobiasdiez]:
> Replying to [comment:96 mkoeppe]:
> > ... also the build of sagelib itself from scratch takes pretty long.
> 
> Yes, but that's something you probably cannot optimize/outsource. 

Well, I think this has actually all been implemented already in the Sage GitLab Docker build. I've opened #33099 to bring it to GH Actions and then we can extend it to provide variants using `FROM gitpod/workspace-full`.


---

Comment by git created at 2021-12-30 20:07:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-30 20:10:12

According to `top`, the system seems to be idling a lot during build. I think you can go higher than `make -j8`, perhaps 16?


---

Comment by git created at 2021-12-30 20:37:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-30 20:43:13

Replying to [comment:100 mkoeppe]:
> Replying to [comment:99 gh-tobiasdiez]:
> > the issue of not having sage-local in the IDE remains.
> 
> There are the symlinks `prefix` and `venv`, which can be used

Good point.


---

Comment by @tobiasdiez created at 2021-12-30 20:43:27

Replying to [comment:103 mkoeppe]:
> According to `top`, the system seems to be idling a lot during build. I think you can go higher than `make -j8`, perhaps 16?

Will try.


---

Comment by git created at 2021-12-30 20:44:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 11:35:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 12:14:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 12:23:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 12:31:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 13:27:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 16:18:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-31 17:30:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-01 12:31:51

Replying to [comment:71 mkoeppe]:
> Would https://www.gitpod.io/docs/prebuilds#manual-prebuilds work, or does this also depend on the org-level activation?

I tried this now, but after about 40 mins it displays the following error:

```

<html><head>
            <meta http-equiv="content-type" content="text/html;charset=utf-8">
                                                                              <title>502 Server Error</title>
                                                                                                             </head>
                                                                                                                    <body text=#000000 bgcolor=#ffffff>
                                <h1>Error: Server Error</h1>
                                                            <h2>The server encountered a temporary error and could not complete your request.<p>Please try again in 30 seconds.</h2>
                                                             <h2></h2>
                                                                      </body></html>

```


I'm not sure if that's an issue with gitpod or something going wrong in sage's build script. According to the logs, matplotlib, scipy, fpylll, sagelib and were still compiling when this error is displayed. Do you have a guess where this message is coming from?


---

Comment by git created at 2022-01-01 12:38:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-01 17:56:01

As there seems to be not enough momentum to get #33099 done, another approach would be to reuse the Docker images built already by our portability suite. Pushing the images to `ghcr.io` was just repaired in #30933. I can just add a variant of `ubuntu-focal` that uses `FROM gitpod/workspace-full` and adjusts `SAGE_LOCAL` so it is suitable for gitpod.


---

Comment by git created at 2022-01-01 18:12:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-01 18:13:56

Basically like this (use `tox -e docker-gitpod-standard -- build-local`), except I'd need to put some `sudo` in front of the `apt-get`)


---

Comment by git created at 2022-01-01 18:21:16

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-01-01 18:51:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-01 19:22:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-01 19:25:20

Thanks for thinking along. The problem is more this strange 502 error that I now get during the prebuild. I've now opened https://github.com/gitpod-io/gitpod/issues/7413 to investigate where the error comes from. We also might merging this ticket and activate the github app, because then you should also have access to the prebuild logs (which is not possible for the manual prebuild).

However, the docker build already works and has not much room for improvement (the only non-Python packages that are currently not finished is singular and maxima). For this I would just wait until gitpod increases its time limit. Using github actions to build docker images, that are then reused by gitpod sounds pretty complicated to me. Gitpod also handles caching and invalidating of the images for you (one needs to rebuild the base docker images for branches that change non-Python packages or if the docker file changes). 

What still has room for improvement (but also almost fits into the 1h limit) is the prebuild of the Python packages. For this it would be good to reuse wheels to decrease the build time, or maybe use conda. But maybe we should first try it withput this optimization and also wait for gitpod to increase the time limit.   

May I ask you to push changes to the gitpod docker and yml files to a different branch. Everytime one changes the docker file, one has to sit through 1h. Thanks.


---

Comment by mkoeppe created at 2022-01-01 19:34:40

Sure, I'll work in #33103.


---

Comment by mkoeppe created at 2022-01-01 19:35:09

Feel free to revert the branch on the ticket here to what works for you.


---

Comment by mkoeppe created at 2022-01-01 19:40:29

Replying to [comment:124 gh-tobiasdiez]:
> We also might merging this ticket and activate the github app, because then you should also have access to the prebuild logs (which is not possible for the manual prebuild).

I think you may want to try this first in your personal [GitHub](GitHub) account. Getting this to work shouldn't require to make org-level changes to the `sagemath` organization on [GitHub](GitHub).


---

Comment by mkoeppe created at 2022-01-01 20:13:09

Replying to [comment:124 gh-tobiasdiez]:
> or maybe use conda

Looking at https://github.com/gitpod-io/workspace-images/blob/master/full/Dockerfile, nix seems to be available, so this may be another option


---

Comment by @tobiasdiez created at 2022-01-01 21:18:09

Replying to [comment:126 mkoeppe]:
> Feel free to revert the branch on the ticket here to what works for you.

Could you maybe revert to 3adf51 for me pls? I don't have a dev pc available and used gitpod to make the necessary changes...
I was wondering if one should keep your changes to the symlink (commit ​c7cc5cd). What was the reason for this change?


---

Comment by @tobiasdiez created at 2022-01-01 21:20:49

Replying to [comment:128 mkoeppe]:
> Replying to [comment:124 gh-tobiasdiez]:
> > or maybe use conda
> 
> Looking at https://github.com/gitpod-io/workspace-images/blob/master/full/Dockerfile, nix seems to be available, so this may be another option

Is this usually quicker or are the more system packages available?


---

Comment by git created at 2022-01-01 21:23:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-01-01 21:25:24

Replying to [comment:129 gh-tobiasdiez]:
> Could you maybe revert to 3adf51 for me pls? I don't have a dev pc available and used gitpod to make the necessary changes...
> I was wondering if one should keep your changes to the symlink (commit ​c7cc5cd). 

Done, with that change cherry-picked.

> What was the reason for this change?

Just an easier solution that works without using `sudo`, and integrates better with #33103


---

Comment by mkoeppe created at 2022-01-01 21:26:28

Replying to [comment:130 gh-tobiasdiez]:
> Replying to [comment:128 mkoeppe]:
> > nix seems to be available, so this may be another option
> 
> Is this usually quicker or are the more system packages available?

More packages, because someone made an effort to package all of sage not so long ago. Not sure in what shape it is though


---

Comment by slelievre created at 2022-01-02 09:59:47

The nix package for Sage seems maintained up to date.

- https://github.com/NixOS/nixpkgs/tree/master/pkgs/applications/science/math/sage
- https://github.com/NixOS/nixpkgs/commits/master/pkgs/applications/science/math/sage


---

Comment by @tobiasdiez created at 2022-01-03 16:54:28

Thanks for the pointer. Nix seems promising indeed, but I think it would make sense to first create a workable nix environment (e.g. `shell.nix` file) and test it for 'normal' local building before using for gitpod.

The approach with prefix + symlink was not working for me. Every prebuild that I triggered timed-out without any error message; also when running it from my own fork using the gitpod app integration. I guess something from the gitpod build context slips into the image/prebuild setup. Thus, I've reverted to use of the prebuild of system packages in `home/gitpod/sage-prebuild` and setting env variables so that the prebuild packages are found. That works. Interestingly, this is somewhat similar to how nix works. Current state can be found at https://github.com/tobiasdiez/sagetrac-mirror.

During the docker build it suggests to install the following packages

```
sudo apt-get install  libflint-arb-dev libcdd-dev libcdd-tools ecl libec-dev eclib-tools libflint-dev flintqs libgiac-dev xcas lcalc liblfunction-dev pari-gp2c libpari-dev pari-doc pari-elldata pari-galdata pari-galpol pari-seadata libprimesieve-dev singular libsingular4-dev tox
```

Some are excluded (like pari and flint) but other would make sense to install I guess. Should I try manually adding them, or should the `sage-get-system-packages` command perhaps be changed?

We now have three possible options for the gitpod integration and before we invest more time working on them separately it is probably worthwhile to choose on one of them to proceed further:
- 1) Only use the gitpod infrastructure to build docker images (non-python packages) and prebuilds (python packages). This is the current version of this ticket.
- 2) Use github action to build a docker image containing all sage packages. This is #33103.
- 3) Use version 1, but install non-python packages using nix.


---

Comment by mkoeppe created at 2022-01-03 18:55:28

I would suggest that we go with 2) (#33103) because its maintenance basically comes for free from the portability test infrastructure.


---

Comment by @tobiasdiez created at 2022-01-03 19:32:58

Is fine with me. However, that approach has a few disadvantages as far as I can see:
- The relevant github action might only be triggered after quite some time upon a new (beta) relase as all other github workflows are then also triggered. During this time one would still use the old docker image.
- The docker image is quite big and thus it takes longer to open a new gitpod workspace.
- It is harder to add gitpod-specific customization to the docker image (e.g. installing tools that are only needed in this context).

These are certainly not deal breakers but should be kept in mind.

The first approach has also a few disadvantages:
- Currently less packages are built due to the gitpod timeout of 1h
- Not automatically tested (although this would probably be easy to do)


---

Comment by mkoeppe created at 2022-01-03 19:39:46

Great points. I think we can address the current disadvantages of approach 2 in a follow-up ticket (#33113). In particular, as discussed in #33103#comment:19, could use `docker/.gitpod.Dockerfile` again with COPY --from to make the final image smaller (e.g., currently /home/gitpod/sage has the old source tree)


---

Comment by @tobiasdiez created at 2022-01-03 19:49:20

Replying to [comment:138 mkoeppe]:
> Great points. I think we can address the current disadvantages of approach 2 in a follow-up ticket (#33113). In particular, as discussed in #33103#comment:19, could use `docker/.gitpod.Dockerfile` again with COPY --from to make the final image smaller (e.g., currently /home/gitpod/sage has the old source tree)

But you also need to transfer the installation of the system packages to the final image, so this may be quite complicated. Probably you end up with something quite close to the dockerfile of this ticket. Maybe that's actually the best of the two worlds: essentially use the docker file from this ticket, but instead of the `prebuild` layer just copy the sage-local directory from the github docker image?


---

Comment by mkoeppe created at 2022-01-03 20:33:42

No, it could just use `FROM` with the build stage https://github.com/mkoeppe/sage/pkgs/container/sage%2Fsage-docker-gitpod-standard-configured (or `...-with-system-packages` - which is currently not pushed)
and then `COPY --from` the build stage https://github.com/mkoeppe/sage/pkgs/container/sage%2Fsage-docker-gitpod-standard-with-targets.


---

Comment by mkoeppe created at 2022-01-05 19:32:55

Replying to [comment:140 mkoeppe]:
> No, it could just use `FROM` with the build stage https://github.com/mkoeppe/sage/pkgs/container/sage%2Fsage-docker-gitpod-standard-configured (or `...-with-system-packages` - which is currently not pushed)
> and then `COPY --from` the build stage https://github.com/mkoeppe/sage/pkgs/container/sage%2Fsage-docker-gitpod-standard-with-targets.

Now implemented in #33103#comment:95


---

Comment by @tobiasdiez created at 2022-01-08 19:48:44

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-01-08 19:48:44

Let's close this in favor of #33103.


---

Comment by mkoeppe created at 2022-01-08 21:27:14

Resolution: invalid
