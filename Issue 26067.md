# Issue 26067: doctests in src/sage/repl/attach.py and src/sage/repl/load.py fail when test.py is present in folder from where doctests are run

Issue created by migration from Trac.

Original creator: strogdon

Original creation time: 2018-09-18 03:10:29

First reported at https://groups.google.com/d/msg/sage-release/eL75kEvaCeA/T6_kmPNCCQAJ.

If an empty `test.py` is present in SAGE_ROOT then

```
sage -t --long src/sage/repl/attach.py
**********************************************************************
File "src/sage/repl/attach.py", line 171, in sage.repl.attach.load_attach_path
Failed example:
    attach('test.py')
Expected:
    Traceback (most recent call last):
    ...
    IOError: did not find file 'test.py' to load or attach
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/repl/attach.py", line 176, in sage.repl.attach.load_attach_path
Failed example:
    attach('test.py')
Expected:
    111
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/repl/attach.py", line 178, in sage.repl.attach.load_attach_path
Failed example:
    attached_files() == [fullpath]
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/repl/attach.py", line 183, in sage.repl.attach.load_attach_path
Failed example:
    load('test.py')
Expected:
    Traceback (most recent call last):
    ...
    IOError: did not find file 'test.py' to load or attach
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/repl/attach.py", line 436, in sage.repl.attach.detach
Failed example:
    attach('test.py')
Expected:
    111
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/repl/attach.py", line 438, in sage.repl.attach.detach
Failed example:
    attached_files() == [os.path.normpath(fullpath)]
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/repl/attach.py", line 443, in sage.repl.attach.detach
Failed example:
    attach('test.py')
Expected:
    111
Got:
    <BLANKLINE>
**********************************************************************
2 items had failures:
   3 of  25 in sage.repl.attach.detach
   4 of  20 in sage.repl.attach.load_attach_path
    [127 tests, 7 failures, 2.61 s]
----------------------------------------------------------------------
sage -t --long src/sage/repl/attach.py  # 7 doctests failed
```


and

```
sage -t --long src/sage/repl/load.py
**********************************************************************
File "src/sage/repl/load.py", line 180, in sage.repl.load.load
Failed example:
    attach(fname)
Expected:
    111
Got:
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of  34 in sage.repl.load.load
    [42 tests, 1 failure, 1.90 s]
----------------------------------------------------------------------
sage -t --long src/sage/repl/load.py  # 1 doctest failed
```




---

Comment by strogdon created at 2018-09-18 03:25:03

In addition it would seem that `attach()` and `load_attach_path()` from `src/sage/repl/attach.py` are not working as intended. The following segments of code produce the same result when a `test.py` is present in the folder from where tests are run.

With an empty `test.py` present in SAGE_ROOT


```
sage: load_attach_path()
['.']
sage: t_dir = tmp_dir()
sage: fname = 'test.py'
sage: fullpath = os.path.join(t_dir, fname)
sage: with open(fullpath, 'w') as f:
....:     _ = f.write("print(37 * 3)")
....:     
sage: load_attach_path(t_dir)
sage: attach(fname)
sage:
```


and without the `load_attach_path(t_dir)`

```
sage: load_attach_path()
['.']
sage: t_dir = tmp_dir()
sage: fname = 'test.py'
sage: fullpath = os.path.join(t_dir, fname)
sage: with open(fullpath, 'w') as f:
....:     _ = f.write("print(37 * 3)")
....:     
sage: attach(fname)
sage:
```

At least in the first instance we should get

```
sage: attach(fname)
111
```

which can be confirmed by running the code with `test.py` removed.


---

Comment by embray created at 2018-09-18 17:40:19

The test should probably change directories into the temp directory.


---

Comment by strogdon created at 2018-09-18 17:57:01

Replying to [comment:2 embray]:
> The test should probably change directories into the temp directory.
I just noticed that `load_attach_path()` has two arguments. Perhaps part of the problem is that we should have

```
load_attach_path(t_dir, replace='True')
```

The default is `replace='False'` and the paths are appended.


---

Comment by strogdon created at 2018-09-19 00:19:04

New commits:


---

Comment by strogdon created at 2018-09-19 00:20:49

Changing status from new to needs_review.


---

Comment by strogdon created at 2018-09-19 00:20:49

For testing purposes make sure there is a `test.py` file in SAGE_ROOT. I hope I have retained the original intent of the code.


---

Comment by strogdon created at 2018-09-20 15:06:11

I will make the following revision since `replace=True` was not needed for the doctest to pass.

```diff
--- a/src/sage/repl/attach.py
+++ b/src/sage/repl/attach.py
`@``@` -174,7 +174,7 `@``@` def load_attach_path(path=None, replace=False):
         Traceback (most recent call last):
         ...
         IOError: did not find file 'test.py' to load or attach
-        sage: load_attach_path(t_dir, replace=True)
+        sage: load_attach_path(t_dir)
         sage: attach('test.py')
         111
         sage: attached_files() == [fullpath]
```



---

Comment by git created at 2018-09-20 15:08:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by strogdon created at 2018-10-08 20:06:22

There is one additional failure not listed above in doctesting `src/sage/repl/attach.py` that does not appear with the above branch applied. 

The failure with an empty
`test2.py` present in `SAGE_ROOT`

```
./sage -t --long src/sage/repl/attach.py

**********************************************************************
File "src/sage/repl/attach.py", line 447, in sage.repl.attach.detach
Failed example:
    attach('test2.py')
Expected:
    3
Got:
    <BLANKLINE>
**********************************************************************
```


To properly test have an empty `test.py` and `test2.py` in `SAGE_ROOT` when testing from `SAGE_ROOT`.


---

Comment by strogdon created at 2018-10-08 20:08:35

Changing priority from major to blocker.


---

Comment by strogdon created at 2018-10-08 20:08:35

Technically this is a doctest failure, though only in corner cases. So, perhaps it should be a blocker?


---

Comment by embray created at 2018-10-09 10:45:55

I don't think this is a blocker.  It does not, for example, cause any buildbots to fail.


---

Comment by strogdon created at 2018-10-09 12:54:39

Changing priority from blocker to major.


---

Comment by strogdon created at 2018-10-09 12:54:39

OK, I'll remove that.


---

Comment by embray created at 2019-01-23 12:29:44

I'm not sure the `os.path.join`s are necessary here, but I'll have a look.  I also want to squash the commits, but LGTM otherwise.


---

Comment by embray created at 2019-01-23 13:48:52

Fixed up my own nitpicks and made one additional small fix.
----
New commits:


---

Comment by embray created at 2019-01-23 13:48:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-24 18:18:02

Resolution: fixed
