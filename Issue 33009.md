# Issue 33009: canonical_label returns incorrect partite sets

Issue created by migration from https://trac.sagemath.org/ticket/33246

Original creator: @maxale

Original creation time: 2022-01-30 02:06:58

CC:  dimpase dcoudert

`.canonical_label` on bipartite graph returns a graph with incorrect partite sets. The following code illustrates an example, where the resulting graph `C` has vertices `1` and `9` in the same left partite set and also an edge between them. 

The graph `C` itself seems to be correct, but partition of its vertices into `C.left` and `C.right` is not (they should be `{0,1,2,3,4}` and `{5,6,7,8,9}`).


```
B = BipartiteGraph( [(0, 4), (0, 5), (0, 6), (0, 8), (1, 5), (1, 7), (1, 8), (2, 6), (2, 7), (2, 8), (3, 4), (3, 7), (3, 8), (4, 9), (5, 9), (6, 9), (7, 9)] )
C = B.canonical_label(partition=(B.left,B.right))
print( (1 in C.left) and (9 in C.left) and C.has_edge(1,9) )
```




---

Comment by dcoudert created at 2022-01-31 10:34:55

The `BipartiteGraph` module requires several improvements and bug fix (#1941). This one seems non trivial.


---

Comment by @maxale created at 2022-01-31 14:00:33

As a workaround for *connected* graphs, we can recompute the partite sets from just edges of `canonical_label()` - like:


```
C = BipartiteGraph( B.canonical_label(partition=(B.left,B.right)).edges() )
```


If `B` is not connected, recomputing the partite sets may shuffle them from different connected components inconsistently with the partite set in `B`.


---

Comment by @maxale created at 2022-02-01 18:17:26

Since `canonical_label()` can return a certificate (mapping of the vertices of given graph to the relabeled one), correct partition of vertices can be computed from this certificate. I found the following workaround quite stable:



```
def correct_canonical_label(B):
    C, cert = B.canonical_label(partition=(B.left,B.right),certificate=True)
    C.left = { cert[v] for v in B.left }
    C.right = { cert[v] for v in B.right }
    return C
```



---

Comment by @enjeck created at 2022-03-12 10:37:53

Any devs already working on this ticket? I'd like to attempt to fix it :)


---

Comment by dcoudert created at 2022-03-12 10:42:16

Feel free to give it a try. Any help is more than welcome.


---

Comment by dcoudert created at 2022-03-17 12:59:44

Thanks for the proposal. I have some comments/questions:
- what's the main difference between this method and `GenericGraph.canonical_label` ? I'm asking beacause you have copy/paste multiple parts of the code, and so it's not obvious to see what makes the difference, why it is working correctly this way
- when you call a function with several optional parameters, it's better to name them: `partition=partition`, `certificate=certificate`, etc. This way you avoid errors if a new parameter is added.
- Bipartite graphs are undirected and without loops. So you don't need to check if it is directed or if it has loops
- the import of `DiGraph` is useful only if you use the fact that you can direct all arc from `left` to `right` to indicate a partition. Otherwise, you can remove it, no ?
- `{ cert[v] for v in self.left }` -> `{cert[v] for v in self.left}`
----
New commits:


---

Comment by @enjeck created at 2022-03-17 13:51:03

Replying to [comment:7 dcoudert]:
> Thanks for the proposal. I have some comments/questions:
> - what's the main difference between this method and `GenericGraph.canonical_label` ? I'm asking beacause you have copy/paste multiple parts of the code, and so it's not obvious to see what makes the difference, why it is working correctly this way

I'm trying to implement the [comment:3 workaround suggested by gh-maxale], using the certificate. Indeed, I did just copy from the main canonical_label function. If the user sets certificate to "True", I just call the original function, since it returns a certificate (mapping of the vertices of given graph to the relabeled one) by default. If certificate is not set to "True", I then compute the vertices (this part is just copied from the original). There's probably some more elegant way of implementing this, but I couldn't figure it out. 

> - when you call a function with several optional parameters, it's better to name them: `partition=partition`, `certificate=certificate`, etc. This way you avoid errors if a new parameter is added.

Okay. I can change that

> - Bipartite graphs are undirected and without loops. So you don't need to check if it is directed or if it has loops

Whoops. That's an oversight on my part. Gotcha!
> - the import of `DiGraph` is useful only if you use the fact that you can direct all arc from `left` to `right` to indicate a partition. Otherwise, you can remove it, no ?

Okay. I'll need to test this out and see. 


> - `{ cert[v] for v in self.left }` -> `{cert[v] for v in self.left}`

Noted


---

Comment by git created at 2022-03-20 12:28:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-03-20 12:31:04

`@`dcoudert, I've made changes. What do you think?


---

Comment by dcoudert created at 2022-03-20 13:48:28

you need to
- remove `dig = (self._directed or self.has_loops())`
- use `dig=False` 
- replace `self_directed` with `False`

Also, in the example, write like this (not mandatory but nicer):

```diff
-            sage: B = BipartiteGraph( [(0, 4), (0, 5), (0, 6), (0, 8), (1, 5), (1, 7), (1, 8
-            ....: ), (2, 6), (2, 7), (2, 8), (3, 4), (3, 7), (3, 8), (4, 9), (5, 9), (6, 9),
-            ....:  (7, 9)] )
+            sage: B = BipartiteGraph([(0, 4), (0, 5), (0, 6), (0, 8), (1, 5),
+            ....:                     (1, 7), (1, 8), (2, 6), (2, 7), (2, 8),
+            ....:                     (3, 4), (3, 7), (3, 8), (4, 9), (5, 9),
+            ....:                     (6, 9), (7, 9)])
```


Lats, add (small) examples with `certificate=True`, `edge_labels=True` and a bipartite with multiple edges. This is to ensure that the method is working well.


---

Comment by slelievre created at 2022-03-21 21:15:30

Also, add your full name to the "Authors" field of the ticket
and set it to "needs review".


---

Comment by git created at 2022-03-22 04:54:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-03-22 05:13:50

Changing status from new to needs_review.


---

Comment by dcoudert created at 2022-03-22 12:53:29

It's improving, but I still have few remarks
- remove

```diff
+                print(G._directed)
```

- Why do you need `G_directed` in `HB.add_edge(G_to[u], G_to[v], None, G._directed)` ?
- When `certificate=True`, you must also return the certificate. Currently it's only the graph. Add a docket.
- For the coding style, we prefer `i, u` and `a, b, c`, so with some spaces
- Also, comments should be aligned in 80 columns mode


---

Comment by @enjeck created at 2022-03-22 14:10:02

Whoops! I did intend to remove `G._directed`, reason why I tried to print it out to see what it does. But I somehow forgot to remove it *facepalm*


---

Comment by git created at 2022-03-23 14:00:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-03-24 07:43:26

The patchbot reports errors:

```
sage -t --long --warn-long 65.9 --random-seed=139219076014934287513221791550255114412 src/sage/graphs/bipartite_graph.py
**********************************************************************
File "src/sage/graphs/bipartite_graph.py", line 2286, in sage.graphs.bipartite_graph.BipartiteGraph.?
Failed example:
    C.left
Exception raised:
    Traceback (most recent call last):
      File "/home/sagemath/sage/local/var/lib/sage/venv-python3.10.2/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sagemath/sage/local/var/lib/sage/venv-python3.10.2/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.bipartite_graph.BipartiteGraph.?[6]>", line 1, in <module>
        C.left
    AttributeError: 'tuple' object has no attribute 'left'
**********************************************************************
File "src/sage/graphs/bipartite_graph.py", line 2288, in sage.graphs.bipartite_graph.BipartiteGraph.?
Failed example:
    C.right
Exception raised:
    Traceback (most recent call last):
      File "/home/sagemath/sage/local/var/lib/sage/venv-python3.10.2/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sagemath/sage/local/var/lib/sage/venv-python3.10.2/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.bipartite_graph.BipartiteGraph.?[7]>", line 1, in <module>
        C.right
    AttributeError: 'tuple' object has no attribute 'right'
```

Indeed, when `certificate` is `True`, you output 2 objects, and not only the graph.


---

Comment by @enjeck created at 2022-03-28 09:12:45

dcoudert, concerning your last comment, I believe I already addressed it in my last commit?


---

Comment by dcoudert created at 2022-03-28 09:31:39

yes


---

Comment by dcoudert created at 2022-04-02 15:21:02

There might be a misunderstanding: the issue reported in #comment:19 has not been fixed (see the patchbot).


---

Comment by dcoudert created at 2022-04-02 15:21:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-04-03 06:19:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-03 06:25:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-04-03 12:23:57

In the doctests, can you add `algorithm='sage'` each time you call `B.canonical_label(...)`. This is to prevent getting different results when you have optional package `bliss` installed (which is my case).

The canonical label returned by `bliss` is not the same as the one returned when using algorithm `'sage'`, but both labelings are correct.

You can also remove the doctest `sage: C[1]`. The certificate has already been printed with the line `sage: C`.


---

Comment by git created at 2022-04-03 13:02:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-04-03 13:03:40

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2022-04-03 13:31:51

- I'm on macOS with sage 9.5.beta7 and I get

```
sage -t --warn-long 291.0 --random-seed=75080170672752573414336716079288479852 src/sage/graphs/bipartite_graph.py
**********************************************************************
File "src/sage/graphs/bipartite_graph.py", line 2289, in sage.graphs.bipartite_graph.BipartiteGraph.?
Failed example:
    C
Expected:
    (Bipartite graph on 10 vertices,
     {0: 3, 1: 0, 2: 1, 3: 2, 9: 4, 4: 5, 5: 7, 6: 6, 7: 8, 8: 9})
Got:
    (Bipartite graph on 10 vertices,
     {0: 3, 1: 0, 2: 1, 3: 2, 4: 5, 5: 7, 6: 6, 7: 8, 8: 9, 9: 4})
**********************************************************************
```

 I'm not sure where the problem comes from. 


- Concerning the call

```
            C = GenericGraph.canonical_label(self, partition, certificate, edge_labels, algorithm, return_graph)
```

 May be I'm missing something, but isn't it better to simply do:

```
            C = self.relabel(perm=cert, inplace=False)
```

 This way you avoid repeating computations you have already done.


---

Comment by @enjeck created at 2022-04-03 13:52:23

I'm running the same Sage version, on Ubuntu 20.04.3 and I do get the expected result of ` (Bipartite graph on 10 vertices, {0: 3, 1: 0, 2: 1, 3: 2, 9: 4, 4: 5, 5: 7, 6: 6, 7: 8, 8: 9}) `. I'm also not sure where the inconsistency is coming from.

And yes, using ` C = self.relabel(perm=cert, inplace=False) ` works fine


---

Comment by dcoudert created at 2022-04-03 14:04:55

I suggest the following change with a more robust test of the certificate:

```diff
-            sage: C = B.canonical_label(partition=(B.left,B.right), certificate=True, algorithm='sage')
-            sage: C
-            (Bipartite graph on 10 vertices,
-             {0: 3, 1: 0, 2: 1, 3: 2, 9: 4, 4: 5, 5: 7, 6: 6, 7: 8, 8: 9})
-            sage: C[0].left
-            {0, 1, 2, 3, 4}
-            sage: C[0].right
-            {5, 6, 7, 8, 9}
+            sage: C, cert = B.canonical_label(partition=(B.left,B.right), certificate=True, algorithm='sage')
+            sage: C
+            Bipartite graph on 10 vertices
+            sage: C.left
+            {0, 1, 2, 3, 4}
+            sage: C.right
+            {5, 6, 7, 8, 9}
+            sage: cert == {0: 3, 1: 0, 2: 1, 3: 2, 4: 5, 5: 7, 6: 6, 7: 8, 8: 9, 9: 4}
+            True
```



---

Comment by git created at 2022-04-03 14:45:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-04-03 18:50:30

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2022-04-03 18:50:30

This time I think it's OK. Thanks.


---

Comment by vbraun created at 2022-04-03 23:15:34

Merge failure on top of:

216d60bb1b Trac #33633: fix indentation (E111) in pyx files in graphs, libs, proba

39d402cb75 Trac #33629: add negative for continued fractions

4955762701 Trac #33565: Add CODE_OF_CONDUCT.md to the repo

00bc51075d Trac #33560: pytest: ignore cython files

a02eec36bf Trac #33582: clean up docstring formatting in schemes/elliptic_curves/

31995b748a Trac #33618: docbuild: typo in arguments check leads to confusing error

94a131cc20 Trac #33612: sage.matrix.matrix_space: Rename a test_... function to _test_... (with deprecation)

823194cfff Trac #33605: cbc: Add system package information for gentoo, nix

6eb1f67d62 Trac #33593: fix W391 in groups/ and algebras/

5ec6108788 Trac #33571: Correct wrong paths in the developer's guide

b886d89536 Trac #33628: Fig bug in graphs.RandomToleranceGraph

5ee8a50e85 Trac #33616: Simplify inventory builder

0a7c8f485c Trac #33615: full cleanup of modules/fp_graded/

97533a71f9 Trac #33589: Gitpod: track remote trac branch

b8d5371aae Trac #33576: Modernize coercion for SpecialHyperellipticQuotientRing

55da3e109e Trac #33572: sage -pytest

2f104e6454 Trac #33533: Update nbconvert to 6.4.x, add optional package pyppeteer

7a5714ac65 Trac #33366: BipartiteGraph() fails to create graph from graph6 string

dfd98a710e Trac #31006: Add more typing information to manifold package

360ee4c168 Trac #30540: Add package phitigra: Graph editor that works with Jupyter

3f93cd0a9c Trac #29640: Create an AUTHORS.md file with links

d8f76fb1bd Trac #33624: doctest unnecessarily assumes SAGE_VENV/bin contains `sage` binary

b438a78918 Trac #33608: Building documentation is broken in Sage 9.6.beta6

88e25dd77b Trac #33631: Github workflow: Fix pyright

78bfb6c7ad Updated [SageMath](SageMath) version to 9.6.beta7



merge was not clean: conflicts in src/sage/graphs/bipartite_graph.py


---

Comment by vbraun created at 2022-04-03 23:15:34

Changing status from positive_review to needs_work.


---

Comment by dcoudert created at 2022-04-04 06:34:30

should be a conflict with  #33366. Can you try to fix the merge conflict ?


---

Comment by git created at 2022-04-04 12:20:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-04-04 12:25:06

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2022-04-04 12:30:15

Did you have to fix any merge conflict ?


---

Comment by @enjeck created at 2022-04-04 12:34:39

Yes. A single conflict with my name in the "AUTHORS" list


---

Comment by dcoudert created at 2022-04-04 12:41:17

Thanks.


---

Comment by dcoudert created at 2022-04-04 12:41:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-04-10 13:13:01

Resolution: fixed
