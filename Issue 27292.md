# Issue 27292: py3: tiny fix in env.py

archive/issues_027292.json:
```json
{
    "body": "CC:  @embray @jdemeyer @tscrim @kiwifb\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27529\n\n",
    "created_at": "2019-03-22T07:57:21Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "py3: tiny fix in env.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27292",
    "user": "https://github.com/fchapoton"
}
```
CC:  @embray @jdemeyer @tscrim @kiwifb



Issue created by migration from https://trac.sagemath.org/ticket/27529





---

archive/issue_comments_384339.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-22T07:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384339",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_384340.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-22T07:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384340",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_384341.json:
```json
{
    "body": "green bot, please review",
    "created_at": "2019-03-22T12:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384341",
    "user": "https://github.com/fchapoton"
}
```

green bot, please review



---

archive/issue_comments_384342.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-22T12:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384342",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_384343.json:
```json
{
    "body": "Please use `sys.executable` instead.",
    "created_at": "2019-03-22T12:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384343",
    "user": "https://github.com/jdemeyer"
}
```

Please use `sys.executable` instead.



---

archive/issue_comments_384344.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-22T12:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384344",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_384345.json:
```json
{
    "body": "indeed, better. Thx",
    "created_at": "2019-03-22T12:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384345",
    "user": "https://github.com/fchapoton"
}
```

indeed, better. Thx



---

archive/issue_comments_384346.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-22T12:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384346",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_384347.json:
```json
{
    "body": "there is another one in src/sage/doctest/control.py, let us fix it too",
    "created_at": "2019-03-22T12:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384347",
    "user": "https://github.com/fchapoton"
}
```

there is another one in src/sage/doctest/control.py, let us fix it too



---

archive/issue_comments_384348.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-22T12:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384348",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_384349.json:
```json
{
    "body": "Very good! Positive review if this passes tests on Python 2 and 3.",
    "created_at": "2019-03-22T12:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384349",
    "user": "https://github.com/jdemeyer"
}
```

Very good! Positive review if this passes tests on Python 2 and 3.



---

archive/issue_comments_384350.json:
```json
{
    "body": "hmm. The change in doctest control breaks one doctest in python3:\n\n```\nsage -t --long src/sage/doctest/control.py\n**********************************************************************\nFile \"src/sage/doctest/control.py\", line 630, in sage.doctest.control.DocTestController.test_safe_directory\nFailed example:\n    DC.test_safe_directory(d)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: refusing to run doctests...\nGot:\n    <BLANKLINE>\n```\n\nI am not sure what to do :\n- undo this change ?\n- tag the doctest with # py2 ?",
    "created_at": "2019-03-22T14:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384350",
    "user": "https://github.com/fchapoton"
}
```

hmm. The change in doctest control breaks one doctest in python3:

```
sage -t --long src/sage/doctest/control.py
**********************************************************************
File "src/sage/doctest/control.py", line 630, in sage.doctest.control.DocTestController.test_safe_directory
Failed example:
    DC.test_safe_directory(d)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    <BLANKLINE>
```

I am not sure what to do :
- undo this change ?
- tag the doctest with # py2 ?



---

archive/issue_comments_384351.json:
```json
{
    "body": "That's interesting. It means two things if I am not mistaken.\n* python3 does allow you to run stuff from unsafe directories just like python2\n* the doctest and possibly the functionality never worked with python3. That bit must have always called python2.",
    "created_at": "2019-03-22T18:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384351",
    "user": "https://github.com/kiwifb"
}
```

That's interesting. It means two things if I am not mistaken.
* python3 does allow you to run stuff from unsafe directories just like python2
* the doctest and possibly the functionality never worked with python3. That bit must have always called python2.



---

archive/issue_comments_384352.json:
```json
{
    "body": "1. `doctest` is not tested by `python3-known-passing.txt`, so that doctest failure doesn't have to prevent merging this ticket. The fix makes sense, despite that it breaks a doctest.\n\n2. I posted about this failure on https://groups.google.com/d/msg/sage-devel/_pH7bjQmw5A/IJz_zlMxAwAJ but that thread didn't come to a conclusion.",
    "created_at": "2019-03-22T20:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384352",
    "user": "https://github.com/jdemeyer"
}
```

1. `doctest` is not tested by `python3-known-passing.txt`, so that doctest failure doesn't have to prevent merging this ticket. The fix makes sense, despite that it breaks a doctest.

2. I posted about this failure on https://groups.google.com/d/msg/sage-devel/_pH7bjQmw5A/IJz_zlMxAwAJ but that thread didn't come to a conclusion.



---

archive/issue_comments_384353.json:
```json
{
    "body": "I would prefer not to have any new py3-failing file.",
    "created_at": "2019-03-23T06:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384353",
    "user": "https://github.com/fchapoton"
}
```

I would prefer not to have any new py3-failing file.



---

archive/issue_comments_384354.json:
```json
{
    "body": "ok, let it be. Jeroen, I am setting to positive in your name.",
    "created_at": "2019-03-23T20:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384354",
    "user": "https://github.com/fchapoton"
}
```

ok, let it be. Jeroen, I am setting to positive in your name.



---

archive/issue_comments_384355.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-23T20:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384355",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_384356.json:
```json
{
    "body": "I'm also not too happy with this situation, but at least this edited test reflects better the reality that it's failing on Python 3. Note that this specific test has always been somewhat controversial.",
    "created_at": "2019-03-23T21:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384356",
    "user": "https://github.com/jdemeyer"
}
```

I'm also not too happy with this situation, but at least this edited test reflects better the reality that it's failing on Python 3. Note that this specific test has always been somewhat controversial.



---

archive/issue_comments_384357.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-03-25T11:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384357",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_384358.json:
```json
{
    "body": "Please squash your commits, and maybe reference this ticket # in the commit message.",
    "created_at": "2019-03-25T11:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384358",
    "user": "https://github.com/embray"
}
```

Please squash your commits, and maybe reference this ticket # in the commit message.



---

archive/issue_comments_384359.json:
```json
{
    "body": "See #26457 which discusses the possibility of removing this test altogether, or #25358 (which would conflict with this) for an alternative middle-ground.\n\nI would rather we go ahead and do one of these than make fixes to a test that's dubious in the first place.",
    "created_at": "2019-03-25T11:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384359",
    "user": "https://github.com/embray"
}
```

See #26457 which discusses the possibility of removing this test altogether, or #25358 (which would conflict with this) for an alternative middle-ground.

I would rather we go ahead and do one of these than make fixes to a test that's dubious in the first place.



---

archive/issue_events_025336.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-03-25T19:43:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27292#event-25336"
}
```



---

archive/issue_comments_384360.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-25T19:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384360",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_384361.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2019-03-25T19:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384361",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_384362.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2019-03-25T19:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384362",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_025337.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-03-25T19:45:42Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27292#event-25337"
}
```



---

archive/issue_comments_384363.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-03-26T11:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384363",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_384364.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-03-29T20:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384364",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_384365.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-29T20:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384365",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_384366.json:
```json
{
    "body": "Why don't we split this (already tiny fix) into pieces? The change in `env.py` should be safe, right? The more controversial doctest can be dealt with elsewhere.",
    "created_at": "2019-05-29T02:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384366",
    "user": "https://github.com/jhpalmieri"
}
```

Why don't we split this (already tiny fix) into pieces? The change in `env.py` should be safe, right? The more controversial doctest can be dealt with elsewhere.



---

archive/issue_comments_384367.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> Why don't we split this (already tiny fix) into pieces? The change in `env.py` should be safe, right? The more controversial doctest can be dealt with elsewhere.\n\nWorks for me.",
    "created_at": "2019-05-29T02:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384367",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:22 jhpalmieri]:
> Why don't we split this (already tiny fix) into pieces? The change in `env.py` should be safe, right? The more controversial doctest can be dealt with elsewhere.

Works for me.



---

archive/issue_comments_384368.json:
```json
{
    "body": "And just to make sure I understand correctly: there are two issues with the tests\n\n```\n    Check that Sage refuses to run doctests from a directory whose\n    permissions are too loose.  We create a world-writable directory\n    inside a safe temporary directory to test this::\n\n        sage: d = os.path.join(tmp_dir(), \"test\")\n        sage: os.mkdir(d)\n        sage: os.chmod(d, 0o777)\n        sage: (out, err, ret) = test_executable([\"sage\", \"-t\", \"nonexisting.py\"], cwd=d)\n        sage: print(err)\n        ...\n        RuntimeError: refusing to run doctests...\n        sage: (out, err, ret) = test_executable([\"sage\", \"-tp\", \"1\", \"nonexisting.py\"], cwd=d)\n        sage: print(err)\n        ...\n        RuntimeError: refusing to run doctests...\n```\n\nright? First, they don't work at all with Python 3 because of `subprocess.call(['python', ...`, and second, they don't work with an unpatched Python. We can fix the second of these by tagging the doctests `# build`. We could fix the first in a less than ideal way by tagging the doctests `# py2`.",
    "created_at": "2019-05-29T02:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384368",
    "user": "https://github.com/jhpalmieri"
}
```

And just to make sure I understand correctly: there are two issues with the tests

```
    Check that Sage refuses to run doctests from a directory whose
    permissions are too loose.  We create a world-writable directory
    inside a safe temporary directory to test this::

        sage: d = os.path.join(tmp_dir(), "test")
        sage: os.mkdir(d)
        sage: os.chmod(d, 0o777)
        sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
        sage: print(err)
        ...
        RuntimeError: refusing to run doctests...
        sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
        sage: print(err)
        ...
        RuntimeError: refusing to run doctests...
```

right? First, they don't work at all with Python 3 because of `subprocess.call(['python', ...`, and second, they don't work with an unpatched Python. We can fix the second of these by tagging the doctests `# build`. We could fix the first in a less than ideal way by tagging the doctests `# py2`.



---

archive/issue_comments_384369.json:
```json
{
    "body": "They would \"work\" if python was python3 which can kind of happen in sage-on-distro. But yes they are the kind of tests the `# build` tag is suitable for. More so than `# py2`.",
    "created_at": "2019-05-29T04:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384369",
    "user": "https://github.com/kiwifb"
}
```

They would "work" if python was python3 which can kind of happen in sage-on-distro. But yes they are the kind of tests the `# build` tag is suitable for. More so than `# py2`.



---

archive/issue_comments_384370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-30T15:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384370",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_384371.json:
```json
{
    "body": "Here is a branch with only the changes in env.py. Positive ?",
    "created_at": "2019-05-30T15:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384371",
    "user": "https://github.com/fchapoton"
}
```

Here is a branch with only the changes in env.py. Positive ?



---

archive/issue_comments_384372.json:
```json
{
    "body": "I think so. Jeroen already reviewed positively before, and I can confirm that the change fixes the py3 problem with `env.py`.",
    "created_at": "2019-05-30T20:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384372",
    "user": "https://github.com/jhpalmieri"
}
```

I think so. Jeroen already reviewed positively before, and I can confirm that the change fixes the py3 problem with `env.py`.



---

archive/issue_comments_384373.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-30T20:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384373",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_384374.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-02T22:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27292#issuecomment-384374",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_025338.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-06-02T22:04:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27292",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27292#event-25338"
}
```
