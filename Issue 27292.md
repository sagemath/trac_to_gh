# Issue 27292: py3: tiny fix in env.py

Issue created by migration from https://trac.sagemath.org/ticket/27529

Original creator: chapoton

Original creation time: 2019-03-22 07:57:21

CC:  embray jdemeyer tscrim fbissey




---

Comment by chapoton created at 2019-03-22 07:57:48

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-03-22 07:57:48

New commits:


---

Comment by chapoton created at 2019-03-22 12:28:07

green bot, please review


---

Comment by jdemeyer created at 2019-03-22 12:29:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2019-03-22 12:29:53

Please use `sys.executable` instead.


---

Comment by git created at 2019-03-22 12:37:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-03-22 12:37:48

indeed, better. Thx


---

Comment by chapoton created at 2019-03-22 12:37:48

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-03-22 12:38:46

there is another one in src/sage/doctest/control.py, let us fix it too


---

Comment by git created at 2019-03-22 12:41:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-03-22 12:49:36

Very good! Positive review if this passes tests on Python 2 and 3.


---

Comment by chapoton created at 2019-03-22 14:08:47

hmm. The change in doctest control breaks one doctest in python3:

```
sage -t --long src/sage/doctest/control.py
**********************************************************************
File "src/sage/doctest/control.py", line 630, in sage.doctest.control.DocTestController.test_safe_directory
Failed example:
    DC.test_safe_directory(d)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    <BLANKLINE>
```

I am not sure what to do :
- undo this change ?
- tag the doctest with # py2 ?


---

Comment by fbissey created at 2019-03-22 18:53:43

That's interesting. It means two things if I am not mistaken.
* python3 does allow you to run stuff from unsafe directories just like python2
* the doctest and possibly the functionality never worked with python3. That bit must have always called python2.


---

Comment by jdemeyer created at 2019-03-22 20:16:54

1. `doctest` is not tested by `python3-known-passing.txt`, so that doctest failure doesn't have to prevent merging this ticket. The fix makes sense, despite that it breaks a doctest.

2. I posted about this failure on https://groups.google.com/d/msg/sage-devel/_pH7bjQmw5A/IJz_zlMxAwAJ but that thread didn't come to a conclusion.


---

Comment by chapoton created at 2019-03-23 06:47:56

I would prefer not to have any new py3-failing file.


---

Comment by chapoton created at 2019-03-23 20:45:58

ok, let it be. Jeroen, I am setting to positive in your name.


---

Comment by chapoton created at 2019-03-23 20:45:58

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2019-03-23 21:47:28

I'm also not too happy with this situation, but at least this edited test reflects better the reality that it's failing on Python 3. Note that this specific test has always been somewhat controversial.


---

Comment by embray created at 2019-03-25 11:06:21

Changing status from positive_review to needs_work.


---

Comment by embray created at 2019-03-25 11:06:21

Please squash your commits, and maybe reference this ticket # in the commit message.


---

Comment by embray created at 2019-03-25 11:11:34

See #26457 which discusses the possibility of removing this test altogether, or #25358 (which would conflict with this) for an alternative middle-ground.

I would rather we go ahead and do one of these than make fixes to a test that's dubious in the first place.


---

Comment by vbraun created at 2019-03-25 19:43:14

Resolution: fixed


---

Comment by vbraun created at 2019-03-25 19:45:42

Resolution changed from fixed to 


---

Comment by vbraun created at 2019-03-25 19:45:42

Changing status from closed to new.


---

Comment by embray created at 2019-03-26 11:58:12

Changing status from new to needs_info.


---

Comment by chapoton created at 2019-03-29 20:25:00

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2019-03-29 20:25:30

New commits:


---

Comment by jhpalmieri created at 2019-05-29 02:38:49

Why don't we split this (already tiny fix) into pieces? The change in `env.py` should be safe, right? The more controversial doctest can be dealt with elsewhere.


---

Comment by fbissey created at 2019-05-29 02:42:43

Replying to [comment:22 jhpalmieri]:
> Why don't we split this (already tiny fix) into pieces? The change in `env.py` should be safe, right? The more controversial doctest can be dealt with elsewhere.

Works for me.


---

Comment by jhpalmieri created at 2019-05-29 02:51:27

And just to make sure I understand correctly: there are two issues with the tests

```
    Check that Sage refuses to run doctests from a directory whose
    permissions are too loose.  We create a world-writable directory
    inside a safe temporary directory to test this::

        sage: d = os.path.join(tmp_dir(), "test")
        sage: os.mkdir(d)
        sage: os.chmod(d, 0o777)
        sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
        sage: print(err)
        ...
        RuntimeError: refusing to run doctests...
        sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
        sage: print(err)
        ...
        RuntimeError: refusing to run doctests...
```

right? First, they don't work at all with Python 3 because of `subprocess.call(['python', ...`, and second, they don't work with an unpatched Python. We can fix the second of these by tagging the doctests `# build`. We could fix the first in a less than ideal way by tagging the doctests `# py2`.


---

Comment by fbissey created at 2019-05-29 04:39:25

They would "work" if python was python3 which can kind of happen in sage-on-distro. But yes they are the kind of tests the `# build` tag is suitable for. More so than `# py2`.


---

Comment by git created at 2019-05-30 15:46:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-05-30 15:48:53

Here is a branch with only the changes in env.py. Positive ?


---

Comment by jhpalmieri created at 2019-05-30 20:25:31

I think so. Jeroen already reviewed positively before, and I can confirm that the change fixes the py3 problem with `env.py`.


---

Comment by jhpalmieri created at 2019-05-30 20:25:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-06-02 22:04:33

Resolution: fixed
