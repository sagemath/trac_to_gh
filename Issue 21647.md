# Issue 21647: giacpy_sage has a doctest failure

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2016-11-17 08:31:57

CC:  parisse frederichan jpflori

Related to #21860 : one failure in ptestlong :


```
charpent`@`asus16-ec:/usr/local/sage-7$ sage -t --long --warn-long 100.3 src/sage/rings/polynomial/multi_polynomial_ideal.py
Running doctests with ID 2016-11-17-09-17-43-cce569e2.
Git branch: t/21860/giacblas
Using --optional=database_gap,giac,giacpy_sage,mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 100.3 src/sage/rings/polynomial/multi_polynomial_ideal.py
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ideal.py", line 3533, in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.groebner_basis
Failed example:
    ideal(J.transformed_basis()).change_ring(P).interreduced_basis()  # optional - giacpy_sage
Expected:
    [a - 60*c^3 + 158/7*c^2 + 8/7*c - 1, b + 30*c^3 - 79/7*c^2 + 3/7*c, c^4 - 10/21*c^3 + 1/84*c^2 + 1/84*c]
Got:
    [7*a - 420*c^3 + 158*c^2 + 8*c - 7, 7*b + 210*c^3 - 79*c^2 + 3*c, 84*c^4 - 40*c^3 + c^2 + c]
**********************************************************************
1 item had failures:
   1 of  67 in sage.rings.polynomial.multi_polynomial_ideal.NCPolynomialIdeal.groebner_basis
    [723 tests, 1 failure, 9.10 s]
----------------------------------------------------------------------
sage -t --long --warn-long 100.3 src/sage/rings/polynomial/multi_polynomial_ideal.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 9.2 seconds
    cpu time: 15.5 seconds
    cumulative wall time: 9.1 seconds
```



---

Comment by frederichan created at 2016-11-17 17:31:01

I don't think that it is related to #21860 (giac update), but it is related to the singular upgrade:

with sage 7.5beta2 (singular4)

```
sage: P.<a,b,c> = PolynomialRing(QQ,3, order='lex') 
sage: toto=ideal([7*a - 420*c^3 + 158*c^2 + 8*c - 7, 7*b + 210*c^3 - 79*c^2 + 3*c, 84*c^4 - 40*c^3 + c^2 + c])
....: 
sage: toto.interreduced_basis()
[7*a - 420*c^3 + 158*c^2 + 8*c - 7, 7*b + 210*c^3 - 79*c^2 + 3*c, 84*c^4 - 40*c^3 + c^2 + c]
sage: 
```

but with older versions with singular3 it gives

```
[a - 60*c^3 + 158/7*c^2 + 8/7*c - 1, b + 30*c^3 - 79/7*c^2 + 3/7*c, c^4 - 10/21*c^3 + 1/84*c^2 + 1/84*c]
```



---

Comment by frederichan created at 2016-11-17 18:23:39

In fact the doctest was not using the result computed by giac but was recomputing everything with singular so I have changed this.

I have not yet changed the output doc string because it seems not coherent with the documentation of
interreduced_basis:


```
   If this ideal is spanned by (f_1, ..., f_n) this method returns
   (g_1, ..., g_s) such that:

   * (f_1,...,f_n) = (g_1,...,g_s)

   * LT(g_i) != LT(g_j) for all i != j

   * LT(g_i) does not divide m for all monomials m of

        {g_1,...,g_{i-1},g_{i+1},...,g_s}

   * LC(g_i) == 1 for all i if the coefficient ring is a field.

```

but


```
sage: P.<a,b,c> = PolynomialRing(QQ,3, order='lex')
sage: toto=ideal([7*a - 420*c^3 + 158*c^2 + 8*c - 7, 7*b + 210*c^3 - 79*c^2 + 3*c, 84*c^4 - 40*c^3 + c^2 + c])
....: 
sage: g=toto.interreduced_basis()
sage: g[0].lc()
7
sage: toto.base_ring()
Rational Field
```


----
Last 10 new commits:


---

Comment by jdemeyer created at 2016-11-19 08:46:39

15 commits to change just one line of code? Please squash this to one commit :-)


---

Comment by jdemeyer created at 2016-11-19 08:49:35

Changing component from packages: optional to doctest coverage.


---

Comment by jdemeyer created at 2016-11-19 08:49:35

And change the title to something which refers to Singular.


---

Comment by frederichan created at 2016-11-19 11:19:36

sorry for the messy branch, here is a new one
----
New commits:


---

Comment by dimpase created at 2016-11-19 18:28:19

how about changing the doc of `interreduced_basis` where it says that LCs will be 1 if working over a field, i.e.

```
* LC(g_i) == 1 for all i if the coefficient ring is a field.
```

is no longer true.


---

Comment by frederichan created at 2016-11-20 10:05:54

Before doing just that, my question is also about how QQ was detected in the old code and does the new condition detect any ring, because if I grep the old test I already have:


```
macbookito(fred)$ grep -r "ringtype == 0" src/sage
src/sage/rings/polynomial/multi_polynomial_libsingular.pyx:            if r.ringtype == 0 or r.cf.nDivBy(p_GetCoeff(f._poly, r), p_GetCoeff(g._poly, r)):
src/sage/rings/polynomial/multi_polynomial_ideal_libsingular.pyx:    if r.ringtype == 0:
src/sage/rings/polynomial/plural.pyx:            if r.ringtype == 0 or r.cf.nDivBy(p_GetCoeff(f._poly, r), p_GetCoeff(g._poly, r)):
src/sage/libs/singular/singular.pyx:        if _ring.ringtype == 0:
src/sage/libs/singular/singular.pyx:        if _ring.ringtype == 0:
macbookito(fred)$ grep -r "ringtype != 0" src/sage
src/sage/rings/polynomial/multi_polynomial_libsingular.pyx:        if r.ringtype != 0:
src/sage/rings/polynomial/multi_polynomial_libsingular.pyx:        if _ring.ringtype != 0:
src/sage/rings/polynomial/multi_polynomial_libsingular.pyx:        if _ring.ringtype != 0:
src/sage/libs/singular/ring.pyx:    if ringtype != 0:
```



---

Comment by frederichan created at 2016-11-23 11:38:05

So if I am right it seems that the old test ringtype != 0 was used as a trick to detect if the  ring of coefficient was not a field, and seems equivalent to 

   cf.type ==  one of n_Z, n_Zm, n_Zmn, n_Z2n

in src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
in the gcd and lcm a test has been added so the code is equivalent to the old one.
            if r.cf.type == n_Znm or r.cf.type == n_Zn or r.cf.type == n_Z2m :
                raise NotImplementedError("Division of multivariate polynomials over non fields by n

in interreduced the normalisation of the head coefficient may be never executed and is not equivalent to the old code. So I suggest 2 modification.
either:
   1)  change the doc a dima suggest to do the same as singular and delete the normalisation code
or
   2)  replace the cf.type == n_unknown by  
            if r.cf.type != n_Znm and r.cf.type != n_Zn and r.cf.type != n_Z2m 
       and keep the doc as is

for plural.pyx it should be OK because of the or

But in src/sage/libs/singular/singular.pyx the 2 substitutions gives  strange code:

```

    elif isinstance(base, IntegerModRing_generic):
        if _ring.cf.type == n_unknown:
            return base(_ring.cf.cfInt(n, _ring.cf))
        return si2sa_ZZmod(n, _ring, base)

```


```
    elif isinstance(elem._parent, IntegerModRing_generic):
        if _ring.cf.type == n_unknown:
            return n_Init(int(elem),_ring)
        return sa2si_ZZmod(elem, _ring)

}}} 
for instance n_Zp had ringtype == 0


---

Comment by git created at 2016-11-24 11:49:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2016-11-24 11:54:19

NB: I chose solution 2 because the reduced command of  multi_polynomial_sequence.py also talk of normalized polynomials and use the libgiac interred:

```
        if isinstance(R,MPolynomialRing_libsingular):
            return PolynomialSequence(R, interred_libsingular(self), immutable=True)
```



---

Comment by frederichan created at 2016-11-24 12:03:23

NB: I am not confortable enough with sage and singular to modify the == n_unkown in:
src/sage/libs/singular/singular.pyx

Does anyone plan to change it or can I switch to need review?


---

Comment by frederichan created at 2016-11-25 12:34:49

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-03-10 21:54:26

Changing priority from major to blocker.


---

Comment by git created at 2017-03-11 09:25:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-03-11 09:26:19

Rebased to 7.6.beta6


---

Comment by tmonteil created at 2017-03-17 14:22:53

Is it good to go ?


---

Comment by frederichan created at 2017-03-17 14:49:25

I have not run the test suite for while but we should try if other doctests have been added in between


---

Comment by charpent created at 2017-03-18 11:00:17

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2017-03-18 11:00:17

In 7.6.rc1 + #20523 + #21884 (present ticket) :
* `giacpy_sage` passes its own test suite (237 tests pased, 0 failed, 5 items with no test)
* Sage pass `ptestlong` with one failure :

```
----------------------------------------------------------------------
sage -t --long src/sage/homology/simplicial_complex.py  # 1 doctest failed
----------------------------------------------------------------------
```

which is transient (i. e. pass without failure when ran standalone).

==> `positive review`.


---

Comment by charpent created at 2017-03-18 11:03:02

Forgot to sign the review...


---

Comment by charpent created at 2017-03-18 11:10:08

Note : I do not understand the patchbot failure. Someone with a better understanding of the patchbot system should investigate the issue...


---

Comment by vbraun created at 2017-03-19 16:25:40

Resolution: fixed
