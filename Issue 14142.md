# Issue 14142: The pari spkg is patching upstream too heavily

Issue created by migration from https://trac.sagemath.org/ticket/14346

Original creator: Snark

Original creation time: 2013-03-23 09:19:17

Assignee: tbd

CC:  jdemeyer

The pari package is full of patches, some of which should have been proposed upstream, some of which break the ABI.

According to the discussion with the debian packager of pari (which is also upstream):
http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=703116
the correct solution would be for sage to *add* what is needed to the sage library instead of patching upstream.


---

Comment by leif created at 2013-03-23 10:53:10

Does this apply to the PARI library, or `gp`?

(Of course `gp` uses the PARI library, but _I think<sup>TM</sup>_ the stand-alone `gp` wouldn't need patching for Sage.)


---

Comment by Snark created at 2013-03-23 16:46:04

Both the library and the executable come out of the same spkg anyway so I don't see how the distinction matters...


---

Comment by fbissey created at 2013-03-23 22:32:04

Have to second that discusion on debian. I have actually pushed almost every single sage patch to pari in sage-on-gentoo. I think it is ok when they are patches included upstream. I hadn't looked at the particulars of polred. Which yes alter the ABI somewhat. Was the change necessary and will it be picked up upstream?


---

Comment by Snark created at 2013-03-24 08:25:06

If you read B.A.'s comment on my debian bug report, I think it's 100% sure they won't take it in the stable branch, as it breaks ABI. Now for another branch, the question is open -- but since this polred.patch is based on upstream commits, they might have better up their sleeve already!


---

Comment by jpflori created at 2013-03-26 14:02:38

IIRC PARI 2.6 release sould happen quite soon, so hopefully the commits we used are from this devel branch, see http://pari.math.u-bordeaux1.fr/timeline.html


---

Comment by Snark created at 2013-03-26 17:17:15

The commits used were from upstream, but the patch is *based* on those commits -- it's not just them. That means that the pari in sage is neither compatible with upstream's 2.5.3, nor with the upcoming 2.6.0.

So yes, we can hope that when sage will package pari 2.6.0, then it will stop forking pari and become compatible with something debian can package seriously.


---

Comment by jdemeyer created at 2013-04-10 10:59:49

Replying to [comment:6 Snark]:
> The commits used were from upstream, but the patch is *based* on those commits -- it's not just them. That means that the pari in sage is neither compatible with upstream's 2.5.3, nor with the upcoming 2.6.0.
I thought backporting patches from later upstream versions is standard practice.


---

Comment by jdemeyer created at 2013-04-10 11:02:36

Changing type from defect to enhancement.


---

Comment by jdemeyer created at 2013-04-10 11:02:36

Replying to [ticket:14346 Snark]:
> The pari package is full of patches
So what? Since when is patching a package a bug?

> some of which should have been proposed upstream
Which patches are you refering to?

> the correct solution would be for sage to *add* what is needed to the sage library instead of patching upstream.
Please elaborate how we should add PARI patches to the Sage library.


---

Comment by fbissey created at 2013-04-10 11:13:06

Replying to [comment:8 jdemeyer]:
> Replying to [comment:6 Snark]:
> > The commits used were from upstream, but the patch is *based* on those commits -- it's not just them. That means that the pari in sage is neither compatible with upstream's 2.5.3, nor with the upcoming 2.6.0.
> I thought backporting patches from later upstream versions is standard practice.

I'll have a shot at that one but it's probably nothing new to you. It depends on the trade off. Backporting in a distro like debian that is keeping fixed version of the software has much as possible is good.... so long as you preserve API. If the patch breaks API that means potentially all dependencies will need patching for the new API. So the trade off is between the number of dependencies you have to patch for the new API and how badly you want/need the backport. 

It applies also to sage but the scale is a priori less than in a full distro. In the case of pari in particular, I don't think the list of dependencies (especially dependencies not in sage) affected by your change is very long (make that non existant until proven otherwise).

Debian may have enshrined the above discussion in a precise policy but I am not a deban-er.


---

Comment by Snark created at 2013-04-10 11:14:00

Backporting is standard practice, to gain a bugfix or a new feature which is only available in a later version.

The current situation is different : some modifications are backports, and some are new code.

The backported patches have their places in the pari spkg, but the new code should be in the sage library.


---

Comment by jdemeyer created at 2013-04-10 11:20:07

Replying to [comment:10 fbissey]:
> If the patch breaks API
In which sense does the polred patch "break API" (I probably don't understand what you mean exactly with "breaks API")


---

Comment by jdemeyer created at 2013-04-10 11:20:49

Replying to [comment:11 Snark]:
> the new code should be in the sage library.
Which code are you refering too?

Details please, this is all so vague...


---

Comment by Snark created at 2013-04-10 14:55:24

Ok, let's be explicit:
 1. in general there are fifteen patches in this spkg, which is way too much ;
 2. in particular polred.patch is a mix between a backport and a new development.

I claim putting new developments in a package is against standard packaging practice.

And I use the verb "break" because that's what will happen when sage will want to include the next pari version...


---

Comment by jdemeyer created at 2013-04-10 15:22:35

Replying to [comment:14 Snark]:
> Ok, let's be explicit:
That's not explicit at all, that's essentially just repeating what you already said. To make it easier for you, I changed the description and let you fill in the blanks.


---

Comment by fbissey created at 2013-04-10 21:54:38

So I did a bit more digging because it is a case of show me the code, I will say that after looking at it carefully I have reached a pragmatic view on this and I don't actually mind the change in question. If Julien is worried about some other code he can put it on display. So in the polred patch

```
diff -ruN src/src/headers/paridecl.h b/src/headers/paridecl.h
--- src/src/headers/paridecl.h	2012-09-25 23:10:47.000000000 +0200
+++ b/src/headers/paridecl.h	2013-01-31 14:49:05.557525771 +0100
@@ -889,6 +889,7 @@
 GEN     polredabs0(GEN x, long flag);
 GEN     polredabs2(GEN x);
 GEN     polredabsall(GEN x, long flun);
+GEN     polredbest(GEN x, long flag);
 GEN     smallpolred(GEN x);
 GEN     smallpolred2(GEN x);
 GEN     tschirnhaus(GEN x);
```

That's technically a change in API you are exposing more functions than in the original. That kind of change is unlikely to break anything. All the rest of the code apart from the new function is private and shouldn't be called directly, so _it_ doesn't matter.
A more disturbing change would have been changing the way a public function is called. If someone has been using a private function in their code and it breaks, honestly they get what they deserve.

I haven't looked upstream, Julien may be worried that this extra function is not upstream or will be upstream under another name or call structure. It is the only thing that I can think could be extracted and put separately inside the sage library. And it technically could be done. BUT I haven't digged the code deep to see if it was possible without calling private functions from pari. I think I said something before about calling private functions... 

There used to be some very invasive change in pari 2.3.xx where the sage spkg added some error handling mechanism. I cannot see it anymore. In fact looking at the patchset more closely than I did for some time, it is much cleaner than it used to be.


---

Comment by jdemeyer created at 2013-04-11 06:33:37

Replying to [comment:17 fbissey]:
> That's technically a change in API you are exposing more functions than in the original.
As I tried to tell you several times, this patch is a backport from upstream PARI-2.6, the added function comes from PARI-2.6.

> In fact looking at the patchset more closely than I did for some time, it is much cleaner than it used to be.
So we can close this ticket as invalid ;-)


---

Comment by fbissey created at 2013-04-11 07:15:11

I played weather van a bit on that one. I would like to see if Julien has anything more to say. If he doesn't I'll happilly review it as invalid for you


---

Comment by jdemeyer created at 2013-04-11 10:30:44

Replying to [comment:11 Snark]:
> Backporting is standard practice, to gain a bugfix or a new feature which is only available in a later version.
By this criterion, moving `polred.patch` to GOOD.


---

Comment by jpflori created at 2013-04-11 10:32:53

FYI, the cygwin_dll_a.patch is upstream, see http://trac.sagemath.org/sage_trac/ticket/13333, corresponding upstream commits are mentioned there.


---

Comment by jdemeyer created at 2013-04-11 10:50:24

Honest question: why is "patch submitted upstream but upstream ignored it" so much better than "patch not submitted upstream"? Because the end result is the same.


---

Comment by fbissey created at 2013-04-11 11:05:40

Scanning the gcc bugzilla entry associated with  GCC_PR49330.patch it seems like gcc dev think people are just doing stuff they shouldn't with pointer arythmetics. i.e. the source code should be fixed - not that i completely understand the discussion mind you. And I learned in that entry that you can pessimize!


---

Comment by jpflori created at 2013-04-11 12:46:49

Replying to [comment:17 fbissey]:
> So I did a bit more digging because it is a case of show me the code, I will say that after looking at it carefully I have reached a pragmatic view on this and I don't actually mind the change in question. If Julien is worried about some other code he can put it on display. So in the polred patch
> {{{
> diff -ruN src/src/headers/paridecl.h b/src/headers/paridecl.h
> --- src/src/headers/paridecl.h	2012-09-25 23:10:47.000000000 +0200
> +++ b/src/headers/paridecl.h	2013-01-31 14:49:05.557525771 +0100
> `@``@` -889,6 +889,7 `@``@`
>  GEN     polredabs0(GEN x, long flag);
>  GEN     polredabs2(GEN x);
>  GEN     polredabsall(GEN x, long flun);
> +GEN     polredbest(GEN x, long flag);
>  GEN     smallpolred(GEN x);
>  GEN     smallpolred2(GEN x);
>  GEN     tschirnhaus(GEN x);
> }}}
> That's technically a change in API you are exposing more functions than in the original. That kind of change is unlikely to break anything. All the rest of the code apart from the new function is private and shouldn't be called directly, so _it_ doesn't matter.
> A more disturbing change would have been changing the way a public function is called. If someone has been using a private function in their code and it breaks, honestly they get what they deserve.
> 
> I haven't looked upstream, Julien may be worried that this extra function is not upstream or will be upstream under another name or call structure. 
I just checked and in PARI's git at least, it's just the same:
* http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=blob;f=src/headers/paridecl.h;h=01e6378eac8e329e9da34ee414f2b2f19f1770f8;hb=HEAD#l1263
but I cannot tell you what will be in PARI 2.6.
>It is the only thing that I can think could be extracted and put separately inside the sage library. And it technically could be done. BUT I haven't digged the code deep to see if it was possible without calling private functions from pari. I think I said something before about calling private functions... 
> 
> There used to be some very invasive change in pari 2.3.xx where the sage spkg added some error handling mechanism. I cannot see it anymore. In fact looking at the patchset more closely than I did for some time, it is much cleaner than it used to be.


---

Comment by Snark created at 2013-04-11 14:14:43

I checked too, and indeed polredbest looks like it's upstream, so I confirm that I was wrong and that polred.patch isn't that bad.

Let me notice that patches without a properly identified author could probably go in the "Needs documentation" list.


---

Comment by jdemeyer created at 2013-05-06 15:49:54

In #14539, I updated the patches README. Please verify that all needed documentation has been added.

I remove the mention of `galoisanalysis_p4.patch` since that patch is upstream in PARI-2.5.4 and therefore not needed anymore.


---

Comment by Snark created at 2013-05-10 21:34:52

The documentation is much better, but it looks like sage-the-distribution is going to ship with a 'polredbest' function which will not be in pari 2.5.4 ; it will hence not be compatible with what other distributions will ship. Can't this function's code go into *sage*'s codebase instead?


---

Comment by jdemeyer created at 2013-05-11 09:08:54

Replying to [comment:36 Snark]:
> Can't this function's code go into *sage*'s codebase instead?
Why should it go into Sage's codebase? Sage is probably always going to need PARI + extra patches, not just vanilla PARI. So what's the point of moving this one patch into Sage?


---

Comment by jpflori created at 2013-05-11 10:05:45

I guess the point is to ease integration of Sage into Debian (or other distributions).
It may be against Debian rules to change the ABI, I don't really know.


---

Comment by jdemeyer created at 2013-05-11 10:25:56

Well, I don't agree that we should add extra complications to Sage to please distributions. And moving pieces of PARI into the Sage library sounds like a non-trivial thing to do.


---

Comment by jpflori created at 2013-05-11 10:28:59

Yup, I agree with that, I was just trying to get Julien's point.

Anyway, for Debian, I guess he'll just have to wait for PARI 2.6 which is supposedly not that far away (unless things changed since the workshop).


---

Comment by fbissey created at 2013-05-11 10:35:04

I don't think this particular code should go in sage. As Jeroen said it wouldn't be trivial. It looks to like pari internal functions are called. If you could implement it only with public functions it would be fine to just stick it in sage - and that would be the way to go in my opinion. But I don't see that as being the case with polredbest.

Gentoo policy on that case is it's ok if upstream intends to include the code which is the case here I believe. But really I have more freedom than Julien here.


---

Comment by Snark created at 2013-05-11 14:41:43

It is again a problem of confusion between sage-the-distribution and sage-the-software ; the current sage-the-software won't work with pari 2.5.4, because it depends on polredbest (at least).

This is a problem for debian ; see the discussion about my
[debian bug report](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=703116).

I'm not sure pari 2.6 will be a solution real soon: I just tried to make a pari 2.6 spkg from an upstream snapshot (taking the current spkg and removing the patches) :
1. it compiled ok ;
2. eclib compiled ;
3. genus2reduction didn't compile (error: ‘arither1’ undeclared) ;
4. lcalc didn't compile (error: too few arguments to function ‘long int* ellinit(GEN, GEN, long int)');
5. sagelib didn't compile (quite a few different problems).


---

Comment by Snark created at 2014-04-10 17:49:44

I think #15767 will fix that bug too.


---

Comment by jdemeyer created at 2015-03-13 10:06:13

What should be done with this ticket now? Do you still consider it relevant?


---

Comment by Snark created at 2015-03-13 13:28:07

Well, things changed a lot : I vote for close.


---

Comment by jdemeyer created at 2015-03-13 17:22:37

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-03-13 17:22:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-17 18:19:55

Resolution: fixed
