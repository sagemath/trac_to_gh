# Issue 31069: Replace use of SAGE_EXTCODE by importlib.resources

archive/issues_031069.json:
```json
{
    "body": "CC:  @tobiasdiez chapoton fbissey dimpase soehms tscrim\n\nWe eliminate direct reading of files from the package directories of sagelib by using `importlib.resources`. \n- `git grep 'SAGE_EXTCODE' src/sage`\n- `git grep '__file__' src/sage`\n\nThis will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)\n\n(requires python 3.7 (hence the dependency on #30551) or add the backport package `importlib_resources` if we want to support 3.6 - but that does not support resources within native namespace packages)\n\nReferences:\n- https://docs.python.org/3/library/importlib.html#module-importlib.resources\n- https://importlib-resources.readthedocs.io/en/latest/migration.html\n- https://importlib-resources.readthedocs.io/en/latest/using.html\n\nIssue created by migration from https://trac.sagemath.org/ticket/31306\n\n",
    "created_at": "2021-01-30T18:16:23Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Replace use of SAGE_EXTCODE by importlib.resources",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31069",
    "user": "mkoeppe"
}
```
CC:  @tobiasdiez chapoton fbissey dimpase soehms tscrim

We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources`. 
- `git grep 'SAGE_EXTCODE' src/sage`
- `git grep '__file__' src/sage`

This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)

(requires python 3.7 (hence the dependency on #30551) or add the backport package `importlib_resources` if we want to support 3.6 - but that does not support resources within native namespace packages)

References:
- https://docs.python.org/3/library/importlib.html#module-importlib.resources
- https://importlib-resources.readthedocs.io/en/latest/migration.html
- https://importlib-resources.readthedocs.io/en/latest/using.html

Issue created by migration from https://trac.sagemath.org/ticket/31306





---

archive/issue_comments_443738.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-12-06T03:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443738",
    "user": "mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_443739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-06T03:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443739",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443740.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-06T03:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443740",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443741.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-12T18:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443741",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443742.json:
```json
{
    "body": "The testsuite failures are unrelated",
    "created_at": "2021-12-17T16:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443742",
    "user": "mkoeppe"
}
```

The testsuite failures are unrelated



---

archive/issue_comments_443743.json:
```json
{
    "body": "lgtm",
    "created_at": "2021-12-18T00:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443743",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_443744.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-18T00:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443744",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443745.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-12-18T00:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443745",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_443746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-12-23T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443746",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_443747.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-12-23T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443747",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_443748.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-23T21:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443748",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443749.json:
```json
{
    "body": "trivial merge",
    "created_at": "2021-12-23T21:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443749",
    "user": "mkoeppe"
}
```

trivial merge



---

archive/issue_comments_443750.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-01-23T01:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443750",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_443751.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-01-23T01:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443751",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_443752.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-23T01:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443752",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443753.json:
```json
{
    "body": "OK, Volker has started merging stuff for 9.6 including this. And I get \n\n```\n$ sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2022-01-31-20-37-00-111581fe.\nUsing --optional=pip,sage\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 248, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputSceneWavefront.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[15]>\", line 1, in <module>\n        backend.validate(dm.types.OutputSceneWavefront.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py\", line 354, in example\n        scene_obj = OutputBuffer.from_file(filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example_wavefront_scene.obj'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 249, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputSceneCanvas3d.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[16]>\", line 1, in <module>\n        backend.validate(dm.types.OutputSceneCanvas3d.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py\", line 161, in example\n        return cls(OutputBuffer.from_file(filename))\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.canvas3d'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 250, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoOgg.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[17]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoOgg.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.ogv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 251, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoWebM.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[18]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoWebM.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.webm'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 252, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoMp4.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[19]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoMp4.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mp4'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 253, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoFlash.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[20]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoFlash.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.flv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 254, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoMatroska.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[21]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoMatroska.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mkv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 255, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoAvi.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[22]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoAvi.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.avi'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 256, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoWmv.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[23]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoWmv.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.wmv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 257, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoQuicktime.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[24]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoQuicktime.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mov'\n**********************************************************************\n```\n\nAnd it comes down to that block https://github.com/sagemath/sage/blob/develop/src/sage/repl/rich_output/buffer.py#L139 - `chmod` is not done if the file is in the `SAGE_EXTCODE` folder but executed otherwise. Of course all those files have been moved out of `SAGE_EXTCODE`.",
    "created_at": "2022-01-31T08:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443753",
    "user": "fbissey"
}
```

OK, Volker has started merging stuff for 9.6 including this. And I get 

```
$ sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py
too many failed tests, not using stored timings
Running doctests with ID 2022-01-31-20-37-00-111581fe.
Using --optional=pip,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 248, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputSceneWavefront.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[15]>", line 1, in <module>
        backend.validate(dm.types.OutputSceneWavefront.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py", line 354, in example
        scene_obj = OutputBuffer.from_file(filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example_wavefront_scene.obj'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 249, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputSceneCanvas3d.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[16]>", line 1, in <module>
        backend.validate(dm.types.OutputSceneCanvas3d.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py", line 161, in example
        return cls(OutputBuffer.from_file(filename))
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.canvas3d'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 250, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoOgg.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[17]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoOgg.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.ogv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 251, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoWebM.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[18]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoWebM.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.webm'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 252, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoMp4.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[19]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoMp4.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mp4'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 253, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoFlash.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[20]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoFlash.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.flv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 254, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoMatroska.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[21]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoMatroska.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mkv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 255, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoAvi.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[22]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoAvi.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.avi'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 256, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoWmv.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[23]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoWmv.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.wmv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 257, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoQuicktime.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[24]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoQuicktime.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mov'
**********************************************************************
```

And it comes down to that block https://github.com/sagemath/sage/blob/develop/src/sage/repl/rich_output/buffer.py#L139 - `chmod` is not done if the file is in the `SAGE_EXTCODE` folder but executed otherwise. Of course all those files have been moved out of `SAGE_EXTCODE`.



---

archive/issue_comments_443754.json:
```json
{
    "body": "I also have\n\n```\nsage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py  # 25 doctests failed\nsage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py  # 14 doctests failed\n```\n\nbecause of the same thing. I guess it doesn't fail on user space build because you can safely `chmod` anything.",
    "created_at": "2022-01-31T08:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443754",
    "user": "fbissey"
}
```

I also have

```
sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py  # 25 doctests failed
sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py  # 14 doctests failed
```

because of the same thing. I guess it doesn't fail on user space build because you can safely `chmod` anything.



---

archive/issue_comments_443755.json:
```json
{
    "body": "Follow up at #33256.",
    "created_at": "2022-01-31T09:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443755",
    "user": "fbissey"
}
```

Follow up at #33256.



---

archive/issue_comments_443756.json:
```json
{
    "body": "Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...",
    "created_at": "2022-01-31T12:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443756",
    "user": "dimpase"
}
```

Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...



---

archive/issue_comments_443757.json:
```json
{
    "body": "Replying to [comment:24 dimpase]:\n> Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...\n\nIs it the `python3.10` or the `/usr/lib/` that makes you go \"wow\"? I can do the `python3.9` flavor too if you want. I have been doctesting system installed sage and reporting from those tests for the last 10 years so I may be a bit blaz\u00e9 about it.",
    "created_at": "2022-01-31T18:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443757",
    "user": "fbissey"
}
```

Replying to [comment:24 dimpase]:
> Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...

Is it the `python3.10` or the `/usr/lib/` that makes you go "wow"? I can do the `python3.9` flavor too if you want. I have been doctesting system installed sage and reporting from those tests for the last 10 years so I may be a bit blazé about it.



---

archive/issue_comments_443758.json:
```json
{
    "body": "it's about /usr/lib",
    "created_at": "2022-01-31T21:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443758",
    "user": "dimpase"
}
```

it's about /usr/lib



---

archive/issue_comments_443759.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-31T23:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31069",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31069#issuecomment-443759",
    "user": "vbraun"
}
```

Resolution: fixed
