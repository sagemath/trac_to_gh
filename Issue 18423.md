# Issue 18423: Improve efficiency of minors() for BinaryMatroid, TernaryMatroid, QuaternaryMatroid

archive/issues_018423.json:
```json
{
    "body": "Assignee: Rudi\n\nCC:  chaoxu stefan yomcat\n\nThe representing matrices of BinaryMatroid, TernaryMatroid, QuaternaryMatroid, are bitpacket. Taking minors, involves constructing a submatrix of such a representing matrix. Since the rows are bitpacked, the relocation of columns in particular is relatively inefficient. \n\nBy allowing a submatrix in which the columns are allowed to be permuted, it is possible to reduce the number of column relocations to at most the number of deleted columns, and this will be far more efficient than the current implementation, especially if few columns are deleted. \n\nIssue created by migration from https://trac.sagemath.org/ticket/18660\n\n",
    "created_at": "2015-06-10T10:16:07Z",
    "labels": [
        "matroid theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Improve efficiency of minors() for BinaryMatroid, TernaryMatroid, QuaternaryMatroid",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18423",
    "user": "Rudi"
}
```
Assignee: Rudi

CC:  chaoxu stefan yomcat

The representing matrices of BinaryMatroid, TernaryMatroid, QuaternaryMatroid, are bitpacket. Taking minors, involves constructing a submatrix of such a representing matrix. Since the rows are bitpacked, the relocation of columns in particular is relatively inefficient. 

By allowing a submatrix in which the columns are allowed to be permuted, it is possible to reduce the number of column relocations to at most the number of deleted columns, and this will be far more efficient than the current implementation, especially if few columns are deleted. 

Issue created by migration from https://trac.sagemath.org/ticket/18660





---

archive/issue_comments_250270.json:
```json
{
    "body": "Still need to try this out. Hope to do this this week.\n\nSince a cocircuit of a binary matroid M is typically going to have size about `r^*(M) /2` elements, I expect a speedup by a factor of up to  `r^*(M)/2/|E(M)|` for the minor-taking in Chao's code in ticket #18539.",
    "created_at": "2015-06-10T10:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250270",
    "user": "Rudi"
}
```

Still need to try this out. Hope to do this this week.

Since a cocircuit of a binary matroid M is typically going to have size about `r^*(M) /2` elements, I expect a speedup by a factor of up to  `r^*(M)/2/|E(M)|` for the minor-taking in Chao's code in ticket #18539.



---

archive/issue_comments_250271.json:
```json
{
    "body": "First worked on BinaryMatroid and BinaryMatrix. The new code seems to be correct:\n\n```\nsage: N = Matroid(MatrixSpace(GF(2), 5,12).random_element())\nsage: for X in subsets(N.groundset()):\n    if not BasisMatroid(N\\X).equals(BasisMatroid(N)\\X):\n        print X\n```\n\nIt's more efficient too. Without the patch:\n\n```\nsage: M = Matroid(MatrixSpace(GF(2), 500,1000).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 3.69 s per loop\n```\n\nWith the patch:\n\n```\nsage: M = Matroid(MatrixSpace(GF(2), 500,1000).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 692 ms per loop\n```\n\n\nSo, about 5 times faster on this example. This is not all due to the trick announced in the ticket. Replacing a list by a c-style array here and there did some good too. And just replacing the line \n\n```\nC = [c for c in range(len(self._E)) if self._E[c] not in deletions | contractions]\n```\n\nin `_minor` by something that does not compute the union `deletions | contractions` *for each c* made the code 2 times faster right there. \n----\nNew commits:",
    "created_at": "2015-06-11T08:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250271",
    "user": "Rudi"
}
```

First worked on BinaryMatroid and BinaryMatrix. The new code seems to be correct:

```
sage: N = Matroid(MatrixSpace(GF(2), 5,12).random_element())
sage: for X in subsets(N.groundset()):
    if not BasisMatroid(N\X).equals(BasisMatroid(N)\X):
        print X
```

It's more efficient too. Without the patch:

```
sage: M = Matroid(MatrixSpace(GF(2), 500,1000).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 3.69 s per loop
```

With the patch:

```
sage: M = Matroid(MatrixSpace(GF(2), 500,1000).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 692 ms per loop
```


So, about 5 times faster on this example. This is not all due to the trick announced in the ticket. Replacing a list by a c-style array here and there did some good too. And just replacing the line 

```
C = [c for c in range(len(self._E)) if self._E[c] not in deletions | contractions]
```

in `_minor` by something that does not compute the union `deletions | contractions` *for each c* made the code 2 times faster right there. 
----
New commits:



---

archive/issue_comments_250272.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-11T10:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250272",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250273.json:
```json
{
    "body": "Correctness:\n\n```\nsage: N = Matroid(MatrixSpace(GF(2), 5,10).random_element())\nsage: for X in subsets(N.groundset()):\n    for Y in subsets(N.groundset()-set(X)):\n        if not BasisMatroid(N.minor(X,Y)).equals(BasisMatroid(N).minor(X,Y)):\n            print X,Y\n....:             \nsage: N = Matroid(MatrixSpace(GF(3), 5,10).random_element())\nsage: for X in subsets(N.groundset()):\n    for Y in subsets(N.groundset()-set(X)):\n        if not BasisMatroid(N.minor(X,Y)).equals(BasisMatroid(N).minor(X,Y)):\n            print X,Y\n....:             \nsage: N = Matroid(MatrixSpace(GF(4,x), 5,10).random_element())\nsage: for X in subsets(N.groundset()):\n    for Y in subsets(N.groundset()-set(X)):\n        if not BasisMatroid(N.minor(X,Y)).equals(BasisMatroid(N).minor(X,Y)):\n            print X,Y\n```\n\nEfficiency before patch:\n\n```\nsage: M = Matroid(MatrixSpace(GF(2), 200,400).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 261 ms per loop\nsage: M = Matroid(MatrixSpace(GF(3), 200,400).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 7.13 s per loop\nsage: M = Matroid(MatrixSpace(GF(4,x), 200,400).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 3.95 s per loop\n```\n\nEfficiency after patch:\n\n```\nsage: M = Matroid(MatrixSpace(GF(2), 200,400).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 73.7 ms per loop\nsage: M = Matroid(MatrixSpace(GF(3), 200,400).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 86.7 ms per loop\nsage: M = Matroid(MatrixSpace(GF(4,x), 200,400).random_element())\nsage: B = M.basis()\nsage: timeit(\"for e in B: M.delete(M._fundamental_cocircuit(B,e))\")\n5 loops, best of 3: 86.4 ms per loop\n```\n\nFor TernaryMatrix and QuaternaryMatrix, there was no optimized submatrix-code to begin with, hence the 40 - 80 times speedup.\nI scaled down the size of the matrix a bit, the ternary benchmark simply wouldn't finish for 500x1000.\n\nI will remove some lingering cython profile directives, and then I'm done.",
    "created_at": "2015-06-11T10:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250273",
    "user": "Rudi"
}
```

Correctness:

```
sage: N = Matroid(MatrixSpace(GF(2), 5,10).random_element())
sage: for X in subsets(N.groundset()):
    for Y in subsets(N.groundset()-set(X)):
        if not BasisMatroid(N.minor(X,Y)).equals(BasisMatroid(N).minor(X,Y)):
            print X,Y
....:             
sage: N = Matroid(MatrixSpace(GF(3), 5,10).random_element())
sage: for X in subsets(N.groundset()):
    for Y in subsets(N.groundset()-set(X)):
        if not BasisMatroid(N.minor(X,Y)).equals(BasisMatroid(N).minor(X,Y)):
            print X,Y
....:             
sage: N = Matroid(MatrixSpace(GF(4,x), 5,10).random_element())
sage: for X in subsets(N.groundset()):
    for Y in subsets(N.groundset()-set(X)):
        if not BasisMatroid(N.minor(X,Y)).equals(BasisMatroid(N).minor(X,Y)):
            print X,Y
```

Efficiency before patch:

```
sage: M = Matroid(MatrixSpace(GF(2), 200,400).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 261 ms per loop
sage: M = Matroid(MatrixSpace(GF(3), 200,400).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 7.13 s per loop
sage: M = Matroid(MatrixSpace(GF(4,x), 200,400).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 3.95 s per loop
```

Efficiency after patch:

```
sage: M = Matroid(MatrixSpace(GF(2), 200,400).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 73.7 ms per loop
sage: M = Matroid(MatrixSpace(GF(3), 200,400).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 86.7 ms per loop
sage: M = Matroid(MatrixSpace(GF(4,x), 200,400).random_element())
sage: B = M.basis()
sage: timeit("for e in B: M.delete(M._fundamental_cocircuit(B,e))")
5 loops, best of 3: 86.4 ms per loop
```

For TernaryMatrix and QuaternaryMatrix, there was no optimized submatrix-code to begin with, hence the 40 - 80 times speedup.
I scaled down the size of the matrix a bit, the ternary benchmark simply wouldn't finish for 500x1000.

I will remove some lingering cython profile directives, and then I'm done.



---

archive/issue_comments_250274.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-11T10:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250274",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250275.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-11T11:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250275",
    "user": "Rudi"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_250276.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-19T08:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250276",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250277.json:
```json
{
    "body": "Before:\n\n```\nsage: M = Matroid(MatrixSpace(GF(3), 500,1000).random_element())\nsage: timeit(\"M.delete([0])\")\n5 loops, best of 3: 333 ms per loop\n```\n\nAfter:\n\n```\nsage: M = Matroid(MatrixSpace(GF(3), 500,1000).random_element())\nsage: timeit(\"M.delete([0])\")\n625 loops, best of 3: 655 \u00b5s per loop\n```\n",
    "created_at": "2015-06-19T09:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250277",
    "user": "Rudi"
}
```

Before:

```
sage: M = Matroid(MatrixSpace(GF(3), 500,1000).random_element())
sage: timeit("M.delete([0])")
5 loops, best of 3: 333 ms per loop
```

After:

```
sage: M = Matroid(MatrixSpace(GF(3), 500,1000).random_element())
sage: timeit("M.delete([0])")
625 loops, best of 3: 655 µs per loop
```




---

archive/issue_comments_250278.json:
```json
{
    "body": "LGTM. I'm slightly unhappy with the fact that it looks like a lot of logic is duplicated across the multiple `matrix_from_rows_and_columns_reordered`, but I don't see a way to really combine the common logic. So positive review.",
    "created_at": "2015-06-19T17:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250278",
    "user": "tscrim"
}
```

LGTM. I'm slightly unhappy with the fact that it looks like a lot of logic is duplicated across the multiple `matrix_from_rows_and_columns_reordered`, but I don't see a way to really combine the common logic. So positive review.



---

archive/issue_comments_250279.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-19T18:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250279",
    "user": "Rudi"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_250280.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> LGTM. I'm slightly unhappy with the fact that it looks like a lot of logic is duplicated across the multiple `matrix_from_rows_and_columns_reordered`, but I don't see a way to really combine the common logic. So positive review.\n\nThanks for the review.",
    "created_at": "2015-06-19T18:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250280",
    "user": "Rudi"
}
```

Replying to [comment:10 tscrim]:
> LGTM. I'm slightly unhappy with the fact that it looks like a lot of logic is duplicated across the multiple `matrix_from_rows_and_columns_reordered`, but I don't see a way to really combine the common logic. So positive review.

Thanks for the review.



---

archive/issue_comments_250281.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-20T09:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18423#issuecomment-250281",
    "user": "vbraun"
}
```

Resolution: fixed
