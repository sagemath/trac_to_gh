# Issue 29902: Metaticket - SageManifolds Code Improvement Discussion

archive/issues_029902.json:
```json
{
    "body": "CC:  egourgoulhon tscrim @tobiasdiez chapoton mkoeppe nthiery\n\nKeywords: sagemanifolds\n\nThe main purpose of this ticket is a discussion and coordination platform regarding general code improvements of the preexisting SageManifolds code, which do not involve bugfixes or new features. That is, for instance, the removal of existing code duplication, and strategies to improve readibility, debugging and compatibility.\n\nI for myself do not have much experience in this field. However, I am eager to improve this nice piece of package as much as I can, so that anyone can benefit from it. In any case, this is not a one man task and I appreciate any support in this matter.\n\nI am looking forward to the discussion! :)\n\nIssue created by migration from https://trac.sagemath.org/ticket/30139\n\n",
    "created_at": "2020-07-14T11:02:35Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Metaticket - SageManifolds Code Improvement Discussion",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29902",
    "user": "@mjungmath"
}
```
CC:  egourgoulhon tscrim @tobiasdiez chapoton mkoeppe nthiery

Keywords: sagemanifolds

The main purpose of this ticket is a discussion and coordination platform regarding general code improvements of the preexisting SageManifolds code, which do not involve bugfixes or new features. That is, for instance, the removal of existing code duplication, and strategies to improve readibility, debugging and compatibility.

I for myself do not have much experience in this field. However, I am eager to improve this nice piece of package as much as I can, so that anyone can benefit from it. In any case, this is not a one man task and I appreciate any support in this matter.

I am looking forward to the discussion! :)

Issue created by migration from https://trac.sagemath.org/ticket/30139





---

archive/issue_comments_424727.json:
```json
{
    "body": "Allow me to start the discussion. In my opinion, the highest priority has the removal of code duplication. The new feature of vector bundles, for example, came with a cost: code duplication and redundancies. This is certainly unwanted (see ticket #29234). Take sections and tensor fields. They share a lot of common code snippets and methods. For example the method `restrict` which is more or less the same. Bugs for sections must now be fixed for tensor fields, and vice versa. But a simple inheritation comes with a problem: we have to drop most of the preexisting documentation. Imho, this would be sad, and I like to discuss how we deal with that.\n\nOf course, this issue is not only restricted to vector bundles. As I modified tensor fields, I had to make changes in three different files simultaneously which had a very similar setup with similar code snippets: `manifolds/differentiable/tensorfield.py`, `manifolds/differentiable/tensorfield_paral.py` and `tensor/modules/free_module_tensor.py`. I had to copy the very same lines over and over again. It was a tedious task not only to modify the code but also to understand how it was built up. A simplification would be desireable, even though I have no clue how. If I look through the code, I am sure, I will find further examples.\n\nAnother thing I am bothering with is the invocation of private variables via `._private_variable`. I think, these variables are private for a reason, and in my opinion, to keep the code as clean as possible, they should be invoced by methods and not directly. But I think, this has low priority because it has not such a tremendous impact. However, it would be nice, I guess.",
    "created_at": "2020-07-14T12:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424727",
    "user": "@mjungmath"
}
```

Allow me to start the discussion. In my opinion, the highest priority has the removal of code duplication. The new feature of vector bundles, for example, came with a cost: code duplication and redundancies. This is certainly unwanted (see ticket #29234). Take sections and tensor fields. They share a lot of common code snippets and methods. For example the method `restrict` which is more or less the same. Bugs for sections must now be fixed for tensor fields, and vice versa. But a simple inheritation comes with a problem: we have to drop most of the preexisting documentation. Imho, this would be sad, and I like to discuss how we deal with that.

Of course, this issue is not only restricted to vector bundles. As I modified tensor fields, I had to make changes in three different files simultaneously which had a very similar setup with similar code snippets: `manifolds/differentiable/tensorfield.py`, `manifolds/differentiable/tensorfield_paral.py` and `tensor/modules/free_module_tensor.py`. I had to copy the very same lines over and over again. It was a tedious task not only to modify the code but also to understand how it was built up. A simplification would be desireable, even though I have no clue how. If I look through the code, I am sure, I will find further examples.

Another thing I am bothering with is the invocation of private variables via `._private_variable`. I think, these variables are private for a reason, and in my opinion, to keep the code as clean as possible, they should be invoced by methods and not directly. But I think, this has low priority because it has not such a tremendous impact. However, it would be nice, I guess.



---

archive/issue_comments_424728.json:
```json
{
    "body": "Changing component from geometry to manifolds.",
    "created_at": "2020-07-14T17:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424728",
    "user": "@mjungmath"
}
```

Changing component from geometry to manifolds.



---

archive/issue_comments_424729.json:
```json
{
    "body": "Let me preface my comments: I have only very recently started to look into sage-manifolds and my understanding of this code is very shallow.\n\nReplying to [comment:1 gh-mjungmath]:\n>  The new feature of vector bundles, for example, came with a cost: code duplication and redundancies. This is certainly unwanted (see ticket #29234). Take sections and tensor fields. They share a lot of common code snippets and methods. For example the method `restrict` which is more or less the same. Bugs for sections must now be fixed for tensor fields, and vice versa. But a simple inheritation comes with a problem: we have to drop most of the preexisting documentation. Imho, this would be sad, and I like to discuss how we deal with that.\n\nIf you are concerned about removing doctests (rather than documentation) as a byproduct of removing code duplications:  There is a solution by moving many tests from doctests to `_test...` methods. These are inherited by subclasses and therefore test coverage can be improved.\n\nI did this in the `sage.numerical.backends` modules in #20323 and follow-up tickets, and recently `gh-kliem` started to do the same in `sage.geometry.polyhedra` (see for example #29918).\n\nIn `sage.numerical.backends.logging_backend` I have some code that assists with transforming doctests to `_test...` methods, which could be generalized easily.",
    "created_at": "2020-07-14T17:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424729",
    "user": "mkoeppe"
}
```

Let me preface my comments: I have only very recently started to look into sage-manifolds and my understanding of this code is very shallow.

Replying to [comment:1 gh-mjungmath]:
>  The new feature of vector bundles, for example, came with a cost: code duplication and redundancies. This is certainly unwanted (see ticket #29234). Take sections and tensor fields. They share a lot of common code snippets and methods. For example the method `restrict` which is more or less the same. Bugs for sections must now be fixed for tensor fields, and vice versa. But a simple inheritation comes with a problem: we have to drop most of the preexisting documentation. Imho, this would be sad, and I like to discuss how we deal with that.

If you are concerned about removing doctests (rather than documentation) as a byproduct of removing code duplications:  There is a solution by moving many tests from doctests to `_test...` methods. These are inherited by subclasses and therefore test coverage can be improved.

I did this in the `sage.numerical.backends` modules in #20323 and follow-up tickets, and recently `gh-kliem` started to do the same in `sage.geometry.polyhedra` (see for example #29918).

In `sage.numerical.backends.logging_backend` I have some code that assists with transforming doctests to `_test...` methods, which could be generalized easily.



---

archive/issue_comments_424730.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> If you are concerned about removing doctests (rather than documentation) as a byproduct of removing code duplications:  There is a solution by moving many tests from doctests to `_test...` methods. These are inherited by subclasses and therefore test coverage can be improved.\n\nThank you. This is good to know and definitely an important point. My concern, however, is also the documentation itself. Tensor fields and sections are declared slighly differently. For example, sections are constructed by using an instance of the vector bundle. Tensor fields, on the other hand, are declared by using an instance of the manifold. Therefore, it would be good to have separate closed minimal examples and hence distinct documentations.\n\nWhat about something like this:\n\n\n```python\n\nclass MyClass(ParentClass)\n    r\"\"\"\n    Blabla\n    \"\"\"\n\n    my_method(self, a, b, c='c'):\n        r\"\"\"\n        Overwritten docstring\n        \"\"\"\n        return ParentClass.my_method(self, a, b, c=c)\n```\n\n\nOr is that too nasty?",
    "created_at": "2020-07-14T17:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424730",
    "user": "@mjungmath"
}
```

Replying to [comment:4 mkoeppe]:
> If you are concerned about removing doctests (rather than documentation) as a byproduct of removing code duplications:  There is a solution by moving many tests from doctests to `_test...` methods. These are inherited by subclasses and therefore test coverage can be improved.

Thank you. This is good to know and definitely an important point. My concern, however, is also the documentation itself. Tensor fields and sections are declared slighly differently. For example, sections are constructed by using an instance of the vector bundle. Tensor fields, on the other hand, are declared by using an instance of the manifold. Therefore, it would be good to have separate closed minimal examples and hence distinct documentations.

What about something like this:


```python

class MyClass(ParentClass)
    r"""
    Blabla
    """

    my_method(self, a, b, c='c'):
        r"""
        Overwritten docstring
        """
        return ParentClass.my_method(self, a, b, c=c)
```


Or is that too nasty?



---

archive/issue_comments_424731.json:
```json
{
    "body": "Nothing wrong with that, I would say. (Of course, one would use `super()` instead of referring to the parent class by name.)\nThe performance impact should be minimal.",
    "created_at": "2020-07-14T18:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424731",
    "user": "mkoeppe"
}
```

Nothing wrong with that, I would say. (Of course, one would use `super()` instead of referring to the parent class by name.)
The performance impact should be minimal.



---

archive/issue_comments_424732.json:
```json
{
    "body": "Just one caveat: it makes it more complicated to look at the code of the method by introspection.\n\nI don't have a good solution though. The best approximation I can come it is to include both the examples/doc of vector bundles and tensor fields in the documentation of the method. It makes it a bit long for the reader. But points out the similarity, which is not bad per se.\n\nMatthias: glad to see _test methods being adopted at a large scale, with additional tooling :-)",
    "created_at": "2020-07-14T19:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424732",
    "user": "nthiery"
}
```

Just one caveat: it makes it more complicated to look at the code of the method by introspection.

I don't have a good solution though. The best approximation I can come it is to include both the examples/doc of vector bundles and tensor fields in the documentation of the method. It makes it a bit long for the reader. But points out the similarity, which is not bad per se.

Matthias: glad to see _test methods being adopted at a large scale, with additional tooling :-)



---

archive/issue_comments_424733.json:
```json
{
    "body": "In a different direction: The (multi)linear algebra in `sage.tensor` that was developed for sage-manifolds has a much better design than the linear algebra provided by `sage.matrix` (see, for example, #30091).\n\nIt would be nice to be able to use it for computational (exact and inexact) (multi)linear algebra. In #30061, Eric already did some improvements that makes better use of sparsity. \n\nIn addition to such speedups, it would be good to be able to use different backends for storing tensors instead of the current dictionary backend. \n\nOn the one hand, for special cases such as vectors and matrices by existing special implementations; for the special case of fully symmetric tensors, using fast implementations of multivariate polynomials. \n\nOn the other hand, for general numerical tensors using mainstream accelerated frameworks like PyTorch (see #30096).",
    "created_at": "2020-07-14T19:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424733",
    "user": "mkoeppe"
}
```

In a different direction: The (multi)linear algebra in `sage.tensor` that was developed for sage-manifolds has a much better design than the linear algebra provided by `sage.matrix` (see, for example, #30091).

It would be nice to be able to use it for computational (exact and inexact) (multi)linear algebra. In #30061, Eric already did some improvements that makes better use of sparsity. 

In addition to such speedups, it would be good to be able to use different backends for storing tensors instead of the current dictionary backend. 

On the one hand, for special cases such as vectors and matrices by existing special implementations; for the special case of fully symmetric tensors, using fast implementations of multivariate polynomials. 

On the other hand, for general numerical tensors using mainstream accelerated frameworks like PyTorch (see #30096).



---

archive/issue_comments_424734.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Nothing wrong with that, I would say. (Of course, one would use `super()` instead of referring to the parent class by name.)\n\nI would have thought that referring to the parent class by name is more robust against changes and increases readability. Is there a particular reason to prefer `super()`?\n\n> The performance impact should be minimal.\n\nThat's good.\n\nReplying to [comment:7 nthiery]:\n> Just one caveat: it makes it more complicated to look at the code of the method by introspection.\n\nWhat exactly do you mean by that?\n\n> I don't have a good solution though. The best approximation I can come it is to include both the examples/doc of vector bundles and tensor fields in the documentation of the method. It makes it a bit long for the reader. But points out the similarity, which is not bad per se.\n\nI'd guess this would contradict the well-documented philosophy of Sage, wouldn't it?",
    "created_at": "2020-07-14T20:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424734",
    "user": "@mjungmath"
}
```

Replying to [comment:6 mkoeppe]:
> Nothing wrong with that, I would say. (Of course, one would use `super()` instead of referring to the parent class by name.)

I would have thought that referring to the parent class by name is more robust against changes and increases readability. Is there a particular reason to prefer `super()`?

> The performance impact should be minimal.

That's good.

Replying to [comment:7 nthiery]:
> Just one caveat: it makes it more complicated to look at the code of the method by introspection.

What exactly do you mean by that?

> I don't have a good solution though. The best approximation I can come it is to include both the examples/doc of vector bundles and tensor fields in the documentation of the method. It makes it a bit long for the reader. But points out the similarity, which is not bad per se.

I'd guess this would contradict the well-documented philosophy of Sage, wouldn't it?



---

archive/issue_comments_424735.json:
```json
{
    "body": "Replying to [comment:9 gh-mjungmath]:\n> Replying to [comment:6 mkoeppe]:\n> > (Of course, one would use `super()` instead of referring to the parent class by name.)\n> \n> I would have thought that referring to the parent class by name is more robust against changes and increases readability. Is there a particular reason to prefer `super()`?\n\nFor classes with single inheritance, it is merely a matter of style. But as soon as multiple inheritance enters, using `super()` ensures that methods of all superclasses are called (and called in the right order)",
    "created_at": "2020-07-17T18:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424735",
    "user": "mkoeppe"
}
```

Replying to [comment:9 gh-mjungmath]:
> Replying to [comment:6 mkoeppe]:
> > (Of course, one would use `super()` instead of referring to the parent class by name.)
> 
> I would have thought that referring to the parent class by name is more robust against changes and increases readability. Is there a particular reason to prefer `super()`?

For classes with single inheritance, it is merely a matter of style. But as soon as multiple inheritance enters, using `super()` ensures that methods of all superclasses are called (and called in the right order)



---

archive/issue_comments_424736.json:
```json
{
    "body": "As someone who's new to sage, but would like to get involved in SageManifolds: how can I help?",
    "created_at": "2020-07-22T04:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424736",
    "user": "@bollu"
}
```

As someone who's new to sage, but would like to get involved in SageManifolds: how can I help?



---

archive/issue_comments_424737.json:
```json
{
    "body": "Replying to [comment:12 gh-bollu]:\n> As someone who's new to sage, but would like to get involved in SageManifolds: how can I help? \nWelcome to the project!\nThere are various ways to contribute, see \nhttps://sagemanifolds.obspm.fr/contrib.html. \n\nIf you take a look at the metaticket #18528, you'll see that various tickets are in stalled state (mostly the blue ones), are therefore are open for development. For instance, #18786 about complex structures. You could pick one of those or create a brand new ticket about a topic that you like.",
    "created_at": "2020-07-22T14:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424737",
    "user": "egourgoulhon"
}
```

Replying to [comment:12 gh-bollu]:
> As someone who's new to sage, but would like to get involved in SageManifolds: how can I help? 
Welcome to the project!
There are various ways to contribute, see 
https://sagemanifolds.obspm.fr/contrib.html. 

If you take a look at the metaticket #18528, you'll see that various tickets are in stalled state (mostly the blue ones), are therefore are open for development. For instance, #18786 about complex structures. You could pick one of those or create a brand new ticket about a topic that you like.



---

archive/issue_comments_424738.json:
```json
{
    "body": "Replying to [comment:5 gh-mjungmath]:\n> Replying to [comment:4 mkoeppe]:\n> \n> What about something like this:\n> \n> {{{\n> #!python\n> \n> class MyClass(ParentClass)\n>     r\"\"\"\n>     Blabla\n>     \"\"\"\n> \n>     my_method(self, a, b, c='c'):\n>         r\"\"\"\n>         Overwritten docstring\n>         \"\"\"\n>         return ParentClass.my_method(self, a, b, c=c)\n> }}}\n> \n> Or is that too nasty?\n\nThis is code duplication and should be avoided IMHO, cf. [comment:6](https://trac.sagemath.org/ticket/29234#comment:6) in #29234 for the case of sections vs. tensor fields.",
    "created_at": "2020-07-24T12:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424738",
    "user": "egourgoulhon"
}
```

Replying to [comment:5 gh-mjungmath]:
> Replying to [comment:4 mkoeppe]:
> 
> What about something like this:
> 
> {{{
> #!python
> 
> class MyClass(ParentClass)
>     r"""
>     Blabla
>     """
> 
>     my_method(self, a, b, c='c'):
>         r"""
>         Overwritten docstring
>         """
>         return ParentClass.my_method(self, a, b, c=c)
> }}}
> 
> Or is that too nasty?

This is code duplication and should be avoided IMHO, cf. [comment:6](https://trac.sagemath.org/ticket/29234#comment:6) in #29234 for the case of sections vs. tensor fields.



---

archive/issue_comments_424739.json:
```json
{
    "body": "Replying to [comment:7 nthiery]:\n> \n> I don't have a good solution though. The best approximation I can come it is to include both the examples/doc of vector bundles and tensor fields in the documentation of the method. It makes it a bit long for the reader. But points out the similarity, which is not bad per se.\n\n+1",
    "created_at": "2020-07-24T12:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424739",
    "user": "egourgoulhon"
}
```

Replying to [comment:7 nthiery]:
> 
> I don't have a good solution though. The best approximation I can come it is to include both the examples/doc of vector bundles and tensor fields in the documentation of the method. It makes it a bit long for the reader. But points out the similarity, which is not bad per se.

+1



---

archive/issue_comments_424740.json:
```json
{
    "body": "Tobias had a very nice idea how to deal with some code duplication, in particular the restriction process: introduce sheafs (cf. [comment:7](https://trac.sagemath.org/ticket/29234#comment:7) in #29234).\n\nI like that idea and I think this is something we definitely should aim for. However, this task is not as easy as one might think on the first glimpse. My first attempt would be utilizing the morphism framework of Sage. Unfortunately, my experience with morphisms in Sage is very limited. What do you think? Any further ideas?",
    "created_at": "2020-07-27T10:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424740",
    "user": "@mjungmath"
}
```

Tobias had a very nice idea how to deal with some code duplication, in particular the restriction process: introduce sheafs (cf. [comment:7](https://trac.sagemath.org/ticket/29234#comment:7) in #29234).

I like that idea and I think this is something we definitely should aim for. However, this task is not as easy as one might think on the first glimpse. My first attempt would be utilizing the morphism framework of Sage. Unfortunately, my experience with morphisms in Sage is very limited. What do you think? Any further ideas?



---

archive/issue_comments_424741.json:
```json
{
    "body": "Replying to [comment:9 gh-mjungmath]:\n> Replying to [comment:7 nthiery]:\n> > Just one caveat: it makes it more complicated to look at the code of the method by introspection.\n> \n> What exactly do you mean by that?\n\nI guess Nicolas means that if the user would like to take a look at the source code via `t.my_method??`, he/she would get `return ParentClass.my_method(self, a, b, c=c)`, i.e.\nuseless information.",
    "created_at": "2020-07-27T13:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424741",
    "user": "egourgoulhon"
}
```

Replying to [comment:9 gh-mjungmath]:
> Replying to [comment:7 nthiery]:
> > Just one caveat: it makes it more complicated to look at the code of the method by introspection.
> 
> What exactly do you mean by that?

I guess Nicolas means that if the user would like to take a look at the source code via `t.my_method??`, he/she would get `return ParentClass.my_method(self, a, b, c=c)`, i.e.
useless information.



---

archive/issue_comments_424742.json:
```json
{
    "body": "I thought a bit about optimizations and the first thing that came to my mind: Cythonize code. Of course, one has to check with prun etc. whether it's worth it. However, Cythonizing `comp.py` and/or the algebraic part in the tensor module should be doable.\n\nOne thing that could definitely be Cythonized is the way of how names, i.e. strings, are concatenated, for example in `format_utilities.py`. I can imagine that this could improve speed a lot. Of course, this needs to be investigated with some performance checks before, too.\n\nEric, what do you think?",
    "created_at": "2021-01-17T19:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424742",
    "user": "@mjungmath"
}
```

I thought a bit about optimizations and the first thing that came to my mind: Cythonize code. Of course, one has to check with prun etc. whether it's worth it. However, Cythonizing `comp.py` and/or the algebraic part in the tensor module should be doable.

One thing that could definitely be Cythonized is the way of how names, i.e. strings, are concatenated, for example in `format_utilities.py`. I can imagine that this could improve speed a lot. Of course, this needs to be investigated with some performance checks before, too.

Eric, what do you think?



---

archive/issue_comments_424743.json:
```json
{
    "body": "Replying to [comment:20 gh-mjungmath]:\n> I thought a bit about optimizations and the first thing that came to my mind: Cythonize code. Of course, one has to check with prun etc. whether it's worth it. However, Cythonizing `comp.py` and/or the algebraic part in the tensor module should be doable.\n> \n> One thing that could definitely be Cythonized is the way of how names, i.e. strings, are concatenated, for example in `format_utilities.py`. I can imagine that this could improve speed a lot. Of course, this needs to be investigated with some performance checks before, too.\n> \n> Eric, what do you think?\n\nCythonizing the algebraic part of tensor calculus will unfortunately not help much to improve the computational speed on manifolds. The reason is that the main bottleneck is symbolic calculus on the tensor field components and more specifically the simplification process, which is performed via Maxima (default backend, Lisp based) or by SymPy (optional backend, Python based). To really gain in performance, one shall rely on parallelization rather than cythonization. A real limitation in this respect is #27492, which forbids parallelization with symbolic functions (side note: certainly Sage's symbolic functions require some major rewritting, see #31047)",
    "created_at": "2021-01-18T09:15:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424743",
    "user": "egourgoulhon"
}
```

Replying to [comment:20 gh-mjungmath]:
> I thought a bit about optimizations and the first thing that came to my mind: Cythonize code. Of course, one has to check with prun etc. whether it's worth it. However, Cythonizing `comp.py` and/or the algebraic part in the tensor module should be doable.
> 
> One thing that could definitely be Cythonized is the way of how names, i.e. strings, are concatenated, for example in `format_utilities.py`. I can imagine that this could improve speed a lot. Of course, this needs to be investigated with some performance checks before, too.
> 
> Eric, what do you think?

Cythonizing the algebraic part of tensor calculus will unfortunately not help much to improve the computational speed on manifolds. The reason is that the main bottleneck is symbolic calculus on the tensor field components and more specifically the simplification process, which is performed via Maxima (default backend, Lisp based) or by SymPy (optional backend, Python based). To really gain in performance, one shall rely on parallelization rather than cythonization. A real limitation in this respect is #27492, which forbids parallelization with symbolic functions (side note: certainly Sage's symbolic functions require some major rewritting, see #31047)



---

archive/issue_comments_424744.json:
```json
{
    "body": "Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?",
    "created_at": "2021-01-18T09:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424744",
    "user": "@bollu"
}
```

Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?



---

archive/issue_comments_424745.json:
```json
{
    "body": "Replying to [comment:22 gh-bollu]:\n> Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?\nThanks for pointing this! This is certainly worth to investigate. Especially SymEngine's README says: *Python wrappers allow easy usage from Python and integration with SymPy and Sage (the symengine.py repository)*.",
    "created_at": "2021-01-18T10:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424745",
    "user": "egourgoulhon"
}
```

Replying to [comment:22 gh-bollu]:
> Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?
Thanks for pointing this! This is certainly worth to investigate. Especially SymEngine's README says: *Python wrappers allow easy usage from Python and integration with SymPy and Sage (the symengine.py repository)*.



---

archive/issue_comments_424746.json:
```json
{
    "body": "If one were to attempt to integrate/use SymEngine for the purpose of making the algebra faster, what should one do? I'd imagine\n1. Pull in SymEngine into SAGE\n2. Replace the calls to Maxima to call to SymEngine\n3. Benchmark?",
    "created_at": "2021-01-18T10:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424746",
    "user": "@bollu"
}
```

If one were to attempt to integrate/use SymEngine for the purpose of making the algebra faster, what should one do? I'd imagine
1. Pull in SymEngine into SAGE
2. Replace the calls to Maxima to call to SymEngine
3. Benchmark?



---

archive/issue_comments_424747.json:
```json
{
    "body": "Replying to [comment:22 gh-bollu]:\n> Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?\n\nThat looks extremely promising. It's definitely worth investigating. And who knows, perhaps it could even replace the entire symbolic backend in Sage.\n\nPerhaps we should post this in the sage-devel group and initiate a discussion.",
    "created_at": "2021-01-18T12:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424747",
    "user": "@mjungmath"
}
```

Replying to [comment:22 gh-bollu]:
> Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?

That looks extremely promising. It's definitely worth investigating. And who knows, perhaps it could even replace the entire symbolic backend in Sage.

Perhaps we should post this in the sage-devel group and initiate a discussion.



---

archive/issue_comments_424748.json:
```json
{
    "body": "Replying to [comment:25 gh-mjungmath]:\n> Replying to [comment:22 gh-bollu]:\n> > Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?\n> \n> That looks extremely promising. It's definitely worth investigating. And who knows, perhaps it could even replace the entire symbolic backend in Sage.\n\nIndeed, this is all the more relevant, given that the main developer of Pynac (Sage's symbolic backend) has resigned:\nhttps://groups.google.com/g/sage-devel/c/JVLHRy2mxUI\n> \n> Perhaps we should post this in the sage-devel group and initiate a discussion.\n\nYes this is certainly the right place to initiate the discussion.",
    "created_at": "2021-01-18T13:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424748",
    "user": "egourgoulhon"
}
```

Replying to [comment:25 gh-mjungmath]:
> Replying to [comment:22 gh-bollu]:
> > Perhaps I am missing something. SymPy has a new C++ backend called SymEngine [https://github.com/symengine/symengine](https://github.com/symengine/symengine). Would that improve performance by some degree?
> 
> That looks extremely promising. It's definitely worth investigating. And who knows, perhaps it could even replace the entire symbolic backend in Sage.

Indeed, this is all the more relevant, given that the main developer of Pynac (Sage's symbolic backend) has resigned:
https://groups.google.com/g/sage-devel/c/JVLHRy2mxUI
> 
> Perhaps we should post this in the sage-devel group and initiate a discussion.

Yes this is certainly the right place to initiate the discussion.



---

archive/issue_comments_424749.json:
```json
{
    "body": "I've created a thread on sage-devel about moving to  SymEngine [https://groups.google.com/g/sage-devel/c/sY3zh-pq8T4](https://groups.google.com/g/sage-devel/c/sY3zh-pq8T4)",
    "created_at": "2021-01-18T13:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424749",
    "user": "@bollu"
}
```

I've created a thread on sage-devel about moving to  SymEngine [https://groups.google.com/g/sage-devel/c/sY3zh-pq8T4](https://groups.google.com/g/sage-devel/c/sY3zh-pq8T4)



---

archive/issue_comments_424750.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-27T02:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424750",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_424751.json:
```json
{
    "body": "Indeed, it would be nice to (co)homology of manifolds. There are two approaches I see right now:\n\n- Morse homology\n- \u010cech cohomology\n**\n\u010cech cohomology** sounds promising since it can (more or less) directly be obtained from charts and their transition maps (see e.g. https://webspace.science.uu.nl/~caval101/homepage/Differential_geometry_2014_files/notes%20on%20Cech%20cohomology.pdf).\n\nAs for **Morse homology** I'd like to refer to https://www.sciencedirect.com/science/article/pii/S0723086905000642. With the orientation implementation we already have, this could be doable, even though there are some immediate problems that I can think of:\n\n- How do we check whether a function is Morse?\n- How can we obtain all critial points? How do we determine their indices?\n\nIs there perhaps a nice class of Morse functions we can easily deal with?\n\nOpinions, comments, hints, references and ideas are welcome! :)",
    "created_at": "2021-04-07T08:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424751",
    "user": "@mjungmath"
}
```

Indeed, it would be nice to (co)homology of manifolds. There are two approaches I see right now:

- Morse homology
- Čech cohomology
**
Čech cohomology** sounds promising since it can (more or less) directly be obtained from charts and their transition maps (see e.g. https://webspace.science.uu.nl/~caval101/homepage/Differential_geometry_2014_files/notes%20on%20Cech%20cohomology.pdf).

As for **Morse homology** I'd like to refer to https://www.sciencedirect.com/science/article/pii/S0723086905000642. With the orientation implementation we already have, this could be doable, even though there are some immediate problems that I can think of:

- How do we check whether a function is Morse?
- How can we obtain all critial points? How do we determine their indices?

Is there perhaps a nice class of Morse functions we can easily deal with?

Opinions, comments, hints, references and ideas are welcome! :)



---

archive/issue_comments_424752.json:
```json
{
    "body": "I would probably start with \u010cech cohomology since it is more straightforward.\n\nFor finding the critical points in Morse homology, I think you can compute them on each chart individually since they are suppose to be isolated IIRC and then remove redundancies. From there, you can check the degeneracy condition.",
    "created_at": "2021-04-07T21:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424752",
    "user": "tscrim"
}
```

I would probably start with Čech cohomology since it is more straightforward.

For finding the critical points in Morse homology, I think you can compute them on each chart individually since they are suppose to be isolated IIRC and then remove redundancies. From there, you can check the degeneracy condition.



---

archive/issue_comments_424753.json:
```json
{
    "body": "Replying to [comment:30 tscrim]:\n> I would probably start with \u010cech cohomology since it is more straightforward.\n\nFor that, we need \"good covers\" consisting of contractible sets, and all its intersections being contractible. Thus we need a way to check contractibility for open subsets. Is that worth a post in sage-devel?",
    "created_at": "2021-04-27T12:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424753",
    "user": "@mjungmath"
}
```

Replying to [comment:30 tscrim]:
> I would probably start with Čech cohomology since it is more straightforward.

For that, we need "good covers" consisting of contractible sets, and all its intersections being contractible. Thus we need a way to check contractibility for open subsets. Is that worth a post in sage-devel?



---

archive/issue_comments_424754.json:
```json
{
    "body": "The manifolds code is growing steadily and more files are added. Do you think it is time that we consider refactoring the folder structure of the manifolds module?",
    "created_at": "2021-04-27T12:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424754",
    "user": "@mjungmath"
}
```

The manifolds code is growing steadily and more files are added. Do you think it is time that we consider refactoring the folder structure of the manifolds module?



---

archive/issue_comments_424755.json:
```json
{
    "body": "Replying to [comment:32 gh-mjungmath]:\n> The manifolds code is growing steadily and more files are added. Do you think it is time that we consider refactoring the folder structure of the manifolds module?\n\nSome of the things added as part of #31740 (Meta-ticket: Families, posets, complexes of manifold subsets) could certainly be moved into a subpackage `sage.manifolds.subsets`:\n- from #31653: `sage.manifolds.continuous_map_image` -> `sage.manifolds.subsets.continuous_map_image`\n- likewise #31644, #31688",
    "created_at": "2021-04-27T17:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424755",
    "user": "mkoeppe"
}
```

Replying to [comment:32 gh-mjungmath]:
> The manifolds code is growing steadily and more files are added. Do you think it is time that we consider refactoring the folder structure of the manifolds module?

Some of the things added as part of #31740 (Meta-ticket: Families, posets, complexes of manifold subsets) could certainly be moved into a subpackage `sage.manifolds.subsets`:
- from #31653: `sage.manifolds.continuous_map_image` -> `sage.manifolds.subsets.continuous_map_image`
- likewise #31644, #31688



---

archive/issue_comments_424756.json:
```json
{
    "body": "Opened #32274 for the structuring issue.",
    "created_at": "2021-07-25T08:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29902#issuecomment-424756",
    "user": "@mjungmath"
}
```

Opened #32274 for the structuring issue.
