# Issue 29725: Allow fuzzing of doctests

archive/issues_029725.json:
```json
{
    "body": "CC:  slelievre\n\nKeywords: doctests, random\n\nWe introduce an option for doctests `--random_seed` that defaults to `0` for now:\n\n\n```\nsage -t --long src/sage/all.py \n...\nDoctesting 1 file.\nsage -t --long --random_seed=0 src/sage/all.py\n    [16 tests, 0.73 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.8 seconds\n    cpu time: 0.7 seconds\n    cumulative wall time: 0.7 seconds\n```\n\n\nThis allows specifying, which random seed shall be used for the doctests.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29962\n\n",
    "created_at": "2020-06-24T19:06:29Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Allow fuzzing of doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29725",
    "user": "@kliem"
}
```
CC:  slelievre

Keywords: doctests, random

We introduce an option for doctests `--random_seed` that defaults to `0` for now:


```
sage -t --long src/sage/all.py 
...
Doctesting 1 file.
sage -t --long --random_seed=0 src/sage/all.py
    [16 tests, 0.73 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
```


This allows specifying, which random seed shall be used for the doctests.

Issue created by migration from https://trac.sagemath.org/ticket/29962





---

archive/issue_comments_422234.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-24T19:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422234",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422235.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-06-24T19:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422235",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_422236.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-24T19:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422236",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-24T19:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422237",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_422238.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-24T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422238",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422239.json:
```json
{
    "body": "Overall, this looks good to me. The following changes seem to be needed:\n\n\n```diff\n-    sage: subprocess.call([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--random-seed=0\", -random_seed.rst\"], **kwds)  # long time\n+    sage: subprocess.call([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--random-seed=0\", \"random_seed.rst\"], **kwds)  # long time\n```\n\n\n\n```diff\n-  - ``--random_seed[=seed]`` -- random seed for fuzzing doctests\n+  - ``--random-seed[=seed]`` -- random seed for fuzzing doctests\n```\n",
    "created_at": "2020-07-10T22:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422239",
    "user": "@mwageringel"
}
```

Overall, this looks good to me. The following changes seem to be needed:


```diff
-    sage: subprocess.call(["sage", "-t", "--warn-long", "0", "--random-seed=0", -random_seed.rst"], **kwds)  # long time
+    sage: subprocess.call(["sage", "-t", "--warn-long", "0", "--random-seed=0", "random_seed.rst"], **kwds)  # long time
```



```diff
-  - ``--random_seed[=seed]`` -- random seed for fuzzing doctests
+  - ``--random-seed[=seed]`` -- random seed for fuzzing doctests
```




---

archive/issue_comments_422240.json:
```json
{
    "body": "The branch adds this to the documentation, which is not true for this ticket:\n\n```\n--- a/src/doc/en/developer/doctesting.rst\n+++ b/src/doc/en/developer/doctesting.rst\n...\n+Doctests start from a random seed::\n+\n+    [kliem@sage sage-9.2]$ sage -t src/sage/doctest/tests/random_seed.rst\n...\n+    sage -t --warn-long 89.5 --random-seed=112986622569797306072457879734474628454 src/sage/doctest/tests/random_seed.rst\n+    **********************************************************************\n```\n",
    "created_at": "2020-07-10T23:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422240",
    "user": "mkoeppe"
}
```

The branch adds this to the documentation, which is not true for this ticket:

```
--- a/src/doc/en/developer/doctesting.rst
+++ b/src/doc/en/developer/doctesting.rst
...
+Doctests start from a random seed::
+
+    [kliem@sage sage-9.2]$ sage -t src/sage/doctest/tests/random_seed.rst
...
+    sage -t --warn-long 89.5 --random-seed=112986622569797306072457879734474628454 src/sage/doctest/tests/random_seed.rst
+    **********************************************************************
```




---

archive/issue_comments_422241.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-11T05:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422241",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_422242.json:
```json
{
    "body": "From my side this is a positive review - if patchbot is green",
    "created_at": "2020-07-11T06:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422242",
    "user": "mkoeppe"
}
```

From my side this is a positive review - if patchbot is green



---

archive/issue_comments_422243.json:
```json
{
    "body": "Thanks. This successfully passes ptestlong.",
    "created_at": "2020-07-11T09:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422243",
    "user": "@mwageringel"
}
```

Thanks. This successfully passes ptestlong.



---

archive/issue_comments_422244.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-11T09:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422244",
    "user": "@mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422245.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-07-11T09:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422245",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_422246.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2020-07-11T23:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422246",
    "user": "vbraun"
}
```

Merge conflict



---

archive/issue_comments_422247.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-07-11T23:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422247",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_422248.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-12T17:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422248",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_422249.json:
```json
{
    "body": "`sage -t --long --all` passes for me.\n----\nNew commits:",
    "created_at": "2020-07-12T17:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422249",
    "user": "@kliem"
}
```

`sage -t --long --all` passes for me.
----
New commits:



---

archive/issue_comments_422250.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-12T17:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422250",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422251.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-07-12T18:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422251",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_422252.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-19T07:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422252",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_422253.json:
```json
{
    "body": "What random seeds are allowed? Any integer?\nOf any sign? Arbitrarily large?",
    "created_at": "2020-08-23T15:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422253",
    "user": "slelievre"
}
```

What random seeds are allowed? Any integer?
Of any sign? Arbitrarily large?



---

archive/issue_comments_422254.json:
```json
{
    "body": "This is how we will eventually get the random seeds.\n\n\n```\nsage: import sage.misc.randstate as randstate                                   \nsage: randstate.set_random_seed()                                               \nsage: randstate.initial_seed()                                                  \n11032378495085541661748859066830408537\n```\n\n\nAt least that's the plan for now. Any random seed that you can feed into `set_random_seed` should work.\n\n(Edit: But I wouldn't be surprised if there are bugs somewhere with some strange random seed. There is no way, you can avoid all of them. But at least you can prepare for rather probable cases.)",
    "created_at": "2020-08-23T16:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422254",
    "user": "@kliem"
}
```

This is how we will eventually get the random seeds.


```
sage: import sage.misc.randstate as randstate                                   
sage: randstate.set_random_seed()                                               
sage: randstate.initial_seed()                                                  
11032378495085541661748859066830408537
```


At least that's the plan for now. Any random seed that you can feed into `set_random_seed` should work.

(Edit: But I wouldn't be surprised if there are bugs somewhere with some strange random seed. There is no way, you can avoid all of them. But at least you can prepare for rather probable cases.)



---

archive/issue_comments_422255.json:
```json
{
    "body": "The `random_seed` docstring says seed \"must be coercible to a Python long\".\n\nIs that from `-2**127` to `2**127 - 1`?\nOr are 32-bit and 64-bit systems different there?\n\nAlso isn't \"long\" a Python 2 concept,\nwith only \"int\" existing in Python 3?\n\nCould we document the admissible range in a follow-up ticket, for non-experts like me?",
    "created_at": "2020-08-23T22:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422255",
    "user": "slelievre"
}
```

The `random_seed` docstring says seed "must be coercible to a Python long".

Is that from `-2**127` to `2**127 - 1`?
Or are 32-bit and 64-bit systems different there?

Also isn't "long" a Python 2 concept,
with only "int" existing in Python 3?

Could we document the admissible range in a follow-up ticket, for non-experts like me?



---

archive/issue_comments_422256.json:
```json
{
    "body": "And thanks for the work on varying random seeds when testing!",
    "created_at": "2020-08-23T22:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422256",
    "user": "slelievre"
}
```

And thanks for the work on varying random seeds when testing!



---

archive/issue_comments_422257.json:
```json
{
    "body": "I added this issue to #29935.\n\nThe idea was that once all parts of Sage are ready for it, the default would be to select a \"random\" random seed.",
    "created_at": "2020-08-24T06:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29725#issuecomment-422257",
    "user": "@kliem"
}
```

I added this issue to #29935.

The idea was that once all parts of Sage are ready for it, the default would be to select a "random" random seed.
