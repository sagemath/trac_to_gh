# Issue 29725: Allow fuzzing of doctests

Issue created by migration from https://trac.sagemath.org/ticket/29962

Original creator: @kliem

Original creation time: 2020-06-24 19:06:29

CC:  slelievre

Keywords: doctests, random

We introduce an option for doctests `--random_seed` that defaults to `0` for now:


```
sage -t --long src/sage/all.py 
...
Doctesting 1 file.
sage -t --long --random_seed=0 src/sage/all.py
    [16 tests, 0.73 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
```


This allows specifying, which random seed shall be used for the doctests.


---

Comment by @kliem created at 2020-06-24 19:17:41

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-06-24 19:17:41

New commits:


---

Comment by git created at 2020-06-24 19:45:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-24 19:47:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-24 19:58:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-07-10 22:17:56

Overall, this looks good to me. The following changes seem to be needed:


```diff
-    sage: subprocess.call(["sage", "-t", "--warn-long", "0", "--random-seed=0", -random_seed.rst"], **kwds)  # long time
+    sage: subprocess.call(["sage", "-t", "--warn-long", "0", "--random-seed=0", "random_seed.rst"], **kwds)  # long time
```



```diff
-  - ``--random_seed[=seed]`` -- random seed for fuzzing doctests
+  - ``--random-seed[=seed]`` -- random seed for fuzzing doctests
```



---

Comment by mkoeppe created at 2020-07-10 23:48:25

The branch adds this to the documentation, which is not true for this ticket:

```
--- a/src/doc/en/developer/doctesting.rst
+++ b/src/doc/en/developer/doctesting.rst
...
+Doctests start from a random seed::
+
+    [kliem@sage sage-9.2]$ sage -t src/sage/doctest/tests/random_seed.rst
...
+    sage -t --warn-long 89.5 --random-seed=112986622569797306072457879734474628454 src/sage/doctest/tests/random_seed.rst
+    **********************************************************************
```



---

Comment by @kliem created at 2020-07-11 05:52:22

New commits:


---

Comment by mkoeppe created at 2020-07-11 06:01:39

From my side this is a positive review - if patchbot is green


---

Comment by @mwageringel created at 2020-07-11 09:01:34

Thanks. This successfully passes ptestlong.


---

Comment by @mwageringel created at 2020-07-11 09:01:34

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-07-11 09:01:58

Thank you.


---

Comment by vbraun created at 2020-07-11 23:22:27

Merge conflict


---

Comment by vbraun created at 2020-07-11 23:22:27

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2020-07-12 17:08:55

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-07-12 17:08:55

`sage -t --long --all` passes for me.
----
New commits:


---

Comment by mkoeppe created at 2020-07-12 17:23:36

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-07-12 18:03:49

Thank you.


---

Comment by vbraun created at 2020-07-19 07:24:18

Resolution: fixed


---

Comment by slelievre created at 2020-08-23 15:34:25

What random seeds are allowed? Any integer?
Of any sign? Arbitrarily large?


---

Comment by @kliem created at 2020-08-23 16:01:21

This is how we will eventually get the random seeds.


```
sage: import sage.misc.randstate as randstate                                   
sage: randstate.set_random_seed()                                               
sage: randstate.initial_seed()                                                  
11032378495085541661748859066830408537
```


At least that's the plan for now. Any random seed that you can feed into `set_random_seed` should work.

(Edit: But I wouldn't be surprised if there are bugs somewhere with some strange random seed. There is no way, you can avoid all of them. But at least you can prepare for rather probable cases.)


---

Comment by slelievre created at 2020-08-23 22:51:41

The `random_seed` docstring says seed "must be coercible to a Python long".

Is that from `-2**127` to `2**127 - 1`?
Or are 32-bit and 64-bit systems different there?

Also isn't "long" a Python 2 concept,
with only "int" existing in Python 3?

Could we document the admissible range in a follow-up ticket, for non-experts like me?


---

Comment by slelievre created at 2020-08-23 22:58:23

And thanks for the work on varying random seeds when testing!


---

Comment by @kliem created at 2020-08-24 06:32:08

I added this issue to #29935.

The idea was that once all parts of Sage are ready for it, the default would be to select a "random" random seed.
