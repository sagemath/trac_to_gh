# Issue 10099: Segfault calling change_ring(RR) on a symbolic polynomial

archive/issues_010099.json:
```json
{
    "body": "Assignee: @burcin\n\nThe following code seems to crash Sage on some (but not all) systems:\n\n```\nsage: a = var('a')\nsage: R.<x>  = a.parent()[]\nsage: (x - a).change_ring(RR) # boom!\n```\n\n\nThis bug was originally spotted when calculating char polys of symbolic matrices:\n\n```\nsage: a,b,c= var('a,b,c')\nsage: mprime = matrix([[01,b+1,2],[a+1,2,1],[2,1,c+1]])\nsage: cp = mprime.charpoly()\nsage: cp.real_roots() # boom!\n```\n\nSee [this sage-devel thread](http://groups.google.co.uk/group/sage-devel/browse_thread/thread/0ea6c973a56191ab/e91868cd98f7fb74).\n\nIssue created by migration from https://trac.sagemath.org/ticket/10100\n\n",
    "created_at": "2010-10-08T10:19:23Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.1",
    "title": "Segfault calling change_ring(RR) on a symbolic polynomial",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10099",
    "user": "https://github.com/loefflerd"
}
```
Assignee: @burcin

The following code seems to crash Sage on some (but not all) systems:

```
sage: a = var('a')
sage: R.<x>  = a.parent()[]
sage: (x - a).change_ring(RR) # boom!
```


This bug was originally spotted when calculating char polys of symbolic matrices:

```
sage: a,b,c= var('a,b,c')
sage: mprime = matrix([[01,b+1,2],[a+1,2,1],[2,1,c+1]])
sage: cp = mprime.charpoly()
sage: cp.real_roots() # boom!
```

See [this sage-devel thread](http://groups.google.co.uk/group/sage-devel/browse_thread/thread/0ea6c973a56191ab/e91868cd98f7fb74).

Issue created by migration from https://trac.sagemath.org/ticket/10100





---

archive/issue_comments_101755.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2010-10-08T10:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101755",
    "user": "https://github.com/loefflerd"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_101756.json:
```json
{
    "body": "FWIW, it crashes on my OpenSolaris machine. I've not looked in detail, but it seems to be something calling mpfr_clear in MPFR. Of course that does **not** mean it is an MPFR bug, but that's where the crash is occuring. \n\n\n```\ndrkirkby@hawk:~/sage-4.6.alpha2$ ./sage -gdb\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\n/export/home/drkirkby/sage-4.6.alpha2/local/bin/sage-ipython\nGNU gdb 6.8\nCopyright (C) 2008 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"i386-pc-solaris2.11\"...\nwarning: Lowest section in /lib/libdl.so.1 is .dynamic at 00000074\nPython 2.6.4 (r264:75706, Oct  6 2010, 11:29:17) \n[GCC 4.5.0] on sunos5\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\nwarning: Lowest section in /lib/libintl.so.1 is .dynamic at 00000074\nwarning: Lowest section in /lib/libpthread.so.1 is .dynamic at 00000074\nsage:  a = var('a')\nsage: R.<x>  = a.parent()[]\nsage: (x - a).change_ring(RR) # boom!\n| Sage Version 4.6.alpha2, Release Date: 2010-09-29                  |\n| Type notebook() for the GUI, and license() for information.        |\nProgram received signal SIGSEGV, Segmentation fault.\n0xfc31aec2 in mpfr_clear ()\n   from /export/home/drkirkby/sage-4.6.alpha2/local/lib//libmpfr.so.1\n```\n",
    "created_at": "2010-10-08T10:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101756",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

FWIW, it crashes on my OpenSolaris machine. I've not looked in detail, but it seems to be something calling mpfr_clear in MPFR. Of course that does **not** mean it is an MPFR bug, but that's where the crash is occuring. 


```
drkirkby@hawk:~/sage-4.6.alpha2$ ./sage -gdb
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
/export/home/drkirkby/sage-4.6.alpha2/local/bin/sage-ipython
GNU gdb 6.8
Copyright (C) 2008 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i386-pc-solaris2.11"...
warning: Lowest section in /lib/libdl.so.1 is .dynamic at 00000074
Python 2.6.4 (r264:75706, Oct  6 2010, 11:29:17) 
[GCC 4.5.0] on sunos5
Type "help", "copyright", "credits" or "license" for more information.
warning: Lowest section in /lib/libintl.so.1 is .dynamic at 00000074
warning: Lowest section in /lib/libpthread.so.1 is .dynamic at 00000074
sage:  a = var('a')
sage: R.<x>  = a.parent()[]
sage: (x - a).change_ring(RR) # boom!
| Sage Version 4.6.alpha2, Release Date: 2010-09-29                  |
| Type notebook() for the GUI, and license() for information.        |
Program received signal SIGSEGV, Segmentation fault.
0xfc31aec2 in mpfr_clear ()
   from /export/home/drkirkby/sage-4.6.alpha2/local/lib//libmpfr.so.1
```




---

archive/issue_comments_101757.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-10-10T18:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101757",
    "user": "https://github.com/mwhansen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_101758.json:
```json
{
    "body": "Attachment [trac_10100.patch](tarball://root/attachments/some-uuid/ticket10100/trac_10100.patch) by @mwhansen created at 2010-10-10 18:47:07",
    "created_at": "2010-10-10T18:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101758",
    "user": "https://github.com/mwhansen"
}
```

Attachment [trac_10100.patch](tarball://root/attachments/some-uuid/ticket10100/trac_10100.patch) by @mwhansen created at 2010-10-10 18:47:07



---

archive/issue_comments_101759.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-05-06T11:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101759",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_101760.json:
```json
{
    "body": "For the record, the bug is that Python might throw an exception in a loop, so there is no guarantee that the whole loop is evaluated. Which is why Mike's fix is the correct one, first loop over all values and `mpfr_init2()` them, then loop again over all values and set their values.\n\nIt would be nicer to apply RAII and keep resource allocation strictly to the `__cinit__()` constructor, but in this case that is challenging because the degree of the polynomial must be computed first. Could be done by factoring out that part into a factory function. But thats already a significant rewrite...",
    "created_at": "2011-05-06T11:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101760",
    "user": "https://github.com/vbraun"
}
```

For the record, the bug is that Python might throw an exception in a loop, so there is no guarantee that the whole loop is evaluated. Which is why Mike's fix is the correct one, first loop over all values and `mpfr_init2()` them, then loop again over all values and set their values.

It would be nicer to apply RAII and keep resource allocation strictly to the `__cinit__()` constructor, but in this case that is challenging because the degree of the polynomial must be computed first. Could be done by factoring out that part into a factory function. But thats already a significant rewrite...



---

archive/issue_comments_101761.json:
```json
{
    "body": "There might need to be some `sig_on()`/`sig_off()` added.",
    "created_at": "2011-05-11T09:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101761",
    "user": "https://github.com/jdemeyer"
}
```

There might need to be some `sig_on()`/`sig_off()` added.



---

archive/issue_comments_101762.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-05-11T12:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101762",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_101763.json:
```json
{
    "body": "To allow Ctrl-C? The constructor takes a list of coefficients, not just a degree. So its not so easy to construct astronomically-sized polynomials. You can, however, pass a generator object that will be expanded into a list.\n\nI'll append a patch that adds `sig_on()` and `sig_off()` around the expansion into a list and the loop that converts to RR. Allocating mpfr memory is comparably quick and sits in-between the two more expensive loops.",
    "created_at": "2011-05-11T12:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101763",
    "user": "https://github.com/vbraun"
}
```

To allow Ctrl-C? The constructor takes a list of coefficients, not just a degree. So its not so easy to construct astronomically-sized polynomials. You can, however, pass a generator object that will be expanded into a list.

I'll append a patch that adds `sig_on()` and `sig_off()` around the expansion into a list and the loop that converts to RR. Allocating mpfr memory is comparably quick and sits in-between the two more expensive loops.



---

archive/issue_comments_101764.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-05-11T12:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101764",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_101765.json:
```json
{
    "body": "Volker, code like\n\n```\ntry:\n    sig_on()\n    raise SomeException\n    sig_off()\nexcept:\n    something()\n```\n\nwill break because you don't call sig_off().  This is probably best handled using try/finally, see [http://boxen.math.washington.edu/home/jdemeyer/doc/developer/coding_in_cython.html#interrupt-and-signal-handling](http://boxen.math.washington.edu/home/jdemeyer/doc/developer/coding_in_cython.html#interrupt-and-signal-handling)",
    "created_at": "2011-05-11T12:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101765",
    "user": "https://github.com/jdemeyer"
}
```

Volker, code like

```
try:
    sig_on()
    raise SomeException
    sig_off()
except:
    something()
```

will break because you don't call sig_off().  This is probably best handled using try/finally, see [http://boxen.math.washington.edu/home/jdemeyer/doc/developer/coding_in_cython.html#interrupt-and-signal-handling](http://boxen.math.washington.edu/home/jdemeyer/doc/developer/coding_in_cython.html#interrupt-and-signal-handling)



---

archive/issue_comments_101766.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-05-11T12:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101766",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_101767.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-05-11T12:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101767",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_101768.json:
```json
{
    "body": "Yes, I also noted that I was too quick. The second block also needs to be wrapped in a try/finally. You sigonoff doctests caught that easily. Updated patch follows...",
    "created_at": "2011-05-11T12:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101768",
    "user": "https://github.com/vbraun"
}
```

Yes, I also noted that I was too quick. The second block also needs to be wrapped in a try/finally. You sigonoff doctests caught that easily. Updated patch follows...



---

archive/issue_comments_101769.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-05-11T12:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101769",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_101770.json:
```json
{
    "body": "Attachment [trac_10100_wrap_sigonoff.patch](tarball://root/attachments/some-uuid/ticket10100/trac_10100_wrap_sigonoff.patch) by @jdemeyer created at 2011-05-17 12:11:04\n\nPositive review, modulo my reviewer patch.",
    "created_at": "2011-05-17T12:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101770",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_10100_wrap_sigonoff.patch](tarball://root/attachments/some-uuid/ticket10100/trac_10100_wrap_sigonoff.patch) by @jdemeyer created at 2011-05-17 12:11:04

Positive review, modulo my reviewer patch.



---

archive/issue_comments_101771.json:
```json
{
    "body": "Attachment [10100_sig_review.patch](tarball://root/attachments/some-uuid/ticket10100/10100_sig_review.patch) by @vbraun created at 2011-05-17 12:23:28\n\nWhy do you want to run the `mpfr2_init()` loop with signals on? If the user manages to press Ctrl-C here then we are almost guaranteed a segfault in the Cython destructor. In fact, the original bug in this ticket was that one could get out of this particular loop by a Python exception.",
    "created_at": "2011-05-17T12:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101771",
    "user": "https://github.com/vbraun"
}
```

Attachment [10100_sig_review.patch](tarball://root/attachments/some-uuid/ticket10100/10100_sig_review.patch) by @vbraun created at 2011-05-17 12:23:28

Why do you want to run the `mpfr2_init()` loop with signals on? If the user manages to press Ctrl-C here then we are almost guaranteed a segfault in the Cython destructor. In fact, the original bug in this ticket was that one could get out of this particular loop by a Python exception.



---

archive/issue_comments_101772.json:
```json
{
    "body": "Alternative patch, apply only this",
    "created_at": "2011-05-17T15:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101772",
    "user": "https://github.com/jdemeyer"
}
```

Alternative patch, apply only this



---

archive/issue_comments_101773.json:
```json
{
    "body": "Attachment [10100_alternative.patch](tarball://root/attachments/some-uuid/ticket10100/10100_alternative.patch) by @jdemeyer created at 2011-05-17 15:16:29\n\nReplying to [comment:11 vbraun]:\n> Why do you want to run the `mpfr2_init()` loop with signals on? If the user manages to press Ctrl-C here then we are almost guaranteed a segfault in the Cython destructor. In fact, the original bug in this ticket was that one could get out of this particular loop by a Python exception.\n\nYou are completely right, but in my opinion this only shows that the original issue was not handled properly.  I attached a new patch which I think is a better solution.",
    "created_at": "2011-05-17T15:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101773",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10100_alternative.patch](tarball://root/attachments/some-uuid/ticket10100/10100_alternative.patch) by @jdemeyer created at 2011-05-17 15:16:29

Replying to [comment:11 vbraun]:
> Why do you want to run the `mpfr2_init()` loop with signals on? If the user manages to press Ctrl-C here then we are almost guaranteed a segfault in the Cython destructor. In fact, the original bug in this ticket was that one could get out of this particular loop by a Python exception.

You are completely right, but in my opinion this only shows that the original issue was not handled properly.  I attached a new patch which I think is a better solution.



---

archive/issue_comments_101774.json:
```json
{
    "body": "I'm not sure that there is any need of being able to interrupt the `mpfr2_init()`-loop, but it certainly can't hurt. Positive review.",
    "created_at": "2011-05-17T15:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101774",
    "user": "https://github.com/vbraun"
}
```

I'm not sure that there is any need of being able to interrupt the `mpfr2_init()`-loop, but it certainly can't hurt. Positive review.



---

archive/issue_comments_101775.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-05-17T15:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101775",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_101776.json:
```json
{
    "body": "Attachment [10100_alternative_after_9944.patch](tarball://root/attachments/some-uuid/ticket10100/10100_alternative_after_9944.patch) by @jdemeyer created at 2011-05-24 10:04:03\n\nPatch [attachment:10100_alternative.patch] rebased to #9944",
    "created_at": "2011-05-24T10:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101776",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10100_alternative_after_9944.patch](tarball://root/attachments/some-uuid/ticket10100/10100_alternative_after_9944.patch) by @jdemeyer created at 2011-05-24 10:04:03

Patch [attachment:10100_alternative.patch] rebased to #9944



---

archive/issue_events_010218.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2011-05-31T17:07:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10099#event-10218"
}
```



---

archive/issue_comments_101777.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-05-31T17:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10099#issuecomment-101777",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
