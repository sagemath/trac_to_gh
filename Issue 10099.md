# Issue 10099: Segfault calling change_ring(RR) on a symbolic polynomial

Issue created by migration from Trac.

Original creator: davidloeffler

Original creation time: 2010-10-08 10:19:23

Assignee: burcin

The following code seems to crash Sage on some (but not all) systems:

```
sage: a = var('a')
sage: R.<x>  = a.parent()[]
sage: (x - a).change_ring(RR) # boom!
```


This bug was originally spotted when calculating char polys of symbolic matrices:

```
sage: a,b,c= var('a,b,c')
sage: mprime = matrix([[01,b+1,2],[a+1,2,1],[2,1,c+1]])
sage: cp = mprime.charpoly()
sage: cp.real_roots() # boom!
```

See [this sage-devel thread](http://groups.google.co.uk/group/sage-devel/browse_thread/thread/0ea6c973a56191ab/e91868cd98f7fb74).


---

Comment by davidloeffler created at 2010-10-08 10:19:37

Changing type from PLEASE CHANGE to defect.


---

Comment by drkirkby created at 2010-10-08 10:46:03

FWIW, it crashes on my OpenSolaris machine. I've not looked in detail, but it seems to be something calling mpfr_clear in MPFR. Of course that does *not* mean it is an MPFR bug, but that's where the crash is occuring. 


```
drkirkby`@`hawk:~/sage-4.6.alpha2$ ./sage -gdb
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
/export/home/drkirkby/sage-4.6.alpha2/local/bin/sage-ipython
GNU gdb 6.8
Copyright (C) 2008 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i386-pc-solaris2.11"...
warning: Lowest section in /lib/libdl.so.1 is .dynamic at 00000074
Python 2.6.4 (r264:75706, Oct  6 2010, 11:29:17) 
[GCC 4.5.0] on sunos5
Type "help", "copyright", "credits" or "license" for more information.
warning: Lowest section in /lib/libintl.so.1 is .dynamic at 00000074
warning: Lowest section in /lib/libpthread.so.1 is .dynamic at 00000074
sage:  a = var('a')
sage: R.<x>  = a.parent()[]
sage: (x - a).change_ring(RR) # boom!
| Sage Version 4.6.alpha2, Release Date: 2010-09-29                  |
| Type notebook() for the GUI, and license() for information.        |
Program received signal SIGSEGV, Segmentation fault.
0xfc31aec2 in mpfr_clear ()
   from /export/home/drkirkby/sage-4.6.alpha2/local/lib//libmpfr.so.1
```



---

Comment by mhansen created at 2010-10-10 18:47:07

Changing status from new to needs_review.


---

Attachment


---

Comment by vbraun created at 2011-05-06 11:09:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2011-05-06 11:09:45

For the record, the bug is that Python might throw an exception in a loop, so there is no guarantee that the whole loop is evaluated. Which is why Mike's fix is the correct one, first loop over all values and `mpfr_init2()` them, then loop again over all values and set their values.

It would be nicer to apply RAII and keep resource allocation strictly to the `__cinit__()` constructor, but in this case that is challenging because the degree of the polynomial must be computed first. Could be done by factoring out that part into a factory function. But thats already a significant rewrite...


---

Comment by jdemeyer created at 2011-05-11 09:31:40

There might need to be some `sig_on()`/`sig_off()` added.


---

Comment by vbraun created at 2011-05-11 12:03:00

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2011-05-11 12:03:00

To allow Ctrl-C? The constructor takes a list of coefficients, not just a degree. So its not so easy to construct astronomically-sized polynomials. You can, however, pass a generator object that will be expanded into a list.

I'll append a patch that adds `sig_on()` and `sig_off()` around the expansion into a list and the loop that converts to RR. Allocating mpfr memory is comparably quick and sits in-between the two more expensive loops.


---

Comment by vbraun created at 2011-05-11 12:06:02

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-05-11 12:36:26

Volker, code like

```
try:
    sig_on()
    raise SomeException
    sig_off()
except:
    something()
```

will break because you don't call sig_off().  This is probably best handled using try/finally, see [http://boxen.math.washington.edu/home/jdemeyer/doc/developer/coding_in_cython.html#interrupt-and-signal-handling](http://boxen.math.washington.edu/home/jdemeyer/doc/developer/coding_in_cython.html#interrupt-and-signal-handling)


---

Comment by jdemeyer created at 2011-05-11 12:36:26

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2011-05-11 12:46:40

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2011-05-11 12:46:40

Yes, I also noted that I was too quick. The second block also needs to be wrapped in a try/finally. You sigonoff doctests caught that easily. Updated patch follows...


---

Comment by vbraun created at 2011-05-11 12:46:55

Updated patch


---

Attachment

Positive review, modulo my reviewer patch.


---

Attachment

Why do you want to run the `mpfr2_init()` loop with signals on? If the user manages to press Ctrl-C here then we are almost guaranteed a segfault in the Cython destructor. In fact, the original bug in this ticket was that one could get out of this particular loop by a Python exception.


---

Comment by jdemeyer created at 2011-05-17 15:14:46

Alternative patch, apply only this


---

Attachment

Replying to [comment:11 vbraun]:
> Why do you want to run the `mpfr2_init()` loop with signals on? If the user manages to press Ctrl-C here then we are almost guaranteed a segfault in the Cython destructor. In fact, the original bug in this ticket was that one could get out of this particular loop by a Python exception.

You are completely right, but in my opinion this only shows that the original issue was not handled properly.  I attached a new patch which I think is a better solution.


---

Comment by vbraun created at 2011-05-17 15:22:06

I'm not sure that there is any need of being able to interrupt the `mpfr2_init()`-loop, but it certainly can't hurt. Positive review.


---

Comment by vbraun created at 2011-05-17 15:22:06

Changing status from needs_review to positive_review.


---

Attachment

Patch [attachment:10100_alternative.patch] rebased to #9944


---

Comment by jdemeyer created at 2011-05-31 17:07:19

Resolution: fixed
