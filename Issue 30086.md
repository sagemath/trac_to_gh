# Issue 30086: Optimize degree_iterator and introduce other degree functions

Issue created by migration from https://trac.sagemath.org/ticket/30323

Original creator: @sgrosser

Original creation time: 2020-08-09 20:34:11

CC:  tscrim dcoudert

Keywords: gsoc2020 graph degree

In `degree_iterator()` of generic_graph.py, there are unoptimal usages of lambdas which should be removed. 

As well, we introduce two new functions based on graph degree: `vertex_with_degree(degree)` in generic_graph.py and `is_path()` in graph.py 


---

Comment by tscrim created at 2020-08-09 23:19:13

I believe you could rewrite the `vertices_with_degree()` simply as

```python
return [v for v,d in self.degree_iterator(labels=True) if d == degree]
```


I would write `is_path()` as

```python
        if len(self) == 1:  # Special case
            return not self.has_loops()
        deg_one_counter = 0
        for v in self:
            deg = self._backend.degree(v, False)
            if deg == 1:
                deg_one_counter += 1
                if deg_one_counter > 2:
                    return False

            elif deg != 2:
                return False
        return deg_one_counter == 2
```

----
New commits:


---

Comment by @sgrosser created at 2020-08-09 23:28:36

For `is_path()`, don't you have to check if it is connected? You have could a disjoint union of a path and a cycle. As it is above, this would return true for that case. 

Replying to [comment:2 tscrim]:
> I believe you could rewrite the `vertices_with_degree()` simply as
> {{{#!python
> return [v for v,d in self.degree_iterator(labels=True) if d == degree]
> }}}
> 
> I would write `is_path()` as
> {{{#!python
>         if len(self) == 1:  # Special case
>             return not self.has_loops()
>         deg_one_counter = 0
>         for v in self:
>             deg = self._backend.degree(v, False)
>             if deg == 1:
>                 deg_one_counter += 1
>                 if deg_one_counter > 2:
>                     return False
> 
>             elif deg != 2:
>                 return False
>         return deg_one_counter == 2
> }}}
> ----
> New commits:
> ||[f5aadab](https://git.sagemath.org/sage.git/commit?id=f5aadaba8843615249b6a39231b0d57fa85e395a)||`changed degree_iterator and added vertices_with_degree and is_path`||


---

Comment by tscrim created at 2020-08-09 23:32:42

Ah, right. Then please keep that portion. However, note that we only need to check if `deg_one_counter > 2` if it changes.

Please also add tests for the disjoint union of a path and a cycle, a single vertex (with and without a loop), and a tree.


---

Comment by dcoudert created at 2020-08-10 10:53:02

Hello,

this ticket addresses 3 different issues that could each deserve a specific ticket.

1. the use of lambdas in `degree_iterator`. The proposed solution is good.

2. A method to extract the subset of vertices with a given degree. We have several places in the graph module where we use the one line solution of #comment:2 and a unified method could improve the readability of the code. However, I think it would be more interesting to add a filter option to `vertices` and `vertex_iterator` (somehow already suggested in #1048). This would offer more functionalities without the addition of another method.

3. the `is_path` method. This is a special case of `is_tree` that we need (we also need a method for checking if a subgraph is an (induced) path, but this is another story). To improve the current method, you should:
 * fix definitions for the empty graph and the graph of order 1
 * add tests for graphs with 0 or 1 vertex
 * check that `G.order() == G.size() + 1`. A path is a tree. Actually, this also handle the case of 1 vertex graph.
 * select for root of the DFS: `root = next(G.vertex_iterator())`. No need to build first the full list of vertices
 * use an extra variable to store the degree of v
 
We could later add a similar method to check is a digraph is a directed path.


---

Comment by git created at 2020-08-16 20:21:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-16 20:24:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-08-17 07:51:31

- instead of parameter `degree`, we could have a more general solution like:

```
        - ``property`` -- function (default: ``None``); a function that inputs
          a vertex and outputs a boolean value, i.e., a vertex ``v`` is kept if
          ``property(v) == True``
...
        if property is not None:
            for v in self._backend.iterator_verts(vertices):
                if property(v):
                    yield v
            return
```



- in `is_path`:

```diff
-        Return true if the graph is a path (has degree sequence of n-2 2's and two 1's).
+        Check whether ``self`` is a path.
+
+        A connected graph of order `n \geq 2` is a path if it is a tree (see :meth:`is_tree`)
+        with `n-2` vertices of degree 2 and two of degree 1.
+        By convention, a graph of order 1 without loops is a path, but the empty graph is not a path.
```

  the link to method `is_tree` might not be correct.

- may be better like that ?

```diff
-            return True if order else False
+            return order == 1
```



---

Comment by git created at 2020-08-17 18:14:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-17 18:29:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sgrosser created at 2020-08-17 18:31:18

Tests seem to be failing with `vertex_property` being called even if it is `None`.


---

Comment by dcoudert created at 2020-08-17 19:46:31

of course, you have to update the d'octets to the new input parameter of method `vertex_iterator`.


---

Comment by git created at 2020-08-17 20:10:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sgrosser created at 2020-08-17 20:14:38

Tests are still failing even with this change.

`Unhandled SIGABRT: An abort() occurred. This probably occurred because a *compiled* module has a bug in it and is not properly wrapped with sig_on(), sig_off(). Python will now terminate.`

Building Sage seems just fine, and running the tests individually works. I don't think I forgot any other doctests to change.


---

Comment by tscrim created at 2020-08-17 22:47:32

I am -1 on only having `vertex_property` because then it becomes much slower to filter by degrees with all of those extra Python lambda function calls. It is also more work for the user for something that is used with some frequency. I think we should allow for certain shortcuts.


---

Comment by git created at 2020-08-17 23:28:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-08-18 07:47:22

Replying to [comment:15 tscrim]:
> I am -1 on only having `vertex_property` because then it becomes much slower to filter by degrees with all of those extra Python lambda function calls. It is also more work for the user for something that is used with some frequency. I think we should allow for certain shortcuts.

We already have the "vertices" shortcut (I'm not sure it's used), so why not having another shortcut.


---

Comment by tscrim created at 2020-08-18 23:31:20

Replying to [comment:17 dcoudert]:
> Replying to [comment:15 tscrim]:
> > I am -1 on only having `vertex_property` because then it becomes much slower to filter by degrees with all of those extra Python lambda function calls. It is also more work for the user for something that is used with some frequency. I think we should allow for certain shortcuts.
> 
> We already have the "vertices" shortcut (I'm not sure it's used), so why not having another shortcut. 

Sorry, I am not quite sure I understand. Do you mean you are okay with adding another shortcut for `degree`?


---

Comment by dcoudert created at 2020-08-19 08:34:05

Yes. However, it should be clear that this shortcut is for equality with given value.


---

Comment by @sgrosser created at 2020-08-20 19:04:21

Alright, I'll make the degree argument with some clear docs on its usage


---

Comment by git created at 2020-08-22 16:46:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-08-22 16:57:58

please make sure that all comments are aligned in 80 columns mode.


---

Comment by git created at 2020-08-22 16:58:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-08-23 08:30:36

I did also like David's suggestion of having a `vertex_property` method, which would work in conjunction with the `degree` input. I was proposing just adding that to the previous version you had at the time.


---

Comment by git created at 2020-08-24 04:22:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 04:30:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sgrosser created at 2020-08-24 04:32:09

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-08-24 05:28:28

I am a little worried that `yield from [a list]` will needlessly create a list and increase the memory usage. I think you can just do `yield from (a generator)`.


---

Comment by dcoudert created at 2020-08-24 07:34:03

I think the right solution here is to use standard for loops.


---

Comment by git created at 2020-08-24 13:17:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-08-24 13:50:02

for the last case in `vertex_iterator`, have you tried `return self._backend.iterator_verts(vertices)` or `yield from self._backend.iterator_verts(vertices)` ?


---

Comment by @sgrosser created at 2020-08-24 14:10:14

I don't think one should mix yielding and returning, but I could definitely switch it to `yield from`


---

Comment by dcoudert created at 2020-08-24 14:15:07

I expect it to be better than another loop, but I may be wrong ;)


---

Comment by @sgrosser created at 2020-08-24 14:20:28

Using `return` causes a bunch of crashing; Python doesn't seem to like putting returns and yields together. Updated to `yield from`!


---

Comment by git created at 2020-08-24 14:20:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-08-24 14:35:11

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2020-08-24 14:35:11

LGTM.


---

Comment by vbraun created at 2020-08-30 08:38:36

Resolution: fixed
