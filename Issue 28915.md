# Issue 28915: Optional package meataxe doesn't build on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/29152

Original creator: embray

Original creation time: 2020-02-04 12:51:26

CC:  ​simonking mmarco dimpase mjo arojas fbissey slelievre jhpalmieri vbraun

The error occurs when linking:


```
[meataxe-1.0.p0] /usr/bin/bash ../libtool  --tag=CC   --mode=link gcc  -g -O2  -L/opt/sagemath-9.0/local/lib -Wl,-rpath,/opt/sagemath-9.0/local/lib  -o libmtx.la -rpath /opt/sagemath-9.0/local/lib args.lo berlekmp.lo bsand.lo bscore.lo bsdup.lo bsissub.lo bsmatch.lo bsminus.lo bsop.lo bsor.lo bsprint.lo bsread.lo bswrite.lo cfinfo.lo charpol.lo chbasis.lo error.lo ffio.lo fpcore.lo fpdup.lo fpmul.lo fpmul2.lo fpprint.lo gcd.lo genseed.lo grmaprow.lo grmatcore.lo grtable.lo homcomp.lo imatcore.lo imatread.lo imatwrite.lo init.lo intio.lo issub.lo isisom.lo kernel-0.lo ldiag.lo maddmul.lo mat2vec.lo matadd.lo matclean.lo matcmp.lo maketabF.lo matcopy.lo matcore.lo matcut.lo matdup.lo matech.lo matid.lo matins.lo matinv.lo matmul.lo matnull.lo matorder.lo matpivot.lo matprint.lo matpwr.lo matread.lo mattr.lo mattrace.lo matwrite.lo message.lo mfcore.lo mfread.lo mfreadlong.lo mfwrite.lo mfwritelong.lo minpol.lo mkendo.lo mmulscal.lo mraddgen.lo mrcore.lo mrread.lo mrtranspose.lo mrwrite.lo msclean.lo mscore.lo mtensor.lo mtxobj.lo os.lo permcmp.lo permcore.lo permdup.lo perminv.lo permmul.lo permorder.lo permprint.lo permpwr.lo permread.lo permwrite.lo poladd.lo polcmp.lo polcore.lo polderive.lo poldiv.lo poldup.lo polgcd.lo polmul.lo polprint.lo polread.lo polwrite.lo quotient.lo random.lo rdcfgen.lo saction.lo setcore.lo setinsert.lo settest.lo spinup.lo spinup2.lo split.lo stabpwr.lo stfcore.lo stfread.lo stfwrite.lo string.lo sumint.lo temap.lo tkinfo.lo vec2mat.lo wgen.lo window.lo zcleanrow.lo zcmprow.lo zgap.lo zpermrow.lo zzz2.lo
[meataxe-1.0.p0] libtool:   error: can't build x86_64-unknown-cygwin shared library unless -no-undefined is specified
```


This is a common issue especially when using libtool to link Windows DLLs and should hopefully be straightforward to fix.


---

Comment by embray created at 2020-02-04 12:51:33

Set assignee to embray.


---

Comment by mkoeppe created at 2020-05-04 17:30:19

The failure can be seen at https://github.com/mkoeppe/sage/runs/641394565


---

Comment by mkoeppe created at 2020-05-04 17:30:19

Changing component from packages: optional to porting: Cygwin.


---

Comment by mkoeppe created at 2020-09-11 18:03:19

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-09-11 18:25:27

Cc'ing mmarco re libbraiding


---

Comment by mkoeppe created at 2020-09-11 18:28:33

cc'ing dimpase re cliquer, also reported at https://github.com/dimpase/autocliquer/issues/4


---

Comment by mkoeppe created at 2020-09-11 18:29:55

Upstream link in `build/pkgs/rw/SPKG.rst` no longer works


---

Comment by mkoeppe created at 2020-09-11 18:31:52

Cc'ing gentoo, arch people to see if new `rw` upstream is known


---

Comment by arojas created at 2020-09-11 18:45:25

I'm getting it from  https://sourceforge.net/projects/rankwidth/, but I don't know if there's anybody reading tickets there (there are none filed so far)


---

Comment by fbissey created at 2020-09-11 19:51:24

Replying to [comment:10 arojas]:
> I'm getting it from  https://sourceforge.net/projects/rankwidth/, but I don't know if there's anybody reading tickets there (there are none filed so far)

Same here in Gentoo https://packages.gentoo.org/packages/sci-mathematics/rw


---

Comment by mjo created at 2020-09-11 20:12:15

What's wrong with rw upstream? The program is more or less "complete," so I wouldn't expect much activity. Last time (a few years ago), we just emailed the guy to ask about contributing an autotools build system.


---

Comment by mkoeppe created at 2020-09-11 20:28:08

Replying to [comment:12 mjo]:
> What's wrong with rw upstream? 
See ticket description
----
New commits:


---

Comment by mmarco created at 2020-09-12 16:02:02

I created a new release for libbraiding:

https://github.com/miguelmarco/libbraiding/releases/tag/1.1

Should I also update the sage package?

IIRC, there is a new way to upload the tarball. Isn't it?


---

Comment by mkoeppe created at 2020-09-12 16:57:16

Replying to [comment:15 mmarco]:
> I created a new release for libbraiding:
> 
> https://github.com/miguelmarco/libbraiding/releases/tag/1.1

Thanks a lot!

> Should I also update the sage package?

Yes please

> IIRC, there is a new way to upload the tarball. Isn't it?

No need to upload, but please add `upstream_url` as explained in https://wiki.sagemath.org/ReleaseTours/sage-9.1#For_developers-1


---

Comment by mkoeppe created at 2020-09-12 17:48:59

New commits:


---

Comment by mkoeppe created at 2020-09-12 23:50:56

Fix for meataxe at https://github.com/simon-king-jena/SharedMeatAxe/pull/1
----
New commits:


---

Comment by mkoeppe created at 2020-09-13 00:25:53

Replying to [comment:6 mkoeppe]:
> cc'ing dimpase re cliquer, also reported at https://github.com/dimpase/autocliquer/issues/4

PR https://github.com/dimpase/autocliquer/pull/5


---

Comment by mkoeppe created at 2020-09-13 00:57:17

PR for rw: https://sourceforge.net/p/rankwidth/tickets/1/


---

Comment by mkoeppe created at 2020-09-13 01:32:50

Looks like the singular gitfan issue may be fixed by upstream commit 2617fca625d047a0b9890e6ffae1c5f8fe755aad


---

Comment by mjo created at 2020-09-13 01:43:44

The `-no-undefined` is only needed when building a shared library, so the flag can be appended in e.g.


```
libfoo_la_LDFLAGS = -no-undefined
```


rather than the global


```
AM_LDFLAGS=-no-undefined
```


that will affect all link operations (including executables). It probably doesn't hurt much, but I remember vaguely that `--as-needed` was nicer than `--no-undefined` if you were going to apply it globally.

I also think most projects should have `LT_INIT([disable-static])` in configure.ac these days, to disable the static libraries by default. They can still be enabled with `--enable-static`, but for most people they're a waste of time/space.


---

Comment by mjo created at 2020-09-13 01:52:56

Putting back the description I clobbered...


---

Comment by mkoeppe created at 2020-09-13 02:02:50

Replying to [comment:26 mjo]:
> The `-no-undefined` is only needed when building a shared library, so the flag can be appended in e.g.
> 
> {{{
> libfoo_la_LDFLAGS = -no-undefined
> }}}
> 
> rather than the global
> 
> {{{
> AM_LDFLAGS=-no-undefined
> }}}
> 
> that will affect all link operations 

I agree, that would be a little bit cleaner. But I don't think it's worth going back for this


---

Comment by mkoeppe created at 2020-09-13 02:04:45

Replying to [comment:26 mjo]:
> I also think most projects should have `LT_INIT([disable-static])` in configure.ac these days, to disable the static libraries by default. They can still be enabled with `--enable-static`, but for most people they're a waste of time/space.

I agree, but I want to keep the upstream patches minimal. We have #28890 for the task of sending `--disable-static` to all our packages


---

Comment by dimpase created at 2020-09-13 08:38:05

Replying to [comment:6 mkoeppe]:
> cc'ing dimpase re cliquer, also reported at https://github.com/dimpase/autocliquer/issues/4
> 
OK, done and dusted, thanks for the PR, see
https://github.com/dimpase/autocliquer/releases/download/v1.22/cliquer-1.22.tar.gz


---

Comment by git created at 2020-09-13 15:57:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-13 16:27:07

could you also add

```diff
--- a/build/pkgs/cliquer/SPKG.rst
+++ b/build/pkgs/cliquer/SPKG.rst
@@ -5,8 +5,8 @@ Description
 -----------
 
 Cliquer is a set of C routines for finding cliques in an arbitrary
-weighted graph. It uses an exact branch-and-bound algorithm recently
-developed by Patr Ostergard.
+weighted graph. It uses an exact branch-and-bound algorithm
+developed by Patric Östergård.
 
 License
 -------
@@ -28,4 +28,5 @@ Dependencies
 Patches
 -------
 
--  autotoolized - see https://github.com/dimpase/autocliquer
+-  minor config updates (v1.22)
+-  autotoolized - see https://github.com/dimpase/autocliquer (v1.21)
```



---

Comment by git created at 2020-09-13 16:29:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-14 11:56:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-02 03:00:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-02 03:00:50

Changing status from new to needs_review.


---

Comment by SimonKing created at 2020-10-02 08:36:04

I am about to release a new minor version of SharedMeatAxe based on Matthias' suggestions, and my plan was to upgrade it in Sage now. But since it is "needs review" already: Did Matthias did the meataxe upgrade in Sage already?


---

Comment by SimonKing created at 2020-10-02 09:39:39

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2020-10-02 09:39:39

Aparently the upgrade of meataxe hasn't been done yet. So, it should be "needs work".


---

Comment by SimonKing created at 2020-10-02 09:58:44

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2020-10-02 09:58:44

SharedMeatAxe is upgraded as well. See https://github.com/simon-king-jena/SharedMeatAxe/releases/tag/v1.0.1

I changed the compression from gz to bz2, since the latter gives a smaller tar ball. Self tests pass, I'm running "make test" now.
----
New commits:


---

Comment by SimonKing created at 2020-10-02 13:04:00

Tests pass for me. However, the point of this ticket is to fix things on cygwin, which I'm not using.

Hence, no positive review.

A question: Is it still the case that the issues are "Reported upstream. No feedback yet.", or can this be changed to "Fixed upstream"?


---

Comment by mkoeppe created at 2020-10-02 18:29:24

Thanks very much, Simon. Could you add an `upstream_url` field to `checksums.ini` please (as explained in https://wiki.sagemath.org/ReleaseTours/sage-9.1#For_developers-1)


---

Comment by git created at 2020-10-02 18:37:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2020-10-02 18:38:29

Hope that upstream_url for SharedMeatAxe is fine.


---

Comment by SimonKing created at 2020-10-03 19:24:52

Replying to [comment:45 mkoeppe]:

You added a URL as reviewer. Is that intended?

Actually it is not clear to me what is stated there. Do I understand correctly that tests on different versions of Cygwin pass, except "cygwin-stage-ii-a (standard)"? And the failed package in this Cygwin version is scipy?


---

Comment by mkoeppe created at 2020-10-03 19:35:22

Replying to [comment:46 SimonKing]:
> Replying to [comment:45 mkoeppe]:
> 
> You added a URL as reviewer. Is that intended?

Yes, it's a trick that I have been using recently. The URL shows in ticket lists such as https://trac.sagemath.org/report/92?asc=1&page=1 and this reminds me (or other developers) to inspect these automatic builds when they are done.

They will be replaced by actual reviewer names when ready.

> Actually it is not clear to me what is stated there. Do I understand correctly that tests on different versions of Cygwin pass, except "cygwin-stage-ii-a (standard)"? And the failed package in this Cygwin version is scipy?

The build on Cygwin takes very long because of various overheads compared to a build on Linux. On GH Actions there is a time limit of 6 hours per job. Therefore I have split the build into several jobs ("stages"), some of which run in parallel. The linked build https://github.com/mkoeppe/sage/actions/runs/285244461 is the `cygwin-standard` build, which means that I install binary packages from the Cygwin distribution first and then start the build of Sage.

`stage-i-a` and `stage-i-b` ran in parallel and succeeded. What they install in `SAGE_LOCAL` is carried forward to `stage-ii`. The 5 jobs `stage-ii-a` to `stage-ii-e` all ran in parallel, building various packages. 

As you observed, `stage-ii-a` failed because of `scipy`. This is a bug unrelated to the present ticket; it is tracked in #30643. 
Unfortunately this bug blocks the following stages (`stage-iii` would go on to build the Sage library), and so because of this we cannot really check that the current ticket is working correctly.


---

Comment by SimonKing created at 2020-10-03 20:08:34

Replying to [comment:47 mkoeppe]:
> Unfortunately this bug blocks the following stages (`stage-iii` would go on to build the Sage library), and so because of this we cannot really check that the current ticket is working correctly.

We cannot test automatically (on github), but a developer with a cygwin machine certainly could...


---

Comment by mkoeppe created at 2020-10-04 20:43:57

Replying to [comment:48 SimonKing]:
> We cannot test automatically (on github), but a developer with a cygwin machine certainly could...

We seem to be in short supply of these...

I have modified the CI script so that the scipy failure does not stop the whole build.

The resulting build logs (https://github.com/mkoeppe/sage/suites/1285136303/artifacts/20016238) show that `cliquer`, `giac`, `meataxe`, and `rw`, i.e., all packages mentioned in the ticket description except for `libbraiding` (for which the branch contains an update) and `singular` (for which the branch does not contain a change) are OK now. 
Some optional packages were not built previously. In total, we now have the following remaining issues:

```
egret:~/Downloads/logs-commit-e41329adfa1f1e69653ba127d6460d2bd7aaaf00-cygwin-standard$ grep "undefined symbols not allowed" pkgs/*
pkgs/barvinok-0.41.1.log:libtool: warning: undefined symbols not allowed in x86_64-unknown-cygwin shared libraries; building static only
pkgs/e_antic-0.1.8.log:libtool: warning: undefined symbols not allowed in x86_64-pc-cygwin shared libraries; building static only
pkgs/isl-0.20.log:libtool: warning: undefined symbols not allowed in x86_64-unknown-cygwin shared libraries; building static only
pkgs/libbraiding-1.1.log:libtool: warning: undefined symbols not allowed in x86_64-pc-cygwin shared libraries; building static only
pkgs/polylib-5.22.5.log:libtool: link: warning: undefined symbols not allowed in x86_64-unknown-cygwin shared libraries
pkgs/singular-4.1.1p2.p0.log:libtool: warning: undefined symbols not allowed in x86_64-unknown-cy(base) eg(ba(base) egr(ba(base) egret(ba(base) (base)(base)(bas(b(bas(base)(((b((
```

----
New commits:


---

Comment by mkoeppe created at 2020-10-22 17:39:25

Let's get this in so that other tickets can use it as a dependency.

Follow up for the remaining issues in #30814.


---

Comment by mkoeppe created at 2020-11-10 19:58:27

Needs review


---

Comment by dimpase created at 2020-11-10 21:56:06

there seems to be some problem with building of scipy

```
 In file included from /usr/include/sys/config.h:5,
                   from /usr/include/_ansi.h:11,
                   from /usr/include/sys/reent.h:13,
                   from /usr/include/math.h:5,
                   from /usr/lib/gcc/x86_64-pc-cygwin/10/include/c++/cmath:45,
                   from scipy/spatial/ckdtree/src/query.cxx:1:
  /usr/include/sys/features.h:255: note: this is the location of the previous definition
    255 | #define __BSD_VISIBLE  0
        |
  In file included from /cygdrive/d/a/sage/sage/local/include/python3.8/pyport.h:219,
                   from /cygdrive/d/a/sage/sage/local/include/python3.8/Python.h:63,
                   from /cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include/numpy/npy_common.h:11,
                   from scipy/spatial/ckdtree/src/ckdtree_decl.h:10,
                   from scipy/spatial/ckdtree/src/query.cxx:13:
  /usr/include/sys/time.h:106:34: error: 'u_int' has not been declared
    106 | bintime_mul(struct bintime *_bt, u_int _x)
        |                                  ^~~~~
  g++: scipy/spatial/ckdtree/src/build.cxx
```



---

Comment by git created at 2020-12-10 03:45:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 03:47:04

Replying to [comment:56 dimpase]:
> there seems to be some problem with building of scipy
> {{{
>   /usr/include/sys/time.h:106:34: error: 'u_int' has not been declared
> }}}
Probably fixed in #30643


---

Comment by git created at 2020-12-10 03:52:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-19 18:25:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-19 19:07:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-19 19:10:04

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-19 19:57:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-29 19:21:03

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-02-01 21:01:25

Let's please get this in.


---

Comment by dimpase created at 2021-02-02 16:17:25

It still doesn't fix all the Cygwin things, no? Anyway, LGTM.


---

Comment by dimpase created at 2021-02-02 16:17:25

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-02-02 17:35:04

Thank you!

Follow up for the remaining issues in #30814.


---

Comment by git created at 2021-02-07 20:44:59

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-02-07 20:44:59

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-02-07 20:45:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-01 00:21:26

Resolution: fixed
