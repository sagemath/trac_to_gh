# Issue 31140: ./configure --enable-editable

Issue created by migration from https://trac.sagemath.org/ticket/31377

Original creator: mkoeppe

Original creation time: 2021-02-10 20:34:37

CC:  @tobiasdiez jhpalmieri chapoton vdelecroix isuruf @kliem tscrim

This configure switch will install sagelib in "develop" ("editable", "in-place") mode instead of using the traditional incremental build system.

This will clutter the source directory with build artifacts (which are `.gitignore`'d, of course) but it has the benefit that for changes to Python files, one does not need to run `./sage -b`; restarting Sage is enough.

It may also have benefits in certain develop environments that get confused by sagelib's nonstandard build system.

This ticket is based on #30371, which developed a version of `setup.py` suitable for the in-place build. This version is `src/setup.py` and distinct from `build/pkgs/sagelib/src/setup.py`.
The configure switch switches to this version of the build system.


---

Comment by git created at 2021-02-10 21:20:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-10 21:42:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-10 22:08:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-10 23:12:13

This almost works for me, except for some errors building modules:

```
[sagelib-9.3.beta7]     gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -Isage/libs/ntl -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/cysignals -Isage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src -I/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c sage/libs/ntl/ntl_ZZ.cpp -o build/temp.macosx-10.15-x86_64-3.9/sage/libs/ntl/ntl_ZZ.o
[sagelib-9.3.beta7]     In file included from sage/libs/ntl/error.cpp:1283:
[sagelib-9.3.beta7]     ../local/include/NTL/tools.h:1064:1: error: unknown type name 'constexpr'
[sagelib-9.3.beta7]     constexpr bool Relocate_aux_has_trivial_copy(T*)
[sagelib-9.3.beta7]     ^
```


This is probably coming from the fact that the C++ std options that `sage_build_cython.create_extension` uses are not used by the new build system.


---

Comment by git created at 2021-02-11 04:17:00

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-02-11 04:19:01

I have merged #31365, which adds directives to files using NTL; and added a few more distutils directives so that things don't depend so much on the code in `sage_build_cython.create_extension`.


---

Comment by mkoeppe created at 2021-02-11 04:19:01

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-02-11 05:54:17

This seems to reasonably work well here on macOS. There are a small number of doctest failures.

```
sage -t --random-seed=0 src/sage/misc/sagedoc.py  # 2 doctests failed
sage -t --random-seed=0 src/sage/misc/sageinspect.py  # 13 doctests failed
sage -t --random-seed=0 src/sage/repl/interpreter.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/categories/primer.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/repl/ipython_tests.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/sets/set_from_iterator.py  # 2 doctests failed
sage -t --random-seed=0 src/sage/interacts/debugger.py  # 2 doctests failed
sage -t --random-seed=0 src/sage/misc/lazy_attribute.pyx  # 1 doctest failed
sage -t --random-seed=0 src/sage/misc/nested_class.pyx  # 1 doctest failed
sage -t --random-seed=0 src/sage/structure/dynamic_class.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/all.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/misc/edit_module.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/cpython/dict_del_by_value.pyx  # 2 doctests failed
sage -t --random-seed=0 src/sage/graphs/graph_decompositions/tree_decomposition.pyx  # 35 doctests failed
```

The last one is due to the fact that in the editable install all `.pyx` files, even when the modules are not compiled, are available and used for doctesting. 

This will need a new solution to suppress the doctests of such modules - see #30778 (`sage.doctest.control`: Exclude doctests in files from non-installed distributions).


---

Comment by git created at 2021-02-11 07:26:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-02-11 08:12:28

please stop adding me in cc


---

Comment by @tobiasdiez created at 2021-02-11 21:25:41

So how does one test this?


---

Comment by mkoeppe created at 2021-02-11 21:43:46

I've added quick instructions to the ticket description


---

Comment by mkoeppe created at 2021-02-12 16:20:57

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-02-12 17:47:32

The installation of the Jupyter kernel is missing - done by `sage_setup.command.sage_install`


---

Comment by mkoeppe created at 2021-02-12 19:10:53

Replying to [comment:13 mkoeppe]:
> This seems to reasonably work well here on macOS. There are a small number of doctest failures.
> {{{
> ...
> sage -t --random-seed=0 src/sage/graphs/graph_decompositions/tree_decomposition.pyx  # 35 doctests failed
> }}}
> The last one is due to the fact that in the editable install all `.pyx` files, even when the modules are not compiled, are available and used for doctesting. 

Wrong guess, this is actually #31389.


---

Comment by git created at 2021-02-12 19:23:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-12 22:14:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-13 00:30:05

``sage.misc.sageinspect`` is broken in an editable build, which causes the docbuild to fail.


---

Comment by mkoeppe created at 2021-02-13 00:30:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-02-13 01:20:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-13 02:02:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-13 02:02:55

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-02-13 02:09:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-13 02:10:31

Now the documentation builds OK and also `make ptest` is fine.


---

Comment by @tobiasdiez created at 2021-02-13 09:24:27

Can you please include the most recent version of setup.py from #30371. Thanks!


---

Comment by @tobiasdiez created at 2021-02-13 09:24:27

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-02-13 18:24:32

The changes there conflict with the changes done and tested here already.


---

Comment by mkoeppe created at 2021-02-13 18:24:32

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-02-13 18:39:18

(Let's please get this in - unless there are problems on this ticket that need solving here. Otherwise please merge this branch into #30371, resolving the conflicts, and let me know)


---

Comment by @tobiasdiez created at 2021-02-13 18:50:38

Replying to [comment:35 mkoeppe]:
> The changes there conflict with the changes done and tested here already.

What conflicts do you mean?
I was referring to the improvements to this code:

```
+# Exclude a few files if the corresponding distribution is not loaded
+optional_packages = ['mcqd', 'bliss', 'tdlib', 'primecount',
+                     'coxeter3', 'fes', 'sirocco', 'meataxe']
+not_installed_packages = [package for package in optional_packages
+                          if not is_package_installed_and_updated(package)]
+
+distributions_to_exclude = [f"sage-{pkg}"
+                            for pkg in not_installed_packages]
+files_to_exclude = filter_cython_sources(SAGE_SRC, distributions_to_exclude)
+
+log.debug(f"files_to_exclude = {files_to_exclude}")
+
+python_packages = find_namespace_packages(where=SAGE_SRC, exclude=['bin', 'doc'])
+log.debug(f"python_packages = {python_packages}")
+
+log.info(f"Discovered Python/Cython sources, time: {(time.time() - t):.2f} seconds.")
+
+# from sage_build_cython:
+import Cython.Compiler.Options
+Cython.Compiler.Options.embed_pos_in_docstring = True
+
+try:
+    log.info("Generating auto-generated sources")
+    from sage_setup.autogen import autogen_all
+    autogen_all()
+
+    from Cython.Build import cythonize
+    from sage.env import cython_aliases, sage_include_directories
+    extensions = cythonize(
+        ["**/*.pyx"],
+        exclude=files_to_exclude,
+        include_path=sage_include_directories(use_sources=True) + ['.'],
+        compile_time_env=compile_time_env_variables(),
+        compiler_directives=compiler_directives(False),
+        aliases=cython_aliases(),
+        create_extension=create_extension,
+        nthreads=4)
+except Exception as exception:
+    log.warn(f"Exception while generating and cythonizing source files: {exception}")
+    extensions = None
```


This has a few problems/issues:
- The first few lines still raise an exception if Cython (and maybe other packages) are not installed.
- You want to auto-generate code before filtering it / excluding parts of it.
- The exception catch is to general and was meant to only capture module import errors.

All these things are fixed in #30371.
-


---

Comment by mkoeppe created at 2021-02-13 19:07:14

OK, fine, I'll do the merging.


---

Comment by @tobiasdiez created at 2021-02-13 19:08:54

Concerning this change:

```
 # distutils: language = c++
+# distutils: extra_compile_args = -std=c++11
```

Woudn't it make sense to specify `-std=c++11` automatically once `language = c++` is set? In fact there is code that looks like it is doing this job in sage_build_cython.

I think also the cython files in libs/singular need similar changes (at least in #30371 errors are thrown otherwise).


---

Comment by mkoeppe created at 2021-02-13 19:14:42

Replying to [comment:40 gh-tobiasdiez]:
> Concerning this change:
> {{{
>  # distutils: language = c++
> +# distutils: extra_compile_args = -std=c++11
> }}}
> Woudn't it make sense to specify `-std=c++11` automatically once `language = c++` is set? In fact there is code that looks like it is doing this job in sage_build_cython.

Of course, but you decided not to use the existing code. So I have made the changes that make it work.


---

Comment by mkoeppe created at 2021-02-13 19:18:44

Important to keep in mind that I have created this ticket so that we can ship something in Sage 9.3 that works. So let's please keep focused on what is described here on the ticket description.

Replying to [comment:38 gh-tobiasdiez]:
> - The first few lines still raise an exception if Cython (and maybe other packages) are not installed.

Not important for this ticket; we do have Cython. 

> - You want to auto-generate code before filtering it / excluding parts of it.

Why? Even after modularization, there will be exactly 1 module that will contain the autogenerated files.


---

Comment by @tobiasdiez created at 2021-02-13 19:36:16

Replying to [comment:41 mkoeppe]:
> Replying to [comment:40 gh-tobiasdiez]:
> > Concerning this change:
> > {{{
> >  # distutils: language = c++
> > +# distutils: extra_compile_args = -std=c++11
> > }}}
> > Woudn't it make sense to specify `-std=c++11` automatically once `language = c++` is set? In fact there is code that looks like it is doing this job in sage_build_cython.
> 
> Of course, but you decided not to use the existing code. So I have made the changes that make it work.
> 

I couldn't make it work with the sage_build_cython command, yes. So changing `create_extension` in `sage_setup/extensions.py` would be a better solution then?


---

Comment by mkoeppe created at 2021-02-13 19:53:56

Your approach of starting the build system from scratch has certainly been valuable, so that we can see what parts of the code are needed.

In terms of complexity of code, I think adding the small of number of explicit directives to the files may actually be preferable to the more complex code regarding the `-std` flags in `sage_build_cython`.
Let's try it out as is. 

In some follow-up ticket, a more general solution may be needed at some point. Especially when use of c++14/17 becomes more widespread, then fixing things to `std=c++11` may no longer be the right thing.
Let's do this when it becomes an issue; not now.


---

Comment by jhpalmieri created at 2021-02-16 19:41:55

Does this now instead implement `./configure --enable-build-as-root`? It sounds like that's related to `sudo make`; is that what's intended?


---

Comment by mkoeppe created at 2021-02-16 19:45:36

Thanks for catching the typo in the help string.


---

Comment by git created at 2021-02-16 19:47:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-02-16 20:07:38

I like it. Sometimes, I wanted to look into a C/C++ file that cython generated and I just couldn't locate it recently. No it's sitting all there for you.

What vanished though is the progress report, how many files yet need to be compiled. I like this feature, because it tells you whether you should wait on it or whether you should carry on and do something else.


---

Comment by mkoeppe created at 2021-02-16 20:10:31

Replying to [comment:50 gh-kliem]:
> What vanished though is the progress report, how many files yet need to be compiled. I like this feature, because it tells you whether you should wait on it or whether you should carry on and do something else.

Tobias wrote this as a minimal version using standard setuptools + cython. Let's keep adding additional features of this kind in mind for possible follow-up tickets.


---

Comment by @kliem created at 2021-02-16 20:24:00

Ok. Just mentioned that this is missing and I like it back, if possible. I think I would even switch to this, without the counter. Just because it is nice to have the files where you think the should be.

You introduced a trailing whitespace in `src/sage_setup/find.py`.


---

Comment by @kliem created at 2021-02-16 20:30:20

Why is it `python3` and not `$PYTHON`?

```diff
+if [ "$SAGE_EDITABLE" = yes ]; then
+    time python3 -m pip install --verbose --no-deps --no-index --no-build-isolation --isolated --editable . || exit 1
+else
+    time "$PYTHON" -u setup.py --no-user-cfg build install || exit 1
+fi
+
```



---

Comment by @kliem created at 2021-02-16 20:40:43

You freshly introduced `from distutils.command.build_ext import build_ext` in `/src/sage_setup/command/sage_build_ext_minimal.py`.
I think this should be replaced by setuptools somehow or at least import setuptools before as to get rid of setuptools.


---

Comment by mkoeppe created at 2021-02-16 20:55:18

We should probably merge #30984 too.


---

Comment by mkoeppe created at 2021-02-16 20:58:13

Replying to [comment:53 gh-kliem]:
> Why is it `python3` and not `$PYTHON`?
> {{{#!diff
> +if [ "$SAGE_EDITABLE" = yes ]; then
> +    time python3 -m pip install --verbose --no-deps --no-index --no-build-isolation --isolated --editable . || exit 1
> +else
> +    time "$PYTHON" -u setup.py --no-user-cfg build install || exit 1
> +fi
> +
> }}}

Thanks for spotting this inconsistency. Actually, both should be `python3` (since #30731, which replaced `sage-python23`).


---

Comment by git created at 2021-02-16 20:58:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-16 21:01:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-16 21:09:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-16 21:14:22

Replying to [comment:50 gh-kliem]:
> What vanished though is the progress report, how many files yet need to be compiled. I like this feature, because it tells you whether you should wait on it or whether you should carry on and do something else.

I think a progress bar will not be easy. The new version directly uses the cythonize method, which doesn't seem to have any configuration in this direction, see https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html?highlight=cythonize#cythonize-arguments.


---

Comment by mkoeppe created at 2021-02-16 21:16:49

I have created #31406 as a place for follow-up items.


---

Comment by @tobiasdiez created at 2021-02-16 21:19:36

Replying to [comment:44 mkoeppe]:

> In terms of complexity of code, I think adding the small of number of explicit directives to the files may actually be preferable to the more complex code regarding the `-std` flags in `sage_build_cython`.
> Let's try it out as is. 

Ok, sounds good to me. But notice that explicitly specifying the `std` changes the behavior on cygwin (for a "normal" build) since the following code in sage_build_cython is no longer invoked:

```
            if sys.platform == 'cygwin':
                # Cygwin (particularly newlib, Cygwin's libc) has some bugs
                # with strict ANSI C/C++ in some headers; using the GNU
                # extensions typically fares better:
                # https://trac.sagemath.org/ticket/24192
                if cplusplus:
                    cflags.append("-std=gnu++11")
                else:
                    cflags.append("-std=gnu99")

```

I don't know if this may have negative side effects.


---

Comment by mkoeppe created at 2021-02-16 21:40:19

Thanks for pointing this out; we'll see when we add automated tests for `--enable-editable` to the Cygwin GH Actions. (in a ticket after #31064 is merged)


---

Comment by @tobiasdiez created at 2021-02-16 22:09:40

A few more observations:
- There is currently no documentation for how to use the inplace install (and why).
- Running the configure command yields the following warning at the end:

```
....
config.status: creating directory local/var/lib/sage/installed
configure: WARNING: unrecognized options: --enable-editable
configure:

    notice: the following SPKGs did not find equivalent system packages
...
```

- My only means to test this on mac is with the github action added in #30371. Admittedly, this is using a lightly different setup, but since the sage inplace install fails, I wanted to point this out. First of all, the files in `sage/libs/singular` don't specify that they should be compiled with `language=c++` and `std=c++11`. Secondly, there are many errors of the form

```
 /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/nl_types.h:97:1: error: unknown type name 'nl_catd'
    nl_catd  catopen(const char *, int);
    ^
```

See e.g. https://github.com/tobiasdiez/sage/runs/1893534204?check_suite_focus=true

- On Linux (with wsl), the make build fails with

```
[pplpy-0.8.6] Copying package files from temporary location /mnt/d/Programming/sage/local/var/tmp/sage/build/pplpy-0.8.6/inst to /mnt/d/Programming/sage/local
[pplpy-0.8.6] Running post-install script for pplpy-0.8.6.
[pplpy-0.8.6] Traceback (most recent call last):
[pplpy-0.8.6]   File "/mnt/d/Programming/sage/local/bin/sphinx-build", line 5, in <module>
[pplpy-0.8.6]     from sphinx.cmd.build import main
[pplpy-0.8.6]   File "/mnt/d/Programming/sage/local/lib/python3.8/site-packages/sphinx/cmd/build.py", line 25, in <module>
[pplpy-0.8.6]     from sphinx.application import Sphinx
[pplpy-0.8.6]   File "/mnt/d/Programming/sage/local/lib/python3.8/site-packages/sphinx/application.py", line 31, in <module>
[pplpy-0.8.6]     from sphinx.config import Config
[pplpy-0.8.6]   File "/mnt/d/Programming/sage/local/lib/python3.8/site-packages/sphinx/config.py", line 28, in <module>
[pplpy-0.8.6]     from sphinx.util.tags import Tags
[pplpy-0.8.6]   File "/mnt/d/Programming/sage/local/lib/python3.8/site-packages/sphinx/util/tags.py", line 11, in <module>
[pplpy-0.8.6]     from jinja2 import nodes
[pplpy-0.8.6]   File "/mnt/d/Programming/sage/local/lib/python3.8/site-packages/jinja2/__init__.py", line 6, in <module>
[pplpy-0.8.6]     from markupsafe import escape
[pplpy-0.8.6] ValueError: source code string cannot contain null bytes
[pplpy-0.8.6] make[5]: *** [Makefile:21: html] Error 1
[pplpy-0.8.6] cp: cannot stat 'build/html/*': No such file or directory
```

That's probably not related to this ticket, but prevents me from testing it.


---

Comment by @tobiasdiez created at 2021-02-16 22:12:09

Replying to [comment:63 mkoeppe]:
> Thanks for pointing this out; we'll see when we add automated tests for `--enable-editable` to the Cygwin GH Actions. (in a ticket after #31064 is merged)

The point is that explicitly specifying `std` in the cython file also overrides it for the sage-distribution compilation, i.e. the one using the setup.py in build.


---

Comment by mkoeppe created at 2021-02-16 22:26:15

Replying to [comment:64 gh-tobiasdiez]:
> - Running the configure command yields the following warning at the end:
> {{{
> ....
> config.status: creating directory local/var/lib/sage/installed
> configure: WARNING: unrecognized options: --enable-editable
> }}}
>
Forgot to run `./bootstrap`?


---

Comment by mkoeppe created at 2021-02-16 22:30:17

Replying to [comment:64 gh-tobiasdiez]:
> - My only means to test this on mac is with the github action added in #30371.

Let's please not pull a discussion of these experimental GH actions from #30371 into this ticket.

If we add automatic testing, we will do it on the basis of the existing GH actions.


---

Comment by mkoeppe created at 2021-02-16 22:32:27

Replying to [comment:65 gh-tobiasdiez]:
> Replying to [comment:63 mkoeppe]:
> > Thanks for pointing this out; we'll see when we add automated tests for `--enable-editable` to the Cygwin GH Actions. (in a ticket after #31064 is merged)
> 
> The point is that explicitly specifying `std` in the cython file also overrides it for the sage-distribution compilation, i.e. the one using the setup.py in build. 

Yes, it is a change and we are using portability testing to make sure that it does not break anything on the supported platforms.


---

Comment by mkoeppe created at 2021-02-16 22:34:20

Replying to [comment:64 gh-tobiasdiez]:
> A few more observations:
> - There is currently no documentation for how to use the inplace install (and why).

Well, I hope we can merge this ticket into the next beta and then ask developers to try it. We can document it in a follow-up ticket.


---

Comment by mkoeppe created at 2021-02-16 22:37:30

Replying to [comment:64 gh-tobiasdiez]:
> - On Linux (with wsl), the make build fails with
> {{{
> [pplpy-0.8.6] Copying package files from temporary location /mnt/d/Programming/sage/local/var/tmp/sage/build/pplpy-0.8.6/inst to /mnt/d/Programming/sage/local
> [pplpy-0.8.6] Running post-install script for pplpy-0.8.6.
> [pplpy-0.8.6]     from markupsafe import escape
> [pplpy-0.8.6] ValueError: source code string cannot contain null bytes
> [pplpy-0.8.6] make[5]: *** [Makefile:21: html] Error 1
> [pplpy-0.8.6] cp: cannot stat 'build/html/*': No such file or directory
> }}}
> That's probably not related to this ticket, but prevents me from testing it.

I have not seen this before and I don't think it has anything to with the present ticket.
Please check if this also occurs with 9.3.beta7 and open a separate ticket if this problem is reproducible.


---

Comment by @tobiasdiez created at 2021-02-16 22:45:41

Replying to [comment:66 mkoeppe]:
> Forgot to run `./bootstrap`?

That fixed it indeed. 

The pplpy error occurs also with the recent develop branch, so this is indeed unrelated to these changes. I've opened #31407 for this.


---

Comment by @kliem created at 2021-02-17 07:15:01

I'm getting a few doctest failures:


```
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    print("dummy line"); shell.run_cell('1/0') # see #25320 for the reason of the `...` and the dummy line in this test
Expected:
    dummy line
    ...
    ZeroDivisionError...Traceback (most recent call last)
    <ipython-input-...> in <module>...
    ----> 1 Integer(1)/Integer(0)
    .../sage/rings/integer.pyx in sage.rings.integer.Integer...div... (.../sage/rings/integer.c:...)()
    ...
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, ....value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    dummy line
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /srv/public/kliem/sage/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__truediv__()
       2038         if type(left) is type(right):
       2039             if mpz_sgn((<Integer>right).value) == 0:
    -> 2040                 raise ZeroDivisionError("rational division by zero")
       2041             x = <Rational> Rational.__new__(Rational)
       2042             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
1 item had failures:
   1 of  20 in sage.repl.interpreter
    [141 tests, 1 failure, 1.97 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 7.4 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 2.0 seconds
kliem@lech:~/localhome/sage$ sage -t --long --random-seed=0 src/sage/stats/hmm/hmm.pyx  # 1 doctest failed
Running doctests with ID 2021-02-17-08-07-40-53dddc3c.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/stats/hmm/hmm.pyx
**********************************************************************
File "src/sage/stats/hmm/hmm.pyx", line 1234, in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel.baum_welch
Failed example:
    m.baum_welch(v,fix_emissions=True)
Expected:
    (-66.98630856918774, 100)
Got:
    (-66.98630856918776, 100)
**********************************************************************
1 item had failures:
   1 of  14 in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel.baum_welch
    [121 tests, 1 failure, 0.32 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/stats/hmm/hmm.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 0.3 seconds
kliem@lech:~/localhome/sage$ sage -t --long --random-seed=0 src/sage_setup/find.py  # 6 doctests failed
Running doctests with ID 2021-02-17-08-07-42-447cd574.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 199, in sage_setup.find.filter_cython_sources
Failed example:
    'sage/graphs/graph_decompositions/tdlib.pyx' in cython_modules
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage_setup/find.py", line 264, in sage_setup.find.find_extra_files
Failed example:
    extras["sage/ext/interpreters"]
Expected:
    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]
Got:
    ['/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_py.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cdf.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_el.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rdf.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cc.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rr.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_py.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cdf.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rr.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rdf.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cc.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_el.pxd']
**********************************************************************
File "src/sage_setup/find.py", line 324, in sage_setup.find.installed_files_by_module
Failed example:
    (f,) = files_by_module['sage.structure.sage_object']; f
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.installed_files_by_module[5]>", line 1, in <module>
        (f,) = files_by_module['sage.structure.sage_object']; f
    ValueError: not enough values to unpack (expected 1, got 0)
**********************************************************************
File "src/sage_setup/find.py", line 326, in sage_setup.find.installed_files_by_module
Failed example:
    (f1, f2) = sorted(files_by_module['sage.structure'])
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.installed_files_by_module[6]>", line 1, in <module>
        (f1, f2) = sorted(files_by_module['sage.structure'])
    ValueError: not enough values to unpack (expected 2, got 0)
**********************************************************************
File "src/sage_setup/find.py", line 327, in sage_setup.find.installed_files_by_module
Failed example:
    f1
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.installed_files_by_module[7]>", line 1, in <module>
        f1
    NameError: name 'f1' is not defined
**********************************************************************
File "src/sage_setup/find.py", line 329, in sage_setup.find.installed_files_by_module
Failed example:
    f2
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/src/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.installed_files_by_module[8]>", line 1, in <module>
        f2
    NameError: name 'f2' is not defined
**********************************************************************
3 items had failures:
   1 of   7 in sage_setup.find.filter_cython_sources
   1 of   7 in sage_setup.find.find_extra_files
   4 of  11 in sage_setup.find.installed_files_by_module
    [42 tests, 6 failures, 0.40 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage_setup/find.py  # 6 doctests failed
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.4 seconds
    cumulative wall time: 0.4 seconds
```


```
kliem@lech:~/localhome/sage$ sage -t --long --random-seed=0 src/sage/tests/cmdline.py  # 3 doctests failed
Running doctests with ID 2021-02-17-08-07-44-7353eba5.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 586, in sage.tests.cmdline.test_executable
Failed example:
    out.startswith("3.")
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 588, in sage.tests.cmdline.test_executable
Failed example:
    err
Expected:
    ''
Got:
    '/srv/public/kliem/sage/src/bin/sage: line 588: exec: sqlite3: not found\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 590, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    127
**********************************************************************
1 item had failures:
   3 of 231 in sage.tests.cmdline.test_executable
    [230 tests, 3 failures, 21.87 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/tests/cmdline.py  # 3 doctests failed
----------------------------------------------------------------------
```


The test in `src/sage/tests/cmdline.py` is just there for completeness and can be ignored.


---

Comment by jhpalmieri created at 2021-02-18 01:19:06

I got failures in `repl/interpreter.py` and `sage_setup/find.py`.


---

Comment by git created at 2021-02-18 01:37:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-18 02:32:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-18 02:43:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-18 03:03:52

The remaining failures in `sage_setup/find.py` are now all about `installed_files_by_module`; I'll have to see what to do about them (this function is only needed for the old build system).

The failure in `sage/repl/interpreter.py` seems to indicate that the C source information (`sage/rings/integer.c`) is missing.


---

Comment by git created at 2021-02-18 03:16:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-18 03:29:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-18 04:12:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-18 06:45:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-18 06:47:19

This fixes the remaining doctests for me.


---

Comment by @kliem created at 2021-02-18 06:53:25

Not for me:

I still get `src/sage/tests/cmdline.py`, which can be ignored.

On top:


```
kliem@lech:~/localhome/sage$ sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py
Running doctests with ID 2021-02-18-07-50-51-5ae2b230.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    print("dummy line"); shell.run_cell('1/0') # see #25320 for the reason of the `...` and the dummy line in this test
Expected:
    dummy line
    ...
    ZeroDivisionError...Traceback (most recent call last)
    <ipython-input-...> in <module>...
    ----> 1 Integer(1)/Integer(0)
    .../sage/rings/integer.pyx in sage.rings.integer.Integer...div... (.../sage/rings/integer.c:...)()
    ...
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, ....value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    dummy line
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /srv/public/kliem/sage/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__truediv__()
       2038         if type(left) is type(right):
       2039             if mpz_sgn((<Integer>right).value) == 0:
    -> 2040                 raise ZeroDivisionError("rational division by zero")
       2041             x = <Rational> Rational.__new__(Rational)
       2042             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
1 item had failures:
   1 of  20 in sage.repl.interpreter
    [141 tests, 1 failure, 1.94 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 7.3 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 1.9 seconds
kliem@lech:~/localhome/sage$ sage -t --long --warn-long 62.2 --random-seed=0 src/sage/stats/hmm/hmm.pyx
Running doctests with ID 2021-02-18-07-51-08-57678760.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/stats/hmm/hmm.pyx
**********************************************************************
File "src/sage/stats/hmm/hmm.pyx", line 1234, in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel.baum_welch
Failed example:
    m.baum_welch(v,fix_emissions=True)
Expected:
    (-66.98630856918774, 100)
Got:
    (-66.98630856918776, 100)
**********************************************************************
1 item had failures:
   1 of  14 in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel.baum_welch
    [121 tests, 1 failure, 0.33 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/stats/hmm/hmm.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 0.3 seconds
kliem@lech:~/localhome/sage$ sage -t --long --warn-long 62.2 --random-seed=0 src/sage_setup/find.py
Running doctests with ID 2021-02-18-07-51-21-d3281c6c.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 264, in sage_setup.find.find_extra_files
Failed example:
    extras["sage/ext/interpreters"]
Expected:
    ['.../src/sage/ext/interpreters/wrapper_cdf.pxd', ...wrapper_cdf.h...]
Got:
    ['/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_py.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cdf.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_el.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rdf.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cc.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rr.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_py.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cdf.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rr.pyx',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_rdf.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_cc.pxd',
     '/srv/public/kliem/sage/src/sage/ext/interpreters/wrapper_el.pxd']
**********************************************************************
1 item had failures:
   1 of   7 in sage_setup.find.find_extra_files
    [41 tests, 1 failure, 0.47 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage_setup/find.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.5 seconds
    cpu time: 0.5 seconds
    cumulative wall time: 0.5 seconds
```



---

Comment by @kliem created at 2021-02-18 06:58:30

`find_extra_files` does exactly what the documentation claims it does, it lists all `pyx, pxd, pxi` files.


---

Comment by mkoeppe created at 2021-02-18 07:06:28

After `make sagelib-clean sagelib` I can reproduce this error too. the `.h` files are missing in the list.


---

Comment by mkoeppe created at 2021-02-18 07:07:46

My guess is that the doctest failure in `src/sage/repl/interpreter.py` will go away if you do `make sagelib-clean`


---

Comment by @kliem created at 2021-02-18 07:27:18

The missing `.h` files are by design. This function gives only `.h.` files in `cythonized`, which is pointless now. I don't know what would be the best way to deal with this.

Can you fix the precision error in `src/sage/stats/hmm/hmm.pyx` as well (`# abs tol 1e-13`). It seems pointless to have an extra ticket for this.


---

Comment by @kliem created at 2021-02-18 08:00:04

Ran `make sagelib-clean sagelib` and `make build` and it still persists:


```
kliem@lech:~/localhome/sage$ sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py
Running doctests with ID 2021-02-18-08-59-13-9182572c.
Git branch: test_31377
Using --optional=build,debian,dochtml,memlimit,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    print("dummy line"); shell.run_cell('1/0') # see #25320 for the reason of the `...` and the dummy line in this test
Expected:
    dummy line
    ...
    ZeroDivisionError...Traceback (most recent call last)
    <ipython-input-...> in <module>...
    ----> 1 Integer(1)/Integer(0)
    .../sage/rings/integer.pyx in sage.rings.integer.Integer...div... (.../sage/rings/integer.c:...)()
    ...
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, ....value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    dummy line
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /srv/public/kliem/sage/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__truediv__()
       2038         if type(left) is type(right):
       2039             if mpz_sgn((<Integer>right).value) == 0:
    -> 2040                 raise ZeroDivisionError("rational division by zero")
       2041             x = <Rational> Rational.__new__(Rational)
       2042             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
1 item had failures:
   1 of  20 in sage.repl.interpreter
    [141 tests, 1 failure, 2.90 s]
----------------------------------------------------------------------
sage -t --long --warn-long 62.2 --random-seed=0 src/sage/repl/interpreter.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 8.4 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 2.9 seconds
```



---

Comment by @kliem created at 2021-02-18 08:01:46

I mean it makes completely sense that the cythonized file is no longer written in parenthesis, because it is in the obvious location. So no need to specify this anymore.


---

Comment by @tobiasdiez created at 2021-02-18 08:34:06

Replying to [comment:86 mkoeppe]:
> My guess is that the doctest failure in `src/sage/repl/interpreter.py` will go away if you do `make sagelib-clean`

I think this problem comes from the fact that currently find_packages is called before the autogeneration. Thus, the auto-generated files are not included in the cythonization step. This is fixed in the setup.py in #30371.


---

Comment by @kliem created at 2021-02-18 08:37:48

I think we can leave those failures for later fix, as long as we take care of them at some point.

None of the doctest failures is serious.

I guess this isn't ready yet for being used for patchbots.


---

Comment by mkoeppe created at 2021-02-18 16:35:31

Replying to [comment:88 gh-kliem]:
> Ran `make sagelib-clean sagelib` and `make build` and it still persists:

I'm pretty sure I fixed this with e272614; perhaps `make sagelib-clean` still does not clean enough?


---

Comment by mkoeppe created at 2021-02-18 16:49:25

Replying to [comment:90 gh-tobiasdiez]:
> Replying to [comment:86 mkoeppe]:
> > My guess is that the doctest failure in `src/sage/repl/interpreter.py` will go away if you do `make sagelib-clean`
> 
> I think this problem comes from the fact that currently find_packages is called before the autogeneration. Thus, the auto-generated files are not included in the cythonization step. This is fixed in the setup.py in #30371.

No, calling autogen earlier does not help.


---

Comment by vdelecroix created at 2021-02-18 17:31:03

For changes in Python source, one might even use `importlib` and not restart sage at all!


---

Comment by git created at 2021-02-18 17:31:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-18 17:33:39

Replying to [comment:95 vdelecroix]:
> For changes in Python source, one might even use `importlib` and not restart sage at all!

True, but let's not document this -- too many possible pitfalls related to class redefinitions


---

Comment by mkoeppe created at 2021-02-18 17:37:27

(Too bad that Python does not have `UPDATE-INSTANCE-FOR-REDEFINED-CLASS` http://clhs.lisp.se/Body/f_upda_1.htm)


---

Comment by mkoeppe created at 2021-02-18 17:45:37

Ready for another round of testing. (I won't do the unrelated `hmm.pyx` doctest fix on this ticket)


---

Comment by @kliem created at 2021-02-18 18:04:11

After deleting everything and reinstalling it, I still get the failure in `src/sage/repl/interpreter.py`. The `find.py` thing is gone now.


---

Comment by mkoeppe created at 2021-02-18 18:33:21

I'm getting the `src/sage/repl/interpreter.py` failure now too again... any help with tracking this down is welcome...


---

Comment by mkoeppe created at 2021-02-18 18:51:32

Or we can leave this issue for the follow-up ticket #31406, that would be fine with me too.


---

Comment by jhpalmieri created at 2021-02-18 19:59:35

If we're to believe the doctest language ("Check that Cython source code appears in tracebacks"), then this is functioning properly, it's just missing "(.../cythonized/sage/rings/integer.c:...)()". Can we just replace that part of the doctest with "...", or is it important?

```diff
diff --git a/src/sage/repl/interpreter.py b/src/sage/repl/interpreter.py
index befa75fc38..3bd894851d 100644
--- a/src/sage/repl/interpreter.py
+++ b/src/sage/repl/interpreter.py
@@ -80,7 +80,7 @@ Check that Cython source code appears in tracebacks::
     ZeroDivisionError...Traceback (most recent call last)
     <ipython-input-...> in <module>...
     ----> 1 Integer(1)/Integer(0)
-    .../sage/rings/integer.pyx in sage.rings.integer.Integer...div... (.../sage/rings/integer.c:...)()
+    .../sage/rings/integer.pyx in sage.rings.integer.Integer...div...
     ...
     -> ...                  raise ZeroDivisionError("rational division by zero")
        ....:            x = <Rational> Rational.__new__(Rational)
```

By the way, `git status` tells me

```
Untracked files:
  (use "git add <file>..." to include in what will be committed)
	src/cython_debug/
```



---

Comment by @tobiasdiez created at 2021-02-18 20:12:57

I had also these untracked files in src/cython_debug.

The tests seem to pass in general for me. However, they need a lot of ram, like > 25GB which sometimes leads to a crash of the system. In particular, the tests around sage/plot seem to very memeroy intensive (but the memory doesn't go down afterwards). Is this normal? I could also reproduce this on the github actions in #30371 which also crash reproducible after about 2 hours of doctesting.


---

Comment by git created at 2021-02-18 20:28:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-18 20:29:58

Replying to [comment:103 jhpalmieri]:
> it's just missing "(.../cythonized/sage/rings/integer.c:...)()". Can we just replace that part of the doctest with "...", or is it important?
I don't know if this information is important, perhaps someone who programs Cython can tell us?


---

Comment by @kliem created at 2021-02-18 20:40:26

Using git blame, this doctest was introduced in commit `6e7ad656ba3307ff67949e251550c101758f9963`. In this commit Jeroen Demeyer added a IPython patch. Of course this patch has long merged upstream and has now changed several times and I failed to located the place, where things are happening.

However, things are out of our control.

I think the reason why "(.../cythonized/sage/rings/integer.c:...)()" appears is that the cythonized file is located at a different location then the source file. So this might be important, when you are debugging. However, if the cythonized files are no longer hidden somewhere else, then it appears pointless to print this information and this is probably why IPython doesn't do it. I mean the file is right next to the other file. It is redundant information in this case.

Long story short, I think this can go. It is an IPython feature of which we do not have control anyway. What is important, is that the corresponding `pyx` file appears correctly, which is the case.


---

Comment by git created at 2021-02-18 20:50:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-18 20:50:57

Thanks for investigating. This is sufficiently convincing, so I have removed the test.


---

Comment by @kliem created at 2021-02-19 15:34:26

Ok, all tests pass now (except for those two unrelated tests).


---

Comment by mkoeppe created at 2021-02-20 18:10:14

Any further concerns, or can we get this in?


---

Comment by @tobiasdiez created at 2021-02-20 18:49:02

From my side this looks good.


---

Comment by @kliem created at 2021-02-20 19:07:29

I'm happy with it, but didn't have the time to understand everything yet.


---

Comment by @kliem created at 2021-02-24 09:25:48

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-02-24 09:25:48

LGTM.

I don't know if setting `nthreads=4` for cythonizing is perfect. Maybe this could be picked up somewhere in a follow up ticket. E.g. if the environment variable `MAKE` is set to `make ... -jN ...` we should probably respect this.


---

Comment by @tobiasdiez created at 2021-02-24 15:19:55

Thanks! I've added your suggestion to #31406.


---

Comment by mkoeppe created at 2021-02-24 18:21:18

Thanks for the review!


---

Comment by git created at 2021-03-07 21:07:56

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-03-07 21:07:56

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-03-07 21:08:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-09 00:00:42

Resolution: fixed


---

Comment by fbissey created at 2021-03-09 21:57:11

I finally tracked this ticket has the breaking point of the way I build the documentation in sage-on-gentoo. This ticket not #30010. 

Unlike the current philosophy pursued by vanilla sage in distro we usually build documentation before installing. There are philosophy discussions to be had about the approaches. I am sometimes not even completely sure how things work. But here the reason is simple, before this ticket, all the sources where copied under `build/lib/` during the build process. After this ticket only the final compiled cython modules are found under `build/lib/`. Historically during the documentation building in sage-on-gentoo the just compiled copy of sagelib under `build/lib/` was used. This is not possible anymore.

Is there a switch to pass to `setup.py` that would copy the source in `build/lib` after this ticket?


---

Comment by mkoeppe created at 2021-03-09 22:10:10

I don't think this ticket changes anything if you don't use `configure --enable-editable`.


---

Comment by mkoeppe created at 2021-03-09 22:12:30

Just be sure to use `build/pkgs/sagelib/src/setup.py`, not `src/setup.py`. This builds in `build/pkgs/sagelib/src/build/`.


---

Comment by fbissey created at 2021-03-09 22:30:33

I am working on top of Volker's merging branch to figure issues before they hit me when a beta is released. When the beta, rc or final release arrive I usually have worked out the issues. I have bisected the change of behavior to this ticket. By the sound of it, the change of behavior is accidental and you have no idea or care about it.

On a side note since you are mentioning it, I am not currently using `build/pkgs/sagelib/src/setup.py`, links to sources have proved troublesome so far. I am hoping to switch to that at some point when some packaging dust settles. But I should point out that it severely hamper my ability to build the documentation in the same package. Which is a point our current philosophy of building sage are getting divergent. But those are discussions we should have in another space than this ticket.


---

Comment by mkoeppe created at 2021-03-09 22:36:49

Replying to [comment:123 fbissey]:
> By the sound of it, the change of behavior is accidental

No. Since #30779, the Sage distribution has no longer used `src/setup.py`. It switched to using `build/pkgs/sagelib/src/setup.py`. You should do the same.


---

Comment by mkoeppe created at 2021-03-09 22:41:42

By the way, if you want to discuss philosophy of docbuilding, --> #31356, #29868.


---

Comment by fbissey created at 2021-03-09 22:52:28

Replying to [comment:124 mkoeppe]:
> Replying to [comment:123 fbissey]:
> > By the sound of it, the change of behavior is accidental
> 
> No. Since #30779, the Sage distribution has no longer used `src/setup.py`. It switched to using `build/pkgs/sagelib/src/setup.py`. You should do the same.

I hadn't realised how much they diverged from each other. It feels like some tickets patch one but not the other and so on. Regardless of my issues and divergence in philosophy, as I called it, if the version in `src/setup.py` shouldn't be used or developed against we need to remove it and quickly.


---

Comment by mkoeppe created at 2021-03-09 22:58:03

No, as of this ticket, it's used for `./configure --enable-editable`.


---

Comment by fbissey created at 2021-03-09 23:04:36

I think I am starting to get the picture. So those large looking differences are on purpose?


---

Comment by jhpalmieri created at 2021-03-09 23:14:59

It sounds like it would be good to add some explanatory comments at the top of `src/setup.py` (not by me, since I don't understand the situation).


---

Comment by mkoeppe created at 2021-03-09 23:42:43

Replying to [comment:128 fbissey]:
> So those large looking differences are on purpose?

Yes! And yes, we'll have to add some documentation. I'll do this in #31386 (which will reduce the amount of duplication between the two `setup.py` files); this ticket is waiting for another big build system ticket, #30913.
