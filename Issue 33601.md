# Issue 33601: Refactoring run_autogen [to generate wrappers] to either build_ext or setup.py

Issue created by migration from https://trac.sagemath.org/ticket/33838

Original creator: fbissey

Original creation time: 2022-05-11 05:14:46

CC:  mkoeppe

Recently some changes in the build tools for PEP517 python packages in Gentoo lead to `python setup.py build` not being executed in favor of `python setup.py build_ext` see https://github.com/cschwan/sage-on-gentoo/issues/693 and https://bugs.gentoo.org/842534

The Gentoo maintainer reasoning for removing `build` is that it is normally a meta target whose sole purpose is to start other phases like `build_ext`. The over-ridding of the `build` command in sage is an increasingly uncommon practice apparently. 

The `build` target does only one thing, run `run_autogen` to generate some cython code and `build` is explicitly only called by the sage build system when it is configured without `--enable-editable`[https://github.com/sagemath/sage/blob/develop/build/pkgs/sagelib/spkg-install#L55](https://github.com/sagemath/sage/blob/develop/build/pkgs/sagelib/spkg-install#L55). In builds with that option enabled, autogeneration is called from `setup.py` [https://github.com/sagemath/sage/blob/develop/src/setup.py#L78](https://github.com/sagemath/sage/blob/develop/src/setup.py#L78) and `build` is not called explicitly.

I think we should take the opportunity to simplify the build system further and reduce the differences editable and non-editable build by either fully moving the autogeneration in `setup.py` or moving it to `build_ext` (the strategy I followed as a quick fix in https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage_setup/files/sage_setup-9.6-no_build.patch

In both option the build system would be simplified.


---

Comment by mkoeppe created at 2022-05-11 05:29:12

I'm -1 on considering anything other than `setup.py egg_info`, `setup.py sdist` and `setup.py bdist_wheel` supported interface. Our package declares the build system via PEP 517 and distributions have no business in poking around in its internals.


---

Comment by mkoeppe created at 2022-05-11 05:34:21

`build_ext` is clearly the wrong place for it. However, it would be OK for me to get rid of `sage_build` and just do it in `setup.py`, as you suggest.


---

Comment by fbissey created at 2022-05-11 05:37:00

I was replying a bit more tongue in check to your first post when the second one came :)

I agree about going with the setup.py solution and thought of my problem as an opportunity to simplify things and minimise difference between editable/non-editable. There are obviously issues there and autogen is one of them.


---

Comment by mkoeppe created at 2022-05-11 05:41:46

For more context, it is probably safe to say that Gorny's homegrown anti-PEP-517 scripts are an obviously misguided approach, but that's not my problem ;)


---

Comment by fbissey created at 2022-05-11 07:35:25

But I take it from your first comment that you will not have any objections to work on replacing 

```
time python3 -u setup.py --no-user-cfg build install || exit 1
```

in `build/pkgs/sagelib/spkg-install` by something more `pip`-ish. The fact that you need to explicitly call `build` here, suggests to me that `pip` doesn't call it either.


---

Comment by mkoeppe created at 2022-05-11 07:40:12

I think the `build` in that line is just a leftover from when we passed some arguments.


---

Comment by mkoeppe created at 2022-05-11 07:41:19

See #32874 for getting rid of our use of `setup.py install`


---

Comment by fbissey created at 2022-05-11 07:46:24

Right, so I seem to have it all wrong. It's just that bizzare duplication of the autogen code between the two cases suggest otherwise. In that case the code in the current `setup.py` for editable sage may be redundant. Yet, that's the one I will want to keep long term.


---

Comment by mkoeppe created at 2022-05-11 07:50:29

Yes, it will be a nice simplification to get rid of the `sage_build` class.

I don't think we have a need for the autogen stuff to be called in several distribution packages, so nothing is gained from having it in a reusable class.


---

Comment by fbissey created at 2022-05-12 00:28:46

Changing status from new to needs_review.


---

Comment by fbissey created at 2022-05-12 00:28:46

First draft.
----
New commits:


---

Comment by mkoeppe created at 2022-05-12 01:36:50

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-12 01:36:50

Looking good


---

Comment by vbraun created at 2022-05-24 22:44:57

Resolution: fixed
