# Issue 25627: make LinearExtensions an iterator

Issue created by migration from https://trac.sagemath.org/ticket/25864

Original creator: mantepse

Original creation time: 2018-07-17 06:35:19

CC:  tscrim chapoton jmantysalo kdilks aschilling




---

Comment by mantepse created at 2018-07-17 07:21:15

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by mantepse created at 2018-07-17 07:21:15

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mantepse created at 2018-07-17 07:21:15

New commits:


---

Comment by git created at 2018-07-17 11:26:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-17 18:44:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-07-17 18:45:04

Changing status from new to needs_review.


---

Comment by git created at 2018-07-18 07:20:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-18 08:56:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-18 11:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2018-07-18 15:36:18

I do not understand. "Currently, it is returning a (sorted) list.", but already

`_ = posets.BooleanLattice(4).linear_extensions()`

takes about zero time, whereas

`_ = list(posets.BooleanLattice(4).linear_extensions())`

takes at least a minute, and for example

`_ = posets.BooleanLattice(4).linear_extensions()[2000]`

takes a fraction of a second. So, this seems to already be an iterator.


---

Comment by mantepse created at 2018-07-18 17:01:26

Currently, `P.linear_extensions()` returns a class, with some (rather little) initialisations done.  This class has a `__list__` method, which triggers the actual computation.

In particular:

Replying to [comment:10 jmantysalo]:
> I do not understand. "Currently, it is returning a (sorted) list.", but already
> 
> `_ = posets.BooleanLattice(4).linear_extensions()`
> 
> takes about zero time, whereas

because only the initialisation code is run,

> `_ = list(posets.BooleanLattice(4).linear_extensions())`
> 
> takes at least a minute, and for example

because the list of all linear extensions is created, and

> `_ = posets.BooleanLattice(4).linear_extensions()[2000]`
> 
> takes a fraction of a second.

because this is only accessing an element in a list.


---

Comment by jmantysalo created at 2018-07-19 04:32:39

Replying to [comment:11 mantepse]:
> Currently, `P.linear_extensions()` returns a class, with some (rather little) initialisations done.  This class has a `__list__` method, which triggers the actual computation.

??? No, it has `__iter__` that is an iterator.


---

Comment by mantepse created at 2018-07-19 08:29:31

Replying to [comment:12 jmantysalo]:
> Replying to [comment:11 mantepse]:
> > Currently, `P.linear_extensions()` returns a class, with some (rather little) initialisations done.  This class has a `__list__` method, which triggers the actual computation.
> 
> ??? No, it has `__iter__` that is an iterator.

which calls `self._linear_extensions_of_hasse_diagram` which is `sage.graphs.linearextensions.LinearExtensions(poset._hasse_diagram)` which had only a `list` method before this ticket...


---

Comment by jmantysalo created at 2018-07-19 08:46:57

But clearly there is some kind of "iterator" used here, as we can ask for example tenth linear extension without generating the whole list. In a quick look it seems that `generate_linear_extensions` gives kind of "implicit iterator", as it computes "next" linear extension in some order of extensions.

But is it so that current implementation eats memory, i.e. already "used" extensions are not released from the memory? If so, then I understand this.


---

Comment by mantepse created at 2018-07-19 11:01:45

Replying to [comment:14 jmantysalo]:
> But clearly there is some kind of "iterator" used here, as we can ask for example tenth linear extension without generating the whole list. 

No, the problem is precisely that the whole list is always generated.  This is slightly obscured by the fact that posets are `UniqueRepresentation`.  But to see it, you can insert a line

```diff
diff --git a/src/sage/graphs/linearextensions.py b/src/sage/graphs/linearextensions.py
index 113a2cd..f899dfc 100644
--- a/src/sage/graphs/linearextensions.py
+++ b/src/sage/graphs/linearextensions.py
@@ -347,6 +347,7 @@ class LinearExtensions(CombinatorialClass):
              [0, 2, 1, 4, 3],
              [0, 2, 4, 1, 3]]
         """
+        print("computing")
         if self.linear_extensions is not None:
             return self.linear_extensions[:]
```

rebuild sage, and then verify the following:

```
sage: P = posets.AntichainPoset(9); L = P.linear_extensions()._linear_extensions_of_hasse_diagram
sage: type(L.linear_extensions)
<type 'NoneType'>
sage: L[0]
computing
[0, 1, 2, 3, 4, 5, 6, 7, 8]
sage: type(L.linear_extensions)
<type 'list'>
sage: L.linear_extensions[0]
[0, 1, 2, 3, 4, 5, 6, 7, 8]
sage: L.linear_extensions[-1]
[8, 7, 6, 5, 4, 3, 2, 1, 0]
```


As you can see, the list of linear extensions is computed although only the first element is requested.


---

Comment by jmantysalo created at 2018-07-19 12:00:35

This is very interesting. Maybe Travis or Frédéric can tell what happens here... I start Sage and say


```
sage: for x in posets.AntichainPoset(10).linear_extensions():
....:     print x
....:     break
```


No output, system seems to be stalled. I press Ctrl+C and get back to command line. I give the same command again, and now I got

`[9, 8, 7, 6, 5, 4, 3, 2, 1, 0]`

So, it seems that this kind of is an iterator, but not exactly.


---

Comment by mantepse created at 2018-07-19 12:13:11

Replying to [comment:16 jmantysalo]:
> This is very interesting. Maybe Travis or Frédéric can tell what happens here... I start Sage and say
> 
> {{{
> sage: for x in posets.AntichainPoset(10).linear_extensions():
> ....:     print x
> ....:     break
> }}}
> 
> No output, system seems to be stalled. I press Ctrl+C and get back to command line. I give the same command again, and now I got
> 
> `[9, 8, 7, 6, 5, 4, 3, 2, 1, 0]`
> 
> So, it seems that this kind of is an iterator, but not exactly.

You are simply interrupting the computation in `posets.AntichainPoset(10).linear_extensions()._linear_extensions_of_hasse_diagram.list()`.

You can see this as follows: in a fresh session (!!!) do the same as before, that is, interrupt

```
sage: P = posets.AntichainPoset(10)
sage: for x in P.linear_extensions():
....:     print x
....:     break
```

then again

```
sage: for x in P.linear_extensions():
....:     print x
....:     break
```

which will yield

```
[9, 8, 7, 6, 5, 4, 3, 2, 1, 0]
```

Then check that

```
sage: P.linear_extensions().cardinality()
3628800
```

Finally:

```
sage: len(P.linear_extensions()._linear_extensions_of_hasse_diagram.linear_extensions)
```

which will tell you a smaller number.  And indeed

```
sage: P.linear_extensions()[3628800-1]
```

will give an error (after a while, because lists are copied all the time).


---

Comment by kdilks created at 2018-07-23 15:38:48

In the process of reading the code in `graphs/linearextensions.py`, and trying to figure out how it needs to be modified to become an iterator. I may need to read a bit more of the paper to understand what the individual helper methods are doing and how they tie together. I'm hoping it will eventually be as easy as changing the end of the `move()` and `switch()` methods to be yield statements, and make the `list()` method an `_iter_()` method.

One potential problem that could arise by changing things is if any other code relies on linear extensions of a poset being generated in lexicographic order. The algorithm itself does not generate them in lexicographic order, but the current implementation makes it appear that way to the user since the entire list is generated and then sorted before being iterated over.


---

Comment by mantepse created at 2018-07-23 17:04:48

`@`kdilks: I modified the code already so that it is a true iterator!

It only needs review, there is no coding to be done!


---

Comment by kdilks created at 2018-07-23 19:12:21

Much easier!

Still building Sage to run some tests. Only extremely minor thing I see from looking at the diff is that the docstring for the _iter_ method still says 'Returns a list of ...' from when it was the list method.


---

Comment by git created at 2018-07-23 20:30:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-07-24 03:30:55

Some things:

- It is better practice to copy the dag on input rather than at `_prepare` as it is possible to pass the dag in, modify the dag, and then run `_prepare`. It also means that it will never have an inconsistent state by having linear extensions for a dag that is not its `self.dag`.

- Errors are not full sentences by Python conventions:
  {{{#!diff
-ValueError("The digraph must be acyclic to have linear extensions.")
+ValueError("the digraph must be acyclic to have linear extensions")
  }}}

- The result is no longer cached. So if this is called repeatedly for the same dag, this could be slower. I think your change is okay, but it might have unintended consequences in terms of speed. Did you check this?


---

Comment by mantepse created at 2018-07-24 11:56:53

The first item is a bit more work, because I will have to copy the graph twice or prepare a matrix of incomparable elements.  Not sure yet what's better.


---

Comment by git created at 2018-07-24 13:04:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-07-24 13:05:01

I now get

```
            sage: l == loads(dumps(l))
            False
```

no idea why (I don't even know what this does...)


---

Comment by kdilks created at 2018-07-24 13:09:08

Google is telling me that this error can occur when you have a dictionary with non-string keys (dumps converts a dictionary to a json file which only has string keys, and then loads recreates the dictionary). How/why that's coming up...I've got nothing.


---

Comment by chapoton created at 2018-07-24 13:43:01

The loads/dumps problem is a "pickling issue" : dumps somehow saves a compressed copy of the object (pickle) and loads restores back something from that. This kind of error is usually triggered by wrong behaviour of the comparison methods `__eq__` or `__richcmp__`. You should try to understand why `l` and `loads(dumps(l))` do not compare equal, and who is in charge of the comparison.


---

Comment by mantepse created at 2018-07-24 13:50:13

It appears to me now that this class actually shouldn't be a parent, because that's what `LinearExtensionsOfPoset` does, except that the latter is specialised to posets, not arbitrary DAGs.

Apart from there, this class is only used once in library code, in `Permutation`.

Alternatively, blow it up similarly to `LinearExtensionsOfPoset`, but I'm a bit afraid that this is really only bloat.


---

Comment by tscrim created at 2018-07-26 12:43:06

I at least agree that it probably should not be a non-façade `Parent` as its "elements" are lists. In fact, this is probably something we should consider cythonizing since this is _also_ used by `DiGraph.topological_sort_generator` (which sounds like it should return an iterator, not a list, but that is a separate issue). Granted, since this is more of an internal class, you are probably right in that it should not be a subclass of `Parent`, but it might mean a finer check.


---

Comment by tscrim created at 2018-07-26 12:43:06

Changing keywords from "" to "sagedays@icerm".


---

Comment by mantepse created at 2018-07-26 18:51:45

Could you say (or give me a reference to) what a non-facade parent is?  Or, maybe easier, what `LinearExtensions` should inherit from.

(I have already adapted the code from `LinearExtensionsOfPoset`, making it a real parent with a new element class `LinearExtension` - its easy to do, I just don't know whether it is what should be done.)


---

Comment by tscrim created at 2018-07-26 23:17:50

A façade parent is a parent that does not have elements but functionally behaves like a parent. IIRC, see the doc of `Parent`. As I said in comment:30, it probably should not inherit from `Parent`, and so probably should be a subclass of `object`. However, there might be some things from the category that do get utilized (such as in the top sort method).


---

Comment by mantepse created at 2018-08-26 06:55:48

I decided to give it a try and cythonized the iterator.  I currently have a speedup of a factor 2.  I am still polishing.


---

Comment by git created at 2018-08-26 21:24:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-08-26 21:58:01

new:

```
sage: from sage.combinat.combinat_cython import linear_extension_iterator
sage: D = posets.BooleanLattice(4)
sage: %time for e in linear_extension_iterator(D._hasse_diagram): pass
CPU times: user 23.5 s, sys: 47.7 ms, total: 23.5 s
Wall time: 23.5 s
sage: from sage.graphs.linearextensions import LinearExtensions
sage: %time for e in LinearExtensions(D): pass
CPU times: user 25.1 s, sys: 0 ns, total: 25.1 s
Wall time: 25 s
```

old:

```
sage: D = posets.BooleanLattice(4)
sage: from sage.graphs.linearextensions import LinearExtensions
sage: %time for e in LinearExtensions(D.hasse_diagram()): pass
CPU times: user 2min 49s, sys: 692 ms, total: 2min 49s
Wall time: 2min 51s
```



---

Comment by mantepse created at 2018-08-27 19:41:31

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-08-28 08:55:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-28 20:04:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-02 10:00:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-09-02 10:01:17

Changing status from needs_work to needs_info.


---

Comment by mantepse created at 2018-09-02 10:04:42

I don't know what to do with

```
            sage: from sage.graphs.linearextensions import LinearExtensions
            sage: D = DiGraph({ 0:[1,2], 1:[3], 2:[3,4] })
            sage: l = LinearExtensions(D)
            sage: l == loads(dumps(l))
            True
```

(because this now gives `False`)

Also, maybe it would be better to deprecate the class `LinearExtensions` completely, the class `LinearExtensionsOfPoset` should be a good replacement (and might be renamed `LinearExtensions`).


---

Comment by git created at 2018-09-02 13:04:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-09-02 13:06:25

Anne, I'm guessing that this might affect (positively, I hope) a lot of your code...


---

Comment by tscrim created at 2018-09-02 22:28:30

Replying to [comment:41 mantepse]:
> I don't know what to do with
> {{{
>             sage: from sage.graphs.linearextensions import LinearExtensions
>             sage: D = DiGraph({ 0:[1,2], 1:[3], 2:[3,4] })
>             sage: l = LinearExtensions(D)
>             sage: l == loads(dumps(l))
>             True
> }}}
> (because this now gives `False`)

Because `Parent` does not have an `__eq__` method (so it defaults to compare by id, which is obviously false).

> Also, maybe it would be better to deprecate the class `LinearExtensions` completely, the class `LinearExtensionsOfPoset` should be a good replacement (and might be renamed `LinearExtensions`).

`LinearExtensions` was serving as an iterator object that yielded low level objects. Now this is done by your cython iterator. So +1 for deprecating it, -1 from saying `LinearExtensionsOfPoset` is a replacement.

Also, I have a general -1 on all of those `sorted`. They should not be necessary, and within code, they can be (relatively) expensive when not needed.


---

Comment by git created at 2018-09-04 16:27:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-09-04 16:35:19

Travis, I need some help with the deprecation message and the `sorted` issue.

* I think the deprecation is mainly (but not exclusively) to direct the user to alternatives.  Thus I'd say it's `DiGraph.topological_sort_generator` and `LinearExtensionsOfPoset`.  You wrote that you disagree with `LinearExtensionsOfPoset`, could you please expand why?

* `LinearExtensions` sorted it's result, and I think it's fine to leave it that way in the deprecated class.  However, in `LinearExtensionsOfPoset` I certainly do not want to sort.  Should I remove the sorting from the doctests too?

* `topological_sort_generator` returns a sorted list.  Should I create a new method `topological_sort_iterator`, which is an iterator, and deprecate the old method, or should I silently modify the old method?

* I would actually like to advertise `LinearExtensionsOfPoset` as main entry point, and I think this should also be a method of `Poset`.  What do you think?


---

Comment by tscrim created at 2018-09-04 22:52:30

Replying to [comment:46 mantepse]:
> * I think the deprecation is mainly (but not exclusively) to direct the user to alternatives.  Thus I'd say it's `DiGraph.topological_sort_generator` and `LinearExtensionsOfPoset`.  You wrote that you disagree with `LinearExtensionsOfPoset`, could you please expand why?

As per comment:44, `LinearExtensionsOfPoset` does not return a low-level object (in this case, a list). It is not equivalent or an alternative as a DAG is not a poset.

> * `LinearExtensions` sorted it's result, and I think it's fine to leave it that way in the deprecated class.  However, in `LinearExtensionsOfPoset` I certainly do not want to sort.  Should I remove the sorting from the doctests too?

Yes. It is not machine dependent, right? There is no point in adding useless things (e.g. sorting) to doctests or code.

> * `topological_sort_generator` returns a sorted list.  Should I create a new method `topological_sort_iterator`, which is an iterator, and deprecate the old method, or should I silently modify the old method?

That it was sorting things is an implementation detail. There is nothing in the documentation about guaranteeing that the linear extensions returned are in a particular order.

> * I would actually like to advertise `LinearExtensionsOfPoset` as main entry point, and I think this should also be a method of `Poset`.  What do you think?

Strong -1 on having `LinearExtensionsOfPoset` as a global entry point and suggesting it in any documentation. You should always go through `Poset(foo).linear_extensions()`. This is natural and helps keeps the global namespace clean.


---

Comment by mantepse created at 2018-09-05 04:49:16

Oh, I didn't realize that `Poset` has a method returning `LinearExtensionsOfPoset`...


---

Comment by mantepse created at 2018-09-05 05:04:48

I am now removing the sorted from the doctests, but I must say that I think this is wrong, for the following reasons:

* it saves no time (because sorting a list of 4 elements is not very costly)

* it makes the doctests less expressive: adding the `sorted` also tells the user not to rely on the order

* it creates a lot of work and larger diffs.

I am totally with you to remove the sorted from the methods, however.


---

Comment by git created at 2018-09-05 05:45:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-09-05 06:29:11

I won't be able to unsort soon, sorry.


---

Comment by git created at 2018-09-10 14:12:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-20 09:06:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-20 09:49:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-11-20 09:49:43

I am now going to remove the sorting from the doctests.


---

Comment by git created at 2018-11-20 10:38:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-11-20 10:39:35

Please check that this "unsorting" also works with python3. Yes, I know that this is a burden..


---

Comment by mantepse created at 2018-11-20 10:40:13

The calls to `sorted` are now also removed in doctests.  Please review!


---

Comment by mantepse created at 2018-11-20 10:40:13

Changing status from needs_info to needs_review.


---

Comment by mantepse created at 2018-11-20 10:43:59

Replying to [comment:57 chapoton]:
> Please check that this "unsorting" also works with python3. Yes, I know that this is a burden..

It was not my idea not to sort, and I explained well why I think that sorting shoult be done, to no avail.  I just spent more than an hour to remove all the sorts, and I have no idea how to do this with python3.

Excuse me, it's absolutely not your fault, but if this was wasted time, I'm really pissed off.


---

Comment by chapoton created at 2018-11-20 10:48:54

I am sorry, because I could in fact have told you a bit earlier. I did not want to interfere, but then I feeled obliged to do so.

The point is: are we sure that the order in which the linear extensions are produced is deterministic ? 

You need to check that the doctests that you take great care to modify will not break on a python3-build sage. I have no available time to do that for you. This means building another copy of sage, and running the doctests..


---

Comment by chapoton created at 2018-11-20 10:53:36

I am right now trying your branch on a python3-sage..


---

Comment by chapoton created at 2018-11-20 10:58:01

ok, this seems to work smoothly on python3. So let the review process go on.


---

Comment by mantepse created at 2018-11-20 11:06:14

OK, now building with python3.


---

Comment by mantepse created at 2018-11-20 11:29:36

Replying to [comment:60 chapoton]:
> I am sorry, because I could in fact have told you a bit earlier. I did not want to interfere, but then I feeled obliged to do so.

No problem, I very much value your work, and I overreacted, because I did not and do not see any sense in removing the sorting, as I explained above.  (In fact, putting in the sorting also took some time.)

I hope that this can be merged soon, so #25865 can be merged, too.


---

Comment by tscrim created at 2018-11-20 17:43:05

Thank you for removing the unnecessary sorting.

The patchbot is getting one failure:

```
File "src/sage/combinat/posets/poset_examples.py", line 1400, in sage.combinat.posets.poset_examples.Posets.YoungDiagramPoset
Failed example:
    P.cover_relations()
Expected:
    [[(0, 0), (1, 0)], [(0, 0), (0, 1)], [(1, 0), (1, 1)],
     [(0, 1), (1, 1)]]
Got:
    [[(0, 0), (0, 1)], [(0, 0), (1, 0)], [(0, 1), (1, 1)], [(1, 0), (1, 1)]]
```

Also, before you whine about this, this was _not_ affected by the sorting changes.


---

Comment by mantepse created at 2018-11-20 18:12:19

This is. #26586


---

Comment by tscrim created at 2018-11-20 18:16:29

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-11-20 18:16:29

Okay, then positive review.


---

Comment by mantepse created at 2018-11-20 19:38:24

Thank you!


---

Comment by vbraun created at 2018-11-21 19:53:01

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-11-21 19:53:32

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2018-11-21 20:59:14

#26586 is not a dependency of this ticket as that problem already exists and is independent of this ticket.


---

Comment by tscrim created at 2018-11-21 21:00:15

I wasn't aware of the #26586 issue before this. Or does this ticket make #26586 now appear without running the doctests with `--gc=never`?


---

Comment by mantepse created at 2018-11-21 21:06:28

No, it is not really a dependency.  What happens is that I was not using `--long` on my laptop, but the patchbot is.

The problem exists with and without this branch, but this branch modifies the output.


---

Comment by vbraun created at 2018-11-22 00:07:19

For whatever reason this ticket excascerbates the problem; I'm not going to merge it if it makes half of the buildbots fail.


---

Comment by vbraun created at 2018-11-22 00:07:19

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-12-24 23:33:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-12-25 00:26:26

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-12-25 01:04:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-25 14:08:08

Merge conflict


---

Comment by vbraun created at 2018-12-25 14:08:08

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-12-28 15:12:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-12-28 15:13:35

Essentially trivial merge.


---

Comment by mantepse created at 2018-12-28 15:13:47

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-12-29 02:20:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-30 09:15:32

Resolution: fixed
