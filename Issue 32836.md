# Issue 32836: Segmentation fault in face iterator (still)

Issue created by migration from https://trac.sagemath.org/ticket/33073

Original creator: vbraun

Original creation time: 2021-12-23 20:35:02

CC:  tmonteil tscrim @kliem

This was not fixed in #32827, still f'ed on 32-bit (here: Debian 10 32-bit):

```
**********************************************************************
Tests run before process (pid=3518194) failed:
sage: p = polytopes.hypercube(2) ## line 82 ##
sage: from sage.geometry.polyhedron.base import is_Polyhedron ## line 83 ##
sage: is_Polyhedron(p) ## line 84 ##
True
sage: is_Polyhedron(123456) ## line 86 ##
False
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 88 ##
0
sage: p = Polyhedron() ## line 125 ##
sage: TestSuite(p).run() ## line 126 ##
sage: p = Polyhedron(vertices=[(1,0), (0,1)], rays=[(1,1)], base_ring=ZZ) ## line 130 ##
sage: TestSuite(p).run() ## line 131 ##
sage: p=polytopes.flow_polytope(digraphs.DeBruijn(3,2)) ## line 135 ##
sage: TestSuite(p).run() ## line 136 ##
free(): invalid next size (fast)
------------------------------------------------------------------------
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-i386-linux-gnu.so(+0x5602)[0xf5df2602]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-i386-linux-gnu.so(+0x57c6)[0xf5df27c6]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/cysignals/signals.cpython-39-i386-linux-gnu.so(+0x7d0a)[0xf5df4d0a]
linux-gate.so.1(__kernel_sigreturn+0x0)[0xf7f14570]
linux-gate.so.1(__kernel_vsyscall+0x9)[0xf7f14559]
/lib/i386-linux-gnu/libc.so.6(gsignal+0xc2)[0xf787a382]
/lib/i386-linux-gnu/libc.so.6(abort+0xf0)[0xf78642b6]
/lib/i386-linux-gnu/libc.so.6(+0x70d2c)[0xf78bbd2c]
/lib/i386-linux-gnu/libc.so.6(+0x77aed)[0xf78c2aed]
/lib/i386-linux-gnu/libc.so.6(+0x791fb)[0xf78c41fb]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x5123)[0xa5296123]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x7166)[0xa5298166]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x712c)[0xa529812c]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x712c)[0xa529812c]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x712c)[0xa529812c]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x712c)[0xa529812c]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.cpython-39-i386-linux-gnu.so(+0x712c)[0xa529812c]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-39-i386-linux-gnu.so(+0x3a097)[0xa52e2097]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-39-i386-linux-gnu.so(+0x21af6)[0xa52c9af6]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/geometry/polyhedron/combinatorial_polyhedron/base.cpython-39-i386-linux-gnu.so(+0x437c2)[0xa52eb7c2]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(PyObject_RichCompare+0x95)[0xf7c50005]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(_PyEval_EvalFrameDefault+0x333d)[0xf7bcdb0d]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x1468bc)[0xf7cdc8bc]
[...]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(+0x19bf90)[0xf7d31f90]
/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/libpython3.9.so.1.0(Py_BytesMain+0x29)[0xf7d32039]
python3(+0x1087)[0x5663b087]
/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf1)[0xf7865b41]
python3(_start+0x31)[0x5663b0d1]
------------------------------------------------------------------------
Attaching gdb to process id 3518194.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2021-12-24 01:25:19

Confirmed using `tox -e docker-debian-buster-standard-i386`


---

Comment by mkoeppe created at 2021-12-24 03:20:58


```
==22168== Invalid write of size 4
==22168==    at 0x24B7E54F: _sparse_bitset_operation (bitset_intrinsics.h:475)
==22168==    by 0x24B7E54F: __pyx_fuse_1__pyx_f_4sage_15data_structures_11bitset_base_sparse_bitset_intersection (list_of_faces.c:12507)

==22168== Invalid read of size 4
==22168==    at 0x24B7EA40: _sparse_bitset_cmp (bitset_intrinsics.h:233)
==22168==    by 0x24B7EA40: __pyx_fuse_1__pyx_f_4sage_15data_structures_11bitset_base_bitset_issubset (list_of_faces.c:9478)
==22168==    by 0x24B7EA40: __pyx_fuse_1__pyx_f_4sage_8geometry_10polyhedron_24combinatorial_polyhedron_19face_data_structure_face_issubset_fused (list_of_faces.c:14757)
```



---

Comment by mkoeppe created at 2021-12-24 07:25:32

These go away if I make the following change:

```
diff --git a/src/sage/data_structures/bitset_base.pxd b/src/sage/data_structures/bitset_base.pxd
index ddbde12175..1e5295a828 100644
--- a/src/sage/data_structures/bitset_base.pxd
+++ b/src/sage/data_structures/bitset_base.pxd
@@ -182,7 +182,7 @@ cdef inline bint bitset_init(fused_bitset_t bits, mp_bitcnt_t size) except -1:
         bits.mem = check_calloc(bits.limbs + extra, LIMB_SIZE)
         bits.bits = <mp_limb_t*> align(bits.mem, ALIGNMENT)
         bits.non_zero_chunks_are_initialized = False
-        bits.non_zero_chunks = <mp_bitcnt_t*> check_allocarray((bits.limbs*LIMB_SIZE) / ALIGNMENT, sizeof(mp_bitcnt_t))
+        bits.non_zero_chunks = <mp_bitcnt_t*> check_allocarray(2 * (bits.limbs*LIMB_SIZE) / ALIGNMENT, sizeof(mp_bitcnt_t))
 
 cdef inline bint bitset_check_alignment(fused_bitset_t bits):
     """
```


So it would be a good idea to check whether chunks are counted correctly.

Overall the design seems to be a bit brittle, as the meaning of a chunk is determined at compile time depending on intrinsics flags -- which might differ between different compilation units. Perhaps the boolean `non_zero_chunks_are_initialized` should be replaced by the chunk size so that code will refuse to operate on it if it does not agree with the compile-time chunk size.


---

Comment by @kliem created at 2021-12-24 10:47:22

Ok, thanks for the help.

Looks like a stupid bug:


```
#if __AVX__
    const mp_bitcnt_t ALIGNMENT = 32; 
#elif __SSE4_1__
    const mp_bitcnt_t ALIGNMENT = 16; 
#else
    const mp_bitcnt_t ALIGNMENT = 8;
#endif
```


However, the last case should be `LIMB_SIZE` aka `sizeof(mp_limb_t)` instead of 8.


---

Comment by @kliem created at 2021-12-24 10:48:43

The improvement according to `non_zero_chunks_are_initialized` sounds good.


---

Comment by @kliem created at 2021-12-24 11:06:04

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-12-24 11:06:04

New commits:


---

Comment by @kliem created at 2021-12-24 11:23:11

Replying to [comment:6 gh-kliem]:
> The improvement according to `non_zero_chunks_are_initialized` sounds good.

Actually, I don't know how to accomplish this. Even the number of limbs depends on the intrinsic flags. Compiling the same module twice with different flags and then mixing types of them is asking for trouble.

If you are trying to intersect two bitsets from different compilation units, this might not work.
What do we do instead:
1. Make it work across compilation units? This might be difficult if not impossible. Unless we just hardcode alignment to 32. In this case alignment would differ from chunk size. This would work with the approach suggested above, but the bitsets might become a bit longer (at least the sparse bitsets).
2. Raise an error, if trying to mix different compilation units. This might be possible by encoding the type in `sparse_bitset_t`. Then the structures would we imcompatible.


---

Comment by mkoeppe created at 2021-12-24 11:30:09

Raising an error would be enough, I'd think

This could be a follow up ticket


---

Comment by @kliem created at 2021-12-24 13:00:24

Replying to [comment:1 mkoeppe]:
> Confirmed using `tox -e docker-debian-buster-standard-i386`

I still don't understand how this works and I won't figure this out today. I ran this command (required sudo) but this did not reveal anything.


---

Comment by mkoeppe created at 2021-12-24 19:26:30


```
$ tox -e docker-debian-buster-standard-i386 
docker-debian-buster-standard-i386 run-test-pre: PYTHONHASHSEED='135639071'
docker-debian-buster-standard-i386 run-test: commands[0] | bash -c 'build/bin/write-dockerfile.sh debian "--has-file=spkg-configure.m4 :standard:" yes no "_bootstrap  " > /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/.tox/docker-debian-buster-standard-i386/Dockerfile'
docker-debian-buster-standard-i386 run-test: commands[1] | bash -c 'for docker_target in with-targets; do  BUILD_TAG=sage-docker-debian-buster-standard-i386-$docker_target:$(git describe --dirty --always);  DOCKER_BUILDKIT=0  docker build . -f /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/.tox/docker-debian-buster-standard-i386/Dockerfile  --target $docker_target  --tag $BUILD_TAG  --build-arg EXTRA_CONFIGURE_ARGS="--enable-experimental-packages --enable-download-from-upstream-url  --with-system-python3=yes  "  --build-arg BASE_IMAGE=i386/debian:buster  --build-arg BOOTSTRAP="./bootstrap"  --build-arg TARGETS_PRE="$(if test -n "$TARGETS_PRE"; then echo $TARGETS_PRE; else echo all-sage-local; fi)"  --build-arg TARGETS="build"  --build-arg TARGETS_OPTIONAL="ptest"  ; status=$?;  if [ $status != 0 ]; then BUILD_TAG="$BUILD_TAG-failed"; docker commit $(docker ps -l -q) $BUILD_TAG; fi;  echo $BUILD_TAG >> /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/.tox/docker-debian-buster-standard-i386/Dockertags;  if [ x"" != x ]; then echo Pushing $BUILD_TAG; docker push $BUILD_TAG || echo "(ignoring errors)"; fi;  if [ $status != 0 ]; then exit $status; fi; done'
Sending build context to Docker daemon  118.5MB
Step 1/44 : ARG BASE_IMAGE=ubuntu:latest
Step 2/44 : FROM ${BASE_IMAGE} as with-system-packages
 ---> 498c9d2ae6b9
Step 3/44 : ENV PACKAGES=" libgd-dev libgmp-dev tox xz-utils liblzma-dev libprimesieve-dev libiml-dev  gfan gfortran libncurses5-dev python3 libpython3
....
[networkx-2.6.3] installing. Log file: /sage/logs/pkgs/networkx-2.6.3.log
[sagetex-3.5] installing. Log file: /sage/logs/pkgs/sagetex-3.5.log
  [sagetex-3.5] successfully installed.
  [networkx-2.6.3] successfully installed.
make[2]: Leaving directory '/sage/build/make'

real	26m40.492s
user	155m41.452s
sys	7m41.957s
SAGE_CHECK=warn, so scanning the log files. This may take a few seconds.

* package:         giac-1.6.0.47p3
  last build time: Dec 24 00:48
  log file:        /sage/logs/pkgs/giac-1.6.0.47p3.log
Sage build/upgrade complete!
make[1]: Leaving directory '/sage'
Removing intermediate container c295ef8c2909
 ---> 307f725722cf
[Warning] One or more build-args [TARGETS_OPTIONAL] were not consumed
Successfully built 307f725722cf
Successfully tagged sage-docker-debian-buster-standard-i386-with-targets:9.5.beta9-203-g159f1e3274

Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
_______________________________________________________________________ summary _______________________________________________________________________
  docker-debian-buster-standard-i386: commands succeeded
  congratulations :)
egret:~/s/sage/sage-rebasing/worktree-gcc11 ((159f1e3274...) $%)$ docker run -it sage-docker-debian-buster-standard-i386-with-targets:9.5.beta9-203-g159f1e3274
WARNING: The requested image's platform (linux/386) does not match the detected host platform (linux/amd64) and no specific platform was requested
root@4f76eeaca173:/sage# ./sage -tp src/sage/geometry/polyhedron/
no stored timings available
Running doctests with ID 2021-12-24-19-22-05-f11b7dab.
Using --optional=debian,dochtml,pip,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,tdlib
Sorting sources by runtime so that slower doctests are run first....
Doctesting 49 files using 8 threads.
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/__init__.py
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/all.py
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/backend_normaliz.py
    [45 tests, 0.67 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/backend_cdd.py
    [33 tests, 2.14 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base1.py
    [147 tests, 2.18 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/backend_polymake.py
    [9 tests, 4.05 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base0.py
    [204 tests, 4.46 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/backend_cdd_rdf.py
    [39 tests, 4.87 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base_QQ.py
    [38 tests, 1.40 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base2.py
    [86 tests, 3.57 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/cdd_file_format.py
    [10 tests, 0.02 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/__init__.py
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/backend_field.py
    [63 tests, 6.24 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base_ZZ.py
    [63 tests, 2.41 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/backend_ppl.py
    [66 tests, 7.59 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/conversions.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/face_data_structure.pxd
    [0 tests, 0.05 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base3.py
    [325 tests, 4.58 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/conversions.pyx
    [62 tests, 0.51 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/face_list_data_structure.pxd
    [0 tests, 0.06 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/face_list_data_structure.pyx
    [0 tests, 0.02 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/polyhedron_face_lattice.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/polyhedron_face_lattice.pyx
    [51 tests, 0.23 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/combinatorial_face.pyx
    [239 tests, 2.06 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/base.pyx
    [626 tests, 2.54 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.pyx
    [71 tests, 0.60 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base_RDF.py
    [14 tests, 4.09 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/lattice_euclidean_group_element.py
    [27 tests, 0.09 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/double_description.py
    [116 tests, 0.49 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/double_description_inhomogeneous.py
    [72 tests, 0.40 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/misc.py
    [12 tests, 0.03 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/modules/__init__.py
    [0 tests, 0.00 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/modules/formal_polyhedra_module.py
    [44 tests, 0.20 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/constructor.py
    [91 tests, 1.01 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.pyx
    [391 tests, 1.98 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/palp_database.py
    [59 tests, 2.28 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/face.py
    [162 tests, 3.28 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/ppl_lattice_polygon.py
    [81 tests, 3.23 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/representation.py
    [338 tests, 0.95 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base_mutable.py
    [57 tests, 7.73 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/ppl_lattice_polytope.py
    [174 tests, 1.94 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/parent.py
    [188 tests, 5.57 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/plot.py
    [236 tests, 6.37 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/library.py
    [276 tests, 31.12 s]
sage -t --random-seed=40972520201426508611197079880425149971 src/sage/geometry/polyhedron/base.py
    [845 tests, 44.48 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 45.0 seconds
    cpu time: 146.6 seconds
    cumulative wall time: 165.5 seconds
Features detected for doctesting: sage.combinat,sage.graphs,sage.plot,sage.rings.number_field,sage.symbolic
================================================================= test session starts =================================================================
platform linux -- Python 3.7.3, pytest-6.2.5, py-1.10.0, pluggy-1.0.0
rootdir: /sage/src, configfile: tox.ini
collected 0 items                                                                                                                                     

================================================================ no tests ran in 0.03s ================================================================
```



---

Comment by mkoeppe created at 2021-12-24 19:29:37

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-24 19:52:05

`valgrind` confirms the errors are gone:

```
root@4f76eeaca173:/sage# eval ./configure $(./config.status --config) --enable-fat-binary && make primecount-clean sagelib-clean build
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /bin/mkdir -p
....
root@4f76eeaca173:/sage# cat > face.sage
from sage.geometry.polyhedron.combinatorial_polyhedron.base import incidence_matrix_to_bit_rep_of_facets
from sage.geometry.polyhedron.combinatorial_polyhedron.base import incidence_matrix_to_bit_rep_of_Vrep
for _ in range(10):
    points = tuple(tuple(randint(-1000,1000) for _ in range(10))
                   for _ in range(randint(3,15)))
    P = Polyhedron(vertices=points)
    inc = P.incidence_matrix()
    mod_inc = inc.delete_columns([i for i,V in enumerate(P.Hrepresentation()) if V.is_equation()])
    facets = incidence_matrix_to_bit_rep_of_facets(mod_inc)
    vertices = incidence_matrix_to_bit_rep_of_Vrep(mod_inc)
    d1 = P.dimension()
    if d1 == 0:
        continue
    d2 = facets.compute_dimension()
    d3 = vertices.compute_dimension()
    if not d1 == d2 == d3:
        print('calculation_dimension() seems to be incorrect') ## line 235 ##

root@4f76eeaca173:/sage# curl -O https://raw.githubusercontent.com/python/cpython/main/Misc/valgrind-python.supp
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  8827  100  8827    0     0  24794      0 --:--:-- --:--:-- --:--:-- 24794

root@4f76eeaca173:/sage# PYTHONMALLOC=malloc valgrind --suppressions=valgrind-python.supp --suppressions=src/sage/ext_data/valgrind/sage.supp venv/bin/python3 -c 'from sage.all import *; load("face.sage")'
==21882== Memcheck, a memory error detector
==21882== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==21882== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info
==21882== Command: venv/bin/python3 -c from\ sage.all\ import\ *;\ load("face.sage")
==21882== 
==21882== Warning: client switching stacks?  SP change: 0xfec6dafc --> 0x5254b30
==21882==          to suppress, use: --max-stackframe=106852404 or greater
==21882== Invalid read of size 4
==21882==    at 0x5423C36: _sig_on_trampoline (implementation.c:324)
==21882==    by 0x408728B: advise_stack_range (allocatestack.c:392)
==21882==    by 0x408728B: start_thread (pthread_create.c:576)
==21882==    by 0x43066D5: clone (clone.S:108)
==21882==  Address 0x5254b4c is 127,212 bytes inside a block of size 135,168 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x5423A60: setup_trampoline (implementation.c:342)
==21882==    by 0x5426922: setup_cysignals_handlers (implementation.c:489)
==21882==    by 0x5426922: __pyx_pf_9cysignals_7signals_4init_cysignals (signals.c:2809)
==21882==    by 0x5426922: __pyx_pw_9cysignals_7signals_5init_cysignals (signals.c:2692)
==21882==    by 0x5423562: __Pyx_CyFunction_CallMethod (signals.c:6188)
==21882==    by 0x82133DA: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x8193DAB: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x81A3231: ??? (in /usr/bin/python3.7)
==21882==    by 0x821219F: _PyMethodDef_RawFastCallDict (in /usr/bin/python3.7)
==21882==    by 0x82123AE: PyCFunction_Call (in /usr/bin/python3.7)
==21882==    by 0x8194A30: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882== 
==21882== Invalid write of size 4
==21882==    at 0x5423C41: _sig_on_trampoline (implementation.c:324)
==21882==    by 0x408728B: advise_stack_range (allocatestack.c:392)
==21882==    by 0x408728B: start_thread (pthread_create.c:576)
==21882==    by 0x43066D5: clone (clone.S:108)
==21882==  Address 0x5254b4c is 127,212 bytes inside a block of size 135,168 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x5423A60: setup_trampoline (implementation.c:342)
==21882==    by 0x5426922: setup_cysignals_handlers (implementation.c:489)
==21882==    by 0x5426922: __pyx_pf_9cysignals_7signals_4init_cysignals (signals.c:2809)
==21882==    by 0x5426922: __pyx_pw_9cysignals_7signals_5init_cysignals (signals.c:2692)
==21882==    by 0x5423562: __Pyx_CyFunction_CallMethod (signals.c:6188)
==21882==    by 0x82133DA: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x8193DAB: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x81A3231: ??? (in /usr/bin/python3.7)
==21882==    by 0x821219F: _PyMethodDef_RawFastCallDict (in /usr/bin/python3.7)
==21882==    by 0x82123AE: PyCFunction_Call (in /usr/bin/python3.7)
==21882==    by 0x8194A30: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882== 
==21882== Invalid read of size 4
==21882==    at 0x5423C4F: _sig_on_trampoline (implementation.c:326)
==21882==    by 0x408728B: advise_stack_range (allocatestack.c:392)
==21882==    by 0x408728B: start_thread (pthread_create.c:576)
==21882==    by 0x43066D5: clone (clone.S:108)
==21882==  Address 0x5254b4c is 127,212 bytes inside a block of size 135,168 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x5423A60: setup_trampoline (implementation.c:342)
==21882==    by 0x5426922: setup_cysignals_handlers (implementation.c:489)
==21882==    by 0x5426922: __pyx_pf_9cysignals_7signals_4init_cysignals (signals.c:2809)
==21882==    by 0x5426922: __pyx_pw_9cysignals_7signals_5init_cysignals (signals.c:2692)
==21882==    by 0x5423562: __Pyx_CyFunction_CallMethod (signals.c:6188)
==21882==    by 0x82133DA: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x8193DAB: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x81A3231: ??? (in /usr/bin/python3.7)
==21882==    by 0x821219F: _PyMethodDef_RawFastCallDict (in /usr/bin/python3.7)
==21882==    by 0x82123AE: PyCFunction_Call (in /usr/bin/python3.7)
==21882==    by 0x8194A30: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882== 
==21882== Warning: client switching stacks?  SP change: 0x5254aec --> 0xfec6db40
==21882==          to suppress, use: --max-stackframe=106852268 or greater
==21882== Warning: set address range perms: large range [0x8e6d9000, 0xce6d9000) (defined)
==21882== Warning: set address range perms: large range [0x8e6d9000, 0xce6d9000) (noaccess)
==21882== Warning: set address range perms: large range [0x8e6d9000, 0xce6d9000) (defined)
==21882== Warning: set address range perms: large range [0x8e6d9000, 0xce308000) (noaccess)
==21893== Warning: invalid file descriptor 1048564 in syscall close()
==21893== Warning: invalid file descriptor 1048565 in syscall close()
==21893== Warning: invalid file descriptor 1048566 in syscall close()
==21893== Warning: invalid file descriptor 1048567 in syscall close()
==21893==    Use --log-fd=<number> to select an alternative log fd.
==21893== Warning: invalid file descriptor 1048568 in syscall close()
==21893== Warning: invalid file descriptor 1048569 in syscall close()
==21882== Invalid write of size 4
==21882==    at 0x5D62C47: __gmpz_mul (in /usr/lib/i386-linux-gnu/libgmp.so.10.3.2)
==21882==    by 0x1834D279: __pyx_pf_4sage_5rings_7integer_7Integer_74__mul__ (integer.c:13197)
==21882==    by 0x1834D279: __pyx_pw_4sage_5rings_7integer_7Integer_75__mul__ (integer.c:13143)
==21882==    by 0x8124DC5: PyNumber_Multiply (in /usr/bin/python3.7)
==21882==    by 0x819105D: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x82139C9: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882==    by 0x81D125B: ??? (in /usr/bin/python3.7)
==21882==    by 0x8212FBE: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818D99B: ??? (in /usr/bin/python3.7)
==21882==    by 0x8190D69: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x82139C9: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882==  Address 0xc0bd03c is 0 bytes after a block of size 4 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x1834B302: sig_malloc (integer.c:46743)
==21882==    by 0x1834B302: __pyx_f_9cysignals_6memory_check_malloc (integer.c:47410)
==21882==    by 0x1834B302: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:44849)
==21882==    by 0x1834D2E3: __pyx_f_4sage_3ext_7stdsage_PY_NEW (integer.c:47772)
==21882==    by 0x1834D2E3: __pyx_pf_4sage_5rings_7integer_7Integer_74__mul__ (integer.c:13182)
==21882==    by 0x1834D2E3: __pyx_pw_4sage_5rings_7integer_7Integer_75__mul__ (integer.c:13143)
==21882==    by 0x8124DC5: PyNumber_Multiply (in /usr/bin/python3.7)
==21882==    by 0x819105D: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x82139C9: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882==    by 0x81D125B: ??? (in /usr/bin/python3.7)
==21882==    by 0x8212FBE: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818D99B: ??? (in /usr/bin/python3.7)
==21882==    by 0x8190D69: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882== 
==21882== Invalid write of size 4
==21882==    at 0x5D62C47: __gmpz_mul (in /usr/lib/i386-linux-gnu/libgmp.so.10.3.2)
==21882==    by 0x1834D279: __pyx_pf_4sage_5rings_7integer_7Integer_74__mul__ (integer.c:13197)
==21882==    by 0x1834D279: __pyx_pw_4sage_5rings_7integer_7Integer_75__mul__ (integer.c:13143)
==21882==    by 0x8124DC5: PyNumber_Multiply (in /usr/bin/python3.7)
==21882==    by 0x18350703: __pyx_pf_4sage_5rings_7integer_7Integer_224squarefree_part (integer.c:35979)
==21882==    by 0x18363541: __pyx_pw_4sage_5rings_7integer_7Integer_225squarefree_part (integer.c:35325)
==21882==    by 0x8211D23: _PyMethodDef_RawFastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818D90F: ??? (in /usr/bin/python3.7)
==21882==    by 0x8193B83: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x818FA55: PyEval_EvalCodeEx (in /usr/bin/python3.7)
==21882==    by 0x19F61D5D: __Pyx_PyFunction_FastCallDict.constprop.91 (real_mpfi.c:38643)
==21882==    by 0x19F66845: __Pyx_PyObject_CallOneArg (real_mpfi.c:38696)
==21882==  Address 0xc0bd03c is 0 bytes after a block of size 4 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x1834B302: sig_malloc (integer.c:46743)
==21882==    by 0x1834B302: __pyx_f_9cysignals_6memory_check_malloc (integer.c:47410)
==21882==    by 0x1834B302: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:44849)
==21882==    by 0x1834D2E3: __pyx_f_4sage_3ext_7stdsage_PY_NEW (integer.c:47772)
==21882==    by 0x1834D2E3: __pyx_pf_4sage_5rings_7integer_7Integer_74__mul__ (integer.c:13182)
==21882==    by 0x1834D2E3: __pyx_pw_4sage_5rings_7integer_7Integer_75__mul__ (integer.c:13143)
==21882==    by 0x8124DC5: PyNumber_Multiply (in /usr/bin/python3.7)
==21882==    by 0x819105D: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x82139C9: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882==    by 0x81D125B: ??? (in /usr/bin/python3.7)
==21882==    by 0x8212FBE: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818D99B: ??? (in /usr/bin/python3.7)
==21882==    by 0x8190D69: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882== 
==21882== Invalid write of size 4
==21882==    at 0x5D62C47: __gmpz_mul (in /usr/lib/i386-linux-gnu/libgmp.so.10.3.2)
==21882==    by 0x1834D279: __pyx_pf_4sage_5rings_7integer_7Integer_74__mul__ (integer.c:13197)
==21882==    by 0x1834D279: __pyx_pw_4sage_5rings_7integer_7Integer_75__mul__ (integer.c:13143)
==21882==    by 0x8124DC5: PyNumber_Multiply (in /usr/bin/python3.7)
==21882==    by 0x82576AC: ??? (in /usr/bin/python3.7)
==21882==    by 0x821206C: _PyMethodDef_RawFastCallDict (in /usr/bin/python3.7)
==21882==    by 0x82123AE: PyCFunction_Call (in /usr/bin/python3.7)
==21882==    by 0x8215A1B: PyObject_CallObject (in /usr/bin/python3.7)
==21882==    by 0x7601BEC: __pyx_f_4sage_9structure_6coerce_13CoercionModel_bin_op (coerce.c:10714)
==21882==    by 0x1834D1D5: __pyx_pf_4sage_5rings_7integer_7Integer_74__mul__ (integer.c:13289)
==21882==    by 0x1834D1D5: __pyx_pw_4sage_5rings_7integer_7Integer_75__mul__ (integer.c:13143)
==21882==    by 0x811F93C: ??? (in /usr/bin/python3.7)
==21882==    by 0x812482E: PyNumber_InPlaceMultiply (in /usr/bin/python3.7)
==21882==    by 0x8192D86: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==  Address 0x461d59c is 0 bytes after a block of size 4 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x1834B302: sig_malloc (integer.c:46743)
==21882==    by 0x1834B302: __pyx_f_9cysignals_6memory_check_malloc (integer.c:47410)
==21882==    by 0x1834B302: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:44849)
==21882==    by 0x8212F41: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x8193DAB: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x8212948: _PyFunction_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818FF6F: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x74DA63F: __Pyx_PyFunction_FastCallNoKw (parent.c:29959)
==21882==    by 0x74DCFBE: __Pyx_PyFunction_FastCallDict.constprop.79 (parent.c:29991)
==21882==    by 0x74E0F07: __Pyx_PyObject_Call2Args (parent.c:30261)
==21882==    by 0x750AEF4: __pyx_pf_4sage_9structure_6parent_6Parent_44__getitem__ (parent.c:11407)
==21882==    by 0x750AEF4: __pyx_pw_4sage_9structure_6parent_6Parent_45__getitem__ (parent.c:11132)
==21882==    by 0x8125074: PyObject_GetItem (in /usr/bin/python3.7)
==21882== 
==21882== Invalid write of size 4
==21882==    at 0x5D57869: __gmpz_add (in /usr/lib/i386-linux-gnu/libgmp.so.10.3.2)
==21882==    by 0x1834CFBF: __pyx_pf_4sage_5rings_7integer_7Integer_60__add__ (integer.c:11627)
==21882==    by 0x1834CFBF: __pyx_pw_4sage_5rings_7integer_7Integer_61__add__ (integer.c:11573)
==21882==    by 0x8121744: PyNumber_Add (in /usr/bin/python3.7)
==21882==    by 0x80B0432: ??? (in /usr/bin/python3.7)
==21882==    by 0x8211C88: _PyMethodDef_RawFastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x81939ED: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x8212694: _PyFunction_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818FF6F: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x6F3ECC8: __Pyx_PyFunction_FastCallNoKw (element.c:37052)
==21882==    by 0x6F4490A: __Pyx_PyFunction_FastCallDict.constprop.128 (element.c:37092)
==21882==    by 0x6F4BCED: __Pyx_PyObject_Call2Args (element.c:37643)
==21882==    by 0x6F4BE7A: __pyx_f_4sage_9structure_7element_13ModuleElement__add_ (element.c:15611)
==21882==  Address 0x464d6e4 is 0 bytes after a block of size 4 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x1834B302: sig_malloc (integer.c:46743)
==21882==    by 0x1834B302: __pyx_f_9cysignals_6memory_check_malloc (integer.c:47410)
==21882==    by 0x1834B302: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:44849)
==21882==    by 0x8212F41: _PyObject_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x8193DAB: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x8212948: _PyFunction_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818FF6F: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x74DA63F: __Pyx_PyFunction_FastCallNoKw (parent.c:29959)
==21882==    by 0x74DCFBE: __Pyx_PyFunction_FastCallDict.constprop.79 (parent.c:29991)
==21882==    by 0x74E0F07: __Pyx_PyObject_Call2Args (parent.c:30261)
==21882==    by 0x750AEF4: __pyx_pf_4sage_9structure_6parent_6Parent_44__getitem__ (parent.c:11407)
==21882==    by 0x750AEF4: __pyx_pw_4sage_9structure_6parent_6Parent_45__getitem__ (parent.c:11132)
==21882==    by 0x8125074: PyObject_GetItem (in /usr/bin/python3.7)
==21882== 
==21882== Invalid write of size 4
==21882==    at 0x5D61D3D: __gmpz_lcm (in /usr/lib/i386-linux-gnu/libgmp.so.10.3.2)
==21882==    by 0xAAE0987: __pyx_f_4sage_5arith_9functions_LCM_list (functions.c:3347)
==21882==    by 0xAAE367A: __pyx_pf_4sage_5arith_9functions_2LCM_list (functions.c:3423)
==21882==    by 0xAAE367A: __pyx_pw_4sage_5arith_9functions_3LCM_list (functions.c:3407)
==21882==    by 0x8211B82: _PyMethodDef_RawFastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x81939ED: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x8212948: _PyFunction_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818D80E: ??? (in /usr/bin/python3.7)
==21882==    by 0x8193B83: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x82139C9: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882==    by 0x811B41F: ??? (in /usr/bin/python3.7)
==21882==  Address 0x2303fe84 is 0 bytes after a block of size 4 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x1834B302: sig_malloc (integer.c:46743)
==21882==    by 0x1834B302: __pyx_f_9cysignals_6memory_check_malloc (integer.c:47410)
==21882==    by 0x1834B302: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:44849)
==21882==    by 0xAAE0766: __Pyx_tp_new_kwargs (functions.c:2361)
==21882==    by 0xAAE0766: __pyx_f_4sage_5arith_9functions_LCM_list (functions.c:3081)
==21882==    by 0xAAE367A: __pyx_pf_4sage_5arith_9functions_2LCM_list (functions.c:3423)
==21882==    by 0xAAE367A: __pyx_pw_4sage_5arith_9functions_3LCM_list (functions.c:3407)
==21882==    by 0x8211B82: _PyMethodDef_RawFastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x81939ED: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x8212948: _PyFunction_FastCallKeywords (in /usr/bin/python3.7)
==21882==    by 0x818D80E: ??? (in /usr/bin/python3.7)
==21882==    by 0x8193B83: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x818E7A7: _PyEval_EvalCodeWithName (in /usr/bin/python3.7)
==21882==    by 0x82139C9: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882== 
==21882== Invalid write of size 4
==21882==    at 0x5D6C711: __gmpn_copyi_x86 (in /usr/lib/i386-linux-gnu/libgmp.so.10.3.2)
==21882==  Address 0x251a0fec is 0 bytes after a block of size 4 alloc'd
==21882==    at 0x403463B: malloc (vg_replace_malloc.c:299)
==21882==    by 0x1834B302: sig_malloc (integer.c:46743)
==21882==    by 0x1834B302: __pyx_f_9cysignals_6memory_check_malloc (integer.c:47410)
==21882==    by 0x1834B302: __pyx_f_4sage_5rings_7integer_fast_tp_new (integer.c:44849)
==21882==    by 0x1D8DED06: __Pyx_tp_new_kwargs (vector_integer_dense.c:2394)
==21882==    by 0x1D8DED06: __pyx_f_4sage_7modules_20vector_integer_dense_20Vector_integer_dense_get_unsafe (vector_integer_dense.c:4128)
==21882==    by 0xBBA874C: __pyx_pf_4sage_7modules_19free_module_element_17FreeModuleElement_43__getitem__ (free_module_element.c:13891)
==21882==    by 0xBBA874C: __pyx_pw_4sage_7modules_19free_module_element_17FreeModuleElement_44__getitem__ (free_module_element.c:13583)
==21882==    by 0x8125074: PyObject_GetItem (in /usr/bin/python3.7)
==21882==    by 0x819033A: _PyEval_EvalFrameDefault (in /usr/bin/python3.7)
==21882==    by 0x8213824: _PyFunction_FastCallDict (in /usr/bin/python3.7)
==21882==    by 0x81CFF48: ??? (in /usr/bin/python3.7)
==21882==    by 0x8115094: ??? (in /usr/bin/python3.7)
==21882==    by 0x1A469EF4: __pyx_f_4sage_6matrix_4args_10MatrixArgs_finalize_seq_seq (args.c:13540)
==21882==    by 0x1A46FF89: __pyx_f_4sage_6matrix_4args_10MatrixArgs_finalize (args.c:10094)
==21882==    by 0x1A46FF89: __pyx_f_4sage_6matrix_4args_10MatrixArgs_finalize (args.c:9342)
==21882==    by 0x1A462ABB: __pyx_f_4sage_6matrix_4args_10MatrixArgs_matrix (args.c:7757)
==21882== 
==21882== 
==21882== HEAP SUMMARY:
==21882==     in use at exit: 29,398,106 bytes in 306,444 blocks
==21882==   total heap usage: 2,262,268 allocs, 1,955,824 frees, 264,811,507 bytes allocated
==21882== 
==21882== LEAK SUMMARY:
==21882==    definitely lost: 174,625 bytes in 884 blocks
==21882==    indirectly lost: 33,637 bytes in 672 blocks
==21882==      possibly lost: 7,092,379 bytes in 119,875 blocks
==21882==    still reachable: 22,097,449 bytes in 185,012 blocks
==21882==                       of which reachable via heuristic:
==21882==                         newarray           : 1,483 bytes in 75 blocks
==21882==         suppressed: 16 bytes in 1 blocks
==21882== Rerun with --leak-check=full to see details of leaked memory
==21882== 
==21882== For counts of detected and suppressed errors, rerun with: -v
==21882== ERROR SUMMARY: 1344 errors from 9 contexts (suppressed: 0 from 0)
root@4f76eeaca173:/sage# 
```



---

Comment by tornaria created at 2021-12-26 03:30:10

On void linux 32 bit I was still getting failures on 3 polyhedron doctests, reported at https://groups.google.com/g/sage-release/c/vo_m79EHAVc/m/fsxF78bGBAAJ

I'll later check if this ticket fixes all of those.

It's funny how similar to #33081 this bug is... (completely unrelated though)


---

Comment by mkoeppe created at 2021-12-26 04:13:19

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-12-26 04:14:23

On `ubuntu-bionic` (https://github.com/mkoeppe/sage/runs/4634092648?check_suite_focus=true):

```
 [sagelib-9.5.beta9]   [57/60] [56/60] In file included from build/cythonized/sage/matroids/circuit_closures_matroid.c:667:0:
  [sagelib-9.5.beta9]   ./sage/data_structures/bitset_intrinsics.h:32:35: error: initializer element is not constant
  [sagelib-9.5.beta9]        const mp_bitcnt_t ALIGNMENT = LIMB_SIZE;
  [sagelib-9.5.beta9]                                      ^~~~~~~~~
```



---

Comment by @kliem created at 2021-12-26 18:12:49

Replying to [comment:16 mkoeppe]:
> On `ubuntu-bionic` (https://github.com/mkoeppe/sage/runs/4634092648?check_suite_focus=true):
> {{{
>  [sagelib-9.5.beta9]   [57/60] [56/60] In file included from build/cythonized/sage/matroids/circuit_closures_matroid.c:667:0:
>   [sagelib-9.5.beta9]   ./sage/data_structures/bitset_intrinsics.h:32:35: error: initializer element is not constant
>   [sagelib-9.5.beta9]        const mp_bitcnt_t ALIGNMENT = LIMB_SIZE;
>   [sagelib-9.5.beta9]                                      ^~~~~~~~~
> }}}

Makes no sense to me. `LIMB_SIZE` is of type `const mp_bitcnt_t`. 

I'll try a fix, a differet fix might be just to remove `const` from `ALIGNMENT`. It's not performance-critical, but I think it is good to declare constants as constants.


---

Comment by git created at 2021-12-26 18:13:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-12-26 18:15:13

https://github.com/kliem/sage/pull/51/checks

Feel free to make any adjustments needed to get this in. I won't be able to work on this the next couple of days.


---

Comment by mkoeppe created at 2021-12-26 19:05:12

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-12-26 20:30:42

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-26 20:30:42

This builds and tests OK, thanks!


---

Comment by tornaria created at 2021-12-27 02:09:49

All the previous segfaults I had while doctesting polyhedra are gone with this patch.

However I'm still getting one doctest failure namely:

```
sage: from sage.geometry.polyhedron.combinatorial_polyhedron.list_of_faces import ListOfFaces
sage: ListOfFaces(1, 2^32-1, 1)
<sage.geometry.polyhedron.combinatorial_polyhedron.list_of_faces.ListOfFaces object at 0x9b168ed0>
```

This works, but the doctest is expecting a `MemoryError: failed to allocate ...`

I guess this is trying to allocate `2^32-1` **bits** which is about `512M`, not quite large enough to give a memory error.

On 64 bits it fails without a question.

I think this doctest was introduced in #32827 and I'm not sure what is the intention. Should it be labelled as 64-bit only?


---

Comment by tornaria created at 2021-12-27 02:21:29

This is what I had in mind; seems to do the trick:

```
--- a/src/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.pyx
+++ b/src/sage/geometry/polyhedron/combinatorial_polyhedron/list_of_faces.pyx
@@ -156,10 +156,11 @@ cdef class ListOfFaces:
             sage: from memory_allocator.test import TestMemoryAllocator
             sage: t = TestMemoryAllocator()
             sage: m = t.size_t_max()
+            # The following is only certain to fail on 64-bit
             sage: ListOfFaces(1, m, 1)
-            Traceback (most recent call last):
+            Traceback (most recent call last):          # 64-bit
             ...
-            MemoryError: failed to allocate ...
+            MemoryError: failed to allocate ...         # 64-bit
         """
         face_list_free(self.data)
 
```



---

Comment by git created at 2021-12-27 02:28:33

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-12-27 02:28:33

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-12-27 03:28:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-29 21:43:16

Resolution: fixed


---

Comment by @kliem created at 2022-01-05 09:13:59

Thanks for the fix.
