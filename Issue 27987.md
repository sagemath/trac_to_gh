# Issue 27987: spkg-configure.m4 for lcalc

Issue created by migration from https://trac.sagemath.org/ticket/28224

Original creator: dimpase

Original creation time: 2019-07-21 10:15:25

CC:  embray isuruf arojas fbissey

Keywords: spkg-configure

Debian and Fedora package lcalc (Fedora calls the package `L-function-devel`).

One needs to check how well-patched they are.


---

Comment by dimpase created at 2019-07-21 10:15:57

Does Conda provide `lcalc`?


---

Comment by isuruf created at 2019-07-21 16:25:01

Replying to [comment:1 dimpase]:
> Does Conda provide `lcalc`?

Yes and uses the patches from sage https://github.com/conda-forge/lcalc-feedstock/tree/master/recipe/patches


---

Comment by dimpase created at 2019-07-23 19:06:33

lcalc depends on PARI, so we need to deal with pari first.


---

Comment by dimpase created at 2019-09-01 01:49:38

New commits:


---

Comment by dimpase created at 2019-09-01 01:49:38

Changing status from new to needs_review.


---

Comment by isuruf created at 2019-09-01 02:17:57

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2019-09-01 02:17:57

sage-dist, conda, arch installs the header as `<prefix>/include/libLfunction/L.h` while debian installs it as `<prefix>/include/Lfunction/L.h`.

You'll need more changes to make lcalc work with Debian way. For eg: https://github.com/sagemath/sage/blob/master/src/sage/libs/lcalc/lcalc_sage.h#L1


---

Comment by dimpase created at 2019-09-01 11:26:31

oops, right, one would in the very least deal with hardcoded

```
src/sage/libs/lcalc/lcalc_sage.h:#include "libLfunction/L.h"
```



---

Comment by git created at 2019-09-01 19:02:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-09-01 19:15:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-09-01 19:50:19

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-09-01 19:50:19

OK, so the updated branch works with Debian's lcalc, currently checking with sage-dist's lcalc.
Any chance to test this with Conda? Thanks!


---

Comment by isuruf created at 2019-09-01 19:59:00

Works for me on conda. I see that you have `test x$ac_cv_header_libLfunction = x`. Isn't that supposed to be `test x$ac_cv_header_libLfunction_L_h = x` ?


---

Comment by git created at 2019-09-01 20:03:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-09-01 20:04:32

good catch. I guess you won't be able to build lcalc cython extension without the latest commit...


---

Comment by isuruf created at 2019-09-01 20:23:31

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2019-09-01 20:23:31

With the last commit and the one before that, I get


```
configure: === checking whether to install the lcalc SPKG ===
checking installing any of pari mpfr? ... no
checking for lcalc... /projects/66d93023-00f0-4c12-8a25-5d6d4e486740/sage-build/bin/lcalc
checking is lcalc's version good enough? ... yes.
checking Lfunction/L.h usability... no
checking Lfunction/L.h presence... no
checking for Lfunction/L.h... no
checking libLfunction/L.h usability... yes
checking libLfunction/L.h presence... yes
checking for libLfunction/L.h... yes
checking whether we can link and run a program using libLfunction... yes; use lcalc from the system
```


but lcalc spkg is being built.


---

Comment by dimpase created at 2019-09-01 20:26:39

hmm, could you attach the output of ./configure and config.log ? Thanks!


---

Comment by isuruf created at 2019-09-01 20:34:33

Else condition of `AC_CHECK_HEADERS` is run for the first header if it is not found.


---

Comment by git created at 2019-09-01 20:42:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-09-01 20:44:09

Replying to [comment:16 isuruf]:
> Else condition of `AC_CHECK_HEADERS` is run for the first header if it is not found.

fixed by the last commit, good catch. I never used AC_CHECK_HEADER*S* before...


---

Comment by isuruf created at 2019-09-01 20:49:44

Works for me now.


---

Comment by git created at 2019-09-01 22:13:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-09-01 22:26:01

The latest commit fixes a weird build bug I was getting.
Namely, if `LCALC_INCDIR_NOLIBPREFIX==''` the build was failing.
So I made it to always be something non-empty and OK for gcc (7 and 8.3, neither worked).

Needs final review now.


---

Comment by dimpase created at 2019-09-01 22:26:01

Changing status from needs_work to needs_review.


---

Comment by isuruf created at 2019-09-01 22:32:00

I think distutils was sending an empty argument. Empty arguments will give that file not found error.


---

Comment by isuruf created at 2019-09-01 22:32:00

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-09-02 07:31:17

reviewer name missing


---

Comment by dimpase created at 2019-09-02 07:53:07

Distributions - new env. var., please take a look.


---

Comment by arojas created at 2019-09-02 07:56:41

Replying to [comment:25 dimpase]:
> Distributions - new env. var., please take a look.

As long as there's a fallback that allows not having to set the variable I'm fine with it - I can change the lcalc package headers accordingly.


---

Comment by dimpase created at 2019-09-02 08:00:22

I am confused now. I thought that you are fine with variables, but not happy with running configure. Otherwise a much easier solution would have been to have
something like `src/sage/libs/lcalc/lcalc_sage.h.in` and fill it in by `./configure`.


---

Comment by arojas created at 2019-09-02 08:02:31

Replying to [comment:27 dimpase]:
> I am confused now. I thought that you are fine with variables, but not happy with running configure. Otherwise a much easier solution would have been to have
> something like `src/sage/libs/lcalc/lcalc_sage.h.in` and fill it in by `./configure`.

Running configure < setting env variables < not having to do anything

So using an env variable with a sane fallback is best.


---

Comment by dimpase created at 2019-09-02 08:05:52

"not having to do anything" would only be possible if Debian et. al reverted their clever idea to rename the include location to `Lfunction`.

I don't know what you mean by a fallback here.


---

Comment by isuruf created at 2019-09-02 08:08:35

I don't think any distribution shipping headers in `libLfunction` has to do anything here as there's a fallback in `src/sage/env.py`.


---

Comment by arojas created at 2019-09-02 08:09:22

Replying to [comment:29 dimpase]:
> "not having to do anything" would only be possible if Debian et. al reverted their clever idea to rename the include location to `Lfunction`.

I mean "not having to do anything when building sagelib on Arch"

> I don't know what you mean by a fallback here. 

I mean a reasonable behavior out of the box when the variable is unset. (ie. if some distro renames the header dir or the lib name, not setting the variable should use the upstream name)


---

Comment by git created at 2019-09-02 08:10:20

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-09-02 08:10:20

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by dimpase created at 2019-09-02 08:11:03

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-09-02 08:11:03

reworded the last commit message, no code changes.


---

Comment by fbissey created at 2019-09-02 08:12:55

I avoided this ticket so far because `lcalc` is one of those packages that "smells" and may be better left alone. 

For the record sage-on-gentoo installs headers in `Lfunction` which is closer to the original upstream than what `libLfunction` is. The latter being a sage packaging special.
https://github.com/sagemath/sagetrac-mirror/blob/master/build/pkgs/lcalc/patches/Makefile.patch#L231
being replaced by
https://github.com/sagemath/sagetrac-mirror/blob/master/build/pkgs/lcalc/patches/Makefile.patch#L234


---

Comment by isuruf created at 2019-09-02 08:21:19

Shall we change the default and also the patch to use `Lfunction` then?

I can change it in conda.


---

Comment by fbissey created at 2019-09-02 08:24:25

Being uniform about these headers locations in distributions and sage certainly would help.


---

Comment by dimpase created at 2019-09-02 10:59:04

Right. I just checked that on Fedora it's `Lfunction` too.
I've asked on sage-devel about the reason for these naming twists...
https://groups.google.com/d/msg/sage-devel/fAPWh1G8_Qw/xMAmtUapAQAJ


---

Comment by dimpase created at 2019-09-03 15:35:00

I've changed the branch so that `INCDIR` of `libLfunction` is `Lfunction/`.

this is much simpler, please review.
----
New commits:


---

Comment by dimpase created at 2019-09-03 15:35:00

Changing status from positive_review to needs_review.


---

Comment by isuruf created at 2019-09-03 16:55:57

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2019-09-03 16:55:57

Needs a version bump for lcalc


---

Comment by git created at 2019-09-03 19:33:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-09-03 19:34:15

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2019-09-03 21:45:59

Love the fact that I won't have to patch that little bit anymore - I am sure my colleagues in other distros are happy about that too.


---

Comment by fbissey created at 2019-09-03 21:45:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-09-05 21:33:13

Resolution: fixed


---

Comment by @thierry-FreeBSD created at 2020-03-30 12:44:36

FYI, a more recent snapshot, for version 1.3, is available at https://github.com/agrawroh/l-calc .
It has been exported from code.google.com/p/l-calc.
