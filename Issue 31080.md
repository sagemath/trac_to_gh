# Issue 31080: eclib interface uses bad default value for elliptic curve modular symbols

Issue created by migration from https://trac.sagemath.org/ticket/31317

Original creator: cremona

Original creation time: 2021-02-01 16:34:22

CC:  wuthrich

Keywords: elliptic curve modular symbol

This was reported to me by Chris Wuthrich in December 2019, and by Barry Mazur and Karl Rubin a few days ago.  I originally thought that there was a bug in eclib, but it turns out that the only bug is that the default value of certain parameters is too small for the cases they were interested in.  I will post a 2-line patch to increase this.  It has to be a 2-line patch, not 1, since the current eclib interfae does not expose the relevant parameter to Sage at all currently.

Here are two example. Wuthrich's (takes a little while as the conductor is 87416):

```
sage: E = EllipticCurve([49,-49])
sage: me = E.modular_symbol(implementation="eclib")
sage: me(1/8)
10/17
sage: mn = E.modular_symbol(implementation="num")
sage: mn(1/8)
1/2
```

and Mazur's:

```
sage: E = EllipticCurve('1590g1')                                                                                                                     
sage: ms = E.modular_symbol()                                                                                                                         
sage: [ms(a/5) for a in [1..4]]                                                                                                                       
[1001/153, -1001/153, -1001/153, 1001/153]
sage: ms = E.modular_symbol(implementation='num')                                                                                                     
sage: [ms(a/5) for a in [1..4]]                                                                                                                       
[13/2, -13/2, -13/2, 13/2]
```


In both cases, after my patch the 'eclib' values agree with the numerical values.


---

Comment by cremona created at 2021-02-02 10:10:24

Changing status from new to needs_review.


---

Comment by cremona created at 2021-02-02 10:10:24

As well as adding the nap option to te interface itself I passed this up the chain so that users can see it too, with doctests.  While there I tidied up the documentation a bit too.
----
New commits:


---

Comment by wuthrich created at 2021-02-02 10:34:56

Is there evidence that 1000 is the right bound for all curves? All for which it makes sense to use eclib. Maybe it should increase with the conductor. Probably 100*sqrt(N) or so is saver.

(sorry not to reply in full, busy with marking new semester etc)


---

Comment by cremona created at 2021-02-02 11:12:49

Replying to [comment:2 wuthrich]:
> Is there evidence that 1000 is the right bound for all curves? All for which it makes sense to use eclib. Maybe it should increase with the conductor. Probably 100*sqrt(N) or so is safer.

Good point -- though at the top level E.modular_symbol() used default nap=400 in this patch.  As you know, for large conductor it will take a long time to make this construction, so I rather doubt it will be used much for N>10000 (say), so a default which works on this range seemed reasonable.  On the other hand, compared with the time it takes to construct the modular symbol space, the time to compute more ap from the curve is negligible, suggesting that having a higher default is better.

I will be changing eclib's own default (which is 300 ap) anyway, probably to 1000, and the way the code works is that it sets a minimum value of nap (currently 300) so that  whatever value the user gives is increased to this if less.  (i.e., there is in effect the line nap=max(300,nap) in eclib's relevant function.)

I would be so much happier if it were possible to get this normalising factor another way than by taking rations of periods.  It is *only* needed at all so that we get the right answers for non-optima curves -- when you give it an optimal curve it goes to all this trouble to compute the ratio as 1 (or in the example before the fix it computed it as 73/68 or something), but I know of no way to do that.  It would be possible to change eclib so that it assumes that the curve is optimal by default, only computing the normalisation factors if the users specifically asks.  Then on the Sage side we could decide to use the default if the curve's label ends in '1', or if the isogeny class consists of only one curve.

The current fix is designed to be easily implemented as it requires no change to eclib -- which had no bugs in this regard, except possible the too low default value of 300.

But I will take your suggestion on board with a new patch, and while waiting for the review I'll test it as many curves as I can -- the test being that 'eclib' and 'num' give the same answer for all small rationals.

> 
> (sorry not to reply in full, busy with marking new semester etc)


---

Comment by cremona created at 2021-02-02 11:12:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-02-02 11:40:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2021-02-02 11:41:47

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2021-02-02 11:41:47

I switched the default at at the top level to max(100*N.isqrt(),10000).  I have started a test for all conductors up to (however far I get, but maybe) 10000.  By comparison, even for conductors up to 500000 I was only computing 6000 ap when finding the curves, which requires far greater precision.


---

Comment by cremona created at 2021-02-02 16:32:55

For all curves of conductor up to 1000, with the new code, the 'eclib' and 'num' results agree (at all rationals with numerator and denominator bounded by 5).  I'll continue to test more, but no-one need be in any doubt that this should be merged.


---

Comment by wuthrich created at 2021-02-03 08:54:41

Changing status from needs_review to positive_review.


---

Comment by wuthrich created at 2021-02-03 08:54:41

I agree with all that is said here and I checked the code and all tests pass etc.


---

Comment by cremona created at 2021-02-03 14:14:41

Replying to [comment:7 wuthrich]:
> I agree with all that is said here and I checked the code and all tests pass etc. 

Thanks.  Although some patchbots are reporting test failures these have nothing to do with this patch, so are less than helpful.  Perhaps patchbots should first run all tests without applying the patch, and only if those pass would they apply the patch and retest.  That would take twice as long but would avoid spurious failures like this which probably have the effect that the release manager assumes something is actually wrong and the bug-fix never gets merged.


---

Comment by vbraun created at 2021-03-09 00:02:11

Resolution: fixed
