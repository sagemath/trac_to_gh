# Issue 14778: Let MPIR >=2.6.0 build on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/15015

Original creator: jpflori

Original creation time: 2013-08-06 21:44:07

CC:  kcrisman dimpase tscrim was

Keywords: mpir spkg cygwin

MPIR 2.6.0 does not build on Cygwin 64.
The next version should fix this problem (and others).
Patches from Sage will mostly be integrated.

Temporary dirty spkg at:
* http://boxen.math.washington.edu/home/jpflori/spkg/mpir-2.6.0.p3.spkg


---

Comment by jpflori created at 2013-08-06 21:44:40

This should surely be renamed to "Update to MPIR 2.6.1" when the official version get released (no idea when...).


---

Comment by tscrim created at 2013-08-10 19:37:01

For the record, the current spkg built for me on cygwin64.


---

Comment by jpflori created at 2013-11-06 09:34:33

On top of that the current MPIR 2.6.0 fails to properly build on Cygwin when CXX support is not enabled.
Therefore it is not possible/easy to build GCC on Cygwin.
That is because of a dirty hack in the autotools stuff already present in GMP before MPIR was forked.
This is also fixed in the current git version.


---

Comment by leif created at 2014-04-06 19:14:49

Otherwise we'd probably have to close it as _won't fix_. :-)

Current upstream tarball: http://mpir.org/mpir-2.7.0-alpha4.tar.bz2


Still needs to be tested on Darwin PowerPC I think.  (moufang?  Does it still live?)

And probably also Macs with more recent versions of Xcode.


---

Comment by kcrisman created at 2014-04-09 18:02:26

So are you saying that JP should make a tarball for this as an alpha?  I don't have time to test this on PPC until that exists.  Currently trying to built 6.2.beta7, I'll wait until I get a clean build for that platform before I try new things.  (Hopefully rpy is the only remaining problem there.)


---

Comment by leif created at 2014-04-09 18:19:35

Replying to [comment:7 kcrisman]:
> So are you saying that JP should make a tarball for this as an alpha?

I think that would be convenient for testing, and there are still some issues on Cygwin* JP knows about.

By the way, note that the latest changes in the alpha4 tarball aren't yet committed on github (it's still at alpha3).


---

Comment by jpflori created at 2014-04-09 21:14:56

Replying to [comment:7 kcrisman]:
> So are you saying that JP should make a tarball for this as an alpha?  I don't have time to test this on PPC until that exists.  Currently trying to built 6.2.beta7, I'll wait until I get a clean build for that platform before I try new things.  (Hopefully rpy is the only remaining problem there.)
I happens I did and almost have an almost completely working out of the box cygwin64 branch.
I just have to cherry-pick commits and push them to different branches on trac.


---

Comment by jpflori created at 2014-04-13 19:46:01

There are still issues with PPL...
See https://groups.google.com/forum/?fromgroups=#!topic/mpir-devel/JFDaMAc0YpY
----
New commits:


---

Comment by leif created at 2014-04-14 00:16:57

A few comments/questions:

 * Do we lose the Clang / XCode 5 patch?  (I did have other `clang` patches elsewhere, also just preventing `configure` to fail for no real reason.)

 * Sun compiler patch (probably less important)?

 * What is `patch ... || continue` supposed to achieve?  (The `if [ $? -ne 0 ]` afterwards gets useless.)

 * In `if uname -a | grep x86_64; then ...` any output (`stdout` and `stderr`) should get redirected to `/dev/null`.




Should #16149 be added as a dependency of this ticket, or do you want to deal with that in MPIR's `spkg-install`?  (I'd prefer the former, but am also undecided about the solution to choose on #16149, hence "needs info".)


---

Comment by leif created at 2014-04-14 01:00:29

I recall we also had issues with AVX-enabled CPUs on Darwin and (not _that_) old Apple assemblers not supporting AVX instructions.  IIRC Jeroen removed a work-around (with a bunch of other things dealing with proper `CFLAGS`) from `spkg-install` a while ago, so this is presumably no longer an issue (just because we meanwhile require some more recent version of Xcode I guess), but I might be wrong.


---

Comment by jpflori created at 2014-04-14 08:09:28

Replying to [comment:11 leif]:
> A few comments/questions:
> 
All (Most?) should be upstream now if I did not screw up a long time ago.
>  * Do we lose the Clang / XCode 5 patch?  (I did have other `clang` patches elsewhere, also just preventing `configure` to fail for no real reason.)
> 
Must admit I don't remember about that one.
>  * Sun compiler patch (probably less important)?
This one is in (IIRC).
> 
>  * What is `patch ... || continue` supposed to achieve?  (The `if [ $? -ne 0 ]` afterwards gets useless.)
When there is no patch at all I guess.
Not sure naymore.
> 
>  * In `if uname -a | grep x86_64; then ...` any output (`stdout` and `stderr`) should get redirected to `/dev/null`.
Maybe!
> 
> 

> 
> Should #16149 be added as a dependency of this ticket, or do you want to deal with that in MPIR's `spkg-install`?  (I'd prefer the former, but am also undecided about the solution to choose on #16149, hence "needs info".)
The CXXFLAGS issue should be fixed in MPIR (maybe not alpha4, but in git master).


---

Comment by jpflori created at 2014-04-14 08:10:24

Replying to [comment:12 leif]:
> I recall we also had issues with AVX-enabled CPUs on Darwin and (not _that_) old Apple assemblers not supporting AVX instructions.  IIRC Jeroen removed a work-around (with a bunch of other things dealing with proper `CFLAGS`) from `spkg-install` a while ago, so this is presumably no longer an issue (just because we meanwhile require some more recent version of Xcode I guess), but I might be wrong.
I don't now.
We surely added thing for apple ocmpiler/assembler/linker but couldn't promise it was AVX related.


---

Comment by leif created at 2014-04-14 08:19:26

Replying to [comment:13 jpflori]:
> Replying to [comment:11 leif]:
> > Should #16149 be added as a dependency of this ticket, or do you want to deal with that in MPIR's `spkg-install`?  (I'd prefer the former, but am also undecided about the solution to choose on #16149, hence "needs info".)
> The CXXFLAGS issue should be fixed in MPIR (maybe not alpha4, but in git master).

No, a slightly different one (but with the same effect).  `AC_PROG_CXX` in MPIR is now correctly called after `CXXFLAGS` have been saved, and MPIR now behaves correctly (I'd say).  But Sage sets (and exports) `CXXFLAGS` to the empty string, so MPIR doesn't touch them (again assuming they were intentionally set), such that we end up with missing flags (unless the user had really set them, or `CFLAGS`, to something meaningful).


---

Comment by jpflori created at 2014-04-14 08:23:53

I see.
Thanks for the explanation.


---

Comment by leif created at 2014-04-14 08:28:06

P.S.:  In `spkg-install`, we could do (almost) the same with `CXXFLAGS` as we do with `CFLAGS`.  In the first "dry" `configure` run, we already unset them, so we could grep MPIR's from the Makefile and at least _prepend_ those settings to our effective `CXXFLAGS` for the second, real `configure`run.

(So far, we didn't touch `CXXFLAGS` at all, which I'd consider a small deficiency or inconsistency anyway.)


---

Comment by leif created at 2014-04-14 08:31:43

[Slight correction to my previous post.]


---

Comment by leif created at 2014-04-14 08:49:00

Replying to [comment:13 jpflori]:
> >  * What is `patch ... || continue` supposed to achieve?  (The `if [ $? -ne 0 ]` afterwards gets useless.)
> When there is no patch at all I guess.

Ah, thought of something like that.  But it should be

```sh
for foo in bar*; do
    [ -r "$foo" ] || continue   # ignore non-readable / non-existent files
    process "$foo"
    if [ $? -ne 0 ]; then
        # processing $foo failed, err out
        ...
    fi
done
```



---

Comment by jpflori created at 2014-04-14 09:16:39

Sure, I messed up :(


---

Comment by git created at 2014-04-14 10:06:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-08-28 10:14:24

All patches from Sage seem to be integrated upstream, good! The changes here look fine, the main part of reviewing will be checking that it actually works. I will upgrade this to the latest MPIR alpha and report back.


---

Comment by jpflori created at 2014-08-28 10:20:29

I'm not sure the problem with ppl is fixed in the latest alpha...
Some hints to fix it must lurk on flint-devel.


---

Comment by jpflori created at 2014-08-28 10:21:45

See https://groups.google.com/d/msg/mpir-devel/JFDaMAc0YpY/h774pq9wN2EJ
And IIRC it does not only happens on Cygwin(64) but also on more usual systems.


---

Comment by jdemeyer created at 2014-08-28 10:37:24

In `spkg-install`, I also changed

```
echo "Checking what CFLAGS MPIR would use if they were empty..."
(unset CFLAGS CPPFLAGS CXXFLAGS && ./configure $MPIR_CONFIGURE) &>configure-empty.log
```

to

```
echo "Configuring MPIR with empty CFLAGS to determine the defaults:"
(unset CFLAGS CPPFLAGS CXXFLAGS && ./configure $MPIR_CONFIGURE)
```


I think it's better to display the first `configure` run, in case it needs to be debugged or just to show the user that Sage isn't stuck.
----
New commits:


---

Comment by jdemeyer created at 2014-08-28 12:02:04

On Linux x86_64, g++ (Gentoo 4.6.4 p1.2, pie-0.5.2) 4.6.4, while compiling the Sage library:

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include/python2.7 -c build/cythonized/sage/libs/ppl.cpp -o build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/ppl.o -fno-strict-aliasing -w
In file included from build/cythonized/sage/libs/ppl.cpp:352:0:
../local/include/gmpxx.h:1548:3: error: ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>::__gmp_expr(intmax_t)’ cannot be overloaded
../local/include/gmpxx.h:1539:3: error: with ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>::__gmp_expr(long int)’
../local/include/gmpxx.h:1552:3: error: ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>::__gmp_expr(uintmax_t)’ cannot be overloaded
../local/include/gmpxx.h:1540:3: error: with ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>::__gmp_expr(long unsigned int)’
../local/include/gmpxx.h:1615:16: error: ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>& __gmp_expr<__mpz_struct [1], __mpz_struct [1]>::operator=(intmax_t)’ cannot be overloaded
../local/include/gmpxx.h:1604:16: error: with ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>& __gmp_expr<__mpz_struct [1], __mpz_struct [1]>::operator=(long int)’
../local/include/gmpxx.h:1619:16: error: ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>& __gmp_expr<__mpz_struct [1], __mpz_struct [1]>::operator=(uintmax_t)’ cannot be overloaded
../local/include/gmpxx.h:1606:16: error: with ‘__gmp_expr<__mpz_struct [1], __mpz_struct [1]>& __gmp_expr<__mpz_struct [1], __mpz_struct [1]>::operator=(long unsigned int)’
error: command 'gcc' failed with exit status 1
```



---

Comment by jpflori created at 2014-08-28 12:03:07

Yup that is the problem I was mentioning.


---

Comment by jpflori created at 2014-09-04 11:21:11

Could you try with the attached patch?
If it works, I'll forward it to Bill.


---

Attachment

Groumpf, thepatch is reversed.
Take the .2 one.


---

Comment by jpflori created at 2014-09-04 13:11:33

Strange I don't have problems, even without my latest patch, on a machine where I seem to remember I used to have problems.


---

Comment by jdemeyer created at 2014-09-04 20:12:58

Works for me...


---

Comment by jpflori created at 2014-09-05 14:26:41

In fact I also need the patch, but not to build PPL anymore, but some ppl related file within the Sage library.


---

Comment by git created at 2014-10-01 14:39:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-01 18:24:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-01 18:24:43

This now builds and passes all doctests on 64-bit for me.

Test please!


---

Comment by jdemeyer created at 2014-10-01 18:26:14

William: this changes one doctest in `src/sage/tests/book_stein_modform.py`


---

Comment by git created at 2014-10-01 18:30:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-01 18:32:50

Unrelated to this ticket, I have re-enabled a doctest in `book_stein_modform.py` which was fixed in #4357.


---

Comment by jpflori created at 2014-10-08 05:29:46

For info, I agree that we should output the first configure run on screen.
Some users already complained that MPIR compilation was stuck because of the long time it can take on some systems and nothing was getting printed on screen.


---

Comment by jpflori created at 2014-10-10 05:33:43

Works fine for me (except for numerical noise I also get with the previous MPIR, and that is surely ppc64 specific).

Would you consider adding a spkg-src script?


---

Comment by jpflori created at 2014-10-16 09:05:15

This works perfectly fine for me (though I did not test Cygwin, but that's a low level priority and can be fixed later in case it is needed).

The current tarball is the upstream one and includes windows stuff we used to delete.
Apart from that, I would positively review the ticket, even without a proper spkg-src script.


---

Comment by jdemeyer created at 2014-10-16 09:09:34

Upstream has indicated that they consider the changed output of `mpz_gcdext()` a bug.

Therefore, I think it is premature to upgrade now.


---

Comment by jpflori created at 2014-10-16 09:22:13

Oh yeah, I read about that one...


---

Comment by jdemeyer created at 2014-10-31 09:41:48

Because of the precedent at #17169, I would simply use the upstream tarball and not add a `spkg-src` script.


---

Comment by jpflori created at 2014-10-31 09:49:14

I don't really agree...
If we keep on like that Sage will grow huge.
Hard disks are cheap but internet connections aren't always, e.g. I get a poor bandwith between my office and boxen.
Let's discuss this on sage-devel.


---

Comment by jpflori created at 2014-10-31 09:55:24

https://groups.google.com/forum/#!topic/sage-devel/a9yIdaqNHKU


---

Comment by jpflori created at 2014-11-24 14:11:51

The gcdext change in MPIR was to be expected (at least the `gcdext(1,1)` example Jeroen found) and I personally don't think it's a bug.
I'm not sure what Bill will think though.

At the very least it makes MPIR consistent with GMP.


---

Comment by jpflori created at 2014-11-24 14:12:17

(And ok for not shipping any `spkg-src` script.)


---

Comment by jpflori created at 2014-11-24 16:15:48

Changing status from new to needs_info.


---

Comment by jpflori created at 2014-12-16 09:45:32

The only thing really annoying me right now is the name of the tarball.
When we update to another alpha or the final version it will be a pain, so we should still repackage the upstream tarball to change the dir name wihtin it (rather than renaming the tarball).


---

Comment by jpflori created at 2014-12-23 16:47:54

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2014-12-24 09:21:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-12-24 09:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-12-24 09:22:05

New commits:


---

Comment by git created at 2014-12-24 09:27:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-12-24 10:50:53

Looks fine.

I had a vague souvenir we had trouble with dashes in version numbers but it does not seem to be the case anymore.
Maybe we could also switch back to verbatim version numbers for Singular 4-0-1.


---

Comment by jpflori created at 2014-12-24 10:50:53

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2014-12-24 11:36:41

Got two files with failing doctests but cannot reproduce these failures:
* `src/sage/modular/modform/ambient.py`
* `src/sage/graphs/genus.pyx`


---

Comment by vbraun created at 2015-01-02 15:46:28

Resolution: fixed
