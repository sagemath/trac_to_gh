# Issue 24567: py3: minor fixes to sage.libs.ntl

Issue created by migration from https://trac.sagemath.org/ticket/24804

Original creator: embray

Original creation time: 2018-02-21 11:42:12

CC:  vklein jhpalmieri fbissey

Keywords: ntl

Two unrelated but (I think) small updates in `sage.libs.ntl`.  With these fixes (among others in unrelated modules) all the tests pass for `sage.libs.ntl` in my Python 3 branch.

The update to `ntl_ZZ_pX` allows it to take as an argument any object that implements the `Sequence` protocol, instead of just `(list, tuple)` exactly.  To summarize, this means classes that implement at least `__iter__`, `__len__`, and `__getitem__` (though to be clear, `dict` is is not a `Sequence`).  This means, among other things, it can accept `range` objects without any additional fuss, and there were several examples of this usage in the tests.


---

Comment by embray created at 2018-02-21 11:42:30

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-02-21 16:14:33

there seems to be some failing doctests

or at least one, see patchbot


---

Comment by chapoton created at 2018-02-21 21:01:55

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-02-23 14:06:57

Yeah, the `SequenceABC` change might need a closer examination; see also #24815.  I still believe it's basically the right way to go, but Jeroen has pointed out some possible performance impact here.  I'm open to other ideas as long as the're flexible-enough to take any types that can be duck-typed as list-like.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by chapoton created at 2018-11-22 10:45:17

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-11-22 10:45:17

in order to move on, I propose a less controversial fix
----
New commits:


---

Comment by embray created at 2018-11-22 11:09:42

This is still pretty arbitrary.  I think it would be nice to at least have defined in one place a tuple of all the common sequence types both built into Python and maybe from Sage as well (e.g. vectors).

In lots of other places we have not explicitly added support for range arguments, so why in this one place?


---

Comment by chapoton created at 2018-11-22 18:57:53

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-11-23 12:45:18

I mean, if this specific fix will help make progress I'm not opposed to it, but then we should open a ticket to discuss some kind of general solution to handling sequence-like types in a consistent manner.


---

Comment by git created at 2018-11-23 13:08:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-11-23 16:22:14

green bot. I would prefer to keep the general discussion for somewhere else.


---

Comment by chapoton created at 2018-11-23 16:32:39

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2018-11-26 09:49:33

> With these fixes (among others in unrelated modules) all the tests pass for sage.libs.ntl

It's currently false. There is still errors in sage.libs.ntl with this ticket:



```
----------------------------------------------------------------------
sage -t --long src/sage/libs/ntl/ntl_GF2X.pyx  # 2 doctests failed
sage -t --long src/sage/libs/ntl/ntl_mat_GF2E.pyx  # 1 doctest failed
sage -t --long src/sage/libs/ntl/ntl_GF2E.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by chapoton created at 2018-11-26 09:50:11

yes, but still this is a little progress..


---

Comment by embray created at 2018-11-26 10:50:54

Replying to [comment:15 vklein]:
> > With these fixes (among others in unrelated modules) all the tests pass for sage.libs.ntl
> 
> It's currently false. There is still errors in sage.libs.ntl with this ticket:
> 
> 
> {{{
> ----------------------------------------------------------------------
> sage -t --long src/sage/libs/ntl/ntl_GF2X.pyx  # 2 doctests failed
> sage -t --long src/sage/libs/ntl/ntl_mat_GF2E.pyx  # 1 doctest failed
> sage -t --long src/sage/libs/ntl/ntl_GF2E.pyx  # 1 doctest failed
> ----------------------------------------------------------------------
> }}}

"With these fixes _(among others in unrelated modules)_" the parenthesized part is important: these were fixes that I needed in `sage.libs.ntl` itself for those tests to pass, but this required some other fixes elsewhere as well.  I don't remember what those fixes would have been; this ticket was opened nine months ago.  I'll take another look though.  I haven't updated my Python 3 branch in too long...


---

Comment by embray created at 2018-11-26 11:29:49

ISTM the remaining bug is caused by some `map` somewhere.  I'm looking  into it.


---

Comment by embray created at 2018-11-26 11:47:13

Looking at the Python code and C-API docs, there is in fact a C-level `PySequence` API: https://docs.python.org/2/c-api/sequence.html

I believe it would be very useful to provide some thin wrappers around this to support sequence-like types generically, but more efficiently than going through the full `isinstance` check and ABC support (which is something I think still worth looking into making faster).


---

Comment by vklein created at 2018-11-26 12:26:53

Replying to [comment:17 embray]:
> Replying to [comment:15 vklein]:
> > > With these fixes (among others in unrelated modules) all the tests pass for 
> the parenthesized part is important: these were fixes that I needed in `sage.libs.ntl` itself for those tests to pass, but this required some other fixes elsewhere as well. 
Ok my bad.


---

Comment by vklein created at 2018-11-26 12:59:22

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-11-26 14:26:18

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-11-26 14:26:18

I am working on an alternative.


---

Comment by embray created at 2018-11-26 14:29:12

Replying to [comment:20 vklein]:
> Replying to [comment:17 embray]:
> > Replying to [comment:15 vklein]:
> > > > With these fixes (among others in unrelated modules) all the tests pass for 
> > the parenthesized part is important: these were fixes that I needed in `sage.libs.ntl` itself for those tests to pass, but this required some other fixes elsewhere as well. 
> Ok my bad.

Apparently not really: The issue here _is_ a `map()` call in `sage.libs.ntl` which could easily be converted to a list comprehension.  I think in my python3 branch it still worked because I changed some other interfaces to accept arbitrary iterables better, which is also just as good, but I think these `map()` calls could just as well be rewritten too.


---

Comment by git created at 2018-11-26 15:26:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-11-26 15:27:34

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-11-26 15:27:34

Updated to take advantage of #26769.  If it takes too long to agree on #26769 or something like it then let's revert back.  But I think this should work well.


---

Comment by chapoton created at 2018-11-26 21:12:47

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-11-26 21:12:47

failing doctests.. I would prefer to "keep it simple-stupid".


---

Comment by embray created at 2018-11-27 13:05:30

It looks like the last failures were caused by the `raise TypeError` I added in https://git.sagemath.org/sage.git/commit/?id=56b866a7afe1193180ec4fad90f1da983e697697

I just didn't understand that in that code it seems to assume that it's okay to initialize a `ntl_ZZ_pX` without actually initializing its `.x` attribute.  It struck me as ill-considered, but it at least seems that it was by design (at first glance it just looked like an oversight) so I'll revert that part for now.


---

Comment by embray created at 2018-11-27 13:10:45

It looks like I was partially wrong too about there being no tests for initializing that type from a string.  The one test there was for it was very non-local, however, and the existing code was still somewhat wrong.  I'll just fix that up a bit.


---

Comment by git created at 2018-11-27 13:23:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by chapoton created at 2019-04-06 20:18:18

Replying to [comment:25 embray]:
> Updated to take advantage of #26769.  If it takes too long to agree on #26769 or something like it then let's revert back.  But I think this should work well.

Now seems to be a good time to revert back to the simple-minded solution. Otherwise, we can give a green light to the under-the-carpet solution proposed in #27588


---

Comment by chapoton created at 2019-04-25 13:59:36

Erik, after 5 months and no review for your proposal, would you oppose to revert to my previous branch public/ticket/24804, and keep your enhanced solution for later ?


---

Comment by embray created at 2019-04-30 12:30:47

Could you open a new ticket instead?  It's fine be me.  Of course someone _could_ just review #26769 and come to a definitive conclusion on that and/or offer an alternative solution to the general problem.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by chapoton created at 2019-07-14 09:34:49

I propose to close this one, as all tests pass in libs/ntl


---

Comment by chapoton created at 2019-07-14 09:34:49

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-07-20 16:46:22

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-07-20 16:46:22

Sounds good to me.


---

Comment by chapoton created at 2019-07-21 07:01:33

Resolution: duplicate
