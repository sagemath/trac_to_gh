# Issue 28823: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages

archive/issues_028823.json:
```json
{
    "body": "CC:  @vbraun @kiwifb @isuruf @dimpase @embray @saraedum @antonio-rojas @slel @sheerluck @tobiasdiez\n\nTesting of source and binary distributions relies too much on manual testing by people.\n\nWe propose to set up Dockerfiles and CI scripts that document and test the expected capabilities of source and binary Sage distributions; and of downstream distribution packaging.\n\nExamples:\n- A Dockerfile for testing that the sage binary distribution runs on `ubuntu:latest` with the following set of installed distribution packages....\n- A Dockerfile for testing that the sage binary distribution is able to install optional packages when run on `ubuntu:latest` with the following set of installed distribution packages....\n- A Dockerfile for testing that all `spkg-configure.m4` scripts work as expected (using `./configure --with-system-PACKAGE=force`)\n- Testing that it is possible to build without error when upgrading with git from some list of previous releases.\n- Testing that `sage -c SAGECOMMAND`, `sage -t`, `sage -python -c COMMAND`, ... work with the `sage` script provided by the distribution (see https://groups.google.com/d/msg/sage-packaging/BmkxIBdwbvE/fRMl2sjdBQAJ)\n- Testing that a macOS binary distribution works on a set of OS versions, with and without XCode installed. (Sadly, cannot use Docker for that.)\n- Testing the cygwin build using Azure pipelines / GitHub Actions.\n\nSee the following for some work in this direction:\n- https://github.com/mkoeppe/sage-numerical-backends-coin (current)\n- https://github.com/mkoeppe/sage_binary_tester (outdated)\n\nIssue created by migration from https://trac.sagemath.org/ticket/29060\n\n",
    "created_at": "2020-01-21T15:42:32Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28823",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @vbraun @kiwifb @isuruf @dimpase @embray @saraedum @antonio-rojas @slel @sheerluck @tobiasdiez

Testing of source and binary distributions relies too much on manual testing by people.

We propose to set up Dockerfiles and CI scripts that document and test the expected capabilities of source and binary Sage distributions; and of downstream distribution packaging.

Examples:
- A Dockerfile for testing that the sage binary distribution runs on `ubuntu:latest` with the following set of installed distribution packages....
- A Dockerfile for testing that the sage binary distribution is able to install optional packages when run on `ubuntu:latest` with the following set of installed distribution packages....
- A Dockerfile for testing that all `spkg-configure.m4` scripts work as expected (using `./configure --with-system-PACKAGE=force`)
- Testing that it is possible to build without error when upgrading with git from some list of previous releases.
- Testing that `sage -c SAGECOMMAND`, `sage -t`, `sage -python -c COMMAND`, ... work with the `sage` script provided by the distribution (see https://groups.google.com/d/msg/sage-packaging/BmkxIBdwbvE/fRMl2sjdBQAJ)
- Testing that a macOS binary distribution works on a set of OS versions, with and without XCode installed. (Sadly, cannot use Docker for that.)
- Testing the cygwin build using Azure pipelines / GitHub Actions.

See the following for some work in this direction:
- https://github.com/mkoeppe/sage-numerical-backends-coin (current)
- https://github.com/mkoeppe/sage_binary_tester (outdated)

Issue created by migration from https://trac.sagemath.org/ticket/29060





---

archive/issue_comments_407072.json:
```json
{
    "body": "Changing keywords from \"\" to \"docker, ContinuousIntegration\".",
    "created_at": "2020-01-21T16:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407072",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "" to "docker, ContinuousIntegration".



---

archive/issue_comments_407073.json:
```json
{
    "body": "I like the general idea of doing more CI a lot. Probably we should split this ticket up though or turn it into a meta ticket that tracks similar CI improvements such as #28457, #24854, #25262.\n\nFor this to be actually noticed by people we probably would need some integration with Trac. If I understood embray correctly, adding something like that, similar to the patchbot status, would not be difficult. (Since #28457 has been ready for a while, it might be a good first candidate for such an integration.)\n\nI would propose to use [GitLab](GitLab) CI for probably all the things you describe. We already have some CI setup there that has been mostly stable recently (though most people don't know about it https://gitlab.com/sagemath/dev/trac/pipelines?page=1&scope=all since it's not visible in trac yet.) I had made some experiments with macOS & Windows there that were not completely disappointing. For macOS you cannot use docker but still [GitLab](GitLab) CI works, see e.g. #25980. Windows can be run inside docker (on Windows) but two years ago, the performance was not sufficient, see #25805. Without docker it worked fine though.\n\nFor our Linux CI needs, we can mostly use the free [GitLab](GitLab) runners but last time we tried we could also easily get plenty of free credits on Google Cloud. For macOS & Windows, I had at some point built a PoC runner that slelievre volunteered to host; unfortunately, I never finished that project.",
    "created_at": "2020-01-21T16:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407073",
    "user": "https://github.com/saraedum"
}
```

I like the general idea of doing more CI a lot. Probably we should split this ticket up though or turn it into a meta ticket that tracks similar CI improvements such as #28457, #24854, #25262.

For this to be actually noticed by people we probably would need some integration with Trac. If I understood embray correctly, adding something like that, similar to the patchbot status, would not be difficult. (Since #28457 has been ready for a while, it might be a good first candidate for such an integration.)

I would propose to use [GitLab](GitLab) CI for probably all the things you describe. We already have some CI setup there that has been mostly stable recently (though most people don't know about it https://gitlab.com/sagemath/dev/trac/pipelines?page=1&scope=all since it's not visible in trac yet.) I had made some experiments with macOS & Windows there that were not completely disappointing. For macOS you cannot use docker but still [GitLab](GitLab) CI works, see e.g. #25980. Windows can be run inside docker (on Windows) but two years ago, the performance was not sufficient, see #25805. Without docker it worked fine though.

For our Linux CI needs, we can mostly use the free [GitLab](GitLab) runners but last time we tried we could also easily get plenty of free credits on Google Cloud. For macOS & Windows, I had at some point built a PoC runner that slelievre volunteered to host; unfortunately, I never finished that project.



---

archive/issue_comments_407074.json:
```json
{
    "body": "Replying to [comment:1 saraedum]:\n> I like the general idea of doing more CI a lot. Probably we should split this ticket up though or turn it into a meta ticket that tracks similar CI improvements such as #28457, #24854, #25262.\n> \n> For this to be actually noticed by people we probably would need some integration with Trac. \n\nYes, that would be nice. But it would already help if this were run at the time that betas and releases are prepared. I don't think it needs to be run on every ticket.",
    "created_at": "2020-01-21T16:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407074",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:1 saraedum]:
> I like the general idea of doing more CI a lot. Probably we should split this ticket up though or turn it into a meta ticket that tracks similar CI improvements such as #28457, #24854, #25262.
> 
> For this to be actually noticed by people we probably would need some integration with Trac. 

Yes, that would be nice. But it would already help if this were run at the time that betas and releases are prepared. I don't think it needs to be run on every ticket.



---

archive/issue_comments_407075.json:
```json
{
    "body": "This needs a writeup to explain how all these cogs: tox, docker, github actions, etc. fit together and move.",
    "created_at": "2020-01-30T16:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407075",
    "user": "https://github.com/dimpase"
}
```

This needs a writeup to explain how all these cogs: tox, docker, github actions, etc. fit together and move.



---

archive/issue_comments_407076.json:
```json
{
    "body": "Replying to [comment:12 dimpase]:\n> This needs a writeup to explain how all these cogs: tox, docker, github actions, etc. fit together and move.\nGood idea, please take a look at the revised description and let me know what needs more detail.",
    "created_at": "2020-01-30T17:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407076",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 dimpase]:
> This needs a writeup to explain how all these cogs: tox, docker, github actions, etc. fit together and move.
Good idea, please take a look at the revised description and let me know what needs more detail.



---

archive/issue_comments_407077.json:
```json
{
    "body": "On some branches there are also lists of `<distro>` packages in `build/pkgs/<distro>.txt` which appear to be used for some kind of bootstrapping.\nWhat are these?",
    "created_at": "2020-02-02T19:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407077",
    "user": "https://github.com/dimpase"
}
```

On some branches there are also lists of `<distro>` packages in `build/pkgs/<distro>.txt` which appear to be used for some kind of bootstrapping.
What are these?



---

archive/issue_comments_407078.json:
```json
{
    "body": "`build/pkgs/DISTRO.txt` contains the minimal requirements for building sage from a source distribution\nand `build/pkgs/DISTRO-bootstrap.txt` are the additional requirements so that `./bootstrap` works.\nIn #29124 I propose to create pseudo-spkgs to capture these, instead, to make this a bit more uniform.",
    "created_at": "2020-02-02T20:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407078",
    "user": "https://github.com/mkoeppe"
}
```

`build/pkgs/DISTRO.txt` contains the minimal requirements for building sage from a source distribution
and `build/pkgs/DISTRO-bootstrap.txt` are the additional requirements so that `./bootstrap` works.
In #29124 I propose to create pseudo-spkgs to capture these, instead, to make this a bit more uniform.



---

archive/issue_comments_407079.json:
```json
{
    "body": "Comments on the top of `build/pkgs/debian.txt` explain this.",
    "created_at": "2020-02-02T20:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407079",
    "user": "https://github.com/mkoeppe"
}
```

Comments on the top of `build/pkgs/debian.txt` explain this.



---

archive/issue_comments_407080.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407080",
    "user": "https://github.com/mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_407081.json:
```json
{
    "body": "Changing keywords from \"docker, ContinuousIntegration\" to \"docker, ContinuousIntegration, sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407081",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "docker, ContinuousIntegration" to "docker, ContinuousIntegration, sd111".



---

archive/issue_comments_407082.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28823#issuecomment-407082",
    "user": "https://github.com/mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.
