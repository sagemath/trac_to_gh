# Issue 28823: Add Dockerfiles and CI scripts for integration testing of source and binary distributions and of downstream packages

Issue created by migration from https://trac.sagemath.org/ticket/29060

Original creator: mkoeppe

Original creation time: 2020-01-21 15:42:32

CC:  vbraun fbissey isuruf dimpase embray saraedum arojas slelievre @sheerluck @tobiasdiez

Testing of source and binary distributions relies too much on manual testing by people.

We propose to set up Dockerfiles and CI scripts that document and test the expected capabilities of source and binary Sage distributions; and of downstream distribution packaging.

Examples:
- A Dockerfile for testing that the sage binary distribution runs on `ubuntu:latest` with the following set of installed distribution packages....
- A Dockerfile for testing that the sage binary distribution is able to install optional packages when run on `ubuntu:latest` with the following set of installed distribution packages....
- A Dockerfile for testing that all `spkg-configure.m4` scripts work as expected (using `./configure --with-system-PACKAGE=force`)
- Testing that it is possible to build without error when upgrading with git from some list of previous releases.
- Testing that `sage -c SAGECOMMAND`, `sage -t`, `sage -python -c COMMAND`, ... work with the `sage` script provided by the distribution (see https://groups.google.com/d/msg/sage-packaging/BmkxIBdwbvE/fRMl2sjdBQAJ)
- Testing that a macOS binary distribution works on a set of OS versions, with and without XCode installed. (Sadly, cannot use Docker for that.)
- Testing the cygwin build using Azure pipelines / GitHub Actions.

See the following for some work in this direction:
- https://github.com/mkoeppe/sage-numerical-backends-coin (current)
- https://github.com/mkoeppe/sage_binary_tester (outdated)


---

Comment by saraedum created at 2020-01-21 16:23:45

Changing keywords from "" to "docker, ContinuousIntegration".


---

Comment by saraedum created at 2020-01-21 16:23:45

I like the general idea of doing more CI a lot. Probably we should split this ticket up though or turn it into a meta ticket that tracks similar CI improvements such as #28457, #24854, #25262.

For this to be actually noticed by people we probably would need some integration with Trac. If I understood embray correctly, adding something like that, similar to the patchbot status, would not be difficult. (Since #28457 has been ready for a while, it might be a good first candidate for such an integration.)

I would propose to use [GitLab](GitLab) CI for probably all the things you describe. We already have some CI setup there that has been mostly stable recently (though most people don't know about it https://gitlab.com/sagemath/dev/trac/pipelines?page=1&scope=all since it's not visible in trac yet.) I had made some experiments with macOS & Windows there that were not completely disappointing. For macOS you cannot use docker but still [GitLab](GitLab) CI works, see e.g. #25980. Windows can be run inside docker (on Windows) but two years ago, the performance was not sufficient, see #25805. Without docker it worked fine though.

For our Linux CI needs, we can mostly use the free [GitLab](GitLab) runners but last time we tried we could also easily get plenty of free credits on Google Cloud. For macOS & Windows, I had at some point built a PoC runner that slelievre volunteered to host; unfortunately, I never finished that project.


---

Comment by mkoeppe created at 2020-01-21 16:50:11

Replying to [comment:1 saraedum]:
> I like the general idea of doing more CI a lot. Probably we should split this ticket up though or turn it into a meta ticket that tracks similar CI improvements such as #28457, #24854, #25262.
> 
> For this to be actually noticed by people we probably would need some integration with Trac. 

Yes, that would be nice. But it would already help if this were run at the time that betas and releases are prepared. I don't think it needs to be run on every ticket.


---

Comment by dimpase created at 2020-01-30 16:38:35

This needs a writeup to explain how all these cogs: tox, docker, github actions, etc. fit together and move.


---

Comment by mkoeppe created at 2020-01-30 17:18:23

Replying to [comment:12 dimpase]:
> This needs a writeup to explain how all these cogs: tox, docker, github actions, etc. fit together and move.
Good idea, please take a look at the revised description and let me know what needs more detail.


---

Comment by dimpase created at 2020-02-02 19:38:49

On some branches there are also lists of `<distro>` packages in `build/pkgs/<distro>.txt` which appear to be used for some kind of bootstrapping.
What are these?


---

Comment by mkoeppe created at 2020-02-02 20:44:11

`build/pkgs/DISTRO.txt` contains the minimal requirements for building sage from a source distribution
and `build/pkgs/DISTRO-bootstrap.txt` are the additional requirements so that `./bootstrap` works.
In #29124 I propose to create pseudo-spkgs to capture these, instead, to make this a bit more uniform.


---

Comment by mkoeppe created at 2020-02-02 20:45:12

Comments on the top of `build/pkgs/debian.txt` explain this.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "docker, ContinuousIntegration" to "docker, ContinuousIntegration, sd111".


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.
