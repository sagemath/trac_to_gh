# Issue 10649: speed up matrix actions on Manin symbols

Issue created by migration from Trac.

Original creator: AlexGhitza

Original creation time: 2011-01-29 05:47:49

Assignee: craigcitro

CC:  davidloeffler

Keywords: manin symbol binomial

The patch (basically written by William at #8614) speeds up these actions by changing the way the binomial coefficients are obtained.

Some timings (the weight seems to be the important parameter here):


BEFORE THE PATCH:


```
sage: from sage.modular.modsym.manin_symbols import ManinSymbolList_gamma0             
sage: m = ManinSymbolList_gamma0(5, 8)                                                 
sage: timeit("n = m.apply_T(4)")                                                       
625 loops, best of 3: 132 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                      
625 loops, best of 3: 26 µs per loop
sage: m = ManinSymbolList_gamma0(5, 30)                                                
sage: timeit("n = m.apply_T(4)")                                                       
625 loops, best of 3: 541 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                      
625 loops, best of 3: 25.8 µs per loop
sage: m = ManinSymbolList_gamma0(5, 100)                                               
sage: timeit("n = m.apply_T(4)")                                                       
125 loops, best of 3: 1.92 ms per loop
sage: timeit("n = m.apply_TT(4)")                                                      
625 loops, best of 3: 25.8 µs per loop
sage: eps = DirichletGroup(4).gen(0)                                                   
sage: from sage.modular.modsym.manin_symbols import ManinSymbolList_character          
sage: m = ManinSymbolList_character(eps, 2)                                            
sage: timeit("n = m.apply_T(4)")                                                       
625 loops, best of 3: 141 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                      
625 loops, best of 3: 103 µs per loop
sage: m = ManinSymbolList_character(eps, 30)                                           
sage: timeit("n = m.apply_T(4)")                                                       
125 loops, best of 3: 2.75 ms per loop
sage: timeit("n = m.apply_TT(4)")                                                      
625 loops, best of 3: 105 µs per loop
sage: m = ManinSymbolList_character(eps, 100)                                          
sage: timeit("n = m.apply_T(4)")                                                       
25 loops, best of 3: 9.35 ms per loop
sage: timeit("n = m.apply_TT(4)")                                                      
625 loops, best of 3: 103 µs per loop
```


AFTER THE PATCH:


```
sage: from sage.modular.modsym.manin_symbols import ManinSymbolList_gamma0                
sage: m = ManinSymbolList_gamma0(5, 8)                                                    
sage: timeit("n = m.apply_T(4)")                                                          
625 loops, best of 3: 21.6 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                         
625 loops, best of 3: 13.8 µs per loop
sage: m = ManinSymbolList_gamma0(5, 30)                                                   
sage: timeit("n = m.apply_T(4)")                                                          
625 loops, best of 3: 74.4 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                         
625 loops, best of 3: 13.7 µs per loop
sage: m = ManinSymbolList_gamma0(5, 100)                                                  
sage: timeit("n = m.apply_T(4)")                                                          
625 loops, best of 3: 297 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                         
625 loops, best of 3: 13.8 µs per loop
sage: eps = DirichletGroup(4).gen(0)                                                      
sage: from sage.modular.modsym.manin_symbols import ManinSymbolList_character             
sage: m = ManinSymbolList_character(eps, 2)                                               
sage: timeit("n = m.apply_T(4)")                                                          
625 loops, best of 3: 126 µs per loop
sage: timeit("n = m.apply_TT(4)")                                                         
625 loops, best of 3: 90.5 µs per loop
sage: m = ManinSymbolList_character(eps, 30)                                              
sage: timeit("n = m.apply_T(4)")                                                          
125 loops, best of 3: 2.26 ms per loop
sage: timeit("n = m.apply_TT(4)")                                                         
625 loops, best of 3: 91.3 µs per loop
sage: m = ManinSymbolList_character(eps, 100)                                             
sage: timeit("n = m.apply_T(4)") 
125 loops, best of 3: 7.7 ms per loop
sage: timeit("n = m.apply_TT(4)")
625 loops, best of 3: 90.6 µs per loop
```



---

Comment by AlexGhitza created at 2011-01-29 05:50:25

Changing status from new to needs_review.


---

Comment by davidloeffler created at 2011-01-29 10:16:12

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2011-01-29 10:16:12

I don't like the following:

```
sage: a = ZZ(10); b = (2*a).binomial(a, algorithm="spam")
sage: b is None
True
```

It should probably raise an error if the algorithm is unrecognized, not just fall of the end of the function and return None.

Also, the "algorithm = mpir" option doesn't seem to allow the computation to be interrupted with Ctrl-C, so if you feed it a very large number by mistake you end up with no alternative but to kill your entire sage session. (The Pari implementation seems to handle interrupts better.) 

Finally, I'd very much prefer it if the generic "binomial" function, called with an integer object, just called the binomial method of that object, and allowed the user to specify an algorithm there instead.


---

Comment by davidloeffler created at 2011-01-29 10:16:53

s/instead/as well/.


---

Comment by AlexGhitza created at 2011-01-29 12:55:24

Changing status from needs_work to needs_review.


---

Comment by AlexGhitza created at 2011-01-29 12:55:24

Replying to [comment:2 davidloeffler]:
> I don't like the following:
> {{{
> sage: a = ZZ(10); b = (2*a).binomial(a, algorithm="spam")
> sage: b is None
> True
> }}}
> It should probably raise an error if the algorithm is unrecognized, not just fall of the end of the function and return None.

Done.

> Also, the "algorithm = mpir" option doesn't seem to allow the computation to be interrupted with Ctrl-C, so if you feed it a very large number by mistake you end up with no alternative but to kill your entire sage session. (The Pari implementation seems to handle interrupts better.) 

Fixed.

> Finally, I'd very much prefer it if the generic "binomial" function, called with an integer object, just called the binomial method of that object, and allowed the user to specify an algorithm there instead. 

Done.


---

Comment by davidloeffler created at 2011-01-29 14:25:31

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2011-01-29 14:25:31

According to patchbot the new patch causes a doctest to fail in combinat (something to do with Catalan numbers).


---

Attachment


---

Comment by AlexGhitza created at 2011-01-29 22:32:39

Replying to [comment:5 davidloeffler]:
> According to patchbot the new patch causes a doctest to fail in combinat (something to do with Catalan numbers).

Fixed and added a doctest to make sure I don't break it again.


---

Comment by AlexGhitza created at 2011-01-29 22:32:39

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2011-01-30 10:57:26

Changing status from needs_review to positive_review.


---

Comment by davidloeffler created at 2011-01-30 10:57:26

Looks fine now.


---

Comment by jdemeyer created at 2011-03-18 13:40:51

Resolution: fixed
