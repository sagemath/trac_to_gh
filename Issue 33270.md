# Issue 33270: sagemath_doc_html: Use pythreejs for 3D graphics

Issue created by migration from https://trac.sagemath.org/ticket/33507

Original creator: mkoeppe

Original creation time: 2022-03-15 20:50:22

CC:  klee jhpalmieri nthiery egourgoulhon dimpase

The Sphinx documentation of `pythreejs` has proper 3D graphics, see for example
https://pythreejs.readthedocs.io/en/stable/examples/Animation.html 

We should be able to do the same.


---

Comment by klee created at 2022-03-16 03:58:33

It uses nbsphinx: https://nbsphinx.readthedocs.io/en/0.8.8/

nbsphinx allows including jupyter notebooks in toctrees. It seems that we cannot include a single cell of a jupyter notebook as a part of our documentation, which I guess is what we want.


---

Comment by git created at 2022-03-16 05:06:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-16 05:08:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-03-16 05:10:33

This tool 

https://jupyter-sphinx.readthedocs.io/en/latest/

works well.

I uploaded a branch to experiment with the tool. First `sage -pip install jupyter-sphinx`.


---

Comment by mkoeppe created at 2022-03-16 05:28:00

This package would be easy to add, we already have all dependencies -  https://github.com/jupyter/jupyter-sphinx/blob/master/setup.py#L30


---

Comment by git created at 2022-03-16 05:33:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-16 08:30:50

We need a sagemath binder repo for Thebe to work.


---

Comment by git created at 2022-03-17 04:53:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-17 05:07:38

The last commit provides an example to provide live images to htmls and static images to pdfs.


---

Comment by klee created at 2022-03-17 05:18:05

One annoying thing is that `.. only:: latex` works but `.. only:: pdf` doesn't.


---

Comment by git created at 2022-03-17 05:22:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-17 07:13:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-17 07:13:22

Here's the package


---

Comment by nthiery created at 2022-03-17 08:15:03

Replying to [comment:10 klee]:
> We need a sagemath binder repo for Thebe to work.

I fixed 'Sage binder env' about a month ago:

https://github.com/sagemath/sage-binder-env

It now uses conda to install Sage which is more maintained than
Sage's docker image.


---

Comment by klee created at 2022-03-17 08:29:38

Replying to [comment:16 mkoeppe]:
> Here's the package

Thank you!


---

Comment by klee created at 2022-03-17 08:52:36

Replying to [comment:17 nthiery]:
> Replying to [comment:10 klee]:
> > We need a sagemath binder repo for Thebe to work.
> 
> I fixed 'Sage binder env' about a month ago:
> 
> https://github.com/sagemath/sage-binder-env
> 
> It now uses conda to install Sage which is more maintained than
> Sage's docker image.

I have no experience with Thebe. Jupyter-sphinx supports Thebe. But running an interact example cell through jupyter-sphinx only shows `Waiting for kernel...`. Is this supposed to take long? Would the interact work well once the kernel is up?


---

Comment by git created at 2022-03-18 09:00:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-18 09:03:25

Replying to [comment:19 klee]:
> Replying to [comment:17 nthiery]:
> > Replying to [comment:10 klee]:
> > > We need a sagemath binder repo for Thebe to work.
> > 
> > I fixed 'Sage binder env' about a month ago:
> > 
> > https://github.com/sagemath/sage-binder-env
> > 
> > It now uses conda to install Sage which is more maintained than
> > Sage's docker image.
> 
> I have no experience with Thebe. Jupyter-sphinx supports Thebe. But running an interact example cell through jupyter-sphinx only shows `Waiting for kernel...`. Is this supposed to take long? Would the interact work well once the kernel is up?

It now seems work almost...only that the sage in conda doesn't work well.


---

Comment by git created at 2022-03-18 09:15:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-18 10:02:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2022-03-18 11:48:23

> It now seems work almost...

Good.

> only that the sage in conda doesn't work well.

Could this be made more specific?


---

Attachment

Replying to [comment:25 nthiery]:
> > It now seems work almost...
> 
> Good.
> 
> > only that the sage in conda doesn't work well.
> 
> Could this be made more specific?

See the screenshot.


---

Comment by klee created at 2022-03-18 13:11:16

It seems python not sage runs.


---

Comment by nthiery created at 2022-03-18 16:29:40

Replying to [comment:27 klee]:
> It seems python not sage runs.

I see.

In Thebe you can configure which kernel should be used;
see the kernel section in:

https://thebe.readthedocs.io/en/latest/config_reference.html

I assume that this can be done too through Jupyter-sphinx, though
I don't know the details from the top of my head.


---

Comment by nthiery created at 2022-03-18 16:33:50

Presumably it should be enough to insert a kernel section 
as documented in the thebe manual in the jupyter-sphinx
thebe configuration:

https://jupyter-sphinx.readthedocs.io/en/latest/#thebelab-support

See also:

https://jupyter-sphinx.readthedocs.io/en/latest/#controlling-the-execution-environment

Thank you for pushing this forward!


---

Comment by git created at 2022-03-18 23:10:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-18 23:12:42

Replying to [comment:28 nthiery]:
> In Thebe you can configure which kernel should be used;
> see the kernel section in:
> 
> https://thebe.readthedocs.io/en/latest/config_reference.html
> 
> I assume that this can be done too through Jupyter-sphinx, though
> I don't know the details from the top of my head.

Adding the kernel spec makes it work perfect. Thank you!


---

Comment by mkoeppe created at 2022-03-19 00:56:52

Given that all the old thebe stuff is commented out in `src/doc/common/themes/sage-classic/layout.html`, should we just remove it entirely (`build/pkgs/thebe/` etc.)?


---

Comment by mkoeppe created at 2022-03-19 01:02:45

(Looks like the branch at #24593 does this)


---

Comment by mkoeppe created at 2022-03-19 01:10:33

Done now in #33529.


---

Comment by mkoeppe created at 2022-03-19 01:40:39

With the present ticket, I am getting: 

```
[sagemath_doc_html-none] [reference] WARNING: failed to reach any of the inventories with the following issues:
[sagemath_doc_html-none] [reference] intersphinx inventory '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/share/doc/sage/inventory/en/reference/jupyter_execute/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/share/doc/sage/inventory/en/reference/jupyter_execute/objects.inv'
[sagemath_doc_html-none] [reference] building [html]: targets for 1 source files that are out of date
[sagemath_doc_html-none] [reference] dumping search index in English (code: en)... done
[sagemath_doc_html-none] [reference] The HTML pages are in local/share/doc/sage/html/en/reference/references.
```

(even after `make doc-uninstall`)


---

Comment by klee created at 2022-03-19 02:53:41

I saw that strange thing. I just deleted the directory. I have no idea where that came from.


---

Comment by mkoeppe created at 2022-03-19 03:04:35

Thanks, this helped.


---

Comment by mkoeppe created at 2022-03-19 03:09:04

This looks very good already!


---

Comment by git created at 2022-03-19 11:44:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-19 12:16:23

As shown by the examples provided by the branch, static images for pdf documentation can either be provided (1) by `sphinx_plot` (this is the status quo), or (2) by prepared png image files saved from live threejs graphics. 

There are pros and cons of both ways. Though both ways may coexist in sage, I think we should choose one of them as a norm, to guide future efforts to improve the documentation.

Pros of (1): It is the current standard; It does not increase the size of the sage distribution.

Pros of (2): It is of better quality; It is consistent with the live threejs renderings.

Cons of (1) is the negative of pros of (2), and vice versa. In particular, a big con of (2) is that it would increase the size of the sage distribution greatly.

So what do you think?


---

Comment by mkoeppe created at 2022-03-19 18:36:56

I'd say for this ticket (1) is better; actually not so much because of the added size but rather because of maintainability concerns. I'm not too worried about the output quality of the PDF documentation (I'd be surprised if anyone looks at it)


---

Comment by git created at 2022-03-20 04:52:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-20 04:53:41

Replying to [comment:43 mkoeppe]:
> I'd say for this ticket (1) is better; actually not so much because of the added size but rather because of maintainability concerns. I'm not too worried about the output quality of the PDF documentation 

Okay.

> (I'd be surprised if anyone looks at it)

:)


---

Comment by klee created at 2022-03-20 04:58:21

In the last commit, I added many jupyter-sphinx images to plot3d.py.

But if you see the page in a webbrowser (at least in my case), many initial images disappear as more images are rendered. 

I don't know why this happens. Too many iframes?


---

Comment by klee created at 2022-03-20 05:11:56

It seems a limit on threejs images:

https://stackoverflow.com/questions/41919341/is-there-a-limit-to-the-number-of-three-webglrenderer-instances-in-a-page


---

Comment by git created at 2022-03-20 08:44:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-20 08:45:27

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-03-20 09:36:44

Replying to [comment:45 klee]:
> Replying to [comment:43 mkoeppe]:
> > I'd say for this ticket (1) is better; actually not so much because of the added size but rather because of maintainability concerns. I'm not too worried about the output quality of the PDF documentation 
> 
> Okay.
> 
> > (I'd be surprised if anyone looks at it)
> 
> :)

I would also vote for (1) for the same reason.


---

Comment by git created at 2022-03-20 10:34:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-21 00:48:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-21 00:57:52

The last commit prevents input code display in Thebe cell as it is duplicate of the example just above it. This in effect also prevents a user from editing the input.


---

Comment by mkoeppe created at 2022-03-21 06:04:25

I have built HTML and PDF. HTML is great, a very nice improvement. PDF is unchanged. I would be ready to give it a positive review.


---

Comment by klee created at 2022-03-21 06:54:30

Replying to [comment:55 mkoeppe]:
> PDF is unchanged. 

I guess you are positive about this.


---

Comment by klee created at 2022-03-21 06:56:30

Replying to [comment:55 mkoeppe]:
> I have built HTML and PDF. HTML is great, a very nice improvement. 

Indeed, we are fortunate to have a very nice tool: jupyter-sphix.


---

Comment by mkoeppe created at 2022-03-21 07:16:40

Replying to [comment:56 klee]:
> Replying to [comment:55 mkoeppe]:
> > PDF is unchanged. 
> 
> I guess you are positive about this.

Yes, this matches the scope of the ticket.


---

Comment by nthiery created at 2022-03-21 14:00:28

Thank you `@`klee! Very nice addition :-)

I am super glad to see Thebe support in the Sage documentation!


---

Comment by klee created at 2022-03-21 14:09:51

Thank you for setting up the sage binder repo!


---

Comment by dimpase created at 2022-03-21 20:21:09

any reason to delay this until 9.7?


---

Comment by dimpase created at 2022-03-21 20:43:52

even after doc-clean, I get an error building docs:

```
[sagemath_doc_html-none] OSError: WARNING: Unable to fetch /Users/dima/sage/local/share/doc/sage/doctrees/en/reference/plot3d/environment.pickle
```



---

Comment by egourgoulhon created at 2022-03-21 20:44:08

Just tested it. This is very nice!

+1 for a positive review. 

Just for curiosity: why is #33522 a dependency?


---

Comment by git created at 2022-03-22 00:05:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-03-22 00:16:05

Replying to [comment:65 egourgoulhon]: 
> Just for curiosity: why is #33522 a dependency?

That was just a temporary dependency. Now removed.


---

Comment by klee created at 2022-03-22 00:17:23

Replying to [comment:64 dimpase]:
> even after doc-clean, I get an error building docs:
> {{{
> [sagemath_doc_html-none] OSError: WARNING: Unable to fetch /Users/dima/sage/local/share/doc/sage/doctrees/en/reference/plot3d/environment.pickle
> }}}

I do: `make doc-clean; make doc-uninstall; make`


---

Comment by git created at 2022-03-22 02:00:39

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by klee created at 2022-03-22 03:46:15

You revived the dependency #33522 that I removed.


---

Comment by git created at 2022-03-22 04:34:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-22 04:34:52

Sorry, fixed now


---

Comment by dimpase created at 2022-03-22 15:46:00

I am still getting this docbuild error on macOS, even after `git clean -fdx`.

```
[sagemath_doc_html-none] [repl     ] executing interact
[sagemath_doc_html-none] [repl     ] /Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jsonschema/validators.py:188: DeprecationWarning: Passing a schema to Validator.iter_errors is deprecated and will be removed in a future release. Call validator.evolve(schema=new_schema).iter_errors(...) instead.
[sagemath_doc_html-none] [repl     ]   warnings.warn(
[sagemath_doc_html-none] [repl     ] Extension error:
[sagemath_doc_html-none] [repl     ] Notebook execution failed (exception: [Errno 2] No such file or directory: '/Users/dima/sage/local/bin/sage')
...
[sagemath_doc_html-none] [plot3d   ] executing plot3d
[sagemath_doc_html-none] [plot3d   ] /Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jsonschema/validators.py:188: DeprecationWarning: Passing a schema to Validator.iter_errors is deprecated and will be removed in a future release. Call validator.evolve(schema=new_schema).iter_errors(...) instead.
[sagemath_doc_html-none] [plot3d   ]   warnings.warn(
[sagemath_doc_html-none] [plot3d   ] Extension error:
[sagemath_doc_html-none] [plot3d   ] Notebook execution failed (exception: [Errno 2] No such file or directory: '/Users/dima/sage/local/bin/sage')
...
sagemath_doc_html-none] [reference] ... done (500 todos, 2546 index, 1665 citations, 2139 modules)
[sagemath_doc_html-none] [reference] WARNING: Unable to fetch /Users/dima/sage/local/share/doc/sage/doctrees/en/reference/plot3d/environment.pickle
[sagemath_doc_html-none] [reference] WARNING: Unable to fetch /Users/dima/sage/local/share/doc/sage/doctrees/en/reference/repl/environment.pickle
[sagemath_doc_html-none] [reference] preparing documents... skipping loading of indexes... done
[sagemath_doc_html-none] [reference] /Users/dima/sage/src/doc/en/reference/index.rst:17: WARNING: unknown document: repl/index
[sagemath_doc_html-none] [reference] /Users/dima/sage/src/doc/en/reference/index.rst:24: WARNING: unknown document: plot3d/index
[sagemath_doc_html-none] [reference] The inventory files are in local/share/doc/sage/inventory/en/reference.
[sagemath_doc_html-none] Error building the documentation.
[sagemath_doc_html-none] Traceback (most recent call last):
[sagemath_doc_html-none]   File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
[sagemath_doc_html-none]     return _run_code(code, main_globals, None,
[sagemath_doc_html-none]   File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
[sagemath_doc_html-none]     exec(code, run_globals)
[sagemath_doc_html-none]   File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
[sagemath_doc_html-none]     main()
[sagemath_doc_html-none]   File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1751, in main
[sagemath_doc_html-none]     builder()
[sagemath_doc_html-none]   File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 141, in f
[sagemath_doc_html-none]     runsphinx()
[sagemath_doc_html-none]   File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 326, in runsphinx
[sagemath_doc_html-none]     sys.stderr.raise_errors()
[sagemath_doc_html-none]   File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 262, in raise_errors
[sagemath_doc_html-none]     raise OSError(self._error)
[sagemath_doc_html-none] OSError: WARNING: Unable to fetch /Users/dima/sage/local/share/doc/sage/doctrees/en/reference/plot3d/environment.pickle 
[sagemath_doc_html-none] 
[sagemath_doc_html-none]     Note: incremental documentation builds sometimes cause spurious
[sagemath_doc_html-none]     error messages. To be certain that these are real errors, run
[sagemath_doc_html-none]     "make doc-clean doc-uninstall" first and try again.
[sagemath_doc_html-none] make[6]: *** [doc-inventory--reference_top] Error 1
[sagemath_doc_html-none] make[5]: *** [doc-inventory-reference] Error 2
make[4]: *** [sagemath_doc_html-SAGE_DOCS-no-deps] Error 2
```


something in these two modules wants to call `'/Users/dima/sage/local/bin/sage'` - 
which is absent, naturally, and probably this leads to absent `environment.pickle` in plot3d.

I presume the message "Notebook execution failed" comes from jupyter-sphinx:
https://github.com/jupyter/jupyter-sphinx/blob/master/jupyter_sphinx/execute.py


---

Comment by dimpase created at 2022-03-22 20:30:43

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2022-03-22 20:30:43

after 

```
ln -s /Users/dima/sage/sage /Users/dima/sage/local/bin/sage
```

the docbuild completes, but it's certainly a problem to be fixed that needs this workaround.


---

Comment by klee created at 2022-03-23 01:12:09

Replying to [comment:75 dimpase]:
> I am still getting this docbuild error on macOS, even after `git clean -fdx`.
> {{{
> [sagemath_doc_html-none] [repl     ] executing interact
> [sagemath_doc_html-none] [repl     ] /Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jsonschema/validators.py:188: DeprecationWarning: Passing a schema to Validator.iter_errors is deprecated and will be removed in a future release. Call validator.evolve(schema=new_schema).iter_errors(...) instead.
> [sagemath_doc_html-none] [repl     ]   warnings.warn(
> [sagemath_doc_html-none] [repl     ] Extension error:
> [sagemath_doc_html-none] [repl     ] Notebook execution failed (exception: [Errno 2] No such file or directory: '/Users/dima/sage/local/bin/sage')
...
> I presume the message "Notebook execution failed" comes from jupyter-sphinx:
> https://github.com/jupyter/jupyter-sphinx/blob/master/jupyter_sphinx/execute.py

I am on macOS too. Do you have no problem in running sagemath kernel in jupyter from your sage installation?


---

Comment by dimpase created at 2022-03-23 09:56:15

If I remove the symlink as in comment:76 I get a jupyter kernel error

```
Traceback (most recent call last):
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/web.py", line 1704, in _execute
    result = await result
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/tasks.py", line 328, in __wakeup
    future.result()
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/gen.py", line 769, in run
    yielded = self.gen.throw(*exc_info)  # type: ignore
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/notebook/services/sessions/handlers.py", line 74, in post
    model = yield maybe_future(
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/gen.py", line 762, in run
    value = future.result()
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/gen.py", line 769, in run
    yielded = self.gen.throw(*exc_info)  # type: ignore
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/notebook/services/sessions/sessionmanager.py", line 98, in create_session
    kernel_id = yield self.start_kernel_for_session(session_id, path, name, type, kernel_name)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/gen.py", line 762, in run
    value = future.result()
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/gen.py", line 769, in run
    yielded = self.gen.throw(*exc_info)  # type: ignore
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/notebook/services/sessions/sessionmanager.py", line 110, in start_kernel_for_session
    kernel_id = yield maybe_future(
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/tornado/gen.py", line 762, in run
    value = future.result()
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/futures.py", line 201, in result
    raise self._exception
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/tasks.py", line 256, in __step
    result = coro.send(None)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/notebook/services/kernels/kernelmanager.py", line 176, in start_kernel
    kernel_id = await maybe_future(self.pinned_superclass.start_kernel(self, **kwargs))
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/utils.py", line 26, in wrapped
    raise e
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/utils.py", line 23, in wrapped
    return loop.run_until_complete(future)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/nest_asyncio.py", line 81, in run_until_complete
    return f.result()
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/futures.py", line 201, in result
    raise self._exception
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/tasks.py", line 256, in __step
    result = coro.send(None)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/multikernelmanager.py", line 187, in _async_start_kernel
    starter = ensure_async(km.start_kernel(**kwargs))
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/utils.py", line 26, in wrapped
    raise e
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/utils.py", line 23, in wrapped
    return loop.run_until_complete(future)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/nest_asyncio.py", line 81, in run_until_complete
    return f.result()
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/futures.py", line 201, in result
    raise self._exception
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/tasks.py", line 256, in __step
    result = coro.send(None)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/manager.py", line 362, in _async_start_kernel
    raise e
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/manager.py", line 351, in _async_start_kernel
    await ensure_async(self._launch_kernel(kernel_cmd, **kw))
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/utils.py", line 26, in wrapped
    raise e
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/utils.py", line 23, in wrapped
    return loop.run_until_complete(future)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/nest_asyncio.py", line 81, in run_until_complete
    return f.result()
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/futures.py", line 201, in result
    raise self._exception
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/asyncio/tasks.py", line 256, in __step
    result = coro.send(None)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/manager.py", line 269, in _async_launch_kernel
    connection_info = await self.provisioner.launch_kernel(kernel_cmd, **kw)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/provisioning/local_provisioner.py", line 179, in launch_kernel
    self.process = launch_kernel(cmd, **scrubbed_kwargs)
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/launcher.py", line 169, in launch_kernel
    raise ex
  File "/Users/dima/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/jupyter_client/launcher.py", line 157, in launch_kernel
    proc = Popen(cmd, **kwargs)
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/subprocess.py", line 951, in __init__
    self._execute_child(args, executable, preexec_fn, close_fds,
  File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/subprocess.py", line 1821, in _execute_child
    raise child_exception_type(errno_num, err_msg, err_filename)
FileNotFoundError: [Errno 2] No such file or directory: '/Users/dima/sage/local/bin/sage'
```


With the link it works. It turns out I have outdated things in `~/Library/Jupyter`, in particular `sagemath/kernel.json` with the obsolete path to `sage` (version 9.4.beta3).

Sorry for noise, it's OK.


---

Comment by dimpase created at 2022-03-23 09:56:15

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2022-03-23 18:36:45

Probably the docbuild should try to isolate from such user settings.


---

Comment by klee created at 2022-03-23 23:49:40

Replying to [comment:79 mkoeppe]:
> Probably the docbuild should try to isolate from such user settings.

I don't understand the precise mechanism. But it seems that jupyter-sphinx just runs a new jupyter notebook with sagemath kernel. Then there is nothing to do with the docbuild.


---

Comment by klee created at 2022-03-23 23:52:54

Replying to [comment:78 dimpase]:

Thank you for review.


---

Comment by mkoeppe created at 2022-03-24 00:16:54

Replying to [comment:80 klee]:
> Replying to [comment:79 mkoeppe]:
> > Probably the docbuild should try to isolate from such user settings.
> 
> I don't understand the precise mechanism. But it seems that jupyter-sphinx just runs a new jupyter notebook with sagemath kernel. Then there is nothing to do with the docbuild.

But its happening during the docbuild according to the output that Dima shared


---

Comment by klee created at 2022-03-24 00:27:17

Replying to [comment:82 mkoeppe]:
> But its happening during the docbuild according to the output that Dima shared

The source of the problem may be in our jupyter kernel configuration in `repl.ipython_kernel.kernel`.


---

Comment by dimpase created at 2022-03-24 08:55:55

Replying to [comment:82 mkoeppe]:
> Replying to [comment:80 klee]:
> > Replying to [comment:79 mkoeppe]:
> > > Probably the docbuild should try to isolate from such user settings.
> > 
> > I don't understand the precise mechanism. But it seems that jupyter-sphinx just runs a new jupyter notebook with sagemath kernel. Then there is nothing to do with the docbuild.
> 
> But its happening during the docbuild according to the output that Dima shared

I could reproduce this issue just by running `./sage -n`. So this is indeed a "pure" notebook problem.


---

Comment by vbraun created at 2022-04-02 10:52:54

Resolution: fixed


---

Comment by mkoeppe created at 2022-04-05 19:18:00

The first bug report on this may have arrived: https://groups.google.com/g/sage-release/c/-0luW4DPEPs/m/1bST2lbcCAAJ


---

Comment by dimpase created at 2022-04-05 20:59:07

Replying to [comment:86 mkoeppe]:
> The first bug report on this may have arrived: https://groups.google.com/g/sage-release/c/-0luW4DPEPs/m/1bST2lbcCAAJ

You mean 

```
[sagemath_doc_html-none] [plot3d   ] Notebook execution failed (exception: [Errno 2] No such file or directory: '/home/furutaka/work/sage/sage-9.0-git-bld/local/bin/sage')
```

I suppose.

This looks identical to comment:75 - a stale Jupyter kernel somewhere.


---

Comment by mkoeppe created at 2022-04-06 04:38:14

Yes. I have opened #33650 for this.
