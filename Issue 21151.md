# Issue 21151: Make Psi2 function less likely to break the stack

archive/issues_021151.json:
```json
{
    "body": "This provides a workaround to a test that caused the Python interpreter to segfault on Windows.  The specific call that caused the segfault is:\n\n`Psi2(71)`\n\nI don't know if that function needs to be implemented the way it is--it's possible that it could be reworked from the ground up to not need this work-around, but I don't know.  I still don't understand the coercion model well-enough.\n\nBut in brief, the crash occurs because we have (in the original code) a large element of \"Univariate Quotient Polynomial Ring in v over Multivariate Polynomial Ring in x, u over Rational Field with modulus v^2 - u^4 + 10*u^3 + 3*u^2 - 4*u + 8\".  This is then being cast simply to a multivariate rational polynomial over x, u, v.  Because there is no direct coercion between these types this involves `eval()`-ing the polynomial as a Python expression.\n\nThe problem is that this expression can become too large for the stack--specifically in Python's symbol visibility analysis, a step it performs just before compiling an expression to bytecode.  The implementation of that recurses into binary expressions, leading to a stack overflow for such a large expression.  This issue has come up once before in #16014 where it was worked around by a rewrite of the code.  This particular test worked on Linux where the default stack size is 8MB, but it crashed on Windows where the typical stack is just 1MB.\n\nThe workaround this time is to simply cast each term in the final sum individually and then sum those terms, rather than summing first and then casting.  This is probably slower, but gives Python smaller expressions to eval.\n\nA more general fix to this problem would be nice though--I'm writing up some thoughts I have on it in a separate post.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21388\n\n",
    "created_at": "2016-09-01T09:28:12Z",
    "labels": [
        "component: elliptic curves",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Make Psi2 function less likely to break the stack",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21151",
    "user": "https://github.com/embray"
}
```
This provides a workaround to a test that caused the Python interpreter to segfault on Windows.  The specific call that caused the segfault is:

`Psi2(71)`

I don't know if that function needs to be implemented the way it is--it's possible that it could be reworked from the ground up to not need this work-around, but I don't know.  I still don't understand the coercion model well-enough.

But in brief, the crash occurs because we have (in the original code) a large element of "Univariate Quotient Polynomial Ring in v over Multivariate Polynomial Ring in x, u over Rational Field with modulus v^2 - u^4 + 10*u^3 + 3*u^2 - 4*u + 8".  This is then being cast simply to a multivariate rational polynomial over x, u, v.  Because there is no direct coercion between these types this involves `eval()`-ing the polynomial as a Python expression.

The problem is that this expression can become too large for the stack--specifically in Python's symbol visibility analysis, a step it performs just before compiling an expression to bytecode.  The implementation of that recurses into binary expressions, leading to a stack overflow for such a large expression.  This issue has come up once before in #16014 where it was worked around by a rewrite of the code.  This particular test worked on Linux where the default stack size is 8MB, but it crashed on Windows where the typical stack is just 1MB.

The workaround this time is to simply cast each term in the final sum individually and then sum those terms, rather than summing first and then casting.  This is probably slower, but gives Python smaller expressions to eval.

A more general fix to this problem would be nice though--I'm writing up some thoughts I have on it in a separate post.

Issue created by migration from https://trac.sagemath.org/ticket/21388





---

archive/issue_comments_292699.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-01T09:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292699",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_292700.json:
```json
{
    "body": "In fact, we don't need the variable `x` in the ring `R` at all...\n\nHang on...\n----\nNew commits:",
    "created_at": "2016-09-02T09:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292700",
    "user": "https://github.com/jdemeyer"
}
```

In fact, we don't need the variable `x` in the ring `R` at all...

Hang on...
----
New commits:



---

archive/issue_comments_292701.json:
```json
{
    "body": "Is the idea that you would just take the multiplication by `x` outside?",
    "created_at": "2016-09-02T09:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292701",
    "user": "https://github.com/embray"
}
```

Is the idea that you would just take the multiplication by `x` outside?



---

archive/issue_comments_292702.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-02T09:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292702",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_292703.json:
```json
{
    "body": "This also happens to speed up the function by a factor of 10.\n\nPlease review...",
    "created_at": "2016-09-02T09:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292703",
    "user": "https://github.com/jdemeyer"
}
```

This also happens to speed up the function by a factor of 10.

Please review...



---

archive/issue_comments_292704.json:
```json
{
    "body": "Some of this makes sense to me (I was already irked by the use of `+= []`) but the rest is a little beyond my understanding of how Sage works (though I'd appreciate a brief explanation :) \n\nThat said it's no surprise to me that more could be done with this than what I did.",
    "created_at": "2016-09-02T09:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292704",
    "user": "https://github.com/embray"
}
```

Some of this makes sense to me (I was already irked by the use of `+= []`) but the rest is a little beyond my understanding of how Sage works (though I'd appreciate a brief explanation :) 

That said it's no surprise to me that more could be done with this than what I did.



---

archive/issue_comments_292705.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> Some of this makes sense to me (I was already irked by the use of `+= []`) but the rest is a little beyond my understanding of how Sage works (though I'd appreciate a brief explanation :)\n\n0. Some general code cleanup and reformatting, in particular adding some spaces.\n\n1. To construct the rational number `1/x`, I use `QQ((1,x))` instead of `1/QQ(x)`.\n\n2. I remove `raise ValueError(\"%s must be one of %s.\"%(l,hyperelliptic_primes))` since that exception is already raised by `_hyperelliptic_isogeny_data`.\n\n3. I rename `y` -> `v` to avoid confusion (the first `v` and the second `v` are really the same thing conceptually).\n\n4. I remove the variable `x` from the first `R` since it's never used. This is probably where the main speed-up comes from.\n\n5. I replace `s = [1]` by `s = [K(1)]` to ensure that all elements of `s` have `K` as parent.\n\n6. I replace your `R((-1)**i*s[i]*x**(d-i))` by `(-1)**i * x**(d-i) * R(s[i])`. Since `s[i]` does not involve the variable `x` at all, I can indeed first convert `s[i]` to `R` and then multiply with `x`.\n\n7. I replace `s[i]` by `s[i].lift()` before conversion. This means \"forgetting\" the quotient and converting `s[i]` to a true polynomial. Put differently, it's the conversion from `K` to `L`. Then there is a coercion from `L` to `R` (but not from `K` to `R`).",
    "created_at": "2016-09-02T10:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292705",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 embray]:
> Some of this makes sense to me (I was already irked by the use of `+= []`) but the rest is a little beyond my understanding of how Sage works (though I'd appreciate a brief explanation :)

0. Some general code cleanup and reformatting, in particular adding some spaces.

1. To construct the rational number `1/x`, I use `QQ((1,x))` instead of `1/QQ(x)`.

2. I remove `raise ValueError("%s must be one of %s."%(l,hyperelliptic_primes))` since that exception is already raised by `_hyperelliptic_isogeny_data`.

3. I rename `y` -> `v` to avoid confusion (the first `v` and the second `v` are really the same thing conceptually).

4. I remove the variable `x` from the first `R` since it's never used. This is probably where the main speed-up comes from.

5. I replace `s = [1]` by `s = [K(1)]` to ensure that all elements of `s` have `K` as parent.

6. I replace your `R((-1)**i*s[i]*x**(d-i))` by `(-1)**i * x**(d-i) * R(s[i])`. Since `s[i]` does not involve the variable `x` at all, I can indeed first convert `s[i]` to `R` and then multiply with `x`.

7. I replace `s[i]` by `s[i].lift()` before conversion. This means "forgetting" the quotient and converting `s[i]` to a true polynomial. Put differently, it's the conversion from `K` to `L`. Then there is a coercion from `L` to `R` (but not from `K` to `R`).



---

archive/issue_comments_292706.json:
```json
{
    "body": "Thanks, that all makes sense.  In particular I didn't realize what lift() did.",
    "created_at": "2016-09-02T11:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292706",
    "user": "https://github.com/embray"
}
```

Thanks, that all makes sense.  In particular I didn't realize what lift() did.



---

archive/issue_comments_292707.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-02T11:30:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292707",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_292708.json:
```json
{
    "body": "Reviewer name..",
    "created_at": "2016-09-02T19:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292708",
    "user": "https://github.com/vbraun"
}
```

Reviewer name..



---

archive/issue_comments_292709.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-09-02T19:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292709",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_292710.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-09-02T20:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292710",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_292711.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-04T00:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21151#issuecomment-292711",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
