# Issue 33631: A bug in modules with basis

Issue created by migration from https://trac.sagemath.org/ticket/33868

Original creator: klee

Original creation time: 2022-05-19 08:17:39

CC:  tscrim jhpalmieri

It seems that stuffs of new modules with flexible bases interfere with classical modules with fixed basis:

```
sage: S.<x,y,z,w> = PolynomialRing(QQ)
sage: A = S**2
sage: A
Ambient free module of rank 2 over the integral domain Multivariate Polynomial Ring in x, y, z, w over Rational Field
sage: A.submodule([vector([x-y,z-w]), vector([y*z, x*w])])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-7-cabbcc8d5285> in <module>
----> 1 A.submodule([vector([x-y,z-w]), vector([y*z, x*w])])

~/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/modules_with_basis.py in submodule(self, gens, check, already_echelonized, unitriangular, support_order, category, *args, **opts)
    876             support_order = self._compute_support_order(gens, support_order)
    877             if not already_echelonized:
--> 878                 gens = self.echelon_form(gens, unitriangular, order=support_order)
    879 
    880             from sage.modules.with_basis.subquotient import SubmoduleWithBasis

~/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/finite_dimensional_modules_with_basis.py in echelon_form(self, elements, row_reduced, order)
    367             order = self._compute_support_order(elements, order)
    368             from sage.matrix.constructor import matrix
--> 369             mat = matrix(self.base_ring(), [g._vector_(order=order) for g in elements])
    370             # Echelonizing a matrix over a field returned the rref
    371             if row_reduced and self.base_ring() not in Fields():

~/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/finite_dimensional_modules_with_basis.py in <listcomp>(.0)
    367             order = self._compute_support_order(elements, order)
    368             from sage.matrix.constructor import matrix
--> 369             mat = matrix(self.base_ring(), [g._vector_(order=order) for g in elements])
    370             # Echelonizing a matrix over a field returned the rref
    371             if row_reduced and self.base_ring() not in Fields():

~/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/modules/free_module_element.pyx in sage.modules.free_module_element.FreeModuleElement._vector_ (build/cythonized/sage/modules/free_module_element.c:9892)()
   1141         return hash(tuple(self))
   1142 
-> 1143     def _vector_(self, R=None):
   1144         r"""
   1145         Return self as a vector.

TypeError: _vector_() got an unexpected keyword argument 'order'
```



---

Comment by klee created at 2022-05-19 08:24:13

I see many module-related methods accept this `order` argument. It is not immediately clear what is the role of this argument. I guess it gives an "order" to the basis...


---

Comment by jhpalmieri created at 2022-05-19 21:07:41

As dimpase pointed out on sage-devel, many things are just not implemented for modules over infinite-dimensional rings. The recently added `modules/fp_graded` (finitely presented modules over graded connected rings) implements some things, but only in a graded setting.


---

Comment by klee created at 2022-05-20 01:17:27

Replying to [comment:3 jhpalmieri]:
> As dimpase pointed out on sage-devel, many things are just not implemented for modules over infinite-dimensional rings. The recently added `modules/fp_graded` (finitely presented modules over graded connected rings) implements some things, but only in a graded setting.

I see. I forgot that... Anyway I will think of a way to raise an exception less surprising in such cases, or provide a simple implementation of submodules of such ambient modules. 

I was working with morphisms between modules over multivariate polynomial rings, and tried to get the image and the kernel of a morphism. I did't know even submodules are not in place...


---

Comment by klee created at 2022-05-20 02:07:06

Replying to [comment:3 jhpalmieri]:
> The recently added `modules/fp_graded` (finitely presented modules over graded connected rings) implements some things, but only in a graded setting.

Actually what I need is submodules of free modules (of finite rank) over graded multivariate polynomial rings. The grading may be multigrades, that is, by integer vectors. Then are these modules included in `fp_graded` modules?


---

Comment by tscrim created at 2022-05-20 02:18:15

Replying to [comment:5 klee]:
> Replying to [comment:3 jhpalmieri]:
> > The recently added `modules/fp_graded` (finitely presented modules over graded connected rings) implements some things, but only in a graded setting.
> 
> Actually what I need is submodules of free modules (of finite rank) over graded multivariate polynomial rings. The grading may be multigrades, that is, by integer vectors. Then are these modules included in `fp_graded` modules?

I don't know how well tested the code is for multigradings, but in principle it should work. The biggest issue I think is polynomial rings do not know they are multigraded. We can hack around this with an appropriate subclass of `CombinatorialFreeModule` that uses a free monoid as its indexing set. However, do not expect algebraic operations to be fast, or have some other polynomial features like division, Gröbner bases, etc.

The easiest fix for this issue would probably be to just modify the `_vector_` to take `order` and ignore it. I can't promise there won't be another compatibility issue, but we can fix those as we encounter them.


---

Comment by klee created at 2022-05-20 02:34:15

Replying to [comment:6 tscrim]:
> I don't know how well tested the code is for multigradings, but in principle it should work. The biggest issue I think is polynomial rings do not know they are multigraded. We can hack around this with an appropriate subclass of `CombinatorialFreeModule` that uses a free monoid as its indexing set. However, do not expect algebraic operations to be fast, or have some other polynomial features like division, Gröbner bases, etc.

Moreover, these modules like `fp_graded` seem intended for modules over algebras and these algebras are not primarily commutative. I see "graded commutative" in sage.algebras.commutative_dga, but this is not "graded" + "commutative".

These seem to be not proper tools to work with the usual graded polynomials rings and modules needed for computational commutative algebra and algebraic geometry.

> 
> The easiest fix for this issue would probably be to just modify the `_vector_` to take `order` and ignore it. 

Okay. I thought of that, but was not sure if that is a right way. Thanks.


---

Comment by tscrim created at 2022-05-20 02:46:05

Replying to [comment:7 klee]:
> Replying to [comment:6 tscrim]:
> > I don't know how well tested the code is for multigradings, but in principle it should work. The biggest issue I think is polynomial rings do not know they are multigraded. We can hack around this with an appropriate subclass of `CombinatorialFreeModule` that uses a free monoid as its indexing set. However, do not expect algebraic operations to be fast, or have some other polynomial features like division, Gröbner bases, etc.
> 
> Moreover, these modules like `fp_graded` seem intended for modules over algebras and these algebras are not primarily commutative.

That is true. They are meant to work with general (likely associative unital) algebras. It does not have the linear algebra quite so close at hand, but they might fair a bit better when moving outside of free modules. We need to have more native support for non-free modules, some of which for commutative base rings can be pulled from singular.

> These seem to be not proper tools to work with the usual graded polynomials rings and modules needed for computational commutative algebra and algebraic geometry.

I don't quite know what you are hoping to compute as it is a bit too far outside of my area. The code here can do some homological algebra. John might know more about how it could be applied.

PS - The `order` argument is for free modules that do not necessarily have a fixed/well-defined ordering of the basis elements. However, to (efficiently) do the linear algebra, we need to chose an ordering of the basis to manipulate the matrices. Thus this is used to convert to/from the implementation with a fixed ordering.


---

Comment by klee created at 2022-05-20 03:44:53

Replying to [comment:8 tscrim]:

> I don't quite know what you are hoping to compute as it is a bit too far outside of my area. The code here can do some homological algebra. John might know more about how it could be applied.

I am working on graded free resolutions of graded modules over polynomial rings, pulling the resolution machinery of Singular. Hence I really don't need to compute with the modules in Sage, but just need the framework. As it is not there, perhaps I can work with matrices instead.

> PS - The `order` argument is for free modules that do not necessarily have a fixed/well-defined ordering of the basis elements. However, to (efficiently) do the linear algebra, we need to choose an ordering of the basis to manipulate the matrices. Thus this is used to convert to/from the implementation with a fixed ordering.

Thanks for explanation.


---

Comment by git created at 2022-05-20 23:00:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-05-20 23:06:09

Changing status from new to needs_review.


---

Comment by klee created at 2022-05-20 23:06:09

I decided to follow Dima's idea, to implement modules over domain. This just amount to insert a class for "modules over domain" between "modules over ring" and "modules over pid". Refactoring thus gives some (trivial) functions to modules over domain.


---

Comment by klee created at 2022-05-21 11:21:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-21 12:26:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-05-21 12:26:42

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-05-21 23:17:19

Changing status from needs_review to needs_work.


---

Comment by klee created at 2022-05-21 23:17:19

As submodules of modules over domain may lack a (linearly independent) basis, the "quick fix" code needs more thought...


---

Comment by git created at 2022-05-25 02:04:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-05-25 02:14:41

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-05-25 02:14:41

Now `FreeModule_generic`, which is the base class of all modules, does not assume that a rank is defined (or an echelon form of its basis matrix is defined). The argument `rank` is `None` in this case.

The change allows a room for `FreeModule_generic_domain` the class of modules over an integral domain, for which there is no notion of rank. Submodules and quotient modules of ambient free modules over a domain can be constructed. There is no attempt to provide a "rank" (or an "echelon form" of the defining matrix) for them.


---

Comment by klee created at 2022-05-27 09:10:52

It now seems to me that classes `FreeModule_submodule_...` defined in `sage.modules.free_module` are intended for (mathematical) free modules, but just embedded as a submodule (of a free module). Hence they all have mathematically well-defined notion of rank (but still possibly no echelon form). 

Then it seems wrong to insert submodules of free modules over a domain (without well-defined notion of rank) here...


---

Comment by klee created at 2022-05-27 09:10:52

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-28 12:30:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-05-28 12:32:39

Now submodules of free modules over a domain is defined in new `submodule.py`.

I also cleaned up modules toc tree.


---

Comment by klee created at 2022-05-28 12:32:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-28 12:37:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-08 03:25:16

Some quick comments:

- For `submodule.py`, I don't think it is good to call the generators basis elements since that implies it is a free module. It would be better to call them generators.
- It might be good to have a shortcut way to construct the morphism from the ambient free module into the submodule in order to do homological algebra (a la the finitely presented graded modules code; but perhaps one needs a little more finite-dimensional-ness coming from the grading to do anything meaningful).


---

Comment by klee created at 2022-06-08 05:20:26

Replying to [comment:28 tscrim]:
> - For `submodule.py`, I don't think it is good to call the generators basis elements since that implies it is a free module. It would be better to call them generators.

I agree. But technically the matters are more complicated. Currently submodules and quotients of free modules over any ring are all subclasses of `FreeModule_generic`. If submodules and quotients of free modules over a multivariate polynomial ring should work well together with existing infrastructure, they should also be subclasses of `FreeModule_generic`. As `FreeModule_generic` expects `basis()` method (implemented in subclasses), I have no choice but to supply this `basis()` method, which simply returns the set of generators. So unfortunately I cannot call them generators everywhere...


---

Comment by tscrim created at 2022-06-08 05:56:06

Replying to [comment:29 klee]:
> Replying to [comment:28 tscrim]:
> > - For `submodule.py`, I don't think it is good to call the generators basis elements since that implies it is a free module. It would be better to call them generators.
> 
> I agree. But technically the matters are more complicated. Currently submodules and quotients of free modules over any ring are all subclasses of `FreeModule_generic`. If submodules and quotients of free modules over a multivariate polynomial ring should work well together with existing infrastructure, they should also be subclasses of `FreeModule_generic`. As `FreeModule_generic` expects `basis()` method (implemented in subclasses), I have no choice but to supply this `basis()` method, which simply returns the set of generators. So unfortunately I cannot call them generators everywhere...

That seems like there should be a refactoring since anything titled `FreeModule` should naturally expect to have a basis. Probably some common methods related to submodules need to be factored out to some `Module_generic` class and then the stuff for free modules is a subclass of that with your generic submodule code being in a separate branch of the class hierarchy. This might get rid of the bit of a code smell coming from allowing `rank=None` as input.


---

Comment by klee created at 2022-06-08 06:53:52

Replying to [comment:30 tscrim]:
> That seems like there should be a refactoring since anything titled `FreeModule` should naturally expect to have a basis. Probably some common methods related to submodules need to be factored out to some `Module_generic` class and then the stuff for free modules is a subclass of that with your generic submodule code being in a separate branch of the class hierarchy. This might get rid of the bit of a code smell coming from allowing `rank=None` as input.

I agree that what you said is the right way to go. But that would be more demanding work... 

Okay. I will work more.


---

Comment by klee created at 2022-06-08 06:53:52

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-06-09 04:17:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-09 04:17:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-06-09 04:25:33

Replying to [comment:30 tscrim]: 
> That seems like there should be a refactoring since anything titled `FreeModule` should naturally expect to have a basis. Probably some common methods related to submodules need to be factored out to some `Module_generic` class and then the stuff for free modules is a subclass of that with your generic submodule code being in a separate branch of the class hierarchy. This might get rid of the bit of a code smell coming from allowing `rank=None` as input.

Done in the last commit. I used the name `FreeModule_base`, as the base class of modules whose elements are represented by elements of a free module. `FreeModule_generic` is such a base class but it is for modules with a basis. `FreeModule_base` are for modules without a basis.


---

Comment by klee created at 2022-06-09 04:29:35

Replying to [comment:28 tscrim]:
> It might be good to have a shortcut way to construct the morphism from the ambient free module into the submodule in order to do homological algebra.

There is no natural map from the ambient free module to a submodule. There is a natural coercion map from the ambient free module to a quotient. This map is really what I need for the free resolutions.


---

Comment by klee created at 2022-06-09 04:30:23

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-06-09 04:57:02

Replying to [comment:35 klee]:
> Replying to [comment:28 tscrim]:
> > It might be good to have a shortcut way to construct the morphism from the ambient free module into the submodule in order to do homological algebra.
> 
> There is no natural map from the ambient free module to a submodule. There is a natural coercion map from the ambient free module to a quotient. This map is really what I need for the free resolutions.

I think that was basically a typo: I think the suggestion was that it might be good to have a shortcut way to construct the morphism from the submodule to the ambient free module. The finitely presented module code, for example, rather than constructing a submodule `M` instead constructs the inclusion map `M -> F`.


---

Comment by git created at 2022-06-09 06:52:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-09 06:54:03

Replying to [comment:37 jhpalmieri]:
> Replying to [comment:35 klee]:
> > Replying to [comment:28 tscrim]:
> > > It might be good to have a shortcut way to construct the morphism from the ambient free module into the submodule in order to do homological algebra.
> > 
> > There is no natural map from the ambient free module to a submodule. There is a natural coercion map from the ambient free module to a quotient. This map is really what I need for the free resolutions.
> 
> I think that was basically a typo: I think the suggestion was that it might be good to have a shortcut way to construct the morphism from the submodule to the ambient free module. The finitely presented module code, for example, rather than constructing a submodule `M` instead constructs the inclusion map `M -> F`.

Okay. Now a submodule has a coercion map into the ambient free module.


---

Comment by git created at 2022-06-09 07:16:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-09 07:23:26

Still does not work well with free resolution code.


---

Comment by klee created at 2022-06-09 07:23:26

Changing status from needs_review to needs_work.


---

Comment by klee created at 2022-06-09 07:35:04

I was confused. Ready for review.


---

Comment by klee created at 2022-06-09 07:35:04

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-06-09 09:10:13

Thank you for doing the refactoring. I think this is better and reflects the mathematics.

Yes, that was a typo; I was also thinking of the morphism to the quotient module too.

From the patchbot, you have some doctest failures:

```
sage -t --long --random-seed=[snip] src/sage/manifolds/chart.py  # 1 doctest failed
sage -t --long --random-seed=[snip] src/sage/rings/padics/padic_generic_element.pyx  # 8 doctests failed
```


I am not sure I like the generic class called `FreeModule_base` as it suggests that it is a free module. Perhaps `ModuleWithAmbientFreeModule` (or `Module_with_free_ambient`)?

Do we also want that class to have a `rank()` method? I feel like that should belong only to the free module subclasses.


---

Comment by klee created at 2022-06-09 10:16:07

Replying to [comment:43 tscrim]:
> I am not sure I like the generic class called `FreeModule_base` as it suggests that it is a free module. Perhaps `ModuleWithAmbientFreeModule` (or `Module_with_free_ambient`)?

Just `Module_free_ambient`?

> Do we also want that class to have a `rank()` method? I feel like that should belong only to the free module subclasses.

Okay. That is not necessary.


---

Comment by git created at 2022-06-09 12:21:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-09 12:23:54

I used uniformly `Module_free_ambient`, `Submodule_free_ambient`, `QuotientModule_free_ambient`.


---

Comment by tscrim created at 2022-06-13 05:26:15

Thank you. Those are good names.

The patchbot Pyflakes is raising two issues. The second indicates one of the code paths does not have a doctest. This isn't strictly necessary, but if you know of a quick one to add, please do so.

I think I am otherwise happy with this ticket (modulo some nitpicks regarding the mass formatting changes in this branch; I don't really like the extra blanklines between bulletpoint items, much less making a de facto standard through an unrelated ticket).


---

Comment by klee created at 2022-06-13 09:47:17

Replying to [comment:47 tscrim]:
> Thank you. Those are good names.
> 
> The patchbot Pyflakes is raising two issues. The second indicates one of the code paths does not have a doctest. This isn't strictly necessary, but if you know of a quick one to add, please do so.

By "the second", you mean `'sage.misc.cachefunc.cached_method' imported but unused`? This is really an unused import. I removed it.

> ... modulo some nitpicks regarding the mass formatting changes in this branch; 

Sorry about those many tiny changes (and not so tiny reformatting of the modules documentation), not strictly related with this ticket. Hopefully they are all for better readability of source files (and the documentation).

> I don't really like the extra blanklines between bulletpoint items, much less making a de facto standard through an unrelated ticket).

I see. I guess you mean specifically the extra blankline in the `AUTHORS` section. I removed it.

I did think the blanklines in `AUTHORS` section is standard. But as I now checked source files, they are not uniform in this matter. I do think there should be a standard though. But this ticket is not a place for the discussion.


---

Comment by git created at 2022-06-13 09:48:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-14 05:09:28

Replying to [comment:48 klee]:
> Replying to [comment:47 tscrim]:
> > Thank you. Those are good names.
> > 
> > The patchbot Pyflakes is raising two issues. The second indicates one of the code paths does not have a doctest. This isn't strictly necessary, but if you know of a quick one to add, please do so.
> 
> By "the second", you mean `'sage.misc.cachefunc.cached_method' imported but unused`? This is really an unused import. I removed it.

Sorry, I had transposed the two when I wrote my comment. It was the `FreeModule_base` that no longer existed with your refactoring and that code path in the quotient module comparison code.

> > ... modulo some nitpicks regarding the mass formatting changes in this branch; 
> 
> Sorry about those many tiny changes (and not so tiny reformatting of the modules documentation), not strictly related with this ticket. Hopefully they are all for better readability of source files (and the documentation).

I am not sure how much I agree, and there are a number of conventions being chosen. The first/title line capitalization and some of the other formatting things are another example of things I don't think we have standardized or discussed as a community. It is not so good that we don't have consistency in the doc. As a disclaimer, part of my agitation about this comes from the fact that these changes are not what I think it should be, which means you can just ignore my ranting about it.

> > I don't really like the extra blanklines between bulletpoint items, much less making a de facto standard through an unrelated ticket).
> 
> I see. I guess you mean specifically the extra blankline in the `AUTHORS` section. I removed it.

Not just that but more broadly throughout the Sage documentation. However, we have not set any standard about this AFAIK.

> I did think the blanklines in `AUTHORS` section is standard. But as I now checked source files, they are not uniform in this matter. I do think there should be a standard though. But this ticket is not a place for the discussion.  

I remember the Sage dev guide not having this in its example before. Anyways, this is not the place to be deciding standards.


---

Comment by klee created at 2022-06-14 06:06:27

Replying to [comment:51 tscrim]:
> ... The first/title line capitalization and some of the other formatting things are another example of things I don't think we have standardized or discussed as a community. It is not so good that we don't have consistency in the doc. 

At some point, I wished consistency in the formatting of the first line in the header of source files, as different formats used by different authors really made the tables of contents of our html documentation look ugly. So in some ticket, I put the "standard" header format into the developer manual: 

https://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files

But as far as I remember this was not openly discussed in the sage-devel. If you think the format suggested in the developer manual is not "right" in some way (like the blanklines in the `AUTHOR` section), please open a discussion there. It would be good that we have a standard that most developers agree.


---

Comment by tscrim created at 2022-06-14 07:29:27

Indeed, I should do that so we can set a standard.

Onto some more technical parts of the review:

- Why not have `Module_free_ambient` use the richcmp? I feel like the comparison method makes sense in the non-free case.
- You should add doctests for the `__init__` method you added. Ideally, it should be both, but one of them is just moved and not necessary.
- Some doc formatting:
  {{{#!diff
-    - ``sparse`` -- bool (default: False)
+    - ``sparse`` -- boolean (default: ``False``)
 
     - ``coordinate_ring`` -- a ring containing ``base_ring``
       (default: equal to ``base_ring``)
 
-    - ``category`` -- category (default: None)
+    - ``category`` -- category (default: ``None``)
  }}}


---

Comment by klee created at 2022-06-14 08:06:30

Replying to [comment:53 tscrim]:

> - Why not have `Module_free_ambient` use the richcmp? I feel like the comparison method makes sense in the non-free case.

The `__richcmp__` method of `FreeModule_generic` is sophisticated (depends on the rank notion and echelon form). So for `Module_free_ambient`, I should make up a new comparison method. Submodules and quotients are also subclasses of `Module_free_ambient`. For these modules, it is not possible even to check containment just using generators. I cannot imagine an easy comparison method that makes sense for all these modules.


---

Comment by klee created at 2022-06-14 08:17:57

Replying to [comment:54 klee]:
> For these modules, it is not possible even to check containment just using generators. 

This is possible if the base ring is a multivariate polynomial ring, using Groebner bases. For general rings, I think there is no meaningful equality check (for submodules).


---

Comment by git created at 2022-06-14 08:40:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-14 08:45:20

Replying to [comment:53 tscrim]:
> - You should add doctests for the `__init__` method you added. 

Done.

> Ideally, it should be both, but one of them is just moved and not necessary.

I don't understand...

> - Some doc formatting: ...

Done. There are many of these. I tried to fix as many as I can spot. Hence more tiny changes :)


---

Comment by tscrim created at 2022-06-14 08:57:18

Replying to [comment:57 klee]:
> Replying to [comment:53 tscrim]:
> > - You should add doctests for the `__init__` method you added. 
> 
> Done.

Thank you.

> > Ideally, it should be both, but one of them is just moved and not necessary.
> 
> I don't understand...

There was another `__init__()` method that you moved from the refactoring that doesn't have any doctests. Anyways, since it was already like that, you don't need to do anything.

> > - Some doc formatting: ...
> 
> Done. There are many of these. I tried to fix as many as I can spot. Hence more tiny changes :)

Thanks. However, these are directly affected docstrings by the refactoring. `:)`


---

Comment by tscrim created at 2022-06-14 09:07:06

Replying to [comment:54 klee]:
> Replying to [comment:53 tscrim]:
> 
> > - Why not have `Module_free_ambient` use the richcmp? I feel like the comparison method makes sense in the non-free case.
> 
> The `__richcmp__` method of `FreeModule_generic` is sophisticated (depends on the rank notion and echelon form). So for `Module_free_ambient`, I should make up a new comparison method. Submodules and quotients are also subclasses of `Module_free_ambient`. For these modules, it is not possible even to check containment just using generators. I cannot imagine an easy comparison method that makes sense for all these modules.

It doesn't have to work correctly in all cases (although the fact we don't have an `Unknown` return type possible makes a `False` slightly annoying). Although the generic `__richcmp__()` that redirects to other methods would still lift up, then the `_eq()` and `is_submodule()` could do some simple checks and otherwise return a `NotImplemented`. For this ticket, it doesn't have to be anything sophisticated. I could possibly do this tomorrow.


---

Comment by git created at 2022-06-15 04:12:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-16 00:20:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-20 07:04:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-20 07:17:48

Replying to [comment:59 tscrim]:
> It doesn't have to work correctly in all cases (although the fact we don't have an `Unknown` return type possible makes a `False` slightly annoying).

I don't know if we have an agreement. I guess I would prefer to have either `NotImplemented` exception or only `True` or `False` return values...

> Although the generic `__richcmp__()` that redirects to other methods would still lift up, then the `_eq()` and `is_submodule()` could do some simple checks and otherwise return a `NotImplemented`. For this ticket, it doesn't have to be anything sophisticated.

I think those could be implemented in subclasses of `Module_free_ambient`, in future. 
 
> I could possibly do this tomorrow.

Would you?


---

Comment by tscrim created at 2022-06-21 04:27:59

Here is a version that makes some feeble attempt at comparisons for general modules. With the first commit, all (short) tests pass in the modules folder. I haven't really tested this to see what it is capable of or if there are any bugs (I have been trying to figure out the issue below).

----

In the second comment, I tried to use inheritance to try and streamline the code and reduce bloat. However, I get one error (and two errors that follow from this):

```
sage -t --warn-long 41.3 --random-seed=225430021128322878573582192201316989060 fp_graded/morphism.py
**********************************************************************
File "fp_graded/morphism.py", line 1331, in sage.modules.fp_graded.morphism.FPModuleMorphism.homology
Failed example:
    ho = f.homology(g)
Exception raised:
    Traceback (most recent call last):
      File "/home/travis/sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modules.fp_graded.morphism.FPModuleMorphism.homology[7]>", line 1, in <module>
        ho = f.homology(g)
      File "/home/travis/sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/modules/fp_graded/morphism.py", line 1341, in homology
        raise ValueError('the image of the given homomorphism is not contained '
    ValueError: the image of the given homomorphism is not contained in the kernel of this homomorphism; the homology is therefore not defined for this pair of maps
```

`@`jhpalmieri I have cc-ed you to see if you have an idea about what could be causing this. I am stuck as the output of the different quotient modules seems to be the same. I don't know how that is working well enough to be able to debug it further.

If we have no idea what is causing this, we can simply revert the last commit.
----
New commits:


---

Comment by klee created at 2022-06-21 05:05:57


```sage
sage: P.<x,y> = QQ[]
sage: M = P**2
sage: S1 = M.submodule([(x,y),(y,x)])
sage: S2 = M.submodule([(x,y),(y-x,x-y)])
sage: S1 == S2
False
```



---

Comment by tscrim created at 2022-06-21 05:22:00

That is because I didn't remove the `is_submodule()`. Although removing that causes some other issues to fix... I should be able to do something quick about it.


---

Comment by klee created at 2022-06-21 05:24:00

Replying to [comment:66 tscrim]:
> That is because I didn't remove the `is_submodule()`. Although removing that causes some other issues to fix... I should be able to do something quick about it.

Then would we get correct result (`True`)?


---

Comment by klee created at 2022-06-21 05:25:38

If we do not assume that the base ring is a field or at least PID, we don't have much to do in comparing `Module_free_ambient` modules. I think an attempt to provide `__richcmp__` that works both for `Module_free_ambient` and `FreeModule_generic` would easily fail. 

A subclass of `Module_free_ambient` can work with more specific `Module_free_ambient` modules, like submodules, quotient modules, or subquotient modules (not yet implemented) of free ambient modules. These subclasses could implement `__richcmp__` using Groebner bases on firm mathematical ground.


---

Comment by klee created at 2022-06-21 05:33:01

Replying to [comment:68 klee]:
> A subclass of `Module_free_ambient` can work with more specific `Module_free_ambient` modules, like submodules, quotient modules, or subquotient modules (not yet implemented) of free ambient modules. These subclasses could implement `__richcmp__` using Groebner bases on firm mathematical ground.   

Only when the base ring is a multivariate polynomial ring. For a general ring, I have no idea...


---

Comment by tscrim created at 2022-06-21 05:41:28

What we should get is also `S1 != S2` returning `False`. Again, this is an issue because we don't have an `Unknown` return option. We can check a number of simple cases. Stop thinking that not implementing this means that comparison doesn't work; it just completely compares by identity.


---

Comment by tscrim created at 2022-06-21 06:00:44

Sorry, that was a snappy of a response. What I was trying to express is that we can do some things that are somewhat trivial but we can still do. Partially correct answers are better than nothing IMO. It isn't hard to make this work. I am just bug-fixing right now trying to expand what it can do with quotient modules. I might just give up on that though.


---

Comment by tscrim created at 2022-06-21 06:05:16

One wrinkle in the current implementation is the ambient module of a quotient module:

```
sage: k.<a> = GF(9); A = k^3; V = A.span_of_basis([[1,0,a], [a,a,1]]); W = V.span([V.1])
sage: Q = V/W
sage: Q.ambient_module() is Q
True
```


Ah, this might be my bug in comment:64: it has a mismatch with the ambient spaces being created.


---

Comment by klee created at 2022-06-21 06:06:54

Replying to [comment:71 tscrim]:
> What I was trying to express is that we can do some things that are somewhat trivial but we can still do. Partially correct answers are better than nothing IMO. 

We may have a separate `__richcmp__` for `Module_free_ambient`, that does the simple cases. As you say, there are obvious cases that can answer `True` or `False`. In other cases, we may raise an exception.


---

Comment by tscrim created at 2022-06-21 06:07:49

Raising exceptions during equality checks is really dangerous. The key example is a `dict` that has a hash collision.


---

Comment by klee created at 2022-06-21 06:33:55

Replying to [comment:74 tscrim]:
> Raising exceptions during equality checks is really dangerous. 

Then I wonder what is the convention in sage for this situation that we can answer correctly for simple cases, but not (or take too much time to get answer) for most other cases. Do we just return `None`? Perhaps there was a discussion in sage-devel before...


---

Comment by git created at 2022-06-21 07:05:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-21 07:12:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-21 07:14:44

Unfortunately `__eq__` cannot return anything other than `True` or `False`.

So I have hacked around some issues: In particular, submodules of a quotient module and the free module should not be comparable. So I have a `defining_module()` attribute so there is no confusion with `ambient_module()`. It leads to some fairly ugly code, but it was the easiest thing to do without further doing major overhauls. I also moved up the `submodule()` and `span()` code as they work in more generality. The code is telling me that it should just override `ambient_module()`. However, then the ambient module for quotients will need some care, and likely the comparison code too. What are your thoughts about this?

The only thing left is to file those doctest failures in `fp_graded/morphism.py`. The issue is not the ambient space it seems. I have no idea whatsoever. `:/`


---

Comment by klee created at 2022-06-21 07:49:21

Replying to [comment:78 tscrim]:
> So I have hacked around some issues: In particular, submodules of a quotient module and the free module should not be comparable. So I have a `defining_module()` attribute so there is no confusion with `ambient_module()`. It leads to some fairly ugly code, but it was the easiest thing to do without further doing major overhauls. I also moved up the `submodule()` and `span()` code as they work in more generality. The code is telling me that it should just override `ambient_module()`. However, then the ambient module for quotients will need some care, and likely the comparison code too. What are your thoughts about this?

I cannot answer yet. You made lots of changes. With these changes (over my code), what do we achieve? Would you give some examples here? Some comparisons worked (correct or not. for instance, the above `S1` and `S2`) before your changes. What have changed?

> The only thing left is to file those doctest failures in `fp_graded/morphism.py`. The issue is not the ambient space it seems. I have no idea whatsoever. `:/`

It seems that comparison of submodules is broken...


---

Comment by tscrim created at 2022-06-21 08:13:07

Replying to [comment:79 klee]:
> Replying to [comment:78 tscrim]:
> > So I have hacked around some issues: In particular, submodules of a quotient module and the free module should not be comparable. So I have a `defining_module()` attribute so there is no confusion with `ambient_module()`. It leads to some fairly ugly code, but it was the easiest thing to do without further doing major overhauls. I also moved up the `submodule()` and `span()` code as they work in more generality. The code is telling me that it should just override `ambient_module()`. However, then the ambient module for quotients will need some care, and likely the comparison code too. What are your thoughts about this?
> 
> I cannot answer yet. You made lots of changes. With these changes (over my code), what do we achieve? Would you give some examples here? Some comparisons worked (correct or not. for instance, the above `S1` and `S2`) before your changes. What have changed?

- Degree 1 submodules now compare correctly:
  {{{
sage: S.<x,y,z> = PolynomialRing(QQ)
sage: M = S**1
sage: N2 = M.submodule([M([x^2]), M([y^2])])
sage: N1 = M.submodule([M([x]), M([y])])
sage: N2.is_submodule(N1)
True
sage: N2 < N1
True
sage: N1 < N2
False
  }}}
- Zero submodules now also compare correctly too.
- Things are also prepared to implement more specialized comparisons, such as modules over polynomial rings (although some minor refactoring might be needed to avoid code duplication).
- The `is_submodule()` is used for comparisons.
- I don't understand your comment about `S1` and `S2`. That returns `False` with your branch for me.

I believe we can push the comparison code a bit further by rejecting the modules that do not have containment with extension of scalars over the fraction field.

> > The only thing left is to file those doctest failures in `fp_graded/morphism.py`. The issue is not the ambient space it seems. I have no idea whatsoever. `:/`
> 
> It seems that comparison of submodules is broken... 

I don't think you can conclude that from the above, nor do I think that is the problem. I do not get this failure when only changing the comparison code. It only happens when I make the free quotient a subclass of the generic quotient. To me, this seems to be a very subtle behavior change in the quotient module, but I cannot see what actually changes.


---

Comment by klee created at 2022-06-21 08:20:54

Replying to [comment:80 tscrim]:
> - I don't understand your comment about `S1` and `S2`. That returns `False` with your branch for me.

I meant that :)

> > It seems that comparison of submodules is broken... 
> 
> I don't think you can conclude that from the above, nor do I think that is the problem. I do not get this failure when only changing the comparison code. It only happens when I make the free quotient a subclass of the generic quotient. 

I see.


---

Comment by tscrim created at 2022-06-21 09:15:27

Replying to [comment:81 klee]:
> Replying to [comment:80 tscrim]:
> > - I don't understand your comment about `S1` and `S2`. That returns `False` with your branch for me.
> 
> I meant that :)

Ah, now `S1 != S2` also returns `False`.

> > > It seems that comparison of submodules is broken... 
> > 
> > I don't think you can conclude that from the above, nor do I think that is the problem. I do not get this failure when only changing the comparison code. It only happens when I make the free quotient a subclass of the generic quotient. 
> 
> I see.

It somehow seems to be loosing one additional coercion check:

```
checking _coerce_map_from_ Vector space of dimension 1 over Finite Field of size 2
self: Vector space quotient V/W of dimension 1 over Finite Field of size 2 where
V: Vector space of dimension 2 over Finite Field of size 2
W: Vector space of degree 2 and dimension 1 over Finite Field of size 2
Basis matrix:
[1 0]
```

I see that this is missing against `develop` by adding a `print()` inside the quotient's `_coerce_map_from_`. (I even checked with using the same constructor as the `develop` version and making sure the `super()` calls are correct too.) The MRO only differs in the added classes marked with a `#`:

```
sage: A = QQ^5; V = A.span_of_basis([[1,0,-1,1,1], [1,-1,0,2/3,3/4]]); W = V.span_of_basis([V.0 - 2/3*V.1]); Q = V / W
sage: Q.__class__.__mro__
(<class 'sage.modules.quotient_module.FreeModule_ambient_field_quotient_with_category'>,
 <class 'sage.modules.quotient_module.FreeModule_ambient_field_quotient'>,
 <class 'sage.modules.free_module.FreeModule_ambient_field'>,
 <class 'sage.modules.free_module.FreeModule_generic_field'>,
 <class 'sage.modules.free_module.FreeModule_ambient_pid'>,
 <class 'sage.modules.free_module.FreeModule_generic_pid'>,
 <class 'sage.modules.free_module.FreeModule_ambient_domain'>,
 <class 'sage.modules.free_module.FreeModule_generic_domain'>,  #
 <class 'sage.modules.free_module.FreeModule_ambient'>,
 <class 'sage.modules.free_module.FreeModule_generic'>,
 <class 'sage.modules.quotient_module.QuotientModule_free_ambient'>,  #
 <class 'sage.modules.free_module.Module_free_ambient'>,  #
```


I am out of ideas for this today.


---

Comment by git created at 2022-06-22 00:04:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-22 00:08:13

I just reverted the change since doctests pass. We can spend time improving this later if we need to. I am still not very happy about the `defining_module()` hack, but that can be revisited if this isn't robust enough. If you want to rework things here and now, we can, but we then need a little more robust of a plan on how to structure things and think about it from a higher level.


---

Comment by klee created at 2022-06-22 03:55:15

Replying to [comment:84 tscrim]:
> I just reverted the change since doctests pass. We can spend time improving this later if we need to. I am still not very happy about the `defining_module()` hack, but that can be revisited if this isn't robust enough. 

You added `defining_module()` as a public method. What is the "defining module" of a submodule from a user's perspective? It should be something different from `ambient_module()`.

You added `submodule()` of `QuotientModule_free_ambient`. It should return a submodule of a quotient module, but it returns an instance of `Submodule_free_ambient`. For submodules of a quotient module, we should have a new class `Subquotient_free_ambient` (as in Macaulay2), but this is not yet implemented. 

> If you want to rework things here and now, we can, but we then need a little more robust of a plan on how to structure things and think about it from a higher level.

Frankly I want to revert back to my last commit, as `__richcmp__` for `Module_free_ambient` is not a prerequisite but a missing feature. It would be great to have `__richcmp__` method but as you say, we should think more from a higher level to avoid introducing inadequate hacks. We may open a new ticket for `__richcmp__`.


---

Comment by tscrim created at 2022-06-22 04:50:15

Replying to [comment:85 klee]:
> Replying to [comment:84 tscrim]:
> > I just reverted the change since doctests pass. We can spend time improving this later if we need to. I am still not very happy about the `defining_module()` hack, but that can be revisited if this isn't robust enough. 
> 
> You added `defining_module()` as a public method. What is the "defining module" of a submodule from a user's perspective? It should be something different from `ambient_module()`.

I don't want the zero submodule of a quotient to compare equal to the zero submodule of the `cover()` free module. I am thinking actually of implementing an `ambient_free_module()` and using that do the linear algebra, which will be different than `ambient_module()`, which would be what is currently the `defining_module()`.

> You added `submodule()` of `QuotientModule_free_ambient`. It should return a submodule of a quotient module, but it returns an instance of `Submodule_free_ambient`. For submodules of a quotient module, we should have a new class `Subquotient_free_ambient` (as in Macaulay2), but this is not yet implemented. 

If we implement a subquotient, then that would be another way out of the above issue of submodule comparisons. Do we really want a separate class for submodules of free modules and submodules of (general) quotient modules? This would further split the generic modules and free modules implementations.

> > If you want to rework things here and now, we can, but we then need a little more robust of a plan on how to structure things and think about it from a higher level.
> 
> Frankly I want to revert back to my last commit, as `__richcmp__` for `Module_free_ambient` is not a prerequisite but a missing feature. It would be great to have `__richcmp__` method but as you say, we should think more from a higher level to avoid introducing inadequate hacks. We may open a new ticket for `__richcmp__`.

Why? The "hack" I am referring to has to do with submodule definitions that is independent of `__richcmp__`. I can remove the submodules of quotient modules and still have the comparison (which  I would argue should be there to protect against mathematically wrong answers, see `S1 != S2`). That is a natural thing to want to construct, and it is not something that should require that much more work.


---

Comment by klee created at 2022-06-22 05:30:10

Replying to [comment:86 tscrim]:
> > You added `defining_module()` as a public method. What is the "defining module" of a submodule from a user's perspective? It should be something different from `ambient_module()`.
> 
> I don't want the zero submodule of a quotient to compare equal to the zero submodule of the `cover()` free module. I am thinking actually of implementing an `ambient_free_module()` and using that do the linear algebra, which will be different than `ambient_module()`, which would be what is currently the `defining_module()`.

It seems we think different things for `Submodule_free_ambient`, and `Quotient_free_ambient`. 

`Submodule_free_ambient` is the class of **submodules of an ambient free module**. `S1` and `S2` here:

```
sage: P.<x,y> = QQ[]
sage: F = P**2
sage: F
Ambient free module of rank 2 over the integral domain Multivariate Polynomial Ring in x, y over Rational Field
sage: S1 = F.submodule([(x,y),(y,x)])
sage: S2 = F.submodule([(x,y)])
```

A submodule is the row space of a matrix over the base ring. In this sense, a submodule is defined by a matrix.

`Quotient_free_ambient` is the class of **quotient of an ambient free module by a submodule of the ambient free module**. `Q1` and `Q2` here:

```
sage: Q1 = F.quotient(S1)
sage: Q2 = F.quotient(S2)
```


Now if we do (hypothetically as we do not have subquotients yet),

```
sage: SQ = Q2.submodule(S1)
```

Then `SQ` is a subquotient. Mathematically it is S1/S2. Hence it is defined by **two matrices**.

So subquotients (submodules of quotients) need a separate class, perhaps `Subquotient_free_ambient`.

Under these definitions, what do you mean by `defining_module()` of a submodule? To me,  `ambient_module`, `ambient_free_module`, `defining_module` refer to the same thing!


---

Comment by tscrim created at 2022-06-22 05:38:49

Replying to [comment:87 klee]:
> It seems we think different things for `Submodule_free_ambient`, and `Quotient_free_ambient`. 

Actually, I wasn't quite sure how we wanted to model things. Thank you for clarifying it. My past thought was to mimic fully the free module implementation: that submodules don't care if their ambient module is a quotient module or not. (So I was treating `Submodule_free_ambient` as just not having the correct name for what it was suppose to model.) However, the quotient of a free module by a free module is again a free module (at least when working over a field). Yet, as you explained, subquotients have different structure in general and the programming model (i.e., class hierarchy) should be different. Thus, I will instead implement a subquotients class and remove the `defining_module()` and rework things to match the math.


---

Comment by klee created at 2022-06-22 05:54:18

Replying to [comment:86 tscrim]:
> > Frankly I want to revert back to my last commit, as `__richcmp__` for `Module_free_ambient` is not a prerequisite but a missing feature. It would be great to have `__richcmp__` method but as you say, we should think more from a higher level to avoid introducing inadequate hacks. We may open a new ticket for `__richcmp__`.
> 
> Why? The "hack" I am referring to has to do with submodule definitions that is independent of `__richcmp__`. I can remove the submodules of quotient modules and still have the comparison 

Without your `defining_module()` and `submodule()` of quotients, does your `__richcmp__` meaningfully work with no doctest failures? I thought you introduced them to make `__richcmp__` work with no doctest failures. That is why I called them "inadequate hacks" (no intention to be personal).

As we can now fully appreciate, it would be much more work to implement `__richcmp__` for `Module_free_ambient` that work well with submodules, quotient modules (and subquotients). The aim of this ticket is just to introduce the frames for submodules and quotients (which I need for another ticket). So, I would ask again, how about opening a new ticket for the next work and limit the scope of this ticket?


---

Comment by tscrim created at 2022-06-22 06:15:37

Replying to [comment:89 klee]:
> Replying to [comment:86 tscrim]:
> > > Frankly I want to revert back to my last commit, as `__richcmp__` for `Module_free_ambient` is not a prerequisite but a missing feature. It would be great to have `__richcmp__` method but as you say, we should think more from a higher level to avoid introducing inadequate hacks. We may open a new ticket for `__richcmp__`.
> > 
> > Why? The "hack" I am referring to has to do with submodule definitions that is independent of `__richcmp__`. I can remove the submodules of quotient modules and still have the comparison 
> 
> Without your `defining_module()` and `submodule()` of quotients, does your `__richcmp__` meaningfully work with no doctest failures? I thought you introduced them to make `__richcmp__` work with no doctest failures. That is why I called them "inadequate hacks"

The types of the classes themselves now will actually do the job that the `defining_module()` was meant for. It will prevent, e.g., zero modules that have no business being compared from actually being compared...well, returning anything other than `False`.

> (no intention to be personal).

I didn't take it to be. `:)`

> As we can now fully appreciate, it would be much more work to implement `__richcmp__` for `Module_free_ambient` that work well with submodules, quotient modules (and subquotients). The aim of this ticket is just to introduce the frames for submodules and quotients (which I need for another ticket). So, I would ask again, how about opening a new ticket for the next work and limit the scope of this ticket?

I think it is important to at least get some of the most trivial comparisons implemented. I believe your code would have only compared thing by identity, which means that we could not even compare if two zero module are equal.

I might not be able to do the quick fixes today due to other commitments, but I will do it tomorrow morning at the latest.


---

Comment by git created at 2022-06-23 08:07:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-23 08:19:12

Okay, it took me a little longer than expected due to other commitments, and I had to think a lot about the overall class structure when adding in subquotients and check that I don't need to be as careful about `ambient_module()` as I previously thought. I believe I have arrived at something that reduces duplication but still has all of the comparison features I want.

The main idea is that every subobject should think of itself as a subquotient. In particular, it should have a `relations()`. The telling line is actually in the documentation of `Module_free_ambient`: it only expects that its _elements_ are represented by vectors in a free module, not that its `ambient_module()` itself is a free module. By thinking about how a subquotients should be implemented, I realized that I would just be lifting all of the methods up to a base class (say, `Module_generic`) and that `ModuleSubquotient` would be the same as `Submodule_free_ambient`. So I simply remaned `Submodule_free_ambient` to `Subquotient_free_ambient`.

Now it is easy to implement a quotient of a quotient: We just need to lift everything up to the ambient free module and stack the matrices. I am going to implement this really quick next. Once that is done, I want to see if I can remove some code duplication. That is the last thing I would want in this ticket.

A wish-list item would be a slightly better echelon form for matrices that at least checked if `a | b` when trying to reduce the matrix. This would help in some more trivial cases...


---

Comment by git created at 2022-06-23 09:51:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-23 09:55:25

Now we can take quotients of quotients, which keeps track of how it was created, as well as the defining matrices of generators and relations for future use in doing homological algebra (a la Macaulay2).

I also was able to remove redundant `span()` and `submodule()` by a new attribute that tells which class defines the submodules and by adding one call to `ambient_module()` when the base ring changes (which will very slightly slow down that code when ``self`` already is an ambient module, but this should be negligible).

I am now happy with the current capabilities of the code. It should be fairly future-proof. There might be some trivial failures around due to changing the error messages.


---

Comment by klee created at 2022-06-23 10:06:03

I just looked over. Yes, it looks nice. I will check in detail later.


---

Comment by tscrim created at 2022-06-23 11:31:01

Thank you. Hopefully a patchbot will test this overnight too.


---

Comment by git created at 2022-06-24 07:53:35

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-06-24 07:57:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-24 08:08:47

I am also happy overall with the new design.

I did minor edits. I renamed `Subquotient_free_module` back to `Submodule_free_quotient` as subquotients are also submodules of the ambient module, which is a quotient module in this case. This name also matches with the filename. I reverted back the `domain` argument of `QuotientModule_free_ambient` to `module` as domain may be misunderstood as integral domain.


---

Comment by klee created at 2022-06-24 08:18:54

Ah, I removed the degree 1 case in `is_submodule` test. It is trivial case and the test is wrong. Your test would give false for `M.is_submodule(N)` with N=(3,5), M=(2)` over `ZZ`.


---

Comment by tscrim created at 2022-06-24 08:37:18

Replying to [comment:101 klee]:
> Ah, I removed the degree 1 case in `is_submodule` test. It is trivial case and the test is wrong. Your test would give false for `M.is_submodule(N)` with `N=(3,5), M=(2)` over `ZZ`.

Right, it is not an if-and-only-if due to linear combinations... This really should have been checking for general cases if we can scale the generators by checking the divisibility of the leading coefficients and only return `True` if that was the case. Anyways, it isn't so important for now.


---

Comment by tscrim created at 2022-06-24 08:39:50

Replying to [comment:100 klee]:
> I am also happy overall with the new design.

Thank you for dealing with me as I worked on it.

> I did minor edits. I renamed `Subquotient_free_module` back to `Submodule_free_quotient` as subquotients are also submodules of the ambient module, which is a quotient module in this case. This name also matches with the filename.

These are good.

> I reverted back the `domain` argument of `QuotientModule_free_ambient` to `module` as domain may be misunderstood as integral domain. 

I am 99% okay with this. I just have a very slight reservation that it doesn't make the free module version. Yet, it is not public facing and the classes are currently separate (although IMO they should not be), so this is okay with me.

If everything else is good, then I think we can set a positive review once a patchbot takes a look at it.


---

Comment by git created at 2022-06-26 10:24:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-27 01:02:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-27 01:03:39

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-06-27 01:14:16

Replying to [comment:103 tscrim]:
> Replying to [comment:100 klee]:
> > I am also happy overall with the new design.
> 
> Thank you for dealing with me as I worked on it.

This ticket achieved much more than I first envisioned. It laid a groundwork to elevate Sage as an alternative platform for commutative algebra computations.


---

Comment by tscrim created at 2022-06-27 02:19:00

Thank you for the changes. There is still work that can be done; in particular things for modules over polynomial rings (possibly using, e.g., `singular` to do the computations). However, that is all good for followup tickets.


---

Comment by vbraun created at 2022-06-28 22:28:32

Merge failure on top of:

8f2fe518a7 Trac #33708: make elliptic-curve isogenies compute Montgomery codomains

86ddb48e2f Trac #33144: Remove some py2 tags in explain_pickle

30ecff9f6d Trac #34085: fix some details in braid groups

3755f58519 Trac #34082: Add an option up_to_isomorphism for is_subgraph

92c75af48c Trac #34080: pycodestyle cleanup in src/sage/graphs/digraph.py

ca49485d88 Trac #34062: enhance our conversion system

1da48e72af Trac #34052: tweaking the giac / libgiac interface

21a14a9dce Trac #34049: fix wrong use of Path inside libgap.Read

d73e3d7af7 Trac #34045: OpenSSL 3.0.4 security update

b617c66a07 Trac #34040: fix W605 in all pyx files inside matrix/

ca041b6034 Trac #34039: fix pycodestyle E306 in categories and part of combinat

2c9b6f0230 Trac #34029: bug in elliptic curve saturation: update to eclib bugfix release 20220621 required.

b2b107f016 Trac #34006: Fix the Killing form and generators for a Lie subalgebra

963b374cb1 Trac #33995: make *test*: Log to a common log file test.log

e3ceba0a60 Trac #33928: phitigra error with hold_canvas

b5d0423a3f Trac #33866: Make jupyter_packaging standard; add hatchling, editables, pathspec, poetry_core, tomlkit, deprecation; update tomli, flit_core, setuptools, pip, wheel

dd6e379e27 Trac #33821: Remove use of SAGE_LIB in sage.misc

2bd081ee38 Trac #33409: Size of docker images has increased in 9.5

1f77ce0ac9 Trac #33295: Refactor sage_conf

3b0dc53967 Trac #33029: Feature and doctest tag for runtime cython

226f4353c3 Trac #29779: pkgconf: Update to 1.8.0, remove runtime dep on environment variable SAGE_LOCAL

548795354e Trac #29549: bootstrap: Clean up use of gettextize

c02edcb15b Trac #25374: Upgrade cryptominisat to 5.8.0, fix build on Cygwin

e22b33a0c1 Trac #34017: Fix tox-docker builds after #29941

c4236d0844 Trac #34008: pycodestyle cleanup in sage.graphs.generic_graph_pyx.pyx

6f961ffa38 Trac #34007: Allow start parameter in Python's sum

c59c86cfbd Trac #33996: ascii_art fail in jupyter notebook

c40983afcd Trac #33991: remove some unused imports

b02c408763 Trac #33978: various details about typing in combinat

6fb1e3f13a Trac #34037: Make doctest from #25626 more robust

4169d7d6c0 Trac #34035: Add __reversed__ method to FrozenBitsets

45c963e0c7 Trac #34030: move supercommutator to superalgebras

d4706f96f9 Trac #34019: minor code details in combinat

3d336f0435 Trac #34014: Clean src/sage/graphs/pq_trees.py

c9aa34b34c Trac #33957: Manifold.options.omit_function_arguments ineffective for arguments not in alphabetic order

0b2741d399 Trac #33619: clean up ell_curve_isogeny.py

c0e59251e2 Trac #34036: fix the linter

2b36879ae1 Trac #34025: Fix doctest in sage/modular/overconvergent/hecke_series.py

c0abe3f5ee Trac #33213: Replace SAGE_TMP by the system location in the sage library

7ab174a70d Trac #32340: document behavior of .is_prime() for number fields

c69f4af336 Trac #28263: Degree for Affine Morphism or Affine Dynamical System

e516392523 Trac #34001: Add flag to avoid OrePolynomialRing cast to PolynomialRing

01b8bcb85f Trac #33993: pep cleanup for words/morphism.py

716c5ce262 Trac #33992: remove class inheritance of object in remaining places

de375bce02 Trac #33990: Subset_s _an_element_

0593e83957 Trac #33987: modernize super() in structure, symbolic, doctest, databases

d9a45e29eb Trac #33985: modernize super() in monoids,modules,modular

7ed404657b Trac #33984: modernize super() in schemes,libs,sets,quivers

1df260e842 Trac #33979: .roots() does not always return elements of the base ring

c6c2b85405 Trac #33974: Documentation addition for symmetric functions - Cauchy identity

f92916e358 Trac #33840: bool(matrix) ignores exceptions raised while comparing entries

f8df80820d Updated [SageMath](SageMath) version to 9.7.beta3



merge was not clean: conflicts in src/sage/modules/free_module.py


---

Comment by vbraun created at 2022-06-28 22:28:32

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-06-29 00:07:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-06-29 00:08:20

Only a trivial conflict with #33985, but I also merged in #34040 just to make sure there was not a conflict there.


---

Comment by tscrim created at 2022-06-29 00:08:20

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-07-09 22:31:08

Resolution: fixed
