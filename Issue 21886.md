# Issue 21886: Update Three.js template

archive/issues_021886.json:
```json
{
    "body": "CC:  @novoselt\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22123\n\n",
    "created_at": "2017-01-03T01:52:25Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Update Three.js template",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21886",
    "user": "@paulmasson"
}
```
CC:  @novoselt



Issue created by migration from https://trac.sagemath.org/ticket/22123





---

archive/issue_comments_303822.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-01-03T01:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303822",
    "user": "@paulmasson"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_303823.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graphics.",
    "created_at": "2017-01-03T01:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303823",
    "user": "@paulmasson"
}
```

Changing component from PLEASE CHANGE to graphics.



---

archive/issue_comments_303824.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-01-07T20:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303824",
    "user": "@paulmasson"
}
```

New commits:



---

archive/issue_comments_303825.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-07T20:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303825",
    "user": "@paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_303826.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-07T22:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303826",
    "user": "@paulmasson"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_303827.json:
```json
{
    "body": "So - what else needs work for these issues?\n\nRegarding embedding this template as iframe - perhaps it would be better to have a visible border of the plot, given that it changes mouse behaviour? Nothing drastic, thin gray line would suffice.",
    "created_at": "2017-01-08T18:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303827",
    "user": "@novoselt"
}
```

So - what else needs work for these issues?

Regarding embedding this template as iframe - perhaps it would be better to have a visible border of the plot, given that it changes mouse behaviour? Nothing drastic, thin gray line would suffice.



---

archive/issue_comments_303828.json:
```json
{
    "body": "Replying to [comment:5 novoselt]:\n> So - what else needs work for these issues?\nNothing for the issues already identified, but there is an outstanding transparency issue that I just figured out how to fix yesterday. I changed the status of the ticket so that no one would need to review it twice. The solution to this third issue is a bit involved and I want to clean up the code before pushing it here.\n> Regarding embedding this template as iframe - perhaps it would be better to have a visible border of the plot, given that it changes mouse behaviour? Nothing drastic, thin gray line would suffice.\nThe embedding is controlled [server side](https://github.com/sagemath/sagecell/blob/develop/backend_cell.py#L133) so you can make that change any time. This ticket will only touch JavaScript.",
    "created_at": "2017-01-08T21:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303828",
    "user": "@paulmasson"
}
```

Replying to [comment:5 novoselt]:
> So - what else needs work for these issues?
Nothing for the issues already identified, but there is an outstanding transparency issue that I just figured out how to fix yesterday. I changed the status of the ticket so that no one would need to review it twice. The solution to this third issue is a bit involved and I want to clean up the code before pushing it here.
> Regarding embedding this template as iframe - perhaps it would be better to have a visible border of the plot, given that it changes mouse behaviour? Nothing drastic, thin gray line would suffice.
The embedding is controlled [server side](https://github.com/sagemath/sagecell/blob/develop/backend_cell.py#L133) so you can make that change any time. This ticket will only touch JavaScript.



---

archive/issue_comments_303829.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-01-10T01:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303829",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_303830.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-01-10T01:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303830",
    "user": "@paulmasson"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_303831.json:
```json
{
    "body": "For future reference, the rendering of transparent objects in Three.js is controlled by the position of the mesh. Two objects with the exact same center will render in the order in which they are added to the scene, so that one will always occlude the other. This will be a problem with intersecting planes and Jmol will always be more adept at handling this. One workaround will be to split planes into two parts along the line of intersection and add them to the scene as separate objects.",
    "created_at": "2017-01-10T01:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303831",
    "user": "@paulmasson"
}
```

For future reference, the rendering of transparent objects in Three.js is controlled by the position of the mesh. Two objects with the exact same center will render in the order in which they are added to the scene, so that one will always occlude the other. This will be a problem with intersecting planes and Jmol will always be more adept at handling this. One workaround will be to split planes into two parts along the line of intersection and add them to the scene as separate objects.



---

archive/issue_comments_303832.json:
```json
{
    "body": "How could one implement it in a sensible way? Compute intersections of all sub-pieces on adding plots?\n\nPerhaps it would make more sense to subdivide all planes into smaller pieces, or at least have some option for this?",
    "created_at": "2017-01-10T06:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303832",
    "user": "@novoselt"
}
```

How could one implement it in a sensible way? Compute intersections of all sub-pieces on adding plots?

Perhaps it would make more sense to subdivide all planes into smaller pieces, or at least have some option for this?



---

archive/issue_comments_303833.json:
```json
{
    "body": "My comment was meant as an advisory to the end user and I can add something like it to the documentation for this viewer if desired. I should have been clearer since there are really two issues:\n\n1) Compact objects need to have different positions for transparency to render properly.\n\n2) Intersecting extended objects will have transparency issues even with different positions. It will be most immediately noticeable for planes but will exist for other objects, such as cylinders. This is an issue with WebGL in general, not just Three.js.\n\nBy the time the objects get to Three.js they're just vertices and faces, so the splitting would have to happen in Python, at least in `implicit_plot3d` and `parametric_plot3d`. Again, this is only for transparent objects as seen from certain angles, so I think we should wait and see how much of a problem it is for end users before making any complicated changes.\n\nIn any case, that's beyond the scope of this ticket.",
    "created_at": "2017-01-11T01:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303833",
    "user": "@paulmasson"
}
```

My comment was meant as an advisory to the end user and I can add something like it to the documentation for this viewer if desired. I should have been clearer since there are really two issues:

1) Compact objects need to have different positions for transparency to render properly.

2) Intersecting extended objects will have transparency issues even with different positions. It will be most immediately noticeable for planes but will exist for other objects, such as cylinders. This is an issue with WebGL in general, not just Three.js.

By the time the objects get to Three.js they're just vertices and faces, so the splitting would have to happen in Python, at least in `implicit_plot3d` and `parametric_plot3d`. Again, this is only for transparent objects as seen from certain angles, so I think we should wait and see how much of a problem it is for end users before making any complicated changes.

In any case, that's beyond the scope of this ticket.



---

archive/issue_comments_303834.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-15T01:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303834",
    "user": "@novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_303835.json:
```json
{
    "body": "OK, it does improve the transparency situation! Can you please clarify multiplication by -1?\n\nContinuing overall discussion - do I understand correctly that say several nested cylinders with the same parameters except for radius will not be drawn correctly ever??? And WebGL has no interest in fixing this situation? If so, what can be a sensible automatic workaround? Break all complicated objects into something like 1000 little triangles so that they almost never will intersect and when they do, defects will be small? Or we just hope that such situations are rare? Even a simple cube looks strange with opacity - as you rotate it it is obvious that facets are different! And they aren't exactly intersecting each other, just touching.",
    "created_at": "2017-01-15T01:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303835",
    "user": "@novoselt"
}
```

OK, it does improve the transparency situation! Can you please clarify multiplication by -1?

Continuing overall discussion - do I understand correctly that say several nested cylinders with the same parameters except for radius will not be drawn correctly ever??? And WebGL has no interest in fixing this situation? If so, what can be a sensible automatic workaround? Break all complicated objects into something like 1000 little triangles so that they almost never will intersect and when they do, defects will be small? Or we just hope that such situations are rare? Even a simple cube looks strange with opacity - as you rotate it it is obvious that facets are different! And they aren't exactly intersecting each other, just touching.



---

archive/issue_comments_303836.json:
```json
{
    "body": "Replying to [comment:12 novoselt]:\n> OK, it does improve the transparency situation! Can you please clarify multiplication by -1?\nThe method `center()` returns the vector used to center vertices in their own frame of reference, so moving the entire object needs to happen in the opposite direction.\n> Continuing overall discussion - do I understand correctly that say several nested cylinders with the same parameters except for radius will not be drawn correctly ever???\nNo, but the process will be difficult to automate. The is an additional parameter named `renderOrder` that can be manually attached to objects to help in these sorts of situations. It would be easy enough to add the feature but would take some explaining for people to understand why it might help.\n> And WebGL has no interest in fixing this situation?\nPart of the reason to use Three.js is avoid having to learn too much about WebGL, but I guess now I'm committed to getting more details. I do know that the depth buffer that tracks object position does not respect transparency and that's the source of the problem. Here's an [example](http://sagecell.sagemath.org/?z=eJyNzrEKwyAUheG90HdwU9ubQiwZ77MUSW6IxaCoSdSnbxw6Frr9y-E7uw6CZ1ZY5fJ68T1DZlZvzWjSy1uXnpOoiKpTtwwiQ6dASRDlG7XFIMF5fS4KPgbYDR0UkKclEL0jhznolXDWNhLoTBFT2Khh6gf2NzU6604p0NTOx8Udwvd3r-QH0vM_uQ==&lang=sage) that I think encapsulates that: rotate the planes vertically and you see how the transparency of each half shifts based on which one's center is closest to the front of the scene.\n\nI don't yet know more details of the implementation, but I assume a choice had to be made to get 3D rendering to work at all in the browser, where resources are more limited than with a Java desktop environment. That might change as browsers gain calculational power. \n> If so, what can be a sensible automatic workaround? Break all complicated objects into something like 1000 little triangles so that they almost never will intersect and when they do, defects will be small?\nThat is possible, but would probably crash the browser. I can try testing it for possible future use. We should also look at how Jmol passes objects to JavaScript, even though it doesn't use WebGL.\n> Or we just hope that such situations are rare?\nI think waiting for some feedback from users would be appropriate.  My interest till now has been with opaque objects and WebGL is great for that. Let's see how important opacity is in practice.\n> Even a simple cube looks strange with opacity - as you rotate it it is obvious that facets are different! And they aren't exactly intersecting each other, just touching.\nThis is partly a result of the existing lighting. In order to get things started I just put lights above and below the frame, but we can change the default lighting. The current `threejs` implementation has lights from six directions IIRC: does it look better to you for a single cube?",
    "created_at": "2017-01-16T01:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303836",
    "user": "@paulmasson"
}
```

Replying to [comment:12 novoselt]:
> OK, it does improve the transparency situation! Can you please clarify multiplication by -1?
The method `center()` returns the vector used to center vertices in their own frame of reference, so moving the entire object needs to happen in the opposite direction.
> Continuing overall discussion - do I understand correctly that say several nested cylinders with the same parameters except for radius will not be drawn correctly ever???
No, but the process will be difficult to automate. The is an additional parameter named `renderOrder` that can be manually attached to objects to help in these sorts of situations. It would be easy enough to add the feature but would take some explaining for people to understand why it might help.
> And WebGL has no interest in fixing this situation?
Part of the reason to use Three.js is avoid having to learn too much about WebGL, but I guess now I'm committed to getting more details. I do know that the depth buffer that tracks object position does not respect transparency and that's the source of the problem. Here's an [example](http://sagecell.sagemath.org/?z=eJyNzrEKwyAUheG90HdwU9ubQiwZ77MUSW6IxaCoSdSnbxw6Frr9y-E7uw6CZ1ZY5fJ68T1DZlZvzWjSy1uXnpOoiKpTtwwiQ6dASRDlG7XFIMF5fS4KPgbYDR0UkKclEL0jhznolXDWNhLoTBFT2Khh6gf2NzU6604p0NTOx8Udwvd3r-QH0vM_uQ==&lang=sage) that I think encapsulates that: rotate the planes vertically and you see how the transparency of each half shifts based on which one's center is closest to the front of the scene.

I don't yet know more details of the implementation, but I assume a choice had to be made to get 3D rendering to work at all in the browser, where resources are more limited than with a Java desktop environment. That might change as browsers gain calculational power. 
> If so, what can be a sensible automatic workaround? Break all complicated objects into something like 1000 little triangles so that they almost never will intersect and when they do, defects will be small?
That is possible, but would probably crash the browser. I can try testing it for possible future use. We should also look at how Jmol passes objects to JavaScript, even though it doesn't use WebGL.
> Or we just hope that such situations are rare?
I think waiting for some feedback from users would be appropriate.  My interest till now has been with opaque objects and WebGL is great for that. Let's see how important opacity is in practice.
> Even a simple cube looks strange with opacity - as you rotate it it is obvious that facets are different! And they aren't exactly intersecting each other, just touching.
This is partly a result of the existing lighting. In order to get things started I just put lights above and below the frame, but we can change the default lighting. The current `threejs` implementation has lights from six directions IIRC: does it look better to you for a single cube?



---

archive/issue_comments_303837.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-01-21T16:34:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303837",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_303838.json:
```json
{
    "body": "Replying to [comment:13 paulmasson]:\n> Replying to [comment:12 novoselt]:\n> > And WebGL has no interest in fixing this situation?\n> Part of the reason to use Three.js is avoid having to learn too much about WebGL, but I guess now I'm committed to getting more details. I do know that the depth buffer that tracks object position does not respect transparency and that's the source of the problem. Here's an [example](http://sagecell.sagemath.org/?z=eJyNzrEKwyAUheG90HdwU9ubQiwZ77MUSW6IxaCoSdSnbxw6Frr9y-E7uw6CZ1ZY5fJ68T1DZlZvzWjSy1uXnpOoiKpTtwwiQ6dASRDlG7XFIMF5fS4KPgbYDR0UkKclEL0jhznolXDWNhLoTBFT2Khh6gf2NzU6604p0NTOx8Udwvd3r-QH0vM_uQ==&lang=sage) that I think encapsulates that: rotate the planes vertically and you see how the transparency of each half shifts based on which one's center is closest to the front of the scene.\n\nGreat example!\n \n> > If so, what can be a sensible automatic workaround? Break all complicated objects into something like 1000 little triangles so that they almost never will intersect and when they do, defects will be small?\n> That is possible, but would probably crash the browser. I can try testing it for possible future use. We should also look at how Jmol passes objects to JavaScript, even though it doesn't use WebGL.\n\nNote that [Jmol actually has some WebGL implementation](http://wiki.jmol.org/index.php/Jmol_JavaScript_Object/WebGL) as well, maybe they have a workaround/solution - it is experimental and I never looked at it myself.\n> > Even a simple cube looks strange with opacity - as you rotate it it is obvious that facets are different! And they aren't exactly intersecting each other, just touching.\n> This is partly a result of the existing lighting. In order to get things started I just put lights above and below the frame, but we can change the default lighting. The current `threejs` implementation has lights from six directions IIRC: does it look better to you for a single cube?\n\nThat was a complaint about transparency. Lighting-wise I think it would be nice to have different lights from different directions, not the same flood from everywhere. Try to rotate [these spheres](http://sagecell.sagemath.org/?z=eJwrULBVKC7ISC1K1UgrSsxNtXVLzClO1eTlKskoSk3NKtYoALIL9Ioz8ss1yjJTy1OLbJWgUkqYMlm5-TkgYQDkZRw4&lang=sage). For the old one the only reason you can notice rotation is that it is not a sphere, it has some corners. Your variant clearly shows where are top and bottom, but not left-right. I find it confusing and even with less contrived examples the lighting is kind of \"flat\". Now I noticed that jmol's version also has visible rotation only due to defects of the surface, but it is the most pleasing one, IMHO. And a big difference seems to be that jmol rotates everything keeping (a single?) light fixed, while threejs rotates objects together with lights. Is it possible to have fixed lights in threejs? That's is ideal for our applications, I think - you kind of have an object under a desk lamp, and rotate it to see different sides.",
    "created_at": "2017-01-22T18:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303838",
    "user": "@novoselt"
}
```

Replying to [comment:13 paulmasson]:
> Replying to [comment:12 novoselt]:
> > And WebGL has no interest in fixing this situation?
> Part of the reason to use Three.js is avoid having to learn too much about WebGL, but I guess now I'm committed to getting more details. I do know that the depth buffer that tracks object position does not respect transparency and that's the source of the problem. Here's an [example](http://sagecell.sagemath.org/?z=eJyNzrEKwyAUheG90HdwU9ubQiwZ77MUSW6IxaCoSdSnbxw6Frr9y-E7uw6CZ1ZY5fJ68T1DZlZvzWjSy1uXnpOoiKpTtwwiQ6dASRDlG7XFIMF5fS4KPgbYDR0UkKclEL0jhznolXDWNhLoTBFT2Khh6gf2NzU6604p0NTOx8Udwvd3r-QH0vM_uQ==&lang=sage) that I think encapsulates that: rotate the planes vertically and you see how the transparency of each half shifts based on which one's center is closest to the front of the scene.

Great example!
 
> > If so, what can be a sensible automatic workaround? Break all complicated objects into something like 1000 little triangles so that they almost never will intersect and when they do, defects will be small?
> That is possible, but would probably crash the browser. I can try testing it for possible future use. We should also look at how Jmol passes objects to JavaScript, even though it doesn't use WebGL.

Note that [Jmol actually has some WebGL implementation](http://wiki.jmol.org/index.php/Jmol_JavaScript_Object/WebGL) as well, maybe they have a workaround/solution - it is experimental and I never looked at it myself.
> > Even a simple cube looks strange with opacity - as you rotate it it is obvious that facets are different! And they aren't exactly intersecting each other, just touching.
> This is partly a result of the existing lighting. In order to get things started I just put lights above and below the frame, but we can change the default lighting. The current `threejs` implementation has lights from six directions IIRC: does it look better to you for a single cube?

That was a complaint about transparency. Lighting-wise I think it would be nice to have different lights from different directions, not the same flood from everywhere. Try to rotate [these spheres](http://sagecell.sagemath.org/?z=eJwrULBVKC7ISC1K1UgrSsxNtXVLzClO1eTlKskoSk3NKtYoALIL9Ioz8ss1yjJTy1OLbJWgUkqYMlm5-TkgYQDkZRw4&lang=sage). For the old one the only reason you can notice rotation is that it is not a sphere, it has some corners. Your variant clearly shows where are top and bottom, but not left-right. I find it confusing and even with less contrived examples the lighting is kind of "flat". Now I noticed that jmol's version also has visible rotation only due to defects of the surface, but it is the most pleasing one, IMHO. And a big difference seems to be that jmol rotates everything keeping (a single?) light fixed, while threejs rotates objects together with lights. Is it possible to have fixed lights in threejs? That's is ideal for our applications, I think - you kind of have an object under a desk lamp, and rotate it to see different sides.



---

archive/issue_comments_303839.json:
```json
{
    "body": "Moving lighting discussion to #22261",
    "created_at": "2017-01-26T00:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21886",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21886#issuecomment-303839",
    "user": "@paulmasson"
}
```

Moving lighting discussion to #22261
