# Issue 28973: scipy.optimize.newton does not accept Sage input anymore

archive/issues_028973.json:
```json
{
    "body": "CC:  @mkoeppe @dimpase\n\nAs reported in [this sage-support thread](https://groups.google.com/forum/#!topic/sage-support/-zGb2Egxl-A), the `scipy.optimize.newton` became more picky about input and broke an interact.\n\nThe problem is reproducible below with sage-9.1.beta4\n\n```\nsage: f(t) = t**2 + 1/2\nsage: df(t) = 2*t\nsage: import scipy.optimize\nsage: scipy.optimize.newton(f, 0.3, df, maxiter=10)\nTraceback (most recent call last)\n<ipython-input-1-3a75ef95af3d> in <module>()\n      2 __tmp__=var(\"t\"); df = symbolic_expression(Integer(2)*t).function(t)\n      3 import scipy.optimize\n----> 4 scipy.optimize.newton(f, RealNumber('0.3'), df, maxiter=Integer(10))\n\n/opt/sage/local/lib/python3.7/site-packages/scipy/optimize/zeros.py in newton(func, x0, fprime, args, tol, maxiter, fprime2, x1, rtol, full_output, disp)\n    297                     newton_step /= 1.0 - adj\n    298             p = p0 - newton_step\n--> 299             if np.isclose(p, p0, rtol=rtol, atol=tol):\n    300                 return _results_select(\n    301                     full_output, (p, funcalls, itr + 1, _ECONVERGED))\n\n/opt/sage/local/lib/python3.7/site-packages/numpy/core/numeric.py in isclose(a, b, rtol, atol, equal_nan)\n   2519     y = array(y, dtype=dt, copy=False, subok=True)\n   2520 \n-> 2521     xfin = isfinite(x)\n   2522     yfin = isfinite(y)\n   2523     if all(xfin) and all(yfin):\n\nTypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29210\n\n",
    "created_at": "2020-02-16T22:10:46Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "scipy.optimize.newton does not accept Sage input anymore",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28973",
    "user": "https://github.com/videlec"
}
```
CC:  @mkoeppe @dimpase

As reported in [this sage-support thread](https://groups.google.com/forum/#!topic/sage-support/-zGb2Egxl-A), the `scipy.optimize.newton` became more picky about input and broke an interact.

The problem is reproducible below with sage-9.1.beta4

```
sage: f(t) = t**2 + 1/2
sage: df(t) = 2*t
sage: import scipy.optimize
sage: scipy.optimize.newton(f, 0.3, df, maxiter=10)
Traceback (most recent call last)
<ipython-input-1-3a75ef95af3d> in <module>()
      2 __tmp__=var("t"); df = symbolic_expression(Integer(2)*t).function(t)
      3 import scipy.optimize
----> 4 scipy.optimize.newton(f, RealNumber('0.3'), df, maxiter=Integer(10))

/opt/sage/local/lib/python3.7/site-packages/scipy/optimize/zeros.py in newton(func, x0, fprime, args, tol, maxiter, fprime2, x1, rtol, full_output, disp)
    297                     newton_step /= 1.0 - adj
    298             p = p0 - newton_step
--> 299             if np.isclose(p, p0, rtol=rtol, atol=tol):
    300                 return _results_select(
    301                     full_output, (p, funcalls, itr + 1, _ECONVERGED))

/opt/sage/local/lib/python3.7/site-packages/numpy/core/numeric.py in isclose(a, b, rtol, atol, equal_nan)
   2519     y = array(y, dtype=dt, copy=False, subok=True)
   2520 
-> 2521     xfin = isfinite(x)
   2522     yfin = isfinite(y)
   2523     if all(xfin) and all(yfin):

TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
```


Issue created by migration from https://trac.sagemath.org/ticket/29210





---

archive/issue_comments_409653.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28973#issuecomment-409653",
    "user": "https://github.com/mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_409654.json:
```json
{
    "body": "Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28973#issuecomment-409654",
    "user": "https://github.com/mkoeppe"
}
```

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_comments_409655.json:
```json
{
    "body": "I think here we have run into the changes to numpy's casting rules. Many functions now default to `casting='safe'`.\n\n```\nsage: sage: f(t) = t**2 - 1/2\nsage: y = f(0.3r)\nsage: type(y)\n<class 'sage.symbolic.expression.Expression'>\nsage: np.array([y]).astype('float', casting='safe')\nTypeError: Cannot cast array data from dtype('O') to dtype('float64') according to the rule 'safe'\nsage: np.array([y]).astype('float', casting='unsafe')\narray([-0.41])\n```\n",
    "created_at": "2022-11-28T20:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28973#issuecomment-409655",
    "user": "https://github.com/mkoeppe"
}
```

I think here we have run into the changes to numpy's casting rules. Many functions now default to `casting='safe'`.

```
sage: sage: f(t) = t**2 - 1/2
sage: y = f(0.3r)
sage: type(y)
<class 'sage.symbolic.expression.Expression'>
sage: np.array([y]).astype('float', casting='safe')
TypeError: Cannot cast array data from dtype('O') to dtype('float64') according to the rule 'safe'
sage: np.array([y]).astype('float', casting='unsafe')
array([-0.41])
```




---

archive/issue_comments_409656.json:
```json
{
    "body": "I guess the problem will be solved if we introduce `ConstantExpression` palatable to numpy as commented in #34693.",
    "created_at": "2022-11-29T21:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28973#issuecomment-409656",
    "user": "https://github.com/kwankyu"
}
```

I guess the problem will be solved if we introduce `ConstantExpression` palatable to numpy as commented in #34693.
