# Issue 17887: hasse_diagram and have_dot2tex problems without dot2tex

Issue created by migration from Trac.

Original creator: novoselt

Original creation time: 2015-04-04 00:19:58

CC:  sage-combinat aschilling nthiery ncohen leif bsalisbury1 tscrim

On a system without dot2tex installed:

```
sage: P = posets.PentagonPoset()
An exception has occurred, use %tb to see the full traceback.

SystemExit: 1

To exit: use 'exit', 'quit', or Ctrl-D.
```

I believe the problem is coming from this:

```
sage: from sage.graphs.dot2tex_utils import have_dot2tex
sage: have_dot2tex()
An exception has occurred, use %tb to see the full traceback.

SystemExit: 1

To exit: use 'exit', 'quit', or Ctrl-D.
```

which is obviously wrong and extremely confusing to users - surely poset creation is independent of TeX!


---

Comment by novoselt created at 2015-04-04 00:27:47

And it looks like the optional package dot2tex IS installed, but there is no dot2tex itself.


---

Comment by novoselt created at 2015-04-04 00:51:18

Looking further, I assume dot2tex package actually installs dot2tex and it is just not present on the system. I am confused by versions:

```
sc_serv`@`sctest:~$ sage/sage -i|grep dot2tex
dot2tex-20120520
sc_serv`@`sctest:~$ sage/sage -sh -c "dot2tex --version"
Dot2tex version 2.9.0dev
```

while http://sagemath.org/packages/optional/ lists dot2tex-2.8.7.p2.spkg

The system in question is SageMathCell:
http://sagecell.sagemath.org/?z=eJxTVS3O4OUqTkxPVdDNrEkvSi1QSMkvMSpJreDlgjIUdHXLUouKM_PzAEdZDwg=&lang=sage


---

Comment by leif created at 2015-04-05 12:23:17

Replying to [comment:2 novoselt]:
> Looking further, I assume dot2tex package actually installs dot2tex and it is just not present on the system. I am confused by versions:
> {{{
> sc_serv`@`sctest:~$ sage/sage -i|grep dot2tex
> dot2tex-20120520
> sc_serv`@`sctest:~$ sage/sage -sh -c "dot2tex --version"
> Dot2tex version 2.9.0dev
> }}}
> while http://sagemath.org/packages/optional/ lists dot2tex-2.8.7.p2.spkg

That's "new-style spkg" weirdness:

The old one (2.8.7.p2) is a real spkg, and listed on `.../packages/optional/`.

The new one (2.9.0dev) has its package metadata only shipped with newer versions of Sage (part of the "unified" git tree, such that you cannot install it on older Sage versions); its corresponding upstream tarball is available as [http://sagemath.org/packages/upstream/dot2tex/dot2tex-20120520.tar.bz2](http://sagemath.org/packages/upstream/dot2tex/dot2tex-20120520.tar.bz2).

----

Did you try to reinstall it with `sage -f dot2tex`?  (Note that at least GraphViz is a prerequisite of it.)


---

Comment by leif created at 2015-04-05 12:33:19

Replying to [comment:3 leif]:
> Did you try to reinstall it with `sage -f dot2tex`?  (Note that at least GraphViz is a prerequisite of it.)

... which means you should better try `sage -f -c dot2tex`.


---

Comment by tscrim created at 2015-04-05 17:13:51

You might be interested in #17171.


---

Comment by novoselt created at 2015-04-07 18:14:18

Replying to [comment:4 leif]:
> ... which means you should better try `sage -f -c dot2tex`.

Tons of errors, GraphViz is not installed. The issue, however, is that I am not trying to make any pictures! Changes that I think have to be done (either one will suffice, but both are better):
 1. Check that things work properly, i.e. don't crash if they don't work.
 1. Check that prerequisites are installed during installation of dot2tex and fail if they are not available.

I does not look like #17171 addresses the first point, not sure about the second one.


---

Comment by leif created at 2015-04-07 19:39:33

Replying to [comment:6 novoselt]:
> Replying to [comment:4 leif]:
> > ... which means you should better try `sage -f -c dot2tex`.
> 
> Tons of errors, GraphViz is not installed.

Yes.  I could reproduce the errors you reported on a previously TeX-free system, but only after installing dot2tex (without `-c`, otherwise the installation would have failed).

Installing GraphViz alone didn't help; after installing a couple of additional (La)TeX-related packages the errors in Sage finally vanished, while the number of failures in dot2tex's test suite only decreased.




> The issue, however, is that I am not trying to make any pictures!

Yep, that's odd, although you must have installed dot2tex at some point... ;-)  (So the ticket's title is somewhat misleading.)




> Changes that I think have to be done (either one will suffice, but both are better):
>  1. Check that things work properly, i.e. don't crash if they don't work.

Agreed, a non-working dot2tex installation shouldn't affect rather unrelated things, especially since you cannot (easily) uninstall dot2tex.




>  2. Check that prerequisites are installed during installation of dot2tex and fail if they are not available.

Yep, some minimal prerequisite check should probably be performed in its `spkg-install`.  (Test suite failures don't necessarily mean dot2tex would be completely unusable, and we normally don't want to run a test suite unless the user explicitly asked for doing so.)




> I does not look like #17171 addresses the first point, not sure about the second one.

Well, not yet, still needs review...


---

Comment by leif created at 2015-04-07 19:51:50

Replying to [comment:7 leif]:
> Installing GraphViz alone didn't help; after installing a couple of additional (La)TeX-related packages the errors in Sage finally vanished, while the number of failures in dot2tex's test suite only decreased.

P.S.:  From dot2tex's `SPKG.txt`:


```
## Dependencies

graphviz (www.graphviz.org) should be installed and in the path (for
example via the graphviz spkg).

preview, a LaTeX package for extracting parts of a document.
```


Necessary, but presumably not sufficient (at least to make 2.9.0dev's test suite pass), but perhaps the packages I installed are also too old.


---

Comment by novoselt created at 2015-04-07 20:09:06

Agreed about the title - my understanding of the issue improved as I was writing the description ;-)

Listing dependencies is not enough - the point of packaging systems is to take care of them automatically. I've installed dot2tex because it is installed in the cloud and in general the goal is to provide as many useful packages as possible through SageMathCell. So I will install GraphViz on the next update, but the issues here still have to be fixed: the code in `have_dot2tex` obviously tries to catch all exceptions, but it is not sufficient.


---

Comment by jdemeyer created at 2015-05-31 12:31:06

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-05-31 12:31:06

New commits:


---

Comment by ncohen created at 2015-06-01 08:20:57

Changing status from needs_review to positive_review.


---

Comment by git created at 2015-06-01 08:21:31

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2015-06-01 08:21:31

Changing status from positive_review to needs_review.


---

Comment by ncohen created at 2015-06-01 08:22:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-02 20:18:17

Resolution: fixed
