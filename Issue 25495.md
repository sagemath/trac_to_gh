# Issue 25495: sdh_install fails when destination exists

Issue created by migration from https://trac.sagemath.org/ticket/25732

Original creator: jdemeyer

Original creation time: 2018-07-01 16:53:55

CC:  embray

Install `pkgconf` and then reinstall without uninstalling it:

```
$ make pkgconf && rm local/var/lib/sage/installed/pkgconf* && make pkgconf
[pkgconf-0.9.7.p0] No record that 'pkgconf' was ever installed; skipping uninstall
[pkgconf-0.9.7.p0] Copying package files from temporary location /home/jdemeyer/sage-test/local/var/tmp/sage/build/pkgconf-0.9.7.p0/inst to /home/jdemeyer/sage-test/loc
al
[pkgconf-0.9.7.p0] Running post-install script for pkgconf-0.9.7.p0.
[pkgconf-0.9.7.p0] ********************************************************************************
[pkgconf-0.9.7.p0] Error: destination /home/jdemeyer/sage-test/local/bin/pkg-config for
[pkgconf-0.9.7.p0] sdh_install exists and is not a directory
[pkgconf-0.9.7.p0] ********************************************************************************
[pkgconf-0.9.7.p0] 
[pkgconf-0.9.7.p0] real 0m0.044s
[pkgconf-0.9.7.p0] user 0m0.012s
[pkgconf-0.9.7.p0] sys  0m0.000s
[pkgconf-0.9.7.p0] ************************************************************************
[pkgconf-0.9.7.p0] Error running the postinst script for pkgconf-0.9.7.p0.
[pkgconf-0.9.7.p0] ************************************************************************
```



---

Comment by embray created at 2018-07-09 09:05:04

So...don't do that?  The proper way to "clean" a previous package installation is to run `make clean-pkgconf`.  Just deleting the stamp file doesn't mean the previous installation is removed.


---

Comment by jdemeyer created at 2018-07-09 12:01:19

Replying to [comment:1 embray]:
> So...don't do that?

So what if

(1) the wrong data is written to `local/var/lib/sage/installed/pkgconf` due to a bug?

(2) the uninstaller didn't work due to a bug?

(3) something crashed and the filesystem state is no longer consistent with `local/var/lib/sage/installed/pkgconf`

As shown on #25731, (1) has happened already and (3) is certainly possible.


---

Comment by embray created at 2018-07-10 11:51:30

I do think maybe `sdh_install` should be more forgiving.  Originally, I made it error when trying to overwrite an existing file since under normal circumstances that would be a problem (e.g. multiple packages trying to write the same file).  But perhaps just a warning would suffice.


---

Comment by embray created at 2018-07-10 11:56:06

There does appear to be a bug here, although not exactly as you described it.  After [this commit](https://git.sagemath.org/sage.git/commit/?id=4827be7be92b434f0f72cf4cef8902a6a1d20a35) there should have been a bump in patch version of the pkgconf spkg.  Without that, the `spkg-postrm` script is not being installed.

How to handle a bug in the packaging system in general?  You know there's no one right answer to that.  If the system is in an inconsistent state that it may require some untangling.  The problem with Sage's software "distribution" is that it's historically never really had a well-defined consistent state in the first place.


---

Comment by embray created at 2018-07-10 12:06:01

I think there are (at least) two valid issues here:

1. `sdh_install` should allow overwriting an existing file when the `-T` flag is used (consistent with GNU install).  The error we're getting here only make sense when trying to install files into a file into a path that is not a directory.

2. The patch level on the pkgconf spkg should be bumped (I'll fix that in another ticket).


---

Comment by embray created at 2018-07-10 12:07:44

Changing status from new to needs_review.


---

Comment by embray created at 2018-07-10 12:07:44

New commits:


---

Comment by vbraun created at 2018-07-12 21:56:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-13 18:25:50

Resolution: fixed
