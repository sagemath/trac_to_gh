# Issue 26375: Remove bad mathjax symlink and bad mathjax directories

Issue created by migration from https://trac.sagemath.org/ticket/26612

Original creator: jhpalmieri

Original creation time: 2018-10-31 18:58:09

The problem reported in #26152 has returned, it seems. As a result, users may end up with a symlink `SAGE_SHARE/mathjax/mathjax` pointing to its parent directory, and this ends up producing a directory `SAGE_DOC/html/en/reference/_static/mathjax` which contains a subdirectory `mathjax` which also contains a subdirectory `mathjax`, etc., hence needlessly using gigabytes of disk space. Let's get rid of these problematic files.



---

Comment by jhpalmieri created at 2018-10-31 18:59:43

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-10-31 18:59:43

New commits:


---

Comment by jhpalmieri created at 2018-10-31 19:00:32

I still don't know what causes the symlink to be created, but let's delete it when we build the documentation.


---

Comment by jdemeyer created at 2018-11-02 10:55:54

I don't like this kind of code. We really should fix the underlying problem instead. Do you have a way to reproduce it?


---

Comment by jdemeyer created at 2018-11-02 10:55:54

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2018-11-02 16:18:18

I don't have a way to reproduce it. There are two issues, in my mind: first, yes, we want to fix the underlying issue, but that seems hard since we don't know what the issue is. Second, there may be people out there who are suffering from this problem and don't realize it and so are wasting huge amounts of disk space. Shouldn't we clean up that mess?


---

Comment by jhpalmieri created at 2018-11-04 05:04:52

I have one computer on which I can recreate the self-referential symlink by running `./sage -f sagenb`. I think the problem comes from this: sagenb is distributed with a full copy of mathjax in its data directory. The installation procedure is supposed to replace this copy with a symlink, and something goes wrong. Why is sagenb distributed with a copy of mathjax in the first place, since mathjax has been a separate Sage package for a while? Now I'm tempted to do this:

```diff
diff --git a/build/pkgs/sagenb/spkg-install b/build/pkgs/sagenb/spkg-install
index 57864ab0d9..639de1d23d 100644
--- a/build/pkgs/sagenb/spkg-install
+++ b/build/pkgs/sagenb/spkg-install
@@ -17,5 +17,6 @@ fi
 PYTHON_VERSION=$("$SAGE_LOCAL/bin/$PYTHON" -c 'import sys; print("%d.%d" % sys.version_info[:2])')
 cd "${SAGE_DESTDIR}${SAGE_LOCAL}/lib/python$PYTHON_VERSION/site-packages/sagenb/data" || \
     sdh_die "Cannot find SageNB data directory."
+rm -rf mathjax
 ln -s -n "$SAGE_SHARE/mathjax/" mathjax || \
     sdh_die "Error: Cannot symlink mathjax into the SageNB data directory."
```

along with a command at the start of sagenb's installation to remove the directory `sagenb/data/mathjax`, if it is not a symlink. Or maybe unconditionally. 

Or something along these lines.


---

Comment by jhpalmieri created at 2018-11-04 05:12:10

This doesn't explain things completely, of course: why can I reliably reproduce this on one computer and not another? On the computer where I can reproduce it, I first installed an older version of sagenb, removed the bad symlink, and then did an incremental update to the current `develop` branch. What remnants from the old build could be causing the symlink to get reproduced each time I do `./sage -f sagenb`?


---

Comment by jdemeyer created at 2018-11-05 11:57:00

Replying to [comment:6 jhpalmieri]:
> I have one computer on which I can recreate the self-referential symlink

To clarify: which self-referential symlink do you mean? You are talking about sagenb here, but #26152 was about `local/share/mathjax/mathjax`.


---

Comment by jdemeyer created at 2018-11-05 11:59:14

On the affected machine, can you post the output of

```
find local -name mathjax | xargs ls -ld
```



---

Comment by jdemeyer created at 2018-11-05 12:26:04

There is certainly something fishy here. On a clean install of sage:

```
$ find local -name mathjax |xargs ls -ld
drwxr-xr-x 7 jdemeyer jdemeyer 4096 Nov  5 13:22 local/lib/python2.7/site-packages/sagenb/data/mathjax
lrwxrwxrwx 1 jdemeyer jdemeyer   44 Nov  5 13:22 local/lib/python2.7/site-packages/sagenb/data/mathjax/mathjax -> /usr/local/src/sage-git/local/share/mathjax/
lrwxrwxrwx 1 jdemeyer jdemeyer   43 Nov  5 10:19 local/share/jupyter/nbextensions/mathjax -> /usr/local/src/sage-git/local/share/mathjax
drwxr-xr-x 7 jdemeyer jdemeyer 4096 Sep 27 07:21 local/share/mathjax
```


The `local/lib/python2.7/site-packages/sagenb/data/mathjax/mathjax` symlink looks wrong to me.


---

Comment by jdemeyer created at 2018-11-05 12:29:30

I'll create a patch based on what you said in [comment:6]


---

Comment by jdemeyer created at 2018-11-05 12:51:11

The actual problem is that something went wrong with the latest sagenb packaging: #26641.


---

Comment by jhpalmieri created at 2018-11-05 18:13:36

Replying to [comment:8 jdemeyer]:
> Replying to [comment:6 jhpalmieri]:
> > I have one computer on which I can recreate the self-referential symlink
> 
> To clarify: which self-referential symlink do you mean? You are talking about sagenb here, but #26152 was about `local/share/mathjax/mathjax`.

I mean the one `SAGE_LOCAL/share/mathjax/mathjax` that points to `SAGE_LOCAL/share/mathjax`.  Force-installing `sagenb` on that machine recreates this link.


---

Comment by jdemeyer created at 2018-11-05 18:30:12

Can you run `find local -name mathjax | xargs ls -ld` on that machine? And then check whether #26641 fixes the issue?


---

Comment by jhpalmieri created at 2018-11-05 18:42:50


```
$ find local -name mathjax | xargs ls -ld
lrwxr-xr-x   1 jpalmier  staff   64 Oct  3 09:58 local/lib/python2.7/site-packages/sagenb/data/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax/
lrwxr-xr-x   1 jpalmier  staff   63 Nov  3 11:45 local/share/jupyter/nbextensions/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax
drwxr-xr-x  14 jpalmier  staff  448 Nov  5 10:12 local/share/mathjax
lrwxr-xr-x   1 jpalmier  staff   64 Nov  5 10:12 local/share/mathjax/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax/
```



---

Comment by jhpalmieri created at 2018-11-05 20:53:04

Replying to [comment:14 jdemeyer]:
> Can you run `find local -name mathjax | xargs ls -ld` on that machine? And then check whether #26641 fixes the issue?

It fixes the issue in the sense that if I delete the bad symlink, then running `./sage -f sagenb` does not recreate it, whereas forcing installation of sagenb-1.1.0 does recreate it. You know the following already: it doesn't fix the issue in the sense that if the bad symlink is present, it is not deleted, and if the docs have been built with the bad symlink, therefore using up way too much disk space, that problem is not cleaned up.


---

Comment by embray created at 2018-11-08 15:40:29

#26612 looks good, so I think we can close this.


---

Comment by embray created at 2018-11-08 15:40:29

Resolution: duplicate


---

Comment by jhpalmieri created at 2018-11-08 16:15:10

Replying to [comment:17 embray]:
> #26612 looks good, so I think we can close this.

_This_ is #26612, so your comment is as self-referential as the symlink.

There is no fix in place which actually cleans up the bad symlink and the bad docbuild. Is that really acceptable?


---

Comment by jhpalmieri created at 2018-11-08 16:16:47

And should there be a doctest that detects whether the symlink is there, so we know quickly if this problem ever reoccurs?


---

Comment by embray created at 2018-11-08 16:44:36

Sorry, I meant #26641.


---

Comment by jdemeyer created at 2018-11-09 06:24:01

Changing status from closed to new.


---

Comment by jdemeyer created at 2018-11-09 06:24:01

Resolution changed from duplicate to 


---

Comment by jdemeyer created at 2018-11-09 06:24:01

I agree with John: #26641 is only a partial fix.


---

Comment by embray created at 2018-11-09 13:04:18

I'm not really sure what else you want to do here.  If someone feels like they're being affected by this they can do an `rm -rf local/share/doc/sage` and re-build.


---

Comment by jhpalmieri created at 2018-11-09 15:46:05

What about the people who are affected but don't realize it?

By the way, they also need to delete `local/share/mathjax/mathjax`. Should `make doc-clean` delete this link?


---

Comment by vbraun created at 2018-12-12 14:26:57

Changing priority from blocker to major.
