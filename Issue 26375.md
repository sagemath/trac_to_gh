# Issue 26375: Remove bad mathjax symlink and bad mathjax directories

archive/issues_026375.json:
```json
{
    "body": "The problem reported in #26152 has returned, it seems. As a result, users may end up with a symlink `SAGE_SHARE/mathjax/mathjax` pointing to its parent directory, and this ends up producing a directory `SAGE_DOC/html/en/reference/_static/mathjax` which contains a subdirectory `mathjax` which also contains a subdirectory `mathjax`, etc., hence needlessly using gigabytes of disk space. Let's get rid of these problematic files.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26612\n\n",
    "created_at": "2018-10-31T18:58:09Z",
    "labels": [
        "component: documentation",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Remove bad mathjax symlink and bad mathjax directories",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26375",
    "user": "https://github.com/jhpalmieri"
}
```
The problem reported in #26152 has returned, it seems. As a result, users may end up with a symlink `SAGE_SHARE/mathjax/mathjax` pointing to its parent directory, and this ends up producing a directory `SAGE_DOC/html/en/reference/_static/mathjax` which contains a subdirectory `mathjax` which also contains a subdirectory `mathjax`, etc., hence needlessly using gigabytes of disk space. Let's get rid of these problematic files.


Issue created by migration from https://trac.sagemath.org/ticket/26612





---

archive/issue_comments_370956.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-31T18:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370956",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370957.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-10-31T18:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370957",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_370958.json:
```json
{
    "body": "I still don't know what causes the symlink to be created, but let's delete it when we build the documentation.",
    "created_at": "2018-10-31T19:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370958",
    "user": "https://github.com/jhpalmieri"
}
```

I still don't know what causes the symlink to be created, but let's delete it when we build the documentation.



---

archive/issue_comments_370959.json:
```json
{
    "body": "I don't like this kind of code. We really should fix the underlying problem instead. Do you have a way to reproduce it?",
    "created_at": "2018-11-02T10:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370959",
    "user": "https://github.com/jdemeyer"
}
```

I don't like this kind of code. We really should fix the underlying problem instead. Do you have a way to reproduce it?



---

archive/issue_comments_370960.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-11-02T10:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370960",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_370961.json:
```json
{
    "body": "I don't have a way to reproduce it. There are two issues, in my mind: first, yes, we want to fix the underlying issue, but that seems hard since we don't know what the issue is. Second, there may be people out there who are suffering from this problem and don't realize it and so are wasting huge amounts of disk space. Shouldn't we clean up that mess?",
    "created_at": "2018-11-02T16:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370961",
    "user": "https://github.com/jhpalmieri"
}
```

I don't have a way to reproduce it. There are two issues, in my mind: first, yes, we want to fix the underlying issue, but that seems hard since we don't know what the issue is. Second, there may be people out there who are suffering from this problem and don't realize it and so are wasting huge amounts of disk space. Shouldn't we clean up that mess?



---

archive/issue_comments_370962.json:
```json
{
    "body": "I have one computer on which I can recreate the self-referential symlink by running `./sage -f sagenb`. I think the problem comes from this: sagenb is distributed with a full copy of mathjax in its data directory. The installation procedure is supposed to replace this copy with a symlink, and something goes wrong. Why is sagenb distributed with a copy of mathjax in the first place, since mathjax has been a separate Sage package for a while? Now I'm tempted to do this:\n\n```diff\ndiff --git a/build/pkgs/sagenb/spkg-install b/build/pkgs/sagenb/spkg-install\nindex 57864ab0d9..639de1d23d 100644\n--- a/build/pkgs/sagenb/spkg-install\n+++ b/build/pkgs/sagenb/spkg-install\n@@ -17,5 +17,6 @@ fi\n PYTHON_VERSION=$(\"$SAGE_LOCAL/bin/$PYTHON\" -c 'import sys; print(\"%d.%d\" % sys.version_info[:2])')\n cd \"${SAGE_DESTDIR}${SAGE_LOCAL}/lib/python$PYTHON_VERSION/site-packages/sagenb/data\" || \\\n     sdh_die \"Cannot find SageNB data directory.\"\n+rm -rf mathjax\n ln -s -n \"$SAGE_SHARE/mathjax/\" mathjax || \\\n     sdh_die \"Error: Cannot symlink mathjax into the SageNB data directory.\"\n```\n\nalong with a command at the start of sagenb's installation to remove the directory `sagenb/data/mathjax`, if it is not a symlink. Or maybe unconditionally. \n\nOr something along these lines.",
    "created_at": "2018-11-04T05:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370962",
    "user": "https://github.com/jhpalmieri"
}
```

I have one computer on which I can recreate the self-referential symlink by running `./sage -f sagenb`. I think the problem comes from this: sagenb is distributed with a full copy of mathjax in its data directory. The installation procedure is supposed to replace this copy with a symlink, and something goes wrong. Why is sagenb distributed with a copy of mathjax in the first place, since mathjax has been a separate Sage package for a while? Now I'm tempted to do this:

```diff
diff --git a/build/pkgs/sagenb/spkg-install b/build/pkgs/sagenb/spkg-install
index 57864ab0d9..639de1d23d 100644
--- a/build/pkgs/sagenb/spkg-install
+++ b/build/pkgs/sagenb/spkg-install
@@ -17,5 +17,6 @@ fi
 PYTHON_VERSION=$("$SAGE_LOCAL/bin/$PYTHON" -c 'import sys; print("%d.%d" % sys.version_info[:2])')
 cd "${SAGE_DESTDIR}${SAGE_LOCAL}/lib/python$PYTHON_VERSION/site-packages/sagenb/data" || \
     sdh_die "Cannot find SageNB data directory."
+rm -rf mathjax
 ln -s -n "$SAGE_SHARE/mathjax/" mathjax || \
     sdh_die "Error: Cannot symlink mathjax into the SageNB data directory."
```

along with a command at the start of sagenb's installation to remove the directory `sagenb/data/mathjax`, if it is not a symlink. Or maybe unconditionally. 

Or something along these lines.



---

archive/issue_comments_370963.json:
```json
{
    "body": "This doesn't explain things completely, of course: why can I reliably reproduce this on one computer and not another? On the computer where I can reproduce it, I first installed an older version of sagenb, removed the bad symlink, and then did an incremental update to the current `develop` branch. What remnants from the old build could be causing the symlink to get reproduced each time I do `./sage -f sagenb`?",
    "created_at": "2018-11-04T05:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370963",
    "user": "https://github.com/jhpalmieri"
}
```

This doesn't explain things completely, of course: why can I reliably reproduce this on one computer and not another? On the computer where I can reproduce it, I first installed an older version of sagenb, removed the bad symlink, and then did an incremental update to the current `develop` branch. What remnants from the old build could be causing the symlink to get reproduced each time I do `./sage -f sagenb`?



---

archive/issue_comments_370964.json:
```json
{
    "body": "Replying to [comment:6 jhpalmieri]:\n> I have one computer on which I can recreate the self-referential symlink\n\nTo clarify: which self-referential symlink do you mean? You are talking about sagenb here, but #26152 was about `local/share/mathjax/mathjax`.",
    "created_at": "2018-11-05T11:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370964",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 jhpalmieri]:
> I have one computer on which I can recreate the self-referential symlink

To clarify: which self-referential symlink do you mean? You are talking about sagenb here, but #26152 was about `local/share/mathjax/mathjax`.



---

archive/issue_comments_370965.json:
```json
{
    "body": "On the affected machine, can you post the output of\n\n```\nfind local -name mathjax | xargs ls -ld\n```\n",
    "created_at": "2018-11-05T11:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370965",
    "user": "https://github.com/jdemeyer"
}
```

On the affected machine, can you post the output of

```
find local -name mathjax | xargs ls -ld
```




---

archive/issue_comments_370966.json:
```json
{
    "body": "There is certainly something fishy here. On a clean install of sage:\n\n```\n$ find local -name mathjax |xargs ls -ld\ndrwxr-xr-x 7 jdemeyer jdemeyer 4096 Nov  5 13:22 local/lib/python2.7/site-packages/sagenb/data/mathjax\nlrwxrwxrwx 1 jdemeyer jdemeyer   44 Nov  5 13:22 local/lib/python2.7/site-packages/sagenb/data/mathjax/mathjax -> /usr/local/src/sage-git/local/share/mathjax/\nlrwxrwxrwx 1 jdemeyer jdemeyer   43 Nov  5 10:19 local/share/jupyter/nbextensions/mathjax -> /usr/local/src/sage-git/local/share/mathjax\ndrwxr-xr-x 7 jdemeyer jdemeyer 4096 Sep 27 07:21 local/share/mathjax\n```\n\n\nThe `local/lib/python2.7/site-packages/sagenb/data/mathjax/mathjax` symlink looks wrong to me.",
    "created_at": "2018-11-05T12:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370966",
    "user": "https://github.com/jdemeyer"
}
```

There is certainly something fishy here. On a clean install of sage:

```
$ find local -name mathjax |xargs ls -ld
drwxr-xr-x 7 jdemeyer jdemeyer 4096 Nov  5 13:22 local/lib/python2.7/site-packages/sagenb/data/mathjax
lrwxrwxrwx 1 jdemeyer jdemeyer   44 Nov  5 13:22 local/lib/python2.7/site-packages/sagenb/data/mathjax/mathjax -> /usr/local/src/sage-git/local/share/mathjax/
lrwxrwxrwx 1 jdemeyer jdemeyer   43 Nov  5 10:19 local/share/jupyter/nbextensions/mathjax -> /usr/local/src/sage-git/local/share/mathjax
drwxr-xr-x 7 jdemeyer jdemeyer 4096 Sep 27 07:21 local/share/mathjax
```


The `local/lib/python2.7/site-packages/sagenb/data/mathjax/mathjax` symlink looks wrong to me.



---

archive/issue_comments_370967.json:
```json
{
    "body": "I'll create a patch based on what you said in [comment:6]",
    "created_at": "2018-11-05T12:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370967",
    "user": "https://github.com/jdemeyer"
}
```

I'll create a patch based on what you said in [comment:6]



---

archive/issue_comments_370968.json:
```json
{
    "body": "The actual problem is that something went wrong with the latest sagenb packaging: #26641.",
    "created_at": "2018-11-05T12:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370968",
    "user": "https://github.com/jdemeyer"
}
```

The actual problem is that something went wrong with the latest sagenb packaging: #26641.



---

archive/issue_comments_370969.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:6 jhpalmieri]:\n> > I have one computer on which I can recreate the self-referential symlink\n> \n> To clarify: which self-referential symlink do you mean? You are talking about sagenb here, but #26152 was about `local/share/mathjax/mathjax`.\n\nI mean the one `SAGE_LOCAL/share/mathjax/mathjax` that points to `SAGE_LOCAL/share/mathjax`.  Force-installing `sagenb` on that machine recreates this link.",
    "created_at": "2018-11-05T18:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370969",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:6 jhpalmieri]:
> > I have one computer on which I can recreate the self-referential symlink
> 
> To clarify: which self-referential symlink do you mean? You are talking about sagenb here, but #26152 was about `local/share/mathjax/mathjax`.

I mean the one `SAGE_LOCAL/share/mathjax/mathjax` that points to `SAGE_LOCAL/share/mathjax`.  Force-installing `sagenb` on that machine recreates this link.



---

archive/issue_comments_370970.json:
```json
{
    "body": "Can you run `find local -name mathjax | xargs ls -ld` on that machine? And then check whether #26641 fixes the issue?",
    "created_at": "2018-11-05T18:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370970",
    "user": "https://github.com/jdemeyer"
}
```

Can you run `find local -name mathjax | xargs ls -ld` on that machine? And then check whether #26641 fixes the issue?



---

archive/issue_comments_370971.json:
```json
{
    "body": "\n```\n$ find local -name mathjax | xargs ls -ld\nlrwxr-xr-x   1 jpalmier  staff   64 Oct  3 09:58 local/lib/python2.7/site-packages/sagenb/data/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax/\nlrwxr-xr-x   1 jpalmier  staff   63 Nov  3 11:45 local/share/jupyter/nbextensions/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax\ndrwxr-xr-x  14 jpalmier  staff  448 Nov  5 10:12 local/share/mathjax\nlrwxr-xr-x   1 jpalmier  staff   64 Nov  5 10:12 local/share/mathjax/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax/\n```\n",
    "created_at": "2018-11-05T18:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370971",
    "user": "https://github.com/jhpalmieri"
}
```


```
$ find local -name mathjax | xargs ls -ld
lrwxr-xr-x   1 jpalmier  staff   64 Oct  3 09:58 local/lib/python2.7/site-packages/sagenb/data/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax/
lrwxr-xr-x   1 jpalmier  staff   63 Nov  3 11:45 local/share/jupyter/nbextensions/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax
drwxr-xr-x  14 jpalmier  staff  448 Nov  5 10:12 local/share/mathjax
lrwxr-xr-x   1 jpalmier  staff   64 Nov  5 10:12 local/share/mathjax/mathjax -> /Users/jpalmier/Desktop/Sage_stuff/git/sage/local/share/mathjax/
```




---

archive/issue_comments_370972.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Can you run `find local -name mathjax | xargs ls -ld` on that machine? And then check whether #26641 fixes the issue?\n\nIt fixes the issue in the sense that if I delete the bad symlink, then running `./sage -f sagenb` does not recreate it, whereas forcing installation of sagenb-1.1.0 does recreate it. You know the following already: it doesn't fix the issue in the sense that if the bad symlink is present, it is not deleted, and if the docs have been built with the bad symlink, therefore using up way too much disk space, that problem is not cleaned up.",
    "created_at": "2018-11-05T20:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370972",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:14 jdemeyer]:
> Can you run `find local -name mathjax | xargs ls -ld` on that machine? And then check whether #26641 fixes the issue?

It fixes the issue in the sense that if I delete the bad symlink, then running `./sage -f sagenb` does not recreate it, whereas forcing installation of sagenb-1.1.0 does recreate it. You know the following already: it doesn't fix the issue in the sense that if the bad symlink is present, it is not deleted, and if the docs have been built with the bad symlink, therefore using up way too much disk space, that problem is not cleaned up.



---

archive/issue_comments_370973.json:
```json
{
    "body": "#26612 looks good, so I think we can close this.",
    "created_at": "2018-11-08T15:40:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370973",
    "user": "https://github.com/embray"
}
```

#26612 looks good, so I think we can close this.



---

archive/issue_comments_370974.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2018-11-08T15:40:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370974",
    "user": "https://github.com/embray"
}
```

Resolution: duplicate



---

archive/issue_comments_370975.json:
```json
{
    "body": "Replying to [comment:17 embray]:\n> #26612 looks good, so I think we can close this.\n\n*This* is #26612, so your comment is as self-referential as the symlink.\n\nThere is no fix in place which actually cleans up the bad symlink and the bad docbuild. Is that really acceptable?",
    "created_at": "2018-11-08T16:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370975",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:17 embray]:
> #26612 looks good, so I think we can close this.

*This* is #26612, so your comment is as self-referential as the symlink.

There is no fix in place which actually cleans up the bad symlink and the bad docbuild. Is that really acceptable?



---

archive/issue_comments_370976.json:
```json
{
    "body": "And should there be a doctest that detects whether the symlink is there, so we know quickly if this problem ever reoccurs?",
    "created_at": "2018-11-08T16:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370976",
    "user": "https://github.com/jhpalmieri"
}
```

And should there be a doctest that detects whether the symlink is there, so we know quickly if this problem ever reoccurs?



---

archive/issue_comments_370977.json:
```json
{
    "body": "Sorry, I meant #26641.",
    "created_at": "2018-11-08T16:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370977",
    "user": "https://github.com/embray"
}
```

Sorry, I meant #26641.



---

archive/issue_comments_370978.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2018-11-09T06:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370978",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_370979.json:
```json
{
    "body": "Resolution changed from duplicate to ",
    "created_at": "2018-11-09T06:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370979",
    "user": "https://github.com/jdemeyer"
}
```

Resolution changed from duplicate to 



---

archive/issue_comments_370980.json:
```json
{
    "body": "I agree with John: #26641 is only a partial fix.",
    "created_at": "2018-11-09T06:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370980",
    "user": "https://github.com/jdemeyer"
}
```

I agree with John: #26641 is only a partial fix.



---

archive/issue_comments_370981.json:
```json
{
    "body": "I'm not really sure what else you want to do here.  If someone feels like they're being affected by this they can do an `rm -rf local/share/doc/sage` and re-build.",
    "created_at": "2018-11-09T13:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370981",
    "user": "https://github.com/embray"
}
```

I'm not really sure what else you want to do here.  If someone feels like they're being affected by this they can do an `rm -rf local/share/doc/sage` and re-build.



---

archive/issue_comments_370982.json:
```json
{
    "body": "What about the people who are affected but don't realize it?\n\nBy the way, they also need to delete `local/share/mathjax/mathjax`. Should `make doc-clean` delete this link?",
    "created_at": "2018-11-09T15:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26375#issuecomment-370982",
    "user": "https://github.com/jhpalmieri"
}
```

What about the people who are affected but don't realize it?

By the way, they also need to delete `local/share/mathjax/mathjax`. Should `make doc-clean` delete this link?
