# Issue 34496: polynomial quo_rem gives wrong answer for noncommutative rings

archive/issues_034496.json:
```json
{
    "body": "As reported in [this sage-devel thread](https://groups.google.com/g/sage-devel/c/D4jOrvAyyj8/m/yL9YEsE5GAAJ):\n\nThe `quo_rem` method for polynomials with quaternionic coefficients outputs incorrect results. Moreover, there is no way to specify whether we want a right or left division. Here is a specific example.\n\n\n```\n# Take the quaternion algebra (-1, -1)_QQ and the ring of polynomials over it:\nHH = QuaternionAlgebra(QQ, -1, -1)\nP.<x> = HH[]\n# Take two polynomials\nf = x^3 + HH.0*x + (HH.1 + 2*HH.2); print(\"f =\", f)\ng = HH.2*x + HH.1 + 3; print(\"g =\", g)\n# Try to compute the quotient and remainder\nq, r = f.quo_rem(g)\n# Check the correctness of the result assuming that this is RIGHT division\nprint(q*g + r == f)\n# Check the correctness of the result assuming that this is LEFT division\nprint(g*q + r == f)\n```\n\n\nBoth tests output False. Tested on Sage 9.5.\n\nMathematical background: the division with the remainder for polynomials over division rings is well known and fully described e.g. in [1] even in a more general setting when the variable does not commute with the coefficients (in our case it does commute). So it is just a matter of proper implementation.\n\n[1] Ore, Oystein. Theory of non-commutative polynomials. Ann. of Math. (2) 34 (1933), no. 3, 480--508. [MR1503119](https://mathscinet.ams.org/mathscinet-getitem?mr=1503119)\n\nIssue created by migration from https://trac.sagemath.org/ticket/34733\n\n",
    "created_at": "2022-11-08T19:02:14Z",
    "labels": [
        "algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "polynomial quo_rem gives wrong answer for noncommutative rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34496",
    "user": "@DaveWitteMorris"
}
```
As reported in [this sage-devel thread](https://groups.google.com/g/sage-devel/c/D4jOrvAyyj8/m/yL9YEsE5GAAJ):

The `quo_rem` method for polynomials with quaternionic coefficients outputs incorrect results. Moreover, there is no way to specify whether we want a right or left division. Here is a specific example.


```
# Take the quaternion algebra (-1, -1)_QQ and the ring of polynomials over it:
HH = QuaternionAlgebra(QQ, -1, -1)
P.<x> = HH[]
# Take two polynomials
f = x^3 + HH.0*x + (HH.1 + 2*HH.2); print("f =", f)
g = HH.2*x + HH.1 + 3; print("g =", g)
# Try to compute the quotient and remainder
q, r = f.quo_rem(g)
# Check the correctness of the result assuming that this is RIGHT division
print(q*g + r == f)
# Check the correctness of the result assuming that this is LEFT division
print(g*q + r == f)
```


Both tests output False. Tested on Sage 9.5.

Mathematical background: the division with the remainder for polynomials over division rings is well known and fully described e.g. in [1] even in a more general setting when the variable does not commute with the coefficients (in our case it does commute). So it is just a matter of proper implementation.

[1] Ore, Oystein. Theory of non-commutative polynomials. Ann. of Math. (2) 34 (1933), no. 3, 480--508. [MR1503119](https://mathscinet.ams.org/mathscinet-getitem?mr=1503119)

Issue created by migration from https://trac.sagemath.org/ticket/34733





---

archive/issue_comments_488431.json:
```json
{
    "body": "The bug was that the multiplication by `y` and the multiplication by its inverse (`inv`) were not both on the same side.\n\nAllowing the user to choose whether to have a left quotient or right quotient would be a bit more involved. (Adding a keyword argument for this would make the signature of this method incompatible with other implementations of `quo_rem`.) So I would like to leave this potential enhancement to a follow-up ticket.\n----\nNew commits:",
    "created_at": "2022-11-08T19:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488431",
    "user": "@DaveWitteMorris"
}
```

The bug was that the multiplication by `y` and the multiplication by its inverse (`inv`) were not both on the same side.

Allowing the user to choose whether to have a left quotient or right quotient would be a bit more involved. (Adding a keyword argument for this would make the signature of this method incompatible with other implementations of `quo_rem`.) So I would like to leave this potential enhancement to a follow-up ticket.
----
New commits:



---

archive/issue_comments_488432.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-08T19:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488432",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_488433.json:
```json
{
    "body": "wouldn't it make sense to add the same doctest also for the other polynomial rings?",
    "created_at": "2022-11-08T20:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488433",
    "user": "mantepse"
}
```

wouldn't it make sense to add the same doctest also for the other polynomial rings?



---

archive/issue_comments_488434.json:
```json
{
    "body": "Are you suggesting that we add a random doctest like this to the `quo_rem` methods for other polynomials that don't have one yet?  That sounds like a good idea to me, but I think it should be a separate ticket.",
    "created_at": "2022-11-08T20:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488434",
    "user": "@DaveWitteMorris"
}
```

Are you suggesting that we add a random doctest like this to the `quo_rem` methods for other polynomials that don't have one yet?  That sounds like a good idea to me, but I think it should be a separate ticket.



---

archive/issue_comments_488435.json:
```json
{
    "body": "Yes, but why not here?  One could in theory also do a slightly more systematic check (eg., checking `quo_rem` for `some_elements`), and I'd agree that this would be for another ticket, but the simple thing could be done here, no?",
    "created_at": "2022-11-08T21:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488435",
    "user": "mantepse"
}
```

Yes, but why not here?  One could in theory also do a slightly more systematic check (eg., checking `quo_rem` for `some_elements`), and I'd agree that this would be for another ticket, but the simple thing could be done here, no?



---

archive/issue_comments_488436.json:
```json
{
    "body": "I think there are about 15 different files that define `quo_rem` for various types of single-variable polynomials. That's expanding the scope of a very simple bug fix ticket (which I was happy to do and thought was important, since it's a bug) to a fairly substantial enhancement (which I probably won't have time to do soon, but could probably do in January).",
    "created_at": "2022-11-08T21:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488436",
    "user": "@DaveWitteMorris"
}
```

I think there are about 15 different files that define `quo_rem` for various types of single-variable polynomials. That's expanding the scope of a very simple bug fix ticket (which I was happy to do and thought was important, since it's a bug) to a fairly substantial enhancement (which I probably won't have time to do soon, but could probably do in January).



---

archive/issue_comments_488437.json:
```json
{
    "body": "I think that the only other polynomial ring that really applies is the sparse version in `polynomial_element_generic.py`.  Do you think adding the following test is OK?\n\n```diff\ndiff --git a/src/sage/rings/polynomial/polynomial_element_generic.py b/src/sage/rings/polynomial/polynomial_element_generic.py\nindex 868a5f691f9..f30e4325d1f 100644\n--- a/src/sage/rings/polynomial/polynomial_element_generic.py\n+++ b/src/sage/rings/polynomial/polynomial_element_generic.py\n@@ -824,6 +824,17 @@ class Polynomial_generic_sparse(Polynomial):\n             sage: f.quo_rem(g)\n             (-y^5 + 2*y^2, y^3 - 2*x^2*y^2 - y)\n \n+        Polynomials over noncommutative rings are also allowed\n+        (after :trac:`34733`)::\n+\n+            sage: HH = QuaternionAlgebra(QQ, -1, -1)\n+            sage: P.<x> = PolynomialRing(HH, sparse=True)\n+            sage: f = P.random_element(5)\n+            sage: g = P.random_element((0, 5))\n+            sage: q, r = f.quo_rem(g)\n+            sage: f == q*g + r\n+            True\n+\n         TESTS::\n \n             sage: P.<x> = PolynomialRing(ZZ, sparse=True)\n```\n",
    "created_at": "2022-11-08T21:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488437",
    "user": "mantepse"
}
```

I think that the only other polynomial ring that really applies is the sparse version in `polynomial_element_generic.py`.  Do you think adding the following test is OK?

```diff
diff --git a/src/sage/rings/polynomial/polynomial_element_generic.py b/src/sage/rings/polynomial/polynomial_element_generic.py
index 868a5f691f9..f30e4325d1f 100644
--- a/src/sage/rings/polynomial/polynomial_element_generic.py
+++ b/src/sage/rings/polynomial/polynomial_element_generic.py
@@ -824,6 +824,17 @@ class Polynomial_generic_sparse(Polynomial):
             sage: f.quo_rem(g)
             (-y^5 + 2*y^2, y^3 - 2*x^2*y^2 - y)
 
+        Polynomials over noncommutative rings are also allowed
+        (after :trac:`34733`)::
+
+            sage: HH = QuaternionAlgebra(QQ, -1, -1)
+            sage: P.<x> = PolynomialRing(HH, sparse=True)
+            sage: f = P.random_element(5)
+            sage: g = P.random_element((0, 5))
+            sage: q, r = f.quo_rem(g)
+            sage: f == q*g + r
+            True
+
         TESTS::
 
             sage: P.<x> = PolynomialRing(ZZ, sparse=True)
```




---

archive/issue_comments_488438.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-09T05:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488438",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488439.json:
```json
{
    "body": "Yes, that's good, so I made the change (except that I deleted \"(after :trac:`34733`)\", because this ticket did not need to make any changes in this method).",
    "created_at": "2022-11-09T05:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488439",
    "user": "@DaveWitteMorris"
}
```

Yes, that's good, so I made the change (except that I deleted "(after :trac:`34733`)", because this ticket did not need to make any changes in this method).



---

archive/issue_comments_488440.json:
```json
{
    "body": "Looks fine.  If you have time, maybe insert a space after the comma in `q,r`.  Thank you!",
    "created_at": "2022-11-09T10:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488440",
    "user": "mantepse"
}
```

Looks fine.  If you have time, maybe insert a space after the comma in `q,r`.  Thank you!



---

archive/issue_comments_488441.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-09T10:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488441",
    "user": "mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_488442.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-11-09T18:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488442",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_488443.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-11-09T18:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488443",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_488444.json:
```json
{
    "body": "Thanks!  (Yes, the extra space is better.)",
    "created_at": "2022-11-09T19:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488444",
    "user": "@DaveWitteMorris"
}
```

Thanks!  (Yes, the extra space is better.)



---

archive/issue_comments_488445.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-09T19:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488445",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_488446.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-11-20T12:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34496#issuecomment-488446",
    "user": "vbraun"
}
```

Resolution: fixed
