# Issue 33019: buffer.py: make files readonly only when possible

Issue created by migration from https://trac.sagemath.org/ticket/33256

Original creator: fbissey

Original creation time: 2022-01-31 09:17:17

CC:  mkoeppe

After #31306 we have doctest failure on sage-on-distros because files have been moved out of `SAGE_EXTCODE`. In `sage/repl/rich_output/buffer.py` files are made readonly with `chmod` so they are immutable during the process. Unfortunately `chmod` fails when trying to act on system installed files as a regular user. There is a safety for files in `SAGE_EXTCODE`, this is a useless complication and should be replaced by a `try` block.


---

Comment by fbissey created at 2022-01-31 09:30:59

While we may want to avoid error on file that are not changeable by the user, just a `try` doesn't reproduce the original intent

```
        if filename.startswith(os.path.abspath(SAGE_EXTCODE)):
            # Do not change permissions on the sample rich output
            # files, as it will cause trouble when upgrading Sage
```

Should the original block be preserved but with `SAGE_SRC` instead of `SAGE_EXTCODE`?


---

Comment by fbissey created at 2022-01-31 09:41:47

New commits:


---

Comment by fbissey created at 2022-01-31 09:41:47

Changing status from new to needs_info.


---

Comment by mkoeppe created at 2022-01-31 18:00:12

I don't know the details about this code there, but for the failures in #31306 I think the right fix is to change the doctests so that they don't attempt to make changes (including permissions) to the source tree.


---

Comment by fbissey created at 2022-01-31 18:54:58

Replying to [comment:4 mkoeppe]:
> I don't know the details about this code there, but for the failures in #31306 I think the right fix is to change the doctests so that they don't attempt to make changes (including permissions) to the source tree.

That's what I thought and why I switched the test to check for `SAGE_SRC` (it works as expected here). 

What about the other part of the branch which basically is about not failing if you cannot change the permissions outside of the source tree? The code wants to make sure the file that it is dealing with cannot be modified by changing its permission, but will fail when it cannot do so - in which case you probably cannot modify the file already.


---

Comment by fbissey created at 2022-01-31 19:23:19

Changing status from needs_info to needs_review.


---

Comment by arojas created at 2022-02-06 22:45:54

Works fine here (also testing on installed package)


---

Comment by arojas created at 2022-02-06 22:45:54

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2022-02-06 23:37:37

Thanks!


---

Comment by vbraun created at 2022-02-16 23:57:25

Resolution: fixed
