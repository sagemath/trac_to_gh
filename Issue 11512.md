# Issue 11512: Obtaining coefficients of polynomials over finite fields is extremely slow

archive/issues_011512.json:
```json
{
    "body": "Assignee: tbd\n\nKeywords: polynomials, finite fields\n\nIf we have a polynomial over a finite field and we want to obtain its coefficients, then there seems to be a lot of conversion overhead.  It is a lot slower than multiplying such polynomials:\n\n```\nsage: K.<a> = GF(5^3)\nsage: P = PolynomialRing(K, 'x')\nsage: f = P.random_element(100)\nsage: timeit('f.list()')\n5 loops, best of 3: 115 ms per loop\nsage: timeit('f * f')\n625 loops, best of 3: 794 \u00b5s per loop\n```\n\n\nIf, on the other hand, we do not use NTL, then we can obtain the coefficient list without any delays, though in that case multiplication is a lot slower:\n\n```\nsage: P = PolynomialRing(K, 'x', implementation='not NTL')\nsage: f = P(f)\nsage: timeit('f.list()')\n625 loops, best of 3: 968 ns per loop\nsage: timeit('f * f')\n25 loops, best of 3: 12.3 ms per loop\n```\n\nThis performance issue occurs in both 4.7 and 4.7.1.rc1.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11684\n\n",
    "created_at": "2011-08-12T20:59:18Z",
    "labels": [
        "performance",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Obtaining coefficients of polynomials over finite fields is extremely slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11512",
    "user": "johanbosman"
}
```
Assignee: tbd

Keywords: polynomials, finite fields

If we have a polynomial over a finite field and we want to obtain its coefficients, then there seems to be a lot of conversion overhead.  It is a lot slower than multiplying such polynomials:

```
sage: K.<a> = GF(5^3)
sage: P = PolynomialRing(K, 'x')
sage: f = P.random_element(100)
sage: timeit('f.list()')
5 loops, best of 3: 115 ms per loop
sage: timeit('f * f')
625 loops, best of 3: 794 Âµs per loop
```


If, on the other hand, we do not use NTL, then we can obtain the coefficient list without any delays, though in that case multiplication is a lot slower:

```
sage: P = PolynomialRing(K, 'x', implementation='not NTL')
sage: f = P(f)
sage: timeit('f.list()')
625 loops, best of 3: 968 ns per loop
sage: timeit('f * f')
25 loops, best of 3: 12.3 ms per loop
```

This performance issue occurs in both 4.7 and 4.7.1.rc1.

Issue created by migration from https://trac.sagemath.org/ticket/11684





---

archive/issue_comments_128921.json:
```json
{
    "body": "To be used after applying the fix of #11685",
    "created_at": "2011-08-13T14:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128921",
    "user": "johanbosman"
}
```

To be used after applying the fix of #11685



---

archive/issue_comments_128922.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-13T14:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128922",
    "user": "johanbosman"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_128923.json:
```json
{
    "body": "Attachment [trac_11684_coefficient_speedup.patch](tarball://root/attachments/some-uuid/ticket11684/trac_11684_coefficient_speedup.patch) by johanbosman created at 2011-08-13 14:26:09\n\nThe uploaded patch improves the speed slightly:\n\n```\nsage: K.<a> = GF(5^3)\nsage: P = PolynomialRing(K, 'x')\nsage: f = P.random_element(100)\nsage: timeit('f.list()')\n125 loops, best of 3: 2.92 ms per loop\n```\n\nA real fix would of course be an NTL wrapper for finite fields, which is a huge project that may not get finished soon.",
    "created_at": "2011-08-13T14:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128923",
    "user": "johanbosman"
}
```

Attachment [trac_11684_coefficient_speedup.patch](tarball://root/attachments/some-uuid/ticket11684/trac_11684_coefficient_speedup.patch) by johanbosman created at 2011-08-13 14:26:09

The uploaded patch improves the speed slightly:

```
sage: K.<a> = GF(5^3)
sage: P = PolynomialRing(K, 'x')
sage: f = P.random_element(100)
sage: timeit('f.list()')
125 loops, best of 3: 2.92 ms per loop
```

A real fix would of course be an NTL wrapper for finite fields, which is a huge project that may not get finished soon.



---

archive/issue_comments_128924.json:
```json
{
    "body": "The code of `list()` currently does `[self[i] for i in range(celement_len(&self.x, _parent))]`. You improved the `__getitem__` method.\n\nBut still, calling the `__getitem__` method over and over again seems to create a lot of overhead. I am sure that NTL provides a method that returns the list of coefficients. So, why not use that instead?\n\nAnd if that is impossible, note that most lines of `__getitem__` are concerned with preparatory steps, namely:\n\n```\n        cdef ZZ_pE_c c_pE\n        cdef cparent _parent\n\n        _parent = get_cparent(self._parent)\n        _parent[0].restore()\n        c_pE = ZZ_pEX_coeff(self.x, i)\n\n        K = self._parent.base_ring()\n```\n\n\nI am pretty sure that it is possible to do these preparatory steps only *once*. Hence, I suggest to be a bit more \"explicit\" in the `list()` method, rather than calling `self[i]`.\n\nOf course, in addition to that, one should also keep your improvement of `__getitem__`.",
    "created_at": "2011-08-14T06:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128924",
    "user": "@simon-king-jena"
}
```

The code of `list()` currently does `[self[i] for i in range(celement_len(&self.x, _parent))]`. You improved the `__getitem__` method.

But still, calling the `__getitem__` method over and over again seems to create a lot of overhead. I am sure that NTL provides a method that returns the list of coefficients. So, why not use that instead?

And if that is impossible, note that most lines of `__getitem__` are concerned with preparatory steps, namely:

```
        cdef ZZ_pE_c c_pE
        cdef cparent _parent

        _parent = get_cparent(self._parent)
        _parent[0].restore()
        c_pE = ZZ_pEX_coeff(self.x, i)

        K = self._parent.base_ring()
```


I am pretty sure that it is possible to do these preparatory steps only *once*. Hence, I suggest to be a bit more "explicit" in the `list()` method, rather than calling `self[i]`.

Of course, in addition to that, one should also keep your improvement of `__getitem__`.



---

archive/issue_comments_128925.json:
```json
{
    "body": "The problem is that Sage uses NTL for polynomials over finite fields, but not for elements of finite fields.  So simply using NTL's list method wouldn't work (unfortunately).  I'll try to see whether a direct list() method will improve speed further.  Though I suspect that 99% of the running time goes into\n\n```\nK(ZZ_pE_c_to_list(c_pE))\n```\n\nso that the gain will be negligible.",
    "created_at": "2011-08-14T07:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128925",
    "user": "johanbosman"
}
```

The problem is that Sage uses NTL for polynomials over finite fields, but not for elements of finite fields.  So simply using NTL's list method wouldn't work (unfortunately).  I'll try to see whether a direct list() method will improve speed further.  Though I suspect that 99% of the running time goes into

```
K(ZZ_pE_c_to_list(c_pE))
```

so that the gain will be negligible.



---

archive/issue_comments_128926.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-08-14T07:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128926",
    "user": "johanbosman"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_128927.json:
```json
{
    "body": "I already created a patch for the more direct approach. I am now running doc tests. The additional speed gain in your example is something like 20%.",
    "created_at": "2011-08-14T08:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128927",
    "user": "@simon-king-jena"
}
```

I already created a patch for the more direct approach. I am now running doc tests. The additional speed gain in your example is something like 20%.



---

archive/issue_comments_128928.json:
```json
{
    "body": "At least the tests in devel/sage/doc pass. Hence, I have already posted my patch. Here are the timings:\n\n```\nsage: K.<a> = GF(5^3)\nsage: P = PolynomialRing(K, 'x')\nsage: f = P.random_element(100)\n```\n\n\n#11685 only:\n\n```\nsage: timeit('f.list()')\n5 loops, best of 3: 79.9 ms per loop\n```\n\n\n#11685 with your patch:\n\n```\nsage: timeit('f.list()')\n125 loops, best of 3: 2.36 ms per loop\n```\n\n\nAll patches:\n\n```\nsage: timeit('f.list()')\n125 loops, best of 3: 2.03 ms per loop\n```\n\n\nOK, that's only a gain of 14%. But I had one run where it took 2.42 ms with one patch and 1.98 ms with both patches (that's why I stated 20% in my previous post).\n\nAnyway, does the second patch make sense? I am currently running doc tests, so that probably I can review both #11685 and your patch from here.",
    "created_at": "2011-08-14T08:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128928",
    "user": "@simon-king-jena"
}
```

At least the tests in devel/sage/doc pass. Hence, I have already posted my patch. Here are the timings:

```
sage: K.<a> = GF(5^3)
sage: P = PolynomialRing(K, 'x')
sage: f = P.random_element(100)
```


#11685 only:

```
sage: timeit('f.list()')
5 loops, best of 3: 79.9 ms per loop
```


#11685 with your patch:

```
sage: timeit('f.list()')
125 loops, best of 3: 2.36 ms per loop
```


All patches:

```
sage: timeit('f.list()')
125 loops, best of 3: 2.03 ms per loop
```


OK, that's only a gain of 14%. But I had one run where it took 2.42 ms with one patch and 1.98 ms with both patches (that's why I stated 20% in my previous post).

Anyway, does the second patch make sense? I am currently running doc tests, so that probably I can review both #11685 and your patch from here.



---

archive/issue_comments_128929.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-08-14T08:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128929",
    "user": "@simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_128930.json:
```json
{
    "body": "I already stated that your patch improves the `__getitem__` method considerably, and I can confirm the resulting speedup in `list()`.\n\nThe long doctests of both devel/sage-main/doc and devel/sage-main/sage pass. Hence, I give your patch a positive review.\n\nOf course I can not review my own patch. So, I'd appreciate if you could have a look on it.",
    "created_at": "2011-08-14T13:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128930",
    "user": "@simon-king-jena"
}
```

I already stated that your patch improves the `__getitem__` method considerably, and I can confirm the resulting speedup in `list()`.

The long doctests of both devel/sage-main/doc and devel/sage-main/sage pass. Hence, I give your patch a positive review.

Of course I can not review my own patch. So, I'd appreciate if you could have a look on it.



---

archive/issue_comments_128931.json:
```json
{
    "body": "I've been travelling all day; I'll start reviewing right now. ;)",
    "created_at": "2011-08-14T19:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128931",
    "user": "johanbosman"
}
```

I've been travelling all day; I'll start reviewing right now. ;)



---

archive/issue_comments_128932.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-14T20:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128932",
    "user": "johanbosman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_128933.json:
```json
{
    "body": "There's a declaration\n\n```\ncdef ZZ_pE_c c_pE \n```\n\nin your code but it isn't used.  So you might as well leave it out. ;).",
    "created_at": "2011-08-14T20:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128933",
    "user": "johanbosman"
}
```

There's a declaration

```
cdef ZZ_pE_c c_pE 
```

in your code but it isn't used.  So you might as well leave it out. ;).



---

archive/issue_comments_128934.json:
```json
{
    "body": "Replying to [comment:9 johanbosman]:\n> There's a declaration\n> {{{\n> cdef ZZ_pE_c c_pE \n> }}}\n> in your code but it isn't used.  So you might as well leave it out. ;).\n\nRight. That is a copy-and-paste error.",
    "created_at": "2011-08-14T20:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128934",
    "user": "@simon-king-jena"
}
```

Replying to [comment:9 johanbosman]:
> There's a declaration
> {{{
> cdef ZZ_pE_c c_pE 
> }}}
> in your code but it isn't used.  So you might as well leave it out. ;).

Right. That is a copy-and-paste error.



---

archive/issue_comments_128935.json:
```json
{
    "body": "More direct coefficient list creation for NTL polys over finite fields. Apply after Johan's patch",
    "created_at": "2011-08-14T21:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128935",
    "user": "@simon-king-jena"
}
```

More direct coefficient list creation for NTL polys over finite fields. Apply after Johan's patch



---

archive/issue_comments_128936.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-08-14T21:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128936",
    "user": "@simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128937.json:
```json
{
    "body": "Attachment [trac_11684_list_speedup.patch](tarball://root/attachments/some-uuid/ticket11684/trac_11684_list_speedup.patch) by @simon-king-jena created at 2011-08-14 21:35:43\n\nI just updated my patch. So, \"needs review\" again.",
    "created_at": "2011-08-14T21:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128937",
    "user": "@simon-king-jena"
}
```

Attachment [trac_11684_list_speedup.patch](tarball://root/attachments/some-uuid/ticket11684/trac_11684_list_speedup.patch) by @simon-king-jena created at 2011-08-14 21:35:43

I just updated my patch. So, "needs review" again.



---

archive/issue_comments_128938.json:
```json
{
    "body": "The code looks okay now, all doctests pass, and the documentation builds fine.",
    "created_at": "2011-08-15T08:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128938",
    "user": "johanbosman"
}
```

The code looks okay now, all doctests pass, and the documentation builds fine.



---

archive/issue_comments_128939.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-15T08:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128939",
    "user": "johanbosman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128940.json:
```json
{
    "body": "Make someone review #11685... ;-)",
    "created_at": "2011-09-08T13:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128940",
    "user": "@nexttime"
}
```

Make someone review #11685... ;-)



---

archive/issue_comments_128941.json:
```json
{
    "body": "Replying to [comment:13 leif]:\n> Make someone review #11685... ;-)\nDone!",
    "created_at": "2011-09-14T09:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128941",
    "user": "@pjbruin"
}
```

Replying to [comment:13 leif]:
> Make someone review #11685... ;-)
Done!



---

archive/issue_comments_128942.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-17T05:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11512#issuecomment-128942",
    "user": "@nexttime"
}
```

Resolution: fixed
