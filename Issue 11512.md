# Issue 11512: Obtaining coefficients of polynomials over finite fields is extremely slow

Issue created by migration from https://trac.sagemath.org/ticket/11684

Original creator: johanbosman

Original creation time: 2011-08-12 20:59:18

Assignee: tbd

Keywords: polynomials, finite fields

If we have a polynomial over a finite field and we want to obtain its coefficients, then there seems to be a lot of conversion overhead.  It is a lot slower than multiplying such polynomials:

```
sage: K.<a> = GF(5^3)
sage: P = PolynomialRing(K, 'x')
sage: f = P.random_element(100)
sage: timeit('f.list()')
5 loops, best of 3: 115 ms per loop
sage: timeit('f * f')
625 loops, best of 3: 794 Âµs per loop
```


If, on the other hand, we do not use NTL, then we can obtain the coefficient list without any delays, though in that case multiplication is a lot slower:

```
sage: P = PolynomialRing(K, 'x', implementation='not NTL')
sage: f = P(f)
sage: timeit('f.list()')
625 loops, best of 3: 968 ns per loop
sage: timeit('f * f')
25 loops, best of 3: 12.3 ms per loop
```

This performance issue occurs in both 4.7 and 4.7.1.rc1.


---

Comment by johanbosman created at 2011-08-13 14:15:59

To be used after applying the fix of #11685


---

Comment by johanbosman created at 2011-08-13 14:26:09

Changing status from new to needs_review.


---

Attachment

The uploaded patch improves the speed slightly:

```
sage: K.<a> = GF(5^3)
sage: P = PolynomialRing(K, 'x')
sage: f = P.random_element(100)
sage: timeit('f.list()')
125 loops, best of 3: 2.92 ms per loop
```

A real fix would of course be an NTL wrapper for finite fields, which is a huge project that may not get finished soon.


---

Comment by SimonKing created at 2011-08-14 06:35:42

The code of `list()` currently does `[self[i] for i in range(celement_len(&self.x, _parent))]`. You improved the `__getitem__` method.

But still, calling the `__getitem__` method over and over again seems to create a lot of overhead. I am sure that NTL provides a method that returns the list of coefficients. So, why not use that instead?

And if that is impossible, note that most lines of `__getitem__` are concerned with preparatory steps, namely:

```
        cdef ZZ_pE_c c_pE
        cdef cparent _parent

        _parent = get_cparent(self._parent)
        _parent[0].restore()
        c_pE = ZZ_pEX_coeff(self.x, i)

        K = self._parent.base_ring()
```


I am pretty sure that it is possible to do these preparatory steps only _once_. Hence, I suggest to be a bit more "explicit" in the `list()` method, rather than calling `self[i]`.

Of course, in addition to that, one should also keep your improvement of `__getitem__`.


---

Comment by johanbosman created at 2011-08-14 07:32:59

The problem is that Sage uses NTL for polynomials over finite fields, but not for elements of finite fields.  So simply using NTL's list method wouldn't work (unfortunately).  I'll try to see whether a direct list() method will improve speed further.  Though I suspect that 99% of the running time goes into

```
K(ZZ_pE_c_to_list(c_pE))
```

so that the gain will be negligible.


---

Comment by johanbosman created at 2011-08-14 07:50:23

Changing status from needs_review to needs_info.


---

Comment by SimonKing created at 2011-08-14 08:18:22

I already created a patch for the more direct approach. I am now running doc tests. The additional speed gain in your example is something like 20%.


---

Comment by SimonKing created at 2011-08-14 08:32:12

At least the tests in devel/sage/doc pass. Hence, I have already posted my patch. Here are the timings:

```
sage: K.<a> = GF(5^3)
sage: P = PolynomialRing(K, 'x')
sage: f = P.random_element(100)
```


#11685 only:

```
sage: timeit('f.list()')
5 loops, best of 3: 79.9 ms per loop
```


#11685 with your patch:

```
sage: timeit('f.list()')
125 loops, best of 3: 2.36 ms per loop
```


All patches:

```
sage: timeit('f.list()')
125 loops, best of 3: 2.03 ms per loop
```


OK, that's only a gain of 14%. But I had one run where it took 2.42 ms with one patch and 1.98 ms with both patches (that's why I stated 20% in my previous post).

Anyway, does the second patch make sense? I am currently running doc tests, so that probably I can review both #11685 and your patch from here.


---

Comment by SimonKing created at 2011-08-14 08:32:12

Changing status from needs_info to needs_review.


---

Comment by SimonKing created at 2011-08-14 13:57:08

I already stated that your patch improves the `__getitem__` method considerably, and I can confirm the resulting speedup in `list()`.

The long doctests of both devel/sage-main/doc and devel/sage-main/sage pass. Hence, I give your patch a positive review.

Of course I can not review my own patch. So, I'd appreciate if you could have a look on it.


---

Comment by johanbosman created at 2011-08-14 19:45:19

I've been travelling all day; I'll start reviewing right now. ;)


---

Comment by johanbosman created at 2011-08-14 20:18:29

Changing status from needs_review to needs_work.


---

Comment by johanbosman created at 2011-08-14 20:18:29

There's a declaration

```
cdef ZZ_pE_c c_pE 
```

in your code but it isn't used.  So you might as well leave it out. ;).


---

Comment by SimonKing created at 2011-08-14 20:41:41

Replying to [comment:9 johanbosman]:
> There's a declaration
> {{{
> cdef ZZ_pE_c c_pE 
> }}}
> in your code but it isn't used.  So you might as well leave it out. ;).

Right. That is a copy-and-paste error.


---

Comment by SimonKing created at 2011-08-14 21:34:12

More direct coefficient list creation for NTL polys over finite fields. Apply after Johan's patch


---

Comment by SimonKing created at 2011-08-14 21:35:43

Changing status from needs_work to needs_review.


---

Attachment

I just updated my patch. So, "needs review" again.


---

Comment by johanbosman created at 2011-08-15 08:10:04

The code looks okay now, all doctests pass, and the documentation builds fine.


---

Comment by johanbosman created at 2011-08-15 08:10:04

Changing status from needs_review to positive_review.


---

Comment by leif created at 2011-09-08 13:42:53

Make someone review #11685... ;-)


---

Comment by pbruin created at 2011-09-14 09:34:09

Replying to [comment:13 leif]:
> Make someone review #11685... ;-)
Done!


---

Comment by leif created at 2011-09-17 05:06:19

Resolution: fixed
