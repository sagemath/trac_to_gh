# Issue 32324: Speed up random bounded tolerance graph

archive/issues_032324.json:
```json
{
    "body": "CC:  @kliem\n\nSince #32186, we use `Combinations` in `RandomBoundedToleranceGraph` and the method is rather slow\n\n```\nsage: %timeit g = graphs.RandomBoundedToleranceGraph(8)\n17.9 s \u00b1 449 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nHere we avoid the use of `Combinations` and we get a much faster generator\n\n```\nsage: %timeit g = graphs.RandomBoundedToleranceGraph(8)\n102 \u00b5s \u00b1 2.38 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32561\n\n",
    "created_at": "2021-09-25T15:50:59Z",
    "labels": [
        "graph theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Speed up random bounded tolerance graph",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32324",
    "user": "@dcoudert"
}
```
CC:  @kliem

Since #32186, we use `Combinations` in `RandomBoundedToleranceGraph` and the method is rather slow

```
sage: %timeit g = graphs.RandomBoundedToleranceGraph(8)
17.9 s ± 449 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

Here we avoid the use of `Combinations` and we get a much faster generator

```
sage: %timeit g = graphs.RandomBoundedToleranceGraph(8)
102 µs ± 2.38 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


Issue created by migration from https://trac.sagemath.org/ticket/32561





---

archive/issue_comments_461356.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-09-25T15:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461356",
    "user": "@dcoudert"
}
```

New commits:



---

archive/issue_comments_461357.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-25T15:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461357",
    "user": "@dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461358.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-25T16:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461358",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461359.json:
```json
{
    "body": "I took the opportunity to remove multiple imports of `randint` and give the same shape to method `RandomToleranceGraph`.",
    "created_at": "2021-09-25T16:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461359",
    "user": "@dcoudert"
}
```

I took the opportunity to remove multiple imports of `randint` and give the same shape to method `RandomToleranceGraph`.



---

archive/issue_comments_461360.json:
```json
{
    "body": "While I agree with the need to change this, I don't agree with the implementation.\n\nHowever, I don't really understand tolerance graphs and what kind of values give you interesting tolerance graphs.\n\nWith this little knowledge that I have, your implementation seems very strange distributed. Half of the intervals start on the right half. I think it should be much less.\n\nSo I propose the following changes:\n\n```diff\n     tolrep = []\n     for _ in range(n):\n-        l = randint(0, W - 1)\n+        l = randint(0, W)\n-        r = randint(l + 1, W)\n+        r = randint(0, W - 1)\n+        if r >= l:\n+            l, r = r + 1, l\n         tolrep.append((l, r, randint(1, r - l)))\n```\n\n\nThe obtained random intervals will be symmtric. It is equivalent to\n\n```\n    tolrep = []\n    for _ in range(n):\n        l = randint(0, W)\n        r = l\n        while r == l:\n            r = randint(0, W)\n        ...\n```\n\nbut much nicer as it avoids the loop.\n\nThe timings of `Combinations(W, 2).random_element()` are absolutely awful. I wasn't aware of this. The complexity appears to grow quadratic to `W` (and only about twice as fast as picking a random element from `itertools.combinations(range(W), 2)`). `Combinations` considers a multi-set though, which is a much more complex problem.",
    "created_at": "2021-09-29T08:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461360",
    "user": "@kliem"
}
```

While I agree with the need to change this, I don't agree with the implementation.

However, I don't really understand tolerance graphs and what kind of values give you interesting tolerance graphs.

With this little knowledge that I have, your implementation seems very strange distributed. Half of the intervals start on the right half. I think it should be much less.

So I propose the following changes:

```diff
     tolrep = []
     for _ in range(n):
-        l = randint(0, W - 1)
+        l = randint(0, W)
-        r = randint(l + 1, W)
+        r = randint(0, W - 1)
+        if r >= l:
+            l, r = r + 1, l
         tolrep.append((l, r, randint(1, r - l)))
```


The obtained random intervals will be symmtric. It is equivalent to

```
    tolrep = []
    for _ in range(n):
        l = randint(0, W)
        r = l
        while r == l:
            r = randint(0, W)
        ...
```

but much nicer as it avoids the loop.

The timings of `Combinations(W, 2).random_element()` are absolutely awful. I wasn't aware of this. The complexity appears to grow quadratic to `W` (and only about twice as fast as picking a random element from `itertools.combinations(range(W), 2)`). `Combinations` considers a multi-set though, which is a much more complex problem.



---

archive/issue_comments_461361.json:
```json
{
    "body": "See also #32584, which improves `Combinations(n, k).random_element()` and gives the following timings:\n\n\n```\nsage: %timeit g = graphs.RandomBoundedToleranceGraph(8)\n85.3 ms \u00b1 3.78 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\n\nNot even close to the new timings, but the intervals uniformly distributed (from the set of all intervals). I don't know if this is desirable or not.\n\nEdit: Well both distributions are the same. One problem is that `random_element` of `Combinations` is linear in the length of the list. Kind of nice, but not when obtaining combinations `Combinations(16000, 10)` or similar.",
    "created_at": "2021-09-29T09:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461361",
    "user": "@kliem"
}
```

See also #32584, which improves `Combinations(n, k).random_element()` and gives the following timings:


```
sage: %timeit g = graphs.RandomBoundedToleranceGraph(8)
85.3 ms ± 3.78 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
```


Not even close to the new timings, but the intervals uniformly distributed (from the set of all intervals). I don't know if this is desirable or not.

Edit: Well both distributions are the same. One problem is that `random_element` of `Combinations` is linear in the length of the list. Kind of nice, but not when obtaining combinations `Combinations(16000, 10)` or similar.



---

archive/issue_comments_461362.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T12:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461362",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461363.json:
```json
{
    "body": "I slightly changes the values since we want 0 <= l < r <= W.\n\nWe could also try with a single `randint` in range `[1, W*(W-1)/2]` and then retrieve l and r, but I'm not sure it's really better.",
    "created_at": "2021-09-29T12:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461363",
    "user": "@dcoudert"
}
```

I slightly changes the values since we want 0 <= l < r <= W.

We could also try with a single `randint` in range `[1, W*(W-1)/2]` and then retrieve l and r, but I'm not sure it's really better.



---

archive/issue_comments_461364.json:
```json
{
    "body": "I guess I could open a new ticket and implement the following:\n\n\n```\ndef random_combination(a, b, k):\n    \"\"\"\n    Return a list of ``k`` distinct sorted random integers ``i`` with ``a <= i <= b``.\n    \"\"\"\n    l = [randint(a, b - i) for i in range(k)]\n    for i in range(k):\n        for j in range(i):\n            if l[i] >= l[j]:\n                l[i] += 1\n    return sorted(l)\n```\n\n\nThen `Combinations_setk` could make use of this, if `k` is small relative to `n` (the above function is quadratic in `k`, which `Combinations(n,k).random_element()` appears to be linear in `n`.",
    "created_at": "2021-09-29T12:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461364",
    "user": "@kliem"
}
```

I guess I could open a new ticket and implement the following:


```
def random_combination(a, b, k):
    """
    Return a list of ``k`` distinct sorted random integers ``i`` with ``a <= i <= b``.
    """
    l = [randint(a, b - i) for i in range(k)]
    for i in range(k):
        for j in range(i):
            if l[i] >= l[j]:
                l[i] += 1
    return sorted(l)
```


Then `Combinations_setk` could make use of this, if `k` is small relative to `n` (the above function is quadratic in `k`, which `Combinations(n,k).random_element()` appears to be linear in `n`.



---

archive/issue_comments_461365.json:
```json
{
    "body": "Replying to [comment:7 dcoudert]:\n> I slightly changes the values since we want 0 <= l < r <= W.\n> \n> We could also try with a single `randint` in range `[1, W*(W-1)/2]` and then retrieve l and r, but I'm not sure it's really better.\n\nThe improvement is good as it is. As I noted later, this is uniformly distributed, as what we are doing is equivalent to the following:\n\n1. Pick `l`, `r` in with `randint(0, W)`.\n2. Restart if `l == r`.\n3. Sort `l` and `r.",
    "created_at": "2021-09-29T12:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461365",
    "user": "@kliem"
}
```

Replying to [comment:7 dcoudert]:
> I slightly changes the values since we want 0 <= l < r <= W.
> 
> We could also try with a single `randint` in range `[1, W*(W-1)/2]` and then retrieve l and r, but I'm not sure it's really better.

The improvement is good as it is. As I noted later, this is uniformly distributed, as what we are doing is equivalent to the following:

1. Pick `l`, `r` in with `randint(0, W)`.
2. Restart if `l == r`.
3. Sort `l` and `r.



---

archive/issue_comments_461366.json:
```json
{
    "body": "I don't understand the relationship between combinations and the method you propose in #comment:8. Furthermore, I can get\n\n```\nsage: random_combination(2, 6, 5)\n[2, 3, 3, 5, 5]\n```\n\n\nAt least, we have improved method `RandomBoundedToleranceGraph`.",
    "created_at": "2021-09-29T14:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461366",
    "user": "@dcoudert"
}
```

I don't understand the relationship between combinations and the method you propose in #comment:8. Furthermore, I can get

```
sage: random_combination(2, 6, 5)
[2, 3, 3, 5, 5]
```


At least, we have improved method `RandomBoundedToleranceGraph`.



---

archive/issue_comments_461367.json:
```json
{
    "body": "Yes, indeed this doesn't work.\nThis is the correct code:\n\n\n```\nsage: def random_combination(a, b, k):\n....:     l = [randint(a, b - i) for i in range(k)]\n....:     for i in range(k):\n....:         for j in range(i):\n....:             if l[i] >= l[j]:\n....:                 l[i] += 1\n....:         l[:i+1] = sorted(l[:i+1])\n....:     return l\n```\n\n\nThis is exactly what we do for the case `k=2`: `random_combination(0, W(n), 2)`.",
    "created_at": "2021-09-29T19:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461367",
    "user": "@kliem"
}
```

Yes, indeed this doesn't work.
This is the correct code:


```
sage: def random_combination(a, b, k):
....:     l = [randint(a, b - i) for i in range(k)]
....:     for i in range(k):
....:         for j in range(i):
....:             if l[i] >= l[j]:
....:                 l[i] += 1
....:         l[:i+1] = sorted(l[:i+1])
....:     return l
```


This is exactly what we do for the case `k=2`: `random_combination(0, W(n), 2)`.



---

archive/issue_comments_461368.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-29T20:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461368",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_461369.json:
```json
{
    "body": "Anyway, LGTM.",
    "created_at": "2021-09-29T20:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461369",
    "user": "@kliem"
}
```

Anyway, LGTM.



---

archive/issue_comments_461370.json:
```json
{
    "body": "Thanks for the review and all the comments.",
    "created_at": "2021-09-29T20:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461370",
    "user": "@dcoudert"
}
```

Thanks for the review and all the comments.



---

archive/issue_comments_461371.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-10T22:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32324#issuecomment-461371",
    "user": "@vbraun"
}
```

Resolution: fixed
