# Issue 14948: Clean up interface to the PARI library

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2013-09-11 14:35:35

Keywords: pari

The file `sage/libs/pari/gen.pyx` is too big and contains too many different things.  For clarity and maintainability, it should be split into three parts:
- `gen.pyx` containing the class `gen`;
- `pari_error.pyx` containing the class `PariError` and other error-handling code;
- `pari_instance.pyx` containing the class `PariInstance` and some utility functions.
The following things should probably be cut out:
- The `gen` class currently contains duplicates of various methods of `PariInstance` (such as `new_gen`) for no obvious reason.  These methods should be deleted.
- The global variables `t0, ..., t5` (used to store results of conversion of Python objects to PARI objects) should be replaced by appropriate local variables.
- There is a lot of obsolete code (e.g. `add_unsafe`, which currently is not used, and probably never should be); this should be deleted.
A patch is being worked on; it does not work well with the existing error-handling code and should be rebased on #9640.


---

Comment by jdemeyer created at 2013-10-03 10:24:44

The `t0GEN` stuff is #11868.


---

Comment by jdemeyer created at 2013-11-23 11:41:10

I think this ticket is a typical "patchbomb" which should be avoided. In particular, the replacing of the global variables `t0`... and the re-organizing of the `.py(x)` files are both big changes which should be on different tickets. For the former, I already created #11868 for this.


---

Comment by pbruin created at 2013-11-23 20:59:09

Replying to [comment:7 jdemeyer]:
> I think this ticket is a typical "patchbomb" which should be avoided.
I know.  The problem is that when I started this clean-up operation, it wasn't clear what the end result was going to look like.  I created this ticket -- and the list of separate issues -- only after reaching a state that worked again, and didn't know about #11868.  Cutting it up into separate tickets is easier said than done; it will probably become more manageable by using Git, but it will still take a lot of effort.


---

Comment by pbruin created at 2013-11-24 02:32:09

As a first step I split off the changes eliminating the global GEN variables as a patch on #11868.  This will certainly have to be rebased, but that had to be done anyway because of #10018.


---

Comment by jdemeyer created at 2013-11-26 14:05:15

To ease rebasing and reviewing, I recommend you to make this ticket absolutely minimal (only move stuff, nothing else): everything which can be done on a different ticket, should be done so.


---

Comment by pbruin created at 2013-11-26 14:18:02

Replying to [comment:10 jdemeyer]:
> To ease rebasing and reviewing, I recommend you to make this ticket absolutely minimal (only move stuff, nothing else): everything which can be done on a different ticket, should be done so.
That is more or less my plan, after #11868 is finished.


---

Comment by jdemeyer created at 2013-12-06 21:46:57

Are we sure we really want to do this? I'm afraid that performance is going to be worse because Cython has an overhead when calling functions in a different module.


---

Comment by pbruin created at 2013-12-08 16:23:30

Replying to [comment:13 jdemeyer]:
> Are we sure we really want to do this? I'm afraid that performance is going to be worse because Cython has an overhead when calling functions in a different module.
Is this because the ``@`cython.final` decorator on an extension type `T` currently does not forbid subtyping `T` in a different Cython module (so that methods can be called directly in the same module, but only via a vtab in a different module)?

If this is what you mean, could the overhead be avoided by making `new_gen()` and `clear_stack()` (which will be responsible for most of the cross-module calls) functions instead of methods?


---

Comment by pbruin created at 2013-12-11 01:58:43

Changing status from new to needs_review.


---

Comment by pbruin created at 2013-12-11 01:58:43

Here is a new branch which moves `PariInstance` to a separate file and otherwise is close to minimal.

It is true that the Cython-generated code has some overhead in for the cross-module method calls.  I think it is very small, but I will try to do some timings.  Depending on the outcome, it might be reasonable to duplicate a small amount of code to avoid these cross-module calls.  I think it is better to do that as part of #15461, though.
----
New commits:


---

Comment by git created at 2013-12-11 02:12:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2013-12-16 11:15:29

Additional commit needs review. Apart from this, everything looks fine.
----
New commits:


---

Comment by pbruin created at 2013-12-16 13:04:44

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2013-12-16 13:04:44

I wasn't sure whether `allocatemem()` should already be removed from the global namespace (it was only deprecated recently), and whether `from sage.libs.pari.all import ...` is better than specifying the precise module, but I'm definitely OK with these changes.


---

Comment by vbraun created at 2013-12-20 15:50:51

Resolution: fixed
