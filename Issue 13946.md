# Issue 13946: Fix wait() in @parallel

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-02-20 12:11:46

Assignee: jason

The new doctesting framework sometimes gets:

```
sage -t --long devel/sage/sage/homology/simplicial_complex.py
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 2188, in sage.homology.simplicial_complex.SimplicialComplex.is_cohen_macaulay
Failed example:
    S.is_cohen_macaulay(ncpus=3)
Expected:
    False
Got:
    Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x646f1e0> ignored
    False
**********************************************************************
```


Fix this.


---

Comment by jdemeyer created at 2013-02-20 12:31:23

Changing status from new to needs_review.


---

Comment by roed created at 2013-02-20 16:04:30

Looks good.  You didn't add a doctest: is there one that consistently fails in the new framework?


---

Comment by jdemeyer created at 2013-02-20 16:14:53

Replying to [comment:2 roed]:
> is there one that consistently fails in the new framework?
To be honest, I cannot say for sure why the problem occurs.

I'm fairly certain the problem is the big gap between

```
pid = os.wait()[0]
```

and

```
del workers[pid]
```

If some exception would occur in between, then `workers[pid]` would still be in the list of workers, even though we saw it exit. However, I cannot really explain where the exception could come from (can `yield` raise exceptions?)


---

Comment by roed created at 2013-02-20 17:09:29

How consistently is this error occurring in the new framework?  Every time?  Do the fixes here make the problem disappear?  If so, I'm willing to give this a positive review, since there is a doctest failing that will no longer fail.


---

Comment by jdemeyer created at 2013-02-20 17:48:34

Replying to [comment:4 roed]:
> How consistently is this error occurring in the new framework?  Every time?
Not every time, but it's still reasonably common that I have seen it multiple times.


---

Comment by jdemeyer created at 2013-02-20 19:56:33

Added doctest which always shows the `OSError` without this patch.


---

Comment by roed created at 2013-02-22 04:15:22

You should fix the unpickling after breaking it.  Add 


```
sage: from sage.structure.sage_object import unpickle_override
sage: del unpickle_override[('sage.rings.polynomial.polynomial_rational_flint', 'Polynomial_rational_flint')]
```


after the end of the `TESTS` block.  Otherwise it looks good.


---

Comment by roed created at 2013-02-22 04:15:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-02-22 07:24:42

Good point :-)


---

Comment by jdemeyer created at 2013-02-23 15:37:36

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by roed created at 2013-02-24 05:47:23

Changing status from needs_review to positive_review.


---

Comment by roed created at 2013-02-24 05:47:23

Great.


---

Comment by jdemeyer created at 2013-02-28 10:33:37

Resolution: fixed


---

Comment by vbraun created at 2013-12-25 12:32:45

Possibly related: #15585
