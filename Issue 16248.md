# Issue 16248: "TypeError: keys do not match self's parent" computing variety of MPolynomialIdeal_singular_repr

Issue created by migration from Trac.

Original creator: gagern

Original creation time: 2014-06-16 15:29:02


```
PR.<q0, q1, q2, q3, c1, c2, c3, o1, o2, o3, f> = PolynomialRing(QQ, order='lex')
i1 = PR.ideal([
        2*q0*q1*c2*f - 2*q0*q1*o2*f + 2*q1^2*c3*f - 2*q1^2*o3*f + 2*q2*q3*c2*f - 2*q2*q3*o2*f + 2*q3^2*c3*f - 2*q3^2*o3*f - c3*f + o3*f - 47,
        -2*q0*q1*c1*f + 2*q0*q1*o1*f - 2*q0*q3*c3*f + 2*q0*q3*o3*f + 2*q1*q2*c3*f - 2*q1*q2*o3*f - 2*q2*q3*c1*f + 2*q2*q3*o1*f + 54,
        2*q0*q1*c1*o2*f - 2*q0*q1*c2*o1*f - 2*q0*q3*c2*o3*f + 2*q0*q3*c3*o2*f + 2*q1^2*c1*o3*f - 2*q1^2*c3*o1*f + 2*q1*q2*c2*o3*f - 2*q1*q2*c3*o2*f + 2*q2*q3*c1*o2*f - 2*q2*q3*c2*o1*f + 2*q3^2*c1*o3*f - 2*q3^2*c3*o1*f - c1*o3*f + c3*o1*f + 121,
        2*q0*q2*c2*f - 2*q0*q2*o2*f + 2*q0*q3*c3*f - 2*q0*q3*o3*f + 2*q1*q2*c3*f - 2*q1*q2*o3*f - 2*q1*q3*c2*f + 2*q1*q3*o2*f + 4,
        -2*q0*q2*c1*f + 2*q0*q2*o1*f + 2*q1*q3*c1*f - 2*q1*q3*o1*f + 2*q2^2*c3*f - 2*q2^2*o3*f + 2*q3^2*c3*f - 2*q3^2*o3*f - c3*f + o3*f + 22,
        2*q0*q2*c1*o2*f - 2*q0*q2*c2*o1*f + 2*q0*q3*c1*o3*f - 2*q0*q3*c3*o1*f + 2*q1*q2*c1*o3*f - 2*q1*q2*c3*o1*f - 2*q1*q3*c1*o2*f + 2*q1*q3*c2*o1*f + 2*q2^2*c2*o3*f - 2*q2^2*c3*o2*f + 2*q3^2*c2*o3*f - 2*q3^2*c3*o2*f - c2*o3*f + c3*o2*f + 3,
        2*q0*q2*f + 2*q1*q3*f + 20,
        -2*q0*q1*f + 2*q2*q3*f - 15,
        2*q0*q1*c2*f - 2*q0*q2*c1*f + 2*q1^2*c3*f - 2*q1*q3*c1*f + 2*q2^2*c3*f - 2*q2*q3*c2*f - c3*f - 85,
        q0^2 + q1^2 + q2^2 + q3^2 - 1,
        c3 - 3,
    ])
i1.variety(QQbar)
```


Trying to compute a variety of some ideal, I get an error message instead:


```
Traceback (most recent call last):
  File "/projects/3629be9c-d6c4-4013-a305-69c083e264d0/.sagemathcloud/sage_server.py", line 734, in execute
    exec compile(block+'\n', '', 'single') in namespace, locals
  File "", line 1, in <module>
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 604, in __call__
    return self.f(self._instance, *args, **kwds)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2647, in variety
    Vbar = _variety(list(t),[])
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2619, in _variety
    Tbar = [ f.subs({variable:root}) for f in T ]
  File "multi_polynomial_libsingular.pyx", line 3298, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22723)
TypeError: keys do not match self's parent
```


So far I haven't managed to find a smaller reproducing example.


---

Comment by gagern created at 2014-06-16 15:43:46

Changing type from PLEASE CHANGE to defect.


---

Comment by gagern created at 2014-06-16 15:43:46

Changing component from PLEASE CHANGE to algebra.


---

Comment by gagern created at 2014-06-16 16:36:10

I found a shorter reproducing example.


---

Comment by gagern created at 2014-06-16 21:32:50

I guess I have an idea as to what's going on here now. The first generator causes `c` to assume a non-rational value. As a consequence, the second generator will change its base ring from `QQ` to `QQbar`. The third generator does not contain `c`, so its base ring remains `QQ`. Now `b` is chosen as the next variable. Its parent is the ring over `QQbar`, since it got chosen from the second generator. However, it can't be substituted into the third generator since the parent for that doesn't match.

I guess one solution would be changing all polynomials to the target ring up front. I'll try to write a fix for this.


---

Comment by gagern created at 2014-06-16 21:53:48

Changing status from new to needs_review.


---

Comment by gagern created at 2014-06-16 21:53:48

OK, here is my suggested solution. There might be some performance penalty for converting polynomials that don't need it, but I consider this a rare scenario and not worth the hassle we'd get from dealing with mixed polynomial rings.
----
New commits:


---

Comment by malb created at 2014-06-25 01:13:20

looks fine to me


---

Comment by malb created at 2014-06-25 01:13:20

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2014-06-25 04:18:41

Changing keywords from "" to "sd59".


---

Comment by tscrim created at 2014-06-25 04:18:41

Forgotten author name.


---

Comment by gagern created at 2014-06-25 05:57:15

I see no contribution from Julian here, and since the code changes are mine, I guess I should be the author here. Let me know if I misunderstood something.


---

Comment by tscrim created at 2014-06-25 12:55:36

Sorry Martin von Gagem, I got my tickets crossed.


---

Comment by vbraun created at 2014-06-26 01:50:36

Resolution: fixed
