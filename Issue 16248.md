# Issue 16248: "TypeError: keys do not match self's parent" computing variety of MPolynomialIdeal_singular_repr

archive/issues_016248.json:
```json
{
    "body": "\n```\nPR.<q0, q1, q2, q3, c1, c2, c3, o1, o2, o3, f> = PolynomialRing(QQ, order='lex')\ni1 = PR.ideal([\n        2*q0*q1*c2*f - 2*q0*q1*o2*f + 2*q1^2*c3*f - 2*q1^2*o3*f + 2*q2*q3*c2*f - 2*q2*q3*o2*f + 2*q3^2*c3*f - 2*q3^2*o3*f - c3*f + o3*f - 47,\n        -2*q0*q1*c1*f + 2*q0*q1*o1*f - 2*q0*q3*c3*f + 2*q0*q3*o3*f + 2*q1*q2*c3*f - 2*q1*q2*o3*f - 2*q2*q3*c1*f + 2*q2*q3*o1*f + 54,\n        2*q0*q1*c1*o2*f - 2*q0*q1*c2*o1*f - 2*q0*q3*c2*o3*f + 2*q0*q3*c3*o2*f + 2*q1^2*c1*o3*f - 2*q1^2*c3*o1*f + 2*q1*q2*c2*o3*f - 2*q1*q2*c3*o2*f + 2*q2*q3*c1*o2*f - 2*q2*q3*c2*o1*f + 2*q3^2*c1*o3*f - 2*q3^2*c3*o1*f - c1*o3*f + c3*o1*f + 121,\n        2*q0*q2*c2*f - 2*q0*q2*o2*f + 2*q0*q3*c3*f - 2*q0*q3*o3*f + 2*q1*q2*c3*f - 2*q1*q2*o3*f - 2*q1*q3*c2*f + 2*q1*q3*o2*f + 4,\n        -2*q0*q2*c1*f + 2*q0*q2*o1*f + 2*q1*q3*c1*f - 2*q1*q3*o1*f + 2*q2^2*c3*f - 2*q2^2*o3*f + 2*q3^2*c3*f - 2*q3^2*o3*f - c3*f + o3*f + 22,\n        2*q0*q2*c1*o2*f - 2*q0*q2*c2*o1*f + 2*q0*q3*c1*o3*f - 2*q0*q3*c3*o1*f + 2*q1*q2*c1*o3*f - 2*q1*q2*c3*o1*f - 2*q1*q3*c1*o2*f + 2*q1*q3*c2*o1*f + 2*q2^2*c2*o3*f - 2*q2^2*c3*o2*f + 2*q3^2*c2*o3*f - 2*q3^2*c3*o2*f - c2*o3*f + c3*o2*f + 3,\n        2*q0*q2*f + 2*q1*q3*f + 20,\n        -2*q0*q1*f + 2*q2*q3*f - 15,\n        2*q0*q1*c2*f - 2*q0*q2*c1*f + 2*q1^2*c3*f - 2*q1*q3*c1*f + 2*q2^2*c3*f - 2*q2*q3*c2*f - c3*f - 85,\n        q0^2 + q1^2 + q2^2 + q3^2 - 1,\n        c3 - 3,\n    ])\ni1.variety(QQbar)\n```\n\n\nTrying to compute a variety of some ideal, I get an error message instead:\n\n\n```\nTraceback (most recent call last):\n  File \"/projects/3629be9c-d6c4-4013-a305-69c083e264d0/.sagemathcloud/sage_server.py\", line 734, in execute\n    exec compile(block+'\\n', '', 'single') in namespace, locals\n  File \"\", line 1, in <module>\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 604, in __call__\n    return self.f(self._instance, *args, **kwds)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2647, in variety\n    Vbar = _variety(list(t),[])\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2620, in _variety\n    _variety(Tbar,V,vbar)\n  File \"/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2619, in _variety\n    Tbar = [ f.subs({variable:root}) for f in T ]\n  File \"multi_polynomial_libsingular.pyx\", line 3298, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22723)\nTypeError: keys do not match self's parent\n```\n\n\nSo far I haven't managed to find a smaller reproducing example.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16485\n\n",
    "created_at": "2014-06-16T15:29:02Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "\"TypeError: keys do not match self's parent\" computing variety of MPolynomialIdeal_singular_repr",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16248",
    "user": "https://github.com/gagern"
}
```

```
PR.<q0, q1, q2, q3, c1, c2, c3, o1, o2, o3, f> = PolynomialRing(QQ, order='lex')
i1 = PR.ideal([
        2*q0*q1*c2*f - 2*q0*q1*o2*f + 2*q1^2*c3*f - 2*q1^2*o3*f + 2*q2*q3*c2*f - 2*q2*q3*o2*f + 2*q3^2*c3*f - 2*q3^2*o3*f - c3*f + o3*f - 47,
        -2*q0*q1*c1*f + 2*q0*q1*o1*f - 2*q0*q3*c3*f + 2*q0*q3*o3*f + 2*q1*q2*c3*f - 2*q1*q2*o3*f - 2*q2*q3*c1*f + 2*q2*q3*o1*f + 54,
        2*q0*q1*c1*o2*f - 2*q0*q1*c2*o1*f - 2*q0*q3*c2*o3*f + 2*q0*q3*c3*o2*f + 2*q1^2*c1*o3*f - 2*q1^2*c3*o1*f + 2*q1*q2*c2*o3*f - 2*q1*q2*c3*o2*f + 2*q2*q3*c1*o2*f - 2*q2*q3*c2*o1*f + 2*q3^2*c1*o3*f - 2*q3^2*c3*o1*f - c1*o3*f + c3*o1*f + 121,
        2*q0*q2*c2*f - 2*q0*q2*o2*f + 2*q0*q3*c3*f - 2*q0*q3*o3*f + 2*q1*q2*c3*f - 2*q1*q2*o3*f - 2*q1*q3*c2*f + 2*q1*q3*o2*f + 4,
        -2*q0*q2*c1*f + 2*q0*q2*o1*f + 2*q1*q3*c1*f - 2*q1*q3*o1*f + 2*q2^2*c3*f - 2*q2^2*o3*f + 2*q3^2*c3*f - 2*q3^2*o3*f - c3*f + o3*f + 22,
        2*q0*q2*c1*o2*f - 2*q0*q2*c2*o1*f + 2*q0*q3*c1*o3*f - 2*q0*q3*c3*o1*f + 2*q1*q2*c1*o3*f - 2*q1*q2*c3*o1*f - 2*q1*q3*c1*o2*f + 2*q1*q3*c2*o1*f + 2*q2^2*c2*o3*f - 2*q2^2*c3*o2*f + 2*q3^2*c2*o3*f - 2*q3^2*c3*o2*f - c2*o3*f + c3*o2*f + 3,
        2*q0*q2*f + 2*q1*q3*f + 20,
        -2*q0*q1*f + 2*q2*q3*f - 15,
        2*q0*q1*c2*f - 2*q0*q2*c1*f + 2*q1^2*c3*f - 2*q1*q3*c1*f + 2*q2^2*c3*f - 2*q2*q3*c2*f - c3*f - 85,
        q0^2 + q1^2 + q2^2 + q3^2 - 1,
        c3 - 3,
    ])
i1.variety(QQbar)
```


Trying to compute a variety of some ideal, I get an error message instead:


```
Traceback (most recent call last):
  File "/projects/3629be9c-d6c4-4013-a305-69c083e264d0/.sagemathcloud/sage_server.py", line 734, in execute
    exec compile(block+'\n', '', 'single') in namespace, locals
  File "", line 1, in <module>
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 604, in __call__
    return self.f(self._instance, *args, **kwds)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2647, in variety
    Vbar = _variety(list(t),[])
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2620, in _variety
    _variety(Tbar,V,vbar)
  File "/usr/local/sage/sage-6.2.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2619, in _variety
    Tbar = [ f.subs({variable:root}) for f in T ]
  File "multi_polynomial_libsingular.pyx", line 3298, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.subs (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22723)
TypeError: keys do not match self's parent
```


So far I haven't managed to find a smaller reproducing example.

Issue created by migration from https://trac.sagemath.org/ticket/16485





---

archive/issue_comments_212229.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2014-06-16T15:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212229",
    "user": "https://github.com/gagern"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_212230.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebra.",
    "created_at": "2014-06-16T15:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212230",
    "user": "https://github.com/gagern"
}
```

Changing component from PLEASE CHANGE to algebra.



---

archive/issue_comments_212231.json:
```json
{
    "body": "I found a shorter reproducing example.",
    "created_at": "2014-06-16T16:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212231",
    "user": "https://github.com/gagern"
}
```

I found a shorter reproducing example.



---

archive/issue_comments_212232.json:
```json
{
    "body": "I guess I have an idea as to what's going on here now. The first generator causes `c` to assume a non-rational value. As a consequence, the second generator will change its base ring from `QQ` to `QQbar`. The third generator does not contain `c`, so its base ring remains `QQ`. Now `b` is chosen as the next variable. Its parent is the ring over `QQbar`, since it got chosen from the second generator. However, it can't be substituted into the third generator since the parent for that doesn't match.\n\nI guess one solution would be changing all polynomials to the target ring up front. I'll try to write a fix for this.",
    "created_at": "2014-06-16T21:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212232",
    "user": "https://github.com/gagern"
}
```

I guess I have an idea as to what's going on here now. The first generator causes `c` to assume a non-rational value. As a consequence, the second generator will change its base ring from `QQ` to `QQbar`. The third generator does not contain `c`, so its base ring remains `QQ`. Now `b` is chosen as the next variable. Its parent is the ring over `QQbar`, since it got chosen from the second generator. However, it can't be substituted into the third generator since the parent for that doesn't match.

I guess one solution would be changing all polynomials to the target ring up front. I'll try to write a fix for this.



---

archive/issue_comments_212233.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-06-16T21:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212233",
    "user": "https://github.com/gagern"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_212234.json:
```json
{
    "body": "OK, here is my suggested solution. There might be some performance penalty for converting polynomials that don't need it, but I consider this a rare scenario and not worth the hassle we'd get from dealing with mixed polynomial rings.\n----\nNew commits:",
    "created_at": "2014-06-16T21:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212234",
    "user": "https://github.com/gagern"
}
```

OK, here is my suggested solution. There might be some performance penalty for converting polynomials that don't need it, but I consider this a rare scenario and not worth the hassle we'd get from dealing with mixed polynomial rings.
----
New commits:



---

archive/issue_comments_212235.json:
```json
{
    "body": "looks fine to me",
    "created_at": "2014-06-25T01:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212235",
    "user": "https://github.com/malb"
}
```

looks fine to me



---

archive/issue_comments_212236.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-25T01:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212236",
    "user": "https://github.com/malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_212237.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd59\".",
    "created_at": "2014-06-25T04:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212237",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "sd59".



---

archive/issue_comments_212238.json:
```json
{
    "body": "Forgotten author name.",
    "created_at": "2014-06-25T04:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212238",
    "user": "https://github.com/tscrim"
}
```

Forgotten author name.



---

archive/issue_comments_212239.json:
```json
{
    "body": "I see no contribution from Julian here, and since the code changes are mine, I guess I should be the author here. Let me know if I misunderstood something.",
    "created_at": "2014-06-25T05:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212239",
    "user": "https://github.com/gagern"
}
```

I see no contribution from Julian here, and since the code changes are mine, I guess I should be the author here. Let me know if I misunderstood something.



---

archive/issue_comments_212240.json:
```json
{
    "body": "Sorry Martin von Gagem, I got my tickets crossed.",
    "created_at": "2014-06-25T12:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212240",
    "user": "https://github.com/tscrim"
}
```

Sorry Martin von Gagem, I got my tickets crossed.



---

archive/issue_comments_212241.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-26T01:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16248#issuecomment-212241",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048449.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-26T01:50:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16248",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16248#event-48449"
}
```
