# Issue 12634: upgrade of spkg networkx-1.2.p2 to 1.6

archive/issues_012634.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\nCC:  @kini @kiwifb brunellus @nathanncohen\n\nKeywords: spkg networkx graphs\n\nWhen upgrading the networkx package to 1.6, there arise a lot of doctest errors, see discussion on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/60e2704e68cad4f4).\nThis ticket should contain everything that is necessary to do so.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12806\n\n",
    "created_at": "2012-04-03T23:15:36Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.2",
    "title": "upgrade of spkg networkx-1.2.p2 to 1.6",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12634",
    "user": "https://github.com/dkrenn"
}
```
Assignee: jason, ncohen, rlm

CC:  @kini @kiwifb brunellus @nathanncohen

Keywords: spkg networkx graphs

When upgrading the networkx package to 1.6, there arise a lot of doctest errors, see discussion on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/60e2704e68cad4f4).
This ticket should contain everything that is necessary to do so.

Issue created by migration from https://trac.sagemath.org/ticket/12806





---

archive/issue_comments_150177.json:
```json
{
    "body": "I made a package networkx-1.6, which is available [here](http://www.math.tugraz.at/~krenn/whatever/networkx-1.6.spkg). \n\nThere are a lot of doctests failing in sage.graphs.",
    "created_at": "2012-04-03T23:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150177",
    "user": "https://github.com/dkrenn"
}
```

I made a package networkx-1.6, which is available [here](http://www.math.tugraz.at/~krenn/whatever/networkx-1.6.spkg). 

There are a lot of doctests failing in sage.graphs.



---

archive/issue_comments_150178.json:
```json
{
    "body": "The failing tests in graph.py are due to an API change in the betweenness_centrality function.\nThey get fixed by replacing\n\n```\n    return networkx.betweenness_centrality(self.networkx_graph(copy=False), normalized)\n```\n\nin line 3252 of SAGE_ROOT/devel/sage-main/sage/graphs/graph.py by\n\n```\n    return networkx.betweenness_centrality(self.networkx_graph(copy=False), normalized = normalized)\n```\n\nI will take a look at the rest of the failing tests tomorrow and write a patch.",
    "created_at": "2012-06-13T16:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150178",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

The failing tests in graph.py are due to an API change in the betweenness_centrality function.
They get fixed by replacing

```
    return networkx.betweenness_centrality(self.networkx_graph(copy=False), normalized)
```

in line 3252 of SAGE_ROOT/devel/sage-main/sage/graphs/graph.py by

```
    return networkx.betweenness_centrality(self.networkx_graph(copy=False), normalized = normalized)
```

I will take a look at the rest of the failing tests tomorrow and write a patch.



---

archive/issue_comments_150179.json:
```json
{
    "body": "The failing test in digraph.py is an improvement. In older versions of NetworkX `topological_sort_recursive` had a problem that has since been sorted out. The failing test was showcasing a bug that is not there anymore. This is also good news since we can also expose the recursive implementation of topological sorts in sage.",
    "created_at": "2012-06-14T10:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150179",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

The failing test in digraph.py is an improvement. In older versions of NetworkX `topological_sort_recursive` had a problem that has since been sorted out. The failing test was showcasing a bug that is not there anymore. This is also good news since we can also expose the recursive implementation of topological sorts in sage.



---

archive/issue_comments_150180.json:
```json
{
    "body": "All but two of the failing tests in `graph_generators.py` are due to extreme cases of balanced trees (degree 1, height 0), that didn't use to be allowed before and now degenerate gracefully. So this problem gets sorted out just by removing the offending doctests. As a nice side-effect, the offending tests took most of the testing time before. After removing them time for running the tests in `graph_generators.py` drops for me from 357s to 18s.",
    "created_at": "2012-06-14T11:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150180",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

All but two of the failing tests in `graph_generators.py` are due to extreme cases of balanced trees (degree 1, height 0), that didn't use to be allowed before and now degenerate gracefully. So this problem gets sorted out just by removing the offending doctests. As a nice side-effect, the offending tests took most of the testing time before. After removing them time for running the tests in `graph_generators.py` drops for me from 357s to 18s.



---

archive/issue_comments_150181.json:
```json
{
    "body": "The two remaining doctests in `graph_generators.py` are due to changes in two randomized methods: a change in `networkx.powerlaw_cluster_graph` from using `random.random` to `_random_subset` and a rewriting of the random method `expected_degree_graph`. Since the functions called in the doctests have a randomized nature it is not unreasonable to expect the results to change after the randomized function is rewritten. Unless somebody complains I will just update the tests to the results with the new methods.",
    "created_at": "2012-06-14T13:44:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150181",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

The two remaining doctests in `graph_generators.py` are due to changes in two randomized methods: a change in `networkx.powerlaw_cluster_graph` from using `random.random` to `_random_subset` and a rewriting of the random method `expected_degree_graph`. Since the functions called in the doctests have a randomized nature it is not unreasonable to expect the results to change after the randomized function is rewritten. Unless somebody complains I will just update the tests to the results with the new methods.



---

archive/issue_comments_150182.json:
```json
{
    "body": "Attachment [trac_12806_doctest_fixes.patch](tarball://root/attachments/some-uuid/ticket12806/trac_12806_doctest_fixes.patch) by jlopez created at 2012-06-14 16:20:31\n\nAdded a patch with the necessary changes for the doctests. All tests pass in my system. To review this patch you need to install the spkg by Daniel Krenn in the first comment and then apply the patch.",
    "created_at": "2012-06-14T16:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150182",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Attachment [trac_12806_doctest_fixes.patch](tarball://root/attachments/some-uuid/ticket12806/trac_12806_doctest_fixes.patch) by jlopez created at 2012-06-14 16:20:31

Added a patch with the necessary changes for the doctests. All tests pass in my system. To review this patch you need to install the spkg by Daniel Krenn in the first comment and then apply the patch.



---

archive/issue_comments_150183.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-06-14T16:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150183",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_150184.json:
```json
{
    "body": "I think the name (and commit message) of the patch is kind of misleading since you are actually changing code and not just fixing doctests.\n\nAnyway, the code looks good - I'm running `make ptestlong` just to make sure.",
    "created_at": "2012-06-14T16:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150184",
    "user": "https://github.com/kini"
}
```

I think the name (and commit message) of the patch is kind of misleading since you are actually changing code and not just fixing doctests.

Anyway, the code looks good - I'm running `make ptestlong` just to make sure.



---

archive/issue_comments_150185.json:
```json
{
    "body": "apply to $SAGE_ROOT/devel/sage",
    "created_at": "2012-06-14T20:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150185",
    "user": "https://github.com/kini"
}
```

apply to $SAGE_ROOT/devel/sage



---

archive/issue_comments_150186.json:
```json
{
    "body": "Attachment [trac_12806.reviewer.patch](tarball://root/attachments/some-uuid/ticket12806/trac_12806.reviewer.patch) by @kini created at 2012-06-14 20:45:43\n\nI fixed a doctest that was failing (deprecation warnings only appear once per session). I also took the liberty of fixing formatting and trailing whitespace in the functions you touched :)\n\npatchbot: apply trac_12806_doctest_fixes.patch trac_12806.reviewer.patch",
    "created_at": "2012-06-14T20:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150186",
    "user": "https://github.com/kini"
}
```

Attachment [trac_12806.reviewer.patch](tarball://root/attachments/some-uuid/ticket12806/trac_12806.reviewer.patch) by @kini created at 2012-06-14 20:45:43

I fixed a doctest that was failing (deprecation warnings only appear once per session). I also took the liberty of fixing formatting and trailing whitespace in the functions you touched :)

patchbot: apply trac_12806_doctest_fixes.patch trac_12806.reviewer.patch



---

archive/issue_comments_150187.json:
```json
{
    "body": "If you agree with the reviewer patch, I'll set this to positive review.",
    "created_at": "2012-06-14T20:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150187",
    "user": "https://github.com/kini"
}
```

If you agree with the reviewer patch, I'll set this to positive review.



---

archive/issue_comments_150188.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-15T08:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150188",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_150189.json:
```json
{
    "body": "Thanks for the prompt response, Keshav! The reviewer patch looks good to me, so I guess we can consider this reviewed!\n\nNow it is time for all the graph people to start doing cool stuff with all the great functionalities of NetworkX we have been missing out! :-D",
    "created_at": "2012-06-15T08:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150189",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Thanks for the prompt response, Keshav! The reviewer patch looks good to me, so I guess we can consider this reviewed!

Now it is time for all the graph people to start doing cool stuff with all the great functionalities of NetworkX we have been missing out! :-D



---

archive/issue_comments_150190.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-06-28T11:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150190",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_150191.json:
```json
{
    "body": "The documentation doesn't build correctly.  I've lost the exact warning/error messages though.",
    "created_at": "2012-06-28T11:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150191",
    "user": "https://github.com/jdemeyer"
}
```

The documentation doesn't build correctly.  I've lost the exact warning/error messages though.



---

archive/issue_comments_150192.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-07-03T12:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150192",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_150193.json:
```json
{
    "body": "I think the documentation building problem is fixed; `sage --docbuild reference pdf` gives me no errors. Needs review just for the docbuild patch.",
    "created_at": "2012-07-03T12:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150193",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

I think the documentation building problem is fixed; `sage --docbuild reference pdf` gives me no errors. Needs review just for the docbuild patch.



---

archive/issue_comments_150194.json:
```json
{
    "body": "patchbot: apply trac_12806_doctest_fixes.patch trac_12806.reviewer.patch trac_12806_docbuild_fix.patch",
    "created_at": "2012-07-03T15:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150194",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

patchbot: apply trac_12806_doctest_fixes.patch trac_12806.reviewer.patch trac_12806_docbuild_fix.patch



---

archive/issue_comments_150195.json:
```json
{
    "body": "I'm not sure what you did, but the third patch does not apply - pretty obviously, it is not based on the reviewer patch.  Needs work.  I may put something together quickly for this.",
    "created_at": "2012-07-04T13:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150195",
    "user": "https://github.com/kcrisman"
}
```

I'm not sure what you did, but the third patch does not apply - pretty obviously, it is not based on the reviewer patch.  Needs work.  I may put something together quickly for this.



---

archive/issue_comments_150196.json:
```json
{
    "body": "There were a few other build errors, and incorrect linking syntax.  I'll fix these.\n\nAlso, is \n\n```\nequivalent to ``weight = weight``\n```\n\nsupposed to be\n\n```\nequivalent to ``weight = 'weight'``\n```\n\nsince weight takes a boolean or a string?",
    "created_at": "2012-07-04T13:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150196",
    "user": "https://github.com/kcrisman"
}
```

There were a few other build errors, and incorrect linking syntax.  I'll fix these.

Also, is 

```
equivalent to ``weight = weight``
```

supposed to be

```
equivalent to ``weight = 'weight'``
```

since weight takes a boolean or a string?



---

archive/issue_comments_150197.json:
```json
{
    "body": "Thanks for jumping in!\n\nI must have messed up my patch queue at some stage. I am building a clean version of sage right now, will made a new patch on top of it if you don't beat me to it.\n\nReplying to [comment:22 kcrisman]:\n> Also, is \n> {{{\n> equivalent to ``weight = weight``\n> }}}\n> supposed to be\n> {{{\n> equivalent to ``weight = 'weight'``\n> }}}\n> since weight takes a boolean or a string?\n\nThat's right, nice catch.\nThanks again for your help!",
    "created_at": "2012-07-04T14:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150197",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Thanks for jumping in!

I must have messed up my patch queue at some stage. I am building a clean version of sage right now, will made a new patch on top of it if you don't beat me to it.

Replying to [comment:22 kcrisman]:
> Also, is 
> {{{
> equivalent to ``weight = weight``
> }}}
> supposed to be
> {{{
> equivalent to ``weight = 'weight'``
> }}}
> since weight takes a boolean or a string?

That's right, nice catch.
Thanks again for your help!



---

archive/issue_comments_150198.json:
```json
{
    "body": "Attachment [trac_12806-docbuild-and-links-alt.patch](tarball://root/attachments/some-uuid/ticket12806/trac_12806-docbuild-and-links-alt.patch) by @kcrisman created at 2012-07-04 14:32:19\n\napply if weight='weight'",
    "created_at": "2012-07-04T14:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150198",
    "user": "https://github.com/kcrisman"
}
```

Attachment [trac_12806-docbuild-and-links-alt.patch](tarball://root/attachments/some-uuid/ticket12806/trac_12806-docbuild-and-links-alt.patch) by @kcrisman created at 2012-07-04 14:32:19

apply if weight='weight'



---

archive/issue_comments_150199.json:
```json
{
    "body": "Ok, I didn't see your message, so we'll go with the alt patch.\n\nPatchbot:\n\nApply [attachment:trac_12806_doctest_fixes.patch], [attachment:trac_12806.reviewer.patch] and [attachment:trac_12806-docbuild-and-links-alt.patch]",
    "created_at": "2012-07-04T14:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150199",
    "user": "https://github.com/kcrisman"
}
```

Ok, I didn't see your message, so we'll go with the alt patch.

Patchbot:

Apply [attachment:trac_12806_doctest_fixes.patch], [attachment:trac_12806.reviewer.patch] and [attachment:trac_12806-docbuild-and-links-alt.patch]



---

archive/issue_comments_150200.json:
```json
{
    "body": "`@`jlopez: I'll leave it to you to give final positive review, but this should catch all of the docbuild errors, fix some links, and removed some whitespace that was right next to the stuff being changed anyway.",
    "created_at": "2012-07-04T14:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150200",
    "user": "https://github.com/kcrisman"
}
```

`@`jlopez: I'll leave it to you to give final positive review, but this should catch all of the docbuild errors, fix some links, and removed some whitespace that was right next to the stuff being changed anyway.



---

archive/issue_comments_150201.json:
```json
{
    "body": "looks good to go.",
    "created_at": "2012-07-04T16:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150201",
    "user": "https://github.com/dimpase"
}
```

looks good to go.



---

archive/issue_comments_150202.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-04T16:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150202",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_012612.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-07-07T22:30:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12634#event-12612"
}
```



---

archive/issue_comments_150203.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-07-07T22:30:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12634#issuecomment-150203",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
