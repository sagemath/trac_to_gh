# Issue 12634: upgrade of spkg networkx-1.2.p2 to 1.6

Issue created by migration from https://trac.sagemath.org/ticket/12806

Original creator: dkrenn

Original creation time: 2012-04-03 23:15:36

Assignee: jason, ncohen, rlm

CC:  kini fbissey brunellus ncohen

Keywords: spkg networkx graphs

When upgrading the networkx package to 1.6, there arise a lot of doctest errors, see discussion on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/60e2704e68cad4f4).
This ticket should contain everything that is necessary to do so.


---

Comment by dkrenn created at 2012-04-03 23:18:33

I made a package networkx-1.6, which is available [here](http://www.math.tugraz.at/~krenn/whatever/networkx-1.6.spkg). 

There are a lot of doctests failing in sage.graphs.


---

Comment by jlopez created at 2012-06-13 16:44:09

The failing tests in graph.py are due to an API change in the betweenness_centrality function.
They get fixed by replacing

```
    return networkx.betweenness_centrality(self.networkx_graph(copy=False), normalized)
```

in line 3252 of SAGE_ROOT/devel/sage-main/sage/graphs/graph.py by

```
    return networkx.betweenness_centrality(self.networkx_graph(copy=False), normalized = normalized)
```

I will take a look at the rest of the failing tests tomorrow and write a patch.


---

Comment by jlopez created at 2012-06-14 10:31:20

The failing test in digraph.py is an improvement. In older versions of NetworkX `topological_sort_recursive` had a problem that has since been sorted out. The failing test was showcasing a bug that is not there anymore. This is also good news since we can also expose the recursive implementation of topological sorts in sage.


---

Comment by jlopez created at 2012-06-14 11:57:12

All but two of the failing tests in `graph_generators.py` are due to extreme cases of balanced trees (degree 1, height 0), that didn't use to be allowed before and now degenerate gracefully. So this problem gets sorted out just by removing the offending doctests. As a nice side-effect, the offending tests took most of the testing time before. After removing them time for running the tests in `graph_generators.py` drops for me from 357s to 18s.


---

Comment by jlopez created at 2012-06-14 13:44:35

The two remaining doctests in `graph_generators.py` are due to changes in two randomized methods: a change in `networkx.powerlaw_cluster_graph` from using `random.random` to `_random_subset` and a rewriting of the random method `expected_degree_graph`. Since the functions called in the doctests have a randomized nature it is not unreasonable to expect the results to change after the randomized function is rewritten. Unless somebody complains I will just update the tests to the results with the new methods.


---

Attachment

Added a patch with the necessary changes for the doctests. All tests pass in my system. To review this patch you need to install the spkg by Daniel Krenn in the first comment and then apply the patch.


---

Comment by jlopez created at 2012-06-14 16:35:30

Changing status from new to needs_review.


---

Comment by kini created at 2012-06-14 16:58:24

I think the name (and commit message) of the patch is kind of misleading since you are actually changing code and not just fixing doctests.

Anyway, the code looks good - I'm running `make ptestlong` just to make sure.


---

Comment by kini created at 2012-06-14 20:42:39

apply to $SAGE_ROOT/devel/sage


---

Attachment

I fixed a doctest that was failing (deprecation warnings only appear once per session). I also took the liberty of fixing formatting and trailing whitespace in the functions you touched :)

patchbot: apply trac_12806_doctest_fixes.patch trac_12806.reviewer.patch


---

Comment by kini created at 2012-06-14 20:47:48

If you agree with the reviewer patch, I'll set this to positive review.


---

Comment by jlopez created at 2012-06-15 08:22:10

Changing status from needs_review to positive_review.


---

Comment by jlopez created at 2012-06-15 08:22:10

Thanks for the prompt response, Keshav! The reviewer patch looks good to me, so I guess we can consider this reviewed!

Now it is time for all the graph people to start doing cool stuff with all the great functionalities of NetworkX we have been missing out! :-D


---

Comment by jdemeyer created at 2012-06-28 11:41:51

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-06-28 11:41:51

The documentation doesn't build correctly.  I've lost the exact warning/error messages though.


---

Comment by jlopez created at 2012-07-03 12:05:13

Changing status from needs_work to needs_review.


---

Comment by jlopez created at 2012-07-03 12:05:13

I think the documentation building problem is fixed; `sage --docbuild reference pdf` gives me no errors. Needs review just for the docbuild patch.


---

Comment by jlopez created at 2012-07-03 15:22:43

patchbot: apply trac_12806_doctest_fixes.patch trac_12806.reviewer.patch trac_12806_docbuild_fix.patch


---

Comment by kcrisman created at 2012-07-04 13:37:00

I'm not sure what you did, but the third patch does not apply - pretty obviously, it is not based on the reviewer patch.  Needs work.  I may put something together quickly for this.


---

Comment by kcrisman created at 2012-07-04 13:50:10

There were a few other build errors, and incorrect linking syntax.  I'll fix these.

Also, is 

```
equivalent to ``weight = weight``
```

supposed to be

```
equivalent to ``weight = 'weight'``
```

since weight takes a boolean or a string?


---

Comment by jlopez created at 2012-07-04 14:18:52

Thanks for jumping in!

I must have messed up my patch queue at some stage. I am building a clean version of sage right now, will made a new patch on top of it if you don't beat me to it.

Replying to [comment:22 kcrisman]:
> Also, is 
> {{{
> equivalent to ``weight = weight``
> }}}
> supposed to be
> {{{
> equivalent to ``weight = 'weight'``
> }}}
> since weight takes a boolean or a string?

That's right, nice catch.
Thanks again for your help!


---

Attachment

apply if weight='weight'


---

Comment by kcrisman created at 2012-07-04 14:34:37

Ok, I didn't see your message, so we'll go with the alt patch.

Patchbot:

Apply [attachment:trac_12806_doctest_fixes.patch], [attachment:trac_12806.reviewer.patch] and [attachment:trac_12806-docbuild-and-links-alt.patch]


---

Comment by kcrisman created at 2012-07-04 14:36:32

`@`jlopez: I'll leave it to you to give final positive review, but this should catch all of the docbuild errors, fix some links, and removed some whitespace that was right next to the stuff being changed anyway.


---

Comment by dimpase created at 2012-07-04 16:00:05

looks good to go.


---

Comment by dimpase created at 2012-07-04 16:00:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-07-07 22:30:05

Resolution: fixed
