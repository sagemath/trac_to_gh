# Issue 14161: One doctest in cmdline.py is too touchy with respect to the shebang

Issue created by migration from Trac.

Original creator: Snark

Original creation time: 2013-03-27 08:56:34

Assignee: mvngu

CC:  fbissey

In cmdline.py, one of the doctest checks the exact shebang of ipython ; the attached patch checks there is a shebang trying to run python, but doesn't check exactly how python is run.


---

Comment by Snark created at 2013-03-27 08:57:16

Patch


---

Comment by Snark created at 2013-03-27 08:57:28

Changing status from new to needs_review.


---

Attachment


---

Comment by leif created at 2013-03-27 12:46:26

Well, your patch doesn't really fit

```

    Check that ``sage-location`` did its job in making Python scripts
    relative.  We test it on the ``ipython`` script::

```


Furthermore, for Sage-on-foo, there might not even be a `$SAGE_LOCAL/bin/ipython` [script], so I think the whole test should be changed.


---

Comment by leif created at 2013-03-27 12:46:26

Changing keywords from "" to "packaging".


---

Comment by Snark created at 2013-03-27 16:27:15

Should I rewrite the patch to just remove that test?


---

Comment by leif created at 2013-03-27 16:33:29

Replying to [comment:3 Snark]:
> Should I rewrite the patch to just remove that test?

Just take another script from `$SAGE_LOCAL/bin/` which is unlikely to use some system-wide version / differ in "repackaged" Sage releases?

Why at all did the test fail for you?


---

Comment by Snark created at 2013-03-27 16:36:31

In debian, ipython starts with:

```
  #! /usr/bin/python
```



---

Comment by leif created at 2013-03-27 17:21:38

Replying to [comment:5 Snark]:
> In debian, ipython starts with:
> {{{
>   #! /usr/bin/python
> }}}

Which is just stupid.  Orthogonal to that, why should Debian's `ipython` script be in `$SAGE_LOCAL/bin/`?


---

Comment by fbissey created at 2013-03-27 17:26:04

But has in sage-on-gentoo SAGE_LOCAL is probably set to /usr. cmdline.py is full of stuff that fail on sage-on-gentoo a lot of them we just  don't really think of fixing.


---

Comment by leif created at 2013-03-27 17:35:03

Replying to [comment:7 fbissey]:
> But has in sage-on-gentoo SAGE_LOCAL is probably set to /usr. cmdline.py is full of stuff that fail on sage-on-gentoo a lot of them we just  don't really think of fixing.

IMHO Sage just shouldn't contain such too specific tests.


---

Comment by Snark created at 2013-03-27 17:44:24

Sage contains :
 1. test for features
 2. test for very specific tests (on places of files, on very specific version of various things)

The first are important. The others wouldn't be a problem if they were all in the same file, which distributions could then not package and not suffer through. But they're scattered everywhere!


---

Comment by fbissey created at 2013-03-27 20:22:26

Just for fun that's what fails in sage-on-gentoo after we patch most of what we care of

```
sage -t -long "devel/sage-main/sage/tests/cmdline.py"       
**********************************************************************
File "/usr/share/sage/devel/sage-main/sage/tests/cmdline.py", line 196:
    sage: ret
Expected:
    0
Got:
    1
**********************************************************************
File "/usr/share/sage/devel/sage-main/sage/tests/cmdline.py", line 217:
    sage: print out
Expected:
    Found package sqlalchemy in spkg/standard/sqlalchemy-...spkg
    = SQLAlchemy =
    ...
    SQLAlchemy is the Python SQL toolkit...
Got:
    sage-run received unknown option: --info 
    usage: sage [options]
    Try 'sage -h' for more information.
    <BLANKLINE>
**********************************************************************
File "/usr/share/sage/devel/sage-main/sage/tests/cmdline.py", line 224:
    sage: ret
Expected:
    0
Got:
    1
**********************************************************************
File "/usr/share/sage/devel/sage-main/sage/tests/cmdline.py", line 347:
    sage: print err
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    <BLANKLINE>
**********************************************************************
File "/usr/share/sage/devel/sage-main/sage/tests/cmdline.py", line 352:
    sage: print err
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    Traceback (most recent call last):
      File "/usr//bin/sage-ptest", line 446, in <module>
        p = multiprocessing.Pool(numthreads)
      File "/usr/lib64/python2.7/multiprocessing/__init__.py", line 232, in Pool
        return Pool(processes, initializer, initargs, maxtasksperchild)
      File "/usr/lib64/python2.7/multiprocessing/pool.py", line 129, in __init__
        raise ValueError("Number of processes must be at least 1")
    ValueError: Number of processes must be at least 1
    <BLANKLINE>
**********************************************************************
```

I'd like to dig the problem with the value from "ret" in 2 tests. The sqlalchemy tests really duplicate testing in another part of sage I am sure. My solution for that will be to eventually remove it surgically since the only sage spkg handling functionality that it is working and intend to keep is to produce spkg.


---

Comment by Snark created at 2013-03-27 21:52:57

Oh, that one:

```
File "/usr/share/sage/devel/sage-main/sage/tests/cmdline.py", line 347:
    sage: print err
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    <BLANKLINE>
```

I have two like this in cmdline.py and another one in control.py.

And I have a few other places where sage expects an error and doesn't... like a place where it deliberately asks something about a polytope in dimension 7 to a palp program which is supposed to work in dimension at most 6... as debian's (future) palp package goes up to eleven [because sage goes as far], the test fails because the computation actually works.

But let's get back to this ticket : what do you propose it should test? I don't think there is such a thing as "another script from $SAGE_LOCAL/bin/ which is unlikely to use some system-wide version / differ in "repackaged" Sage releases" as Leif put it...


---

Comment by fbissey created at 2013-03-27 22:10:44

To be brutally honest this file probably can be completely dropped from a binary distro. It is only testing that the various options of the sage command line behave as expected. There is no functionality in here.


---

Comment by jdemeyer created at 2013-04-28 22:12:15

The patch simply destroys the whole point of the test, so it surely isn't acceptable.


---

Comment by jdemeyer created at 2013-04-28 22:12:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-04-28 22:13:46

Replying to [comment:11 Snark]:
> I have two like this in cmdline.py and another one in control.py.
That's because upstream Python very stupidly refuses to add a patch fixing [an important security issue](http://bugs.python.org/issue16202).


---

Comment by jdemeyer created at 2013-04-28 22:18:19

Replying to [comment:9 Snark]:
> Sage contains :
>  1. test for features
>  2. test for very specific tests (on places of files, on very specific version of various things)

In reality there is also a lot of
3. tests combining a type 1 and a type 2 test

The test that this ticket is about is such a test. If it was only type 2 we could just remove it. But it's really meant as a test of type 1, namely that `sage-location` works.


---

Comment by fbissey created at 2013-05-01 10:41:43

Actually that's one of the tests we now keep in sage-on-gentoo and I don't really have a problem with it - lucky. For a binary distro you may want to drop some tests. I don't see the point in shipping and testing sage-location in that particular case. I am not talking about a bdist, I am talking about something installed by your distro package manager.


---

Comment by fbissey created at 2013-05-02 01:45:54

Well that's interesting, I will drop the test in question shortly from sage-on-gentoo. We now have
{{{#!/usr/bin/python-exec-c\n
```

which comes from the new way to handle multiple simultaneous python install at the time in Gentoo. Like I said, it won't be missed if it just test that sage-relocation did its work. We don't do that in sage-on-gentoo anyway. And I am sure you don't want to do that either in a debian package that install sage as part of the system.

While it would be nice to have sage upstream completely distro friendly, there are some divergences at the moment because of slightly different objectives. I am absolutely ready to review this as invalid. As long as sage upstream support something like "sage-relocation" it will make sense to test it. And it won't ever for a project like sage-on-foo.

If you have a sure to work, in both world, alternative to the test I would be ok with it. In the meantime I am not really willing to spend much time on it.


---

Comment by Snark created at 2015-03-19 06:19:32

Changing status from needs_work to needs_review.


---

Comment by Snark created at 2015-03-19 06:19:32

All of this discussion is outdated : debian will patch out any test which doesn't make sense.

I suggest to close as invalid/outdated/obsolete (whatever the trac name is), thanks.


---

Comment by fbissey created at 2015-03-19 06:27:59

Set to invalid.


---

Comment by fbissey created at 2015-03-19 06:27:59

Changing status from needs_review to positive_review.


---

Comment by leif created at 2015-03-19 14:48:41

Replying to [comment:23 fbissey]:
> Set to invalid.

I'm interpreting this as "`sudo` set to invalid", although that's not necessary here.


---

Comment by vbraun created at 2015-03-21 09:31:41

Resolution: invalid
