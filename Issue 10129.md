# Issue 10129: Revamp __hash__, __cmp__ and __richcmp__

archive/issues_010129.json:
```json
{
    "body": "Assignee: @robertwb\n\nCC:  @robertwb @nthiery\n\nThere are a number of confusing and non-optimal features of the way Sage currently handles hashing and comparison.\n\n* Because of Python, if you're writing a Cython class and you override one of these functions, you must redefine the others as well.  This is easy to forget and confuses new users.\n* The comparison infrastructure in sage.structure.element predates cpdef, and could be made far less confusing with cpdef.\n* hashes of parents are used extensively in the coercion framework, so speed is quite important.  But since parents are usually written in Python, the current model will always have at least a dictionary lookup (for example, in finding a cached `self.__hash`).  And often parents don't override the default hashing code and they fall back to slow `__repr__` methods.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10130\n\n",
    "created_at": "2010-10-15T07:09:10Z",
    "labels": [
        "coercion",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Revamp __hash__, __cmp__ and __richcmp__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10129",
    "user": "@roed314"
}
```
Assignee: @robertwb

CC:  @robertwb @nthiery

There are a number of confusing and non-optimal features of the way Sage currently handles hashing and comparison.

* Because of Python, if you're writing a Cython class and you override one of these functions, you must redefine the others as well.  This is easy to forget and confuses new users.
* The comparison infrastructure in sage.structure.element predates cpdef, and could be made far less confusing with cpdef.
* hashes of parents are used extensively in the coercion framework, so speed is quite important.  But since parents are usually written in Python, the current model will always have at least a dictionary lookup (for example, in finding a cached `self.__hash`).  And often parents don't override the default hashing code and they fall back to slow `__repr__` methods.

Issue created by migration from https://trac.sagemath.org/ticket/10130





---

archive/issue_comments_102327.json:
```json
{
    "body": "I don't know the best way to resolve these issues, but here are some ideas.\n* Have cpdef'd functions `_hash_`, `_cmp_` and `_richcmp_` that users will override.\n* For parents, add an attribute \"cdef public long `__hash`\".  I don't know if this should be set to self._hash_() during the parent's `__init__` method, or set to -1 and then reset upon the first call to `__hash__`.\n* For `SageObject`, have the default behavior of `_hash_()` be to return `hash(repr(self))`.  For parents, have the default value of hash depend on `self.construction()`?\n* For elements, don't cache the hash by default.\n* Have the results of ==, <, etc, depend on `_richcmp_`.  By default, have `_richcmp_` determined by a total ordering implemented by `_cmp_`.  So if you want to have partial ordering, or a different partial and total ordering, you need to implement both `_cmp_` and `_richcmp_`.\n* For parents, `_cmp_` checks first for pointer equality.  If non-equal, it compares the hashes.  If those are nonequal, returns the cmp of the hashes.  Otherwise, returns the cmp of the pointers.\n* Elements would have no default `_cmp_`, but would instead raise an error.",
    "created_at": "2010-10-15T07:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102327",
    "user": "@roed314"
}
```

I don't know the best way to resolve these issues, but here are some ideas.
* Have cpdef'd functions `_hash_`, `_cmp_` and `_richcmp_` that users will override.
* For parents, add an attribute "cdef public long `__hash`".  I don't know if this should be set to self._hash_() during the parent's `__init__` method, or set to -1 and then reset upon the first call to `__hash__`.
* For `SageObject`, have the default behavior of `_hash_()` be to return `hash(repr(self))`.  For parents, have the default value of hash depend on `self.construction()`?
* For elements, don't cache the hash by default.
* Have the results of ==, <, etc, depend on `_richcmp_`.  By default, have `_richcmp_` determined by a total ordering implemented by `_cmp_`.  So if you want to have partial ordering, or a different partial and total ordering, you need to implement both `_cmp_` and `_richcmp_`.
* For parents, `_cmp_` checks first for pointer equality.  If non-equal, it compares the hashes.  If those are nonequal, returns the cmp of the hashes.  Otherwise, returns the cmp of the pointers.
* Elements would have no default `_cmp_`, but would instead raise an error.



---

archive/issue_comments_102328.json:
```json
{
    "body": "Also, in Python 2.6, you can set A.__hash__ = None, to indicate that an object is not hashable.  We should probably do this for the various immutable types in Sage, rather than raising a type error.  I don't know if this works currently (I can't do it from the command line on a mutable matrix for example).",
    "created_at": "2010-10-15T07:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102328",
    "user": "@roed314"
}
```

Also, in Python 2.6, you can set A.__hash__ = None, to indicate that an object is not hashable.  We should probably do this for the various immutable types in Sage, rather than raising a type error.  I don't know if this works currently (I can't do it from the command line on a mutable matrix for example).



---

archive/issue_comments_102329.json:
```json
{
    "body": "Attachment [10130_basic.patch](tarball://root/attachments/some-uuid/ticket10130/10130_basic.patch) by @roed314 created at 2010-10-15 07:39:53\n\nA few hash changes.  WARNING: changes parent.pxd, so rebuilding will be slow.",
    "created_at": "2010-10-15T07:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102329",
    "user": "@roed314"
}
```

Attachment [10130_basic.patch](tarball://root/attachments/some-uuid/ticket10130/10130_basic.patch) by @roed314 created at 2010-10-15 07:39:53

A few hash changes.  WARNING: changes parent.pxd, so rebuilding will be slow.



---

archive/issue_comments_102330.json:
```json
{
    "body": "As an example of the speed gains possible, this patch resolves #9886.",
    "created_at": "2010-10-15T07:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102330",
    "user": "@roed314"
}
```

As an example of the speed gains possible, this patch resolves #9886.



---

archive/issue_comments_102331.json:
```json
{
    "body": "Just a quick note: for parents that use UniqueRepresentation, the hash is given by the id of the object; one can't be much faster (except that UniqueRepresentation is not Cython'ed yet):\n\n\n```\n\n   F = CombinatorialFreeModule(QQ,QQ)\n   sage: F.__hash__()\n   98169392\n   sage: id(F)\n   98169392\n```\n\n\nOther than that, I am all for improvements in this direction, because at this stage I am still confused about what I should do when I want to implement a partially ordered set in Python. Besides it would be best if it was possible to implement such partial orders in categories (remember that element methods defined in categories are overridden by methods defined in concrete classes like Element).",
    "created_at": "2011-03-28T13:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102331",
    "user": "@nthiery"
}
```

Just a quick note: for parents that use UniqueRepresentation, the hash is given by the id of the object; one can't be much faster (except that UniqueRepresentation is not Cython'ed yet):


```

   F = CombinatorialFreeModule(QQ,QQ)
   sage: F.__hash__()
   98169392
   sage: id(F)
   98169392
```


Other than that, I am all for improvements in this direction, because at this stage I am still confused about what I should do when I want to implement a partially ordered set in Python. Besides it would be best if it was possible to implement such partial orders in categories (remember that element methods defined in categories are overridden by methods defined in concrete classes like Element).



---

archive/issue_comments_102332.json:
```json
{
    "body": "Nicolas T. and I somewhat came across the second point in working on #13605. In particular, I have changed `Partition` to inherit from `Element`, use the rich comparisons, and removed the `__cmp__()` method. Thus calling things like\n\n```\nsage: sorted(Partitions(5), cmp)\n```\n\nraise the \"BUG - comparsion not implemented\" exception. This holds for any subclass of `Element` which does not implement a `__cmp__()` and does not fall back on the rich comparisons as regular python objects would.",
    "created_at": "2013-02-05T15:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102332",
    "user": "@tscrim"
}
```

Nicolas T. and I somewhat came across the second point in working on #13605. In particular, I have changed `Partition` to inherit from `Element`, use the rich comparisons, and removed the `__cmp__()` method. Thus calling things like

```
sage: sorted(Partitions(5), cmp)
```

raise the "BUG - comparsion not implemented" exception. This holds for any subclass of `Element` which does not implement a `__cmp__()` and does not fall back on the rich comparisons as regular python objects would.



---

archive/issue_comments_102333.json:
```json
{
    "body": "Related: #17890.",
    "created_at": "2015-03-04T15:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102333",
    "user": "@mezzarobba"
}
```

Related: #17890.



---

archive/issue_comments_102334.json:
```json
{
    "body": "The second item is fixed by #17890 and I guess the third is fixed #715. The first is pure Python behaviour, which I don't see an obvious solution for...",
    "created_at": "2015-03-04T16:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102334",
    "user": "@jdemeyer"
}
```

The second item is fixed by #17890 and I guess the third is fixed #715. The first is pure Python behaviour, which I don't see an obvious solution for...



---

archive/issue_comments_102335.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-29T11:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102335",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_102336.json:
```json
{
    "body": "This is a too general ticket. And most of this is actually fixed.",
    "created_at": "2016-07-29T11:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102336",
    "user": "@jdemeyer"
}
```

This is a too general ticket. And most of this is actually fixed.



---

archive/issue_comments_102337.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-29T11:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102337",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_102338.json:
```json
{
    "body": "Determined to be invalid/duplicate/wontfix (closing as \"wontfix\" as a catch-all resolution).",
    "created_at": "2016-08-30T13:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102338",
    "user": "@embray"
}
```

Determined to be invalid/duplicate/wontfix (closing as "wontfix" as a catch-all resolution).



---

archive/issue_comments_102339.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2016-08-30T13:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10129#issuecomment-102339",
    "user": "@embray"
}
```

Resolution: wontfix
