# Issue 19348: Improve efficiency of calling GAP functions

Issue created by migration from Trac.

Original creator: jaanos

Original creation time: 2015-11-14 12:40:22

CC:  vbraun ncohen dimpase




---

Comment by jaanos created at 2015-11-14 13:03:55

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jaanos created at 2015-11-14 13:03:55

Changing status from new to needs_review.


---

Comment by jaanos created at 2015-11-14 13:03:55

Changing component from PLEASE CHANGE to interfaces.


---

Comment by jaanos created at 2015-11-14 13:03:55

Changing keywords from "" to "GAP functions interface".


---

Comment by jaanos created at 2015-11-14 13:03:55

New commits:


---

Comment by tscrim created at 2015-11-14 16:13:14

This does not appear to be a universal speedup. With branch:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 432 ms, sys: 44 ms, total: 476 ms
Wall time: 507 ms

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
1000 loops, best of 3: 1.08 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: P.cardinality()
29120
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 115 ms, sys: 10.3 ms, total: 125 ms
Wall time: 296 ms
```

vs before:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 368 ms, sys: 40.4 ms, total: 408 ms
Wall time: 436 ms

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
1000 loops, best of 3: 1.02 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 139 ms, sys: 121 µs, total: 139 ms
Wall time: 264 ms
```

(For these timings, I ran it 10 times and took the best.)

Perhaps this change is asymptotically better. Could you post the group(s) you are using to test this?


---

Comment by jaanos created at 2015-11-14 19:24:49

Cubic vertex-transitive graph of order 1000, #3


---

Attachment

I have attached the sparse6 string of a graph the automorphism group of which I was working with. I guess the problem here is that the domain is very large (unlike the cases above), so actually printing and reading the result is what takes most time, rather than the computation itself.


---

Comment by tscrim created at 2015-11-15 00:17:36

I suspect the reason we are seeing a slowdown in these smaller function calls is because of the extra GAP call:

```python
if self.eval('IsIdenticalObj(__SAGE_VAL__, __SAGE_LAST__)') != 'true':
```

I think we could probably just check if `res` is non-empty:

```python
self.eval('__SAGE_LAST__ := "__SAGE_LAST__";;')
res = self.eval("%s(%s);;"%(function, ",".join([s.name() for s in args]+
                ['%s=%s'%(key,value.name()) for key, value in kwds.items()])))
if not res: # No printing was done
    if self.eval('IsIdenticalObj(last, __SAGE_LAST__)') != 'true':
        return self.new('last2')
else:
    if res.strip():
        from sage.interfaces.expect import AsciiArtString
        return AsciiArtString(res)
```



---

Comment by dimpase created at 2015-11-15 00:41:00

By the way, apart from the result the last call, `last`, GAP stores results of two previous calls, in `last2` and in `last3`.
It looks like using these might avoid doing an extra GAP call...
(`IsIdenticalObject` is not cheap in GAP)


---

Comment by tscrim created at 2015-11-15 01:03:20

Here is the above tweak (which I did some editing to) that has about a %1 slowdown of the current Sage version but doesn't do the extra printing.

Is `IsIdenticalObject` really that expensive in GAP? It seems like it would be the equivalent of `is`, and so it should be fast...
----
New commits:


---

Comment by jaanos created at 2015-11-15 10:31:11

I think we have a problem now... what if the function does print something, but also returns a value? Then we should catch the value, not the printed output (which is most likely some kind of warning).


---

Comment by jaanos created at 2015-11-15 11:21:59

I have removed the check for empty output. Since most functions we call will return a value and not print anything, there is actually one check less in these cases.

As far as `IsIdenticalObj` is concerned, it surprises me too that it should not be cheap. I don't suppose that `=` is actually cheaper?

Actually, what we could do is cut the number of times `eval` is called, by simply running the three GAP commands in one `eval`. I'll try that, and if there is any speedup from doing that, I'll push the change to this ticket.
----
New commits:


---

Comment by tscrim created at 2015-11-15 14:28:11

Replying to [comment:9 jaanos]:
> I think we have a problem now... what if the function does print something, but also returns a value? Then we should catch the value, not the printed output (which is most likely some kind of warning).

This is the current behavior in Sage, so it's not really a problem. However, with our current approach, we could print out any non-trivial print statements along with functions that print and give outputs.

Although I think we do need 2 function calls, where the second one is the current call to `IsIdenticalObject`.


---

Comment by jaanos created at 2015-11-15 17:48:32

Hi!

I've tried a few alternatives. First of all, for reference, the timings on my laptop with the develop branch (i.e., 6.10.beta4):

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 944 ms, sys: 64 ms, total: 1.01 s
Wall time: 1.33 s

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
100 loops, best of 3: 3.26 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 300 ms, sys: 40 ms, total: 340 ms
Wall time: 421 ms
```


With the current branch, there is a small slowdown when there wasn't much output to cut, as expected:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 1.08 s, sys: 120 ms, total: 1.2 s
Wall time: 1.42 s

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
100 loops, best of 3: 3.31 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 220 ms, sys: 40 ms, total: 260 ms
Wall time: 343 ms
```


I've tried removing `IsIdenticalObj`:

```python
marker1 = '"__SAGE_LAST1__"'
marker2 = '"__SAGE_LAST2__"'
self.eval('__SAGE_LAST1__ := %s;;' % marker1)
self.eval('__SAGE_LAST2__ := %s;;' % marker2)
res = self.eval("%s(%s);;"%(function, ",".join([s.name() for s in args]+
                ['%s=%s'%(key,value.name()) for key, value in kwds.items()])))
if self.eval('last2') == marker2:
    return self.new('last2')
else:
    ...
```

But it seems that `IsIdenticalObj` isn't that expensive after all:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 1.08 s, sys: 132 ms, total: 1.22 s
Wall time: 1.5 s

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
100 loops, best of 3: 3.27 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 240 ms, sys: 28 ms, total: 268 ms
Wall time: 371 ms
```


I've also tried making all calls in a single `eval`, but it seems that `last` doesn't work when used in a file. So it will probably be best to keep the latest version with `IsIdenticalObj`.

Janoš


---

Comment by tscrim created at 2015-11-15 18:41:18

By combining the two commands, I get a net speedup:

```
sage: P = groups.permutation.Symmetric(7)
sage: %timeit P.conjugacy_classes_subgroups()
1 loops, best of 3: 390 ms per loop
sage: P = groups.permutation.Symmetric(2)
sage: %timeit P.conjugacy_classes_subgroups()
100 loops, best of 3: 7.87 ms per loop
```

vs current `develop`:

```
sage: P = groups.permutation.Symmetric(7)
sage: %timeit P.conjugacy_classes_subgroups()
1 loops, best of 3: 403 ms per loop
sage: P = groups.permutation.Symmetric(2)
sage: %timeit P.conjugacy_classes_subgroups()
100 loops, best of 3: 8.08 ms per loop
```

I think we need to mitigate then number of `eval` calls that get made more so than doing the check in Sage. So if you're happy with my last change, then I'm okay with setting this to positive review.
----
New commits:


---

Comment by nbruin created at 2015-11-15 19:20:16

For solving your original problem: if communication is a bottleneck, then using libGap will probably give you the best improvements. That said, improvements in expect interfaces are of course welcome, so thanks!


---

Comment by dimpase created at 2015-11-15 20:25:09

Replying to [comment:15 nbruin]:
> For solving your original problem: if communication is a bottleneck, then using libGap will probably give you the best improvements. That said, improvements in expect interfaces are of course welcome, so thanks!

interestingly, libGAP is quite slow here.

```
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 143 ms, sys: 24 ms, total: 167 ms
Wall time: 181 ms
sage: P = libgap.SuzukiGroup(libgap.IsPermGroup,8)
sage: %time S=P.ConjugacyClassesSubgroups()
CPU times: user 220 ms, sys: 0 ns, total: 220 ms
Wall time: 220 ms
```


I guess there handling of `P` and `S` on the Sage side is not optimal...


---

Comment by nbruin created at 2015-11-15 21:22:05

Replying to [comment:16 dimpase]:
> interestingly, libGAP is quite slow here.
...
> I guess there handling of `P` and `S` on the Sage side is not optimal... 

That is one possibility. It could also be that libGap gets compiled with different optimization settings and/or that the memory manager underneath is different and affects execution. It could really be worthwhile if someone knowledgeable about libGap would run some of these examples through a profiler (gperftool perhaps?) and compare the execution profiles between Gap and libGap.


---

Comment by jaanos created at 2015-11-15 21:47:41

Hi!

> I think we need to mitigate then number of `eval` calls that get made more so than doing the check in Sage. So if you're happy with my last change, then I'm okay with setting this to positive review.

That seems like a good idea, however it fails for longer commands, when a file is used to communicate with GAP (as I said, `last` doesn't seem to work in this case). Maybe we could check the length of the command, and then decide how many `eval`s we do based on that (really short cases can be handled with a single `eval`).

Janoš


---

Comment by jaanos created at 2015-11-15 23:35:17

Hello again!

OK, I added the check for overlong function calls, and it doesn't seem to affect runnning times. Such calls would probably never happen, but we can simulate one with something like

```python
gap.function_call("ConjugacyClassesSubgroups", sage.interfaces.gap.GapElement(gap, 'SymmetricGroup(2)', name = 'a_variable_with_a_very_very_very_long_name'))
```

Without the latest commit, this would return a wrong result.

I have also experimented with also making the check for identical objects in the same `eval` if the function call was short enough, but this invariably caused slowdowns.

Janoš
----
New commits:


---

Comment by tscrim created at 2015-11-16 03:55:50

I'm not quite sure why my version didn't work; I'm sure it has something to do with how the pexpect interfaces work. However I confirm we need this change. Could you add a doctest for the long commands? With that, then you can set a positive review on my behalf.


---

Comment by git created at 2015-11-16 11:49:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jaanos created at 2015-11-16 11:59:23

Changing status from needs_review to needs_work.


---

Comment by jaanos created at 2015-11-16 11:59:23

I've added the doctest. However, now doctesting fails on a seemingly unrelated issue:

```
sage -t src/sage/interfaces/gap.py
**********************************************************************
File "src/sage/interfaces/gap.py", line 1001, in sage.interfaces.gap.GapElement_generic.bool
Failed example:
    gap('false').bool()
Expected:
    False
Got:
    True
**********************************************************************
```

This doesn't happen on the develop branch, and not even with the last commit. It seems that the failure has to do with the overlong variable name being reused:

```python
sage: gap.function_call("ConjugacyClassesSubgroups", sage.interfaces.gap.GapElement(gap, 'SymmetricGroup(2)', name = 'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'))
[ ConjugacyClassSubgroups(SymmetricGroup( [ 1 .. 2 ] ),Group( [ () ] )), 
  ConjugacyClassSubgroups(SymmetricGroup( [ 1 .. 2 ] ),SymmetricGroup( [ 1 .. 2 ] )) ]
sage: F = gap('false')
sage: F.bool()
True
sage: F.name()
'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'
sage: F = gap('false')
sage: F.bool()
False
sage: F.name()
'$sage1'
```

Will look into it.


---

Comment by git created at 2015-11-16 12:32:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jaanos created at 2015-11-16 12:38:50

OK, I had to make sure that getting variables with long names is properly handled. As it is, it is possible that `eval`s with commands a bit longer than the cutoff are made directly to GAP instead of with a temporary file (due to the `Print()` being wrapped around the variable name), but this shouldn't be a problem.

I am setting this back to "needs review" due to this additional changes.

Janoš


---

Comment by jaanos created at 2015-11-16 12:38:50

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2015-11-17 18:14:22

While in principle, I think these recent changes are okay, could someone else double-check that we want to do things this way?

As for the current code, I would change:

```diff
-        if isinstance(self._name, six.string_types) and parent._eval_using_file_cutoff and \
-           parent._eval_using_file_cutoff < len(self._name):
-            self._get_using_file = True
+        self._get_using_file = (isinstance(self._name, six.string_types)
+                                and parent._eval_using_file_cutoff
+                                and parent._eval_using_file_cutoff < len(self._name))
```

so we don't have to do a `try/except` block:

```diff
         if use_file is None:
-            try:
-                use_file = self._get_using_file
-            except AttributeError:
-                use_file = False
+            use_file = self._get_using_file
```



---

Comment by jaanos created at 2015-11-17 19:20:52

I agree with the change.

By the way, earlier in `Expect.__init__`, `_get_using_file` is set if the _value_ is too long - I don't see how that helps (except when `is_name == True`, but the new code also covers this case). So we can probably remove that piece of code, too.

On the other hand, this comment

```python
# idea: Joe Wetherell -- try to find out if the output
# is too long and if so get it using file, otherwise
# don't.
```

makes me wonder whether `_get_using_file == True` was meant that fetching the result would be done using a temporary file (rather than using one to communicate the variable name). But of course, a long command may give a very short answer, and the output of a short command may be very long, so this isn't something that can be decided here. Also, the only `get_using_file` methods apart from the new one in `gap.py` are the generic one in `interface.py` (which simply calls `get`), and one in `lie.py` which raises a `NotImplementedError`. So we're probably safe redefining the meaning, if that's what's happening here.


---

Comment by jaanos created at 2015-11-19 23:49:51

Changing status from needs_review to needs_work.


---

Comment by jaanos created at 2015-11-19 23:49:51

Hello everybody!

It turns out that we still have some issues here.

Firstly, GAP function calls don't actually work when done through a temporary file, nor does getting a variable (which is essentially a `Print` call). The reason for this is that when `_eval_line_using_file` is called, it first looks for a `:=` token - if there is one, all is well; but since we are relying on `last`, we don't have one, and a `Print()` is wrapped around our function call. If the function actually returns a value, this gives an impression of working, since the correct result is printed - but we get an `AsciiArtString` instead of a `GapElement`. When the function does not return a value, the situation is even worse, since printing the result of a function which does not return a result results in an error (which is silently suppressed, and an empty string is returned).

Now, it seems that we can't really solve this problem, since `last` is not updated when commands are read from a file. So I'd suggest this is how we deal with it:
* If the command is short, evaluate it directly (one or two `eval`s, as in the latest commit).
* If the command is long, we assign its result to a variable. This will of course cause an error if the function does not return a value - but such functions are few and it is much more likely that a (long) function does return a value.
* When getting a variable, we make a direct call to `Expect._eval_line_using_file` if a file should be needed to avoid having two `Print`s and hence an error.

This problem has existed before this ticket was opened, so the cases when a temporary file is used are marginal at best. If you think it is OK, I can implement the above solution (or maybe someone else can do it, since I'll probably be busy in the following days).

Secondly, `get_using_file` is indeed meant to use a file to read the results. So the code regarding `_get_using_file` should probably be left as it is (of course we can always set `_get_using_file`, so we don't need `try`/`except` blocks to check it), although the length of the input may be a poor predictor of the length of the output. Now, we should check whether getting with a file is actually faster with GAP than directly reading the output.

Janoš


---

Comment by tscrim created at 2015-11-20 18:38:34

Just to confirm, all of the issues you noted are there before this change. If so, then let us open up a follow-up ticket for these issues and get this into Sage as is. We don't need to fix everything all in one ticket.


---

Comment by jaanos created at 2015-11-20 21:40:36

Changing status from needs_work to needs_review.


---

Comment by jaanos created at 2015-11-20 21:40:36

OK, I have removed the latest commit since it introduces some unneeded and erroneous code. Now we're back to where we've been at comment [comment:23], with a doctest failing. I'll open a new ticket shortly addressing this problem.


---

Comment by tscrim created at 2015-11-26 00:35:13

The other ticket is #19607, and I don't have the technical knowledge of that part of Sage to do a good review of that.

However I have figured out the problem with comment:23, and it is essentially what you wrote in comment:28. I added the following right at the offending doctest:

```
sage: x.str()   # This is why it is returning True
''
sage: x._name   # Because this is making use the file
'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'
sage: gap(x._name)   # At least the variable is stored and retrieved correctly...
false
```

So we could likely to suppress this by doing another test with a shorter name being passed. I'm guessing we are somehow recycling variable names in the session, and we either shouldn't or will actually have to handle long variable names before this can get merged (possibly both too). I'm okay with suppressing with a note in the doctest referencing this issue. Anyone familiar with the interface have a better idea of what is going on?


---

Comment by jaanos created at 2015-11-26 11:50:44

Indeed, variable names are being recycled, so simply doing another test with a shorter variable name will probably result in another doctest failing (and even if it doesn't, it may in the future). So I guess the right thing to do would be to do the long variable name doctests in a separate GAP session.


---

Comment by git created at 2015-11-26 12:21:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jaanos created at 2015-11-26 12:53:11

OK, done. Can anyone look at #19607? (I have included the latest commit there to avoid conflicts.


---

Comment by tscrim created at 2015-11-27 02:52:41

Okay, LGTM. Thanks.


---

Comment by tscrim created at 2015-11-27 02:52:41

Changing status from needs_review to positive_review.


---

Comment by jaanos created at 2015-11-28 09:21:23

I see that this has now been merged into the `develop` branch. Thanks everyone!


---

Comment by ncohen created at 2015-11-28 09:22:02

I hope that you are wrong, as otherwise the ticket should be marked as 'closed'.


---

Comment by jaanos created at 2015-11-28 11:36:20

Yes, I'd expect it to be marked as closed too, but I see that it has been merged (just missing the latest beta, though):

https://github.com/vbraun/sage/commits/develop

The other three tickets merged after the latest beta are still 'positive_review', too.


---

Comment by ncohen created at 2015-11-28 11:40:06

Oh I see. That's the repository that Volker uses to work on the betas, but that's not released yet. Several commits below the one of this ticket, you see the 'Updated Sage version' commit that marks where the last release goes.

Nathann


---

Comment by vbraun created at 2015-11-28 12:01:44

You shouldn't be looking at my repo, that is just what is being tested on the buildbot. Just because its being tested doesn't mean that its ever going to be merged ;-)


---

Comment by jaanos created at 2015-11-28 13:15:39

Oh, I see:) Thanks for the clarification.


---

Comment by vbraun created at 2015-11-28 13:46:05

Resolution: fixed


---

Comment by jaanos created at 2015-11-28 14:05:30

OK, now it really is merged:) Thanks again!
