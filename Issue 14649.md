# Issue 14649: RDF vertices of a graph are transformed into consecutive integers

archive/issues_014649.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\nCC:  @nathanncohen\n\nAs reported in the comments of [this ask answer](http://ask.sagemath.org/question/2774/generate-maximal-subsets-based-on-mutualsubset?answer=3808#3808):\n\n\n```\nsage: A=Set([RDF.random_element(min=0,max=10) for k in range(10)]) ; A\n{6.42320967152, 1.77698693175, 2.95922392964, 9.50745089775, 4.60546838289, 3.67300191731, 5.21254750195, 5.90579400282, 7.55309974188, 0.442799267782}\nsage: G = Graph()\nsage: G.add_vertices(A)\nsage: G.vertices()\n[0, 1, 2, 3, 4, 5, 6, 7, 9]\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14853\n\n",
    "created_at": "2013-07-04T13:02:45Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "RDF vertices of a graph are transformed into consecutive integers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14649",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
Assignee: jason, ncohen, rlm

CC:  @nathanncohen

As reported in the comments of [this ask answer](http://ask.sagemath.org/question/2774/generate-maximal-subsets-based-on-mutualsubset?answer=3808#3808):


```
sage: A=Set([RDF.random_element(min=0,max=10) for k in range(10)]) ; A
{6.42320967152, 1.77698693175, 2.95922392964, 9.50745089775, 4.60546838289, 3.67300191731, 5.21254750195, 5.90579400282, 7.55309974188, 0.442799267782}
sage: G = Graph()
sage: G.add_vertices(A)
sage: G.vertices()
[0, 1, 2, 3, 4, 5, 6, 7, 9]
```



Issue created by migration from https://trac.sagemath.org/ticket/14853





---

archive/issue_comments_186216.json:
```json
{
    "body": "Unfortunately this is not limited to RDF:\n\n\n```\nsage: A = Set([QQ(0), QQ(1)/QQ(2)])                                                      \nsage: A \n{0, 1/2}\nsage: G = Graph()\nsage: G.add_vertices(A)\nsage: G.vertices()\n[0]\n```\n\n\nMy attempts at debugging this stop here:\n\n\n```\nsage: G._backend.add_vertex??  \n\nType:       instancemethod\nString Form:<bound method SparseGraphBackend.add_vertex of <class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>>\nDefinition: G._backend.add_vertex(self, name)\nSource:\n    def add_vertex(self, object name):\n        \"\"\"\n        Add a vertex to ``self``.\n\n        INPUT:\n\n        - ``name`` -- the vertex to be added (must be hashable). If ``None``,\n          a new name is created.\n\n        OUTPUT:\n\n        - If name=None, the new vertex name is returned.\n          None otherwise.\n\n        .. SEEALSO::\n\n            - :meth:`add_vertices`\n              -- add a bunch of vertices of this graph.\n\n            - :meth:`has_vertex`\n              -- returns whether or not this graph has a specific vertex.\n\n        EXAMPLE::\n\n            sage: D = sage.graphs.base.dense_graph.DenseGraphBackend(9)\n            sage: D.add_vertex(10)\n            sage: D.add_vertex([])\n            Traceback (most recent call last):\n            ...\n            TypeError: unhashable type: 'list'\n\n        ::\n\n            sage: S = sage.graphs.base.sparse_graph.SparseGraphBackend(9)\n            sage: S.add_vertex(10)\n            sage: S.add_vertex([])\n            Traceback (most recent call last):\n            ...\n            TypeError: unhashable type: 'list'\n        \"\"\"\n        retval = None\n        if name is None:\n            name = 0\n            while name in self.vertex_ints or (\n                name not in self.vertex_labels and\n                bitset_in((<CGraph>self._cg).active_vertices, name)):\n                name += 1\n            retval = name\n\n        check_vertex(name,\n                     self.vertex_ints,\n                     self.vertex_labels,\n                     self._cg,\n                     self._cg_rev,\n                     (self._directed and\n                      self._cg_rev is not None)) # this will add the vertex\n\n        return retval\n```\n\n\nWhat is that mysterious `check_vertex` method and where can I find it?\n\nEDIT: Oh, I found it. I have been grepping for \"def check_vertex\" but it is \"cdef int check_vertex\". Let me see.",
    "created_at": "2013-07-14T11:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186216",
    "user": "https://github.com/darijgr"
}
```

Unfortunately this is not limited to RDF:


```
sage: A = Set([QQ(0), QQ(1)/QQ(2)])                                                      
sage: A 
{0, 1/2}
sage: G = Graph()
sage: G.add_vertices(A)
sage: G.vertices()
[0]
```


My attempts at debugging this stop here:


```
sage: G._backend.add_vertex??  

Type:       instancemethod
String Form:<bound method SparseGraphBackend.add_vertex of <class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>>
Definition: G._backend.add_vertex(self, name)
Source:
    def add_vertex(self, object name):
        """
        Add a vertex to ``self``.

        INPUT:

        - ``name`` -- the vertex to be added (must be hashable). If ``None``,
          a new name is created.

        OUTPUT:

        - If name=None, the new vertex name is returned.
          None otherwise.

        .. SEEALSO::

            - :meth:`add_vertices`
              -- add a bunch of vertices of this graph.

            - :meth:`has_vertex`
              -- returns whether or not this graph has a specific vertex.

        EXAMPLE::

            sage: D = sage.graphs.base.dense_graph.DenseGraphBackend(9)
            sage: D.add_vertex(10)
            sage: D.add_vertex([])
            Traceback (most recent call last):
            ...
            TypeError: unhashable type: 'list'

        ::

            sage: S = sage.graphs.base.sparse_graph.SparseGraphBackend(9)
            sage: S.add_vertex(10)
            sage: S.add_vertex([])
            Traceback (most recent call last):
            ...
            TypeError: unhashable type: 'list'
        """
        retval = None
        if name is None:
            name = 0
            while name in self.vertex_ints or (
                name not in self.vertex_labels and
                bitset_in((<CGraph>self._cg).active_vertices, name)):
                name += 1
            retval = name

        check_vertex(name,
                     self.vertex_ints,
                     self.vertex_labels,
                     self._cg,
                     self._cg_rev,
                     (self._directed and
                      self._cg_rev is not None)) # this will add the vertex

        return retval
```


What is that mysterious `check_vertex` method and where can I find it?

EDIT: Oh, I found it. I have been grepping for "def check_vertex" but it is "cdef int check_vertex". Let me see.



---

archive/issue_comments_186217.json:
```json
{
    "body": "I suspect the error is in `sage/graphs/base/c_graph.pyx`:\n\n\n```\ncdef int get_vertex(object u, dict vertex_ints, dict vertex_labels,\n                    CGraph G) except ? -2:\n    \"\"\"\n    Returns an int representing the arbitrary hashable vertex u (whether or not\n    u is actually in the graph), or -1 if a new association must be made for u\n    to be a vertex.\n\n    TESTS:\n\n    We check that the bug described in #8406 is gone::\n\n        sage: G = Graph()\n        sage: R.<a> = GF(3**3)\n        sage: S.<x> = R[]\n        sage: G.add_vertex(a**2)\n        sage: G.add_vertex(x)\n        sage: G.vertices()\n        [a^2, x]\n\n    And that the bug described in #9610 is gone::\n\n        sage: n = 20\n        sage: k = 3\n        sage: g = DiGraph()\n        sage: g.add_edges( (i,Mod(i+j,n)) for i in range(n) for j in range(1,k+1) )\n        sage: g.vertices()\n        [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]\n        sage: g.strongly_connected_components()\n        [[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]]\n\n    \"\"\"\n    cdef int u_int\n    if u in vertex_ints:\n        return vertex_ints[u]\n    try:\n        u_int = u\n    except StandardError:\n        return -1\n    if u_int < 0 or u_int >= G.active_vertices.size or u_int in vertex_labels:\n        return -1\n    return u_int\n```\n\n\nThis \"try/except\" has apparently been written in the hope that if `u` is anything other than an integer, there will be an exception; but that reasoning fails because rationals and reals are silently converted into integers. Am I right? I'm unable to import methods from cython files into the sage console, so I can't test my conjectures...",
    "created_at": "2013-07-14T11:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186217",
    "user": "https://github.com/darijgr"
}
```

I suspect the error is in `sage/graphs/base/c_graph.pyx`:


```
cdef int get_vertex(object u, dict vertex_ints, dict vertex_labels,
                    CGraph G) except ? -2:
    """
    Returns an int representing the arbitrary hashable vertex u (whether or not
    u is actually in the graph), or -1 if a new association must be made for u
    to be a vertex.

    TESTS:

    We check that the bug described in #8406 is gone::

        sage: G = Graph()
        sage: R.<a> = GF(3**3)
        sage: S.<x> = R[]
        sage: G.add_vertex(a**2)
        sage: G.add_vertex(x)
        sage: G.vertices()
        [a^2, x]

    And that the bug described in #9610 is gone::

        sage: n = 20
        sage: k = 3
        sage: g = DiGraph()
        sage: g.add_edges( (i,Mod(i+j,n)) for i in range(n) for j in range(1,k+1) )
        sage: g.vertices()
        [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
        sage: g.strongly_connected_components()
        [[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]]

    """
    cdef int u_int
    if u in vertex_ints:
        return vertex_ints[u]
    try:
        u_int = u
    except StandardError:
        return -1
    if u_int < 0 or u_int >= G.active_vertices.size or u_int in vertex_labels:
        return -1
    return u_int
```


This "try/except" has apparently been written in the hope that if `u` is anything other than an integer, there will be an exception; but that reasoning fails because rationals and reals are silently converted into integers. Am I right? I'm unable to import methods from cython files into the sage console, so I can't test my conjectures...



---

archive/issue_comments_186218.json:
```json
{
    "body": "See also #14967",
    "created_at": "2013-07-25T16:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186218",
    "user": "https://github.com/rlmill"
}
```

See also #14967



---

archive/issue_comments_186219.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-07-29T01:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186219",
    "user": "https://github.com/rlmill"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_186220.json:
```json
{
    "body": "for patchbot:\n\nApply trac_14853.patch",
    "created_at": "2013-07-29T01:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186220",
    "user": "https://github.com/rlmill"
}
```

for patchbot:

Apply trac_14853.patch



---

archive/issue_comments_186221.json:
```json
{
    "body": "OKayyyyyyyyyyy... Could you replace the references to the track ticket with `:trac:14967` and `:trac:14853` `? `:-)`\n\nShort of this I think it's good to go `:-)`\n\nNathann",
    "created_at": "2013-07-30T08:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186221",
    "user": "https://github.com/nathanncohen"
}
```

OKayyyyyyyyyyy... Could you replace the references to the track ticket with `:trac:14967` and `:trac:14853` `? `:-)`

Short of this I think it's good to go `:-)`

Nathann



---

archive/issue_comments_186222.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-07-30T08:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186222",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_186223.json:
```json
{
    "body": "OOps. `:trac:`14967`` and `:trac:`14853`` sorry !\n\nNathann",
    "created_at": "2013-07-30T08:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186223",
    "user": "https://github.com/nathanncohen"
}
```

OOps. `:trac:`14967`` and `:trac:`14853`` sorry !

Nathann



---

archive/issue_comments_186224.json:
```json
{
    "body": "Attachment [trac_14853.patch](tarball://root/attachments/some-uuid/ticket14853/trac_14853.patch) by @rlmill created at 2013-07-30 17:23:37",
    "created_at": "2013-07-30T17:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186224",
    "user": "https://github.com/rlmill"
}
```

Attachment [trac_14853.patch](tarball://root/attachments/some-uuid/ticket14853/trac_14853.patch) by @rlmill created at 2013-07-30 17:23:37



---

archive/issue_comments_186225.json:
```json
{
    "body": "Thanks Nathann!",
    "created_at": "2013-07-30T17:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186225",
    "user": "https://github.com/rlmill"
}
```

Thanks Nathann!



---

archive/issue_comments_186226.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-07-30T17:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186226",
    "user": "https://github.com/rlmill"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_186227.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-30T18:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186227",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186228.json:
```json
{
    "body": "Well.. All tests pass `:-)`\n\nThaaaaaaaaaaaaaaanks !\n\nNathann",
    "created_at": "2013-07-30T18:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186228",
    "user": "https://github.com/nathanncohen"
}
```

Well.. All tests pass `:-)`

Thaaaaaaaaaaaaaaanks !

Nathann



---

archive/issue_events_014396.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-20T12:59:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14649#event-14396"
}
```



---

archive/issue_comments_186229.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-20T12:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14649#issuecomment-186229",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
