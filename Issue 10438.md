# Issue 10438: Dump environment before building

archive/issues_010438.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nKeywords: scripts install\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10491\n\n",
    "created_at": "2010-12-18T09:48:41Z",
    "labels": [
        "build",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Dump environment before building",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10438",
    "user": "@jdemeyer"
}
```
Assignee: GeorgSWeber

Keywords: scripts install



Issue created by migration from https://trac.sagemath.org/ticket/10491





---

archive/issue_comments_107637.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2010-12-18T09:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107637",
    "user": "@jdemeyer"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_107638.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-18T09:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107638",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_107639.json:
```json
{
    "body": "SCRIPTS",
    "created_at": "2010-12-18T09:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107639",
    "user": "@jdemeyer"
}
```

SCRIPTS



---

archive/issue_comments_107640.json:
```json
{
    "body": "Changing component from build to scripts.",
    "created_at": "2010-12-18T16:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107640",
    "user": "@jdemeyer"
}
```

Changing component from build to scripts.



---

archive/issue_comments_107641.json:
```json
{
    "body": "Attachment [10491_install_dump_env.patch](tarball://root/attachments/some-uuid/ticket10491/10491_install_dump_env.patch) by @jdemeyer created at 2010-12-18 16:38:13",
    "created_at": "2010-12-18T16:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107641",
    "user": "@jdemeyer"
}
```

Attachment [10491_install_dump_env.patch](tarball://root/attachments/some-uuid/ticket10491/10491_install_dump_env.patch) by @jdemeyer created at 2010-12-18 16:38:13



---

archive/issue_comments_107642.json:
```json
{
    "body": "Looks good!",
    "created_at": "2010-12-24T18:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107642",
    "user": "@vbraun"
}
```

Looks good!



---

archive/issue_comments_107643.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-12-24T18:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107643",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_107644.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-12-24T20:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107644",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_107645.json:
```json
{
    "body": "IMHO **needs work**.\n\nIt's totally odd to dump the whole environment whenever `make something` is run, where `something` includes `doc`, `ptestlong` and most of all other targets.\n\nI would\n* make the output depend on some environment variable (*not* `SAGE_DEBUG` ;-) , but perhaps `SAGE_DEBUG_BUILD` to be also used elsewhere),\n* limit the output to \"relevant\" variables; I e.g. personally use\n\n```sh\nprintenv | egrep \"SAGE|MAKE|CC|CXX|FLAG|LC|TMP|TEMP\" | sort\n```\n\n (which you would certainly extend I think),\n* use `printenv`, the shell built-in, instead of `env`.\n\n\nSorry, had some \"Sage-free Days\"...",
    "created_at": "2010-12-27T01:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107645",
    "user": "@nexttime"
}
```

IMHO **needs work**.

It's totally odd to dump the whole environment whenever `make something` is run, where `something` includes `doc`, `ptestlong` and most of all other targets.

I would
* make the output depend on some environment variable (*not* `SAGE_DEBUG` ;-) , but perhaps `SAGE_DEBUG_BUILD` to be also used elsewhere),
* limit the output to "relevant" variables; I e.g. personally use

```sh
printenv | egrep "SAGE|MAKE|CC|CXX|FLAG|LC|TMP|TEMP" | sort
```

 (which you would certainly extend I think),
* use `printenv`, the shell built-in, instead of `env`.


Sorry, had some "Sage-free Days"...



---

archive/issue_comments_107646.json:
```json
{
    "body": "You could also do (one of or some other combination of) the following:\n\n```diff\n--- Makefile.orig\t2010-12-24 13:39:58.000000000 +0100\n+++ Makefile\t2010-12-27 02:38:20.000000000 +0100\n@@ -43,7 +43,7 @@\n #\ttest -x $@ # or make it executable if it exists; sanity check only anyway\n \n build: $(PIPE)\n-\tcd spkg && \"../$(PIPE)\" \"./install all 2>&1\" \"tee -a ../install.log\"\n+\tcd spkg && env MAKECMDGOALS=\"$(MAKECMDGOALS)\" \"../$(PIPE)\" \"./install all 2>&1\" \"tee -a ../install.log\"\n \n doc: doc-html\n \n--- spkg/install.orig\t2010-12-26 23:28:59.000000000 +0100\n+++ spkg/install\t2010-12-27 03:10:04.000000000 +0100\n@@ -432,10 +432,26 @@\n export ZNPOLY\n \n \n-# Dump environment for debugging purposes:\n-echo \"*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***\"\n-env\n-echo \"***********************************************\"\n+# Skip the rest if nothing to do (i.e., to [re]build):\n+# (Note that we should use $MAKE here, but we currently don't use\n+# it further below either unless SAGE_PARALLEL_SPKG_BUILD=yes, which\n+# I consider a \"bug\".)\n+if make -q -f standard/deps $1; then\n+    echo\n+    echo \"Nothing to (re)build / all up-to-date.\"\n+    echo\n+    exit 0\n+fi\n+\n+# ALTERNATIVELY:\n+\n+# Only dump the environment when 'make' or 'make build' was issued:\n+if ! echo $MAKECMDGOALS | egrep \"doc|test\" >/dev/null; then\n+    # Dump environment for debugging purposes:\n+    echo \"*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***\"\n+    env\n+    echo \"***********************************************\"\n+fi\n \n \n ###############################################################################\n```\n\n\n----\n\nP.S.: I did not know you are the copyright owner of our rewritten `pipestatus`... ;-)",
    "created_at": "2010-12-27T02:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107646",
    "user": "@nexttime"
}
```

You could also do (one of or some other combination of) the following:

```diff
--- Makefile.orig	2010-12-24 13:39:58.000000000 +0100
+++ Makefile	2010-12-27 02:38:20.000000000 +0100
@@ -43,7 +43,7 @@
 #	test -x $@ # or make it executable if it exists; sanity check only anyway
 
 build: $(PIPE)
-	cd spkg && "../$(PIPE)" "./install all 2>&1" "tee -a ../install.log"
+	cd spkg && env MAKECMDGOALS="$(MAKECMDGOALS)" "../$(PIPE)" "./install all 2>&1" "tee -a ../install.log"
 
 doc: doc-html
 
--- spkg/install.orig	2010-12-26 23:28:59.000000000 +0100
+++ spkg/install	2010-12-27 03:10:04.000000000 +0100
@@ -432,10 +432,26 @@
 export ZNPOLY
 
 
-# Dump environment for debugging purposes:
-echo "*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***"
-env
-echo "***********************************************"
+# Skip the rest if nothing to do (i.e., to [re]build):
+# (Note that we should use $MAKE here, but we currently don't use
+# it further below either unless SAGE_PARALLEL_SPKG_BUILD=yes, which
+# I consider a "bug".)
+if make -q -f standard/deps $1; then
+    echo
+    echo "Nothing to (re)build / all up-to-date."
+    echo
+    exit 0
+fi
+
+# ALTERNATIVELY:
+
+# Only dump the environment when 'make' or 'make build' was issued:
+if ! echo $MAKECMDGOALS | egrep "doc|test" >/dev/null; then
+    # Dump environment for debugging purposes:
+    echo "*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***"
+    env
+    echo "***********************************************"
+fi
 
 
 ###############################################################################
```


----

P.S.: I did not know you are the copyright owner of our rewritten `pipestatus`... ;-)



---

archive/issue_comments_107647.json:
```json
{
    "body": "(You could invert the test on `$MAKECMDGOALS` to\n\n```sh\nif [ -z \"$MAKECMDGOALS\" ] || (echo $MAKECMDGOALS | egrep \"build|all\" >/dev/null); then\n    # dump all (or some) env vars\n    ...\nfi\n```\n\n)\n\nThe \"early exit\" in my patch above is IMHO useful anyway, since always printing\n\n```\nTo install gap, gp, singular, etc., scripts\nin a standard bin directory, start sage and\ntype something like\n   sage: install_scripts('/usr/local/bin')\nat the Sage command prompt.\n\nTo build the documentation, run\n   make doc\n\nSage build/upgrade complete!\n```\n\nis also dumb.",
    "created_at": "2010-12-27T02:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107647",
    "user": "@nexttime"
}
```

(You could invert the test on `$MAKECMDGOALS` to

```sh
if [ -z "$MAKECMDGOALS" ] || (echo $MAKECMDGOALS | egrep "build|all" >/dev/null); then
    # dump all (or some) env vars
    ...
fi
```

)

The "early exit" in my patch above is IMHO useful anyway, since always printing

```
To install gap, gp, singular, etc., scripts
in a standard bin directory, start sage and
type something like
   sage: install_scripts('/usr/local/bin')
at the Sage command prompt.

To build the documentation, run
   make doc

Sage build/upgrade complete!
```

is also dumb.



---

archive/issue_comments_107648.json:
```json
{
    "body": "P.P.S., related:\n\nImplementing `sage -printenv` is also on my TODO list since a while...\n\n(This should only print relevant variables, e.g. set/used in `sage-env`, grouped by category.)",
    "created_at": "2010-12-27T02:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107648",
    "user": "@nexttime"
}
```

P.P.S., related:

Implementing `sage -printenv` is also on my TODO list since a while...

(This should only print relevant variables, e.g. set/used in `sage-env`, grouped by category.)



---

archive/issue_comments_107649.json:
```json
{
    "body": "Replying to [comment:5 leif]:\n> It's totally odd to dump the whole environment whenever `make something` is run, where `something` includes `doc`, `ptestlong` and most of all other targets.\nAgreed.\n\n> I would\n>  * make the output depend on some environment variable (*not* `SAGE_DEBUG` ;-) , but perhaps `SAGE_DEBUG_BUILD` to be also used elsewhere),\nMakes sense.\n\n>  * limit the output to \"relevant\" variables; I e.g. personally use\nDisagree, you never know in advance which environment variables are \"relevant\".  If a build fails, it might be because of some obscure environment variable.  That's why I added this patch.\n\n>  * use `printenv`, the shell built-in, instead of `env`.\nDisagree, `env` is more portable than `printenv`.",
    "created_at": "2010-12-27T12:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107649",
    "user": "@jdemeyer"
}
```

Replying to [comment:5 leif]:
> It's totally odd to dump the whole environment whenever `make something` is run, where `something` includes `doc`, `ptestlong` and most of all other targets.
Agreed.

> I would
>  * make the output depend on some environment variable (*not* `SAGE_DEBUG` ;-) , but perhaps `SAGE_DEBUG_BUILD` to be also used elsewhere),
Makes sense.

>  * limit the output to "relevant" variables; I e.g. personally use
Disagree, you never know in advance which environment variables are "relevant".  If a build fails, it might be because of some obscure environment variable.  That's why I added this patch.

>  * use `printenv`, the shell built-in, instead of `env`.
Disagree, `env` is more portable than `printenv`.



---

archive/issue_comments_107650.json:
```json
{
    "body": "To me, it makes sense to me to always dump the environment before running make ptest/ptestlong. For example, say, I change an environment variable and testing breaks today, but I know it worked yesterday... For the same reason, I don't like it to be contingent on some \"debug\" environment variable. Its good to be able to compare with previously working tests.\n\nAnd if you look at the size of the `install.log`, thats just a drop of water in the ocean. Saving 4k of disk space? really, we are even discussing this?",
    "created_at": "2010-12-27T16:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107650",
    "user": "@vbraun"
}
```

To me, it makes sense to me to always dump the environment before running make ptest/ptestlong. For example, say, I change an environment variable and testing breaks today, but I know it worked yesterday... For the same reason, I don't like it to be contingent on some "debug" environment variable. Its good to be able to compare with previously working tests.

And if you look at the size of the `install.log`, thats just a drop of water in the ocean. Saving 4k of disk space? really, we are even discussing this?



---

archive/issue_comments_107651.json:
```json
{
    "body": "Edit your `~/.sagerc`.\n\nMost of the environment is completely unrelated to Sage, and will annoy ordinary users.\n\n\n\nWe already had long discussions regarding the removal of (short!) useless messages like \"*Building a 64-bit version of Sage*\".\n\n\n\nI'm also strongly in favour of first running `make -q` before (usually one-time) build-related messages are printed. `ptestlong` etc. are likely to be run much more often than a real (re)build is performed.\n\nIf you need it, you can add `ptestlong-debug` etc. targets to the top-level `Makefile`.",
    "created_at": "2010-12-27T16:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107651",
    "user": "@nexttime"
}
```

Edit your `~/.sagerc`.

Most of the environment is completely unrelated to Sage, and will annoy ordinary users.



We already had long discussions regarding the removal of (short!) useless messages like "*Building a 64-bit version of Sage*".



I'm also strongly in favour of first running `make -q` before (usually one-time) build-related messages are printed. `ptestlong` etc. are likely to be run much more often than a real (re)build is performed.

If you need it, you can add `ptestlong-debug` etc. targets to the top-level `Makefile`.



---

archive/issue_comments_107652.json:
```json
{
    "body": "Fine. I don't really care what the color of your bike shed is. If you post a patch that at least somehow adds a dump of environment variables to the log then I'll review it positively for you. If its not in time for Sage-4.6.1 then preferably in a different ticket.",
    "created_at": "2010-12-27T18:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107652",
    "user": "@vbraun"
}
```

Fine. I don't really care what the color of your bike shed is. If you post a patch that at least somehow adds a dump of environment variables to the log then I'll review it positively for you. If its not in time for Sage-4.6.1 then preferably in a different ticket.



---

archive/issue_comments_107653.json:
```json
{
    "body": "Replying to [comment:11 leif]:\n> Most of the environment is completely unrelated to Sage\nThis is certainly true, but as I have said before: you never know in advance which environment variables are relevant, so better print them all.",
    "created_at": "2011-01-03T10:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107653",
    "user": "@jdemeyer"
}
```

Replying to [comment:11 leif]:
> Most of the environment is completely unrelated to Sage
This is certainly true, but as I have said before: you never know in advance which environment variables are relevant, so better print them all.



---

archive/issue_comments_107654.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2011-01-03T10:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107654",
    "user": "@jdemeyer"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_107655.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2011-01-03T10:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107655",
    "user": "@jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_107656.json:
```json
{
    "body": "Attachment [10491_skip.patch](tarball://root/attachments/some-uuid/ticket10491/10491_skip.patch) by @jdemeyer created at 2011-01-03 10:36:31\n\nSCRIPTS, Apply on top of previous",
    "created_at": "2011-01-03T10:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107656",
    "user": "@jdemeyer"
}
```

Attachment [10491_skip.patch](tarball://root/attachments/some-uuid/ticket10491/10491_skip.patch) by @jdemeyer created at 2011-01-03 10:36:31

SCRIPTS, Apply on top of previous



---

archive/issue_comments_107657.json:
```json
{
    "body": "Leif, I implemented your \"skip the rest of the script if nothing to do\" patch.",
    "created_at": "2011-01-03T10:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107657",
    "user": "@jdemeyer"
}
```

Leif, I implemented your "skip the rest of the script if nothing to do" patch.



---

archive/issue_comments_107658.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-01-03T10:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107658",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_107659.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-03T11:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107659",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_107660.json:
```json
{
    "body": "Looks good to me.\n\nFor the release manager: First apply 10491_install_dump_env.patch (merged in Sage-4.6.1.rc0), then 10491_skip.patch\n\nAll patches apply within `$SAGE_ROOT/spkg/`",
    "created_at": "2011-01-03T11:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107660",
    "user": "@vbraun"
}
```

Looks good to me.

For the release manager: First apply 10491_install_dump_env.patch (merged in Sage-4.6.1.rc0), then 10491_skip.patch

All patches apply within `$SAGE_ROOT/spkg/`



---

archive/issue_comments_107661.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-05T08:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10438#issuecomment-107661",
    "user": "@jdemeyer"
}
```

Resolution: fixed
