# Issue 10438: Dump environment before building

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2010-12-18 09:48:41

Assignee: GeorgSWeber

Keywords: scripts install




---

Comment by jdemeyer created at 2010-12-18 09:49:04

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jdemeyer created at 2010-12-18 09:49:04

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2010-12-18 09:49:29

SCRIPTS


---

Comment by jdemeyer created at 2010-12-18 16:38:13

Changing component from build to scripts.


---

Attachment


---

Comment by vbraun created at 2010-12-24 18:59:27

Looks good!


---

Comment by vbraun created at 2010-12-24 18:59:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2010-12-24 20:01:14

Resolution: fixed


---

Comment by leif created at 2010-12-27 01:09:11

IMHO *needs work*.

It's totally odd to dump the whole environment whenever `make something` is run, where `something` includes `doc`, `ptestlong` and most of all other targets.

I would
 * make the output depend on some environment variable (_not_ `SAGE_DEBUG` ;-) , but perhaps `SAGE_DEBUG_BUILD` to be also used elsewhere),
 * limit the output to "relevant" variables; I e.g. personally use

```sh
printenv | egrep "SAGE|MAKE|CC|CXX|FLAG|LC|TMP|TEMP" | sort
```

 (which you would certainly extend I think),
 * use `printenv`, the shell built-in, instead of `env`.


Sorry, had some "Sage-free Days"...


---

Comment by leif created at 2010-12-27 02:27:36

You could also do (one of or some other combination of) the following:

```diff
--- Makefile.orig	2010-12-24 13:39:58.000000000 +0100
+++ Makefile	2010-12-27 02:38:20.000000000 +0100
`@``@` -43,7 +43,7 `@``@`
 #	test -x $`@` # or make it executable if it exists; sanity check only anyway
 
 build: $(PIPE)
-	cd spkg && "../$(PIPE)" "./install all 2>&1" "tee -a ../install.log"
+	cd spkg && env MAKECMDGOALS="$(MAKECMDGOALS)" "../$(PIPE)" "./install all 2>&1" "tee -a ../install.log"
 
 doc: doc-html
 
--- spkg/install.orig	2010-12-26 23:28:59.000000000 +0100
+++ spkg/install	2010-12-27 03:10:04.000000000 +0100
`@``@` -432,10 +432,26 `@``@`
 export ZNPOLY
 
 
-# Dump environment for debugging purposes:
-echo "*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***"
-env
-echo "***********************************************"
+# Skip the rest if nothing to do (i.e., to [re]build):
+# (Note that we should use $MAKE here, but we currently don't use
+# it further below either unless SAGE_PARALLEL_SPKG_BUILD=yes, which
+# I consider a "bug".)
+if make -q -f standard/deps $1; then
+    echo
+    echo "Nothing to (re)build / all up-to-date."
+    echo
+    exit 0
+fi
+
+# ALTERNATIVELY:
+
+# Only dump the environment when 'make' or 'make build' was issued:
+if ! echo $MAKECMDGOALS | egrep "doc|test" >/dev/null; then
+    # Dump environment for debugging purposes:
+    echo "*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***"
+    env
+    echo "***********************************************"
+fi
 
 
 ###############################################################################
```


----

P.S.: I did not know you are the copyright owner of our rewritten `pipestatus`... ;-)


---

Comment by leif created at 2010-12-27 02:38:57

(You could invert the test on `$MAKECMDGOALS` to

```sh
if [ -z "$MAKECMDGOALS" ] || (echo $MAKECMDGOALS | egrep "build|all" >/dev/null); then
    # dump all (or some) env vars
    ...
fi
```

)

The "early exit" in my patch above is IMHO useful anyway, since always printing

```
To install gap, gp, singular, etc., scripts
in a standard bin directory, start sage and
type something like
   sage: install_scripts('/usr/local/bin')
at the Sage command prompt.

To build the documentation, run
   make doc

Sage build/upgrade complete!
```

is also dumb.


---

Comment by leif created at 2010-12-27 02:45:53

P.P.S., related:

Implementing `sage -printenv` is also on my TODO list since a while...

(This should only print relevant variables, e.g. set/used in `sage-env`, grouped by category.)


---

Comment by jdemeyer created at 2010-12-27 12:01:51

Replying to [comment:5 leif]:
> It's totally odd to dump the whole environment whenever `make something` is run, where `something` includes `doc`, `ptestlong` and most of all other targets.
Agreed.

> I would
>  * make the output depend on some environment variable (_not_ `SAGE_DEBUG` ;-) , but perhaps `SAGE_DEBUG_BUILD` to be also used elsewhere),
Makes sense.

>  * limit the output to "relevant" variables; I e.g. personally use
Disagree, you never know in advance which environment variables are "relevant".  If a build fails, it might be because of some obscure environment variable.  That's why I added this patch.

>  * use `printenv`, the shell built-in, instead of `env`.
Disagree, `env` is more portable than `printenv`.


---

Comment by vbraun created at 2010-12-27 16:08:30

To me, it makes sense to me to always dump the environment before running make ptest/ptestlong. For example, say, I change an environment variable and testing breaks today, but I know it worked yesterday... For the same reason, I don't like it to be contingent on some "debug" environment variable. Its good to be able to compare with previously working tests.

And if you look at the size of the `install.log`, thats just a drop of water in the ocean. Saving 4k of disk space? really, we are even discussing this?


---

Comment by leif created at 2010-12-27 16:26:50

Edit your `~/.sagerc`.

Most of the environment is completely unrelated to Sage, and will annoy ordinary users.



We already had long discussions regarding the removal of (short!) useless messages like "_Building a 64-bit version of Sage_".



I'm also strongly in favour of first running `make -q` before (usually one-time) build-related messages are printed. `ptestlong` etc. are likely to be run much more often than a real (re)build is performed.

If you need it, you can add `ptestlong-debug` etc. targets to the top-level `Makefile`.


---

Comment by vbraun created at 2010-12-27 18:55:18

Fine. I don't really care what the color of your bike shed is. If you post a patch that at least somehow adds a dump of environment variables to the log then I'll review it positively for you. If its not in time for Sage-4.6.1 then preferably in a different ticket.


---

Comment by jdemeyer created at 2011-01-03 10:27:44

Replying to [comment:11 leif]:
> Most of the environment is completely unrelated to Sage
This is certainly true, but as I have said before: you never know in advance which environment variables are relevant, so better print them all.


---

Comment by jdemeyer created at 2011-01-03 10:35:37

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-01-03 10:35:37

Changing status from closed to new.


---

Attachment

SCRIPTS, Apply on top of previous


---

Comment by jdemeyer created at 2011-01-03 10:37:39

Leif, I implemented your "skip the rest of the script if nothing to do" patch.


---

Comment by jdemeyer created at 2011-01-03 10:37:39

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-01-03 11:12:00

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2011-01-03 11:12:00

Looks good to me.

For the release manager: First apply 10491_install_dump_env.patch (merged in Sage-4.6.1.rc0), then 10491_skip.patch

All patches apply within `$SAGE_ROOT/spkg/`


---

Comment by jdemeyer created at 2011-01-05 08:20:02

Resolution: fixed
