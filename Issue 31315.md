# Issue 31315: /usr/local leaks into Singular build

archive/issues_031315.json:
```json
{
    "body": "CC:  dimpase slelievre jhpalmieri @zlscherr fbissey vdelecroix arojas\n\nOn macOS, even when using `gcc -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk` (which disables use of `/usr/local`), Singular's `configure` script sneaks in `/usr/local/include` and `/usr/local/lib`.\n\n\n```\nIt was created by singular configure 4.2.0p1+2021-03-13+sage, which was\ngenerated by GNU Autoconf 2.69.  Invocation command line was\n\n  $ ./configure --prefix=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --libdir=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local/lib --disable-maintainer-mode\n --disable-dependency-tracking --exec-prefix=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --bindir=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local/bin --wit\nh-ntl=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --with-flint=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --enable-gfanlib --enable-Singular --enable-\nfactory --disable-doc --disable-polymake --without-python --without-pythonmodule --disable-python --disable-python_module --disable-python-module --disable\n-static\n\nPATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/build/bin\nPATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/src/bin\nPATH: /var/tmp/sage-9.3.rc0-cpython-38-darwin/local/bin\nPATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/build/bin\nPATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/src/bin\nPATH: /var/tmp/sage-9.3.rc0-cpython-38-darwin/local/bin\nPATH: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-dcsf70hx/overlay/bin\nPATH: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-dcsf70hx/normal/bin\nPATH: /Users/mkoeppe/s/sage/sage-rebasing/worktree-dist/src/pkgs/sage_conf-relocatable/.tox/python-macos-10.15-python3.8/bin\nPATH: /usr/local/opt/xz/bin\nPATH: /usr/local/opt/gpatch/bin\nPATH: /usr/bin\nPATH: /bin\nPATH: /usr/sbin\nPATH: /sbin\n\nconfigure:20714: checking gmp.h usability\nconfigure:20714: gcc -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -c -O2 -g  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -fno-threadsafe-statics -funroll-loops -fno-delete-null-pointer-checks -Qunused-arguments -pthread -I/usr/local/include  conftest.c >&5\nconfigure:20714: $? = 0\nconfigure:20714: result: yes\n```\n\nIf NTL from homebrew is installed, this can lead to an NTL threading mismatch:\n\n```\n    [singular-4.2.0p1+2021-03-13+sage]   ld: illegal thread local variable reference to regular symbol __ZN3NTL13ErrorCallbackE for architecture x86_64\n    [singular-4.2.0p1+2021-03-13+sage]   clang: error: linker command failed with exit code 1 (use -v to see invocation)\n```\n\n\n\nWe fix this by passing gmp configuration to the Singular configure script.\n\nSee also: #31348 `build/pkgs/{mpir,mpfr}/spkg-configure.m4`: Check pkg-config first\n\nIssue created by migration from https://trac.sagemath.org/ticket/31552\n\n",
    "created_at": "2021-03-24T18:42:44Z",
    "labels": [
        "packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "/usr/local leaks into Singular build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31315",
    "user": "mkoeppe"
}
```
CC:  dimpase slelievre jhpalmieri @zlscherr fbissey vdelecroix arojas

On macOS, even when using `gcc -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk` (which disables use of `/usr/local`), Singular's `configure` script sneaks in `/usr/local/include` and `/usr/local/lib`.


```
It was created by singular configure 4.2.0p1+2021-03-13+sage, which was
generated by GNU Autoconf 2.69.  Invocation command line was

  $ ./configure --prefix=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --libdir=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local/lib --disable-maintainer-mode
 --disable-dependency-tracking --exec-prefix=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --bindir=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local/bin --wit
h-ntl=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --with-flint=/var/tmp/sage-9.3.rc0-cpython-38-darwin/local --enable-gfanlib --enable-Singular --enable-
factory --disable-doc --disable-polymake --without-python --without-pythonmodule --disable-python --disable-python_module --disable-python-module --disable
-static

PATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/build/bin
PATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/src/bin
PATH: /var/tmp/sage-9.3.rc0-cpython-38-darwin/local/bin
PATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/build/bin
PATH: /private/var/tmp/sage-9.3.rc0-cpython-38-darwin/src/bin
PATH: /var/tmp/sage-9.3.rc0-cpython-38-darwin/local/bin
PATH: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-dcsf70hx/overlay/bin
PATH: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-dcsf70hx/normal/bin
PATH: /Users/mkoeppe/s/sage/sage-rebasing/worktree-dist/src/pkgs/sage_conf-relocatable/.tox/python-macos-10.15-python3.8/bin
PATH: /usr/local/opt/xz/bin
PATH: /usr/local/opt/gpatch/bin
PATH: /usr/bin
PATH: /bin
PATH: /usr/sbin
PATH: /sbin

configure:20714: checking gmp.h usability
configure:20714: gcc -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -c -O2 -g  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -fno-threadsafe-statics -funroll-loops -fno-delete-null-pointer-checks -Qunused-arguments -pthread -I/usr/local/include  conftest.c >&5
configure:20714: $? = 0
configure:20714: result: yes
```

If NTL from homebrew is installed, this can lead to an NTL threading mismatch:

```
    [singular-4.2.0p1+2021-03-13+sage]   ld: illegal thread local variable reference to regular symbol __ZN3NTL13ErrorCallbackE for architecture x86_64
    [singular-4.2.0p1+2021-03-13+sage]   clang: error: linker command failed with exit code 1 (use -v to see invocation)
```



We fix this by passing gmp configuration to the Singular configure script.

See also: #31348 `build/pkgs/{mpir,mpfr}/spkg-configure.m4`: Check pkg-config first

Issue created by migration from https://trac.sagemath.org/ticket/31552





---

archive/issue_comments_447674.json:
```json
{
    "body": "Actually, driver error, I ran into #29620 again",
    "created_at": "2021-03-24T19:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447674",
    "user": "mkoeppe"
}
```

Actually, driver error, I ran into #29620 again



---

archive/issue_comments_447675.json:
```json
{
    "body": "But the problem is real - Singular will not use gmp that can be found by compiler and linker if it finds `/usr/local/include/gmp.h`\nThis ought to be fixed upstream.",
    "created_at": "2021-03-24T19:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447675",
    "user": "mkoeppe"
}
```

But the problem is real - Singular will not use gmp that can be found by compiler and linker if it finds `/usr/local/include/gmp.h`
This ought to be fixed upstream.



---

archive/issue_comments_447676.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2021-03-24T19:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447676",
    "user": "mkoeppe"
}
```

Changing priority from critical to major.



---

archive/issue_comments_447677.json:
```json
{
    "body": "It also ignores an explicitly passed gmp directory (using --with-gmp=...) when there is an installation in `/usr/local` because the search loop is missing a `break`. https://github.com/Singular/Singular/blob/spielwiese/m4/gfanlib-check.m4#L40\n\nThis can only be fixed by making a PR + new singular tarball.",
    "created_at": "2021-03-24T21:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447677",
    "user": "mkoeppe"
}
```

It also ignores an explicitly passed gmp directory (using --with-gmp=...) when there is an installation in `/usr/local` because the search loop is missing a `break`. https://github.com/Singular/Singular/blob/spielwiese/m4/gfanlib-check.m4#L40

This can only be fixed by making a PR + new singular tarball.



---

archive/issue_comments_447678.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-03-24T21:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447678",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_447679.json:
```json
{
    "body": "Attachment [singular-4.2.0p1+2021-03-24+sage-2.tar.gz](tarball://root/attachments/some-uuid/ticket31552/singular-4.2.0p1+2021-03-24+sage-2.tar.gz) by mkoeppe created at 2021-03-25 00:05:58",
    "created_at": "2021-03-25T00:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447679",
    "user": "mkoeppe"
}
```

Attachment [singular-4.2.0p1+2021-03-24+sage-2.tar.gz](tarball://root/attachments/some-uuid/ticket31552/singular-4.2.0p1+2021-03-24+sage-2.tar.gz) by mkoeppe created at 2021-03-25 00:05:58



---

archive/issue_comments_447680.json:
```json
{
    "body": "Picking up a newer upstream spielwiese HEAD (which contains a few new commits that look like bugfixes) plus two new PRs: https://github.com/Singular/Singular/pull/1066 and https://github.com/Singular/Singular/pull/1067; the new tarball is made from tag  https://github.com/mkoeppe/Singular/tree/singular-4.2.0p1+2021-03-24%2Bsage-2\n\nRecipe for making the tarball: From within a Sage shell, I used `./configure --with-ntl=/usr/local --with-gmp=/usr/local --disable-pyobject-module --enable-doc-build --with-libparse && make && make dist`\n\n----\nNew commits:",
    "created_at": "2021-03-25T00:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447680",
    "user": "mkoeppe"
}
```

Picking up a newer upstream spielwiese HEAD (which contains a few new commits that look like bugfixes) plus two new PRs: https://github.com/Singular/Singular/pull/1066 and https://github.com/Singular/Singular/pull/1067; the new tarball is made from tag  https://github.com/mkoeppe/Singular/tree/singular-4.2.0p1+2021-03-24%2Bsage-2

Recipe for making the tarball: From within a Sage shell, I used `./configure --with-ntl=/usr/local --with-gmp=/usr/local --disable-pyobject-module --enable-doc-build --with-libparse && make && make dist`

----
New commits:



---

archive/issue_comments_447681.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-25T00:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447681",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_447682.json:
```json
{
    "body": "Upstream has merged the two PRs.\n\nNeeds review",
    "created_at": "2021-03-25T17:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447682",
    "user": "mkoeppe"
}
```

Upstream has merged the two PRs.

Needs review



---

archive/issue_comments_447683.json:
```json
{
    "body": "How to review this?",
    "created_at": "2021-03-25T22:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447683",
    "user": "slelievre"
}
```

How to review this?



---

archive/issue_comments_447684.json:
```json
{
    "body": "This is a tiny increment over the update done in #25993.\nIf it builds, it ships, I'd think",
    "created_at": "2021-03-25T23:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447684",
    "user": "mkoeppe"
}
```

This is a tiny increment over the update done in #25993.
If it builds, it ships, I'd think



---

archive/issue_comments_447685.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> This is a tiny increment over the update done in #25993.\n> If it builds, it ships, I'd think\n\nI'd agree with that. I have been thinking of giving the detection of other libraries the treatment I gave to flint and I decided to give up because I don't need that kind of problem right now. I like the simplicity of your minimal fix.",
    "created_at": "2021-03-25T23:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447685",
    "user": "fbissey"
}
```

Replying to [comment:10 mkoeppe]:
> This is a tiny increment over the update done in #25993.
> If it builds, it ships, I'd think

I'd agree with that. I have been thinking of giving the detection of other libraries the treatment I gave to flint and I decided to give up because I don't need that kind of problem right now. I like the simplicity of your minimal fix.



---

archive/issue_comments_447686.json:
```json
{
    "body": "Tests have been running at https://github.com/mkoeppe/sage/runs/2197735803",
    "created_at": "2021-03-26T05:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447686",
    "user": "mkoeppe"
}
```

Tests have been running at https://github.com/mkoeppe/sage/runs/2197735803



---

archive/issue_comments_447687.json:
```json
{
    "body": "Rather than using our own tarball, it's more common to use patches (and then delete the patches when they're merged in a stable upstream release). Why not do that here?",
    "created_at": "2021-03-29T01:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447687",
    "user": "jhpalmieri"
}
```

Rather than using our own tarball, it's more common to use patches (and then delete the patches when they're merged in a stable upstream release). Why not do that here?



---

archive/issue_comments_447688.json:
```json
{
    "body": "https://doc.sagemath.org/html/en/developer/packaging.html#when-to-patch-when-to-repackage-when-to-autoconfiscate explains why patching is not always possible.\n(In short: Changes to the autotooling are done, and thus the build system is regenerated)",
    "created_at": "2021-03-29T01:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447688",
    "user": "mkoeppe"
}
```

https://doc.sagemath.org/html/en/developer/packaging.html#when-to-patch-when-to-repackage-when-to-autoconfiscate explains why patching is not always possible.
(In short: Changes to the autotooling are done, and thus the build system is regenerated)



---

archive/issue_comments_447689.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> https://doc.sagemath.org/html/en/developer/packaging.html#when-to-patch-when-to-repackage-when-to-autoconfiscate explains why patching is not always possible.\n> (In short: Changes to the autotooling are done, and thus the build system is regenerated)\n\nThe fact that autotools files need to be regenerated is one of the strongest point in favor of cmake compared to autotools for downstream re-packagers in my opinion.",
    "created_at": "2021-03-29T03:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447689",
    "user": "fbissey"
}
```

Replying to [comment:14 mkoeppe]:
> https://doc.sagemath.org/html/en/developer/packaging.html#when-to-patch-when-to-repackage-when-to-autoconfiscate explains why patching is not always possible.
> (In short: Changes to the autotooling are done, and thus the build system is regenerated)

The fact that autotools files need to be regenerated is one of the strongest point in favor of cmake compared to autotools for downstream re-packagers in my opinion.



---

archive/issue_comments_447690.json:
```json
{
    "body": "Beyond the scope of this ticket to switch upstream to another build system.",
    "created_at": "2021-03-29T03:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447690",
    "user": "mkoeppe"
}
```

Beyond the scope of this ticket to switch upstream to another build system.



---

archive/issue_comments_447691.json:
```json
{
    "body": "That was just a general comment. Is there anything holding that ticket? It mostly looks good to me, some of your testruns appear to have failed, one at least for lack of space. Anything more serious?",
    "created_at": "2021-03-29T03:56:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447691",
    "user": "fbissey"
}
```

That was just a general comment. Is there anything holding that ticket? It mostly looks good to me, some of your testruns appear to have failed, one at least for lack of space. Anything more serious?



---

archive/issue_comments_447692.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> Is there anything holding that ticket?\nNot as far as I can see",
    "created_at": "2021-03-29T03:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447692",
    "user": "mkoeppe"
}
```

Replying to [comment:17 fbissey]:
> Is there anything holding that ticket?
Not as far as I can see



---

archive/issue_comments_447693.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-29T04:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447693",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_447694.json:
```json
{
    "body": "I am putting my name on the reviewer field then. Ship it.",
    "created_at": "2021-03-29T04:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447694",
    "user": "fbissey"
}
```

I am putting my name on the reviewer field then. Ship it.



---

archive/issue_comments_447695.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-03-29T04:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447695",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_447696.json:
```json
{
    "body": "Next ticket in the same direction: #31562",
    "created_at": "2021-03-29T04:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447696",
    "user": "mkoeppe"
}
```

Next ticket in the same direction: #31562



---

archive/issue_comments_447697.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-03-29T23:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447697",
    "user": "mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_447698.json:
```json
{
    "body": "Setting priority to blocker to bring this ticket to the attention of the release bot.",
    "created_at": "2021-03-29T23:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447698",
    "user": "mkoeppe"
}
```

Setting priority to blocker to bring this ticket to the attention of the release bot.



---

archive/issue_comments_447699.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-02T22:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31315",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31315#issuecomment-447699",
    "user": "vbraun"
}
```

Resolution: fixed
