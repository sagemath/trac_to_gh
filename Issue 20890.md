# Issue 20890: py3: turn some divisions in compatible format

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2016-07-29 13:38:34

CC:  tscrim jdemeyer dimpase darij jmantysalo

as part of #15995 and a step towards python3


---

Comment by chapoton created at 2016-07-29 13:39:43

New commits:


---

Comment by chapoton created at 2016-07-29 13:39:43

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-07-29 14:12:17

It would be nice if you would add `from __future__ import division` to those modules.

This might actually fix the doctest in `delsarte_bounds.py` with `check=False`.


---

Comment by git created at 2016-07-29 14:49:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-07-29 14:52:28

I added import except in the 2 files in misc, because that was changing the behavior
and causing doctest failures.


---

Comment by chapoton created at 2016-08-01 10:08:26

ping ?


---

Comment by jdemeyer created at 2016-08-02 13:07:52

This is not very fun to review because it is not something which can be done "mechanically". I actually have to read and understand the code to check whether the change is good. And when I see 15 files changed like this, it seems like a lot of work.


---

Comment by chapoton created at 2016-08-02 16:42:46

yes, I agree that this is not an easy review. But at least 4 of the files are
just modified by adding `optional - python2`.

And two other ones are just adding `...divide` so that the doctest can contain either `divide`or `true_divide`

In the coding file, we just get a correct result instead of an incorrect (but doctested) one.

In the two combinat files, the divisions are exact by congruence imposed on the parameters.

For the graph one, we divide by two an even quantity

For the logic one, we divide by 2 to perform a bit shift

for the knots one, I am not very sure of my change, but the doctests pass.

The crypto and hyperbolic are probably the more subtle ones.


---

Comment by jdemeyer created at 2016-08-03 12:26:26

How did you come up with this patch actually? Your branch seems to contain a random selection of files within Sage. Probably there are a lot of files which needs divisions fixed, so why this selection of files to fix?


---

Comment by chapoton created at 2016-08-03 12:32:02

See the bottom of the description of #15995:

```
export PYTHONIOENCODING="utf-8"
source ./local/bin/sage-env
python -Qnew ./local/bin/sage-runtests --all
```

This runs all the tests with the new division behaviour. I have corrected here most of the failing doctests. There remains a few more difficult cases, where I have not been able to locate the problem.


---

Comment by jdemeyer created at 2016-08-08 05:21:48

I think we need a better strategy to deal with divisions.

Ideally, I would like to have a record of every single division operation in Sage. Then, for every division in the Sage sources:
1. If that division sometimes has a Sage `Element` as one of the arguments, it should be replaced by a true division.
2. If that division is always an `int`/`int` division, it should be replaced by a floor division.

I think this would take care of most divisions correctly.


---

Comment by jdemeyer created at 2016-08-08 06:57:17

Python actually has a script [fixdiv.py](http://svn.python.org/projects/python/trunk/Tools/scripts/fixdiv.py) which more-or-less does this.


---

Comment by jdemeyer created at 2016-08-08 07:01:52

Hmm.. the `-Qxxx` command-line options only affect warnings for Python standard types. There is no way to get a warning for _every_ division, regardless of type.


---

Comment by chapoton created at 2016-08-08 07:22:30

The need to find a better strategy should not prevent this ticket to be validated.

Anyway, I think our main problem now is `cmp` and all its friends.


---

Comment by jdemeyer created at 2016-08-08 07:25:32

Replying to [comment:13 chapoton]:
> Anyway, I think our main problem now is `cmp` and all its friends.

Hmm, it depends how you look at it. I think that divisions are still harder, mainly because decisions need to be made on a case-by-case basis. For `__cmp__`, things are simple: we need to fix everything and we can do that in a pretty uniform way. It is surely a lot of work but at least relatively easy work.


---

Comment by jdemeyer created at 2016-08-08 07:26:10

Replying to [comment:13 chapoton]:
> The need to find a better strategy should not prevent this ticket to be validated.

Ideally, that better strategy would make this ticket obsolete.


---

Comment by chapoton created at 2016-08-10 16:05:17

I would nevertheless like to have this ticket reviewed. Any volunteer ?


---

Comment by chapoton created at 2016-08-15 07:53:57

*ping* !


---

Comment by jmantysalo created at 2016-08-15 08:36:23

I guess I can look these.

(At the same time this is a test message. It seems that "Active tickets I participated in" do not contain ticket I have been CC'ed any more.)


---

Comment by jmantysalo created at 2016-08-15 09:19:45

You did


```
-        s = RR(1/(RR(n).sqrt() * log(n, 2)**2) * q)
+        s = q / (RR(n).sqrt() * log(n, 2)**2)
```


and now if we have, say, `n=42`, we got numerical `9.43000415102671` from current version and symbolic `274.197052882637*log(2)<sup>2/log(42)</sup>2` from the new version. This should be asked before the change.

E: I don't think I can be sure about changes to `src/sage/crypto/lwe.py` and hope someone else will review this one.


---

Comment by git created at 2016-08-15 12:29:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-16 16:34:30

I have taken your remark into account. Do you see something else ?


---

Comment by jmantysalo created at 2016-08-16 16:43:20

Replying to [comment:22 chapoton]:
> I have taken your remark into account. Do you see something else ?

Hmm... There was

`sk = ceil((C*(n1+n2))**(3/2))`

and in python2 for example `100**(3/2)` is `100`, whereas in python3 it is `1000.0`. But this seems to be a clear bug in current implementation. Maybe your change actually corrects this!

But I can not review this, as I do not know what `lwe.py` should do.


---

Comment by chapoton created at 2016-08-16 16:46:13

I do not understand what lwe should do either.

Would you give a positive rev. if I revert the changes to lwe ?


---

Comment by jmantysalo created at 2016-08-16 18:00:37

Replying to [comment:24 chapoton]:

> Would you give a positive rev. if I revert the changes to lwe ?

I guess so, but haven't read every line yet.


---

Comment by chapoton created at 2016-08-16 18:10:48

here is a clean branch with no changes to the file crypto/lwe.py
----
New commits:


---

Comment by jmantysalo created at 2016-08-17 06:33:13

Changing status from needs_review to positive_review.


---

Comment by jmantysalo created at 2016-08-17 06:33:13

OK, I checked the rest.


---

Comment by vbraun created at 2016-08-19 22:45:05

Resolution: fixed


---

Comment by embray created at 2018-02-23 13:35:04

Changing keywords from "" to "division".
