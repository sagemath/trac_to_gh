# Issue 20890: py3: turn some divisions in compatible format

archive/issues_020890.json:
```json
{
    "body": "CC:  tscrim jdemeyer dimpase darij jmantysalo\n\nas part of #15995 and a step towards python3\n\nIssue created by migration from https://trac.sagemath.org/ticket/21127\n\n",
    "created_at": "2016-07-29T13:38:34Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: turn some divisions in compatible format",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20890",
    "user": "chapoton"
}
```
CC:  tscrim jdemeyer dimpase darij jmantysalo

as part of #15995 and a step towards python3

Issue created by migration from https://trac.sagemath.org/ticket/21127





---

archive/issue_comments_288807.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-07-29T13:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288807",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_288808.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-29T13:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288808",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_288809.json:
```json
{
    "body": "It would be nice if you would add `from __future__ import division` to those modules.\n\nThis might actually fix the doctest in `delsarte_bounds.py` with `check=False`.",
    "created_at": "2016-07-29T14:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288809",
    "user": "jdemeyer"
}
```

It would be nice if you would add `from __future__ import division` to those modules.

This might actually fix the doctest in `delsarte_bounds.py` with `check=False`.



---

archive/issue_comments_288810.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-29T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288810",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288811.json:
```json
{
    "body": "I added import except in the 2 files in misc, because that was changing the behavior\nand causing doctest failures.",
    "created_at": "2016-07-29T14:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288811",
    "user": "chapoton"
}
```

I added import except in the 2 files in misc, because that was changing the behavior
and causing doctest failures.



---

archive/issue_comments_288812.json:
```json
{
    "body": "ping ?",
    "created_at": "2016-08-01T10:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288812",
    "user": "chapoton"
}
```

ping ?



---

archive/issue_comments_288813.json:
```json
{
    "body": "This is not very fun to review because it is not something which can be done \"mechanically\". I actually have to read and understand the code to check whether the change is good. And when I see 15 files changed like this, it seems like a lot of work.",
    "created_at": "2016-08-02T13:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288813",
    "user": "jdemeyer"
}
```

This is not very fun to review because it is not something which can be done "mechanically". I actually have to read and understand the code to check whether the change is good. And when I see 15 files changed like this, it seems like a lot of work.



---

archive/issue_comments_288814.json:
```json
{
    "body": "yes, I agree that this is not an easy review. But at least 4 of the files are\njust modified by adding `optional - python2`.\n\nAnd two other ones are just adding `...divide` so that the doctest can contain either `divide`or `true_divide`\n\nIn the coding file, we just get a correct result instead of an incorrect (but doctested) one.\n\nIn the two combinat files, the divisions are exact by congruence imposed on the parameters.\n\nFor the graph one, we divide by two an even quantity\n\nFor the logic one, we divide by 2 to perform a bit shift\n\nfor the knots one, I am not very sure of my change, but the doctests pass.\n\nThe crypto and hyperbolic are probably the more subtle ones.",
    "created_at": "2016-08-02T16:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288814",
    "user": "chapoton"
}
```

yes, I agree that this is not an easy review. But at least 4 of the files are
just modified by adding `optional - python2`.

And two other ones are just adding `...divide` so that the doctest can contain either `divide`or `true_divide`

In the coding file, we just get a correct result instead of an incorrect (but doctested) one.

In the two combinat files, the divisions are exact by congruence imposed on the parameters.

For the graph one, we divide by two an even quantity

For the logic one, we divide by 2 to perform a bit shift

for the knots one, I am not very sure of my change, but the doctests pass.

The crypto and hyperbolic are probably the more subtle ones.



---

archive/issue_comments_288815.json:
```json
{
    "body": "How did you come up with this patch actually? Your branch seems to contain a random selection of files within Sage. Probably there are a lot of files which needs divisions fixed, so why this selection of files to fix?",
    "created_at": "2016-08-03T12:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288815",
    "user": "jdemeyer"
}
```

How did you come up with this patch actually? Your branch seems to contain a random selection of files within Sage. Probably there are a lot of files which needs divisions fixed, so why this selection of files to fix?



---

archive/issue_comments_288816.json:
```json
{
    "body": "See the bottom of the description of #15995:\n\n```\nexport PYTHONIOENCODING=\"utf-8\"\nsource ./local/bin/sage-env\npython -Qnew ./local/bin/sage-runtests --all\n```\n\nThis runs all the tests with the new division behaviour. I have corrected here most of the failing doctests. There remains a few more difficult cases, where I have not been able to locate the problem.",
    "created_at": "2016-08-03T12:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288816",
    "user": "chapoton"
}
```

See the bottom of the description of #15995:

```
export PYTHONIOENCODING="utf-8"
source ./local/bin/sage-env
python -Qnew ./local/bin/sage-runtests --all
```

This runs all the tests with the new division behaviour. I have corrected here most of the failing doctests. There remains a few more difficult cases, where I have not been able to locate the problem.



---

archive/issue_comments_288817.json:
```json
{
    "body": "I think we need a better strategy to deal with divisions.\n\nIdeally, I would like to have a record of every single division operation in Sage. Then, for every division in the Sage sources:\n1. If that division sometimes has a Sage `Element` as one of the arguments, it should be replaced by a true division.\n2. If that division is always an `int`/`int` division, it should be replaced by a floor division.\n\nI think this would take care of most divisions correctly.",
    "created_at": "2016-08-08T05:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288817",
    "user": "jdemeyer"
}
```

I think we need a better strategy to deal with divisions.

Ideally, I would like to have a record of every single division operation in Sage. Then, for every division in the Sage sources:
1. If that division sometimes has a Sage `Element` as one of the arguments, it should be replaced by a true division.
2. If that division is always an `int`/`int` division, it should be replaced by a floor division.

I think this would take care of most divisions correctly.



---

archive/issue_comments_288818.json:
```json
{
    "body": "Python actually has a script [fixdiv.py](http://svn.python.org/projects/python/trunk/Tools/scripts/fixdiv.py) which more-or-less does this.",
    "created_at": "2016-08-08T06:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288818",
    "user": "jdemeyer"
}
```

Python actually has a script [fixdiv.py](http://svn.python.org/projects/python/trunk/Tools/scripts/fixdiv.py) which more-or-less does this.



---

archive/issue_comments_288819.json:
```json
{
    "body": "Hmm.. the `-Qxxx` command-line options only affect warnings for Python standard types. There is no way to get a warning for *every* division, regardless of type.",
    "created_at": "2016-08-08T07:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288819",
    "user": "jdemeyer"
}
```

Hmm.. the `-Qxxx` command-line options only affect warnings for Python standard types. There is no way to get a warning for *every* division, regardless of type.



---

archive/issue_comments_288820.json:
```json
{
    "body": "The need to find a better strategy should not prevent this ticket to be validated.\n\nAnyway, I think our main problem now is `cmp` and all its friends.",
    "created_at": "2016-08-08T07:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288820",
    "user": "chapoton"
}
```

The need to find a better strategy should not prevent this ticket to be validated.

Anyway, I think our main problem now is `cmp` and all its friends.



---

archive/issue_comments_288821.json:
```json
{
    "body": "Replying to [comment:13 chapoton]:\n> Anyway, I think our main problem now is `cmp` and all its friends.\n\nHmm, it depends how you look at it. I think that divisions are still harder, mainly because decisions need to be made on a case-by-case basis. For `__cmp__`, things are simple: we need to fix everything and we can do that in a pretty uniform way. It is surely a lot of work but at least relatively easy work.",
    "created_at": "2016-08-08T07:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288821",
    "user": "jdemeyer"
}
```

Replying to [comment:13 chapoton]:
> Anyway, I think our main problem now is `cmp` and all its friends.

Hmm, it depends how you look at it. I think that divisions are still harder, mainly because decisions need to be made on a case-by-case basis. For `__cmp__`, things are simple: we need to fix everything and we can do that in a pretty uniform way. It is surely a lot of work but at least relatively easy work.



---

archive/issue_comments_288822.json:
```json
{
    "body": "Replying to [comment:13 chapoton]:\n> The need to find a better strategy should not prevent this ticket to be validated.\n\nIdeally, that better strategy would make this ticket obsolete.",
    "created_at": "2016-08-08T07:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288822",
    "user": "jdemeyer"
}
```

Replying to [comment:13 chapoton]:
> The need to find a better strategy should not prevent this ticket to be validated.

Ideally, that better strategy would make this ticket obsolete.



---

archive/issue_comments_288823.json:
```json
{
    "body": "I would nevertheless like to have this ticket reviewed. Any volunteer ?",
    "created_at": "2016-08-10T16:05:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288823",
    "user": "chapoton"
}
```

I would nevertheless like to have this ticket reviewed. Any volunteer ?



---

archive/issue_comments_288824.json:
```json
{
    "body": "*ping* !",
    "created_at": "2016-08-15T07:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288824",
    "user": "chapoton"
}
```

*ping* !



---

archive/issue_comments_288825.json:
```json
{
    "body": "I guess I can look these.\n\n(At the same time this is a test message. It seems that \"Active tickets I participated in\" do not contain ticket I have been CC'ed any more.)",
    "created_at": "2016-08-15T08:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288825",
    "user": "jmantysalo"
}
```

I guess I can look these.

(At the same time this is a test message. It seems that "Active tickets I participated in" do not contain ticket I have been CC'ed any more.)



---

archive/issue_comments_288826.json:
```json
{
    "body": "You did\n\n\n```\n-        s = RR(1/(RR(n).sqrt() * log(n, 2)**2) * q)\n+        s = q / (RR(n).sqrt() * log(n, 2)**2)\n```\n\n\nand now if we have, say, `n=42`, we got numerical `9.43000415102671` from current version and symbolic `274.197052882637*log(2)<sup>2/log(42)</sup>2` from the new version. This should be asked before the change.\n\nE: I don't think I can be sure about changes to `src/sage/crypto/lwe.py` and hope someone else will review this one.",
    "created_at": "2016-08-15T09:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288826",
    "user": "jmantysalo"
}
```

You did


```
-        s = RR(1/(RR(n).sqrt() * log(n, 2)**2) * q)
+        s = q / (RR(n).sqrt() * log(n, 2)**2)
```


and now if we have, say, `n=42`, we got numerical `9.43000415102671` from current version and symbolic `274.197052882637*log(2)<sup>2/log(42)</sup>2` from the new version. This should be asked before the change.

E: I don't think I can be sure about changes to `src/sage/crypto/lwe.py` and hope someone else will review this one.



---

archive/issue_comments_288827.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-15T12:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288827",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_288828.json:
```json
{
    "body": "I have taken your remark into account. Do you see something else ?",
    "created_at": "2016-08-16T16:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288828",
    "user": "chapoton"
}
```

I have taken your remark into account. Do you see something else ?



---

archive/issue_comments_288829.json:
```json
{
    "body": "Replying to [comment:22 chapoton]:\n> I have taken your remark into account. Do you see something else ?\n\nHmm... There was\n\n`sk = ceil((C*(n1+n2))**(3/2))`\n\nand in python2 for example `100**(3/2)` is `100`, whereas in python3 it is `1000.0`. But this seems to be a clear bug in current implementation. Maybe your change actually corrects this!\n\nBut I can not review this, as I do not know what `lwe.py` should do.",
    "created_at": "2016-08-16T16:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288829",
    "user": "jmantysalo"
}
```

Replying to [comment:22 chapoton]:
> I have taken your remark into account. Do you see something else ?

Hmm... There was

`sk = ceil((C*(n1+n2))**(3/2))`

and in python2 for example `100**(3/2)` is `100`, whereas in python3 it is `1000.0`. But this seems to be a clear bug in current implementation. Maybe your change actually corrects this!

But I can not review this, as I do not know what `lwe.py` should do.



---

archive/issue_comments_288830.json:
```json
{
    "body": "I do not understand what lwe should do either.\n\nWould you give a positive rev. if I revert the changes to lwe ?",
    "created_at": "2016-08-16T16:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288830",
    "user": "chapoton"
}
```

I do not understand what lwe should do either.

Would you give a positive rev. if I revert the changes to lwe ?



---

archive/issue_comments_288831.json:
```json
{
    "body": "Replying to [comment:24 chapoton]:\n\n> Would you give a positive rev. if I revert the changes to lwe ?\n\nI guess so, but haven't read every line yet.",
    "created_at": "2016-08-16T18:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288831",
    "user": "jmantysalo"
}
```

Replying to [comment:24 chapoton]:

> Would you give a positive rev. if I revert the changes to lwe ?

I guess so, but haven't read every line yet.



---

archive/issue_comments_288832.json:
```json
{
    "body": "here is a clean branch with no changes to the file crypto/lwe.py\n----\nNew commits:",
    "created_at": "2016-08-16T18:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288832",
    "user": "chapoton"
}
```

here is a clean branch with no changes to the file crypto/lwe.py
----
New commits:



---

archive/issue_comments_288833.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-17T06:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288833",
    "user": "jmantysalo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_288834.json:
```json
{
    "body": "OK, I checked the rest.",
    "created_at": "2016-08-17T06:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288834",
    "user": "jmantysalo"
}
```

OK, I checked the rest.



---

archive/issue_comments_288835.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-19T22:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288835",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_288836.json:
```json
{
    "body": "Changing keywords from \"\" to \"division\".",
    "created_at": "2018-02-23T13:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20890",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20890#issuecomment-288836",
    "user": "embray"
}
```

Changing keywords from "" to "division".
