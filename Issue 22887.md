# Issue 22887: Fix sig_on/sig_off in boost_graph.pyx

Issue created by migration from https://trac.sagemath.org/ticket/23124

Original creator: jdemeyer

Original creation time: 2017-06-01 14:02:07

CC:  borassi dcoudert

The file `src/sage/graphs/base/boost_graph.pyx` is full of bad uses of `sig_on()`/`sig_off()`: one should never put Python code in a `sig_on()` block.


---

Comment by jdemeyer created at 2017-06-01 15:24:46

New commits:


---

Comment by jdemeyer created at 2017-06-01 15:24:54

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-06-03 00:28:25

LGTM (as far as my understanding of how to use `sig_on`/`sig_off`).


---

Comment by tscrim created at 2017-06-03 00:28:25

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2017-06-03 10:19:45

Thank you for this patch. I was not aware of the good use of `sig_on/sig_off`.

I have several compilation warnings. For instance

```
/Users/dcoudert/sage/src/build/cythonized/sage/graphs/base/boost_graph.cpp:5210:11: warning: '__pyx_v_vi' may be used uninitialized in this function [-Wmaybe-uninitialized]
   v_index __pyx_v_vi;
           ^
/Users/dcoudert/sage/src/build/cythonized/sage/graphs/base/boost_graph.cpp:5223:15: warning: '__pyx_t_9' may be used uninitialized in this function [-Wmaybe-uninitialized]
   PyObject *(*__pyx_t_9)(PyObject *);
               ^
In file included from /Users/dcoudert/sage/src/build/cythonized/sage/graphs/base/boost_graph.cpp:498:0:
/Users/dcoudert/sage/local/lib/python2.7/site-packages/cysignals/macros.h:114:125: warning: '<anonymous>' may be used uninitialized in this function [-Wmaybe-uninitialized]
 #define _sig_on_(message) ( unlikely(_sig_on_prejmp(message, __FILE__, __LINE__)) || _sig_on_postjmp(sigsetjmp(cysigs.env,0)) )
                                                                                                                             ^
/Users/dcoudert/sage/local/lib/python2.7/site-packages/cysignals/macros.h:114:125: note: '<anonymous>' was declared here
 #define _sig_on_(message) ( unlikely(_sig_on_prejmp(message, __FILE__, __LINE__)) || _sig_on_postjmp(sigsetjmp(cysigs.env,0)) )
                                                                                                                             ^
/Users/dcoudert/sage/local/lib/python2.7/site-packages/cysignals/macros.h:207:28: note: in expansion of macro '_sig_on_'
 #define sig_on()           _sig_on_(NULL)
                            ^
```


In method `boost_clustering_coeff`, could you explain why you use intermediate variable `cdef v_index vi` before the call `result_d = g[0].clustering_coeff(vi)` (in a `sig_on/sig_off` block). I don't understand the motivation behind.


---

Comment by jdemeyer created at 2017-06-03 12:59:19

Replying to [comment:10 dcoudert]:
> Thank you for this patch. I was not aware of the good use of `sig_on/sig_off`.

The most important rule which is often forgotten is that you should not manipulate any Python objects inside `sig_on()`.

> I have several compilation warnings.

I know that there are several `-Wmaybe-uninitialized` warnings. But they are false positives (as far as I can tell). I fixed all other warnings.

> In method `boost_clustering_coeff`, could you explain why you use intermediate variable `cdef v_index vi` before the call `result_d = g[0].clustering_coeff(vi)` (in a `sig_on/sig_off` block). I don't understand the motivation behind.

See the "most important rule": `v` is a Python object, so we should do the conversion Python -> C outside of the `sig_on()` block.


---

Comment by dcoudert created at 2017-06-04 08:31:55

I will try to remember it. Thanks.


---

Comment by vbraun created at 2017-06-07 20:13:08

Resolution: fixed
