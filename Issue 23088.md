# Issue 23088: Upgrade to Pynac-0.7.9

Issue created by migration from https://trac.sagemath.org/ticket/23325

Original creator: rws

Original creation time: 2017-06-26 07:40:53

CC:  fbissey

In the new version:
* remove static PyObjects; (#23134)
* (real<sup>m)</sup>(1/n) --> abs(real)^(m/n), m even, m/n integer (#14305)
* fix `add::conjugate()` (#23135)
* fix `is_real(zeta(real))`
* negative symbolic domain from assume(sym<0) (#21973)
* add missing calls to `set_domain` in symbol constructors (#23138)
* implement `add.info(negative)`
* exact comparison of `overall_coefficient`s
* fast internal in-place arithmetic operators
* obsolete some internal usages of Python

https://github.com/pynac/pynac/releases/download/pynac-0.7.9/pynac-0.7.9.tar.bz2


---

Comment by rws created at 2017-06-26 07:50:27

New commits:


---

Comment by rws created at 2017-06-26 07:50:27

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-06-26 13:26:23

I don't agree with the change to `py_get_parent_char`: why assume characteristic zero if the parent cannot decide?


---

Comment by jdemeyer created at 2017-06-26 13:26:23

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-06-26 13:28:07

If you revert the change to `py_get_parent_char` and all doctests pass, you can set this to positive review.


---

Comment by rws created at 2017-06-27 06:28:10

That's a no, because this then needs investigation (doctest fail at src/sage/manifolds/differentiable/diff_form.py:796):

```
sage: M = Manifold(3, 'R3', '\RR^3', start_index=1)
sage: c_cart.<x,y,z> = M.chart()
sage: eps = M.diff_form(3, 'epsilon', r'\epsilon')
sage: eps[1,2,3] = 1
sage: a = M.one_form('A')
sage: a[:] = (x*y*z, -z*x, y*z)
sage: b = M.one_form('B')
sage: b[:] = (cos(z), sin(x), cos(y))
sage: ab = a.wedge(b)
sage: dab = ab.exterior_derivative()
sage: dab[[1,2,3]]/eps[[1,2,3]]
...
/home/ralf/sage/src/sage/structure/element.pyx in sage.structure.element.RingElement._div_ (build/cythonized/sage/structure/element.c:17655)()
   2453         return l
   2454 
-> 2455     cpdef _div_(self, other):
   2456         """
   2457         Default implementation of division using the fraction field.

/home/ralf/sage/local/lib/python2.7/site-packages/sage/manifolds/coord_func_symb.pyc in _div_(self, other)
    947         if other._express.is_zero():
    948             raise ZeroDivisionError("division of a coordinate function by zero")
--> 949         res = self._simplify(self._express / SR(other))
    950         if res.is_trivial_zero():  # NB: "if res == 0" would be too
    951                                    # expensive (cf. #22859)

/home/ralf/sage/src/sage/structure/element.pyx in sage.structure.element.Element.__div__ (build/cythonized/sage/structure/element.c:12950)()
   1638         cdef int cl = classify_elements(left, right)
   1639         if HAVE_SAME_PARENT(cl):
-> 1640             return (<Element>left)._div_(right)
   1641         if BOTH_ARE_ELEMENT(cl):
   1642             return coercion_model.bin_op(left, right, div)

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._div_ (build/cythonized/sage/symbolic/expression.cpp:24795)()
   3445                 raise ZeroDivisionError("Symbolic division by zero")
   3446             else:
-> 3447                 raise
   3448         finally:
   3449             sig_off()

/home/ralf/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._div_ (build/cythonized/sage/symbolic/expression.cpp:24684)()
   3437                                o)
   3438             else:
-> 3439                 x = left._gobj / _right._gobj
   3440             return new_Expression_from_GEx(left._parent, x)
   3441         except Exception as msg:

/home/ralf/sage/src/sage/libs/pynac/pynac.pyx in sage.libs.pynac.pynac.py_get_parent_char (build/cythonized/sage/libs/pynac/pynac.cpp:9942)()
    818         return 0
    819 
--> 820     c = (<Element>o)._parent.characteristic()
    821 
    822     # Pynac only differentiates between

/home/ralf/sage/local/lib/python2.7/site-packages/sage/categories/rings.pyc in characteristic(self)
    461             from sage.rings.infinity import infinity
    462             from sage.rings.integer_ring import ZZ
--> 463             order_1 = self.one().additive_order()
    464             return ZZ.zero() if order_1 is infinity else order_1
    465 

/home/ralf/sage/src/sage/structure/element.pyx in sage.structure.element.RingElement.additive_order (build/cythonized/sage/structure/element.c:18049)()
   2470         Return the additive order of ``self``.
   2471         """
-> 2472         raise NotImplementedError
   2473 
   2474     def multiplicative_order(self):

NotImplementedError: 

sage: dab[[1,2,3]]
Scalar field on the 3-dimensional differentiable manifold R3
sage: type(_)
<class 'sage.manifolds.differentiable.scalarfield_algebra.DiffScalarFieldAlgebra_with_category.element_class'>
sage: eps[[1,2,3]]
Scalar field on the 3-dimensional differentiable manifold R3
sage: type(_)
<class 'sage.manifolds.differentiable.scalarfield_algebra.DiffScalarFieldAlgebra_with_category.element_class'>

sage: parent(dab[[1,2,3]])
Algebra of differentiable scalar fields on the 3-dimensional differentiable manifold R3
sage: parent(eps[[1,2,3]])
Algebra of differentiable scalar fields on the 3-dimensional differentiable manifold R3
```

While this is triggered by changes in Pynac that should be addressed it's not clear to me why the division of two scalar fields must go through `SR` at all.


---

Comment by jdemeyer created at 2017-06-27 08:15:27

I will have a look.


---

Comment by rws created at 2017-06-27 08:32:54

The reason why this is now failing is that the quotient here, which is `1` but not integer, is now recognized as `is_one` and triggers the `...pos_char` call.

https://github.com/pynac/pynac/blob/master/ginac/mul.cpp#L702

Removing the call altogether in preliminary testing only fails one doctest involving `Mod` and, frankly, I could care less. Full testing now.


---

Comment by jdemeyer created at 2017-06-27 08:46:37

I think the best solution here is simply to implement `characteric` for the "Ring of coordinate functions".


---

Comment by git created at 2017-06-27 12:42:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-04 14:44:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-08-04 14:47:42

Correct is 0.7.10 not 2.7.10.


---

Comment by git created at 2017-08-05 07:15:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-06 07:28:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-08-06 08:42:12

May we please change the .configure line in spkg-install to

```
    ./configure --disable-static --prefix=${SAGE_LOCAL} --with-giac=no --libdir=
"$SAGE_LOCAL/lib" PYTHON=sage-python23
```

to ensure compatibility with python3 ?


---

Comment by git created at 2017-08-06 12:57:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-08-06 14:24:43

If you looked at the doctest changes you probably have noticed natural simplifications where quadratic numeric factors inside `sqrt` are drawn out of the root. I will have to revert this behaviour, unfortunately. There is code in the Sage code base that relies on that root content is not changed, because it allows manipulations leading to expressions that can later be better simplified by Maxima's simplification functions. Apparently none of these functions is able to normalize root content in complicated expressions. I will maybe implement it separately, similar to `gamma_normalize`, for inclusion in `simplify_full` but releasing pynac-0.7.10 is more urgent.


---

Comment by rws created at 2017-08-09 06:57:56

I made a new branch. Please review.
----
New commits:


---

Comment by rws created at 2017-08-09 06:57:56

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-08-09 10:52:26

For ease of reviewing, I would prefer to wait until the dependencies have been merged.


---

Comment by git created at 2017-08-10 07:03:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-08-10 11:51:23

I don't think this is a valid way to revert a merge. Either you really revert the merge (by rewriting git history as if the merge never happened), or you keep the dependency on #23582.


---

Comment by jdemeyer created at 2017-08-10 11:51:23

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-08-10 12:56:46

Nice opportunity for the rarely used `git rebase -i`.
----
New commits:


---

Comment by rws created at 2017-08-10 12:58:19

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-08-11 07:42:55

Replying to [comment:31 rws]:
> Nice opportunity for the rarely used `git rebase -i`.

I use that all the time...


---

Comment by jdemeyer created at 2017-08-11 11:27:37

New commits:


---

Comment by jdemeyer created at 2017-08-11 11:27:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-08-13 09:45:02

Resolution: fixed


---

Comment by vbraun created at 2017-08-13 18:29:18

Resolution changed from fixed to 


---

Comment by vbraun created at 2017-08-13 18:29:18

Fails on 32-bit Linux

```
**********************************************************************
File "src/doc/de/thematische_anleitungen/sage_gymnasium.rst", line 191, in doc.de.thematische_anleitungen.sage_gymnasium
Failed example:
    sqrt(18)
Expected:
    3*sqrt(2)
Got:
    sqrt(18)
**********************************************************************
1 item had failures:
   1 of 294 in doc.de.thematische_anleitungen.sage_gymnasium
    [207 tests, 1 failure, 5.39 s]
**********************************************************************
File "src/sage/functions/orthogonal_polys.py", line 1668, in sage.functions.orthogonal_polys.Func_assoc_legendre_Q._eval_
Failed example:
    gen_legendre_Q(2,1,3)
Expected:
    -1/4*sqrt(-2)*(-36*I*pi + 36*log(4) - 36*log(2) - 25)
Got:
    -1/8*sqrt(-8)*(-36*I*pi + 36*log(4) - 36*log(2) - 25)
**********************************************************************
1 item had failures:
   1 of   2 in sage.functions.orthogonal_polys.Func_assoc_legendre_Q._eval_
    [378 tests, 1 failure, 7.79 s]
**********************************************************************
File "src/sage/rings/number_field/number_field_base.pyx", line 219, in sage.rings.number_field.number_field_base.NumberField.minkowski_bound
Failed example:
    B = K.minkowski_bound(); B
Expected:
    16/3*sqrt(3)/pi
Got:
    8/9*sqrt(108)/pi
**********************************************************************
File "src/sage/rings/number_field/number_field_base.pyx", line 230, in sage.rings.number_field.number_field_base.NumberField.minkowski_bound
Failed example:
    B = K.minkowski_bound(); B
Expected:
    sqrt(10)
Got:
    1/2*sqrt(40)
**********************************************************************
1 item had failures:
   2 of  19 in sage.rings.number_field.number_field_base.NumberField.minkowski_bound
    [74 tests, 2 failures, 2.09 s]
**********************************************************************
File "src/sage/rings/real_mpfr.pyx", line 3961, in sage.rings.real_mpfr.RealNumber.sqrt
Failed example:
    r.sqrt()
Expected:
    2*sqrt(1086)
Got:
    sqrt(4344)
**********************************************************************
1 item had failures:
   1 of  13 in sage.rings.real_mpfr.RealNumber.sqrt
    [1000 tests, 1 failure, 3.14 s]
```



---

Comment by vbraun created at 2017-08-13 18:29:18

Changing status from closed to new.


---

Comment by rws created at 2017-08-16 08:10:51

Okay, I'm installing virtualization (a first) and Ubuntu 32-bit to get the ability to test on 32-bit.


---

Comment by rws created at 2017-08-19 06:50:45

STDERR: error: Server does not allow request for unadvertised object b54f51bab33a602448c1b3e2f719fb375661aac3

So I'll push to my previous branch `u/rws/23325-1` (including Jeroen's fix) in the hope you can pick up its last commit, which contains a last-minute fix.


---

Comment by rws created at 2017-08-19 06:55:58

New commits:


---

Comment by rws created at 2017-08-19 06:55:58

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-08-22 22:53:55

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-08-22 22:53:55

I think it can just be put back to positive review. Especially if the last fix is the stuff for 32bits problems.


---

Comment by vbraun created at 2017-08-29 19:51:09

Resolution: fixed
