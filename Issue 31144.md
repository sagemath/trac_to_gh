# Issue 31144: Edge option "--" of G.graphviz_string method output is ignored

Issue created by migration from https://trac.sagemath.org/ticket/31381

Original creator: slabbe

Original creation time: 2021-02-11 11:33:11

If `G` is a digraph, the documentation of `G.graphviz_string` says the following work:


```
sage: f(x) = -1 / x
sage: g(x) = 1 / (x + 1)
sage: G = DiGraph()
sage: G.add_edges((i, f(i), f) for i in (1, 2, 1/2, 1/4))
sage: G.add_edges((i, g(i), g) for i in (1, 2, 1/2, 1/4))
sage: print(G.graphviz_string())
digraph {
  node_0  [label="-1"];
  node_1  [label="-1/2"];
  node_2  [label="1/2"];
  node_3  [label="-2"];
  node_4  [label="1/4"];
  node_5  [label="-4"];
  node_6  [label="1/3"];
  node_7  [label="2/3"];
  node_8  [label="4/5"];
  node_9  [label="1"];
  node_10  [label="2"];

  node_2 -> node_3;
  node_2 -> node_7;
  node_4 -> node_5;
  node_4 -> node_8;
  node_9 -> node_0;
  node_9 -> node_2;
  node_10 -> node_1;
  node_10 -> node_6;
}
```

Indeed, it works:

```
sage: TikzPicture.from_graph(G).pdf()
```


At the end of `G.graphviz_string` documentation, the following is suggested:


```
We now test all options:

    sage: def edge_options(data):
    ....:     u, v, label = data
    ....:     options = {"color": {f: "red", g: "blue"}[label]}
    ....:     if (u,v) == (1/2, -2): options["label"]       = "coucou"; options["label_style"] = "string"
    ....:     if (u,v) == (1/2,2/3): options["dot"]         = "x=1,y=2"
    ....:     if (u,v) == (1,   -1): options["label_style"] = "latex"
    ....:     if (u,v) == (1,  1/2): options["edge_string"] = "<-"
    ....:     if (u,v) == (1/2,  1): options["backward"]    = True
    ....:     return options
    sage: print(G.graphviz_string(edge_options=edge_options))  # random
    digraph {
    node_10  [label="1"];
    node_11  [label="2"];
    node_3  [label="-1/2"];
    node_6  [label="1/2"];
    node_7  [label="1/2"];
    node_5  [label="1/3"];
    node_8  [label="2/3"];
    node_4  [label="1/4"];
    node_1  [label="-2"];
    node_9  [label="4/5"];
    node_0  [label="-4"];
    node_2  [label="-1"];

    node_10 -> node_2 [label=" ", texlbl="$x \ { |--> }\ -\frac{1}{x}$", color = "red"];
    node_10 <- node_6 [color = "blue"];
    node_11 -> node_3 [color = "red"];
    node_11 -> node_5 [color = "blue"];
    node_7 -> node_1 [label="coucou", color = "red"];
    node_7 -> node_8 [x=1,y=2, color = "blue"];
    node_4 -> node_0 [color = "red"];
    node_4 -> node_9 [color = "blue"];
    }
```


Unfortunately, it does not work:

```
sage: TikzPicture.from_graph(G, edge_options=edge_options).pdf()
```


If we replace `'<-'` by `--`, it is not as bad, but the option is ignored:


```
We now test all options:

    sage: def edge_options(data):
    ....:     u, v, label = data
    ....:     options = {"color": {f: "red", g: "blue"}[label]}
    ....:     if (u,v) == (1/2, -2): options["label"]       = "coucou"; options["label_style"] = "string"
    ....:     if (u,v) == (1/2,2/3): options["dot"]         = "x=1,y=2"
    ....:     if (u,v) == (1,   -1): options["label_style"] = "latex"
    ....:     if (u,v) == (1,  1/2): options["edge_string"] = "--"
    ....:     if (u,v) == (1/2,  1): options["backward"]    = True
    ....:     return options
    sage: print(G.graphviz_string(edge_options=edge_options))  # random
    digraph {
    node_10  [label="1"];
    node_11  [label="2"];
    node_3  [label="-1/2"];
    node_6  [label="1/2"];
    node_7  [label="1/2"];
    node_5  [label="1/3"];
    node_8  [label="2/3"];
    node_4  [label="1/4"];
    node_1  [label="-2"];
    node_9  [label="4/5"];
    node_0  [label="-4"];
    node_2  [label="-1"];

    node_10 -> node_2 [label=" ", texlbl="$x \ { |--> }\ -\frac{1}{x}$", color = "red"];
    node_10 <- node_6 [color = "blue"];
    node_11 -> node_3 [color = "red"];
    node_11 -> node_5 [color = "blue"];
    node_7 -> node_1 [label="coucou", color = "red"];
    node_7 -> node_8 [x=1,y=2, color = "blue"];
    node_4 -> node_0 [color = "red"];
    node_4 -> node_9 [color = "blue"];
    }
```


Unfortunately, the option `'--'` is ignored:

```
sage: TikzPicture.from_graph(G, edge_options=edge_options).pdf()
```



---

Attachment


---

Attachment


---

Attachment


---

Comment by slabbe created at 2021-02-11 20:12:44

According to the [DOT language description](http://www.graphviz.org/doc/info/lang.html), `--` is the format for an edge of a `graph` and `->` is the format for an edge of a `digraph` and nothing else.

Therefore, it is a bug in the documentation to suggest `<-` or `--` for digraph.

Moreover, according to the thread [Graphviz Dot, mix directed and undirected](https://stackoverflow.com/questions/13236975/graphviz-dot-mix-directed-and-undirected) on stackoverflow, it seems that the proper way to remove the headarrow for one edge of a digraph to set `dir=none`.

Therefore, the `edge_option` should allow one to set `dir=none`.


---

Comment by slabbe created at 2021-02-11 22:34:06

Moreover, according to http://www.graphviz.org/doc/info/attrs.html#k:dirType, the possible values for the direction of an edge are `none`, `forward`, `back` and `both`. The default for a graph is `none` and the default for a digraph is `forward`.


---

Comment by slabbe created at 2021-02-11 22:34:47

New commits:


---

Attachment


---

Comment by slabbe created at 2021-02-11 22:49:35

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-02-12 11:03:08

doc does not build, see patchbot


---

Comment by git created at 2021-02-12 12:33:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2021-02-12 12:41:34

I rebased the branch on top of the most recent development version and replaced one `:` by `::`.


---

Comment by slabbe created at 2021-02-12 18:34:10

Replying to [comment:13 chapoton]:
> doc does not build, see patchbot

looks good now


---

Comment by chapoton created at 2021-02-13 09:24:50

ok, good, but "misspelled" takes 2 s


---

Comment by git created at 2021-02-15 08:10:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-02-16 12:48:19

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-02-16 12:48:19

ok.

Pour info, juste pousser une branche git n'envoie pas de mail, donc ne prévient pas les participants au ticket.


---

Comment by slabbe created at 2021-02-17 21:17:20

ok

Merci Frédéric!


---

Comment by vbraun created at 2021-03-09 00:01:31

Resolution: fixed


---

Comment by tscrim created at 2021-08-25 23:54:59

I was not paying enough attention in #31719. The result is now that the arrows are backwards rather than being an indication that the arrows should be considered as moving in the opposite direction for the layout. The key change was not adding back in this line:

```python
if edge_options['backward']:
    v,u = u,v    # <------------------------------
    dot_options.append('dir=back')
```

So implementing the deprecation message is actually giving a change in the behavior. This feature is really useful in having nicer layout for KR crystals.

----

The question is what to do going forward. Should we have `dir='back'` implement the old behavior or add back in the `backward` input for what will be distinct behavior?


---

Comment by slabbe created at 2021-08-28 20:07:30

While working on this ticket, I spent a lot of time thinking about all cases and tested all of them. To me, there was a bug in the `backward=True` code. To my opinion, the line `u,v=v,u` is changing the graph  and should not be done inside a method which just draws it. I think if the user really want to change the graph, the user should do this before drawing it.

If I well remember (it is too bad I did not copy pasted an example here), the option `backward=True` was not working at all. Because swapping u and v and setting `dir=back` was like doing nothing for showing a digraph. After this ticket, writting `dir=back` really does `dir=back` as understood by the dot language.

What happens if in #31719 you instead just removed the `backward=True` as follows?


```diff
             G = Crystals().parent_class.digraph(self, subset, index_set)
-            if have_dot2tex():
-                f = lambda u_v_label: ({"backward": u_v_label[2] == 0})
-                G.set_latex_options(edge_options=f)
             return G
```



---

Comment by tscrim created at 2021-08-28 20:34:11

It was not a bug at all. The major effect was the layout, and it was something that was documented. When drawing the digraphs, it tries to make all of the arrows pointing downward. The classical crystals are posets, so it is okay. Now the KR crystals are those posets plus some extra arrows that go in the wrong direction. With that option, it would basically just add them in without altering the layout. If we remove that option, then what happens is those special backwards arrows are no longer special, so the layout is much more difficult to read.

We do _not_ want to change the digraph either because the arrows carry mathematical meaning. So it would need to be done locally within the latex construction. Hence we arrive at what the code was doing before.


---

Comment by slabbe created at 2021-08-29 19:47:39

Ok, I see. Then, it was a mistake from me. I am sorry. I think we should then add back the `backward` option.


---

Comment by tscrim created at 2021-08-30 22:25:26

No problem. I should have caught it when I was doing #31719. This is now #32438.
