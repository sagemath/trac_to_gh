# Issue 30650: spkg-configure.m4 for 4ti2

Issue created by migration from https://trac.sagemath.org/ticket/30887

Original creator: mkoeppe

Original creation time: 2020-11-11 01:24:52

CC:  dimpase mjo slelievre arojas fbissey @jengelh klee slabbe

In addition to adjustments to `src/sage/interfaces/four_ti_2.py`, also the following needs changing:

```
src/sage/sandpiles/sandpile.py:path_to_zsolve = os.path.join(SAGE_LOCAL, 'bin', 'zsolve')
```


https://repology.org/project/4ti2/versions


---

Comment by slelievre created at 2021-03-22 01:42:45

Changing keywords from "" to "4ti2, spkg-configure.m4".


---

Comment by slelievre created at 2021-03-22 01:42:45

Here is distro information to get things started.
----
New commits:


---

Comment by mkoeppe created at 2021-03-23 19:09:22

`latte_int` uses `4ti2` as a library. The test is here: https://github.com/latte-int/latte/blob/master/m4/4ti2-check.m4#L48


---

Comment by mkoeppe created at 2021-03-23 19:11:25

Also `Py4ti2` (to be added in #31363) uses `4ti2` as a library - https://github.com/alfsan/Py4ti2/blob/master/setup.py


---

Comment by mkoeppe created at 2021-03-23 19:15:39

`singular` is able to use `4ti2` via the command-line interface. Checks are done in https://github.com/Singular/Singular/blob/spielwiese/configure.ac#L352

```
configure.ac:AC_CHECK_PROGS([FOURTITWO_HILBERT], [hilbert 4ti2-hilbert])
configure.ac:AC_CHECK_PROGS([FOURTITWO_MARKOV], [markov 4ti2-markov])
configure.ac:AC_CHECK_PROGS([FOURTITWO_GRAVER], [graver 4ti2-graver])
```



---

Comment by mkoeppe created at 2021-03-23 19:19:43

`src/sage/interfaces/four_ti_2.py` calls the executables 

```
$ grep call src/sage/interfaces/four_ti_2.py
    def call(self, command, project, verbose=True):
            sage: four_ti_2.call("groebner", "test_file", False) # optional - 4ti2
        subprocess.call(cmd, shell=True, cwd=self.directory())
        self.call('zsolve -q', project)
        self.call('qsolve -q -parbitrary', project)
        self.call('rays -q -parbitrary', project)
        self.call('hilbert -q', project)
        self.call('graver -q', project)
        self.call('ppi 2> /dev/null', n)
        self.call('circuits -q -parbitrary', project)
        self.call('groebner -q -parbitrary', project)
```

and does not know that Debian installs them with an executable prefix.


---

Comment by mkoeppe created at 2021-03-23 20:20:58

`polymake` calls the executables `groebner`, `zsolve`, `circuits`, which are configurable (https://github.com/polymake/polymake/blob/c2a326f240b11a06e1b1d5fd1c2ca7278bbe60a2/apps/polytope/rules/_4ti2.rules) but it does not know that Debian installs them with an executable prefix


---

Comment by git created at 2021-03-23 23:52:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-24 02:20:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-23 23:40:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-23 23:57:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-23 23:58:25

On `ubuntu-focal-maximal`:

```
Checking whether SageMath should install SPKG 4ti2...
checking whether any of gmp mpir glpk zlib is installed as or will be installed as SPKG... no
checking for hilbert... no
checking for 4ti2-hilbert... 4ti2-hilbert
checking for markov... no
checking for 4ti2-markov... 4ti2-markov
checking for graver... no
checking for 4ti2-graver... 4ti2-graver
checking for zsolve... no
checking for 4ti2-zsolve... 4ti2-zsolve
checking for qsolve... no
checking for 4ti2-qsolve... 4ti2-qsolve
checking for rays... no
checking for 4ti2-rays... 4ti2-rays
checking for ppi... no
checking for 4ti2-ppi... 4ti2-ppi
checking for circuits... no
checking for 4ti2-circuits... 4ti2-circuits
checking for groebner... no
checking for 4ti2-groebner... 4ti2-groebner
checking for library 4ti2gmp... no
configure: no suitable system package found for SPKG 4ti2
```



---

Comment by mkoeppe created at 2021-06-24 00:02:54

Ubuntu packaging does not have the headers and has the shared libs in a nonstandard place - can't use


---

Comment by git created at 2021-06-24 01:37:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-24 01:38:52

Changing status from new to needs_review.


---

Comment by fbissey created at 2021-06-24 01:51:38

I didn't realize that `zsolve` is a part of `4ti2`. Gentoo isn't following debian naming (for now). It all look OK from a Gentoo point of view. I'll give it a proper run through later tonight.


---

Comment by fbissey created at 2021-06-25 01:43:03

Works and doctest with system 4ti2 on Gentoo.


---

Comment by @jengelh created at 2021-07-01 21:08:27

The 4ti2 binaries in openSUSE, since the package's inception in 2012 (so way before the Debian package by the looks of it), are available as e.g. /usr/bin/4ti2_zsolve, i.e. with a underscore rather than a dash. Alternatively, one can extend $PATH to include /usr/libexec/4ti2 and get them by their original name that way.


---

Comment by mkoeppe created at 2021-07-01 21:14:59

OK, we can check for the prefix `4ti2_` here too


---

Comment by mkoeppe created at 2021-07-01 21:21:23

You may want to send a pull request to Singular and Polymake so that these packages accept system 4ti2 on SuSE


---

Comment by git created at 2021-07-01 21:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-06 18:35:24

Let's get this in please


---

Comment by dimpase created at 2021-07-07 09:26:24

`AC_TRY_LINK` is obsolete. We spent some time removing these in #30668. `autoupdate` produces

```diff
diff --git a/build/pkgs/4ti2/spkg-configure.m4 b/build/pkgs/4ti2/spkg-configure.m4
index e01562c50d..a16da8fc4b 100644
--- a/build/pkgs/4ti2/spkg-configure.m4
+++ b/build/pkgs/4ti2/spkg-configure.m4
@@ -17,13 +17,12 @@ SAGE_SPKG_CONFIGURE([4ti2], [
         FORTYTWO_LIBS="-l4ti2gmp -lzsolve"
         CXXFLAGS="${BACKUP_CXXFLAGS} ${FORTYTWO_CXXFLAGS} ${GMP_CFLAGS}"
         LIBS="${BACKUP_LIBS} ${FORTYTWO_LIBS} ${GMP_LIBS}"
-        AC_TRY_LINK([
+        AC_LINK_IFELSE([AC_LANG_PROGRAM([[
 #include "4ti2/4ti2.h"
-],
-[ _4ti2_rays_create_state(_4ti2_PREC_INT_ARB);
-], [
+]], [[ _4ti2_rays_create_state(_4ti2_PREC_INT_ARB);
+]])],[
         AC_MSG_RESULT([yes])
-], [
+],[
         AC_MSG_RESULT([no])
         sage_spkg_install_4ti2=yes
 ])
```

and it appears to work.


---

Comment by dimpase created at 2021-07-07 09:36:11

by the way, with system `4ti2`, I have not found a way to tell Sage it is "installed" (./configure does pick it up all right); I tried `./configure --with-system-4ti2=force --enable-4ti2=yes`
and still `4ti2` does not appear in the list of optional packages while doing `./sage -t ...`.

Surely I can add it explicitly to `--optional`, but this is very suboptimal.


---

Comment by mkoeppe created at 2021-07-07 19:50:06

Replying to [comment:27 dimpase]:
> `AC_TRY_LINK` is obsolete. We spent some time removing these in #30668. `autoupdate` produces

Can you push this to the ticket please?


---

Comment by mkoeppe created at 2021-07-07 19:54:13

Replying to [comment:28 dimpase]:
> by the way, with system `4ti2`, I have not found a way to tell Sage it is "installed" (./configure does pick it up all right); I tried `./configure --with-system-4ti2=force --enable-4ti2=yes`
> and still `4ti2` does not appear in the list of optional packages while doing `./sage -t ...`.
> 
> Surely I can add it explicitly to `--optional`, but this is very suboptimal.

Right, that's an important point. For optional packages with `spkg-configure.m4` we don't have a mechanism yet to put them on the default "optional" list. I ran into this trap also recently on the lrslib ticket. That's basically #30746 (`sage.doctest.control`: Replace use of `sage.misc.package.list_packages`)


---

Comment by git created at 2021-07-07 21:58:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-08 17:57:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-08 18:55:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-08 19:06:12

I have now added a `has_4ti2` to `sage.doctest.external`, so that the 4ti2 tests are at least run if `./sage -t --optional=sage,external` is used. 

I get that `internet` shouldn't be probed without an additional option, but I think that at least for some "safe" features such as `imagemagick`, `rubiks`, `4ti2`, `pandoc`, it really shouldn't require the use of `external` to check for these.


---

Comment by mkoeppe created at 2021-07-08 20:25:57

Replying to [comment:34 mkoeppe]:
> I get that `internet` shouldn't be probed without an additional option, but I think that at least for some "safe" features such as `imagemagick`, `rubiks`, `4ti2`, `pandoc`, it really shouldn't require the use of `external` to check for these. 

(that's for another ticket.)


---

Comment by mkoeppe created at 2021-07-10 18:35:08

This is now #32174 (doctests: Detect "safe" external features even if `--optional=external` is not used).


---

Comment by dimpase created at 2021-07-19 14:26:25

needs a rebase


---

Comment by git created at 2021-07-19 14:28:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-07-19 18:14:22

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-07-19 18:14:22

lgtm


---

Comment by mkoeppe created at 2021-07-19 18:30:03

Thanks!


---

Comment by vbraun created at 2021-07-21 20:19:25

Tests fail


---

Comment by vbraun created at 2021-07-21 20:19:25

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2021-07-21 22:59:55

Volker, there are dozens of different ways external packages, vendored or not, with dependencies, may fail. More info please.


---

Comment by git created at 2021-07-25 05:08:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-25 05:10:27

Works fine with and without 4ti2 installed. If there is a failure on some machine, we obviously need more information than "tests fail".


---

Comment by mkoeppe created at 2021-07-25 05:10:27

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-07-25 20:26:28

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-07-25 20:26:28


```
sage -t --long --warn-long 43.6 --random-seed=0 src/sage/misc/dev_tools.py
**********************************************************************
File "src/sage/misc/dev_tools.py", line 487, in sage.misc.dev_tools.import_statements
Failed example:
    import_statements('SAGE_ENV')
Expected:
    from sage.env import SAGE_ENV
Got:
    # ** Warning **: several modules for the object {'UNAME': 'Linux', 'HOSTNAME': 'zen', 'LOCAL_IDENTIFIER': 'zen.1421426', 'SAGE_VERSION': '9.4.beta6', 'SAGE_DATE': '2021-07-24', 'SAGE_VERSION_BANNER': 'SageMath version 9.4.beta6, Release Date: 2021-07-24', 'SAGE_VENV': '/home/release/Sage/local', 'SAGE_LIB': '/home/release/Sage/local/lib64/python3.9/site-packages', 'SAGE_EXTCODE': '/home/release/Sage/local/lib64/python3.9/site-packages/sage/ext_data', 'SAGE_VENV_SPKG_INST': '/home/release/Sage/local/var/lib/sage/installed', 'SAGE_LOCAL': '/home/release/Sage/local', 'SAGE_SHARE': '/home/release/Sage/local/share', 'SAGE_DOC': '/home/release/Sage/local/share/doc/sage', 'SAGE_SPKG_INST': '/home/release/Sage/local/var/lib/sage/installed', 'SAGE_ROOT': '/home/release/Sage', 'SAGE_SRC': '/home/release/Sage/src', 'SAGE_DOC_SRC': '/home/release/Sage/src/doc', 'SAGE_PKGS': '/home/release/Sage/build/pkgs', 'SAGE_ROOT_GIT': '/home/release/Sage/.git', 'DOT_SAGE': '/home/release/.sage/', 'SAGE_STARTUP_FILE': '/home/release/.sage/init-doctests.sage', 'SAGE_ARCHFLAGS': 'unset', 'SAGE_PKG_CONFIG_PATH': '/home/release/Sage/local/lib/pkgconfig', 'CONWAY_POLYNOMIALS_DATA_DIR': '/home/release/Sage/local/share/conway_polynomials', 'GRAPHS_DATA_DIR': '/home/release/Sage/local/share/graphs', 'ELLCURVE_DATA_DIR': '/home/release/Sage/local/share/ellcurves', 'POLYTOPE_DATA_DIR': '/home/release/Sage/local/share/reflexive_polytopes', 'GAP_ROOT_DIR': '/home/release/Sage/local/share/gap', 'THEBE_DIR': '/home/release/Sage/local/share/thebe', 'COMBINATORIAL_DESIGN_DATA_DIR': '/home/release/Sage/local/share/combinatorial_designs', 'CREMONA_MINI_DATA_DIR': '/home/release/Sage/local/share/cremona', 'CREMONA_LARGE_DATA_DIR': '/home/release/Sage/local/share/cremona', 'JMOL_DIR': '/home/release/Sage/local/share/jmol', 'MATHJAX_DIR': '/home/release/Sage/local/share/mathjax', 'MTXLIB': '/home/release/Sage/local/share/meataxe', 'THREEJS_DIR': '/home/release/Sage/local/share/threejs-sage', 'PPLPY_DOCS': '/home/release/Sage/local/share/doc/pplpy', 'MAXIMA': '/home/release/Sage/local/bin/maxima', 'MAXIMA_FAS': '/home/release/Sage/local/lib/ecl/maxima.fas', 'KENZO_FAS': '/home/release/Sage/local/lib/ecl/kenzo.fas', 'SAGE_NAUTY_BINS_PREFIX': '', 'FOURTITWO_HILBERT': '', 'FOURTITWO_MARKOV': '', 'FOURTITWO_GRAVER': '', 'FOURTITWO_ZSOLVE': '', 'FOURTITWO_QSOLVE': '', 'FOURTITWO_RAYS': '', 'FOURTITWO_PPI': '', 'FOURTITWO_CIRCUITS': '', 'FOURTITWO_GROEBNER': '', 'ARB_LIBRARY': 'arb', 'CBLAS_PC_MODULES': 'cblas', 'ECL_CONFIG': '/home/release/Sage/local/bin/ecl-config', 'NTL_INCDIR': '', 'NTL_LIBDIR': '', 'LIE_INFO_DIR': '/home/release/Sage/local/lib/LiE', 'OPENMP_CFLAGS': '-fopenmp', 'OPENMP_CXXFLAGS': '-fopenmp', 'SAGE_BANNER': '', 'SAGE_IMPORTALL': 'yes', 'SINGULAR_SO': '/home/release/Sage/local/lib/libSingular-4.2.0.so', 'GAP_SO': '/home/release/Sage/local/lib/libgap.so.0.0.0'}: sage.all, sage.all_cmdline, sage.env, sage.features.four_ti_2, sage.repl.ipython_kernel.all_jupyter
    from sage.env import SAGE_ENV
**********************************************************************
1 item had failures:
   1 of  37 in sage.misc.dev_tools.import_statements
    [60 tests, 1 failure, 0.22 s]
----------------------------------------------------------------------
sage -t --long --warn-long 43.6 --random-seed=0 src/sage/misc/dev_tools.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by git created at 2021-07-25 20:51:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-25 20:51:42

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-25 20:51:42

Thanks, fixed.


---

Comment by mkoeppe created at 2021-10-03 21:49:29

Let's get this in please.


---

Comment by arojas created at 2021-10-04 20:16:30

All good here with both distro packaging and building from source against system 4ti2


---

Comment by arojas created at 2021-10-04 20:16:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-04 20:51:15

Thank you!


---

Comment by vbraun created at 2021-10-10 10:17:14

Resolution: fixed
