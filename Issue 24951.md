# Issue 24951: DUMMY_PACKAGES does not work

Issue created by migration from https://trac.sagemath.org/ticket/25188

Original creator: jdemeyer

Original creation time: 2018-04-17 09:51:33

CC:  embray

It seems that `DUMMY_PACKAGES` in `build/make/Makefile` no longer works correctly.

`build/make/Makefile` contains

```
DUMMY_PACKAGES = \
    gcc \
    gfortran \
    git \
```


Despite this, a normal build rule for `gfortran` is generated. Partial output of `make -f build/make/Makefile -n DEBUG_RULES=1`:

```
$(INST)/gfortran-7.2.0:   /bin/gcc  |  $(inst_mpir)  $(inst_mpfr)  $(inst_mpc)  $(inst_zlib)  $(inst_xz)
        +sage-logger -p '$(SAGE_SPKG) gfortran-7.2.0' '$(SAGE_LOGS)/gfortran-7.2.0.log'

gfortran: $(INST)/gfortran-7.2.0

gfortran-clean:
        rm -rf $(INST)/gfortran-7.2.0
```

This is causing build failures because `gcc` is also installed.


---

Attachment

Auto-generated build/make/Makefile


---

Comment by embray created at 2018-04-17 16:44:00

I don't think this is any different from how it used to work.  For each package, there is a variable in the Makefile called `inst_<pkgname>`.  If the package should be installed (particularly as a dependency of another package) its `inst_<pkgname>` should point to the real stamp file for that package under `SAGE_SPKG_INSTS`.  However, if the package is not being installed in Sage (i.e. due to a configure check) then its `inst_<pkgname>` just points to `.dummy`.  But explicit build rules for that package are still added to the Makefile, so if you run `make gfortran` you can still install the `gfortran` package, overriding the `configure`-time determination.

I'm not 100% convinced that's the best behavior (I think if you want to override a `configure`-based selection you should have to actually re-run `configure`).  But that's how it always worked until now.


---

Comment by embray created at 2018-04-17 17:01:04

I think the problem has more to do with the oddities of how gcc is being handled, especially since #24703.

I was confused because you wrote that "gcc is also installed", but in your Makefile it has `gcc` in `DUMMY_PACKAGES` implying that it was not selected for installation.  Yet all the packages have `$(SAGE_LOCAL)/bin/gcc` as dependencies implying that it was installed at some point.

I think that what #24703 missed is that even if `$SAGE_INSTALL_GCC = exists` it needs to be setting `needs_to_install_gcc = yes` (this doesn't actually mean it will reinstall gcc if it isn't necessary to--this just means gcc is selected for possible installation in Sage, pending checking of its prerequisites by make).   Since that isn't happening, the build system gets into a funny state where Sage's gcc _is_ installed, but the build system doesn't really think it should be.


---

Comment by embray created at 2018-04-17 17:38:09

Changing status from new to needs_review.


---

Comment by embray created at 2018-04-17 17:38:09

I'm not positive since you weren't clear on the actual symptoms, but I think this should fix the basic problem (I'm guessing that it was a complaint about no target for `$(SAGE_LOCAL)/bin/gcc`).
----
New commits:


---

Comment by git created at 2018-04-17 17:41:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-04-17 18:47:27

I haven't reviewed the patch, but it would really be useful if `DEBUG_RULES=1` would show _everything_ that ends up in the `Makefile`. In particular, the expansions of the `inst_FOO` variables are currently missing.

This is precisely the sort of thing why I opposed #21524: the `Makefile` rules are too obscure to understand what is broken.


---

Comment by jdemeyer created at 2018-04-17 18:52:32

Replying to [comment:4 embray]:
> I was confused because you wrote that "gcc is also installed", but in your Makefile it has `gcc` in `DUMMY_PACKAGES` implying that it was not selected for installation.  Yet all the packages have `$(SAGE_LOCAL)/bin/gcc` as dependencies implying that it was installed at some point.

Yes, I meant "gcc has been installed at some point in the past". `configure` correctly detects that `gfortran` should not be installed, but it's still being installed anyway.


---

Comment by jdemeyer created at 2018-04-17 18:57:11

Replying to [comment:3 embray]:
> if you run `make gfortran` you can still install the `gfortran` package, overriding the `configure`-time determination.

To be clear: this is _not_ what I'm doing. `gfortran` is build during the normal build process.


---

Comment by jdemeyer created at 2018-04-17 19:01:11

Resolution: worksforme


---

Comment by jdemeyer created at 2018-04-17 19:01:11

Never mind, user error...


---

Comment by embray created at 2018-04-18 13:14:04

Replying to [comment:7 jdemeyer]:
> I haven't reviewed the patch, but it would really be useful if `DEBUG_RULES=1` would show _everything_ that ends up in the `Makefile`. In particular, the expansions of the `inst_FOO` variables are currently missing.
> 
> This is precisely the sort of thing why I opposed #21524: the `Makefile` rules are too obscure to understand what is broken.

I don't think anything's really being obscured here.  The old hard-coded makefile didn't expand those variables either so if you suspected something to do with them you've lost nothing.


---

Comment by embray created at 2018-04-18 13:18:41

Resolution changed from worksforme to 


---

Comment by embray created at 2018-04-18 13:18:41

Changing status from closed to new.


---

Comment by embray created at 2018-04-18 13:18:41

Well don't just close it.  You've been very vague about what the actual problem is here, though you led me to actually examine the issue closely and this fix actually is the correct thing to do.

If `./configure` detects an existing GCC installed in Sage (`SAGE_INSTALL_GCC=exists`) then it should keep gcc selected among the packages to be installed as part of the distribution.  Otherwise it basically deselects gcc which is the wrong thing to do (with any package).


---

Comment by embray created at 2018-04-18 13:18:46

Changing status from new to needs_review.


---

Comment by embray created at 2018-04-18 13:23:24

Replying to [comment:9 jdemeyer]:
> Replying to [comment:3 embray]:
> > if you run `make gfortran` you can still install the `gfortran` package, overriding the `configure`-time determination.
> 
> To be clear: this is _not_ what I'm doing. `gfortran` is build during the normal build process.

Right, I didn't think you were doing that.  I'm just explaining that that capability exists (even if it's sometimes not a good idea), and that that's nothing new.


---

Comment by vbraun created at 2018-04-18 23:32:36

Lgtm; Jeroen, any comments?


---

Comment by jdemeyer created at 2018-04-19 09:53:15

I honestly don't understand the issue here. Which problem is this trying to solve?


---

Comment by embray created at 2018-04-19 11:45:21

It's resolving the thing I at least thought you were confused about.

Say you want to install gcc in Sage (whether explicitly, or by requirement of configure):


```
$ SAGE_INSTALL_GCC=yes ./configure
```


then `./configure` correctly outputs:


```
checking package versions...
...
    gcc-7.2.0
...
```


Then you install the gcc SPKG (explicitly or otherwise):


```
$ make gcc
```


And in the Makefile you see


```
BUILT_PACKAGES =\
...
gcc \
...
```


and


```
DUMMY_PACKAGES = \
    curl \
    gfortran \
    git \
```


However, if you then re-run `./configure` (without explicitly supplying `SAGE_INSTALL_GCC=yes`):


```
checking package versions...
...
    gcc-7.2.0 not installed (configure check)
...
```


it now says gcc spkg will not be installed (even though it is in fact already installed, and should continue to be installed).  Furthermore this means:


```
DUMMY_PACKAGES = \
    curl \
    gcc \
    gfortran \
    git \
```


so the stamp file for the gcc spkg is now `$SAGE_SPKG_INST/.dummy` and not the real stamp file for the actual installed gcc.  This obviously isn't the intended behavior, nor the behavior for any other package.  This bug is just unique to the gcc package because of how its installation state is being managed by the configure script.


---

Comment by jdemeyer created at 2018-04-19 12:13:51

Replying to [comment:19 embray]:
> This obviously isn't the intended behavior

I actually think that it is intended.


---

Comment by vbraun created at 2018-04-19 22:56:17

Resolution: fixed


---

Comment by vbraun created at 2018-04-19 23:02:09

I think the affected users would prefer not to recompile gcc if they can avoid it... Though I'll leave it to you two to figure it out. But if there is no resultion real soon (TM) then it won't be in 8.2.


---

Comment by vbraun created at 2018-04-19 23:02:09

Changing status from closed to new.


---

Comment by vbraun created at 2018-04-19 23:02:09

Resolution changed from fixed to 


---

Comment by vbraun created at 2018-04-19 23:02:17

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-04-20 05:13:03

Replying to [comment:22 vbraun]:
> I think the affected users would prefer not to recompile gcc if they can avoid it...

Indeed. that's the idea. We never recompile GCC just for fun.


---

Comment by embray created at 2018-04-20 13:53:42

It's not that it's recompiling GCC.  It's a reminder that GCC is supposed to be installed in Sage in the first place.  It's really wrong--it means that if you delete `$SAGE_LOCAL/var/lib/sage/installed/gcc-*` then the gcc package won't get rebuilt.  You _do_ want that because otherwise the package is for all intents and purposes broken.  I also don't know why you would want to treat gcc differently from any other package in this regard.

The only way I could see this remotely making sense is if proper uninstallation were also implemented.  Otherwise you're effectively saying "gcc is not part of this Sage distribution" even though it is installed.


---

Comment by vbraun created at 2018-04-20 16:47:48

Changing priority from blocker to major.


---

Comment by vbraun created at 2018-04-20 16:47:48

Either way, doesn't strike me as a blocker.


---

Comment by jdemeyer created at 2018-04-23 07:27:53

Replying to [comment:25 embray]:
> I also don't know why you would want to treat gcc differently from any other package in this regard.

Because GCC tends to give cyclic build dependencies: GCC depends on MPIR but MPIR depends on GCC.


---

Comment by embray created at 2018-04-23 15:36:40

Okay, but the current behavior doesn't seem like the correct way to resolve that.


---

Comment by saraedum created at 2018-07-17 15:48:25

This seems like a reasonable change to me. Feel free to set this to positive review from my end. What's the current status here embray?


---

Comment by saraedum created at 2018-07-17 15:48:35

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-07-17 19:04:14

Jeroen has expressed some concerns that this has problems related to cyclic dependencies.  I think it's the fact that when you install sage-gcc, mpir, mpc, mpfr, and other dependencies of gcc are installed first in order to bootstrap it, then gcc is build, then its dependencies are _rebuilt_ with the new gcc.  After this point, if dependencies of gcc get rebuilt, it should not trigger gcc to be rebuilt as well.

I think, with this patch, that still would not happen, but I need to make sure.

Either way, I don't think pretending that sage-gcc is not selected is a good way to deal with this.  Better to see if a special case can be made for toolchain dependencies (as in the more recent ticket #25857).


---

Comment by git created at 2018-07-18 07:19:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2018-07-18 07:27:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-18 07:35:40

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-07-18 07:35:40

I had to make a small change over the previous fix, but I'm pretty confident this works.  I also had to merge in the fix from #25857 in order to be able to be able to test this at all without breaking things too much.

You can install sage-gcc, then packages that gcc depends on like mpir can be reinstalled and updated as much as you want.  This isn't a problem because, in part, all of gcc's dependencies are listed as prerequisite-only.


---

Comment by dimpase created at 2018-09-07 08:11:24

I suppose this also needs configure tarball and bump...


---

Comment by embray created at 2018-09-07 09:16:21

It might not need a configure tarball, since this looks like one of those ones that "happens to work" even without rebuilding configure.


---

Comment by dimpase created at 2018-10-15 09:55:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-10-18 12:11:02

Merge conflict


---

Comment by vbraun created at 2018-10-18 16:21:37

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2018-10-19 09:18:58

Replying to [comment:40 vbraun]:
IIRC that work branch was https://github.com/sagemath/sage - but this does not seem to be the case anymore. Please advice where to look.


---

Comment by dimpase created at 2018-10-28 08:30:56

a trivial merge


---

Comment by dimpase created at 2018-10-28 08:30:56

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-10-29 22:46:40

Resolution: fixed
