# Issue 18339: zeromq-4.0.5 fails to build on Solaris SPARC due to casting issues with volatite integer.

archive/issues_018339.json:
```json
{
    "body": "CC:  jpflori dimpase\n\nUsing\n\n* Sage 6.7\n* Sun Blade 2000 with UltraSPARC CPU\n* gcc 4.9.2\n\nI get a build failure on Solaris SPARC.\n\n\n```\n\nmake[6]: Entering directory `/export/home/drkirkby/sage-6.7/local/var/tmp/sage/build/zeromq-4.0.5/src'\nmake[6]: Leaving directory `/export/home/drkirkby/sage-6.7/local/var/tmp/sage/build/zeromq-4.0.5/src'\n  CXX    libzmq_la-address.lo\n  CXX    libzmq_la-clock.lo\n  CXX    libzmq_la-ctx.lo\nIn file included from ctx.hpp:34:0,\n                 from ctx.cpp:30:\natomic_counter.hpp: In member function 'zmq::atomic_counter_t::integer_t zmq::atomic_counter_t::add(zmq::atomic_counter_t::integer_t)':\natomic_counter.hpp:87:71: error: invalid conversion from 'volatile integer_t* {aka volatile unsigned int*}' to 'uint32_t* {aka unsigned int*}' [-fpermissive]\n             integer_t new_value = atomic_add_32_nv (&value, increment_);\n                                                                       ^\natomic_counter.hpp: In member function 'bool zmq::atomic_counter_t::sub(zmq::atomic_counter_t::integer_t)':\natomic_counter.hpp:130:59: error: invalid conversion from 'volatile integer_t* {aka volatile unsigned int*}' to 'uint32_t* {aka unsigned int*}' [-fpermissive]\n             integer_t nv = atomic_add_32_nv (&value, delta);\n                                                           ^\nmake[5]: *** [libzmq_la-ctx.lo] Error 1\nmake[5]: Leaving directory `/export/home/drkirkby/sage-6.7/local/var/tmp/sage/build/zeromq-4.0.5/src/src'\nmake[4]: *** [all] Error 2\n```\n\nIt looks like there are assembly code that is assembled on x86 and ARM processors, but C++ is compiled on other processors. Here's the dodgy code, which appears to be casting a volatile unsigned 32-bit integer to a standard (non-volatile) unsigned 32-bit integer.No doubt adding -fpermissive would allow it to compile, but I don't know what the authors intended here.\n\nI will report this upstream to Martin Sustrik and Mikko Koppanen, and offer them access to the SPARC if they want it, although I suspect they will see the problem and can suggest a fix. \n\n\n```\n\n       //  Atomic addition. Returns the old value.\n\n  inline integer_t add (integer_t increment_){\n    integer_t old_value;\n\n#if defined ZMQ_ATOMIC_COUNTER_WINDOWS\n\n  old_value = InterlockedExchangeAdd ((LONG*) &value, increment_);\n\n#elif defined ZMQ_ATOMIC_COUNTER_ATOMIC_H\n\n  integer_t new_value = atomic_add_32_nv (&value, increment_); // BREAKS ON SOLARIS\n  old_value = new_value - increment_;\n\n#elif defined ZMQ_ATOMIC_COUNTER_TILE\n\n  old_value = arch_atomic_add (&value, increment_);\n\n#elif defined ZMQ_ATOMIC_COUNTER_X86\n\n  __asm__ volatile (\n    \"lock; xadd %0, %1 \\n\\t\": \"=r\" (old_value), \"=m\" (value): \"0\" (increment_), \"m\" (value): \"cc\", \"memory\");\n\n#elif defined ZMQ_ATOMIC_COUNTER_ARM\n\n  integer_t flag, tmp;__asm__ volatile (\n    \"       dmb     sy\\n\\t\"\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18576\n\n",
    "created_at": "2015-06-01T21:47:39Z",
    "labels": [
        "porting: Solaris",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "zeromq-4.0.5 fails to build on Solaris SPARC due to casting issues with volatite integer.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18339",
    "user": "drkirkby"
}
```
CC:  jpflori dimpase

Using

* Sage 6.7
* Sun Blade 2000 with UltraSPARC CPU
* gcc 4.9.2

I get a build failure on Solaris SPARC.


```

make[6]: Entering directory `/export/home/drkirkby/sage-6.7/local/var/tmp/sage/build/zeromq-4.0.5/src'
make[6]: Leaving directory `/export/home/drkirkby/sage-6.7/local/var/tmp/sage/build/zeromq-4.0.5/src'
  CXX    libzmq_la-address.lo
  CXX    libzmq_la-clock.lo
  CXX    libzmq_la-ctx.lo
In file included from ctx.hpp:34:0,
                 from ctx.cpp:30:
atomic_counter.hpp: In member function 'zmq::atomic_counter_t::integer_t zmq::atomic_counter_t::add(zmq::atomic_counter_t::integer_t)':
atomic_counter.hpp:87:71: error: invalid conversion from 'volatile integer_t* {aka volatile unsigned int*}' to 'uint32_t* {aka unsigned int*}' [-fpermissive]
             integer_t new_value = atomic_add_32_nv (&value, increment_);
                                                                       ^
atomic_counter.hpp: In member function 'bool zmq::atomic_counter_t::sub(zmq::atomic_counter_t::integer_t)':
atomic_counter.hpp:130:59: error: invalid conversion from 'volatile integer_t* {aka volatile unsigned int*}' to 'uint32_t* {aka unsigned int*}' [-fpermissive]
             integer_t nv = atomic_add_32_nv (&value, delta);
                                                           ^
make[5]: *** [libzmq_la-ctx.lo] Error 1
make[5]: Leaving directory `/export/home/drkirkby/sage-6.7/local/var/tmp/sage/build/zeromq-4.0.5/src/src'
make[4]: *** [all] Error 2
```

It looks like there are assembly code that is assembled on x86 and ARM processors, but C++ is compiled on other processors. Here's the dodgy code, which appears to be casting a volatile unsigned 32-bit integer to a standard (non-volatile) unsigned 32-bit integer.No doubt adding -fpermissive would allow it to compile, but I don't know what the authors intended here.

I will report this upstream to Martin Sustrik and Mikko Koppanen, and offer them access to the SPARC if they want it, although I suspect they will see the problem and can suggest a fix. 


```

       //  Atomic addition. Returns the old value.

  inline integer_t add (integer_t increment_){
    integer_t old_value;

#if defined ZMQ_ATOMIC_COUNTER_WINDOWS

  old_value = InterlockedExchangeAdd ((LONG*) &value, increment_);

#elif defined ZMQ_ATOMIC_COUNTER_ATOMIC_H

  integer_t new_value = atomic_add_32_nv (&value, increment_); // BREAKS ON SOLARIS
  old_value = new_value - increment_;

#elif defined ZMQ_ATOMIC_COUNTER_TILE

  old_value = arch_atomic_add (&value, increment_);

#elif defined ZMQ_ATOMIC_COUNTER_X86

  __asm__ volatile (
    "lock; xadd %0, %1 \n\t": "=r" (old_value), "=m" (value): "0" (increment_), "m" (value): "cc", "memory");

#elif defined ZMQ_ATOMIC_COUNTER_ARM

  integer_t flag, tmp;__asm__ volatile (
    "       dmb     sy\n\t"
```


Issue created by migration from https://trac.sagemath.org/ticket/18576





---

archive/issue_comments_248847.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2015-09-18T10:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18339#issuecomment-248847",
    "user": "jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_248848.json:
```json
{
    "body": "Outdated, should be closed",
    "created_at": "2020-07-08T16:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18339#issuecomment-248848",
    "user": "mkoeppe"
}
```

Outdated, should be closed



---

archive/issue_comments_248849.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-08T16:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18339#issuecomment-248849",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_248850.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-09T13:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18339#issuecomment-248850",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_248851.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-08-14T12:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18339#issuecomment-248851",
    "user": "chapoton"
}
```

Resolution: invalid
