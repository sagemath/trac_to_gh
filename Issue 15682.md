# Issue 15682: Notation S[i] for i-th element of enumerated set S conflicts with notation R[x] for polynomial ring

archive/issues_015682.json:
```json
{
    "body": "CC:  mmezzarobba sage-combinat\n\nKeywords: notation, algebra, polynomial\n\n\n```\nFF = IntegerModRing(29)\ntester = FF._tester()\nlist(tester.some_elements(CartesianProduct(FF, FF, FF)))\n```\n\nThis should give a list of 3-arrays of elements of Z/29. Instead I get:\n\n```\nsage: FF = IntegerModRing(29)\nsage: tester = FF._tester()\nsage: list(tester.some_elements(CartesianProduct(FF, FF, FF)))\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-3-5d7e71a13340> in <module>()\n----> 1 list(tester.some_elements(CartesianProduct(FF, FF, FF)))\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/misc/sage_unittest.pyc in some_elements(self, S)\n    498             if n > self._max_runs:\n    499                 from random import sample\n--> 500                 S = sample(S, self._max_runs)\n    501         except (TypeError, AttributeError):\n    502             # We already can't tell what the length of n is, so\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python/random.pyc in sample(self, population, k)\n    342                         j = _int(random() * n)\n    343                     selected_add(j)\n--> 344                     result[i] = population[j]\n    345             except (TypeError, KeyError):   # handle (at least) sets\n    346                 if isinstance(population, list):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/combinat.pyc in __getitem__(self, i)\n   1220             ValueError: the value must be between 0 and 2 inclusive\n   1221         \"\"\"\n-> 1222         return self.unrank(i)\n   1223 \n   1224     def __str__(self):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)\n    258             raise IndexError(\"x larger than the size of the Cartesian Product\")\n    259         positions.reverse()\n--> 260         return [L[i] for L,i in zip(self.iters, positions)]\n    261 \n    262     def random_element(self):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)\n    859 \n    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n--> 861             return PolynomialRing(self, elts)\n    862 \n    863     class ElementMethods:\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)\n    467                 raise TypeError(\"if second arguments is a string with no commas, then there must be no other non-optional arguments\")\n    468             name = arg1\n--> 469             R = _single_variate(base_ring, name, sparse, implementation)\n    470         else:\n    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)\n    518 def _single_variate(base_ring, name, sparse, implementation):\n    519     import sage.rings.polynomial.polynomial_ring as m\n--> 520     name = normalize_names(1, name)\n    521     key = (base_ring, name, sparse, implementation if not sparse else None)\n    522     R = _get_from_cache(key)\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()\n\nValueError: first letter of variable name must be a letter\n```\n\nAnd 29 is the smallest number where this seems to throw this error; also, it doesn't fail if I only take the cartesian product of two copies of the field.\n\nI get a similar error if I do `CartesianProduct(FF, FF).unrank(3)`, and this has been around for a while (not just since beta4):\n\n```\nsage: FF = IntegerModRing(3)\nsage: CartesianProduct(FF, FF).unrank(3)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-15-98d0a571cc61> in <module>()\n----> 1 CartesianProduct(FF, FF).unrank(Integer(3))\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)\n    258             raise IndexError(\"x larger than the size of the Cartesian Product\")\n    259         positions.reverse()\n--> 260         return [L[i] for L,i in zip(self.iters, positions)]\n    261 \n    262     def random_element(self):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)\n    859 \n    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n--> 861             return PolynomialRing(self, elts)\n    862 \n    863     class ElementMethods:\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)\n    467                 raise TypeError(\"if second arguments is a string with no commas, then there must be no other non-optional arguments\")\n    468             name = arg1\n--> 469             R = _single_variate(base_ring, name, sparse, implementation)\n    470         else:\n    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)\n    518 def _single_variate(base_ring, name, sparse, implementation):\n    519     import sage.rings.polynomial.polynomial_ring as m\n--> 520     name = normalize_names(1, name)\n    521     key = (base_ring, name, sparse, implementation if not sparse else None)\n    522     R = _get_from_cache(key)\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()\n\n/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()\n\nValueError: first letter of variable name must be a letter\n```\n\nSo it seems that both bugs are due to the fancy `R[x]` syntax for polynomial rings conflicting with the `R[i]` syntax for the i-th element of an enumerated set `R`, and #8389 didn't cause the error, but at most exposed it better.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15919\n\n",
    "created_at": "2014-03-12T04:51:49Z",
    "labels": [
        "algebra",
        "major",
        "bug"
    ],
    "title": "Notation S[i] for i-th element of enumerated set S conflicts with notation R[x] for polynomial ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15682",
    "user": "darij"
}
```
CC:  mmezzarobba sage-combinat

Keywords: notation, algebra, polynomial


```
FF = IntegerModRing(29)
tester = FF._tester()
list(tester.some_elements(CartesianProduct(FF, FF, FF)))
```

This should give a list of 3-arrays of elements of Z/29. Instead I get:

```
sage: FF = IntegerModRing(29)
sage: tester = FF._tester()
sage: list(tester.some_elements(CartesianProduct(FF, FF, FF)))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-3-5d7e71a13340> in <module>()
----> 1 list(tester.some_elements(CartesianProduct(FF, FF, FF)))

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/misc/sage_unittest.pyc in some_elements(self, S)
    498             if n > self._max_runs:
    499                 from random import sample
--> 500                 S = sample(S, self._max_runs)
    501         except (TypeError, AttributeError):
    502             # We already can't tell what the length of n is, so

/home/darij/gitsage/sage-5.13.beta1/local/lib/python/random.pyc in sample(self, population, k)
    342                         j = _int(random() * n)
    343                     selected_add(j)
--> 344                     result[i] = population[j]
    345             except (TypeError, KeyError):   # handle (at least) sets
    346                 if isinstance(population, list):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/combinat.pyc in __getitem__(self, i)
   1220             ValueError: the value must be between 0 and 2 inclusive
   1221         """
-> 1222         return self.unrank(i)
   1223 
   1224     def __str__(self):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)
    258             raise IndexError("x larger than the size of the Cartesian Product")
    259         positions.reverse()
--> 260         return [L[i] for L,i in zip(self.iters, positions)]
    261 
    262     def random_element(self):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)
    859 
    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
--> 861             return PolynomialRing(self, elts)
    862 
    863     class ElementMethods:

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)
    467                 raise TypeError("if second arguments is a string with no commas, then there must be no other non-optional arguments")
    468             name = arg1
--> 469             R = _single_variate(base_ring, name, sparse, implementation)
    470         else:
    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)
    518 def _single_variate(base_ring, name, sparse, implementation):
    519     import sage.rings.polynomial.polynomial_ring as m
--> 520     name = normalize_names(1, name)
    521     key = (base_ring, name, sparse, implementation if not sparse else None)
    522     R = _get_from_cache(key)

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()

ValueError: first letter of variable name must be a letter
```

And 29 is the smallest number where this seems to throw this error; also, it doesn't fail if I only take the cartesian product of two copies of the field.

I get a similar error if I do `CartesianProduct(FF, FF).unrank(3)`, and this has been around for a while (not just since beta4):

```
sage: FF = IntegerModRing(3)
sage: CartesianProduct(FF, FF).unrank(3)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-15-98d0a571cc61> in <module>()
----> 1 CartesianProduct(FF, FF).unrank(Integer(3))

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in unrank(self, x)
    258             raise IndexError("x larger than the size of the Cartesian Product")
    259         positions.reverse()
--> 260         return [L[i] for L,i in zip(self.iters, positions)]
    261 
    262     def random_element(self):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__getitem__ (sage/structure/parent.c:11060)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/categories/rings.pyc in __getitem__(self, arg)
    859 
    860             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
--> 861             return PolynomialRing(self, elts)
    862 
    863     class ElementMethods:

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, var_array, implementation)
    467                 raise TypeError("if second arguments is a string with no commas, then there must be no other non-optional arguments")
    468             name = arg1
--> 469             R = _single_variate(base_ring, name, sparse, implementation)
    470         else:
    471             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)
    518 def _single_variate(base_ring, name, sparse, implementation):
    519     import sage.rings.polynomial.polynomial_ring as m
--> 520     name = normalize_names(1, name)
    521     key = (base_ring, name, sparse, implementation if not sparse else None)
    522     R = _get_from_cache(key)

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2759)()

/home/darij/gitsage/sage-5.13.beta1/local/lib/python2.7/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:2322)()

ValueError: first letter of variable name must be a letter
```

So it seems that both bugs are due to the fancy `R[x]` syntax for polynomial rings conflicting with the `R[i]` syntax for the i-th element of an enumerated set `R`, and #8389 didn't cause the error, but at most exposed it better.

Issue created by migration from https://trac.sagemath.org/ticket/15919





---

archive/issue_comments_203068.json:
```json
{
    "body": "I think the bug is in unrank, not in the fact that rings use `__getitem__` in a funny way. The problem is that a Cartesian product can easily be constructed from iterables, and then should probably be iterable itself, but iterables are not necessarily indexable:\n\n```\nsage: V={1,2,3}\nsage: CartesianProduct(V,V).unrank(2)\nTypeError: 'set' object does not support indexing\nsage: [i for i in CartesianProduct(V,V)]\n[[1, 1], [1, 2], [1, 3], [2, 1], [2, 2], [2, 3], [3, 1], [3, 2], [3, 3]]\n```\n\nThe function \"unrank\" should only be applied to indexable cartesian products, i.e., cartesian products of indexables. That's not the same as iterables. In particular,\n\nSo the problem is really in `tester.some_elements`. Indeed, the offending code:\n\n```\n        try:\n            n = _len(S)\n            if n > self._max_runs:\n                from random import sample\n                S = sample(S, self._max_runs)\n        except (TypeError, AttributeError):\n```\n\ntries `sample` on `S`, which apparently leads to calls of the type `S[i]`. As you can see, the code is prepared to fail, but doesn't expect that to happen with a `ValueError`. I think this just shows that it's a bit callous to just try and index a structure and hope for the best.",
    "created_at": "2014-03-12T05:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203068",
    "user": "nbruin"
}
```

I think the bug is in unrank, not in the fact that rings use `__getitem__` in a funny way. The problem is that a Cartesian product can easily be constructed from iterables, and then should probably be iterable itself, but iterables are not necessarily indexable:

```
sage: V={1,2,3}
sage: CartesianProduct(V,V).unrank(2)
TypeError: 'set' object does not support indexing
sage: [i for i in CartesianProduct(V,V)]
[[1, 1], [1, 2], [1, 3], [2, 1], [2, 2], [2, 3], [3, 1], [3, 2], [3, 3]]
```

The function "unrank" should only be applied to indexable cartesian products, i.e., cartesian products of indexables. That's not the same as iterables. In particular,

So the problem is really in `tester.some_elements`. Indeed, the offending code:

```
        try:
            n = _len(S)
            if n > self._max_runs:
                from random import sample
                S = sample(S, self._max_runs)
        except (TypeError, AttributeError):
```

tries `sample` on `S`, which apparently leads to calls of the type `S[i]`. As you can see, the code is prepared to fail, but doesn't expect that to happen with a `ValueError`. I think this just shows that it's a bit callous to just try and index a structure and hope for the best.



---

archive/issue_comments_203069.json:
```json
{
    "body": "Hmm. So Sets are not required to define getitem in a reasonable way? Good to know.",
    "created_at": "2014-03-12T05:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203069",
    "user": "darij"
}
```

Hmm. So Sets are not required to define getitem in a reasonable way? Good to know.



---

archive/issue_comments_203070.json:
```json
{
    "body": "Nicolas Thi\u00e9ry suggested deprecating `R[n]` in favor of `R.unrank(n)` at least when `R` is a ring (see http://trac.sagemath.org/ticket/8389#comment:13), and I tend to agree. If you don't, could you please leave a comment at #15885?",
    "created_at": "2014-03-12T12:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203070",
    "user": "mmezzarobba"
}
```

Nicolas Thiéry suggested deprecating `R[n]` in favor of `R.unrank(n)` at least when `R` is a ring (see http://trac.sagemath.org/ticket/8389#comment:13), and I tend to agree. If you don't, could you please leave a comment at #15885?



---

archive/issue_comments_203071.json:
```json
{
    "body": "I agree too if we can do this quickly enough. This is causing problems in #10963...",
    "created_at": "2014-03-12T13:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203071",
    "user": "darij"
}
```

I agree too if we can do this quickly enough. This is causing problems in #10963...



---

archive/issue_comments_203072.json:
```json
{
    "body": "The above branch takes a first step toward using more systematically the unrank protocol, in that case in `CartesianProduct`. This should improve the situation and could be deemed good enough for now, but is certainly not a final solution. Also, the unrank function I introduced might be too paranoid: it makes CartesianProduct.unrank work only with lists, tuples, Parents, xranges; there might be other inputs that are used around. All tests pass though (haven't tried long tests yet).\n\nI agree with Nils though: the sampling in the TestSuite should not be using [i] to do unranking, and probably should just assume that the object is iterable, and not necessarily unrankable. I'll have a look unless someone beats me to it.\n\nThe third alternative, explored by Darij in his branch, is to reinstate temporarily the notation FF[i] for unranking for IntegerModRing and friends.\n\nWhat do you think?\n----\nNew commits:",
    "created_at": "2014-03-13T12:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203072",
    "user": "nthiery"
}
```

The above branch takes a first step toward using more systematically the unrank protocol, in that case in `CartesianProduct`. This should improve the situation and could be deemed good enough for now, but is certainly not a final solution. Also, the unrank function I introduced might be too paranoid: it makes CartesianProduct.unrank work only with lists, tuples, Parents, xranges; there might be other inputs that are used around. All tests pass though (haven't tried long tests yet).

I agree with Nils though: the sampling in the TestSuite should not be using [i] to do unranking, and probably should just assume that the object is iterable, and not necessarily unrankable. I'll have a look unless someone beats me to it.

The third alternative, explored by Darij in his branch, is to reinstate temporarily the notation FF[i] for unranking for IntegerModRing and friends.

What do you think?
----
New commits:



---

archive/issue_comments_203073.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-21T17:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203073",
    "user": "nthiery"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_203074.json:
```json
{
    "body": "Hey Nicolas,\n\nI've expanded upon what `unrank` can accept (all iterables, even if not in enumerated sets, should now work). I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?\n----\nNew commits:",
    "created_at": "2014-04-22T19:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203074",
    "user": "tscrim"
}
```

Hey Nicolas,

I've expanded upon what `unrank` can accept (all iterables, even if not in enumerated sets, should now work). I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?
----
New commits:



---

archive/issue_comments_203075.json:
```json
{
    "body": "Not a review, just a tiny remark: the colon before the doctest in `cartesian_product.py` should be doubled.",
    "created_at": "2014-04-23T11:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203075",
    "user": "pbruin"
}
```

Not a review, just a tiny remark: the colon before the doctest in `cartesian_product.py` should be doubled.



---

archive/issue_comments_203076.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-23T12:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203076",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_203077.json:
```json
{
    "body": "Hi Travis!\n\nThanks for the improvement! I made one further step, in particular to\navoid trapping too many exceptions; typical situation: a parent L that implements\nunranking as L[i] and raises an \"out of bound\" value error.\n\nI am still unhappy about the `unrank(ZZ,i)` returning something completely wrong (Integer Ring). In case a parent is iterable, I wonder if I would not prefer to prefer the Iterable strategy, and only use `__getitem__` if everything else has failed.\n\nCheers,\n                                        Nicolas",
    "created_at": "2014-04-25T16:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203077",
    "user": "nthiery"
}
```

Hi Travis!

Thanks for the improvement! I made one further step, in particular to
avoid trapping too many exceptions; typical situation: a parent L that implements
unranking as L[i] and raises an "out of bound" value error.

I am still unhappy about the `unrank(ZZ,i)` returning something completely wrong (Integer Ring). In case a parent is iterable, I wonder if I would not prefer to prefer the Iterable strategy, and only use `__getitem__` if everything else has failed.

Cheers,
                                        Nicolas



---

archive/issue_comments_203078.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?\n\n+1. Let's focus here on what's needed for #10963.\n----\nNew commits:",
    "created_at": "2014-04-25T17:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203078",
    "user": "nthiery"
}
```

Replying to [comment:9 tscrim]:
> I agree the sampling should not use `[i]` to do unranking, but should we push that to another ticket?

+1. Let's focus here on what's needed for #10963.
----
New commits:



---

archive/issue_comments_203079.json:
```json
{
    "body": "Ah shoot, the sampling issue actually occurs with #10963.\n\nAt this point I am tempted to remove the sampling altogether in\nInstanceTester.some_elements, and instead have it always return a list\n(or iterator?) of the first max_run elements (or less if `S` does not\nhave that many). Then, the only requirement on `S` would be to be\niterable.\n\nThe code would then just be:\n\n```\n    def some_elements(self, S=None):\n        if S is None:\n            if self._elements is None:\n                S = self._instance.some_elements()\n            else:\n                S = self._elements\n        import itertools\n        return list(itertools.islice(S,0,self._max_runs))\n```\n\n\nI am now running the tests with #10963 and this change.\n\nCheers,\n                                     Nicolas",
    "created_at": "2014-04-25T17:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203079",
    "user": "nthiery"
}
```

Ah shoot, the sampling issue actually occurs with #10963.

At this point I am tempted to remove the sampling altogether in
InstanceTester.some_elements, and instead have it always return a list
(or iterator?) of the first max_run elements (or less if `S` does not
have that many). Then, the only requirement on `S` would be to be
iterable.

The code would then just be:

```
    def some_elements(self, S=None):
        if S is None:
            if self._elements is None:
                S = self._instance.some_elements()
            else:
                S = self._elements
        import itertools
        return list(itertools.islice(S,0,self._max_runs))
```


I am now running the tests with #10963 and this change.

Cheers,
                                     Nicolas



---

archive/issue_comments_203080.json:
```json
{
    "body": "With just this change (and not the rest of the stuff in this branch), #10963 passes all tests.\n\nAt this point, I am tempted to split this ticket into two tickets:\n- One about fixing TestSuite/InstanceTester.some_elements to not use indexed access (sufficient for #10963)\n- One toward using the unrank protocol more systematically (in that case in CartesianProduct)\n\nWhat do you think?",
    "created_at": "2014-04-25T19:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203080",
    "user": "nthiery"
}
```

With just this change (and not the rest of the stuff in this branch), #10963 passes all tests.

At this point, I am tempted to split this ticket into two tickets:
- One about fixing TestSuite/InstanceTester.some_elements to not use indexed access (sufficient for #10963)
- One toward using the unrank protocol more systematically (in that case in CartesianProduct)

What do you think?



---

archive/issue_comments_203081.json:
```json
{
    "body": "(Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get \"most\" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.\n\nI'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).\n\nBest,\n\nTravis",
    "created_at": "2014-04-26T05:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203081",
    "user": "tscrim"
}
```

(Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get "most" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.

I'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).

Best,

Travis



---

archive/issue_comments_203082.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-04-26T05:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203082",
    "user": "tscrim"
}
```

New commits:



---

archive/issue_comments_203083.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> (Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get \"most\" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.\n\nOk, glad to see we are on the same line. I have created #16244 for\njust this piece. I'll push my little change there later.\n\n> I'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).\n\nOk, I am happy with your change. So I guess this can be positive reviewed. There remains to update the description of this ticket to better reflect what has actually been done, and refer to the other ticket for the actual solution of the original issue.",
    "created_at": "2014-04-26T18:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203083",
    "user": "nthiery"
}
```

Replying to [comment:17 tscrim]:
> (Much) More of me says this change to `InstanceTester.some_elements()` is significantly better (and might even be faster for things that are hard to repeatably iterate over like crystals) than loosing the possibility that (over enough repeated tests) we get "most" elements of a very large finite set (and without calculating `__len__()`, which also might be expensive or error catching). So I'm saying let's make this change, the question is where. I'd be happy doing it right here.

Ok, glad to see we are on the same line. I have created #16244 for
just this piece. I'll push my little change there later.

> I'd say the problem with `ZZ` is that it is not in the correct category, which is now #16239. I've also made some very minor doctweaks, so I'm pos_rev with the current state (up to where to make the change above).

Ok, I am happy with your change. So I guess this can be positive reviewed. There remains to update the description of this ticket to better reflect what has actually been done, and refer to the other ticket for the actual solution of the original issue.



---

archive/issue_comments_203084.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-04-26T19:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203084",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203085.json:
```json
{
    "body": "Done and done.",
    "created_at": "2014-04-26T19:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203085",
    "user": "tscrim"
}
```

Done and done.



---

archive/issue_comments_203086.json:
```json
{
    "body": "Thanks Travis!",
    "created_at": "2014-04-26T21:16:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203086",
    "user": "nthiery"
}
```

Thanks Travis!



---

archive/issue_comments_203087.json:
```json
{
    "body": "The only thing that somewhat worries me is the speed. Before:\n\n```\nsage: T = range(20)\nsage: C = CartesianProduct(T,T,T)\nsage: %timeit C.unrank(3)\n100000 loops, best of 3: 15 \u00b5s per loop\n```\n\nAfter:\n\n```\nsage: T = range(20)\nsage: C = CartesianProduct(T,T,T)\nsage: %timeit C.unrank(3)\n10000 loops, best of 3: 35.5 \u00b5s per loop\n```\n\n(These timings are fairly independent on the 20 and the 3...)\n\nI don't know how often this unranking is used, though, and whether these \u00b5s add up...",
    "created_at": "2014-04-27T05:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203087",
    "user": "darij"
}
```

The only thing that somewhat worries me is the speed. Before:

```
sage: T = range(20)
sage: C = CartesianProduct(T,T,T)
sage: %timeit C.unrank(3)
100000 loops, best of 3: 15 µs per loop
```

After:

```
sage: T = range(20)
sage: C = CartesianProduct(T,T,T)
sage: %timeit C.unrank(3)
10000 loops, best of 3: 35.5 µs per loop
```

(These timings are fairly independent on the 20 and the 3...)

I don't know how often this unranking is used, though, and whether these µs add up...



---

archive/issue_comments_203088.json:
```json
{
    "body": "Replying to [comment:23 darij]:\n> The only thing that somewhat worries me is the speed. Before:\n> ...\n> I don't know how often this unranking is used, though, and whether these \u00b5s add up...\n\nAh good point; the `isinstance` and `in EnumeratedSets` checks cause a little\noverhead which is non negligible for inputs that have super fast\nunranking (like lists).\n\nMy impression is that this unranking is not used much. If it really\nbecame a bottleneck, a reasonable fix would be to have\nCartesianProduct build unranking functions once for all upon the first\nunrank (I started toying with this in\nu/nthiery/15919-unrank-unrank-from), so that the above checks would be\ndone only once.\n\nBesides, things should eventually resolve by themselves as CartesianProduct gets\nprogressively replaced by cartesian_product (for which the inputs are\nparents, or coerced into parents), and parents implement more\nsystematically the unrank protocol.\n\nSo altogether, in this balance between overhead and correctness, I\nwould lean here toward correctness. What do you think?",
    "created_at": "2014-04-27T22:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203088",
    "user": "nthiery"
}
```

Replying to [comment:23 darij]:
> The only thing that somewhat worries me is the speed. Before:
> ...
> I don't know how often this unranking is used, though, and whether these µs add up...

Ah good point; the `isinstance` and `in EnumeratedSets` checks cause a little
overhead which is non negligible for inputs that have super fast
unranking (like lists).

My impression is that this unranking is not used much. If it really
became a bottleneck, a reasonable fix would be to have
CartesianProduct build unranking functions once for all upon the first
unrank (I started toying with this in
u/nthiery/15919-unrank-unrank-from), so that the above checks would be
done only once.

Besides, things should eventually resolve by themselves as CartesianProduct gets
progressively replaced by cartesian_product (for which the inputs are
parents, or coerced into parents), and parents implement more
systematically the unrank protocol.

So altogether, in this balance between overhead and correctness, I
would lean here toward correctness. What do you think?



---

archive/issue_comments_203089.json:
```json
{
    "body": "I am not suggesting to go against correctness! My original idea on this ticket was to de-prioritize the notation `R[x]` for a polynomial ring or a subalgebra generated by `x`, because that notation is really syntactic sugar. So it's speed vs. convenience. But looking at Travis's posts I am no longer sure if this would have fixed all issues. Anyway, since unrank and CartesianProduct aren't very much used together, this is not an issue.",
    "created_at": "2014-04-28T00:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203089",
    "user": "darij"
}
```

I am not suggesting to go against correctness! My original idea on this ticket was to de-prioritize the notation `R[x]` for a polynomial ring or a subalgebra generated by `x`, because that notation is really syntactic sugar. So it's speed vs. convenience. But looking at Travis's posts I am no longer sure if this would have fixed all issues. Anyway, since unrank and CartesianProduct aren't very much used together, this is not an issue.



---

archive/issue_comments_203090.json:
```json
{
    "body": "Replying to [comment:25 darij]:\n> I am not suggesting to go against correctness!\n\nOops, sorry if my wording involuntarily implied this :-) I just meant\nthat I was ready paying a little speed overhead as a price for a\nsolution of the problem. And I agree the problem worked on this ticket\n(being cleaner with unrank versus `__getitem__`) has deviated from the\noriginal one. Not so bad since I believe this + #16244 fixes\nreasonably the original problem.\n\nUnless someone raises an objection now, this is good to go!\n\nThanks to both of you.",
    "created_at": "2014-04-28T08:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203090",
    "user": "nthiery"
}
```

Replying to [comment:25 darij]:
> I am not suggesting to go against correctness!

Oops, sorry if my wording involuntarily implied this :-) I just meant
that I was ready paying a little speed overhead as a price for a
solution of the problem. And I agree the problem worked on this ticket
(being cleaner with unrank versus `__getitem__`) has deviated from the
original one. Not so bad since I believe this + #16244 fixes
reasonably the original problem.

Unless someone raises an objection now, this is good to go!

Thanks to both of you.



---

archive/issue_comments_203091.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-08T08:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15682",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15682#issuecomment-203091",
    "user": "vbraun"
}
```

Resolution: fixed
