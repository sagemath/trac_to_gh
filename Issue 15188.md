# Issue 15188: Cleanup cartesian products

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2013-11-15 17:58:36

CC:  sage-combinat ncohen vdelecroix tscrim

Currently we have: `cartesian_product`, `CartesianProduct` and
`cartesian_product_iterator` for constructing cartesian products.

- `CartesianProduct` is an old simple parent that focuses on the
  "enumerated sets" aspect: providing counting and enumeration over
  cartesian products of enumerated sets. It accepts any iterables as
  input.

- `cartesian_product` is a "functorial construction". This means
  that it uses the categories to endow the resulting parent with as
  much structure as it can lift from the input. E.g. the cartesian
  product of two monoids is a monoid.

- `cartesian_product_iterator` is just a function that provides an
  iterator

`cartesian_product` is meant to subdue `CartesianProduct`. The
missing features at this point are:

- Accepting any iterable as input. This probably requires turning them
  into parents (e.g. with FiniteEnumeratedSet). The overhead is
  probably negligible in most cases, but one would need to double
  check that we don't have spots where CartesianProduct is used
  intensively for very small calculations.

  #14224 which can be closed once this is fixed.

- Some features of CartesianProduct still need to be lifted to
  Sets.Finite.CartesianProducts or EnumeratedSets.CartesianProducts.
  For example, cardinality is currently calculated from the iterator (gasp):
  {{{
      sage: F = Permutations(10)
      sage: C = cartesian_product([F,F])
      sage: C.cardinality()
      *hangs forever*
  }}}

Once this is done, we can make CartesianProduct an alias for
cartesian_product, and maybe deprecate it in the long run.

My 2 cents for cartesian_product_iterator: it should be removed from
the global name space, and deprecated altogether if after checking it
turns out to be really just a duplicated of itertools.product.

Another bug in cartesian_product (reported by Vincent Delecroix [1]):

```
sage: C = cartesian_product([ZZ,ZZ])
...
AttributeError: type object 'sage.rings.integer_ring.IntegerRing_class' has no attribute 'CartesianProduct'
```


This is a regression that is caused by a small change introduced by
#12959 in Sets.ParentMethods.CartesianProduct:

```
            return parents[0].__class__ -> return parents[0].__class__
```


I (Nicolas) take a double blame for it: I was reviewer of this ticket
and did not notice this chunk (or don't remember why it was
introduced), and I had not written an appropriate test in the first
place. So this needs to be fixed too.

Yet another bug reported by Nathann Cohen [2]: when converting a list
to an element of a cartesian product:

```
sage: Z3 = IntegerModRing(3)
sage: C = cartesian_product([Z3,Z3])
sage: C([Z3(2),Z3(2)])^2
(1, 1)
sage: C([2,2])^2   # Ooops
(4, 4)
```


The fix would be convert the operands of the list into the respective
parents in
`sage.sets.cartesian_product.CartesianProduct._element_constructor`.

Many features could be further added, like for example making the
cartesian product of an additive magma into an additive magma and so
on. This can go in this ticket or in later tickets.

[1] https://groups.google.com/forum/#!topic/sage-combinat-devel/8Aw63kro_0M
[2] https://groups.google.com/forum/#!msg/sage-devel/tyAxhqxk3ZI/rff7pTrGIQ4J


---

Comment by nthiery created at 2014-05-05 00:04:46

Changing type from defect to task.


---

Comment by vdelecroix created at 2014-05-05 06:08:54

Hello,

+1 on that ticket!

I cleaned a bit the description.

I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.

Vincent


---

Comment by ncohen created at 2014-05-05 07:53:16

> I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.

We could mention it in the docstring of `cartesian_product`. "If you just want to list the elements, use itertools.product as it is much faster" ?


---

Comment by nthiery created at 2014-05-05 09:57:20

Replying to [comment:5 ncohen]:
> > I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.
> 
> We could mention it in the docstring of `cartesian_product`. "If you just want to list the elements, use itertools.product as it is much faster" ?

Sounds good to me, with 'list -> iterate through'


---

Comment by vdelecroix created at 2015-04-23 15:12:11

Hello,

I think that we should get rid of `_cartesian_product_of_elements`. If we want speed we can either:
 - add an argument `coerce` to the `_element_constructor_`
 - use directly `element_class`

Vincent


---

Comment by vdelecroix created at 2015-04-23 15:17:39

Shouldn't the two following commands give the same answer

```
sage: ZZ**2
Ambient free module of rank 2 over the principal ideal domain Integer Ring
sage: cartesian_product([ZZ,ZZ])
The cartesian product of (Integer Ring, Integer Ring)
```



---

Comment by mkoeppe created at 2022-08-11 04:52:42

Bugs 5 and 6 are still present in 9.7.beta8
