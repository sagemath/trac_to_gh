# Issue 15188: Cleanup cartesian products

archive/issues_015188.json:
```json
{
    "body": "CC:  sage-combinat ncohen vdelecroix tscrim\n\nCurrently we have: `cartesian_product`, `CartesianProduct` and\n`cartesian_product_iterator` for constructing cartesian products.\n\n- `CartesianProduct` is an old simple parent that focuses on the\n  \"enumerated sets\" aspect: providing counting and enumeration over\n  cartesian products of enumerated sets. It accepts any iterables as\n  input.\n\n- `cartesian_product` is a \"functorial construction\". This means\n  that it uses the categories to endow the resulting parent with as\n  much structure as it can lift from the input. E.g. the cartesian\n  product of two monoids is a monoid.\n\n- `cartesian_product_iterator` is just a function that provides an\n  iterator\n\n`cartesian_product` is meant to subdue `CartesianProduct`. The\nmissing features at this point are:\n\n- Accepting any iterable as input. This probably requires turning them\n  into parents (e.g. with FiniteEnumeratedSet). The overhead is\n  probably negligible in most cases, but one would need to double\n  check that we don't have spots where CartesianProduct is used\n  intensively for very small calculations.\n\n  #14224 which can be closed once this is fixed.\n\n- Some features of CartesianProduct still need to be lifted to\n  Sets.Finite.CartesianProducts or EnumeratedSets.CartesianProducts.\n  For example, cardinality is currently calculated from the iterator (gasp):\n  {{{\n      sage: F = Permutations(10)\n      sage: C = cartesian_product([F,F])\n      sage: C.cardinality()\n      *hangs forever*\n  }}}\n\nOnce this is done, we can make CartesianProduct an alias for\ncartesian_product, and maybe deprecate it in the long run.\n\nMy 2 cents for cartesian_product_iterator: it should be removed from\nthe global name space, and deprecated altogether if after checking it\nturns out to be really just a duplicated of itertools.product.\n\nAnother bug in cartesian_product (reported by Vincent Delecroix [1]):\n\n```\nsage: C = cartesian_product([ZZ,ZZ])\n...\nAttributeError: type object 'sage.rings.integer_ring.IntegerRing_class' has no attribute 'CartesianProduct'\n```\n\n\nThis is a regression that is caused by a small change introduced by\n#12959 in Sets.ParentMethods.CartesianProduct:\n\n```\n            return parents[0].__class__ -> return parents[0].__class__\n```\n\n\nI (Nicolas) take a double blame for it: I was reviewer of this ticket\nand did not notice this chunk (or don't remember why it was\nintroduced), and I had not written an appropriate test in the first\nplace. So this needs to be fixed too.\n\nYet another bug reported by Nathann Cohen [2]: when converting a list\nto an element of a cartesian product:\n\n```\nsage: Z3 = IntegerModRing(3)\nsage: C = cartesian_product([Z3,Z3])\nsage: C([Z3(2),Z3(2)])^2\n(1, 1)\nsage: C([2,2])^2   # Ooops\n(4, 4)\n```\n\n\nThe fix would be convert the operands of the list into the respective\nparents in\n`sage.sets.cartesian_product.CartesianProduct._element_constructor`.\n\nMany features could be further added, like for example making the\ncartesian product of an additive magma into an additive magma and so\non. This can go in this ticket or in later tickets.\n\n[1] https://groups.google.com/forum/#!topic/sage-combinat-devel/8Aw63kro_0M\n[2] https://groups.google.com/forum/#!msg/sage-devel/tyAxhqxk3ZI/rff7pTrGIQ4J\n\nIssue created by migration from https://trac.sagemath.org/ticket/15425\n\n",
    "created_at": "2013-11-15T17:58:36Z",
    "labels": [
        "categories",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Cleanup cartesian products",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15188",
    "user": "nthiery"
}
```
CC:  sage-combinat ncohen vdelecroix tscrim

Currently we have: `cartesian_product`, `CartesianProduct` and
`cartesian_product_iterator` for constructing cartesian products.

- `CartesianProduct` is an old simple parent that focuses on the
  "enumerated sets" aspect: providing counting and enumeration over
  cartesian products of enumerated sets. It accepts any iterables as
  input.

- `cartesian_product` is a "functorial construction". This means
  that it uses the categories to endow the resulting parent with as
  much structure as it can lift from the input. E.g. the cartesian
  product of two monoids is a monoid.

- `cartesian_product_iterator` is just a function that provides an
  iterator

`cartesian_product` is meant to subdue `CartesianProduct`. The
missing features at this point are:

- Accepting any iterable as input. This probably requires turning them
  into parents (e.g. with FiniteEnumeratedSet). The overhead is
  probably negligible in most cases, but one would need to double
  check that we don't have spots where CartesianProduct is used
  intensively for very small calculations.

  #14224 which can be closed once this is fixed.

- Some features of CartesianProduct still need to be lifted to
  Sets.Finite.CartesianProducts or EnumeratedSets.CartesianProducts.
  For example, cardinality is currently calculated from the iterator (gasp):
  {{{
      sage: F = Permutations(10)
      sage: C = cartesian_product([F,F])
      sage: C.cardinality()
      *hangs forever*
  }}}

Once this is done, we can make CartesianProduct an alias for
cartesian_product, and maybe deprecate it in the long run.

My 2 cents for cartesian_product_iterator: it should be removed from
the global name space, and deprecated altogether if after checking it
turns out to be really just a duplicated of itertools.product.

Another bug in cartesian_product (reported by Vincent Delecroix [1]):

```
sage: C = cartesian_product([ZZ,ZZ])
...
AttributeError: type object 'sage.rings.integer_ring.IntegerRing_class' has no attribute 'CartesianProduct'
```


This is a regression that is caused by a small change introduced by
#12959 in Sets.ParentMethods.CartesianProduct:

```
            return parents[0].__class__ -> return parents[0].__class__
```


I (Nicolas) take a double blame for it: I was reviewer of this ticket
and did not notice this chunk (or don't remember why it was
introduced), and I had not written an appropriate test in the first
place. So this needs to be fixed too.

Yet another bug reported by Nathann Cohen [2]: when converting a list
to an element of a cartesian product:

```
sage: Z3 = IntegerModRing(3)
sage: C = cartesian_product([Z3,Z3])
sage: C([Z3(2),Z3(2)])^2
(1, 1)
sage: C([2,2])^2   # Ooops
(4, 4)
```


The fix would be convert the operands of the list into the respective
parents in
`sage.sets.cartesian_product.CartesianProduct._element_constructor`.

Many features could be further added, like for example making the
cartesian product of an additive magma into an additive magma and so
on. This can go in this ticket or in later tickets.

[1] https://groups.google.com/forum/#!topic/sage-combinat-devel/8Aw63kro_0M
[2] https://groups.google.com/forum/#!msg/sage-devel/tyAxhqxk3ZI/rff7pTrGIQ4J

Issue created by migration from https://trac.sagemath.org/ticket/15425





---

archive/issue_comments_195051.json:
```json
{
    "body": "Changing type from defect to task.",
    "created_at": "2014-05-05T00:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195051",
    "user": "nthiery"
}
```

Changing type from defect to task.



---

archive/issue_comments_195052.json:
```json
{
    "body": "Hello,\n\n+1 on that ticket!\n\nI cleaned a bit the description.\n\nI think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.\n\nVincent",
    "created_at": "2014-05-05T06:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195052",
    "user": "vdelecroix"
}
```

Hello,

+1 on that ticket!

I cleaned a bit the description.

I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.

Vincent



---

archive/issue_comments_195053.json:
```json
{
    "body": "> I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.\n\nWe could mention it in the docstring of `cartesian_product`. \"If you just want to list the elements, use itertools.product as it is much faster\" ?",
    "created_at": "2014-05-05T07:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195053",
    "user": "ncohen"
}
```

> I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.

We could mention it in the docstring of `cartesian_product`. "If you just want to list the elements, use itertools.product as it is much faster" ?



---

archive/issue_comments_195054.json:
```json
{
    "body": "Replying to [comment:5 ncohen]:\n> > I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.\n> \n> We could mention it in the docstring of `cartesian_product`. \"If you just want to list the elements, use itertools.product as it is much faster\" ?\n\nSounds good to me, with 'list -> iterate through'",
    "created_at": "2014-05-05T09:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195054",
    "user": "nthiery"
}
```

Replying to [comment:5 ncohen]:
> > I think it is bad to hide `cartesian_product_iterator` as the object is very nice. We should advertise the `product` from `itertools` somewhere.
> 
> We could mention it in the docstring of `cartesian_product`. "If you just want to list the elements, use itertools.product as it is much faster" ?

Sounds good to me, with 'list -> iterate through'



---

archive/issue_comments_195055.json:
```json
{
    "body": "Hello,\n\nI think that we should get rid of `_cartesian_product_of_elements`. If we want speed we can either:\n- add an argument `coerce` to the `_element_constructor_`\n- use directly `element_class`\n\nVincent",
    "created_at": "2015-04-23T15:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195055",
    "user": "vdelecroix"
}
```

Hello,

I think that we should get rid of `_cartesian_product_of_elements`. If we want speed we can either:
- add an argument `coerce` to the `_element_constructor_`
- use directly `element_class`

Vincent



---

archive/issue_comments_195056.json:
```json
{
    "body": "Shouldn't the two following commands give the same answer\n\n```\nsage: ZZ**2\nAmbient free module of rank 2 over the principal ideal domain Integer Ring\nsage: cartesian_product([ZZ,ZZ])\nThe cartesian product of (Integer Ring, Integer Ring)\n```\n",
    "created_at": "2015-04-23T15:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195056",
    "user": "vdelecroix"
}
```

Shouldn't the two following commands give the same answer

```
sage: ZZ**2
Ambient free module of rank 2 over the principal ideal domain Integer Ring
sage: cartesian_product([ZZ,ZZ])
The cartesian product of (Integer Ring, Integer Ring)
```




---

archive/issue_comments_195057.json:
```json
{
    "body": "Bugs 5 and 6 are still present in 9.7.beta8",
    "created_at": "2022-08-11T04:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15188#issuecomment-195057",
    "user": "mkoeppe"
}
```

Bugs 5 and 6 are still present in 9.7.beta8
