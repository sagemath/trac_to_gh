# Issue 24356: Upgrade from Thebe to ThebeLab for live documentation support

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2018-01-25 23:18:53

CC:  jdemeyer tmonteil embray vdelecroix jhpalmieri klee arojas

[This is the Trac macro *Thebe* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#Thebe-macro) is a javascript library to turn static HTML pages into live documents where code cells can be edited and executed. Thebe was been introduced in #20690 as a replacement for the live documentation feature of sagenb. It covers the use case of browsing the documentation through the Jupyter notebook; in this case, Thebe connected to that notebook for computations.

However this model was not sustainable:
- Shipping Thebe is additional burden for Sage's maintainers and packagers
- Thebe is a fork of the Jupyter code base and thus not maintainable.
- In practice, Thebe got out of sync and soon became incompatible with the Jupyter we shipped. So the feature was lost.

Meanwhile, Thebe has been reimplemented as [This is the Trac macro *ThebeLab* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#ThebeLab-macro), a thin layer on top of JupyterLab, making it much more sustainable. In addition, an online computation backend is now available thanks to http://mybinder.org and Sage's docker container.

In this ticket, we switch gear, and focus on the use case of browsing the documentation from anywhere (within Jupyter, local static documentation, Sage's online documentation), with the assumption of an internet connection.

Implementation:
- When compiling the documentation, Sphinx adds a small header to the produced static html pages.
- If a page contains a sage code cell, an Activate button is added.
- Upon activation, the thebelab javascript library (and some of the jupyterlab javascript as dependency) is fetched from the web.
- Thebe is configured to use Sage's docker container on MyBinder as computation backend.

Bonus:
- Get rid of Thebe's package.

The feature has been tested for a couple months on 
[More SageMath Tutorials](http://more-sagemath-tutorials.readthedocs.io/). It's also configured by default for any Sage package that uses [sage-package](https://github.com/sagemath/sage-package).

We believe that dropping the use case of offline browsing while having a notebook running (which is broken anyway) is largely compensated by the much easier maintenance and the availability of the feature for all deployements of Sage's documentation.


---

Comment by nthiery created at 2018-01-27 10:51:28

New commits:


---

Comment by nthiery created at 2018-01-27 10:52:03

I am currently building the whole documentation on my machine to test it locally.


---

Comment by nthiery created at 2018-01-27 22:43:15

Works here, either when opening the html doc files directly in the browser as file:..., or by browsing the documentation through the Help menu of the Jupyter notebook.

Hence needs review.


---

Comment by nthiery created at 2018-01-27 22:43:38

Changing status from new to needs_review.


---

Comment by nthiery created at 2018-01-28 14:09:48

I had a look at the patchbot reports; one is gree. Some of the patchbot fails on compiling giac: most likely unrelated. For another the startup time is affected; again, it seems likely to be unrelated.


---

Comment by nthiery created at 2018-01-28 14:11:11

See sage-devel for the giac failure: apparently due to gcc that needs rebuilding (https://trac.sagemath.org/ticket/24599) .


---

Comment by tmonteil created at 2018-01-28 22:51:09

I am not sure to completely understand how the whole stuff work, here are some questions:

- The thebelab javascript is provided by a CDN (namely `unpkg.com`), and since the version is hardcoded in the link, if there is an upgrade of thebelab, there will be an update within Sage source code as well, so why not providing the javascript locally (by packaging thebelab), and avoid this remote intermediary ?

- The work of forking jupyterlab to extract the thebe-like part was done already by thebelab. Why not using that interesting part locally and use the running jupyter instance instead of mybinder ?

- How could a user running the doc from her Sage installation be sufficiently warned that, while a Sage kernel is currently running on her machine, the code will however be executed remotely ?

- mybinder FAQ explicitly states _ You shouldn't do anything on mybinder.org that you wouldn't mind sharing with the world! _ see https://mybinder.readthedocs.io/en/latest/faq.html#can-i-push-data-from-my-binder-session-back-to-my-repository How is this issue addressed since the goal of live documentation is precisely that the user will modify the cells with stuff she wants to try ?

- The local documentation depends on the version of Sage (e.g. existence of some method, option, ...), hence there must be a corresponding kernel on mybinder:
  - How is the local Sage version transmitted to mybinder so that the correct kernel is launched remotely ?
  - This require a frequent updates on the mybinder machines (one at each release). Who takes the responsibility of long-term maintenance of remote kernels ?

- What is the point of having this into Sagemath source code if Sagemath can not run it, as it requires remote servers to work anyway ? Why not instead maintaining a `livedoc.sagemath.org` service ? This would be more consistent and understandable from a user perspective.

- Is it possible to disable this feature when building Sage documentation (as we did for the plot directive) ?

- [this one is sarcastic] shall we consider having `sage --notebook` open a webpage redirecting to some cocalc or any similar centralized, bandwidth consuming, earth warming, privacy harming, open-source alternative ?


---

Comment by tmonteil created at 2018-01-28 22:51:51

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2018-01-30 06:40:49

I don't understand the following

```
Thebe is configured to use Sage's docker container on MyBinder as
computation backend.
```

This means that you need to use MyBinder in order to have live documentation? What is the point of having Sage on my computer then? To my mind, having a live documentation needing internet and a web service is not worth it.


---

Comment by vdelecroix created at 2018-01-30 07:24:32

To balance [comment:13 comment:13]: I think that using MyBinder would be good for let say `livedoc.sagemath.org` as Thierry suggested in [comment:11 comment:11].


---

Comment by novoselt created at 2018-01-30 08:57:29

What exactly are the differences between Thebe and SageMathCell? In particular:
* Do multiple users share the same running instance of the container?
* How many concurrent users can be supported?
* How long can a session run, i.e. if there are several linked cells, how long can one wait after executing the first one before executing the last one?
* What are CPU/memory/disk usage limits?

Regarding others comments: I also do not see the point in having my local documentation (which is build from the source on my machine, perhaps my own branch) to use for computations remote servers. Having a link (perhaps glued on the screen as the current Activate button) to some web server with live cells would be much less confusing in terms of accessing remote resources and different versions.


---

Comment by nthiery created at 2018-02-02 17:47:40

Hi everyone,

Thanks for the thoughtfull comments. I am done with teaching for the
week, and can finally come back to this.

I realized I forgot to state the obvious: yes, when possible, using a
locally running jupyter would be preferable for computations for all
the aforementionned reasons (use of resources, privacy, consistency
with the locally installed kernel, ...).

But this requires some additional work:
1. packaging thebelab
2. packaging jupyterlab
3. implementing the logic: "am I being served by a Jupyter server? If yes, connect there; otherwise offer binder as backup".
4. making sure that the jupyterlab client code is compatible with the Jupyter server we are running

I therefore aimed for a strategy in two stages:
- Implement something simple for now, put it in production, and assess how robust this is
- Add support for using a local Jupyter server when available

Additional motivations:
- the use of the local jupyter by our previous Thebe setup was broken
  anyway, This ticket tackles the most urgent: reinstating the feature
  in most use cases.
- we might as well wait for Sage to upgrade from Jupyter to JupyterLab
  before implementing the second step, to save on 2. and 4.

What do you think?

Now to more specific points:

> - The thebelab javascript is provided by a CDN (namely `unpkg.com`),
>   and since the version is hardcoded in the link, if there is an
>   upgrade of thebelab, there will be an update within Sage source
>   code as well, so why not providing the javascript locally (by
>   packaging thebelab), and avoid this remote intermediary ?

The link is actually using semantic versioning (that's the `^` in
`thebelab`@`^0.1.0`). So it will fetch the latest version of thebelab
whose API is meant to be backward compatible.


> - The work of forking jupyterlab to extract the thebe-like part was
>   done already by thebelab.

Just for clarification: it's not a fork. thebelab is using the vanilla
jupyterlab as a library.

> - How could a user running the doc from her Sage installation be
>   sufficiently warned that, while a Sage kernel is currently running
>   on her machine, the code will however be executed remotely ?

Yes, that's an important point. The tooltip explains this. Do you have
specific suggestions? We could e.g. easily change the Activate button
title or the messages that appear when it get pressed.

> - mybinder FAQ explicitly states '' You shouldn't do anything on
>   mybinder.org that you wouldn't mind sharing with the world! '' see
>   https://mybinder.readthedocs.io/en/latest/faq.html#can-i-push-data-from-my-binder-session-back-to-my-repository
>   How is this issue addressed since the goal of live documentation
>   is precisely that the user will modify the cells with stuff she
>   wants to try ?

The live documentation, is mostly meant for casually toying with small
variations of the existing examples; this sounds unlikely to leak
private information. That being said, yes, the user should be well
aware of what's happening in case she would want to play harder.

>   - This require a frequent updates on the mybinder machines (one at
>     each release). Who takes the responsibility of long-term
>     maintenance of remote kernels ?

The bulk of the work is to update the docker container, which have
many other use cases anyway. This is mostly automated. Erik and Julian
are working on fully automatizing this, toward including this in the
release process.

Beyond this, there remains on trivial item: updating the label in:

    https://github.com/sagemath/sage-binder-env/blob/master/Dockerfile

I am happy to volunteer on that for the next couple years :-)


> alternative the livedoc.sagemath.org approach

Our users browse the Sage documentation in many ways: on
doc.sagemath.org, through the notebook's Help menu, or browsing
directly the local html pages, or a copy of them on their department
page. With this ticket (and admittedly assuming internet), the user
can make the documentation live right where he is. Forcing her/him to
navigate to a parallel set of documentation pages is only making
things more complicated. And breaks the flow of reading.

Besides this would also forces us to setup and maintain a new service.

> - Is it possible to disable this feature when building Sage
>   documentation (as we did for the plot directive) ?

It should be doable, but I don't necessarily see the point. Except for
the 10 lines of javascript/css to setup the button, nothing happens
unless the user explicitly presses the activate button: no connection
to binder, no thebelab download, no network activity of any form.

> About thebelab and the Sage cell server

That's a real question, as there is much overlap between the two
projects. We actually discussed this with Jason Grout last week.

ThebeLab, like Jupyter, is language agnostic and targets a much much
wider community than the Sage cell server. It's therefore likely to
get more traction in the long run, in terms of users, developers, and
computing resources. It can also use any Jupyter server (a local
jupyter, a jupyterhub, binder, ...) that the user has credentials for.

The Sage cell server on the other hand is much more advanced when it
comes to performance. For example, when used with binder, a full new
jupyter ends up being started each time, rather than just spawning a
new kernel, or even forking an existing one.

I would love to see a convergence between the two projects, with the
cool features and ideas of the Sage cell server being ported over to
ThebeLab (or presumably down the stack into Jupyter/JupyterHub). Kind
of what happened with the Sage notebook and Jupyter.

Cheers,
                   Nicolas


---

Comment by nthiery created at 2018-02-02 17:55:34

Replying to [comment:15 novoselt]:
> What exactly are the differences between Thebe and SageMathCell? In particular:
> * Do multiple users share the same running instance of the container?

No

> * How many concurrent users can be supported?

I don't know for sure. Since the project has been revamped a couple months ago, Binder seems to scale relatively well. There are several ongoing efforts as well to add more deployements (like  [this one](http://binderhub.fedcloud-tf.fedcloud.eu/) on the "EU  cloud") though they are not federated yet.

> * How long can a session run, i.e. if there are several linked cells, how long can one wait after executing the first one before executing the last one?
> * What are CPU/memory/disk usage limits?

I would need to check on the binder docs.

I remember beeing really annoyed by Sage's live documentation that would loose its history in the middle of my lectures. But I have changed workflow and haven't used ThebeLab enough to have a feeling on whether this could become annoying for a typical usage.


---

Comment by schilly created at 2018-02-02 18:33:16

Hi, I see this here for the first time. Since I'm the one maintaining the public sage documentation files, will this an impact on it? Since that last "thebe" change, I always have to apply a patch to Sage in order to make it work (basically, to disable the javascript). https://github.com/sagemath/documentation/blob/gh-pages/thebe.patch

Is there also an intention to make this work for the doc.sagemath.org pages?


---

Comment by nthiery created at 2018-02-03 22:39:18

Hi Harald,

>  Hi, I see this here for the first time. Since I'm the one maintaining the
>  public sage documentation files, will this an impact on it? Since that
>  last "thebe" change, I always have to apply a patch to Sage in order to
>  make it work (basically, to disable the javascript).
>  https://github.com/sagemath/documentation/blob/gh-pages/thebe.patch
> 
>  Is there also an intention to make this work for the doc.sagemath.org
>  pages?

Thanks for investigating this. Yes, having this work on
doc.sagemath.org is one of the big point.

The new implementation consists of a couple lines of javascript and
css, which just assume standard internet connection to further fetch
thebelab's javascript from a cdn and connect to binder. This worked
without special action on ReadTheDoc. See e.g.:

        http://sage-package.readthedocs.io/en/latest/sage_package/sphinx-demo.html

Do you foresee anything specific in the doc.sagemath.org setup that
could break that? If useful, I can provide with a tiny tarball with
one example page and the js and css to be temporarily deployed in a
corner of docs.sagemath.org for testing.

Cheers,
                                Nicolas


---

Comment by schilly created at 2018-02-04 12:40:27

> Do you foresee anything specific in the doc.sagemath.org setup ...

No, there is nothing weird going on. It's just static files hosted on the "fastly" CDN. 

OTOH, I also don't remember what the problem is right now. Probably that it didn't load at all or something like that. That's why I disabled it.


---

Comment by nthiery created at 2018-02-04 13:04:47

> No, there is nothing weird going on. It's just static files hosted on the "fastly" CDN. 

Good. Then this should "just work".

> OTOH, I also don't remember what the problem is right now. Probably that it didn't load at all or something like that. That's why I disabled it.

Thebe is currently (i.e. before this ticket) configured in the Sage documentation to connect to a local notebook. So the feature could never have worked on doc.sagemath.org anyway. It could be that, in addition, the detection logic was faulty and causing problem.


---

Comment by nthiery created at 2018-02-13 22:47:07

I believe I provided tentative answers to the questions that were asked, so I am setting this back to needs review. Mostly as a ping.

Any opinions? In particular on the two stages approach?


---

Comment by nthiery created at 2018-02-13 22:47:07

Changing status from needs_info to needs_review.


---

Comment by novoselt created at 2018-02-13 23:49:24

>>       How could a user running the doc from her Sage installation be sufficiently warned that, while a Sage kernel is currently running on her machine, the code will however be executed remotely ? 
>Yes, that's an important point. The tooltip explains this. Do you have specific suggestions? We could e.g. easily change the Activate button title or the messages that appear when it get pressed. 

I think it should be much more clear that a remote server will be used and, perhaps, a different version of Sage. How about some dialog window with this information that appears when "Activate" is pressed? Perhaps with a checkbox "Don't show this again". Relying on users reading tooltips is unreliable...


---

Comment by nthiery created at 2018-02-14 16:37:58

Replying to [comment:23 novoselt]:
> I think it should be much more clear that a remote server will be used and, perhaps, a different version of Sage.

> How about some dialog window with this information that appears when "Activate" is pressed? Perhaps with a checkbox "Don't show this again". Relying on users reading tooltips is unreliable...

Dialog windows are a bit of a bother for users. I had a look at how you handle the same issue in SageMatCell. I like the "Help" and "About" links. A further improvement would be to have those links along the run button rather than at the end of the output: first to see them before actually pressing button, and also to save on vertical space.

This would need to be done upstream in Thebe though; I'll post a feature request there. It's also somewhat more complicated than for the [SageMathCell](SageMathCell) since there can be many possible configurations, and the message or page linked to should reflect that.

In the mean time, one easy thing to do would be to adapt the status messages that are displayed in the status field that replaces the Activate button. Currently it shows:
- building
- launching
- ready

We could make it into something like:
- Setting up Thebe
- Connecting to mybinder.org
- Connected to mybinder.og

where mybinder.org would be a clickable link.

What do you think? Suggestions for better wording?


---

Comment by novoselt created at 2018-02-14 17:00:31

Replying to [comment:24 nthiery]:
> Replying to [comment:23 novoselt]:
> > I think it should be much more clear that a remote server will be used and, perhaps, a different version of Sage.
> 
> > How about some dialog window with this information that appears when "Activate" is pressed? Perhaps with a checkbox "Don't show this again". Relying on users reading tooltips is unreliable...
> 
> Dialog windows are a bit of a bother for users. I had a look at how you handle the same issue in SageMatCell. I like the "Help" and "About" links. A further improvement would be to have those links along the run button rather than at the end of the output: first to see them before actually pressing button, and also to save on vertical space.

This is not at all the same issue: [SageMathCell](SageMathCell) handles cells embedded in random web pages without any relation to local installation. If a user opens some website, it is only natural that the content is using the internet. But when I build a local copy of Sage, perhaps with my own modifications, and local files from this copy use a remote server with a different version of Sage - that's not at all obvious.

I do agree that dialog windows are annoying, yet we had them for TOS when it was necessary and they would appear only once. I did not find this annoying at all and for showing an important and non-obvious piece of information that's a great solution, I think.

Regarding possible improvement for [SageMathCell](SageMathCell) - I've added a link to some existing ones. Presumably the output location was used as the one which is always visible (at least when things are working) while input can be completely hidden including the button.


---

Comment by vdelecroix created at 2018-02-16 16:40:45

Replying to [comment:22 nthiery]:
> I believe I provided tentative answers to the questions that were asked, so I am setting this back to needs review. Mostly as a ping.
> 
> Any opinions? In particular on the two stages approach?

For the time being, we could simply disable thebe (since you say that it is broken). Having in Sage an even more broken feature (= let users depend on internet and mybinder) is not an improvement. To my mind, the proposal in this ticket is for online documentation only (and a possible good proposal for that purpose). However, it has nothing to do inside the standard Sage.

The current branch is not like a huge amount of code and refactoring. So I don't see any emergency in including it at this stage. People who are interested in testing/using it can simply apply the branch as it is done for many experimental features.


---

Comment by nthiery created at 2018-02-17 14:23:01

Replying to [comment:26 vdelecroix]:
> For the time being, we could simply disable thebe (since you say that it is broken). Having in Sage an even more broken feature (= let users depend on internet and mybinder) is not an improvement.

Yes it is an improvement for the local documentation! It goes from non functional to functional -- admitedly with caveats -- when the user has internet.

Think in particular about the case where the reader is not browsing through a Jupyter server; e.g. because she opened the files directly with the browser or is on a local copy on a department page; then using the local Sage setup, as desirable as it would be, would be really hard: how to start Jupyter+Sage? how to discover an already running Jupyter? how to authenticate? Using a remote anonymous service as is done in this ticket is roughly the best we can hope to do.

Anyway, Vincent, I propose that we brainstorm about it over the phone. We are not converging here.


---

Comment by nthiery created at 2018-02-17 14:25:00

I have worked on improving the UI to give stronger feedback and background about the service to the user. You can try it on:

http://sage-package.readthedocs.io/en/latest/sage_package/sphinx-demo.html


---

Comment by git created at 2018-05-03 08:03:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-07 18:52:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-06-07 19:15:51

There seem to be merge conflicts.


---

Comment by saraedum created at 2018-06-07 19:15:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-07 21:57:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-07 23:32:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-07 23:37:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-07 23:40:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by nthiery created at 2018-06-07 23:47:42

With this new version:
- thebelab is packaged for Sage, and added in the jupyter notebook extensions
- if the page is served through a jupyter server, this tries to get thebelab
  from and run computations on that server;
  in particular, if the page is served from the users' [SageMath](SageMath) jupyter
  (e.g. the Help button), no internet connection is required
- if thebelab is not available locally, resort to downloading from internet
- if there is no jupyter server or no sagemath kernel, resort to using binder


---

Comment by nthiery created at 2018-06-07 23:49:13

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2018-06-07 23:55:35

Vincent: I believe this is what we had agreed upon, right?

**Questionable point**

As a new package, should the thebelab spkg be standard
or optional? Officially we should wait one year; however it replaces
an existing package, and it should be rather failsafe (a simple js file
to be installed by jupyter); also, up to the dependency upon on the
network, the live doc would still work without it.

What do you think?

**Timing**

when browsing the doc through Jupyter, it takes 4s on my machine from pressing the Activate button to displaying the first output.


---

Comment by nthiery created at 2018-06-08 00:12:11

The result in action: http://sage-package.readthedocs.io/en/latest/sage_package/sphinx-demo.html

Of course, this does not showcase the use of a local jupyter server. That takes an installation ...


---

Attachment

For reference:

I made a quick experiment of a semi-automatic notebook emulating
a static web page for testing whether thebelab
works; it does not require the documentation to be compiled.
See attached file (contains usage instructions).
Maybe it could eventually be fully automated and integrated in our test suite.


---

Comment by vdelecroix created at 2018-06-08 14:44:26

Hi Nicolas,

Sorry to have not worked on this! Too busy at MathExp and now I need to take care about my moving from Bordeaux.

Replying to [comment:38 nthiery]:
> Vincent: I believe this is what we had agreed upon, right?

Looks like it! Though I am unsure about the 100% availability without internet. I will try.

> **Questionable point**
> 
> As a new package, should the thebelab spkg be standard
> or optional? Officially we should wait one year; however it replaces
> an existing package, and it should be rather failsafe (a simple js file
> to be installed by jupyter); also, up to the dependency upon on the
> network, the live doc would still work without it.

For what and why should we wait one year? If it fixes issues it is fine to make it standard from now. Though this has to be discussed on sage-devel.

> What do you think?
> 
> **Timing**
> 
> when browsing the doc through Jupyter, it takes 4s on my machine from pressing the Activate button to displaying the first output.

4s in which mode (local or mybinder)? Starting a Jupter worksheet is much faster, most of the time is spent in starting Sage (1.5secs).


---

Comment by vdelecroix created at 2018-06-08 14:48:25

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-06-08 14:48:25

The tarball in attachment is invalid...

```
[thebelab-0.2.1] Found local metadata for thebelab-0.2.1
[thebelab-0.2.1] Invalid checksum for cached file /opt/sage/upstream/thebelab-0.2.1.tar.bz2, deleting
```



---

Comment by vdelecroix created at 2018-06-08 14:51:38

The instruction to build a new tarball

```
    THEBELAB_VERSION=0.2.1
    echo $THEBELAB_VERSION > package-version.txt
    mkdir src
    wget https://unpkg.com/thebelab`@`\^$THEBELAB_VERSION -O src/thebelab.js
    tar -jcvf thebelab-$THEBELAB_VERSION.tar.bz2 src
    rm  src/thebelab.js; rmdir src
    mv thebelab-$THEBELAB_VERSION.tar.bz2 ../../../upstream
    sage --package fix-checksum
```

should be in a `spkg-src` script (there are many of them in Sage for inspiration).


---

Comment by vdelecroix created at 2018-06-08 14:52:38

Still in `SPKG.txt` I would prefer if `#20690` and `#24593` were complete url. It is not clear that you are refering to trac ticket numbers.


---

Comment by vdelecroix created at 2018-06-08 14:59:32

Replying to [comment:42 vdelecroix]:
> The tarball in attachment is invalid...
> {{{
> [thebelab-0.2.1] Found local metadata for thebelab-0.2.1
> [thebelab-0.2.1] Invalid checksum for cached file /opt/sage/upstream/thebelab-0.2.1.tar.bz2, deleting
> }}}

Actually, the link to the tarball should be

    https://trac.sagemath.org/raw-attachment/ticket/24593/thebelab-0.2.1.tar.bz2

(checksum were correct)


---

Comment by vdelecroix created at 2018-06-08 15:21:14

Works well on my computer (and it is much faster than 4secs to start).


---

Comment by vdelecroix created at 2018-06-08 15:27:38

Once you click on activate, two links appear in place of the button: "Sage" (pointing to sagemath.org) and "About" (pointing to http://sage-package.readthedocs.io/en/latest/sage_package/thebe.html). The latter one is pointing to a page that does not mention the fact that the examples can (and does) run with a local Jupyter.


---

Comment by nthiery created at 2018-06-08 15:40:59

Replying to [comment:47 vdelecroix]:
> Once you click on activate, two links appear in place of the button: "Sage" (pointing to sagemath.org) and "About" (pointing to http://sage-package.readthedocs.io/en/latest/sage_package/thebe.html). The latter one is pointing to a page that does not mention the fact that the examples can (and does) run with a local Jupyter.


```
Documentation pages produced with sage-package take further steps to reduce the dependence on network and cloud services. If the page is served by a Jupyter server, it will attempt to use it to fetch the Thebe javascript and run the computations.
```


That being said, you are welcome to edit the [sources](https://github.com/sagemath/sage-package/blob/master/docs/sage_package/thebe.rst) of this page if you have ideas to improve the wording and make the information more prominent while keeping it reasonably concise.


---

Comment by nthiery created at 2018-06-08 15:54:33

Replying to [comment:43 vdelecroix]:
> The instruction to build a new tarball
> {{{
>     THEBELAB_VERSION=0.2.1
>     echo $THEBELAB_VERSION > package-version.txt
>     mkdir src
>     wget https://unpkg.com/thebelab`@`\^$THEBELAB_VERSION -O src/thebelab.js
>     tar -jcvf thebelab-$THEBELAB_VERSION.tar.bz2 src
>     rm  src/thebelab.js; rmdir src
>     mv thebelab-$THEBELAB_VERSION.tar.bz2 ../../../upstream
>     sage --package fix-checksum
> }}}
> should be in a `spkg-src` script (there are many of them in Sage for inspiration).

I considered this, but then dropped the idea after reading the dev guide: we are indeed not
changing the upstream sources:
```
The spkg-src file is optional and only to document how the upstream tarball was changed. Ideally it is not modified, then there would be no spkg-src file present either.
```

Is your argument that building a tarball is a change by itself to the upstream sources?
Then, yeah, sure, we could do that.


---

Comment by git created at 2018-06-08 15:56:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2018-06-08 15:58:33

Replying to [comment:44 vdelecroix]:
> Still in `SPKG.txt` I would prefer if `#20690` and `#24593` were complete url. It is not clear that you are refering to trac ticket numbers.

Done. That being said it seems that most SPKG.txt refer to ticket by number rather than URL ...


---

Comment by nthiery created at 2018-06-08 16:01:19

> Works well on my computer (and it is much faster than 4secs to start).

Starting Sage by itself on my machine takes 2.5s :-) Indeed, if I am quick at clicking Activate -> Run, I can get down to 3s.

I guess it's going to be time to get a faster machine!


---

Comment by slelievre created at 2018-06-14 14:23:13

Note: there is popular demand for this feature!

See this question.posted today on StackOverflow:

- [[StackOverflow 50854931] Does SageMath provide interactive tutorials?](https://stackoverflow.com/questions/50854931/does-sagemath-provide-interactive-tutorials)


---

Comment by jdemeyer created at 2018-06-14 14:43:18

Replying to [ticket:24593 nthiery]:
> thebelab tarball
> 
>     https://trac.sagemath.org/raw-attachment/ticket/24593/thebelab-0.2.1.tar.bz2

Why is that an attachment on a Sage Trac ticket? Does thebelab not have proper releases?


---

Comment by jdemeyer created at 2018-06-14 14:46:34

Does this require an installation of JupyterLab?


---

Comment by jdemeyer created at 2018-06-14 14:54:24

This is not acceptable:

```
To upgrade the sources to a new version:

    THEBELAB_VERSION=0.2.1
    echo $THEBELAB_VERSION > package-version.txt
    mkdir src
    wget https://unpkg.com/thebelab`@`\^$THEBELAB_VERSION -O src/thebelab.js
    tar -jcvf thebelab-$THEBELAB_VERSION.tar.bz2 src
    rm  src/thebelab.js; rmdir src
    mv thebelab-$THEBELAB_VERSION.tar.bz2 ../../../upstream
    sage --package fix-checksum
```

If you really require a special script for generating the source tarball (why?), then it should be a `spkg-src` file. See `build/pkgs/glpk/spkg-src` for a good example.


---

Comment by vdelecroix created at 2018-06-14 15:10:32

Replying to [comment:56 jdemeyer]:
> This is not acceptable:
> {{{
> To upgrade the sources to a new version:
> 
>     THEBELAB_VERSION=0.2.1
>     echo $THEBELAB_VERSION > package-version.txt
>     mkdir src
>     wget https://unpkg.com/thebelab`@`\^$THEBELAB_VERSION -O src/thebelab.js
>     tar -jcvf thebelab-$THEBELAB_VERSION.tar.bz2 src
>     rm  src/thebelab.js; rmdir src
>     mv thebelab-$THEBELAB_VERSION.tar.bz2 ../../../upstream
>     sage --package fix-checksum
> }}}
> If you really require a special script for generating the source tarball (why?), then it should be a `spkg-src` file. See `build/pkgs/glpk/spkg-src` for a good example.

You are repeating [comment:43 comment:43]...


---

Comment by nthiery created at 2018-06-16 15:29:29

Replying to [comment:57 vdelecroix]:
> You are repeating [comment:43 comment:43]...

Indeed. And in an unpleasant tone, especially given the ambiguity of the doc on the topic.

But let's leave this aside: I am totally fine with having a spkg-src script. Not sure I'll get to it right away though, so feel free to take that part over.

About thebelab's tarball: yes, AFAIK thebelab does not yet have an official tarball: it's released as a single javascript file distributed on usual CDN's; I guess this is a rather standard thing in the javascript world, but I am no expert in those things. I'll ask Min when I see him on Wednesday, and whether there should be an official tarball.

About the dependency on jupyterlab: yes thebelab uses the jupyterlab code base, but the relevant part is automatically bundled in the downloaded javascript. So it does not depend on jupyterlab being installed separately. Of course we may hope that, once Sage will ship by default with jupyterlab, there would be a way to not ship the same code twice.


---

Comment by jdemeyer created at 2018-06-16 22:20:13

Replying to [comment:58 nthiery]:
> And in an unpleasant tone

Sorry for that, I didn't intend that.

> About thebelab's tarball: yes, AFAIK thebelab does not yet have an official tarball: it's released as a single javascript file distributed on usual CDN's; I guess this is a rather standard thing in the javascript world, but I am no expert in those things. I'll ask Min when I see him on Wednesday, and whether there should be an official tarball.

Please ask him. There are also the github tarballs (https://github.com/minrk/thebelab/releases), would that work?

> About the dependency on jupyterlab: yes thebelab uses the jupyterlab code base, but the relevant part is automatically bundled in the downloaded javascript. So it does not depend on jupyterlab being installed separately.

Thanks for the answer. It would be good to document this clearly in `SPKG.txt`.


---

Comment by nthiery created at 2018-06-20 21:37:46

Brief update after talking to min: thebelab is being distributed through npm, and
a tarball can be obtained from:


    https://registry.npmjs.org/thebelab/-/thebelab-0.2.1.tgz

I'll try to update the branch here accordingly, unless someone is quicker!


---

Comment by git created at 2018-06-21 21:59:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2018-06-21 22:00:46

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-06-21 22:04:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2018-06-21 22:06:00

Alright; I guess all the reviewers suggestions have been addressed?

Cheers


---

Comment by nthiery created at 2018-06-22 05:25:44

Changing status from needs_review to needs_work.


---

Comment by nthiery created at 2018-06-22 05:25:44

Oops, the format of the tarball downloaded from npm is not the same as the one I was creating myself ...


---

Comment by git created at 2018-07-17 18:36:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-17 18:58:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-17 18:59:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2018-07-17 19:01:29

Changing status from needs_work to needs_info.


---

Comment by nthiery created at 2018-07-17 19:01:29

The bundled spkg-src script builds the tarball from npm; this way we delegate
to npm the building (with webpack) of the standalone js file for thebelab.


---

Comment by nthiery created at 2018-07-17 19:01:52

Changing status from needs_info to needs_review.


---

Comment by git created at 2018-07-23 19:14:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-23 19:15:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by jdemeyer created at 2018-08-07 13:56:37

Replying to [comment:65 nthiery]:
> Oops, the format of the tarball downloaded from npm is not the same as the one I was creating myself ...

Sorry, what you mean with this? In other words: why cannot you use the tarball ​https://registry.npmjs.org/thebelab/-/thebelab-0.2.1.tgz

There also seems to be a version mismatch: on the ticket, you posted `thebelab-0.2.1.2.tgz` (I assume created using `spkg-src`) but in the branch, there is version 0.2.1


---

Comment by jdemeyer created at 2018-08-07 13:56:37

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-08-07 13:57:45

Typo: `shiped` -> `shipped`


---

Comment by jdemeyer created at 2018-08-07 14:01:03

Doesn't the `^` mean that the version might not be the exact version that you specified?

```
wget https://unpkg.com/$PACKAGENAME`@`\^$UPLOADVERSION -O src/$PACKAGENAME.js
```


By the way, this might be more readable as follows:

```
wget "https://unpkg.com/${PACKAGENAME}`@`${UPLOADVERSION}" -O src/$PACKAGENAME.js
```



---

Comment by nthiery created at 2018-08-08 00:08:42

Replying to [comment:75 jdemeyer]:
> Replying to [comment:65 nthiery]:
> > Oops, the format of the tarball downloaded from npm is not the same as the one I was creating myself ...
> 
> Sorry, what you mean with this? In other words: why cannot you use the tarball ​https://registry.npmjs.org/thebelab/-/thebelab-0.2.1.tgz

Because it's the source tarball for thebelab. Oh, but actually there is a lib subdirectory which contained the webpacked's javascript file; I had missed that. So we could actually use it.

> There also seems to be a version mismatch: on the ticket, you posted `thebelab-0.2.1.2.tgz` (I assume created using `spkg-src`) but in the branch, there is version 0.2.1

That was just me running through hoops to replace an existing file ... Anyway we don't need it any more.


---

Comment by nthiery created at 2018-08-08 00:10:15

I am on vacations until August 14th; feel free to proceed and implement the suggested changes. Otherwise I'll take care of them when I am back.

Thanks for the review


---

Comment by jdemeyer created at 2018-10-28 23:19:34

New commits:


---

Comment by git created at 2018-10-29 11:08:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-10-31 12:58:59

This is working as intended, both locally and remotely, except that it's always downloading the font from the web.


---

Comment by jdemeyer created at 2018-10-31 12:59:56

I found out that the font comes from jupyterlab.


---

Comment by nthiery created at 2018-11-11 21:49:58

Ok. So presumably we will have that font available locally as soon as Jupyterlab will ship with Sage.
I would tend to see this as a very minor caveat, given that the whole thing works without Internet, albeit with a slightly less nice font. So, unless we see an immediate solution, I would tend to proceed as is for now.

Other than this font issue, is there anything left to be done? Or shall I press positive review once I'll have reviewed your latest changes?


---

Comment by jdemeyer created at 2018-11-13 09:28:10

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2018-11-13 09:28:29

Replying to [comment:88 nthiery]:
> Other than this font issue, is there anything left to be done?

I don't think so.


---

Comment by slelievre created at 2018-11-13 11:31:50

For reference:

- #26059 Make JupyterLab an optional package
- #24904 Make JupyterLab a standard package


---

Comment by jdemeyer created at 2019-01-06 08:24:25

ping?


---

Comment by chapoton created at 2020-05-13 16:01:41

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2020-05-13 16:01:41

red branch and OpenDreamKit is over


---

Comment by chapoton created at 2020-05-13 16:01:41

Changing keywords from "" to "notebook".


---

Comment by mkoeppe created at 2020-08-19 20:31:23

Could someone please take care of this ticket before it bitrots completely?


---

Comment by slelievre created at 2020-09-02 00:31:38

In the meantime Thebelab changed its name to Thebe.

For reference the renaming discussion is here:

- https://github.com/executablebooks/thebe/issues/219


---

Comment by mkoeppe created at 2020-09-02 00:48:53

... but we still have the old Thebe?


---

Comment by mkoeppe created at 2020-09-02 06:00:01

This seems to be upstream now: https://github.com/executablebooks/thebe


---

Comment by mkoeppe created at 2020-09-02 06:02:41

https://www.npmjs.com/package/thebelab


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by slelievre created at 2021-04-30 09:04:57

Requested again at

- [Ask Sage question 56875: Working through the Sage tutorial in a notebook error](https://ask.sagemath.org/question/56875)


---

Comment by slelievre created at 2021-04-30 09:54:06

Thebelab changed its name back to Thebe.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by klee created at 2021-11-12 11:56:50

Nicolas, what is the status of the branch?


---

Comment by mkoeppe created at 2022-03-19 01:35:47

I've split out the removal of the old `thebe` package as #33529.

I don't think we need to ship the new `thebe` at all as an SPKG. As our use of it involves mybinder.org, the generated web pages can also just get the `thebe` from the CDN.


---

Comment by klee created at 2022-03-22 04:07:40

I agree. The feature in the ticket description is now achieved by #33507. Hence we can close this ticket.

But I would like to acknowledge that the infrastructure, namely the repo `sagemath/sage-binder-env` set up and maintained  by Nicolas M. Thiéry and Jeroen Demeyer was very valuable for the rapid development of #33507. Thank you.


---

Comment by klee created at 2022-03-22 04:13:46

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2022-03-22 07:51:09

I agree that this ticket is no longer needed, and that
having a solution based on a now existing external
library (jupyter-sphinx) is better!


---

Comment by nthiery created at 2022-03-22 07:52:00

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-03-23 00:23:59

To be continued at #33320.


---

Comment by mkoeppe created at 2022-05-11 02:14:43

Resolution: invalid
