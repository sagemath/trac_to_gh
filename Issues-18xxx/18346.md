# Issue 18346: Easier handling of vertex labels in graph backends

archive/issues_018109.json:
```json
{
    "body": "This ticket addresses the following problem:\n\n    In the `CGraph` backends, three `cdef` functions are used all the time to\n    deal with vertex labels, i.e. `get_vertex`, `vertex_label`,\n`check_vertex`. They are always called with the same arguments, which are\n    all attributes of the backend that calls it. They should be method, so that\n    the arguments are not needlessly repeated.\n\nWhat this branch does:\n\n- The `CGraph` backends (i.e. `SparseBackend`, `DenseBackend` and\n  `StaticSparseGraph`) and `GenericGraphBackend` are turned into cdef classes.\n\n- The three functions `get_vertex`, `vertex_label`, `check_vertex` become\n  methods of `CGraphBackend`\n\n- It adds a method `CGraphBackend.c_graph()` to get the two cdef attributes\n  `_cg` and `_cg_rev`. Turns out that some code in Sage accesses directly\n  `G._backend._cg`.\n\nThis should have been sufficient, but there were (unexpected) consequences:\n\n- There is no automatic pickling for cdef classes (as instrospection does not\n  work), and the doctests do not pass if that does not work. Consequently, I\n  implemented a unique `__reduce__` function in `GenericGraphBackend` which\n  handles the pickling for all backends (sparse/dense/static/networkx). It also\n  removes some duplicated code as a result.\n\nThis makes the code a bit clearer (and it is needed). Also, moving this pickling\nfunction above is good for the future, for there will be many modifications in\nthe future to the data structures in Sage: I plan to merge `CGraph` and\n`GenericBackend` into only one class (but that's for later).\n\nNathann\n\nP.S.: The branch is built to be reviewed commit by commit. In particular, the renamed file appears as trivial when looking at the first commit, but as a lot of + and - when looking at the branch's diff\n\nCC:  borassi @dcoudert @darijgr @videlec\n\nBranch/Commit: 6ffbb05999f70fa2535f28aca08b203036664491\n\nReviewer: Vincent Delecroix\n\nAuthor: Nathann Cohen\n\nDependencies: #18317\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18346\n\n",
    "closed_at": "2015-05-04T19:04:37Z",
    "created_at": "2015-05-01T08:26:50Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Easier handling of vertex labels in graph backends",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18346",
    "user": "https://github.com/nathanncohen"
}
```
This ticket addresses the following problem:

    In the `CGraph` backends, three `cdef` functions are used all the time to
    deal with vertex labels, i.e. `get_vertex`, `vertex_label`,
`check_vertex`. They are always called with the same arguments, which are
    all attributes of the backend that calls it. They should be method, so that
    the arguments are not needlessly repeated.

What this branch does:

- The `CGraph` backends (i.e. `SparseBackend`, `DenseBackend` and
  `StaticSparseGraph`) and `GenericGraphBackend` are turned into cdef classes.

- The three functions `get_vertex`, `vertex_label`, `check_vertex` become
  methods of `CGraphBackend`

- It adds a method `CGraphBackend.c_graph()` to get the two cdef attributes
  `_cg` and `_cg_rev`. Turns out that some code in Sage accesses directly
  `G._backend._cg`.

This should have been sufficient, but there were (unexpected) consequences:

- There is no automatic pickling for cdef classes (as instrospection does not
  work), and the doctests do not pass if that does not work. Consequently, I
  implemented a unique `__reduce__` function in `GenericGraphBackend` which
  handles the pickling for all backends (sparse/dense/static/networkx). It also
  removes some duplicated code as a result.

This makes the code a bit clearer (and it is needed). Also, moving this pickling
function above is good for the future, for there will be many modifications in
the future to the data structures in Sage: I plan to merge `CGraph` and
`GenericBackend` into only one class (but that's for later).

Nathann

P.S.: The branch is built to be reviewed commit by commit. In particular, the renamed file appears as trivial when looking at the first commit, but as a lot of + and - when looking at the branch's diff

CC:  borassi @dcoudert @darijgr @videlec

Branch/Commit: 6ffbb05999f70fa2535f28aca08b203036664491

Reviewer: Vincent Delecroix

Author: Nathann Cohen

Dependencies: #18317

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18346





---

archive/issue_comments_259658.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-01T08:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259658",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_259659.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2015-05-01T08:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259659",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_259660.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2015-05-01T08:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259660",
    "user": "https://github.com/nathanncohen"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_259661.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -33,6 +33,8 @@\n \n Nathann\n \n+P.S.: The branch is built to be reviewed commit by commit. In particular, the renamed file appears as trivial when looking at the first commit, but as a lot of + and - when looking at the branch's diff\n+\n Author: Nathann Cohen\n \n Comment: 1\n```\n",
    "created_at": "2015-05-01T08:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259661",
    "user": "https://github.com/nathanncohen"
}
```

Description changed:
```diff
--- 
+++ 
@@ -33,6 +33,8 @@
 
 Nathann
 
+P.S.: The branch is built to be reviewed commit by commit. In particular, the renamed file appears as trivial when looking at the first commit, but as a lot of + and - when looking at the branch's diff
+
 Author: Nathann Cohen
 
 Comment: 1
```




---

archive/issue_comments_259662.json:
```json
{
    "body": "<a id='comment:3'></a>Hello,\n\n1. Would it be bad to access directly the `._cg` or `._cg_rev` attributes? (ok it seems to be for python code)\n\n2. Is there a description somewhere of the attributes `vertex_ints` and `vertex_labels`?\n\n3. In a cython file, there is no need to declare `cdef object x` or `object x`, just do `x`.\n\nVincent",
    "created_at": "2015-05-01T09:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259662",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>Hello,

1. Would it be bad to access directly the `._cg` or `._cg_rev` attributes? (ok it seems to be for python code)

2. Is there a description somewhere of the attributes `vertex_ints` and `vertex_labels`?

3. In a cython file, there is no need to declare `cdef object x` or `object x`, just do `x`.

Vincent



---

archive/issue_comments_259663.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-05-01T09:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259663",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_259664.json:
```json
{
    "body": "<a id='comment:5'></a>Hello,\n\n> 1. Would it be bad to access directly the `._cg` or `._cg_rev` attributes? (ok it seems to be for python code)\n\n\nI do not think that it is if you do not modify them. Some functions (like isomorphism test) use it directly. The guy who wrote the code that does that knew what he was doing, unfortunately he is the only one `:-P`\n\n> 2. Is there a description somewhere of the attributes `vertex_ints` and `vertex_labels`?\n\n\nNot that I know. I am not sure that I remember exactly what they do either. What I remember is that not all vertices have an associated label, so that you don't spend your time playing with a dictionary when your graph is defined over integers.\n\nThis being said, I plan to rewrite all this (and of course the new code will have a proper documentation). I spent several hours thinking of how this should all be done, and my hardest constraint was that the changes should be \"reviewable\". Which is not very easily achieved when you plan to merge two classes together `:-P`\n\nThe 'first step' was #18185, the second is this one (or #18317, but that's only doc). Then I will turn NetworkX backend into a CGraph, and deprecate a lot of things in there. And then... Merge the classes `O_O;;`\n\n> 3. In a cython file, there is no need to declare `cdef object x` or `object x`, just do `x`.\n\n\nOkay. Well, I don't think I did anything like that but I may have met such a line somewhere. Really, this does not matter for the moment: this code will be heavily rewritten.\n\nNathann",
    "created_at": "2015-05-01T10:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259664",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>Hello,

> 1. Would it be bad to access directly the `._cg` or `._cg_rev` attributes? (ok it seems to be for python code)


I do not think that it is if you do not modify them. Some functions (like isomorphism test) use it directly. The guy who wrote the code that does that knew what he was doing, unfortunately he is the only one `:-P`

> 2. Is there a description somewhere of the attributes `vertex_ints` and `vertex_labels`?


Not that I know. I am not sure that I remember exactly what they do either. What I remember is that not all vertices have an associated label, so that you don't spend your time playing with a dictionary when your graph is defined over integers.

This being said, I plan to rewrite all this (and of course the new code will have a proper documentation). I spent several hours thinking of how this should all be done, and my hardest constraint was that the changes should be "reviewable". Which is not very easily achieved when you plan to merge two classes together `:-P`

The 'first step' was #18185, the second is this one (or #18317, but that's only doc). Then I will turn NetworkX backend into a CGraph, and deprecate a lot of things in there. And then... Merge the classes `O_O;;`

> 3. In a cython file, there is no need to declare `cdef object x` or `object x`, just do `x`.


Okay. Well, I don't think I did anything like that but I may have met such a line somewhere. Really, this does not matter for the moment: this code will be heavily rewritten.

Nathann



---

archive/issue_comments_259665.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-05-01T10:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259665",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_259666.json:
```json
{
    "body": "<a id='comment:6'></a>Hello,\n\nReplying to [comment:5 ncohen]:\n> > 2. Is there a description somewhere of the attributes `vertex_ints` and `vertex_labels`?\n  \n> \n> Not that I know. I am not sure that I remember exactly what they do either. What I remember is that not all vertices have an associated label, so that you don't spend your time playing with a dictionary when your graph is defined over integers.\n\n\nActually you do since `get_vertex` or `vertex_label` are intensively used everywhere. And those methods do check if their argument belongs to some dictionary as a first step! But if I understand well, the aim of the ticket is precisely **not** to upgrade these two methods but just to move them.\n \n> > 3. In a cython file, there is no need to declare `cdef object x` or `object x`, just do `x`.\n  \n> \n> Okay. Well, I don't think I did anything like that but I may have met such a line somewhere. Really, this does not matter for the moment: this code will be heavily rewritten.\n\n\nHum\n\n```diff\n+ cdef int get_vertex(self, object u) except ? -2\n+ cdef object vertex_label(self, int u_int)\n```\nthis would better be\n\n```diff\ncdef int get_vertex(self, u) except ? -2\ncdef vertex_label(self, int u_int)\n```\n\nVincent",
    "created_at": "2015-05-02T10:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259666",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>Hello,

Replying to [comment:5 ncohen]:
> > 2. Is there a description somewhere of the attributes `vertex_ints` and `vertex_labels`?
  
> 
> Not that I know. I am not sure that I remember exactly what they do either. What I remember is that not all vertices have an associated label, so that you don't spend your time playing with a dictionary when your graph is defined over integers.


Actually you do since `get_vertex` or `vertex_label` are intensively used everywhere. And those methods do check if their argument belongs to some dictionary as a first step! But if I understand well, the aim of the ticket is precisely **not** to upgrade these two methods but just to move them.
 
> > 3. In a cython file, there is no need to declare `cdef object x` or `object x`, just do `x`.
  
> 
> Okay. Well, I don't think I did anything like that but I may have met such a line somewhere. Really, this does not matter for the moment: this code will be heavily rewritten.


Hum

```diff
+ cdef int get_vertex(self, object u) except ? -2
+ cdef object vertex_label(self, int u_int)
```
this would better be

```diff
cdef int get_vertex(self, u) except ? -2
cdef vertex_label(self, int u_int)
```

Vincent



---

archive/issue_comments_259667.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-02T19:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259667",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259668.json:
```json
{
    "body": "<a id='comment:8'></a>Yo !\n\n> Actually you do since `get_vertex` or `vertex_label` are intensively used everywhere. And those methods do check if their argument belongs to some dictionary as a first step!\n\n\nOh really? But perhaps the dictionary does *not* contain the integers then? Anyway, does not matter much.\n\n> But if I understand well, the aim of the ticket is precisely **not** to upgrade these two methods but just to move them.\n\n\nThe aim of this ticket is to merge CGraph and Backend together. All that \"backend\" does is forward everything to CGraph. But I certainly cannot do all of this at once, it would be impossible to review. Plus because of the problems I met when writing this branch, I know that I should be wary of the isomorphism test code which works at a lower level than I expected.\n\n> Hum\n> \n> ```diff\n> + cdef int get_vertex(self, object u) except ? -2\n> + cdef object vertex_label(self, int u_int)\n> ```\nFixed. Actually, those are the lines that I moved from functions to methods. You will find (almost) the same lines with a '-' in front of them, a couple of lines above.\n\nNathann",
    "created_at": "2015-05-02T19:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259668",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'></a>Yo !

> Actually you do since `get_vertex` or `vertex_label` are intensively used everywhere. And those methods do check if their argument belongs to some dictionary as a first step!


Oh really? But perhaps the dictionary does *not* contain the integers then? Anyway, does not matter much.

> But if I understand well, the aim of the ticket is precisely **not** to upgrade these two methods but just to move them.


The aim of this ticket is to merge CGraph and Backend together. All that "backend" does is forward everything to CGraph. But I certainly cannot do all of this at once, it would be impossible to review. Plus because of the problems I met when writing this branch, I know that I should be wary of the isomorphism test code which works at a lower level than I expected.

> Hum
> 
> ```diff
> + cdef int get_vertex(self, object u) except ? -2
> + cdef object vertex_label(self, int u_int)
> ```
Fixed. Actually, those are the lines that I moved from functions to methods. You will find (almost) the same lines with a '-' in front of them, a couple of lines above.

Nathann



---

archive/issue_comments_259669.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 ncohen]:\n> The aim of this ticket is to merge CGraph and Backend together. All that \"backend\" does is forward everything to CGraph. But I certainly cannot do all of this at once, it would be impossible to review. Plus because of the problems I met when writing this branch, I know that I should be wary of the isomorphism test code which works at a lower level than I expected.\n\n\nWill you keep these `get_vertex` and `vertex_label` forever? If you do so I will had a commit to optimize them. They are basically used everywhere.\n\nVincent",
    "created_at": "2015-05-02T19:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259669",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>Replying to [comment:8 ncohen]:
> The aim of this ticket is to merge CGraph and Backend together. All that "backend" does is forward everything to CGraph. But I certainly cannot do all of this at once, it would be impossible to review. Plus because of the problems I met when writing this branch, I know that I should be wary of the isomorphism test code which works at a lower level than I expected.


Will you keep these `get_vertex` and `vertex_label` forever? If you do so I will had a commit to optimize them. They are basically used everywhere.

Vincent



---

archive/issue_comments_259670.json:
```json
{
    "body": "<a id='comment:10'></a>> Will you keep these `get_vertex` and `vertex_label` forever? If you do so I will had a commit to optimize them. They are basically used everywhere.\n\n\nI have no idea for the moment. If there is something you want to change, it really cannot hurt.\n\nNathann",
    "created_at": "2015-05-02T19:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259670",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>> Will you keep these `get_vertex` and `vertex_label` forever? If you do so I will had a commit to optimize them. They are basically used everywhere.


I have no idea for the moment. If there is something you want to change, it really cannot hurt.

Nathann



---

archive/issue_comments_259671.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-02T20:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259671",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259672.json:
```json
{
    "body": "<a id='comment:12'></a>I win some very precious nano seconds and add a tiny bit of documentation for `vertex_labels` and `vertex_ints`. I will start reviewing your other commits.\n\nVincent",
    "created_at": "2015-05-02T20:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259672",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>I win some very precious nano seconds and add a tiny bit of documentation for `vertex_labels` and `vertex_ints`. I will start reviewing your other commits.

Vincent



---

archive/issue_comments_259673.json:
```json
{
    "body": "<a id='comment:13'></a>Heuuuuuuu... Sorry Vincent but I am not really sure that what this code needs is 10 more lines to convert integer types from one to another....\n\nAnd if you remove some 'object', please remove them from the `.pxd` file too.",
    "created_at": "2015-05-03T06:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259673",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:13'></a>Heuuuuuuu... Sorry Vincent but I am not really sure that what this code needs is 10 more lines to convert integer types from one to another....

And if you remove some 'object', please remove them from the `.pxd` file too.



---

archive/issue_comments_259674.json:
```json
{
    "body": "<a id='comment:14'></a>If this kind of cast from !Python/!Sage integer is really costly, perhaps we should have a cdef function that does it somewhere? Do I make a mistake if I say that you wrote this code in order to avoid having to raise an exception in many cases ?\n\nNathann",
    "created_at": "2015-05-03T06:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259674",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:14'></a>If this kind of cast from !Python/!Sage integer is really costly, perhaps we should have a cdef function that does it somewhere? Do I make a mistake if I say that you wrote this code in order to avoid having to raise an exception in many cases ?

Nathann



---

archive/issue_comments_259675.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 ncohen]:\n> If this kind of cast from !Python/!Sage integer is really costly, perhaps we should have a cdef function that does it somewhere?\n\n\nThat's a possibility, but it is not clear what should be the signature of the function. What if it fails?\n\n> Do I make a mistake if I say that you wrote this code in order to avoid having to raise an exception in many cases?\n\n\nIt is not only that: calling directyl `mpz_get_si` or `PyInt_AS_LONG` is faster than the cast which does call `PyInt_AsLong`. But that's true that I do not like this `try/except`.",
    "created_at": "2015-05-03T14:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259675",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:14 ncohen]:
> If this kind of cast from !Python/!Sage integer is really costly, perhaps we should have a cdef function that does it somewhere?


That's a possibility, but it is not clear what should be the signature of the function. What if it fails?

> Do I make a mistake if I say that you wrote this code in order to avoid having to raise an exception in many cases?


It is not only that: calling directyl `mpz_get_si` or `PyInt_AS_LONG` is faster than the cast which does call `PyInt_AsLong`. But that's true that I do not like this `try/except`.



---

archive/issue_comments_259676.json:
```json
{
    "body": "<a id='comment:16'></a>Yo !\n\n> That's a possibility, but it is not clear what should be the signature of the function. What if it fails?\n\n\n`LONG_MAX` ?\n\n> It is not only that: calling directyl `mpz_get_si` or `PyInt_AS_LONG` is faster than the cast which does call `PyInt_AsLong`. But that's true that I do not like this `try/except`.\n\n\nWell, if you can turn it into an independent function in some other module (something integer-related) then no problem. This code is much more in need of clarity than nanoseconds at the moment `:-P`\n\nNathann",
    "created_at": "2015-05-03T14:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259676",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>Yo !

> That's a possibility, but it is not clear what should be the signature of the function. What if it fails?


`LONG_MAX` ?

> It is not only that: calling directyl `mpz_get_si` or `PyInt_AS_LONG` is faster than the cast which does call `PyInt_AsLong`. But that's true that I do not like this `try/except`.


Well, if you can turn it into an independent function in some other module (something integer-related) then no problem. This code is much more in need of clarity than nanoseconds at the moment `:-P`

Nathann



---

archive/issue_comments_259677.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-03T15:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259677",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_259678.json:
```json
{
    "body": "<a id='comment:18'></a>Hello,\n\nDo whatever you want with `efd07b7`. The rest of the cleanup is isolated in `6318944`.\n\nVincent",
    "created_at": "2015-05-03T15:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259678",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>Hello,

Do whatever you want with `efd07b7`. The rest of the cleanup is isolated in `6318944`.

Vincent



---

archive/issue_comments_259679.json:
```json
{
    "body": "<a id='comment:19'></a>> Do whatever you want with `efd07b7`. The rest of the cleanup is isolated in `6318944`.\n\n\nIf you do not plan to turn the integer tests into a an independent function, then can you discard it?",
    "created_at": "2015-05-03T15:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259679",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:19'></a>> Do whatever you want with `efd07b7`. The rest of the cleanup is isolated in `6318944`.


If you do not plan to turn the integer tests into a an independent function, then can you discard it?



---

archive/issue_comments_259680.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 ncohen]:\n> > Do whatever you want with `efd07b7`. The rest of the cleanup is isolated in `6318944`.\n\n> \n> If you do not plan to turn the integer tests into a an independent function, then can you discard it?\n\n\nyes",
    "created_at": "2015-05-03T15:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259680",
    "user": "https://github.com/videlec"
}
```

<a id='comment:20'></a>Replying to [comment:19 ncohen]:
> > Do whatever you want with `efd07b7`. The rest of the cleanup is isolated in `6318944`.

> 
> If you do not plan to turn the integer tests into a an independent function, then can you discard it?


yes



---

archive/issue_comments_259681.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-03T15:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259681",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_259682.json:
```json
{
    "body": "<a id='comment:22'></a>I am done with reviewing your commits and they are fine.\n\nSo if `e8df618` is fine for you, then it can go.",
    "created_at": "2015-05-03T15:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259682",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>I am done with reviewing your commits and they are fine.

So if `e8df618` is fine for you, then it can go.



---

archive/issue_comments_259683.json:
```json
{
    "body": "<a id='comment:23'></a>Yoooooooooo !\n\n> I am done with reviewing your commits and they are fine.\n> \n> So if `e8df618` is fine for you, then it can go.\n\n\nOh. Great, thanks !! I was reviewing that commit. I should be done in 10 minutes.\n\nNathann",
    "created_at": "2015-05-03T15:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259683",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:23'></a>Yoooooooooo !

> I am done with reviewing your commits and they are fine.
> 
> So if `e8df618` is fine for you, then it can go.


Oh. Great, thanks !! I was reviewing that commit. I should be done in 10 minutes.

Nathann



---

archive/issue_comments_259684.json:
```json
{
    "body": "<a id='comment:24'></a>If you feel like messing with a new subfolder of src/, I cleaned a couple of things from finance/ in #18355 `;-)`",
    "created_at": "2015-05-03T15:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259684",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:24'></a>If you feel like messing with a new subfolder of src/, I cleaned a couple of things from finance/ in #18355 `;-)`



---

archive/issue_comments_259685.json:
```json
{
    "body": "<a id='comment:25'></a>Okayokay, it's all good. Thank you very much for your help with these painful patches `^^;`\n\nNathann",
    "created_at": "2015-05-03T15:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259685",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:25'></a>Okayokay, it's all good. Thank you very much for your help with these painful patches `^^;`

Nathann



---

archive/issue_comments_259686.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-03T15:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259686",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_259687.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-05-03T20:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259687",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_259688.json:
```json
{
    "body": "<a id='comment:26'></a>\n```\nsage -t --long src/sage/graphs/base/overview.py\n**********************************************************************\nFile \"src/sage/graphs/base/overview.py\", line 50, in sage.graphs.base.overview\nFailed example:\n    Graph()._backend\nExpected:\n    <class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>\nGot:\n    <type 'sage.graphs.base.sparse_graph.SparseGraphBackend'>\n**********************************************************************\n1 item had failures:\n   1 of   2 in sage.graphs.base.overview\n    [1 test, 1 failure, 0.01 s]\n```",
    "created_at": "2015-05-03T20:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259688",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:26'></a>
```
sage -t --long src/sage/graphs/base/overview.py
**********************************************************************
File "src/sage/graphs/base/overview.py", line 50, in sage.graphs.base.overview
Failed example:
    Graph()._backend
Expected:
    <class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>
Got:
    <type 'sage.graphs.base.sparse_graph.SparseGraphBackend'>
**********************************************************************
1 item had failures:
   1 of   2 in sage.graphs.base.overview
    [1 test, 1 failure, 0.01 s]
```



---

archive/issue_comments_259689.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:14 ncohen]:\n> If this kind of cast from !Python/!Sage integer is really costly, perhaps we should have a cdef function that does it somewhere? Do I make a mistake if I say that you wrote this code in order to avoid having to raise an exception in many cases ?\n\n\nThe proper solution to \"convert\" a Python object `u` into a long is\n\n```\ncdef long u_long = PyNumber_Index(u)\n```\nsee\n\n    https://groups.google.com/forum/#!topic/sage-support/0ATjCgQlq4c\n\nVincent",
    "created_at": "2015-05-03T20:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259689",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'></a>Replying to [comment:14 ncohen]:
> If this kind of cast from !Python/!Sage integer is really costly, perhaps we should have a cdef function that does it somewhere? Do I make a mistake if I say that you wrote this code in order to avoid having to raise an exception in many cases ?


The proper solution to "convert" a Python object `u` into a long is

```
cdef long u_long = PyNumber_Index(u)
```
see

    https://groups.google.com/forum/#!topic/sage-support/0ATjCgQlq4c

Vincent



---

archive/issue_comments_259690.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-04T05:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259690",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259691.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-05-04T05:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259691",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_259692.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-04T19:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18346#issuecomment-259692",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_051757.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-04T19:04:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18346",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18346#event-51757"
}
```
