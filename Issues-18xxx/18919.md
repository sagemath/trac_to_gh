# Issue 18919: Interrupt in PARI's pari_malloc() hangs Sage

archive/issues_018682.json:
```json
{
    "body": "This fails quite frequently:\n\n```\nsage: 0.binomial(1) ## line 6262 ##\n0\nsage: 0.binomial(-1) ## line 6264 ##\n0\nsage: 13.binomial(2r) ## line 6266 ##\n78\nsage: alarm(0.5); (2^100).binomial(2^22, algorithm='mpir') ## line 6271 ##\nsage: alarm(0.5); (2^100).binomial(2^22, algorithm='pari') ## line 6275 ##\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long src/sage/rings/integer.pyx  # Timed out (and interrupt failed)\n----------------------------------------------------------------------\n```\nThis is a consequence of a recent PARI upgrade, because `malloc()` is used in a place where it wasn't used before. The cause is exactly the same as #16850.\n\nFor PARI, we should be able to fix this using `PARI_SIGINT_block` which is like `sig_block()` but for the PARI library.\n\nCC:  @jdemeyer\n\nKeywords: random_fail\n\nReviewer: Vincent Delecroix\n\nAuthor: Jeroen Demeyer\n\nBranch: f16032bad4ef8a9feeb2e3321b72b55555a32960\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18919\n\n",
    "closed_at": "2015-08-16T11:08:38Z",
    "created_at": "2015-07-18T09:26:40Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Interrupt in PARI's pari_malloc() hangs Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18919",
    "user": "https://github.com/vbraun"
}
```
This fails quite frequently:

```
sage: 0.binomial(1) ## line 6262 ##
0
sage: 0.binomial(-1) ## line 6264 ##
0
sage: 13.binomial(2r) ## line 6266 ##
78
sage: alarm(0.5); (2^100).binomial(2^22, algorithm='mpir') ## line 6271 ##
sage: alarm(0.5); (2^100).binomial(2^22, algorithm='pari') ## line 6275 ##

**********************************************************************
----------------------------------------------------------------------
sage -t --long src/sage/rings/integer.pyx  # Timed out (and interrupt failed)
----------------------------------------------------------------------
```
This is a consequence of a recent PARI upgrade, because `malloc()` is used in a place where it wasn't used before. The cause is exactly the same as #16850.

For PARI, we should be able to fix this using `PARI_SIGINT_block` which is like `sig_block()` but for the PARI library.

CC:  @jdemeyer

Keywords: random_fail

Reviewer: Vincent Delecroix

Author: Jeroen Demeyer

Branch: f16032bad4ef8a9feeb2e3321b72b55555a32960

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18919





---

archive/issue_comments_270830.json:
```json
{
    "body": "<a id='comment:1'></a>It's the PARI library interface, so #10476 cannot be the cause. My bet would something in PARI itself.",
    "created_at": "2015-07-19T00:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270830",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>It's the PARI library interface, so #10476 cannot be the cause. My bet would something in PARI itself.



---

archive/issue_comments_270831.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -15,7 +15,7 @@\n sage -t --long src/sage/rings/integer.pyx  # Timed out (and interrupt failed)\n ----------------------------------------------------------------------\n ```\n-Possibly consequence of #10476, on the plus side I didn't get the singular failure.\n+Possibly consequence of a recent PARI upgrade, on the plus side I didn't get the singular failure.\n \n http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2064%20bit%29%20incremental/builds/7/steps/shell_4/logs/stdio\n http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu12_32s02%20%28Ubuntu%2012.04%2032%20bit%29%20incremental/builds/19/steps/shell_4/logs/stdio\n```\n",
    "created_at": "2015-07-19T00:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270831",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -15,7 +15,7 @@
 sage -t --long src/sage/rings/integer.pyx  # Timed out (and interrupt failed)
 ----------------------------------------------------------------------
 ```
-Possibly consequence of #10476, on the plus side I didn't get the singular failure.
+Possibly consequence of a recent PARI upgrade, on the plus side I didn't get the singular failure.
 
 http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2064%20bit%29%20incremental/builds/7/steps/shell_4/logs/stdio
 http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu12_32s02%20%28Ubuntu%2012.04%2032%20bit%29%20incremental/builds/19/steps/shell_4/logs/stdio
```




---

archive/issue_comments_270832.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,23 @@\n+This fails quite frequently:\n \n+```\n+sage: 0.binomial(1) ## line 6262 ##\n+0\n+sage: 0.binomial(-1) ## line 6264 ##\n+0\n+sage: 13.binomial(2r) ## line 6266 ##\n+78\n+sage: alarm(0.5); (2^100).binomial(2^22, algorithm='mpir') ## line 6271 ##\n+sage: alarm(0.5); (2^100).binomial(2^22, algorithm='pari') ## line 6275 ##\n+\n+**********************************************************************\n+----------------------------------------------------------------------\n+sage -t --long src/sage/rings/integer.pyx  # Timed out (and interrupt failed)\n+----------------------------------------------------------------------\n+```\n+This is a consequence of a recent PARI upgrade, because `malloc()` is used in a place where it wasn't used before. The cause is exactly the same as #16850.\n+\n+For PARI, we should be able to fix this using `PARI_SIGINT_block` which is like `sig_block()` but for the PARI library.\n \n Comment: 1\n \n```\n",
    "created_at": "2015-07-19T08:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270832",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,23 @@
+This fails quite frequently:
 
+```
+sage: 0.binomial(1) ## line 6262 ##
+0
+sage: 0.binomial(-1) ## line 6264 ##
+0
+sage: 13.binomial(2r) ## line 6266 ##
+78
+sage: alarm(0.5); (2^100).binomial(2^22, algorithm='mpir') ## line 6271 ##
+sage: alarm(0.5); (2^100).binomial(2^22, algorithm='pari') ## line 6275 ##
+
+**********************************************************************
+----------------------------------------------------------------------
+sage -t --long src/sage/rings/integer.pyx  # Timed out (and interrupt failed)
+----------------------------------------------------------------------
+```
+This is a consequence of a recent PARI upgrade, because `malloc()` is used in a place where it wasn't used before. The cause is exactly the same as #16850.
+
+For PARI, we should be able to fix this using `PARI_SIGINT_block` which is like `sig_block()` but for the PARI library.
 
 Comment: 1
 
```




---

archive/issue_comments_270833.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2015-07-20T10:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270833",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_270834.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-20T10:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270834",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_270835.json:
```json
{
    "body": "<a id='comment:7'></a>I am infinitely happy that you found out a solution for this annoying interrupt! Though, I do not like the fact that now the interrupt code depends explicitely on pari. In an ideal world, all this interrupt buisness should go in upstream Cython, don't you think? Do you have an idea whether it would be possible to have something modular for the interrupt code?",
    "created_at": "2015-08-15T17:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270835",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>I am infinitely happy that you found out a solution for this annoying interrupt! Though, I do not like the fact that now the interrupt code depends explicitely on pari. In an ideal world, all this interrupt buisness should go in upstream Cython, don't you think? Do you have an idea whether it would be possible to have something modular for the interrupt code?



---

archive/issue_comments_270836.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-08-15T17:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270836",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_270837.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-08-16T11:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270837",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052788.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-08-16T11:08:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18919#event-52788"
}
```



---

archive/issue_comments_270838.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 vdelecroix]:\n> Though, I do not like the fact that now the interrupt code depends explicitely on pari.\n\n\nI understand your sentiment, but at least it fixes a bug which I don't know how to fix otherwise. You should also understand that I never claimed that cysignals is 100% bullet-proof. We try to fix most use cases but now and then something breaks (see #24986 for example).\n\n> In an ideal world, all this interrupt buisness should go in upstream Cython, don't you think?\n\n\nMoving this to upstream Cython won't magically fix the PARI problem.\n\nBesides, I don't think that there is much reason to push it to Cython now that we have cysignals.",
    "created_at": "2018-04-30T08:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18919",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18919#issuecomment-270838",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:7 vdelecroix]:
> Though, I do not like the fact that now the interrupt code depends explicitely on pari.


I understand your sentiment, but at least it fixes a bug which I don't know how to fix otherwise. You should also understand that I never claimed that cysignals is 100% bullet-proof. We try to fix most use cases but now and then something breaks (see #24986 for example).

> In an ideal world, all this interrupt buisness should go in upstream Cython, don't you think?


Moving this to upstream Cython won't magically fix the PARI problem.

Besides, I don't think that there is much reason to push it to Cython now that we have cysignals.
