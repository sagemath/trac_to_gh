# Issue 18952: heavy performance regression with real/imag(ex)

archive/issues_018715.json:
```json
{
    "body": "This is the first Symbench test. Sage around 4.3 took 0.3s (see http://wiki.sagemath.org/symbench#Problem_R1) but Sage-6.8rc0 needs 10 minutes:\n\n```\nsage: def f(z): return sqrt(1/3)*z^2 + i/3\nsage: real(f(f(f(f(f(f(f(f(f(f(i/2)))))))))))\n```\nwhile\n\n```\nsage: %timeit real(f(f(f(f(f(f(f(f(f(f(i/2)))))))))).expand())\n10 loops, best of 3: 23.5 ms per loop\n```\nA simplified version of this is:\n\n```\nsage: real((((((((((sqrt(3)+I)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2\n```\n\n\nReviewer: Vincent Delecroix\n\nDependencies: #18980\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18952\n\n",
    "closed_at": "2015-09-25T08:22:06Z",
    "created_at": "2015-07-25T15:07:00Z",
    "labels": [
        "component: performance",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "heavy performance regression with real/imag(ex)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18952",
    "user": "https://github.com/rwst"
}
```
This is the first Symbench test. Sage around 4.3 took 0.3s (see http://wiki.sagemath.org/symbench#Problem_R1) but Sage-6.8rc0 needs 10 minutes:

```
sage: def f(z): return sqrt(1/3)*z^2 + i/3
sage: real(f(f(f(f(f(f(f(f(f(f(i/2)))))))))))
```
while

```
sage: %timeit real(f(f(f(f(f(f(f(f(f(f(i/2)))))))))).expand())
10 loops, best of 3: 23.5 ms per loop
```
A simplified version of this is:

```
sage: real((((((((((sqrt(3)+I)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2+1)^2
```


Reviewer: Vincent Delecroix

Dependencies: #18980

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18952





---

archive/issue_comments_335959.json:
```json
{
    "body": "<a id='comment:1'></a>Profiling with callgrind reveals remarkable things, even with only 6 f's. Although Pynac accounts for less than 1 per cent of the time, a whopping 150,000 of numerics are created;  88,000 calls to `ex::is_zero`; 50,000 to `Integer(long)`. The 3,400 calls of `atan2` show that the formula `power(abs(basis),c)*exp(-d*atan2(b,a))*cos(c*atan2(b,a)+d*log(abs(basis)))` is used to compute `real((1/3)^(1/2))` over and over.\n\nThe simplest solution would be to expand before taking the real part in Pynac.\n\nHowever, there is probably more in this use case regarding performance improvement.",
    "created_at": "2015-07-26T07:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335959",
    "user": "https://github.com/rwst"
}
```

<a id='comment:1'></a>Profiling with callgrind reveals remarkable things, even with only 6 f's. Although Pynac accounts for less than 1 per cent of the time, a whopping 150,000 of numerics are created;  88,000 calls to `ex::is_zero`; 50,000 to `Integer(long)`. The 3,400 calls of `atan2` show that the formula `power(abs(basis),c)*exp(-d*atan2(b,a))*cos(c*atan2(b,a)+d*log(abs(basis)))` is used to compute `real((1/3)^(1/2))` over and over.

The simplest solution would be to expand before taking the real part in Pynac.

However, there is probably more in this use case regarding performance improvement.



---

archive/issue_comments_335960.json:
```json
{
    "body": "Changing dependencies from \"\" to \"pynac-0.3.9.3/-0.4.3\"",
    "created_at": "2015-07-26T09:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335960",
    "user": "https://github.com/rwst"
}
```

Changing dependencies from "" to "pynac-0.3.9.3/-0.4.3"



---

archive/issue_comments_335961.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Fixed upstream, in a later stable release.\"",
    "created_at": "2015-07-26T09:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335961",
    "user": "https://github.com/rwst"
}
```

Changing upstream from "N/A" to "Fixed upstream, in a later stable release."



---

archive/issue_comments_335962.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2015-09-13T18:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335962",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_335963.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-13T18:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335963",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_335964.json:
```json
{
    "body": "<a id='comment:4'></a>Ralf,\n\nWith #18980 the problem seems to disappear. Should we close it as a duplicate?\n\nVincent",
    "created_at": "2015-09-13T18:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335964",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>Ralf,

With #18980 the problem seems to disappear. Should we close it as a duplicate?

Vincent



---

archive/issue_comments_335965.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-09-13T18:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335965",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_335966.json:
```json
{
    "body": "Changing upstream from \"Fixed upstream, in a later stable release.\" to \"N/A\"",
    "created_at": "2015-09-14T05:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335966",
    "user": "https://github.com/rwst"
}
```

Changing upstream from "Fixed upstream, in a later stable release." to "N/A"



---

archive/issue_events_052857.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-09-14T05:41:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18952#event-52857"
}
```



---

archive/issue_comments_335967.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-09-14T05:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335967",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_335968.json:
```json
{
    "body": "Changing dependencies from \"pynac-0.3.9.3/-0.4.3\" to \"#18980\"",
    "created_at": "2015-09-14T05:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335968",
    "user": "https://github.com/rwst"
}
```

Changing dependencies from "pynac-0.3.9.3/-0.4.3" to "#18980"



---

archive/issue_comments_335969.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-14T12:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335969",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_052858.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-09-25T08:22:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18952#event-52858"
}
```



---

archive/issue_comments_335970.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-25T08:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18952",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18952#issuecomment-335970",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
