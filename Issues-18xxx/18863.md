# Issue 18863: Subgroup doesn't work with number field unit group

archive/issues_018626.json:
```json
{
    "body": "CC:  @katestange @tscholl2\n\nKeywords: unit group, number field, subgroup, gap\n\nI think we would like the following code to work:\n\n```\nN.<a> = NumberField(x^3+2)\nG = N.unit_group()\ng = G.random_element()\nG.subgroup([g])\n```\n\nBut at the moment the last line produces a runtime error\n\n```\nRuntimeError: Gap produced error output\nError, Variable: 'u1' must have a value\n```\n\nThis is currently reproducible on the single cell sage server and sage cloud.  It does not seem to depend on the number field in question.\n\nAs far as I can tell, subgroup() is unable to recognise the input as elements of the group.  I think the problem is that one cannot pass the argument 'names' when creating the unit group.  For example, the following works:\n\n```\nH = AbelianGroup(5,[2],names=list(\"pqrst\"))\nH.subgroup([H.random_element()])\n```\n\nbut the following fails in exactly the same way as the unit group example\n\n```\nH = AbelianGroup(5,[2])\nH.subgroup([H.random_element()])\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/18863\n\n",
    "closed_at": "2021-05-27T20:30:36Z",
    "created_at": "2015-07-07T22:10:43Z",
    "labels": [
        "component: group theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Subgroup doesn't work with number field unit group",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18863",
    "user": "https://github.com/katestange"
}
```
CC:  @katestange @tscholl2

Keywords: unit group, number field, subgroup, gap

I think we would like the following code to work:

```
N.<a> = NumberField(x^3+2)
G = N.unit_group()
g = G.random_element()
G.subgroup([g])
```

But at the moment the last line produces a runtime error

```
RuntimeError: Gap produced error output
Error, Variable: 'u1' must have a value
```

This is currently reproducible on the single cell sage server and sage cloud.  It does not seem to depend on the number field in question.

As far as I can tell, subgroup() is unable to recognise the input as elements of the group.  I think the problem is that one cannot pass the argument 'names' when creating the unit group.  For example, the following works:

```
H = AbelianGroup(5,[2],names=list("pqrst"))
H.subgroup([H.random_element()])
```

but the following fails in exactly the same way as the unit group example

```
H = AbelianGroup(5,[2])
H.subgroup([H.random_element()])
```

Issue created by migration from https://trac.sagemath.org/ticket/18863





---

archive/issue_comments_253338.json:
```json
{
    "body": "I asked for a workaround here, and there is some more information from other users there:  [http://ask.sagemath.org/question/27274/subgroup-of-number-field-unit-group/](http://ask.sagemath.org/question/27274/subgroup-of-number-field-unit-group/)",
    "created_at": "2015-07-08T14:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253338",
    "user": "https://github.com/katestange"
}
```

I asked for a workaround here, and there is some more information from other users there:  [http://ask.sagemath.org/question/27274/subgroup-of-number-field-unit-group/](http://ask.sagemath.org/question/27274/subgroup-of-number-field-unit-group/)



---

archive/issue_comments_253339.json:
```json
{
    "body": "Changing keywords from \"unit group, number field, subgroup\" to \"unit group, number field, subgroup, gap\".",
    "created_at": "2015-07-08T14:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253339",
    "user": "https://github.com/katestange"
}
```

Changing keywords from "unit group, number field, subgroup" to "unit group, number field, subgroup, gap".



---

archive/issue_comments_253340.json:
```json
{
    "body": "I note that the same problem arises with class groups, which are also built using `AbelianGroupWithValues`.  However in the following case, it *is* possible to obtain a subgroup of a group with values:\n\n```\nsage: U = Zmod(30).unit_group()\nsage: type(U)\n<class 'sage.groups.abelian_gps.values.AbelianGroupWithValues_class_with_category'>\nsage: U.subgroup([U.random_element()])\nMultiplicative Abelian subgroup isomorphic to C2 generated by {f0*f1^2}\n```\nI have tried, but failed, to see why the other cases lead to `gap` errors.",
    "created_at": "2015-07-09T10:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253340",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

I note that the same problem arises with class groups, which are also built using `AbelianGroupWithValues`.  However in the following case, it *is* possible to obtain a subgroup of a group with values:

```
sage: U = Zmod(30).unit_group()
sage: type(U)
<class 'sage.groups.abelian_gps.values.AbelianGroupWithValues_class_with_category'>
sage: U.subgroup([U.random_element()])
Multiplicative Abelian subgroup isomorphic to C2 generated by {f0*f1^2}
```
I have tried, but failed, to see why the other cases lead to `gap` errors.



---

archive/issue_comments_253341.json:
```json
{
    "body": "I believe this is another small example, and it raises an exception in at least Sage 9.0.\n\n```python\nG = AbelianGroup([4,0])\nG.subgroup(G.gens())\n```\n\nI printed out the gap commands which this runs in the `gap.eval(...)` lines:\n\n```\nG:= AbelianGroup([4]); gens := GeneratorsOfGroup(G)\nf0 := gens[1]\ngensH:=[f0, f1]\n```\n\nIt seemed clear that the issue was likely the order check here:\n\nhttps://github.com/sagemath/sage/blob/860e4dc9881966a36ef8808a0d1fae0c6b54f741/src/sage/groups/abelian_gps/abelian_group.py#L1549\n\nChanging those lines to the following seem to fix it:\n\n```python\nHgens0 = [x for x in Hgens if any(y in str(x) for y in Ggens0)]\nHgensf = [x for x in Hgens if not(x in Hgens0)]\n```\n\nThis seemed to also make the code in the original post work, i.e.:\n\n```python\nH = AbelianGroup(5,[2])\nH.subgroup([H.random_element()])\n```\n\nI have not tested this rigorously yet, and I have no idea if this is the \"proper\" way to test whether a generator has infinite order. I am also unsure if that is the thing which is being tested here.",
    "created_at": "2020-06-05T02:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253341",
    "user": "https://github.com/tscholl2"
}
```

I believe this is another small example, and it raises an exception in at least Sage 9.0.

```python
G = AbelianGroup([4,0])
G.subgroup(G.gens())
```

I printed out the gap commands which this runs in the `gap.eval(...)` lines:

```
G:= AbelianGroup([4]); gens := GeneratorsOfGroup(G)
f0 := gens[1]
gensH:=[f0, f1]
```

It seemed clear that the issue was likely the order check here:

https://github.com/sagemath/sage/blob/860e4dc9881966a36ef8808a0d1fae0c6b54f741/src/sage/groups/abelian_gps/abelian_group.py#L1549

Changing those lines to the following seem to fix it:

```python
Hgens0 = [x for x in Hgens if any(y in str(x) for y in Ggens0)]
Hgensf = [x for x in Hgens if not(x in Hgens0)]
```

This seemed to also make the code in the original post work, i.e.:

```python
H = AbelianGroup(5,[2])
H.subgroup([H.random_element()])
```

I have not tested this rigorously yet, and I have no idea if this is the "proper" way to test whether a generator has infinite order. I am also unsure if that is the thing which is being tested here.



---

archive/issue_comments_253342.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-12T14:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253342",
    "user": "https://github.com/tscholl2"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_253343.json:
```json
{
    "body": "I modified the lines I mentioned in my previous comment, however I tried to avoid using string representations and instead looked at the order of each generator appearing in each element given as a generator for the subgroup.\n\nIt passed all tests for me when running `./sage -t src/sage/groups/*` and `./sage -t --long src/sage/groups/abelian_gps/*`.",
    "created_at": "2020-06-12T14:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253343",
    "user": "https://github.com/tscholl2"
}
```

I modified the lines I mentioned in my previous comment, however I tried to avoid using string representations and instead looked at the order of each generator appearing in each element given as a generator for the subgroup.

It passed all tests for me when running `./sage -t src/sage/groups/*` and `./sage -t --long src/sage/groups/abelian_gps/*`.



---

archive/issue_events_052712.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-08-15T13:17:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18863#event-52712"
}
```



---

archive/issue_events_052713.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18863#event-52713"
}
```



---

archive/issue_events_052714.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18863#event-52714"
}
```



---

archive/issue_events_052715.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18863#event-52715"
}
```



---

archive/issue_events_052716.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18863#event-52716"
}
```



---

archive/issue_comments_253344.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253344",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_253345.json:
```json
{
    "body": "I deleted a couple lines to make pyflakes happy; set to positive review once tests pass.\n\n---\nNew commits:",
    "created_at": "2021-04-28T07:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253345",
    "user": "https://github.com/roed314"
}
```

I deleted a couple lines to make pyflakes happy; set to positive review once tests pass.

---
New commits:



---

archive/issue_comments_253346.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-28T21:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253346",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253347.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18863#issuecomment-253347",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052717.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:30:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18863",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18863#event-52717"
}
```
