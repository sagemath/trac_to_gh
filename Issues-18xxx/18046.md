# Issue 18046: Graphs with multiedges and latex

archive/issues_017809.json:
```json
{
    "body": "It was discovered that the LaTeX module for graphs raises the NotImplementedError for graphs containing multiple edges (`multiedges=True`). The intention of this ticket is to incorporate the fixes needed to typeset a graph with latex.\n\nCC:  @nathanncohen @nthiery @tscrim @anneschilling\n\nKeywords: graph-theory, multiedges, latex, sd66\n\nAuthor: Jacob Laas\n\nBranch: u/jclaas/graphs_with_multiedges_and_latex\n\nStatus: needs_work\n\nCommit: d2ebe228caee2da94ecee214bf7a8f52004228be\n\nIssue created by migration from https://trac.sagemath.org/ticket/18046\n\n",
    "created_at": "2015-03-24T15:43:30Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Graphs with multiedges and latex",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18046",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```
It was discovered that the LaTeX module for graphs raises the NotImplementedError for graphs containing multiple edges (`multiedges=True`). The intention of this ticket is to incorporate the fixes needed to typeset a graph with latex.

CC:  @nathanncohen @nthiery @tscrim @anneschilling

Keywords: graph-theory, multiedges, latex, sd66

Author: Jacob Laas

Branch: u/jclaas/graphs_with_multiedges_and_latex

Status: needs_work

Commit: d2ebe228caee2da94ecee214bf7a8f52004228be

Issue created by migration from https://trac.sagemath.org/ticket/18046





---

archive/issue_comments_238406.json:
```json
{
    "body": "Changing keywords from \"\" to \"graph-theory, multiedges, latex\".",
    "created_at": "2015-03-24T16:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238406",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

Changing keywords from "" to "graph-theory, multiedges, latex".



---

archive/issue_comments_238407.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2015-03-24T16:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238407",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_238408.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2015-03-24T16:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238408",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_238409.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2015-03-24T16:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238409",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_238410.json:
```json
{
    "body": "<a id='comment:2'></a>I should note that I've already incorporated most of the necessary fixes into a local copy of `sage/graphs/graph_latex.py` and will soon post here a patch for the file, so that I can get some feedback..",
    "created_at": "2015-03-24T16:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238410",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

<a id='comment:2'></a>I should note that I've already incorporated most of the necessary fixes into a local copy of `sage/graphs/graph_latex.py` and will soon post here a patch for the file, so that I can get some feedback..



---

archive/issue_comments_238411.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-25T10:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238411",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_238412.json:
```json
{
    "body": "<a id='comment:4'></a>I've just pushed a commit containing updated code so that graphs with multiedges can be tex-ified, but there's a particular case that still causes issue: when a set of multiedges contain labels, their customizations do not match up correctly.\n\nMy first guess was that this due to the nature of using a dict_of_dicts to track all edge/vertex properties, which python then gets the order of hashable items mixed up.\n\nSee below for a test case illustrating the issue:\n\n```\nmygraph = DiGraph(multiedges=True)\nmygraph.add_edge('A','B','thinnest')\nmygraph.add_edge('A','B','blah')\nmygraph.add_edge('A','B','thickest')\nmygraph.add_edge('A','C','blah')\nmygraph.add_edge('B','C','blah')\nmygraph.add_edge('C','B','blah')\nmygraph.set_latex_options(\n    units='in',\n    graphic_size=(6,6),\n    edge_thickness=0.01,\n    edge_labels=True,\n    edge_thicknesses={('A','B'):[0.01,0.025,0.05]},\n    )\nprint latex(mygraph)\nview(latex(mygraph))\n```\n\nI've specified a list of thicknesses for the multiedges 'A' -> 'B'. Their labels were defined in a particular order, and the thicknesses are meant to match this order, but they don't.. any ideas?",
    "created_at": "2015-03-25T10:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238412",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

<a id='comment:4'></a>I've just pushed a commit containing updated code so that graphs with multiedges can be tex-ified, but there's a particular case that still causes issue: when a set of multiedges contain labels, their customizations do not match up correctly.

My first guess was that this due to the nature of using a dict_of_dicts to track all edge/vertex properties, which python then gets the order of hashable items mixed up.

See below for a test case illustrating the issue:

```
mygraph = DiGraph(multiedges=True)
mygraph.add_edge('A','B','thinnest')
mygraph.add_edge('A','B','blah')
mygraph.add_edge('A','B','thickest')
mygraph.add_edge('A','C','blah')
mygraph.add_edge('B','C','blah')
mygraph.add_edge('C','B','blah')
mygraph.set_latex_options(
    units='in',
    graphic_size=(6,6),
    edge_thickness=0.01,
    edge_labels=True,
    edge_thicknesses={('A','B'):[0.01,0.025,0.05]},
    )
print latex(mygraph)
view(latex(mygraph))
```

I've specified a list of thicknesses for the multiedges 'A' -> 'B'. Their labels were defined in a particular order, and the thicknesses are meant to match this order, but they don't.. any ideas?



---

archive/issue_comments_238413.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-03-25T10:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238413",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_238414.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-25T10:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238414",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_238415.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-30T21:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238415",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_238416.json:
```json
{
    "body": "Changing keywords from \"graph-theory, multiedges, latex\" to \"graph-theory, multiedges, latex, sd66\".",
    "created_at": "2015-03-30T21:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238416",
    "user": "https://github.com/nathanncohen"
}
```

Changing keywords from "graph-theory, multiedges, latex" to "graph-theory, multiedges, latex, sd66".



---

archive/issue_comments_238417.json:
```json
{
    "body": "<a id='comment:7'></a>Hello,\n\nSeveral other remarks:\n\n- These days I have been told that we should use `isinstance(x,list)` instead of\n  `type(x) in [list]`. Note that the following works:\n\n    sage: isinstance([],(list,dict))\n    True\n    sage: isinstance({},(list,dict))\n    True\n    sage: isinstance(5,(list,dict))\n    True\n\n- Now, this file looks rather messy and you apparently tried to get your code to\n  'fit in the local style'. It seems that they define a variable named\n  `number_types` that you could use.\n\n- `et` -> no short name please.\n\n- This line contains both `and` and `or`. Could you add parentheses where they belong ?\n\n  `if self._graph.is_directed() or self._graph.allows_multiple_edges() and not loop:`\n\n- Could you write the proper documentation (in the INPUT section of the docstring) for the parameter `edge_thickness` in\n  case of multiple edges?\n\n- Your error message is misleading: it is not that multiple customization of\n  multiedges is impossible, it is that only `thickness` can be set. At least,\n  this is what your condition tests.\n\n- What is the difference between `->` and `post` in TikZ? Why did you make that\n  change?\n\n- Is there any reason why you call `self._graph.edge_label(edge[0],edge[1])`?\n  That value should already be equal to `e[2]`, shouldn't it?\n\nNathann",
    "created_at": "2015-03-30T21:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238417",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>Hello,

Several other remarks:

- These days I have been told that we should use `isinstance(x,list)` instead of
  `type(x) in [list]`. Note that the following works:

    sage: isinstance([],(list,dict))
    True
    sage: isinstance({},(list,dict))
    True
    sage: isinstance(5,(list,dict))
    True

- Now, this file looks rather messy and you apparently tried to get your code to
  'fit in the local style'. It seems that they define a variable named
  `number_types` that you could use.

- `et` -> no short name please.

- This line contains both `and` and `or`. Could you add parentheses where they belong ?

  `if self._graph.is_directed() or self._graph.allows_multiple_edges() and not loop:`

- Could you write the proper documentation (in the INPUT section of the docstring) for the parameter `edge_thickness` in
  case of multiple edges?

- Your error message is misleading: it is not that multiple customization of
  multiedges is impossible, it is that only `thickness` can be set. At least,
  this is what your condition tests.

- What is the difference between `->` and `post` in TikZ? Why did you make that
  change?

- Is there any reason why you call `self._graph.edge_label(edge[0],edge[1])`?
  That value should already be equal to `e[2]`, shouldn't it?

Nathann



---

archive/issue_comments_238418.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks for your feedback. Sorry for missing some of the style rules, but some of the issues you raise are actually left over from previous work. Regardless, I've tried to fix them the best I can.\n\nAlso, I'm happy to report that I've gotten custom `edge_thicknesses` to work. It turned out that I just had to reverse the value of multiedge_index. I didn't dive too deep to find out why, as there's something like 27k lines of code I might have to search through.\n\n> - These days I have been told that we should use `isinstance(x,list)` instead of `type(x)` in [list].\n\n\nFixed.\n\n> - Now, this file looks rather messy and you apparently tried to get your code to 'fit in the local style'. It seems that they define a variable named `number_types` that you could use.\n\n\nFixed.\n\n> - `et` -> no short name please.\n\n\nFixed.\n\n> - This line contains both `and` and `or`. Could you add parentheses where they belong ?\n\n\nFixed.\n\n> - Could you write the proper documentation (in the INPUT section of the docstring) for the parameter `edge_thickness` in case of multiple edges?\n\n\nFixed.\n\n> - Your error message is misleading: it is not that multiple customization of multiedges is impossible, it is that only `thickness` can be set. At least, this is what your condition tests.\n\n\nI've edited the message to read \"Edge-specific colors are not available for multiedges.\", so that it only refers to the case of edge_colors, which I wasn't up to the task of fixing immediately. The color issue seems like a lot of work, because each vertex/edge color is specified via unique `\\definecolor{}{rgb}{`} latex definitions, instead of just passing colors as strings. From what I can tell from the documentation (though I don't understand French), tkz-graph understands colors as strings, so it seems like the entire set of `\\definecolor{}{rgb}{`} definitions are unnecessary. Perhaps one should open a ticket just for updating this feature? I could see an update to this being more useful for my own purposes, but it also just seems better to just have colors specified within each edge's tex-string.\n\n> - What is the difference between `->` and `post` in TikZ? Why did you make that change?\n\n\nI don't know what `post` is, but I replaced it with `->` because `post` doesn't respect line widths and it's not in the most recent documentation (https://www.ctan.org/pkg/tkz-graph).\n\n> - Is there any reason why you call `self._graph.edge_label(edge[0],edge[1])`? That value should already be equal to `e[2]`, shouldn't it?\n\n\nHmm that wasn't my doing, but I did find out that attempting to refer to `e[2]` absolutely doesn't maintain the order in which the edge labels are called, which I find very bizarre. Leaving it as-is will at least ensure that my fix for `edge_thicknesses` works properly.",
    "created_at": "2015-03-31T14:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238418",
    "user": "https://trac.sagemath.org/admin/accounts/users/jclaas"
}
```

<a id='comment:8'></a>Thanks for your feedback. Sorry for missing some of the style rules, but some of the issues you raise are actually left over from previous work. Regardless, I've tried to fix them the best I can.

Also, I'm happy to report that I've gotten custom `edge_thicknesses` to work. It turned out that I just had to reverse the value of multiedge_index. I didn't dive too deep to find out why, as there's something like 27k lines of code I might have to search through.

> - These days I have been told that we should use `isinstance(x,list)` instead of `type(x)` in [list].


Fixed.

> - Now, this file looks rather messy and you apparently tried to get your code to 'fit in the local style'. It seems that they define a variable named `number_types` that you could use.


Fixed.

> - `et` -> no short name please.


Fixed.

> - This line contains both `and` and `or`. Could you add parentheses where they belong ?


Fixed.

> - Could you write the proper documentation (in the INPUT section of the docstring) for the parameter `edge_thickness` in case of multiple edges?


Fixed.

> - Your error message is misleading: it is not that multiple customization of multiedges is impossible, it is that only `thickness` can be set. At least, this is what your condition tests.


I've edited the message to read "Edge-specific colors are not available for multiedges.", so that it only refers to the case of edge_colors, which I wasn't up to the task of fixing immediately. The color issue seems like a lot of work, because each vertex/edge color is specified via unique `\definecolor{}{rgb}{`} latex definitions, instead of just passing colors as strings. From what I can tell from the documentation (though I don't understand French), tkz-graph understands colors as strings, so it seems like the entire set of `\definecolor{}{rgb}{`} definitions are unnecessary. Perhaps one should open a ticket just for updating this feature? I could see an update to this being more useful for my own purposes, but it also just seems better to just have colors specified within each edge's tex-string.

> - What is the difference between `->` and `post` in TikZ? Why did you make that change?


I don't know what `post` is, but I replaced it with `->` because `post` doesn't respect line widths and it's not in the most recent documentation (https://www.ctan.org/pkg/tkz-graph).

> - Is there any reason why you call `self._graph.edge_label(edge[0],edge[1])`? That value should already be equal to `e[2]`, shouldn't it?


Hmm that wasn't my doing, but I did find out that attempting to refer to `e[2]` absolutely doesn't maintain the order in which the edge labels are called, which I find very bizarre. Leaving it as-is will at least ensure that my fix for `edge_thicknesses` works properly.



---

archive/issue_comments_238419.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-31T15:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238419",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_238420.json:
```json
{
    "body": "<a id='comment:10'></a>Helloooooooooooo,\n\nSeveral coments:\n\n- Could you add to the doctests an example of a graph plot which uses the new\n  feature you impplemented?\n\n- `if isinstance(x, list) and (not isinstance(x[0], number_types) or not x[0] >= 0.0):`\n\n  This code only tests if the *first* element of the list is a positive. You\n  should probably replace\n  `x[0] >= 0.0`\n  with\n  `all(xx>=0 for xx in x)`\n\n- The previous test appears so often that it would be better to define a\n  `is_positive_number=lambda x:isinstance(x, number_types) and x >= 0.0` and\n  use it everywhere.\n\n- In this block of code\n  {{{\n  reverse_index = len(edge_thickness) - (multiedge_index+1)\n  edge_thickness = edge_thickness[reverse_index]\n  }}}\n  You should probably use the following Python trick\n  {{{\n  sage: a=[1,2,3,4,5,6]\n  sage: a[-1]\n  6\n  sage: a[-4]\n  3\n  sage: a[-5]\n  2\n  sage: a[-6]\n  1\n  }}}\n\nShort of this the code looks good. Thanks,\n\nNathann",
    "created_at": "2015-04-05T16:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18046",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18046#issuecomment-238420",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>Helloooooooooooo,

Several coments:

- Could you add to the doctests an example of a graph plot which uses the new
  feature you impplemented?

- `if isinstance(x, list) and (not isinstance(x[0], number_types) or not x[0] >= 0.0):`

  This code only tests if the *first* element of the list is a positive. You
  should probably replace
  `x[0] >= 0.0`
  with
  `all(xx>=0 for xx in x)`

- The previous test appears so often that it would be better to define a
  `is_positive_number=lambda x:isinstance(x, number_types) and x >= 0.0` and
  use it everywhere.

- In this block of code
  {{{
  reverse_index = len(edge_thickness) - (multiedge_index+1)
  edge_thickness = edge_thickness[reverse_index]
  }}}
  You should probably use the following Python trick
  {{{
  sage: a=[1,2,3,4,5,6]
  sage: a[-1]
  6
  sage: a[-4]
  3
  sage: a[-5]
  2
  sage: a[-6]
  1
  }}}

Short of this the code looks good. Thanks,

Nathann
