# Issue 18860: Faster Poyhedron.graph()

archive/issues_018623.json:
```json
{
    "body": "With this branch, `polytopes.Gosset_3_21().graph()` takes 300ms, against 16s before.\n\nThe 'definition' used to compute adjacent vertices can be found in [comment:10]\n\nAnd of course the following works:\n\n```\nsage: g=graphs.GossetGraph()\nsage: g.is_isomorphic(polytopes.Gosset_3_21().graph())\nTrue\n```\n\nCC:  @videlec @dimpase @vbraun @novoselt\n\nBranch/Commit: 5223cda9f15b2a417b550039b978a07e126f9053\n\nReviewer: Dima Pasechnik\n\nAuthor: Nathann Cohen\n\nDependencies: #18779\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18860\n\n",
    "closed_at": "2015-08-01T23:07:52Z",
    "created_at": "2015-07-07T16:35:48Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Faster Poyhedron.graph()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18860",
    "user": "https://github.com/nathanncohen"
}
```
With this branch, `polytopes.Gosset_3_21().graph()` takes 300ms, against 16s before.

The 'definition' used to compute adjacent vertices can be found in [comment:10]

And of course the following works:

```
sage: g=graphs.GossetGraph()
sage: g.is_isomorphic(polytopes.Gosset_3_21().graph())
True
```

CC:  @videlec @dimpase @vbraun @novoselt

Branch/Commit: 5223cda9f15b2a417b550039b978a07e126f9053

Reviewer: Dima Pasechnik

Author: Nathann Cohen

Dependencies: #18779

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18860





---

archive/issue_comments_269886.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-07T16:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269886",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269887.json:
```json
{
    "body": "<a id='comment:4'></a>\n```\n+        # Why 26 ?? I was expecting 'd-1'. Are there some useless inequalities\n+        # in the list?\n```\nwell, you have 26 facets on each edge - none are more useless than the others. You can do the\nfollowing (note that 0th and 1st vertices are adjacent).\n\n```\nsage: p=polytopes.Gosset_3_21()\nsage: M=p.incidence_matrix()\nsage: a=0; b=1;\nsage: vv=[i for i in [0..702] if M[a,i]*M[b,i]>0]\nsage: matrix([p.inequalities()[j].vector() for j in vv]).T.kernel()\nFree module of degree 9 and rank 1 over Integer Ring\nEchelon basis matrix:\n[0 1 0 0 0 0 0 0 0]\n```\nor just \n\n```\nsage: m=matrix([p.inequalities()[j].vector() for j in vv])\nsage: m.rank()\n8\n```\nwhich makes sense, as `m` is of size 27x9.  (27, as there is not full-dimensional).\n\nGeneral code for adjacency of two vertices `a` and `b` of a polytope in `d`-dimensional space\nshould check that `m` has corank `1`.\n\n(There could be special cases when one of the vertices is the origin, or some inequalities are homogeneous).",
    "created_at": "2015-07-07T18:03:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269887",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
```
+        # Why 26 ?? I was expecting 'd-1'. Are there some useless inequalities
+        # in the list?
```
well, you have 26 facets on each edge - none are more useless than the others. You can do the
following (note that 0th and 1st vertices are adjacent).

```
sage: p=polytopes.Gosset_3_21()
sage: M=p.incidence_matrix()
sage: a=0; b=1;
sage: vv=[i for i in [0..702] if M[a,i]*M[b,i]>0]
sage: matrix([p.inequalities()[j].vector() for j in vv]).T.kernel()
Free module of degree 9 and rank 1 over Integer Ring
Echelon basis matrix:
[0 1 0 0 0 0 0 0 0]
```
or just 

```
sage: m=matrix([p.inequalities()[j].vector() for j in vv])
sage: m.rank()
8
```
which makes sense, as `m` is of size 27x9.  (27, as there is not full-dimensional).

General code for adjacency of two vertices `a` and `b` of a polytope in `d`-dimensional space
should check that `m` has corank `1`.

(There could be special cases when one of the vertices is the origin, or some inequalities are homogeneous).



---

archive/issue_comments_269888.json:
```json
{
    "body": "<a id='comment:5'></a>> General code for adjacency of two vertices `a` and `b` of a polytope in `d`-dimensional space\n> should check that `m` has corank `1`.\n\n\nWould you know how to adapt this code for that? Hoping that it will remain faster than what we currently have?\n\nNathann",
    "created_at": "2015-07-07T19:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269888",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>> General code for adjacency of two vertices `a` and `b` of a polytope in `d`-dimensional space
> should check that `m` has corank `1`.


Would you know how to adapt this code for that? Hoping that it will remain faster than what we currently have?

Nathann



---

archive/issue_comments_269889.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 ncohen]:\n> > General code for adjacency of two vertices `a` and `b` of a polytope in `d`-dimensional space\n> > should check that `m` has corank `1`.\n\n> \n> Would you know how to adapt this code for that? Hoping that it will remain faster than what we currently have?\n\n\nMy understanding is that hacking `hasse_diagram.py` to stop earlier is what one actually needs to do.\nExcept that it goes from bottom to top, which probably means that one gets adjacency of facets as the first step. But it should be possible to change it that goes the other way around.\nWe can write a paper about it ;-).",
    "created_at": "2015-07-08T09:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269889",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>Replying to [comment:5 ncohen]:
> > General code for adjacency of two vertices `a` and `b` of a polytope in `d`-dimensional space
> > should check that `m` has corank `1`.

> 
> Would you know how to adapt this code for that? Hoping that it will remain faster than what we currently have?


My understanding is that hacking `hasse_diagram.py` to stop earlier is what one actually needs to do.
Except that it goes from bottom to top, which probably means that one gets adjacency of facets as the first step. But it should be possible to change it that goes the other way around.
We can write a paper about it ;-).



---

archive/issue_comments_269890.json:
```json
{
    "body": "<a id='comment:7'></a>> My understanding is that hacking `hasse_diagram.py` to stop earlier is what one actually needs to do.\n\n\nI do not know how to do that. If you know how to fix this implementation, at least it will be done. Otherwise chances are that nothing will happen.\n\nNathann",
    "created_at": "2015-07-08T11:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269890",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>> My understanding is that hacking `hasse_diagram.py` to stop earlier is what one actually needs to do.


I do not know how to do that. If you know how to fix this implementation, at least it will be done. Otherwise chances are that nothing will happen.

Nathann



---

archive/issue_comments_269891.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 ncohen]:\n> > My understanding is that hacking `hasse_diagram.py` to stop earlier is what one actually needs to do.\n\n> \n> I do not know how to do that. If you know how to fix this implementation, at least it will be done. Otherwise chances are that nothing will happen\n\n\nthe whole Polyhedron code does a potentially very slow thing: enumerating the inequalities at construction time, instead of doing it optionally or/and lazily.\n\nIndeed, e.g. the problem at hand, deciding if two vertices are adjacent, does not need pre-computed inequalities. Namely, checking that v_1 and v_2 are adjacent can be done by solving the following LP:\n\n```\n    variables: x_0..x_d,x_{d+1}\n    objective: max x_0\n    constraints: \n         -1 <= x_i <=1 for i in [1..d]; \n          x_{d+1} >= 0;\n          sum_{j=1}^d v_{i,j}*x_j = x_{d+1},         for i=1,2;\n          sum_{j=1}^d v_{i,j}*x_j >= x_{d+1} + x_0,  for i>2;\n```\nif the optimum exists and is strictly positive, they form an edge, and otherwise they don't.\n\nSo we are trying to find an inequality that is valid for the convex hull of v_k's and turns\ninto an equation on v_1 and v_2, but is a strict inequality on the rest of v_k's.\n\n(The LP above will not work if there are more v_j's on the line joining v_1 and v_2 --- but this case can be taken care of trivially.)",
    "created_at": "2015-07-08T14:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269891",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Replying to [comment:7 ncohen]:
> > My understanding is that hacking `hasse_diagram.py` to stop earlier is what one actually needs to do.

> 
> I do not know how to do that. If you know how to fix this implementation, at least it will be done. Otherwise chances are that nothing will happen


the whole Polyhedron code does a potentially very slow thing: enumerating the inequalities at construction time, instead of doing it optionally or/and lazily.

Indeed, e.g. the problem at hand, deciding if two vertices are adjacent, does not need pre-computed inequalities. Namely, checking that v_1 and v_2 are adjacent can be done by solving the following LP:

```
    variables: x_0..x_d,x_{d+1}
    objective: max x_0
    constraints: 
         -1 <= x_i <=1 for i in [1..d]; 
          x_{d+1} >= 0;
          sum_{j=1}^d v_{i,j}*x_j = x_{d+1},         for i=1,2;
          sum_{j=1}^d v_{i,j}*x_j >= x_{d+1} + x_0,  for i>2;
```
if the optimum exists and is strictly positive, they form an edge, and otherwise they don't.

So we are trying to find an inequality that is valid for the convex hull of v_k's and turns
into an equation on v_1 and v_2, but is a strict inequality on the rest of v_k's.

(The LP above will not work if there are more v_j's on the line joining v_1 and v_2 --- but this case can be taken care of trivially.)



---

archive/issue_comments_269892.json:
```json
{
    "body": "<a id='comment:9'></a>Oh. That's a nice formulation of the problem, thanks. I will not forget it.\n\nWould you know a combinatorial way to compute it? It seems that we can already rely on cddlib (see #18861) in order to build the graph over RDF.\n\nNathann",
    "created_at": "2015-07-08T14:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269892",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:9'></a>Oh. That's a nice formulation of the problem, thanks. I will not forget it.

Would you know a combinatorial way to compute it? It seems that we can already rely on cddlib (see #18861) in order to build the graph over RDF.

Nathann



---

archive/issue_comments_269893.json:
```json
{
    "body": "<a id='comment:10'></a>Here is a new 'combinatorial' version. It uses an 'idea', which I am not sure is a proper definition of the object, but well... You tell me `:-P`\n\n1) For every inequality `I`, build the set `set(I)` of points for which it is an equality\n2) For any pair of points `i,j`, list all inequalities `I_1, ..., I_k` that contain them both\n3) Intersection `set(I_1), ..., set(I_k)`. If this intersection has cardinality 2, then ij is an edge.\n\nWorks for Gosset (at least) `:-P`\n\nNathann",
    "created_at": "2015-07-08T16:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269893",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>Here is a new 'combinatorial' version. It uses an 'idea', which I am not sure is a proper definition of the object, but well... You tell me `:-P`

1) For every inequality `I`, build the set `set(I)` of points for which it is an equality
2) For any pair of points `i,j`, list all inequalities `I_1, ..., I_k` that contain them both
3) Intersection `set(I_1), ..., set(I_k)`. If this intersection has cardinality 2, then ij is an edge.

Works for Gosset (at least) `:-P`

Nathann



---

archive/issue_comments_269894.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-07-08T16:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269894",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_269895.json:
```json
{
    "body": "<a id='comment:12'></a>A bit cleaner: I moved the code to the `.graph()`, method for apparently the `_vertex_adjacency_matrix` is not what it claims to be. Its dimension may not even be the number of vertices (if you have rays n your polyhedron) [1].\n\nWith this, all tests pass in the `geometry` folder.\n\nNathann\n\n[1] You can see what goes wrong by adding `return self.graph().adjacency_matrix()` in the first line of `_vertex_adjacency_matrix`.",
    "created_at": "2015-07-08T16:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269895",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:12'></a>A bit cleaner: I moved the code to the `.graph()`, method for apparently the `_vertex_adjacency_matrix` is not what it claims to be. Its dimension may not even be the number of vertices (if you have rays n your polyhedron) [1].

With this, all tests pass in the `geometry` folder.

Nathann

[1] You can see what goes wrong by adding `return self.graph().adjacency_matrix()` in the first line of `_vertex_adjacency_matrix`.



---

archive/issue_comments_269896.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n-With this branch, `polytopes.Gosset_3_21().graph()` takes 200ms, against 16s before.\n+With this branch, `polytopes.Gosset_3_21().graph()` takes 300ms, against 16s before.\n \n-There is however, a mystery in the code: I hard-coded a constant '26' which I expected to be equal to 'd-1'. If we can solve this mistery, we get a speedup.\n+The 'definition' used to compute adjacent vertices can be found in [comment:10]\n \n-This 26 has been picked so that the following works:\n+And of course the following works:\n \n ```\n sage: g=graphs.GossetGraph()\n```\n",
    "created_at": "2015-07-08T16:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269896",
    "user": "https://github.com/nathanncohen"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,8 +1,8 @@
-With this branch, `polytopes.Gosset_3_21().graph()` takes 200ms, against 16s before.
+With this branch, `polytopes.Gosset_3_21().graph()` takes 300ms, against 16s before.
 
-There is however, a mystery in the code: I hard-coded a constant '26' which I expected to be equal to 'd-1'. If we can solve this mistery, we get a speedup.
+The 'definition' used to compute adjacent vertices can be found in [comment:10]
 
-This 26 has been picked so that the following works:
+And of course the following works:
 
 ```
 sage: g=graphs.GossetGraph()
```




---

archive/issue_comments_269897.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-08T16:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269897",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_269898.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-07-08T16:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269898",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_269899.json:
```json
{
    "body": "<a id='comment:15'></a>The adjacency matrix for unbound polyhedra is essentially the projectvization; See also the adjacency matrix docs for a more down-to-earth definition.",
    "created_at": "2015-07-08T19:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269899",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>The adjacency matrix for unbound polyhedra is essentially the projectvization; See also the adjacency matrix docs for a more down-to-earth definition.



---

archive/issue_comments_269900.json:
```json
{
    "body": "<a id='comment:16'></a>> The adjacency matrix for unbound polyhedra is essentially the projectvization; See also the adjacency matrix docs for a more down-to-earth definition.\n\n\nI was not talking about the `.adjacency_matrix` method. I was talking about `._vertex_adjacency_matrix`, which should (from its name) have as many rows/cols as there are vertices.\n\nNathann",
    "created_at": "2015-07-08T20:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269900",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>> The adjacency matrix for unbound polyhedra is essentially the projectvization; See also the adjacency matrix docs for a more down-to-earth definition.


I was not talking about the `.adjacency_matrix` method. I was talking about `._vertex_adjacency_matrix`, which should (from its name) have as many rows/cols as there are vertices.

Nathann



---

archive/issue_comments_269901.json:
```json
{
    "body": "<a id='comment:17'></a>Again its really the V-representation adjacency matrix; The non-compact case is just the projectivization. So in a sense its really the vertex adjacency matrix; I know its somewhat confusing but most people are interested in the compact case so being overly nitpicky about wording is going to be confusing too.",
    "created_at": "2015-07-08T20:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269901",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Again its really the V-representation adjacency matrix; The non-compact case is just the projectivization. So in a sense its really the vertex adjacency matrix; I know its somewhat confusing but most people are interested in the compact case so being overly nitpicky about wording is going to be confusing too.



---

archive/issue_comments_269902.json:
```json
{
    "body": "<a id='comment:18'></a>> Again its really the V-representation adjacency matrix; The non-compact case is just the projectivization. So in a sense its really the vertex adjacency matrix; I know its somewhat confusing but most people are interested in the compact case so being overly nitpicky about wording is going to be confusing too. \n\n\nSo was this line incorrect `return Graph(self.vertex_adjacency_matrix(), loops=False)` ?\n\nI expect the `.vertex_graph()` to give me a graph whose vertices are the vertices of the polyhedron. And the incidence matrix of that graph is *not* the output of the `_vertex_adjacency_matrix` whose rows are not the vertices only. Do we agree?\n\nNathann",
    "created_at": "2015-07-08T20:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269902",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:18'></a>> Again its really the V-representation adjacency matrix; The non-compact case is just the projectivization. So in a sense its really the vertex adjacency matrix; I know its somewhat confusing but most people are interested in the compact case so being overly nitpicky about wording is going to be confusing too. 


So was this line incorrect `return Graph(self.vertex_adjacency_matrix(), loops=False)` ?

I expect the `.vertex_graph()` to give me a graph whose vertices are the vertices of the polyhedron. And the incidence matrix of that graph is *not* the output of the `_vertex_adjacency_matrix` whose rows are not the vertices only. Do we agree?

Nathann



---

archive/issue_comments_269903.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:10 ncohen]:\n> Here is a new 'combinatorial' version. It uses an 'idea', which I am not sure is a proper definition of the object, but well... You tell me `:-P`\n> \n> 1) For every inequality `I`, build the set `set(I)` of points for which it is an equality\n> 2) For any pair of points `i,j`, list all inequalities `I_1, ..., I_k` that contain them both\n> 3) Intersection `set(I_1), ..., set(I_k)`. If this intersection has cardinality 2, then ij is an edge.\n\n\nyes, that's correct for the polytopes - provided there is no redundancy.\nE.g. if a polytope is not full-dimensional, then adding an equation satisfied by all the vertices to an inequality is a \"copy\" of this inequality, vertex-vise.\n\n\n> Works for Gosset (at least) `:-P`\n> \n> Nathann",
    "created_at": "2015-07-08T23:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269903",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>Replying to [comment:10 ncohen]:
> Here is a new 'combinatorial' version. It uses an 'idea', which I am not sure is a proper definition of the object, but well... You tell me `:-P`
> 
> 1) For every inequality `I`, build the set `set(I)` of points for which it is an equality
> 2) For any pair of points `i,j`, list all inequalities `I_1, ..., I_k` that contain them both
> 3) Intersection `set(I_1), ..., set(I_k)`. If this intersection has cardinality 2, then ij is an edge.


yes, that's correct for the polytopes - provided there is no redundancy.
E.g. if a polytope is not full-dimensional, then adding an equation satisfied by all the vertices to an inequality is a "copy" of this inequality, vertex-vise.


> Works for Gosset (at least) `:-P`
> 
> Nathann



---

archive/issue_comments_269904.json:
```json
{
    "body": "<a id='comment:20'></a>> yes, that's correct for the polytopes - provided there is no redundancy.\n\n\nExcellent news! Then we have a very nice speedup ahead `:-PPPP`\n\nAs for redundancy, it is true that this algorithm will not behave very well if there are several vertices at the same place which are actually the same. Redundancy of inequalities, however, is not a problem.\n\n> E.g. if a polytope is not full-dimensional, then adding an equation satisfied by all the vertices to an inequality is a \"copy\" of this inequality, vertex-vise.\n\n\nYeah but in terms of sets it produces the very same one. So it's cool.\n\nNathann",
    "created_at": "2015-07-09T07:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269904",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:20'></a>> yes, that's correct for the polytopes - provided there is no redundancy.


Excellent news! Then we have a very nice speedup ahead `:-PPPP`

As for redundancy, it is true that this algorithm will not behave very well if there are several vertices at the same place which are actually the same. Redundancy of inequalities, however, is not a problem.

> E.g. if a polytope is not full-dimensional, then adding an equation satisfied by all the vertices to an inequality is a "copy" of this inequality, vertex-vise.


Yeah but in terms of sets it produces the very same one. So it's cool.

Nathann



---

archive/issue_comments_269905.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:12 ncohen]:\n> A bit cleaner: I moved the code to the `.graph()`, method for apparently the `_vertex_adjacency_matrix` is not what it claims to be. Its dimension may not even be the number of vertices (if you have rays n your polyhedron) [1].\n> \n> With this, all tests pass in the `geometry` folder.\n\n\nAren't we changing the behaviour of some functions for the non-compact case?",
    "created_at": "2015-07-09T10:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269905",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>Replying to [comment:12 ncohen]:
> A bit cleaner: I moved the code to the `.graph()`, method for apparently the `_vertex_adjacency_matrix` is not what it claims to be. Its dimension may not even be the number of vertices (if you have rays n your polyhedron) [1].
> 
> With this, all tests pass in the `geometry` folder.


Aren't we changing the behaviour of some functions for the non-compact case?



---

archive/issue_comments_269906.json:
```json
{
    "body": "<a id='comment:22'></a>> Aren't we changing the behaviour of some functions for the non-compact case?\n\n\nThis patch only touches the function `.vertex_graph`. Its behaviour changes indeed for the non-compact case, but unless you can defend that the previous behavior was not a bug (there were more vertices in the graph than vertices in the polyhedron) I would say that this is not a problem.\n\nNathann",
    "created_at": "2015-07-09T10:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269906",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:22'></a>> Aren't we changing the behaviour of some functions for the non-compact case?


This patch only touches the function `.vertex_graph`. Its behaviour changes indeed for the non-compact case, but unless you can defend that the previous behavior was not a bug (there were more vertices in the graph than vertices in the polyhedron) I would say that this is not a problem.

Nathann



---

archive/issue_comments_269907.json:
```json
{
    "body": "<a id='comment:23'></a>> Aren't we changing the behaviour of some functions for the non-compact case?\n\n\nalso note that not a single doctest changed. But to be honest, I still believe that the `._vertex_adjacency_matrix` should be either fixed or renamed. It is not what it claims to be.\n\nNathann",
    "created_at": "2015-07-09T10:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269907",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:23'></a>> Aren't we changing the behaviour of some functions for the non-compact case?


also note that not a single doctest changed. But to be honest, I still believe that the `._vertex_adjacency_matrix` should be either fixed or renamed. It is not what it claims to be.

Nathann



---

archive/issue_comments_269908.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 ncohen]:\n> > Aren't we changing the behaviour of some functions for the non-compact case?\n\n> \n> also note that not a single doctest changed. But to be honest, I still believe that the `._vertex_adjacency_matrix` should be either fixed or renamed. It is not what it claims to be.\n\n\npresently we have \n\n```\nadjacency_matrix = vertex_adjacency_matrix\n```\nin `geometry/polhedron/base.py`. I'd think we should rename `._vertex_adjacency_matrix` to something like `._Vrep_adjacency_matrix`, and, dually `._facet_adjacency_matrix` to `._Hrep_adjacency_matrix`. \n\nAnd then set `adjacency_matrix = _Vrep_adjacency_matrix`, and provide a meaningful implementation of  `vertex_adjacency_matrix`, as you propose here.",
    "created_at": "2015-07-09T11:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269908",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>Replying to [comment:23 ncohen]:
> > Aren't we changing the behaviour of some functions for the non-compact case?

> 
> also note that not a single doctest changed. But to be honest, I still believe that the `._vertex_adjacency_matrix` should be either fixed or renamed. It is not what it claims to be.


presently we have 

```
adjacency_matrix = vertex_adjacency_matrix
```
in `geometry/polhedron/base.py`. I'd think we should rename `._vertex_adjacency_matrix` to something like `._Vrep_adjacency_matrix`, and, dually `._facet_adjacency_matrix` to `._Hrep_adjacency_matrix`. 

And then set `adjacency_matrix = _Vrep_adjacency_matrix`, and provide a meaningful implementation of  `vertex_adjacency_matrix`, as you propose here.



---

archive/issue_comments_269909.json:
```json
{
    "body": "<a id='comment:25'></a>Seems reasonable. Though I would very much like to see the definition of a `V_rep adjacency matrix`.\n\nNathann",
    "created_at": "2015-07-09T11:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269909",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:25'></a>Seems reasonable. Though I would very much like to see the definition of a `V_rep adjacency matrix`.

Nathann



---

archive/issue_comments_269910.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 ncohen]:\n> Seems reasonable. Though I would very much like to see the definition of a `V_rep adjacency matrix`.\n> \n\nwell, check out `sage.geometry.polyhedron.constructor?`. In short, any polyhedron is the Minkowski sum of a polytope P (spanned by vertices), a pointed polyhedral cone (spanned by rays), and a subspace S (spanned by lines). \n\n* If S is empty or of dimension bigger than 1, it can be ignored. \n* Otherwise S is a line,  and it is adjacent to all the vertices, and to no ray; and, counter-intuitively, no   vertices are adjacent to each other.\n* Rays are not adjacent to each other, and might be adjacent to some vertices.\n\nHow these general adjacencies are used, I don't know.",
    "created_at": "2015-07-09T19:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269910",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>Replying to [comment:25 ncohen]:
> Seems reasonable. Though I would very much like to see the definition of a `V_rep adjacency matrix`.
> 

well, check out `sage.geometry.polyhedron.constructor?`. In short, any polyhedron is the Minkowski sum of a polytope P (spanned by vertices), a pointed polyhedral cone (spanned by rays), and a subspace S (spanned by lines). 

* If S is empty or of dimension bigger than 1, it can be ignored. 
* Otherwise S is a line,  and it is adjacent to all the vertices, and to no ray; and, counter-intuitively, no   vertices are adjacent to each other.
* Rays are not adjacent to each other, and might be adjacent to some vertices.

How these general adjacencies are used, I don't know.



---

archive/issue_comments_269911.json:
```json
{
    "body": "<a id='comment:27'></a>Oh. Then it seems that it will be possible to rewrite that method using the algorithm implemented here, then. And everything will be faster.\n\nNathann",
    "created_at": "2015-07-09T19:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269911",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:27'></a>Oh. Then it seems that it will be possible to rewrite that method using the algorithm implemented here, then. And everything will be faster.

Nathann



---

archive/issue_comments_269912.json:
```json
{
    "body": "<a id='comment:28'></a>Are we still in `needs review` here? I struggle to remember what was the sticking point.",
    "created_at": "2015-07-31T10:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269912",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>Are we still in `needs review` here? I struggle to remember what was the sticking point.



---

archive/issue_comments_269913.json:
```json
{
    "body": "<a id='comment:29'></a>> Are we still in `needs review` here? I struggle to remember what was the sticking point.\n\n\nI do not think that there was any. We had discussions on the name of other functions, but this new implementation only touches the \"vertex graph\" and clearly improves the running time.\n\nNathann",
    "created_at": "2015-07-31T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269913",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:29'></a>> Are we still in `needs review` here? I struggle to remember what was the sticking point.


I do not think that there was any. We had discussions on the name of other functions, but this new implementation only touches the "vertex graph" and clearly improves the running time.

Nathann



---

archive/issue_comments_269914.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-31T12:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269914",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_269915.json:
```json
{
    "body": "<a id='comment:30'></a>OK. Merges in 6.8, no problem...",
    "created_at": "2015-07-31T12:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269915",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>OK. Merges in 6.8, no problem...



---

archive/issue_comments_269916.json:
```json
{
    "body": "<a id='comment:31'></a>Thanks!",
    "created_at": "2015-07-31T12:55:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269916",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:31'></a>Thanks!



---

archive/issue_comments_269917.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-08-01T09:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269917",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_269918.json:
```json
{
    "body": "<a id='comment:32'></a>\n```\nsage -t --long src/sage/graphs/generators/random.py\n**********************************************************************\nFile \"src/sage/graphs/generators/random.py\", line 806, in sage.graphs.generators.random.RandomTriangulation\nFailed example:\n    for i in range(10):\n        g = graphs.RandomTriangulation(30,embed=True)\n        assert g.is_planar() and g.size() == 3*g.order()-6\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.generators.random.RandomTriangulation[3]>\", line 3, in <module>\n        assert g.is_planar() and g.size() == Integer(3)*g.order()-Integer(6)\n      File \"/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 4035, in is_planar\n        planar = is_planar(G,kuratowski=kuratowski,set_pos=set_pos,set_embedding=set_embedding)\n      File \"sage/graphs/planarity.pyx\", line 99, in sage.graphs.planarity.is_planar (/mnt/highperf/buildbot/slave/sage_git/build/src/build/cythonized/sage/graphs/planarity.c:1800)\n        g.relabel(ffrom)\n      File \"/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 18006, in relabel\n        new_attr[perm[v]] = value\n    KeyError: 0\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.graphs.generators.random.RandomTriangulation\n    [71 tests, 1 failure, 5.56 s]\n```\nWould have been easy to catch if you had checked the patchbot output...",
    "created_at": "2015-08-01T09:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269918",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>
```
sage -t --long src/sage/graphs/generators/random.py
**********************************************************************
File "src/sage/graphs/generators/random.py", line 806, in sage.graphs.generators.random.RandomTriangulation
Failed example:
    for i in range(10):
        g = graphs.RandomTriangulation(30,embed=True)
        assert g.is_planar() and g.size() == 3*g.order()-6
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generators.random.RandomTriangulation[3]>", line 3, in <module>
        assert g.is_planar() and g.size() == Integer(3)*g.order()-Integer(6)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 4035, in is_planar
        planar = is_planar(G,kuratowski=kuratowski,set_pos=set_pos,set_embedding=set_embedding)
      File "sage/graphs/planarity.pyx", line 99, in sage.graphs.planarity.is_planar (/mnt/highperf/buildbot/slave/sage_git/build/src/build/cythonized/sage/graphs/planarity.c:1800)
        g.relabel(ffrom)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18006, in relabel
        new_attr[perm[v]] = value
    KeyError: 0
**********************************************************************
1 item had failures:
   1 of   5 in sage.graphs.generators.random.RandomTriangulation
    [71 tests, 1 failure, 5.56 s]
```
Would have been easy to catch if you had checked the patchbot output...



---

archive/issue_comments_269919.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-01T09:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269919",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269920.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-01T09:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269920",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_269921.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:34 ncohen]:\n\nCould you explain what happens in the last commit? \n(E.g.. why did it work earlier?)",
    "created_at": "2015-08-01T09:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269921",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>Replying to [comment:34 ncohen]:

Could you explain what happens in the last commit? 
(E.g.. why did it work earlier?)



---

archive/issue_comments_269922.json:
```json
{
    "body": "<a id='comment:36'></a>Oh, no problem: there is a difference between the previous output or `.vertex_graph` and the new version: in the former, the vertices of the graph were labelled on integers. Now, the vertices of that graph are the 'vertex' objects contained in the polyhedron.\n\nI adapted the code, for it expected the keys of the position dictionary (the vertices) to be integers, instead of the new points.\n\nActually, it convinced me that the previous version of this function was incorrect in theory. It was assumed that the vertices of the polyhedron appeared in the very same order as how they were first given to the polyhedron constructor. I don't know if it is true in practice, but for sure there is no reason to assume that a priori. So you can see this as a bugfix `;-)`\n\nNathann",
    "created_at": "2015-08-01T09:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269922",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:36'></a>Oh, no problem: there is a difference between the previous output or `.vertex_graph` and the new version: in the former, the vertices of the graph were labelled on integers. Now, the vertices of that graph are the 'vertex' objects contained in the polyhedron.

I adapted the code, for it expected the keys of the position dictionary (the vertices) to be integers, instead of the new points.

Actually, it convinced me that the previous version of this function was incorrect in theory. It was assumed that the vertices of the polyhedron appeared in the very same order as how they were first given to the polyhedron constructor. I don't know if it is true in practice, but for sure there is no reason to assume that a priori. So you can see this as a bugfix `;-)`

Nathann



---

archive/issue_comments_269923.json:
```json
{
    "body": "<a id='comment:37'></a>Vertices are definitely reordered in `Polyhedron`.",
    "created_at": "2015-08-01T09:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269923",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:37'></a>Vertices are definitely reordered in `Polyhedron`.



---

archive/issue_comments_269924.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-08-01T10:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269924",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_269925.json:
```json
{
    "body": "<a id='comment:38'></a>OK, looks good.",
    "created_at": "2015-08-01T10:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269925",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>OK, looks good.



---

archive/issue_comments_269926.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-08-01T23:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18860#issuecomment-269926",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052707.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-08-01T23:07:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18860",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18860#event-52707"
}
```
