# Issue 18157: Random failure in coerce_action.pyx

archive/issues_017920.json:
```json
{
    "assignees": [],
    "body": "Zmod(6) can be collected at the wrong time\n\n```\nsage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 78, in sage.structure.coerce_actions.LAction\nFailed example:\n    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\nExpected:\n    Left action by Rational Field on Ring of integers modulo 6\nGot:\n    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.LAction\n    [100 tests, 1 failure, 0.82 s]\n```\n\nIdem with\n\n```\nsage -t --long src/sage/structure/coerce.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action\nFailed example:\n    cm.discover_action(GF(5)['x'], ZZ, operator.div)\nExpected:\n    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5\n    with precomposition on right by Natural morphism:\n      From: Integer Ring\n      To:   Finite Field of size 5\nGot:\n    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n```\n\nCC:  @simon-king-jena\n\nKeywords: **random_fail**\n\nBranch: **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)**\n\nReviewer: **Simon King**\n\nAuthor: **Vincent Delecroix, Simon King**\n\nComponent: **coercion**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18157_\n\n",
    "closed_at": "2015-04-19T01:52:11Z",
    "created_at": "2015-04-10T20:16:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20coercion",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Random failure in coerce_action.pyx",
    "type": "issue",
    "updated_at": "2015-05-27T13:44:12Z",
    "url": "https://github.com/sagemath/sage/issues/18157",
    "user": "https://github.com/vbraun"
}
```
Zmod(6) can be collected at the wrong time

```
sage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 78, in sage.structure.coerce_actions.LAction
Failed example:
    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
Expected:
    Left action by Rational Field on Ring of integers modulo 6
Got:
    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.LAction
    [100 tests, 1 failure, 0.82 s]
```

Idem with

```
sage -t --long src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action
Failed example:
    cm.discover_action(GF(5)['x'], ZZ, operator.div)
Expected:
    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5
    with precomposition on right by Natural morphism:
      From: Integer Ring
      To:   Finite Field of size 5
Got:
    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
```

CC:  @simon-king-jena

Keywords: **random_fail**

Branch: **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)**

Reviewer: **Simon King**

Author: **Vincent Delecroix, Simon King**

Component: **coercion**

_Issue created by migration from https://trac.sagemath.org/ticket/18157_





---

archive/issue_events_255818.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "milestone_number": null,
    "milestone_title": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255818"
}
```



---

archive/issue_events_255819.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20coercion",
    "label_color": "0000ff",
    "label_name": "c: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255819"
}
```



---

archive/issue_events_255820.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255820"
}
```



---

archive/issue_events_255821.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255821"
}
```



---

archive/issue_comments_248072.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nReliable reproduction of the error condition:\n\n```\nimport gc\nA=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\ngc.collect()\nC=repr(A)\n```\nThe reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this \"action\" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.\n\nIt may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:\n\n```\nsage: Z6 = Zmod(6)\nsage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)\n```",
    "created_at": "2015-04-10T21:54:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248072",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

Reliable reproduction of the error condition:

```
import gc
A=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
gc.collect()
C=repr(A)
```
The reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this "action" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.

It may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:

```
sage: Z6 = Zmod(6)
sage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)
```



---

archive/issue_comments_248073.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,3 +15,21 @@\n    1 of   4 in sage.structure.coerce_actions.LAction\n     [100 tests, 1 failure, 0.82 s]\n ```\n+\n+Idem with\n+\n+```\n+sage -t --long src/sage/structure/coerce.pyx\n+**********************************************************************\n+File \"src/sage/structure/coerce.pyx\", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action\n+Failed example:\n+    cm.discover_action(GF(5)['x'], ZZ, operator.div)\n+Expected:\n+    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5\n+    with precomposition on right by Natural morphism:\n+      From: Integer Ring\n+      To:   Finite Field of size 5\n+Got:\n+    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>\n+**********************************************************************\n+```\n``````\n",
    "created_at": "2015-04-12T20:22:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248073",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,3 +15,21 @@
    1 of   4 in sage.structure.coerce_actions.LAction
     [100 tests, 1 failure, 0.82 s]
 ```
+
+Idem with
+
+```
+sage -t --long src/sage/structure/coerce.pyx
+**********************************************************************
+File "src/sage/structure/coerce.pyx", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action
+Failed example:
+    cm.discover_action(GF(5)['x'], ZZ, operator.div)
+Expected:
+    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5
+    with precomposition on right by Natural morphism:
+      From: Integer Ring
+      To:   Finite Field of size 5
+Got:
+    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>
+**********************************************************************
+```
``````




---

archive/issue_comments_248074.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\n\n```\ncm.discover_action(GF(5)['x'], ZZ, operator.div)\n```\nAlso for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.\n\nIf we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.",
    "created_at": "2015-04-13T00:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248074",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:3" align="right">comment:3</div>


```
cm.discover_action(GF(5)['x'], ZZ, operator.div)
```
Also for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.

If we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.



---

archive/issue_comments_248075.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nbruin](#comment:3):\n> I think the bug is in the doctests.\n\nMe too!",
    "created_at": "2015-04-13T07:01:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248075",
    "user": "https://github.com/videlec"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nbruin](#comment:3):
> I think the bug is in the doctests.

Me too!



---

archive/issue_comments_248076.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSomebody please write a patch instead of me-too-ing ;-)",
    "created_at": "2015-04-13T08:33:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248076",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:5" align="right">comment:5</div>

Somebody please write a patch instead of me-too-ing ;-)



---

archive/issue_comments_248077.json:
```json
{
    "body": "Commit: **[`ced7bfc`](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)**",
    "created_at": "2015-04-13T09:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248077",
    "user": "https://github.com/videlec"
}
```

Commit: **[`ced7bfc`](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)**



---

archive/issue_comments_248078.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nMight be other wrong doctests... not sure how to find them.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b\"><code>ced7bfc</code></a></td><td><code>Trac 18157: fix garbage collected objects in doctest</code></td></tr></table>\n",
    "created_at": "2015-04-13T09:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248078",
    "user": "https://github.com/videlec"
}
```

<div id="comment:6" align="right">comment:6</div>

Might be other wrong doctests... not sure how to find them.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b"><code>ced7bfc</code></a></td><td><code>Trac 18157: fix garbage collected objects in doctest</code></td></tr></table>




---

archive/issue_comments_248079.json:
```json
{
    "body": "Branch: **[public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)**",
    "created_at": "2015-04-13T09:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248079",
    "user": "https://github.com/videlec"
}
```

Branch: **[public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)**



---

archive/issue_events_255822.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-13T09:11:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255822"
}
```



---

archive/issue_comments_248080.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThere is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.",
    "created_at": "2015-04-13T09:21:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248080",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:7" align="right">comment:7</div>

There is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.



---

archive/issue_comments_248081.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nWould be nice if people would run the testsuite with this patch (and #10513)\n\n```\nfor i in $(seq -w 1 100)\ndo\n   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log\ndone\n```\n\nOr even better, does somebody know how to call `gc.collect()` after each command in doctests?",
    "created_at": "2015-04-13T09:23:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248081",
    "user": "https://github.com/videlec"
}
```

<div id="comment:8" align="right">comment:8</div>

Would be nice if people would run the testsuite with this patch (and #10513)

```
for i in $(seq -w 1 100)
do
   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log
done
```

Or even better, does somebody know how to call `gc.collect()` after each command in doctests?



---

archive/issue_comments_248082.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@videlec](#comment:8):\n> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n\nThat wouldn't help, right?",
    "created_at": "2015-04-13T09:28:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248082",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@videlec](#comment:8):
> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?

That wouldn't help, right?



---

archive/issue_comments_248083.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment:9):\n> Replying to [@videlec](#comment:8):\n> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n\n> That wouldn't help, right?\n\nRight! Not for the two doctests mentioned in the description...",
    "created_at": "2015-04-13T09:31:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248083",
    "user": "https://github.com/videlec"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment:9):
> Replying to [@videlec](#comment:8):
> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?

> That wouldn't help, right?

Right! Not for the two doctests mentioned in the description...



---

archive/issue_comments_248084.json:
```json
{
    "body": "Reviewer: **Simon King**",
    "created_at": "2015-04-17T08:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248084",
    "user": "https://github.com/simon-king-jena"
}
```

Reviewer: **Simon King**



---

archive/issue_comments_248085.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nWith one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.\n\nHowever, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!\n\nOne test is different:\n\n```diff\n@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):\n \n         This used to hang before :trac:`17844`::\n \n-            sage: E = EllipticCurve(GF(5), [4,0])\n+            sage: GF5 = GF(5)\n+            sage: E = EllipticCurve(GF5, [4,0])\n             sage: P = E.random_element()\n             sage: (-2^63)*P\n             (0 : 1 : 0)\n```\nDefining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.\n\nSo, I put it to \"needs work\", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.",
    "created_at": "2015-04-17T08:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248085",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

With one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.

However, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!

One test is different:

```diff
@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):
 
         This used to hang before :trac:`17844`::
 
-            sage: E = EllipticCurve(GF(5), [4,0])
+            sage: GF5 = GF(5)
+            sage: E = EllipticCurve(GF5, [4,0])
             sage: P = E.random_element()
             sage: (-2^63)*P
             (0 : 1 : 0)
```
Defining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.

So, I put it to "needs work", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.



---

archive/issue_comments_248086.json:
```json
{
    "body": "Work Issues: **Find underlying problem for elliptic curve problem, or open a new ticket for it**",
    "created_at": "2015-04-17T08:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248086",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Find underlying problem for elliptic curve problem, or open a new ticket for it**



---

archive/issue_events_255823.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T08:47:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255823"
}
```



---

archive/issue_events_255824.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T08:47:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255824"
}
```



---

archive/issue_comments_248087.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI don't see a problem with the elliptic curve example:\n\n```\nsage: import gc\nsage: E = EllipticCurve(GF(5), [4,0])\nsage: gc.collect()\n156\nsage: P = E.random_element()\nsage: gc.collect()\n0\nsage: (-2^63)*P\n(0 : 1 : 0)\n```\nSo, why should it be changed?",
    "created_at": "2015-04-17T10:33:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248087",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

I don't see a problem with the elliptic curve example:

```
sage: import gc
sage: E = EllipticCurve(GF(5), [4,0])
sage: gc.collect()
156
sage: P = E.random_element()
sage: gc.collect()
0
sage: (-2^63)*P
(0 : 1 : 0)
```
So, why should it be changed?



---

archive/issue_comments_248088.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nEven if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.",
    "created_at": "2015-04-17T14:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248088",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:14" align="right">comment:14</div>

Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.



---

archive/issue_comments_248089.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@simon-king-jena](#comment:12):\n\n> One test is different:\n\nAgreed. You can revert it.",
    "created_at": "2015-04-17T15:14:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248089",
    "user": "https://github.com/videlec"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@simon-king-jena](#comment:12):

> One test is different:

Agreed. You can revert it.



---

archive/issue_comments_248090.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@vbraun](#comment:14):\n> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. \n\nWhat are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.",
    "created_at": "2015-04-17T17:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248090",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@vbraun](#comment:14):
> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. 

What are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.



---

archive/issue_comments_248091.json:
```json
{
    "body": "Changed commit from **[`ced7bfc`](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)** to **[`ef3bb5d`](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)**",
    "created_at": "2015-04-17T17:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248091",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ced7bfc`](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)** to **[`ef3bb5d`](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)**



---

archive/issue_comments_248092.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c\"><code>ef3bb5d</code></a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>\n",
    "created_at": "2015-04-17T17:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248092",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c"><code>ef3bb5d</code></a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>




---

archive/issue_comments_248093.json:
```json
{
    "body": "Author: **Vincent Delecroix, SImon King**",
    "created_at": "2015-04-17T17:58:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248093",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Vincent Delecroix, SImon King**



---

archive/issue_events_255825.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T17:58:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255825"
}
```



---

archive/issue_events_255826.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T17:58:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255826"
}
```



---

archive/issue_comments_248094.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.\n\nFrom my point of view, it is a positive review, but of course someone should have a look at my commit.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c\"><code>ef3bb5d</code></a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>\n",
    "created_at": "2015-04-17T17:58:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248094",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">comment:18</div>

I added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.

From my point of view, it is a positive review, but of course someone should have a look at my commit.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c"><code>ef3bb5d</code></a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>




---

archive/issue_comments_248095.json:
```json
{
    "body": "Changed commit from **[`ef3bb5d`](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)** to **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)**",
    "created_at": "2015-04-17T22:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248095",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ef3bb5d`](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)** to **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)**



---

archive/issue_comments_248096.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a48cd0656cb69fa00658aa4be8fab5b1d6599f9a\"><code>a48cd06</code></a></td><td><code>Merge branch 'public/18157' of trac.sagemath.org:sage into develop</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca\"><code>60fcedc</code></a></td><td><code>Trac 18157: adding reference to the trac ticket</code></td></tr></table>\n",
    "created_at": "2015-04-17T22:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248096",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a48cd0656cb69fa00658aa4be8fab5b1d6599f9a"><code>a48cd06</code></a></td><td><code>Merge branch 'public/18157' of trac.sagemath.org:sage into develop</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca"><code>60fcedc</code></a></td><td><code>Trac 18157: adding reference to the trac ticket</code></td></tr></table>




---

archive/issue_comments_248097.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nHi Simon,\n\nI merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI agree with your commits and just added references to your ticket. I am ok for the positive review.\n\nVincent",
    "created_at": "2015-04-17T22:34:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248097",
    "user": "https://github.com/videlec"
}
```

<div id="comment:20" align="right">comment:20</div>

Hi Simon,

I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I agree with your commits and just added references to your ticket. I am ok for the positive review.

Vincent



---

archive/issue_comments_248098.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@videlec](#comment:20):\n> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.\n\nSo, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.",
    "created_at": "2015-04-17T22:48:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248098",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@videlec](#comment:20):
> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.

So, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.



---

archive/issue_comments_248099.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThe patchbot tells us that all tests pass, and based on the discussion above we have a positive review.",
    "created_at": "2015-04-18T08:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248099",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

The patchbot tells us that all tests pass, and based on the discussion above we have a positive review.



---

archive/issue_events_255827.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-18T08:20:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255827"
}
```



---

archive/issue_events_255828.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-18T08:20:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255828"
}
```



---

archive/issue_comments_248100.json:
```json
{
    "body": "Changed work issues from **Find underlying problem for elliptic curve problem, or open a new ticket for it** to none",
    "created_at": "2015-04-18T08:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248100",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Find underlying problem for elliptic curve problem, or open a new ticket for it** to none



---

archive/issue_comments_248101.json:
```json
{
    "body": "Changed branch from **[public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)** to **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)**",
    "created_at": "2015-04-19T01:52:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248101",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)** to **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)**



---

archive/issue_events_255829.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-19T01:52:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255829"
}
```



---

archive/issue_events_255830.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "217f9e63e5c5974e825a14cbcfe45008f8f0dd6d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-04-19T01:52:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-255830"
}
```



---

archive/issue_comments_248102.json:
```json
{
    "body": "Changed author from **Vincent Delecroix, SImon King** to **Vincent Delecroix, Simon King**",
    "created_at": "2015-05-27T13:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248102",
    "user": "https://github.com/kcrisman"
}
```

Changed author from **Vincent Delecroix, SImon King** to **Vincent Delecroix, Simon King**



---

archive/issue_comments_248103.json:
```json
{
    "body": "Changed commit from **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)** to none",
    "created_at": "2015-05-27T13:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-248103",
    "user": "https://github.com/kcrisman"
}
```

Changed commit from **[`60fcedc`](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)** to none
