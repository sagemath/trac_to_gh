# Issue 18157: Random failure in coerce_action.pyx

archive/issues_017920.json:
```json
{
    "body": "Zmod(6) can be collected at the wrong time\n\n```\nsage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 78, in sage.structure.coerce_actions.LAction\nFailed example:\n    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\nExpected:\n    Left action by Rational Field on Ring of integers modulo 6\nGot:\n    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.LAction\n    [100 tests, 1 failure, 0.82 s]\n```\n\nIdem with\n\n```\nsage -t --long src/sage/structure/coerce.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action\nFailed example:\n    cm.discover_action(GF(5)['x'], ZZ, operator.div)\nExpected:\n    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5\n    with precomposition on right by Natural morphism:\n      From: Integer Ring\n      To:   Finite Field of size 5\nGot:\n    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n```\n\nCC:  simonking\n\nKeywords: random_fail\n\nReviewer: Simon King\n\nAuthor: Vincent Delecroix, Simon King\n\nBranch: 60fcedce48b8237353e72315976ed24ab7c236ca\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18157\n\n",
    "closed_at": "2015-04-19T01:52:11Z",
    "created_at": "2015-04-10T20:16:15Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Random failure in coerce_action.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18157",
    "user": "https://github.com/vbraun"
}
```
Zmod(6) can be collected at the wrong time

```
sage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 78, in sage.structure.coerce_actions.LAction
Failed example:
    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
Expected:
    Left action by Rational Field on Ring of integers modulo 6
Got:
    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.LAction
    [100 tests, 1 failure, 0.82 s]
```

Idem with

```
sage -t --long src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action
Failed example:
    cm.discover_action(GF(5)['x'], ZZ, operator.div)
Expected:
    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5
    with precomposition on right by Natural morphism:
      From: Integer Ring
      To:   Finite Field of size 5
Got:
    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
```

CC:  simonking

Keywords: random_fail

Reviewer: Simon King

Author: Vincent Delecroix, Simon King

Branch: 60fcedce48b8237353e72315976ed24ab7c236ca

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18157





---

archive/issue_comments_309855.json:
```json
{
    "body": "<a id='comment:1'></a>\nReliable reproduction of the error condition:\n\n```\nimport gc\nA=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\ngc.collect()\nC=repr(A)\n```\nThe reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this \"action\" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.\n\nIt may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:\n\n```\nsage: Z6 = Zmod(6)\nsage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)\n```",
    "created_at": "2015-04-10T21:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309855",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'></a>
Reliable reproduction of the error condition:

```
import gc
A=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
gc.collect()
C=repr(A)
```
The reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this "action" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.

It may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:

```
sage: Z6 = Zmod(6)
sage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)
```



---

archive/issue_comments_309856.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,3 +15,21 @@\n    1 of   4 in sage.structure.coerce_actions.LAction\n     [100 tests, 1 failure, 0.82 s]\n ```\n+\n+Idem with\n+\n+```\n+sage -t --long src/sage/structure/coerce.pyx\n+**********************************************************************\n+File \"src/sage/structure/coerce.pyx\", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action\n+Failed example:\n+    cm.discover_action(GF(5)['x'], ZZ, operator.div)\n+Expected:\n+    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5\n+    with precomposition on right by Natural morphism:\n+      From: Integer Ring\n+      To:   Finite Field of size 5\n+Got:\n+    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>\n+**********************************************************************\n+```\n``````\n",
    "created_at": "2015-04-12T20:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309856",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,3 +15,21 @@
    1 of   4 in sage.structure.coerce_actions.LAction
     [100 tests, 1 failure, 0.82 s]
 ```
+
+Idem with
+
+```
+sage -t --long src/sage/structure/coerce.pyx
+**********************************************************************
+File "src/sage/structure/coerce.pyx", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action
+Failed example:
+    cm.discover_action(GF(5)['x'], ZZ, operator.div)
+Expected:
+    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5
+    with precomposition on right by Natural morphism:
+      From: Integer Ring
+      To:   Finite Field of size 5
+Got:
+    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>
+**********************************************************************
+```
``````




---

archive/issue_comments_309857.json:
```json
{
    "body": "<a id='comment:3'></a>\n\n```\ncm.discover_action(GF(5)['x'], ZZ, operator.div)\n```\nAlso for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.\n\nIf we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.",
    "created_at": "2015-04-13T00:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309857",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>

```
cm.discover_action(GF(5)['x'], ZZ, operator.div)
```
Also for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.

If we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.



---

archive/issue_comments_309858.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [nbruin](#comment%3A3):\n> I think the bug is in the doctests.\n\n\nMe too!",
    "created_at": "2015-04-13T07:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309858",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>
Replying to [nbruin](#comment%3A3):
> I think the bug is in the doctests.


Me too!



---

archive/issue_comments_309859.json:
```json
{
    "body": "<a id='comment:5'></a>\nSomebody please write a patch instead of me-too-ing ;-)",
    "created_at": "2015-04-13T08:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309859",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>
Somebody please write a patch instead of me-too-ing ;-)



---

archive/issue_comments_309860.json:
```json
{
    "body": "Changing commit from \"\" to \"ced7bfcc760e2fb362b2a382a22a94e02f996f9b\"",
    "created_at": "2015-04-13T09:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309860",
    "user": "https://github.com/videlec"
}
```

Changing commit from "" to "ced7bfcc760e2fb362b2a382a22a94e02f996f9b"



---

archive/issue_comments_309861.json:
```json
{
    "body": "<a id='comment:6'></a>\nMight be other wrong doctests... not sure how to find them.\n\n---\nNew commits:\n|                                                                                                                                          |                                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|\n|[ced7bfc](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)|`Trac 18157: fix garbage collected objects in doctest`|",
    "created_at": "2015-04-13T09:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309861",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>
Might be other wrong doctests... not sure how to find them.

---
New commits:
|                                                                                                                                          |                                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|
|[ced7bfc](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)|`Trac 18157: fix garbage collected objects in doctest`|



---

archive/issue_comments_309862.json:
```json
{
    "body": "Changing branch from \"\" to \"public/18157\"",
    "created_at": "2015-04-13T09:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309862",
    "user": "https://github.com/videlec"
}
```

Changing branch from "" to "public/18157"



---

archive/issue_comments_309863.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-13T09:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309863",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_309864.json:
```json
{
    "body": "<a id='comment:7'></a>\nThere is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.",
    "created_at": "2015-04-13T09:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309864",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>
There is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.



---

archive/issue_comments_309865.json:
```json
{
    "body": "<a id='comment:8'></a>\nWould be nice if people would run the testsuite with this patch (and #10513)\n\n```\nfor i in $(seq -w 1 100)\ndo\n   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log\ndone\n```\n\nOr even better, does somebody know how to call `gc.collect()` after each command in doctests?",
    "created_at": "2015-04-13T09:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309865",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>
Would be nice if people would run the testsuite with this patch (and #10513)

```
for i in $(seq -w 1 100)
do
   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log
done
```

Or even better, does somebody know how to call `gc.collect()` after each command in doctests?



---

archive/issue_comments_309866.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [vdelecroix](#comment%3A8):\n> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n\nThat wouldn't help, right?",
    "created_at": "2015-04-13T09:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309866",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [vdelecroix](#comment%3A8):
> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?

That wouldn't help, right?



---

archive/issue_comments_309867.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [jdemeyer](#comment%3A9):\n> Replying to [vdelecroix](#comment%3A8):\n> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n\n> That wouldn't help, right?\n\nRight! Not for the two doctests mentioned in the description...",
    "created_at": "2015-04-13T09:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309867",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>
Replying to [jdemeyer](#comment%3A9):
> Replying to [vdelecroix](#comment%3A8):
> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?

> That wouldn't help, right?

Right! Not for the two doctests mentioned in the description...



---

archive/issue_comments_309868.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Simon King\"",
    "created_at": "2015-04-17T08:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309868",
    "user": "https://github.com/simon-king-jena"
}
```

Changing reviewer from "" to "Simon King"



---

archive/issue_comments_309869.json:
```json
{
    "body": "<a id='comment:12'></a>\nWith one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.\n\nHowever, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!\n\nOne test is different:\n\n```diff\n@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):\n \n         This used to hang before :trac:`17844`::\n \n-            sage: E = EllipticCurve(GF(5), [4,0])\n+            sage: GF5 = GF(5)\n+            sage: E = EllipticCurve(GF5, [4,0])\n             sage: P = E.random_element()\n             sage: (-2^63)*P\n             (0 : 1 : 0)\n```\nDefining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.\n\nSo, I put it to \"needs work\", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.",
    "created_at": "2015-04-17T08:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309869",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
With one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.

However, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!

One test is different:

```diff
@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):
 
         This used to hang before :trac:`17844`::
 
-            sage: E = EllipticCurve(GF(5), [4,0])
+            sage: GF5 = GF(5)
+            sage: E = EllipticCurve(GF5, [4,0])
             sage: P = E.random_element()
             sage: (-2^63)*P
             (0 : 1 : 0)
```
Defining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.

So, I put it to "needs work", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.



---

archive/issue_comments_309870.json:
```json
{
    "body": "Changing work_issues from \"\" to \"Find underlying problem for elliptic curve problem, or open a new ticket for it\"",
    "created_at": "2015-04-17T08:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309870",
    "user": "https://github.com/simon-king-jena"
}
```

Changing work_issues from "" to "Find underlying problem for elliptic curve problem, or open a new ticket for it"



---

archive/issue_comments_309871.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-17T08:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309871",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_309872.json:
```json
{
    "body": "<a id='comment:13'></a>\nI don't see a problem with the elliptic curve example:\n\n```\nsage: import gc\nsage: E = EllipticCurve(GF(5), [4,0])\nsage: gc.collect()\n156\nsage: P = E.random_element()\nsage: gc.collect()\n0\nsage: (-2^63)*P\n(0 : 1 : 0)\n```\nSo, why should it be changed?",
    "created_at": "2015-04-17T10:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309872",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
I don't see a problem with the elliptic curve example:

```
sage: import gc
sage: E = EllipticCurve(GF(5), [4,0])
sage: gc.collect()
156
sage: P = E.random_element()
sage: gc.collect()
0
sage: (-2^63)*P
(0 : 1 : 0)
```
So, why should it be changed?



---

archive/issue_comments_309873.json:
```json
{
    "body": "<a id='comment:14'></a>\nEven if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.",
    "created_at": "2015-04-17T14:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309873",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>
Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.



---

archive/issue_comments_309874.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [SimonKing](#comment%3A12):\n\n> One test is different:\n\n\nAgreed. You can revert it.",
    "created_at": "2015-04-17T15:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309874",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>
Replying to [SimonKing](#comment%3A12):

> One test is different:


Agreed. You can revert it.



---

archive/issue_comments_309875.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [vbraun](#comment%3A14):\n> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. \n\n\nWhat are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.",
    "created_at": "2015-04-17T17:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309875",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>
Replying to [vbraun](#comment%3A14):
> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. 


What are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.



---

archive/issue_comments_309876.json:
```json
{
    "body": "Changing commit from \"ced7bfcc760e2fb362b2a382a22a94e02f996f9b\" to \"ef3bb5d985ee65e46d89277a3833af40953bc59c\"",
    "created_at": "2015-04-17T17:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309876",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ced7bfcc760e2fb362b2a382a22a94e02f996f9b" to "ef3bb5d985ee65e46d89277a3833af40953bc59c"



---

archive/issue_comments_309877.json:
```json
{
    "body": "<a id='comment:17'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|\n|[ef3bb5d](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)|`Add a warning not to use coerce actions outside of the coercion model`|",
    "created_at": "2015-04-17T17:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|
|[ef3bb5d](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)|`Add a warning not to use coerce actions outside of the coercion model`|



---

archive/issue_comments_309878.json:
```json
{
    "body": "Changing author from \"\" to \"Vincent Delecroix, SImon King\"",
    "created_at": "2015-04-17T17:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309878",
    "user": "https://github.com/simon-king-jena"
}
```

Changing author from "" to "Vincent Delecroix, SImon King"



---

archive/issue_comments_309879.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-17T17:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309879",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_309880.json:
```json
{
    "body": "<a id='comment:18'></a>\nI added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.\n\nFrom my point of view, it is a positive review, but of course someone should have a look at my commit.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|\n|[ef3bb5d](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)|`Add a warning not to use coerce actions outside of the coercion model`|",
    "created_at": "2015-04-17T17:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309880",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
I added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.

From my point of view, it is a positive review, but of course someone should have a look at my commit.

---
New commits:
|                                                                                                                                          |                                                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|
|[ef3bb5d](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)|`Add a warning not to use coerce actions outside of the coercion model`|



---

archive/issue_comments_309881.json:
```json
{
    "body": "Changing commit from \"ef3bb5d985ee65e46d89277a3833af40953bc59c\" to \"60fcedce48b8237353e72315976ed24ab7c236ca\"",
    "created_at": "2015-04-17T22:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309881",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ef3bb5d985ee65e46d89277a3833af40953bc59c" to "60fcedce48b8237353e72315976ed24ab7c236ca"



---

archive/issue_comments_309882.json:
```json
{
    "body": "<a id='comment:19'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|\n|[a48cd06](https://github.com/sagemath/sagetrac-mirror/commit/a48cd0656cb69fa00658aa4be8fab5b1d6599f9a)|`Merge branch 'public/18157' of trac.sagemath.org:sage into develop`|\n|[60fcedc](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)|`Trac 18157: adding reference to the trac ticket`|",
    "created_at": "2015-04-17T22:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309882",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
|[a48cd06](https://github.com/sagemath/sagetrac-mirror/commit/a48cd0656cb69fa00658aa4be8fab5b1d6599f9a)|`Merge branch 'public/18157' of trac.sagemath.org:sage into develop`|
|[60fcedc](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)|`Trac 18157: adding reference to the trac ticket`|



---

archive/issue_comments_309883.json:
```json
{
    "body": "<a id='comment:20'></a>\nHi Simon,\n\nI merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI agree with your commits and just added references to your ticket. I am ok for the positive review.\n\nVincent",
    "created_at": "2015-04-17T22:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309883",
    "user": "https://github.com/videlec"
}
```

<a id='comment:20'></a>
Hi Simon,

I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I agree with your commits and just added references to your ticket. I am ok for the positive review.

Vincent



---

archive/issue_comments_309884.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [vdelecroix](#comment%3A20):\n> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\n\nI suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.\n\nSo, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.",
    "created_at": "2015-04-17T22:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309884",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>
Replying to [vdelecroix](#comment%3A20):
> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.


I suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.

So, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.



---

archive/issue_comments_309885.json:
```json
{
    "body": "<a id='comment:22'></a>\nThe patchbot tells us that all tests pass, and based on the discussion above we have a positive review.",
    "created_at": "2015-04-18T08:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309885",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>
The patchbot tells us that all tests pass, and based on the discussion above we have a positive review.



---

archive/issue_comments_309886.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-18T08:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309886",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_309887.json:
```json
{
    "body": "Changing work_issues from \"Find underlying problem for elliptic curve problem, or open a new ticket for it\" to \"\"",
    "created_at": "2015-04-18T08:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309887",
    "user": "https://github.com/simon-king-jena"
}
```

Changing work_issues from "Find underlying problem for elliptic curve problem, or open a new ticket for it" to ""



---

archive/issue_comments_309888.json:
```json
{
    "body": "Changing branch from \"public/18157\" to \"60fcedce48b8237353e72315976ed24ab7c236ca\"",
    "created_at": "2015-04-19T01:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309888",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/18157" to "60fcedce48b8237353e72315976ed24ab7c236ca"



---

archive/issue_comments_309889.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-19T01:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309889",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_066219.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-19T01:52:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18157#event-66219"
}
```



---

archive/issue_comments_309890.json:
```json
{
    "body": "Changing author from \"Vincent Delecroix, SImon King\" to \"Vincent Delecroix, Simon King\"",
    "created_at": "2015-05-27T13:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309890",
    "user": "https://github.com/kcrisman"
}
```

Changing author from "Vincent Delecroix, SImon King" to "Vincent Delecroix, Simon King"



---

archive/issue_comments_309891.json:
```json
{
    "body": "Changing commit from \"60fcedce48b8237353e72315976ed24ab7c236ca\" to \"\"",
    "created_at": "2015-05-27T13:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18157#issuecomment-309891",
    "user": "https://github.com/kcrisman"
}
```

Changing commit from "60fcedce48b8237353e72315976ed24ab7c236ca" to ""
