# Issue 18157: Random failure in coerce_action.pyx

archive/issues_017920.json:
```json
{
    "assignees": [],
    "body": "Zmod(6) can be collected at the wrong time\n\n```\nsage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 78, in sage.structure.coerce_actions.LAction\nFailed example:\n    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\nExpected:\n    Left action by Rational Field on Ring of integers modulo 6\nGot:\n    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.LAction\n    [100 tests, 1 failure, 0.82 s]\n```\n\nIdem with\n\n```\nsage -t --long src/sage/structure/coerce.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action\nFailed example:\n    cm.discover_action(GF(5)['x'], ZZ, operator.div)\nExpected:\n    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5\n    with precomposition on right by Natural morphism:\n      From: Integer Ring\n      To:   Finite Field of size 5\nGot:\n    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n```\n\n**CC:**  @simon-king-jena\n\n**Keywords:** random_fail\n\n**Branch:** [60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)\n\n**Reviewer:** Simon King\n\n**Author:** Vincent Delecroix, Simon King\n\nIssue created by migration from https://trac.sagemath.org/ticket/18157\n\n",
    "closed_at": "2015-04-19T01:52:11Z",
    "created_at": "2015-04-10T20:16:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20coercion",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Random failure in coerce_action.pyx",
    "type": "issue",
    "updated_at": "2015-05-27T13:44:12Z",
    "url": "https://github.com/sagemath/sage/issues/18157",
    "user": "https://github.com/vbraun"
}
```
Zmod(6) can be collected at the wrong time

```
sage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 78, in sage.structure.coerce_actions.LAction
Failed example:
    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
Expected:
    Left action by Rational Field on Ring of integers modulo 6
Got:
    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.LAction
    [100 tests, 1 failure, 0.82 s]
```

Idem with

```
sage -t --long src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action
Failed example:
    cm.discover_action(GF(5)['x'], ZZ, operator.div)
Expected:
    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5
    with precomposition on right by Natural morphism:
      From: Integer Ring
      To:   Finite Field of size 5
Got:
    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
```

**CC:**  @simon-king-jena

**Keywords:** random_fail

**Branch:** [60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)

**Reviewer:** Simon King

**Author:** Vincent Delecroix, Simon King

Issue created by migration from https://trac.sagemath.org/ticket/18157





---

archive/issue_events_221884.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "milestone_number": null,
    "milestone_title": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221884"
}
```



---

archive/issue_events_221885.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20coercion",
    "label_color": "08517b",
    "label_name": "component: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221885"
}
```



---

archive/issue_events_221886.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-10T20:16:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221886"
}
```



---

archive/issue_comments_250584.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nReliable reproduction of the error condition:\n\n```\nimport gc\nA=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\ngc.collect()\nC=repr(A)\n```\nThe reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this \"action\" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.\n\nIt may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:\n\n```\nsage: Z6 = Zmod(6)\nsage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)\n```",
    "created_at": "2015-04-10T21:54:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250584",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'>**Comment 1:**</a>
Reliable reproduction of the error condition:

```
import gc
A=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
gc.collect()
C=repr(A)
```
The reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this "action" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.

It may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:

```
sage: Z6 = Zmod(6)
sage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)
```



---

archive/issue_comments_250585.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,3 +15,21 @@\n    1 of   4 in sage.structure.coerce_actions.LAction\n     [100 tests, 1 failure, 0.82 s]\n ```\n+\n+Idem with\n+\n+```\n+sage -t --long src/sage/structure/coerce.pyx\n+**********************************************************************\n+File \"src/sage/structure/coerce.pyx\", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action\n+Failed example:\n+    cm.discover_action(GF(5)['x'], ZZ, operator.div)\n+Expected:\n+    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5\n+    with precomposition on right by Natural morphism:\n+      From: Integer Ring\n+      To:   Finite Field of size 5\n+Got:\n+    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>\n+**********************************************************************\n+```\n``````\n",
    "created_at": "2015-04-12T20:22:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250585",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,3 +15,21 @@
    1 of   4 in sage.structure.coerce_actions.LAction
     [100 tests, 1 failure, 0.82 s]
 ```
+
+Idem with
+
+```
+sage -t --long src/sage/structure/coerce.pyx
+**********************************************************************
+File "src/sage/structure/coerce.pyx", line 1452, in sage.structure.coerce.CoercionModel_cache_maps.discover_action
+Failed example:
+    cm.discover_action(GF(5)['x'], ZZ, operator.div)
+Expected:
+    Right inverse action by Finite Field of size 5 on Univariate Polynomial Ring in x over Finite Field of size 5
+    with precomposition on right by Natural morphism:
+      From: Integer Ring
+      To:   Finite Field of size 5
+Got:
+    <repr(<sage.categories.action.PrecomposedAction at 0x2b41eb2a2050>) failed: RuntimeError: This action acted on a set that became garbage collected>
+**********************************************************************
+```
``````




---

archive/issue_comments_250586.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\n\n```\ncm.discover_action(GF(5)['x'], ZZ, operator.div)\n```\nAlso for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.\n\nIf we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.",
    "created_at": "2015-04-13T00:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250586",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'>**Comment 3:**</a>

```
cm.discover_action(GF(5)['x'], ZZ, operator.div)
```
Also for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.

If we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.



---

archive/issue_comments_250587.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nReplying to [@nbruin](#comment%3A3):\n> I think the bug is in the doctests.\n\nMe too!",
    "created_at": "2015-04-13T07:01:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250587",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'>**Comment 4:**</a>
Replying to [@nbruin](#comment%3A3):
> I think the bug is in the doctests.

Me too!



---

archive/issue_comments_250588.json:
```json
{
    "body": "<a id='comment:5'>**Comment 5:**</a>\nSomebody please write a patch instead of me-too-ing ;-)",
    "created_at": "2015-04-13T08:33:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250588",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'>**Comment 5:**</a>
Somebody please write a patch instead of me-too-ing ;-)



---

archive/issue_comments_250589.json:
```json
{
    "body": "**Commit:** [ced7bfcc760e2fb362b2a382a22a94e02f996f9b](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)",
    "created_at": "2015-04-13T09:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250589",
    "user": "https://github.com/videlec"
}
```

**Commit:** [ced7bfcc760e2fb362b2a382a22a94e02f996f9b](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)



---

archive/issue_comments_250590.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nMight be other wrong doctests... not sure how to find them.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b\">ced7bfc</a></td><td><code>Trac 18157: fix garbage collected objects in doctest</code></td></tr></table>\n",
    "created_at": "2015-04-13T09:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250590",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'>**Comment 6:**</a>
Might be other wrong doctests... not sure how to find them.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b">ced7bfc</a></td><td><code>Trac 18157: fix garbage collected objects in doctest</code></td></tr></table>




---

archive/issue_comments_250591.json:
```json
{
    "body": "**Branch:** [public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)",
    "created_at": "2015-04-13T09:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250591",
    "user": "https://github.com/videlec"
}
```

**Branch:** [public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)



---

archive/issue_events_221887.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-04-13T09:11:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221887"
}
```



---

archive/issue_comments_250592.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nThere is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.",
    "created_at": "2015-04-13T09:21:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250592",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'>**Comment 7:**</a>
There is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.



---

archive/issue_comments_250593.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nWould be nice if people would run the testsuite with this patch (and #10513)\n\n```\nfor i in $(seq -w 1 100)\ndo\n   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log\ndone\n```\n\nOr even better, does somebody know how to call `gc.collect()` after each command in doctests?",
    "created_at": "2015-04-13T09:23:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250593",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'>**Comment 8:**</a>
Would be nice if people would run the testsuite with this patch (and #10513)

```
for i in $(seq -w 1 100)
do
   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log
done
```

Or even better, does somebody know how to call `gc.collect()` after each command in doctests?



---

archive/issue_comments_250594.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nReplying to [@videlec](#comment%3A8):\n> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n\nThat wouldn't help, right?",
    "created_at": "2015-04-13T09:28:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250594",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'>**Comment 9:**</a>
Replying to [@videlec](#comment%3A8):
> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?

That wouldn't help, right?



---

archive/issue_comments_250595.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nReplying to [@jdemeyer](#comment%3A9):\n> Replying to [@videlec](#comment%3A8):\n> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n\n> That wouldn't help, right?\n\nRight! Not for the two doctests mentioned in the description...",
    "created_at": "2015-04-13T09:31:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250595",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'>**Comment 10:**</a>
Replying to [@jdemeyer](#comment%3A9):
> Replying to [@videlec](#comment%3A8):
> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?

> That wouldn't help, right?

Right! Not for the two doctests mentioned in the description...



---

archive/issue_comments_250596.json:
```json
{
    "body": "**Reviewer:** Simon King",
    "created_at": "2015-04-17T08:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250596",
    "user": "https://github.com/simon-king-jena"
}
```

**Reviewer:** Simon King



---

archive/issue_comments_250597.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nWith one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.\n\nHowever, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!\n\nOne test is different:\n\n```diff\n@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):\n \n         This used to hang before :trac:`17844`::\n \n-            sage: E = EllipticCurve(GF(5), [4,0])\n+            sage: GF5 = GF(5)\n+            sage: E = EllipticCurve(GF5, [4,0])\n             sage: P = E.random_element()\n             sage: (-2^63)*P\n             (0 : 1 : 0)\n```\nDefining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.\n\nSo, I put it to \"needs work\", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.",
    "created_at": "2015-04-17T08:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250597",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'>**Comment 12:**</a>
With one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.

However, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!

One test is different:

```diff
@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):
 
         This used to hang before :trac:`17844`::
 
-            sage: E = EllipticCurve(GF(5), [4,0])
+            sage: GF5 = GF(5)
+            sage: E = EllipticCurve(GF5, [4,0])
             sage: P = E.random_element()
             sage: (-2^63)*P
             (0 : 1 : 0)
```
Defining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.

So, I put it to "needs work", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.



---

archive/issue_comments_250598.json:
```json
{
    "body": "**Work Issues:** Find underlying problem for elliptic curve problem, or open a new ticket for it",
    "created_at": "2015-04-17T08:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250598",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** Find underlying problem for elliptic curve problem, or open a new ticket for it



---

archive/issue_events_221888.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T08:47:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221888"
}
```



---

archive/issue_events_221889.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T08:47:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221889"
}
```



---

archive/issue_comments_250599.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nI don't see a problem with the elliptic curve example:\n\n```\nsage: import gc\nsage: E = EllipticCurve(GF(5), [4,0])\nsage: gc.collect()\n156\nsage: P = E.random_element()\nsage: gc.collect()\n0\nsage: (-2^63)*P\n(0 : 1 : 0)\n```\nSo, why should it be changed?",
    "created_at": "2015-04-17T10:33:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250599",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'>**Comment 13:**</a>
I don't see a problem with the elliptic curve example:

```
sage: import gc
sage: E = EllipticCurve(GF(5), [4,0])
sage: gc.collect()
156
sage: P = E.random_element()
sage: gc.collect()
0
sage: (-2^63)*P
(0 : 1 : 0)
```
So, why should it be changed?



---

archive/issue_comments_250600.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nEven if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.",
    "created_at": "2015-04-17T14:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250600",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'>**Comment 14:**</a>
Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.



---

archive/issue_comments_250601.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\nReplying to [@simon-king-jena](#comment%3A12):\n\n> One test is different:\n\nAgreed. You can revert it.",
    "created_at": "2015-04-17T15:14:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250601",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'>**Comment 15:**</a>
Replying to [@simon-king-jena](#comment%3A12):

> One test is different:

Agreed. You can revert it.



---

archive/issue_comments_250602.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nReplying to [@vbraun](#comment%3A14):\n> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. \n\nWhat are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.",
    "created_at": "2015-04-17T17:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250602",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'>**Comment 16:**</a>
Replying to [@vbraun](#comment%3A14):
> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. 

What are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.



---

archive/issue_comments_250603.json:
```json
{
    "body": "**Changing commit** from \"[ced7bfcc760e2fb362b2a382a22a94e02f996f9b](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)\" to \"[ef3bb5d985ee65e46d89277a3833af40953bc59c](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)\".",
    "created_at": "2015-04-17T17:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250603",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[ced7bfcc760e2fb362b2a382a22a94e02f996f9b](https://github.com/sagemath/sagetrac-mirror/commit/ced7bfcc760e2fb362b2a382a22a94e02f996f9b)" to "[ef3bb5d985ee65e46d89277a3833af40953bc59c](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)".



---

archive/issue_comments_250604.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c\">ef3bb5d</a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>\n",
    "created_at": "2015-04-17T17:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250604",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>**Comment 17:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c">ef3bb5d</a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>




---

archive/issue_comments_250605.json:
```json
{
    "body": "**Author:** Vincent Delecroix, SImon King",
    "created_at": "2015-04-17T17:58:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250605",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Vincent Delecroix, SImon King



---

archive/issue_events_221890.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T17:58:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221890"
}
```



---

archive/issue_events_221891.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-17T17:58:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221891"
}
```



---

archive/issue_comments_250606.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nI added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.\n\nFrom my point of view, it is a positive review, but of course someone should have a look at my commit.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c\">ef3bb5d</a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>\n",
    "created_at": "2015-04-17T17:58:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250606",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'>**Comment 18:**</a>
I added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.

From my point of view, it is a positive review, but of course someone should have a look at my commit.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c">ef3bb5d</a></td><td><code>Add a warning not to use coerce actions outside of the coercion model</code></td></tr></table>




---

archive/issue_comments_250607.json:
```json
{
    "body": "**Changing commit** from \"[ef3bb5d985ee65e46d89277a3833af40953bc59c](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)\" to \"[60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)\".",
    "created_at": "2015-04-17T22:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250607",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[ef3bb5d985ee65e46d89277a3833af40953bc59c](https://github.com/sagemath/sagetrac-mirror/commit/ef3bb5d985ee65e46d89277a3833af40953bc59c)" to "[60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)".



---

archive/issue_comments_250608.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a48cd0656cb69fa00658aa4be8fab5b1d6599f9a\">a48cd06</a></td><td><code>Merge branch 'public/18157' of trac.sagemath.org:sage into develop</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca\">60fcedc</a></td><td><code>Trac 18157: adding reference to the trac ticket</code></td></tr></table>\n",
    "created_at": "2015-04-17T22:32:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250608",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:19'>**Comment 19:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a48cd0656cb69fa00658aa4be8fab5b1d6599f9a">a48cd06</a></td><td><code>Merge branch 'public/18157' of trac.sagemath.org:sage into develop</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca">60fcedc</a></td><td><code>Trac 18157: adding reference to the trac ticket</code></td></tr></table>




---

archive/issue_comments_250609.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\nHi Simon,\n\nI merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI agree with your commits and just added references to your ticket. I am ok for the positive review.\n\nVincent",
    "created_at": "2015-04-17T22:34:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250609",
    "user": "https://github.com/videlec"
}
```

<a id='comment:20'>**Comment 20:**</a>
Hi Simon,

I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I agree with your commits and just added references to your ticket. I am ok for the positive review.

Vincent



---

archive/issue_comments_250610.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nReplying to [@videlec](#comment%3A20):\n> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.\n\nSo, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.",
    "created_at": "2015-04-17T22:48:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250610",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'>**Comment 21:**</a>
Replying to [@videlec](#comment%3A20):
> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.

So, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.



---

archive/issue_comments_250611.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\nThe patchbot tells us that all tests pass, and based on the discussion above we have a positive review.",
    "created_at": "2015-04-18T08:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250611",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'>**Comment 22:**</a>
The patchbot tells us that all tests pass, and based on the discussion above we have a positive review.



---

archive/issue_events_221892.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-18T08:20:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221892"
}
```



---

archive/issue_events_221893.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-04-18T08:20:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221893"
}
```



---

archive/issue_comments_250612.json:
```json
{
    "body": "**Changing work issues** from \"Find underlying problem for elliptic curve problem, or open a new ticket for it\" to \"\".",
    "created_at": "2015-04-18T08:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250612",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work issues** from "Find underlying problem for elliptic curve problem, or open a new ticket for it" to "".



---

archive/issue_comments_250613.json:
```json
{
    "body": "**Changing branch** from \"[public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)\" to \"[60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)\".",
    "created_at": "2015-04-19T01:52:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250613",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/18157](https://github.com/sagemath/sagetrac-mirror/tree/public/18157)" to "[60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)".



---

archive/issue_events_221894.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-19T01:52:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221894"
}
```



---

archive/issue_events_221895.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "217f9e63e5c5974e825a14cbcfe45008f8f0dd6d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-04-19T01:52:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18157#event-221895"
}
```



---

archive/issue_comments_250614.json:
```json
{
    "body": "**Changing author** from \"Vincent Delecroix, SImon King\" to \"Vincent Delecroix, Simon King\".",
    "created_at": "2015-05-27T13:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250614",
    "user": "https://github.com/kcrisman"
}
```

**Changing author** from "Vincent Delecroix, SImon King" to "Vincent Delecroix, Simon King".



---

archive/issue_comments_250615.json:
```json
{
    "body": "**Changing commit** from \"[60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)\" to \"\".",
    "created_at": "2015-05-27T13:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18157#issuecomment-250615",
    "user": "https://github.com/kcrisman"
}
```

**Changing commit** from "[60fcedce48b8237353e72315976ed24ab7c236ca](https://github.com/sagemath/sagetrac-mirror/commit/60fcedce48b8237353e72315976ed24ab7c236ca)" to "".
