# Issue 18842: Really fix cleaning of Sage library

archive/issues_018605.json:
```json
{
    "body": "Since #18494, we install `.pxd` files but we never remove them.\n\nCC:  @kiwifb @nathanncohen\n\nBranch/Commit: 2b0fbaff82a95a4345b8aa70d4af6965a1a23126\n\nReviewer: Steven Trogdon\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18842\n\n",
    "closed_at": "2015-07-05T10:21:56Z",
    "created_at": "2015-07-02T11:21:49Z",
    "labels": [
        "component: cython",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Really fix cleaning of Sage library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18842",
    "user": "https://github.com/jdemeyer"
}
```
Since #18494, we install `.pxd` files but we never remove them.

CC:  @kiwifb @nathanncohen

Branch/Commit: 2b0fbaff82a95a4345b8aa70d4af6965a1a23126

Reviewer: Steven Trogdon

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18842





---

archive/issue_comments_269455.json:
```json
{
    "body": "<a id='comment:2'></a>Here a \n\n```\nrm local/lib/python2.7/site-packages/sage/graphs/graph_decompositions/*.pxd\n```\nseemed to allow one to recover, but then required a `make doc-clean && make` to rebuild the docs.",
    "created_at": "2015-07-02T22:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269455",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:2'></a>Here a 

```
rm local/lib/python2.7/site-packages/sage/graphs/graph_decompositions/*.pxd
```
seemed to allow one to recover, but then required a `make doc-clean && make` to rebuild the docs.



---

archive/issue_comments_269456.json:
```json
{
    "body": "<a id='comment:3'></a>Actually, only `fast_digraph.pxd` and `vertex_separation.pxd` have to be removed which are new with ticket #18746.",
    "created_at": "2015-07-02T22:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269456",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:3'></a>Actually, only `fast_digraph.pxd` and `vertex_separation.pxd` have to be removed which are new with ticket #18746.



---

archive/issue_comments_269457.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2015-07-03T11:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269457",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_269458.json:
```json
{
    "body": "<a id='comment:6'></a>So i see you are switching to only using `data_files` and the only headers to be considered are those found in `SAGE_CYTHONIZED` which makes sense as all the useful headers will be copied. \n\nIs the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?",
    "created_at": "2015-07-03T11:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269458",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>So i see you are switching to only using `data_files` and the only headers to be considered are those found in `SAGE_CYTHONIZED` which makes sense as all the useful headers will be copied. 

Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?



---

archive/issue_comments_269459.json:
```json
{
    "body": "<a id='comment:7'></a>Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.",
    "created_at": "2015-07-03T12:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269459",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.



---

archive/issue_comments_269460.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 fbissey]:\n> Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?\n\nYes, if we delete a `.pxd` file from the sources, it should also be deleted from the installation directory.",
    "created_at": "2015-07-03T12:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269460",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:6 fbissey]:
> Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?

Yes, if we delete a `.pxd` file from the sources, it should also be deleted from the installation directory.



---

archive/issue_comments_269461.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This is probably due to #18494 but needs to be investigated further.\n+Since #18494, we install \\`.pxd\\` files but we never remove them. Since Cython automatically looks for \\`.pxd\\` files when parsing \\`.pyx\\` file, this leads to trouble.\n \n Steps to reproduce:\n \n@@ -26,6 +26,10 @@\n sage/graphs/graph_decompositions/fast_digraph.pyx:23:17: C attributes cannot be added in implementation part of extension type defined in a pxd\n \\`\\`\\`\n \n+The obvious fix is to clean stale \\`.pxd\\` files (implemented in this branch). Unfortunately, this is not sufficient since the cleaning currently happens after Cythonization, which is too late.\n+\n+Part of this could be considered a Cython bug: Cython should not look for \\`.pxd\\` files everywhere: [https://groups.google.com/forum/#!topic/cython-users/PZTK8sZdxrY](https://groups.google.com/forum/#!topic/cython-users/PZTK8sZdxrY)\n+\n Comment: 1\n \n Summary: Cythonization broken\n```\n",
    "created_at": "2015-07-03T14:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269461",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This is probably due to #18494 but needs to be investigated further.
+Since #18494, we install \`.pxd\` files but we never remove them. Since Cython automatically looks for \`.pxd\` files when parsing \`.pyx\` file, this leads to trouble.
 
 Steps to reproduce:
 
@@ -26,6 +26,10 @@
 sage/graphs/graph_decompositions/fast_digraph.pyx:23:17: C attributes cannot be added in implementation part of extension type defined in a pxd
 \`\`\`
 
+The obvious fix is to clean stale \`.pxd\` files (implemented in this branch). Unfortunately, this is not sufficient since the cleaning currently happens after Cythonization, which is too late.
+
+Part of this could be considered a Cython bug: Cython should not look for \`.pxd\` files everywhere: [https://groups.google.com/forum/#!topic/cython-users/PZTK8sZdxrY](https://groups.google.com/forum/#!topic/cython-users/PZTK8sZdxrY)
+
 Comment: 1
 
 Summary: Cythonization broken
```




---

archive/issue_comments_269462.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:7 jdemeyer]:\n> Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.\n  \nBummer. You're absolutely correct. And this is what is done when they are removed manually.",
    "created_at": "2015-07-03T17:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269462",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:10'></a>Replying to [comment:7 jdemeyer]:
> Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.
  
Bummer. You're absolutely correct. And this is what is done when they are removed manually.



---

archive/issue_comments_269463.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+Since #18494, we install \\`.pxd\\` files but we never remove them.\n \n Comment: 1\n \n```\n",
    "created_at": "2015-07-03T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269463",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+Since #18494, we install \`.pxd\` files but we never remove them.
 
 Comment: 1
 
```




---

archive/issue_comments_269464.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-03T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269464",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_269465.json:
```json
{
    "body": "<a id='comment:12'></a>See #18851 for the Cython patch.\n\nThis branch is still relevant, but it doesn't fix the problem originally reported.",
    "created_at": "2015-07-03T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269465",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>See #18851 for the Cython patch.

This branch is still relevant, but it doesn't fix the problem originally reported.



---

archive/issue_comments_269466.json:
```json
{
    "body": "<a id='comment:13'></a>Built Sage on top of 6.8.beta6 with commits from this ticket and #18851 + #18746. All `.pxd` files added with #18746 were removed when Sage was rebuild without #18746. Fran\u00e7ois, feel free to reverse things if you see anything out of place with the commits.",
    "created_at": "2015-07-04T22:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269466",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:13'></a>Built Sage on top of 6.8.beta6 with commits from this ticket and #18851 + #18746. All `.pxd` files added with #18746 were removed when Sage was rebuild without #18746. François, feel free to reverse things if you see anything out of place with the commits.



---

archive/issue_comments_269467.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-04T22:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269467",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_269468.json:
```json
{
    "body": "<a id='comment:14'></a>It's absolutely fine with me and definitely should go in.",
    "created_at": "2015-07-04T23:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269468",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>It's absolutely fine with me and definitely should go in.



---

archive/issue_comments_269469.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-05T10:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18842#issuecomment-269469",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052653.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-05T10:21:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18842",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18842#event-52653"
}
```
