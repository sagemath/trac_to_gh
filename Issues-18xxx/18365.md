# Issue 18365: Definition of LU decomposition of a matrix depends on the base ring

archive/issues_018128.json:
```json
{
    "body": "CC:  @kcrisman @chamanagrawal\n\nAs reported on [this ask question](http://ask.sagemath.org/question/26713/lu-descomposition-for-a-matrix/), there is an inconsistency in the definition of the LU decomposition of a matrix depending on its base ring. If a matrix `A` belongs to `ZZ`, `QQ`, `AA`, `QQbar`, `A.LU()` returns a triple `(P,L,U)` such that `A=PLU`. If a matrix `A` belongs to `RDF`, `A.LU()` returns a triple `(P,L,U)` such that `PA=LU`. For example:\n\n```\nsage: A = random_matrix(ZZ,4)\nsage: A.LU()\n(\n[0 1 0 0]  [    1     0     0     0]  [   72    -4   -38     0]\n[0 0 1 0]  [    0     1     0     0]  [    0    -1    -2    10]\n[1 0 0 0]  [ 1/36   8/9     1     0]  [    0     0  17/6 -80/9]\n[0 0 0 1], [-1/36   1/9    -1     1], [    0     0     0   -17]\n)\nsage: B = A.change_ring(RDF)\nsage: B.LU()\n(\n[0.0 0.0 1.0 0.0]\n[1.0 0.0 0.0 0.0]\n[0.0 1.0 0.0 0.0]\n[0.0 0.0 0.0 1.0],\n\n[             1.0              0.0              0.0              0.0]\n[             0.0              1.0              0.0              0.0]\n[ 0.0277777777778   0.888888888889              1.0              0.0]\n[-0.0277777777778   0.111111111111             -1.0              1.0],\n\n[          72.0           -4.0          -38.0            0.0]\n[           0.0           -1.0           -2.0           10.0]\n[           0.0            0.0  2.83333333333 -8.88888888889]\n[           0.0            0.0            0.0          -17.0]\n)\n\n\nsage: B.LU()[0] == A.LU()[0]\nFalse\nsage: B.LU()[0] == A.LU()[0].transpose()\nTrue\nsage: \n```\n\nThe aim of this ticket is to fix this inconsistency and choose a common definition for all rings.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18365\n\n",
    "closed_at": "2020-03-12T22:48:18Z",
    "created_at": "2015-05-04T15:04:44Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Definition of LU decomposition of a matrix depends on the base ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18365",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
CC:  @kcrisman @chamanagrawal

As reported on [this ask question](http://ask.sagemath.org/question/26713/lu-descomposition-for-a-matrix/), there is an inconsistency in the definition of the LU decomposition of a matrix depending on its base ring. If a matrix `A` belongs to `ZZ`, `QQ`, `AA`, `QQbar`, `A.LU()` returns a triple `(P,L,U)` such that `A=PLU`. If a matrix `A` belongs to `RDF`, `A.LU()` returns a triple `(P,L,U)` such that `PA=LU`. For example:

```
sage: A = random_matrix(ZZ,4)
sage: A.LU()
(
[0 1 0 0]  [    1     0     0     0]  [   72    -4   -38     0]
[0 0 1 0]  [    0     1     0     0]  [    0    -1    -2    10]
[1 0 0 0]  [ 1/36   8/9     1     0]  [    0     0  17/6 -80/9]
[0 0 0 1], [-1/36   1/9    -1     1], [    0     0     0   -17]
)
sage: B = A.change_ring(RDF)
sage: B.LU()
(
[0.0 0.0 1.0 0.0]
[1.0 0.0 0.0 0.0]
[0.0 1.0 0.0 0.0]
[0.0 0.0 0.0 1.0],

[             1.0              0.0              0.0              0.0]
[             0.0              1.0              0.0              0.0]
[ 0.0277777777778   0.888888888889              1.0              0.0]
[-0.0277777777778   0.111111111111             -1.0              1.0],

[          72.0           -4.0          -38.0            0.0]
[           0.0           -1.0           -2.0           10.0]
[           0.0            0.0  2.83333333333 -8.88888888889]
[           0.0            0.0            0.0          -17.0]
)


sage: B.LU()[0] == A.LU()[0]
False
sage: B.LU()[0] == A.LU()[0].transpose()
True
sage: 
```

The aim of this ticket is to fix this inconsistency and choose a common definition for all rings.


Issue created by migration from https://trac.sagemath.org/ticket/18365





---

archive/issue_comments_244123.json:
```json
{
    "body": "It is worth noticing that the source code for matrices over `RDF` calls `scipy.linalg.lu` which returns a triple `(P,L,U)` such that `A=PLU` and then transpose `P` with the documentation:\n\n```\n# Numpy has a different convention than we had with GSL\n# So we invert (transpose) the P to match our prior behavior\n# TODO: It's an awful waste to store a huge matrix for P, which\n# is just a simple permutation, really.\n```\n\nSo, i guess this extra transposition should be reverted, so that it becomes consistent with both `scipy` and the implementation for exact rings.",
    "created_at": "2015-05-04T15:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244123",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

It is worth noticing that the source code for matrices over `RDF` calls `scipy.linalg.lu` which returns a triple `(P,L,U)` such that `A=PLU` and then transpose `P` with the documentation:

```
# Numpy has a different convention than we had with GSL
# So we invert (transpose) the P to match our prior behavior
# TODO: It's an awful waste to store a huge matrix for P, which
# is just a simple permutation, really.
```

So, i guess this extra transposition should be reverted, so that it becomes consistent with both `scipy` and the implementation for exact rings.



---

archive/issue_comments_244124.json:
```json
{
    "body": "Probably in principle the old behavior should be deprecated ... but the inconsistency is annoying, agreed.",
    "created_at": "2019-03-04T20:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244124",
    "user": "https://github.com/kcrisman"
}
```

Probably in principle the old behavior should be deprecated ... but the inconsistency is annoying, agreed.



---

archive/issue_comments_244125.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-08T11:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244125",
    "user": "https://github.com/ChamanAgrawal"
}
```

New commits:



---

archive/issue_comments_244126.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-08T11:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244126",
    "user": "https://github.com/ChamanAgrawal"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_244127.json:
```json
{
    "body": "I have removed to the extra copy of the matrix and also reverted the transposing step to maintain consistent behavior with scipy and also with `LU()` in matrices of other class in sagemath.",
    "created_at": "2019-03-08T12:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244127",
    "user": "https://github.com/ChamanAgrawal"
}
```

I have removed to the extra copy of the matrix and also reverted the transposing step to maintain consistent behavior with scipy and also with `LU()` in matrices of other class in sagemath.



---

archive/issue_comments_244128.json:
```json
{
    "body": "Replying to [comment:3 kcrisman]:\n> Probably in principle the old behavior should be deprecated ... but the inconsistency is annoying, agreed.\n\n\nThe proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?\n\nDo you say that if the `.LU()` method is used for a matrix over RDF then a deprecation warning should be used? That warning would appear also in the case that the user expects the new (not the old) behaviour, i.e., when a warning is inappropriate.",
    "created_at": "2019-04-01T07:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244128",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:3 kcrisman]:
> Probably in principle the old behavior should be deprecated ... but the inconsistency is annoying, agreed.


The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?

Do you say that if the `.LU()` method is used for a matrix over RDF then a deprecation warning should be used? That warning would appear also in the case that the user expects the new (not the old) behaviour, i.e., when a warning is inappropriate.



---

archive/issue_comments_244129.json:
```json
{
    "body": "> The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?\n\n\nGood point.   Perhaps we need to just put a visible note in the documentation that might help clarify if someone is perplexed by the output changing - I guess that was my point, that it is a \"silent\" change.  But they should agree over all rings, yes.",
    "created_at": "2019-04-01T11:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244129",
    "user": "https://github.com/kcrisman"
}
```

> The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?


Good point.   Perhaps we need to just put a visible note in the documentation that might help clarify if someone is perplexed by the output changing - I guess that was my point, that it is a "silent" change.  But they should agree over all rings, yes.



---

archive/issue_comments_244130.json:
```json
{
    "body": "Replying to [comment:7 kcrisman]:\n> \n> > The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?\n\n> \n> Good point.   Perhaps we need to just put a visible note in the documentation that might help clarify if someone is perplexed by the output changing - I guess that was my point, that it is a \"silent\" change.  But they should agree over all rings, yes.\n\n\nI think along with a note in the documentation `LU()` should also give a warning on using for this behavior change, what do you think?",
    "created_at": "2019-04-01T12:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244130",
    "user": "https://github.com/ChamanAgrawal"
}
```

Replying to [comment:7 kcrisman]:
> 
> > The proposed change does not change the syntax of using the `.LU()` method, but changes the semantic of the output. How would it be possible to deprecate it?

> 
> Good point.   Perhaps we need to just put a visible note in the documentation that might help clarify if someone is perplexed by the output changing - I guess that was my point, that it is a "silent" change.  But they should agree over all rings, yes.


I think along with a note in the documentation `LU()` should also give a warning on using for this behavior change, what do you think?



---

archive/issue_comments_244131.json:
```json
{
    "body": "Replying to [comment:8 gh-ChamanAgrawal]:\n> I think along with a note in the documentation `LU()` should also give a warning on using for this behavior change, what do you think?\n\n\nI don't think so. A warning (in the sense of: \"If M.LU() is called then a warning is printed\") is disturbing, because the mere fact of calling `.LU()` is *not* a problem. What is a potential problem is whether or not the user expects the output in a particular form. And we cannot guess on the expectation of the user. Hence, certainly it should be written in the documentation that there has been a change, give an example for which that change happens, and insert a link to this ticket. The syntax for such link in the docstrings is\n\n```\nSee :trac:`18365`.\n```\nBut there should be no warning inserted into the code.",
    "created_at": "2019-04-01T12:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244131",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:8 gh-ChamanAgrawal]:
> I think along with a note in the documentation `LU()` should also give a warning on using for this behavior change, what do you think?


I don't think so. A warning (in the sense of: "If M.LU() is called then a warning is printed") is disturbing, because the mere fact of calling `.LU()` is *not* a problem. What is a potential problem is whether or not the user expects the output in a particular form. And we cannot guess on the expectation of the user. Hence, certainly it should be written in the documentation that there has been a change, give an example for which that change happens, and insert a link to this ticket. The syntax for such link in the docstrings is

```
See :trac:`18365`.
```
But there should be no warning inserted into the code.



---

archive/issue_comments_244132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-01T13:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244132",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_244133.json:
```json
{
    "body": "I have added a note for the change as below, any suggestion for change? \n\n```\n.. NOTE::\n            The behaviour of ``LU()`` has been changed. Earlier ``LU()`` \n            returned ``P,L,U`` such that ``P*A=L*U``, where ``P`` represents\n            the permutation and is the matrix inverse of the ``P`` returned\n            by this method. The computation of this matrix inverse can be accomplished\n            quickly with just a transpose as the matrix is orthogonal/unitary.\n                \n            For Details See :trac:`18365`.\n\n        EXAMPLES::\n\n            sage: m = matrix(RDF,4,range(16))\n            sage: P,L,U = m.LU()\n            sage: P*L*U # rel tol 2e-16\n            [ 0.0  1.0  2.0  3.0]\n            [ 4.0  5.0  6.0  7.0]\n            [ 8.0  9.0 10.0 11.0]\n            [12.0 13.0 14.0 15.0]\n            \n        Below example illustrate the change in behaviour of ``LU()``. ::\n\n            sage: m == P*L*U\n            True\n            sage: P*m == L*U\n            False\n```",
    "created_at": "2019-04-01T13:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244133",
    "user": "https://github.com/ChamanAgrawal"
}
```

I have added a note for the change as below, any suggestion for change? 

```
.. NOTE::
            The behaviour of ``LU()`` has been changed. Earlier ``LU()`` 
            returned ``P,L,U`` such that ``P*A=L*U``, where ``P`` represents
            the permutation and is the matrix inverse of the ``P`` returned
            by this method. The computation of this matrix inverse can be accomplished
            quickly with just a transpose as the matrix is orthogonal/unitary.
                
            For Details See :trac:`18365`.

        EXAMPLES::

            sage: m = matrix(RDF,4,range(16))
            sage: P,L,U = m.LU()
            sage: P*L*U # rel tol 2e-16
            [ 0.0  1.0  2.0  3.0]
            [ 4.0  5.0  6.0  7.0]
            [ 8.0  9.0 10.0 11.0]
            [12.0 13.0 14.0 15.0]
            
        Below example illustrate the change in behaviour of ``LU()``. ::

            sage: m == P*L*U
            True
            sage: P*m == L*U
            False
```



---

archive/issue_events_051800.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-01-04T08:33:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18365#event-51800"
}
```



---

archive/issue_comments_244134.json:
```json
{
    "body": "I suggest that this gets merged now, despite the backwards incompatibility.",
    "created_at": "2020-02-27T22:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244134",
    "user": "https://github.com/mwageringel"
}
```

I suggest that this gets merged now, despite the backwards incompatibility.



---

archive/issue_comments_244135.json:
```json
{
    "body": "I have made small formatting changes to the documentation and removed trailing whitespace. I will let the patchbot run on this ticket once more and then set it to positive.\n\n---\nNew commits:",
    "created_at": "2020-03-08T13:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244135",
    "user": "https://github.com/mwageringel"
}
```

I have made small formatting changes to the documentation and removed trailing whitespace. I will let the patchbot run on this ticket once more and then set it to positive.

---
New commits:



---

archive/issue_comments_244136.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-11T18:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244136",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_051801.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-12T22:48:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18365#event-51801"
}
```



---

archive/issue_comments_244137.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-12T22:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18365",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18365#issuecomment-244137",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
