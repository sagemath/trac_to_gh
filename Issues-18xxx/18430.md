# Issue 18430: Bug in is_hyperbolic

archive/issues_018193.json:
```json
{
    "body": "The method is_hyperbolic in the class of quadratic form returns incorrect results over the field QQ_2. Here is an explicit example:\n\n```python\nq = DiagonalQuadraticForm(QQ, [1,1,-1,-1])\nprint q.is_hyperbolic(2)\n```\nThe form <1,1,-1,-1> is clearly hyperbolic - by definition. It is a sum of two hyperbolic planes. Nevertheless Sage returns `False` here.\n\nThe reason is as follows. In the file `quadratic_forms/quadratic_form__local_field_invariants.py` in function `is_hyperbolic` the actual code is\n\n```python\n    elif p == 2:\n        return QQ(self.det() * (-1)**m).is_padic_square(p) and (self.hasse_invariant(p) == (-1)**m)    ## Actually, this -1 is the Hilbert symbol (-1,-1)_p\n```\nwhile it should be\n\n```python\n    elif p == 2:\n        return QQ(self.det() * (-1)**m).is_padic_square(p) and (self.hasse_invariant(p) == (-1)**(m*(m-1)/2))    ## Actually, this -1 is the Hilbert symbol (-1,-1)_p\n```\nFor mathematical explanation see e.g. T.Y. Lam \"Introduction to Quadratic Forms over Field\", Proposition V.3.25\n\nI'm not sure how to formally patch the code, so I'm posting it this way.\n\n\nBranch/Commit: f99393fc110ed6c5f59136717d5fbf1c69c6c7bd\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\n\nAuthor: Malcolm Rupert\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18430\n\n",
    "closed_at": "2017-06-09T18:38:01Z",
    "created_at": "2015-05-16T19:03:59Z",
    "labels": [
        "component: quadratic forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Bug in is_hyperbolic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18430",
    "user": "https://trac.sagemath.org/admin/accounts/users/pkoprowski"
}
```
The method is_hyperbolic in the class of quadratic form returns incorrect results over the field QQ_2. Here is an explicit example:

```python
q = DiagonalQuadraticForm(QQ, [1,1,-1,-1])
print q.is_hyperbolic(2)
```
The form <1,1,-1,-1> is clearly hyperbolic - by definition. It is a sum of two hyperbolic planes. Nevertheless Sage returns `False` here.

The reason is as follows. In the file `quadratic_forms/quadratic_form__local_field_invariants.py` in function `is_hyperbolic` the actual code is

```python
    elif p == 2:
        return QQ(self.det() * (-1)**m).is_padic_square(p) and (self.hasse_invariant(p) == (-1)**m)    ## Actually, this -1 is the Hilbert symbol (-1,-1)_p
```
while it should be

```python
    elif p == 2:
        return QQ(self.det() * (-1)**m).is_padic_square(p) and (self.hasse_invariant(p) == (-1)**(m*(m-1)/2))    ## Actually, this -1 is the Hilbert symbol (-1,-1)_p
```
For mathematical explanation see e.g. T.Y. Lam "Introduction to Quadratic Forms over Field", Proposition V.3.25

I'm not sure how to formally patch the code, so I'm posting it this way.


Branch/Commit: f99393fc110ed6c5f59136717d5fbf1c69c6c7bd

Reviewer: Frédéric Chapoton, Travis Scrimshaw

Author: Malcolm Rupert

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18430





---

archive/issue_comments_321230.json:
```json
{
    "body": "Changing branch from \"\" to \"u/MRupert/bug_in_is_hyperbolic\"",
    "created_at": "2015-05-25T21:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321230",
    "user": "https://trac.sagemath.org/admin/accounts/users/MRupert"
}
```

Changing branch from "" to "u/MRupert/bug_in_is_hyperbolic"



---

archive/issue_comments_321231.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-25T21:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321231",
    "user": "https://trac.sagemath.org/admin/accounts/users/MRupert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_321232.json:
```json
{
    "body": "<a id='comment:2'></a>This commit should fix the problem. I also added functionality and improved the documentation on the infinite place.\n\n---\nNew commits:",
    "created_at": "2015-05-25T21:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321232",
    "user": "https://trac.sagemath.org/admin/accounts/users/MRupert"
}
```

<a id='comment:2'></a>This commit should fix the problem. I also added functionality and improved the documentation on the infinite place.

---
New commits:



---

archive/issue_comments_321233.json:
```json
{
    "body": "Changing commit from \"\" to \"abb9f998469824499d2ac1c26234363c6b6a2a72\"",
    "created_at": "2015-05-25T21:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321233",
    "user": "https://trac.sagemath.org/admin/accounts/users/MRupert"
}
```

Changing commit from "" to "abb9f998469824499d2ac1c26234363c6b6a2a72"



---

archive/issue_comments_321234.json:
```json
{
    "body": "Changing author from \"\" to \"Malcolm Rupert\"",
    "created_at": "2015-05-25T21:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321234",
    "user": "https://trac.sagemath.org/admin/accounts/users/MRupert"
}
```

Changing author from "" to "Malcolm Rupert"



---

archive/issue_comments_321235.json:
```json
{
    "body": "<a id='comment:3'></a>Can you replace\n\n```\nif p == \"infinity\":\n    return self.is_definite()\nelse:\n    ...\n```\nby\n\n```\nif p == Infinity:\n    return self.is_definite()\n\n...\n```\nThis means you don't need to indent the whole block for `p` a prime number and I also prefer the actual value `Infinity` (which needs to be imported from `sage.rings.infinity`) instead of the string `\"infinity\"`.\n\nI also don't understand why you use `-1` at one point and `\"infinity\"` somewhere else.\n\nAnd instead of writing\n\n```\n(-1)**(m*(m-1)/2)) ## Actually, this -1 is the Hilbert symbol (-1,-1)\n```\nwhy don't you actually write\n\n```\nhilbert_symbol(-1, -1, p)**(m*(m-1)/2))\n```",
    "created_at": "2015-06-09T17:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321235",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Can you replace

```
if p == "infinity":
    return self.is_definite()
else:
    ...
```
by

```
if p == Infinity:
    return self.is_definite()

...
```
This means you don't need to indent the whole block for `p` a prime number and I also prefer the actual value `Infinity` (which needs to be imported from `sage.rings.infinity`) instead of the string `"infinity"`.

I also don't understand why you use `-1` at one point and `"infinity"` somewhere else.

And instead of writing

```
(-1)**(m*(m-1)/2)) ## Actually, this -1 is the Hilbert symbol (-1,-1)
```
why don't you actually write

```
hilbert_symbol(-1, -1, p)**(m*(m-1)/2))
```



---

archive/issue_comments_321236.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-10T20:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321236",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321237.json:
```json
{
    "body": "Changing commit from \"abb9f998469824499d2ac1c26234363c6b6a2a72\" to \"fc968e3e33e64167ed1364fcf0331d1aa52d2077\"",
    "created_at": "2016-08-28T08:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321237",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "abb9f998469824499d2ac1c26234363c6b6a2a72" to "fc968e3e33e64167ed1364fcf0331d1aa52d2077"



---

archive/issue_comments_321238.json:
```json
{
    "body": "<a id='comment:5'></a>rebase and clean-up\n\n---\nNew commits:",
    "created_at": "2016-08-28T08:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321238",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>rebase and clean-up

---
New commits:



---

archive/issue_comments_321239.json:
```json
{
    "body": "Changing branch from \"u/MRupert/bug_in_is_hyperbolic\" to \"u/chapoton/18430\"",
    "created_at": "2016-08-28T08:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321239",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "u/MRupert/bug_in_is_hyperbolic" to "u/chapoton/18430"



---

archive/issue_comments_321240.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-28T08:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321240",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_051904.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-08-28T08:23:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18430#event-51904"
}
```



---

archive/issue_events_051905.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-04-02T20:17:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18430#event-51905"
}
```



---

archive/issue_events_051906.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-04-02T20:17:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18430#event-51906"
}
```



---

archive/issue_comments_321241.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-03T20:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321242.json:
```json
{
    "body": "Changing commit from \"fc968e3e33e64167ed1364fcf0331d1aa52d2077\" to \"7690f842f00d3e84b2b6e32c94ee62d924dae09d\"",
    "created_at": "2017-04-03T20:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321242",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fc968e3e33e64167ed1364fcf0331d1aa52d2077" to "7690f842f00d3e84b2b6e32c94ee62d924dae09d"



---

archive/issue_comments_321243.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [jdemeyer](#comment%3A3):\n> I also don't understand why you use `-1` at one point and `\"infinity\"` somewhere else.\n> \n> And instead of writing\n> \n> ```\n> (-1)**(m*(m-1)/2)) ## Actually, this -1 is the Hilbert symbol (-1,-1)\n> ```\n> why don't you actually write\n> \n> ```\n> hilbert_symbol(-1, -1, p)**(m*(m-1)/2))\n> ```\n\n\nI am pretty sure the former is (much) faster and the comment makes the simplification clear.",
    "created_at": "2017-04-03T21:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321243",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Replying to [jdemeyer](#comment%3A3):
> I also don't understand why you use `-1` at one point and `"infinity"` somewhere else.
> 
> And instead of writing
> 
> ```
> (-1)**(m*(m-1)/2)) ## Actually, this -1 is the Hilbert symbol (-1,-1)
> ```
> why don't you actually write
> 
> ```
> hilbert_symbol(-1, -1, p)**(m*(m-1)/2))
> ```


I am pretty sure the former is (much) faster and the comment makes the simplification clear.



---

archive/issue_comments_321244.json:
```json
{
    "body": "Changing commit from \"7690f842f00d3e84b2b6e32c94ee62d924dae09d\" to \"3231a6ddc00a7a4049d39ba5a2eacf1d2fdc7529\"",
    "created_at": "2017-04-04T19:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321244",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7690f842f00d3e84b2b6e32c94ee62d924dae09d" to "3231a6ddc00a7a4049d39ba5a2eacf1d2fdc7529"



---

archive/issue_comments_321245.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-04T19:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321245",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321246.json:
```json
{
    "body": "<a id='comment:11'></a>done",
    "created_at": "2017-04-04T19:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321246",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>done



---

archive/issue_comments_321247.json:
```json
{
    "body": "<a id='comment:12'></a>ping ?",
    "created_at": "2017-06-02T06:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321247",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>ping ?



---

archive/issue_comments_321248.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\"",
    "created_at": "2017-06-03T00:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321248",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Frédéric Chapoton, Travis Scrimshaw"



---

archive/issue_comments_321249.json:
```json
{
    "body": "<a id='comment:13'></a>If you just fix up this `INPUT:` docstring (in a few places):\n\n```diff\n-`p` -- a prime number > 0 or `-1` for the infinite place.\n+- `p` -- a prime number > 0 or `-1` for the infinite place\n```\nOnce that is done, you can set a positive review on my behalf.",
    "created_at": "2017-06-03T00:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321249",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>If you just fix up this `INPUT:` docstring (in a few places):

```diff
-`p` -- a prime number > 0 or `-1` for the infinite place.
+- `p` -- a prime number > 0 or `-1` for the infinite place
```
Once that is done, you can set a positive review on my behalf.



---

archive/issue_comments_321250.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-05T21:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321250",
    "user": "https://trac.sagemath.org/admin/accounts/users/pmercuri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321251.json:
```json
{
    "body": "Changing work_issues from \"\" to \"documentation formatting\"",
    "created_at": "2017-06-05T21:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321251",
    "user": "https://trac.sagemath.org/admin/accounts/users/pmercuri"
}
```

Changing work_issues from "" to "documentation formatting"



---

archive/issue_comments_321252.json:
```json
{
    "body": "Changing commit from \"3231a6ddc00a7a4049d39ba5a2eacf1d2fdc7529\" to \"f99393fc110ed6c5f59136717d5fbf1c69c6c7bd\"",
    "created_at": "2017-06-07T12:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321252",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3231a6ddc00a7a4049d39ba5a2eacf1d2fdc7529" to "f99393fc110ed6c5f59136717d5fbf1c69c6c7bd"



---

archive/issue_comments_321253.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-07T12:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321253",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321254.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-07T12:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321254",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321255.json:
```json
{
    "body": "Changing work_issues from \"documentation formatting\" to \"\"",
    "created_at": "2017-06-07T12:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321255",
    "user": "https://github.com/fchapoton"
}
```

Changing work_issues from "documentation formatting" to ""



---

archive/issue_comments_321256.json:
```json
{
    "body": "<a id='comment:17'></a>LGTM.",
    "created_at": "2017-06-07T13:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321256",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>LGTM.



---

archive/issue_comments_321257.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-07T13:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321257",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_051907.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-09T18:38:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18430#event-51907"
}
```



---

archive/issue_comments_321258.json:
```json
{
    "body": "Changing branch from \"u/chapoton/18430\" to \"f99393fc110ed6c5f59136717d5fbf1c69c6c7bd\"",
    "created_at": "2017-06-09T18:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321258",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/chapoton/18430" to "f99393fc110ed6c5f59136717d5fbf1c69c6c7bd"



---

archive/issue_comments_321259.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-09T18:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18430#issuecomment-321259",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
