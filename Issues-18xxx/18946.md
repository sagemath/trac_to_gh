# Issue 18946: unweighted matroid intersection using blocking flow approach

archive/issues_018709.json:
```json
{
    "body": "Implement a unweighted matroid intersection algorithm that uses O(sqrt(p)rn) independence queries by adopting a blocking flow like technique, where r is the rank, p is the size of the maximum common independent set. \nIt is a bit better than the augmenting paths algorithm, which takes O(prn) queries. However, it's expected to perform worse when p is small, since the constant overhead is a bit larger.\n\nWilliam H Cunningham. 1986. Improved bounds for matroid partition and intersection algorithms. SIAM J. Comput. 15, 4 (November 1986), 948-957. DOI=10.1137/0215066 http://dx.doi.org/10.1137/0215066\n\nCC:  stefan yomcat rudi\n\nReviewer: Stefan van Zwam\n\nAuthor: Chao Xu\n\nBranch: 37f2c3bf0ac81d4e422bdcdb5f2ede05c512cab8\n\nCommit: 37f2c3bf0ac81d4e422bdcdb5f2ede05c512cab8\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18946\n\n",
    "closed_at": "2015-09-14T18:59:40Z",
    "created_at": "2015-07-24T03:47:00Z",
    "labels": [
        "component: matroid theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "unweighted matroid intersection using blocking flow approach",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18946",
    "user": "https://github.com/chaoxu"
}
```
Implement a unweighted matroid intersection algorithm that uses O(sqrt(p)rn) independence queries by adopting a blocking flow like technique, where r is the rank, p is the size of the maximum common independent set. 
It is a bit better than the augmenting paths algorithm, which takes O(prn) queries. However, it's expected to perform worse when p is small, since the constant overhead is a bit larger.

William H Cunningham. 1986. Improved bounds for matroid partition and intersection algorithms. SIAM J. Comput. 15, 4 (November 1986), 948-957. DOI=10.1137/0215066 http://dx.doi.org/10.1137/0215066

CC:  stefan yomcat rudi

Reviewer: Stefan van Zwam

Author: Chao Xu

Branch: 37f2c3bf0ac81d4e422bdcdb5f2ede05c512cab8

Commit: 37f2c3bf0ac81d4e422bdcdb5f2ede05c512cab8

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18946





---

archive/issue_comments_255002.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-24T03:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_255003.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-24T03:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255003",
    "user": "https://github.com/chaoxu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_255004.json:
```json
{
    "body": "<a id='comment:3'></a>Here is a run time comparison if the maximum common independent set is large.\n\n```\nsage: M = Matroid(MatrixSpace(GF(2), 1000,1000).random_element())\nsage: N = Matroid(MatrixSpace(GF(2), 1000,1000).random_element())\nsage: %time len(M.intersection(N))\nCPU times: user 446 ms, sys: 2.05 ms, total: 448 ms\nWall time: 450 ms\n998\nsage: %time len(M._intersection_unweighted(N))\nCPU times: user 316 ms, sys: 569 us, total: 317 ms\nWall time: 317 ms\n998\n```\n\nI have done tests on random matroids and  `intersection(N)` seems to  `_intersection_unweighted(N)`. so far so good.",
    "created_at": "2015-07-24T03:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255004",
    "user": "https://github.com/chaoxu"
}
```

<a id='comment:3'></a>Here is a run time comparison if the maximum common independent set is large.

```
sage: M = Matroid(MatrixSpace(GF(2), 1000,1000).random_element())
sage: N = Matroid(MatrixSpace(GF(2), 1000,1000).random_element())
sage: %time len(M.intersection(N))
CPU times: user 446 ms, sys: 2.05 ms, total: 448 ms
Wall time: 450 ms
998
sage: %time len(M._intersection_unweighted(N))
CPU times: user 316 ms, sys: 569 us, total: 317 ms
Wall time: 317 ms
998
```

I have done tests on random matroids and  `intersection(N)` seems to  `_intersection_unweighted(N)`. so far so good.



---

archive/issue_events_052849.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2015-08-19T01:53:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "milestone": "sage-6.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18946#event-52849"
}
```



---

archive/issue_comments_255005.json:
```json
{
    "body": "<a id='comment:5'></a>The runtime seems to depend a lot on the type of matroid.\n\n```\nsage: M1 = Matroid(MatrixSpace(GF(2), 500, 2000).random_element())\nsage: M2 = Matroid(MatrixSpace(GF(3), 500, 2000).random_element())\nsage: %time X = M1.intersection(M2)\nCPU times: user 929 ms, sys: 122 ms, total: 1.05 s\nWall time: 1.05 s\nsage: %time X = M1._intersection_unweighted(M2)\nCPU times: user 332 ms, sys: 1.68 ms, total: 334 ms\nWall time: 334 ms\nsage: M1 = Matroid(MatrixSpace(GF(7), 500, 2000).random_element())\nsage: M2 = Matroid(MatrixSpace(GF(3), 500, 2000).random_element())\nsage: %time X = M1.intersection(M2)\nCPU times: user 37 s, sys: 201 ms, total: 37.2 s\nWall time: 37.2 s\nsage: %time X2 = M1._intersection_unweighted(M2)\nCPU times: user 5min 1s, sys: 217 ms, total: 5min 1s\nWall time: 5min 2s\n```\n\nYour method is not accessible to end users; mention it in the documentation of the intersection method. After adding that documentation (where you could say something like \"a method that might be faster, depending on the matroids involved\"), I would say it's good to go in",
    "created_at": "2015-08-20T22:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255005",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

<a id='comment:5'></a>The runtime seems to depend a lot on the type of matroid.

```
sage: M1 = Matroid(MatrixSpace(GF(2), 500, 2000).random_element())
sage: M2 = Matroid(MatrixSpace(GF(3), 500, 2000).random_element())
sage: %time X = M1.intersection(M2)
CPU times: user 929 ms, sys: 122 ms, total: 1.05 s
Wall time: 1.05 s
sage: %time X = M1._intersection_unweighted(M2)
CPU times: user 332 ms, sys: 1.68 ms, total: 334 ms
Wall time: 334 ms
sage: M1 = Matroid(MatrixSpace(GF(7), 500, 2000).random_element())
sage: M2 = Matroid(MatrixSpace(GF(3), 500, 2000).random_element())
sage: %time X = M1.intersection(M2)
CPU times: user 37 s, sys: 201 ms, total: 37.2 s
Wall time: 37.2 s
sage: %time X2 = M1._intersection_unweighted(M2)
CPU times: user 5min 1s, sys: 217 ms, total: 5min 1s
Wall time: 5min 2s
```

Your method is not accessible to end users; mention it in the documentation of the intersection method. After adding that documentation (where you could say something like "a method that might be faster, depending on the matroids involved"), I would say it's good to go in



---

archive/issue_comments_255006.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-20T22:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255006",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_255007.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-21T23:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255007",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_255008.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-21T23:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255008",
    "user": "https://github.com/chaoxu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_255009.json:
```json
{
    "body": "<a id='comment:8'></a>This is extremely strange. \nThere are 2 steps in the algorithm. First one is construct the level graph, then do many augmentation in a batch. \nThe bad running time comes from the \"construct the level graph\" in my code. I have no idea why is my version so much slower. (probably due to ordering of the elements, since it actually use fewer  `_closure()` tests)\n\nI replaced it with the one in `_intersection_augmentation()` and apparently solved this problem.\n\nThis update was done quickly, hence this probably need more testing.\n\n```\nsage: M1 = Matroid(MatrixSpace(GF(7), 500, 2000).random_element())\nsage: M2 = Matroid(MatrixSpace(GF(3), 500, 2000).random_element())\nsage: %time X = M1.intersection(M2)\nCPU times: user 44.6 s, sys: 481 ms, total: 45 s\nWall time: 45.3 s\nsage: %time X2 = M1._intersection_unweighted(M2)\nCPU times: user 39 s, sys: 52.2 ms, total: 39 s\nWall time: 37.2 s\nsage: M1 = Matroid(MatrixSpace(GF(2), 500, 2000).random_element())\nsage: M2 = Matroid(MatrixSpace(GF(2), 500, 2000).random_element())\nsage: %time X = M1.intersection(M2)\nCPU times: user 1.52 s, sys: 332 ms, total: 1.85 s\nWall time: 1.85 s\nsage: %time X2 = M1._intersection_unweighted(M2)\nCPU times: user 191 ms, sys: 2.93 ms, total: 194 ms\nWall time: 194 ms\n```",
    "created_at": "2015-08-21T23:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255009",
    "user": "https://github.com/chaoxu"
}
```

<a id='comment:8'></a>This is extremely strange. 
There are 2 steps in the algorithm. First one is construct the level graph, then do many augmentation in a batch. 
The bad running time comes from the "construct the level graph" in my code. I have no idea why is my version so much slower. (probably due to ordering of the elements, since it actually use fewer  `_closure()` tests)

I replaced it with the one in `_intersection_augmentation()` and apparently solved this problem.

This update was done quickly, hence this probably need more testing.

```
sage: M1 = Matroid(MatrixSpace(GF(7), 500, 2000).random_element())
sage: M2 = Matroid(MatrixSpace(GF(3), 500, 2000).random_element())
sage: %time X = M1.intersection(M2)
CPU times: user 44.6 s, sys: 481 ms, total: 45 s
Wall time: 45.3 s
sage: %time X2 = M1._intersection_unweighted(M2)
CPU times: user 39 s, sys: 52.2 ms, total: 39 s
Wall time: 37.2 s
sage: M1 = Matroid(MatrixSpace(GF(2), 500, 2000).random_element())
sage: M2 = Matroid(MatrixSpace(GF(2), 500, 2000).random_element())
sage: %time X = M1.intersection(M2)
CPU times: user 1.52 s, sys: 332 ms, total: 1.85 s
Wall time: 1.85 s
sage: %time X2 = M1._intersection_unweighted(M2)
CPU times: user 191 ms, sys: 2.93 ms, total: 194 ms
Wall time: 194 ms
```



---

archive/issue_comments_255010.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-02T15:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255010",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_255011.json:
```json
{
    "body": "<a id='comment:9'></a>I did a bunch of tests, and the output was always correct. Also, timing tests now show a consistent speedup. It's good to go in as far as I'm concerned!\n\n```\nsage: def test():\n    for i in xrange(1000):\n            M1 = Matroid(MatrixSpace(GF(7), 50, 2000).random_element())\n            M2 = Matroid(MatrixSpace(GF(3), 50, 2000).random_element())\n            X = M1.intersection(M2)\n....:         \nsage: %time test()\nCPU times: user 21min 49s, sys: 25.8 s, total: 22min 15s\nWall time: 22min 17s\nsage: def test2():\n    for i in xrange(1000):\n            M1 = Matroid(MatrixSpace(GF(7), 50, 2000).random_element())\n            M2 = Matroid(MatrixSpace(GF(3), 50, 2000).random_element())\n            X = M1._intersection_unweighted(M2)\n....:         \nsage: %time test2()\nCPU times: user 11min 43s, sys: 936 ms, total: 11min 44s\nWall time: 11min 44s\n```",
    "created_at": "2015-09-02T15:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255011",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

<a id='comment:9'></a>I did a bunch of tests, and the output was always correct. Also, timing tests now show a consistent speedup. It's good to go in as far as I'm concerned!

```
sage: def test():
    for i in xrange(1000):
            M1 = Matroid(MatrixSpace(GF(7), 50, 2000).random_element())
            M2 = Matroid(MatrixSpace(GF(3), 50, 2000).random_element())
            X = M1.intersection(M2)
....:         
sage: %time test()
CPU times: user 21min 49s, sys: 25.8 s, total: 22min 15s
Wall time: 22min 17s
sage: def test2():
    for i in xrange(1000):
            M1 = Matroid(MatrixSpace(GF(7), 50, 2000).random_element())
            M2 = Matroid(MatrixSpace(GF(3), 50, 2000).random_element())
            X = M1._intersection_unweighted(M2)
....:         
sage: %time test2()
CPU times: user 11min 43s, sys: 936 ms, total: 11min 44s
Wall time: 11min 44s
```



---

archive/issue_comments_255012.json:
```json
{
    "body": "<a id='comment:10'></a>Merge conflict, merge in latest beta",
    "created_at": "2015-09-04T18:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255012",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>Merge conflict, merge in latest beta



---

archive/issue_comments_255013.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-09-04T18:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255013",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_255014.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-04T23:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_255015.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-04T23:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255015",
    "user": "https://github.com/chaoxu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_255016.json:
```json
{
    "body": "<a id='comment:13'></a>I don't think that last merge went as planned. I can't get it to compile, and after a \"git trac try 18946\" typing \"git diff master\" gives a long list of changes unrelated to this ticket.",
    "created_at": "2015-09-11T15:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255016",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

<a id='comment:13'></a>I don't think that last merge went as planned. I can't get it to compile, and after a "git trac try 18946" typing "git diff master" gives a long list of changes unrelated to this ticket.



---

archive/issue_comments_255017.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-11T15:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255017",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_255018.json:
```json
{
    "body": "<a id='comment:16'></a>I tried to branch from the current develop, and made the same updates.\n\nThe code would look ok with \"git diff develop\".\nOr should I actually work with master?",
    "created_at": "2015-09-11T21:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255018",
    "user": "https://github.com/chaoxu"
}
```

<a id='comment:16'></a>I tried to branch from the current develop, and made the same updates.

The code would look ok with "git diff develop".
Or should I actually work with master?



---

archive/issue_comments_255019.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-09-11T21:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255019",
    "user": "https://github.com/chaoxu"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_255020.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-09-11T23:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255020",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_255021.json:
```json
{
    "body": "<a id='comment:17'></a>We typically work with the `develop` branch. If you work with `master`, chances are that when time comes to merge the ticket, it won't work. Basing the ready for review ticket on the latest Sage beta is the best way to assume that things will go OK.",
    "created_at": "2015-09-11T23:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255021",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>We typically work with the `develop` branch. If you work with `master`, chances are that when time comes to merge the ticket, it won't work. Basing the ready for review ticket on the latest Sage beta is the best way to assume that things will go OK.



---

archive/issue_comments_255022.json:
```json
{
    "body": "<a id='comment:18'></a>My bad, I was in a hurry and messed up between the two. Code looks fine and Sage builds and runs. Positive review!",
    "created_at": "2015-09-12T21:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255022",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

<a id='comment:18'></a>My bad, I was in a hurry and messed up between the two. Code looks fine and Sage builds and runs. Positive review!



---

archive/issue_comments_255023.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-12T21:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255023",
    "user": "https://trac.sagemath.org/admin/accounts/users/Stefan"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_255024.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-14T18:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18946#issuecomment-255024",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_052850.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-09-14T18:59:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18946",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18946#event-52850"
}
```
