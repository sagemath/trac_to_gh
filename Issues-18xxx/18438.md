# Issue 18438: Race between building and using python

archive/issues_018201.json:
```json
{
    "assignees": [
        "https://github.com/embray"
    ],
    "body": "I think what happened below is that the build system tried to use the sage-download-file script while Python was in the process of being installed. Rebuild works. We should probably use sage-native-execute python:\n\n```\nFound local metadata for ntl-6.2.1.p0\nAttempting to download package ntl-6.2.1.p0\nCould not find platform dependent libraries <exec_prefix>\nConsider setting $PYTHONHOME to <prefix>[:<exec_prefix>]\nTraceback (most recent call last):\n  File \"/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/bin/sage-download-file\", line 11, in <module>\n    import contextlib\n  File \"/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py\", line 4, in <module>\n    from functools import wraps\n  File \"/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/functools.py\", line 10, in <module>\n    from _functools import partial, reduce\nImportError: No module named _functools\nError: spkg file '/mnt/disk/home/buildslave-sage/slave/sage_git/build/upstream/ntl-6.2.1.tar.bz2' not found.\nThis shouldn't happen, it is a bug in the sage-spkg script.\n```\n\nKeywords: **random_fail**\n\nBranch/Commit: **[`d84bfb6`](https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390)**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Volker Braun, Erik Bray**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18438_\n\n",
    "closed_at": "2018-09-15T09:05:05Z",
    "created_at": "2015-05-18T08:15:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Race between building and using python",
    "type": "issue",
    "updated_at": "2018-09-15T09:05:05Z",
    "url": "https://github.com/sagemath/sage/issues/18438",
    "user": "https://github.com/vbraun"
}
```
I think what happened below is that the build system tried to use the sage-download-file script while Python was in the process of being installed. Rebuild works. We should probably use sage-native-execute python:

```
Found local metadata for ntl-6.2.1.p0
Attempting to download package ntl-6.2.1.p0
Could not find platform dependent libraries <exec_prefix>
Consider setting $PYTHONHOME to <prefix>[:<exec_prefix>]
Traceback (most recent call last):
  File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/bin/sage-download-file", line 11, in <module>
    import contextlib
  File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py", line 4, in <module>
    from functools import wraps
  File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/functools.py", line 10, in <module>
    from _functools import partial, reduce
ImportError: No module named _functools
Error: spkg file '/mnt/disk/home/buildslave-sage/slave/sage_git/build/upstream/ntl-6.2.1.tar.bz2' not found.
This shouldn't happen, it is a bug in the sage-spkg script.
```

Keywords: **random_fail**

Branch/Commit: **[`d84bfb6`](https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390)**

Reviewer: **Dima Pasechnik**

Author: **Volker Braun, Erik Bray**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/18438_





---

archive/issue_events_262047.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-18T08:15:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "milestone_number": null,
    "milestone_title": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262047"
}
```



---

archive/issue_events_262048.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-18T08:15:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262048"
}
```



---

archive/issue_events_262049.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-18T08:15:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262049"
}
```



---

archive/issue_events_262050.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-18T08:15:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262050"
}
```



---

archive/issue_comments_254225.json:
```json
{
    "body": "Branch: **[u/vbraun/race_between_building_and_using_python](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/race_between_building_and_using_python)**",
    "created_at": "2015-05-18T23:22:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254225",
    "user": "https://github.com/vbraun"
}
```

Branch: **[u/vbraun/race_between_building_and_using_python](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/race_between_building_and_using_python)**



---

archive/issue_comments_254226.json:
```json
{
    "body": "Commit: **[`7f5bbf9`](https://github.com/sagemath/sagetrac-mirror/commit/7f5bbf96e9e3eec11dcb6b1adbfaff8f3893fd29)**",
    "created_at": "2015-05-18T23:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254226",
    "user": "https://github.com/vbraun"
}
```

Commit: **[`7f5bbf9`](https://github.com/sagemath/sagetrac-mirror/commit/7f5bbf96e9e3eec11dcb6b1adbfaff8f3893fd29)**



---

archive/issue_comments_254227.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2015-05-18T23:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254227",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_comments_254228.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d5bbfc0dfe4db19694498a4254dfd51f65a0333b\">d5bbfc0</a></td><td><code>Merge #18417 into #18428</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e280943ca8d48c211b0b0119d77713b0c26c0cbf\">e280943</a></td><td><code>remove checksumming from sage-spkg</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aa24229765773f685f943943a768736da9e999a9\">aa24229</a></td><td><code>Do not ignor errors in sage-spkg</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/49aa3c5ddb0df89865383f84ab8ffa12a5a05551\">49aa3c5</a></td><td><code>Only download mirror list when needed</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fd0b5ec2bb7b0a4a4713769c8e505a83a1d030a0\">fd0b5ec</a></td><td><code>sage-spkg has to ignore some errors when building from scratch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/84c4620b8c2bf387e978a4bd876aedb127cf479f\">84c4620</a></td><td><code>Merge #18428 into #18438</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7f5bbf96e9e3eec11dcb6b1adbfaff8f3893fd29\">7f5bbf9</a></td><td><code>Always use the system python for sage-download-file</code></td></tr></table>\n",
    "created_at": "2015-05-18T23:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254228",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d5bbfc0dfe4db19694498a4254dfd51f65a0333b">d5bbfc0</a></td><td><code>Merge #18417 into #18428</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e280943ca8d48c211b0b0119d77713b0c26c0cbf">e280943</a></td><td><code>remove checksumming from sage-spkg</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aa24229765773f685f943943a768736da9e999a9">aa24229</a></td><td><code>Do not ignor errors in sage-spkg</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/49aa3c5ddb0df89865383f84ab8ffa12a5a05551">49aa3c5</a></td><td><code>Only download mirror list when needed</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fd0b5ec2bb7b0a4a4713769c8e505a83a1d030a0">fd0b5ec</a></td><td><code>sage-spkg has to ignore some errors when building from scratch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/84c4620b8c2bf387e978a4bd876aedb127cf479f">84c4620</a></td><td><code>Merge #18428 into #18438</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7f5bbf96e9e3eec11dcb6b1adbfaff8f3893fd29">7f5bbf9</a></td><td><code>Always use the system python for sage-download-file</code></td></tr></table>




---

archive/issue_comments_254229.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\n`sage-native-execute` doesn't get rid of the whole Sage environment, we need something slightly different here that keeps `SAGE_ROOT` but resets `PATH`. This is now named `sage-system-python`",
    "created_at": "2015-05-18T23:25:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254229",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:3" align="right">comment:3</div>

`sage-native-execute` doesn't get rid of the whole Sage environment, we need something slightly different here that keeps `SAGE_ROOT` but resets `PATH`. This is now named `sage-system-python`



---

archive/issue_comments_254230.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThere's way more necessary to use the system python! If you don't reset library paths and python search paths, you're setting yourself up for failure. #9386 is just some sh-style issues away from finalization and will provide proper environment reset tools, in a fairly efficient manner. Perhaps it's better to build on that? If you want to preserve SAGE_ROOT, you could remove it from the to-be-restored list, or set `export SAGE_SAVED_SAGE_ROOT=$SAGE_ROOT` (which means we should perhaps document a process to tweak restores).",
    "created_at": "2015-05-19T04:20:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254230",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

There's way more necessary to use the system python! If you don't reset library paths and python search paths, you're setting yourself up for failure. #9386 is just some sh-style issues away from finalization and will provide proper environment reset tools, in a fairly efficient manner. Perhaps it's better to build on that? If you want to preserve SAGE_ROOT, you could remove it from the to-be-restored list, or set `export SAGE_SAVED_SAGE_ROOT=$SAGE_ROOT` (which means we should perhaps document a process to tweak restores).



---

archive/issue_comments_254231.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWell if #9386 can be finished then that would be great... but it didn't appear to be that close.",
    "created_at": "2015-05-19T06:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254231",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:5" align="right">comment:5</div>

Well if #9386 can be finished then that would be great... but it didn't appear to be that close.



---

archive/issue_comments_254232.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nFrom experience I know that if you are going to run a different python, you'll have to set PYTHONPATH and PYTHONHOME to the appropiate (previous) values too. I ran into this problem with a start-up script (in python) for magma. It didn't use anything fancy from Python, but at some point my system python and sage python (or their c-libs) were sufficiently different that the sage python libraries (picked up via PYTHONPATH, which was normally unset on my system) prevented python from running successfully.",
    "created_at": "2015-05-20T15:17:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254232",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

From experience I know that if you are going to run a different python, you'll have to set PYTHONPATH and PYTHONHOME to the appropiate (previous) values too. I ran into this problem with a start-up script (in python) for magma. It didn't use anything fancy from Python, but at some point my system python and sage python (or their c-libs) were sufficiently different that the sage python libraries (picked up via PYTHONPATH, which was normally unset on my system) prevented python from running successfully.



---

archive/issue_comments_254233.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe system python ought to work without (=unset) PYTHONPATH/PYTHONHOME, which is what the sage-system-python script does. Of course in more complicated setups you'll need the right values...",
    "created_at": "2015-05-20T22:30:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254233",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

The system python ought to work without (=unset) PYTHONPATH/PYTHONHOME, which is what the sage-system-python script does. Of course in more complicated setups you'll need the right values...



---

archive/issue_comments_254234.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHere is another failure with more context:\n\n```\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fnmatch.py ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fork1.py ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_format.py ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fpformat.py ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fractions.pyFound local metadata for ntl-6.2.1.p0\nCould not find platform dependent libraries <exec_prefix>\nConsider setting $PYTHONHOME to <prefix>[:<exec_prefix>]\nTraceback (most recent call last):\n  File \"/mnt/disk/home/release/Sage/src/bin/sage-download-file\", line 11, in <module>\n    import contextlib\n  File \"/mnt/disk/home/release/Sage/local/lib/python2.7/contextlib.py\", line 4, in <module>\n    from functools import wraps\n  File \"/mnt/disk/home/release/Sage/local/lib/python2.7/functools.py\", line 10, in <module>\n    from _functools import partial, reduce\nImportError: No module named _functools\nMakefile:1260: recipe for target '/mnt/disk/home/release/Sage/local/var/lib/sage/installed/ntl-6.2.1.p0' failed\nmake[2]: *** [/mnt/disk/home/release/Sage/local/var/lib/sage/installed/ntl-6.2.1.p0] Error 1\nmake[2]: *** Waiting for unfinished jobs....\n ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_frozen.py ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_ftplib.py ...\nCompiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_funcattrs.py ...\n```",
    "created_at": "2015-06-28T12:46:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254234",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">comment:8</div>

Here is another failure with more context:

```
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fnmatch.py ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fork1.py ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_format.py ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fpformat.py ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_fractions.pyFound local metadata for ntl-6.2.1.p0
Could not find platform dependent libraries <exec_prefix>
Consider setting $PYTHONHOME to <prefix>[:<exec_prefix>]
Traceback (most recent call last):
  File "/mnt/disk/home/release/Sage/src/bin/sage-download-file", line 11, in <module>
    import contextlib
  File "/mnt/disk/home/release/Sage/local/lib/python2.7/contextlib.py", line 4, in <module>
    from functools import wraps
  File "/mnt/disk/home/release/Sage/local/lib/python2.7/functools.py", line 10, in <module>
    from _functools import partial, reduce
ImportError: No module named _functools
Makefile:1260: recipe for target '/mnt/disk/home/release/Sage/local/var/lib/sage/installed/ntl-6.2.1.p0' failed
make[2]: *** [/mnt/disk/home/release/Sage/local/var/lib/sage/installed/ntl-6.2.1.p0] Error 1
make[2]: *** Waiting for unfinished jobs....
 ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_frozen.py ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_ftplib.py ...
Compiling /mnt/disk/home/release/Sage/local/lib/python2.7/test/test_funcattrs.py ...
```



---

archive/issue_events_262051.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-30T12:00:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "milestone_number": null,
    "milestone_title": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262051"
}
```



---

archive/issue_events_262052.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-30T12:00:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262052"
}
```



---

archive/issue_comments_254235.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nSee also #26083 for a similar report with some additional context.  This has been becoming more common as we integrate more Python tools into `sage-spkg`.  I feel that long term `sage-spkg` should be rewritten entirely in Python, but even that would not completely fix this problem.  I agree with the general approach of preferring to use the system Python for the build system; otherwise trying to use tools in `$SAGE_LOCAL` to build `$SAGE_LOCAL` is destined to result in problems.",
    "created_at": "2018-08-30T12:00:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254235",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

See also #26083 for a similar report with some additional context.  This has been becoming more common as we integrate more Python tools into `sage-spkg`.  I feel that long term `sage-spkg` should be rewritten entirely in Python, but even that would not completely fix this problem.  I agree with the general approach of preferring to use the system Python for the build system; otherwise trying to use tools in `$SAGE_LOCAL` to build `$SAGE_LOCAL` is destined to result in problems.



---

archive/issue_events_262053.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-30T12:00:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262053"
}
```



---

archive/issue_events_262054.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-30T12:00:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262054"
}
```



---

archive/issue_events_262055.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T12:20:09Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "subject": "https://github.com/embray",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262055"
}
```



---

archive/issue_comments_254236.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThe original branch for this doesn't totally make sense anymore, but I'm testing out a new implementation (which is actually much simpler now that Sage doesn't set PYTHONPATH, PYTHONHOME, LD_LIBRARY_PATH, etc.)  But we also have more build scripts now that rely on Python so many of them also need to be updated.",
    "created_at": "2018-09-12T12:20:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254236",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

The original branch for this doesn't totally make sense anymore, but I'm testing out a new implementation (which is actually much simpler now that Sage doesn't set PYTHONPATH, PYTHONHOME, LD_LIBRARY_PATH, etc.)  But we also have more build scripts now that rely on Python so many of them also need to be updated.



---

archive/issue_comments_254237.json:
```json
{
    "body": "Changed author from **Volker Braun** to **Volker Braun, Erik Bray**",
    "created_at": "2018-09-12T12:30:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254237",
    "user": "https://github.com/embray"
}
```

Changed author from **Volker Braun** to **Volker Braun, Erik Bray**



---

archive/issue_comments_254238.json:
```json
{
    "body": "Changed commit from **[`7f5bbf9`](https://github.com/sagemath/sagetrac-mirror/commit/7f5bbf96e9e3eec11dcb6b1adbfaff8f3893fd29)** to **[`39fa363`](https://github.com/sagemath/sagetrac-mirror/commit/39fa36329240bae075cd6c0116ce5b493ab557c7)**",
    "created_at": "2018-09-12T12:30:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254238",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`7f5bbf9`](https://github.com/sagemath/sagetrac-mirror/commit/7f5bbf96e9e3eec11dcb6b1adbfaff8f3893fd29)** to **[`39fa363`](https://github.com/sagemath/sagetrac-mirror/commit/39fa36329240bae075cd6c0116ce5b493ab557c7)**



---

archive/issue_comments_254239.json:
```json
{
    "body": "Changed branch from **[u/vbraun/race_between_building_and_using_python](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/race_between_building_and_using_python)** to **[u/embray/ticket-18438](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-18438)**",
    "created_at": "2018-09-12T12:30:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254239",
    "user": "https://github.com/embray"
}
```

Changed branch from **[u/vbraun/race_between_building_and_using_python](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/race_between_building_and_using_python)** to **[u/embray/ticket-18438](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-18438)**



---

archive/issue_events_262056.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T12:30:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262056"
}
```



---

archive/issue_comments_254240.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI've tested this a few times now on a 16 core machine with different variations of `make -j` from 8 to 16, so there should have been a high likelihood of reproducing the problem (as I confirmed against the unmodified 8.4.beta4), but with this patch I did not have any problems, as expected.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39fa36329240bae075cd6c0116ce5b493ab557c7\">39fa363</a></td><td><code>Trac #18438: Always use system Python for build toolchain scripts written in</code></td></tr></table>\n",
    "created_at": "2018-09-12T12:30:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254240",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

I've tested this a few times now on a 16 core machine with different variations of `make -j` from 8 to 16, so there should have been a high likelihood of reproducing the problem (as I confirmed against the unmodified 8.4.beta4), but with this patch I did not have any problems, as expected.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39fa36329240bae075cd6c0116ce5b493ab557c7">39fa363</a></td><td><code>Trac #18438: Always use system Python for build toolchain scripts written in</code></td></tr></table>




---

archive/issue_comments_254241.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nHuh. I just tried this on a different system and ran into a teensy problem: It seems, for some reason, that `sage-pip-install` is now using the system pip rather than the one installed in Sage.  Which is odd because I deliberately did *not* update `sage-pip-install`.  It's *supposed* to use Sage's Python online.",
    "created_at": "2018-09-12T12:50:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254241",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

Huh. I just tried this on a different system and ran into a teensy problem: It seems, for some reason, that `sage-pip-install` is now using the system pip rather than the one installed in Sage.  Which is odd because I deliberately did *not* update `sage-pip-install`.  It's *supposed* to use Sage's Python online.



---

archive/issue_events_262057.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T12:50:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262057"
}
```



---

archive/issue_events_262058.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T12:50:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262058"
}
```



---

archive/issue_comments_254242.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e6c18f1697ae33c024a006443eb04715569fe701\">e6c18f1</a></td><td><code>Trac #18438: Ensure that sage-pip-install runs pip with Sage's Python</code></td></tr></table>\n",
    "created_at": "2018-09-12T13:07:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254242",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e6c18f1697ae33c024a006443eb04715569fe701">e6c18f1</a></td><td><code>Trac #18438: Ensure that sage-pip-install runs pip with Sage's Python</code></td></tr></table>




---

archive/issue_comments_254243.json:
```json
{
    "body": "Changed commit from **[`39fa363`](https://github.com/sagemath/sagetrac-mirror/commit/39fa36329240bae075cd6c0116ce5b493ab557c7)** to **[`e6c18f1`](https://github.com/sagemath/sagetrac-mirror/commit/e6c18f1697ae33c024a006443eb04715569fe701)**",
    "created_at": "2018-09-12T13:07:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254243",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`39fa363`](https://github.com/sagemath/sagetrac-mirror/commit/39fa36329240bae075cd6c0116ce5b493ab557c7)** to **[`e6c18f1`](https://github.com/sagemath/sagetrac-mirror/commit/e6c18f1697ae33c024a006443eb04715569fe701)**



---

archive/issue_events_262059.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T13:09:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262059"
}
```



---

archive/issue_events_262060.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T13:09:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262060"
}
```



---

archive/issue_comments_254244.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI'm not wild about the workaround in `sage-pip-install` and am open to other ideas.  On the other hand, maybe it's not all bad, as it really emphasizes and ensures that `sage-pip-install` is run with Sage's Python.",
    "created_at": "2018-09-12T13:09:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254244",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

I'm not wild about the workaround in `sage-pip-install` and am open to other ideas.  On the other hand, maybe it's not all bad, as it really emphasizes and ensures that `sage-pip-install` is run with Sage's Python.



---

archive/issue_comments_254245.json:
```json
{
    "body": "Changed commit from **[`e6c18f1`](https://github.com/sagemath/sagetrac-mirror/commit/e6c18f1697ae33c024a006443eb04715569fe701)** to **[`ddafa36`](https://github.com/sagemath/sagetrac-mirror/commit/ddafa36338450833a5cdd86eb3fecb16ad0bff0e)**",
    "created_at": "2018-09-12T13:12:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254245",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`e6c18f1`](https://github.com/sagemath/sagetrac-mirror/commit/e6c18f1697ae33c024a006443eb04715569fe701)** to **[`ddafa36`](https://github.com/sagemath/sagetrac-mirror/commit/ddafa36338450833a5cdd86eb3fecb16ad0bff0e)**



---

archive/issue_comments_254246.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ddafa36338450833a5cdd86eb3fecb16ad0bff0e\">ddafa36</a></td><td><code>Trac #18438: Always use system Python for build toolchain scripts written in</code></td></tr></table>\n",
    "created_at": "2018-09-12T13:12:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254246",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ddafa36338450833a5cdd86eb3fecb16ad0bff0e">ddafa36</a></td><td><code>Trac #18438: Always use system Python for build toolchain scripts written in</code></td></tr></table>




---

archive/issue_comments_254247.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\n(Decided to squash to a single commit)",
    "created_at": "2018-09-12T13:13:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254247",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

(Decided to squash to a single commit)



---

archive/issue_events_262061.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T13:37:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262061"
}
```



---

archive/issue_events_262062.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T13:37:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262062"
}
```



---

archive/issue_comments_254248.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThe `sage-flock` thing still causes things to break when installing cypari.  Not sure why I never had this problem in earlier testing.  Maybe I already had `$SAGE_LOCAL` on my `$PATH` to start with for some reason.",
    "created_at": "2018-09-12T13:37:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254248",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

The `sage-flock` thing still causes things to break when installing cypari.  Not sure why I never had this problem in earlier testing.  Maybe I already had `$SAGE_LOCAL` on my `$PATH` to start with for some reason.



---

archive/issue_comments_254249.json:
```json
{
    "body": "Changed commit from **[`ddafa36`](https://github.com/sagemath/sagetrac-mirror/commit/ddafa36338450833a5cdd86eb3fecb16ad0bff0e)** to **[`d84bfb6`](https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390)**",
    "created_at": "2018-09-12T14:22:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254249",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ddafa36`](https://github.com/sagemath/sagetrac-mirror/commit/ddafa36338450833a5cdd86eb3fecb16ad0bff0e)** to **[`d84bfb6`](https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390)**



---

archive/issue_comments_254250.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390\">d84bfb6</a></td><td><code>Trac #18438: A different take on sage-system-python</code></td></tr></table>\n",
    "created_at": "2018-09-12T14:22:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254250",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390">d84bfb6</a></td><td><code>Trac #18438: A different take on sage-system-python</code></td></tr></table>




---

archive/issue_comments_254251.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI think this is a better middle-ground.  It make sure to run the system Python, but otherwise keeps Sage's `$PATH` configuration.\n\nIf/when this has otherwise positive review I'll squash the commits again.",
    "created_at": "2018-09-12T14:24:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254251",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

I think this is a better middle-ground.  It make sure to run the system Python, but otherwise keeps Sage's `$PATH` configuration.

If/when this has otherwise positive review I'll squash the commits again.



---

archive/issue_events_262063.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T14:24:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262063"
}
```



---

archive/issue_events_262064.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-12T14:24:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262064"
}
```



---

archive/issue_comments_254252.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2018-09-14T09:13:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254252",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_254253.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nlooks good to me.",
    "created_at": "2018-09-14T09:13:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254253",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:20" align="right">comment:20</div>

looks good to me.



---

archive/issue_events_262065.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-09-14T09:13:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262065"
}
```



---

archive/issue_events_262066.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-09-14T09:13:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262066"
}
```



---

archive/issue_comments_254254.json:
```json
{
    "body": "Changed branch from **[u/embray/ticket-18438](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-18438)** to **[`d84bfb6`](https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390)**",
    "created_at": "2018-09-15T09:05:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18438#issuecomment-254254",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/ticket-18438](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-18438)** to **[`d84bfb6`](https://github.com/sagemath/sagetrac-mirror/commit/d84bfb620292949c4b84d10baf15e45888a6a390)**



---

archive/issue_events_262067.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-15T09:05:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262067"
}
```



---

archive/issue_events_262068.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "b01215c1600554db0a80222b7498c26bce56d9dd",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-09-15T09:05:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18438",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18438#event-262068"
}
```
