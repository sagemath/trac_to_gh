# Issue 18076: Coercion for numpy types

archive/issues_017839.json:
```json
{
    "body": "Plenty of bugs have been reported for the interaction with numpy:\n- #8426: polynomial * constant does not work if constant is a numpy type\n- #8949: symbolic functions dont work with numpy.int32\n- #9769: symbolic function do not work with numpy.int64 arguments\n- #13386: comparison of Sage integer with Numpy integer\n- #15695: Coercion problems between numpy and sage floats\n- #17758: Intervals and numpy floats do not compare correctly\n- #17865: get rid of _native_coercion_ranks_inv and _native_coercion_ranks\n\nWe solve them all by defining coercions of numpy integers to `ZZ`, numpy floating to `RDF` and numpy complex floating to `CDF`. Also, coercion between numerical types (in `sage.structure.coerce`) are now done directly via the addition. In particular, all of this used to fail\n\n```\nsage: import numpy\n\nsage: f(t) = t^2\nsage: f(numpy.int32('1'))\n1\n\nsage: sin(numpy.int32(10))\nsin(10)\n\nsage: 123 == numpy.int32(123)\nTrue\n\nsage: 1j + numpy.float(2)\n2.00000000000000 + 1.00000000000000*I\nsage: parent(_)\nComplex Field with 53 bits of precision\n\nsage: RIF(1) <= numpy.float64(2.0)\nTrue \n```\n\nSome of them depend on modifying some internal in numpy and will not be solved here:\n- #8824: Make it so that numpy datatypes are integrated into the coercion model\n\nAssignee: @videlec\n\nCC:  tmonteil\n\nKeywords: sd66\n\nBranch/Commit: 8b0cf3903f70460883cd4b8ba4ba90b0c30f7d8f\n\nReviewer: Jeroen Demeyer, Vincent Delecroix\n\nAuthor: Vincent Delecroix, Jeroen Demeyer\n\nDependencies: #18121\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18076\n\n",
    "closed_at": "2015-04-28T04:44:37Z",
    "created_at": "2015-03-28T00:03:04Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Coercion for numpy types",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18076",
    "user": "https://github.com/videlec"
}
```
Plenty of bugs have been reported for the interaction with numpy:
- #8426: polynomial * constant does not work if constant is a numpy type
- #8949: symbolic functions dont work with numpy.int32
- #9769: symbolic function do not work with numpy.int64 arguments
- #13386: comparison of Sage integer with Numpy integer
- #15695: Coercion problems between numpy and sage floats
- #17758: Intervals and numpy floats do not compare correctly
- #17865: get rid of _native_coercion_ranks_inv and _native_coercion_ranks

We solve them all by defining coercions of numpy integers to `ZZ`, numpy floating to `RDF` and numpy complex floating to `CDF`. Also, coercion between numerical types (in `sage.structure.coerce`) are now done directly via the addition. In particular, all of this used to fail

```
sage: import numpy

sage: f(t) = t^2
sage: f(numpy.int32('1'))
1

sage: sin(numpy.int32(10))
sin(10)

sage: 123 == numpy.int32(123)
True

sage: 1j + numpy.float(2)
2.00000000000000 + 1.00000000000000*I
sage: parent(_)
Complex Field with 53 bits of precision

sage: RIF(1) <= numpy.float64(2.0)
True 
```

Some of them depend on modifying some internal in numpy and will not be solved here:
- #8824: Make it so that numpy datatypes are integrated into the coercion model

Assignee: @videlec

CC:  tmonteil

Keywords: sd66

Branch/Commit: 8b0cf3903f70460883cd4b8ba4ba90b0c30f7d8f

Reviewer: Jeroen Demeyer, Vincent Delecroix

Author: Vincent Delecroix, Jeroen Demeyer

Dependencies: #18121

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18076





---

archive/issue_comments_254448.json:
```json
{
    "body": "Set assignee to @videlec.",
    "created_at": "2015-03-28T00:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254448",
    "user": "https://github.com/videlec"
}
```

Set assignee to @videlec.



---

archive/issue_comments_254449.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2015-03-28T11:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254449",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_254450.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -5,11 +5,12 @@\n - #13386: comparison of Sage integer with Numpy integer\n - #15695: Coercion problems between numpy and sage floats\n - #17758: Intervals and numpy floats do not compare correctly\n+- #17865: get rid of _native_coercion_ranks_inv and _native_coercion_ranks\n \n-We solve them all by defining coercions of numpy integers to \\`ZZ\\`, numpy floating to \\`RDF\\` and numpy complex floating to \\`CDF\\`.\n+We solve them all by defining coercions of numpy integers to \\`ZZ\\`, numpy floating to \\`RDF\\` and numpy complex floating to \\`CDF\\`. Also, coercion between numerical types (in \\`sage.structure.coerce\\`) are now done directly via the addition.\n \n Some of them depend on modifying some internal in numpy and will not be solved here:\n-- - #8824: Make it so that numpy datatypes are integrated into the coercion model\n+- #8824: Make it so that numpy datatypes are integrated into the coercion model\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-03-28T11:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254450",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -5,11 +5,12 @@
 - #13386: comparison of Sage integer with Numpy integer
 - #15695: Coercion problems between numpy and sage floats
 - #17758: Intervals and numpy floats do not compare correctly
+- #17865: get rid of _native_coercion_ranks_inv and _native_coercion_ranks
 
-We solve them all by defining coercions of numpy integers to \`ZZ\`, numpy floating to \`RDF\` and numpy complex floating to \`CDF\`.
+We solve them all by defining coercions of numpy integers to \`ZZ\`, numpy floating to \`RDF\` and numpy complex floating to \`CDF\`. Also, coercion between numerical types (in \`sage.structure.coerce\`) are now done directly via the addition.
 
 Some of them depend on modifying some internal in numpy and will not be solved here:
-- - #8824: Make it so that numpy datatypes are integrated into the coercion model
+- #8824: Make it so that numpy datatypes are integrated into the coercion model
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_254451.json:
```json
{
    "body": "<a id='comment:3'></a>Not so bad... got three problematic files\n\n```\nsage -t --long src/sage/plot/plot.py  # 2 doctests failed\nsage -t --long src/sage/plot/graphics.py  # 1 doctest failed\nsage -t --long src/doc/en/thematic_tutorials/numerical_sage/numpy.rst  # 1 doctest failed\n```",
    "created_at": "2015-03-28T20:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254451",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>Not so bad... got three problematic files

```
sage -t --long src/sage/plot/plot.py  # 2 doctests failed
sage -t --long src/sage/plot/graphics.py  # 1 doctest failed
sage -t --long src/doc/en/thematic_tutorials/numerical_sage/numpy.rst  # 1 doctest failed
```



---

archive/issue_comments_254452.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-28T21:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254452",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_254453.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-28T21:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254453",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_254454.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-28T21:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254454",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_254455.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-28T21:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254455",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_254456.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,38 @@\n+Plenty of bugs have been reported for the interaction with numpy:\n+- #8426: polynomial * constant does not work if constant is a numpy type\n+- #8949: symbolic functions dont work with numpy.int32\n+- #9769: symbolic function do not work with numpy.int64 arguments\n+- #13386: comparison of Sage integer with Numpy integer\n+- #15695: Coercion problems between numpy and sage floats\n+- #17758: Intervals and numpy floats do not compare correctly\n+- #17865: get rid of _native_coercion_ranks_inv and _native_coercion_ranks\n \n+We solve them all by defining coercions of numpy integers to \\`ZZ\\`, numpy floating to \\`RDF\\` and numpy complex floating to \\`CDF\\`. Also, coercion between numerical types (in \\`sage.structure.coerce\\`) are now done directly via the addition. In particular, all of this used to fail\n+\n+\\`\\`\\`\n+sage: import numpy\n+\n+sage: f(t) = t^2\n+sage: f(numpy.int32('1'))\n+1\n+\n+sage: sin(numpy.int32(10))\n+sin(10)\n+\n+sage: 123 == numpy.int32(123)\n+True\n+\n+sage: 1j + numpy.float(2)\n+2.00000000000000 + 1.00000000000000*I\n+sage: parent(_)\n+Complex Field with 53 bits of precision\n+\n+sage: RIF(1) <= numpy.float64(2.0)\n+True \n+\\`\\`\\`\n+\n+Some of them depend on modifying some internal in numpy and will not be solved here:\n+- #8824: Make it so that numpy datatypes are integrated into the coercion model\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-03-30T16:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254456",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,38 @@
+Plenty of bugs have been reported for the interaction with numpy:
+- #8426: polynomial * constant does not work if constant is a numpy type
+- #8949: symbolic functions dont work with numpy.int32
+- #9769: symbolic function do not work with numpy.int64 arguments
+- #13386: comparison of Sage integer with Numpy integer
+- #15695: Coercion problems between numpy and sage floats
+- #17758: Intervals and numpy floats do not compare correctly
+- #17865: get rid of _native_coercion_ranks_inv and _native_coercion_ranks
 
+We solve them all by defining coercions of numpy integers to \`ZZ\`, numpy floating to \`RDF\` and numpy complex floating to \`CDF\`. Also, coercion between numerical types (in \`sage.structure.coerce\`) are now done directly via the addition. In particular, all of this used to fail
+
+\`\`\`
+sage: import numpy
+
+sage: f(t) = t^2
+sage: f(numpy.int32('1'))
+1
+
+sage: sin(numpy.int32(10))
+sin(10)
+
+sage: 123 == numpy.int32(123)
+True
+
+sage: 1j + numpy.float(2)
+2.00000000000000 + 1.00000000000000*I
+sage: parent(_)
+Complex Field with 53 bits of precision
+
+sage: RIF(1) <= numpy.float64(2.0)
+True 
+\`\`\`
+
+Some of them depend on modifying some internal in numpy and will not be solved here:
+- #8824: Make it so that numpy datatypes are integrated into the coercion model
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_254457.json:
```json
{
    "body": "<a id='comment:9'></a>3 failing doctests, see patchbot report",
    "created_at": "2015-03-31T18:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254457",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>3 failing doctests, see patchbot report



---

archive/issue_comments_254458.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-31T18:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254458",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_254459.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-31T19:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254459",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_254460.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 chapoton]:\n> 3 failing doctests, see patchbot report\n\n\nIs that all?",
    "created_at": "2015-03-31T19:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254460",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Replying to [comment:9 chapoton]:
> 3 failing doctests, see patchbot report


Is that all?



---

archive/issue_comments_254461.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-31T19:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254461",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254462.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-01T16:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254462",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_254463.json:
```json
{
    "body": "<a id='comment:13'></a>still one failing doctest, see patchbot report.\n\nD\u00e9sol\u00e9 de ne pas faire de commentaires plus constructifs, vraiment.",
    "created_at": "2015-04-01T16:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254463",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>still one failing doctest, see patchbot report.

Désolé de ne pas faire de commentaires plus constructifs, vraiment.



---

archive/issue_comments_254464.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-01T21:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_254465.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-01T21:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254465",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254466.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 chapoton]:\n> still one failing doctest, see patchbot report.\n> \n> D\u00e9sol\u00e9 de ne pas faire de commentaires plus constructifs, vraiment.\n\n\nDone!",
    "created_at": "2015-04-01T21:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254466",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:13 chapoton]:
> still one failing doctest, see patchbot report.
> 
> Désolé de ne pas faire de commentaires plus constructifs, vraiment.


Done!



---

archive/issue_comments_254467.json:
```json
{
    "body": "<a id='comment:16'></a>There is a incomplete trac number XYZ:\n\n```\n+ This used to fail (see :trac:`XYZ`)::\n```",
    "created_at": "2015-04-03T15:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254467",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:16'></a>There is a incomplete trac number XYZ:

```
+ This used to fail (see :trac:`XYZ`)::
```



---

archive/issue_comments_254468.json:
```json
{
    "body": "<a id='comment:17'></a>My intention is to make this depend on #18121.",
    "created_at": "2015-04-04T07:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254468",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>My intention is to make this depend on #18121.



---

archive/issue_comments_254469.json:
```json
{
    "body": "<a id='comment:20'></a>This looks wrong to me:\n\n```\nsage: numpy.int8('12') + 1/3\n12.333333333333334\n```\nWhy is the answer a float???\n\n---\nNew commits:",
    "created_at": "2015-04-07T10:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254469",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>This looks wrong to me:

```
sage: numpy.int8('12') + 1/3
12.333333333333334
```
Why is the answer a float???

---
New commits:



---

archive/issue_comments_254470.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-07T10:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254470",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_254471.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 jdemeyer]:\n> This looks wrong to me:\n> \n> ```\n> sage: numpy.int8('12') + 1/3\n> 12.333333333333334\n> ```\n> Why is the answer a float???\n\n\nThis is because the addition is handled by numpy and not by the rational. Simlarly\n\n```\nsage: import numpy\nsage: numpy.int64('1') + 1\n2\nsage: parent(_)\n<type 'numpy.int64'>\n```\nThere is a comment somewhere that this can be an upstream request.",
    "created_at": "2015-04-07T10:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254471",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>Replying to [comment:20 jdemeyer]:
> This looks wrong to me:
> 
> ```
> sage: numpy.int8('12') + 1/3
> 12.333333333333334
> ```
> Why is the answer a float???


This is because the addition is handled by numpy and not by the rational. Simlarly

```
sage: import numpy
sage: numpy.int64('1') + 1
2
sage: parent(_)
<type 'numpy.int64'>
```
There is a comment somewhere that this can be an upstream request.



---

archive/issue_comments_254472.json:
```json
{
    "body": "<a id='comment:22'></a>see also #8824",
    "created_at": "2015-04-07T10:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254472",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>see also #8824



---

archive/issue_comments_254473.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:21 vdelecroix]:\n> Replying to [comment:20 jdemeyer]:\n> > This looks wrong to me:\n> > \n> > ```\n> > sage: numpy.int8('12') + 1/3\n> > 12.333333333333334\n> > ```\n> > Why is the answer a float???\n\n> \n> This is because the addition is handled by numpy and not by the rational.\n\nI see. It doesn't use the Sage coercion framework at all.\n\nCould you clarify this in the docstring when you write this example?",
    "created_at": "2015-04-07T11:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254473",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Replying to [comment:21 vdelecroix]:
> Replying to [comment:20 jdemeyer]:
> > This looks wrong to me:
> > 
> > ```
> > sage: numpy.int8('12') + 1/3
> > 12.333333333333334
> > ```
> > Why is the answer a float???

> 
> This is because the addition is handled by numpy and not by the rational.

I see. It doesn't use the Sage coercion framework at all.

Could you clarify this in the docstring when you write this example?



---

archive/issue_comments_254474.json:
```json
{
    "body": "<a id='comment:24'></a>Could you please add doctests for all the tickets you're marking as duplicate of this one? For example, there is no doctest for #8949.",
    "created_at": "2015-04-07T11:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254474",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Could you please add doctests for all the tickets you're marking as duplicate of this one? For example, there is no doctest for #8949.



---

archive/issue_comments_254475.json:
```json
{
    "body": "<a id='comment:25'></a>New commits:",
    "created_at": "2015-04-07T11:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254475",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>New commits:



---

archive/issue_comments_254476.json:
```json
{
    "body": "Changing component from interfaces to coercion.",
    "created_at": "2015-04-07T11:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254476",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from interfaces to coercion.



---

archive/issue_comments_254477.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-07T12:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254477",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_254478.json:
```json
{
    "body": "<a id='comment:28'></a>Feel free to set this ticket back to needs_review (although somebody needs to review #18121 before this ticket can be formally reviewed).",
    "created_at": "2015-04-07T15:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254478",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>Feel free to set this ticket back to needs_review (although somebody needs to review #18121 before this ticket can be formally reviewed).



---

archive/issue_comments_254479.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-09T19:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254479",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254480.json:
```json
{
    "body": "<a id='comment:30'></a>Various conflicts, rebasing...",
    "created_at": "2015-04-22T08:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254480",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>Various conflicts, rebasing...



---

archive/issue_events_051282.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-22T08:24:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18076#event-51282"
}
```



---

archive/issue_comments_254481.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-22T08:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254481",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_254482.json:
```json
{
    "body": "<a id='comment:32'></a>New commits:",
    "created_at": "2015-04-22T09:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254482",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>New commits:



---

archive/issue_comments_254483.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-22T09:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254483",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254484.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-22T19:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254484",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_254485.json:
```json
{
    "body": "<a id='comment:33'></a>This is fine for me. And all test pass.\n\nVincent",
    "created_at": "2015-04-22T19:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254485",
    "user": "https://github.com/videlec"
}
```

<a id='comment:33'></a>This is fine for me. And all test pass.

Vincent



---

archive/issue_comments_254486.json:
```json
{
    "body": "<a id='comment:34'></a>Not so fast, I haven't actually reviewed all your changes.",
    "created_at": "2015-04-22T19:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254486",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Not so fast, I haven't actually reviewed all your changes.



---

archive/issue_comments_254487.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2015-04-22T19:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254487",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_254488.json:
```json
{
    "body": "<a id='comment:35'></a>My comments (all easy to fix):\n\n1. Conversion `numpy.floating` -> `QQ` should use `RR` directly, instead of `numpy.floating` -> `RDF` which then converts to `RR`.\n\n2. The reference to #15965 is wrong.\n\n3. In `src/sage/rings/real_double.pyx`, I would prefer to split up `if S is ZZ or S is QQ or S is RLF or (isinstance(S, RealField_class) and S.prec() >= 53)` in several cases, just like for `CDF` (in particular, if the precision is too small, we can return `None` immediately).\n\n4. Python considers `bool` a subclass of `int`, so\n\n```\nissubclass(py_type, int) or issubclass(py_type, long) or issubclass(py_type, bool)\n```\ncan be replaced by\n\n```\nissubclass(py_type, int) or issubclass(py_type, long)\n```\n\n5. In doctests, please replace `1jr` by the more natural `I` (unless you have a good reason to not do this)\n\n6. In `NumpyToSRMorphism.__init__`, could you raise a `TypeError` if `numpy_type` doesn't satisfy any of the `issubclass()` checks (and add a doctest for this case). Also, the second `if` should better be an `elif`.",
    "created_at": "2015-04-23T10:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254488",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>My comments (all easy to fix):

1. Conversion `numpy.floating` -> `QQ` should use `RR` directly, instead of `numpy.floating` -> `RDF` which then converts to `RR`.

2. The reference to #15965 is wrong.

3. In `src/sage/rings/real_double.pyx`, I would prefer to split up `if S is ZZ or S is QQ or S is RLF or (isinstance(S, RealField_class) and S.prec() >= 53)` in several cases, just like for `CDF` (in particular, if the precision is too small, we can return `None` immediately).

4. Python considers `bool` a subclass of `int`, so

```
issubclass(py_type, int) or issubclass(py_type, long) or issubclass(py_type, bool)
```
can be replaced by

```
issubclass(py_type, int) or issubclass(py_type, long)
```

5. In doctests, please replace `1jr` by the more natural `I` (unless you have a good reason to not do this)

6. In `NumpyToSRMorphism.__init__`, could you raise a `TypeError` if `numpy_type` doesn't satisfy any of the `issubclass()` checks (and add a doctest for this case). Also, the second `if` should better be an `elif`.



---

archive/issue_comments_254489.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-23T10:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254489",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_254490.json:
```json
{
    "body": "<a id='comment:37'></a>I'm also wondering if this check is really needed:\n\n```\nif ty != type(y + x):\n    raise RuntimeError(\"x + y and y + x have different types...\")\n```\n\nFirst of all, I cannot find any case where this happens. Second, even if it does happen, would it really be a problem?",
    "created_at": "2015-04-23T10:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254490",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>I'm also wondering if this check is really needed:

```
if ty != type(y + x):
    raise RuntimeError("x + y and y + x have different types...")
```

First of all, I cannot find any case where this happens. Second, even if it does happen, would it really be a problem?



---

archive/issue_comments_254491.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 jdemeyer]:\n> I'm also wondering if this check is really needed:\n> \n> ```\n> if ty != type(y + x):\n>     raise RuntimeError(\"x + y and y + x have different types...\")\n> ```\n> \n> First of all, I cannot find any case where this happens. \n\n\n```\nsage: numpy.int16(1) + 1.0\n2.0\nsage: type(_)\n<type 'numpy.float64'>\nsage: 1.0 + numpy.int16(1)\n2.00000000000000\nsage: type(_)\n<type 'sage.rings.real_mpfr.RealNumber'>\n```\nBut the canonical coercion is fine since we do have a coercion from numpy types to real numbers.\n\n> Second, even if it does happen, would it really be a problem?\n\n\nI don't know. You would prefer that we get rid of it?\n\nVincent",
    "created_at": "2015-04-23T10:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254491",
    "user": "https://github.com/videlec"
}
```

<a id='comment:38'></a>Replying to [comment:37 jdemeyer]:
> I'm also wondering if this check is really needed:
> 
> ```
> if ty != type(y + x):
>     raise RuntimeError("x + y and y + x have different types...")
> ```
> 
> First of all, I cannot find any case where this happens. 


```
sage: numpy.int16(1) + 1.0
2.0
sage: type(_)
<type 'numpy.float64'>
sage: 1.0 + numpy.int16(1)
2.00000000000000
sage: type(_)
<type 'sage.rings.real_mpfr.RealNumber'>
```
But the canonical coercion is fine since we do have a coercion from numpy types to real numbers.

> Second, even if it does happen, would it really be a problem?


I don't know. You would prefer that we get rid of it?

Vincent



---

archive/issue_comments_254492.json:
```json
{
    "body": "<a id='comment:39'></a>New commits:",
    "created_at": "2015-04-23T11:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254492",
    "user": "https://github.com/videlec"
}
```

<a id='comment:39'></a>New commits:



---

archive/issue_comments_254493.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-23T11:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254493",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254494.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:38 vdelecroix]:\n> I don't know. You would prefer that we get rid of it?\n\nGiven that I see no reason to have the check, I'd rather remove it.\n\nI think you did your search-and-replace a bit too naive, this is a syntax error: `numpy.complex128(-2+.I)`",
    "created_at": "2015-04-23T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254494",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>Replying to [comment:38 vdelecroix]:
> I don't know. You would prefer that we get rid of it?

Given that I see no reason to have the check, I'd rather remove it.

I think you did your search-and-replace a bit too naive, this is a syntax error: `numpy.complex128(-2+.I)`



---

archive/issue_comments_254495.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-23T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254495",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_254496.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T11:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254496",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_254497.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-23T11:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254497",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254498.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-23T12:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254498",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_254499.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-04-25T03:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254499",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_254500.json:
```json
{
    "body": "<a id='comment:44'></a>On 32-bit:\n\n```\nsage -t --long src/sage/structure/coerce.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 334, in sage.structure.coerce.CoercionModel_cache_maps\nFailed example:\n    type(_)\nExpected:\n    <type 'numpy.int64'>\nGot:\n    <type 'numpy.int32'>\n**********************************************************************\n1 item had failures:\n   1 of  22 in sage.structure.coerce.CoercionModel_cache_maps\n    [272 tests, 1 failure, 0.41 s]\n```",
    "created_at": "2015-04-25T03:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254500",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:44'></a>On 32-bit:

```
sage -t --long src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 334, in sage.structure.coerce.CoercionModel_cache_maps
Failed example:
    type(_)
Expected:
    <type 'numpy.int64'>
Got:
    <type 'numpy.int32'>
**********************************************************************
1 item had failures:
   1 of  22 in sage.structure.coerce.CoercionModel_cache_maps
    [272 tests, 1 failure, 0.41 s]
```



---

archive/issue_comments_254501.json:
```json
{
    "body": "<a id='comment:46'></a>New commits:",
    "created_at": "2015-04-25T08:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254501",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>New commits:



---

archive/issue_comments_254502.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-25T08:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254502",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_254503.json:
```json
{
    "body": "<a id='comment:47'></a>It does not affect floating point?\n\n```\nsage: numpy.int8('12') + 1/3\n12.333333333333334\nsage: type(_)\n<type 'numpy.float64'>\n```",
    "created_at": "2015-04-25T09:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254503",
    "user": "https://github.com/videlec"
}
```

<a id='comment:47'></a>It does not affect floating point?

```
sage: numpy.int8('12') + 1/3
12.333333333333334
sage: type(_)
<type 'numpy.float64'>
```



---

archive/issue_comments_254504.json:
```json
{
    "body": "<a id='comment:48'></a>Let's assume that it's right...",
    "created_at": "2015-04-27T15:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254504",
    "user": "https://github.com/videlec"
}
```

<a id='comment:48'></a>Let's assume that it's right...



---

archive/issue_comments_254505.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-27T15:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254505",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_051283.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-28T04:44:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18076#event-51283"
}
```



---

archive/issue_comments_254506.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-28T04:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18076#issuecomment-254506",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
