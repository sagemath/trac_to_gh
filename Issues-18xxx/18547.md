# Issue 18547: Improve polynomial powering in positive characteristic

archive/issues_018310.json:
```json
{
    "body": "Before:\n\n```python\nsage: R.<x> = PolynomialRing(GF(5), sparse=True)\nsage: (1+x)^(5^10)\n... (hangs for ever)\n```\n\nAfter:\n\n```python\nsage: R.<x> = PolynomialRing(GF(5), sparse=True)\nsage: (1+x)^(5^10)\nx^9765625 + 1\n```\n\n**Notes.**\n1. I've tried to be careful with quite extensive tests not to slow down the computations for \"easy\" cases. This explains the threshold values in the code.\n2. This is related to #7253 and #12660. Though, there is another problem for non-sparse polynomials: Simply assigning the value and printing the polynomial take a very long time. Compare the timings for\n\n    ```python\n    sage: R.<x> = ZZ[]\n    sage: 1+x^5^10\n    x^9765625 + 1\n    ```\n    and \n\n    ```python\n    sage: R.<x> = GF(5)[]\n    sage: 1+x^5^10\n    x^9765625 + 1\n    ```\n    Thus for tickets #7253 and #12660 to be closed, it remains to handle this other problem, but this is not the purpose of this ticket.\n\n\n\n**Keywords:** polynomial, powering\n\n**Branch/Commit:** [41dd9054555eaaf7567fac4ec56d95d05b039daa](https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa)\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Bruno Grenet\n\nIssue created by migration from https://trac.sagemath.org/ticket/18547\n\n",
    "closed_at": "2015-09-07T21:34:55Z",
    "created_at": "2015-05-29T15:18:57Z",
    "labels": [
        "component: commutative algebra",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.9",
    "title": "Improve polynomial powering in positive characteristic",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/18547",
    "user": "https://github.com/bgrenet"
}
```
Before:

```python
sage: R.<x> = PolynomialRing(GF(5), sparse=True)
sage: (1+x)^(5^10)
... (hangs for ever)
```

After:

```python
sage: R.<x> = PolynomialRing(GF(5), sparse=True)
sage: (1+x)^(5^10)
x^9765625 + 1
```

**Notes.**
1. I've tried to be careful with quite extensive tests not to slow down the computations for "easy" cases. This explains the threshold values in the code.
2. This is related to #7253 and #12660. Though, there is another problem for non-sparse polynomials: Simply assigning the value and printing the polynomial take a very long time. Compare the timings for

    ```python
    sage: R.<x> = ZZ[]
    sage: 1+x^5^10
    x^9765625 + 1
    ```
    and 

    ```python
    sage: R.<x> = GF(5)[]
    sage: 1+x^5^10
    x^9765625 + 1
    ```
    Thus for tickets #7253 and #12660 to be closed, it remains to handle this other problem, but this is not the purpose of this ticket.



**Keywords:** polynomial, powering

**Branch/Commit:** [41dd9054555eaaf7567fac4ec56d95d05b039daa](https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa)

**Reviewer:** Jeroen Demeyer

**Author:** Bruno Grenet

Issue created by migration from https://trac.sagemath.org/ticket/18547





---

archive/issue_comments_259886.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb\">a8ecb3e</a></td><td><code>Special code for positive characteristic</code></td></tr></table>\n",
    "created_at": "2015-05-29T15:20:11Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259886",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb">a8ecb3e</a></td><td><code>Special code for positive characteristic</code></td></tr></table>




---

archive/issue_comments_259887.json:
```json
{
    "body": "**Commit:** [a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb](https://github.com/sagemath/sagetrac-mirror/commit/a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb)",
    "created_at": "2015-05-29T15:20:11Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259887",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb](https://github.com/sagemath/sagetrac-mirror/commit/a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb)



---

archive/issue_events_166745.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-05-29T15:20:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166745"
}
```



---

archive/issue_comments_259888.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8f4125bc4d368738cf734d023086c33bc9bf62df\">8f4125b</a></td><td><code>Typo in the doc</code></td></tr></table>\n",
    "created_at": "2015-05-29T15:26:21Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259888",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8f4125bc4d368738cf734d023086c33bc9bf62df">8f4125b</a></td><td><code>Typo in the doc</code></td></tr></table>




---

archive/issue_comments_259889.json:
```json
{
    "body": "**Changing commit** from \"[a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb](https://github.com/sagemath/sagetrac-mirror/commit/a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb)\" to \"[8f4125bc4d368738cf734d023086c33bc9bf62df](https://github.com/sagemath/sagetrac-mirror/commit/8f4125bc4d368738cf734d023086c33bc9bf62df)\".",
    "created_at": "2015-05-29T15:26:21Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb](https://github.com/sagemath/sagetrac-mirror/commit/a8ecb3e0c9e353370b2a3754a7d6fc46891da4cb)" to "[8f4125bc4d368738cf734d023086c33bc9bf62df](https://github.com/sagemath/sagetrac-mirror/commit/8f4125bc4d368738cf734d023086c33bc9bf62df)".



---

archive/issue_events_166746.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-29T19:31:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166746"
}
```



---

archive/issue_events_166747.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-29T19:31:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166747"
}
```



---

archive/issue_comments_259890.json:
```json
{
    "body": "<a id='comment:4'></a>\nYour added doctest still takes `# long time` (28s on my computer). You should shorten the test to take less than 1s: `5^8` instead of `5^10` would be better.",
    "created_at": "2015-05-29T19:31:03Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259890",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Your added doctest still takes `# long time` (28s on my computer). You should shorten the test to take less than 1s: `5^8` instead of `5^10` would be better.



---

archive/issue_comments_259891.json:
```json
{
    "body": "<a id='comment:5'></a>\nI don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...",
    "created_at": "2015-05-29T19:38:19Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259891",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...



---

archive/issue_comments_259892.json:
```json
{
    "body": "<a id='comment:6'></a>\nI think it does use the code.  But what's happening is that in the line\n\n```\n                return self.subs({x:x**(q*p)}) * self**r\n```\n`x**(q*p)` is taking (almost) all the time.  And this comes from the section of the code dealing with powers of the polynomial generator, in particular the line\n\n```\n            return self.parent()(v, check=False)\n```\nwhere `v` is defined in the previous line as\n\n```\n                v = [R.zero()]*right + [R.one()]\n```\nwith `R` being the base ring.  It just takes a long time to create a non-sparse polynomial of this size.",
    "created_at": "2015-05-30T09:18:07Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259892",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:6'></a>
I think it does use the code.  But what's happening is that in the line

```
                return self.subs({x:x**(q*p)}) * self**r
```
`x**(q*p)` is taking (almost) all the time.  And this comes from the section of the code dealing with powers of the polynomial generator, in particular the line

```
            return self.parent()(v, check=False)
```
where `v` is defined in the previous line as

```
                v = [R.zero()]*right + [R.one()]
```
with `R` being the base ring.  It just takes a long time to create a non-sparse polynomial of this size.



---

archive/issue_comments_259893.json:
```json
{
    "body": "**Changing commit** from \"[8f4125bc4d368738cf734d023086c33bc9bf62df](https://github.com/sagemath/sagetrac-mirror/commit/8f4125bc4d368738cf734d023086c33bc9bf62df)\" to \"[139ac601f9635d3f613613d2b0537964fe942028](https://github.com/sagemath/sagetrac-mirror/commit/139ac601f9635d3f613613d2b0537964fe942028)\".",
    "created_at": "2015-06-01T09:07:00Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259893",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8f4125bc4d368738cf734d023086c33bc9bf62df](https://github.com/sagemath/sagetrac-mirror/commit/8f4125bc4d368738cf734d023086c33bc9bf62df)" to "[139ac601f9635d3f613613d2b0537964fe942028](https://github.com/sagemath/sagetrac-mirror/commit/139ac601f9635d3f613613d2b0537964fe942028)".



---

archive/issue_comments_259894.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/139ac601f9635d3f613613d2b0537964fe942028\">139ac60</a></td><td><code>Correct doctest</code></td></tr></table>\n",
    "created_at": "2015-06-01T09:07:00Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259894",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/139ac601f9635d3f613613d2b0537964fe942028">139ac60</a></td><td><code>Correct doctest</code></td></tr></table>




---

archive/issue_comments_259895.json:
```json
{
    "body": "**Changing commit** from \"[139ac601f9635d3f613613d2b0537964fe942028](https://github.com/sagemath/sagetrac-mirror/commit/139ac601f9635d3f613613d2b0537964fe942028)\" to \"[3088973f9fadcd82960950ed3c8320886ae9ed77](https://github.com/sagemath/sagetrac-mirror/commit/3088973f9fadcd82960950ed3c8320886ae9ed77)\".",
    "created_at": "2015-06-01T09:45:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259895",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[139ac601f9635d3f613613d2b0537964fe942028](https://github.com/sagemath/sagetrac-mirror/commit/139ac601f9635d3f613613d2b0537964fe942028)" to "[3088973f9fadcd82960950ed3c8320886ae9ed77](https://github.com/sagemath/sagetrac-mirror/commit/3088973f9fadcd82960950ed3c8320886ae9ed77)".



---

archive/issue_comments_259896.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3088973f9fadcd82960950ed3c8320886ae9ed77\">3088973</a></td><td><code>Special code only works for field... of course!</code></td></tr></table>\n",
    "created_at": "2015-06-01T09:45:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259896",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3088973f9fadcd82960950ed3c8320886ae9ed77">3088973</a></td><td><code>Special code only works for field... of course!</code></td></tr></table>




---

archive/issue_comments_259897.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [jdemeyer](#comment%3A5):\n> I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...\n\n\nRight, because my doctest was wrong: The code is intended for sparse polynomials. I have not really been able yet to determine what is precisely going on for dense polynomial. Though, as indicated by [fwclarke](#comment%3A6) and mentioned in my note 2. in the description, there is another problem for dense polynomial, namely that creating a large polynomial over a finite field takes a very long time. It is not the purpose of this ticket to correct this, even though it should be corrected!\n\nThis patch thus improves the situation for *sparse polynomials only*. The code is indeed not used for dense polynomials over `Zmod(k)` for any `k` since specific code appears in `src/sage/rings/polynomial/polynomial_template.pxi` for this case.\n\n**Important note:** I forgot to test whether the base ring is a field, which is of course mandatory. I correct this mistake in my latest commit.",
    "created_at": "2015-06-01T09:50:30Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259897",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:9'></a>
Replying to [jdemeyer](#comment%3A5):
> I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...


Right, because my doctest was wrong: The code is intended for sparse polynomials. I have not really been able yet to determine what is precisely going on for dense polynomial. Though, as indicated by [fwclarke](#comment%3A6) and mentioned in my note 2. in the description, there is another problem for dense polynomial, namely that creating a large polynomial over a finite field takes a very long time. It is not the purpose of this ticket to correct this, even though it should be corrected!

This patch thus improves the situation for *sparse polynomials only*. The code is indeed not used for dense polynomials over `Zmod(k)` for any `k` since specific code appears in `src/sage/rings/polynomial/polynomial_template.pxi` for this case.

**Important note:** I forgot to test whether the base ring is a field, which is of course mandatory. I correct this mistake in my latest commit.



---

archive/issue_events_166748.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-06-01T09:50:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166748"
}
```



---

archive/issue_events_166749.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-06-01T09:50:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166749"
}
```



---

archive/issue_comments_259898.json:
```json
{
    "body": "<a id='comment:10'></a>\nYou added 3 cases here:\n\n```\nif self.parent().base_ring().is_finite():\n    return ...\nif self.parent().is_sparse():\n    ...\nelse:\n    ...\n```\nYou should add a doctest for each of these 3 cases (and perhaps replace the second `if` by `elif` for clarity).",
    "created_at": "2015-06-01T11:39:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259898",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
You added 3 cases here:

```
if self.parent().base_ring().is_finite():
    return ...
if self.parent().is_sparse():
    ...
else:
    ...
```
You should add a doctest for each of these 3 cases (and perhaps replace the second `if` by `elif` for clarity).



---

archive/issue_events_166750.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-01T11:39:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166750"
}
```



---

archive/issue_events_166751.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-01T11:39:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166751"
}
```



---

archive/issue_comments_259899.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [bruno](#comment%3A9):\n> **Important note:** I forgot to test whether the base ring is a field, which is of course mandatory.\n\nWhy is this \"of course\" mandatory? You need that the characteristic is a prime number, not that the base ring is a field.",
    "created_at": "2015-06-01T11:44:02Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259899",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [bruno](#comment%3A9):
> **Important note:** I forgot to test whether the base ring is a field, which is of course mandatory.

Why is this "of course" mandatory? You need that the characteristic is a prime number, not that the base ring is a field.



---

archive/issue_comments_259900.json:
```json
{
    "body": "**Changing commit** from \"[3088973f9fadcd82960950ed3c8320886ae9ed77](https://github.com/sagemath/sagetrac-mirror/commit/3088973f9fadcd82960950ed3c8320886ae9ed77)\" to \"[7760a4306328684b58752e095b84991c66a3996c](https://github.com/sagemath/sagetrac-mirror/commit/7760a4306328684b58752e095b84991c66a3996c)\".",
    "created_at": "2015-06-01T16:02:13Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259900",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[3088973f9fadcd82960950ed3c8320886ae9ed77](https://github.com/sagemath/sagetrac-mirror/commit/3088973f9fadcd82960950ed3c8320886ae9ed77)" to "[7760a4306328684b58752e095b84991c66a3996c](https://github.com/sagemath/sagetrac-mirror/commit/7760a4306328684b58752e095b84991c66a3996c)".



---

archive/issue_comments_259901.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7760a4306328684b58752e095b84991c66a3996c\">7760a43</a></td><td><code>Correct algorithm + adapted doctests</code></td></tr></table>\n",
    "created_at": "2015-06-01T16:02:13Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259901",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7760a4306328684b58752e095b84991c66a3996c">7760a43</a></td><td><code>Correct algorithm + adapted doctests</code></td></tr></table>




---

archive/issue_events_166752.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-06-01T16:12:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166752"
}
```



---

archive/issue_events_166753.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-06-01T16:12:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166753"
}
```



---

archive/issue_comments_259902.json:
```json
{
    "body": "<a id='comment:13'></a>\nThe algorithm I proposed was completely wrong: If `p` is the characteristic and `n=p * q + r`, I used the **wrong** identity `f(x)^n = f(x^{p*q}) * f(x)^r` instead of the correct `f(x)^n = f(x<sup>p)</sup>q * f(x)^r`. \n\nIn the commit, I correct this mistake, and in the same time I take [jdemeyer](#comment%3A10)'s comments into account:\n- I add doctests for the different possibilities. (Note that I wrote code for the case where the base ring is a finite field and the polynomials are in dense representation, though as I wrote [above](#comment%3A9) this code is not used since there is specific code in `polynomial_template.pxi`. Thus there is no doctest for this case.)\n- \"Of course\", it is not \"of course mandatory\" for the base ring to be a finite field...\n\nFurthermore, I improve the code not using `self.subs(...)`, but rather doing the computations myself.",
    "created_at": "2015-06-01T16:12:25Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259902",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:13'></a>
The algorithm I proposed was completely wrong: If `p` is the characteristic and `n=p * q + r`, I used the **wrong** identity `f(x)^n = f(x^{p*q}) * f(x)^r` instead of the correct `f(x)^n = f(x<sup>p)</sup>q * f(x)^r`. 

In the commit, I correct this mistake, and in the same time I take [jdemeyer](#comment%3A10)'s comments into account:
- I add doctests for the different possibilities. (Note that I wrote code for the case where the base ring is a finite field and the polynomials are in dense representation, though as I wrote [above](#comment%3A9) this code is not used since there is specific code in `polynomial_template.pxi`. Thus there is no doctest for this case.)
- "Of course", it is not "of course mandatory" for the base ring to be a finite field...

Furthermore, I improve the code not using `self.subs(...)`, but rather doing the computations myself.



---

archive/issue_events_166754.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-28T20:07:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166754"
}
```



---

archive/issue_events_166755.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-28T20:07:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166755"
}
```



---

archive/issue_comments_259903.json:
```json
{
    "body": "<a id='comment:14'></a>\nThere should be an empty line after\n\n```\nCheck that the algorithm used is indeed correct::\n```",
    "created_at": "2015-08-28T20:07:09Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259903",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:14'></a>
There should be an empty line after

```
Check that the algorithm used is indeed correct::
```



---

archive/issue_comments_259904.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/959947d37b22e0c806e5e2034760abdc10d967b6\">959947d</a></td><td><code>trac 18547: add missing empty line</code></td></tr></table>\n",
    "created_at": "2015-08-29T08:55:18Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259904",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/959947d37b22e0c806e5e2034760abdc10d967b6">959947d</a></td><td><code>trac 18547: add missing empty line</code></td></tr></table>




---

archive/issue_comments_259905.json:
```json
{
    "body": "**Changing commit** from \"[7760a4306328684b58752e095b84991c66a3996c](https://github.com/sagemath/sagetrac-mirror/commit/7760a4306328684b58752e095b84991c66a3996c)\" to \"[959947d37b22e0c806e5e2034760abdc10d967b6](https://github.com/sagemath/sagetrac-mirror/commit/959947d37b22e0c806e5e2034760abdc10d967b6)\".",
    "created_at": "2015-08-29T08:55:18Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259905",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7760a4306328684b58752e095b84991c66a3996c](https://github.com/sagemath/sagetrac-mirror/commit/7760a4306328684b58752e095b84991c66a3996c)" to "[959947d37b22e0c806e5e2034760abdc10d967b6](https://github.com/sagemath/sagetrac-mirror/commit/959947d37b22e0c806e5e2034760abdc10d967b6)".



---

archive/issue_comments_259906.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [chapoton](#comment%3A14):\n> There should be an empty line after\n> \n> ```\n> Check that the algorithm used is indeed correct::\n> ```\n\n\nDone!",
    "created_at": "2015-08-29T08:56:34Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259906",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:16'></a>
Replying to [chapoton](#comment%3A14):
> There should be an empty line after
> 
> ```
> Check that the algorithm used is indeed correct::
> ```


Done!



---

archive/issue_events_166756.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-08-29T08:56:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166756"
}
```



---

archive/issue_events_166757.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-08-29T08:56:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166757"
}
```



---

archive/issue_comments_259907.json:
```json
{
    "body": "<a id='comment:17'></a>\nI think this test is much too weak:\n\n```\nsage: R.<x> = PolynomialRing(GF(17), sparse=True)\nsage: for d in [17, 264, 516]:\n....: assert((1+x)^d == generic_power(1+x,d))\n```\n\n(but I'll wait to suggest a better test until I understand the code better).",
    "created_at": "2015-08-30T11:37:38Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259907",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
I think this test is much too weak:

```
sage: R.<x> = PolynomialRing(GF(17), sparse=True)
sage: for d in [17, 264, 516]:
....: assert((1+x)^d == generic_power(1+x,d))
```

(but I'll wait to suggest a better test until I understand the code better).



---

archive/issue_events_166758.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-08-30T11:38:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "milestone": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166758"
}
```



---

archive/issue_events_166759.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-08-30T11:38:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "milestone": "sage-6.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166759"
}
```



---

archive/issue_comments_259908.json:
```json
{
    "body": "<a id='comment:18'></a>\nPlease justify in the code why\n\n```\n# characteristic 2 is special\n```",
    "created_at": "2015-08-30T11:38:15Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259908",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Please justify in the code why

```
# characteristic 2 is special
```



---

archive/issue_events_166760.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-08-30T11:38:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166760"
}
```



---

archive/issue_events_166761.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-08-30T11:38:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166761"
}
```



---

archive/issue_comments_259909.json:
```json
{
    "body": "<a id='comment:19'></a>\nI suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.",
    "created_at": "2015-08-30T11:41:54Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259909",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.



---

archive/issue_comments_259910.json:
```json
{
    "body": "<a id='comment:20'></a>\nAnd I'm not too happy with this either:\n\n```\nself.base_ring().is_field()\n```\n\nChecking whether some complicated ring is a field might be an expensive operation. I prefer\n\n```\nself.base_ring() in IntegralDomains\n```",
    "created_at": "2015-08-30T11:47:58Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259910",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
And I'm not too happy with this either:

```
self.base_ring().is_field()
```

Checking whether some complicated ring is a field might be an expensive operation. I prefer

```
self.base_ring() in IntegralDomains
```



---

archive/issue_comments_259911.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7788e843acd44a6e23f16559589315cde131e4b5\">7788e84</a></td><td><code>Merge branch 'u/bruno/polynomial_powering_positive_characteristic' of git://trac.sagemath.org/sage into t18547_poly_power_positive_char</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a452c7471e57e0ae4ecaef43a68ce3c3b3b71a9\">3a452c7</a></td><td><code>trac 18547: characteristic 2 is not special</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a4965ccb5a4b03b5abcca65d0daeb4a96190a58\">5a4965c</a></td><td><code>trac 18547: is_field() replaced by in IntegralDomains</code></td></tr></table>\n",
    "created_at": "2015-08-31T12:55:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259911",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7788e843acd44a6e23f16559589315cde131e4b5">7788e84</a></td><td><code>Merge branch 'u/bruno/polynomial_powering_positive_characteristic' of git://trac.sagemath.org/sage into t18547_poly_power_positive_char</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a452c7471e57e0ae4ecaef43a68ce3c3b3b71a9">3a452c7</a></td><td><code>trac 18547: characteristic 2 is not special</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a4965ccb5a4b03b5abcca65d0daeb4a96190a58">5a4965c</a></td><td><code>trac 18547: is_field() replaced by in IntegralDomains</code></td></tr></table>




---

archive/issue_comments_259912.json:
```json
{
    "body": "**Changing commit** from \"[959947d37b22e0c806e5e2034760abdc10d967b6](https://github.com/sagemath/sagetrac-mirror/commit/959947d37b22e0c806e5e2034760abdc10d967b6)\" to \"[5a4965ccb5a4b03b5abcca65d0daeb4a96190a58](https://github.com/sagemath/sagetrac-mirror/commit/5a4965ccb5a4b03b5abcca65d0daeb4a96190a58)\".",
    "created_at": "2015-08-31T12:55:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259912",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[959947d37b22e0c806e5e2034760abdc10d967b6](https://github.com/sagemath/sagetrac-mirror/commit/959947d37b22e0c806e5e2034760abdc10d967b6)" to "[5a4965ccb5a4b03b5abcca65d0daeb4a96190a58](https://github.com/sagemath/sagetrac-mirror/commit/5a4965ccb5a4b03b5abcca65d0daeb4a96190a58)".



---

archive/issue_comments_259913.json:
```json
{
    "body": "<a id='comment:22'></a>\nI didn't say you had to remove this:\n\n```\nif ... or p.is_prime()\n```",
    "created_at": "2015-08-31T13:01:30Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259913",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
I didn't say you had to remove this:

```
if ... or p.is_prime()
```



---

archive/issue_comments_259914.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [jdemeyer](#comment%3A18):\n> Please justify in the code why\n> \n> ```\n> # characteristic 2 is special\n> ```\n\nI had run some tests and my conclusion that was using `generic_power` was faster in characteristic 2. (Note that binary exponentiation is well suited to this characteristic.) I am not able to reproduce this behavior though, so I removed the special case.\n\nReplying to [jdemeyer](#comment%3A20):\n> And I'm not too happy with this either:\n> \n> ```\n> self.base_ring().is_field()\n> ```\n> \n> Checking whether some complicated ring is a field might be an expensive operation. I prefer\n> \n> ```\n> self.base_ring() in IntegralDomains\n> ```\n\n\nDone.\n\nReplying to [jdemeyer](#comment%3A19):\n> I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.\n\n\nActually, the current code is faster for finite fields. With the special case:\n\n```python\nsage: R.<x> = PolynomialRing(GF(17),sparse=True)\nsage: p = R.random_element(100)\nsage: %timeit p^(17^5)\nThe slowest run took 11.13 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 159 \u00b5s per loop\n```\n\nWithout the special case, with the same `p`:\n\n```python\n%timeit p^(17^5)\nThe slowest run took 26.59 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 249 \u00b5s per loop\n```\n\nI may refactor the code though so that it is less redundant. Tell me what you think.\n\nReplying to [jdemeyer](#comment%3A17):\n> I think this test is much too weak\n\nI am happy if you find a good way to test this function!",
    "created_at": "2015-08-31T13:04:18Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259914",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:23'></a>
Replying to [jdemeyer](#comment%3A18):
> Please justify in the code why
> 
> ```
> # characteristic 2 is special
> ```

I had run some tests and my conclusion that was using `generic_power` was faster in characteristic 2. (Note that binary exponentiation is well suited to this characteristic.) I am not able to reproduce this behavior though, so I removed the special case.

Replying to [jdemeyer](#comment%3A20):
> And I'm not too happy with this either:
> 
> ```
> self.base_ring().is_field()
> ```
> 
> Checking whether some complicated ring is a field might be an expensive operation. I prefer
> 
> ```
> self.base_ring() in IntegralDomains
> ```


Done.

Replying to [jdemeyer](#comment%3A19):
> I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.


Actually, the current code is faster for finite fields. With the special case:

```python
sage: R.<x> = PolynomialRing(GF(17),sparse=True)
sage: p = R.random_element(100)
sage: %timeit p^(17^5)
The slowest run took 11.13 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 159 µs per loop
```

Without the special case, with the same `p`:

```python
%timeit p^(17^5)
The slowest run took 26.59 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 249 µs per loop
```

I may refactor the code though so that it is less redundant. Tell me what you think.

Replying to [jdemeyer](#comment%3A17):
> I think this test is much too weak

I am happy if you find a good way to test this function!



---

archive/issue_comments_259915.json:
```json
{
    "body": "**Changing commit** from \"[5a4965ccb5a4b03b5abcca65d0daeb4a96190a58](https://github.com/sagemath/sagetrac-mirror/commit/5a4965ccb5a4b03b5abcca65d0daeb4a96190a58)\" to \"[ba484dfa38afe24d10d2df1927e5a301e8a13dd0](https://github.com/sagemath/sagetrac-mirror/commit/ba484dfa38afe24d10d2df1927e5a301e8a13dd0)\".",
    "created_at": "2015-08-31T13:06:06Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259915",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5a4965ccb5a4b03b5abcca65d0daeb4a96190a58](https://github.com/sagemath/sagetrac-mirror/commit/5a4965ccb5a4b03b5abcca65d0daeb4a96190a58)" to "[ba484dfa38afe24d10d2df1927e5a301e8a13dd0](https://github.com/sagemath/sagetrac-mirror/commit/ba484dfa38afe24d10d2df1927e5a301e8a13dd0)".



---

archive/issue_comments_259916.json:
```json
{
    "body": "<a id='comment:24'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ba484dfa38afe24d10d2df1927e5a301e8a13dd0\">ba484df</a></td><td><code>trac 18547: restore is_prime(), previously removed as an error</code></td></tr></table>\n",
    "created_at": "2015-08-31T13:06:06Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259916",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ba484dfa38afe24d10d2df1927e5a301e8a13dd0">ba484df</a></td><td><code>trac 18547: restore is_prime(), previously removed as an error</code></td></tr></table>




---

archive/issue_comments_259917.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [jdemeyer](#comment%3A22):\n> I didn't say you had to remove this:\n> \n> ```\n> if ... or p.is_prime()\n> ```\n\n\nRight, my mistake!",
    "created_at": "2015-08-31T13:06:48Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259917",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:25'></a>
Replying to [jdemeyer](#comment%3A22):
> I didn't say you had to remove this:
> 
> ```
> if ... or p.is_prime()
> ```


Right, my mistake!



---

archive/issue_events_166762.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-08-31T13:06:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166762"
}
```



---

archive/issue_events_166763.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-08-31T13:06:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166763"
}
```



---

archive/issue_events_166764.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-09-01T08:19:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166764"
}
```



---

archive/issue_events_166765.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-09-01T08:19:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166765"
}
```



---

archive/issue_comments_259918.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [bruno](#comment%3A23):\n> I am happy if you find a good way to test this function!\n\nYou have many cases and they should all be tested:\n\n```\nsage: R1 = PolynomialRing(GF(8, 'a'), 'x')\nsage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)\nsage: R3 = PolynomialRing(R2, 'y')\nsage: R4 = PolynomialRing(R1, 'y', sparse=True)\nsage: for d in range(40):  # long time\n....:     for R in [R1, R2, R3, R4]:\n....:         a = R.random_element()\n....:         assert a^d == generic_power(a, d)\n```",
    "created_at": "2015-09-01T08:19:19Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259918",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Replying to [bruno](#comment%3A23):
> I am happy if you find a good way to test this function!

You have many cases and they should all be tested:

```
sage: R1 = PolynomialRing(GF(8, 'a'), 'x')
sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)
sage: R3 = PolynomialRing(R2, 'y')
sage: R4 = PolynomialRing(R1, 'y', sparse=True)
sage: for d in range(40):  # long time
....:     for R in [R1, R2, R3, R4]:
....:         a = R.random_element()
....:         assert a^d == generic_power(a, d)
```



---

archive/issue_comments_259919.json:
```json
{
    "body": "**Changing commit** from \"[ba484dfa38afe24d10d2df1927e5a301e8a13dd0](https://github.com/sagemath/sagetrac-mirror/commit/ba484dfa38afe24d10d2df1927e5a301e8a13dd0)\" to \"[41dd9054555eaaf7567fac4ec56d95d05b039daa](https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa)\".",
    "created_at": "2015-09-01T13:38:05Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259919",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ba484dfa38afe24d10d2df1927e5a301e8a13dd0](https://github.com/sagemath/sagetrac-mirror/commit/ba484dfa38afe24d10d2df1927e5a301e8a13dd0)" to "[41dd9054555eaaf7567fac4ec56d95d05b039daa](https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa)".



---

archive/issue_comments_259920.json:
```json
{
    "body": "<a id='comment:27'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e8d11a6e71684531def6fef495caed30a6584800\">e8d11a6</a></td><td><code>Trac 18547: better doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa\">41dd905</a></td><td><code>Trac 18547: Refactor and correct code</code></td></tr></table>\n",
    "created_at": "2015-09-01T13:38:05Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259920",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e8d11a6e71684531def6fef495caed30a6584800">e8d11a6</a></td><td><code>Trac 18547: better doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa">41dd905</a></td><td><code>Trac 18547: Refactor and correct code</code></td></tr></table>




---

archive/issue_comments_259921.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [jdemeyer](#comment%3A26):\n> Replying to [bruno](#comment%3A23):\n> > I am happy if you find a good way to test this function!\n\n> You have many cases and they should all be tested:\n> \n> ```\n> sage: R1 = PolynomialRing(GF(8, 'a'), 'x')\n> sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)\n> sage: R3 = PolynomialRing(R2, 'y')\n> sage: R4 = PolynomialRing(R1, 'y', sparse=True)\n> sage: for d in range(40):  # long time\n> ....:     for R in [R1, R2, R3, R4]:\n> ....:         a = R.random_element()\n> ....:         assert a^d == generic_power(a, d)\n> ```\n\n\nI introduced your proposed doctest, with the following change: Since I put a threshold `20` on the exponent before using the new code (for efficiency reasons), the loop is `for d in range(20,40)`.\n\nReplying to [bruno](#comment%3A23):\n> Replying to [jdemeyer](#comment%3A19):\n> > I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.\n\n>\n> Actually, the current code is faster for finite fields.\n\n\nActually, the code was not correct for non-prime finite fields... (The special case should have been for prime finite fields only.) So I finally followed your advice and removed the special case. In the same time, I refactored a bit the code.",
    "created_at": "2015-09-01T13:43:35Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259921",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:28'></a>
Replying to [jdemeyer](#comment%3A26):
> Replying to [bruno](#comment%3A23):
> > I am happy if you find a good way to test this function!

> You have many cases and they should all be tested:
> 
> ```
> sage: R1 = PolynomialRing(GF(8, 'a'), 'x')
> sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)
> sage: R3 = PolynomialRing(R2, 'y')
> sage: R4 = PolynomialRing(R1, 'y', sparse=True)
> sage: for d in range(40):  # long time
> ....:     for R in [R1, R2, R3, R4]:
> ....:         a = R.random_element()
> ....:         assert a^d == generic_power(a, d)
> ```


I introduced your proposed doctest, with the following change: Since I put a threshold `20` on the exponent before using the new code (for efficiency reasons), the loop is `for d in range(20,40)`.

Replying to [bruno](#comment%3A23):
> Replying to [jdemeyer](#comment%3A19):
> > I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.

>
> Actually, the current code is faster for finite fields.


Actually, the code was not correct for non-prime finite fields... (The special case should have been for prime finite fields only.) So I finally followed your advice and removed the special case. In the same time, I refactored a bit the code.



---

archive/issue_events_166766.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-09-01T13:43:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166766"
}
```



---

archive/issue_events_166767.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2015-09-01T13:43:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166767"
}
```



---

archive/issue_comments_259922.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2015-09-07T12:40:43Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259922",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_events_166768.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-09-07T12:40:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166768"
}
```



---

archive/issue_events_166769.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-09-07T12:40:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166769"
}
```



---

archive/issue_events_166770.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-09-07T21:34:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166770"
}
```



---

archive/issue_events_166771.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "1761131f306bc9e260ec6d0fe8a5aada2798d2f2",
    "created_at": "2015-09-07T21:34:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18547#event-166771"
}
```



---

archive/issue_comments_259923.json:
```json
{
    "body": "**Changing branch** from \"[u/bruno/polynomial_powering_positive_characteristic](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/polynomial_powering_positive_characteristic)\" to \"[41dd9054555eaaf7567fac4ec56d95d05b039daa](https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa)\".",
    "created_at": "2015-09-07T21:34:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18547#issuecomment-259923",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/bruno/polynomial_powering_positive_characteristic](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/polynomial_powering_positive_characteristic)" to "[41dd9054555eaaf7567fac4ec56d95d05b039daa](https://github.com/sagemath/sagetrac-mirror/commit/41dd9054555eaaf7567fac4ec56d95d05b039daa)".
