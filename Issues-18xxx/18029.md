# Issue 18029: speed up integral point enumeration

archive/issues_017792.json:
```json
{
    "body": "Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17562) and more.\n\nCC:  @novoselt @tscrim winfried\n\nBranch/Commit: 83d3322c4ba5f9a99be21e55e65489ec94862ef4\n\nReviewer: Matthias Koeppe, Jeroen Demeyer\n\nAuthor: Travis Scrimshaw\n\nDependencies: #17562\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18029\n\n",
    "closed_at": "2016-12-10T12:38:20Z",
    "created_at": "2015-03-21T13:23:39Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "speed up integral point enumeration",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18029",
    "user": "https://github.com/videlec"
}
```
Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17562) and more.

CC:  @novoselt @tscrim winfried

Branch/Commit: 83d3322c4ba5f9a99be21e55e65489ec94862ef4

Reviewer: Matthias Koeppe, Jeroen Demeyer

Author: Travis Scrimshaw

Dependencies: #17562

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18029





---

archive/issue_comments_253655.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Some of the cython code in \\`sage/geometry/integral_points.pyx\\` can be optimized a lot (properly defining the types of objects, use the \\`set_unsafe\\` feature from #17652) and more.\n+Some of the cython code in \\`sage/geometry/integral_points.pyx\\` can be optimized a lot (properly defining the types of objects, use the \\`set_unsafe\\` feature from #17562) and more.\n \n Dependencies: #17562\n \n```\n",
    "created_at": "2015-03-21T13:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253655",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Some of the cython code in \`sage/geometry/integral_points.pyx\` can be optimized a lot (properly defining the types of objects, use the \`set_unsafe\` feature from #17652) and more.
+Some of the cython code in \`sage/geometry/integral_points.pyx\` can be optimized a lot (properly defining the types of objects, use the \`set_unsafe\` feature from #17562) and more.
 
 Dependencies: #17562
 
```




---

archive/issue_events_051197.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-07-08T06:38:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18029#event-51197"
}
```



---

archive/issue_comments_253656.json:
```json
{
    "body": "<a id='comment:4'></a>I was able to get ~15% speedup:\n\n```\nsage: sage: ieqs = [(-1, -1, -1, -1, -1, -1, -1, -1, -1),\n....:         (0, -1, 0, 0, 0, 0, 0, 0, 0),\n....:         (0, -1, 0, 2, -1, 0, 0, 0, 0),\n....:         (0, 0, -1, -1, 2, -1, 0, 0, 0),\n....:         (0, 2, 0, -1, 0, 0, 0, 0, 0),\n....:         (0, 0, 0, 0, 0, 0, 0, -1, 2),\n....:         (1, 0, 2, 0, -1, 0, 0, 0, 0),\n....:         (0, 0, 0, 0, -1, 2, -1, 0, 0),\n....:         (0, 0, 0, 0, 0, 0, 0, 0, -1),\n....:         (0, 0, 0, 0, 0, -1, 2, -1, 0),\n....:         (0, 0, 0, 0, 0, 0, -1, 2, -1)]\nsage: P = Polyhedron(ieqs=ieqs)\nsage: %time len(P.integral_points())\nCPU times: user 12.4 s, sys: 5 \u00b5s, total: 12.4 s\nWall time: 12.4 s\n4\n```\nIn the current version, this takes ~14s. There is also some improvement for the simplex approach:\n\n```\nsage: from sage.geometry.integral_points import simplex_points\nsage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)] \nsage: simplex = Polyhedron(v); simplexA 4-dimensional polyhedron in ZZ^4 defined as the convex hull of 5 vertices\nsage: %timeit len(simplex_points(simplex.vertices()))\n100 loops, best of 3: 15.1 ms per loop\n```\nvs\n\n```\n10 loops, best of 3: 24.1 ms per loop\n```\n\nI used all the tricks that I know to squeeze speed out with doing any rewrites. However, it would be better to implement/use a priority queue (or linked list) data structure instead of a straight list for the inequalities since we are often moving one to the front as part of the algorithm.\nYet I think this is a good gain and should be included in the present state (unless someone feels like doing something more invasive, which I would then review).\n\n---\nNew commits:",
    "created_at": "2016-07-08T06:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253656",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>I was able to get ~15% speedup:

```
sage: sage: ieqs = [(-1, -1, -1, -1, -1, -1, -1, -1, -1),
....:         (0, -1, 0, 0, 0, 0, 0, 0, 0),
....:         (0, -1, 0, 2, -1, 0, 0, 0, 0),
....:         (0, 0, -1, -1, 2, -1, 0, 0, 0),
....:         (0, 2, 0, -1, 0, 0, 0, 0, 0),
....:         (0, 0, 0, 0, 0, 0, 0, -1, 2),
....:         (1, 0, 2, 0, -1, 0, 0, 0, 0),
....:         (0, 0, 0, 0, -1, 2, -1, 0, 0),
....:         (0, 0, 0, 0, 0, 0, 0, 0, -1),
....:         (0, 0, 0, 0, 0, -1, 2, -1, 0),
....:         (0, 0, 0, 0, 0, 0, -1, 2, -1)]
sage: P = Polyhedron(ieqs=ieqs)
sage: %time len(P.integral_points())
CPU times: user 12.4 s, sys: 5 Âµs, total: 12.4 s
Wall time: 12.4 s
4
```
In the current version, this takes ~14s. There is also some improvement for the simplex approach:

```
sage: from sage.geometry.integral_points import simplex_points
sage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)] 
sage: simplex = Polyhedron(v); simplexA 4-dimensional polyhedron in ZZ^4 defined as the convex hull of 5 vertices
sage: %timeit len(simplex_points(simplex.vertices()))
100 loops, best of 3: 15.1 ms per loop
```
vs

```
10 loops, best of 3: 24.1 ms per loop
```

I used all the tricks that I know to squeeze speed out with doing any rewrites. However, it would be better to implement/use a priority queue (or linked list) data structure instead of a straight list for the inequalities since we are often moving one to the front as part of the algorithm.
Yet I think this is a good gain and should be included in the present state (unless someone feels like doing something more invasive, which I would then review).

---
New commits:



---

archive/issue_comments_253657.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-08T06:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253657",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_253658.json:
```json
{
    "body": "normaliz input",
    "created_at": "2016-07-17T13:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253658",
    "user": "https://github.com/mkoeppe"
}
```

normaliz input



---

archive/issue_comments_253659.json:
```json
{
    "body": "<a id='comment:6'></a>Attachment [18029-example.in](tarball://root/attachments/some-uuid/ticket18029/18029-example.in) by @mkoeppe created at 2016-07-17 14:01:17\n\nThis looks fine, but let me point out that the performance of this code is very far from the state of the art.\nThe first example in dimension 8 is solved by normaliz in 0.1s (I have attached an input file for normaliz). So a simple interface to normaliz (#20885) would bring huge speedups.",
    "created_at": "2016-07-17T14:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253659",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Attachment [18029-example.in](tarball://root/attachments/some-uuid/ticket18029/18029-example.in) by @mkoeppe created at 2016-07-17 14:01:17

This looks fine, but let me point out that the performance of this code is very far from the state of the art.
The first example in dimension 8 is solved by normaliz in 0.1s (I have attached an input file for normaliz). So a simple interface to normaliz (#20885) would bring huge speedups.



---

archive/issue_comments_253660.json:
```json
{
    "body": "<a id='comment:7'></a>That said, of course it's nice to have a basic, generic implementation in Sage if one does not want to install normaliz; but it turns out that the implementation is actually not very generic (#21037).",
    "created_at": "2016-07-17T14:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253660",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>That said, of course it's nice to have a basic, generic implementation in Sage if one does not want to install normaliz; but it turns out that the implementation is actually not very generic (#21037).



---

archive/issue_comments_253661.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-17T23:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253662.json:
```json
{
    "body": "<a id='comment:9'></a>FYI - this merged cleanly with #21037.",
    "created_at": "2016-07-17T23:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253662",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>FYI - this merged cleanly with #21037.



---

archive/issue_comments_253663.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-17T23:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253663",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253664.json:
```json
{
    "body": "<a id='comment:10'></a>Looks good.\n\nSo... how about that normaliz interface?",
    "created_at": "2016-07-17T23:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253664",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Looks good.

So... how about that normaliz interface?



---

archive/issue_comments_253665.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-07-17T23:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253665",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_253666.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2016-07-17T23:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_253667.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 mkoeppe]:\n> Looks good.\n\n\nSorry, I found one other place where I got another `.4s` in the above example.\n\n> So... how about that normaliz interface?\n\n\nThat's quite a difference, and it would be great to have it available (and be extremely useful to me to have integral points that fast). I don't know how much I could help it writing the interface; I know somewhat how to write the cython bindings, but not what to use/expose from noraliz. I will definitely be happy to review it.",
    "created_at": "2016-07-17T23:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253667",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>Replying to [comment:10 mkoeppe]:
> Looks good.


Sorry, I found one other place where I got another `.4s` in the above example.

> So... how about that normaliz interface?


That's quite a difference, and it would be great to have it available (and be extremely useful to me to have integral points that fast). I don't know how much I could help it writing the interface; I know somewhat how to write the cython bindings, but not what to use/expose from noraliz. I will definitely be happy to review it.



---

archive/issue_comments_253668.json:
```json
{
    "body": "<a id='comment:13'></a>Just in case you didn't see it, could you check my last push?",
    "created_at": "2016-07-18T14:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253668",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Just in case you didn't see it, could you check my last push?



---

archive/issue_comments_253669.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-18T15:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253669",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253670.json:
```json
{
    "body": "<a id='comment:15'></a>Thank you.",
    "created_at": "2016-07-18T15:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253670",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Thank you.



---

archive/issue_comments_253671.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-07-19T06:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253671",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_253672.json:
```json
{
    "body": "<a id='comment:17'></a>You need to use an `except` value when you have a `c(p)def` function with a return type: replace `cpdef bint ...(...)` by `cpdef bint ...(...) except -1`.\n\nAnd since you seem to like Cython micro-optimizations a lot in this ticket, you missed an obvious one: setting the `boundscheck` and `wraparound` [directives](http://docs.cython.org/src/reference/compilation.html#compiler-directives) to `False` to speed up list indexing.",
    "created_at": "2016-07-19T07:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253672",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>You need to use an `except` value when you have a `c(p)def` function with a return type: replace `cpdef bint ...(...)` by `cpdef bint ...(...) except -1`.

And since you seem to like Cython micro-optimizations a lot in this ticket, you missed an obvious one: setting the `boundscheck` and `wraparound` [directives](http://docs.cython.org/src/reference/compilation.html#compiler-directives) to `False` to speed up list indexing.



---

archive/issue_comments_253673.json:
```json
{
    "body": "<a id='comment:18'></a>I should also add that declaring the type of a variable or return value may or may not speed up the code. You gain if Cython can use special optimizations for that type. But you lose if Cython needs to add pointless checks that the thing you are assigning to the variable has the correct type.\n\nDeciding whether to declare the type of a variable should be done on a case-on-case basis, it's not a general rule that you should declare as much types as possible.",
    "created_at": "2016-07-19T07:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253673",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>I should also add that declaring the type of a variable or return value may or may not speed up the code. You gain if Cython can use special optimizations for that type. But you lose if Cython needs to add pointless checks that the thing you are assigning to the variable has the correct type.

Deciding whether to declare the type of a variable should be done on a case-on-case basis, it's not a general rule that you should declare as much types as possible.



---

archive/issue_comments_253674.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-03T15:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253674",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253675.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-03T15:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253675",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_253676.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-03T15:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253676",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_253677.json:
```json
{
    "body": "<a id='comment:21'></a>I've added the Cython directives (I didn't know about them, thank you), and I've added a few more type declarations. I believe I have made it so once the type is known, it is kept that way so Cython should never have to recheck the type of things.",
    "created_at": "2016-08-03T15:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253677",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>I've added the Cython directives (I didn't know about them, thank you), and I've added a few more type declarations. I believe I have made it so once the type is known, it is kept that way so Cython should never have to recheck the type of things.



---

archive/issue_comments_253678.json:
```json
{
    "body": "<a id='comment:22'></a>I've also added the `except -1` to the necessary `c(p)def` methods.",
    "created_at": "2016-08-03T15:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253678",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>I've also added the `except -1` to the necessary `c(p)def` methods.



---

archive/issue_comments_253679.json:
```json
{
    "body": "<a id='comment:24'></a>It builds and works OK.\nJeroen, could you take another look?",
    "created_at": "2016-08-03T19:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253679",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>It builds and works OK.
Jeroen, could you take another look?



---

archive/issue_events_051198.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-08-09T23:19:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18029#event-51198"
}
```



---

archive/issue_events_051199.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-08-09T23:19:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18029#event-51199"
}
```



---

archive/issue_comments_253680.json:
```json
{
    "body": "<a id='comment:25'></a>Jeroen, if you have a minute, could you check my most recent changes? Thanks.",
    "created_at": "2016-08-09T23:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253680",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>Jeroen, if you have a minute, could you check my most recent changes? Thanks.



---

archive/issue_comments_253681.json:
```json
{
    "body": "<a id='comment:26'></a>Ping?",
    "created_at": "2016-10-28T04:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253681",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>Ping?



---

archive/issue_comments_253682.json:
```json
{
    "body": "<a id='comment:28'></a>#20885 now has an implementation of `integer_points` using normaliz.",
    "created_at": "2016-11-26T06:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253682",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>#20885 now has an implementation of `integer_points` using normaliz.



---

archive/issue_comments_253683.json:
```json
{
    "body": "<a id='comment:29'></a>This ticket would need rebasing also.",
    "created_at": "2016-11-27T02:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253683",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>This ticket would need rebasing also.



---

archive/issue_comments_253684.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-27T11:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253685.json:
```json
{
    "body": "<a id='comment:31'></a>Rebased. It would be nice to finalize this and get this in until #20885 gets merged and becomes the default.",
    "created_at": "2016-11-27T11:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253685",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:31'></a>Rebased. It would be nice to finalize this and get this in until #20885 gets merged and becomes the default.



---

archive/issue_comments_253686.json:
```json
{
    "body": "<a id='comment:32'></a>By the way, I noticed the following bug in Sage (without this branch -- haven't tested yet with this branch!):\n\n```\nsage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()\n...\n/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)\n   4357                 box_points<threshold:\n   4358             from sage.geometry.integral_points import rectangular_box_points\n-> 4359             return rectangular_box_points(box_min, box_max, self)\n   4360 \n   4361         # for more complicate polytopes, triangulate & use smith normal form\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()\n    552     v = vector(ZZ, d)\n    553     if not return_saturated:\n--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):\n    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow\n    556             for i in range(0,d):\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()\n    601     while True:\n    602         sig_check()\n--> 603         inequalities.prepare_inner_loop(p)\n    604         i_min = box_min[0]\n    605         i_max = box_max[0]\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()\n   1256         \"\"\"\n   1257         for ineq in self.ineqs_int:\n-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)\n   1259         for ineq in self.ineqs_generic:\n   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()\n    938         cdef int j\n    939         if self.dim>1:\n--> 940             self.cache = self.cache_next + self.coeff_next*p[1]\n    941         else:\n    942             self.cache = self.cache_next\n\nOverflowError: value too large to convert to int\n```\n\n(I can make this a separate ticket if that's better.)\n\n---\nNew commits:",
    "created_at": "2016-11-27T20:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253686",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>By the way, I noticed the following bug in Sage (without this branch -- haven't tested yet with this branch!):

```
sage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()
...
/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)
   4357                 box_points<threshold:
   4358             from sage.geometry.integral_points import rectangular_box_points
-> 4359             return rectangular_box_points(box_min, box_max, self)
   4360 
   4361         # for more complicate polytopes, triangulate & use smith normal form

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()
    552     v = vector(ZZ, d)
    553     if not return_saturated:
--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):
    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow
    556             for i in range(0,d):

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()
    601     while True:
    602         sig_check()
--> 603         inequalities.prepare_inner_loop(p)
    604         i_min = box_min[0]
    605         i_max = box_max[0]

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()
   1256         """
   1257         for ineq in self.ineqs_int:
-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)
   1259         for ineq in self.ineqs_generic:
   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()
    938         cdef int j
    939         if self.dim>1:
--> 940             self.cache = self.cache_next + self.coeff_next*p[1]
    941         else:
    942             self.cache = self.cache_next

OverflowError: value too large to convert to int
```

(I can make this a separate ticket if that's better.)

---
New commits:



---

archive/issue_comments_253687.json:
```json
{
    "body": "<a id='comment:33'></a>(same error also with this branch).",
    "created_at": "2016-11-27T21:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253687",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>(same error also with this branch).



---

archive/issue_comments_253688.json:
```json
{
    "body": "<a id='comment:34'></a>I think that should be a separate ticket. (It likely might just be changing some `int` to `long`...)",
    "created_at": "2016-11-29T13:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253688",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:34'></a>I think that should be a separate ticket. (It likely might just be changing some `int` to `long`...)



---

archive/issue_comments_253689.json:
```json
{
    "body": "<a id='comment:35'></a>That's now #21993.",
    "created_at": "2016-11-29T19:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253689",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>That's now #21993.



---

archive/issue_comments_253690.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-08T19:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253690",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_051200.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-12-08T19:18:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18029#event-51200"
}
```



---

archive/issue_events_051201.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-12-08T19:18:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18029#event-51201"
}
```



---

archive/issue_comments_253691.json:
```json
{
    "body": "<a id='comment:36'></a>Looks good to me.\nI'm setting this to positive review -- but Jeroen may have more comments.",
    "created_at": "2016-12-08T19:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253691",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Looks good to me.
I'm setting this to positive review -- but Jeroen may have more comments.



---

archive/issue_events_051202.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-10T12:38:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18029#event-51202"
}
```



---

archive/issue_comments_253692.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-12-10T12:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18029#issuecomment-253692",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
