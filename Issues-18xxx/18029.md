# Issue 18029: speed up integral point enumeration

archive/issues_017792.json:
```json
{
    "assignees": [],
    "body": "Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17562) and more.\n\nDepends on #17562\n\n**CC:**  @novoselt @tscrim Winfried\n\n**Branch/Commit:** [83d3322c4ba5f9a99be21e55e65489ec94862ef4](https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4)\n\n**Reviewer:** Matthias Koeppe, Jeroen Demeyer\n\n**Author:** Travis Scrimshaw\n\nIssue created by migration from https://trac.sagemath.org/ticket/18029\n\n",
    "closed_at": "2016-12-10T12:38:20Z",
    "created_at": "2015-03-21T13:23:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20geometry",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "speed up integral point enumeration",
    "type": "issue",
    "updated_at": "2016-12-10T12:38:20Z",
    "url": "https://github.com/sagemath/sage/issues/18029",
    "user": "https://github.com/videlec"
}
```
Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17562) and more.

Depends on #17562

**CC:**  @novoselt @tscrim Winfried

**Branch/Commit:** [83d3322c4ba5f9a99be21e55e65489ec94862ef4](https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4)

**Reviewer:** Matthias Koeppe, Jeroen Demeyer

**Author:** Travis Scrimshaw

Issue created by migration from https://trac.sagemath.org/ticket/18029





---

archive/issue_events_220308.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-03-21T13:23:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220308"
}
```



---

archive/issue_events_220309.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-03-21T13:23:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20geometry",
    "label_color": "08517b",
    "label_name": "component: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220309"
}
```



---

archive/issue_events_220310.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-03-21T13:23:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220310"
}
```



---

archive/issue_comments_247873.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17652) and more.\n+Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17562) and more.\n``````\n",
    "created_at": "2015-03-21T13:23:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247873",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17652) and more.
+Some of the cython code in `sage/geometry/integral_points.pyx` can be optimized a lot (properly defining the types of objects, use the `set_unsafe` feature from #17562) and more.
``````




---

archive/issue_comments_247874.json:
```json
{
    "body": "**Branch:** [public/geometry/speedup_integral_points-18029](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/speedup_integral_points-18029)",
    "created_at": "2016-07-08T06:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247874",
    "user": "https://github.com/tscrim"
}
```

**Branch:** [public/geometry/speedup_integral_points-18029](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/speedup_integral_points-18029)



---

archive/issue_events_220311.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-07-08T06:38:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220311"
}
```



---

archive/issue_events_220312.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-07-08T06:38:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220312"
}
```



---

archive/issue_comments_247875.json:
```json
{
    "body": "<a id='comment:4'></a>\nI was able to get ~15% speedup:\n\n```\nsage: sage: ieqs = [(-1, -1, -1, -1, -1, -1, -1, -1, -1),\n....:         (0, -1, 0, 0, 0, 0, 0, 0, 0),\n....:         (0, -1, 0, 2, -1, 0, 0, 0, 0),\n....:         (0, 0, -1, -1, 2, -1, 0, 0, 0),\n....:         (0, 2, 0, -1, 0, 0, 0, 0, 0),\n....:         (0, 0, 0, 0, 0, 0, 0, -1, 2),\n....:         (1, 0, 2, 0, -1, 0, 0, 0, 0),\n....:         (0, 0, 0, 0, -1, 2, -1, 0, 0),\n....:         (0, 0, 0, 0, 0, 0, 0, 0, -1),\n....:         (0, 0, 0, 0, 0, -1, 2, -1, 0),\n....:         (0, 0, 0, 0, 0, 0, -1, 2, -1)]\nsage: P = Polyhedron(ieqs=ieqs)\nsage: %time len(P.integral_points())\nCPU times: user 12.4 s, sys: 5 \u00b5s, total: 12.4 s\nWall time: 12.4 s\n4\n```\nIn the current version, this takes ~14s. There is also some improvement for the simplex approach:\n\n```\nsage: from sage.geometry.integral_points import simplex_points\nsage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)] \nsage: simplex = Polyhedron(v); simplexA 4-dimensional polyhedron in ZZ^4 defined as the convex hull of 5 vertices\nsage: %timeit len(simplex_points(simplex.vertices()))\n100 loops, best of 3: 15.1 ms per loop\n```\nvs\n\n```\n10 loops, best of 3: 24.1 ms per loop\n```\n\nI used all the tricks that I know to squeeze speed out with doing any rewrites. However, it would be better to implement/use a priority queue (or linked list) data structure instead of a straight list for the inequalities since we are often moving one to the front as part of the algorithm.\nYet I think this is a good gain and should be included in the present state (unless someone feels like doing something more invasive, which I would then review).\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1e7e811a0ff797b2fb7665dc3a77a50a63a68583\">1e7e811</a></td><td><code>Optimizations and improve cython code for integral_points.pyx.</code></td></tr></table>\n",
    "created_at": "2016-07-08T06:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247875",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
I was able to get ~15% speedup:

```
sage: sage: ieqs = [(-1, -1, -1, -1, -1, -1, -1, -1, -1),
....:         (0, -1, 0, 0, 0, 0, 0, 0, 0),
....:         (0, -1, 0, 2, -1, 0, 0, 0, 0),
....:         (0, 0, -1, -1, 2, -1, 0, 0, 0),
....:         (0, 2, 0, -1, 0, 0, 0, 0, 0),
....:         (0, 0, 0, 0, 0, 0, 0, -1, 2),
....:         (1, 0, 2, 0, -1, 0, 0, 0, 0),
....:         (0, 0, 0, 0, -1, 2, -1, 0, 0),
....:         (0, 0, 0, 0, 0, 0, 0, 0, -1),
....:         (0, 0, 0, 0, 0, -1, 2, -1, 0),
....:         (0, 0, 0, 0, 0, 0, -1, 2, -1)]
sage: P = Polyhedron(ieqs=ieqs)
sage: %time len(P.integral_points())
CPU times: user 12.4 s, sys: 5 Âµs, total: 12.4 s
Wall time: 12.4 s
4
```
In the current version, this takes ~14s. There is also some improvement for the simplex approach:

```
sage: from sage.geometry.integral_points import simplex_points
sage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)] 
sage: simplex = Polyhedron(v); simplexA 4-dimensional polyhedron in ZZ^4 defined as the convex hull of 5 vertices
sage: %timeit len(simplex_points(simplex.vertices()))
100 loops, best of 3: 15.1 ms per loop
```
vs

```
10 loops, best of 3: 24.1 ms per loop
```

I used all the tricks that I know to squeeze speed out with doing any rewrites. However, it would be better to implement/use a priority queue (or linked list) data structure instead of a straight list for the inequalities since we are often moving one to the front as part of the algorithm.
Yet I think this is a good gain and should be included in the present state (unless someone feels like doing something more invasive, which I would then review).

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1e7e811a0ff797b2fb7665dc3a77a50a63a68583">1e7e811</a></td><td><code>Optimizations and improve cython code for integral_points.pyx.</code></td></tr></table>




---

archive/issue_comments_247876.json:
```json
{
    "body": "**Author:** Travis Scrimshaw",
    "created_at": "2016-07-08T06:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247876",
    "user": "https://github.com/tscrim"
}
```

**Author:** Travis Scrimshaw



---

archive/issue_comments_247877.json:
```json
{
    "body": "**Commit:** [1e7e811a0ff797b2fb7665dc3a77a50a63a68583](https://github.com/sagemath/sagetrac-mirror/commit/1e7e811a0ff797b2fb7665dc3a77a50a63a68583)",
    "created_at": "2016-07-08T06:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247877",
    "user": "https://github.com/tscrim"
}
```

**Commit:** [1e7e811a0ff797b2fb7665dc3a77a50a63a68583](https://github.com/sagemath/sagetrac-mirror/commit/1e7e811a0ff797b2fb7665dc3a77a50a63a68583)



---

archive/issue_events_220313.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-07-08T06:39:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220313"
}
```



---

archive/issue_comments_247878.json:
```json
{
    "body": "normaliz input",
    "created_at": "2016-07-17T13:57:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247878",
    "user": "https://github.com/mkoeppe"
}
```

normaliz input



---

archive/issue_comments_247879.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Attachment:** [18029-example.in](https://github.com/sagemath/sage/files/ticket18029/18029-example.in)\n\nThis looks fine, but let me point out that the performance of this code is very far from the state of the art.\nThe first example in dimension 8 is solved by normaliz in 0.1s (I have attached an input file for normaliz). So a simple interface to normaliz (#20885) would bring huge speedups.",
    "created_at": "2016-07-17T14:01:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247879",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
**Attachment:** [18029-example.in](https://github.com/sagemath/sage/files/ticket18029/18029-example.in)

This looks fine, but let me point out that the performance of this code is very far from the state of the art.
The first example in dimension 8 is solved by normaliz in 0.1s (I have attached an input file for normaliz). So a simple interface to normaliz (#20885) would bring huge speedups.



---

archive/issue_comments_247880.json:
```json
{
    "body": "<a id='comment:7'></a>\nThat said, of course it's nice to have a basic, generic implementation in Sage if one does not want to install normaliz; but it turns out that the implementation is actually not very generic (#21037).",
    "created_at": "2016-07-17T14:49:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247880",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
That said, of course it's nice to have a basic, generic implementation in Sage if one does not want to install normaliz; but it turns out that the implementation is actually not very generic (#21037).



---

archive/issue_comments_247881.json:
```json
{
    "body": "**Changing commit** from \"[1e7e811a0ff797b2fb7665dc3a77a50a63a68583](https://github.com/sagemath/sagetrac-mirror/commit/1e7e811a0ff797b2fb7665dc3a77a50a63a68583)\" to \"[8cd48fcb69a150e4901c257a29dd8764d25474ac](https://github.com/sagemath/sagetrac-mirror/commit/8cd48fcb69a150e4901c257a29dd8764d25474ac)\".",
    "created_at": "2016-07-17T23:05:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247881",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[1e7e811a0ff797b2fb7665dc3a77a50a63a68583](https://github.com/sagemath/sagetrac-mirror/commit/1e7e811a0ff797b2fb7665dc3a77a50a63a68583)" to "[8cd48fcb69a150e4901c257a29dd8764d25474ac](https://github.com/sagemath/sagetrac-mirror/commit/8cd48fcb69a150e4901c257a29dd8764d25474ac)".



---

archive/issue_comments_247882.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/25903fc5f93e3a5edcffe2afc8d14f34dc2212f9\">25903fc</a></td><td><code>Merge branch 'public/geometry/speedup_integral_points-18029' of trac.sagemath.org:sage into public/geometry/speedup_integral_points-18029</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8cd48fcb69a150e4901c257a29dd8764d25474ac\">8cd48fc</a></td><td><code>Trying to get a little bit more speed out.</code></td></tr></table>\n",
    "created_at": "2016-07-17T23:05:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247882",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/25903fc5f93e3a5edcffe2afc8d14f34dc2212f9">25903fc</a></td><td><code>Merge branch 'public/geometry/speedup_integral_points-18029' of trac.sagemath.org:sage into public/geometry/speedup_integral_points-18029</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8cd48fcb69a150e4901c257a29dd8764d25474ac">8cd48fc</a></td><td><code>Trying to get a little bit more speed out.</code></td></tr></table>




---

archive/issue_comments_247883.json:
```json
{
    "body": "<a id='comment:9'></a>\nFYI - this merged cleanly with #21037.",
    "created_at": "2016-07-17T23:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247883",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>
FYI - this merged cleanly with #21037.



---

archive/issue_events_220314.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-07-17T23:32:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220314"
}
```



---

archive/issue_events_220315.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-07-17T23:32:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220315"
}
```



---

archive/issue_comments_247884.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2016-07-17T23:32:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247884",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_comments_247885.json:
```json
{
    "body": "<a id='comment:10'></a>\nLooks good.\n\nSo... how about that normaliz interface?",
    "created_at": "2016-07-17T23:32:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247885",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
Looks good.

So... how about that normaliz interface?



---

archive/issue_events_220316.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2016-07-17T23:39:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220316"
}
```



---

archive/issue_events_220317.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2016-07-17T23:39:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220317"
}
```



---

archive/issue_comments_247886.json:
```json
{
    "body": "**Changing commit** from \"[8cd48fcb69a150e4901c257a29dd8764d25474ac](https://github.com/sagemath/sagetrac-mirror/commit/8cd48fcb69a150e4901c257a29dd8764d25474ac)\" to \"[801226044e890ac38db3bbe6367cd4692b3095d8](https://github.com/sagemath/sagetrac-mirror/commit/801226044e890ac38db3bbe6367cd4692b3095d8)\".",
    "created_at": "2016-07-17T23:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247886",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[8cd48fcb69a150e4901c257a29dd8764d25474ac](https://github.com/sagemath/sagetrac-mirror/commit/8cd48fcb69a150e4901c257a29dd8764d25474ac)" to "[801226044e890ac38db3bbe6367cd4692b3095d8](https://github.com/sagemath/sagetrac-mirror/commit/801226044e890ac38db3bbe6367cd4692b3095d8)".



---

archive/issue_comments_247887.json:
```json
{
    "body": "<a id='comment:11'></a>\n**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/801226044e890ac38db3bbe6367cd4692b3095d8\">8012260</a></td><td><code>Don't manipulate the lengths of lists unless necessary.</code></td></tr></table>\n",
    "created_at": "2016-07-17T23:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247887",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:11'></a>
**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/801226044e890ac38db3bbe6367cd4692b3095d8">8012260</a></td><td><code>Don't manipulate the lengths of lists unless necessary.</code></td></tr></table>




---

archive/issue_comments_247888.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [@mkoeppe](#comment%3A10):\n> Looks good.\n\nSorry, I found one other place where I got another `.4s` in the above example.\n\n> So... how about that normaliz interface?\n\nThat's quite a difference, and it would be great to have it available (and be extremely useful to me to have integral points that fast). I don't know how much I could help it writing the interface; I know somewhat how to write the cython bindings, but not what to use/expose from noraliz. I will definitely be happy to review it.",
    "created_at": "2016-07-17T23:42:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247888",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
Replying to [@mkoeppe](#comment%3A10):
> Looks good.

Sorry, I found one other place where I got another `.4s` in the above example.

> So... how about that normaliz interface?

That's quite a difference, and it would be great to have it available (and be extremely useful to me to have integral points that fast). I don't know how much I could help it writing the interface; I know somewhat how to write the cython bindings, but not what to use/expose from noraliz. I will definitely be happy to review it.



---

archive/issue_comments_247889.json:
```json
{
    "body": "<a id='comment:13'></a>\nJust in case you didn't see it, could you check my last push?",
    "created_at": "2016-07-18T14:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247889",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>
Just in case you didn't see it, could you check my last push?



---

archive/issue_events_220318.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-07-18T15:01:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220318"
}
```



---

archive/issue_events_220319.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-07-18T15:01:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220319"
}
```



---

archive/issue_comments_247890.json:
```json
{
    "body": "<a id='comment:15'></a>\nThank you.",
    "created_at": "2016-07-18T15:07:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247890",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>
Thank you.



---

archive/issue_events_220320.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-07-19T06:44:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220320"
}
```



---

archive/issue_events_220321.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-07-19T06:44:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220321"
}
```



---

archive/issue_comments_247891.json:
```json
{
    "body": "<a id='comment:17'></a>\nYou need to use an `except` value when you have a `c(p)def` function with a return type: replace `cpdef bint ...(...)` by `cpdef bint ...(...) except -1`.\n\nAnd since you seem to like Cython micro-optimizations a lot in this ticket, you missed an obvious one: setting the `boundscheck` and `wraparound` [directives](http://docs.cython.org/src/reference/compilation.html#compiler-directives) to `False` to speed up list indexing.",
    "created_at": "2016-07-19T07:03:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247891",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
You need to use an `except` value when you have a `c(p)def` function with a return type: replace `cpdef bint ...(...)` by `cpdef bint ...(...) except -1`.

And since you seem to like Cython micro-optimizations a lot in this ticket, you missed an obvious one: setting the `boundscheck` and `wraparound` [directives](http://docs.cython.org/src/reference/compilation.html#compiler-directives) to `False` to speed up list indexing.



---

archive/issue_comments_247892.json:
```json
{
    "body": "<a id='comment:18'></a>\nI should also add that declaring the type of a variable or return value may or may not speed up the code. You gain if Cython can use special optimizations for that type. But you lose if Cython needs to add pointless checks that the thing you are assigning to the variable has the correct type.\n\nDeciding whether to declare the type of a variable should be done on a case-on-case basis, it's not a general rule that you should declare as much types as possible.",
    "created_at": "2016-07-19T07:09:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247892",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
I should also add that declaring the type of a variable or return value may or may not speed up the code. You gain if Cython can use special optimizations for that type. But you lose if Cython needs to add pointless checks that the thing you are assigning to the variable has the correct type.

Deciding whether to declare the type of a variable should be done on a case-on-case basis, it's not a general rule that you should declare as much types as possible.



---

archive/issue_comments_247893.json:
```json
{
    "body": "**Changing commit** from \"[801226044e890ac38db3bbe6367cd4692b3095d8](https://github.com/sagemath/sagetrac-mirror/commit/801226044e890ac38db3bbe6367cd4692b3095d8)\" to \"[d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9](https://github.com/sagemath/sagetrac-mirror/commit/d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9)\".",
    "created_at": "2016-08-03T15:22:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247893",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[801226044e890ac38db3bbe6367cd4692b3095d8](https://github.com/sagemath/sagetrac-mirror/commit/801226044e890ac38db3bbe6367cd4692b3095d8)" to "[d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9](https://github.com/sagemath/sagetrac-mirror/commit/d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9)".



---

archive/issue_comments_247894.json:
```json
{
    "body": "<a id='comment:19'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76cf443874dd3b61a937decb7cd547674fef4ddd\">76cf443</a></td><td><code>Merge branch 'develop' into public/geometry/speedup_integral_points-18029</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9\">d829223</a></td><td><code>Using Cython directives and forcing min/max_box to be lists.</code></td></tr></table>\n",
    "created_at": "2016-08-03T15:22:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247894",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:19'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76cf443874dd3b61a937decb7cd547674fef4ddd">76cf443</a></td><td><code>Merge branch 'develop' into public/geometry/speedup_integral_points-18029</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9">d829223</a></td><td><code>Using Cython directives and forcing min/max_box to be lists.</code></td></tr></table>




---

archive/issue_comments_247895.json:
```json
{
    "body": "**Changing commit** from \"[d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9](https://github.com/sagemath/sagetrac-mirror/commit/d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9)\" to \"[9dd64fb8681bb4043caf4f108e5822559d684e83](https://github.com/sagemath/sagetrac-mirror/commit/9dd64fb8681bb4043caf4f108e5822559d684e83)\".",
    "created_at": "2016-08-03T15:26:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247895",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9](https://github.com/sagemath/sagetrac-mirror/commit/d8292231fcf4a43f9f8a9e0d19ed4e15322da3e9)" to "[9dd64fb8681bb4043caf4f108e5822559d684e83](https://github.com/sagemath/sagetrac-mirror/commit/9dd64fb8681bb4043caf4f108e5822559d684e83)".



---

archive/issue_comments_247896.json:
```json
{
    "body": "<a id='comment:20'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9dd64fb8681bb4043caf4f108e5822559d684e83\">9dd64fb</a></td><td><code>Using Cython directives and forcing box_min/max to be lists.</code></td></tr></table>\n",
    "created_at": "2016-08-03T15:26:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247896",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:20'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9dd64fb8681bb4043caf4f108e5822559d684e83">9dd64fb</a></td><td><code>Using Cython directives and forcing box_min/max to be lists.</code></td></tr></table>




---

archive/issue_events_220322.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-08-03T15:31:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220322"
}
```



---

archive/issue_events_220323.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-08-03T15:31:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220323"
}
```



---

archive/issue_comments_247897.json:
```json
{
    "body": "<a id='comment:21'></a>\nI've added the Cython directives (I didn't know about them, thank you), and I've added a few more type declarations. I believe I have made it so once the type is known, it is kept that way so Cython should never have to recheck the type of things.",
    "created_at": "2016-08-03T15:31:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247897",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>
I've added the Cython directives (I didn't know about them, thank you), and I've added a few more type declarations. I believe I have made it so once the type is known, it is kept that way so Cython should never have to recheck the type of things.



---

archive/issue_comments_247898.json:
```json
{
    "body": "<a id='comment:22'></a>\nI've also added the `except -1` to the necessary `c(p)def` methods.",
    "created_at": "2016-08-03T15:31:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247898",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>
I've also added the `except -1` to the necessary `c(p)def` methods.



---

archive/issue_comments_247899.json:
```json
{
    "body": "**Changing reviewer** from \"Matthias Koeppe\" to \"Matthias Koeppe, Jeroen Demeyer\".",
    "created_at": "2016-08-03T18:58:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247899",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "Matthias Koeppe" to "Matthias Koeppe, Jeroen Demeyer".



---

archive/issue_comments_247900.json:
```json
{
    "body": "<a id='comment:24'></a>\nIt builds and works OK.\nJeroen, could you take another look?",
    "created_at": "2016-08-03T19:11:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247900",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
It builds and works OK.
Jeroen, could you take another look?



---

archive/issue_events_220324.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-08-09T23:19:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220324"
}
```



---

archive/issue_events_220325.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-08-09T23:19:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220325"
}
```



---

archive/issue_comments_247901.json:
```json
{
    "body": "<a id='comment:25'></a>\nJeroen, if you have a minute, could you check my most recent changes? Thanks.",
    "created_at": "2016-08-09T23:19:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247901",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>
Jeroen, if you have a minute, could you check my most recent changes? Thanks.



---

archive/issue_comments_247902.json:
```json
{
    "body": "<a id='comment:26'></a>\nPing?",
    "created_at": "2016-10-28T04:37:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247902",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>
Ping?



---

archive/issue_comments_247903.json:
```json
{
    "body": "<a id='comment:28'></a>\n#20885 now has an implementation of `integer_points` using normaliz.",
    "created_at": "2016-11-26T06:27:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247903",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
#20885 now has an implementation of `integer_points` using normaliz.



---

archive/issue_comments_247904.json:
```json
{
    "body": "<a id='comment:29'></a>\nThis ticket would need rebasing also.",
    "created_at": "2016-11-27T02:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247904",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>
This ticket would need rebasing also.



---

archive/issue_comments_247905.json:
```json
{
    "body": "**Changing commit** from \"[9dd64fb8681bb4043caf4f108e5822559d684e83](https://github.com/sagemath/sagetrac-mirror/commit/9dd64fb8681bb4043caf4f108e5822559d684e83)\" to \"[83d3322c4ba5f9a99be21e55e65489ec94862ef4](https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4)\".",
    "created_at": "2016-11-27T11:37:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247905",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[9dd64fb8681bb4043caf4f108e5822559d684e83](https://github.com/sagemath/sagetrac-mirror/commit/9dd64fb8681bb4043caf4f108e5822559d684e83)" to "[83d3322c4ba5f9a99be21e55e65489ec94862ef4](https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4)".



---

archive/issue_comments_247906.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4\">83d3322</a></td><td><code>Merge branch 'public/geometry/speedup_integral_points-18029' of trac.sagemath.org:sage into public/geometry/speedup_integral_points-18029</code></td></tr></table>\n",
    "created_at": "2016-11-27T11:37:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247906",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4">83d3322</a></td><td><code>Merge branch 'public/geometry/speedup_integral_points-18029' of trac.sagemath.org:sage into public/geometry/speedup_integral_points-18029</code></td></tr></table>




---

archive/issue_comments_247907.json:
```json
{
    "body": "<a id='comment:31'></a>\nRebased. It would be nice to finalize this and get this in until #20885 gets merged and becomes the default.",
    "created_at": "2016-11-27T11:39:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247907",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:31'></a>
Rebased. It would be nice to finalize this and get this in until #20885 gets merged and becomes the default.



---

archive/issue_comments_247908.json:
```json
{
    "body": "<a id='comment:32'></a>\nBy the way, I noticed the following bug in Sage (without this branch -- haven't tested yet with this branch!):\n\n```\nsage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()\n...\n/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)\n   4357                 box_points<threshold:\n   4358             from sage.geometry.integral_points import rectangular_box_points\n-> 4359             return rectangular_box_points(box_min, box_max, self)\n   4360 \n   4361         # for more complicate polytopes, triangulate & use smith normal form\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()\n    552     v = vector(ZZ, d)\n    553     if not return_saturated:\n--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):\n    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow\n    556             for i in range(0,d):\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()\n    601     while True:\n    602         sig_check()\n--> 603         inequalities.prepare_inner_loop(p)\n    604         i_min = box_min[0]\n    605         i_max = box_max[0]\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()\n   1256         \"\"\"\n   1257         for ineq in self.ineqs_int:\n-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)\n   1259         for ineq in self.ineqs_generic:\n   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)\n\n/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()\n    938         cdef int j\n    939         if self.dim>1:\n--> 940             self.cache = self.cache_next + self.coeff_next*p[1]\n    941         else:\n    942             self.cache = self.cache_next\n\nOverflowError: value too large to convert to int\n```\n\n(I can make this a separate ticket if that's better.)\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4\">83d3322</a></td><td><code>Merge branch 'public/geometry/speedup_integral_points-18029' of trac.sagemath.org:sage into public/geometry/speedup_integral_points-18029</code></td></tr></table>\n",
    "created_at": "2016-11-27T20:42:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247908",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
By the way, I noticed the following bug in Sage (without this branch -- haven't tested yet with this branch!):

```
sage: %timeit (Polyhedron(vertices=((0, 0), (1789345,37121))) + 1/1000*polytopes.hypercube(2)).integral_points()
...
/Users/mkoeppe/s/sage/sage-rebasing/yet/another/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.pyc in integral_points(self, threshold)
   4357                 box_points<threshold:
   4358             from sage.geometry.integral_points import rectangular_box_points
-> 4359             return rectangular_box_points(box_min, box_max, self)
   4360 
   4361         # for more complicate polytopes, triangulate & use smith normal form

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:6809)()
    552     v = vector(ZZ, d)
    553     if not return_saturated:
--> 554         for p in loop_over_rectangular_box_points(box_min, box_max, inequalities, d, count_only):
    555             #  v = vector(ZZ, orig_perm.action(p))   # too slow
    556             for i in range(0,d):

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.loop_over_rectangular_box_points (build/cythonized/sage/geometry/integral_points.c:7772)()
    601     while True:
    602         sig_check()
--> 603         inequalities.prepare_inner_loop(p)
    604         i_min = box_min[0]
    605         i_max = box_max[0]

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.InequalityCollection.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:14134)()
   1256         """
   1257         for ineq in self.ineqs_int:
-> 1258             (<Inequality_int>ineq).prepare_inner_loop(p)
   1259         for ineq in self.ineqs_generic:
   1260             (<Inequality_generic>ineq).prepare_inner_loop(p)

/Users/mkoeppe/s/sage/sage-rebasing/src/sage/geometry/integral_points.pyx in sage.geometry.integral_points.Inequality_int.prepare_inner_loop (build/cythonized/sage/geometry/integral_points.c:10574)()
    938         cdef int j
    939         if self.dim>1:
--> 940             self.cache = self.cache_next + self.coeff_next*p[1]
    941         else:
    942             self.cache = self.cache_next

OverflowError: value too large to convert to int
```

(I can make this a separate ticket if that's better.)

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4">83d3322</a></td><td><code>Merge branch 'public/geometry/speedup_integral_points-18029' of trac.sagemath.org:sage into public/geometry/speedup_integral_points-18029</code></td></tr></table>




---

archive/issue_comments_247909.json:
```json
{
    "body": "<a id='comment:33'></a>\n(same error also with this branch).",
    "created_at": "2016-11-27T21:28:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247909",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>
(same error also with this branch).



---

archive/issue_comments_247910.json:
```json
{
    "body": "<a id='comment:34'></a>\nI think that should be a separate ticket. (It likely might just be changing some `int` to `long`...)",
    "created_at": "2016-11-29T13:43:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247910",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:34'></a>
I think that should be a separate ticket. (It likely might just be changing some `int` to `long`...)



---

archive/issue_comments_247911.json:
```json
{
    "body": "<a id='comment:35'></a>\nThat's now #21993.",
    "created_at": "2016-11-29T19:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247911",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>
That's now #21993.



---

archive/issue_events_220326.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-12-08T19:18:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220326"
}
```



---

archive/issue_events_220327.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-12-08T19:18:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220327"
}
```



---

archive/issue_events_220328.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-12-08T19:18:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220328"
}
```



---

archive/issue_events_220329.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-12-08T19:18:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220329"
}
```



---

archive/issue_comments_247912.json:
```json
{
    "body": "<a id='comment:36'></a>\nLooks good to me.\nI'm setting this to positive review -- but Jeroen may have more comments.",
    "created_at": "2016-12-08T19:18:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247912",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>
Looks good to me.
I'm setting this to positive review -- but Jeroen may have more comments.



---

archive/issue_events_220330.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-10T12:38:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220330"
}
```



---

archive/issue_events_220331.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "41ca455bdb01dd7d4d432483b61911f2b46c8e8d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-12-10T12:38:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18029#event-220331"
}
```



---

archive/issue_comments_247913.json:
```json
{
    "body": "**Changing branch** from \"[public/geometry/speedup_integral_points-18029](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/speedup_integral_points-18029)\" to \"[83d3322c4ba5f9a99be21e55e65489ec94862ef4](https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4)\".",
    "created_at": "2016-12-10T12:38:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18029",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18029#issuecomment-247913",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/geometry/speedup_integral_points-18029](https://github.com/sagemath/sagetrac-mirror/tree/public/geometry/speedup_integral_points-18029)" to "[83d3322c4ba5f9a99be21e55e65489ec94862ef4](https://github.com/sagemath/sagetrac-mirror/commit/83d3322c4ba5f9a99be21e55e65489ec94862ef4)".
