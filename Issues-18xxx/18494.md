# Issue 18494: Install sage headers and auxiliary files (.h/.pxd/.pxi files)

archive/issues_018257.json:
```json
{
    "body": "Currently, Sage doesn't install any files other than `.py` and compiled cython code. Headers and other auxiliary files that are necessary for compiling user code (such as the `cython()` command or certain optional packages) are kept in the `src` directory and we rely on its presence. Since #18027 we also rely on the presence of the `src/build/cythonized` directory. It would be good if sage could just work without relying on the presence of it source and build directory.\n\n\n\nCC:  jpflori @strogdon @frederichan-IMJPRG\n\nReviewer: Jeroen Demeyer\n\nAuthor: Fran\u00e7ois Bissey\n\nBranch: 56929a9f831d77d5022fe8969ca8365db0487285\n\nCommit: 56929a9f831d77d5022fe8969ca8365db0487285\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18494\n\n",
    "closed_at": "2015-06-12T18:23:51Z",
    "created_at": "2015-05-25T02:41:18Z",
    "labels": [
        "component: distribution",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Install sage headers and auxiliary files (.h/.pxd/.pxi files)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18494",
    "user": "https://github.com/kiwifb"
}
```
Currently, Sage doesn't install any files other than `.py` and compiled cython code. Headers and other auxiliary files that are necessary for compiling user code (such as the `cython()` command or certain optional packages) are kept in the `src` directory and we rely on its presence. Since #18027 we also rely on the presence of the `src/build/cythonized` directory. It would be good if sage could just work without relying on the presence of it source and build directory.



CC:  jpflori @strogdon @frederichan-IMJPRG

Reviewer: Jeroen Demeyer

Author: Fran√ßois Bissey

Branch: 56929a9f831d77d5022fe8969ca8365db0487285

Commit: 56929a9f831d77d5022fe8969ca8365db0487285

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18494





---

archive/issue_comments_246234.json:
```json
{
    "body": "<a id='comment:4'></a>I think we only really need the headers that are in `sage/ext/` and its sub-folders. That would include stuff like `ccobject.h` of p_group_cohomology recent fame. We may want to restrict headers to public interfaces to try to prevent that kind of stuff in the future. Apart from the `.pxi` and `.pxd` we would need the `.pyx` if we want to be able to run the doctests without the sources, that's possibly one step further after this ticket.",
    "created_at": "2015-05-25T09:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246234",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>I think we only really need the headers that are in `sage/ext/` and its sub-folders. That would include stuff like `ccobject.h` of p_group_cohomology recent fame. We may want to restrict headers to public interfaces to try to prevent that kind of stuff in the future. Apart from the `.pxi` and `.pxd` we would need the `.pyx` if we want to be able to run the doctests without the sources, that's possibly one step further after this ticket.



---

archive/issue_comments_246235.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 fbissey]:\n> we would need the `.pyx` if we want to be able to run the doctests without the sources\n\nAnd the `.py` files of course, but I don't think we want that...",
    "created_at": "2015-05-25T13:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246235",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:4 fbissey]:
> we would need the `.pyx` if we want to be able to run the doctests without the sources

And the `.py` files of course, but I don't think we want that...



---

archive/issue_comments_246236.json:
```json
{
    "body": "<a id='comment:6'></a>I'll take the last point as sarcasm. In any case I discovered that `interrupt_api.h` is not the only interesting generated header file that need shipping. `interrupt_api.h` wants `interrupt.h` which is generated in the same folder.",
    "created_at": "2015-05-25T21:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246236",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>I'll take the last point as sarcasm. In any case I discovered that `interrupt_api.h` is not the only interesting generated header file that need shipping. `interrupt_api.h` wants `interrupt.h` which is generated in the same folder.



---

archive/issue_comments_246237.json:
```json
{
    "body": "<a id='comment:7'></a>Fields notes: \n* One would expect all `.py` files to be installed but `src/sage/doctest/tests/nodoctest.py` isn't.\n* `sage/misc/lazy_import_cache.py` has a test for the presence of `src` in the value of `get_cache_file()` I am not quite sure what is the point of this or why it needs to point to `SAGE_SRC` honestly. But that's out of this ticket's scope.\n\nFound that out in sage-on-gentoo by installing manually all headers, pxi, pxd, .pyx, .rst files plus generated headers, fixing pxi.h, not installing the sources at all and pointing `SAGE_SRC` to `/usr/lib64/python2.7/site-packages`. I am relatively impressed at how well that went but I know for a fact that some doctests were not run by my `sage -t --long --all` command (there is one doctest currently timing out on my sage-on-gentoo install and it was definitely not run). \n\nNow I have to seriously find a way of mostly generating all that stuff and to put it in `data_files` in `setup.py`.",
    "created_at": "2015-05-26T02:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246237",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>Fields notes: 
* One would expect all `.py` files to be installed but `src/sage/doctest/tests/nodoctest.py` isn't.
* `sage/misc/lazy_import_cache.py` has a test for the presence of `src` in the value of `get_cache_file()` I am not quite sure what is the point of this or why it needs to point to `SAGE_SRC` honestly. But that's out of this ticket's scope.

Found that out in sage-on-gentoo by installing manually all headers, pxi, pxd, .pyx, .rst files plus generated headers, fixing pxi.h, not installing the sources at all and pointing `SAGE_SRC` to `/usr/lib64/python2.7/site-packages`. I am relatively impressed at how well that went but I know for a fact that some doctests were not run by my `sage -t --long --all` command (there is one doctest currently timing out on my sage-on-gentoo install and it was definitely not run). 

Now I have to seriously find a way of mostly generating all that stuff and to put it in `data_files` in `setup.py`.



---

archive/issue_comments_246238.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:5 jdemeyer]:\n> And the `.py` files of course, but I don't think we want that...\n\n\nWell, what I really wanted to say is that we shouldn't rely on the *installed* `.py` or `.pyx` files for doctests. I don't see it as a problem if running doctests requires the sources.",
    "created_at": "2015-05-26T09:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246238",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:5 jdemeyer]:
> And the `.py` files of course, but I don't think we want that...


Well, what I really wanted to say is that we shouldn't rely on the *installed* `.py` or `.pyx` files for doctests. I don't see it as a problem if running doctests requires the sources.



---

archive/issue_comments_246239.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:6 fbissey]:\n> I'll take the last point as sarcasm. In any case I discovered that `interrupt_api.h` is not the only interesting generated header file that need shipping. `interrupt_api.h` wants `interrupt.h` which is generated in the same folder.\n\nTrue, I forgot about that. In any case, it doesn't change much: just treat those 2 files the same, as auto-generated by Cython.",
    "created_at": "2015-05-26T09:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246239",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:6 fbissey]:
> I'll take the last point as sarcasm. In any case I discovered that `interrupt_api.h` is not the only interesting generated header file that need shipping. `interrupt_api.h` wants `interrupt.h` which is generated in the same folder.

True, I forgot about that. In any case, it doesn't change much: just treat those 2 files the same, as auto-generated by Cython.



---

archive/issue_comments_246240.json:
```json
{
    "body": "<a id='comment:10'></a>The bit about `pxi.h` is annoying. Once installed it needs the reference to `build/cythonized...` removed to be usable with an installed `interrupt_api.h` but it is necessary during the building phase unless `setup.py` is modified to have a specific build directory in `include_dirs`. Any other suggestions?",
    "created_at": "2015-05-26T10:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246240",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>The bit about `pxi.h` is annoying. Once installed it needs the reference to `build/cythonized...` removed to be usable with an installed `interrupt_api.h` but it is necessary during the building phase unless `setup.py` is modified to have a specific build directory in `include_dirs`. Any other suggestions?



---

archive/issue_comments_246241.json:
```json
{
    "body": "<a id='comment:11'></a>Is there a way to change the order of operations? The following would work:\n\n1. Cythonize\n2. Install headers\n3. Compile modules (using the headers installed in step 2, not the ones generated in step 1)",
    "created_at": "2015-05-26T10:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246241",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Is there a way to change the order of operations? The following would work:

1. Cythonize
2. Install headers
3. Compile modules (using the headers installed in step 2, not the ones generated in step 1)



---

archive/issue_comments_246242.json:
```json
{
    "body": "<a id='comment:12'></a>I am not sure about \"installing\" the header but copying them in `SAGE_SRC` instead in step 2 would be sufficient (may be that's what you actually meant) if that can be done. I'll look into it.",
    "created_at": "2015-05-26T10:23:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246242",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:12'></a>I am not sure about "installing" the header but copying them in `SAGE_SRC` instead in step 2 would be sufficient (may be that's what you actually meant) if that can be done. I'll look into it.



---

archive/issue_comments_246243.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 fbissey]:\n> I am not sure about \"installing\" the header but copying them in `SAGE_SRC` instead in step 2 would be sufficient\n\nI wouldn't copy stuff to `SAGE_SRC`. The build system should treat the source directory as read-only as much as possible.\n\nWhen you talked about \"an installed `interrupt_api.h`\" in [comment:10], which installation location did you mean?",
    "created_at": "2015-05-26T10:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246243",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 fbissey]:
> I am not sure about "installing" the header but copying them in `SAGE_SRC` instead in step 2 would be sufficient

I wouldn't copy stuff to `SAGE_SRC`. The build system should treat the source directory as read-only as much as possible.

When you talked about "an installed `interrupt_api.h`" in [comment:10], which installation location did you mean?



---

archive/issue_comments_246244.json:
```json
{
    "body": "<a id='comment:14'></a>Ultimately I was thinking `SAGE_LOCAL/lib/python2.7/site-packages/sage/ext/interrupt/`, site-packages is the final installation destination. I get what you mean by keeping source pristine, we would like building out of source as much as possible, must have hurt to mess up with that to autogenerate the pari stuff, of course you can argue that you prepared the source before putting it through `setup.py`.\n\nIn any case I am not sure what would effectively be a two passes approach is a good idea.",
    "created_at": "2015-05-26T11:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246244",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>Ultimately I was thinking `SAGE_LOCAL/lib/python2.7/site-packages/sage/ext/interrupt/`, site-packages is the final installation destination. I get what you mean by keeping source pristine, we would like building out of source as much as possible, must have hurt to mess up with that to autogenerate the pari stuff, of course you can argue that you prepared the source before putting it through `setup.py`.

In any case I am not sure what would effectively be a two passes approach is a good idea.



---

archive/issue_comments_246245.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 fbissey]:\n> In any case I am not sure what would effectively be a two passes approach is a good idea.\n\nWell, you need to install the headers in any case. Does it make a big difference to do it before or after building extension modules?",
    "created_at": "2015-05-26T11:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246245",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:14 fbissey]:
> In any case I am not sure what would effectively be a two passes approach is a good idea.

Well, you need to install the headers in any case. Does it make a big difference to do it before or after building extension modules?



---

archive/issue_comments_246246.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:\n> Replying to [comment:14 fbissey]:\n> > In any case I am not sure what would effectively be a two passes approach is a good idea.\n\n> Well, you need to install the headers in any case. Does it make a big difference to do it before or after building extension modules?\n\nIt does to me, it means that I need to make two ebuilds because I cannot break the order \"prepare/configure/build/install/merge\". I don't think it matters much to add an entry to `include_dirs` in `setup.py`. It is not used for anything but building/installing unlike `cython.py`.",
    "created_at": "2015-05-26T12:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246246",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 fbissey]:
> > In any case I am not sure what would effectively be a two passes approach is a good idea.

> Well, you need to install the headers in any case. Does it make a big difference to do it before or after building extension modules?

It does to me, it means that I need to make two ebuilds because I cannot break the order "prepare/configure/build/install/merge". I don't think it matters much to add an entry to `include_dirs` in `setup.py`. It is not used for anything but building/installing unlike `cython.py`.



---

archive/issue_comments_246247.json:
```json
{
    "body": "<a id='comment:17'></a>In `cython.py`\n\n```\ninclude_dirs = [os.path.join(SAGE_LOCAL,'include','csage'),\n                os.path.join(SAGE_LOCAL,'include'), \\\n                os.path.join(SAGE_LOCAL,'include','python'+platform.python_version().rsplit('.', 1)[0]), \\\n                os.path.join(SAGE_LOCAL,'lib','python','site-packages','numpy','core','include'), \\\n                os.path.join(SAGE_SRC,'sage','ext'), \\\n                os.path.join(SAGE_SRC), \\\n                os.path.join(SAGE_SRC,'sage','gsl')]\n```\nAny ideas why we add `SAGE_SRC` and `SAGE_SRC/sage/gsl`? Neither has any headers in it although I am guessing `gsl` may have had once.",
    "created_at": "2015-05-26T22:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246247",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'></a>In `cython.py`

```
include_dirs = [os.path.join(SAGE_LOCAL,'include','csage'),
                os.path.join(SAGE_LOCAL,'include'), \
                os.path.join(SAGE_LOCAL,'include','python'+platform.python_version().rsplit('.', 1)[0]), \
                os.path.join(SAGE_LOCAL,'lib','python','site-packages','numpy','core','include'), \
                os.path.join(SAGE_SRC,'sage','ext'), \
                os.path.join(SAGE_SRC), \
                os.path.join(SAGE_SRC,'sage','gsl')]
```
Any ideas why we add `SAGE_SRC` and `SAGE_SRC/sage/gsl`? Neither has any headers in it although I am guessing `gsl` may have had once.



---

archive/issue_comments_246248.json:
```json
{
    "body": "<a id='comment:18'></a>The correct list of include dirs is the one in `src/setup.py`. We should define them in one place and use the same list for `setup.py` and `cython.py`.",
    "created_at": "2015-05-27T05:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246248",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>The correct list of include dirs is the one in `src/setup.py`. We should define them in one place and use the same list for `setup.py` and `cython.py`.



---

archive/issue_comments_246249.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-30T03:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246249",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_246250.json:
```json
{
    "body": "<a id='comment:19'></a>I disagree. include dirs being the same in `setup.py` and `cython.py` is on the nice to have list but there is no compelling reason why install time and runtime absolutely have to match. In this particular case having the same list in `cython.py` has in `setup.py` means that you want to use the source instead of the installed files at runtime. I don't find that compelling. I cannot really accept a cythonize/\"install headers\"/build/\"final install\" routine which could put the two in agreement. I think that's undue complication an breaking of standard building procedures.\n\nSo what the current branch does:\n* clean up the \"cythonized\" path from `pxi.h`\n* clean `cython.py` so it use installed include directories rather than source ones. Prune useless directories as well and use python mechanism as much as possible rather than path \"knowledge\" (potentially help python2.3 as well)\n* add cythonized include path in `setup.py` so that `pxi.h` can find the generated include files at build time\n* add sections to `setup.py` to install header files under `sage/ext` including the generated headers. Also install all `.pxi` and `.pxd` files\n* also replace one instance of path knowledge by python mechanism in `source.py`\n\nThere is more that could be done but I don't want to extend the scope of the ticket. I have bled a little on one extra file as it is.\n\n---\nNew commits:",
    "created_at": "2015-05-30T03:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246250",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'></a>I disagree. include dirs being the same in `setup.py` and `cython.py` is on the nice to have list but there is no compelling reason why install time and runtime absolutely have to match. In this particular case having the same list in `cython.py` has in `setup.py` means that you want to use the source instead of the installed files at runtime. I don't find that compelling. I cannot really accept a cythonize/"install headers"/build/"final install" routine which could put the two in agreement. I think that's undue complication an breaking of standard building procedures.

So what the current branch does:
* clean up the "cythonized" path from `pxi.h`
* clean `cython.py` so it use installed include directories rather than source ones. Prune useless directories as well and use python mechanism as much as possible rather than path "knowledge" (potentially help python2.3 as well)
* add cythonized include path in `setup.py` so that `pxi.h` can find the generated include files at build time
* add sections to `setup.py` to install header files under `sage/ext` including the generated headers. Also install all `.pxi` and `.pxd` files
* also replace one instance of path knowledge by python mechanism in `source.py`

There is more that could be done but I don't want to extend the scope of the ticket. I have bled a little on one extra file as it is.

---
New commits:



---

archive/issue_comments_246251.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-30T05:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246251",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_246252.json:
```json
{
    "body": "<a id='comment:20'></a>Some unexpected doctest failures to remedy, I hadn't tested sage_setup and got unexpected stuff in the notebook.",
    "created_at": "2015-05-30T05:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246252",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:20'></a>Some unexpected doctest failures to remedy, I hadn't tested sage_setup and got unexpected stuff in the notebook.



---

archive/issue_comments_246253.json:
```json
{
    "body": "<a id='comment:21'></a>Hi, is there any chance to review #9552 first and base this ticket on that?",
    "created_at": "2015-05-30T07:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246253",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Hi, is there any chance to review #9552 first and base this ticket on that?



---

archive/issue_comments_246254.json:
```json
{
    "body": "<a id='comment:22'></a>I would still like to use as much as possible the same headers in `src/setup.py` and in `cython.py`. You could make a function\n\n```\n@cached_function\ndef sage_include_directories(sage_lib_dir):\n    \"\"\"\n    Return the list of include directories for compiling Sage extension modules.\n    \"\"\"\n    import numpy   # not a global import!\n    return [.......]\n```\nreturning the include directories for `cython()` if `sage_lib_dir` is `SAGE_LIB` and returning the include directories for `src/setup.py` if `sage_lib_dir` is `SAGE_SRC`. I haven't thought about is that much, but I think that's the right direction to go.\n\nAnd I do indeed agree that `sage/gsl` should be removed.",
    "created_at": "2015-05-30T07:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246254",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>I would still like to use as much as possible the same headers in `src/setup.py` and in `cython.py`. You could make a function

```
@cached_function
def sage_include_directories(sage_lib_dir):
    """
    Return the list of include directories for compiling Sage extension modules.
    """
    import numpy   # not a global import!
    return [.......]
```
returning the include directories for `cython()` if `sage_lib_dir` is `SAGE_LIB` and returning the include directories for `src/setup.py` if `sage_lib_dir` is `SAGE_SRC`. I haven't thought about is that much, but I think that's the right direction to go.

And I do indeed agree that `sage/gsl` should be removed.



---

archive/issue_comments_246255.json:
```json
{
    "body": "<a id='comment:23'></a>And what is so special about the two files `sage/libs/linkages/padics/*.pxi`?",
    "created_at": "2015-05-30T08:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246255",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>And what is so special about the two files `sage/libs/linkages/padics/*.pxi`?



---

archive/issue_comments_246256.json:
```json
{
    "body": "<a id='comment:24'></a>Minor remark: please fix your indentation (multiples of 4 spaces) and\n\n```\n[\"add\", \"a\", \"space\", \"after\", \"commas\", \"in\", \"a\", \"list\"]\n```",
    "created_at": "2015-05-30T08:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246256",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Minor remark: please fix your indentation (multiples of 4 spaces) and

```
["add", "a", "space", "after", "commas", "in", "a", "list"]
```



---

archive/issue_comments_246257.json:
```json
{
    "body": "<a id='comment:25'></a>I don't understand the two cases here:\n\n```\nif 'ext' in package:\n  python_package_data[package] = ['*.pyx', '*.pxd', '*.pxi','*.h']\nelse:\n  python_package_data[package] = ['*.pyx', '*.pxd', '*.pxi']\n```",
    "created_at": "2015-05-30T08:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246257",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>I don't understand the two cases here:

```
if 'ext' in package:
  python_package_data[package] = ['*.pyx', '*.pxd', '*.pxi','*.h']
else:
  python_package_data[package] = ['*.pyx', '*.pxd', '*.pxi']
```



---

archive/issue_comments_246258.json:
```json
{
    "body": "<a id='comment:26'></a>I originally thought only the headers in `sage/ext` and under where necessary but I hadn't put that theory through a harsh test yet. I am fixing that in the next iteration.",
    "created_at": "2015-05-30T08:21:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246258",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:26'></a>I originally thought only the headers in `sage/ext` and under where necessary but I hadn't put that theory through a harsh test yet. I am fixing that in the next iteration.



---

archive/issue_comments_246259.json:
```json
{
    "body": "<a id='comment:27'></a>Also, although installing `.pyx` files will not hurt, I wonder whether we really want to do that: I don't think that ordinary users are expected to run doctests...",
    "created_at": "2015-05-30T08:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246259",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>Also, although installing `.pyx` files will not hurt, I wonder whether we really want to do that: I don't think that ordinary users are expected to run doctests...



---

archive/issue_comments_246260.json:
```json
{
    "body": "<a id='comment:29'></a>I would not like to see every `pyx` file duplicated either...",
    "created_at": "2015-05-30T09:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246260",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:29'></a>I would not like to see every `pyx` file duplicated either...



---

archive/issue_comments_246261.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:11 jdemeyer]:\n> Is there a way to change the order of operations? The following would work:\n> \n> 1. Cythonize\n> 2. Install headers\n> 3. Compile modules (using the headers installed in step 2, not the ones generated in step 1)\n  \nAt some point we also had #14397.\nNot sure if there was a followup to this ticket.",
    "created_at": "2015-05-30T09:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246261",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:30'></a>Replying to [comment:11 jdemeyer]:
> Is there a way to change the order of operations? The following would work:
> 
> 1. Cythonize
> 2. Install headers
> 3. Compile modules (using the headers installed in step 2, not the ones generated in step 1)
  
At some point we also had #14397.
Not sure if there was a followup to this ticket.



---

archive/issue_comments_246262.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 jpflori]:\n> Replying to [comment:11 jdemeyer]:\n> > Is there a way to change the order of operations? The following would work:\n> > \n> > 1. Cythonize\n> > 2. Install headers\n> > 3. Compile modules (using the headers installed in step 2, not the ones generated in step 1)\n  \n> At some point we also had #14397.\n> Not sure if there was a followup to this ticket.\n\nHum, I guess so... and that is just what we do now with the `cythonized` directory.",
    "created_at": "2015-05-30T09:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246262",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:31'></a>Replying to [comment:30 jpflori]:
> Replying to [comment:11 jdemeyer]:
> > Is there a way to change the order of operations? The following would work:
> > 
> > 1. Cythonize
> > 2. Install headers
> > 3. Compile modules (using the headers installed in step 2, not the ones generated in step 1)
  
> At some point we also had #14397.
> Not sure if there was a followup to this ticket.

Hum, I guess so... and that is just what we do now with the `cythonized` directory.



---

archive/issue_comments_246263.json:
```json
{
    "body": "<a id='comment:32'></a>Hum... Well there are several point of views about that but I will remove it because I consider it out of scope, it shouldn't have been in that commit. \n\nMy point of view is that sage should stand on its own without the sources. As it is the doctest are only runnable once sage is installed. Ideally we could run the doctest after building but before installing. But I'll keep that bit as my own special case, separate, only in the sage-on-gentoo tree if I want to run the doctests without the source being present.",
    "created_at": "2015-05-30T09:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246263",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:32'></a>Hum... Well there are several point of views about that but I will remove it because I consider it out of scope, it shouldn't have been in that commit. 

My point of view is that sage should stand on its own without the sources. As it is the doctest are only runnable once sage is installed. Ideally we could run the doctest after building but before installing. But I'll keep that bit as my own special case, separate, only in the sage-on-gentoo tree if I want to run the doctests without the source being present.



---

archive/issue_comments_246264.json:
```json
{
    "body": "<a id='comment:33'></a>Did I just make sage automatically load `numpy` by importing it in `cython.py`?\n\n```\nsage -t --long src/sage/tests/startup.py\n**********************************************************************\nFile \"src/sage/tests/startup.py\", line 6, in sage.tests.startup\nFailed example:\n    'numpy' in sys.modules\nExpected:\n    False\nGot:\n    True\n```",
    "created_at": "2015-05-30T09:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246264",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:33'></a>Did I just make sage automatically load `numpy` by importing it in `cython.py`?

```
sage -t --long src/sage/tests/startup.py
**********************************************************************
File "src/sage/tests/startup.py", line 6, in sage.tests.startup
Failed example:
    'numpy' in sys.modules
Expected:
    False
Got:
    True
```



---

archive/issue_comments_246265.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 fbissey]:\n> Did I just make sage automatically load `numpy` by importing it in `cython.py`?\n\nSee [comment:22]",
    "created_at": "2015-05-30T10:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246265",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Replying to [comment:33 fbissey]:
> Did I just make sage automatically load `numpy` by importing it in `cython.py`?

See [comment:22]



---

archive/issue_comments_246266.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-30T10:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246266",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246267.json:
```json
{
    "body": "<a id='comment:36'></a>Still have to fix `sage_setup`. Curiously in `sage/doctest/sources.py` changing `sp` from `SAGE_LOCAL/lib/python/site-packages` to `SAGE_LOCAL/lib/python2.7/site-packages` (or `SAGE_LIB`) breaks doctesting of sagenb - in \"vanilla\" sage but not sage-on-gentoo. This was extra baggage to this ticket so I won't pursue it.",
    "created_at": "2015-05-30T10:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246267",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:36'></a>Still have to fix `sage_setup`. Curiously in `sage/doctest/sources.py` changing `sp` from `SAGE_LOCAL/lib/python/site-packages` to `SAGE_LOCAL/lib/python2.7/site-packages` (or `SAGE_LIB`) breaks doctesting of sagenb - in "vanilla" sage but not sage-on-gentoo. This was extra baggage to this ticket so I won't pursue it.



---

archive/issue_comments_246268.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:34 jdemeyer]:\n> Replying to [comment:33 fbissey]:\n> > Did I just make sage automatically load `numpy` by importing it in `cython.py`?\n\n> See [comment:22]\n\nSorry somehow a bunch of notifications didn't make it into my inbox. I will review #9952 and I'll certainly rebase on top once it is done.",
    "created_at": "2015-05-30T11:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246268",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:37'></a>Replying to [comment:34 jdemeyer]:
> Replying to [comment:33 fbissey]:
> > Did I just make sage automatically load `numpy` by importing it in `cython.py`?

> See [comment:22]

Sorry somehow a bunch of notifications didn't make it into my inbox. I will review #9952 and I'll certainly rebase on top once it is done.



---

archive/issue_comments_246269.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:22 jdemeyer]:\n> I would still like to use as much as possible the same headers in `src/setup.py` and in `cython.py`. You could make a function\n> \n> ```\n> @cached_function\n> def sage_include_directories(sage_lib_dir):\n>     \"\"\"\n>     Return the list of include directories for compiling Sage extension modules.\n>     \"\"\"\n>     import numpy   # not a global import!\n>     return [.......]\n> ```\n> returning the include directories for `cython()` if `sage_lib_dir` is `SAGE_LIB` and returning the include directories for `src/setup.py` if `sage_lib_dir` is `SAGE_SRC`. I haven't thought about is that much, but I think that's the right direction to go.\n> \n\n\nThat would be clever. I'll try that.\n\nIt is actually quite hard to work out which `.pxi`/`.pxd` will never be used which why I included the `padics` files. There is no other python sources in that directory so to package them I either have to do it as a `data_files`  or introduce a special case in `package_data`. Any chance of them being obsolete?\n\nI'll check my space after commas and correct the surroundings. I usually follow the style of what I change rather than move to a new style but I guess the space after comma should really be the standard.",
    "created_at": "2015-05-30T11:20:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246269",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:38'></a>Replying to [comment:22 jdemeyer]:
> I would still like to use as much as possible the same headers in `src/setup.py` and in `cython.py`. You could make a function
> 
> ```
> @cached_function
> def sage_include_directories(sage_lib_dir):
>     """
>     Return the list of include directories for compiling Sage extension modules.
>     """
>     import numpy   # not a global import!
>     return [.......]
> ```
> returning the include directories for `cython()` if `sage_lib_dir` is `SAGE_LIB` and returning the include directories for `src/setup.py` if `sage_lib_dir` is `SAGE_SRC`. I haven't thought about is that much, but I think that's the right direction to go.
> 


That would be clever. I'll try that.

It is actually quite hard to work out which `.pxi`/`.pxd` will never be used which why I included the `padics` files. There is no other python sources in that directory so to package them I either have to do it as a `data_files`  or introduce a special case in `package_data`. Any chance of them being obsolete?

I'll check my space after commas and correct the surroundings. I usually follow the style of what I change rather than move to a new style but I guess the space after comma should really be the standard.



---

archive/issue_comments_246270.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:38 fbissey]:\n> It is actually quite hard to work out which `.pxi`/`.pxd` will never be used which why I included the `padics` files. There is no other python sources in that directory\n\nWould it help to just add a `__init__.py` file?\n\n> Any chance of them being obsolete?\n\nNo, `mpz.pxi` is not obsolete (and `API.pxi` is really just documentation)",
    "created_at": "2015-05-30T14:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246270",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>Replying to [comment:38 fbissey]:
> It is actually quite hard to work out which `.pxi`/`.pxd` will never be used which why I included the `padics` files. There is no other python sources in that directory

Would it help to just add a `__init__.py` file?

> Any chance of them being obsolete?

No, `mpz.pxi` is not obsolete (and `API.pxi` is really just documentation)



---

archive/issue_comments_246271.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:39 jdemeyer]:\n> Replying to [comment:38 fbissey]:\n> > It is actually quite hard to work out which `.pxi`/`.pxd` will never be used which why I included the `padics` files. There is no other python sources in that directory\n\n> Would it help to just add a `__init__.py` file?\n> \n\n\nIt should. That should put the folder in `python_packages` so it should work. Putting on my list.",
    "created_at": "2015-05-30T21:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246271",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:40'></a>Replying to [comment:39 jdemeyer]:
> Replying to [comment:38 fbissey]:
> > It is actually quite hard to work out which `.pxi`/`.pxd` will never be used which why I included the `padics` files. There is no other python sources in that directory

> Would it help to just add a `__init__.py` file?
> 


It should. That should put the folder in `python_packages` so it should work. Putting on my list.



---

archive/issue_comments_246272.json:
```json
{
    "body": "<a id='comment:41'></a>How close are we of getting #17854 merged we have many item queued that clearly touch the same files. I think finishing #17854 should be the top priority there are two many things that will either depends on it or need to be rebased after it or its dependencies are merged.",
    "created_at": "2015-05-30T22:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246272",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:41'></a>How close are we of getting #17854 merged we have many item queued that clearly touch the same files. I think finishing #17854 should be the top priority there are two many things that will either depends on it or need to be rebased after it or its dependencies are merged.



---

archive/issue_comments_246273.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 fbissey]:\n> How close are we of getting #17854 merged we have many item queued that clearly touch the same files. I think finishing #17854 should be the top priority there are two many things that will either depends on it or need to be rebased after it or its dependencies are merged.\n\nI cannot really say but I see the last dependency of #17854 is getting rid of something NTL related.\nOur NTL wrapping code is really terrible with regards to what Cython can now do and we should definitely rewrite it all using actual C++ bindings.\nThis is not so difficult but very time consuming...\nSo maybe waiting for #17854 is not the right thing to do.",
    "created_at": "2015-05-30T22:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246273",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:42'></a>Replying to [comment:41 fbissey]:
> How close are we of getting #17854 merged we have many item queued that clearly touch the same files. I think finishing #17854 should be the top priority there are two many things that will either depends on it or need to be rebased after it or its dependencies are merged.

I cannot really say but I see the last dependency of #17854 is getting rid of something NTL related.
Our NTL wrapping code is really terrible with regards to what Cython can now do and we should definitely rewrite it all using actual C++ bindings.
This is not so difficult but very time consuming...
So maybe waiting for #17854 is not the right thing to do.



---

archive/issue_comments_246274.json:
```json
{
    "body": "<a id='comment:43'></a>I see. I have a vested interest in `libcsage` going away and it shows in some of my eagerness. Anyone has an idea why sage trac messages (including the digest) arrive in my inbox as \"read\"? Very annoying.",
    "created_at": "2015-05-31T00:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246274",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:43'></a>I see. I have a vested interest in `libcsage` going away and it shows in some of my eagerness. Anyone has an idea why sage trac messages (including the digest) arrive in my inbox as "read"? Very annoying.



---

archive/issue_comments_246275.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:41 fbissey]:\n> How close are we of getting #17854 merged\n\nSince it's needs_review, that only depends on whether or not somebody wants to review it.",
    "created_at": "2015-05-31T08:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246275",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>Replying to [comment:41 fbissey]:
> How close are we of getting #17854 merged

Since it's needs_review, that only depends on whether or not somebody wants to review it.



---

archive/issue_comments_246276.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:42 jpflori]:\n> Our NTL wrapping code is really terrible with regards to what Cython can now do and we should definitely rewrite it all using actual C++ bindings.\n> This is not so difficult but very time consuming...\n\n\nI agree completely with the above statement. Note that #18367 doesn't really clean-up the NTL interface, it just moves it from `c_lib` to the Sage library.",
    "created_at": "2015-05-31T08:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246276",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>Replying to [comment:42 jpflori]:
> Our NTL wrapping code is really terrible with regards to what Cython can now do and we should definitely rewrite it all using actual C++ bindings.
> This is not so difficult but very time consuming...


I agree completely with the above statement. Note that #18367 doesn't really clean-up the NTL interface, it just moves it from `c_lib` to the Sage library.



---

archive/issue_comments_246277.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:45 jdemeyer]:\n> Replying to [comment:41 fbissey]:\n> > How close are we of getting #17854 merged\n\n> Since it's needs_review, that only depends on whether or not somebody wants to review it.\n\nIt seems to need re-basing but #18367 seems to be clean and ready for a run on the patchbot as far as I can see.",
    "created_at": "2015-05-31T08:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246277",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:47'></a>Replying to [comment:45 jdemeyer]:
> Replying to [comment:41 fbissey]:
> > How close are we of getting #17854 merged

> Since it's needs_review, that only depends on whether or not somebody wants to review it.

It seems to need re-basing but #18367 seems to be clean and ready for a run on the patchbot as far as I can see.



---

archive/issue_comments_246278.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:47 fbissey]:\n> It seems to need re-basing\n\nIt merges cleanly for me... don't get confused by the red Trac link.",
    "created_at": "2015-05-31T08:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246278",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>Replying to [comment:47 fbissey]:
> It seems to need re-basing

It merges cleanly for me... don't get confused by the red Trac link.



---

archive/issue_comments_246279.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:48 jdemeyer]:\n> Replying to [comment:47 fbissey]:\n> > It seems to need re-basing\n\n> It merges cleanly for me... don't get confused by the red Trac link.\n\nOK, regardless I have noticed that #18450 is also needed and in need of review. And there seem to be no progress with upstream cython on that one, which puts a damper on the whole thing.",
    "created_at": "2015-05-31T08:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246279",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:49'></a>Replying to [comment:48 jdemeyer]:
> Replying to [comment:47 fbissey]:
> > It seems to need re-basing

> It merges cleanly for me... don't get confused by the red Trac link.

OK, regardless I have noticed that #18450 is also needed and in need of review. And there seem to be no progress with upstream cython on that one, which puts a damper on the whole thing.



---

archive/issue_comments_246280.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:49 fbissey]:\n> OK, regardless I have noticed that #18450 is also needed and in need of review.\n\nIt is not really needed for #18450, it's mostly a dependency to avoid conflicts.\n\n> And there seem to be no progress with upstream cython on that one\n\nMy personal opinion is that we shouldn't care too much about what upstream thinks. Note that upstream Cython has not given a **single reason** why they are against my feature on #18450.",
    "created_at": "2015-05-31T09:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246280",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>Replying to [comment:49 fbissey]:
> OK, regardless I have noticed that #18450 is also needed and in need of review.

It is not really needed for #18450, it's mostly a dependency to avoid conflicts.

> And there seem to be no progress with upstream cython on that one

My personal opinion is that we shouldn't care too much about what upstream thinks. Note that upstream Cython has not given a **single reason** why they are against my feature on #18450.



---

archive/issue_comments_246281.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 fbissey]:\n> And there seem to be no progress with upstream cython on that one, which puts a damper on the whole thing.\n\nBut a very tiny damper regardless. It's trivial to fix #18450 such that it does not depend on the non-accepted Cython patch.",
    "created_at": "2015-05-31T09:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246281",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>Replying to [comment:49 fbissey]:
> And there seem to be no progress with upstream cython on that one, which puts a damper on the whole thing.

But a very tiny damper regardless. It's trivial to fix #18450 such that it does not depend on the non-accepted Cython patch.



---

archive/issue_comments_246282.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:50 jdemeyer]:\n> Replying to [comment:49 fbissey]:\n> > OK, regardless I have noticed that #18450 is also needed and in need of review.\n\n> It is not really needed for #18450, it's mostly a dependency to avoid conflicts.\n> \n> > And there seem to be no progress with upstream cython on that one\n\n> My personal opinion is that we shouldn't care too much about what upstream thinks. Note that upstream Cython has not given a **single reason** why they are against my feature on #18450.\n\nYes very strange conversation I have to agree. Upstream think their reasons are obvious. Unfortunately while I am sure you don't care it makes my other life a bit too \"interesting\". \n\nBut I should start re-writing stuff for this ticket, if there are conflicts we'll sort them out when we work out the merge order.",
    "created_at": "2015-05-31T10:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246282",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:52'></a>Replying to [comment:50 jdemeyer]:
> Replying to [comment:49 fbissey]:
> > OK, regardless I have noticed that #18450 is also needed and in need of review.

> It is not really needed for #18450, it's mostly a dependency to avoid conflicts.
> 
> > And there seem to be no progress with upstream cython on that one

> My personal opinion is that we shouldn't care too much about what upstream thinks. Note that upstream Cython has not given a **single reason** why they are against my feature on #18450.

Yes very strange conversation I have to agree. Upstream think their reasons are obvious. Unfortunately while I am sure you don't care it makes my other life a bit too "interesting". 

But I should start re-writing stuff for this ticket, if there are conflicts we'll sort them out when we work out the merge order.



---

archive/issue_comments_246283.json:
```json
{
    "body": "<a id='comment:53'></a>Replying to [comment:22 jdemeyer]:\n> I would still like to use as much as possible the same headers in `src/setup.py` and in `cython.py`. You could make a function\n> \n> ```\n> @cached_function\n> def sage_include_directories(sage_lib_dir):\n>     \"\"\"\n>     Return the list of include directories for compiling Sage extension modules.\n>     \"\"\"\n>     import numpy   # not a global import!\n>     return [.......]\n> ```\n\n\nLeast you think I am not working on this. My attention had to be divided between a number of things but I am still working on this. Any recommendation on where to put this function? We do not want to put it in `cython.py` because we don't want to import any bits of it in `setup.py` (bad things will happen to you if you do). I don't want to put it anywhere in `sage_setup` because it should only be used at build time not runtime, same for `module_list.py`. `env.py` could be interesting if I can get away with it. The other possibilities: \n* its own file\n* something I haven't thought about\n\nopinions?",
    "created_at": "2015-06-02T23:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246283",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:53'></a>Replying to [comment:22 jdemeyer]:
> I would still like to use as much as possible the same headers in `src/setup.py` and in `cython.py`. You could make a function
> 
> ```
> @cached_function
> def sage_include_directories(sage_lib_dir):
>     """
>     Return the list of include directories for compiling Sage extension modules.
>     """
>     import numpy   # not a global import!
>     return [.......]
> ```


Least you think I am not working on this. My attention had to be divided between a number of things but I am still working on this. Any recommendation on where to put this function? We do not want to put it in `cython.py` because we don't want to import any bits of it in `setup.py` (bad things will happen to you if you do). I don't want to put it anywhere in `sage_setup` because it should only be used at build time not runtime, same for `module_list.py`. `env.py` could be interesting if I can get away with it. The other possibilities: 
* its own file
* something I haven't thought about

opinions?



---

archive/issue_comments_246284.json:
```json
{
    "body": "<a id='comment:54'></a>Actually, `env.py` sounds like a good suggestion. You'll need to move `SAGE_INC` (currently defined in `setup.py`) also to `env.py`.\n\nI'd wait for 6.8.beta3 though to be safe with merge conflicts.",
    "created_at": "2015-06-03T05:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246284",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>Actually, `env.py` sounds like a good suggestion. You'll need to move `SAGE_INC` (currently defined in `setup.py`) also to `env.py`.

I'd wait for 6.8.beta3 though to be safe with merge conflicts.



---

archive/issue_comments_246285.json:
```json
{
    "body": "<a id='comment:55'></a>In `src/setup.py`, it would be good to define a new variable for the `build/cythonized` directory.",
    "created_at": "2015-06-03T08:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246285",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>In `src/setup.py`, it would be good to define a new variable for the `build/cythonized` directory.



---

archive/issue_comments_246286.json:
```json
{
    "body": "<a id='comment:56'></a>OK, I'll wait beta3 to put the work to \"need review\" but I could already present stuff for scrutiny, it is quite advanced now. Bringing `SAGE_INC` to the `sage.env` sounds a good idea, hopefully it will be its final destination (I am sure it started in `module_list.py`). If you think a variable for `build/cythonized` would be useful I can throw that in, suggestion for the name?",
    "created_at": "2015-06-03T09:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246286",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:56'></a>OK, I'll wait beta3 to put the work to "need review" but I could already present stuff for scrutiny, it is quite advanced now. Bringing `SAGE_INC` to the `sage.env` sounds a good idea, hopefully it will be its final destination (I am sure it started in `module_list.py`). If you think a variable for `build/cythonized` would be useful I can throw that in, suggestion for the name?



---

archive/issue_comments_246287.json:
```json
{
    "body": "<a id='comment:57'></a>Replying to [comment:56 fbissey]:\n> If you think a variable for `build/cythonized` would be useful I can throw that in, suggestion for the name?\n\n`SAGE_CYTHONIZED`?",
    "created_at": "2015-06-03T09:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246287",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:57'></a>Replying to [comment:56 fbissey]:
> If you think a variable for `build/cythonized` would be useful I can throw that in, suggestion for the name?

`SAGE_CYTHONIZED`?



---

archive/issue_comments_246288.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:56 fbissey]:\n> OK, I'll wait beta3 to put the work to \"need review\" but I could already present stuff for scrutiny, it is quite advanced now.\n\n\nFor me, you don't need to wait to put it to needs_review, just be aware of #9552, #18450, #18367 (and #17854 which isn't reviewed yet).",
    "created_at": "2015-06-03T09:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246288",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>Replying to [comment:56 fbissey]:
> OK, I'll wait beta3 to put the work to "need review" but I could already present stuff for scrutiny, it is quite advanced now.


For me, you don't need to wait to put it to needs_review, just be aware of #9552, #18450, #18367 (and #17854 which isn't reviewed yet).



---

archive/issue_comments_246289.json:
```json
{
    "body": "<a id='comment:59'></a>I should be able to rebase/update everything in the next couple of days, including this little surprise\n\n```\nFile \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 231, in sage.misc.cython.pyx_preparse\nFailed example:\n    module = sage.misc.cython.import_test(\"trac11680\")  # long time (7s on sage.math, 2012)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.cython.pyx_preparse[9]>\", line 1, in <module>\n        module = sage.misc.cython.import_test(\"trac11680\")  # long time (7s on sage.math, 2012)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 810, in import_test\n        return compile_and_load(TESTS[name])\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 763, in compile_and_load\n        return cython_import(file, create_local_c_file=False)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 687, in cython_import\n        **kwds)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 480, in cython\n        raise RuntimeError(\"Error compiling {}:\\n{}\\n{}\".format(filename, log, err))\n    RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/31051/tmp_zyUtdw.pyx:\n    running build\n    running build_ext\n    building '_home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0' extension\n    creating build\n    creating build/temp.linux-x86_64-2.7\n    x86_64-pc-linux-gnu-gcc -pthread -fPIC -I/usr/lib64/python2.7/site-packages/sage/libs/flint -I/usr//include/flint -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/home/fbissey/.sage/temp/QCD-nzi3/31051 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0.c -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0.o -w -O2 -O3 -ggdb\n\n    _home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0.c:258:37: fatal error: sage/libs/ntl/ntlwrap.cpp: No such file or directory\n     #include \"sage/libs/ntl/ntlwrap.cpp\"\n                                         ^\n    compilation terminated.\n    error: command 'x86_64-pc-linux-gnu-gcc' failed with exit status 1\n```\nSo that is one extra file to ship, the only one of its kind.",
    "created_at": "2015-06-05T19:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246289",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:59'></a>I should be able to rebase/update everything in the next couple of days, including this little surprise

```
File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 231, in sage.misc.cython.pyx_preparse
Failed example:
    module = sage.misc.cython.import_test("trac11680")  # long time (7s on sage.math, 2012)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cython.pyx_preparse[9]>", line 1, in <module>
        module = sage.misc.cython.import_test("trac11680")  # long time (7s on sage.math, 2012)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 810, in import_test
        return compile_and_load(TESTS[name])
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 763, in compile_and_load
        return cython_import(file, create_local_c_file=False)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 687, in cython_import
        **kwds)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 480, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/31051/tmp_zyUtdw.pyx:
    running build
    running build_ext
    building '_home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0' extension
    creating build
    creating build/temp.linux-x86_64-2.7
    x86_64-pc-linux-gnu-gcc -pthread -fPIC -I/usr/lib64/python2.7/site-packages/sage/libs/flint -I/usr//include/flint -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/home/fbissey/.sage/temp/QCD-nzi3/31051 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0.c -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0.o -w -O2 -O3 -ggdb

    _home_fbissey__sage_temp_QCD_nzi3_31051_tmp_zyUtdw_pyx_0.c:258:37: fatal error: sage/libs/ntl/ntlwrap.cpp: No such file or directory
     #include "sage/libs/ntl/ntlwrap.cpp"
                                         ^
    compilation terminated.
    error: command 'x86_64-pc-linux-gnu-gcc' failed with exit status 1
```
So that is one extra file to ship, the only one of its kind.



---

archive/issue_comments_246290.json:
```json
{
    "body": "<a id='comment:60'></a>Pushed newer version of the work, I am still testing things so I am not putting to review but feedback welcome. After that work, I still feel unsatisfied. Like a few year ago I thought the usage of `SAGE_ROOT` was excessive in sage, I now think the usage of `SAGE_SRC` is excessive. It is legit for doctesting but there are some cases where the sources are used at runtime when installed files should be used. On the whole with this commit things should work if you set `SAGE_SRC=SAGE_LIB` with the possible exception of `cython` debugging which I would have to check.\n\n---\nNew commits:",
    "created_at": "2015-06-06T11:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246290",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:60'></a>Pushed newer version of the work, I am still testing things so I am not putting to review but feedback welcome. After that work, I still feel unsatisfied. Like a few year ago I thought the usage of `SAGE_ROOT` was excessive in sage, I now think the usage of `SAGE_SRC` is excessive. It is legit for doctesting but there are some cases where the sources are used at runtime when installed files should be used. On the whole with this commit things should work if you set `SAGE_SRC=SAGE_LIB` with the possible exception of `cython` debugging which I would have to check.

---
New commits:



---

archive/issue_comments_246291.json:
```json
{
    "body": "<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-06T21:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246292.json:
```json
{
    "body": "<a id='comment:62'></a>Fixed the last few doctests, I am putting this to needs_review.",
    "created_at": "2015-06-06T21:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246292",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:62'></a>Fixed the last few doctests, I am putting this to needs_review.



---

archive/issue_comments_246293.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-06T21:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246293",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_246294.json:
```json
{
    "body": "<a id='comment:63'></a>Patchbot seem to like it. I am waiting for review before moving back to #17630 based on this ticket.",
    "created_at": "2015-06-08T09:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246294",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:63'></a>Patchbot seem to like it. I am waiting for review before moving back to #17630 based on this ticket.



---

archive/issue_comments_246295.json:
```json
{
    "body": "<a id='comment:64'></a>To allow for future auto-generation of `python_data_files`, I would prefer to start out with a list\n\n```\ncython_generated_files = [\n    os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt_api.h'),\n    os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt.h')\n]\n```\nand then generate `python_data_files` from that. That would also be more readable than the \n`[(()[()()])]` nesting.",
    "created_at": "2015-06-08T10:15:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246295",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:64'></a>To allow for future auto-generation of `python_data_files`, I would prefer to start out with a list

```
cython_generated_files = [
    os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt_api.h'),
    os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt.h')
]
```
and then generate `python_data_files` from that. That would also be more readable than the 
`[(()[()()])]` nesting.



---

archive/issue_comments_246296.json:
```json
{
    "body": "<a id='comment:65'></a>Some formatting issues:\n1. use 4 space indents in `for package in python_packages:`\n2. format the docstring of `def sage_include_directories():` according to [http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings](http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings)\n3. remove the redundant `\\` in `def sage_include_directories()`",
    "created_at": "2015-06-08T10:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246296",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:65'></a>Some formatting issues:
1. use 4 space indents in `for package in python_packages:`
2. format the docstring of `def sage_include_directories():` according to [http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings](http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings)
3. remove the redundant `\` in `def sage_include_directories()`



---

archive/issue_comments_246297.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-08T10:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246297",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_246298.json:
```json
{
    "body": "<a id='comment:66'></a>`SAGE_CYTHONIZED` should use an absolute path (relative to `SAGE_SRC`)",
    "created_at": "2015-06-08T10:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246298",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:66'></a>`SAGE_CYTHONIZED` should use an absolute path (relative to `SAGE_SRC`)



---

archive/issue_comments_246299.json:
```json
{
    "body": "<a id='comment:67'></a>Instead of an argument `phase='runtime'` (whose intentions are not so clear to me), I would prefer to see something more explicit like `use_sources=False`. Using a boolean will also avoid the need for\n\n```\nelse:\n    raise ValueError('phase not recognised')\n    return               # <--- This line is redundant by the way\n```",
    "created_at": "2015-06-08T10:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246299",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:67'></a>Instead of an argument `phase='runtime'` (whose intentions are not so clear to me), I would prefer to see something more explicit like `use_sources=False`. Using a boolean will also avoid the need for

```
else:
    raise ValueError('phase not recognised')
    return               # <--- This line is redundant by the way
```



---

archive/issue_comments_246300.json:
```json
{
    "body": "<a id='comment:68'></a>Replying to [comment:66 jdemeyer]:\n> `SAGE_CYTHONIZED` should use an absolute path (relative to `SAGE_SRC`)\n\n\nOk I initially did that and reverted because it broke a doctest (`sage/repl/interpreter.py`) but I have no objection to making it absolute and fixing the doctest instead. \n\nAll comments sound good to me, I guess my vocabulary on \"phase\" is packaging speak, your suggestion is simpler.",
    "created_at": "2015-06-08T10:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246300",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:68'></a>Replying to [comment:66 jdemeyer]:
> `SAGE_CYTHONIZED` should use an absolute path (relative to `SAGE_SRC`)


Ok I initially did that and reverted because it broke a doctest (`sage/repl/interpreter.py`) but I have no objection to making it absolute and fixing the doctest instead. 

All comments sound good to me, I guess my vocabulary on "phase" is packaging speak, your suggestion is simpler.



---

archive/issue_comments_246301.json:
```json
{
    "body": "<a id='comment:69'></a>In `src/sage_setup/clean.py`, rename `extensions` as `skip_extensions`.",
    "created_at": "2015-06-08T10:29:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246301",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:69'></a>In `src/sage_setup/clean.py`, rename `extensions` as `skip_extensions`.



---

archive/issue_comments_246302.json:
```json
{
    "body": "<a id='comment:70'></a>Replace `opj(x)` by `x`",
    "created_at": "2015-06-08T10:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246302",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:70'></a>Replace `opj(x)` by `x`



---

archive/issue_comments_246303.json:
```json
{
    "body": "<a id='comment:71'></a>I am experiencing a difficulty while writing an \"examples\" section. The example works fine from the sage prompt but during doctesting I get\n\n```\nsage -t --long src/sage/env.py\n**********************************************************************\nFile \"src/sage/env.py\", line 164, in sage.env.sage_include_directories\nFailed example:\n    sage.env.sage_include_directories()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.env.sage_include_directories[1]>\", line 1, in <module>\n        sage.env.sage_include_directories()\n    AttributeError: 'module' object has no attribute 'sage_include_directories'\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.env.sage_include_directories\n    [12 tests, 1 failure, 0.01 s]\n```\nThe code tested is\n\n```\nsage: import sage.env\nsage: sage.env.sage_include_directories()\n['/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/include',\n '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/include/python2.7',\n '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/lib/python2.7/site-packages/numpy/core/include',\n '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/lib/python2.7/site-packages',\n '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/lib/python2.7/site-packages/sage/ext']\n```",
    "created_at": "2015-06-08T12:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246303",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:71'></a>I am experiencing a difficulty while writing an "examples" section. The example works fine from the sage prompt but during doctesting I get

```
sage -t --long src/sage/env.py
**********************************************************************
File "src/sage/env.py", line 164, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.env.sage_include_directories[1]>", line 1, in <module>
        sage.env.sage_include_directories()
    AttributeError: 'module' object has no attribute 'sage_include_directories'
**********************************************************************
1 item had failures:
   1 of   3 in sage.env.sage_include_directories
    [12 tests, 1 failure, 0.01 s]
```
The code tested is

```
sage: import sage.env
sage: sage.env.sage_include_directories()
['/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/include',
 '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/include/python2.7',
 '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/lib/python2.7/site-packages/numpy/core/include',
 '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/lib/python2.7/site-packages',
 '/home/fbissey/sandbox/git-fork/sage-6.8.beta3/local/lib/python2.7/site-packages/sage/ext']
```



---

archive/issue_comments_246304.json:
```json
{
    "body": "<a id='comment:72'></a>It was the wrong `sage` being executed... Commits coming.",
    "created_at": "2015-06-08T13:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246304",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:72'></a>It was the wrong `sage` being executed... Commits coming.



---

archive/issue_comments_246305.json:
```json
{
    "body": "<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-08T13:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246305",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246306.json:
```json
{
    "body": "<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-08T13:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246306",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246307.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-08T13:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246307",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_246308.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-08T14:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246308",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_246309.json:
```json
{
    "body": "<a id='comment:76'></a>Can you make `use_sources` an actual boolean, not a string with value \"True\" or \"False\"?",
    "created_at": "2015-06-08T14:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246309",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:76'></a>Can you make `use_sources` an actual boolean, not a string with value "True" or "False"?



---

archive/issue_comments_246310.json:
```json
{
    "body": "<a id='comment:77'></a>I don't want to assume that all `cython_generated_files` are in `sage/ext/interrupt`, so I don't like this:\n\n```\npython_data_files = [\n    (os.path.join(SAGE_LIB, 'sage', 'ext', 'interrupt'), cython_generated_files)\n]\n```\n\nEventually, also files like `src/build/cythonized/sage/modular/arithgroup/farey_symbol.h` should be installed in the correct directory.",
    "created_at": "2015-06-08T14:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246310",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:77'></a>I don't want to assume that all `cython_generated_files` are in `sage/ext/interrupt`, so I don't like this:

```
python_data_files = [
    (os.path.join(SAGE_LIB, 'sage', 'ext', 'interrupt'), cython_generated_files)
]
```

Eventually, also files like `src/build/cythonized/sage/modular/arithgroup/farey_symbol.h` should be installed in the correct directory.



---

archive/issue_comments_246311.json:
```json
{
    "body": "<a id='comment:78'></a>Replying to [comment:77 jdemeyer]:\n> I don't want to assume that all `cython_generated_files` are in `sage/ext/interrupt`, so I don't like this:\n> \n> ```\n> python_data_files = [\n>     (os.path.join(SAGE_LIB, 'sage', 'ext', 'interrupt'), cython_generated_files)\n> ]\n> ```\n> \n> Eventually, also files like `src/build/cythonized/sage/modular/arithgroup/farey_symbol.h` should be installed in the correct directory.\n\n\nI guess we could use a slice but that wouldn't be as clean as using a dictionary or specifically named variable. I would go for the dictionary.",
    "created_at": "2015-06-08T21:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246311",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:78'></a>Replying to [comment:77 jdemeyer]:
> I don't want to assume that all `cython_generated_files` are in `sage/ext/interrupt`, so I don't like this:
> 
> ```
> python_data_files = [
>     (os.path.join(SAGE_LIB, 'sage', 'ext', 'interrupt'), cython_generated_files)
> ]
> ```
> 
> Eventually, also files like `src/build/cythonized/sage/modular/arithgroup/farey_symbol.h` should be installed in the correct directory.


I guess we could use a slice but that wouldn't be as clean as using a dictionary or specifically named variable. I would go for the dictionary.



---

archive/issue_comments_246312.json:
```json
{
    "body": "<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-09T00:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246313.json:
```json
{
    "body": "<a id='comment:80'></a>OK moved to a new design but I feel I just pushed the old ugliness of `python_data_files` in `cython_generated_files` with better documentation.",
    "created_at": "2015-06-09T00:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246313",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:80'></a>OK moved to a new design but I feel I just pushed the old ugliness of `python_data_files` in `cython_generated_files` with better documentation.



---

archive/issue_comments_246314.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-09T00:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246314",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_246315.json:
```json
{
    "body": "<a id='comment:81'></a>seeking new review, would very much wants this or something close to it in the next beta/rc.",
    "created_at": "2015-06-11T01:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246315",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:81'></a>seeking new review, would very much wants this or something close to it in the next beta/rc.



---

archive/issue_comments_246316.json:
```json
{
    "body": "<a id='comment:82'></a>Replying to [comment:80 fbissey]:\n> I feel I just pushed the old ugliness of `python_data_files` in `cython_generated_files` with better documentation.\n\nI agree and what you did is not quite what I had in mind: the point is that the `ext/interrupt` should be *computed* from the `os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt.h')` part.\n\nOn the other hard, if you're tired of making these changes, they could be postponed to a follow-up ticket.",
    "created_at": "2015-06-11T06:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246316",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:82'></a>Replying to [comment:80 fbissey]:
> I feel I just pushed the old ugliness of `python_data_files` in `cython_generated_files` with better documentation.

I agree and what you did is not quite what I had in mind: the point is that the `ext/interrupt` should be *computed* from the `os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt.h')` part.

On the other hard, if you're tired of making these changes, they could be postponed to a follow-up ticket.



---

archive/issue_comments_246317.json:
```json
{
    "body": "<a id='comment:83'></a>Replying to [comment:82 jdemeyer]:\n> Replying to [comment:80 fbissey]:\n> > I feel I just pushed the old ugliness of `python_data_files` in `cython_generated_files` with better documentation.\n\n> I agree and what you did is not quite what I had in mind: the point is that the `ext/interrupt` should be *computed* from the `os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt.h')` part.\n> \n> On the other hard, if you're tired of making these changes, they could be postponed to a follow-up ticket.\n\n\nI see what you have in mind now. I may have an idea how to do something like that, but I am giving myself a time limit. If I cannot work it out in the next 24hours, it'll be a follow up ticket.",
    "created_at": "2015-06-11T08:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246317",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:83'></a>Replying to [comment:82 jdemeyer]:
> Replying to [comment:80 fbissey]:
> > I feel I just pushed the old ugliness of `python_data_files` in `cython_generated_files` with better documentation.

> I agree and what you did is not quite what I had in mind: the point is that the `ext/interrupt` should be *computed* from the `os.path.join(SAGE_CYTHONIZED, 'sage', 'ext', 'interrupt', 'interrupt.h')` part.
> 
> On the other hard, if you're tired of making these changes, they could be postponed to a follow-up ticket.


I see what you have in mind now. I may have an idea how to do something like that, but I am giving myself a time limit. If I cannot work it out in the next 24hours, it'll be a follow up ticket.



---

archive/issue_comments_246318.json:
```json
{
    "body": "<a id='comment:84'></a>I think this is important also for #12375 and #18514.",
    "created_at": "2015-06-11T11:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246318",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:84'></a>I think this is important also for #12375 and #18514.



---

archive/issue_comments_246319.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2015-06-11T11:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246319",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_246320.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-11T11:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246320",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_246321.json:
```json
{
    "body": "<a id='comment:85'></a>Replying to [comment:83 fbissey]:\n> I see what you have in mind now. I may have an idea how to do something like that, but I am giving myself a time limit. If I cannot work it out in the next 24hours, it'll be a follow up ticket.\n\n\nExcellent. I'll set this ticket to needs_work now. Feel free to set it back to needs_review (with or without making further changes).",
    "created_at": "2015-06-11T11:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246321",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:85'></a>Replying to [comment:83 fbissey]:
> I see what you have in mind now. I may have an idea how to do something like that, but I am giving myself a time limit. If I cannot work it out in the next 24hours, it'll be a follow up ticket.


Excellent. I'll set this ticket to needs_work now. Feel free to set it back to needs_review (with or without making further changes).



---

archive/issue_comments_246322.json:
```json
{
    "body": "<a id='comment:86'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-11T12:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246322",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:86'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246323.json:
```json
{
    "body": "<a id='comment:87'></a>Seems to be working from the list of files now.",
    "created_at": "2015-06-11T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246323",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:87'></a>Seems to be working from the list of files now.



---

archive/issue_comments_246324.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-11T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246324",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_246325.json:
```json
{
    "body": "<a id='comment:88'></a>This comments needs to be updated:\n\n```\n# This is stored as a dictionary with the key being the directory to install the file under sage.\n```",
    "created_at": "2015-06-11T13:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246325",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:88'></a>This comments needs to be updated:

```
# This is stored as a dictionary with the key being the directory to install the file under sage.
```



---

archive/issue_comments_246326.json:
```json
{
    "body": "<a id='comment:89'></a>`INPUTS` and `OUTPUTS` should be `INPUT` and `OUTPUT`.",
    "created_at": "2015-06-11T13:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246326",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:89'></a>`INPUTS` and `OUTPUTS` should be `INPUT` and `OUTPUT`.



---

archive/issue_comments_246327.json:
```json
{
    "body": "<a id='comment:90'></a>```\nsage -t --long src/sage/repl/interpreter.py\n**********************************************************************\nFile \"src/sage/repl/interpreter.py\", line 77, in sage.repl.interpreter\nFailed example:\n    shell.run_cell('1/0')\nExpected:\n    ---------------------------------------------------------------------------\n    .../sage/rings/integer_ring.pyx in sage.rings.integer_ring.IntegerRing_class._div (.../build/cythonized/sage/rings/integer_ring.c:...)()\n        ...         cdef rational.Rational x = rational.Rational.__new__(rational.Rational)\n        ...         if mpz_sgn(right.value) == 0:\n        ...             raise ZeroDivisionError('Rational division by zero')\n        ...         mpz_set(mpq_numref(x.value), left.value)\n        ...         mpz_set(mpq_denref(x.value), right.value)\n    <BLANKLINE>\n    ZeroDivisionError: Rational division by zero\nGot:\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    <ipython-input-1-6f88eab09598> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    /usr/local/src/sage-config/src/sage/structure/element.pyx in sage.structure.element.RingElement.__div__ (build/cythonized/sage/structure/element.c:18132)()\n       2034                 return (<RingElement>self)._idiv_(<RingElement>right)\n       2035             else:\n    -> 2036                 return (<RingElement>self)._div_(<RingElement>right)\n       2037         global coercion_model\n       2038         return coercion_model.bin_op(self, right, div)\n    <BLANKLINE>\n    /usr/local/src/sage-config/src/sage/rings/integer.pyx in sage.rings.integer.Integer._div_ (build/cythonized/sage/rings/integer.c:12151)()\n       1748         # This is vastly faster than doing it here, since here\n       1749         # we can't cimport rationals.\n    -> 1750         return the_integer_ring._div(self, right)\n       1751 \n       1752     def __floordiv__(x, y):\n    <BLANKLINE>\n    /usr/local/src/sage-config/src/sage/rings/integer_ring.pyx in sage.rings.integer_ring.IntegerRing_class._div (build/cythonized/sage/rings/integer_ring.c:4900)()\n        420         cdef rational.Rational x = rational.Rational.__new__(rational.Rational)\n        421         if mpz_sgn(right.value) == 0:\n    --> 422             raise ZeroDivisionError('Rational division by zero')\n        423         mpz_set(mpq_numref(x.value), left.value)\n        424         mpz_set(mpq_denref(x.value), right.value)\n    <BLANKLINE>\n    ZeroDivisionError: Rational division by zero\n**********************************************************************\n```",
    "created_at": "2015-06-11T15:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246327",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:90'></a>```
sage -t --long src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    shell.run_cell('1/0')
Expected:
    ---------------------------------------------------------------------------
    .../sage/rings/integer_ring.pyx in sage.rings.integer_ring.IntegerRing_class._div (.../build/cythonized/sage/rings/integer_ring.c:...)()
        ...         cdef rational.Rational x = rational.Rational.__new__(rational.Rational)
        ...         if mpz_sgn(right.value) == 0:
        ...             raise ZeroDivisionError('Rational division by zero')
        ...         mpz_set(mpq_numref(x.value), left.value)
        ...         mpz_set(mpq_denref(x.value), right.value)
    <BLANKLINE>
    ZeroDivisionError: Rational division by zero
Got:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-6f88eab09598> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /usr/local/src/sage-config/src/sage/structure/element.pyx in sage.structure.element.RingElement.__div__ (build/cythonized/sage/structure/element.c:18132)()
       2034                 return (<RingElement>self)._idiv_(<RingElement>right)
       2035             else:
    -> 2036                 return (<RingElement>self)._div_(<RingElement>right)
       2037         global coercion_model
       2038         return coercion_model.bin_op(self, right, div)
    <BLANKLINE>
    /usr/local/src/sage-config/src/sage/rings/integer.pyx in sage.rings.integer.Integer._div_ (build/cythonized/sage/rings/integer.c:12151)()
       1748         # This is vastly faster than doing it here, since here
       1749         # we can't cimport rationals.
    -> 1750         return the_integer_ring._div(self, right)
       1751 
       1752     def __floordiv__(x, y):
    <BLANKLINE>
    /usr/local/src/sage-config/src/sage/rings/integer_ring.pyx in sage.rings.integer_ring.IntegerRing_class._div (build/cythonized/sage/rings/integer_ring.c:4900)()
        420         cdef rational.Rational x = rational.Rational.__new__(rational.Rational)
        421         if mpz_sgn(right.value) == 0:
    --> 422             raise ZeroDivisionError('Rational division by zero')
        423         mpz_set(mpq_numref(x.value), left.value)
        424         mpz_set(mpq_denref(x.value), right.value)
    <BLANKLINE>
    ZeroDivisionError: Rational division by zero
**********************************************************************
```



---

archive/issue_comments_246328.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-11T15:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246328",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_246329.json:
```json
{
    "body": "<a id='comment:92'></a>Replying to [comment:89 jdemeyer]:\n> `INPUTS` and `OUTPUTS` should be `INPUT` and `OUTPUT`.\n\nI really need to get some glasses, and stop reading stuff in the middle of the night too. The failing doctest shouldn't be. It probably means `sage/rings/integer_ring.pyx` hasn't been rebuilt after you patched. I thought touching setup.py would trigger that.",
    "created_at": "2015-06-11T21:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246329",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:92'></a>Replying to [comment:89 jdemeyer]:
> `INPUTS` and `OUTPUTS` should be `INPUT` and `OUTPUT`.

I really need to get some glasses, and stop reading stuff in the middle of the night too. The failing doctest shouldn't be. It probably means `sage/rings/integer_ring.pyx` hasn't been rebuilt after you patched. I thought touching setup.py would trigger that.



---

archive/issue_comments_246330.json:
```json
{
    "body": "<a id='comment:93'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-11T21:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246330",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:93'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246331.json:
```json
{
    "body": "<a id='comment:94'></a>I am putting this back to \"need_review\" unless someone really wants to do something to trigger the rebuild of `sage/rings/integer_ring.pyx` that I haven't touched but for which the building directory is doctested in a completely unrelated file, I think it should go in.",
    "created_at": "2015-06-11T21:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246331",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:94'></a>I am putting this back to "need_review" unless someone really wants to do something to trigger the rebuild of `sage/rings/integer_ring.pyx` that I haven't touched but for which the building directory is doctested in a completely unrelated file, I think it should go in.



---

archive/issue_comments_246332.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-11T21:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246332",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_246333.json:
```json
{
    "body": "<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-11T23:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246333",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_246334.json:
```json
{
    "body": "<a id='comment:96'></a>Just one more push, changing the doctest a little bit means that it will pass whether or not we have a rebuild of `integer_ring.pyx` and it doesn't impact what the test is designed to do I believe.",
    "created_at": "2015-06-11T23:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246334",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:96'></a>Just one more push, changing the doctest a little bit means that it will pass whether or not we have a rebuild of `integer_ring.pyx` and it doesn't impact what the test is designed to do I believe.



---

archive/issue_comments_246335.json:
```json
{
    "body": "<a id='comment:97'></a>Replying to [comment:92 fbissey]:\n> It probably means `sage/rings/integer_ring.pyx` hasn't been rebuilt after you patched. I thought touching setup.py would trigger that.\n\nNo, changing `setup.py` triggers re-compilation of everything (i.e. running of `gcc`) but not re-cythonizing. The usual trick to do that is to change what's in the `.cython_version` file, see line 545 of `setup.py`.",
    "created_at": "2015-06-12T04:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246335",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:97'></a>Replying to [comment:92 fbissey]:
> It probably means `sage/rings/integer_ring.pyx` hasn't been rebuilt after you patched. I thought touching setup.py would trigger that.

No, changing `setup.py` triggers re-compilation of everything (i.e. running of `gcc`) but not re-cythonizing. The usual trick to do that is to change what's in the `.cython_version` file, see line 545 of `setup.py`.



---

archive/issue_comments_246336.json:
```json
{
    "body": "<a id='comment:98'></a>I guess this is good to go now.",
    "created_at": "2015-06-12T05:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246336",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:98'></a>I guess this is good to go now.



---

archive/issue_comments_246337.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-12T05:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246337",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_246338.json:
```json
{
    "body": "<a id='comment:99'></a>Sorry for the delay but I  still have problems with trac12375. I have tried to isolate the problem:\n(can you reproduce it?)\n\nsetup.py:\n\n```/usr/bin/env sage -python\nfrom sage.env import *\nimport os\n\n###\ntry:\n    # Sage >= 6.8\n    from sage.env import sage_include_directories\nexcept ImportError:\n    # Sage < 6.8\n    def sage_include_directories(source=True):\n        return [\n            os.path.join(SAGE_LOCAL, \"include\"),\n            os.path.join(SAGE_LOCAL, \"include\", \"csage\"),\n            os.path.join(SAGE_SRC),\n            os.path.join(SAGE_SRC, \"sage\", \"ext\"),\n            ]\n###\n\nfrom distutils.core import setup\nfrom distutils.extension import Extension\n\n\ncmdclass = { }\next_modules = [ ]\n\ninclude_dirs=sage_include_directories(True)\n\nfrom Cython.Distutils import build_ext\n\next_modules+=[Extension(\n                   \"giacpy\",                 # name of extension\n                   [\"giacpy.pyx\"], #  our Cython source\n                   include_dirs=include_dirs,\n                   language=\"c++\")]\ncmdclass={'build_ext': build_ext}\n\n\nsetup(\n    ext_modules=ext_modules,\n    cmdclass=cmdclass\n    )\n```\n\nand giacpy.pyx\n\n```\nfrom sage.rings.integer cimport Integer\nfrom sage.env import * ##without this line it builts\ninclude 'sage/ext/interrupt.pxi'\ninclude 'sage/ext/stdsage.pxi'\n```\n\ngives:\n\n```\ngiacpy.cpp: In function \u2018int __pyx_import_star_set(PyObject*, PyObject*, char*)\u2019:\ngiacpy.cpp:3635:55: error: \u2018__pyx_convert__from_py_sage_signals_t\u2019 was not declared in this scope\n     _signals = __pyx_convert__from_py_sage_signals_t(o); if (PyErr_Occurred()) {__pyx_filename = __pyx_f[3]; __pyx_lineno = 45; __pyx_clineno = __LINE__; goto __pyx_L2_error;};\n                \n```",
    "created_at": "2015-06-12T10:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246338",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:99'></a>Sorry for the delay but I  still have problems with trac12375. I have tried to isolate the problem:
(can you reproduce it?)

setup.py:

```/usr/bin/env sage -python
from sage.env import *
import os

###
try:
    # Sage >= 6.8
    from sage.env import sage_include_directories
except ImportError:
    # Sage < 6.8
    def sage_include_directories(source=True):
        return [
            os.path.join(SAGE_LOCAL, "include"),
            os.path.join(SAGE_LOCAL, "include", "csage"),
            os.path.join(SAGE_SRC),
            os.path.join(SAGE_SRC, "sage", "ext"),
            ]
###

from distutils.core import setup
from distutils.extension import Extension


cmdclass = { }
ext_modules = [ ]

include_dirs=sage_include_directories(True)

from Cython.Distutils import build_ext

ext_modules+=[Extension(
                   "giacpy",                 # name of extension
                   ["giacpy.pyx"], #  our Cython source
                   include_dirs=include_dirs,
                   language="c++")]
cmdclass={'build_ext': build_ext}


setup(
    ext_modules=ext_modules,
    cmdclass=cmdclass
    )
```

and giacpy.pyx

```
from sage.rings.integer cimport Integer
from sage.env import * ##without this line it builts
include 'sage/ext/interrupt.pxi'
include 'sage/ext/stdsage.pxi'
```

gives:

```
giacpy.cpp: In function ‚Äòint __pyx_import_star_set(PyObject*, PyObject*, char*)‚Äô:
giacpy.cpp:3635:55: error: ‚Äò__pyx_convert__from_py_sage_signals_t‚Äô was not declared in this scope
     _signals = __pyx_convert__from_py_sage_signals_t(o); if (PyErr_Occurred()) {__pyx_filename = __pyx_f[3]; __pyx_lineno = 45; __pyx_clineno = __LINE__; goto __pyx_L2_error;};
                
```



---

archive/issue_comments_246339.json:
```json
{
    "body": "<a id='comment:0'></a>Two remarks, in `setup.py` you have\n\n```\ninclude_dirs=sage_include_directories(True)\n```\nIt should be \n\n```\ninclude_dirs=sage_include_directories()\n```\nIn `giacpy.pyx` why would you need `from sage.env import *`? What do you need from this?",
    "created_at": "2015-06-12T10:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246339",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:0'></a>Two remarks, in `setup.py` you have

```
include_dirs=sage_include_directories(True)
```
It should be 

```
include_dirs=sage_include_directories()
```
In `giacpy.pyx` why would you need `from sage.env import *`? What do you need from this?



---

archive/issue_comments_246340.json:
```json
{
    "body": "<a id='comment:1'></a>I have tried with and without True and got the same pb. But removing\nfrom sage.env import * doesn't help my original program, I have just tried to obtain a small code with the same error message.",
    "created_at": "2015-06-12T11:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246340",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:1'></a>I have tried with and without True and got the same pb. But removing
from sage.env import * doesn't help my original program, I have just tried to obtain a small code with the same error message.



---

archive/issue_comments_246341.json:
```json
{
    "body": "<a id='comment:2'></a>Did it work at all before you included this ticket?",
    "created_at": "2015-06-12T11:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246341",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>Did it work at all before you included this ticket?



---

archive/issue_comments_246342.json:
```json
{
    "body": "<a id='comment:3'></a>it works for instance with sage 6.7. What I have notice on this small example:\n\n```\nrm giacpy.cpp; /usr/local/sage/sage setup.py build_ext\n```\nbuilts (on sage 6.7) but not:\n\n```\nrm giacpy.cpp; /home/fred/dev/sage/develop/sage/sage setup.py build_ext\n```\n(on my git)",
    "created_at": "2015-06-12T11:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246342",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:3'></a>it works for instance with sage 6.7. What I have notice on this small example:

```
rm giacpy.cpp; /usr/local/sage/sage setup.py build_ext
```
builts (on sage 6.7) but not:

```
rm giacpy.cpp; /home/fred/dev/sage/develop/sage/sage setup.py build_ext
```
(on my git)



---

archive/issue_comments_246343.json:
```json
{
    "body": "<a id='comment:4'></a>`@`frederichan: it would help if you give us the exact and complete code you have trouble with: update #12375, rebase it on top of #18494 and then we can talk.",
    "created_at": "2015-06-12T11:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246343",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>`@`frederichan: it would help if you give us the exact and complete code you have trouble with: update #12375, rebase it on top of #18494 and then we can talk.



---

archive/issue_comments_246344.json:
```json
{
    "body": "<a id='comment:5'></a>NB: it doesn't work with sage 6.8beta3 without your ticket. It just mean the this ticket doesn't solve my pb.",
    "created_at": "2015-06-12T11:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246344",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:5'></a>NB: it doesn't work with sage 6.8beta3 without your ticket. It just mean the this ticket doesn't solve my pb.



---

archive/issue_comments_246345.json:
```json
{
    "body": "<a id='comment:106'></a>Replying to [comment:105 frederichan]:\n> NB: it doesn't work with sage 6.8beta3 without your ticket. It just mean the this ticket doesn't solve my pb.\n\n\nYes, I understood that. I'm saying that, regardless of earlier Sage versions, the best way forward is to use #18494 anyway.",
    "created_at": "2015-06-12T12:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246345",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:106'></a>Replying to [comment:105 frederichan]:
> NB: it doesn't work with sage 6.8beta3 without your ticket. It just mean the this ticket doesn't solve my pb.


Yes, I understood that. I'm saying that, regardless of earlier Sage versions, the best way forward is to use #18494 anyway.



---

archive/issue_events_052012.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-12T18:23:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18494#event-52012"
}
```



---

archive/issue_comments_246346.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-12T18:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18494#issuecomment-246346",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
