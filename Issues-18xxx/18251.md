# Issue 18251: CombinatorialFreeModule: fix arithmetic/comparison with base ring zero

archive/issues_018014.json:
```json
{
    "body": "Currently we have the following in Sage:\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: C(0) + ZZ(0)\n0\nsage: C(0) + QQ(0)\nTypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'\n```\nand also\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: C.zero() == ZZ(0)\nTrue\nsage: C.zero() == QQ(0)\nFalse\n```\n\nThe problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.\n\nAssignee: @tscrim\n\nCC:  @nthiery @darijgr @nbruin @robertwb @fchapoton @videlec\n\nKeywords: zero\n\nBranch: u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons\n\nStatus: new\n\nDependencies: #21128\n\nCommit: 3aa0ccae4e5c42359636afd5b77a504388e26928\n\nIssue created by migration from https://trac.sagemath.org/ticket/18251\n\n",
    "created_at": "2015-04-19T18:00:05Z",
    "labels": [
        "component: coercion",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "CombinatorialFreeModule: fix arithmetic/comparison with base ring zero",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18251",
    "user": "https://github.com/tscrim"
}
```
Currently we have the following in Sage:

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: C(0) + ZZ(0)
0
sage: C(0) + QQ(0)
TypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'
```
and also

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: C.zero() == ZZ(0)
True
sage: C.zero() == QQ(0)
False
```

The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.

Assignee: @tscrim

CC:  @nthiery @darijgr @nbruin @robertwb @fchapoton @videlec

Keywords: zero

Branch: u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons

Status: new

Dependencies: #21128

Commit: 3aa0ccae4e5c42359636afd5b77a504388e26928

Issue created by migration from https://trac.sagemath.org/ticket/18251





---

archive/issue_comments_316702.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,16 +6,7 @@\n True\n sage: C.zero() == QQ(0)\n False\n-sage: M.zero()\n-(0, 0, 0, 0)\n-sage: M.zero() == ZZ(0)\n-True\n-sage: M.zero() == QQ(0)\n-False\n ```\n-What I've been doing has been implementing a custom `__eq__` which checks explicitly for the other argument is 0 and then checking `self.is_zero`. However I'm thinking we should have a general fix with this as a special case, but we could do it just for these element classes.\n-\n-Additionally this works when there a coercion from the base ring. I guess more generally do we want equality checking for when there is a conversion to the base ring? Thoughts?\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T11:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316702",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,16 +6,7 @@
 True
 sage: C.zero() == QQ(0)
 False
-sage: M.zero()
-(0, 0, 0, 0)
-sage: M.zero() == ZZ(0)
-True
-sage: M.zero() == QQ(0)
-False
 ```
-What I've been doing has been implementing a custom `__eq__` which checks explicitly for the other argument is 0 and then checking `self.is_zero`. However I'm thinking we should have a general fix with this as a special case, but we could do it just for these element classes.
-
-Additionally this works when there a coercion from the base ring. I guess more generally do we want equality checking for when there is a conversion to the base ring? Thoughts?
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316703.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T11:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316703",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_events_051551.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-29T11:34:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18251#event-51551"
}
```



---

archive/issue_comments_316704.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+\n+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n+\n+We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we need a Python interface to `PyObject_RichCompare()` which I propose to call `richcmp()`.\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T11:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316704",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,16 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+
+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
+
+We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we need a Python interface to `PyObject_RichCompare()` which I propose to call `richcmp()`.
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316705.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+\n+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n+\n+The fix is this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.\n+\n+We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T13:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316705",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+
+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
+
+The fix is this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.
+
+We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316706.json:
```json
{
    "body": "<a id='comment:6'></a>Part of the problem is that there is no coercion defined anyway:\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: C.coerce(QQ(0))\nTypeError: no canonical coercion from Rational Field to Free module generated by {'a', 'b'} over Rational Field\n```\n\nThis makes sense, but it means that the problem is different from what I originally thought.",
    "created_at": "2016-07-29T14:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316706",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Part of the problem is that there is no coercion defined anyway:

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: C.coerce(QQ(0))
TypeError: no canonical coercion from Rational Field to Free module generated by {'a', 'b'} over Rational Field
```

This makes sense, but it means that the problem is different from what I originally thought.



---

archive/issue_comments_316707.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+\n+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n+\n+The fix in this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.\n+\n+We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T14:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316707",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+
+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
+
+The fix in this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.
+
+We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316708.json:
```json
{
    "body": "<a id='comment:8'></a>And the coercion model has an explicit special case for `ZZ(0)`.",
    "created_at": "2016-07-29T14:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316708",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>And the coercion model has an explicit special case for `ZZ(0)`.



---

archive/issue_comments_316709.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+\n+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T14:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316709",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,14 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+
+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316710.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#21128\"",
    "created_at": "2016-07-29T14:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316710",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#21128"



---

archive/issue_comments_316711.json:
```json
{
    "body": "<a id='comment:10'></a>I am going to attach my branch anyway, which does coercion but doesn't actually fix the problem.",
    "created_at": "2016-07-29T14:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316711",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>I am going to attach my branch anyway, which does coercion but doesn't actually fix the problem.



---

archive/issue_comments_316712.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons\"",
    "created_at": "2016-07-29T14:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316712",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons"



---

archive/issue_comments_316713.json:
```json
{
    "body": "<a id='comment:12'></a>New commits:",
    "created_at": "2016-07-29T14:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316713",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>New commits:



---

archive/issue_comments_316714.json:
```json
{
    "body": "Changing commit from \"\" to \"3aa0ccae4e5c42359636afd5b77a504388e26928\"",
    "created_at": "2016-07-29T14:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316714",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "3aa0ccae4e5c42359636afd5b77a504388e26928"



---

archive/issue_comments_316715.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+\n+The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T14:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316715",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,14 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+
+The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316716.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,23 @@\n+Currently we have the following in Sage:\n \n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C(0) + ZZ(0)\n+0\n+sage: C(0) + QQ(0)\n+TypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'\n+```\n+and also\n+\n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C.zero() == ZZ(0)\n+True\n+sage: C.zero() == QQ(0)\n+False\n+```\n+\n+The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.\n \n Summary: Equality comparison with 0 is not consistant\n \n``````\n",
    "created_at": "2016-07-29T15:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316716",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,23 @@
+Currently we have the following in Sage:
 
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C(0) + ZZ(0)
+0
+sage: C(0) + QQ(0)
+TypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'
+```
+and also
+
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C.zero() == ZZ(0)
+True
+sage: C.zero() == QQ(0)
+False
+```
+
+The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.
 
 Summary: Equality comparison with 0 is not consistant
 
``````




---

archive/issue_comments_316717.json:
```json
{
    "body": "<a id='comment:14'></a>The current behavior of CFM agrees with that of the usual modules:\n\n```sage\nsage: V = QQ^3\nsage: V.coerce(ZZ(0))\n(0, 0, 0)\nsage: V.coerce(QQ(0))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: no canonical coercion from Rational Field to Vector space of dimension 3 over Rational Field\nsage: V.zero() == QQ(0)\nFalse\nsage: V.zero() == ZZ(0)\nTrue\n```\nI'm thinking a better and more general solution would be to special case the zero of the base ring or possibly just `QQ`.",
    "created_at": "2016-07-30T14:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18251#issuecomment-316717",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>The current behavior of CFM agrees with that of the usual modules:

```sage
sage: V = QQ^3
sage: V.coerce(ZZ(0))
(0, 0, 0)
sage: V.coerce(QQ(0))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: no canonical coercion from Rational Field to Vector space of dimension 3 over Rational Field
sage: V.zero() == QQ(0)
False
sage: V.zero() == ZZ(0)
True
```
I'm thinking a better and more general solution would be to special case the zero of the base ring or possibly just `QQ`.
