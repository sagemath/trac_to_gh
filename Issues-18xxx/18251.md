# Issue 18251: CombinatorialFreeModule: fix arithmetic/comparison with base ring zero

archive/issues_018014.json:
```json
{
    "body": "Currently we have the following in Sage:\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: C(0) + ZZ(0)\n0\nsage: C(0) + QQ(0)\nTypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'\n```\nand also\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: C.zero() == ZZ(0)\nTrue\nsage: C.zero() == QQ(0)\nFalse\n```\n\nThe problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.\n\nDepends on #21128\n\n**Assignee:** @tscrim\n\n**CC:**  @nthiery @darijgr @nbruin @robertwb @fchapoton @videlec\n\n**Keywords:** zero\n\n**Branch:** [u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons)\n\n**Commit:** [3aa0ccae4e5c42359636afd5b77a504388e26928](https://github.com/sagemath/sagetrac-mirror/commit/3aa0ccae4e5c42359636afd5b77a504388e26928)\n\nIssue created by migration from https://trac.sagemath.org/ticket/18251\n\n",
    "created_at": "2015-04-19T18:00:05Z",
    "labels": [
        "component: coercion",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.4",
    "title": "CombinatorialFreeModule: fix arithmetic/comparison with base ring zero",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/18251",
    "user": "https://github.com/tscrim"
}
```
Currently we have the following in Sage:

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: C(0) + ZZ(0)
0
sage: C(0) + QQ(0)
TypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'
```
and also

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: C.zero() == ZZ(0)
True
sage: C.zero() == QQ(0)
False
```

The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.

Depends on #21128

**Assignee:** @tscrim

**CC:**  @nthiery @darijgr @nbruin @robertwb @fchapoton @videlec

**Keywords:** zero

**Branch:** [u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons)

**Commit:** [3aa0ccae4e5c42359636afd5b77a504388e26928](https://github.com/sagemath/sagetrac-mirror/commit/3aa0ccae4e5c42359636afd5b77a504388e26928)

Issue created by migration from https://trac.sagemath.org/ticket/18251





---

archive/issue_events_163857.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-29T11:19:51Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "rename": {
        "from": "Equality comparison with 0 is not consistant",
        "to": "CombinatorialFreeModule should use coercion for comparisons"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18251#event-163857"
}
```



---

archive/issue_comments_252682.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,13 +6,4 @@\n True\n sage: C.zero() == QQ(0)\n False\n-sage: M.zero()\n-(0, 0, 0, 0)\n-sage: M.zero() == ZZ(0)\n-True\n-sage: M.zero() == QQ(0)\n-False\n ```\n-What I've been doing has been implementing a custom `__eq__` which checks explicitly for the other argument is 0 and then checking `self.is_zero`. However I'm thinking we should have a general fix with this as a special case, but we could do it just for these element classes.\n-\n-Additionally this works when there a coercion from the base ring. I guess more generally do we want equality checking for when there is a conversion to the base ring? Thoughts?\n``````\n",
    "created_at": "2016-07-29T11:19:51Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252682",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,13 +6,4 @@
 True
 sage: C.zero() == QQ(0)
 False
-sage: M.zero()
-(0, 0, 0, 0)
-sage: M.zero() == ZZ(0)
-True
-sage: M.zero() == QQ(0)
-False
 ```
-What I've been doing has been implementing a custom `__eq__` which checks explicitly for the other argument is 0 and then checking `self.is_zero`. However I'm thinking we should have a general fix with this as a special case, but we could do it just for these element classes.
-
-Additionally this works when there a coercion from the base ring. I guess more generally do we want equality checking for when there is a conversion to the base ring? Thoughts?
``````




---

archive/issue_comments_252683.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,3 +7,4 @@\n sage: C.zero() == QQ(0)\n False\n ```\n+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n``````\n",
    "created_at": "2016-07-29T11:21:15Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252683",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,3 +7,4 @@
 sage: C.zero() == QQ(0)
 False
 ```
+This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
``````




---

archive/issue_events_163858.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-29T11:34:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18251#event-163858"
}
```



---

archive/issue_events_163859.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-29T11:34:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18251#event-163859"
}
```



---

archive/issue_comments_252684.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,4 +7,7 @@\n sage: C.zero() == QQ(0)\n False\n ```\n+\n This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n+\n+We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we need a Python interface to `PyObject_RichCompare()` which I propose to call `richcmp()`.\n``````\n",
    "created_at": "2016-07-29T11:34:22Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252684",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,4 +7,7 @@
 sage: C.zero() == QQ(0)
 False
 ```
+
 This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
+
+We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we need a Python interface to `PyObject_RichCompare()` which I propose to call `richcmp()`.
``````




---

archive/issue_comments_252685.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,4 +10,6 @@\n \n This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n \n-We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we need a Python interface to `PyObject_RichCompare()` which I propose to call `richcmp()`.\n+The fix is this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.\n+\n+We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.\n``````\n",
    "created_at": "2016-07-29T13:57:35Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252685",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,4 +10,6 @@
 
 This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
 
-We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we need a Python interface to `PyObject_RichCompare()` which I propose to call `richcmp()`.
+The fix is this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.
+
+We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.
``````




---

archive/issue_comments_252686.json:
```json
{
    "body": "<a id='comment:6'></a>\nPart of the problem is that there is no coercion defined anyway:\n\n```\nsage: C = CombinatorialFreeModule(QQ, ['a','b'])\nsage: C.coerce(QQ(0))\nTypeError: no canonical coercion from Rational Field to Free module generated by {'a', 'b'} over Rational Field\n```\n\nThis makes sense, but it means that the problem is different from what I originally thought.",
    "created_at": "2016-07-29T14:31:05Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252686",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Part of the problem is that there is no coercion defined anyway:

```
sage: C = CombinatorialFreeModule(QQ, ['a','b'])
sage: C.coerce(QQ(0))
TypeError: no canonical coercion from Rational Field to Free module generated by {'a', 'b'} over Rational Field
```

This makes sense, but it means that the problem is different from what I originally thought.



---

archive/issue_comments_252687.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,6 +10,6 @@\n \n This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n \n-The fix is this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.\n+The fix in this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.\n \n We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.\n``````\n",
    "created_at": "2016-07-29T14:36:57Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252687",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,6 +10,6 @@
 
 This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
 
-The fix is this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.
+The fix in this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.
 
 We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.
``````




---

archive/issue_comments_252688.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnd the coercion model has an explicit special case for `ZZ(0)`.",
    "created_at": "2016-07-29T14:38:42Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252688",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
And the coercion model has an explicit special case for `ZZ(0)`.



---

archive/issue_comments_252689.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -9,7 +9,3 @@\n ```\n \n This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n-\n-The fix in this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.\n-\n-We need access to the CPython function `PyObject_RichCompare()` which \u2014as far as I know\u2014 is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.\n``````\n",
    "created_at": "2016-07-29T14:41:23Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252689",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -9,7 +9,3 @@
 ```
 
 This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
-
-The fix in this ticket is meant to be an example for other plain Python modules which need to implement comparison using coercion.
-
-We need access to the CPython function `PyObject_RichCompare()` which —as far as I know— is not exposed by Python. So we add a Python interface to `PyObject_RichCompare()` called `richcmp()`.
``````




---

archive/issue_comments_252690.json:
```json
{
    "body": "**Dependencies:** #21128",
    "created_at": "2016-07-29T14:41:23Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252690",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #21128



---

archive/issue_comments_252691.json:
```json
{
    "body": "<a id='comment:10'></a>\nI am going to attach my branch anyway, which does coercion but doesn't actually fix the problem.",
    "created_at": "2016-07-29T14:41:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252691",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
I am going to attach my branch anyway, which does coercion but doesn't actually fix the problem.



---

archive/issue_comments_252692.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons)",
    "created_at": "2016-07-29T14:42:37Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252692",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/combinatorialfreemodule_should_use_coercion_for_comparisons)



---

archive/issue_comments_252693.json:
```json
{
    "body": "<a id='comment:12'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f9db8433c07ec7c3c352e6660f0f314a0a0d35a5\">f9db843</a></td><td><code>Improve support for comparisons in plain Python modules</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3aa0ccae4e5c42359636afd5b77a504388e26928\">3aa0cca</a></td><td><code>CombinatorialFreeModule: use coercion for comparisons</code></td></tr></table>\n",
    "created_at": "2016-07-29T14:48:14Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252693",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f9db8433c07ec7c3c352e6660f0f314a0a0d35a5">f9db843</a></td><td><code>Improve support for comparisons in plain Python modules</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3aa0ccae4e5c42359636afd5b77a504388e26928">3aa0cca</a></td><td><code>CombinatorialFreeModule: use coercion for comparisons</code></td></tr></table>




---

archive/issue_events_163860.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-29T14:48:14Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "rename": {
        "from": "CombinatorialFreeModule should use coercion for comparisons",
        "to": "CombinatorialFreeModule: fix comparison with zero"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18251#event-163860"
}
```



---

archive/issue_comments_252694.json:
```json
{
    "body": "**Commit:** [3aa0ccae4e5c42359636afd5b77a504388e26928](https://github.com/sagemath/sagetrac-mirror/commit/3aa0ccae4e5c42359636afd5b77a504388e26928)",
    "created_at": "2016-07-29T14:48:14Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252694",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [3aa0ccae4e5c42359636afd5b77a504388e26928](https://github.com/sagemath/sagetrac-mirror/commit/3aa0ccae4e5c42359636afd5b77a504388e26928)



---

archive/issue_comments_252695.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -8,4 +8,4 @@\n False\n ```\n \n-This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).\n+The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.\n``````\n",
    "created_at": "2016-07-29T14:48:14Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252695",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -8,4 +8,4 @@
 False
 ```
 
-This should be fixed by using coercing comparison (`_cmp_` or `_richcmp_`).
+The problem is that there is no coercion `QQ -> C`. The coercion model special-cases `ZZ(0)` but not other kinds of zero.
``````




---

archive/issue_comments_252696.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n Currently we have the following in Sage:\n+\n+```\n+sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n+sage: C(0) + ZZ(0)\n+0\n+sage: C(0) + QQ(0)\n+TypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'\n+```\n+and also\n \n ```\n sage: C = CombinatorialFreeModule(QQ, ['a','b'])\n``````\n",
    "created_at": "2016-07-29T15:07:54Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252696",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
 Currently we have the following in Sage:
+
+```
+sage: C = CombinatorialFreeModule(QQ, ['a','b'])
+sage: C(0) + ZZ(0)
+0
+sage: C(0) + QQ(0)
+TypeError: unsupported operand parent(s) for '+': 'Free module generated by {'a', 'b'} over Rational Field' and 'Rational Field'
+```
+and also
 
 ```
 sage: C = CombinatorialFreeModule(QQ, ['a','b'])
``````




---

archive/issue_events_163861.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-07-29T15:07:54Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "rename": {
        "from": "CombinatorialFreeModule: fix comparison with zero",
        "to": "CombinatorialFreeModule: fix arithmetic/comparison with base ring zero"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18251#event-163861"
}
```



---

archive/issue_comments_252697.json:
```json
{
    "body": "<a id='comment:14'></a>\nThe current behavior of CFM agrees with that of the usual modules:\n\n```sage\nsage: V = QQ^3\nsage: V.coerce(ZZ(0))\n(0, 0, 0)\nsage: V.coerce(QQ(0))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: no canonical coercion from Rational Field to Vector space of dimension 3 over Rational Field\nsage: V.zero() == QQ(0)\nFalse\nsage: V.zero() == ZZ(0)\nTrue\n```\nI'm thinking a better and more general solution would be to special case the zero of the base ring or possibly just `QQ`.",
    "created_at": "2016-07-30T14:25:04Z",
    "issue": "https://github.com/sagemath/sage/issues/18251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18251#issuecomment-252697",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
The current behavior of CFM agrees with that of the usual modules:

```sage
sage: V = QQ^3
sage: V.coerce(ZZ(0))
(0, 0, 0)
sage: V.coerce(QQ(0))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: no canonical coercion from Rational Field to Vector space of dimension 3 over Rational Field
sage: V.zero() == QQ(0)
False
sage: V.zero() == ZZ(0)
True
```
I'm thinking a better and more general solution would be to special case the zero of the base ring or possibly just `QQ`.
