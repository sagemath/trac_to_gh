# Issue 18836: Make refine_embedding into a method of number fields instead of stand-alone

archive/issues_018599.json:
```json
{
    "body": "The stand-alone function {{{refine_embedding}} has been around for a while, right at the bottom of sage/rings/number_field/number_field.py, not imported into the global namespace and hence having to be imported whenever needed.  More seriously, it is very easy for users and developers to miss its existence entirely!  (Proof:  today I learned that one of my students needed such a function and wrote his own since he did not know that I had written the existing function a few years ago!)\n\nI am moving the function into the class NumberField, so that one can now say\n\n```\nembx = K.refine_embedding(emb, prec)\n```\ninstead of\n\n```\nfrom sage.rings.number_field.number_field import refine_embedding\nembx = refine_embedding(emb,prec)\n```\n\nThere are only about 3 places in the Sage library where this is used, which need small changes.\n\n**Branch:** [u/cremona/18836-refine_embedding](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18836-refine_embedding)\n\n**Commit:** [94a1d567b17399c9e39517ab6943004210ee23ba](https://github.com/sagemath/sagetrac-mirror/commit/94a1d567b17399c9e39517ab6943004210ee23ba)\n\n**Reviewer:** Vincent Delecroix\n\n**Author:** John Cremona\n\n**Status:** needs_work\n\n**Dependencies:** #20064\n\nIssue created by migration from https://trac.sagemath.org/ticket/18836\n\n",
    "created_at": "2015-07-01T14:05:55Z",
    "labels": [
        "component: number fields",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Make refine_embedding into a method of number fields instead of stand-alone",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18836",
    "user": "https://github.com/JohnCremona"
}
```
The stand-alone function {{{refine_embedding}} has been around for a while, right at the bottom of sage/rings/number_field/number_field.py, not imported into the global namespace and hence having to be imported whenever needed.  More seriously, it is very easy for users and developers to miss its existence entirely!  (Proof:  today I learned that one of my students needed such a function and wrote his own since he did not know that I had written the existing function a few years ago!)

I am moving the function into the class NumberField, so that one can now say

```
embx = K.refine_embedding(emb, prec)
```
instead of

```
from sage.rings.number_field.number_field import refine_embedding
embx = refine_embedding(emb,prec)
```

There are only about 3 places in the Sage library where this is used, which need small changes.

**Branch:** [u/cremona/18836-refine_embedding](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18836-refine_embedding)

**Commit:** [94a1d567b17399c9e39517ab6943004210ee23ba](https://github.com/sagemath/sagetrac-mirror/commit/94a1d567b17399c9e39517ab6943004210ee23ba)

**Reviewer:** Vincent Delecroix

**Author:** John Cremona

**Status:** needs_work

**Dependencies:** #20064

Issue created by migration from https://trac.sagemath.org/ticket/18836





---

archive/issue_comments_318259.json:
```json
{
    "body": "**Commit:** [87cb9bec69f77d1a3b4f33dacef1b7d6043c5062](https://github.com/sagemath/sagetrac-mirror/commit/87cb9bec69f77d1a3b4f33dacef1b7d6043c5062)",
    "created_at": "2015-07-01T14:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318259",
    "user": "https://github.com/JohnCremona"
}
```

**Commit:** [87cb9bec69f77d1a3b4f33dacef1b7d6043c5062](https://github.com/sagemath/sagetrac-mirror/commit/87cb9bec69f77d1a3b4f33dacef1b7d6043c5062)



---

archive/issue_comments_318260.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87cb9bec69f77d1a3b4f33dacef1b7d6043c5062\">87cb9be</a></td><td><code>#18836: mvoe refine_embedding function into NumberField class</code></td></tr></table>\n",
    "created_at": "2015-07-01T14:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318260",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87cb9bec69f77d1a3b4f33dacef1b7d6043c5062">87cb9be</a></td><td><code>#18836: mvoe refine_embedding function into NumberField class</code></td></tr></table>




---

archive/issue_comments_318261.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2015-07-01T14:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318261",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_318262.json:
```json
{
    "body": "**Branch:** [u/cremona/18836-refine_embedding](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18836-refine_embedding)",
    "created_at": "2015-07-01T14:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318262",
    "user": "https://github.com/JohnCremona"
}
```

**Branch:** [u/cremona/18836-refine_embedding](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18836-refine_embedding)



---

archive/issue_comments_318263.json:
```json
{
    "body": "**Reviewer:** Vincent Delecroix",
    "created_at": "2015-07-06T07:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318263",
    "user": "https://github.com/videlec"
}
```

**Reviewer:** Vincent Delecroix



---

archive/issue_comments_318264.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2015-07-06T07:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318264",
    "user": "https://github.com/videlec"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_318265.json:
```json
{
    "body": "<a id='comment:2'></a>\nHello John,\n\n- Could you be more uniform in notations: you wrote `RR` and `CC` but <code>\\`\\`AA\\`\\`</code> and <code>\\`\\`QQbar\\`\\`</code>.\n\n- `if not self is e.domain()` -> `if self is not e.domain()`\n\n- it is crazy that this function needs to compute **all** embeddings to refine **one**!! (might be for another ticket)\n\n- This is very obfuscated\n\n```\n        diffs = [(RC(ee(self.gen()))-old_root).abs() for ee in elist]\n        return elist[min(izip(diffs,count()))[1]]\n```\n  Could you make it more readable like\n\n```\n   diff_min = Infinity\n   ans = None\n   for ee in elist:\n       diff = (RC(ee(self.gen())) - old_root).abs()\n       if diff < diff_min:\n           ans = ee\n           diff_min = diff\n   return ans\n```\n\nVincent",
    "created_at": "2015-07-06T07:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318265",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>
Hello John,

- Could you be more uniform in notations: you wrote `RR` and `CC` but <code>\`\`AA\`\`</code> and <code>\`\`QQbar\`\`</code>.

- `if not self is e.domain()` -> `if self is not e.domain()`

- it is crazy that this function needs to compute **all** embeddings to refine **one**!! (might be for another ticket)

- This is very obfuscated

```
        diffs = [(RC(ee(self.gen()))-old_root).abs() for ee in elist]
        return elist[min(izip(diffs,count()))[1]]
```
  Could you make it more readable like

```
   diff_min = Infinity
   ans = None
   for ee in elist:
       diff = (RC(ee(self.gen())) - old_root).abs()
       if diff < diff_min:
           ans = ee
           diff_min = diff
   return ans
```

Vincent



---

archive/issue_comments_318266.json:
```json
{
    "body": "<a id='comment:3'></a>\nOK, I am working on it.  On your second point I am not sure that it is so wasteful to find all roots of a polynomial in a real / complex field than to refine one approximate root to higher precision, but I will experiment to see if that is possible. And of course, this code (mostly by me) has been in Sage for a few years already, all I did here was to move it!",
    "created_at": "2015-07-08T19:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318266",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>
OK, I am working on it.  On your second point I am not sure that it is so wasteful to find all roots of a polynomial in a real / complex field than to refine one approximate root to higher precision, but I will experiment to see if that is possible. And of course, this code (mostly by me) has been in Sage for a few years already, all I did here was to move it!



---

archive/issue_comments_318267.json:
```json
{
    "body": "**Changing commit** from \"[87cb9bec69f77d1a3b4f33dacef1b7d6043c5062](https://github.com/sagemath/sagetrac-mirror/commit/87cb9bec69f77d1a3b4f33dacef1b7d6043c5062)\" to \"[87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd](https://github.com/sagemath/sagetrac-mirror/commit/87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd)\".",
    "created_at": "2015-07-12T09:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318267",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[87cb9bec69f77d1a3b4f33dacef1b7d6043c5062](https://github.com/sagemath/sagetrac-mirror/commit/87cb9bec69f77d1a3b4f33dacef1b7d6043c5062)" to "[87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd](https://github.com/sagemath/sagetrac-mirror/commit/87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd)".



---

archive/issue_comments_318268.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/450209d4800a42fc50297288817c78b387d0b790\">450209d</a></td><td><code>#18836: mvoe refine_embedding function into NumberField class</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/accaa9fcf910dab8770d26fd9bfd7ed72ebc7a5d\">accaa9f</a></td><td><code>#18836: simplified code after review</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd\">87e8c14</a></td><td><code>Merge branch 'u/cremona/18836-refine_embedding' of trac.sagemath.org:sage into refine_embedding</code></td></tr></table>\n",
    "created_at": "2015-07-12T09:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/450209d4800a42fc50297288817c78b387d0b790">450209d</a></td><td><code>#18836: mvoe refine_embedding function into NumberField class</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/accaa9fcf910dab8770d26fd9bfd7ed72ebc7a5d">accaa9f</a></td><td><code>#18836: simplified code after review</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd">87e8c14</a></td><td><code>Merge branch 'u/cremona/18836-refine_embedding' of trac.sagemath.org:sage into refine_embedding</code></td></tr></table>




---

archive/issue_comments_318269.json:
```json
{
    "body": "<a id='comment:5'></a>\nI did what was asked for (almost) and rebased onto 6.8.beta7.   There does not seem to be a way to ask for one root in a field close to a given approximation, so it still finds all roots in the higher precision field -- but only the roots, it does not contruct all teh associated embeddings, just the closest one.  I think the code is less obfuscated now too.\n\nThere is still a problem,though:  in testing I get two errors (from essentially the same test) in sage/schemes/elliptic_curves/ell_point.py and period_lattice.py.  These occur when a complex embedding has been refined to infinite precision (i.e. to an embedding into QQbar), but an error is caused when an element of QQbar has its square root taken: its _value is an element of sage.rings.real_mpfi.RealIntervalFieldElement which is surely wrong -- it should be the corresponding complex type -- and does not like its argument being asked for.\n\nI have not been able to track this down, so I have not set the ticket to \"needs review\" as I know that these tests fail, but I am guessing that I have somehow stumbled across a bug which has nothing to do with this ticket.  Help appreciated!",
    "created_at": "2015-07-12T10:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318269",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:5'></a>
I did what was asked for (almost) and rebased onto 6.8.beta7.   There does not seem to be a way to ask for one root in a field close to a given approximation, so it still finds all roots in the higher precision field -- but only the roots, it does not contruct all teh associated embeddings, just the closest one.  I think the code is less obfuscated now too.

There is still a problem,though:  in testing I get two errors (from essentially the same test) in sage/schemes/elliptic_curves/ell_point.py and period_lattice.py.  These occur when a complex embedding has been refined to infinite precision (i.e. to an embedding into QQbar), but an error is caused when an element of QQbar has its square root taken: its _value is an element of sage.rings.real_mpfi.RealIntervalFieldElement which is surely wrong -- it should be the corresponding complex type -- and does not like its argument being asked for.

I have not been able to track this down, so I have not set the ticket to "needs review" as I know that these tests fail, but I am guessing that I have somehow stumbled across a bug which has nothing to do with this ticket.  Help appreciated!



---

archive/issue_comments_318270.json:
```json
{
    "body": "**Changing commit** from \"[87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd](https://github.com/sagemath/sagetrac-mirror/commit/87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd)\" to \"[ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494](https://github.com/sagemath/sagetrac-mirror/commit/ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494)\".",
    "created_at": "2015-12-28T13:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318270",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd](https://github.com/sagemath/sagetrac-mirror/commit/87e8c14747eb0f5bf9b877b971b2ab2d5edbbffd)" to "[ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494](https://github.com/sagemath/sagetrac-mirror/commit/ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494)".



---

archive/issue_comments_318271.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494\">ee94ab4</a></td><td><code>Merge branch 'master' (6.10) into refine_embedding</code></td></tr></table>\n",
    "created_at": "2015-12-28T13:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494">ee94ab4</a></td><td><code>Merge branch 'master' (6.10) into refine_embedding</code></td></tr></table>




---

archive/issue_comments_318272.json:
```json
{
    "body": "<a id='comment:7'></a>\nI have merged this with 6.10 to make it possible to continue with it.",
    "created_at": "2015-12-28T14:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318272",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>
I have merged this with 6.10 to make it possible to continue with it.



---

archive/issue_comments_318273.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis code was written while debugging the above.  It runs fine unless you comment out the two lines near the end.  I would say that this is a bug in QQbar.sqrt!\n\n```\nK.<i> = QuadraticField(-1)\n\n# define a low-precision embedding from K to CC:                                                                \n\nemb = K.embeddings(CC)[1]\n\n# extend this to the closest embedding into QQbar:                                                              \n\nold_gen = emb(K.gen())\nrr = K.defining_polynomial().roots(QQbar, multiplicities=False)\ndiffs = [(CC(r)-old_gen).abs() for r in rr]\nnew_gen = rr[diffs.index(min(diffs))]\nemb0 = K.hom([new_gen], check=False)\n\n# Take a polynomial with 3 roots in K:                                                                          \n\ne1 = -4+i\ne2 = 1+i\ne3 = 3-2*i\nprint(\"Original ei: %s with parent %s\" % ([e1,e2,e3],parent(e1)))\nx = polygen(K)\npol = (x-e1)*(x-e2)*(x-e3)\n\n# Find the roots again in QQbar:                                                                                \n\npol0 = PolynomialRing(QQbar,'x')([emb0(c) for c in list(pol)])\ne1, e2, e3 = pol0.roots(QQbar,multiplicities=False)\nprint(\"Roots ei: %s with parent %s\" % ([e1,e2,e3],parent(e1)))\n\n# Attempt to compute sqrt(e1-e2) from these:                                                                    \n\nd = e1-e2\nprint(\"d=%s with parent %s\" % (d,d.parent()))\n# If the next 2 lines are commented out, an error is raised in the sqrt!                                        \ns = d.imag().is_zero()\nprint(\"d.imag().is_zero()=%s\" % s)\nprint(\"d=%s with parent %s\" % (d,d.parent()))\nd = d.sqrt()\nprint(\"d=%s\" % d)\n```",
    "created_at": "2015-12-29T16:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318273",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>
This code was written while debugging the above.  It runs fine unless you comment out the two lines near the end.  I would say that this is a bug in QQbar.sqrt!

```
K.<i> = QuadraticField(-1)

# define a low-precision embedding from K to CC:                                                                

emb = K.embeddings(CC)[1]

# extend this to the closest embedding into QQbar:                                                              

old_gen = emb(K.gen())
rr = K.defining_polynomial().roots(QQbar, multiplicities=False)
diffs = [(CC(r)-old_gen).abs() for r in rr]
new_gen = rr[diffs.index(min(diffs))]
emb0 = K.hom([new_gen], check=False)

# Take a polynomial with 3 roots in K:                                                                          

e1 = -4+i
e2 = 1+i
e3 = 3-2*i
print("Original ei: %s with parent %s" % ([e1,e2,e3],parent(e1)))
x = polygen(K)
pol = (x-e1)*(x-e2)*(x-e3)

# Find the roots again in QQbar:                                                                                

pol0 = PolynomialRing(QQbar,'x')([emb0(c) for c in list(pol)])
e1, e2, e3 = pol0.roots(QQbar,multiplicities=False)
print("Roots ei: %s with parent %s" % ([e1,e2,e3],parent(e1)))

# Attempt to compute sqrt(e1-e2) from these:                                                                    

d = e1-e2
print("d=%s with parent %s" % (d,d.parent()))
# If the next 2 lines are commented out, an error is raised in the sqrt!                                        
s = d.imag().is_zero()
print("d.imag().is_zero()=%s" % s)
print("d=%s with parent %s" % (d,d.parent()))
d = d.sqrt()
print("d=%s" % d)
```



---

archive/issue_comments_318274.json:
```json
{
    "body": "<a id='comment:9'></a>\nThe fact that `_value` becomes a *real* interval element is probably due to this implementation (line 7431 of `sage/rings/qqbar.py`)\n\n```\n    def _interval_fast(self, prec):\n        gen_val = self._generator._interval_fast(prec)\n        v = self._value.polynomial()(gen_val)\n        if self._exactly_real and is_ComplexIntervalFieldElement(v):\n            return v.real()\n        return v\n```\nIt could well be that this is really the intention (and there could be other places where the interval is set to be a real thing!), in which case the bug is indeed in `sqrt`, which should avoid relying on \"argument\" being available.\n\nLooking at it a little bit more, I think the error is in fact in `__pow__` (sage/rings/qqbar.py:4233). I expect it's  not invalid for `_value` to be a RIF element. That seems to happen quite a bit:\n\n```\nsage: type(QQbar(5)._value)\n<type 'sage.rings.real_mpfi.RealIntervalFieldElement'>\n```\nIt's just that elements where that happens are usually filtered out earlier. So in this case, `d` isn't recognized as a rational number yet when we enter, but then in the for loop on line 4304, we have that on line 4322 we execute:\n\n```\n               val = self._interval_fast(prec)\n```\nSo actually, on the first pass `val` is a CIF element. We apparently get an error on the second pass, when `val` has been forced through `_interval_fast`.\n\nSo I see two solutions: either ensure that val is put back into CIF or ensure that \"argument extraction\" is done appropriately in cases where \"val\" is in RIF.",
    "created_at": "2016-02-16T21:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318274",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>
The fact that `_value` becomes a *real* interval element is probably due to this implementation (line 7431 of `sage/rings/qqbar.py`)

```
    def _interval_fast(self, prec):
        gen_val = self._generator._interval_fast(prec)
        v = self._value.polynomial()(gen_val)
        if self._exactly_real and is_ComplexIntervalFieldElement(v):
            return v.real()
        return v
```
It could well be that this is really the intention (and there could be other places where the interval is set to be a real thing!), in which case the bug is indeed in `sqrt`, which should avoid relying on "argument" being available.

Looking at it a little bit more, I think the error is in fact in `__pow__` (sage/rings/qqbar.py:4233). I expect it's  not invalid for `_value` to be a RIF element. That seems to happen quite a bit:

```
sage: type(QQbar(5)._value)
<type 'sage.rings.real_mpfi.RealIntervalFieldElement'>
```
It's just that elements where that happens are usually filtered out earlier. So in this case, `d` isn't recognized as a rational number yet when we enter, but then in the for loop on line 4304, we have that on line 4322 we execute:

```
               val = self._interval_fast(prec)
```
So actually, on the first pass `val` is a CIF element. We apparently get an error on the second pass, when `val` has been forced through `_interval_fast`.

So I see two solutions: either ensure that val is put back into CIF or ensure that "argument extraction" is done appropriately in cases where "val" is in RIF.



---

archive/issue_comments_318275.json:
```json
{
    "body": "<a id='comment:10'></a>\nThat is good, I thought that you (Nils) would be able to help with this.  I think we should fix this on #20068, which I made a dependency for this ticket, so I will copy your comments there.",
    "created_at": "2016-02-17T12:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318275",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>
That is good, I thought that you (Nils) would be able to help with this.  I think we should fix this on #20068, which I made a dependency for this ticket, so I will copy your comments there.



---

archive/issue_comments_318276.json:
```json
{
    "body": "<a id='comment:11'></a>\nHello,\n\nI followed the comment from #18333. It would actually make sense for elements in `QQbar` to **always** have their intervals being in some complex interval field. Since the zero is exact in interval arithmetic we can check if the number is real with\n\n```\nsage: a = CIF(5)\nsage: a.imag().is_zero()\nTrue\n```\n\nThough there is a lot of code shared between `AA` and `QQbar` and the change might be less trivial than it seems.\n\nVincent",
    "created_at": "2016-02-17T12:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318276",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
Hello,

I followed the comment from #18333. It would actually make sense for elements in `QQbar` to **always** have their intervals being in some complex interval field. Since the zero is exact in interval arithmetic we can check if the number is real with

```
sage: a = CIF(5)
sage: a.imag().is_zero()
True
```

Though there is a lot of code shared between `AA` and `QQbar` and the change might be less trivial than it seems.

Vincent



---

archive/issue_comments_318277.json:
```json
{
    "body": "<a id='comment:12'></a>\nThanks, I did not know of the meta-ticket #18333.  If this issue (now at #20064) can be resolved as part of that, then good, but I hope that a quick resolution will be possible since #20064 is a real bug while it looks as if many of the issues at #18333 are less urgent (though worth doing, certainly).",
    "created_at": "2016-02-17T12:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318277",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'></a>
Thanks, I did not know of the meta-ticket #18333.  If this issue (now at #20064) can be resolved as part of that, then good, but I hope that a quick resolution will be possible since #20064 is a real bug while it looks as if many of the issues at #18333 are less urgent (though worth doing, certainly).



---

archive/issue_comments_318278.json:
```json
{
    "body": "**Changing commit** from \"[ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494](https://github.com/sagemath/sagetrac-mirror/commit/ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494)\" to \"[94a1d567b17399c9e39517ab6943004210ee23ba](https://github.com/sagemath/sagetrac-mirror/commit/94a1d567b17399c9e39517ab6943004210ee23ba)\".",
    "created_at": "2016-02-18T13:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318278",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494](https://github.com/sagemath/sagetrac-mirror/commit/ee94ab4b6da7a2bdf20b6fc50eefb2dba9190494)" to "[94a1d567b17399c9e39517ab6943004210ee23ba](https://github.com/sagemath/sagetrac-mirror/commit/94a1d567b17399c9e39517ab6943004210ee23ba)".



---

archive/issue_comments_318279.json:
```json
{
    "body": "<a id='comment:13'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/94a1d567b17399c9e39517ab6943004210ee23ba\">94a1d56</a></td><td><code>Merge branch 'develop (7.1.beta3)' into 18836</code></td></tr></table>\n",
    "created_at": "2016-02-18T13:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/94a1d567b17399c9e39517ab6943004210ee23ba">94a1d56</a></td><td><code>Merge branch 'develop (7.1.beta3)' into 18836</code></td></tr></table>




---

archive/issue_comments_318280.json:
```json
{
    "body": "<a id='comment:14'></a>\nI am about to see if the fix at #20064 deals with the remaining issues.",
    "created_at": "2016-02-18T13:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318280",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'></a>
I am about to see if the fix at #20064 deals with the remaining issues.



---

archive/issue_comments_318281.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [cremona](#comment%3A14):\n> I am about to see if the fix at #20064 deals with the remaining issues.\n\n\nIt does, and now has a positive review, so I will set that as a dependency of this and ask for another review of this one.",
    "created_at": "2016-02-18T13:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318281",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>
Replying to [cremona](#comment%3A14):
> I am about to see if the fix at #20064 deals with the remaining issues.


It does, and now has a positive review, so I will set that as a dependency of this and ask for another review of this one.



---

archive/issue_comments_318282.json:
```json
{
    "body": "**Dependencies:** #20064",
    "created_at": "2016-02-18T13:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318282",
    "user": "https://github.com/JohnCremona"
}
```

**Dependencies:** #20064



---

archive/issue_comments_318283.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2016-02-18T13:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318283",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_318284.json:
```json
{
    "body": "<a id='comment:16'></a>\nI got doctest failing for this one.\n\nsage -t --long src/sage/schemes/elliptic_curves/ell_point.py  # 1 doctest failed\nsage -t --long src/sage/schemes/elliptic_curves/period_lattice.py  # 2 doctests failed",
    "created_at": "2016-02-24T09:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318284",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:16'></a>
I got doctest failing for this one.

sage -t --long src/sage/schemes/elliptic_curves/ell_point.py  # 1 doctest failed
sage -t --long src/sage/schemes/elliptic_curves/period_lattice.py  # 2 doctests failed



---

archive/issue_comments_318285.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2016-02-24T09:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318285",
    "user": "https://github.com/lftabera"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_318286.json:
```json
{
    "body": "<a id='comment:17'></a>\nAre those failures the ones which are fixed by #20064?  Did you apply #20064 first -- it is merged but not yet in the latest beta, I think.",
    "created_at": "2016-02-24T11:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318286",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>
Are those failures the ones which are fixed by #20064?  Did you apply #20064 first -- it is merged but not yet in the latest beta, I think.



---

archive/issue_comments_318287.json:
```json
{
    "body": "<a id='comment:18'></a>\nYou are right, I thought #20064 was already merged, while it is not. Everything is fine now.\n\n- The code is ok, I miss extending embeddings from number to p-adic fields, but this issue is out of scope for this ticket.\n\n- Please document that precision cannot decrease.\n\n```\nsage: N=QQ[sqrt(2)]\nsage: e=N.embeddings(RR)[0]\nsage: N.refine_embedding(e,16) is e\nTrue\nsage: e\nRing morphism:\n  From: Number Field in sqrt2 with defining polynomial x^2 - 2\n  To:   Real Field with 53 bits of precision\n  Defn: sqrt2 |--> -1.41421356237310\n```\n\nAlso, it would be nice to note that, when the refinement is not unique, an \"arbitrary\" one is returned:\n\n```\nsage: N=NumberField(x^4 - 199999999/50000000*x^2 + 40000000400000001/10000000000000000,'a')\nsage: e = N.embeddings(ComplexField(16))[1]\nsage: e\nRing morphism:\n  From: Number Field in a with defining polynomial x^4 - 199999999/50000000*x^2 + 40000000400000001/10000000000000000\n  To:   Complex Field with 16 bits of precision\n  Defn: a |--> 1.414\nsage: N.refine_embedding(e,32)\nRing morphism:\n  From: Number Field in a with defining polynomial x^4 - 199999999/50000000*x^2 + 40000000400000001/10000000000000000\n  To:   Complex Field with 32 bits of precision\n  Defn: a |--> 1.41421356 - 0.0000988882552*I\nsage: len(N.embeddings(ComplexField(16)))\n2\nsage: len(N.embeddings(ComplexField(32)))\n4\n```",
    "created_at": "2016-02-24T13:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18836#issuecomment-318287",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:18'></a>
You are right, I thought #20064 was already merged, while it is not. Everything is fine now.

- The code is ok, I miss extending embeddings from number to p-adic fields, but this issue is out of scope for this ticket.

- Please document that precision cannot decrease.

```
sage: N=QQ[sqrt(2)]
sage: e=N.embeddings(RR)[0]
sage: N.refine_embedding(e,16) is e
True
sage: e
Ring morphism:
  From: Number Field in sqrt2 with defining polynomial x^2 - 2
  To:   Real Field with 53 bits of precision
  Defn: sqrt2 |--> -1.41421356237310
```

Also, it would be nice to note that, when the refinement is not unique, an "arbitrary" one is returned:

```
sage: N=NumberField(x^4 - 199999999/50000000*x^2 + 40000000400000001/10000000000000000,'a')
sage: e = N.embeddings(ComplexField(16))[1]
sage: e
Ring morphism:
  From: Number Field in a with defining polynomial x^4 - 199999999/50000000*x^2 + 40000000400000001/10000000000000000
  To:   Complex Field with 16 bits of precision
  Defn: a |--> 1.414
sage: N.refine_embedding(e,32)
Ring morphism:
  From: Number Field in a with defining polynomial x^4 - 199999999/50000000*x^2 + 40000000400000001/10000000000000000
  To:   Complex Field with 32 bits of precision
  Defn: a |--> 1.41421356 - 0.0000988882552*I
sage: len(N.embeddings(ComplexField(16)))
2
sage: len(N.embeddings(ComplexField(32)))
4
```
