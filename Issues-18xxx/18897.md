# Issue 18897: Memory leak in sage.misc.binary_tree.BinareeTree

archive/issues_018660.json:
```json
{
    "body": "This method, inspired from the code of Nils Bruin posted in the sage-devel post [Memory leaks on matrix creation?](https://groups.google.com/d/msg/sage-devel/Jqi5f60j_lY/M7esZcJliZoJ), shows some leak in the eigenvalues method for integer matrices of order larger or equal to 4. Examples are below.\n\n```python\ndef test(L, dim):\n    import gc\n    from collections import Counter\n    gc.collect()\n    pre={id(c) for c in gc.get_objects()}\n    for _ in range(100):\n        matrix(dim, L).eigenvalues()\n    gc.collect()\n    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n    return [(k,v) for (k,v) in post.iteritems() if v>10]\n```\n\nAn example with no leak::\n\n```python\n    sage: L = [1,0,0,1,0,0,1,1,0,0,0,1,2,0,0,1,0,0,2,0,0,0,0,0,1]\n    sage: test(L, 5)\n    []\n```\nFive forgotten polynomials::\n\n```python\n    sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]\n    sage: test(L, 5)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]\n```\nTwelve forgotten polynomials::\n\n```python\n    sage: L = [0,1,2,0,0,2,1,2,1,1,1,0,1,1,2,1,1,1,2,0,0,2,0,2,0]\n    sage: test(L, 5)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1200)]\n```\nA 4 by 4 matrix with five forgotten polynomials::\n\n```python\n    sage: L = [0, 2, 0, 2, 2, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1]\n    sage: test(L, 4)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]\n```\n\nRandom ones::\n\n```python\n    sage: test([randint(0,100) for _ in range(9)], 3)\n    []\n    sage: test([randint(0,100) for _ in range(16)], 4)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]\n    sage: test([randint(0,2) for _ in range(25)], 5)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]\n    sage: test([randint(0,2) for _ in range(25)], 5)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1200)]\n    sage: test([randint(0,2) for _ in range(25)], 5)\n    []\n    sage: test([randint(0,100) for _ in range(36)], 6)\n    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1400)]\n```\n\nCC:  simonking @jm58660\n\nBranch/Commit: 80ce8765811c7ac18b921467e113630169b6aaaf\n\nReviewer: S\u00e9bastien Labb\u00e9, Dima Pasechnik\n\nAuthor: Simon King\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18897\n\n",
    "closed_at": "2015-07-16T22:51:17Z",
    "created_at": "2015-07-14T09:02:44Z",
    "labels": [
        "component: memleak",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Memory leak in sage.misc.binary_tree.BinareeTree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18897",
    "user": "https://github.com/seblabbe"
}
```
This method, inspired from the code of Nils Bruin posted in the sage-devel post [Memory leaks on matrix creation?](https://groups.google.com/d/msg/sage-devel/Jqi5f60j_lY/M7esZcJliZoJ), shows some leak in the eigenvalues method for integer matrices of order larger or equal to 4. Examples are below.

```python
def test(L, dim):
    import gc
    from collections import Counter
    gc.collect()
    pre={id(c) for c in gc.get_objects()}
    for _ in range(100):
        matrix(dim, L).eigenvalues()
    gc.collect()
    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
    return [(k,v) for (k,v) in post.iteritems() if v>10]
```

An example with no leak::

```python
    sage: L = [1,0,0,1,0,0,1,1,0,0,0,1,2,0,0,1,0,0,2,0,0,0,0,0,1]
    sage: test(L, 5)
    []
```
Five forgotten polynomials::

```python
    sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]
    sage: test(L, 5)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]
```
Twelve forgotten polynomials::

```python
    sage: L = [0,1,2,0,0,2,1,2,1,1,1,0,1,1,2,1,1,1,2,0,0,2,0,2,0]
    sage: test(L, 5)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1200)]
```
A 4 by 4 matrix with five forgotten polynomials::

```python
    sage: L = [0, 2, 0, 2, 2, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1]
    sage: test(L, 4)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]
```

Random ones::

```python
    sage: test([randint(0,100) for _ in range(9)], 3)
    []
    sage: test([randint(0,100) for _ in range(16)], 4)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]
    sage: test([randint(0,2) for _ in range(25)], 5)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]
    sage: test([randint(0,2) for _ in range(25)], 5)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1200)]
    sage: test([randint(0,2) for _ in range(25)], 5)
    []
    sage: test([randint(0,100) for _ in range(36)], 6)
    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1400)]
```

CC:  simonking @jm58660

Branch/Commit: 80ce8765811c7ac18b921467e113630169b6aaaf

Reviewer: Sébastien Labbé, Dima Pasechnik

Author: Simon King

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18897





---

archive/issue_comments_329586.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This method, inspired from the code of Nils Bruin posted in the sage-devel post [Memory leaks on matrix creation?](https://groups.google.com/d/msg/sage-devel/Jqi5f60j_lY/M7esZcJliZoJ), shows some leak in the eigenvalues method for 4x4 and 5x5 integer matrices. Examples are below.\n+This method, inspired from the code of Nils Bruin posted in the sage-devel post [Memory leaks on matrix creation?](https://groups.google.com/d/msg/sage-devel/Jqi5f60j_lY/M7esZcJliZoJ), shows some leak in the eigenvalues method for integer matrices of order larger or equal to 4. Examples are below.\n \n ```python\n def test(L, dim):\n@@ -55,4 +55,6 @@\n     [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1200)]\n     sage: test([randint(0,2) for _ in range(25)], 5)\n     []\n+    sage: test([randint(0,100) for _ in range(36)], 6)\n+    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1400)]\n ```\n``````\n",
    "created_at": "2015-07-14T09:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329586",
    "user": "https://github.com/seblabbe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This method, inspired from the code of Nils Bruin posted in the sage-devel post [Memory leaks on matrix creation?](https://groups.google.com/d/msg/sage-devel/Jqi5f60j_lY/M7esZcJliZoJ), shows some leak in the eigenvalues method for 4x4 and 5x5 integer matrices. Examples are below.
+This method, inspired from the code of Nils Bruin posted in the sage-devel post [Memory leaks on matrix creation?](https://groups.google.com/d/msg/sage-devel/Jqi5f60j_lY/M7esZcJliZoJ), shows some leak in the eigenvalues method for integer matrices of order larger or equal to 4. Examples are below.
 
 ```python
 def test(L, dim):
@@ -55,4 +55,6 @@
     [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1200)]
     sage: test([randint(0,2) for _ in range(25)], 5)
     []
+    sage: test([randint(0,100) for _ in range(36)], 6)
+    [(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1400)]
 ```
``````




---

archive/issue_events_067764.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "rename": {
        "from": "Memory leak in eigenvalues method",
        "to": "Memory leak in polynomial_compiled.univar_pd"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18897#event-67764"
}
```



---

archive/issue_comments_329587.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt seems to come from the factor method applied on the charpoly after changing the ring to `AlgebraicField`.\n\n```python\ndef test(L, dim):\n    import gc\n    from collections import Counter\n    gc.collect()\n    pre={id(c) for c in gc.get_objects()}\n    for _ in range(100):\n        matrix(dim, L).charpoly().change_ring(QQbar).factor()\n    gc.collect()\n    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n    return [(k,v) for (k,v) in post.iteritems() if v>10]\n```\nWe get:\n\n```python\nsage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]\nsage: test(L, 5)\n[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1000)]\n```",
    "created_at": "2015-07-14T09:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329587",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:4'></a>
It seems to come from the factor method applied on the charpoly after changing the ring to `AlgebraicField`.

```python
def test(L, dim):
    import gc
    from collections import Counter
    gc.collect()
    pre={id(c) for c in gc.get_objects()}
    for _ in range(100):
        matrix(dim, L).charpoly().change_ring(QQbar).factor()
    gc.collect()
    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
    return [(k,v) for (k,v) in post.iteritems() if v>10]
```
We get:

```python
sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]
sage: test(L, 5)
[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1000)]
```



---

archive/issue_comments_329588.json:
```json
{
    "body": "<a id='comment:5'></a>\nOk, so it seems to come from calling `roots` on an element of the `Univariate Polynomial Ring in x over Algebraic Field` :\n\n```python\ndef test():\n    import gc\n    from collections import Counter\n    gc.collect()\n    pre={id(c) for c in gc.get_objects()}\n    R.<x> = QQbar['x']\n    p = x^5 - 8*x^4 + 21*x^3 - 22*x^2 + 9*x - 1\n    for _ in range(100):\n        #p.factor()                              # which then calls:\n        #QQbar._factor_univariate_polynomial(p)  # which then calls:\n        p.roots()\n    gc.collect()\n    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n    return [(k,v) for (k,v) in post.iteritems() if v>10]\n```\nWe get:\n\n```python\nsage: test()\n[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1000)]\n```",
    "created_at": "2015-07-14T10:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329588",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:5'></a>
Ok, so it seems to come from calling `roots` on an element of the `Univariate Polynomial Ring in x over Algebraic Field` :

```python
def test():
    import gc
    from collections import Counter
    gc.collect()
    pre={id(c) for c in gc.get_objects()}
    R.<x> = QQbar['x']
    p = x^5 - 8*x^4 + 21*x^3 - 22*x^2 + 9*x - 1
    for _ in range(100):
        #p.factor()                              # which then calls:
        #QQbar._factor_univariate_polynomial(p)  # which then calls:
        p.roots()
    gc.collect()
    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
    return [(k,v) for (k,v) in post.iteritems() if v>10]
```
We get:

```python
sage: test()
[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 1000)]
```



---

archive/issue_comments_329589.json:
```json
{
    "body": "<a id='comment:6'></a>\nThose `univar_pd` are created in the class `CompiledPolynomialFunction` which provides an easy way to create the problem:\n\n```python\ndef test():\n    from sage.rings.polynomial.polynomial_compiled import CompiledPolynomialFunction\n    import gc\n    from collections import Counter\n    gc.collect()\n    pre={id(c) for c in gc.get_objects()}\n    L = [-1, 9, -22, 21, -8, 1]\n    for _ in range(100):\n        CompiledPolynomialFunction(L)\n    gc.collect()\n    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n    return [(k,v) for (k,v) in post.iteritems() if v>10]\n```\nand we get:\n\n```python\nsage: test()\n[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 100)]\n```",
    "created_at": "2015-07-14T14:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329589",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:6'></a>
Those `univar_pd` are created in the class `CompiledPolynomialFunction` which provides an easy way to create the problem:

```python
def test():
    from sage.rings.polynomial.polynomial_compiled import CompiledPolynomialFunction
    import gc
    from collections import Counter
    gc.collect()
    pre={id(c) for c in gc.get_objects()}
    L = [-1, 9, -22, 21, -8, 1]
    for _ in range(100):
        CompiledPolynomialFunction(L)
    gc.collect()
    post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
    return [(k,v) for (k,v) in post.iteritems() if v>10]
```
and we get:

```python
sage: test()
[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 100)]
```



---

archive/issue_comments_329590.json:
```json
{
    "body": "<a id='comment:7'></a>\nOk, so this goes now beyond my knowledge. Somebody else will need to check why the univar_pd are not garbage collected.\n\nhttps://github.com/sagemath/sage/blob/master/src/sage/rings/polynomial/polynomial_compiled.pyx#L402",
    "created_at": "2015-07-14T14:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329590",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:7'></a>
Ok, so this goes now beyond my knowledge. Somebody else will need to check why the univar_pd are not garbage collected.

https://github.com/sagemath/sage/blob/master/src/sage/rings/polynomial/polynomial_compiled.pyx#L402



---

archive/issue_comments_329591.json:
```json
{
    "body": "<a id='comment:8'></a>\nDuring initialisation of a compiled polynomial, `_parse_structure()` is called, which creates a `sage.misc.binary_tree.BinaryTree`. Into this binary tree, a `univar_pd` is inserted.\n\nWhen finishing initialisation of a compiled polynomial, the binary tree gets deallocated. However, the `univar_pd` does *not* get deallocated. I don't know why it isn't, but rather clearly that's where the leak is occurring.",
    "created_at": "2015-07-14T19:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329591",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
During initialisation of a compiled polynomial, `_parse_structure()` is called, which creates a `sage.misc.binary_tree.BinaryTree`. Into this binary tree, a `univar_pd` is inserted.

When finishing initialisation of a compiled polynomial, the binary tree gets deallocated. However, the `univar_pd` does *not* get deallocated. I don't know why it isn't, but rather clearly that's where the leak is occurring.



---

archive/issue_comments_329592.json:
```json
{
    "body": "<a id='comment:9'></a>\nGot it!\n\nIt seems that a binary tree is NEVER completely deallocated. When calling `binary_tree_dealloc(node)`, then the left and right descendants of `node` are deallocated, but not `node` itself.",
    "created_at": "2015-07-14T19:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329592",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Got it!

It seems that a binary tree is NEVER completely deallocated. When calling `binary_tree_dealloc(node)`, then the left and right descendants of `node` are deallocated, but not `node` itself.



---

archive/issue_comments_329593.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [SimonKing](#comment%3A9):\n> It seems that a binary tree is NEVER completely deallocated. When calling `binary_tree_dealloc(node)`, then the left and right descendants of `node` are deallocated, but not `node` itself.\n\n\nTo be precise: The pointer to `node` is freed, but one should call `free_binary_tree_node(node)` instead.",
    "created_at": "2015-07-14T19:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329593",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
Replying to [SimonKing](#comment%3A9):
> It seems that a binary tree is NEVER completely deallocated. When calling `binary_tree_dealloc(node)`, then the left and right descendants of `node` are deallocated, but not `node` itself.


To be precise: The pointer to `node` is freed, but one should call `free_binary_tree_node(node)` instead.



---

archive/issue_comments_329594.json:
```json
{
    "body": "Changing branch from \"\" to \"u/SimonKing/memory_leak_compiled_polynomial\"",
    "created_at": "2015-07-14T20:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329594",
    "user": "https://github.com/simon-king-jena"
}
```

Changing branch from "" to "u/SimonKing/memory_leak_compiled_polynomial"



---

archive/issue_comments_329595.json:
```json
{
    "body": "Changing commit from \"\" to \"79923d35f59362331a5aa006f8dbc6c329acd440\"",
    "created_at": "2015-07-14T20:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329595",
    "user": "https://github.com/simon-king-jena"
}
```

Changing commit from "" to "79923d35f59362331a5aa006f8dbc6c329acd440"



---

archive/issue_comments_329596.json:
```json
{
    "body": "<a id='comment:12'></a>\nI used your test to show that the memory leak is fixed. Note, however, that the fix is in the deallocation of binary trees and has nothing to do with compiled polynomials.\n\n---\nNew commits:\n|                                                                                                                                          |                                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|\n|[79923d3](https://github.com/sagemath/sagetrac-mirror/commit/79923d35f59362331a5aa006f8dbc6c329acd440)|`Fix a memory leak in the deallocation of binary trees`|",
    "created_at": "2015-07-14T20:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329596",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
I used your test to show that the memory leak is fixed. Note, however, that the fix is in the deallocation of binary trees and has nothing to do with compiled polynomials.

---
New commits:
|                                                                                                                                          |                                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|
|[79923d3](https://github.com/sagemath/sagetrac-mirror/commit/79923d35f59362331a5aa006f8dbc6c329acd440)|`Fix a memory leak in the deallocation of binary trees`|



---

archive/issue_comments_329597.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-14T20:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329597",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329598.json:
```json
{
    "body": "Changing author from \"\" to \"Simon King\"",
    "created_at": "2015-07-14T20:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329598",
    "user": "https://github.com/simon-king-jena"
}
```

Changing author from "" to "Simon King"



---

archive/issue_comments_329599.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [SimonKing](#comment%3A10):\n> Replying to [SimonKing](#comment%3A9):\n> > It seems that a binary tree is NEVER completely deallocated. When calling `binary_tree_dealloc(node)`, then the left and right descendants of `node` are deallocated, but not `node` itself.\n\n> \n> To be precise: The pointer to `node` is freed, but one should call `free_binary_tree_node(node)` instead.\n\n\nthe following looks more logical to me (diff over your patch):\n\n```\ndiff --git a/src/sage/misc/binary_tree.pyx b/src/sage/misc/binary_tree.pyx\nindex 984ef57..c637d91 100644\n--- a/src/sage/misc/binary_tree.pyx\n+++ b/src/sage/misc/binary_tree.pyx\n@@ -25,13 +25,11 @@ cdef void free_binary_tree_node(binary_tree_node *self):\n     sage_free(self)\n \n cdef void binary_tree_dealloc(binary_tree_node *self):\n-    # deallocate the descendants of self, but NOT self\n     if self.left != NULL:\n         binary_tree_dealloc(self.left)\n-        free_binary_tree_node(self.left)\n     if self.right != NULL:\n         binary_tree_dealloc(self.right)\n-        free_binary_tree_node(self.right)\n+    free_binary_tree_node(self)\n \n \n cdef void binary_tree_insert(binary_tree_node *self, int key, object value):\n@@ -210,7 +208,6 @@ cdef class BinaryTree:\n         \"\"\"\n         if self.head != NULL:\n             binary_tree_dealloc(self.head)\n-            free_binary_tree_node(self.head)\n \n     def insert(BinaryTree self, object key, object value = None):\n         \"\"\"\n```",
    "created_at": "2015-07-15T08:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329599",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>
Replying to [SimonKing](#comment%3A10):
> Replying to [SimonKing](#comment%3A9):
> > It seems that a binary tree is NEVER completely deallocated. When calling `binary_tree_dealloc(node)`, then the left and right descendants of `node` are deallocated, but not `node` itself.

> 
> To be precise: The pointer to `node` is freed, but one should call `free_binary_tree_node(node)` instead.


the following looks more logical to me (diff over your patch):

```
diff --git a/src/sage/misc/binary_tree.pyx b/src/sage/misc/binary_tree.pyx
index 984ef57..c637d91 100644
--- a/src/sage/misc/binary_tree.pyx
+++ b/src/sage/misc/binary_tree.pyx
@@ -25,13 +25,11 @@ cdef void free_binary_tree_node(binary_tree_node *self):
     sage_free(self)
 
 cdef void binary_tree_dealloc(binary_tree_node *self):
-    # deallocate the descendants of self, but NOT self
     if self.left != NULL:
         binary_tree_dealloc(self.left)
-        free_binary_tree_node(self.left)
     if self.right != NULL:
         binary_tree_dealloc(self.right)
-        free_binary_tree_node(self.right)
+    free_binary_tree_node(self)
 
 
 cdef void binary_tree_insert(binary_tree_node *self, int key, object value):
@@ -210,7 +208,6 @@ cdef class BinaryTree:
         """
         if self.head != NULL:
             binary_tree_dealloc(self.head)
-            free_binary_tree_node(self.head)
 
     def insert(BinaryTree self, object key, object value = None):
         """
```



---

archive/issue_comments_329600.json:
```json
{
    "body": "<a id='comment:15'></a>\nThe fix proposed by Simon fixes all the way to create the bug I saw yesterday. To me it is a positive review. I added a reference to the ticket in the doctest and posted that on public/18897.\n\n(the comment of dimpase just appeared as I was writing this comment)\n\n---\nNew commits:\n|                                                                                                                                          |                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[720de3b](https://github.com/sagemath/sagetrac-mirror/commit/720de3bf96d4e72965581bbf5ad372e94fe61237)|`Trac #18897: added a ref to trac # in doctest`|",
    "created_at": "2015-07-15T08:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329600",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:15'></a>
The fix proposed by Simon fixes all the way to create the bug I saw yesterday. To me it is a positive review. I added a reference to the ticket in the doctest and posted that on public/18897.

(the comment of dimpase just appeared as I was writing this comment)

---
New commits:
|                                                                                                                                          |                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[720de3b](https://github.com/sagemath/sagetrac-mirror/commit/720de3bf96d4e72965581bbf5ad372e94fe61237)|`Trac #18897: added a ref to trac # in doctest`|



---

archive/issue_comments_329601.json:
```json
{
    "body": "Changing commit from \"79923d35f59362331a5aa006f8dbc6c329acd440\" to \"720de3bf96d4e72965581bbf5ad372e94fe61237\"",
    "created_at": "2015-07-15T08:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329601",
    "user": "https://github.com/seblabbe"
}
```

Changing commit from "79923d35f59362331a5aa006f8dbc6c329acd440" to "720de3bf96d4e72965581bbf5ad372e94fe61237"



---

archive/issue_comments_329602.json:
```json
{
    "body": "Changing branch from \"u/SimonKing/memory_leak_compiled_polynomial\" to \"public/18897\"",
    "created_at": "2015-07-15T08:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329602",
    "user": "https://github.com/seblabbe"
}
```

Changing branch from "u/SimonKing/memory_leak_compiled_polynomial" to "public/18897"



---

archive/issue_comments_329603.json:
```json
{
    "body": "<a id='comment:16'></a>\nI am now running tests with the change I proposed (which I like as it makes code shorter and more readable), just to be 100% sure.",
    "created_at": "2015-07-15T08:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329603",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>
I am now running tests with the change I proposed (which I like as it makes code shorter and more readable), just to be 100% sure.



---

archive/issue_events_067765.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "rename": {
        "from": "Memory leak in polynomial_compiled.univar_pd",
        "to": "Memory leak in sage.misc.binary_tree.pyx"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18897#event-67765"
}
```



---

archive/issue_comments_329604.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [dimpase](#comment%3A14):\n> the following looks more logical to me (diff over your patch):\n\n\nI wanted the change to be as small as possible. But I wouldn't oppose to have all checks done in `binary_tree_dealloc`:\n\n```python\ncdef void binary_tree_dealloc(binary_tree_node *self):\n    if self == NULL:\n        return\n    binary_tree_dealloc(self.left)\n    binary_tree_dealloc(self.right)\n    free_binary_tree_node(self)\n```",
    "created_at": "2015-07-15T09:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329604",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
Replying to [dimpase](#comment%3A14):
> the following looks more logical to me (diff over your patch):


I wanted the change to be as small as possible. But I wouldn't oppose to have all checks done in `binary_tree_dealloc`:

```python
cdef void binary_tree_dealloc(binary_tree_node *self):
    if self == NULL:
        return
    binary_tree_dealloc(self.left)
    binary_tree_dealloc(self.right)
    free_binary_tree_node(self)
```



---

archive/issue_events_067766.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "rename": {
        "from": "Memory leak in sage.misc.binary_tree.pyx",
        "to": "Memory leak in polynomial_compiled.univar_pd"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18897#event-67766"
}
```



---

archive/issue_comments_329605.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [SimonKing](#comment%3A18):\n> Replying to [dimpase](#comment%3A14):\n> > the following looks more logical to me (diff over your patch):\n\n> \n> I wanted the change to be as small as possible. But I wouldn't oppose to have all checks done in `binary_tree_dealloc`:\n\n\nPS: And then of course `BinaryTree.__dealloc__` simply becomes\n\n```python\n    def __dealloc__(self):\n        binary_tree_dealloc(self.head)\n```",
    "created_at": "2015-07-15T09:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329605",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>
Replying to [SimonKing](#comment%3A18):
> Replying to [dimpase](#comment%3A14):
> > the following looks more logical to me (diff over your patch):

> 
> I wanted the change to be as small as possible. But I wouldn't oppose to have all checks done in `binary_tree_dealloc`:


PS: And then of course `BinaryTree.__dealloc__` simply becomes

```python
    def __dealloc__(self):
        binary_tree_dealloc(self.head)
```



---

archive/issue_comments_329606.json:
```json
{
    "body": "<a id='comment:20'></a>\nPS: I am doing this change now. Also, I am changing `__init__` into `__cinit__`.\n\nRationale: The current `__init__` just sets the pointer `self.head = NULL`. But initialising c-data (pointers etc.) is the job of `__cinit__`: It should initialise the c-data to such extend that `__dealloc__` can not crash. With the current code, there may be circumstances under which the `__init__` is not called, so that `__dealloc__` will fail with a segmentation fault.",
    "created_at": "2015-07-15T09:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329606",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'></a>
PS: I am doing this change now. Also, I am changing `__init__` into `__cinit__`.

Rationale: The current `__init__` just sets the pointer `self.head = NULL`. But initialising c-data (pointers etc.) is the job of `__cinit__`: It should initialise the c-data to such extend that `__dealloc__` can not crash. With the current code, there may be circumstances under which the `__init__` is not called, so that `__dealloc__` will fail with a segmentation fault.



---

archive/issue_comments_329607.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [SimonKing](#comment%3A18):\n> Replying to [dimpase](#comment%3A14):\n> > the following looks more logical to me (diff over your patch):\n\n> \n> I wanted the change to be as small as possible. But I wouldn't oppose to have all checks done in `binary_tree_dealloc`:\n> \n> ```\n> #!python\n> cdef void binary_tree_dealloc(binary_tree_node *self):\n>     if self == NULL:\n>         return\n>     binary_tree_dealloc(self.left)\n>     binary_tree_dealloc(self.right)\n>     free_binary_tree_node(self)\n> ```\n\n\nor even \n\n```python\ncdef void binary_tree_dealloc(binary_tree_node *self):\n    if self != NULL:\n        binary_tree_dealloc(self.left)\n        binary_tree_dealloc(self.right)\n        free_binary_tree_node(self)\n```",
    "created_at": "2015-07-15T09:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329607",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>
Replying to [SimonKing](#comment%3A18):
> Replying to [dimpase](#comment%3A14):
> > the following looks more logical to me (diff over your patch):

> 
> I wanted the change to be as small as possible. But I wouldn't oppose to have all checks done in `binary_tree_dealloc`:
> 
> ```
> #!python
> cdef void binary_tree_dealloc(binary_tree_node *self):
>     if self == NULL:
>         return
>     binary_tree_dealloc(self.left)
>     binary_tree_dealloc(self.right)
>     free_binary_tree_node(self)
> ```


or even 

```python
cdef void binary_tree_dealloc(binary_tree_node *self):
    if self != NULL:
        binary_tree_dealloc(self.left)
        binary_tree_dealloc(self.right)
        free_binary_tree_node(self)
```



---

archive/issue_comments_329608.json:
```json
{
    "body": "<a id='comment:22'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[6d34077](https://github.com/sagemath/sagetrac-mirror/commit/6d340771137df00b0da8a24485a95383f111d533)|`Simplify code for deallocation of binary trees`|",
    "created_at": "2015-07-15T09:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329608",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[6d34077](https://github.com/sagemath/sagetrac-mirror/commit/6d340771137df00b0da8a24485a95383f111d533)|`Simplify code for deallocation of binary trees`|



---

archive/issue_comments_329609.json:
```json
{
    "body": "Changing commit from \"720de3bf96d4e72965581bbf5ad372e94fe61237\" to \"6d340771137df00b0da8a24485a95383f111d533\"",
    "created_at": "2015-07-15T09:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329609",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "720de3bf96d4e72965581bbf5ad372e94fe61237" to "6d340771137df00b0da8a24485a95383f111d533"



---

archive/issue_comments_329610.json:
```json
{
    "body": "<a id='comment:23'></a>\nSomething completely different: Shouldn't `BinaryTree` be moved to `sage.data_structures`?\n\n---\nNew commits:\n|                                                                                                                                          |                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[6d34077](https://github.com/sagemath/sagetrac-mirror/commit/6d340771137df00b0da8a24485a95383f111d533)|`Simplify code for deallocation of binary trees`|\n\n---\nNew commits:\n|                                                                                                                                          |                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[6d34077](https://github.com/sagemath/sagetrac-mirror/commit/6d340771137df00b0da8a24485a95383f111d533)|`Simplify code for deallocation of binary trees`|",
    "created_at": "2015-07-15T09:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329610",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>
Something completely different: Shouldn't `BinaryTree` be moved to `sage.data_structures`?

---
New commits:
|                                                                                                                                          |                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[6d34077](https://github.com/sagemath/sagetrac-mirror/commit/6d340771137df00b0da8a24485a95383f111d533)|`Simplify code for deallocation of binary trees`|

---
New commits:
|                                                                                                                                          |                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[6d34077](https://github.com/sagemath/sagetrac-mirror/commit/6d340771137df00b0da8a24485a95383f111d533)|`Simplify code for deallocation of binary trees`|



---

archive/issue_comments_329611.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [dimpase](#comment%3A21):\n> or even \n> \n> \n> ```\n> #!python\n> cdef void binary_tree_dealloc(binary_tree_node *self):\n>     if self != NULL:\n>         binary_tree_dealloc(self.left)\n>         binary_tree_dealloc(self.right)\n>         free_binary_tree_node(self)\n> ```\n\n\nRight. Before I change that: Should the module be moved to data_structures? After all, it is a general data structure that does not rely on sage-specific structures (i.e., not on parents and elements).",
    "created_at": "2015-07-15T09:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329611",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>
Replying to [dimpase](#comment%3A21):
> or even 
> 
> 
> ```
> #!python
> cdef void binary_tree_dealloc(binary_tree_node *self):
>     if self != NULL:
>         binary_tree_dealloc(self.left)
>         binary_tree_dealloc(self.right)
>         free_binary_tree_node(self)
> ```


Right. Before I change that: Should the module be moved to data_structures? After all, it is a general data structure that does not rely on sage-specific structures (i.e., not on parents and elements).



---

archive/issue_comments_329612.json:
```json
{
    "body": "<a id='comment:25'></a>\nPPS: Why is the implementation of binary trees in sage.combinat.binary_tree totally orthogonal to the one in sage.misc.binary_tree?\n\nI'll ask on sage.combinat, and I suppose moving to sage.data_structure and unification of the two implementations should be on a separate ticket. So, I'll do the additional simplification now, and everything else is for later.",
    "created_at": "2015-07-15T09:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329612",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>
PPS: Why is the implementation of binary trees in sage.combinat.binary_tree totally orthogonal to the one in sage.misc.binary_tree?

I'll ask on sage.combinat, and I suppose moving to sage.data_structure and unification of the two implementations should be on a separate ticket. So, I'll do the additional simplification now, and everything else is for later.



---

archive/issue_comments_329613.json:
```json
{
    "body": "Changing commit from \"6d340771137df00b0da8a24485a95383f111d533\" to \"80ce8765811c7ac18b921467e113630169b6aaaf\"",
    "created_at": "2015-07-15T09:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329613",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6d340771137df00b0da8a24485a95383f111d533" to "80ce8765811c7ac18b921467e113630169b6aaaf"



---

archive/issue_comments_329614.json:
```json
{
    "body": "<a id='comment:26'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[80ce876](https://github.com/sagemath/sagetrac-mirror/commit/80ce8765811c7ac18b921467e113630169b6aaaf)|`Further simplification`|",
    "created_at": "2015-07-15T09:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329614",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                        |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[80ce876](https://github.com/sagemath/sagetrac-mirror/commit/80ce8765811c7ac18b921467e113630169b6aaaf)|`Further simplification`|



---

archive/issue_comments_329615.json:
```json
{
    "body": "<a id='comment:27'></a>\nI just tried the example in the ticket description, both on unpatched and patched, and got\nthe following disturbing output:\n\n```\n$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath Version 6.8.beta8, Release Date: 2015-07-10               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: def test(L, dim):                                      \n        import gc\n        from collections import Counter\n        gc.collect()\n        pre={id(c) for c in gc.get_objects()}\n        for _ in range(100):\n                matrix(dim, L).eigenvalues()\n        gc.collect()\n        post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n        return [(k,v) for (k,v) in post.iteritems() if v>10]\n....:     \nsage: L = [1,0,0,1,0,0,1,1,0,0,0,1,2,0,0,1,0,0,2,0,0,0,0,0,1]\nsage: test(L, 5)\n[(<class 'sage.structure.dynamic_class.DynamicMetaclass'>, 11),\n (<type 'instance'>, 106),\n (<type 'function'>, 1680),\n (<type 'dict'>, 271),\n (<type 'type'>, 78),\n (<type 'method_descriptor'>, 195),\n (<type 'wrapper_descriptor'>, 403),\n (<type 'property'>, 37),\n (<type 'classobj'>, 13),\n (<type 'module'>, 83),\n (<type 'list'>, 262),\n (<type 'sage.misc.constant_function.ConstantFunction'>, 21),\n (<type 'tuple'>, 264),\n (<type 'getset_descriptor'>, 199),\n (<class 'weakref.KeyedRef'>, 64),\n (<class 'numpy.testing.nosetester.NoseTester'>, 19),\n (<type 'staticmethod'>, 50),\n (<type 'member_descriptor'>, 12),\n (<type 'builtin_function_or_method'>, 177),\n (<type 'weakref'>, 152),\n (<type 'instancemethod'>, 22),\n (<type 'cell'>, 40)]\nsage: \n```\n\nif I re-run stuff, it works as it should; on the patched system:\n\n```\nsage: test(L, 5) # as before the fix:\n[]\nsage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]\nsage: test(L, 5) # did not work before the fix:\n[]\nsage: \n```\n\non the unpatched system:\n\n```\nsage: test(L, 5)\n[]\nsage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]\nsage: test(L, 5)\n[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]\nsage: \n```\n\nIn short: something happens on the 1st call... \nPerhaps it is harmless, I don't know.",
    "created_at": "2015-07-15T09:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329615",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
I just tried the example in the ticket description, both on unpatched and patched, and got
the following disturbing output:

```
$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath Version 6.8.beta8, Release Date: 2015-07-10               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: def test(L, dim):                                      
        import gc
        from collections import Counter
        gc.collect()
        pre={id(c) for c in gc.get_objects()}
        for _ in range(100):
                matrix(dim, L).eigenvalues()
        gc.collect()
        post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
        return [(k,v) for (k,v) in post.iteritems() if v>10]
....:     
sage: L = [1,0,0,1,0,0,1,1,0,0,0,1,2,0,0,1,0,0,2,0,0,0,0,0,1]
sage: test(L, 5)
[(<class 'sage.structure.dynamic_class.DynamicMetaclass'>, 11),
 (<type 'instance'>, 106),
 (<type 'function'>, 1680),
 (<type 'dict'>, 271),
 (<type 'type'>, 78),
 (<type 'method_descriptor'>, 195),
 (<type 'wrapper_descriptor'>, 403),
 (<type 'property'>, 37),
 (<type 'classobj'>, 13),
 (<type 'module'>, 83),
 (<type 'list'>, 262),
 (<type 'sage.misc.constant_function.ConstantFunction'>, 21),
 (<type 'tuple'>, 264),
 (<type 'getset_descriptor'>, 199),
 (<class 'weakref.KeyedRef'>, 64),
 (<class 'numpy.testing.nosetester.NoseTester'>, 19),
 (<type 'staticmethod'>, 50),
 (<type 'member_descriptor'>, 12),
 (<type 'builtin_function_or_method'>, 177),
 (<type 'weakref'>, 152),
 (<type 'instancemethod'>, 22),
 (<type 'cell'>, 40)]
sage: 
```

if I re-run stuff, it works as it should; on the patched system:

```
sage: test(L, 5) # as before the fix:
[]
sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]
sage: test(L, 5) # did not work before the fix:
[]
sage: 
```

on the unpatched system:

```
sage: test(L, 5)
[]
sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]
sage: test(L, 5)
[(<type 'sage.rings.polynomial.polynomial_compiled.univar_pd'>, 500)]
sage: 
```

In short: something happens on the 1st call... 
Perhaps it is harmless, I don't know.



---

archive/issue_comments_329616.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-07-15T09:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329616",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_329617.json:
```json
{
    "body": "<a id='comment:28'></a>\nperhaps `matrix` leaks in other places, too; on the patched system:\n\n```\n$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath Version 6.8.beta8, Release Date: 2015-07-10               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: matrix(5,[1]*25);                                  \nsage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]\nsage: def test(L, dim):                                      \n        import gc\n        from collections import Counter\n        gc.collect()\n        pre={id(c) for c in gc.get_objects()}\n        for _ in range(100):\n                matrix(dim, L).eigenvalues()\n        gc.collect()\n        post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n        return [(k,v) for (k,v) in post.iteritems() if v>10]\n....:     \nsage: test(L, 5)\n[(<type 'function'>, 13),\n (<type 'dict'>, 18),\n (<class 'sage.structure.dynamic_class.DynamicMetaclass'>, 11),\n (<type 'list'>, 34),\n (<type 'sage.misc.constant_function.ConstantFunction'>, 21),\n (<type 'tuple'>, 88),\n (<type 'cell'>, 24),\n (<class 'weakref.KeyedRef'>, 64),\n (<type 'staticmethod'>, 12),\n (<type 'weakref'>, 27)]\nsage: test(L, 5)\n[]\nsage: \n```",
    "created_at": "2015-07-15T10:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329617",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>
perhaps `matrix` leaks in other places, too; on the patched system:

```
$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath Version 6.8.beta8, Release Date: 2015-07-10               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: matrix(5,[1]*25);                                  
sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]
sage: def test(L, dim):                                      
        import gc
        from collections import Counter
        gc.collect()
        pre={id(c) for c in gc.get_objects()}
        for _ in range(100):
                matrix(dim, L).eigenvalues()
        gc.collect()
        post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
        return [(k,v) for (k,v) in post.iteritems() if v>10]
....:     
sage: test(L, 5)
[(<type 'function'>, 13),
 (<type 'dict'>, 18),
 (<class 'sage.structure.dynamic_class.DynamicMetaclass'>, 11),
 (<type 'list'>, 34),
 (<type 'sage.misc.constant_function.ConstantFunction'>, 21),
 (<type 'tuple'>, 88),
 (<type 'cell'>, 24),
 (<class 'weakref.KeyedRef'>, 64),
 (<type 'staticmethod'>, 12),
 (<type 'weakref'>, 27)]
sage: test(L, 5)
[]
sage: 
```



---

archive/issue_comments_329618.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-07-15T10:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329618",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_329619.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [dimpase](#comment%3A27):\n> In short: something happens on the 1st call... \n> Perhaps it is harmless, I don't know.\n\n\nWell, if something is only there in the first run, then it is not accumulating, and thus by definition it is not a leak, and thus not critical.",
    "created_at": "2015-07-15T10:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329619",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'></a>
Replying to [dimpase](#comment%3A27):
> In short: something happens on the 1st call... 
> Perhaps it is harmless, I don't know.


Well, if something is only there in the first run, then it is not accumulating, and thus by definition it is not a leak, and thus not critical.



---

archive/issue_comments_329620.json:
```json
{
    "body": "<a id='comment:30'></a>\nOn the other hand: What happens if you are also iterating over different base rings?",
    "created_at": "2015-07-15T10:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329620",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
On the other hand: What happens if you are also iterating over different base rings?



---

archive/issue_comments_329621.json:
```json
{
    "body": "<a id='comment:31'></a>\n\n```\nsage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]\nsage: def test(L, dim):\n....:     import gc\n....:     from collections import Counter\n....:     gc.collect()\n....:     pre={id(c) for c in gc.get_objects()}\n....:     m = matrix(dim, L)\n....:     for p in range(2,102):\n....:         m.change_ring(GF(nth_prime(p))).eigenvalues()\n....:     gc.collect()\n....:     post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)\n....:     return [(k,v) for (k,v) in post.iteritems() if v>10]\n....: \nsage: test(L, 5)\n[(<class 'sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_pseudo_conway_with_category'>,\n  100),\n (<type 'sage.libs.ntl.ntl_ZZ_pX.ntl_ZZ_pX'>, 76),\n (<type 'sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint'>,\n  2494),\n (<class 'sage.rings.finite_rings.homset.FiniteFieldHomset_with_category'>,\n  76),\n (<type 'sage.categories.morphism.IdentityMorphism'>, 153),\n (<class 'sage.rings.homset.RingHomset_quo_ring_with_category'>, 100),\n (<type 'weakref'>, 3700),\n (<type 'sage.categories.map.FormalCompositeMap'>, 200),\n (<class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>,\n  16),\n (<class 'sage.modules.free_module.FreeModule_ambient_field_with_category'>,\n  60),\n (<type 'sage.libs.ntl.ntl_ZZ_pEContext.ntl_ZZ_pEContext_class'>, 75),\n (<type 'sage.categories.morphism.CallMorphism'>, 197),\n (<class 'sage.rings.polynomial.polynomial_ring.PolynomialRing_dense_mod_p_with_category'>,\n  176),\n (<type 'list'>, 8080),\n (<type 'sage.rings.finite_rings.element_givaro.FiniteField_givaroElement'>,\n  523),\n (<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>, 100),\n (<type 'sage.rings.finite_rings.integer_mod.Int_to_IntegerMod'>, 200),\n (<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>, 382),\n (<type 'sage.misc.constant_function.ConstantFunction'>, 3050),\n (<class 'sage.rings.ideal.Ideal_pid'>, 100),\n (<type 'sage.rings.finite_rings.hom_prime_finite_field.FiniteFieldHomomorphism_prime'>,\n  76),\n (<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>,\n  100),\n (<class 'sage.structure.sequence.Sequence_generic'>, 75),\n (<type 'dict'>, 2034),\n (<type 'sage.misc.cachefunc.CachedMethodCaller'>, 123),\n (<class 'sage.rings.finite_rings.conway_polynomials.PseudoConwayLattice'>,\n  100),\n (<type 'staticmethod'>, 132),\n (<type 'cell'>, 204),\n (<type 'sage.structure.element.NamedBinopMethod'>, 13),\n (<type 'sage.rings.finite_rings.integer_mod.Integer_to_IntegerMod'>, 176),\n (<type 'sage.rings.finite_rings.element_givaro.Cache_givaro'>, 16),\n (<type 'sage.rings.polynomial.polynomial_element.PolynomialBaseringInjection'>,\n  200),\n (<type 'classobj'>, 13),\n (<type 'function'>, 1817),\n (<type 'property'>, 37),\n (<class 'sage.rings.finite_rings.finite_field_pari_ffelt.FiniteField_pari_ffelt_with_category'>,\n  60),\n (<class 'sage.rings.homset.RingHomset_generic_with_category'>, 100),\n (<class 'sage.structure.dynamic_class.DynamicMetaclass'>, 72),\n (<type 'frozenset'>, 33),\n (<type 'sage.structure.coerce_dict.MonoDictEraser'>, 2087),\n (<type 'sage.structure.coerce_dict.TripleDict'>, 1043),\n (<type 'instancemethod'>, 609),\n (<type 'sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt'>,\n  180),\n (<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>, 21),\n (<type 'wrapper_descriptor'>, 513),\n (<type 'instance'>, 106),\n (<type 'sage.libs.ntl.ntl_ZZ_pContext.ntl_ZZ_pContext_class'>, 76),\n (<type 'getset_descriptor'>, 202),\n (<class 'sage.rings.finite_rings.homset.FiniteFieldHomset_with_category'>,\n  76),\n (<type 'sage.structure.coerce_dict.MonoDict'>, 2087),\n (<type 'sage.structure.coerce_maps.DefaultConvertMap_unique'>, 1090),\n (<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>, 21566),\n (<class 'weakref.KeyedRef'>, 10447),\n (<type 'builtin_function_or_method'>, 428),\n (<type 'member_descriptor'>, 12),\n (<class 'sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_pseudo_conway_with_category.element_class'>,\n  76),\n (<type 'sage.rings.morphism.RingHomomorphism_cover'>, 76),\n (<class 'sage.categories.homset.Homset_with_category'>, 176),\n (<type 'method_descriptor'>, 360),\n (<type 'module'>, 94),\n (<type 'tuple'>, 2688),\n (<type 'sage.libs.pari.gen.gen'>, 60),\n (<type 'sage.structure.coerce_dict.TripleDictEraser'>, 1043),\n (<class 'numpy.testing.nosetester.NoseTester'>, 19),\n (<type 'type'>, 82),\n (<type 'sage.rings.morphism.RingMap_lift'>, 76)]\nsage: test(L, 5)\n[]\n```\n\nSo, that looks like a different kind of leak: Some objects are not deallocated when they aren't used (output of the first `test(L, 5)`), but at least they are still available for future use (output of the second `test(L, 5)`).\n\nThe patch from this ticket has fixes one leak, and I'd say that the other leak should be addressed on a different ticket.",
    "created_at": "2015-07-15T10:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329621",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'></a>

```
sage: L = [1,1,0,1,0,1,2,1,1,0,0,1,2,0,0,1,1,0,2,0,0,0,0,0,1]
sage: def test(L, dim):
....:     import gc
....:     from collections import Counter
....:     gc.collect()
....:     pre={id(c) for c in gc.get_objects()}
....:     m = matrix(dim, L)
....:     for p in range(2,102):
....:         m.change_ring(GF(nth_prime(p))).eigenvalues()
....:     gc.collect()
....:     post=Counter(type(o) for o in gc.get_objects() if id(o) not in pre)
....:     return [(k,v) for (k,v) in post.iteritems() if v>10]
....: 
sage: test(L, 5)
[(<class 'sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_pseudo_conway_with_category'>,
  100),
 (<type 'sage.libs.ntl.ntl_ZZ_pX.ntl_ZZ_pX'>, 76),
 (<type 'sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint'>,
  2494),
 (<class 'sage.rings.finite_rings.homset.FiniteFieldHomset_with_category'>,
  76),
 (<type 'sage.categories.morphism.IdentityMorphism'>, 153),
 (<class 'sage.rings.homset.RingHomset_quo_ring_with_category'>, 100),
 (<type 'weakref'>, 3700),
 (<type 'sage.categories.map.FormalCompositeMap'>, 200),
 (<class 'sage.rings.finite_rings.finite_field_givaro.FiniteField_givaro_with_category'>,
  16),
 (<class 'sage.modules.free_module.FreeModule_ambient_field_with_category'>,
  60),
 (<type 'sage.libs.ntl.ntl_ZZ_pEContext.ntl_ZZ_pEContext_class'>, 75),
 (<type 'sage.categories.morphism.CallMorphism'>, 197),
 (<class 'sage.rings.polynomial.polynomial_ring.PolynomialRing_dense_mod_p_with_category'>,
  176),
 (<type 'list'>, 8080),
 (<type 'sage.rings.finite_rings.element_givaro.FiniteField_givaroElement'>,
  523),
 (<type 'sage.rings.finite_rings.integer_mod.NativeIntStruct'>, 100),
 (<type 'sage.rings.finite_rings.integer_mod.Int_to_IntegerMod'>, 200),
 (<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>, 382),
 (<type 'sage.misc.constant_function.ConstantFunction'>, 3050),
 (<class 'sage.rings.ideal.Ideal_pid'>, 100),
 (<type 'sage.rings.finite_rings.hom_prime_finite_field.FiniteFieldHomomorphism_prime'>,
  76),
 (<class 'sage.rings.finite_rings.finite_field_prime_modn.FiniteField_prime_modn_with_category'>,
  100),
 (<class 'sage.structure.sequence.Sequence_generic'>, 75),
 (<type 'dict'>, 2034),
 (<type 'sage.misc.cachefunc.CachedMethodCaller'>, 123),
 (<class 'sage.rings.finite_rings.conway_polynomials.PseudoConwayLattice'>,
  100),
 (<type 'staticmethod'>, 132),
 (<type 'cell'>, 204),
 (<type 'sage.structure.element.NamedBinopMethod'>, 13),
 (<type 'sage.rings.finite_rings.integer_mod.Integer_to_IntegerMod'>, 176),
 (<type 'sage.rings.finite_rings.element_givaro.Cache_givaro'>, 16),
 (<type 'sage.rings.polynomial.polynomial_element.PolynomialBaseringInjection'>,
  200),
 (<type 'classobj'>, 13),
 (<type 'function'>, 1817),
 (<type 'property'>, 37),
 (<class 'sage.rings.finite_rings.finite_field_pari_ffelt.FiniteField_pari_ffelt_with_category'>,
  60),
 (<class 'sage.rings.homset.RingHomset_generic_with_category'>, 100),
 (<class 'sage.structure.dynamic_class.DynamicMetaclass'>, 72),
 (<type 'frozenset'>, 33),
 (<type 'sage.structure.coerce_dict.MonoDictEraser'>, 2087),
 (<type 'sage.structure.coerce_dict.TripleDict'>, 1043),
 (<type 'instancemethod'>, 609),
 (<type 'sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt'>,
  180),
 (<class 'sage.structure.dynamic_class.DynamicClasscallMetaclass'>, 21),
 (<type 'wrapper_descriptor'>, 513),
 (<type 'instance'>, 106),
 (<type 'sage.libs.ntl.ntl_ZZ_pContext.ntl_ZZ_pContext_class'>, 76),
 (<type 'getset_descriptor'>, 202),
 (<class 'sage.rings.finite_rings.homset.FiniteFieldHomset_with_category'>,
  76),
 (<type 'sage.structure.coerce_dict.MonoDict'>, 2087),
 (<type 'sage.structure.coerce_maps.DefaultConvertMap_unique'>, 1090),
 (<type 'sage.rings.finite_rings.integer_mod.IntegerMod_int'>, 21566),
 (<class 'weakref.KeyedRef'>, 10447),
 (<type 'builtin_function_or_method'>, 428),
 (<type 'member_descriptor'>, 12),
 (<class 'sage.rings.algebraic_closure_finite_field.AlgebraicClosureFiniteField_pseudo_conway_with_category.element_class'>,
  76),
 (<type 'sage.rings.morphism.RingHomomorphism_cover'>, 76),
 (<class 'sage.categories.homset.Homset_with_category'>, 176),
 (<type 'method_descriptor'>, 360),
 (<type 'module'>, 94),
 (<type 'tuple'>, 2688),
 (<type 'sage.libs.pari.gen.gen'>, 60),
 (<type 'sage.structure.coerce_dict.TripleDictEraser'>, 1043),
 (<class 'numpy.testing.nosetester.NoseTester'>, 19),
 (<type 'type'>, 82),
 (<type 'sage.rings.morphism.RingMap_lift'>, 76)]
sage: test(L, 5)
[]
```

So, that looks like a different kind of leak: Some objects are not deallocated when they aren't used (output of the first `test(L, 5)`), but at least they are still available for future use (output of the second `test(L, 5)`).

The patch from this ticket has fixes one leak, and I'd say that the other leak should be addressed on a different ticket.



---

archive/issue_comments_329622.json:
```json
{
    "body": "<a id='comment:32'></a>\n\n```\n...\n (<class 'sage.rings.homset.RingHomset_quo_ring_with_category'>, 100),\n...\n (<class 'sage.rings.homset.RingHomset_generic_with_category'>, 100),\n...\n```\nI guess that's the culprit.",
    "created_at": "2015-07-15T10:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329622",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>

```
...
 (<class 'sage.rings.homset.RingHomset_quo_ring_with_category'>, 100),
...
 (<class 'sage.rings.homset.RingHomset_generic_with_category'>, 100),
...
```
I guess that's the culprit.



---

archive/issue_comments_329623.json:
```json
{
    "body": "<a id='comment:33'></a>\nI opened #18905 to work on the latest leaks. Otherwise, it's good to go.",
    "created_at": "2015-07-15T10:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329623",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>
I opened #18905 to work on the latest leaks. Otherwise, it's good to go.



---

archive/issue_comments_329624.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [dimpase](#comment%3A27):\n> In short: something happens on the 1st call... \n> Perhaps it is harmless, I don't know.\n\n\nYes, I noticed the same thing yesterday. There is stuff that is there the first execution, but never after. I did not look deeper into that...",
    "created_at": "2015-07-15T10:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329624",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:34'></a>
Replying to [dimpase](#comment%3A27):
> In short: something happens on the 1st call... 
> Perhaps it is harmless, I don't know.


Yes, I noticed the same thing yesterday. There is stuff that is there the first execution, but never after. I did not look deeper into that...



---

archive/issue_comments_329625.json:
```json
{
    "body": "Changing reviewer from \"\" to \"S\u00e9bastien Labb\u00e9, Dima Pasechnik\"",
    "created_at": "2015-07-15T10:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329625",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Sébastien Labbé, Dima Pasechnik"



---

archive/issue_comments_329626.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-15T10:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329626",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_067767.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "rename": {
        "from": "Memory leak in polynomial_compiled.univar_pd",
        "to": "Memory leak in sage.misc.binary_tree.BinareeTree"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18897#event-67767"
}
```



---

archive/issue_comments_329627.json:
```json
{
    "body": "Changing branch from \"public/18897\" to \"80ce8765811c7ac18b921467e113630169b6aaaf\"",
    "created_at": "2015-07-16T22:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329627",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/18897" to "80ce8765811c7ac18b921467e113630169b6aaaf"



---

archive/issue_events_067768.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-16T22:51:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18897#event-67768"
}
```



---

archive/issue_comments_329628.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-16T22:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18897#issuecomment-329628",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
