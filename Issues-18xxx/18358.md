# Issue 18358: a cython function that produces long given python input

archive/issues_018121.json:
```json
{
    "body": "I met twice the same problem which is the nedd for a standalone function that given a python objects return an associated long (if it makes sense).\n\nThe following is not safe\n\n```\ncdef long f(x):\n    return x\n```\nsince `f(2/3)` would return `0` (see e.g. #18278). Moreover, one could expect something that would be very fast for both Python int and Sage integers (see #18346).\n\n**CC:**  @nathanncohen\n\n**Branch/Commit:** [6b46fee72115db82a7eedb02482b83af694247ba](https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba)\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Vincent Delecroix\n\nIssue created by migration from https://trac.sagemath.org/ticket/18358\n\n",
    "closed_at": "2015-05-14T22:40:19Z",
    "created_at": "2015-05-03T20:25:38Z",
    "labels": [
        "component: coercion",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.7",
    "title": "a cython function that produces long given python input",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/18358",
    "user": "https://github.com/videlec"
}
```
I met twice the same problem which is the nedd for a standalone function that given a python objects return an associated long (if it makes sense).

The following is not safe

```
cdef long f(x):
    return x
```
since `f(2/3)` would return `0` (see e.g. #18278). Moreover, one could expect something that would be very fast for both Python int and Sage integers (see #18346).

**CC:**  @nathanncohen

**Branch/Commit:** [6b46fee72115db82a7eedb02482b83af694247ba](https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba)

**Reviewer:** Jeroen Demeyer

**Author:** Vincent Delecroix

Issue created by migration from https://trac.sagemath.org/ticket/18358





---

archive/issue_events_164852.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-03T20:44:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164852"
}
```



---

archive/issue_comments_254989.json:
```json
{
    "body": "<a id='comment:1'></a>\nThat's not a bug report, but a support request. If you post this to `sage-support`, I'll answer.",
    "created_at": "2015-05-03T20:44:04Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254989",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
That's not a bug report, but a support request. If you post this to `sage-support`, I'll answer.



---

archive/issue_events_164853.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-03T20:44:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164853"
}
```



---

archive/issue_events_164854.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-03T20:44:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164854"
}
```



---

archive/issue_events_164855.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-03T20:44:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164855"
}
```



---

archive/issue_events_164856.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-03T20:44:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164856"
}
```



---

archive/issue_comments_254990.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [jdemeyer](#comment%3A1):\n> That's not a bug report, but a support request. If you post this to `sage-support`, I'll answer.\n\n\nhttps://groups.google.com/forum/#!topic/sage-support/0ATjCgQlq4c",
    "created_at": "2015-05-03T20:49:38Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254990",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>
Replying to [jdemeyer](#comment%3A1):
> That's not a bug report, but a support request. If you post this to `sage-support`, I'll answer.


https://groups.google.com/forum/#!topic/sage-support/0ATjCgQlq4c



---

archive/issue_comments_254991.json:
```json
{
    "body": "<a id='comment:4'></a>\nIn view of your answer on sage-support, it might still be worth to have something along\n\n```\ncdef inline long long_or_LONG_MIN(x):\n    if PyInt_CheckExact(x):\n        return PyInt_AS_LONG(x)\n    elif type(x) is Integer:\n        if mpz_fits_slong_p((<Integer>x).value):\n            return mpz_get_si((<Integer>x).value)\n        else:\n            return LONG_MIN\n    else:\n        try:\n            return PyNumber_Index(x)\n        except Exception:\n            return LONG_MIN \n```\nIt would be faster for Python ints and Sage integers.\n\nVincent",
    "created_at": "2015-05-04T13:08:02Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254991",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>
In view of your answer on sage-support, it might still be worth to have something along

```
cdef inline long long_or_LONG_MIN(x):
    if PyInt_CheckExact(x):
        return PyInt_AS_LONG(x)
    elif type(x) is Integer:
        if mpz_fits_slong_p((<Integer>x).value):
            return mpz_get_si((<Integer>x).value)
        else:
            return LONG_MIN
    else:
        try:
            return PyNumber_Index(x)
        except Exception:
            return LONG_MIN 
```
It would be faster for Python ints and Sage integers.

Vincent



---

archive/issue_comments_254992.json:
```json
{
    "body": "<a id='comment:5'></a>\nFor Python `int`s, there will not be much difference (calling `PyNumber_Index(x)` on an `int` just returns `x`, so the only overhead is a function call and some reference counting).\n\nFor `Integer`, there is a larger gain. It's just annoying that Python doesn't allow defining a fast conversion `ArbitraryType` -> C `long`.",
    "created_at": "2015-05-04T13:46:04Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254992",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
For Python `int`s, there will not be much difference (calling `PyNumber_Index(x)` on an `int` just returns `x`, so the only overhead is a function call and some reference counting).

For `Integer`, there is a larger gain. It's just annoying that Python doesn't allow defining a fast conversion `ArbitraryType` -> C `long`.



---

archive/issue_events_164857.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-04T14:02:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164857"
}
```



---

archive/issue_events_164858.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-04T14:02:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164858"
}
```



---

archive/issue_events_164859.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-04T14:02:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164859"
}
```



---

archive/issue_comments_254993.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jdemeyer](#comment%3A5):\n\n> For `Integer`, there is a larger gain. It's just annoying that Python doesn't allow defining a fast conversion `ArbitraryType` -> C `long`.\n\n\nIt does! It's called `tp_hash` :-). It's of course already taken for other purposes. We'd need an extra slot. Something along the lines of the conversion macro suggested in [comment:4](#comment%3A4) would probably be the best we can do without it.",
    "created_at": "2015-05-04T16:07:39Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254993",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>
Replying to [jdemeyer](#comment%3A5):

> For `Integer`, there is a larger gain. It's just annoying that Python doesn't allow defining a fast conversion `ArbitraryType` -> C `long`.


It does! It's called `tp_hash` :-). It's of course already taken for other purposes. We'd need an extra slot. Something along the lines of the conversion macro suggested in [comment:4](#comment%3A4) would probably be the best we can do without it.



---

archive/issue_comments_254994.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [nbruin](#comment%3A7):\n> We'd need an extra slot.\n\nSometimes I wish I could just patch Python...\n\n> Something along the lines of the conversion macro suggested in [comment:4](#comment%3A4) would probably be the best we can do without it.\n\nIndeed.",
    "created_at": "2015-05-04T17:30:38Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254994",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [nbruin](#comment%3A7):
> We'd need an extra slot.

Sometimes I wish I could just patch Python...

> Something along the lines of the conversion macro suggested in [comment:4](#comment%3A4) would probably be the best we can do without it.

Indeed.



---

archive/issue_events_164860.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-05T13:45:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164860"
}
```



---

archive/issue_events_164861.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-05T13:45:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164861"
}
```



---

archive/issue_comments_254995.json:
```json
{
    "body": "**Branch:** [u/vdelecroix/18358](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/18358)",
    "created_at": "2015-05-05T13:45:06Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254995",
    "user": "https://github.com/videlec"
}
```

**Branch:** [u/vdelecroix/18358](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/18358)



---

archive/issue_comments_254996.json:
```json
{
    "body": "<a id='comment:9'></a>\nHere is an experimental branch with a macro `pyobject_to_long` in `sage.misc.long`. I do not like the gestion of error but I do not know how to do better without affecting performance. Please tell me.\n\nIt is used in `Integer.__pow__` and `Rational.__pow__` as a proof of concept. And we win 20 precious nano seconds when the exponent is a small Sage Integer (~10%):\n\n```\nsage: timeit(\"2**5\", number=400000, repeat=20)\n400000 loops, best of 20: 248 ns per loop\nsage: timeit(\"(2/3)**2\", number=100000, repeat=20)\n100000 loops, best of 20: 1.1 \u00b5s per loop\n```\nagainst\n\n```\nsage: timeit(\"2**5\", number=400000, repeat=20)\n400000 loops, best of 20: 228 ns per loop\nsage: timeit(\"(2/3)**2\", number=100000, repeat=20)\n200000 loops, best of 30: 990 ns per loop\n```\n\nVincent\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/524393b4aa89d93d8cc6831480e07c7350c06535\">524393b</a></td><td><code>Trac 18290: upgrade sets and cartesian products</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e1e22d1ae7c494773df4b161690d707762558c7\">6e1e22d</a></td><td><code>Trac 18290: better doc + remove duplications</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/671e6ecff8079a28f9b43fda96da29530ba454a8\">671e6ec</a></td><td><code>Trac 18290: fix doctest in combinat/tutorial</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0378c4a5319972501b1d982c3670085f139c1dd4\">0378c4a</a></td><td><code>Trac 18290: fix doctest in categories/enumerated_sets.py</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/925b2e062bb86212916b73c831f9333f312db4b5\">925b2e0</a></td><td><code>Trac 18290: fix doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8e9148450538c683d50c89d90acf7457feb0cc03\">8e91484</a></td><td><code>Trac 18358: macro to cast Python object to C long</code></td></tr></table>\n",
    "created_at": "2015-05-05T13:45:06Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254996",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>
Here is an experimental branch with a macro `pyobject_to_long` in `sage.misc.long`. I do not like the gestion of error but I do not know how to do better without affecting performance. Please tell me.

It is used in `Integer.__pow__` and `Rational.__pow__` as a proof of concept. And we win 20 precious nano seconds when the exponent is a small Sage Integer (~10%):

```
sage: timeit("2**5", number=400000, repeat=20)
400000 loops, best of 20: 248 ns per loop
sage: timeit("(2/3)**2", number=100000, repeat=20)
100000 loops, best of 20: 1.1 µs per loop
```
against

```
sage: timeit("2**5", number=400000, repeat=20)
400000 loops, best of 20: 228 ns per loop
sage: timeit("(2/3)**2", number=100000, repeat=20)
200000 loops, best of 30: 990 ns per loop
```

Vincent

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/524393b4aa89d93d8cc6831480e07c7350c06535">524393b</a></td><td><code>Trac 18290: upgrade sets and cartesian products</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e1e22d1ae7c494773df4b161690d707762558c7">6e1e22d</a></td><td><code>Trac 18290: better doc + remove duplications</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/671e6ecff8079a28f9b43fda96da29530ba454a8">671e6ec</a></td><td><code>Trac 18290: fix doctest in combinat/tutorial</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0378c4a5319972501b1d982c3670085f139c1dd4">0378c4a</a></td><td><code>Trac 18290: fix doctest in categories/enumerated_sets.py</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/925b2e062bb86212916b73c831f9333f312db4b5">925b2e0</a></td><td><code>Trac 18290: fix doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8e9148450538c683d50c89d90acf7457feb0cc03">8e91484</a></td><td><code>Trac 18358: macro to cast Python object to C long</code></td></tr></table>




---

archive/issue_comments_254997.json:
```json
{
    "body": "**Commit:** [8e9148450538c683d50c89d90acf7457feb0cc03](https://github.com/sagemath/sagetrac-mirror/commit/8e9148450538c683d50c89d90acf7457feb0cc03)",
    "created_at": "2015-05-05T13:45:06Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254997",
    "user": "https://github.com/videlec"
}
```

**Commit:** [8e9148450538c683d50c89d90acf7457feb0cc03](https://github.com/sagemath/sagetrac-mirror/commit/8e9148450538c683d50c89d90acf7457feb0cc03)



---

archive/issue_comments_254998.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b6df2eeff959f3f0ffb3d47dfe1c84a04a25ac11\">b6df2ee</a></td><td><code>Trac 18358: macro pyobject -> long conversion</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1e7db2e21982c4d5097e0452bb19c5329ad1c40e\">1e7db2e</a></td><td><code>Trac 18358: use macro in pow for Integer/Rational</code></td></tr></table>\n",
    "created_at": "2015-05-05T13:45:28Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254998",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b6df2eeff959f3f0ffb3d47dfe1c84a04a25ac11">b6df2ee</a></td><td><code>Trac 18358: macro pyobject -> long conversion</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1e7db2e21982c4d5097e0452bb19c5329ad1c40e">1e7db2e</a></td><td><code>Trac 18358: use macro in pow for Integer/Rational</code></td></tr></table>




---

archive/issue_comments_254999.json:
```json
{
    "body": "**Changing commit** from \"[8e9148450538c683d50c89d90acf7457feb0cc03](https://github.com/sagemath/sagetrac-mirror/commit/8e9148450538c683d50c89d90acf7457feb0cc03)\" to \"[1e7db2e21982c4d5097e0452bb19c5329ad1c40e](https://github.com/sagemath/sagetrac-mirror/commit/1e7db2e21982c4d5097e0452bb19c5329ad1c40e)\".",
    "created_at": "2015-05-05T13:45:28Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-254999",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8e9148450538c683d50c89d90acf7457feb0cc03](https://github.com/sagemath/sagetrac-mirror/commit/8e9148450538c683d50c89d90acf7457feb0cc03)" to "[1e7db2e21982c4d5097e0452bb19c5329ad1c40e](https://github.com/sagemath/sagetrac-mirror/commit/1e7db2e21982c4d5097e0452bb19c5329ad1c40e)".



---

archive/issue_comments_255000.json:
```json
{
    "body": "<a id='comment:11'></a>\n`except LONG_MIN` -> `except? LONG_MIN` and there is no need to document `LONG_MIN` in the docstring.",
    "created_at": "2015-05-05T14:47:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255000",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
`except LONG_MIN` -> `except? LONG_MIN` and there is no need to document `LONG_MIN` in the docstring.



---

archive/issue_comments_255001.json:
```json
{
    "body": "<a id='comment:12'></a>\n`PyInt_CheckExact(...)` -> `isinstance(..., int)`",
    "created_at": "2015-05-05T14:48:19Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255001",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
`PyInt_CheckExact(...)` -> `isinstance(..., int)`



---

archive/issue_comments_255002.json:
```json
{
    "body": "<a id='comment:13'></a>\n`OverflowError` -> `OverflowError(\"Integer too large to convert to C long\")` or something like that.\n\nAnd obviously: doctests please.",
    "created_at": "2015-05-05T14:50:34Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255002",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
`OverflowError` -> `OverflowError("Integer too large to convert to C long")` or something like that.

And obviously: doctests please.



---

archive/issue_events_164862.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-05T14:50:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164862"
}
```



---

archive/issue_events_164863.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-05T14:50:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164863"
}
```



---

archive/issue_comments_255003.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A13):\n> `OverflowError` -> `OverflowError(\"Integer too large to convert to C long\")` or something like that.\n> \n> And obviously: doctests please.\n\n\nHow? Should I use `Integer.__pow__` and `Rational.__pow__` with indirect doctests?",
    "created_at": "2015-05-05T15:45:20Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255003",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A13):
> `OverflowError` -> `OverflowError("Integer too large to convert to C long")` or something like that.
> 
> And obviously: doctests please.


How? Should I use `Integer.__pow__` and `Rational.__pow__` with indirect doctests?



---

archive/issue_comments_255004.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [vdelecroix](#comment%3A14):\n> Replying to [jdemeyer](#comment%3A13):\n> > `OverflowError` -> `OverflowError(\"Integer too large to convert to C long\")` or something like that.\n> > \n> > And obviously: doctests please.\n\n> \n> How? Should I use `Integer.__pow__` and `Rational.__pow__` with indirect doctests?\n\nThat's actually not a bad idea. You should probably test the following numbers: `int(10)`, `long(10)`, `long(10^100)`, `10`, `10^100`, `QQ(10)`, `QQ(10^100)`, `1/2`.",
    "created_at": "2015-05-05T19:00:28Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255004",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [vdelecroix](#comment%3A14):
> Replying to [jdemeyer](#comment%3A13):
> > `OverflowError` -> `OverflowError("Integer too large to convert to C long")` or something like that.
> > 
> > And obviously: doctests please.

> 
> How? Should I use `Integer.__pow__` and `Rational.__pow__` with indirect doctests?

That's actually not a bad idea. You should probably test the following numbers: `int(10)`, `long(10)`, `long(10^100)`, `10`, `10^100`, `QQ(10)`, `QQ(10^100)`, `1/2`.



---

archive/issue_comments_255005.json:
```json
{
    "body": "<a id='comment:16'></a>\nIt would make sense to merge 6.7.beta4 and replace all occurances of `PyNumber_Index` and `PyNumber_AsSsize_t` by this new function.",
    "created_at": "2015-05-05T21:01:35Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255005",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
It would make sense to merge 6.7.beta4 and replace all occurances of `PyNumber_Index` and `PyNumber_AsSsize_t` by this new function.



---

archive/issue_comments_255006.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [jdemeyer](#comment%3A16):\n> It would make sense to merge 6.7.beta4 and replace all occurances of `PyNumber_Index` and `PyNumber_AsSsize_t` by this new function.\n\n\nIt might not be good everywhere as the overflow might not be appropriate. I will have a look at occurrences.",
    "created_at": "2015-05-05T21:26:14Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255006",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>
Replying to [jdemeyer](#comment%3A16):
> It would make sense to merge 6.7.beta4 and replace all occurances of `PyNumber_Index` and `PyNumber_AsSsize_t` by this new function.


It might not be good everywhere as the overflow might not be appropriate. I will have a look at occurrences.



---

archive/issue_comments_255007.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f67ead58cc51250037409d64205f209b2286d960\">f67ead5</a></td><td><code>Trac 18358: macro pyobject -> long conversion</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/98008da68599a8f53269811b363f5bb2bef86d27\">98008da</a></td><td><code>Trac 18358: use macro in pow for Integer/Rational</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c7b741fc34a79e594c327ed72476a7972481fc33\">c7b741f</a></td><td><code>Trac 18358: better pyobject_to_long</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e7ad72f5a0a5e44d4d6aad5208e597201edf2be8\">e7ad72f</a></td><td><code>Trac 18358: use pyobject_to_long where possible</code></td></tr></table>\n",
    "created_at": "2015-05-06T07:10:56Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255007",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f67ead58cc51250037409d64205f209b2286d960">f67ead5</a></td><td><code>Trac 18358: macro pyobject -> long conversion</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/98008da68599a8f53269811b363f5bb2bef86d27">98008da</a></td><td><code>Trac 18358: use macro in pow for Integer/Rational</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c7b741fc34a79e594c327ed72476a7972481fc33">c7b741f</a></td><td><code>Trac 18358: better pyobject_to_long</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e7ad72f5a0a5e44d4d6aad5208e597201edf2be8">e7ad72f</a></td><td><code>Trac 18358: use pyobject_to_long where possible</code></td></tr></table>




---

archive/issue_comments_255008.json:
```json
{
    "body": "**Changing commit** from \"[1e7db2e21982c4d5097e0452bb19c5329ad1c40e](https://github.com/sagemath/sagetrac-mirror/commit/1e7db2e21982c4d5097e0452bb19c5329ad1c40e)\" to \"[e7ad72f5a0a5e44d4d6aad5208e597201edf2be8](https://github.com/sagemath/sagetrac-mirror/commit/e7ad72f5a0a5e44d4d6aad5208e597201edf2be8)\".",
    "created_at": "2015-05-06T07:10:56Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255008",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1e7db2e21982c4d5097e0452bb19c5329ad1c40e](https://github.com/sagemath/sagetrac-mirror/commit/1e7db2e21982c4d5097e0452bb19c5329ad1c40e)" to "[e7ad72f5a0a5e44d4d6aad5208e597201edf2be8](https://github.com/sagemath/sagetrac-mirror/commit/e7ad72f5a0a5e44d4d6aad5208e597201edf2be8)".



---

archive/issue_comments_255009.json:
```json
{
    "body": "<a id='comment:19'></a>\nRebased on sage-6.7.beta4. I used `pyobject_to_long` where it seemed appropriate.\n\nVincent",
    "created_at": "2015-05-06T07:11:33Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255009",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>
Rebased on sage-6.7.beta4. I used `pyobject_to_long` where it seemed appropriate.

Vincent



---

archive/issue_events_164864.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-06T07:11:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164864"
}
```



---

archive/issue_events_164865.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-06T07:11:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164865"
}
```



---

archive/issue_events_164866.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-06T07:29:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164866"
}
```



---

archive/issue_events_164867.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-06T07:29:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164867"
}
```



---

archive/issue_comments_255010.json:
```json
{
    "body": "<a id='comment:20'></a>\nIn `c_graph`, if you call a variable `u_long`, actually make it a `long` (now it's still an `int` which means it can silently overflow).",
    "created_at": "2015-05-06T07:29:33Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255010",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
In `c_graph`, if you call a variable `u_long`, actually make it a `long` (now it's still an `int` which means it can silently overflow).



---

archive/issue_comments_255011.json:
```json
{
    "body": "<a id='comment:21'></a>\nYou're not actually using this:\n\n```\nsage: tens = [10r, 10l, 10, 10/1]\n```",
    "created_at": "2015-05-06T07:33:08Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255011",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
You're not actually using this:

```
sage: tens = [10r, 10l, 10, 10/1]
```



---

archive/issue_comments_255012.json:
```json
{
    "body": "<a id='comment:22'></a>\nI would prefer to replace\n\n```\ntry:\n    n = pyobject_to_long(exp)\nexcept TypeError:\n    raise TypeError(\"non-integral exponents not supported\")\n```\nby\n\n```\nn = pyobject_to_long(exp)\n```",
    "created_at": "2015-05-06T07:37:08Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255012",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
I would prefer to replace

```
try:
    n = pyobject_to_long(exp)
except TypeError:
    raise TypeError("non-integral exponents not supported")
```
by

```
n = pyobject_to_long(exp)
```



---

archive/issue_comments_255013.json:
```json
{
    "body": "**Changing commit** from \"[e7ad72f5a0a5e44d4d6aad5208e597201edf2be8](https://github.com/sagemath/sagetrac-mirror/commit/e7ad72f5a0a5e44d4d6aad5208e597201edf2be8)\" to \"[90453ff943b693383a38c358aeb4a81a9c5da25e](https://github.com/sagemath/sagetrac-mirror/commit/90453ff943b693383a38c358aeb4a81a9c5da25e)\".",
    "created_at": "2015-05-11T17:21:51Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255013",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[e7ad72f5a0a5e44d4d6aad5208e597201edf2be8](https://github.com/sagemath/sagetrac-mirror/commit/e7ad72f5a0a5e44d4d6aad5208e597201edf2be8)" to "[90453ff943b693383a38c358aeb4a81a9c5da25e](https://github.com/sagemath/sagetrac-mirror/commit/90453ff943b693383a38c358aeb4a81a9c5da25e)".



---

archive/issue_comments_255014.json:
```json
{
    "body": "<a id='comment:23'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90453ff943b693383a38c358aeb4a81a9c5da25e\">90453ff</a></td><td><code>Trac 18358: review commit</code></td></tr></table>\n",
    "created_at": "2015-05-11T17:21:51Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90453ff943b693383a38c358aeb4a81a9c5da25e">90453ff</a></td><td><code>Trac 18358: review commit</code></td></tr></table>




---

archive/issue_comments_255015.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2015-05-11T17:25:13Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255015",
    "user": "https://github.com/videlec"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_events_164868.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-11T17:25:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164868"
}
```



---

archive/issue_events_164869.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-11T17:25:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164869"
}
```



---

archive/issue_comments_255016.json:
```json
{
    "body": "<a id='comment:25'></a>\nTwo more points:\n\n1. `raied` -> `raised`\n\n2. The doctests for `Integer.__pow__` and `Rational.__pow__` seem redundant. It's sufficient to keep just one.",
    "created_at": "2015-05-12T12:31:12Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255016",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
Two more points:

1. `raied` -> `raised`

2. The doctests for `Integer.__pow__` and `Rational.__pow__` seem redundant. It's sufficient to keep just one.



---

archive/issue_events_164870.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-12T12:44:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164870"
}
```



---

archive/issue_events_164871.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-12T12:44:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164871"
}
```



---

archive/issue_comments_255017.json:
```json
{
    "body": "**Changing commit** from \"[90453ff943b693383a38c358aeb4a81a9c5da25e](https://github.com/sagemath/sagetrac-mirror/commit/90453ff943b693383a38c358aeb4a81a9c5da25e)\" to \"[6b46fee72115db82a7eedb02482b83af694247ba](https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba)\".",
    "created_at": "2015-05-13T16:15:10Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[90453ff943b693383a38c358aeb4a81a9c5da25e](https://github.com/sagemath/sagetrac-mirror/commit/90453ff943b693383a38c358aeb4a81a9c5da25e)" to "[6b46fee72115db82a7eedb02482b83af694247ba](https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba)".



---

archive/issue_comments_255018.json:
```json
{
    "body": "<a id='comment:27'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba\">6b46fee</a></td><td><code>Trac #18358: typo + remove redundant doctest</code></td></tr></table>\n",
    "created_at": "2015-05-13T16:15:10Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255018",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba">6b46fee</a></td><td><code>Trac #18358: typo + remove redundant doctest</code></td></tr></table>




---

archive/issue_events_164872.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-13T16:15:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164872"
}
```



---

archive/issue_events_164873.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-05-13T16:15:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164873"
}
```



---

archive/issue_comments_255019.json:
```json
{
    "body": "<a id='comment:29'></a>\nI didn't run doctests again, but positive_review assuming that they pass.",
    "created_at": "2015-05-13T19:53:43Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255019",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
I didn't run doctests again, but positive_review assuming that they pass.



---

archive/issue_events_164874.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-13T19:53:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164874"
}
```



---

archive/issue_events_164875.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-13T19:53:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164875"
}
```



---

archive/issue_events_164876.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-14T22:40:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164876"
}
```



---

archive/issue_events_164877.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-14T22:40:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18358#event-164877"
}
```



---

archive/issue_comments_255020.json:
```json
{
    "body": "**Changing branch** from \"[u/vdelecroix/18358](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/18358)\" to \"[6b46fee72115db82a7eedb02482b83af694247ba](https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba)\".",
    "created_at": "2015-05-14T22:40:19Z",
    "issue": "https://github.com/sagemath/sage/issues/18358",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18358#issuecomment-255020",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/vdelecroix/18358](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/18358)" to "[6b46fee72115db82a7eedb02482b83af694247ba](https://github.com/sagemath/sagetrac-mirror/commit/6b46fee72115db82a7eedb02482b83af694247ba)".
