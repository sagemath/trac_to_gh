# Issue 18626: fix gap_packages (Guava) optional tests

archive/issues_018389.json:
```json
{
    "body": "in Sage 6.8.beta3 optional gap_packages tests fail in Guava;\nsee http://trac.sagemath.org/attachment/ticket/17390/gua\n\nThe 1st of errors I just reported on https://github.com/osj1961/guava/issues/1\n\nCC:  @vbraun @jdemeyer @nathanncohen @wdjoyner\n\nBranch/Commit: 80a75c242b6e705a6ea91c4ee05d30dff34a64b6\n\nUpstream: Fixed upstream, in a later stable release.\n\nReviewer: Nathann Cohen\n\nAuthor: Dima Pasechnik\n\nDependencies: #18689\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18626\n\n",
    "closed_at": "2015-06-30T12:57:56Z",
    "created_at": "2015-06-06T22:02:26Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "fix gap_packages (Guava) optional tests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18626",
    "user": "https://github.com/dimpase"
}
```
in Sage 6.8.beta3 optional gap_packages tests fail in Guava;
see http://trac.sagemath.org/attachment/ticket/17390/gua

The 1st of errors I just reported on https://github.com/osj1961/guava/issues/1

CC:  @vbraun @jdemeyer @nathanncohen @wdjoyner

Branch/Commit: 80a75c242b6e705a6ea91c4ee05d30dff34a64b6

Upstream: Fixed upstream, in a later stable release.

Reviewer: Nathann Cohen

Author: Dima Pasechnik

Dependencies: #18689

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18626





---

archive/issue_comments_265803.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2015-06-07T00:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265803",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_265804.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 dimpase]:\n> New commits:\n> |                                                                                                                                          |                                                     |\n> |------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|\n> |[4b17832](http://git.sagemath.org/sage.git/commit/?id=4b178327727c76d60f7423ecd3ce28c4bea8bdf7)|`don't compute MatrixAutomorphisms of empty matrices`|\n\n\nthis takes care of 2 out of 7 failures",
    "created_at": "2015-06-07T00:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265804",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>Replying to [comment:2 dimpase]:
> New commits:
> |                                                                                                                                          |                                                     |
> |------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|
> |[4b17832](http://git.sagemath.org/sage.git/commit/?id=4b178327727c76d60f7423ecd3ce28c4bea8bdf7)|`don't compute MatrixAutomorphisms of empty matrices`|


this takes care of 2 out of 7 failures



---

archive/issue_comments_265805.json:
```json
{
    "body": "Attachment [l.sage](tarball://root/attachments/some-uuid/ticket18626/l.sage) by @dimpase created at 2015-06-08 11:30:03\n\ngap/libgap discrepancy...",
    "created_at": "2015-06-08T11:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265805",
    "user": "https://github.com/dimpase"
}
```

Attachment [l.sage](tarball://root/attachments/some-uuid/ticket18626/l.sage) by @dimpase created at 2015-06-08 11:30:03

gap/libgap discrepancy...



---

archive/issue_comments_265806.json:
```json
{
    "body": "must be in the current working directory",
    "created_at": "2015-06-08T11:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265806",
    "user": "https://github.com/dimpase"
}
```

must be in the current working directory



---

archive/issue_comments_265807.json:
```json
{
    "body": "<a id='comment:4'></a>Attachment [libornotlib.g](tarball://root/attachments/some-uuid/ticket18626/libornotlib.g) by @dimpase created at 2015-06-08 11:36:39\n\nWith the fix I proposed here:\nhttps://github.com/osj1961/guava/pull/2\nI see a strange discrepancy between GAP and libGAP.\nNamely:\n* apply the patch from the pull request to `SAGELOCAL/gap/current/pkg/guava/lib`\n* download two attachments to somewhere; \n* start Sage in in there, and `load(\"l.sage\")`\n* watch `libgap` succeeding, and `gap` failing...\n\nWhat is going on, any clues?",
    "created_at": "2015-06-08T11:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265807",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>Attachment [libornotlib.g](tarball://root/attachments/some-uuid/ticket18626/libornotlib.g) by @dimpase created at 2015-06-08 11:36:39

With the fix I proposed here:
https://github.com/osj1961/guava/pull/2
I see a strange discrepancy between GAP and libGAP.
Namely:
* apply the patch from the pull request to `SAGELOCAL/gap/current/pkg/guava/lib`
* download two attachments to somewhere; 
* start Sage in in there, and `load("l.sage")`
* watch `libgap` succeeding, and `gap` failing...

What is going on, any clues?



---

archive/issue_comments_265808.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 dimpase]:\n\n> What is going on, any clues?\n\n\ncould it be pexpect acting up?",
    "created_at": "2015-06-08T11:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265808",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>Replying to [comment:4 dimpase]:

> What is going on, any clues?


could it be pexpect acting up?



---

archive/issue_comments_265809.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 dimpase]:\n> Replying to [comment:4 dimpase]:\n> \n> > What is going on, any clues?\n\n> \n> could it be pexpect acting up?\n\n\nOK, this was just a stale GAP workspace. They should be wiped up after `gap_packages` spkg is installed!",
    "created_at": "2015-06-08T12:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265809",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>Replying to [comment:5 dimpase]:
> Replying to [comment:4 dimpase]:
> 
> > What is going on, any clues?

> 
> could it be pexpect acting up?


OK, this was just a stale GAP workspace. They should be wiped up after `gap_packages` spkg is installed!



---

archive/issue_comments_265810.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-08T13:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265810",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265811.json:
```json
{
    "body": "<a id='comment:8'></a>The latter commit was not enough - also Guava C code needed a small fix, to accommodate very long tempfile names we get nowadays. This is the 2nd commit in https://github.com/osj1961/guava/pull/2\n\nwe can either make a new spkg with these fixes, or wait for upstream, hopefully they can be quick...",
    "created_at": "2015-06-08T15:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265811",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>The latter commit was not enough - also Guava C code needed a small fix, to accommodate very long tempfile names we get nowadays. This is the 2nd commit in https://github.com/osj1961/guava/pull/2

we can either make a new spkg with these fixes, or wait for upstream, hopefully they can be quick...



---

archive/issue_comments_265812.json:
```json
{
    "body": "<a id='comment:10'></a>By the way, are we replacing `os.system()` by `subprocess.call()`, or leave them?",
    "created_at": "2015-06-08T22:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265812",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>By the way, are we replacing `os.system()` by `subprocess.call()`, or leave them?



---

archive/issue_comments_265813.json:
```json
{
    "body": "<a id='comment:11'></a>IMHO you should always use subprocess.call over os.system, its such a no-braner. You want the Pythonic interface or do you want the bare posix wrapper?",
    "created_at": "2015-06-09T07:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265813",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>IMHO you should always use subprocess.call over os.system, its such a no-braner. You want the Pythonic interface or do you want the bare posix wrapper?



---

archive/issue_comments_265814.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 vbraun]:\n> IMHO you should always use subprocess.call over os.system, its such a no-braner. You want the Pythonic interface or do you want the bare posix wrapper?\n\n\nit's  about old Sage code that uses `os.system()`. While I am at it I can do a fly-by patch...",
    "created_at": "2015-06-09T07:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265814",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>Replying to [comment:11 vbraun]:
> IMHO you should always use subprocess.call over os.system, its such a no-braner. You want the Pythonic interface or do you want the bare posix wrapper?


it's  about old Sage code that uses `os.system()`. While I am at it I can do a fly-by patch...



---

archive/issue_comments_265815.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-06-09T13:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265815",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_265816.json:
```json
{
    "body": "<a id='comment:14'></a>You don't really need to create a temporary file just to redirect output to, you can use `subprocess.check_output()` which is exactly meant for this use-case (unless the subprocess really doesn't work with a piped stdout, but that's unlikely).",
    "created_at": "2015-06-09T13:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265816",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>You don't really need to create a temporary file just to redirect output to, you can use `subprocess.check_output()` which is exactly meant for this use-case (unless the subprocess really doesn't work with a piped stdout, but that's unlikely).



---

archive/issue_comments_265817.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-10T09:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265817",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265818.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-18T22:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265818",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265819.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-06-18T23:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265819",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_265820.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-18T23:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265820",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_265821.json:
```json
{
    "body": "<a id='comment:19'></a>with the gap 4.7.8 (see #18689), all tests pass!",
    "created_at": "2015-06-18T23:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265821",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>with the gap 4.7.8 (see #18689), all tests pass!



---

archive/issue_comments_265822.json:
```json
{
    "body": "<a id='comment:20'></a>Hello Dima,\n\nIn this patch you add a block of code with is indented with 3 spaces instead of 4, right before a block of code with a 4-spaces indentation. So you have a 'if' inside of a loop, just because of 1 space. The code seems to behave as intended.\n\nThis being said, wouldn't it be better to *not* move this big block of code, and just add this?\n\n```\nif gap(\"Length(matCwt)\") <= 0: \n    continue\n```\n\nNathann",
    "created_at": "2015-06-28T18:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265822",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:20'></a>Hello Dima,

In this patch you add a block of code with is indented with 3 spaces instead of 4, right before a block of code with a 4-spaces indentation. So you have a 'if' inside of a loop, just because of 1 space. The code seems to behave as intended.

This being said, wouldn't it be better to *not* move this big block of code, and just add this?

```
if gap("Length(matCwt)") <= 0: 
    continue
```

Nathann



---

archive/issue_comments_265823.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 ncohen]:\n> Hello Dima,\n> \n> In this patch you add a block of code with is indented with 3 spaces instead of 4, right before a block of code with a 4-spaces indentation. So you have a 'if' inside of a loop, just because of 1 space. The code seems to behave as intended.\n> \n\nok, I'll fix this.\n\n> This being said, wouldn't it be better to *not* move this big block of code, and just add this?\n> \n> ```\n> if gap(\"Length(matCwt)\") <= 0: \n>     continue\n> ```\n\n\nIMHO, `continue` is even less readable than `goto`...",
    "created_at": "2015-06-28T19:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265823",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>Replying to [comment:20 ncohen]:
> Hello Dima,
> 
> In this patch you add a block of code with is indented with 3 spaces instead of 4, right before a block of code with a 4-spaces indentation. So you have a 'if' inside of a loop, just because of 1 space. The code seems to behave as intended.
> 

ok, I'll fix this.

> This being said, wouldn't it be better to *not* move this big block of code, and just add this?
> 
> ```
> if gap("Length(matCwt)") <= 0: 
>     continue
> ```


IMHO, `continue` is even less readable than `goto`...



---

archive/issue_comments_265824.json:
```json
{
    "body": "<a id='comment:22'></a>> IMHO, `continue` is even less readable than `goto`...\n\n\nWith a 'continue' you do not have to change the indentation of 10 lines of code only because you want to make an assumption.\n\nAnd I will start minding 'continue' the day Python will be compiled. A language that stores classes methods in a *dictionary* does not deserve this kind of respect.\n\nNathann",
    "created_at": "2015-06-28T19:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265824",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:22'></a>> IMHO, `continue` is even less readable than `goto`...


With a 'continue' you do not have to change the indentation of 10 lines of code only because you want to make an assumption.

And I will start minding 'continue' the day Python will be compiled. A language that stores classes methods in a *dictionary* does not deserve this kind of respect.

Nathann



---

archive/issue_comments_265825.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 ncohen]:\n> > IMHO, `continue` is even less readable than `goto`...\n\n> \n> With a 'continue' you do not have to change the indentation of 10 lines of code only because you want to make an assumption.\n\n\nwell, but it results in unreadable crap. Given that this loop already has a number of `break`s,\nin particular.\n\n> \n> And I will start minding 'continue' the day Python will be compiled. A language that stores classes methods in a *dictionary* does not deserve this kind of respect.\n\n\nLanguage, perhaps. But the mere mortals who need to read the code?",
    "created_at": "2015-06-28T19:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265825",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>Replying to [comment:22 ncohen]:
> > IMHO, `continue` is even less readable than `goto`...

> 
> With a 'continue' you do not have to change the indentation of 10 lines of code only because you want to make an assumption.


well, but it results in unreadable crap. Given that this loop already has a number of `break`s,
in particular.

> 
> And I will start minding 'continue' the day Python will be compiled. A language that stores classes methods in a *dictionary* does not deserve this kind of respect.


Language, perhaps. But the mere mortals who need to read the code?



---

archive/issue_comments_265826.json:
```json
{
    "body": "<a id='comment:25'></a>just checked that the rebased version (in public/18626) works, long tests pass.",
    "created_at": "2015-06-28T23:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265826",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>just checked that the rebased version (in public/18626) works, long tests pass.



---

archive/issue_comments_265827.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-29T10:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265827",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265828.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-06-29T10:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265828",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_265829.json:
```json
{
    "body": "<a id='comment:28'></a>Sorry for the mess! I pushed to much by mistake... It should be fixed now: I added a commit which changes the formatting of a broken internet doctest. If it's good for you, you can update the ticket's status.\n\nNathann",
    "created_at": "2015-06-29T10:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265829",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:28'></a>Sorry for the mess! I pushed to much by mistake... It should be fixed now: I added a commit which changes the formatting of a broken internet doctest. If it's good for you, you can update the ticket's status.

Nathann



---

archive/issue_comments_265830.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-29T11:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265830",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_052260.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-30T12:57:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18626#event-52260"
}
```



---

archive/issue_comments_265831.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-30T12:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18626#issuecomment-265831",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
