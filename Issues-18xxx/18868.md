# Issue 18868: a MemoryAllocator object for easier Cython memory management

archive/issues_018631.json:
```json
{
    "assignees": [],
    "body": "This is a re-implementation of an example appearing in Cython's documentation (see bottom of [1]).\n\nThe idea is simple: an object has a `.malloc` method, and returns arrays of memory. When that object is garbage-collected, the memory it allocated is automatically freed.\n\nThis makes it much easier to deal with C pointers in Cython code, which must be freed before any 'return' and whenever an exception can be raised.\n\nAs an illustration of how useful this can be, I removed a *lot* of graph code.\n\nNathann\n\n[1] http://docs.cython.org/src/tutorial/memory_allocation.html\n\nDepends on #18864\n\nCC:  @dimpase @sagetrac-borassi @dcoudert @vbraun @jdemeyer @simon-king-jena\n\nComponent: **cython**\n\nAuthor: **Nathann Cohen, Jeroen Demeyer**\n\nBranch/Commit: **[`0304d9f`](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**\n\nReviewer: **Jeroen Demeyer, Volker Braun**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18868_\n\n",
    "closed_at": "2015-07-28T22:47:06Z",
    "created_at": "2015-07-08T10:00:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20cython",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "a MemoryAllocator object for easier Cython memory management",
    "type": "issue",
    "updated_at": "2015-07-28T22:47:06Z",
    "url": "https://github.com/sagemath/sage/issues/18868",
    "user": "https://github.com/nathanncohen"
}
```
This is a re-implementation of an example appearing in Cython's documentation (see bottom of [1]).

The idea is simple: an object has a `.malloc` method, and returns arrays of memory. When that object is garbage-collected, the memory it allocated is automatically freed.

This makes it much easier to deal with C pointers in Cython code, which must be freed before any 'return' and whenever an exception can be raised.

As an illustration of how useful this can be, I removed a *lot* of graph code.

Nathann

[1] http://docs.cython.org/src/tutorial/memory_allocation.html

Depends on #18864

CC:  @dimpase @sagetrac-borassi @dcoudert @vbraun @jdemeyer @simon-king-jena

Component: **cython**

Author: **Nathann Cohen, Jeroen Demeyer**

Branch/Commit: **[`0304d9f`](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**

Reviewer: **Jeroen Demeyer, Volker Braun**

_Issue created by migration from https://trac.sagemath.org/ticket/18868_





---

archive/issue_events_265498.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "milestone_number": null,
    "milestone_title": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265498"
}
```



---

archive/issue_events_265499.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20cython",
    "label_color": "0000b0",
    "label_name": "c: cython",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265499"
}
```



---

archive/issue_events_265500.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265500"
}
```



---

archive/issue_events_265501.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265501"
}
```



---

archive/issue_comments_264150.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf\"><code>2723175</code></a></td><td><code>trac #18868: a MemoryAllocator object for easier Cython memory management</code></td></tr></table>\n",
    "created_at": "2015-07-08T10:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264150",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf"><code>2723175</code></a></td><td><code>trac #18868: a MemoryAllocator object for easier Cython memory management</code></td></tr></table>




---

archive/issue_comments_264151.json:
```json
{
    "body": "Commit: **[`2723175`](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)**",
    "created_at": "2015-07-08T10:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264151",
    "user": "https://github.com/nathanncohen"
}
```

Commit: **[`2723175`](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)**



---

archive/issue_events_265502.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:01:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265502"
}
```



---

archive/issue_comments_264152.json:
```json
{
    "body": "Branch: **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)**",
    "created_at": "2015-07-08T10:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264152",
    "user": "https://github.com/nathanncohen"
}
```

Branch: **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)**



---

archive/issue_comments_264153.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThis\n\n```\ninclude 'sage/ext/interrupt.pxi'\n```\nshould be in the `.pyx` file.",
    "created_at": "2015-07-08T10:06:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264153",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

This

```
include 'sage/ext/interrupt.pxi'
```
should be in the `.pyx` file.



---

archive/issue_events_265503.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T10:06:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265503"
}
```



---

archive/issue_events_265504.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T10:06:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265504"
}
```



---

archive/issue_comments_264154.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nFor performance, replace\n\n```\ncdef MemoryAllocator mem = MemoryAllocator()\n```\nby\n\n```\ncdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)\n```",
    "created_at": "2015-07-08T10:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264154",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

For performance, replace

```
cdef MemoryAllocator mem = MemoryAllocator()
```
by

```
cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)
```



---

archive/issue_comments_264155.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nCan you please support all memory-allocation functions, like `calloc`, `realloc`, `(re)allocarray` and replace the dangerous(*) calls like\n\n```\nmem.malloc( n * sizeof(unsigned short *))\n```\nby\n\n```\nmem.allocarray(n, sizeof(unsigned short *))\n```\n\n(*) the multiplication can overflow.",
    "created_at": "2015-07-08T10:12:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264155",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Can you please support all memory-allocation functions, like `calloc`, `realloc`, `(re)allocarray` and replace the dangerous(*) calls like

```
mem.malloc( n * sizeof(unsigned short *))
```
by

```
mem.allocarray(n, sizeof(unsigned short *))
```

(*) the multiplication can overflow.



---

archive/issue_comments_264156.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAlso for performance: keep `calloc`, do not replace it with `malloc + memset`.",
    "created_at": "2015-07-08T10:14:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264156",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Also for performance: keep `calloc`, do not replace it with `malloc + memset`.



---

archive/issue_comments_264157.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI guess that `realloc(array)` might not be so easy to support, so you can forget about that. But I would certainly support `allocarray` and `calloc`.\n\nAnd I don't understand why you use\n\n```\ncdef void * val = malloc(size)\nif val == NULL:\n    raise MemoryError()\n```\ninstead of\n\n```\ncdef void * val = check_malloc(size)\n```",
    "created_at": "2015-07-08T10:18:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264157",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

I guess that `realloc(array)` might not be so easy to support, so you can forget about that. But I would certainly support `allocarray` and `calloc`.

And I don't understand why you use

```
cdef void * val = malloc(size)
if val == NULL:
    raise MemoryError()
```
instead of

```
cdef void * val = check_malloc(size)
```



---

archive/issue_comments_264158.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\n[1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions. Why do you \nstick with `malloc` etc?",
    "created_at": "2015-07-08T10:25:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264158",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">comment:7</div>

[1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions. Why do you 
stick with `malloc` etc?



---

archive/issue_comments_264159.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nMore about performance: note that your use of `MemoryAllocator` needs at least 2 extra memory allocation calls compared to not using `MemoryAllocator`: one to allocate the `MemoryAllocator` object and one to allocate the `pointers` member. If you allocate several pointers, it's worse because you again need more additional `realloc()` calls for `pointers.`\n\nTo solve some of these problems, I propose the following: add a small fixed array\n\n```\ncdef void* local_pointers[16]\n```\nin the `MemoryAllocator` class and initialize\n\n```\nself.max_size = 16\nself.pointers = self.local_pointers\n```\nsuch that you avoid any allocations for `pointers` if you need to store at most 16 pointers (which is the usual case I guess).",
    "created_at": "2015-07-08T10:26:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264159",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

More about performance: note that your use of `MemoryAllocator` needs at least 2 extra memory allocation calls compared to not using `MemoryAllocator`: one to allocate the `MemoryAllocator` object and one to allocate the `pointers` member. If you allocate several pointers, it's worse because you again need more additional `realloc()` calls for `pointers.`

To solve some of these problems, I propose the following: add a small fixed array

```
cdef void* local_pointers[16]
```
in the `MemoryAllocator` class and initialize

```
self.max_size = 16
self.pointers = self.local_pointers
```
such that you avoid any allocations for `pointers` if you need to store at most 16 pointers (which is the usual case I guess).



---

archive/issue_comments_264160.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@dimpase](#comment%3A7):\n> Why do you stick with `malloc` etc?\n\nIn Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!",
    "created_at": "2015-07-08T10:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264160",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@dimpase](#comment%3A7):
> Why do you stick with `malloc` etc?

In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!



---

archive/issue_comments_264161.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nMore for performance: replace\n\n```\ncdef enlarge_if_needed(self):\n```\nby\n\n```\ncdef int enlarge_if_needed(self) except -1:\n```",
    "created_at": "2015-07-08T10:28:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264161",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

More for performance: replace

```
cdef enlarge_if_needed(self):
```
by

```
cdef int enlarge_if_needed(self) except -1:
```



---

archive/issue_comments_264162.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOne more detail: replace\n\n```\ncdef int n\ncdef int max_size\n```\nby\n\n```\ncdef size_t n\ncdef size_t max_size\n```\n(and adjust the loop index in `__dealloc__`) in case I ever need more than 2<sup>31</sup> pointers :-)",
    "created_at": "2015-07-08T10:33:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264162",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

One more detail: replace

```
cdef int n
cdef int max_size
```
by

```
cdef size_t n
cdef size_t max_size
```
(and adjust the loop index in `__dealloc__`) in case I ever need more than 2<sup>31</sup> pointers :-)



---

archive/issue_comments_264163.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment%3A9):\n> Replying to [@dimpase](#comment%3A7):\n> > Why do you stick with `malloc` etc?\n\n> In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!\n\nAnd why does `sage_malloc` use `malloc`, and not `PyMem_Malloc`?",
    "created_at": "2015-07-08T11:24:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264163",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment%3A9):
> Replying to [@dimpase](#comment%3A7):
> > Why do you stick with `malloc` etc?

> In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!

And why does `sage_malloc` use `malloc`, and not `PyMem_Malloc`?



---

archive/issue_comments_264164.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf39672b9547f32ec01e261e7541f22429bee5b7\"><code>bf39672</code></a></td><td><code>trac #18868: back to calloc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13\"><code>9597eec</code></a></td><td><code>trac #18868: Changes to MemoryAllocator</code></td></tr></table>\n",
    "created_at": "2015-07-08T11:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264164",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf39672b9547f32ec01e261e7541f22429bee5b7"><code>bf39672</code></a></td><td><code>trac #18868: back to calloc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13"><code>9597eec</code></a></td><td><code>trac #18868: Changes to MemoryAllocator</code></td></tr></table>




---

archive/issue_comments_264165.json:
```json
{
    "body": "Changed commit from **[`2723175`](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)** to **[`9597eec`](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)**",
    "created_at": "2015-07-08T11:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264165",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2723175`](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)** to **[`9597eec`](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)**



---

archive/issue_events_265505.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T11:36:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265505"
}
```



---

archive/issue_events_265506.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T11:36:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265506"
}
```



---

archive/issue_comments_264166.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\n> This `include 'sage/ext/interrupt.pxi'` should be in the .pyx file.\n\nDone\n\n> For performance, replace \n> `cdef MemoryAllocator mem = MemoryAllocator()`\n> by\n> `cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)`\n\nMakes no difference in any of the functions I touched, so I did not do it. Less\nreadable.\n\n> Can you please support all memory-allocation functions, like calloc, realloc,\n> (re)allocarray and replace the dangerous(*) calls like\n\nI added support for calloc. I do not need realloc (you can add a commit if you\nneed it).\n\nAbout realloc:\n\n> I guess that realloc(array) might not be so easy to support, so you can forget\n> about that.\n\n+1\n\n> But I would certainly support allocarray\n\nAdd a commit if you like. My problem with 'allocarray' is that it is Sage's\nterminology (as far as I know), and that I prefer to stick to more widely\nunderstood terms like 'malloc/calloc'. I was just saying to David that we may\neventually move some C graph code away from sage and make it an independent C\nlibrary.\n\n> And I don't understand why you use\n\n>\n> ```\n> cdef void * val = malloc(size)\n> if val == NULL:\n>     raise MemoryError()\n> ```\n> instead of\n>\n> ```\n> cdef void * val = check_malloc(size)\n> ```\n\nDone\n\n> [1] recommends PyMem_Malloc, PyMem_Realloc, PyMem_Free over the system\n> functions. Why do you stick with malloc etc?\n\nPersonally, for a simple reason: I trust C functions. Officially, it is for the\nreason Jeroen mentionned. Note that we can satisfy everybody: it is possible to\nhave `sage_malloc` (which behaves properly with respect to interrupts) call your\nfunctions instead of C ones.\n\n> More about performance: note that your use of MemoryAllocator needs at least 2\n> extra memory allocation calls compared to not using MemoryAllocator\n\nThis is not a problem for the codes I touched, for malloc is never a dominant\ncost in any of them. You can add a commit if you like, though please keep the\ncode simple and understandable if you do.\n\n> More for performance: replace\n> `cdef enlarge_if_needed(self):`\n> by\n> `cdef int enlarge_if_needed(self) except -1:`\n\nDone.\n\n> One more detail: replace `int` with `size_t`\n\nDone.\n\nJeroen, could you send reviews as one big comment rather than adding one every\ntime you notice something? Everybody in Cc receives an email for each comments,\nand it is also a bit harder to address your points:\n\n- One never knows if you are done reading the code or if we can expect a new\n  comment in the next seconds\n\n- Answering your points like I do now is a bit harder: instead of clicking on\n  'reply' (to your comment), I copy/paste all your individual messages into a\n  text file, then start answering them.\n\nThaaaaaaaaanks,\n\nNathann",
    "created_at": "2015-07-08T11:36:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264166",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:15" align="right">comment:15</div>

> This `include 'sage/ext/interrupt.pxi'` should be in the .pyx file.

Done

> For performance, replace 
> `cdef MemoryAllocator mem = MemoryAllocator()`
> by
> `cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)`

Makes no difference in any of the functions I touched, so I did not do it. Less
readable.

> Can you please support all memory-allocation functions, like calloc, realloc,
> (re)allocarray and replace the dangerous(*) calls like

I added support for calloc. I do not need realloc (you can add a commit if you
need it).

About realloc:

> I guess that realloc(array) might not be so easy to support, so you can forget
> about that.

+1

> But I would certainly support allocarray

Add a commit if you like. My problem with 'allocarray' is that it is Sage's
terminology (as far as I know), and that I prefer to stick to more widely
understood terms like 'malloc/calloc'. I was just saying to David that we may
eventually move some C graph code away from sage and make it an independent C
library.

> And I don't understand why you use

>
> ```
> cdef void * val = malloc(size)
> if val == NULL:
>     raise MemoryError()
> ```
> instead of
>
> ```
> cdef void * val = check_malloc(size)
> ```

Done

> [1] recommends PyMem_Malloc, PyMem_Realloc, PyMem_Free over the system
> functions. Why do you stick with malloc etc?

Personally, for a simple reason: I trust C functions. Officially, it is for the
reason Jeroen mentionned. Note that we can satisfy everybody: it is possible to
have `sage_malloc` (which behaves properly with respect to interrupts) call your
functions instead of C ones.

> More about performance: note that your use of MemoryAllocator needs at least 2
> extra memory allocation calls compared to not using MemoryAllocator

This is not a problem for the codes I touched, for malloc is never a dominant
cost in any of them. You can add a commit if you like, though please keep the
code simple and understandable if you do.

> More for performance: replace
> `cdef enlarge_if_needed(self):`
> by
> `cdef int enlarge_if_needed(self) except -1:`

Done.

> One more detail: replace `int` with `size_t`

Done.

Jeroen, could you send reviews as one big comment rather than adding one every
time you notice something? Everybody in Cc receives an email for each comments,
and it is also a bit harder to address your points:

- One never knows if you are done reading the code or if we can expect a new
  comment in the next seconds

- Answering your points like I do now is a bit harder: instead of clicking on
  'reply' (to your comment), I copy/paste all your individual messages into a
  text file, then start answering them.

Thaaaaaaaaanks,

Nathann



---

archive/issue_comments_264167.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@dimpase](#comment%3A7):\n> [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.\n\nWhat is [1]?",
    "created_at": "2015-07-08T11:58:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264167",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@dimpase](#comment%3A7):
> [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.

What is [1]?



---

archive/issue_comments_264168.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@nathanncohen](#comment%3A15):\n> My problem with 'allocarray' is that it is Sage's terminology (as far as I know)\n\nIt actually comes from BSD, where it was added for security reasons (like I said, the multiplication in `malloc(n * sizeof(foo))` can overflow, a potential security issue). For Sage, it's not so much the \"security\" aspect which is important, but the reliability.",
    "created_at": "2015-07-08T12:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264168",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@nathanncohen](#comment%3A15):
> My problem with 'allocarray' is that it is Sage's terminology (as far as I know)

It actually comes from BSD, where it was added for security reasons (like I said, the multiplication in `malloc(n * sizeof(foo))` can overflow, a potential security issue). For Sage, it's not so much the "security" aspect which is important, but the reliability.



---

archive/issue_events_265507.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T12:06:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265507"
}
```



---

archive/issue_events_265508.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T12:06:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265508"
}
```



---

archive/issue_comments_264169.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@nathanncohen](#comment%3A15):\n> You can add a commit if you like, though please keep the\n> code simple and understandable if you do.\n\nI thought that speed was an important reason to invent this new class. If you don't care so much about speed, there are several already-existing alternatives, such as [Cython arrays](http://docs.cython.org/src/userguide/memoryviews.html#cython-arrays).\n\nIf speed is not so much a concern, then why are you reinventing the wheel?",
    "created_at": "2015-07-08T12:06:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264169",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@nathanncohen](#comment%3A15):
> You can add a commit if you like, though please keep the
> code simple and understandable if you do.

I thought that speed was an important reason to invent this new class. If you don't care so much about speed, there are several already-existing alternatives, such as [Cython arrays](http://docs.cython.org/src/userguide/memoryviews.html#cython-arrays).

If speed is not so much a concern, then why are you reinventing the wheel?



---

archive/issue_events_265509.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T12:09:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265509"
}
```



---

archive/issue_events_265510.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T12:09:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265510"
}
```



---

archive/issue_comments_264170.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\n> I thought that speed was an important reason to invent this new class.\n\nI care about the speed of the algorithm themselves. I need real C arrays. The time it takes to allocate them is not a problem in the graph code.\n\nNathann",
    "created_at": "2015-07-08T12:09:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264170",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:19" align="right">comment:19</div>

> I thought that speed was an important reason to invent this new class.

I care about the speed of the algorithm themselves. I need real C arrays. The time it takes to allocate them is not a problem in the graph code.

Nathann



---

archive/issue_comments_264171.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@nathanncohen](#comment%3A15):\n> Makes no difference in any of the functions I touched, so I did not do it. Less\n> readable.\n\nYou are right. I was confused with *explicit* calls to `__init__` (i.e. `foo.__init__()` should be avoided in Cython).",
    "created_at": "2015-07-08T12:19:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264171",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@nathanncohen](#comment%3A15):
> Makes no difference in any of the functions I touched, so I did not do it. Less
> readable.

You are right. I was confused with *explicit* calls to `__init__` (i.e. `foo.__init__()` should be avoided in Cython).



---

archive/issue_comments_264172.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@jdemeyer](#comment%3A16):\n> Replying to [@dimpase](#comment%3A7):\n> > [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.\n\n> \n> What is [1]?\n\nsee the ticket description",
    "created_at": "2015-07-08T12:22:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264172",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@jdemeyer](#comment%3A16):
> Replying to [@dimpase](#comment%3A7):
> > [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.

> 
> What is [1]?

see the ticket description



---

archive/issue_comments_264173.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI wonder whether there are ways to avoid syntactic clutter such as\n\n```\ncdef uint32_t * _connected_structure = <uint32_t *> mem.calloc(n * n , sizeof(uint32_t))\n```\nYou know, in C such thing would be best written as macro call like\n\n```\nnewdef(_connected_structure, uint32_t, n*n)\n```\navoiding mentioning `uint32_t` three times...",
    "created_at": "2015-07-08T12:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264173",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:22" align="right">comment:22</div>

I wonder whether there are ways to avoid syntactic clutter such as

```
cdef uint32_t * _connected_structure = <uint32_t *> mem.calloc(n * n , sizeof(uint32_t))
```
You know, in C such thing would be best written as macro call like

```
newdef(_connected_structure, uint32_t, n*n)
```
avoiding mentioning `uint32_t` three times...



---

archive/issue_comments_264174.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\n> I wonder whether there are ways to avoid syntactic clutter such as\n\n+1 `:-/`\n\nNathann",
    "created_at": "2015-07-08T12:38:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264174",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:23" align="right">comment:23</div>

> I wonder whether there are ways to avoid syntactic clutter such as

+1 `:-/`

Nathann



---

archive/issue_comments_264175.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@nathanncohen](#comment%3A19):\n> I need real C arrays. The time it takes to allocate them is not a problem in the graph code.\n\nOK, here is a deal: if you really mean what you say (that you don't care about the time to allocate, just the access time), then I'm pretty sure that your problem can be solved with Cython arrays. A memoryview like `cdef int[::1]` should be as fast as a C pointer.",
    "created_at": "2015-07-08T12:49:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264175",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@nathanncohen](#comment%3A19):
> I need real C arrays. The time it takes to allocate them is not a problem in the graph code.

OK, here is a deal: if you really mean what you say (that you don't care about the time to allocate, just the access time), then I'm pretty sure that your problem can be solved with Cython arrays. A memoryview like `cdef int[::1]` should be as fast as a C pointer.



---

archive/issue_comments_264176.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n> A memoryview like `cdef int[::1]` should be as fast as a C pointer.\n\nIf your 'should' is a 'is', and if you do not need to replace each pointer allocation by 1) creationg of a Cython object 2) Linking it to the C array then yes. Can you give an example of that? I read your link toward 'Cython arrays' and it seems to have this drawback, i.e. 2 lines per allocation.\n\nNathann",
    "created_at": "2015-07-08T12:53:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264176",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:25" align="right">comment:25</div>

> A memoryview like `cdef int[::1]` should be as fast as a C pointer.

If your 'should' is a 'is', and if you do not need to replace each pointer allocation by 1) creationg of a Cython object 2) Linking it to the C array then yes. Can you give an example of that? I read your link toward 'Cython arrays' and it seems to have this drawback, i.e. 2 lines per allocation.

Nathann



---

archive/issue_comments_264177.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@nathanncohen](#comment%3A25):\n> Can you give an example of that?\n\nA created a new ticket #18870 to discuss it.",
    "created_at": "2015-07-08T13:01:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264177",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@nathanncohen](#comment%3A25):
> Can you give an example of that?

A created a new ticket #18870 to discuss it.



---

archive/issue_comments_264178.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI looked into #18870 and personally, I don't like it.",
    "created_at": "2015-07-08T13:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264178",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

I looked into #18870 and personally, I don't like it.



---

archive/issue_comments_264179.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nWhy wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?",
    "created_at": "2015-07-08T13:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264179",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:28" align="right">comment:28</div>

Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?



---

archive/issue_comments_264180.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@nathanncohen](#comment%3A28):\n> Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?\n\nsure, why not; also, how about asking them about comment [23](https://github.com/sagemath/sage/issues/18868#comment:23) ?",
    "created_at": "2015-07-08T13:58:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264180",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@nathanncohen](#comment%3A28):
> Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?

sure, why not; also, how about asking them about comment [23](https://github.com/sagemath/sage/issues/18868#comment:23) ?



---

archive/issue_comments_264181.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f\"><code>f514301</code></a></td><td><code>Optimize MemoryAllocator and add allocarray()</code></td></tr></table>\n",
    "created_at": "2015-07-08T15:46:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264181",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f"><code>f514301</code></a></td><td><code>Optimize MemoryAllocator and add allocarray()</code></td></tr></table>




---

archive/issue_comments_264182.json:
```json
{
    "body": "Changed commit from **[`9597eec`](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)** to **[`f514301`](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)**",
    "created_at": "2015-07-08T15:46:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264182",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9597eec`](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)** to **[`f514301`](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)**



---

archive/issue_comments_264183.json:
```json
{
    "body": "<div id=\"comment:31\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37\"><code>39f8839</code></a></td><td><code>Fix exception handling</code></td></tr></table>\n",
    "created_at": "2015-07-08T18:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264183",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37"><code>39f8839</code></a></td><td><code>Fix exception handling</code></td></tr></table>




---

archive/issue_comments_264184.json:
```json
{
    "body": "Changed commit from **[`f514301`](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)** to **[`39f8839`](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)**",
    "created_at": "2015-07-08T18:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264184",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f514301`](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)** to **[`39f8839`](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)**



---

archive/issue_comments_264185.json:
```json
{
    "body": "Changed author from **Nathann Cohen** to **Nathann Cohen, Jeroen Demeyer**",
    "created_at": "2015-07-08T18:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264185",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Nathann Cohen** to **Nathann Cohen, Jeroen Demeyer**



---

archive/issue_comments_264186.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2015-07-08T18:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264186",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_264187.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThis is ok for me, but someone needs to review my changes.",
    "created_at": "2015-07-08T18:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264187",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:32" align="right">comment:32</div>

This is ok for me, but someone needs to review my changes.



---

archive/issue_comments_264188.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nstill, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?\n\nApart from performance, there could be advantages in sense of debugging, as one can \n`./configure` Python with `--with-pydebug` to catch memory errors...",
    "created_at": "2015-07-09T10:42:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264188",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:33" align="right">comment:33</div>

still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?

Apart from performance, there could be advantages in sense of debugging, as one can 
`./configure` Python with `--with-pydebug` to catch memory errors...



---

archive/issue_comments_264189.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@dimpase](#comment%3A33):\n> still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?\n\nIn any case, that's independent of this ticket.\n\nSecond, `sage_malloc()` can be called without the GIL. I guess `PyMem_Malloc` cannot...",
    "created_at": "2015-07-09T11:11:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264189",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@dimpase](#comment%3A33):
> still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?

In any case, that's independent of this ticket.

Second, `sage_malloc()` can be called without the GIL. I guess `PyMem_Malloc` cannot...



---

archive/issue_comments_264190.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nThird, Python's memory allocator does not support `calloc()` or `allocarray()`, two very useful functions.\n\nAnd if you're speaking about performance, recall that `malloc()` + `memset()` is slower than `calloc()`.",
    "created_at": "2015-07-09T11:18:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264190",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

Third, Python's memory allocator does not support `calloc()` or `allocarray()`, two very useful functions.

And if you're speaking about performance, recall that `malloc()` + `memset()` is slower than `calloc()`.



---

archive/issue_comments_264191.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nCan somebody review this please?",
    "created_at": "2015-07-17T10:33:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264191",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">comment:36</div>

Can somebody review this please?



---

archive/issue_events_265511.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-17T11:20:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265511"
}
```



---

archive/issue_events_265512.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-17T11:20:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265512"
}
```



---

archive/issue_comments_264192.json:
```json
{
    "body": "Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**",
    "created_at": "2015-07-17T11:22:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264192",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**



---

archive/issue_comments_264193.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nYour were faster than me.\nI can at least confirm that all long tests pass on `src/sage/graphs/`.\nDavid.",
    "created_at": "2015-07-17T11:23:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264193",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:39" align="right">comment:39</div>

Your were faster than me.
I can at least confirm that all long tests pass on `src/sage/graphs/`.
David.



---

archive/issue_comments_264194.json:
```json
{
    "body": "Changed commit from **[`39f8839`](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)** to **[`0304d9f`](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**",
    "created_at": "2015-07-24T09:40:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264194",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`39f8839`](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)** to **[`0304d9f`](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**



---

archive/issue_comments_264195.json:
```json
{
    "body": "<div id=\"comment:40\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da7bad709841e6d77dc089524178011f35ee931e\"><code>da7bad7</code></a></td><td><code>trac #18864: Merged with 6.8.beta8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da0260dca9b43d96b47bcae2ba79a2b8819896ec\"><code>da0260d</code></a></td><td><code>trac #18864: prevent using the Takes-Kosters algorithm on digraphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/554c5099f8b47cef74a13cd968223c9288264424\"><code>554c509</code></a></td><td><code>trac #18864: implement reviewer's comments</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f48a33e012a0187ceea3b3011909342dc5cb1375\"><code>f48a33e</code></a></td><td><code>trac #18864: minor corrections</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a3717b73c811ff702345a186b679df4b99e725fa\"><code>a3717b7</code></a></td><td><code>trac #18864: improve behavior with directed graphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f621777db49299ce66bf8663795ad79453d4e43e\"><code>f621777</code></a></td><td><code>trac #18864: corrections and improved doc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80cb89935d8eb8288d6659d7c73d8c05ee1c9411\"><code>80cb899</code></a></td><td><code>trac #18864: correct version</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce9d26556e5b1a69002e1a5165933e51ddfc7c05\"><code>ce9d265</code></a></td><td><code>trac #18864: return Sage integers</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a1b36dafbf11d7f72f8568c51af6fba7003ca096\"><code>a1b36da</code></a></td><td><code>trac #18864: Merged with 6.8.rc1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5\"><code>0304d9f</code></a></td><td><code>trac #18868: Merged with #18864</code></td></tr></table>\n",
    "created_at": "2015-07-24T09:40:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264195",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:40"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da7bad709841e6d77dc089524178011f35ee931e"><code>da7bad7</code></a></td><td><code>trac #18864: Merged with 6.8.beta8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da0260dca9b43d96b47bcae2ba79a2b8819896ec"><code>da0260d</code></a></td><td><code>trac #18864: prevent using the Takes-Kosters algorithm on digraphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/554c5099f8b47cef74a13cd968223c9288264424"><code>554c509</code></a></td><td><code>trac #18864: implement reviewer's comments</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f48a33e012a0187ceea3b3011909342dc5cb1375"><code>f48a33e</code></a></td><td><code>trac #18864: minor corrections</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a3717b73c811ff702345a186b679df4b99e725fa"><code>a3717b7</code></a></td><td><code>trac #18864: improve behavior with directed graphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f621777db49299ce66bf8663795ad79453d4e43e"><code>f621777</code></a></td><td><code>trac #18864: corrections and improved doc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80cb89935d8eb8288d6659d7c73d8c05ee1c9411"><code>80cb899</code></a></td><td><code>trac #18864: correct version</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce9d26556e5b1a69002e1a5165933e51ddfc7c05"><code>ce9d265</code></a></td><td><code>trac #18864: return Sage integers</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a1b36dafbf11d7f72f8568c51af6fba7003ca096"><code>a1b36da</code></a></td><td><code>trac #18864: Merged with 6.8.rc1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5"><code>0304d9f</code></a></td><td><code>trac #18868: Merged with #18864</code></td></tr></table>




---

archive/issue_events_265513.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2015-07-24T09:40:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265513"
}
```



---

archive/issue_events_265514.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2015-07-24T09:40:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265514"
}
```



---

archive/issue_events_265515.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-24T09:41:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265515"
}
```



---

archive/issue_events_265516.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-24T09:41:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265516"
}
```



---

archive/issue_comments_264196.json:
```json
{
    "body": "Dependencies: **#18864**",
    "created_at": "2015-07-24T09:41:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264196",
    "user": "https://github.com/nathanncohen"
}
```

Dependencies: **#18864**



---

archive/issue_events_265517.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T18:42:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265517"
}
```



---

archive/issue_events_265518.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T18:42:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265518"
}
```



---

archive/issue_comments_264197.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nConflict with #18868",
    "created_at": "2015-07-28T18:42:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264197",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:43" align="right">comment:43</div>

Conflict with #18868



---

archive/issue_comments_264198.json:
```json
{
    "body": "Changed branch from **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)** to **[`0304d9f`](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**",
    "created_at": "2015-07-28T22:47:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-264198",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)** to **[`0304d9f`](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**



---

archive/issue_events_265519.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T22:47:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265519"
}
```



---

archive/issue_events_265520.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "79703efc9a66ecd0475610467fc2ea92a01646dc",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-07-28T22:47:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-265520"
}
```
