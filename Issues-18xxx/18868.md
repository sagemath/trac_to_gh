# Issue 18868: a MemoryAllocator object for easier Cython memory management

archive/issues_018631.json:
```json
{
    "assignees": [],
    "body": "This is a re-implementation of an example appearing in Cython's documentation (see bottom of [1]).\n\nThe idea is simple: an object has a `.malloc` method, and returns arrays of memory. When that object is garbage-collected, the memory it allocated is automatically freed.\n\nThis makes it much easier to deal with C pointers in Cython code, which must be freed before any 'return' and whenever an exception can be raised.\n\nAs an illustration of how useful this can be, I removed a *lot* of graph code.\n\nNathann\n\n[1] http://docs.cython.org/src/tutorial/memory_allocation.html\n\nDepends on #18864\n\nCC:  @dimpase borassi @dcoudert @vbraun @jdemeyer @simon-king-jena\n\nBranch/Commit: **[0304d9f](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**\n\nReviewer: **Jeroen Demeyer, Volker Braun**\n\nAuthor: **Nathann Cohen, Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18868_\n\n",
    "closed_at": "2015-07-28T22:47:06Z",
    "created_at": "2015-07-08T10:00:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20cython",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "a MemoryAllocator object for easier Cython memory management",
    "type": "issue",
    "updated_at": "2015-07-28T22:47:06Z",
    "url": "https://github.com/sagemath/sage/issues/18868",
    "user": "https://github.com/nathanncohen"
}
```
This is a re-implementation of an example appearing in Cython's documentation (see bottom of [1]).

The idea is simple: an object has a `.malloc` method, and returns arrays of memory. When that object is garbage-collected, the memory it allocated is automatically freed.

This makes it much easier to deal with C pointers in Cython code, which must be freed before any 'return' and whenever an exception can be raised.

As an illustration of how useful this can be, I removed a *lot* of graph code.

Nathann

[1] http://docs.cython.org/src/tutorial/memory_allocation.html

Depends on #18864

CC:  @dimpase borassi @dcoudert @vbraun @jdemeyer @simon-king-jena

Branch/Commit: **[0304d9f](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**

Reviewer: **Jeroen Demeyer, Volker Braun**

Author: **Nathann Cohen, Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/18868_





---

archive/issue_events_250126.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "milestone_number": null,
    "milestone_title": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250126"
}
```



---

archive/issue_events_250127.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20cython",
    "label_color": "000080",
    "label_name": "component: cython",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250127"
}
```



---

archive/issue_events_250128.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250128"
}
```



---

archive/issue_events_250129.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:00:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250129"
}
```



---

archive/issue_comments_266759.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf\">2723175</a></td><td><code>trac #18868: a MemoryAllocator object for easier Cython memory management</code></td></tr></table>\n",
    "created_at": "2015-07-08T10:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266759",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf">2723175</a></td><td><code>trac #18868: a MemoryAllocator object for easier Cython memory management</code></td></tr></table>




---

archive/issue_comments_266760.json:
```json
{
    "body": "Commit: **[2723175](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)**",
    "created_at": "2015-07-08T10:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266760",
    "user": "https://github.com/nathanncohen"
}
```

Commit: **[2723175](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)**



---

archive/issue_events_250130.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T10:01:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250130"
}
```



---

archive/issue_comments_266761.json:
```json
{
    "body": "Branch: **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)**",
    "created_at": "2015-07-08T10:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266761",
    "user": "https://github.com/nathanncohen"
}
```

Branch: **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)**



---

archive/issue_comments_266762.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nThis\n\n```\ninclude 'sage/ext/interrupt.pxi'\n```\nshould be in the `.pyx` file.",
    "created_at": "2015-07-08T10:06:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266762",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'>Comment 2:</a>
This

```
include 'sage/ext/interrupt.pxi'
```
should be in the `.pyx` file.



---

archive/issue_events_250131.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T10:06:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250131"
}
```



---

archive/issue_events_250132.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T10:06:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250132"
}
```



---

archive/issue_comments_266763.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nFor performance, replace\n\n```\ncdef MemoryAllocator mem = MemoryAllocator()\n```\nby\n\n```\ncdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)\n```",
    "created_at": "2015-07-08T10:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266763",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'>Comment 3:</a>
For performance, replace

```
cdef MemoryAllocator mem = MemoryAllocator()
```
by

```
cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)
```



---

archive/issue_comments_266764.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nCan you please support all memory-allocation functions, like `calloc`, `realloc`, `(re)allocarray` and replace the dangerous(*) calls like\n\n```\nmem.malloc( n * sizeof(unsigned short *))\n```\nby\n\n```\nmem.allocarray(n, sizeof(unsigned short *))\n```\n\n(*) the multiplication can overflow.",
    "created_at": "2015-07-08T10:12:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266764",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'>Comment 4:</a>
Can you please support all memory-allocation functions, like `calloc`, `realloc`, `(re)allocarray` and replace the dangerous(*) calls like

```
mem.malloc( n * sizeof(unsigned short *))
```
by

```
mem.allocarray(n, sizeof(unsigned short *))
```

(*) the multiplication can overflow.



---

archive/issue_comments_266765.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nAlso for performance: keep `calloc`, do not replace it with `malloc + memset`.",
    "created_at": "2015-07-08T10:14:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266765",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'>Comment 5:</a>
Also for performance: keep `calloc`, do not replace it with `malloc + memset`.



---

archive/issue_comments_266766.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nI guess that `realloc(array)` might not be so easy to support, so you can forget about that. But I would certainly support `allocarray` and `calloc`.\n\nAnd I don't understand why you use\n\n```\ncdef void * val = malloc(size)\nif val == NULL:\n    raise MemoryError()\n```\ninstead of\n\n```\ncdef void * val = check_malloc(size)\n```",
    "created_at": "2015-07-08T10:18:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266766",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'>Comment 6:</a>
I guess that `realloc(array)` might not be so easy to support, so you can forget about that. But I would certainly support `allocarray` and `calloc`.

And I don't understand why you use

```
cdef void * val = malloc(size)
if val == NULL:
    raise MemoryError()
```
instead of

```
cdef void * val = check_malloc(size)
```



---

archive/issue_comments_266767.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\n[1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions. Why do you \nstick with `malloc` etc?",
    "created_at": "2015-07-08T10:25:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266767",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'>Comment 7:</a>
[1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions. Why do you 
stick with `malloc` etc?



---

archive/issue_comments_266768.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nMore about performance: note that your use of `MemoryAllocator` needs at least 2 extra memory allocation calls compared to not using `MemoryAllocator`: one to allocate the `MemoryAllocator` object and one to allocate the `pointers` member. If you allocate several pointers, it's worse because you again need more additional `realloc()` calls for `pointers.`\n\nTo solve some of these problems, I propose the following: add a small fixed array\n\n```\ncdef void* local_pointers[16]\n```\nin the `MemoryAllocator` class and initialize\n\n```\nself.max_size = 16\nself.pointers = self.local_pointers\n```\nsuch that you avoid any allocations for `pointers` if you need to store at most 16 pointers (which is the usual case I guess).",
    "created_at": "2015-07-08T10:26:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266768",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'>Comment 8:</a>
More about performance: note that your use of `MemoryAllocator` needs at least 2 extra memory allocation calls compared to not using `MemoryAllocator`: one to allocate the `MemoryAllocator` object and one to allocate the `pointers` member. If you allocate several pointers, it's worse because you again need more additional `realloc()` calls for `pointers.`

To solve some of these problems, I propose the following: add a small fixed array

```
cdef void* local_pointers[16]
```
in the `MemoryAllocator` class and initialize

```
self.max_size = 16
self.pointers = self.local_pointers
```
such that you avoid any allocations for `pointers` if you need to store at most 16 pointers (which is the usual case I guess).



---

archive/issue_comments_266769.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [@dimpase](#comment%3A7):\n> Why do you stick with `malloc` etc?\n\nIn Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!",
    "created_at": "2015-07-08T10:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266769",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [@dimpase](#comment%3A7):
> Why do you stick with `malloc` etc?

In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!



---

archive/issue_comments_266770.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nMore for performance: replace\n\n```\ncdef enlarge_if_needed(self):\n```\nby\n\n```\ncdef int enlarge_if_needed(self) except -1:\n```",
    "created_at": "2015-07-08T10:28:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266770",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'>Comment 10:</a>
More for performance: replace

```
cdef enlarge_if_needed(self):
```
by

```
cdef int enlarge_if_needed(self) except -1:
```



---

archive/issue_comments_266771.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nOne more detail: replace\n\n```\ncdef int n\ncdef int max_size\n```\nby\n\n```\ncdef size_t n\ncdef size_t max_size\n```\n(and adjust the loop index in `__dealloc__`) in case I ever need more than 2<sup>31</sup> pointers :-)",
    "created_at": "2015-07-08T10:33:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266771",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'>Comment 11:</a>
One more detail: replace

```
cdef int n
cdef int max_size
```
by

```
cdef size_t n
cdef size_t max_size
```
(and adjust the loop index in `__dealloc__`) in case I ever need more than 2<sup>31</sup> pointers :-)



---

archive/issue_comments_266772.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@jdemeyer](#comment%3A9):\n> Replying to [@dimpase](#comment%3A7):\n> > Why do you stick with `malloc` etc?\n\n> In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!\n\nAnd why does `sage_malloc` use `malloc`, and not `PyMem_Malloc`?",
    "created_at": "2015-07-08T11:24:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266772",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@jdemeyer](#comment%3A9):
> Replying to [@dimpase](#comment%3A7):
> > Why do you stick with `malloc` etc?

> In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!

And why does `sage_malloc` use `malloc`, and not `PyMem_Malloc`?



---

archive/issue_comments_266773.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf39672b9547f32ec01e261e7541f22429bee5b7\">bf39672</a></td><td><code>trac #18868: back to calloc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13\">9597eec</a></td><td><code>trac #18868: Changes to MemoryAllocator</code></td></tr></table>\n",
    "created_at": "2015-07-08T11:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266773",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:14'>Comment 14:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf39672b9547f32ec01e261e7541f22429bee5b7">bf39672</a></td><td><code>trac #18868: back to calloc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13">9597eec</a></td><td><code>trac #18868: Changes to MemoryAllocator</code></td></tr></table>




---

archive/issue_comments_266774.json:
```json
{
    "body": "Changed commit from **[2723175](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)** to **[9597eec](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)**",
    "created_at": "2015-07-08T11:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266774",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2723175](https://github.com/sagemath/sagetrac-mirror/commit/27231756748e4743df056783f524c66099189ccf)** to **[9597eec](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)**



---

archive/issue_events_250133.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T11:36:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250133"
}
```



---

archive/issue_events_250134.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T11:36:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250134"
}
```



---

archive/issue_comments_266775.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\n> This `include 'sage/ext/interrupt.pxi'` should be in the .pyx file.\n\nDone\n\n> For performance, replace \n> `cdef MemoryAllocator mem = MemoryAllocator()`\n> by\n> `cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)`\n\nMakes no difference in any of the functions I touched, so I did not do it. Less\nreadable.\n\n> Can you please support all memory-allocation functions, like calloc, realloc,\n> (re)allocarray and replace the dangerous(*) calls like\n\nI added support for calloc. I do not need realloc (you can add a commit if you\nneed it).\n\nAbout realloc:\n\n> I guess that realloc(array) might not be so easy to support, so you can forget\n> about that.\n\n+1\n\n> But I would certainly support allocarray\n\nAdd a commit if you like. My problem with 'allocarray' is that it is Sage's\nterminology (as far as I know), and that I prefer to stick to more widely\nunderstood terms like 'malloc/calloc'. I was just saying to David that we may\neventually move some C graph code away from sage and make it an independent C\nlibrary.\n\n> And I don't understand why you use\n\n>\n> ```\n> cdef void * val = malloc(size)\n> if val == NULL:\n>     raise MemoryError()\n> ```\n> instead of\n>\n> ```\n> cdef void * val = check_malloc(size)\n> ```\n\nDone\n\n> [1] recommends PyMem_Malloc, PyMem_Realloc, PyMem_Free over the system\n> functions. Why do you stick with malloc etc?\n\nPersonally, for a simple reason: I trust C functions. Officially, it is for the\nreason Jeroen mentionned. Note that we can satisfy everybody: it is possible to\nhave `sage_malloc` (which behaves properly with respect to interrupts) call your\nfunctions instead of C ones.\n\n> More about performance: note that your use of MemoryAllocator needs at least 2\n> extra memory allocation calls compared to not using MemoryAllocator\n\nThis is not a problem for the codes I touched, for malloc is never a dominant\ncost in any of them. You can add a commit if you like, though please keep the\ncode simple and understandable if you do.\n\n> More for performance: replace\n> `cdef enlarge_if_needed(self):`\n> by\n> `cdef int enlarge_if_needed(self) except -1:`\n\nDone.\n\n> One more detail: replace `int` with `size_t`\n\nDone.\n\nJeroen, could you send reviews as one big comment rather than adding one every\ntime you notice something? Everybody in Cc receives an email for each comments,\nand it is also a bit harder to address your points:\n\n- One never knows if you are done reading the code or if we can expect a new\n  comment in the next seconds\n\n- Answering your points like I do now is a bit harder: instead of clicking on\n  'reply' (to your comment), I copy/paste all your individual messages into a\n  text file, then start answering them.\n\nThaaaaaaaaanks,\n\nNathann",
    "created_at": "2015-07-08T11:36:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266775",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:15'>Comment 15:</a>
> This `include 'sage/ext/interrupt.pxi'` should be in the .pyx file.

Done

> For performance, replace 
> `cdef MemoryAllocator mem = MemoryAllocator()`
> by
> `cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)`

Makes no difference in any of the functions I touched, so I did not do it. Less
readable.

> Can you please support all memory-allocation functions, like calloc, realloc,
> (re)allocarray and replace the dangerous(*) calls like

I added support for calloc. I do not need realloc (you can add a commit if you
need it).

About realloc:

> I guess that realloc(array) might not be so easy to support, so you can forget
> about that.

+1

> But I would certainly support allocarray

Add a commit if you like. My problem with 'allocarray' is that it is Sage's
terminology (as far as I know), and that I prefer to stick to more widely
understood terms like 'malloc/calloc'. I was just saying to David that we may
eventually move some C graph code away from sage and make it an independent C
library.

> And I don't understand why you use

>
> ```
> cdef void * val = malloc(size)
> if val == NULL:
>     raise MemoryError()
> ```
> instead of
>
> ```
> cdef void * val = check_malloc(size)
> ```

Done

> [1] recommends PyMem_Malloc, PyMem_Realloc, PyMem_Free over the system
> functions. Why do you stick with malloc etc?

Personally, for a simple reason: I trust C functions. Officially, it is for the
reason Jeroen mentionned. Note that we can satisfy everybody: it is possible to
have `sage_malloc` (which behaves properly with respect to interrupts) call your
functions instead of C ones.

> More about performance: note that your use of MemoryAllocator needs at least 2
> extra memory allocation calls compared to not using MemoryAllocator

This is not a problem for the codes I touched, for malloc is never a dominant
cost in any of them. You can add a commit if you like, though please keep the
code simple and understandable if you do.

> More for performance: replace
> `cdef enlarge_if_needed(self):`
> by
> `cdef int enlarge_if_needed(self) except -1:`

Done.

> One more detail: replace `int` with `size_t`

Done.

Jeroen, could you send reviews as one big comment rather than adding one every
time you notice something? Everybody in Cc receives an email for each comments,
and it is also a bit harder to address your points:

- One never knows if you are done reading the code or if we can expect a new
  comment in the next seconds

- Answering your points like I do now is a bit harder: instead of clicking on
  'reply' (to your comment), I copy/paste all your individual messages into a
  text file, then start answering them.

Thaaaaaaaaanks,

Nathann



---

archive/issue_comments_266776.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nReplying to [@dimpase](#comment%3A7):\n> [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.\n\nWhat is [1]?",
    "created_at": "2015-07-08T11:58:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266776",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'>Comment 16:</a>
Replying to [@dimpase](#comment%3A7):
> [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.

What is [1]?



---

archive/issue_comments_266777.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@nathanncohen](#comment%3A15):\n> My problem with 'allocarray' is that it is Sage's terminology (as far as I know)\n\nIt actually comes from BSD, where it was added for security reasons (like I said, the multiplication in `malloc(n * sizeof(foo))` can overflow, a potential security issue). For Sage, it's not so much the \"security\" aspect which is important, but the reliability.",
    "created_at": "2015-07-08T12:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266777",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@nathanncohen](#comment%3A15):
> My problem with 'allocarray' is that it is Sage's terminology (as far as I know)

It actually comes from BSD, where it was added for security reasons (like I said, the multiplication in `malloc(n * sizeof(foo))` can overflow, a potential security issue). For Sage, it's not so much the "security" aspect which is important, but the reliability.



---

archive/issue_events_250135.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T12:06:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250135"
}
```



---

archive/issue_events_250136.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-07-08T12:06:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250136"
}
```



---

archive/issue_comments_266778.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nReplying to [@nathanncohen](#comment%3A15):\n> You can add a commit if you like, though please keep the\n> code simple and understandable if you do.\n\nI thought that speed was an important reason to invent this new class. If you don't care so much about speed, there are several already-existing alternatives, such as [Cython arrays](http://docs.cython.org/src/userguide/memoryviews.html#cython-arrays).\n\nIf speed is not so much a concern, then why are you reinventing the wheel?",
    "created_at": "2015-07-08T12:06:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266778",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
Replying to [@nathanncohen](#comment%3A15):
> You can add a commit if you like, though please keep the
> code simple and understandable if you do.

I thought that speed was an important reason to invent this new class. If you don't care so much about speed, there are several already-existing alternatives, such as [Cython arrays](http://docs.cython.org/src/userguide/memoryviews.html#cython-arrays).

If speed is not so much a concern, then why are you reinventing the wheel?



---

archive/issue_events_250137.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T12:09:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250137"
}
```



---

archive/issue_events_250138.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-08T12:09:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250138"
}
```



---

archive/issue_comments_266779.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\n> I thought that speed was an important reason to invent this new class.\n\nI care about the speed of the algorithm themselves. I need real C arrays. The time it takes to allocate them is not a problem in the graph code.\n\nNathann",
    "created_at": "2015-07-08T12:09:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266779",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:19'>Comment 19:</a>
> I thought that speed was an important reason to invent this new class.

I care about the speed of the algorithm themselves. I need real C arrays. The time it takes to allocate them is not a problem in the graph code.

Nathann



---

archive/issue_comments_266780.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nReplying to [@nathanncohen](#comment%3A15):\n> Makes no difference in any of the functions I touched, so I did not do it. Less\n> readable.\n\nYou are right. I was confused with *explicit* calls to `__init__` (i.e. `foo.__init__()` should be avoided in Cython).",
    "created_at": "2015-07-08T12:19:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266780",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'>Comment 20:</a>
Replying to [@nathanncohen](#comment%3A15):
> Makes no difference in any of the functions I touched, so I did not do it. Less
> readable.

You are right. I was confused with *explicit* calls to `__init__` (i.e. `foo.__init__()` should be avoided in Cython).



---

archive/issue_comments_266781.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [@jdemeyer](#comment%3A16):\n> Replying to [@dimpase](#comment%3A7):\n> > [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.\n\n> \n> What is [1]?\n\nsee the ticket description",
    "created_at": "2015-07-08T12:22:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266781",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [@jdemeyer](#comment%3A16):
> Replying to [@dimpase](#comment%3A7):
> > [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.

> 
> What is [1]?

see the ticket description



---

archive/issue_comments_266782.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nI wonder whether there are ways to avoid syntactic clutter such as\n\n```\ncdef uint32_t * _connected_structure = <uint32_t *> mem.calloc(n * n , sizeof(uint32_t))\n```\nYou know, in C such thing would be best written as macro call like\n\n```\nnewdef(_connected_structure, uint32_t, n*n)\n```\navoiding mentioning `uint32_t` three times...",
    "created_at": "2015-07-08T12:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266782",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'>Comment 22:</a>
I wonder whether there are ways to avoid syntactic clutter such as

```
cdef uint32_t * _connected_structure = <uint32_t *> mem.calloc(n * n , sizeof(uint32_t))
```
You know, in C such thing would be best written as macro call like

```
newdef(_connected_structure, uint32_t, n*n)
```
avoiding mentioning `uint32_t` three times...



---

archive/issue_comments_266783.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\n> I wonder whether there are ways to avoid syntactic clutter such as\n\n+1 `:-/`\n\nNathann",
    "created_at": "2015-07-08T12:38:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266783",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:23'>Comment 23:</a>
> I wonder whether there are ways to avoid syntactic clutter such as

+1 `:-/`

Nathann



---

archive/issue_comments_266784.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nReplying to [@nathanncohen](#comment%3A19):\n> I need real C arrays. The time it takes to allocate them is not a problem in the graph code.\n\nOK, here is a deal: if you really mean what you say (that you don't care about the time to allocate, just the access time), then I'm pretty sure that your problem can be solved with Cython arrays. A memoryview like `cdef int[::1]` should be as fast as a C pointer.",
    "created_at": "2015-07-08T12:49:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266784",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'>Comment 24:</a>
Replying to [@nathanncohen](#comment%3A19):
> I need real C arrays. The time it takes to allocate them is not a problem in the graph code.

OK, here is a deal: if you really mean what you say (that you don't care about the time to allocate, just the access time), then I'm pretty sure that your problem can be solved with Cython arrays. A memoryview like `cdef int[::1]` should be as fast as a C pointer.



---

archive/issue_comments_266785.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\n> A memoryview like `cdef int[::1]` should be as fast as a C pointer.\n\nIf your 'should' is a 'is', and if you do not need to replace each pointer allocation by 1) creationg of a Cython object 2) Linking it to the C array then yes. Can you give an example of that? I read your link toward 'Cython arrays' and it seems to have this drawback, i.e. 2 lines per allocation.\n\nNathann",
    "created_at": "2015-07-08T12:53:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266785",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:25'>Comment 25:</a>
> A memoryview like `cdef int[::1]` should be as fast as a C pointer.

If your 'should' is a 'is', and if you do not need to replace each pointer allocation by 1) creationg of a Cython object 2) Linking it to the C array then yes. Can you give an example of that? I read your link toward 'Cython arrays' and it seems to have this drawback, i.e. 2 lines per allocation.

Nathann



---

archive/issue_comments_266786.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nReplying to [@nathanncohen](#comment%3A25):\n> Can you give an example of that?\n\nA created a new ticket #18870 to discuss it.",
    "created_at": "2015-07-08T13:01:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266786",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'>Comment 26:</a>
Replying to [@nathanncohen](#comment%3A25):
> Can you give an example of that?

A created a new ticket #18870 to discuss it.



---

archive/issue_comments_266787.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nI looked into #18870 and personally, I don't like it.",
    "created_at": "2015-07-08T13:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266787",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'>Comment 27:</a>
I looked into #18870 and personally, I don't like it.



---

archive/issue_comments_266788.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nWhy wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?",
    "created_at": "2015-07-08T13:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266788",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:28'>Comment 28:</a>
Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?



---

archive/issue_comments_266789.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nReplying to [@nathanncohen](#comment%3A28):\n> Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?\n\nsure, why not; also, how about asking them about comment [23](https://github.com/sagemath/sage/issues/18868#comment:23) ?",
    "created_at": "2015-07-08T13:58:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266789",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'>Comment 29:</a>
Replying to [@nathanncohen](#comment%3A28):
> Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?

sure, why not; also, how about asking them about comment [23](https://github.com/sagemath/sage/issues/18868#comment:23) ?



---

archive/issue_comments_266790.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f\">f514301</a></td><td><code>Optimize MemoryAllocator and add allocarray()</code></td></tr></table>\n",
    "created_at": "2015-07-08T15:46:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266790",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:30'>Comment 30:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f">f514301</a></td><td><code>Optimize MemoryAllocator and add allocarray()</code></td></tr></table>




---

archive/issue_comments_266791.json:
```json
{
    "body": "Changed commit from **[9597eec](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)** to **[f514301](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)**",
    "created_at": "2015-07-08T15:46:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266791",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9597eec](https://github.com/sagemath/sagetrac-mirror/commit/9597eec5a42d72f66d56245f7312af3d69bbbf13)** to **[f514301](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)**



---

archive/issue_comments_266792.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37\">39f8839</a></td><td><code>Fix exception handling</code></td></tr></table>\n",
    "created_at": "2015-07-08T18:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266792",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:31'>Comment 31:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37">39f8839</a></td><td><code>Fix exception handling</code></td></tr></table>




---

archive/issue_comments_266793.json:
```json
{
    "body": "Changed commit from **[f514301](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)** to **[39f8839](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)**",
    "created_at": "2015-07-08T18:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266793",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[f514301](https://github.com/sagemath/sagetrac-mirror/commit/f514301ecf95d895d4321c7782d888d4cd27355f)** to **[39f8839](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)**



---

archive/issue_comments_266794.json:
```json
{
    "body": "Changed author from **Nathann Cohen** to **Nathann Cohen, Jeroen Demeyer**",
    "created_at": "2015-07-08T18:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266794",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Nathann Cohen** to **Nathann Cohen, Jeroen Demeyer**



---

archive/issue_comments_266795.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2015-07-08T18:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266795",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_266796.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nThis is ok for me, but someone needs to review my changes.",
    "created_at": "2015-07-08T18:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266796",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'>Comment 32:</a>
This is ok for me, but someone needs to review my changes.



---

archive/issue_comments_266797.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nstill, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?\n\nApart from performance, there could be advantages in sense of debugging, as one can \n`./configure` Python with `--with-pydebug` to catch memory errors...",
    "created_at": "2015-07-09T10:42:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266797",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'>Comment 33:</a>
still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?

Apart from performance, there could be advantages in sense of debugging, as one can 
`./configure` Python with `--with-pydebug` to catch memory errors...



---

archive/issue_comments_266798.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nReplying to [@dimpase](#comment%3A33):\n> still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?\n\nIn any case, that's independent of this ticket.\n\nSecond, `sage_malloc()` can be called without the GIL. I guess `PyMem_Malloc` cannot...",
    "created_at": "2015-07-09T11:11:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266798",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'>Comment 34:</a>
Replying to [@dimpase](#comment%3A33):
> still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?

In any case, that's independent of this ticket.

Second, `sage_malloc()` can be called without the GIL. I guess `PyMem_Malloc` cannot...



---

archive/issue_comments_266799.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nThird, Python's memory allocator does not support `calloc()` or `allocarray()`, two very useful functions.\n\nAnd if you're speaking about performance, recall that `malloc()` + `memset()` is slower than `calloc()`.",
    "created_at": "2015-07-09T11:18:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266799",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'>Comment 35:</a>
Third, Python's memory allocator does not support `calloc()` or `allocarray()`, two very useful functions.

And if you're speaking about performance, recall that `malloc()` + `memset()` is slower than `calloc()`.



---

archive/issue_comments_266800.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nCan somebody review this please?",
    "created_at": "2015-07-17T10:33:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266800",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'>Comment 36:</a>
Can somebody review this please?



---

archive/issue_events_250139.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-17T11:20:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250139"
}
```



---

archive/issue_events_250140.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-17T11:20:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250140"
}
```



---

archive/issue_comments_266801.json:
```json
{
    "body": "Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**",
    "created_at": "2015-07-17T11:22:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266801",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**



---

archive/issue_comments_266802.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nYour were faster than me.\nI can at least confirm that all long tests pass on `src/sage/graphs/`.\nDavid.",
    "created_at": "2015-07-17T11:23:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266802",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:39'>Comment 39:</a>
Your were faster than me.
I can at least confirm that all long tests pass on `src/sage/graphs/`.
David.



---

archive/issue_comments_266803.json:
```json
{
    "body": "Changed commit from **[39f8839](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)** to **[0304d9f](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**",
    "created_at": "2015-07-24T09:40:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266803",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[39f8839](https://github.com/sagemath/sagetrac-mirror/commit/39f88395bcef3aa972d48b31d4561c3c8a284d37)** to **[0304d9f](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**



---

archive/issue_comments_266804.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da7bad709841e6d77dc089524178011f35ee931e\">da7bad7</a></td><td><code>trac #18864: Merged with 6.8.beta8</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da0260dca9b43d96b47bcae2ba79a2b8819896ec\">da0260d</a></td><td><code>trac #18864: prevent using the Takes-Kosters algorithm on digraphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/554c5099f8b47cef74a13cd968223c9288264424\">554c509</a></td><td><code>trac #18864: implement reviewer's comments</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f48a33e012a0187ceea3b3011909342dc5cb1375\">f48a33e</a></td><td><code>trac #18864: minor corrections</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a3717b73c811ff702345a186b679df4b99e725fa\">a3717b7</a></td><td><code>trac #18864: improve behavior with directed graphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f621777db49299ce66bf8663795ad79453d4e43e\">f621777</a></td><td><code>trac #18864: corrections and improved doc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80cb89935d8eb8288d6659d7c73d8c05ee1c9411\">80cb899</a></td><td><code>trac #18864: correct version</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce9d26556e5b1a69002e1a5165933e51ddfc7c05\">ce9d265</a></td><td><code>trac #18864: return Sage integers</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a1b36dafbf11d7f72f8568c51af6fba7003ca096\">a1b36da</a></td><td><code>trac #18864: Merged with 6.8.rc1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5\">0304d9f</a></td><td><code>trac #18868: Merged with #18864</code></td></tr></table>\n",
    "created_at": "2015-07-24T09:40:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266804",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:40'>Comment 40:</a>
Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da7bad709841e6d77dc089524178011f35ee931e">da7bad7</a></td><td><code>trac #18864: Merged with 6.8.beta8</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da0260dca9b43d96b47bcae2ba79a2b8819896ec">da0260d</a></td><td><code>trac #18864: prevent using the Takes-Kosters algorithm on digraphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/554c5099f8b47cef74a13cd968223c9288264424">554c509</a></td><td><code>trac #18864: implement reviewer's comments</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f48a33e012a0187ceea3b3011909342dc5cb1375">f48a33e</a></td><td><code>trac #18864: minor corrections</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a3717b73c811ff702345a186b679df4b99e725fa">a3717b7</a></td><td><code>trac #18864: improve behavior with directed graphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f621777db49299ce66bf8663795ad79453d4e43e">f621777</a></td><td><code>trac #18864: corrections and improved doc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80cb89935d8eb8288d6659d7c73d8c05ee1c9411">80cb899</a></td><td><code>trac #18864: correct version</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce9d26556e5b1a69002e1a5165933e51ddfc7c05">ce9d265</a></td><td><code>trac #18864: return Sage integers</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a1b36dafbf11d7f72f8568c51af6fba7003ca096">a1b36da</a></td><td><code>trac #18864: Merged with 6.8.rc1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5">0304d9f</a></td><td><code>trac #18868: Merged with #18864</code></td></tr></table>




---

archive/issue_events_250141.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2015-07-24T09:40:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250141"
}
```



---

archive/issue_events_250142.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2015-07-24T09:40:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250142"
}
```



---

archive/issue_events_250143.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-24T09:41:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250143"
}
```



---

archive/issue_events_250144.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2015-07-24T09:41:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250144"
}
```



---

archive/issue_comments_266805.json:
```json
{
    "body": "Dependencies: **#18864**",
    "created_at": "2015-07-24T09:41:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266805",
    "user": "https://github.com/nathanncohen"
}
```

Dependencies: **#18864**



---

archive/issue_events_250145.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T18:42:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250145"
}
```



---

archive/issue_events_250146.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T18:42:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250146"
}
```



---

archive/issue_comments_266806.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nConflict with #18868",
    "created_at": "2015-07-28T18:42:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266806",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:43'>Comment 43:</a>
Conflict with #18868



---

archive/issue_comments_266807.json:
```json
{
    "body": "Changed branch from **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)** to **[0304d9f](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**",
    "created_at": "2015-07-28T22:47:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18868#issuecomment-266807",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/18868](https://github.com/sagemath/sagetrac-mirror/tree/public/18868)** to **[0304d9f](https://github.com/sagemath/sagetrac-mirror/commit/0304d9f21aa483f8b37bc6959e1a7490cd23ddb5)**



---

archive/issue_events_250147.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T22:47:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250147"
}
```



---

archive/issue_events_250148.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "79703efc9a66ecd0475610467fc2ea92a01646dc",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-07-28T22:47:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18868",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18868#event-250148"
}
```
