# Issue 18589: isogeny efficiency improvement

archive/issues_018352.json:
```json
{
    "assignees": [],
    "body": "Computation of isogenies of prime degree p is expensive when the degree is neither a \"genus zero\" prime [2,3,5,7,13] or a \"hyperelliptic prime\" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree `(p^2-1)/2` division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.\n\nThe example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and the code requires factoring the 89-division polynomial of each!)  I used a less extreme example for a doctest: a 37-isogeny.\n\nCC:  @defeo\n\nKeywords: **isogeny**\n\nBranch/Commit: **[`3d687e5`](https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62)**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **John Cremona**\n\nComponent: **elliptic curves**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18589_\n\n",
    "closed_at": "2015-06-06T12:47:44Z",
    "created_at": "2015-06-02T19:33:19Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "isogeny efficiency improvement",
    "type": "issue",
    "updated_at": "2015-06-06T12:47:44Z",
    "url": "https://github.com/sagemath/sage/issues/18589",
    "user": "https://github.com/JohnCremona"
}
```
Computation of isogenies of prime degree p is expensive when the degree is neither a "genus zero" prime [2,3,5,7,13] or a "hyperelliptic prime" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree `(p^2-1)/2` division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.

The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and the code requires factoring the 89-division polynomial of each!)  I used a less extreme example for a doctest: a 37-isogeny.

CC:  @defeo

Keywords: **isogeny**

Branch/Commit: **[`3d687e5`](https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62)**

Reviewer: **Jeroen Demeyer**

Author: **John Cremona**

Component: **elliptic curves**

_Issue created by migration from https://trac.sagemath.org/ticket/18589_





---

archive/issue_events_261855.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-02T19:33:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "milestone_number": null,
    "milestone_title": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261855"
}
```



---

archive/issue_events_261856.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-02T19:33:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
    "label_color": "0000ff",
    "label_name": "c: elliptic curves",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261856"
}
```



---

archive/issue_events_261857.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-02T19:33:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261857"
}
```



---

archive/issue_events_261858.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-02T19:33:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261858"
}
```



---

archive/issue_comments_258348.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-Computation of isogenies of prime degree p is expensive when the degree is neither a \"genus zero\" prime [2,3,5,7,13] or a \"hyperelliptic prime\" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree (p^2-1)/2 division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.\n+Computation of isogenies of prime degree p is expensive when the degree is neither a \"genus zero\" prime [2,3,5,7,13] or a \"hyperelliptic prime\" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree `(p^2-1)/2` division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.\n \n The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and thec ode requires factoring the 89-division polynomial of each!)  I will find a less extreme example for a doctest.\n``````\n",
    "created_at": "2015-06-02T19:33:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258348",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-Computation of isogenies of prime degree p is expensive when the degree is neither a "genus zero" prime [2,3,5,7,13] or a "hyperelliptic prime" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree (p^2-1)/2 division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.
+Computation of isogenies of prime degree p is expensive when the degree is neither a "genus zero" prime [2,3,5,7,13] or a "hyperelliptic prime" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree `(p^2-1)/2` division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.
 
 The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and thec ode requires factoring the 89-division polynomial of each!)  I will find a less extreme example for a doctest.
``````




---

archive/issue_comments_258349.json:
```json
{
    "body": "Commit: **[`47ccfd5`](https://github.com/sagemath/sagetrac-mirror/commit/47ccfd587402b953c612fcd3cddaa541a6847bd3)**",
    "created_at": "2015-06-02T19:51:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258349",
    "user": "https://github.com/JohnCremona"
}
```

Commit: **[`47ccfd5`](https://github.com/sagemath/sagetrac-mirror/commit/47ccfd587402b953c612fcd3cddaa541a6847bd3)**



---

archive/issue_comments_258350.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/47ccfd587402b953c612fcd3cddaa541a6847bd3\"><code>47ccfd5</code></a></td><td><code>#18589 isogeny improvement</code></td></tr></table>\n",
    "created_at": "2015-06-02T19:51:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258350",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/47ccfd587402b953c612fcd3cddaa541a6847bd3"><code>47ccfd5</code></a></td><td><code>#18589 isogeny improvement</code></td></tr></table>




---

archive/issue_comments_258351.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n Computation of isogenies of prime degree p is expensive when the degree is neither a \"genus zero\" prime [2,3,5,7,13] or a \"hyperelliptic prime\" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree `(p^2-1)/2` division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.\n \n-The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and thec ode requires factoring the 89-division polynomial of each!)  I will find a less extreme example for a doctest.\n+The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and the code requires factoring the 89-division polynomial of each!)  I used a less extreme example for a doctest: a 37-isogeny.\n``````\n",
    "created_at": "2015-06-02T19:51:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258351",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 Computation of isogenies of prime degree p is expensive when the degree is neither a "genus zero" prime [2,3,5,7,13] or a "hyperelliptic prime" [11, 17, 19, 23, 29, 31, 41, 47, 59, 71] (for these there is special code written).  In one situation we can save time, after factoring the degree `(p^2-1)/2` division polynomial, if there is exactly one factor of degree (p-1)/2, or one subset of factors whose product has that degree, then the factor of degree (p-1)/2 must be a kernel polynomial.  Then we do not need to check consistency, which is very expensive.
 
-The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and thec ode requires factoring the 89-division polynomial of each!)  I will find a less extreme example for a doctest.
+The example which led me to this was with p=89 over a quadratic number field, where E.isogeny_class() was taking days.  After the change here that goes down to 3 hours.  (There are 4 curves in the isogeny class and the code requires factoring the 89-division polynomial of each!)  I used a less extreme example for a doctest: a 37-isogeny.
``````




---

archive/issue_comments_258352.json:
```json
{
    "body": "Branch: **[u/cremona/18589](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18589)**",
    "created_at": "2015-06-02T19:51:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258352",
    "user": "https://github.com/JohnCremona"
}
```

Branch: **[u/cremona/18589](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18589)**



---

archive/issue_events_261859.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-02T19:51:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261859"
}
```



---

archive/issue_comments_258353.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nInteresting, the hardest part of the computation is checking the consistency, not computing the actual result.\n\nI had a look at what PARI can do for isogenies: `ellisogeny` computes the isogeny, so it could be used to implement `E.isogeny()`, but I assume it does no checking.\n\nMinor comment: in the doctest, you don't need\n\n```\nfrom sage.schemes.elliptic_curves.isogeny_small_degree import isogenies_prime_degree_general\n```",
    "created_at": "2015-06-03T16:00:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258353",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Interesting, the hardest part of the computation is checking the consistency, not computing the actual result.

I had a look at what PARI can do for isogenies: `ellisogeny` computes the isogeny, so it could be used to implement `E.isogeny()`, but I assume it does no checking.

Minor comment: in the doctest, you don't need

```
from sage.schemes.elliptic_curves.isogeny_small_degree import isogenies_prime_degree_general
```



---

archive/issue_comments_258354.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThanks for the comments, I noticed you over at pari-dev and wondered what you were up to.\n\nI don't know how general the pari code is -- here we can handle arbitrary fields (but only separable isogenies).  Over number fields the really hard part is determining which prime degrees to test to get the whole class, and I put a lot of work into this (including CM and \"potential CM\" cases).\n\nSome checking is necessary:  I have an example where the 13-division poly factors as 14 degree 6 factors, but only 2 of them are kernel polys!  For the rest you need to make a quadratic extension which splits each into two cubics, and then you have to match the factors.  The Sage code does this!",
    "created_at": "2015-06-03T16:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258354",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:5" align="right">comment:5</div>

Thanks for the comments, I noticed you over at pari-dev and wondered what you were up to.

I don't know how general the pari code is -- here we can handle arbitrary fields (but only separable isogenies).  Over number fields the really hard part is determining which prime degrees to test to get the whole class, and I put a lot of work into this (including CM and "potential CM" cases).

Some checking is necessary:  I have an example where the 13-division poly factors as 14 degree 6 factors, but only 2 of them are kernel polys!  For the rest you need to make a quadratic extension which splits each into two cubics, and then you have to match the factors.  The Sage code does this!



---

archive/issue_comments_258355.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@JohnCremona](#comment:5):\n> I have an example where the 13-division poly factors as 14 degree 6 factors, but only 2 of them are kernel polys!\n\nIs this example in Sage? It would be good to have (if it takes too long, just add `# not tested (10 minutes)` or whatever)",
    "created_at": "2015-06-04T08:00:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258355",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@JohnCremona](#comment:5):
> I have an example where the 13-division poly factors as 14 degree 6 factors, but only 2 of them are kernel polys!

Is this example in Sage? It would be good to have (if it takes too long, just add `# not tested (10 minutes)` or whatever)



---

archive/issue_comments_258356.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@JohnCremona](#comment:5):\n> For the rest you need to make a quadratic extension which splits each into two cubics, and then you have to match the factors.\n\nI'm wondering if you could use resultants instead...",
    "created_at": "2015-06-04T08:01:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258356",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@JohnCremona](#comment:5):
> For the rest you need to make a quadratic extension which splits each into two cubics, and then you have to match the factors.

I'm wondering if you could use resultants instead...



---

archive/issue_comments_258357.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@jdemeyer](#comment:6):\n> Replying to [@JohnCremona](#comment:5):\n> > I have an example where the 13-division poly factors as 14 degree 6 factors, but only 2 of them are kernel polys!\n\n> Is this example in Sage? It would be good to have (if it takes too long, just add `# not tested (10 minutes)` or whatever)\n\nNo, but it is Example 3.1.1 on page 28 of [KT2013] which is here: http://wrap.warwick.ac.uk/57568/\nThe example is over F_3 so is not slow.",
    "created_at": "2015-06-04T08:09:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258357",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@jdemeyer](#comment:6):
> Replying to [@JohnCremona](#comment:5):
> > I have an example where the 13-division poly factors as 14 degree 6 factors, but only 2 of them are kernel polys!

> Is this example in Sage? It would be good to have (if it takes too long, just add `# not tested (10 minutes)` or whatever)

No, but it is Example 3.1.1 on page 28 of [KT2013] which is here: http://wrap.warwick.ac.uk/57568/
The example is over F_3 so is not slow.



---

archive/issue_comments_258358.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@jdemeyer](#comment:7):\n> Replying to [@JohnCremona](#comment:5):\n> > For the rest you need to make a quadratic extension which splits each into two cubics, and then you have to match the factors.\n\n> I'm wondering if you could use resultants instead...\n\nI thought that we did use resultants... but looking again at Kimi's code, the relevant function is mult() on line 1960:  the effect of this function is to take the polynomial f and the rational function m, under the assumption that f is coprime to the denominator of m, and return the poly whose roots are m(alpha) as alpha runs over the roots of f.  If m were a polynomial that would be res_Y(X-m(Y),f(Y)).  I can see now that we could stil use that formula with m(Y) replaced by the polynomial p(Y) which satisfies p*d=n (mod f) where m=n/d which would amount to one extended gcd and one resultant.  This may be better than the current code since it does not use rational functions.\n\nCan we keep this idea for another ticket?",
    "created_at": "2015-06-04T08:15:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258358",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@jdemeyer](#comment:7):
> Replying to [@JohnCremona](#comment:5):
> > For the rest you need to make a quadratic extension which splits each into two cubics, and then you have to match the factors.

> I'm wondering if you could use resultants instead...

I thought that we did use resultants... but looking again at Kimi's code, the relevant function is mult() on line 1960:  the effect of this function is to take the polynomial f and the rational function m, under the assumption that f is coprime to the denominator of m, and return the poly whose roots are m(alpha) as alpha runs over the roots of f.  If m were a polynomial that would be res_Y(X-m(Y),f(Y)).  I can see now that we could stil use that formula with m(Y) replaced by the polynomial p(Y) which satisfies p*d=n (mod f) where m=n/d which would amount to one extended gcd and one resultant.  This may be better than the current code since it does not use rational functions.

Can we keep this idea for another ticket?



---

archive/issue_comments_258359.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@JohnCremona](#comment:9):\n> Can we keep this idea for another ticket?\n\nSure...",
    "created_at": "2015-06-04T08:19:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258359",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@JohnCremona](#comment:9):
> Can we keep this idea for another ticket?

Sure...



---

archive/issue_comments_258360.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nIn your code, \"special case 1\" is really a special case of \"special case 2\". For simplicity, I would therefore keep only special case 2.",
    "created_at": "2015-06-04T09:39:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258360",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

In your code, "special case 1" is really a special case of "special case 2". For simplicity, I would therefore keep only special case 2.



---

archive/issue_comments_258361.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThere is a pre-existing typo: `otain` instead of `obtain`.",
    "created_at": "2015-06-04T09:40:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258361",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

There is a pre-existing typo: `otain` instead of `obtain`.



---

archive/issue_comments_258362.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThere is a redundant\n\n```\nfrom sage.misc.all import prod\n```",
    "created_at": "2015-06-04T09:42:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258362",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

There is a redundant

```
from sage.misc.all import prod
```



---

archive/issue_comments_258363.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nOK, I will fix the redundant imports;  I agree that Case 1 is a special case of Case 2.  And I am working on the resultant improvement -- so setting to \"needs work\" is fine.  (Without the patch though I would not have been able to compute this:  http://beta.lmfdb.org/EllipticCurve/2.2.89.1/81.1/a/ !!",
    "created_at": "2015-06-04T09:46:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258363",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:14" align="right">comment:14</div>

OK, I will fix the redundant imports;  I agree that Case 1 is a special case of Case 2.  And I am working on the resultant improvement -- so setting to "needs work" is fine.  (Without the patch though I would not have been able to compute this:  http://beta.lmfdb.org/EllipticCurve/2.2.89.1/81.1/a/ !!



---

archive/issue_comments_258364.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nSince the constant `(l-1)//2` appears in several places in the algorithm, I would prefer to see a variable assigned to it (let's call it `D` or whatever).",
    "created_at": "2015-06-04T09:48:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258364",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Since the constant `(l-1)//2` appears in several places in the algorithm, I would prefer to see a variable assigned to it (let's call it `D` or whatever).



---

archive/issue_comments_258365.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAlso, can't you avoid some conversions? In\n\n```\nF(f(m(x)).numerator())\n```\nthe call `m(x)` is really a conversion which should be done just once, probably best as `F(m)`. Then, I don't think the `F()` is needed and neither do you need `x`.",
    "created_at": "2015-06-04T09:58:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258365",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Also, can't you avoid some conversions? In

```
F(f(m(x)).numerator())
```
the call `m(x)` is really a conversion which should be done just once, probably best as `F(m)`. Then, I don't think the `F()` is needed and neither do you need `x`.



---

archive/issue_comments_258366.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nIn this loop,\n\n```\n        for i in range((l-1)/(2*d)-1):\n            g = mult(S[i])\n            S.append(g)\n            if g in factors:\n                factors.remove(g)\n```\nwhen can it happen that `g` is not in `factors`?",
    "created_at": "2015-06-04T10:04:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258366",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

In this loop,

```
        for i in range((l-1)/(2*d)-1):
            g = mult(S[i])
            S.append(g)
            if g in factors:
                factors.remove(g)
```
when can it happen that `g` is not in `factors`?



---

archive/issue_comments_258367.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@JohnCremona](#comment:9):\n> I thought that we did use resultants... but looking again at Kimi's code, the relevant function is mult() on line 1960:  the effect of this function is to take the polynomial f and the rational function m, under the assumption that f is coprime to the denominator of m, and return the poly whose roots are m(alpha) as alpha runs over the roots of f.  If m were a polynomial that would be res_Y(X-m(Y),f(Y)).  I can see now that we could stil use that formula with m(Y) replaced by the polynomial p(Y) which satisfies p*d=n (mod f) where m=n/d which would amount to one extended gcd and one resultant.  This may be better than the current code since it does not use rational functions.\n\nI don't quite get what you're saying here. I think I said \"resultants\" too quickly before looking at the actual code.\n\nMathematically, we need to compute\n\n```\ngcd( numerator( f(a/b) ), psi)\n```\nwhere `f`, `a`, `b`, `psi` are univariate polynomials and only `f` changes. I guess we know that the denominator of `f(a/b)` is `b^d` with `d` the degree of `f`. So we need\n\n```\ngcd( b^d f(a/b), psi)\n```\nNow suppose `c` is such that `a/b = c mod psi`, then we really need\n\n```\ngcd( b^d f(c), psi)\n```\nwhich equals\n\n```\ngcd(f(c), psi)\n```\nNow compute this in `R[x]/psi(x)` and this should be the most efficient way.\n\n(this was written up quickly, I haven't really checked that it's correct)",
    "created_at": "2015-06-04T10:13:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258367",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@JohnCremona](#comment:9):
> I thought that we did use resultants... but looking again at Kimi's code, the relevant function is mult() on line 1960:  the effect of this function is to take the polynomial f and the rational function m, under the assumption that f is coprime to the denominator of m, and return the poly whose roots are m(alpha) as alpha runs over the roots of f.  If m were a polynomial that would be res_Y(X-m(Y),f(Y)).  I can see now that we could stil use that formula with m(Y) replaced by the polynomial p(Y) which satisfies p*d=n (mod f) where m=n/d which would amount to one extended gcd and one resultant.  This may be better than the current code since it does not use rational functions.

I don't quite get what you're saying here. I think I said "resultants" too quickly before looking at the actual code.

Mathematically, we need to compute

```
gcd( numerator( f(a/b) ), psi)
```
where `f`, `a`, `b`, `psi` are univariate polynomials and only `f` changes. I guess we know that the denominator of `f(a/b)` is `b^d` with `d` the degree of `f`. So we need

```
gcd( b^d f(a/b), psi)
```
Now suppose `c` is such that `a/b = c mod psi`, then we really need

```
gcd( b^d f(c), psi)
```
which equals

```
gcd(f(c), psi)
```
Now compute this in `R[x]/psi(x)` and this should be the most efficient way.

(this was written up quickly, I haven't really checked that it's correct)



---

archive/issue_comments_258368.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nActually, my idea works, but it's not so efficient since you're working mod `psi` which is huge.",
    "created_at": "2015-06-04T10:25:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258368",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

Actually, my idea works, but it's not so efficient since you're working mod `psi` which is huge.



---

archive/issue_comments_258369.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI'm going to set this ticket to needs_work such that you can address the several minor points I mentioned (and answer [comment:17], which I need to understand the algorithm better). Never mind the computation of `mult()`.",
    "created_at": "2015-06-04T10:27:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258369",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

I'm going to set this ticket to needs_work such that you can address the several minor points I mentioned (and answer [comment:17], which I need to understand the algorithm better). Never mind the computation of `mult()`.



---

archive/issue_events_261860.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-04T10:27:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261860"
}
```



---

archive/issue_events_261861.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-04T10:27:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261861"
}
```



---

archive/issue_comments_258370.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@JohnCremona](#comment:8):\n> No, but it is Example 3.1.1 on page 28 of [KT2013] which is here: http://wrap.warwick.ac.uk/57568/\n> The example is over F_3 so is not slow.\n\nWouldn't it be a good testcase for the current code (both over F_3 and F_9)?",
    "created_at": "2015-06-04T10:35:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258370",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@JohnCremona](#comment:8):
> No, but it is Example 3.1.1 on page 28 of [KT2013] which is here: http://wrap.warwick.ac.uk/57568/
> The example is over F_3 so is not slow.

Wouldn't it be a good testcase for the current code (both over F_3 and F_9)?



---

archive/issue_comments_258371.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nSince you write `Every kernel polynomial is a product of irreducible factors of the division polynomial of the same degree`, could special case 2 apply by just considering the polynomials of a given degree?",
    "created_at": "2015-06-04T11:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258371",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Since you write `Every kernel polynomial is a product of irreducible factors of the division polynomial of the same degree`, could special case 2 apply by just considering the polynomials of a given degree?



---

archive/issue_comments_258372.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThanks for all the comments -- I was busy with other things so have not replied to them indiviually yet, but perhaps it would be clearer if I now did so!",
    "created_at": "2015-06-04T12:13:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258372",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:23" align="right">comment:23</div>

Thanks for all the comments -- I was busy with other things so have not replied to them indiviually yet, but perhaps it would be clearer if I now did so!



---

archive/issue_comments_258373.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jdemeyer](#comment:11):\n> In your code, \"special case 1\" is really a special case of \"special case 2\". For simplicity, I would therefore keep only special case 2.\n\nAgreed -- done.",
    "created_at": "2015-06-04T12:13:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258373",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jdemeyer](#comment:11):
> In your code, "special case 1" is really a special case of "special case 2". For simplicity, I would therefore keep only special case 2.

Agreed -- done.



---

archive/issue_comments_258374.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jdemeyer](#comment:12):\n> There is a pre-existing typo: `otain` instead of `obtain`.\n\nDone.",
    "created_at": "2015-06-04T12:14:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258374",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jdemeyer](#comment:12):
> There is a pre-existing typo: `otain` instead of `obtain`.

Done.



---

archive/issue_comments_258375.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment:13):\n> There is a redundant\n> \n> ```\n> from sage.misc.all import prod\n> ```\n\nDone.",
    "created_at": "2015-06-04T12:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258375",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment:13):
> There is a redundant
> 
> ```
> from sage.misc.all import prod
> ```

Done.



---

archive/issue_comments_258376.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jdemeyer](#comment:15):\n> Since the constant `(l-1)//2` appears in several places in the algorithm, I would prefer to see a variable assigned to it (let's call it `D` or whatever).\n\nDone -- I called it l2.",
    "created_at": "2015-06-04T12:16:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258376",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jdemeyer](#comment:15):
> Since the constant `(l-1)//2` appears in several places in the algorithm, I would prefer to see a variable assigned to it (let's call it `D` or whatever).

Done -- I called it l2.



---

archive/issue_comments_258377.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@jdemeyer](#comment:17):\n> In this loop,\n> \n> ```\n>         for i in range((l-1)/(2*d)-1):\n>             g = mult(S[i])\n>             S.append(g)\n>             if g in factors:\n>                 factors.remove(g)\n> ```\n> when can it happen that `g` is not in `factors`?\n\nVery good question!  I think it always happens, since the operation f --> mult(f) applies the multiplication-by-a map to the roots, so must take f to another irreducible factor of the same degree;  the fact being checked is that the resulting cycle has the correct length, which is (l-1)/2 divided by deg(f), so that the product of the f's in the cycle gives the kernel polynomial. [I will delete the check.]  I tried removing the check and got run-time errors, so my mathematics must be wrong...",
    "created_at": "2015-06-04T12:36:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258377",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@jdemeyer](#comment:17):
> In this loop,
> 
> ```
>         for i in range((l-1)/(2*d)-1):
>             g = mult(S[i])
>             S.append(g)
>             if g in factors:
>                 factors.remove(g)
> ```
> when can it happen that `g` is not in `factors`?

Very good question!  I think it always happens, since the operation f --> mult(f) applies the multiplication-by-a map to the roots, so must take f to another irreducible factor of the same degree;  the fact being checked is that the resulting cycle has the correct length, which is (l-1)/2 divided by deg(f), so that the product of the f's in the cycle gives the kernel polynomial. [I will delete the check.]  I tried removing the check and got run-time errors, so my mathematics must be wrong...



---

archive/issue_comments_258378.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@jdemeyer](#comment:22):\n> Since you write `Every kernel polynomial is a product of irreducible factors of the division polynomial of the same degree`, could special case 2 apply by just considering the polynomials of a given degree?\n\nYes:  if for some degree d dividing l2=(l-1)/2 there are exactly (l-1)/2d factors then their product must be a kernel poly.\n\nSome more theory:  each subgroup has l2 x-coordinates and the rational function m(x) permutes these in a single cycle (by definition of \"semi-primitive root\" as a class mod l which generates the multiplcative group modulo <-1>).  A kernel poly is a poly of degree l2 whose set of roots is invariant under this map.  Since the map is defined over the ground field, each of the x-coordinates in any subgroup has the same degree d over the base, so d is a divisor of l2 and the kernel poly is a product of l2/d polys of degree d.   On the other hand, an irreducible factor f of degree d (where d didvides l2) need not be a factor of a kernel poly, as the F_3 example with l=13 shows.  If that is the case then the orbit of f under mult() will be longer than l2/d and we will detect that after l2/d steps we have not returned to the start.  In this circumstance we will have removed l2/d factors from the list but this is only *part of* an orbit, so later on when we start with one of the remaining factors in that orbit, we may well iterate onto a factor which is already removed.\n\nThere, I have proved that g need not be in factors!  And more -- if we find a g which is not in factors then we have hit a part-orbit already seen so can break.",
    "created_at": "2015-06-04T13:02:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258378",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@jdemeyer](#comment:22):
> Since you write `Every kernel polynomial is a product of irreducible factors of the division polynomial of the same degree`, could special case 2 apply by just considering the polynomials of a given degree?

Yes:  if for some degree d dividing l2=(l-1)/2 there are exactly (l-1)/2d factors then their product must be a kernel poly.

Some more theory:  each subgroup has l2 x-coordinates and the rational function m(x) permutes these in a single cycle (by definition of "semi-primitive root" as a class mod l which generates the multiplcative group modulo <-1>).  A kernel poly is a poly of degree l2 whose set of roots is invariant under this map.  Since the map is defined over the ground field, each of the x-coordinates in any subgroup has the same degree d over the base, so d is a divisor of l2 and the kernel poly is a product of l2/d polys of degree d.   On the other hand, an irreducible factor f of degree d (where d didvides l2) need not be a factor of a kernel poly, as the F_3 example with l=13 shows.  If that is the case then the orbit of f under mult() will be longer than l2/d and we will detect that after l2/d steps we have not returned to the start.  In this circumstance we will have removed l2/d factors from the list but this is only *part of* an orbit, so later on when we start with one of the remaining factors in that orbit, we may well iterate onto a factor which is already removed.

There, I have proved that g need not be in factors!  And more -- if we find a g which is not in factors then we have hit a part-orbit already seen so can break.



---

archive/issue_comments_258379.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@JohnCremona](#comment:28):\n> Very good question!  I think it always happens, since the operation f --> mult(f) applies the multiplication-by-a map to the roots, so must take f to another irreducible factor of the same degree;  the fact being checked is that the resulting cycle has the correct length, which is (l-1)/2 divided by deg(f), so that the product of the f's in the cycle gives the kernel polynomial. [I will delete the check.]  I tried removing the check and got run-time errors, so my mathematics must be wrong...\n\nI also used the same thinking as you, and I also don't understand the problem...",
    "created_at": "2015-06-04T13:07:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258379",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@JohnCremona](#comment:28):
> Very good question!  I think it always happens, since the operation f --> mult(f) applies the multiplication-by-a map to the roots, so must take f to another irreducible factor of the same degree;  the fact being checked is that the resulting cycle has the correct length, which is (l-1)/2 divided by deg(f), so that the product of the f's in the cycle gives the kernel polynomial. [I will delete the check.]  I tried removing the check and got run-time errors, so my mathematics must be wrong...

I also used the same thinking as you, and I also don't understand the problem...



---

archive/issue_comments_258380.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@jdemeyer](#comment:30):\n> Replying to [@JohnCremona](#comment:28):\n> > Very good question!  I think it always happens, since the operation f --> mult(f) applies the multiplication-by-a map to the roots, so must take f to another irreducible factor of the same degree;  the fact being checked is that the resulting cycle has the correct length, which is (l-1)/2 divided by deg(f), so that the product of the f's in the cycle gives the kernel polynomial. [I will delete the check.]  I tried removing the check and got run-time errors, so my mathematics must be wrong...\n\n> \n> I also used the same thinking as you, and I also don't understand the problem...\n\nSee comment 29!",
    "created_at": "2015-06-04T13:24:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258380",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@jdemeyer](#comment:30):
> Replying to [@JohnCremona](#comment:28):
> > Very good question!  I think it always happens, since the operation f --> mult(f) applies the multiplication-by-a map to the roots, so must take f to another irreducible factor of the same degree;  the fact being checked is that the resulting cycle has the correct length, which is (l-1)/2 divided by deg(f), so that the product of the f's in the cycle gives the kernel polynomial. [I will delete the check.]  I tried removing the check and got run-time errors, so my mathematics must be wrong...

> 
> I also used the same thinking as you, and I also don't understand the problem...

See comment 29!



---

archive/issue_comments_258381.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nOK, I have done quite a rewrite which makes the logic much clearer (I think) and also treats all the special cases together.  New commit soon...",
    "created_at": "2015-06-04T13:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258381",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:32" align="right">comment:32</div>

OK, I have done quite a rewrite which makes the logic much clearer (I think) and also treats all the special cases together.  New commit soon...



---

archive/issue_comments_258382.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@JohnCremona](#comment:14):\n> Without the patch though I would not have been able to compute this:  http://beta.lmfdb.org/EllipticCurve/2.2.89.1/81.1/a/ !!\n\nI'm actually curious why you get a huge speed-up here. I can see that the patch here improves things, but to go from \"not being able to compute\" to \"being able to compute\" surprises me. Doesn't the computation and factoring of the division polynomial dominate the whole computation anyway?",
    "created_at": "2015-06-04T13:38:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258382",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@JohnCremona](#comment:14):
> Without the patch though I would not have been able to compute this:  http://beta.lmfdb.org/EllipticCurve/2.2.89.1/81.1/a/ !!

I'm actually curious why you get a huge speed-up here. I can see that the patch here improves things, but to go from "not being able to compute" to "being able to compute" surprises me. Doesn't the computation and factoring of the division polynomial dominate the whole computation anyway?



---

archive/issue_comments_258383.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@jdemeyer](#comment:33):\n> Replying to [@JohnCremona](#comment:14):\n> > Without the patch though I would not have been able to compute this:  http://beta.lmfdb.org/EllipticCurve/2.2.89.1/81.1/a/ !!\n\n> \n> I'm actually curious why you get a huge speed-up here. I can see that the patch here improves things, but to go from \"not being able to compute\" to \"being able to compute\" surprises me. Doesn't the computation and factoring of the division polynomial dominate the whole computation anyway?\n\nIts computation is short, and its factoring takes < 1 hour.  In the code I had, computing the complete isogeny class of 4 curves, I had to do that 4 times.  (I am working on not having to recompute the kernel polys for other curves in the isogeny class, but that will definitely be another ticket).  I also had some lines like E1.is_isogenous(E2,proof=True) which triggered computation of the whole isogeny class of E1.  (With proof=False it just checks traces of Frobenius but I also had curves which were not isogenous but whose traces agreed at a lot of primes, so was playing safe).",
    "created_at": "2015-06-04T14:04:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258383",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@jdemeyer](#comment:33):
> Replying to [@JohnCremona](#comment:14):
> > Without the patch though I would not have been able to compute this:  http://beta.lmfdb.org/EllipticCurve/2.2.89.1/81.1/a/ !!

> 
> I'm actually curious why you get a huge speed-up here. I can see that the patch here improves things, but to go from "not being able to compute" to "being able to compute" surprises me. Doesn't the computation and factoring of the division polynomial dominate the whole computation anyway?

Its computation is short, and its factoring takes < 1 hour.  In the code I had, computing the complete isogeny class of 4 curves, I had to do that 4 times.  (I am working on not having to recompute the kernel polys for other curves in the isogeny class, but that will definitely be another ticket).  I also had some lines like E1.is_isogenous(E2,proof=True) which triggered computation of the whole isogeny class of E1.  (With proof=False it just checks traces of Frobenius but I also had curves which were not isogenous but whose traces agreed at a lot of primes, so was playing safe).



---

archive/issue_comments_258384.json:
```json
{
    "body": "Changed commit from **[`47ccfd5`](https://github.com/sagemath/sagetrac-mirror/commit/47ccfd587402b953c612fcd3cddaa541a6847bd3)** to **[`ad56369`](https://github.com/sagemath/sagetrac-mirror/commit/ad56369f5def8060575b6567342dedb28a447293)**",
    "created_at": "2015-06-04T14:36:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258384",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`47ccfd5`](https://github.com/sagemath/sagetrac-mirror/commit/47ccfd587402b953c612fcd3cddaa541a6847bd3)** to **[`ad56369`](https://github.com/sagemath/sagetrac-mirror/commit/ad56369f5def8060575b6567342dedb28a447293)**



---

archive/issue_comments_258385.json:
```json
{
    "body": "<div id=\"comment:35\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ad56369f5def8060575b6567342dedb28a447293\"><code>ad56369</code></a></td><td><code>#18589 simplified code + further improvements</code></td></tr></table>\n",
    "created_at": "2015-06-04T14:36:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258385",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:35"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ad56369f5def8060575b6567342dedb28a447293"><code>ad56369</code></a></td><td><code>#18589 simplified code + further improvements</code></td></tr></table>




---

archive/issue_events_261862.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-04T14:38:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261862"
}
```



---

archive/issue_events_261863.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-04T14:38:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261863"
}
```



---

archive/issue_comments_258386.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nPlease take a look at this.  the code is (I hope) simpler to understand, deals with factors of each degree separately, and has more explanatory comments.  I experimented with a couple of other version of mult(), one of which is there but commented out, but they were no faster.  I also added a new example as discussed above.",
    "created_at": "2015-06-04T14:38:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258386",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:36" align="right">comment:36</div>

Please take a look at this.  the code is (I hope) simpler to understand, deals with factors of each degree separately, and has more explanatory comments.  I experimented with a couple of other version of mult(), one of which is there but commented out, but they were no faster.  I also added a new example as discussed above.



---

archive/issue_comments_258387.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@JohnCremona](#comment:34):\n> Its computation is short, and its factoring takes < 1 hour.\n\nThen why did the computation of the isogenies without this patch take days? What was the bottleneck? I find it hard to believe that the calls to `mult()` can take so much time.",
    "created_at": "2015-06-04T14:42:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258387",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@JohnCremona](#comment:34):
> Its computation is short, and its factoring takes < 1 hour.

Then why did the computation of the isogenies without this patch take days? What was the bottleneck? I find it hard to believe that the calls to `mult()` can take so much time.



---

archive/issue_comments_258388.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nIn the current implementation, you are computing\n\n```\n    from sage.rings.arith import gcd\n    a = _least_semi_primitive(l)\n    m = E.multiplication_by_m(a, x_only=True)\n    F = psi_l.parent()\n    x = F.gen()\n    d = F(m.denominator())\n    n = F(m.numerator())\n```\neven when `factors_by_degree` is empty.\n\nAn easy optimization would be\n\n```\nif all(factors == [] for factors in factors_by_degree):\n    return ...\n```\njust before that block.",
    "created_at": "2015-06-04T14:51:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258388",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

In the current implementation, you are computing

```
    from sage.rings.arith import gcd
    a = _least_semi_primitive(l)
    m = E.multiplication_by_m(a, x_only=True)
    F = psi_l.parent()
    x = F.gen()
    d = F(m.denominator())
    n = F(m.numerator())
```
even when `factors_by_degree` is empty.

An easy optimization would be

```
if all(factors == [] for factors in factors_by_degree):
    return ...
```
just before that block.



---

archive/issue_comments_258389.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nI think you can simplify\n\n```\nfactors = [h for h,e in psi_l.factor() if l2 % h.degree() == 0]\n```\nto\n\n```\nfactors = [h for h,e in psi_l.factor()]\n```\n(in the line below, you are only selecting the degrees you care about anyway)",
    "created_at": "2015-06-04T14:53:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258389",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

I think you can simplify

```
factors = [h for h,e in psi_l.factor() if l2 % h.degree() == 0]
```
to

```
factors = [h for h,e in psi_l.factor()]
```
(in the line below, you are only selecting the degrees you care about anyway)



---

archive/issue_comments_258390.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@jdemeyer](#comment:37):\n> Replying to [@JohnCremona](#comment:34):\n> > Its computation is short, and its factoring takes < 1 hour.\n\n> Then why did the computation of the isogenies without this patch take days? What was the bottleneck? I find it hard to believe that the calls to `mult()` can take so much time.\n\nMe too, but as I tried to explain the script I was running was computing the isogeny class many times.  I am rerunning just E.isogeny_class() under 6.7 now and will report back (but this ticket need not wait).",
    "created_at": "2015-06-04T15:25:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258390",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@jdemeyer](#comment:37):
> Replying to [@JohnCremona](#comment:34):
> > Its computation is short, and its factoring takes < 1 hour.

> Then why did the computation of the isogenies without this patch take days? What was the bottleneck? I find it hard to believe that the calls to `mult()` can take so much time.

Me too, but as I tried to explain the script I was running was computing the isogeny class many times.  I am rerunning just E.isogeny_class() under 6.7 now and will report back (but this ticket need not wait).



---

archive/issue_comments_258391.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@jdemeyer](#comment:39):\n> I think you can simplify\n> \n> ```\n> factors = [h for h,e in psi_l.factor() if l2 % h.degree() == 0]\n> ```\n> to\n> \n> ```\n> factors = [h for h,e in psi_l.factor()]\n> ```\n> (in the line below, you are only selecting the degrees you care about anyway)\n\nFine, I will make these simplifications!",
    "created_at": "2015-06-04T15:26:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258391",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@jdemeyer](#comment:39):
> I think you can simplify
> 
> ```
> factors = [h for h,e in psi_l.factor() if l2 % h.degree() == 0]
> ```
> to
> 
> ```
> factors = [h for h,e in psi_l.factor()]
> ```
> (in the line below, you are only selecting the degrees you care about anyway)

Fine, I will make these simplifications!



---

archive/issue_comments_258392.json:
```json
{
    "body": "<div id=\"comment:42\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499\"><code>2f83c20</code></a></td><td><code>#18589: 2 simplifications following review</code></td></tr></table>\n",
    "created_at": "2015-06-04T15:39:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258392",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:42"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499"><code>2f83c20</code></a></td><td><code>#18589: 2 simplifications following review</code></td></tr></table>




---

archive/issue_comments_258393.json:
```json
{
    "body": "Changed commit from **[`ad56369`](https://github.com/sagemath/sagetrac-mirror/commit/ad56369f5def8060575b6567342dedb28a447293)** to **[`2f83c20`](https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499)**",
    "created_at": "2015-06-04T15:39:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258393",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ad56369`](https://github.com/sagemath/sagetrac-mirror/commit/ad56369f5def8060575b6567342dedb28a447293)** to **[`2f83c20`](https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499)**



---

archive/issue_comments_258394.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2015-06-04T15:41:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258394",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_258395.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@JohnCremona](#comment:40):\n> Me too, but as I tried to explain the script I was running was computing the isogeny class many times.  I am rerunning just E.isogeny_class() under 6.7 now and will report back (but this ticket need not wait).\n\nI agree that this ticket makes sense by itself. It's just that it only does some easy optimizations, it doesn't fundamentally improve the algorithm.\n\nI have been thinking a bit about the computation of `mult()` this afternoon and I might have an idea to compute `mult^-1(f)` (that is, find `g` such that `mult(g) == f`) much faster than the current `mult()`. Of course, theoretically, `mult()` and `mult^-1()` play the same role.\n\nI'm wondering if it's worth pursuing further and for that I need to know if `mult()` is ever the bottleneck of the algorithm. (this is of course for a hypothetical follow-up ticket)",
    "created_at": "2015-06-04T15:41:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258395",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@JohnCremona](#comment:40):
> Me too, but as I tried to explain the script I was running was computing the isogeny class many times.  I am rerunning just E.isogeny_class() under 6.7 now and will report back (but this ticket need not wait).

I agree that this ticket makes sense by itself. It's just that it only does some easy optimizations, it doesn't fundamentally improve the algorithm.

I have been thinking a bit about the computation of `mult()` this afternoon and I might have an idea to compute `mult^-1(f)` (that is, find `g` such that `mult(g) == f`) much faster than the current `mult()`. Of course, theoretically, `mult()` and `mult^-1()` play the same role.

I'm wondering if it's worth pursuing further and for that I need to know if `mult()` is ever the bottleneck of the algorithm. (this is of course for a hypothetical follow-up ticket)



---

archive/issue_comments_258396.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@sagetrac-git](#comment:42):\n> Branch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499\"><code>2f83c20</code></a></td><td><code>#18589: 2 simplifications following review</code></td></tr></table>\n\nThe check `not factors_by_degree` only checks that the dict has no keys, but you really need to check that all values are empty lists:\n\n```\nall(factors == [] for factors in factors_by_degree.values())\n```",
    "created_at": "2015-06-04T15:44:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258396",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@sagetrac-git](#comment:42):
> Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499"><code>2f83c20</code></a></td><td><code>#18589: 2 simplifications following review</code></td></tr></table>

The check `not factors_by_degree` only checks that the dict has no keys, but you really need to check that all values are empty lists:

```
all(factors == [] for factors in factors_by_degree.values())
```



---

archive/issue_events_261864.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-04T15:44:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261864"
}
```



---

archive/issue_events_261865.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-04T15:44:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261865"
}
```



---

archive/issue_comments_258397.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@jdemeyer](#comment:43):\n> Replying to [@JohnCremona](#comment:40):\n> > Me too, but as I tried to explain the script I was running was computing the isogeny class many times.  I am rerunning just E.isogeny_class() under 6.7 now and will report back (but this ticket need not wait).\n\n> \n> I agree that this ticket makes sense by itself. It's just that it only does some easy optimizations, it doesn't fundamentally improve the algorithm.\n\nAgreed.\n\n> \n> I have been thinking a bit about the computation of `mult()` this afternoon and I might have an idea to compute `mult^-1(f)` (that is, find `g` such that `mult(g) == f`) much faster than the current `mult()`. Of course, theoretically, `mult()` and `mult^-1()` play the same role.\n\nThat is true -- you can use either.  You can see in Prop 3.3.1 of the thesis that both are natural!  It would be good to improve this.\n\n> \n> I'm wondering if it's worth pursuing further and for that I need to know if `mult()` is ever the bottleneck of the algorithm. (this is of course for a hypothetical follow-up ticket)",
    "created_at": "2015-06-04T15:45:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258397",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@jdemeyer](#comment:43):
> Replying to [@JohnCremona](#comment:40):
> > Me too, but as I tried to explain the script I was running was computing the isogeny class many times.  I am rerunning just E.isogeny_class() under 6.7 now and will report back (but this ticket need not wait).

> 
> I agree that this ticket makes sense by itself. It's just that it only does some easy optimizations, it doesn't fundamentally improve the algorithm.

Agreed.

> 
> I have been thinking a bit about the computation of `mult()` this afternoon and I might have an idea to compute `mult^-1(f)` (that is, find `g` such that `mult(g) == f`) much faster than the current `mult()`. Of course, theoretically, `mult()` and `mult^-1()` play the same role.

That is true -- you can use either.  You can see in Prop 3.3.1 of the thesis that both are natural!  It would be good to improve this.

> 
> I'm wondering if it's worth pursuing further and for that I need to know if `mult()` is ever the bottleneck of the algorithm. (this is of course for a hypothetical follow-up ticket)



---

archive/issue_comments_258398.json:
```json
{
    "body": "Changed commit from **[`2f83c20`](https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499)** to **[`3d687e5`](https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62)**",
    "created_at": "2015-06-04T15:50:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258398",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2f83c20`](https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499)** to **[`3d687e5`](https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62)**



---

archive/issue_comments_258399.json:
```json
{
    "body": "<div id=\"comment:46\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62\"><code>3d687e5</code></a></td><td><code>#18589 further one-liner</code></td></tr></table>\n",
    "created_at": "2015-06-04T15:50:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258399",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:46"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62"><code>3d687e5</code></a></td><td><code>#18589 further one-liner</code></td></tr></table>




---

archive/issue_comments_258400.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nReplying to [@jdemeyer](#comment:44):\n> Replying to [@sagetrac-git](#comment:42):\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n\n> |                                                                                                                                                 |                                            |\n> |-------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n> |[2f83c20](https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499)|`#18589: 2 simplifications following review`|\n> \n> The check `not factors_by_degree` only checks that the dict has no keys, but you really need to check that all values are empty lists:\n> \n> ```\n> all(factors == [] for factors in factors_by_degree.values())\n> ```\n\nYou are right, I had forgotten that in creating the dict it might have had some empty lists.  I should have known better than to do more simplifaction than you recommended!\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62\"><code>3d687e5</code></a></td><td><code>#18589 further one-liner</code></td></tr></table>\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62\"><code>3d687e5</code></a></td><td><code>#18589 further one-liner</code></td></tr></table>\n",
    "created_at": "2015-06-04T15:50:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258400",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:47" align="right">comment:47</div>

Replying to [@jdemeyer](#comment:44):
> Replying to [@sagetrac-git](#comment:42):
> > Branch pushed to git repo; I updated commit sha1. New commits:

> |                                                                                                                                                 |                                            |
> |-------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
> |[2f83c20](https://github.com/sagemath/sagetrac-mirror/commit/2f83c20a3753b9141c635ab26ed88015a9fed499)|`#18589: 2 simplifications following review`|
> 
> The check `not factors_by_degree` only checks that the dict has no keys, but you really need to check that all values are empty lists:
> 
> ```
> all(factors == [] for factors in factors_by_degree.values())
> ```

You are right, I had forgotten that in creating the dict it might have had some empty lists.  I should have known better than to do more simplifaction than you recommended!

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62"><code>3d687e5</code></a></td><td><code>#18589 further one-liner</code></td></tr></table>

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62"><code>3d687e5</code></a></td><td><code>#18589 further one-liner</code></td></tr></table>




---

archive/issue_events_261866.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-04T15:51:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261866"
}
```



---

archive/issue_events_261867.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2015-06-04T15:51:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261867"
}
```



---

archive/issue_comments_258401.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nAny further changes will have to wait until tomorrow....",
    "created_at": "2015-06-04T15:51:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258401",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:48" align="right">comment:48</div>

Any further changes will have to wait until tomorrow....



---

archive/issue_comments_258402.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nFurther work: #18611",
    "created_at": "2015-06-04T19:45:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258402",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:49" align="right">comment:49</div>

Further work: #18611



---

archive/issue_events_261868.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-04T19:45:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261868"
}
```



---

archive/issue_events_261869.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-04T19:45:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261869"
}
```



---

archive/issue_comments_258403.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nMany thanks for a fantastic job reviewing this ( excelletn in both mathematical and coding aspects).  I will continue the discussion over at #18611.\n\nI suspect that there have been other changes since 6.7 which have sped up my l=89 example, to do with factoring the 89-division polynomial over a quadratic field.  As you say, one computation of mult() could not take such a long time even before this patch, yet a single run of E.isogenies_prime_degree(89) is stil running after 14 hours, and all that has to do is run isogenies_prime_degree_general once with l=89.",
    "created_at": "2015-06-05T08:10:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258403",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:50" align="right">comment:50</div>

Many thanks for a fantastic job reviewing this ( excelletn in both mathematical and coding aspects).  I will continue the discussion over at #18611.

I suspect that there have been other changes since 6.7 which have sped up my l=89 example, to do with factoring the 89-division polynomial over a quadratic field.  As you say, one computation of mult() could not take such a long time even before this patch, yet a single run of E.isogenies_prime_degree(89) is stil running after 14 hours, and all that has to do is run isogenies_prime_degree_general once with l=89.



---

archive/issue_comments_258404.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nReplying to [@JohnCremona](#comment:50):\n> yet a single run of E.isogenies_prime_degree(89) is stil running after 14 hours\n\nCan you interrupt (CTRL-C) it and look at the traceback to see what it's doing?",
    "created_at": "2015-06-05T08:28:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258404",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:51" align="right">comment:51</div>

Replying to [@JohnCremona](#comment:50):
> yet a single run of E.isogenies_prime_degree(89) is stil running after 14 hours

Can you interrupt (CTRL-C) it and look at the traceback to see what it's doing?



---

archive/issue_comments_258405.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nReplying to [@jdemeyer](#comment:51):\n> Replying to [@JohnCremona](#comment:50):\n> > yet a single run of E.isogenies_prime_degree(89) is stil running after 14 hours\n\n> \n> Can you interrupt (CTRL-C) it and look at the traceback to see what it's doing?\n\nAs expected:  it is in the lines \n\n```\n-> 1939         if mult(S[-1]) == f:\n```\nand \n\n```\n-> 1928         return gcd(F(f(m(x)).numerator()),psi_l).monic()\n```\nand\n\n```\n-> 1588             return a.gcd(b, **kwargs)\n```\nand below that\n\n```\n/usr/local/sage/sage-2/src/sage/rings/polynomial/polynomial_number_field.pyx in sage.rings.poly\nnomial.polynomial_number_field.Polynomial_absolute_number_field_dense.gcd (build/cythonized/sag\ne/rings/polynomial/polynomial_number_field.c:1761)()\n    203         h1 = self._pari_with_name('x')\n    204         h2 = other._pari_with_name('x')\n--> 205         g = h1.gcd(h2)\n```\nand at the bottom, pari/gen.pyx",
    "created_at": "2015-06-05T08:36:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258405",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:52" align="right">comment:52</div>

Replying to [@jdemeyer](#comment:51):
> Replying to [@JohnCremona](#comment:50):
> > yet a single run of E.isogenies_prime_degree(89) is stil running after 14 hours

> 
> Can you interrupt (CTRL-C) it and look at the traceback to see what it's doing?

As expected:  it is in the lines 

```
-> 1939         if mult(S[-1]) == f:
```
and 

```
-> 1928         return gcd(F(f(m(x)).numerator()),psi_l).monic()
```
and

```
-> 1588             return a.gcd(b, **kwargs)
```
and below that

```
/usr/local/sage/sage-2/src/sage/rings/polynomial/polynomial_number_field.pyx in sage.rings.poly
nomial.polynomial_number_field.Polynomial_absolute_number_field_dense.gcd (build/cythonized/sag
e/rings/polynomial/polynomial_number_field.c:1761)()
    203         h1 = self._pari_with_name('x')
    204         h2 = other._pari_with_name('x')
--> 205         g = h1.gcd(h2)
```
and at the bottom, pari/gen.pyx



---

archive/issue_comments_258406.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nThanks for the info.\n\nInteresting, it looks like the `gcd()` computation in `mult()` takes so much time. I would assume that some kind of coefficient explosion occurs.",
    "created_at": "2015-06-05T08:51:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258406",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:53" align="right">comment:53</div>

Thanks for the info.

Interesting, it looks like the `gcd()` computation in `mult()` takes so much time. I would assume that some kind of coefficient explosion occurs.



---

archive/issue_comments_258407.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [@jdemeyer](#comment:53):\n> Thanks for the info.\n> \n> Interesting, it looks like the `gcd()` computation in `mult()` takes so much time. I would assume that some kind of coefficient explosion occurs.\n\nI think that the real point here is http://trac.sagemath.org/ticket/18461 which re-implemented univariate polynomial gcd!  So it is possible that without any of the changes on this ticket or #18611 we would have seen anoticeable improvement.  Anyway, between these two tickets we certainly have more efficient code so the exercise was worth carrying out.  Thanks!",
    "created_at": "2015-06-05T08:57:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258407",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [@jdemeyer](#comment:53):
> Thanks for the info.
> 
> Interesting, it looks like the `gcd()` computation in `mult()` takes so much time. I would assume that some kind of coefficient explosion occurs.

I think that the real point here is http://trac.sagemath.org/ticket/18461 which re-implemented univariate polynomial gcd!  So it is possible that without any of the changes on this ticket or #18611 we would have seen anoticeable improvement.  Anyway, between these two tickets we certainly have more efficient code so the exercise was worth carrying out.  Thanks!



---

archive/issue_comments_258408.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [@JohnCremona](#comment:54):\n> Replying to [@jdemeyer](#comment:53):\n> > Thanks for the info.\n> > \n> > Interesting, it looks like the `gcd()` computation in `mult()` takes so much time. I would assume that some kind of coefficient explosion occurs.\n\n> I think that the real point here is http://trac.sagemath.org/ticket/18461 which re-implemented univariate polynomial gcd!\n\nFrom the traceback, you see that PARI is used to compute this gcd, so the generic Sage code doesn't matter.",
    "created_at": "2015-06-05T09:11:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258408",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [@JohnCremona](#comment:54):
> Replying to [@jdemeyer](#comment:53):
> > Thanks for the info.
> > 
> > Interesting, it looks like the `gcd()` computation in `mult()` takes so much time. I would assume that some kind of coefficient explosion occurs.

> I think that the real point here is http://trac.sagemath.org/ticket/18461 which re-implemented univariate polynomial gcd!

From the traceback, you see that PARI is used to compute this gcd, so the generic Sage code doesn't matter.



---

archive/issue_comments_258409.json:
```json
{
    "body": "Changed branch from **[u/cremona/18589](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18589)** to **[`3d687e5`](https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62)**",
    "created_at": "2015-06-06T12:47:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18589#issuecomment-258409",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/cremona/18589](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/18589)** to **[`3d687e5`](https://github.com/sagemath/sagetrac-mirror/commit/3d687e5225f67808eb6c5af5fbf4cb93f2000c62)**



---

archive/issue_events_261870.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-06T12:47:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261870"
}
```



---

archive/issue_events_261871.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "c4d77304ecc95b71f85c95ed927073047fa1db48",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-06-06T12:47:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18589",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18589#event-261871"
}
```
