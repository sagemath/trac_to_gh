# Issue 18593: Relative tolerance in French Sage book

archive/issues_018356.json:
```json
{
    "body": "A doctest from the French Sage book just barely fails in SageMathCloud (Intel Haswell, iirc).\n\n**CC:**  @zimmermann6 @ClementPernet\n\n**Keywords:** french book doctest tolerance\n\n**Branch/Commit:** [bf5b521bcbba59895cfae220284a3bc6ec05d12e](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)\n\n**Reviewer:** Marc Mezzarobba\n\n**Author:** Rob Beezer\n\nIssue created by migration from https://trac.sagemath.org/ticket/18593\n\n",
    "closed_at": "2015-06-03T23:22:30Z",
    "created_at": "2015-06-02T22:05:33Z",
    "labels": [
        "component: documentation",
        "trivial",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.8",
    "title": "Relative tolerance in French Sage book",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/18593",
    "user": "https://github.com/rbeezer"
}
```
A doctest from the French Sage book just barely fails in SageMathCloud (Intel Haswell, iirc).

**CC:**  @zimmermann6 @ClementPernet

**Keywords:** french book doctest tolerance

**Branch/Commit:** [bf5b521bcbba59895cfae220284a3bc6ec05d12e](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)

**Reviewer:** Marc Mezzarobba

**Author:** Rob Beezer

Issue created by migration from https://trac.sagemath.org/ticket/18593





---

archive/issue_comments_260954.json:
```json
{
    "body": "**Author:** Rob Beezer",
    "created_at": "2015-06-02T22:12:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260954",
    "user": "https://github.com/rbeezer"
}
```

**Author:** Rob Beezer



---

archive/issue_events_167210.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:12:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-167210"
}
```



---

archive/issue_comments_260955.json:
```json
{
    "body": "**Branch:** [u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)",
    "created_at": "2015-06-02T22:12:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260955",
    "user": "https://github.com/rbeezer"
}
```

**Branch:** [u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)



---

archive/issue_comments_260956.json:
```json
{
    "body": "**Commit:** [bf5b521bcbba59895cfae220284a3bc6ec05d12e](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)",
    "created_at": "2015-06-02T22:12:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260956",
    "user": "https://github.com/rbeezer"
}
```

**Commit:** [bf5b521bcbba59895cfae220284a3bc6ec05d12e](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)



---

archive/issue_comments_260957.json:
```json
{
    "body": "<a id='comment:1'></a>\nIncreased the tolerance by an order of magnitude, so test now passes.\n\nPaul - feel free to cc the relevant section author!  Mostly experimenting making a contribution from with SageMathCloud, but thought it best to kill this one (repeated) failure.  Thanks, Rob\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e\">bf5b521</a></td><td><code>18593: Relative tolerance on linear system in French Sage book</code></td></tr></table>\n",
    "created_at": "2015-06-02T22:12:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260957",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:1'></a>
Increased the tolerance by an order of magnitude, so test now passes.

Paul - feel free to cc the relevant section author!  Mostly experimenting making a contribution from with SageMathCloud, but thought it best to kill this one (repeated) failure.  Thanks, Rob

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e">bf5b521</a></td><td><code>18593: Relative tolerance on linear system in French Sage book</code></td></tr></table>




---

archive/issue_events_167211.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:18:23Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "rename": {
        "from": "Realtive tolerance in French Sage book",
        "to": "Relative tolerance in French Sage book"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-167211"
}
```



---

archive/issue_comments_260958.json:
```json
{
    "body": "<a id='comment:2'></a>\nFixed typo in ticket title.  ;-)",
    "created_at": "2015-06-02T22:18:23Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260958",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:2'></a>
Fixed typo in ticket title.  ;-)



---

archive/issue_events_167212.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2015-06-03T06:37:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-167212"
}
```



---

archive/issue_events_167213.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2015-06-03T06:37:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-167213"
}
```



---

archive/issue_comments_260959.json:
```json
{
    "body": "**Reviewer:** Marc Mezzarobba",
    "created_at": "2015-06-03T06:37:08Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260959",
    "user": "https://github.com/mezzarobba"
}
```

**Reviewer:** Marc Mezzarobba



---

archive/issue_comments_260960.json:
```json
{
    "body": "<a id='comment:4'></a>\njust curious, I'd like to investigate more. Here is what I get with Sage 6.8.beta1 on my workstation:\n\n```\nsage: A = matrix(RDF, [[1,3,2],[1,4,2],[0,5,2],[1,3,2]]); A\n[1.0 3.0 2.0]\n[1.0 4.0 2.0]\n[0.0 5.0 2.0]\n[1.0 3.0 2.0]\nsage: b = vector(RDF, [1,2,3,4]); b\n(1.0, 2.0, 3.0, 4.0)\nsage: transpose(A)\n[1.0 1.0 0.0 1.0]\n[3.0 4.0 5.0 3.0]\n[2.0 2.0 2.0 2.0]\nsage: R = transpose(A)*b; R\n(7.0, 38.0, 20.0)\nsage: Z = transpose(A)*A; Z\n[ 3.0 10.0  6.0]\n[10.0 59.0 30.0]\n[ 6.0 30.0 16.0]\nsage: Z.solve_right(R)\n(-1.5000000000000049, -0.5000000000000011, 2.750000000000004)\nsage: from sage.misc.citation import get_systems\nsage: get_systems('Z.solve_right(R)')\n['numpy', 'scipy']\n```\nWhat do you get on the machine where the test did fail?\n\nPaul",
    "created_at": "2015-06-03T07:12:46Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260960",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:4'></a>
just curious, I'd like to investigate more. Here is what I get with Sage 6.8.beta1 on my workstation:

```
sage: A = matrix(RDF, [[1,3,2],[1,4,2],[0,5,2],[1,3,2]]); A
[1.0 3.0 2.0]
[1.0 4.0 2.0]
[0.0 5.0 2.0]
[1.0 3.0 2.0]
sage: b = vector(RDF, [1,2,3,4]); b
(1.0, 2.0, 3.0, 4.0)
sage: transpose(A)
[1.0 1.0 0.0 1.0]
[3.0 4.0 5.0 3.0]
[2.0 2.0 2.0 2.0]
sage: R = transpose(A)*b; R
(7.0, 38.0, 20.0)
sage: Z = transpose(A)*A; Z
[ 3.0 10.0  6.0]
[10.0 59.0 30.0]
[ 6.0 30.0 16.0]
sage: Z.solve_right(R)
(-1.5000000000000049, -0.5000000000000011, 2.750000000000004)
sage: from sage.misc.citation import get_systems
sage: get_systems('Z.solve_right(R)')
['numpy', 'scipy']
```
What do you get on the machine where the test did fail?

Paul



---

archive/issue_comments_260961.json:
```json
{
    "body": "<a id='comment:5'></a>\nOne should not expect the numerical garbage to be reproducible when changing architectures: even if basic operations are compliant with the IEEE norm, the way they are scheduled (by the compiler or programmer) impacts the numerical noise.\nLooking at the condition number (1222), we can assume that up to 3 digits can be lost. So the bug was indeed that the tolerance was probably set to a too low value.\n\nI ran directly the LAPACK degesv implementation of GotoBLAS-2.11 on various architectures and got the following values:\n\nx = [-1.5000000000000067 ,-0.50000000000000389 ,2.7500000000000098] for Intel Haswell, SandyBridge and Westmere, AMD K8, \nx = [-1.4999999999999918 ,-0.49999999999999678 ,2.7499999999999911] for AMD Bulldozer\nx = [-1.5000000000000135 ,-0.50000000000000855 ,2.7500000000000213] for AMD K10",
    "created_at": "2015-06-03T09:25:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260961",
    "user": "https://github.com/ClementPernet"
}
```

<a id='comment:5'></a>
One should not expect the numerical garbage to be reproducible when changing architectures: even if basic operations are compliant with the IEEE norm, the way they are scheduled (by the compiler or programmer) impacts the numerical noise.
Looking at the condition number (1222), we can assume that up to 3 digits can be lost. So the bug was indeed that the tolerance was probably set to a too low value.

I ran directly the LAPACK degesv implementation of GotoBLAS-2.11 on various architectures and got the following values:

x = [-1.5000000000000067 ,-0.50000000000000389 ,2.7500000000000098] for Intel Haswell, SandyBridge and Westmere, AMD K8, 
x = [-1.4999999999999918 ,-0.49999999999999678 ,2.7499999999999911] for AMD Bulldozer
x = [-1.5000000000000135 ,-0.50000000000000855 ,2.7500000000000213] for AMD K10



---

archive/issue_comments_260962.json:
```json
{
    "body": "<a id='comment:6'></a>\nindeed the -0.50000000000000855 middle value on AMD K10 gives a relative error of 1.53e-14, which is larger than the previous tolerance of 1e-14.",
    "created_at": "2015-06-03T11:02:39Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260962",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:6'></a>
indeed the -0.50000000000000855 middle value on AMD K10 gives a relative error of 1.53e-14, which is larger than the previous tolerance of 1e-14.



---

archive/issue_comments_260963.json:
```json
{
    "body": "<a id='comment:7'></a>\nPaul - Sorry to have been incomplete on this one.  Indeed, the failure looks just like the AMD K10 \"middle one.\"\n\nMarc - thanks for the review!\n\n```\nFile \"src/sage/tests/french_book/linsolve_doctest.py\", line 86, in sage.tests.french_book.linsolve_doctest\nFailed example:\n    Z.solve_right(R)  # rel tol 1e-14\nExpected:\n    (-1.5000000000000044, -0.5000000000000009, 2.750000000000003)\nGot:\n    (-1.5000000000000135, -0.5000000000000085, 2.7500000000000213)\nTolerance exceeded in 1 of 3:\n    -0.5000000000000009 vs -0.5000000000000085, tolerance 2e-14 > 1e-14\n```",
    "created_at": "2015-06-03T16:03:53Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260963",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:7'></a>
Paul - Sorry to have been incomplete on this one.  Indeed, the failure looks just like the AMD K10 "middle one."

Marc - thanks for the review!

```
File "src/sage/tests/french_book/linsolve_doctest.py", line 86, in sage.tests.french_book.linsolve_doctest
Failed example:
    Z.solve_right(R)  # rel tol 1e-14
Expected:
    (-1.5000000000000044, -0.5000000000000009, 2.750000000000003)
Got:
    (-1.5000000000000135, -0.5000000000000085, 2.7500000000000213)
Tolerance exceeded in 1 of 3:
    -0.5000000000000009 vs -0.5000000000000085, tolerance 2e-14 > 1e-14
```



---

archive/issue_comments_260964.json:
```json
{
    "body": "**Changing branch** from \"[u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)\" to \"[bf5b521bcbba59895cfae220284a3bc6ec05d12e](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)\".",
    "created_at": "2015-06-03T23:22:30Z",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-260964",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)" to "[bf5b521bcbba59895cfae220284a3bc6ec05d12e](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)".



---

archive/issue_events_167214.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-03T23:22:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-167214"
}
```



---

archive/issue_events_167215.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "38e965b85f9ca7a728cdf523fc7d5d945e704627",
    "created_at": "2015-06-03T23:22:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-167215"
}
```
