# Issue 18593: Relative tolerance in French Sage book

archive/issues_018356.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nA doctest from the French Sage book just barely fails in SageMathCloud (Intel Haswell, iirc).\n\nCC:  @zimmermann6 @ClementPernet\n\nComponent: **documentation**\n\nKeywords: **french book doctest tolerance**\n\nAuthor: **Rob Beezer**\n\nBranch/Commit: **[`bf5b521`](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)**\n\nReviewer: **Marc Mezzarobba**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18593_\n\n",
    "closed_at": "2015-06-03T23:22:30Z",
    "created_at": "2015-06-02T22:05:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20documentation",
        "https://github.com/sagemath/sage/labels/p%3A%20trivial%20/%205",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/doctest%20coverage"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Relative tolerance in French Sage book",
    "type": "issue",
    "updated_at": "2015-06-03T23:22:30Z",
    "url": "https://github.com/sagemath/sage/issues/18593",
    "user": "https://github.com/rbeezer"
}
```
<div id="comment:0"></div>

A doctest from the French Sage book just barely fails in SageMathCloud (Intel Haswell, iirc).

CC:  @zimmermann6 @ClementPernet

Component: **documentation**

Keywords: **french book doctest tolerance**

Author: **Rob Beezer**

Branch/Commit: **[`bf5b521`](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)**

Reviewer: **Marc Mezzarobba**

_Issue created by migration from https://trac.sagemath.org/ticket/18593_





---

archive/issue_events_261904.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:05:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "milestone_number": null,
    "milestone_title": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261904"
}
```



---

archive/issue_events_261905.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:05:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261905"
}
```



---

archive/issue_events_261906.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:05:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20trivial%20/%205",
    "label_color": "fff9e5",
    "label_name": "p: trivial / 5",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261906"
}
```



---

archive/issue_events_261907.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:05:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261907"
}
```



---

archive/issue_events_261908.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:05:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261908"
}
```



---

archive/issue_comments_258447.json:
```json
{
    "body": "Author: **Rob Beezer**",
    "created_at": "2015-06-02T22:12:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258447",
    "user": "https://github.com/rbeezer"
}
```

Author: **Rob Beezer**



---

archive/issue_events_261909.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:12:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261909"
}
```



---

archive/issue_comments_258448.json:
```json
{
    "body": "Branch: **[u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)**",
    "created_at": "2015-06-02T22:12:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258448",
    "user": "https://github.com/rbeezer"
}
```

Branch: **[u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)**



---

archive/issue_comments_258449.json:
```json
{
    "body": "Commit: **[`bf5b521`](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)**",
    "created_at": "2015-06-02T22:12:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258449",
    "user": "https://github.com/rbeezer"
}
```

Commit: **[`bf5b521`](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)**



---

archive/issue_comments_258450.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nIncreased the tolerance by an order of magnitude, so test now passes.\n\nPaul - feel free to cc the relevant section author!  Mostly experimenting making a contribution from with SageMathCloud, but thought it best to kill this one (repeated) failure.  Thanks, Rob\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e\"><code>bf5b521</code></a></td><td><code>18593: Relative tolerance on linear system in French Sage book</code></td></tr></table>\n",
    "created_at": "2015-06-02T22:12:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258450",
    "user": "https://github.com/rbeezer"
}
```

<div id="comment:1" align="right">comment:1</div>

Increased the tolerance by an order of magnitude, so test now passes.

Paul - feel free to cc the relevant section author!  Mostly experimenting making a contribution from with SageMathCloud, but thought it best to kill this one (repeated) failure.  Thanks, Rob

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e"><code>bf5b521</code></a></td><td><code>18593: Relative tolerance on linear system in French Sage book</code></td></tr></table>




---

archive/issue_events_261910.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2015-06-02T22:18:23Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "title_is": "Relative tolerance in French Sage book",
    "title_was": "Realtive tolerance in French Sage book",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261910"
}
```



---

archive/issue_comments_258451.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFixed typo in ticket title.  ;-)",
    "created_at": "2015-06-02T22:18:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258451",
    "user": "https://github.com/rbeezer"
}
```

<div id="comment:2" align="right">comment:2</div>

Fixed typo in ticket title.  ;-)



---

archive/issue_events_261911.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2015-06-03T06:37:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261911"
}
```



---

archive/issue_events_261912.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2015-06-03T06:37:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261912"
}
```



---

archive/issue_comments_258452.json:
```json
{
    "body": "Reviewer: **Marc Mezzarobba**",
    "created_at": "2015-06-03T06:37:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258452",
    "user": "https://github.com/mezzarobba"
}
```

Reviewer: **Marc Mezzarobba**



---

archive/issue_comments_258453.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\njust curious, I'd like to investigate more. Here is what I get with Sage 6.8.beta1 on my workstation:\n\n```\nsage: A = matrix(RDF, [[1,3,2],[1,4,2],[0,5,2],[1,3,2]]); A\n[1.0 3.0 2.0]\n[1.0 4.0 2.0]\n[0.0 5.0 2.0]\n[1.0 3.0 2.0]\nsage: b = vector(RDF, [1,2,3,4]); b\n(1.0, 2.0, 3.0, 4.0)\nsage: transpose(A)\n[1.0 1.0 0.0 1.0]\n[3.0 4.0 5.0 3.0]\n[2.0 2.0 2.0 2.0]\nsage: R = transpose(A)*b; R\n(7.0, 38.0, 20.0)\nsage: Z = transpose(A)*A; Z\n[ 3.0 10.0  6.0]\n[10.0 59.0 30.0]\n[ 6.0 30.0 16.0]\nsage: Z.solve_right(R)\n(-1.5000000000000049, -0.5000000000000011, 2.750000000000004)\nsage: from sage.misc.citation import get_systems\nsage: get_systems('Z.solve_right(R)')\n['numpy', 'scipy']\n```\nWhat do you get on the machine where the test did fail?\n\nPaul",
    "created_at": "2015-06-03T07:12:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258453",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:4" align="right">comment:4</div>

just curious, I'd like to investigate more. Here is what I get with Sage 6.8.beta1 on my workstation:

```
sage: A = matrix(RDF, [[1,3,2],[1,4,2],[0,5,2],[1,3,2]]); A
[1.0 3.0 2.0]
[1.0 4.0 2.0]
[0.0 5.0 2.0]
[1.0 3.0 2.0]
sage: b = vector(RDF, [1,2,3,4]); b
(1.0, 2.0, 3.0, 4.0)
sage: transpose(A)
[1.0 1.0 0.0 1.0]
[3.0 4.0 5.0 3.0]
[2.0 2.0 2.0 2.0]
sage: R = transpose(A)*b; R
(7.0, 38.0, 20.0)
sage: Z = transpose(A)*A; Z
[ 3.0 10.0  6.0]
[10.0 59.0 30.0]
[ 6.0 30.0 16.0]
sage: Z.solve_right(R)
(-1.5000000000000049, -0.5000000000000011, 2.750000000000004)
sage: from sage.misc.citation import get_systems
sage: get_systems('Z.solve_right(R)')
['numpy', 'scipy']
```
What do you get on the machine where the test did fail?

Paul



---

archive/issue_comments_258454.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOne should not expect the numerical garbage to be reproducible when changing architectures: even if basic operations are compliant with the IEEE norm, the way they are scheduled (by the compiler or programmer) impacts the numerical noise.\nLooking at the condition number (1222), we can assume that up to 3 digits can be lost. So the bug was indeed that the tolerance was probably set to a too low value.\n\nI ran directly the LAPACK degesv implementation of GotoBLAS-2.11 on various architectures and got the following values:\n\nx = [-1.5000000000000067 ,-0.50000000000000389 ,2.7500000000000098] for Intel Haswell, SandyBridge and Westmere, AMD K8, \nx = [-1.4999999999999918 ,-0.49999999999999678 ,2.7499999999999911] for AMD Bulldozer\nx = [-1.5000000000000135 ,-0.50000000000000855 ,2.7500000000000213] for AMD K10",
    "created_at": "2015-06-03T09:25:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258454",
    "user": "https://github.com/ClementPernet"
}
```

<div id="comment:5" align="right">comment:5</div>

One should not expect the numerical garbage to be reproducible when changing architectures: even if basic operations are compliant with the IEEE norm, the way they are scheduled (by the compiler or programmer) impacts the numerical noise.
Looking at the condition number (1222), we can assume that up to 3 digits can be lost. So the bug was indeed that the tolerance was probably set to a too low value.

I ran directly the LAPACK degesv implementation of GotoBLAS-2.11 on various architectures and got the following values:

x = [-1.5000000000000067 ,-0.50000000000000389 ,2.7500000000000098] for Intel Haswell, SandyBridge and Westmere, AMD K8, 
x = [-1.4999999999999918 ,-0.49999999999999678 ,2.7499999999999911] for AMD Bulldozer
x = [-1.5000000000000135 ,-0.50000000000000855 ,2.7500000000000213] for AMD K10



---

archive/issue_comments_258455.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nindeed the -0.50000000000000855 middle value on AMD K10 gives a relative error of 1.53e-14, which is larger than the previous tolerance of 1e-14.",
    "created_at": "2015-06-03T11:02:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258455",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:6" align="right">comment:6</div>

indeed the -0.50000000000000855 middle value on AMD K10 gives a relative error of 1.53e-14, which is larger than the previous tolerance of 1e-14.



---

archive/issue_comments_258456.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nPaul - Sorry to have been incomplete on this one.  Indeed, the failure looks just like the AMD K10 \"middle one.\"\n\nMarc - thanks for the review!\n\n```\nFile \"src/sage/tests/french_book/linsolve_doctest.py\", line 86, in sage.tests.french_book.linsolve_doctest\nFailed example:\n    Z.solve_right(R)  # rel tol 1e-14\nExpected:\n    (-1.5000000000000044, -0.5000000000000009, 2.750000000000003)\nGot:\n    (-1.5000000000000135, -0.5000000000000085, 2.7500000000000213)\nTolerance exceeded in 1 of 3:\n    -0.5000000000000009 vs -0.5000000000000085, tolerance 2e-14 > 1e-14\n```",
    "created_at": "2015-06-03T16:03:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258456",
    "user": "https://github.com/rbeezer"
}
```

<div id="comment:7" align="right">comment:7</div>

Paul - Sorry to have been incomplete on this one.  Indeed, the failure looks just like the AMD K10 "middle one."

Marc - thanks for the review!

```
File "src/sage/tests/french_book/linsolve_doctest.py", line 86, in sage.tests.french_book.linsolve_doctest
Failed example:
    Z.solve_right(R)  # rel tol 1e-14
Expected:
    (-1.5000000000000044, -0.5000000000000009, 2.750000000000003)
Got:
    (-1.5000000000000135, -0.5000000000000085, 2.7500000000000213)
Tolerance exceeded in 1 of 3:
    -0.5000000000000009 vs -0.5000000000000085, tolerance 2e-14 > 1e-14
```



---

archive/issue_comments_258457.json:
```json
{
    "body": "Changed branch from **[u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)** to **[`bf5b521`](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)**",
    "created_at": "2015-06-03T23:22:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18593#issuecomment-258457",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/rbeezer/tolerance-french-book](https://github.com/sagemath/sagetrac-mirror/tree/u/rbeezer/tolerance-french-book)** to **[`bf5b521`](https://github.com/sagemath/sagetrac-mirror/commit/bf5b521bcbba59895cfae220284a3bc6ec05d12e)**



---

archive/issue_events_261913.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-03T23:22:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261913"
}
```



---

archive/issue_events_261914.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "38e965b85f9ca7a728cdf523fc7d5d945e704627",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-06-03T23:22:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18593",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18593#event-261914"
}
```
