# Issue 18450: Define library dependencies in .pxd files

archive/issues_018213.json:
```json
{
    "body": "CC:  jpflori gouezel\n\nRather than defining libraries in `module_list.py` or in `.pyx` files, we should add them to the `.pxd` files where the declarations are.\n\nIn this branch, we do this as proof-of-concept for `pari` and `gmp`. Other tickets can be opened later for other libraries. We still leave the libraries explicitly in `module_list.py` when needed as dependency of another library, for example `mpfr` depends on `gmp`.\n\nOne annoying part is that the order of libraries is not defined, so we need to manually re-order them using one global library order. Since the order of libraries currently specified in `src/module_list.py` is far from a DAG, many extensions will be compiled with a different library order than before.\n\nTo clean up, we also remove the explicit mention of `stdc++` for `c++` code (which is automatically added anyway).\n\n---\n\nThese are all modules where the list of libraries was actually changed:\n\nThese were probably underlinked before:\n* `sage/rings/polynomial/pbori`: added `gmp`\n* `sage/rings/real_arb` (optional): added `gmp`\n\nThese use inline functions or macros of libraries but don't use exported functions. So they don't need to link to the library, but it's added anyway:\n* `sage/rings/rational`: added `pari`\n* `sage/rings/padics/common_conversion`: added `pari`\n\nModules using the Sage/PARI interface but not directly using PARI will now link against `pari`. Strictly speaking, this is a bug but it's hard to avoid:\n* `sage/rings/padics/padic_capped_absolute_element`: added `pari`\n* `sage/rings/padics/padic_capped_relative_element`: added `pari`\n* `sage/rings/padics/padic_fixed_mod_element`: added `pari`\n* `sage/rings/real_double`: added `pari`\n\nThis branch adds `gmp` for all modules where bitsets are used. Some bitset functions require GMP, others do not. These modules were only using the ones not implemented using GMP:\n* `sage/combinat/debruijn_sequence`: added `gmp`\n* `sage/combinat/words/word_char`: added `gmp`\n* `sage/graphs/base/static_sparse_backend`: added `gmp`\n* `sage/graphs/weakly_chordal`: added `gmp`\n\nUnused libraries are removed:\n* `sage/graphs/graph_generators_pyx`: removed `gmp`\n* `sage/groups/semimonomial_transformations/semimonomial_transformation`: removed `gmp`\n* `sage/modular/modsym/p1list`: removed `gmp`\n* `sage/modules/vector_mod2_dense`: removed `gmp`\n\n---\n\nWe need 1 patch to upstream Cython to fix dependency handling:\n* [https://github.com/cython/cython/pull/381](https://github.com/cython/cython/pull/381) (accepted)\n\nIssue created by migration from https://trac.sagemath.org/ticket/18450\n\n",
    "closed_at": "2015-06-03T23:22:41Z",
    "created_at": "2015-05-19T12:56:01Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Define library dependencies in .pxd files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18450",
    "user": "https://github.com/jdemeyer"
}
```
CC:  jpflori gouezel

Rather than defining libraries in `module_list.py` or in `.pyx` files, we should add them to the `.pxd` files where the declarations are.

In this branch, we do this as proof-of-concept for `pari` and `gmp`. Other tickets can be opened later for other libraries. We still leave the libraries explicitly in `module_list.py` when needed as dependency of another library, for example `mpfr` depends on `gmp`.

One annoying part is that the order of libraries is not defined, so we need to manually re-order them using one global library order. Since the order of libraries currently specified in `src/module_list.py` is far from a DAG, many extensions will be compiled with a different library order than before.

To clean up, we also remove the explicit mention of `stdc++` for `c++` code (which is automatically added anyway).

---

These are all modules where the list of libraries was actually changed:

These were probably underlinked before:
* `sage/rings/polynomial/pbori`: added `gmp`
* `sage/rings/real_arb` (optional): added `gmp`

These use inline functions or macros of libraries but don't use exported functions. So they don't need to link to the library, but it's added anyway:
* `sage/rings/rational`: added `pari`
* `sage/rings/padics/common_conversion`: added `pari`

Modules using the Sage/PARI interface but not directly using PARI will now link against `pari`. Strictly speaking, this is a bug but it's hard to avoid:
* `sage/rings/padics/padic_capped_absolute_element`: added `pari`
* `sage/rings/padics/padic_capped_relative_element`: added `pari`
* `sage/rings/padics/padic_fixed_mod_element`: added `pari`
* `sage/rings/real_double`: added `pari`

This branch adds `gmp` for all modules where bitsets are used. Some bitset functions require GMP, others do not. These modules were only using the ones not implemented using GMP:
* `sage/combinat/debruijn_sequence`: added `gmp`
* `sage/combinat/words/word_char`: added `gmp`
* `sage/graphs/base/static_sparse_backend`: added `gmp`
* `sage/graphs/weakly_chordal`: added `gmp`

Unused libraries are removed:
* `sage/graphs/graph_generators_pyx`: removed `gmp`
* `sage/groups/semimonomial_transformations/semimonomial_transformation`: removed `gmp`
* `sage/modular/modsym/p1list`: removed `gmp`
* `sage/modules/vector_mod2_dense`: removed `gmp`

---

We need 1 patch to upstream Cython to fix dependency handling:
* [https://github.com/cython/cython/pull/381](https://github.com/cython/cython/pull/381) (accepted)

Issue created by migration from https://trac.sagemath.org/ticket/18450





---

archive/issue_comments_245633.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-05-20T05:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245633",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_245634.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-20T09:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245634",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_245635.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-20T09:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245635",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_245636.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-23T11:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245636",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_245637.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-23T20:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245637",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_051942.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-23T20:48:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "milestone": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18450#event-51942"
}
```



---

archive/issue_comments_245638.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-23T20:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245638",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_245639.json:
```json
{
    "body": "To potential reviewers: if the upstream status of the second Cython patch is what prevents you from reviewing this ticket, I can add a quick work-around for that. Just let me know.",
    "created_at": "2015-06-01T10:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245639",
    "user": "https://github.com/jdemeyer"
}
```

To potential reviewers: if the upstream status of the second Cython patch is what prevents you from reviewing this ticket, I can add a quick work-around for that. Just let me know.



---

archive/issue_comments_245640.json:
```json
{
    "body": "Please do!\n\nI had a look at the upstream ticket and did not get any strong feeling yet.",
    "created_at": "2015-06-01T10:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245640",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Please do!

I had a look at the upstream ticket and did not get any strong feeling yet.



---

archive/issue_comments_245641.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-01T11:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245641",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_245642.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-01T12:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_245643.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-01T12:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245643",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_245644.json:
```json
{
    "body": "With the patch, `mpfr` is not picked when compiling `partitions_c` (on cygwin)\nPart of the log:\n\n```\nbuild/temp.cygwin-1.7.35-x86_64-2.7/sage/combinat/partitions_c.o: dans la fonction \u00ab compute_current_precision \u00bb:\n/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:448: r\u00e9f\u00e9rence ind\u00e9finie vers \u00ab __imp_mpfr_init2 \u00bb\n/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:448:(.text+0x16): relocalisation tronqu\u00e9e pour concorder avec la taille: R_X86_64_PC32 vers le symbole ind\u00e9fini __imp_mpfr_init2\n/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:452: r\u00e9f\u00e9rence ind\u00e9finie vers \u00ab __imp_mpfr_set_d \u00bb\n```\nFull log on request.",
    "created_at": "2015-06-02T07:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245644",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

With the patch, `mpfr` is not picked when compiling `partitions_c` (on cygwin)
Part of the log:

```
build/temp.cygwin-1.7.35-x86_64-2.7/sage/combinat/partitions_c.o: dans la fonction « compute_current_precision »:
/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:448: référence indéfinie vers « __imp_mpfr_init2 »
/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:448:(.text+0x16): relocalisation tronquée pour concorder avec la taille: R_X86_64_PC32 vers le symbole indéfini __imp_mpfr_init2
/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:452: référence indéfinie vers « __imp_mpfr_set_d »
```
Full log on request.



---

archive/issue_comments_245645.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-02T07:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245645",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_245646.json:
```json
{
    "body": "Right, it's `partitions_c.cc` which needs those libraries, not the Cython code...",
    "created_at": "2015-06-02T07:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245646",
    "user": "https://github.com/jdemeyer"
}
```

Right, it's `partitions_c.cc` which needs those libraries, not the Cython code...



---

archive/issue_comments_245647.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-02T07:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245647",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_245648.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-02T07:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245648",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_245649.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-02T09:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245649",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_245650.json:
```json
{
    "body": "Coule you please open a follow up ticket for the Pari linking issue?",
    "created_at": "2015-06-02T09:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245650",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Coule you please open a follow up ticket for the Pari linking issue?



---

archive/issue_comments_245651.json:
```json
{
    "body": "You mean the fact that `pari` gets added as library when it's not needed? That's now #18583.",
    "created_at": "2015-06-02T10:01:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245651",
    "user": "https://github.com/jdemeyer"
}
```

You mean the fact that `pari` gets added as library when it's not needed? That's now #18583.



---

archive/issue_comments_245652.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-02T15:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245652",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_245653.json:
```json
{
    "body": "With the patch, linking problem of 'libecm' with 'gmp'\nPart of log:\n\n```\ngcc -shared -Wl,--enable-auto-image-base -L/home/Sebastien/sage13/sage/local/lib build/temp.cygwin-1.7.35-x86_64-2.7/build/cythonized/sage/libs/libecm.o -L/home/Sebastien/sage13/sage/local/lib -L/home/Sebastien/sage13/sage/local/lib/python2.7/config -L/home/Sebastien/sage13/sage/local/lib -lcsage -lgmp -lecm -lpython2.7 -o build/lib.cygwin-1.7.35-x86_64-2.7/sage/libs/libecm.dll\n/home/Sebastien/sage13/sage/local/lib/libecm.a(libecm_la-factor.o): dans la fonction \u00ab ecm_init \u00bb:\n/home/Sebastien/sage13/sage/local/var/tmp/sage/build/ecm-6.4.4/src/factor.c:32: r\u00e9f\u00e9rence ind\u00e9finie vers \u00ab __imp___gmpz_init_set_ui \u00bb\n```",
    "created_at": "2015-06-02T15:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245653",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

With the patch, linking problem of 'libecm' with 'gmp'
Part of log:

```
gcc -shared -Wl,--enable-auto-image-base -L/home/Sebastien/sage13/sage/local/lib build/temp.cygwin-1.7.35-x86_64-2.7/build/cythonized/sage/libs/libecm.o -L/home/Sebastien/sage13/sage/local/lib -L/home/Sebastien/sage13/sage/local/lib/python2.7/config -L/home/Sebastien/sage13/sage/local/lib -lcsage -lgmp -lecm -lpython2.7 -o build/lib.cygwin-1.7.35-x86_64-2.7/sage/libs/libecm.dll
/home/Sebastien/sage13/sage/local/lib/libecm.a(libecm_la-factor.o): dans la fonction « ecm_init »:
/home/Sebastien/sage13/sage/local/var/tmp/sage/build/ecm-6.4.4/src/factor.c:32: référence indéfinie vers « __imp___gmpz_init_set_ui »
```



---

archive/issue_comments_245654.json:
```json
{
    "body": "There is a lgmp but before lecm and the linker is picky.",
    "created_at": "2015-06-02T15:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245654",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

There is a lgmp but before lecm and the linker is picky.



---

archive/issue_comments_245655.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-02T15:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245655",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_245656.json:
```json
{
    "body": "Right, I forgot to add `ecm`.",
    "created_at": "2015-06-02T15:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245656",
    "user": "https://github.com/jdemeyer"
}
```

Right, I forgot to add `ecm`.



---

archive/issue_comments_245657.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-02T15:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245657",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_245658.json:
```json
{
    "body": "Good to go.",
    "created_at": "2015-06-02T20:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245658",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Good to go.



---

archive/issue_comments_245659.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-02T20:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245659",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_245660.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2015-06-03T05:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245660",
    "user": "https://github.com/jdemeyer"
}
```

Thanks for the review!



---

archive/issue_events_051943.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-03T23:22:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18450#event-51943"
}
```



---

archive/issue_comments_245661.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-03T23:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245661",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_245662.json:
```json
{
    "body": "Just out of curiosity:  Are there follow-ups moving further things into `*.pxd`?\n\n(More precisely, into `# distutils: ...` declarations.)",
    "created_at": "2016-06-29T20:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18450",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18450#issuecomment-245662",
    "user": "https://github.com/nexttime"
}
```

Just out of curiosity:  Are there follow-ups moving further things into `*.pxd`?

(More precisely, into `# distutils: ...` declarations.)
