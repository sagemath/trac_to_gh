# Issue 18142: Numpy: fix dependency checking of headers for Sage library code

archive/issues_017905.json:
```json
{
    "body": "1. In `src/setup.py`, use `numpy.get_include()` to determine the location of the `numpy` includes.\n2. When installing `numpy`, touch the includes to fix dependency checking.\n3. Remove all the manual numpy header and dependency stuff from `src/module_list.py`.\n\nThe removal of the manual `numpy` dependencies only removed the `numpy` dependency of `src/sage/finance/fractal.pyx` (which doesn't use `numpy`, so the change is correct).\n\nBranch/Commit: d9bbc1d673590fcd18db88120ac95c68a25f281a\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18142\n\n",
    "closed_at": "2015-04-14T19:43:10Z",
    "created_at": "2015-04-08T08:55:29Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Numpy: fix dependency checking of headers for Sage library code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18142",
    "user": "https://github.com/jdemeyer"
}
```
1. In `src/setup.py`, use `numpy.get_include()` to determine the location of the `numpy` includes.
2. When installing `numpy`, touch the includes to fix dependency checking.
3. Remove all the manual numpy header and dependency stuff from `src/module_list.py`.

The removal of the manual `numpy` dependencies only removed the `numpy` dependency of `src/sage/finance/fractal.pyx` (which doesn't use `numpy`, so the change is correct).

Branch/Commit: d9bbc1d673590fcd18db88120ac95c68a25f281a

Reviewer: François Bissey

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18142





---

archive/issue_comments_240079.json:
```json
{
    "body": "<a id='comment:3'></a>It always felt strange that there isn't a way to get to the numpy include location from numpy itself. Is it just because we are ignorant? If not it seems to be a case of something missing to me.\n\nOf course with sage you can afford the short-cut to `local/include` I cannot when I can numpy installed for various versions of python. I'd like to see if numpy provides a mechanism first.",
    "created_at": "2015-04-08T10:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240079",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:3'></a>It always felt strange that there isn't a way to get to the numpy include location from numpy itself. Is it just because we are ignorant? If not it seems to be a case of something missing to me.

Of course with sage you can afford the short-cut to `local/include` I cannot when I can numpy installed for various versions of python. I'd like to see if numpy provides a mechanism first.



---

archive/issue_comments_240080.json:
```json
{
    "body": "<a id='comment:4'></a>http://stackoverflow.com/questions/2379898/make-distutils-look-for-numpy-header-files-in-the-correct-place\n\n`numpy.get_include()` is what we are after.",
    "created_at": "2015-04-08T10:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240080",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>http://stackoverflow.com/questions/2379898/make-distutils-look-for-numpy-header-files-in-the-correct-place

`numpy.get_include()` is what we are after.



---

archive/issue_comments_240081.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 fbissey]:\n> Of course with sage you can afford the short-cut to `local/include` I cannot when I can numpy installed for various versions of python. I'd like to see if numpy provides a mechanism first.\n\n\nFran\u00e7ois, I don't quite understand what you're trying to say. Are you saying that it's a bad idea to symlink numpy's headers in `$SAGE_LOCAL/include/numpy`?",
    "created_at": "2015-04-08T10:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240081",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:3 fbissey]:
> Of course with sage you can afford the short-cut to `local/include` I cannot when I can numpy installed for various versions of python. I'd like to see if numpy provides a mechanism first.


François, I don't quite understand what you're trying to say. Are you saying that it's a bad idea to symlink numpy's headers in `$SAGE_LOCAL/include/numpy`?



---

archive/issue_comments_240082.json:
```json
{
    "body": "<a id='comment:6'></a>Well for sage alone you don't really care. But from my sage-on-distro point of view I can have numpy for python 2.7.9 and python 3.4.3 installed. And I will have to choose which one to link under `/usr/include`. But I think the annoyance we have in setup.py (and currently module_list.py), is because we never bothered to look if numpy itself could just tell us where its headers are. And as a matter of fact it can.",
    "created_at": "2015-04-08T10:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240082",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>Well for sage alone you don't really care. But from my sage-on-distro point of view I can have numpy for python 2.7.9 and python 3.4.3 installed. And I will have to choose which one to link under `/usr/include`. But I think the annoyance we have in setup.py (and currently module_list.py), is because we never bothered to look if numpy itself could just tell us where its headers are. And as a matter of fact it can.



---

archive/issue_comments_240083.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 fbissey]:\n> Well for sage alone you don't really care. But from my sage-on-distro point of view I can have numpy for python 2.7.9 and python 3.4.3 installed.\n\nDoes the Python version even matter for the C includes of `numpy`?",
    "created_at": "2015-04-08T11:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240083",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 fbissey]:
> Well for sage alone you don't really care. But from my sage-on-distro point of view I can have numpy for python 2.7.9 and python 3.4.3 installed.

Does the Python version even matter for the C includes of `numpy`?



---

archive/issue_comments_240084.json:
```json
{
    "body": "<a id='comment:8'></a>If you prefer `numpy.get_include()`, that could be arranged. But I still find it strange that every single package installs its includes in `$SAGE_LOCAL/includes` *except* for numpy.",
    "created_at": "2015-04-08T11:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240084",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>If you prefer `numpy.get_include()`, that could be arranged. But I still find it strange that every single package installs its includes in `$SAGE_LOCAL/includes` *except* for numpy.



---

archive/issue_comments_240085.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 jdemeyer]:\n> If you prefer `numpy.get_include()`, that could be arranged. But I still find it strange that every single package installs its includes in `$SAGE_LOCAL/includes` *except* for numpy.\n\n\nThe only python packages that I know have headers and install under `include` are\n* python itself under python$version\n* pynac (python 2.7 only)\n* polybori (python 2.7 only)\n\nApart from numpy and cython I cannot think of any other python packages that install headers and those two definitely don't do it under `$prefix/include`. Because some of the headers in these can depend on the version of python I don't think it will happen anytime soon.",
    "created_at": "2015-04-08T12:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240085",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>Replying to [comment:8 jdemeyer]:
> If you prefer `numpy.get_include()`, that could be arranged. But I still find it strange that every single package installs its includes in `$SAGE_LOCAL/includes` *except* for numpy.


The only python packages that I know have headers and install under `include` are
* python itself under python$version
* pynac (python 2.7 only)
* polybori (python 2.7 only)

Apart from numpy and cython I cannot think of any other python packages that install headers and those two definitely don't do it under `$prefix/include`. Because some of the headers in these can depend on the version of python I don't think it will happen anytime soon.



---

archive/issue_comments_240086.json:
```json
{
    "body": "<a id='comment:12'></a>New commits:",
    "created_at": "2015-04-08T12:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240086",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>New commits:



---

archive/issue_comments_240087.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-08T12:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240087",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_240088.json:
```json
{
    "body": "<a id='comment:13'></a>After inspection of my system I got one header that is shared between version of python under `/usr/include`: `pygobject/pygobject.h`. There is only one switch inside that depends on the version of python used if I read the thing correctly. So it can be done.\n\nAnyway the patch looks very good to me and it get the right head counts of `numpy_depends` (26) in `module_list.py`. \n\nThe only thing you forgot is that bit of code in `sage/misc/cython.py`\n\n```\ninclude_dirs = [os.path.join(SAGE_LOCAL,'include','csage'),\n                os.path.join(SAGE_LOCAL,'include'), \\\n                os.path.join(SAGE_LOCAL,'include','python'+platform.python_version().rsplit('.', 1)[0]), \\\n                os.path.join(SAGE_LOCAL,'lib','python','site-packages','numpy','core','include'), \\\n                os.path.join(SAGE_SRC,'sage','ext'), \\\n                os.path.join(SAGE_SRC), \\\n                os.path.join(SAGE_SRC,'sage','gsl')]\n```",
    "created_at": "2015-04-08T12:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240088",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:13'></a>After inspection of my system I got one header that is shared between version of python under `/usr/include`: `pygobject/pygobject.h`. There is only one switch inside that depends on the version of python used if I read the thing correctly. So it can be done.

Anyway the patch looks very good to me and it get the right head counts of `numpy_depends` (26) in `module_list.py`. 

The only thing you forgot is that bit of code in `sage/misc/cython.py`

```
include_dirs = [os.path.join(SAGE_LOCAL,'include','csage'),
                os.path.join(SAGE_LOCAL,'include'), \
                os.path.join(SAGE_LOCAL,'include','python'+platform.python_version().rsplit('.', 1)[0]), \
                os.path.join(SAGE_LOCAL,'lib','python','site-packages','numpy','core','include'), \
                os.path.join(SAGE_SRC,'sage','ext'), \
                os.path.join(SAGE_SRC), \
                os.path.join(SAGE_SRC,'sage','gsl')]
```



---

archive/issue_comments_240089.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 fbissey]:\n> The only thing you forgot is that bit of code in `sage/misc/cython.py`\n\n\nPlease no! That's outside the scope of this ticket. Fixing the big mess which is `sage/misc/cython.py` is for later.",
    "created_at": "2015-04-08T13:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240089",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:13 fbissey]:
> The only thing you forgot is that bit of code in `sage/misc/cython.py`


Please no! That's outside the scope of this ticket. Fixing the big mess which is `sage/misc/cython.py` is for later.



---

archive/issue_comments_240090.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-08T13:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240090",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_240091.json:
```json
{
    "body": "<a id='comment:16'></a>Fair enough cython.py deserve its own ticket.",
    "created_at": "2015-04-08T13:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240091",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:16'></a>Fair enough cython.py deserve its own ticket.



---

archive/issue_comments_240092.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 fbissey]:\n> Fair enough cython.py deserve its own ticket.\n\n\nBut later. There are way too many Cython-related tickets that it's becoming hard to do anything which doesn't conflict with another ticket.",
    "created_at": "2015-04-08T13:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240092",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:16 fbissey]:
> Fair enough cython.py deserve its own ticket.


But later. There are way too many Cython-related tickets that it's becoming hard to do anything which doesn't conflict with another ticket.



---

archive/issue_events_051372.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-14T19:43:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18142#event-51372"
}
```



---

archive/issue_comments_240093.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-14T19:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18142",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18142#issuecomment-240093",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
