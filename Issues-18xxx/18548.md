# Issue 18548: Fix a bug introduced in #17792

archive/issues_018311.json:
```json
{
    "body": "Ticket #17792 implemented the solution for the word problem for congruence subgroups of (P)SL2(Z). However, the element represented by the output word sometimes differs from the original element by at most one generator.\n\nHere is an example:\n\n```\nsage: G = Gamma0(10)\nsage: F = G.farey_symbol()\nsage: g = G([-701,-137,4600,899])\nsage: word = F.word_problem(g, output = 'syllables')\nsage: g1 = prod(F.generators()[i]**a for i,a in word)\nsage: g == g1 or g * G([-1,0,0,-1]) == g1\nFalse # Should be True\n```\n\nThis ticket solves this. I have ran the code below to test:\n\n```\nfor N in range(2,500):\n    G = Gamma0(N)\n    print \"N = %s\"%N\n    gens = G.generators()\n    F = G.farey_symbol()\n    i = 0\n    I = G([1,0,0,1])\n    E = G([-1,0,0,-1])\n    while i < 200:\n        c = ZZ.random_element(1000)\n        d = ZZ.random_element(1000)\n        if gcd(c*N,d) > 1:\n            continue\n        i += 1\n        _,a,b = xgcd(d,-c * N)\n        g = G([a,b,c*N,d])\n        wd = F.word_problem(g, output = 'syllables')\n        g1 = prod(gens[j]**n for j,n in wd)\n        assert g * g1**-1 ==  I or g * g1**-1 == E\n```\n(and also a modification to check Gamma_1(N).\n\nPS: I also publicly apologise for being careless about this before. I did have code to fix this behaviour, but it was in an external sage script: this made the indirect tests pass.\n\nCC:  @JohnCremona\n\nBranch/Commit: [83344bd457be7a7954b32066ee017b226921072b](https://github.com/sagemath/sagetrac-mirror/commit/83344bd457be7a7954b32066ee017b226921072b)\n\nReviewer: David Loeffler\n\nAuthor: Marc Masdeu\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/18548\n\n",
    "closed_at": "2015-07-03T10:32:06Z",
    "created_at": "2015-05-29T16:15:22Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Fix a bug introduced in #17792",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18548",
    "user": "https://github.com/mmasdeu"
}
```
Ticket #17792 implemented the solution for the word problem for congruence subgroups of (P)SL2(Z). However, the element represented by the output word sometimes differs from the original element by at most one generator.

Here is an example:

```
sage: G = Gamma0(10)
sage: F = G.farey_symbol()
sage: g = G([-701,-137,4600,899])
sage: word = F.word_problem(g, output = 'syllables')
sage: g1 = prod(F.generators()[i]**a for i,a in word)
sage: g == g1 or g * G([-1,0,0,-1]) == g1
False # Should be True
```

This ticket solves this. I have ran the code below to test:

```
for N in range(2,500):
    G = Gamma0(N)
    print "N = %s"%N
    gens = G.generators()
    F = G.farey_symbol()
    i = 0
    I = G([1,0,0,1])
    E = G([-1,0,0,-1])
    while i < 200:
        c = ZZ.random_element(1000)
        d = ZZ.random_element(1000)
        if gcd(c*N,d) > 1:
            continue
        i += 1
        _,a,b = xgcd(d,-c * N)
        g = G([a,b,c*N,d])
        wd = F.word_problem(g, output = 'syllables')
        g1 = prod(gens[j]**n for j,n in wd)
        assert g * g1**-1 ==  I or g * g1**-1 == E
```
(and also a modification to check Gamma_1(N).

PS: I also publicly apologise for being careless about this before. I did have code to fix this behaviour, but it was in an external sage script: this made the indirect tests pass.

CC:  @JohnCremona

Branch/Commit: [83344bd457be7a7954b32066ee017b226921072b](https://github.com/sagemath/sagetrac-mirror/commit/83344bd457be7a7954b32066ee017b226921072b)

Reviewer: David Loeffler

Author: Marc Masdeu

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/18548





---

archive/issue_comments_329063.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-29T16:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329063",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329064.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mmasdeu/18548-fix_farey_word_problem\"",
    "created_at": "2015-05-29T16:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329064",
    "user": "https://github.com/mmasdeu"
}
```

Changing branch from "" to "u/mmasdeu/18548-fix_farey_word_problem"



---

archive/issue_comments_329065.json:
```json
{
    "body": "Changing commit from \"\" to \"fa32ed11968c4d04f79893eef732e36d6ad73d3e\"",
    "created_at": "2015-05-29T16:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329065",
    "user": "https://github.com/mmasdeu"
}
```

Changing commit from "" to "fa32ed11968c4d04f79893eef732e36d6ad73d3e"



---

archive/issue_comments_329066.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -36,3 +36,5 @@\n         assert g * g1**-1 ==  I or g * g1**-1 == E\n ```\n (and also a modification to check Gamma_1(N).\n+\n+PS: I also publicly apologise for being careless about this before. I did have code to fix this behaviour, but it was in an external sage script: this made the indirect tests pass.\n``````\n",
    "created_at": "2015-05-29T16:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329066",
    "user": "https://github.com/mmasdeu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -36,3 +36,5 @@
         assert g * g1**-1 ==  I or g * g1**-1 == E
 ```
 (and also a modification to check Gamma_1(N).
+
+PS: I also publicly apologise for being careless about this before. I did have code to fix this behaviour, but it was in an external sage script: this made the indirect tests pass.
``````




---

archive/issue_comments_329067.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-01T07:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329067",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_329068.json:
```json
{
    "body": "<a id='comment:2'></a>\ndoc does not build, see patchbot reports",
    "created_at": "2015-06-01T07:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329068",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
doc does not build, see patchbot reports



---

archive/issue_comments_329069.json:
```json
{
    "body": "<a id='comment:3'></a>\nyou wrongly used `TESTS ::` with one spurious space",
    "created_at": "2015-06-01T07:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329069",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
you wrongly used `TESTS ::` with one spurious space



---

archive/issue_comments_329070.json:
```json
{
    "body": "Changing commit from \"fa32ed11968c4d04f79893eef732e36d6ad73d3e\" to \"ef973b5de108bb2dfa117785eb185fed6167f069\"",
    "created_at": "2015-06-01T08:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329070",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fa32ed11968c4d04f79893eef732e36d6ad73d3e" to "ef973b5de108bb2dfa117785eb185fed6167f069"



---

archive/issue_comments_329071.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[ef973b5](https://github.com/sagemath/sagetrac-mirror/commit/ef973b5de108bb2dfa117785eb185fed6167f069)|`Trac #18548: Fixed extra space in doctest.`|",
    "created_at": "2015-06-01T08:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329071",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[ef973b5](https://github.com/sagemath/sagetrac-mirror/commit/ef973b5de108bb2dfa117785eb185fed6167f069)|`Trac #18548: Fixed extra space in doctest.`|



---

archive/issue_comments_329072.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-01T08:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329072",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_329073.json:
```json
{
    "body": "<a id='comment:5'></a>\nOK, just fixed that. Sorry!",
    "created_at": "2015-06-01T08:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329073",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:5'></a>
OK, just fixed that. Sorry!



---

archive/issue_comments_329074.json:
```json
{
    "body": "<a id='comment:6'></a>\nIn fact, this was not the exact problem. You are misplacing the ::\n\nThey should be as follows in your case.\n\n```\nTESTS:\n\nsome text here::\n\n    sage: 2 + 2\n    4\n```\n\nAnd please add doctests to the functions you introduce",
    "created_at": "2015-06-01T08:54:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329074",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
In fact, this was not the exact problem. You are misplacing the ::

They should be as follows in your case.

```
TESTS:

some text here::

    sage: 2 + 2
    4
```

And please add doctests to the functions you introduce



---

archive/issue_comments_329075.json:
```json
{
    "body": "Changing commit from \"ef973b5de108bb2dfa117785eb185fed6167f069\" to \"83344bd457be7a7954b32066ee017b226921072b\"",
    "created_at": "2015-06-01T09:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329075",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ef973b5de108bb2dfa117785eb185fed6167f069" to "83344bd457be7a7954b32066ee017b226921072b"



---

archive/issue_comments_329076.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------|\n|[83344bd](https://github.com/sagemath/sagetrac-mirror/commit/83344bd457be7a7954b32066ee017b226921072b)|`Added doctests.`|",
    "created_at": "2015-06-01T09:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329076",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------|
|[83344bd](https://github.com/sagemath/sagetrac-mirror/commit/83344bd457be7a7954b32066ee017b226921072b)|`Added doctests.`|



---

archive/issue_comments_329077.json:
```json
{
    "body": "<a id='comment:8'></a>\nHopefully better now. Thanks!",
    "created_at": "2015-06-01T09:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329077",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:8'></a>
Hopefully better now. Thanks!



---

archive/issue_comments_329078.json:
```json
{
    "body": "<a id='comment:9'></a>\nLooks fine to me.",
    "created_at": "2015-07-02T14:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329078",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:9'></a>
Looks fine to me.



---

archive/issue_comments_329079.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-02T14:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329079",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329080.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Loeffler\"",
    "created_at": "2015-07-02T14:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329080",
    "user": "https://github.com/loefflerd"
}
```

Changing reviewer from "" to "David Loeffler"



---

archive/issue_comments_329081.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-07-02T20:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329081",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_329082.json:
```json
{
    "body": "<a id='comment:10'></a>\nauthor name is missing",
    "created_at": "2015-07-02T20:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329082",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
author name is missing



---

archive/issue_comments_329083.json:
```json
{
    "body": "Changing author from \"\" to \"Marc Masdeu\"",
    "created_at": "2015-07-02T22:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329083",
    "user": "https://github.com/mmasdeu"
}
```

Changing author from "" to "Marc Masdeu"



---

archive/issue_comments_329084.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-07-02T22:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329084",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_329085.json:
```json
{
    "body": "Changing branch from \"u/mmasdeu/18548-fix_farey_word_problem\" to \"83344bd457be7a7954b32066ee017b226921072b\"",
    "created_at": "2015-07-03T10:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329085",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mmasdeu/18548-fix_farey_word_problem" to "83344bd457be7a7954b32066ee017b226921072b"



---

archive/issue_comments_329086.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-03T10:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18548#issuecomment-329086",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059293.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-03T10:32:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18548",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18548#event-59293"
}
```
