# Issue 18121: Patch Cython with PyTypeObject members

archive/issues_017884.json:
```json
{
    "body": "Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`.\n\nI have made two upstream pull requests:\n- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)\n\nThese got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a [bug-fix](https://github.com/cython/cython/pull/380) which isn't in Cython 0.22).\n\n**Keywords:** sd66\n\n**Branch:** [58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)\n\n**Upstream:** Fixed upstream, but not in a stable release.\n\n**Reviewer:** Vincent Delecroix, Nils Bruin\n\n**Author:** Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/18121\n\n",
    "closed_at": "2015-04-23T03:21:55Z",
    "created_at": "2015-04-03T12:19:49Z",
    "labels": [
        "component: packages: standard",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.7",
    "title": "Patch Cython with PyTypeObject members",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/18121",
    "user": "https://github.com/jdemeyer"
}
```
Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`.

I have made two upstream pull requests:
- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)

These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a [bug-fix](https://github.com/cython/cython/pull/380) which isn't in Cython 0.22).

**Keywords:** sd66

**Branch:** [58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)

**Upstream:** Fixed upstream, but not in a stable release.

**Reviewer:** Vincent Delecroix, Nils Bruin

**Author:** Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/18121





---

archive/issue_comments_249816.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes.\n+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes and then send a pull request to Cython upstream.\n``````\n",
    "created_at": "2015-04-03T12:20:15Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249816",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes.
+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes and then send a pull request to Cython upstream.
``````




---

archive/issue_comments_249817.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/patch_cython_with_pytypeobject_members](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/patch_cython_with_pytypeobject_members)",
    "created_at": "2015-04-03T16:01:31Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249817",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/patch_cython_with_pytypeobject_members](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/patch_cython_with_pytypeobject_members)



---

archive/issue_comments_249818.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7a455baa2c1be8b753f99d3efcf64c253137e7f3\">7a455ba</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>\n",
    "created_at": "2015-04-03T21:23:59Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249818",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7a455baa2c1be8b753f99d3efcf64c253137e7f3">7a455ba</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>




---

archive/issue_comments_249819.json:
```json
{
    "body": "**Commit:** [7a455baa2c1be8b753f99d3efcf64c253137e7f3](https://github.com/sagemath/sagetrac-mirror/commit/7a455baa2c1be8b753f99d3efcf64c253137e7f3)",
    "created_at": "2015-04-03T21:23:59Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249819",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [7a455baa2c1be8b753f99d3efcf64c253137e7f3](https://github.com/sagemath/sagetrac-mirror/commit/7a455baa2c1be8b753f99d3efcf64c253137e7f3)



---

archive/issue_events_162563.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-03T21:26:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162563"
}
```



---

archive/issue_comments_249820.json:
```json
{
    "body": "**Changing upstream** from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. No feedback yet.\".",
    "created_at": "2015-04-04T07:01:40Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249820",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Not yet reported upstream; Will do shortly." to "Reported upstream. No feedback yet.".



---

archive/issue_comments_249821.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes and then send a pull request to Cython upstream.\n+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython.\n+\n+Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n``````\n",
    "created_at": "2015-04-04T07:01:40Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249821",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes and then send a pull request to Cython upstream.
+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython.
+
+Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
``````




---

archive/issue_events_162564.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-05T07:14:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162564"
}
```



---

archive/issue_events_162565.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-05T07:14:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162565"
}
```



---

archive/issue_comments_249822.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython.\n \n-Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n+Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)\n``````\n",
    "created_at": "2015-04-05T07:14:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249822",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython.
 
-Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
+Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)
``````




---

archive/issue_comments_249823.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. No feedback yet.\" to \"None of the above - read trac for reasoning.\".",
    "created_at": "2015-04-05T07:14:50Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249823",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. No feedback yet." to "None of the above - read trac for reasoning.".



---

archive/issue_comments_249824.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython.\n+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.\n \n-Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)\n+Patches sent upstream:\n+- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)\n+- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379) (no response yet)\n``````\n",
    "created_at": "2015-04-06T21:21:35Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249824",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython.
+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.
 
-Patch sent upstream: [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)
+Patches sent upstream:
+- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)
+- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379) (no response yet)
``````




---

archive/issue_comments_249825.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,5 @@\n Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.\n \n Patches sent upstream:\n-- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)\n+- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted)\n - [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379) (no response yet)\n``````\n",
    "created_at": "2015-04-06T21:24:44Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249825",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,5 @@
 Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.
 
 Patches sent upstream:
-- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted after significant modifications)
+- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted)
 - [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379) (no response yet)
``````




---

archive/issue_comments_249826.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd222e004b130b6b956425951eee47e2b2cbbc1d\">bd222e0</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>\n",
    "created_at": "2015-04-06T21:31:18Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd222e004b130b6b956425951eee47e2b2cbbc1d">bd222e0</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>




---

archive/issue_comments_249827.json:
```json
{
    "body": "**Changing commit** from \"[7a455baa2c1be8b753f99d3efcf64c253137e7f3](https://github.com/sagemath/sagetrac-mirror/commit/7a455baa2c1be8b753f99d3efcf64c253137e7f3)\" to \"[bd222e004b130b6b956425951eee47e2b2cbbc1d](https://github.com/sagemath/sagetrac-mirror/commit/bd222e004b130b6b956425951eee47e2b2cbbc1d)\".",
    "created_at": "2015-04-06T21:31:18Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249827",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7a455baa2c1be8b753f99d3efcf64c253137e7f3](https://github.com/sagemath/sagetrac-mirror/commit/7a455baa2c1be8b753f99d3efcf64c253137e7f3)" to "[bd222e004b130b6b956425951eee47e2b2cbbc1d](https://github.com/sagemath/sagetrac-mirror/commit/bd222e004b130b6b956425951eee47e2b2cbbc1d)".



---

archive/issue_events_162566.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-06T21:31:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162566"
}
```



---

archive/issue_events_162567.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-06T21:31:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162567"
}
```



---

archive/issue_comments_249828.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,5 @@\n Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.\n \n Patches sent upstream:\n-- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted)\n-- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379) (no response yet)\n+- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n+- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)\n``````\n",
    "created_at": "2015-04-07T06:12:30Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249828",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,5 @@
 Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.
 
 Patches sent upstream:
-- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378) (accepted)
-- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379) (no response yet)
+- [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
+- [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)
``````




---

archive/issue_comments_249829.json:
```json
{
    "body": "**Changing upstream** from \"None of the above - read trac for reasoning.\" to \"Fixed upstream, but not in a stable release.\".",
    "created_at": "2015-04-07T06:12:30Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249829",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "None of the above - read trac for reasoning." to "Fixed upstream, but not in a stable release.".



---

archive/issue_comments_249830.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5532969cc7c462d24788585030ab662cf05b024b\">5532969</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>\n",
    "created_at": "2015-04-07T08:23:32Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249830",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5532969cc7c462d24788585030ab662cf05b024b">5532969</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>




---

archive/issue_comments_249831.json:
```json
{
    "body": "**Changing commit** from \"[bd222e004b130b6b956425951eee47e2b2cbbc1d](https://github.com/sagemath/sagetrac-mirror/commit/bd222e004b130b6b956425951eee47e2b2cbbc1d)\" to \"[5532969cc7c462d24788585030ab662cf05b024b](https://github.com/sagemath/sagetrac-mirror/commit/5532969cc7c462d24788585030ab662cf05b024b)\".",
    "created_at": "2015-04-07T08:23:32Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249831",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[bd222e004b130b6b956425951eee47e2b2cbbc1d](https://github.com/sagemath/sagetrac-mirror/commit/bd222e004b130b6b956425951eee47e2b2cbbc1d)" to "[5532969cc7c462d24788585030ab662cf05b024b](https://github.com/sagemath/sagetrac-mirror/commit/5532969cc7c462d24788585030ab662cf05b024b)".



---

archive/issue_comments_249832.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,7 @@\n Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.\n \n-Patches sent upstream:\n+I have made two upstream pull requests:\n - [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n - [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)\n+\n+These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a bug-fix which isn't in Cython 0.22).\n``````\n",
    "created_at": "2015-04-07T08:25:52Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249832",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,7 @@
 Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.
 
-Patches sent upstream:
+I have made two upstream pull requests:
 - [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
 - [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)
+
+These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a bug-fix which isn't in Cython 0.22).
``````




---

archive/issue_comments_249833.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd66\".",
    "created_at": "2015-04-07T08:58:28Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249833",
    "user": "https://github.com/jdemeyer"
}
```

**Changing keywords** from "" to "sd66".



---

archive/issue_comments_249834.json:
```json
{
    "body": "**Changing commit** from \"[5532969cc7c462d24788585030ab662cf05b024b](https://github.com/sagemath/sagetrac-mirror/commit/5532969cc7c462d24788585030ab662cf05b024b)\" to \"[a10dcbaaaefb87d48cf337be367cd48f11ed6edf](https://github.com/sagemath/sagetrac-mirror/commit/a10dcbaaaefb87d48cf337be367cd48f11ed6edf)\".",
    "created_at": "2015-04-16T09:22:35Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249834",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5532969cc7c462d24788585030ab662cf05b024b](https://github.com/sagemath/sagetrac-mirror/commit/5532969cc7c462d24788585030ab662cf05b024b)" to "[a10dcbaaaefb87d48cf337be367cd48f11ed6edf](https://github.com/sagemath/sagetrac-mirror/commit/a10dcbaaaefb87d48cf337be367cd48f11ed6edf)".



---

archive/issue_comments_249835.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a10dcbaaaefb87d48cf337be367cd48f11ed6edf\">a10dcba</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>\n",
    "created_at": "2015-04-16T09:22:35Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249835",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a10dcbaaaefb87d48cf337be367cd48f11ed6edf">a10dcba</a></td><td><code>Use PyTypeObject from Cython</code></td></tr></table>




---

archive/issue_comments_249836.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.\n+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`.\n \n I have made two upstream pull requests:\n - [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n``````\n",
    "created_at": "2015-04-16T09:24:39Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249836",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`. Also fix a few Cython warnings.
+Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. Fix this by adding all declarations to Cython and removing `src/sage/ext/python_rich_object.pxi`.
 
 I have made two upstream pull requests:
 - [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
``````




---

archive/issue_comments_249837.json:
```json
{
    "body": "<a id='comment:17'></a>\nAs far as I can see, the patch you are using does not exactly match the changes to Cython given by [ec8ba63](https://github.com/cython/cython/commit/ec8ba63bc54839d00a07af9bcdc5129a25182a6c) (concerning the pull request 378).\n\nYou are using\n\n```\nfrom cpython.object cimport PyObject\n```\ninstead of\n\n```\nfrom .object cimport PyObject\n```\nwhy is that? It is not supported in our Cython 0.22?",
    "created_at": "2015-04-19T20:18:01Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249837",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>
As far as I can see, the patch you are using does not exactly match the changes to Cython given by [ec8ba63](https://github.com/cython/cython/commit/ec8ba63bc54839d00a07af9bcdc5129a25182a6c) (concerning the pull request 378).

You are using

```
from cpython.object cimport PyObject
```
instead of

```
from .object cimport PyObject
```
why is that? It is not supported in our Cython 0.22?



---

archive/issue_comments_249838.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [vdelecroix](#comment%3A17):\n> It is not supported in our Cython 0.22?\n\nNot completely. It needs a bug-fix which isn't in Cython 0.22.",
    "created_at": "2015-04-20T17:00:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249838",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Replying to [vdelecroix](#comment%3A17):
> It is not supported in our Cython 0.22?

Not completely. It needs a bug-fix which isn't in Cython 0.22.



---

archive/issue_comments_249839.json:
```json
{
    "body": "<a id='comment:19'></a>\nWhy `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe. Though, your version of `MonoDict_traverse` looks nicer.\n\nCould you explain to me the reason of declaring\n\n```\n    int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1\n```\nand not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.\n\nIn `sage/structure/coerce_dict.pyx`, couldn't you get rid of\n\n```\ncdef extern from \"Python.h\":\n    PyObject* PyWeakref_GetObject(object r)\n```\nIt is in `cpython.weakref`.\n\nDo you know why `Py_None` is not available from Cython?\n\nCould we also remove or comment the `cpdef inline Py_ssize_t signed_id(x)`?",
    "created_at": "2015-04-20T17:36:31Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249839",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>
Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe. Though, your version of `MonoDict_traverse` looks nicer.

Could you explain to me the reason of declaring

```
    int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
```
and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.

In `sage/structure/coerce_dict.pyx`, couldn't you get rid of

```
cdef extern from "Python.h":
    PyObject* PyWeakref_GetObject(object r)
```
It is in `cpython.weakref`.

Do you know why `Py_None` is not available from Cython?

Could we also remove or comment the `cpdef inline Py_ssize_t signed_id(x)`?



---

archive/issue_comments_249840.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [vdelecroix](#comment%3A19):\n> Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe.\n\nCorrect, and I agree. Depending on the user giving parameters a particular name *and* cython mangling the names in a particular way is more fragile than what the CPython macro does. We only use this stuff twice, so it's not too onerous and much less obscure to be explicit in the code. If we find ourselves writing more \"traverse\" functions, we should push for a more structural solution in cython (currently we're already hacking by modifying a pytype structure after PyTypeReady has run on it).\n\n> Could you explain to me the reason of declaring\n> \n> ```\n>     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1\n> ```\n> and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.\n\nSee its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.\n> In `sage/structure/coerce_dict.pyx`, couldn't you get rid of\n> \n> ```\n> cdef extern from \"Python.h\":\n>     PyObject* PyWeakref_GetObject(object r)\n> ```\n> It is in `cpython.weakref`.\n\nSo it is now! I don't think it was before.\n\n> Do you know why `Py_None` is not available from Cython?\n\nIt is as \"None\", but then it's an `object`, and we need to compare it as a `PyObject *`. Cython's support for `PyObject *` (i.e., borrowed references) is poor -- basically intentionally so at the moment because a good interface (other than just the C interface) hasn't been formulated yet.\n\n> Could we also remove or comment the `cpdef inline Py_ssize_t signed_id(x)`?\n\nNo objections to that.",
    "created_at": "2015-04-20T18:32:40Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249840",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:20'></a>
Replying to [vdelecroix](#comment%3A19):
> Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe.

Correct, and I agree. Depending on the user giving parameters a particular name *and* cython mangling the names in a particular way is more fragile than what the CPython macro does. We only use this stuff twice, so it's not too onerous and much less obscure to be explicit in the code. If we find ourselves writing more "traverse" functions, we should push for a more structural solution in cython (currently we're already hacking by modifying a pytype structure after PyTypeReady has run on it).

> Could you explain to me the reason of declaring
> 
> ```
>     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
> ```
> and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.

See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.
> In `sage/structure/coerce_dict.pyx`, couldn't you get rid of
> 
> ```
> cdef extern from "Python.h":
>     PyObject* PyWeakref_GetObject(object r)
> ```
> It is in `cpython.weakref`.

So it is now! I don't think it was before.

> Do you know why `Py_None` is not available from Cython?

It is as "None", but then it's an `object`, and we need to compare it as a `PyObject *`. Cython's support for `PyObject *` (i.e., borrowed references) is poor -- basically intentionally so at the moment because a good interface (other than just the C interface) hasn't been formulated yet.

> Could we also remove or comment the `cpdef inline Py_ssize_t signed_id(x)`?

No objections to that.



---

archive/issue_comments_249841.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [nbruin](#comment%3A20):\n> Replying to [vdelecroix](#comment%3A19):\n> > Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe.\n\n> \n> Correct, and I agree. Depending on the user giving parameters a particular name *and* cython mangling the names in a particular way is more fragile than what the CPython macro does.\n\nHow about generalizing the macro to accept `visit` and `arg` arguments?\n\n> We only use this stuff twice\n\n8 times if I count correctly.",
    "created_at": "2015-04-20T19:54:11Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249841",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
Replying to [nbruin](#comment%3A20):
> Replying to [vdelecroix](#comment%3A19):
> > Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe.

> 
> Correct, and I agree. Depending on the user giving parameters a particular name *and* cython mangling the names in a particular way is more fragile than what the CPython macro does.

How about generalizing the macro to accept `visit` and `arg` arguments?

> We only use this stuff twice

8 times if I count correctly.



---

archive/issue_comments_249842.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [jdemeyer](#comment%3A21):\n> How about generalizing the macro to accept `visit` and `arg` arguments?\n\nFine with me. It's brainless boilerplate, but at least we have a clean macro that way that doesn't depend on naming conventions and (undocumented) cython behaviour.\n\n> > We only use this stuff twice\n\n> 8 times if I count correctly.\n\nOK, \"twice\"= in two simple, trivial, boilerplate routines :-).",
    "created_at": "2015-04-20T20:59:27Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249842",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:22'></a>
Replying to [jdemeyer](#comment%3A21):
> How about generalizing the macro to accept `visit` and `arg` arguments?

Fine with me. It's brainless boilerplate, but at least we have a clean macro that way that doesn't depend on naming conventions and (undocumented) cython behaviour.

> > We only use this stuff twice

> 8 times if I count correctly.

OK, "twice"= in two simple, trivial, boilerplate routines :-).



---

archive/issue_comments_249843.json:
```json
{
    "body": "<a id='comment:23'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/77e38d28e608521c7a79decf16bfb3f09b089737\">77e38d2</a></td><td><code>Define 3-argument version Py_VISIT3 of Py_VISIT</code></td></tr></table>\n",
    "created_at": "2015-04-21T09:03:21Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249843",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/77e38d28e608521c7a79decf16bfb3f09b089737">77e38d2</a></td><td><code>Define 3-argument version Py_VISIT3 of Py_VISIT</code></td></tr></table>




---

archive/issue_comments_249844.json:
```json
{
    "body": "**Changing commit** from \"[a10dcbaaaefb87d48cf337be367cd48f11ed6edf](https://github.com/sagemath/sagetrac-mirror/commit/a10dcbaaaefb87d48cf337be367cd48f11ed6edf)\" to \"[77e38d28e608521c7a79decf16bfb3f09b089737](https://github.com/sagemath/sagetrac-mirror/commit/77e38d28e608521c7a79decf16bfb3f09b089737)\".",
    "created_at": "2015-04-21T09:03:21Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249844",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[a10dcbaaaefb87d48cf337be367cd48f11ed6edf](https://github.com/sagemath/sagetrac-mirror/commit/a10dcbaaaefb87d48cf337be367cd48f11ed6edf)" to "[77e38d28e608521c7a79decf16bfb3f09b089737](https://github.com/sagemath/sagetrac-mirror/commit/77e38d28e608521c7a79decf16bfb3f09b089737)".



---

archive/issue_comments_249845.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,4 +4,4 @@\n - [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)\n - [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)\n \n-These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a bug-fix which isn't in Cython 0.22).\n+These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a [bug-fix](https://github.com/cython/cython/pull/380) which isn't in Cython 0.22).\n``````\n",
    "created_at": "2015-04-21T12:23:41Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249845",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,4 +4,4 @@
 - [https://github.com/cython/cython/pull/378](https://github.com/cython/cython/pull/378)
 - [https://github.com/cython/cython/pull/379](https://github.com/cython/cython/pull/379)
 
-These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a bug-fix which isn't in Cython 0.22).
+These got accepted with some additional changes. Since it involved several commits, I simply upgraded the whole `Cython/Includes` directory to the latest Cython git master (but I changed the relative `cimport`s back to absolute since that needs a [bug-fix](https://github.com/cython/cython/pull/380) which isn't in Cython 0.22).
``````




---

archive/issue_comments_249846.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [nbruin](#comment%3A20):\n> Replying to [vdelecroix](#comment%3A19):\n> > Could you explain to me the reason of declaring\n> > \n> > ```\n> >     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1\n> > ```\n> > and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.\n\n> \n> See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.\n\n`@`Nils: then do you think Cython is wrong here?\n\n> > In `sage/structure/coerce_dict.pyx`, couldn't you get rid of\n> > \n> > ```\n> > cdef extern from \"Python.h\":\n> >     PyObject* PyWeakref_GetObject(object r)\n> > ```\n> > It is in `cpython.weakref`.\n\n> \n> So it is now! I don't think it was before.\n\n`@`Jeroen: could this be done here?",
    "created_at": "2015-04-21T12:57:16Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249846",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>
Replying to [nbruin](#comment%3A20):
> Replying to [vdelecroix](#comment%3A19):
> > Could you explain to me the reason of declaring
> > 
> > ```
> >     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
> > ```
> > and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.

> 
> See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.

`@`Nils: then do you think Cython is wrong here?

> > In `sage/structure/coerce_dict.pyx`, couldn't you get rid of
> > 
> > ```
> > cdef extern from "Python.h":
> >     PyObject* PyWeakref_GetObject(object r)
> > ```
> > It is in `cpython.weakref`.

> 
> So it is now! I don't think it was before.

`@`Jeroen: could this be done here?



---

archive/issue_comments_249847.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [vdelecroix](#comment%3A25):\n> Replying to [nbruin](#comment%3A20):\n> > Replying to [vdelecroix](#comment%3A19):\n> > > Could you explain to me the reason of declaring\n> > > \n> > > ```\n> > >     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1\n> > > ```\n> > > and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.\n\n> > \n> > See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.\n\n> \n> `@`Nils: then do you think Cython is wrong here?\n> \n> > > In `sage/structure/coerce_dict.pyx`, couldn't you get rid of\n> > > \n> > > ```\n> > > cdef extern from \"Python.h\":\n> > >     PyObject* PyWeakref_GetObject(object r)\n> > > ```\n> > > It is in `cpython.weakref`.\n\n> > \n> > So it is now! I don't think it was before.\n\n> \n> `@`Jeroen: could this be done here?\n\nBoth questions have the same answer: using `PyObject*` instead of `object` is the right thing in this specific use case. Cython isn't wrong, it's just that we are doing very low-level stuff for which the standard Cython declarations don't work.",
    "created_at": "2015-04-21T18:57:28Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249847",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Replying to [vdelecroix](#comment%3A25):
> Replying to [nbruin](#comment%3A20):
> > Replying to [vdelecroix](#comment%3A19):
> > > Could you explain to me the reason of declaring
> > > 
> > > ```
> > >     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
> > > ```
> > > and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.

> > 
> > See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.

> 
> `@`Nils: then do you think Cython is wrong here?
> 
> > > In `sage/structure/coerce_dict.pyx`, couldn't you get rid of
> > > 
> > > ```
> > > cdef extern from "Python.h":
> > >     PyObject* PyWeakref_GetObject(object r)
> > > ```
> > > It is in `cpython.weakref`.

> > 
> > So it is now! I don't think it was before.

> 
> `@`Jeroen: could this be done here?

Both questions have the same answer: using `PyObject*` instead of `object` is the right thing in this specific use case. Cython isn't wrong, it's just that we are doing very low-level stuff for which the standard Cython declarations don't work.



---

archive/issue_comments_249848.json:
```json
{
    "body": "<a id='comment:27'></a>\n`PyWeakref_GetObject` is defined in ` cpython.weakref` as\n\n```\n    PyObject* PyWeakref_GetObject(object ref)\n    # Return the referenced object from a weak reference, ref.  If the\n    # referent is no longer live, returns None.\n```",
    "created_at": "2015-04-21T19:02:52Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249848",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'></a>
`PyWeakref_GetObject` is defined in ` cpython.weakref` as

```
    PyObject* PyWeakref_GetObject(object ref)
    # Return the referenced object from a weak reference, ref.  If the
    # referent is no longer live, returns None.
```



---

archive/issue_comments_249849.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [vdelecroix](#comment%3A27):\n> `PyWeakref_GetObject` is defined in ` cpython.weakref` as\n> \n> ```\n>     PyObject* PyWeakref_GetObject(object ref)\n>     # Return the referenced object from a weak reference, ref.  If the\n>     # referent is no longer live, returns None.\n> ```\n\nYes, and that is the same signature as with which it is defined in `coerce_dict.pyx`. Apparently we're only dereferencing weakrefs we are actually owning (i.e., `object`s). Its return type is also correctly typed, since it returns a *borrowed* reference, so the normal use of storing the returned value into an `<object>` leads exactly to the INCREF required to ensure the object doesn't get deallocated.\n\nI am pretty sure that if this is now available in cpython.weakref, we can cimport it from there rather than explicitly \"cdef extern\" it from \"Python.h\". Of course, there will be absolutely no difference to the eventual code generated either.",
    "created_at": "2015-04-21T19:13:30Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249849",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:28'></a>
Replying to [vdelecroix](#comment%3A27):
> `PyWeakref_GetObject` is defined in ` cpython.weakref` as
> 
> ```
>     PyObject* PyWeakref_GetObject(object ref)
>     # Return the referenced object from a weak reference, ref.  If the
>     # referent is no longer live, returns None.
> ```

Yes, and that is the same signature as with which it is defined in `coerce_dict.pyx`. Apparently we're only dereferencing weakrefs we are actually owning (i.e., `object`s). Its return type is also correctly typed, since it returns a *borrowed* reference, so the normal use of storing the returned value into an `<object>` leads exactly to the INCREF required to ensure the object doesn't get deallocated.

I am pretty sure that if this is now available in cpython.weakref, we can cimport it from there rather than explicitly "cdef extern" it from "Python.h". Of course, there will be absolutely no difference to the eventual code generated either.



---

archive/issue_events_162568.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-21T19:44:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162568"
}
```



---

archive/issue_events_162569.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-21T19:44:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162569"
}
```



---

archive/issue_comments_249850.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8\">58c17fb</a></td><td><code>cimport PyWeakref_GetObject() from cpython.weakref</code></td></tr></table>\n",
    "created_at": "2015-04-21T20:02:23Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249850",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8">58c17fb</a></td><td><code>cimport PyWeakref_GetObject() from cpython.weakref</code></td></tr></table>




---

archive/issue_comments_249851.json:
```json
{
    "body": "**Changing commit** from \"[77e38d28e608521c7a79decf16bfb3f09b089737](https://github.com/sagemath/sagetrac-mirror/commit/77e38d28e608521c7a79decf16bfb3f09b089737)\" to \"[58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)\".",
    "created_at": "2015-04-21T20:02:23Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249851",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[77e38d28e608521c7a79decf16bfb3f09b089737](https://github.com/sagemath/sagetrac-mirror/commit/77e38d28e608521c7a79decf16bfb3f09b089737)" to "[58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)".



---

archive/issue_events_162570.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-21T20:02:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162570"
}
```



---

archive/issue_events_162571.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-21T20:02:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162571"
}
```



---

archive/issue_comments_249852.json:
```json
{
    "body": "**Reviewer:** Vincent Delecroix, Nils Bruin",
    "created_at": "2015-04-21T20:26:51Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249852",
    "user": "https://github.com/videlec"
}
```

**Reviewer:** Vincent Delecroix, Nils Bruin



---

archive/issue_comments_249853.json:
```json
{
    "body": "<a id='comment:32'></a>\nI have no further remark.\n\nVincent",
    "created_at": "2015-04-21T20:26:51Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249853",
    "user": "https://github.com/videlec"
}
```

<a id='comment:32'></a>
I have no further remark.

Vincent



---

archive/issue_events_162572.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2015-04-22T05:13:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162572"
}
```



---

archive/issue_events_162573.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2015-04-22T05:13:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162573"
}
```



---

archive/issue_comments_249854.json:
```json
{
    "body": "<a id='comment:33'></a>\nseems good to me!",
    "created_at": "2015-04-22T05:13:47Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249854",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:33'></a>
seems good to me!



---

archive/issue_events_162574.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-23T03:21:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162574"
}
```



---

archive/issue_events_162575.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "90333a99a7878a81d5603dbf7baffb6819701466",
    "created_at": "2015-04-23T03:21:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162575"
}
```



---

archive/issue_comments_249855.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/patch_cython_with_pytypeobject_members](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/patch_cython_with_pytypeobject_members)\" to \"[58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)\".",
    "created_at": "2015-04-23T03:21:55Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249855",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/patch_cython_with_pytypeobject_members](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/patch_cython_with_pytypeobject_members)" to "[58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)".



---

archive/issue_comments_249856.json:
```json
{
    "body": "**Changing commit** from \"[58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)\" to \"\".",
    "created_at": "2015-04-25T02:08:46Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249856",
    "user": "https://github.com/nexttime"
}
```

**Changing commit** from "[58c17fbe84b31e534be250907717c52b8827e1d8](https://github.com/sagemath/sagetrac-mirror/commit/58c17fbe84b31e534be250907717c52b8827e1d8)" to "".



---

archive/issue_comments_249857.json:
```json
{
    "body": "<a id='comment:35'></a>\nPlease, guys, fix the milestones...  (It's odd enough \"Merged in\" gets no longer filled.)",
    "created_at": "2015-04-25T02:08:46Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249857",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:35'></a>
Please, guys, fix the milestones...  (It's odd enough "Merged in" gets no longer filled.)



---

archive/issue_events_162576.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2015-04-25T02:08:46Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162576"
}
```



---

archive/issue_events_162577.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2015-04-25T02:08:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18121#event-162577"
}
```



---

archive/issue_comments_249858.json:
```json
{
    "body": "<a id='comment:36'></a>\nthis ticket was opened before 6.7",
    "created_at": "2015-04-25T02:10:59Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249858",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:36'></a>
this ticket was opened before 6.7



---

archive/issue_comments_249859.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [vbraun](#comment%3A36):\n> this ticket was opened before 6.7\n\nSo what?  Besides that `vbraun_spam` appears to be on holidays since a while, certainly 6.6 got released before this ticket got closed.  (And it's based on 6.7.beta2.)\n\nIf someone sees a closed milestone on a (closed) ticket, the first guess is that it'd been merged into that release.\n\nI'm certainly not the only one not wanting having to read the ticket history and/or to look up the parent(s) of the commit to find out whether that's true or not.\n\nEspecially \"ordinary\" Sage users simply won't do that, e.g. if they want to find out whether a bug has already been fixed, and if so, in which [stable] release.",
    "created_at": "2015-04-25T02:42:44Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249859",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:37'></a>
Replying to [vbraun](#comment%3A36):
> this ticket was opened before 6.7

So what?  Besides that `vbraun_spam` appears to be on holidays since a while, certainly 6.6 got released before this ticket got closed.  (And it's based on 6.7.beta2.)

If someone sees a closed milestone on a (closed) ticket, the first guess is that it'd been merged into that release.

I'm certainly not the only one not wanting having to read the ticket history and/or to look up the parent(s) of the commit to find out whether that's true or not.

Especially "ordinary" Sage users simply won't do that, e.g. if they want to find out whether a bug has already been fixed, and if so, in which [stable] release.



---

archive/issue_comments_249860.json:
```json
{
    "body": "<a id='comment:38'></a>\nWe agreed to not update the milestone at each new release. Karl-Dieter wanted to write a script to set the milestone (edit: I mean merged-in) after each release, I'm sure he would appreciate help...",
    "created_at": "2015-04-25T02:44:59Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249860",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:38'></a>
We agreed to not update the milestone at each new release. Karl-Dieter wanted to write a script to set the milestone (edit: I mean merged-in) after each release, I'm sure he would appreciate help...



---

archive/issue_comments_249861.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [vbraun](#comment%3A38):\n> We agreed to not update the milestone at each new release.\n\nWhy?  (Pointer?)\n\nIf so, then at least the milestone should get corrected by the authors/reviewers or the RM before it gets closed.\n\nBut it's annoying to have open (new/needs review/whatever) tickets for already closed milestones; usual queries will no longer work (as expected).\n\n\n\n\n\n> Karl-Dieter wanted to write a script to set the milestone (edit: I mean merged-in) after each release, I'm sure he would appreciate help...\n\nThe only thing one needs is a \"spam\" trac account... ;-)",
    "created_at": "2015-04-25T03:06:46Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249861",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:39'></a>
Replying to [vbraun](#comment%3A38):
> We agreed to not update the milestone at each new release.

Why?  (Pointer?)

If so, then at least the milestone should get corrected by the authors/reviewers or the RM before it gets closed.

But it's annoying to have open (new/needs review/whatever) tickets for already closed milestones; usual queries will no longer work (as expected).





> Karl-Dieter wanted to write a script to set the milestone (edit: I mean merged-in) after each release, I'm sure he would appreciate help...

The only thing one needs is a "spam" trac account... ;-)



---

archive/issue_comments_249862.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [leif](#comment%3A39):\n> Why?  (Pointer?)\n\nGoogle? ... sigh... http://thread.gmane.org/gmane.comp.mathematics.sage.devel/74794/focus=74860",
    "created_at": "2015-04-25T03:16:41Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249862",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:40'></a>
Replying to [leif](#comment%3A39):
> Why?  (Pointer?)

Google? ... sigh... http://thread.gmane.org/gmane.comp.mathematics.sage.devel/74794/focus=74860



---

archive/issue_comments_249863.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [vbraun](#comment%3A40):\n> Replying to [leif](#comment%3A39):\n> > Why?  (Pointer?)\n\n> \n> Google? \n\nGmane!\n\n> ... sigh... http://thread.gmane.org/gmane.comp.mathematics.sage.devel/74794/focus=74860\n\n\nQuoting Ivan: *\"Why can\u2019t we just set them all to future, **and then when they get merged, we can change the milestone to the actual version**?\"*",
    "created_at": "2015-04-25T04:38:40Z",
    "issue": "https://github.com/sagemath/sage/issues/18121",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18121#issuecomment-249863",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:41'></a>
Replying to [vbraun](#comment%3A40):
> Replying to [leif](#comment%3A39):
> > Why?  (Pointer?)

> 
> Google? 

Gmane!

> ... sigh... http://thread.gmane.org/gmane.comp.mathematics.sage.devel/74794/focus=74860


Quoting Ivan: *"Why can’t we just set them all to future, **and then when they get merged, we can change the milestone to the actual version**?"*
