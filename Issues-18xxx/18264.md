# Issue 18264: make map_coefficients in modules_with_basis safer or more general

archive/issues_018027.json:
```json
{
    "assignees": [],
    "body": "We would love to be able to, for example, present a symmetric function with factored coefficients.  But:\n\n```\nsage: f = SymmetricFunctions(ZZ).s()([2,2,1])\nsage: f.map_coefficients(factor)\n0\n```\n\nThe result is not against the specification, because `map_coefficients` requires an endofunction.\n\nThere are two issues:\n\n1.) we possibly want to be warned when supplying `map_coefficients` with something that is not an endofunction.  This might be achieved by adding an optional argument `check` with default `True`.\n\n2.) we want some way to factor the coefficients.  Nicolas proposed to make something like\n\n```\nsage: f.map_coefficients(factor, codomain=SR)\n```\nor\n\n```\nsage: f.change_base_ring(SR).map_coefficients(factor) \n```\nwork.\n\nNote that the `Polynomial` class contains something similar, namely:\n\n```\ndef map_coefficients(self, f, new_base_ring=None)\n```\n\nHowever, there might be another tiny problem: it seems that currently it is not possible to make factored integers into a commutative ring.  This should possibly be a separate ticket.\n\nCC:  @zabrocki @darijgr @sagetrac-sage-combinat @hivert\n\nKeywords: **map_coefficients, modules_with_basis, base_ring, check arguments**\n\nBranch/Commit: **[public/ticket/18264](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/18264) @ [`d0d80e7`](https://github.com/sagemath/sagetrac-mirror/commit/d0d80e73ccae7a5823e8692e72e0c31e59800e1b)**\n\nReviewer: **Nicolas M. Thi\u00e9ry**\n\nAuthor: **Martin Rubey**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/18264_\n\n",
    "created_at": "2015-04-21T07:05:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "make map_coefficients in modules_with_basis safer or more general",
    "type": "issue",
    "updated_at": "2022-12-29T01:31:57Z",
    "url": "https://github.com/sagemath/sage/issues/18264",
    "user": "https://github.com/mantepse"
}
```
We would love to be able to, for example, present a symmetric function with factored coefficients.  But:

```
sage: f = SymmetricFunctions(ZZ).s()([2,2,1])
sage: f.map_coefficients(factor)
0
```

The result is not against the specification, because `map_coefficients` requires an endofunction.

There are two issues:

1.) we possibly want to be warned when supplying `map_coefficients` with something that is not an endofunction.  This might be achieved by adding an optional argument `check` with default `True`.

2.) we want some way to factor the coefficients.  Nicolas proposed to make something like

```
sage: f.map_coefficients(factor, codomain=SR)
```
or

```
sage: f.change_base_ring(SR).map_coefficients(factor) 
```
work.

Note that the `Polynomial` class contains something similar, namely:

```
def map_coefficients(self, f, new_base_ring=None)
```

However, there might be another tiny problem: it seems that currently it is not possible to make factored integers into a commutative ring.  This should possibly be a separate ticket.

CC:  @zabrocki @darijgr @sagetrac-sage-combinat @hivert

Keywords: **map_coefficients, modules_with_basis, base_ring, check arguments**

Branch/Commit: **[public/ticket/18264](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/18264) @ [`d0d80e7`](https://github.com/sagemath/sagetrac-mirror/commit/d0d80e73ccae7a5823e8692e72e0c31e59800e1b)**

Reviewer: **Nicolas M. Thi√©ry**

Author: **Martin Rubey**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/18264_





---

archive/issue_events_260876.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2015-04-21T07:05:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "milestone_number": null,
    "milestone_title": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260876"
}
```



---

archive/issue_events_260877.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2015-04-21T07:05:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260877"
}
```



---

archive/issue_events_260878.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2015-04-21T07:05:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260878"
}
```



---

archive/issue_events_260879.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2015-04-21T07:09:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260879"
}
```



---

archive/issue_comments_250411.json:
```json
{
    "body": "Branch: **[u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general)**",
    "created_at": "2015-04-21T18:39:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250411",
    "user": "https://github.com/mantepse"
}
```

Branch: **[u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general)**



---

archive/issue_comments_250412.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nDoing this I noticed that `map_coefficients` did not make use of the `distinct` feature of `sum_of_terms`.  I added this too, assuming that initially an element has distinct monomials.",
    "created_at": "2015-04-21T18:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250412",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:3" align="right">comment:3</div>

Doing this I noticed that `map_coefficients` did not make use of the `distinct` feature of `sum_of_terms`.  I added this too, assuming that initially an element has distinct monomials.



---

archive/issue_comments_250413.json:
```json
{
    "body": "Commit: **[`3a7761e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7761e95b8ca8b83e08635828a3754d751fe918)**",
    "created_at": "2015-04-21T18:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250413",
    "user": "https://github.com/mantepse"
}
```

Commit: **[`3a7761e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7761e95b8ca8b83e08635828a3754d751fe918)**



---

archive/issue_comments_250414.json:
```json
{
    "body": "Author: **Martin Rubey**",
    "created_at": "2015-04-21T19:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250414",
    "user": "https://github.com/mantepse"
}
```

Author: **Martin Rubey**



---

archive/issue_events_260880.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2015-04-22T10:19:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260880"
}
```



---

archive/issue_events_260881.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2015-04-22T10:19:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260881"
}
```



---

archive/issue_events_260882.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2015-04-22T10:19:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260882"
}
```



---

archive/issue_comments_250415.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHi Martin!\n\nThanks for taking action; this is looking good!\n\nNow that I am reading actual code: a usual idiom to check that a\ncoefficient is indeed in the base ring is to coerce it back there with\n`R(c)`. I guess that would be a fine behavior: it's faster, and it\ntakes care of all cases where someone passes an int, or something that\nrequires some small coercion to be put back in the base ring.\n\nMaybe the option shall be named `coerce` after all. Comments anyone?\n\nNote by the way that coercing would fail in Mike's original use case,\nso whether we go for `coerce` or `check` don't make a difference\nthere:\n\n```\nsage: ZZ(factor(4))\nTypeError: unable to coerce <class 'sage.structure.factorization_integer.IntegerFactorization'> to an integer\n```\n\n\nIf we go for the coerce way, then the simplest would be to pass this\noption down to `sum_of_terms`. This requires updating\n`CombinatorialFreeModule.sum_of_terms` to implement that option, by\npassing it down to respectively `CombinatorialFreeModule._from_dict`\nwhere it's already implemented and `CombinatorialFreeModule.term`\nwhere it would need to be implemented by passing the option down to\n`_from_dict`.\n\nIt's getting a bit bigger of a change than what was planned for\noriginaly; do you feel like handling it?\n\nCheers,\n                        Nicolas",
    "created_at": "2015-04-22T10:35:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250415",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:7" align="right">comment:7</div>

Hi Martin!

Thanks for taking action; this is looking good!

Now that I am reading actual code: a usual idiom to check that a
coefficient is indeed in the base ring is to coerce it back there with
`R(c)`. I guess that would be a fine behavior: it's faster, and it
takes care of all cases where someone passes an int, or something that
requires some small coercion to be put back in the base ring.

Maybe the option shall be named `coerce` after all. Comments anyone?

Note by the way that coercing would fail in Mike's original use case,
so whether we go for `coerce` or `check` don't make a difference
there:

```
sage: ZZ(factor(4))
TypeError: unable to coerce <class 'sage.structure.factorization_integer.IntegerFactorization'> to an integer
```


If we go for the coerce way, then the simplest would be to pass this
option down to `sum_of_terms`. This requires updating
`CombinatorialFreeModule.sum_of_terms` to implement that option, by
passing it down to respectively `CombinatorialFreeModule._from_dict`
where it's already implemented and `CombinatorialFreeModule.term`
where it would need to be implemented by passing the option down to
`_from_dict`.

It's getting a bit bigger of a change than what was planned for
originaly; do you feel like handling it?

Cheers,
                        Nicolas



---

archive/issue_comments_250416.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@nthiery](#comment:7):\n\n> If we go for the coerce way, then the simplest would be to pass this\n> option down to `sum_of_terms`. This requires updating\n> `CombinatorialFreeModule.sum_of_terms` to implement that option, by\n> passing it down to respectively `CombinatorialFreeModule._from_dict`\n> where it's already implemented and `CombinatorialFreeModule.term`\n> where it would need to be implemented by passing the option down to\n> `_from_dict`.\n\nI agree and will do that as soon as my sage works again (see sage-devel thread...)",
    "created_at": "2015-04-23T04:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250416",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@nthiery](#comment:7):

> If we go for the coerce way, then the simplest would be to pass this
> option down to `sum_of_terms`. This requires updating
> `CombinatorialFreeModule.sum_of_terms` to implement that option, by
> passing it down to respectively `CombinatorialFreeModule._from_dict`
> where it's already implemented and `CombinatorialFreeModule.term`
> where it would need to be implemented by passing the option down to
> `_from_dict`.

I agree and will do that as soon as my sage works again (see sage-devel thread...)



---

archive/issue_comments_250417.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nHi there!\n\nI was just about to do what Nicolas suggest -- adding an optional argument `coerce`, but I encountered some things that make me hesitate:\n\n1. to be helpful for the casual user, it's default value would have to be `True` - differently from what we have in `_from_dict`.\n\n2. the docstring would then be something like\n\n```\nwhether to try to coerce the result of applying `f` to the coefficient ring.\n```\n\n    which is a bit strange, given that we require `f` to be an endofunction.\n\nIf you reassure me, I'll do it.  I'm just not 100% sure myself.",
    "created_at": "2015-04-24T18:13:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250417",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:10" align="right">comment:10</div>

Hi there!

I was just about to do what Nicolas suggest -- adding an optional argument `coerce`, but I encountered some things that make me hesitate:

1. to be helpful for the casual user, it's default value would have to be `True` - differently from what we have in `_from_dict`.

2. the docstring would then be something like

```
whether to try to coerce the result of applying `f` to the coefficient ring.
```

    which is a bit strange, given that we require `f` to be an endofunction.

If you reassure me, I'll do it.  I'm just not 100% sure myself.



---

archive/issue_comments_250418.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@mantepse](#comment:10):\n> 1. to be helpful for the casual user, it's default value would have to be `True`\n> - differently from what we have in `_from_dict`.\n\nYeah, I agree; it's not supper consistent. Yet `_from_dict` is a\nprivate method when this one is public; so it's not unreasonable\neither that the typical usage situation differ, inducing different\ndefault behavior.\n\n> 2. the docstring would then be something like\n> \n> ```\n> whether to try to coerce the result of applying `f` to the coefficient ring.\n> ```\n> \n>     which is a bit strange, given that we require `f` to be an endofunction.\n\nI see your point. We should be able to find some wording that makes it\nsound natural. Maybe something like:\n\n`Whether to systematically coerce to the coefficient ring the result\nof applying `f`, for additional safety`.\n\nFrom my perspective you can proceed! Feedback anyone else?\n\nCheers,",
    "created_at": "2015-04-24T20:51:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250418",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@mantepse](#comment:10):
> 1. to be helpful for the casual user, it's default value would have to be `True`
> - differently from what we have in `_from_dict`.

Yeah, I agree; it's not supper consistent. Yet `_from_dict` is a
private method when this one is public; so it's not unreasonable
either that the typical usage situation differ, inducing different
default behavior.

> 2. the docstring would then be something like
> 
> ```
> whether to try to coerce the result of applying `f` to the coefficient ring.
> ```
> 
>     which is a bit strange, given that we require `f` to be an endofunction.

I see your point. We should be able to find some wording that makes it
sound natural. Maybe something like:

`Whether to systematically coerce to the coefficient ring the result
of applying `f`, for additional safety`.

From my perspective you can proceed! Feedback anyone else?

Cheers,



---

archive/issue_comments_250419.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nDone (currently testing).\n\nA question: in general, what is the requirement on the coefficients (morally, not enforced...)?\n\n1) they should be in the base ring\n2) they should be coercible to the base ring\n3) you shouldn't expect anything...\n\n1: In the internal representation, the coefficients are supposed to be\nin the base ring and non zero (as tested by `bool(c)` aka\n`c.__nonzero__()`).\n\nI indeed would not be surprised if there were quite a few places in\nthe Sage sources where those assumptions are broken / abused. It would\nbe good to progressively detect and fix them. A step in this direction\nis to find a better speed/safety/flexibility balance for when to run\nsanity checks, or not, as you are doing here.",
    "created_at": "2015-04-25T06:38:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250419",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:12" align="right">comment:12</div>

Done (currently testing).

A question: in general, what is the requirement on the coefficients (morally, not enforced...)?

1) they should be in the base ring
2) they should be coercible to the base ring
3) you shouldn't expect anything...

1: In the internal representation, the coefficients are supposed to be
in the base ring and non zero (as tested by `bool(c)` aka
`c.__nonzero__()`).

I indeed would not be surprised if there were quite a few places in
the Sage sources where those assumptions are broken / abused. It would
be good to progressively detect and fix them. A step in this direction
is to find a better speed/safety/flexibility balance for when to run
sanity checks, or not, as you are doing here.



---

archive/issue_comments_250420.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAs it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:\n\n```\nFile \"src/sage/combinat/ncsf_qsym/ncsf.py\", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi\nFailed example:\n    test_psi(2)\n    ...\n    TypeError: no conversion of this rational to integer\n```\n\nThe test which fails looks as follows:\n\n```\nsage: NCSF = NonCommutativeSymmetricFunctions(ZZ)\nsage: R = NCSF.R()\nsage: Psi = NCSF.Psi()\nsage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])\nsage: Psi(a)\n```\n\nThe expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is \"3\".\n\nMartin",
    "created_at": "2015-04-25T07:27:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250420",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:13" align="right">comment:13</div>

As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:

```
File "src/sage/combinat/ncsf_qsym/ncsf.py", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi
Failed example:
    test_psi(2)
    ...
    TypeError: no conversion of this rational to integer
```

The test which fails looks as follows:

```
sage: NCSF = NonCommutativeSymmetricFunctions(ZZ)
sage: R = NCSF.R()
sage: Psi = NCSF.Psi()
sage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])
sage: Psi(a)
```

The expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is "3".

Martin



---

archive/issue_comments_250421.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@mantepse](#comment:13):\n> As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:\n\nOk. Can you post here the test summary with the list of failing files,\njust to get an idea of how bad this is?\n\n> ```\n> File \"src/sage/combinat/ncsf_qsym/ncsf.py\", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi\n> Failed example:\n>     test_psi(2)\n>     ...\n>     TypeError: no conversion of this rational to integer\n> ```\n> \n> The test which fails looks as follows:\n> \n> ```\n> sage: NCSF = NonCommutativeSymmetricFunctions(ZZ)\n> sage: R = NCSF.R()\n> sage: Psi = NCSF.Psi()\n> sage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])\n> sage: Psi(a)\n> ```\n> \n> The expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is \"3\".\n\nIf some intermediate calculations involve rational coefficients, then\nwe definitely want a failure here. Maybe there is a way to improve the\nncsf code to better support NCSF over integers by sticking to integral\ncomputations.\n\nDarij, Mike, ..., what do you think? Do you have a quick way to improve NCSF's\nhandling of integral coefficients? Or is it ok to switch this test to\n`QQ` or mark it as \"not implemented\" for now?",
    "created_at": "2015-04-25T08:59:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250421",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@mantepse](#comment:13):
> As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:

Ok. Can you post here the test summary with the list of failing files,
just to get an idea of how bad this is?

> ```
> File "src/sage/combinat/ncsf_qsym/ncsf.py", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi
> Failed example:
>     test_psi(2)
>     ...
>     TypeError: no conversion of this rational to integer
> ```
> 
> The test which fails looks as follows:
> 
> ```
> sage: NCSF = NonCommutativeSymmetricFunctions(ZZ)
> sage: R = NCSF.R()
> sage: Psi = NCSF.Psi()
> sage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])
> sage: Psi(a)
> ```
> 
> The expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is "3".

If some intermediate calculations involve rational coefficients, then
we definitely want a failure here. Maybe there is a way to improve the
ncsf code to better support NCSF over integers by sticking to integral
computations.

Darij, Mike, ..., what do you think? Do you have a quick way to improve NCSF's
handling of integral coefficients? Or is it ok to switch this test to
`QQ` or mark it as "not implemented" for now?



---

archive/issue_comments_250422.json:
```json
{
    "body": "Reviewer: **Nicolas M. Thi\u00e9ry**",
    "created_at": "2015-04-25T09:01:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250422",
    "user": "https://github.com/nthiery"
}
```

Reviewer: **Nicolas M. Thi√©ry**



---

archive/issue_comments_250423.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI think it's only\n\n```\n2 items had failures:\n   3 of  21 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Phi.Element.verschiebung\n   3 of   8 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi\n    [715 tests, 6 failures, 28.15 s]\n----------------------------------------------------------------------\nsage -t --warn-long 97.2 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2015-04-25T11:22:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250423",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:16" align="right">comment:16</div>

I think it's only

```
2 items had failures:
   3 of  21 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Phi.Element.verschiebung
   3 of   8 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi
    [715 tests, 6 failures, 28.15 s]
----------------------------------------------------------------------
sage -t --warn-long 97.2 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_250424.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOut of curiosity, I modified `_from_dict` to to always try coercion.  I then get some more failures:\n\n\n```\n----------------------------------------------------------------------\nsage -t --warn-long 74.6 src/sage/modular/modform_hecketriangle/hecke_triangle_group_element.py  # Timed out\nsage -t --warn-long 74.6 src/sage/algebras/steenrod/steenrod_algebra.py  # 1 doctest failed\nsage -t --warn-long 74.6 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed\nsage -t --warn-long 74.6 src/sage/combinat/sf/macdonald.py  # 4 doctests failed\nsage -t --warn-long 74.6 src/sage/combinat/free_module.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2015-04-25T13:44:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250424",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:17" align="right">comment:17</div>

Out of curiosity, I modified `_from_dict` to to always try coercion.  I then get some more failures:


```
----------------------------------------------------------------------
sage -t --warn-long 74.6 src/sage/modular/modform_hecketriangle/hecke_triangle_group_element.py  # Timed out
sage -t --warn-long 74.6 src/sage/algebras/steenrod/steenrod_algebra.py  # 1 doctest failed
sage -t --warn-long 74.6 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed
sage -t --warn-long 74.6 src/sage/combinat/sf/macdonald.py  # 4 doctests failed
sage -t --warn-long 74.6 src/sage/combinat/free_module.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_250425.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nDarij put some effort into making sure that `ncsf` and `qsym` worked over the integers in obvious ways.  I believe that this involved a lot of workarounds.\n\nI am concerned about the conflicts with macdonald.py.  I want to check those out carefully because we are in the process of fine tuning that code in #18194\n\nIMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...",
    "created_at": "2015-04-25T13:49:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250425",
    "user": "https://github.com/zabrocki"
}
```

<div id="comment:18" align="right">comment:18</div>

Darij put some effort into making sure that `ncsf` and `qsym` worked over the integers in obvious ways.  I believe that this involved a lot of workarounds.

I am concerned about the conflicts with macdonald.py.  I want to check those out carefully because we are in the process of fine tuning that code in #18194

IMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...



---

archive/issue_comments_250426.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nCan you tell me how to exactly reproduce the failing doctests in ncsf.py? I don't have time for the rest, but at least I should see what's going wrong in my code. The test_psi(n) tests, though, have every right to fail. They should be fixed by replacing `Psi(a) == Psi[n]` by `a == R(Psi[n])`.",
    "created_at": "2015-04-25T17:12:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250426",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:19" align="right">comment:19</div>

Can you tell me how to exactly reproduce the failing doctests in ncsf.py? I don't have time for the rest, but at least I should see what's going wrong in my code. The test_psi(n) tests, though, have every right to fail. They should be fixed by replacing `Psi(a) == Psi[n]` by `a == R(Psi[n])`.



---

archive/issue_comments_250427.json:
```json
{
    "body": "Changed commit from **[`3a7761e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7761e95b8ca8b83e08635828a3754d751fe918)** to **[`985e716`](https://github.com/sagemath/sagetrac-mirror/commit/985e716e917594185bf6ac44f9a602f8bd92f545)**",
    "created_at": "2015-04-25T18:35:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250427",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3a7761e`](https://github.com/sagemath/sagetrac-mirror/commit/3a7761e95b8ca8b83e08635828a3754d751fe918)** to **[`985e716`](https://github.com/sagemath/sagetrac-mirror/commit/985e716e917594185bf6ac44f9a602f8bd92f545)**



---

archive/issue_comments_250428.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/985e716e917594185bf6ac44f9a602f8bd92f545\"><code>985e716</code></a></td><td><code>pass coerce=True down to _from_dict</code></td></tr></table>\n",
    "created_at": "2015-04-25T18:35:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250428",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/985e716e917594185bf6ac44f9a602f8bd92f545"><code>985e716</code></a></td><td><code>pass coerce=True down to _from_dict</code></td></tr></table>




---

archive/issue_comments_250429.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOOps, I thought I pushed, but I actually only pushed just now.\n\nDarij, if you pull the current branch, you'll see the failures.",
    "created_at": "2015-04-25T18:36:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250429",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:21" align="right">comment:21</div>

OOps, I thought I pushed, but I actually only pushed just now.

Darij, if you pull the current branch, you'll see the failures.



---

archive/issue_comments_250430.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@zabrocki](#comment:18):\n\n> IMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...\n\nI don't think so.  A neat trick we should copy from FriCAS is to have a constructor `Factored` that takes a ring and returns a ring, keeping the elements in factored form.\n\nSo far, however, I do not know how to create a ring in sage...",
    "created_at": "2015-04-25T20:18:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250430",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@zabrocki](#comment:18):

> IMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...

I don't think so.  A neat trick we should copy from FriCAS is to have a constructor `Factored` that takes a ring and returns a ring, keeping the elements in factored form.

So far, however, I do not know how to create a ring in sage...



---

archive/issue_comments_250431.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI investigated the failure in `sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.coproduct`, which is actually not a real failure:\n\n```\nFailed example:\n    SteenrodAlgebra(p=11, profile=((), (2,1,2))).Q(0,2).coproduct()\nExpected:\n    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 - Q_2 # Q_0\nGot:\n    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 + 10*Q_2 # Q_0\n\n```\n\nThe `p=11` in the example means that the coefficient ring is the field with 11 elements, so -1 and 10 are actually the same thing.",
    "created_at": "2015-04-25T20:49:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250431",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:23" align="right">comment:23</div>

I investigated the failure in `sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.coproduct`, which is actually not a real failure:

```
Failed example:
    SteenrodAlgebra(p=11, profile=((), (2,1,2))).Q(0,2).coproduct()
Expected:
    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 - Q_2 # Q_0
Got:
    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 + 10*Q_2 # Q_0

```

The `p=11` in the example means that the coefficient ring is the field with 11 elements, so -1 and 10 are actually the same thing.



---

archive/issue_comments_250432.json:
```json
{
    "body": "Changed branch from **[u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general)** to **[public/ticket/18264](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/18264)**",
    "created_at": "2015-04-28T19:09:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250432",
    "user": "https://github.com/darijgr"
}
```

Changed branch from **[u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general)** to **[public/ticket/18264](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/18264)**



---

archive/issue_comments_250433.json:
```json
{
    "body": "Changed commit from **[`985e716`](https://github.com/sagemath/sagetrac-mirror/commit/985e716e917594185bf6ac44f9a602f8bd92f545)** to **[`d0d80e7`](https://github.com/sagemath/sagetrac-mirror/commit/d0d80e73ccae7a5823e8692e72e0c31e59800e1b)**",
    "created_at": "2015-04-28T19:09:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250433",
    "user": "https://github.com/darijgr"
}
```

Changed commit from **[`985e716`](https://github.com/sagemath/sagetrac-mirror/commit/985e716e917594185bf6ac44f9a602f8bd92f545)** to **[`d0d80e7`](https://github.com/sagemath/sagetrac-mirror/commit/d0d80e73ccae7a5823e8692e72e0c31e59800e1b)**



---

archive/issue_comments_250434.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e52f396d0ea92e98f3ea0a4426ae99bd5b187ae\"><code>6e52f39</code></a></td><td><code>Merge branch 'u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general' of git://trac.sagemath.org/sage into map</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0d80e73ccae7a5823e8692e72e0c31e59800e1b\"><code>d0d80e7</code></a></td><td><code>fix ncsf.py and steenrod_algebra.py (both times the doctests were bad)</code></td></tr></table>\n",
    "created_at": "2015-04-28T19:09:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250434",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:24"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e52f396d0ea92e98f3ea0a4426ae99bd5b187ae"><code>6e52f39</code></a></td><td><code>Merge branch 'u/mantepse/make_map_coefficients_in_modules_with_basis_safer_or_more_general' of git://trac.sagemath.org/sage into map</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0d80e73ccae7a5823e8692e72e0c31e59800e1b"><code>d0d80e7</code></a></td><td><code>fix ncsf.py and steenrod_algebra.py (both times the doctests were bad)</code></td></tr></table>




---

archive/issue_comments_250435.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI've fixed the doctests in two files.\n\nThe doc failure in macdonald.py seems a real issue. Mike? (Anyone who works on this needs the newest develop version, 6.7.beta3, since the Macdonald functions have undergone a major change in this version.)\n\nAlso the error in free_module.py itself seems to suggest that some optional parameters are being ignored...",
    "created_at": "2015-04-28T19:11:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250435",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:25" align="right">comment:25</div>

I've fixed the doctests in two files.

The doc failure in macdonald.py seems a real issue. Mike? (Anyone who works on this needs the newest develop version, 6.7.beta3, since the Macdonald functions have undergone a major change in this version.)

Also the error in free_module.py itself seems to suggest that some optional parameters are being ignored...



---

archive/issue_comments_250436.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@darijgr](#comment:25):\n> I've fixed the doctests in two files.\n\nThank you!\n\n> Also the error in free_module.py itself seems to suggest that some optional parameters are being ignored...\n\nYes, as I mentioned above (I hope), I \"manually\" set `coerce = True` in `_from_dict` to catch errors.",
    "created_at": "2015-04-28T19:23:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250436",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@darijgr](#comment:25):
> I've fixed the doctests in two files.

Thank you!

> Also the error in free_module.py itself seems to suggest that some optional parameters are being ignored...

Yes, as I mentioned above (I hope), I "manually" set `coerce = True` in `_from_dict` to catch errors.



---

archive/issue_comments_250437.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nOh! Does this mean I've built on top of an experimental branch? Sorry!",
    "created_at": "2015-04-28T19:25:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250437",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:27" align="right">comment:27</div>

Oh! Does this mean I've built on top of an experimental branch? Sorry!



---

archive/issue_comments_250438.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI'm sorry, I did not warn explicitely enough.\n\nTo get a production branch, simply remove the line `coerce = True` in `_from_dict` and recompile.",
    "created_at": "2015-04-29T04:55:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250438",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:28" align="right">comment:28</div>

I'm sorry, I did not warn explicitely enough.

To get a production branch, simply remove the line `coerce = True` in `_from_dict` and recompile.



---

archive/issue_comments_250439.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nThe doctest fixes are now in #19771.",
    "created_at": "2015-12-23T16:15:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250439",
    "user": "https://github.com/darijgr"
}
```

<div id="comment:29" align="right">comment:29</div>

The doctest fixes are now in #19771.



---

archive/issue_comments_250440.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nAnother case where the implementation of `map_coefficients` in `module_with_basis` is called but doesn't work:\n\n```\nsage: vector([1,2]).map_coefficients(lambda x: x+1)\n...\nTypeError: 'sage.rings.integer.Integer' object is not iterable\n```",
    "created_at": "2016-04-07T10:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/18264#issuecomment-250440",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:30" align="right">comment:30</div>

Another case where the implementation of `map_coefficients` in `module_with_basis` is called but doesn't work:

```
sage: vector([1,2]).map_coefficients(lambda x: x+1)
...
TypeError: 'sage.rings.integer.Integer' object is not iterable
```



---

archive/issue_events_260883.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:31:57Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/18264",
    "milestone_number": null,
    "milestone_title": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/18264#event-260883"
}
```
