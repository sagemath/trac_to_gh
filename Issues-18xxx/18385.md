# Issue 18385: deallocate pari when sage quits

archive/issues_018148.json:
```json
{
    "body": "As global module variables point toward the (unique) `PariInstance` instance built by Sage, and because those are not automatically cleaned, this instance is never deleted. Thus, we do it explicitly in `quit_sage`, as it was done before #13741.\n\nNathann\n\n[1] https://groups.google.com/d/topic/sage-devel/E-U4otPW9_0/discussion\n\nCC:  @nexttime jpflori\n\nBranch: public/18385\n\nStatus: needs_info\n\nCommit: 9bb69f848059d05ecb6566fa99d6e5d0624b6fa1\n\nIssue created by migration from https://trac.sagemath.org/ticket/18385\n\n",
    "created_at": "2015-05-09T06:38:29Z",
    "labels": [
        "component: memleak",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "deallocate pari when sage quits",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18385",
    "user": "https://github.com/nathanncohen"
}
```
As global module variables point toward the (unique) `PariInstance` instance built by Sage, and because those are not automatically cleaned, this instance is never deleted. Thus, we do it explicitly in `quit_sage`, as it was done before #13741.

Nathann

[1] https://groups.google.com/d/topic/sage-devel/E-U4otPW9_0/discussion

CC:  @nexttime jpflori

Branch: public/18385

Status: needs_info

Commit: 9bb69f848059d05ecb6566fa99d6e5d0624b6fa1

Issue created by migration from https://trac.sagemath.org/ticket/18385





---

archive/issue_comments_320063.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-09T06:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320063",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_320064.json:
```json
{
    "body": "Changing branch from \"\" to \"public/18385\"",
    "created_at": "2015-05-09T06:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320064",
    "user": "https://github.com/nathanncohen"
}
```

Changing branch from "" to "public/18385"



---

archive/issue_comments_320065.json:
```json
{
    "body": "Changing commit from \"\" to \"9bb69f848059d05ecb6566fa99d6e5d0624b6fa1\"",
    "created_at": "2015-05-09T06:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320065",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "9bb69f848059d05ecb6566fa99d6e5d0624b6fa1"



---

archive/issue_comments_320066.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[9bb69f8](http://git.sagemath.org/sage.git/commit/?id=9bb69f848059d05ecb6566fa99d6e5d0624b6fa1)|`trac #18385: deallocate pari when sage quits`|",
    "created_at": "2015-05-09T06:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320066",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[9bb69f8](http://git.sagemath.org/sage.git/commit/?id=9bb69f848059d05ecb6566fa99d6e5d0624b6fa1)|`trac #18385: deallocate pari when sage quits`|



---

archive/issue_comments_320067.json:
```json
{
    "body": "<a id='comment:3'></a>\nI don't like this. How can you be sure that no PARI code will be executed after deallocating the PARI stack?",
    "created_at": "2015-05-09T08:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320067",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
I don't like this. How can you be sure that no PARI code will be executed after deallocating the PARI stack?



---

archive/issue_comments_320068.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-05-09T08:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320068",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_320069.json:
```json
{
    "body": "<a id='comment:4'></a>\n> I don't like this. How can you be sure that no PARI code will be executed after deallocating the PARI stack?\n\n\nI am not, and you are right this is probably not a good idea after all. Do you know how we could do to have this be deallocated when it should?",
    "created_at": "2015-05-09T08:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320069",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:4'></a>
> I don't like this. How can you be sure that no PARI code will be executed after deallocating the PARI stack?


I am not, and you are right this is probably not a good idea after all. Do you know how we could do to have this be deallocated when it should?



---

archive/issue_comments_320070.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-As global module variables point toward the (unique) 'PariInstance' instance built by Sage, and because those are nto automatically cleaned, this instance is never deleted. Thus, we do it exlicitly in `quit_sage`.\n+As global module variables point toward the (unique) `PariInstance` instance built by Sage, and because those are not automatically cleaned, this instance is never deleted. Thus, we do it explicitly in `quit_sage`, as it was done before #13741.\n \n Nathann\n \n``````\n",
    "created_at": "2015-05-09T08:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320070",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-As global module variables point toward the (unique) 'PariInstance' instance built by Sage, and because those are nto automatically cleaned, this instance is never deleted. Thus, we do it exlicitly in `quit_sage`.
+As global module variables point toward the (unique) `PariInstance` instance built by Sage, and because those are not automatically cleaned, this instance is never deleted. Thus, we do it explicitly in `quit_sage`, as it was done before #13741.
 
 Nathann
 
``````




---

archive/issue_comments_320071.json:
```json
{
    "body": "<a id='comment:6'></a>\nOf course it's not nice, but the only alternatives that come to my mind are:\n\n* Add even more Valgrind suppressions.  (IMHO odd.)\n\n* Remove the global variable which is bad anyway. (Implies a performance penalty.)\n\n* Convince Cython to call the deallocator.  (I have no idea how; `del` in `quit_sage()` doesn't work.)",
    "created_at": "2015-05-09T09:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320071",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>
Of course it's not nice, but the only alternatives that come to my mind are:

* Add even more Valgrind suppressions.  (IMHO odd.)

* Remove the global variable which is bad anyway. (Implies a performance penalty.)

* Convince Cython to call the deallocator.  (I have no idea how; `del` in `quit_sage()` doesn't work.)



---

archive/issue_comments_320072.json:
```json
{
    "body": "<a id='comment:7'></a>\nWe should probably benchmark option !#2.",
    "created_at": "2015-05-09T09:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320072",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>
We should probably benchmark option !#2.



---

archive/issue_comments_320073.json:
```json
{
    "body": "<a id='comment:9'></a>\nI am against solving this problem \"by proxy\". The problem isn't that `pari` is never deallocated, the problem is apparently that Cython global variables are never deallocated. Even if you fix pari, then there are still a lot of other global variables with the same problem.",
    "created_at": "2015-11-24T10:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320073",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
I am against solving this problem "by proxy". The problem isn't that `pari` is never deallocated, the problem is apparently that Cython global variables are never deallocated. Even if you fix pari, then there are still a lot of other global variables with the same problem.



---

archive/issue_comments_320074.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [jdemeyer](#comment%3A9):\n> The problem isn't that `pari` is never deallocated, the problem is apparently that Cython global variables are never deallocated.\n\n\nA little googling gives me the impression that this is a wide-spread problem with python (extension) modules: there is no way to \"unload\" a module (which would be the time to deallocate global variables), and it seems it doesn't exist because people haven't been able to solve the subtle problems that arise in deciding when and in what order unloading should happen (especially extension modules seem to be complicated this way)\n\nIndeed, without extra information, the fact that arbitrary code could be executed upon deallocation means there is no sure-fire way to decide a correct way to order module deallocation. It wouldn't be hard to write 2 modules A and B such that the deallocation code of one requires the other module to be functional. One would require a rather careful protocol specification to allow module deactivation.\n\nWithout extra information, you cannot start deallocating global variables unless you know the module has been \"deactivated\". So I think Cython in general will not be solving this problem any time soon.",
    "created_at": "2015-11-24T18:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18385#issuecomment-320074",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:10'></a>
Replying to [jdemeyer](#comment%3A9):
> The problem isn't that `pari` is never deallocated, the problem is apparently that Cython global variables are never deallocated.


A little googling gives me the impression that this is a wide-spread problem with python (extension) modules: there is no way to "unload" a module (which would be the time to deallocate global variables), and it seems it doesn't exist because people haven't been able to solve the subtle problems that arise in deciding when and in what order unloading should happen (especially extension modules seem to be complicated this way)

Indeed, without extra information, the fact that arbitrary code could be executed upon deallocation means there is no sure-fire way to decide a correct way to order module deallocation. It wouldn't be hard to write 2 modules A and B such that the deallocation code of one requires the other module to be functional. One would require a rather careful protocol specification to allow module deactivation.

Without extra information, you cannot start deallocating global variables unless you know the module has been "deactivated". So I think Cython in general will not be solving this problem any time soon.
