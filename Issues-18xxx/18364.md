# Issue 18364: Building libgd fails if libvpx 1.4 is installed

archive/issues_018127.json:
```json
{
    "body": "I currently fail to build sage 6.7.beta1 from scratch:\n\n```\nlibtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I\u2026/sage/local/include/libpng12 -I\u2026/sage/local/include/freetype2 -g -fvisibility=hidden -MT webpimg.lo -MD -MP -MF .deps/webpimg.Tpo -c webpimg.c  -fPIC -DPIC -o .libs/webpimg.o\nwebpimg.c: In function 'VPXEncode':\nwebpimg.c:714:24: error: 'IMG_FMT_I420' undeclared (first use in this function)\n     vpx_img_wrap(&img, IMG_FMT_I420,\n                        ^\nwebpimg.c:714:24: note: each undeclared identifier is reported only once for each function it appears in\nwebpimg.c:716:16: error: 'PLANE_Y' undeclared (first use in this function)\n     img.planes[PLANE_Y] = (uint8*)(Y);\n                ^\nwebpimg.c:717:16: error: 'PLANE_U' undeclared (first use in this function)\n     img.planes[PLANE_U] = (uint8*)(U);\n                ^\nwebpimg.c:718:16: error: 'PLANE_V' undeclared (first use in this function)\n     img.planes[PLANE_V] = (uint8*)(V);\n                ^\nMakefile:773: recipe for target 'webpimg.lo' failed\nmake[5]: *** [webpimg.lo] Error 1\nmake[5]: Leaving directory '\u2026/sage/local/var/tmp/sage/build/libgd-2.1.0.p0/src/src'\nMakefile:439: recipe for target 'all' failed\nmake[4]: *** [all] Error 2\nmake[4]: Leaving directory '\u2026/sage/local/var/tmp/sage/build/libgd-2.1.0.p0/src/src'\nMakefile:341: recipe for target 'all-recursive' failed\nmake[3]: *** [all-recursive] Error 1\nmake[3]: Leaving directory '\u2026/sage/local/var/tmp/sage/build/libgd-2.1.0.p0/src'\nError building gd.\n```\n\nThis is related to the auto-detected configure setting\n\n```\n   Support for VPX library:          yes\n```\n\nFortunately I've recently encountered the same issue for Gentoo with the libgd bundled with php ([Gentoo bug #547310](https://bugs.gentoo.org/show_bug.cgi?id=547310)). The issue is related to [this change](http://git.chromium.org/gitweb/?p=webm/libvpx.git;a=blobdiff;f=vpx/vpx_image.h;h=ef6d1dd3092e5c8e70173a4fc9def62c8eedef01;hp=0b7bb90572da3c0d0048285dffb7ed847f762823;hb=9cdaa3d72eade9ad162ef8f78a93bd8f85c6de10;hpb=0ecc75c81986a277d2e8e387117edfc21cb2fed0) for libvpx, which removed some legacy symbols. Prefixing those symbols with `VPX_` solves the issue, as done in [this commit](https://github.com/gagern/libgd/commit/d41eb72cd4545c394578332e5c102dee69e02ee8) to the GD-2.1 branch.\n\nI think we have at least four solutions at our disposal:\n\n1. Fix symbol names in libgd 2.1 by patching in [this commit](https://github.com/gagern/libgd/commit/d41eb72cd4545c394578332e5c102dee69e02ee8)\n2. Explicitely disable libvpx support, to avoid linking against system library there\n3. Bundle libvpx at a given version to become independent of system library\n4. Upgrade to libgd 2.2 (once that's available), which should use libwebp instead of libvpx according to [libgd ticket #129](https://github.com/libgd/libgd/issues/129)\n\nWhich solution would you prefer? 1. differs the least from what we currently do, but that doesn't neccessarily make it the best solution.\n\nReviewer: Martin von Gagern\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/18364\n\n",
    "closed_at": "2015-05-19T06:45:28Z",
    "created_at": "2015-05-04T12:59:58Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Building libgd fails if libvpx 1.4 is installed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18364",
    "user": "https://github.com/gagern"
}
```
I currently fail to build sage 6.7.beta1 from scratch:

```
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I…/sage/local/include/libpng12 -I…/sage/local/include/freetype2 -g -fvisibility=hidden -MT webpimg.lo -MD -MP -MF .deps/webpimg.Tpo -c webpimg.c  -fPIC -DPIC -o .libs/webpimg.o
webpimg.c: In function 'VPXEncode':
webpimg.c:714:24: error: 'IMG_FMT_I420' undeclared (first use in this function)
     vpx_img_wrap(&img, IMG_FMT_I420,
                        ^
webpimg.c:714:24: note: each undeclared identifier is reported only once for each function it appears in
webpimg.c:716:16: error: 'PLANE_Y' undeclared (first use in this function)
     img.planes[PLANE_Y] = (uint8*)(Y);
                ^
webpimg.c:717:16: error: 'PLANE_U' undeclared (first use in this function)
     img.planes[PLANE_U] = (uint8*)(U);
                ^
webpimg.c:718:16: error: 'PLANE_V' undeclared (first use in this function)
     img.planes[PLANE_V] = (uint8*)(V);
                ^
Makefile:773: recipe for target 'webpimg.lo' failed
make[5]: *** [webpimg.lo] Error 1
make[5]: Leaving directory '…/sage/local/var/tmp/sage/build/libgd-2.1.0.p0/src/src'
Makefile:439: recipe for target 'all' failed
make[4]: *** [all] Error 2
make[4]: Leaving directory '…/sage/local/var/tmp/sage/build/libgd-2.1.0.p0/src/src'
Makefile:341: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '…/sage/local/var/tmp/sage/build/libgd-2.1.0.p0/src'
Error building gd.
```

This is related to the auto-detected configure setting

```
   Support for VPX library:          yes
```

Fortunately I've recently encountered the same issue for Gentoo with the libgd bundled with php ([Gentoo bug #547310](https://bugs.gentoo.org/show_bug.cgi?id=547310)). The issue is related to [this change](http://git.chromium.org/gitweb/?p=webm/libvpx.git;a=blobdiff;f=vpx/vpx_image.h;h=ef6d1dd3092e5c8e70173a4fc9def62c8eedef01;hp=0b7bb90572da3c0d0048285dffb7ed847f762823;hb=9cdaa3d72eade9ad162ef8f78a93bd8f85c6de10;hpb=0ecc75c81986a277d2e8e387117edfc21cb2fed0) for libvpx, which removed some legacy symbols. Prefixing those symbols with `VPX_` solves the issue, as done in [this commit](https://github.com/gagern/libgd/commit/d41eb72cd4545c394578332e5c102dee69e02ee8) to the GD-2.1 branch.

I think we have at least four solutions at our disposal:

1. Fix symbol names in libgd 2.1 by patching in [this commit](https://github.com/gagern/libgd/commit/d41eb72cd4545c394578332e5c102dee69e02ee8)
2. Explicitely disable libvpx support, to avoid linking against system library there
3. Bundle libvpx at a given version to become independent of system library
4. Upgrade to libgd 2.2 (once that's available), which should use libwebp instead of libvpx according to [libgd ticket #129](https://github.com/libgd/libgd/issues/129)

Which solution would you prefer? 1. differs the least from what we currently do, but that doesn't neccessarily make it the best solution.

Reviewer: Martin von Gagern

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/18364





---

archive/issue_comments_323410.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-04T18:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18364#issuecomment-323410",
    "user": "https://github.com/a-andre"
}
```

Changing status from new to needs_review.



---

archive/issue_events_058905.json:
```json
{
    "actor": "https://github.com/a-andre",
    "created_at": "2015-05-04T18:42:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18364#event-58905"
}
```



---

archive/issue_comments_323411.json:
```json
{
    "body": "<a id='comment:1'></a>\nDuplicate of #18293.",
    "created_at": "2015-05-04T18:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18364#issuecomment-323411",
    "user": "https://github.com/a-andre"
}
```

<a id='comment:1'></a>
Duplicate of #18293.



---

archive/issue_comments_323412.json:
```json
{
    "body": "Reviewer: Martin von Gagern",
    "created_at": "2015-05-04T20:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18364#issuecomment-323412",
    "user": "https://github.com/gagern"
}
```

Reviewer: Martin von Gagern



---

archive/issue_comments_323413.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-04T20:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18364#issuecomment-323413",
    "user": "https://github.com/gagern"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_058906.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-19T06:45:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18364#event-58906"
}
```



---

archive/issue_comments_323414.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2015-05-19T06:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18364",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18364#issuecomment-323414",
    "user": "https://github.com/vbraun"
}
```

Resolution: duplicate
