# Issue 24873: minkowski_reduction() returns wrong output

archive/issues_024873.json:
```json
{
    "body": "Currently, the function in //quadratic_form_reduction_theory.py// to Minkowski reduce a basis returns an incorrect output.  For example:\n\n\n```\nsage: Q=QuadraticForm(ZZ,3,[1,-2,0,2,0,2])\nsage: Q.Gram_matrix()\n\n[ 1 -1  0]\n[-1  2  0]\n[ 0  0  2]\nsage: Q.minkowski_reduction()\n\n(\nQuadratic form in 3 variables over Integer Ring with coefficients: \n[ 1 -2 0 ]                                                         \n[ * 2 0 ]                                                          \n[ * * 2 ]                                                          ,\n\n[1 0 0]\n[0 1 0]\n[0 0 1]\n)\n```\n\n\nBut this is by definition (see for example Cassels \"Rational Quadratic Forms\" p. 255) not Minkowski reduced, since   \n\n\n```\nQ(1,1,0) < Q(0,1,0).\n```\n\n\nA correct Minkowski reduced matrix equivalent to the one given, would be \n\n\n```\nQuadratic form in 3 variables over Integer Ring with coefficients: \n[ 1 0 0 ]\n[ * 1 0 ]\n[ * * 2 ]\n```\n\n\nThere is also a problem that this function runs on an infinite loop (rather than raising an error flag) when an indefinite quadratic form is entered.  \n\nIssue created by migration from https://trac.sagemath.org/ticket/25110\n\n",
    "created_at": "2018-04-06T15:52:03Z",
    "labels": [
        "quadratic forms",
        "major",
        "bug"
    ],
    "title": "minkowski_reduction() returns wrong output",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24873",
    "user": "annahaensch"
}
```
Currently, the function in //quadratic_form_reduction_theory.py// to Minkowski reduce a basis returns an incorrect output.  For example:


```
sage: Q=QuadraticForm(ZZ,3,[1,-2,0,2,0,2])
sage: Q.Gram_matrix()

[ 1 -1  0]
[-1  2  0]
[ 0  0  2]
sage: Q.minkowski_reduction()

(
Quadratic form in 3 variables over Integer Ring with coefficients: 
[ 1 -2 0 ]                                                         
[ * 2 0 ]                                                          
[ * * 2 ]                                                          ,

[1 0 0]
[0 1 0]
[0 0 1]
)
```


But this is by definition (see for example Cassels "Rational Quadratic Forms" p. 255) not Minkowski reduced, since   


```
Q(1,1,0) < Q(0,1,0).
```


A correct Minkowski reduced matrix equivalent to the one given, would be 


```
Quadratic form in 3 variables over Integer Ring with coefficients: 
[ 1 0 0 ]
[ * 1 0 ]
[ * * 2 ]
```


There is also a problem that this function runs on an infinite loop (rather than raising an error flag) when an indefinite quadratic form is entered.  

Issue created by migration from https://trac.sagemath.org/ticket/25110





---

archive/issue_comments_349530.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-04-07T07:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349530",
    "user": "annahaensch"
}
```

New commits:



---

archive/issue_comments_349531.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-07T07:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349531",
    "user": "annahaensch"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_349532.json:
```json
{
    "body": "Sorry I can't do a full review, but for the sake of PEP8 please change\n\n```\nQ=QuadraticForm(ZZ,4,[1,-2,0,0,2,0,0,2,0,2])\n```\n\nto\n\n```\nQ = QuadraticForm(ZZ, 4, [1, -2, 0, 0, 2, 0, 0, 2, 0, 2])\n```\n\nand  consider simplifying\n\n```\nfor a_first in mrange([3  for i in range(j)]):\n    y = [x-1 for x in a_first] + [1] + [0 for k in range(n-1-j)]\n    e_j = [0  for k in range(n)]\n```\n\nto\n\n```\nfor a_first in mrange([3] * j]):\n    y = [x-1 for x in a_first] + [1] + [0] * (n-1-j)\n    e_j = [0] * n\n```\n\nfor better readability.",
    "created_at": "2018-04-08T11:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349532",
    "user": "slelievre"
}
```

Sorry I can't do a full review, but for the sake of PEP8 please change

```
Q=QuadraticForm(ZZ,4,[1,-2,0,0,2,0,0,2,0,2])
```

to

```
Q = QuadraticForm(ZZ, 4, [1, -2, 0, 0, 2, 0, 0, 2, 0, 2])
```

and  consider simplifying

```
for a_first in mrange([3  for i in range(j)]):
    y = [x-1 for x in a_first] + [1] + [0 for k in range(n-1-j)]
    e_j = [0  for k in range(n)]
```

to

```
for a_first in mrange([3] * j]):
    y = [x-1 for x in a_first] + [1] + [0] * (n-1-j)
    e_j = [0] * n
```

for better readability.



---

archive/issue_comments_349533.json:
```json
{
    "body": "Thanks, I updated the documentation as you recommend.  I left the code in its original form.  The edits you suggest introduced a build error, and rather than troubleshoot that, I think it's easier just to leave it as it's been.",
    "created_at": "2018-04-09T15:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349533",
    "user": "annahaensch"
}
```

Thanks, I updated the documentation as you recommend.  I left the code in its original form.  The edits you suggest introduced a build error, and rather than troubleshoot that, I think it's easier just to leave it as it's been.



---

archive/issue_comments_349534.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-09T15:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349534",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349535.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-18T08:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349535",
    "user": "ehlen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_349536.json:
```json
{
    "body": "The code works as expected.\nThe code agrees with the algorithm given in the reference by Schulze-Pillot.\nAll documentation and all test are completed without errors.",
    "created_at": "2018-06-18T08:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349536",
    "user": "ehlen"
}
```

The code works as expected.
The code agrees with the algorithm given in the reference by Schulze-Pillot.
All documentation and all test are completed without errors.



---

archive/issue_comments_349537.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-06-18T12:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349537",
    "user": "ehlen"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_349538.json:
```json
{
    "body": "Actually (I'm sorry), I take it back.\nI think there is a typo in Schulze-Pillot's paper. Where it says m>=4 in the algorithm it should really say m<= 4.\nI'm not convinced that the algorithm implemented here works for more that 4 variables.\nIt seems to me that the coefficients *s_i* are taken in {0,-1,1} but this should only work for at most 4 variables.\nI haven't thought about this a lot and so I'm changing the status to 'needs info' first. \nBut I suspect that this actually needs work...",
    "created_at": "2018-06-18T12:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349538",
    "user": "ehlen"
}
```

Actually (I'm sorry), I take it back.
I think there is a typo in Schulze-Pillot's paper. Where it says m>=4 in the algorithm it should really say m<= 4.
I'm not convinced that the algorithm implemented here works for more that 4 variables.
It seems to me that the coefficients *s_i* are taken in {0,-1,1} but this should only work for at most 4 variables.
I haven't thought about this a lot and so I'm changing the status to 'needs info' first. 
But I suspect that this actually needs work...



---

archive/issue_comments_349539.json:
```json
{
    "body": "Replying to [comment:7 ehlen]:\n> Actually (I'm sorry), I take it back.\n> I think there is a typo in Schulze-Pillot's paper. Where it says m>=4 in the algorithm it should really say m<= 4.\n> I'm not convinced that the algorithm implemented here works for more that 4 variables.\n> It seems to me that the coefficients *s_i* are taken in {0,-1,1} but this should only work for at most 4 variables.\n> I haven't thought about this a lot and so I'm changing the status to 'needs info' first. \n> But I suspect that this actually needs work...\n\nI think you're correct.  I looked more closely at the 1979 Donaldson paper (see bottom of page 203) and it looks like the problem of finding the s_i grows difficult very quickly as the dimension increases.  For the moment, I think we should just call this an algorithm for forms with dimension less than or equal to 4 and raise a NotImplimentedError otherwise.  I just pushed a commit to that effect.  Let me know what you think. Thanks!",
    "created_at": "2018-06-23T01:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349539",
    "user": "annahaensch"
}
```

Replying to [comment:7 ehlen]:
> Actually (I'm sorry), I take it back.
> I think there is a typo in Schulze-Pillot's paper. Where it says m>=4 in the algorithm it should really say m<= 4.
> I'm not convinced that the algorithm implemented here works for more that 4 variables.
> It seems to me that the coefficients *s_i* are taken in {0,-1,1} but this should only work for at most 4 variables.
> I haven't thought about this a lot and so I'm changing the status to 'needs info' first. 
> But I suspect that this actually needs work...

I think you're correct.  I looked more closely at the 1979 Donaldson paper (see bottom of page 203) and it looks like the problem of finding the s_i grows difficult very quickly as the dimension increases.  For the moment, I think we should just call this an algorithm for forms with dimension less than or equal to 4 and raise a NotImplimentedError otherwise.  I just pushed a commit to that effect.  Let me know what you think. Thanks!



---

archive/issue_comments_349540.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-23T01:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349540",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349541.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-06-23T01:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349541",
    "user": "annahaensch"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_349542.json:
```json
{
    "body": "you should add a doctest in dimension 5, raising the `NotImplementedError`",
    "created_at": "2018-06-23T07:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349542",
    "user": "chapoton"
}
```

you should add a doctest in dimension 5, raising the `NotImplementedError`



---

archive/issue_comments_349543.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-23T14:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349543",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349544.json:
```json
{
    "body": "Replying to [comment:11 chapoton]:\n> you should add a doctest in dimension 5, raising the `NotImplementedError`\n\nThanks, I just added that.",
    "created_at": "2018-06-23T14:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349544",
    "user": "annahaensch"
}
```

Replying to [comment:11 chapoton]:
> you should add a doctest in dimension 5, raising the `NotImplementedError`

Thanks, I just added that.



---

archive/issue_comments_349545.json:
```json
{
    "body": "Everything works as expected. The documentation is fine.\nMerging with the latest development branch (8.3beta7) works fine, compiles fine and all tests pass.",
    "created_at": "2018-06-25T14:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349545",
    "user": "ehlen"
}
```

Everything works as expected. The documentation is fine.
Merging with the latest development branch (8.3beta7) works fine, compiles fine and all tests pass.



---

archive/issue_comments_349546.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-25T14:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349546",
    "user": "ehlen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_349547.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-29T22:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24873#issuecomment-349547",
    "user": "vbraun"
}
```

Resolution: fixed
