# Issue 27129: Polyhedron.affine_hull: more output options

archive/issues_027129.json:
```json
{
    "body": "CC:  @jplab @videlec @kliem\n\nAt the moment when calling `.affine_hull`, either the polyhedron or the affine map can be returned. If both needed, parts need to be recomputed, so we extend the parameters to allow returning both at the same time.\n\nMoreover, we also allow to additionally return some more (internal) data using during creating the affine map. This is a preparation for #27365.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27366\n\n",
    "created_at": "2019-02-26T15:22:11Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Polyhedron.affine_hull: more output options",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27129",
    "user": "@dkrenn"
}
```
CC:  @jplab @videlec @kliem

At the moment when calling `.affine_hull`, either the polyhedron or the affine map can be returned. If both needed, parts need to be recomputed, so we extend the parameters to allow returning both at the same time.

Moreover, we also allow to additionally return some more (internal) data using during creating the affine map. This is a preparation for #27365.

Issue created by migration from https://trac.sagemath.org/ticket/27366





---

archive/issue_comments_382129.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-26T15:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382129",
    "user": "@dkrenn"
}
```

New commits:



---

archive/issue_comments_382130.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-26T15:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382130",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382131.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-26T15:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382131",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-07T09:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382132",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382133.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-10T17:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382133",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382134.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-10T18:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382134",
    "user": "@dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_382135.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-12T11:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382135",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382136.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382136",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_382137.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382137",
    "user": "@embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_382138.json:
```json
{
    "body": "red branch, needs to be rebased on top of the latest beta",
    "created_at": "2019-08-31T07:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382138",
    "user": "@fchapoton"
}
```

red branch, needs to be rebased on top of the latest beta



---

archive/issue_comments_382139.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-31T07:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382139",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382140.json:
```json
{
    "body": "Changing keywords from \"\" to \"polytope,\".",
    "created_at": "2019-09-03T18:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382140",
    "user": "@jplab"
}
```

Changing keywords from "" to "polytope,".



---

archive/issue_comments_382141.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382141",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_382142.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382142",
    "user": "@mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_382143.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382143",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_382144.json:
```json
{
    "body": "Merged with current develop.\n----\nNew commits:",
    "created_at": "2021-04-12T19:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382144",
    "user": "@mkoeppe"
}
```

Merged with current develop.
----
New commits:



---

archive/issue_comments_382145.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-12T20:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382145",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_382146.json:
```json
{
    "body": "Untested so far...",
    "created_at": "2021-04-12T20:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382146",
    "user": "@mkoeppe"
}
```

Untested so far...



---

archive/issue_comments_382147.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T02:07:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382147",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382148.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T20:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382148",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382149.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T21:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382149",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382150.json:
```json
{
    "body": "I plan to rework this so the output is a bit more straightforward.\n\nWe have `affine_map`, which is the projection that sends the affine hull (k-dimensional affine subspace of R<sup>n</sup>) to R<sup>k</sup>.\n\nWhat's missing is simply its section map that sends back R<sup>k</sup> to the affine hull.\n\nI think both `parametric_form` and `coordinate_images` somehow represent this section map.\n\nAs the section map is affine linear, we should represent it in the same way as `affine_map`: A linear transformation and a shift.",
    "created_at": "2021-04-14T00:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382150",
    "user": "@mkoeppe"
}
```

I plan to rework this so the output is a bit more straightforward.

We have `affine_map`, which is the projection that sends the affine hull (k-dimensional affine subspace of R<sup>n</sup>) to R<sup>k</sup>.

What's missing is simply its section map that sends back R<sup>k</sup> to the affine hull.

I think both `parametric_form` and `coordinate_images` somehow represent this section map.

As the section map is affine linear, we should represent it in the same way as `affine_map`: A linear transformation and a shift.



---

archive/issue_comments_382151.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-14T05:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382151",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382152.json:
```json
{
    "body": "For the non-orthogonal case, the `section_map` still needs to be computed.\n\nBut comments are already welcome",
    "created_at": "2021-04-14T05:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382152",
    "user": "@mkoeppe"
}
```

For the non-orthogonal case, the `section_map` still needs to be computed.

But comments are already welcome



---

archive/issue_comments_382153.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-14T05:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382153",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382154.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-15T04:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382154",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382155.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-15T04:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382155",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382156.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-15T04:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382156",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_382157.json:
```json
{
    "body": "Still some issues with algebraic numbers:\n\n```\nsage: D = polytopes.dodecahedron()\nsage: D.facets()[0].as_polyhedron().affine_hull_projection()                                                                       \nA 2-dimensional polyhedron in (Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?)^2 defined as the convex hull of 5 vertices\nsage: D.facets()[0].as_polyhedron().affine_hull_projection(return_all_data=True)  \nTypeError: (-sqrt5 + 1, -2*sqrt5 + 4, 0) fails to convert into the map's domain Vector space of dimension 3 over Rational Field, but a `pushforward` method is not properly implemented\n```\n",
    "created_at": "2021-04-15T06:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382157",
    "user": "@mkoeppe"
}
```

Still some issues with algebraic numbers:

```
sage: D = polytopes.dodecahedron()
sage: D.facets()[0].as_polyhedron().affine_hull_projection()                                                                       
A 2-dimensional polyhedron in (Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?)^2 defined as the convex hull of 5 vertices
sage: D.facets()[0].as_polyhedron().affine_hull_projection(return_all_data=True)  
TypeError: (-sqrt5 + 1, -2*sqrt5 + 4, 0) fails to convert into the map's domain Vector space of dimension 3 over Rational Field, but a `pushforward` method is not properly implemented
```




---

archive/issue_comments_382158.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-15T06:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382158",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382159.json:
```json
{
    "body": "I have a fix almost ready and added a test method.\n\nHowever, there is going to be one more ticket in the dependency chain:\n\n\n```\nsage: D = polytopes.dodecahedron()                                                                                                                                                  \nsage: D.change_ring(AA) == D                                                                                                                                                        \nFalse\n```\n",
    "created_at": "2021-04-15T19:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382159",
    "user": "@kliem"
}
```

I have a fix almost ready and added a test method.

However, there is going to be one more ticket in the dependency chain:


```
sage: D = polytopes.dodecahedron()                                                                                                                                                  
sage: D.change_ring(AA) == D                                                                                                                                                        
False
```




---

archive/issue_comments_382160.json:
```json
{
    "body": "The behavior is actually consistent with rings, I still don't like it.\n\nLooks, like this is related to #4621:\n\n\n```\nsage: D = polytopes.dodecahedron()                                                                                                                                                  \nsage: D.base_ring()                                                                                                                                                                 \nNumber Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?\nsage: sqrt5 = D.base_ring().gens()[0]                                                                                                                                               \nsage: sqrt5 == AA(sqrt5)                                                                                                                                                            \nFalse\nsage: 0*sqrt5 == AA(0)                                                                                                                                                              \nFalse\n```\n\n\nThis is extremely stupid. At least it should throw an error instead of giving a false negative. But its pointless to be fixed here.\n\nEdit: I realized that equality checks should never throw an error. So it is really hard to do the right thing here. The base ring of algebraic polyhedra has a specified embedding into `RLF`, which makes it incomparable with `AA`.",
    "created_at": "2021-04-15T19:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382160",
    "user": "@kliem"
}
```

The behavior is actually consistent with rings, I still don't like it.

Looks, like this is related to #4621:


```
sage: D = polytopes.dodecahedron()                                                                                                                                                  
sage: D.base_ring()                                                                                                                                                                 
Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?
sage: sqrt5 = D.base_ring().gens()[0]                                                                                                                                               
sage: sqrt5 == AA(sqrt5)                                                                                                                                                            
False
sage: 0*sqrt5 == AA(0)                                                                                                                                                              
False
```


This is extremely stupid. At least it should throw an error instead of giving a false negative. But its pointless to be fixed here.

Edit: I realized that equality checks should never throw an error. So it is really hard to do the right thing here. The base ring of algebraic polyhedra has a specified embedding into `RLF`, which makes it incomparable with `AA`.



---

archive/issue_comments_382161.json:
```json
{
    "body": "Unfortunately, it is still at \"needs work\".\n\nThe test suite fails for `polytopes.Birkhoff(3)` terribly (the section map has incorrect rank).\n\nIt also fails for the 0-dimensional polyhedron, but maybe that is just the way it is.\n\nIt fails for unbounded polyhedron, in particular `Polyhedron(rays=[This is the Trac macro *0, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0, 1-macro))`.",
    "created_at": "2021-04-15T19:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382161",
    "user": "@kliem"
}
```

Unfortunately, it is still at "needs work".

The test suite fails for `polytopes.Birkhoff(3)` terribly (the section map has incorrect rank).

It also fails for the 0-dimensional polyhedron, but maybe that is just the way it is.

It fails for unbounded polyhedron, in particular `Polyhedron(rays=[This is the Trac macro *0, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0, 1-macro))`.



---

archive/issue_comments_382162.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-15T19:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382162",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_382163.json:
```json
{
    "body": "Thanks a lot! Great idea to add the test method",
    "created_at": "2021-04-15T19:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382163",
    "user": "@mkoeppe"
}
```

Thanks a lot! Great idea to add the test method



---

archive/issue_comments_382164.json:
```json
{
    "body": "I started adding doctests and I realized that they are extremely long and nobody is actually going to check them...",
    "created_at": "2021-04-15T20:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382164",
    "user": "@kliem"
}
```

I started adding doctests and I realized that they are extremely long and nobody is actually going to check them...



---

archive/issue_comments_382165.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-15T23:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382165",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382166.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-15T23:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382166",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_382167.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-16T01:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382167",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382168.json:
```json
{
    "body": "There is still a doctest that fails terribly. (After fixing an incorrect doctest that I will push in a minute).\n\n\n```\nsage: p = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                            \nsage: p = Polyhedron([(0,0)], base_ring=RDF)                                                                                                                                        \nsage: data = p.affine_hull_projection(return_all_data=True, orthogonal=True, extend=True)                                                                                           \nsage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                           \nsage: p1 == p                                                                                                                                                                       \nTrue\nsage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                \nsage: p1 == p                                                         \nTrue\n```\n\n\nSomehow linear transformation applied to a 0-dimensional polyhedron isn't stable. The problem really seems to be connected to underlying matrices:\n\n\n```\nsage: p = Polyhedron([(0,0)], base_ring=RDF)                                                                                                                                        \nsage: data = p.affine_hull_projection(return_all_data=True, orthogonal=True, extend=True)                                                                                           \nsage: M = data['section_map'][0].matrix().transpose()                                                                                                                               \nsage: V = data['polyhedron'].vertices_matrix()                                                                                                                                      \nsage: M*V                                                                                                                                                                           \n[3.445383e-316]\n[          0.0]\nsage: M*V                                                                                                                                                                           \n[3.445383e-316]\n[          0.0]\nsage: M*V                                                                                                                                                                           \n[3.17525635e-316]\n[            0.0]\nsage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                           \nsage: M*V                                                                                                                                                                           \n[0.0]\n[0.0]\nsage: M*V                                                                                                                                                                           \n[1.0]\n[0.0]\nsage: M*V                                                                                                                                                                           \n[0.0]\n[1.0]\nsage: M*V                                                                                                                                                                           \n[0.0]\n[0.0]\nsage: M*V                                                                                                                                                                           \n[0.0]\n[0.0]\n```\n\n\nApparently, the content of the matrix is never initialized. You might say that multiplication of those matrices isn't well-defined. However, if you think of this as linear maps, there is only one linear map from `RLF^0` to `RLF^2`.",
    "created_at": "2021-04-16T09:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382168",
    "user": "@kliem"
}
```

There is still a doctest that fails terribly. (After fixing an incorrect doctest that I will push in a minute).


```
sage: p = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                            
sage: p = Polyhedron([(0,0)], base_ring=RDF)                                                                                                                                        
sage: data = p.affine_hull_projection(return_all_data=True, orthogonal=True, extend=True)                                                                                           
sage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                           
sage: p1 == p                                                                                                                                                                       
True
sage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                
sage: p1 == p                                                         
True
```


Somehow linear transformation applied to a 0-dimensional polyhedron isn't stable. The problem really seems to be connected to underlying matrices:


```
sage: p = Polyhedron([(0,0)], base_ring=RDF)                                                                                                                                        
sage: data = p.affine_hull_projection(return_all_data=True, orthogonal=True, extend=True)                                                                                           
sage: M = data['section_map'][0].matrix().transpose()                                                                                                                               
sage: V = data['polyhedron'].vertices_matrix()                                                                                                                                      
sage: M*V                                                                                                                                                                           
[3.445383e-316]
[          0.0]
sage: M*V                                                                                                                                                                           
[3.445383e-316]
[          0.0]
sage: M*V                                                                                                                                                                           
[3.17525635e-316]
[            0.0]
sage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                           
sage: M*V                                                                                                                                                                           
[0.0]
[0.0]
sage: M*V                                                                                                                                                                           
[1.0]
[0.0]
sage: M*V                                                                                                                                                                           
[0.0]
[1.0]
sage: M*V                                                                                                                                                                           
[0.0]
[0.0]
sage: M*V                                                                                                                                                                           
[0.0]
[0.0]
```


Apparently, the content of the matrix is never initialized. You might say that multiplication of those matrices isn't well-defined. However, if you think of this as linear maps, there is only one linear map from `RLF^0` to `RLF^2`.



---

archive/issue_comments_382169.json:
```json
{
    "body": "Ok, seems to work now.\n\nFixing the problem with real matrices was actually quite easy. The matrix was not initialized as I thought. Should I open a seperate ticket for this?\n----\nNew commits:",
    "created_at": "2021-04-16T09:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382169",
    "user": "@kliem"
}
```

Ok, seems to work now.

Fixing the problem with real matrices was actually quite easy. The matrix was not initialized as I thought. Should I open a seperate ticket for this?
----
New commits:



---

archive/issue_comments_382170.json:
```json
{
    "body": "Thanks for fixing this! I think it's fine to keep it on this ticket",
    "created_at": "2021-04-16T15:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382170",
    "user": "@mkoeppe"
}
```

Thanks for fixing this! I think it's fine to keep it on this ticket



---

archive/issue_comments_382171.json:
```json
{
    "body": "Green patchbot.\n\nBut we may want to consider making the result a dataclass (https://docs.python.org/3/library/dataclasses.html) instead of a dictionary",
    "created_at": "2021-04-16T16:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382171",
    "user": "@mkoeppe"
}
```

Green patchbot.

But we may want to consider making the result a dataclass (https://docs.python.org/3/library/dataclasses.html) instead of a dictionary



---

archive/issue_comments_382172.json:
```json
{
    "body": "(depends on #30551 - Drop Python 3.6 support - which is planned for 9.4 anyway)",
    "created_at": "2021-04-16T16:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382172",
    "user": "@mkoeppe"
}
```

(depends on #30551 - Drop Python 3.6 support - which is planned for 9.4 anyway)



---

archive/issue_comments_382173.json:
```json
{
    "body": "\n```\nfrom dataclasses import dataclass\nfrom typing import Any\n@dataclass\nclass AffineHullProjectionData:\n   polyhedron: Any\n   projection_linear_map: Any\n   projection_translation: Any\n   section_linear_map: Any\n   section_translation: Any\n```\n\nNote, unpacking the pairs -- this would be future-proof in case we ever decide to add proper affine linear maps to Sage",
    "created_at": "2021-04-16T19:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382173",
    "user": "@mkoeppe"
}
```


```
from dataclasses import dataclass
from typing import Any
@dataclass
class AffineHullProjectionData:
   polyhedron: Any
   projection_linear_map: Any
   projection_translation: Any
   section_linear_map: Any
   section_translation: Any
```

Note, unpacking the pairs -- this would be future-proof in case we ever decide to add proper affine linear maps to Sage



---

archive/issue_comments_382174.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-19T03:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382174",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382175.json:
```json
{
    "body": "This ticket should depend now on #30551, right?\n\nApparently `sage.geometry.polyhedron.base` is a startup module, which is terrible. I chased it down and it seems one needs to do a series of lazy/more careful imports.\n\n- It starts with `sage/schemes/toric/all.py`, which just imports a everything right away.\n- `sage/schemes/toric/variety.py` imports `Cone, is_Cone`. Both of them are only needed twice in the entire module and not even in popular places, it seems. (There are other places where `is_Cone` is just imported in the module, although it is only used in special methods.\n- `sage/geometry/all.py` could just do a lot more lazy imports (I think all of them should be lazy).\n- `sage/geometry/cone.py` could use a lot more careful imports. E.g. `FinitePoset` is imported, but it is only used for the face lattice. In particular the function `is_Cone` could live without all those imports. If your object isn't a cone, you probably won't need them anyway.\n\n  In particular it imports `is_Polyhedron` in `sage.geometry.polyhedron.base`.\n- Again `sage/geometry/polyhedron/base.py` imports a lot of stuff that is definetly not needed for `is_Polyhedron`.\n\nAdding some lazy imports above, I can avoid the import of `sage.geometry.polyhedron.base'.",
    "created_at": "2021-04-20T08:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382175",
    "user": "@kliem"
}
```

This ticket should depend now on #30551, right?

Apparently `sage.geometry.polyhedron.base` is a startup module, which is terrible. I chased it down and it seems one needs to do a series of lazy/more careful imports.

- It starts with `sage/schemes/toric/all.py`, which just imports a everything right away.
- `sage/schemes/toric/variety.py` imports `Cone, is_Cone`. Both of them are only needed twice in the entire module and not even in popular places, it seems. (There are other places where `is_Cone` is just imported in the module, although it is only used in special methods.
- `sage/geometry/all.py` could just do a lot more lazy imports (I think all of them should be lazy).
- `sage/geometry/cone.py` could use a lot more careful imports. E.g. `FinitePoset` is imported, but it is only used for the face lattice. In particular the function `is_Cone` could live without all those imports. If your object isn't a cone, you probably won't need them anyway.

  In particular it imports `is_Polyhedron` in `sage.geometry.polyhedron.base`.
- Again `sage/geometry/polyhedron/base.py` imports a lot of stuff that is definetly not needed for `is_Polyhedron`.

Adding some lazy imports above, I can avoid the import of `sage.geometry.polyhedron.base'.



---

archive/issue_comments_382176.json:
```json
{
    "body": "Yes, I've added the dependency. But I don't think we need to merge in the branch of that.",
    "created_at": "2021-04-20T16:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382176",
    "user": "@mkoeppe"
}
```

Yes, I've added the dependency. But I don't think we need to merge in the branch of that.



---

archive/issue_comments_382177.json:
```json
{
    "body": "I have opened #31705 for the lazy import improvements",
    "created_at": "2021-04-20T16:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382177",
    "user": "@mkoeppe"
}
```

I have opened #31705 for the lazy import improvements



---

archive/issue_comments_382178.json:
```json
{
    "body": "\n```\n                L_section = linear_transformation(matrix(len(pivots), self.ambient_dim(),\n                                                         [E[i] for i in range(len(pivots))]).transpose(),\n                                                  side='right')\n```\n\nThis is not always an inverse to `A`:\n\n\n```\nsage: set_random_seed(0)                                                                                                              \nsage: M = random_matrix(ZZ, 5, 5, distribution='uniform')                                                                             \nsage: while True: \n....:     M = random_matrix(ZZ, 5, 5, distribution='uniform')   \n....:     if M.rank() != 5: \n....:         break \n....:                                                                                                                                 \nsage: P = Polyhedron(M)                                                                                                               \nsage: P._test_affine_hull_projection()                                                                                                \n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\n<ipython-input-23-f3c92d590b2b> in <module>\n----> 1 P._test_affine_hull_projection()\n\n~/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/base.py in _test_affine_hull_projection(self, tester, verbose, **options)\n  10487             else:\n  10488                 self_extend = self\n> 10489             tester.assertEqual(data.polyhedron.linear_transformation(M)\n  10490                                + data.section_translation,\n  10491                                self_extend)\n\n/usr/lib/python3.8/unittest/case.py in assertEqual(self, first, second, msg)\n    910         \"\"\"\n    911         assertion_func = self._getAssertEqualityFunc(first, second)\n--> 912         assertion_func(first, second, msg=msg)\n    913 \n    914     def assertNotEqual(self, first, second, msg=None):\n\n/usr/lib/python3.8/unittest/case.py in _baseAssertEqual(self, first, second, msg)\n    903             standardMsg = '%s != %s' % _common_shorten_repr(first, second)\n    904             msg = self._formatMessage(msg, standardMsg)\n--> 905             raise self.failureException(msg)\n    906 \n    907     def assertEqual(self, first, second, msg=None):\n\nAssertionError: A 4-dimensional polyhedron in QQ^5 defined as the convex hull of 5 vertices != A 4-dimensional polyhedron in ZZ^5 defined as the convex hull of 5 vertices\n```\n",
    "created_at": "2021-04-25T06:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382178",
    "user": "@kliem"
}
```


```
                L_section = linear_transformation(matrix(len(pivots), self.ambient_dim(),
                                                         [E[i] for i in range(len(pivots))]).transpose(),
                                                  side='right')
```

This is not always an inverse to `A`:


```
sage: set_random_seed(0)                                                                                                              
sage: M = random_matrix(ZZ, 5, 5, distribution='uniform')                                                                             
sage: while True: 
....:     M = random_matrix(ZZ, 5, 5, distribution='uniform')   
....:     if M.rank() != 5: 
....:         break 
....:                                                                                                                                 
sage: P = Polyhedron(M)                                                                                                               
sage: P._test_affine_hull_projection()                                                                                                
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-23-f3c92d590b2b> in <module>
----> 1 P._test_affine_hull_projection()

~/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/base.py in _test_affine_hull_projection(self, tester, verbose, **options)
  10487             else:
  10488                 self_extend = self
> 10489             tester.assertEqual(data.polyhedron.linear_transformation(M)
  10490                                + data.section_translation,
  10491                                self_extend)

/usr/lib/python3.8/unittest/case.py in assertEqual(self, first, second, msg)
    910         """
    911         assertion_func = self._getAssertEqualityFunc(first, second)
--> 912         assertion_func(first, second, msg=msg)
    913 
    914     def assertNotEqual(self, first, second, msg=None):

/usr/lib/python3.8/unittest/case.py in _baseAssertEqual(self, first, second, msg)
    903             standardMsg = '%s != %s' % _common_shorten_repr(first, second)
    904             msg = self._formatMessage(msg, standardMsg)
--> 905             raise self.failureException(msg)
    906 
    907     def assertEqual(self, first, second, msg=None):

AssertionError: A 4-dimensional polyhedron in QQ^5 defined as the convex hull of 5 vertices != A 4-dimensional polyhedron in ZZ^5 defined as the convex hull of 5 vertices
```




---

archive/issue_comments_382179.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-25T06:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382179",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382180.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-25T06:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382180",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_382181.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-26T11:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382181",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382182.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-26T11:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382182",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_382183.json:
```json
{
    "body": "I'm happy with it now.",
    "created_at": "2021-04-26T11:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382183",
    "user": "@kliem"
}
```

I'm happy with it now.



---

archive/issue_comments_382184.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-26T16:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382184",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_382185.json:
```json
{
    "body": "Thanks a lot for finding this elegant fix.",
    "created_at": "2021-04-26T16:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382185",
    "user": "@mkoeppe"
}
```

Thanks a lot for finding this elegant fix.



---

archive/issue_comments_382186.json:
```json
{
    "body": "Changing keywords from \"polytope,\" to \"polytope\".",
    "created_at": "2021-04-26T16:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382186",
    "user": "@mkoeppe"
}
```

Changing keywords from "polytope," to "polytope".



---

archive/issue_comments_382187.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27129",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27129#issuecomment-382187",
    "user": "@vbraun"
}
```

Resolution: fixed
