# Issue 27129: Polyhedron.affine_hull: more output options

Issue created by migration from https://trac.sagemath.org/ticket/27366

Original creator: dkrenn

Original creation time: 2019-02-26 15:22:11

CC:  jipilab vdelecroix @kliem

At the moment when calling `.affine_hull`, either the polyhedron or the affine map can be returned. If both needed, parts need to be recomputed, so we extend the parameters to allow returning both at the same time.

Moreover, we also allow to additionally return some more (internal) data using during creating the affine map. This is a preparation for #27365.


---

Comment by dkrenn created at 2019-02-26 15:25:28

New commits:


---

Comment by git created at 2019-02-26 15:32:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-26 15:51:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-07 09:49:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-10 17:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2019-03-10 18:22:08

Changing status from new to needs_review.


---

Comment by git created at 2019-03-12 11:20:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by chapoton created at 2019-08-31 07:18:39

red branch, needs to be rebased on top of the latest beta


---

Comment by chapoton created at 2019-08-31 07:18:39

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2019-09-03 18:57:00

Changing keywords from "" to "polytope,".


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-04-12 19:08:51

Merged with current develop.
----
New commits:


---

Comment by mkoeppe created at 2021-04-12 20:25:52

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-04-12 20:25:52

Untested so far...


---

Comment by git created at 2021-04-13 02:07:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-13 20:28:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-13 21:08:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-14 00:40:35

I plan to rework this so the output is a bit more straightforward.

We have `affine_map`, which is the projection that sends the affine hull (k-dimensional affine subspace of R<sup>n</sup>) to R<sup>k</sup>.

What's missing is simply its section map that sends back R<sup>k</sup> to the affine hull.

I think both `parametric_form` and `coordinate_images` somehow represent this section map.

As the section map is affine linear, we should represent it in the same way as `affine_map`: A linear transformation and a shift.


---

Comment by git created at 2021-04-14 05:13:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-14 05:15:42

For the non-orthogonal case, the `section_map` still needs to be computed.

But comments are already welcome


---

Comment by mkoeppe created at 2021-04-14 05:15:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-04-15 04:45:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-15 04:50:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-15 04:54:00

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-04-15 06:07:38

Still some issues with algebraic numbers:

```
sage: D = polytopes.dodecahedron()
sage: D.facets()[0].as_polyhedron().affine_hull_projection()                                                                       
A 2-dimensional polyhedron in (Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?)^2 defined as the convex hull of 5 vertices
sage: D.facets()[0].as_polyhedron().affine_hull_projection(return_all_data=True)  
TypeError: (-sqrt5 + 1, -2*sqrt5 + 4, 0) fails to convert into the map's domain Vector space of dimension 3 over Rational Field, but a `pushforward` method is not properly implemented
```



---

Comment by mkoeppe created at 2021-04-15 06:07:38

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-04-15 19:09:34

I have a fix almost ready and added a test method.

However, there is going to be one more ticket in the dependency chain:


```
sage: D = polytopes.dodecahedron()                                                                                                                                                  
sage: D.change_ring(AA) == D                                                                                                                                                        
False
```



---

Comment by @kliem created at 2021-04-15 19:25:11

The behavior is actually consistent with rings, I still don't like it.

Looks, like this is related to #4621:


```
sage: D = polytopes.dodecahedron()                                                                                                                                                  
sage: D.base_ring()                                                                                                                                                                 
Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?
sage: sqrt5 = D.base_ring().gens()[0]                                                                                                                                               
sage: sqrt5 == AA(sqrt5)                                                                                                                                                            
False
sage: 0*sqrt5 == AA(0)                                                                                                                                                              
False
```


This is extremely stupid. At least it should throw an error instead of giving a false negative. But its pointless to be fixed here.

Edit: I realized that equality checks should never throw an error. So it is really hard to do the right thing here. The base ring of algebraic polyhedra has a specified embedding into `RLF`, which makes it incomparable with `AA`.


---

Comment by @kliem created at 2021-04-15 19:49:41

Unfortunately, it is still at "needs work".

The test suite fails for `polytopes.Birkhoff(3)` terribly (the section map has incorrect rank).

It also fails for the 0-dimensional polyhedron, but maybe that is just the way it is.

It fails for unbounded polyhedron, in particular `Polyhedron(rays=[This is the Trac macro *0, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0, 1-macro))`.


---

Comment by @kliem created at 2021-04-15 19:49:58

New commits:


---

Comment by mkoeppe created at 2021-04-15 19:56:56

Thanks a lot! Great idea to add the test method


---

Comment by @kliem created at 2021-04-15 20:06:56

I started adding doctests and I realized that they are extremely long and nobody is actually going to check them...


---

Comment by git created at 2021-04-15 23:47:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-15 23:48:04

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-04-16 01:25:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-04-16 09:19:01

There is still a doctest that fails terribly. (After fixing an incorrect doctest that I will push in a minute).


```
sage: p = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                            
sage: p = Polyhedron([(0,0)], base_ring=RDF)                                                                                                                                        
sage: data = p.affine_hull_projection(return_all_data=True, orthogonal=True, extend=True)                                                                                           
sage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                           
sage: p1 == p                                                                                                                                                                       
True
sage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                
sage: p1 == p                                                         
True
```


Somehow linear transformation applied to a 0-dimensional polyhedron isn't stable. The problem really seems to be connected to underlying matrices:


```
sage: p = Polyhedron([(0,0)], base_ring=RDF)                                                                                                                                        
sage: data = p.affine_hull_projection(return_all_data=True, orthogonal=True, extend=True)                                                                                           
sage: M = data['section_map'][0].matrix().transpose()                                                                                                                               
sage: V = data['polyhedron'].vertices_matrix()                                                                                                                                      
sage: M*V                                                                                                                                                                           
[3.445383e-316]
[          0.0]
sage: M*V                                                                                                                                                                           
[3.445383e-316]
[          0.0]
sage: M*V                                                                                                                                                                           
[3.17525635e-316]
[            0.0]
sage: p1 = data['polyhedron'].linear_transformation(data['section_map'][0].matrix().transpose()) + data['section_map'][1]                                                           
sage: M*V                                                                                                                                                                           
[0.0]
[0.0]
sage: M*V                                                                                                                                                                           
[1.0]
[0.0]
sage: M*V                                                                                                                                                                           
[0.0]
[1.0]
sage: M*V                                                                                                                                                                           
[0.0]
[0.0]
sage: M*V                                                                                                                                                                           
[0.0]
[0.0]
```


Apparently, the content of the matrix is never initialized. You might say that multiplication of those matrices isn't well-defined. However, if you think of this as linear maps, there is only one linear map from `RLF^0` to `RLF^2`.


---

Comment by @kliem created at 2021-04-16 09:48:54

Ok, seems to work now.

Fixing the problem with real matrices was actually quite easy. The matrix was not initialized as I thought. Should I open a seperate ticket for this?
----
New commits:


---

Comment by mkoeppe created at 2021-04-16 15:43:52

Thanks for fixing this! I think it's fine to keep it on this ticket


---

Comment by mkoeppe created at 2021-04-16 16:30:50

Green patchbot.

But we may want to consider making the result a dataclass (https://docs.python.org/3/library/dataclasses.html) instead of a dictionary


---

Comment by mkoeppe created at 2021-04-16 16:32:30

(depends on #30551 - Drop Python 3.6 support - which is planned for 9.4 anyway)


---

Comment by mkoeppe created at 2021-04-16 19:00:29


```
from dataclasses import dataclass
from typing import Any
@dataclass
class AffineHullProjectionData:
   polyhedron: Any
   projection_linear_map: Any
   projection_translation: Any
   section_linear_map: Any
   section_translation: Any
```

Note, unpacking the pairs -- this would be future-proof in case we ever decide to add proper affine linear maps to Sage


---

Comment by git created at 2021-04-19 03:07:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-04-20 08:03:58

This ticket should depend now on #30551, right?

Apparently `sage.geometry.polyhedron.base` is a startup module, which is terrible. I chased it down and it seems one needs to do a series of lazy/more careful imports.

- It starts with `sage/schemes/toric/all.py`, which just imports a everything right away.
- `sage/schemes/toric/variety.py` imports `Cone, is_Cone`. Both of them are only needed twice in the entire module and not even in popular places, it seems. (There are other places where `is_Cone` is just imported in the module, although it is only used in special methods.
- `sage/geometry/all.py` could just do a lot more lazy imports (I think all of them should be lazy).
- `sage/geometry/cone.py` could use a lot more careful imports. E.g. `FinitePoset` is imported, but it is only used for the face lattice. In particular the function `is_Cone` could live without all those imports. If your object isn't a cone, you probably won't need them anyway.

  In particular it imports `is_Polyhedron` in `sage.geometry.polyhedron.base`.
- Again `sage/geometry/polyhedron/base.py` imports a lot of stuff that is definetly not needed for `is_Polyhedron`.

Adding some lazy imports above, I can avoid the import of `sage.geometry.polyhedron.base'.


---

Comment by mkoeppe created at 2021-04-20 16:10:46

Yes, I've added the dependency. But I don't think we need to merge in the branch of that.


---

Comment by mkoeppe created at 2021-04-20 16:12:58

I have opened #31705 for the lazy import improvements


---

Comment by @kliem created at 2021-04-25 06:04:27


```
                L_section = linear_transformation(matrix(len(pivots), self.ambient_dim(),
                                                         [E[i] for i in range(len(pivots))]).transpose(),
                                                  side='right')
```

This is not always an inverse to `A`:


```
sage: set_random_seed(0)                                                                                                              
sage: M = random_matrix(ZZ, 5, 5, distribution='uniform')                                                                             
sage: while True: 
....:     M = random_matrix(ZZ, 5, 5, distribution='uniform')   
....:     if M.rank() != 5: 
....:         break 
....:                                                                                                                                 
sage: P = Polyhedron(M)                                                                                                               
sage: P._test_affine_hull_projection()                                                                                                
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-23-f3c92d590b2b> in <module>
----> 1 P._test_affine_hull_projection()

~/Applications/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/base.py in _test_affine_hull_projection(self, tester, verbose, **options)
  10487             else:
  10488                 self_extend = self
> 10489             tester.assertEqual(data.polyhedron.linear_transformation(M)
  10490                                + data.section_translation,
  10491                                self_extend)

/usr/lib/python3.8/unittest/case.py in assertEqual(self, first, second, msg)
    910         """
    911         assertion_func = self._getAssertEqualityFunc(first, second)
--> 912         assertion_func(first, second, msg=msg)
    913 
    914     def assertNotEqual(self, first, second, msg=None):

/usr/lib/python3.8/unittest/case.py in _baseAssertEqual(self, first, second, msg)
    903             standardMsg = '%s != %s' % _common_shorten_repr(first, second)
    904             msg = self._formatMessage(msg, standardMsg)
--> 905             raise self.failureException(msg)
    906 
    907     def assertEqual(self, first, second, msg=None):

AssertionError: A 4-dimensional polyhedron in QQ^5 defined as the convex hull of 5 vertices != A 4-dimensional polyhedron in ZZ^5 defined as the convex hull of 5 vertices
```



---

Comment by @kliem created at 2021-04-25 06:04:27

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-04-25 06:07:38

New commits:


---

Comment by git created at 2021-04-26 11:11:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-04-26 11:11:36

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-04-26 11:24:03

I'm happy with it now.


---

Comment by mkoeppe created at 2021-04-26 16:59:46

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-26 16:59:46

Thanks a lot for finding this elegant fix.


---

Comment by mkoeppe created at 2021-04-26 16:59:46

Changing keywords from "polytope," to "polytope".


---

Comment by vbraun created at 2021-05-27 20:29:23

Resolution: fixed
