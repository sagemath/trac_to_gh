# Issue 14594: Export graphics objects to PGF/TikZ

Issue created by migration from Trac.

Original creator: etn40ff

Original creation time: 2013-06-21 16:18:01

Assignee: jason, was

Keywords: matplotlib, plot, TikZ, days49

This patch allows  to produce PGF/TikZ output than can than be included in LaTeX documents. It is based on the new pgf backend included in matplotlib-1.2+. 

The backend still has some issues that cripple this patch:
* the first time that it is run it produce this warning:

sage: line([(0,0), (1,1)],axes=False).save("/tmp/sage.pgf")
/opt/sage/sage-5.10.rc2/local/lib/python2.7/site-packages/matplotlib/tight_bbox.py:55: UserWarning: bbox_inches option for pgf backend is not implemented yet. 
"implemented yet." % (format))

* closing sage after using save() give this other error:

Exception AttributeError: "'NoneType' object has no attribute 'isdir'" in <bound method LatexManager.__del__ of <matplotlib.backends.backend_pgf.LatexManager instance at 0x7d375a8>> ignored

* finally not all the graphics primitives can be plotted at the moment: printing some text() will trigger 
RuntimeError: Cannot get window extent w/o renderer


---

Comment by jhpalmieri created at 2013-06-21 21:42:51

This doesn't apply cleanly to Sage 5.11.beta3. I would recommend _not_ making all of the white space changes: it makes your patch much more likely to lead to conflicts.


---

Attachment

rebased for 5.11beta3


---

Comment by etn40ff created at 2013-06-23 15:55:00

Sorry for the issue with the last patch: I was working on 5.10. I also followed your advice on spaces.

I clicked on attach file twice so now there are two copies of the patch; is there a way to remove one of them.


---

Comment by leif created at 2013-06-24 13:38:34

Replying to [comment:2 etn40ff]:
> I clicked on attach file twice so now there are two copies of the patch; is there a way to remove one of them.

Yes, I could delete one of them, or both (as I can't rename attachments, so you could afterwards reupload your current patch without a sequence number).

Next time make sure you check the "replace existing bla" box, then the attachment will get updated.


---

Comment by etn40ff created at 2013-06-24 19:52:05

thank you! it should be enough to remove  trac_14798_pgf_tikz_output.2.patch since it is identical to the other file


---

Comment by leif created at 2013-06-24 19:55:24

Replying to [comment:4 etn40ff]:
> thank you! it should be enough to remove  trac_14798_pgf_tikz_output.2.patch since it is identical to the other file

Done and done.


---

Comment by chapoton created at 2014-07-18 19:40:59

I just made a few cosmetic changes.
----
New commits:


---

Comment by etn40ff created at 2014-07-19 11:35:15

Thank you for the cleanup.
I gave this patch another spin and it looks like both the first and third issue got solved by upgrading to matplotlib 1.3. 

The second one is still present. I looked into it: it depends on the method _cleanup of the class LatexManager in matplotlib (the definition is in src/lib/matplotlib/backends/backend_pgf.py). Apparently when calling _cleanup python/sage does not know any more of the existence of the module os.path. I have no idea of how this is possible.


---

Comment by git created at 2014-09-22 18:38:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-08 20:08:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-18 20:58:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2015-09-21 09:30:43

The cause of the second issue is explained in the Python doc about `__del__` method, which is used in the class `LatexManager` in the `.../lib/matplotlib/backends/backend_pgf.py` file. The method tries to close temporary files whose list is kept in the class attribute `_unclean_instances`, by calling `_cleanup(self)` method,  which in turn uses the `os.path` module. But as Sage is shutting down, the last module is in state of being destroyed. Thus an exception raises (but ignored).

Simply speaking, the `__del__` method is doing too much at a critical moment.

I don't know the appropriate way of dealing with this (bug?). Should it be dealt in Sage or at upstream?


---

Comment by git created at 2015-09-24 16:02:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-24 16:03:12

I have just rebased the branch.

I have no opinion on how to solve this "vanishing os" issue.


---

Comment by klee created at 2015-09-25 19:31:30

Reported to the upstream matplotlib community about the second issue. Loaded a patch and requested to pull: https://github.com/matplotlib/matplotlib/pull/5144

With the patch, the second issue resolves in Sage.


---

Comment by klee created at 2015-11-05 05:09:59

The upstream discussion is now moved to https://github.com/matplotlib/matplotlib/pull/5249


---

Comment by klee created at 2016-01-14 09:43:43

The upstream patch was merged to matplotlib 1.5.1, which was released recently. So it remains only to upgrade Sage's matplotlib to the latest stable version, before this ticket is ready for a review.


---

Comment by etn40ff created at 2016-02-22 15:01:46

Matplotlib is now updated to 1.5.1: #19988


---

Comment by etn40ff created at 2016-02-22 15:01:46

Changing status from new to needs_review.


---

Comment by chapoton created at 2016-02-26 13:54:23

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-02-26 13:54:23

ok, looks good to me. Let it go.

I am just slightly worried about the fact that "view" will not work.


---

Comment by klee created at 2016-02-26 14:01:27

Looks good to me too. 

What do you mean by "view"?


---

Comment by chapoton created at 2016-02-26 14:06:26

with this ticket:

```
sage: c=line([(0,0),(1,1)])
sage: view(c)
...
!  ==> Fatal error occurred, no output PDF file produced!

Latex error
```



---

Comment by klee created at 2016-02-26 14:08:49

By its doc, "view" is supposed to give a latex representation of the object. Did it work somehow for a graphics object?


---

Comment by chapoton created at 2016-02-26 14:10:50

Well, it previously used the repr, so display the text "Graphics object .."

Now it is broken..


---

Comment by etn40ff created at 2016-02-26 14:21:22

I  have no access to a sage install today but I can look into this later on. What would you think is the best option for view? Shall it return repr or shall it return the pgf/latex code?
S.


---

Comment by klee created at 2016-02-26 14:30:17

The previous behaviour seems not very useful. It would be nice to give the graphic image itself included by latex. This could be done without using the pgf output. Just include .png file. Anyway pgf is limited and cannot represent all graphics, as far as I know.

By the way, my mac just finished doctesting for Sage 7.1.beta5 with the current patch merged. It reports some failures.

```
----------------------------------------------------------------------
sage -t src/sage/structure/sage_object.pyx  # 1 doctest failed
sage -t src/sage/dev/git_interface.py  # 2 doctests failed
sage -t src/sage/repl/rich_output/pretty_print.py  # 1 doctest failed
----------------------------------------------------------------------
```


I will test again without the patch...


---

Comment by chapoton created at 2016-02-26 14:32:31

we should rather step back for a moment


---

Comment by chapoton created at 2016-02-26 14:32:31

Changing status from positive_review to needs_work.


---

Comment by klee created at 2016-02-26 14:37:25

After retry, the first and third failures seem to be related with this patch.


---

Comment by git created at 2016-02-28 13:07:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-02-28 16:57:07

Replying to [comment:31 etn40ff]:
> I  have no access to a sage install today but I can look into this later on. What would you think is the best option for view? Shall it return repr or shall it return the pgf/latex code?

It should return the pgf/latex code so the behavior remains consistent.

Also you have to do some setup for tikz code:

```python
from sage.graphs.graph_latex import setup_latex_preamble
setup_latex_preamble()
```

That could be why `view` is broken.


---

Comment by git created at 2016-02-29 06:29:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-02-29 06:33:14

Fixed `_latex_()` method of `Graphics` according to the suggestions by tscrim. No more doctest failures. But check if the output of `view(g)` is satisfying.


---

Comment by etn40ff created at 2016-02-29 11:39:09

Dear All,
thank you for dealing with this while I had not sage to play with. 
I am back at it now and I agree with the changes made so far. 

One thing I am not convinced of is how the output of `view` looks like: the
figure is all squashed to the right side. 

A possible fix to this is to enclose the output of `latex()` into a
`\makebox[\textwidth]{` `}`.  This unfortunately creates some problem with latex
itself. Somehow if we put things inside a `\makebox` environment then latex
complains about undefined control sequence `\pgfsys`. The latex code works
perfectly without the `\makebox`. To replicate this do as follows:

With the current code

```
sage: c = plot(sin(x))
sage: view(c)
```

works but the figure is all squashed to the right.

Apply this patch then and try again

```
diff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py
index de63252..ee62c3e 100644
--- a/src/sage/misc/latex.py
+++ b/src/sage/misc/latex.py
`@``@` -1768,7 +1768,9 `@``@` def _latex_file_(objects, title='SAGE', debug=False, \
         for i in range(len(objects)):
             x = objects[i]
             L = latex(x)
-            if not '\\begin{verbatim}' in L:
+            if '\\begin{pgfpicture}' in L:
+                s += '\n\\makebox[\\textwidth]{\n%s\n}\n'%L
+            elif not '\\begin{verbatim}' in L:
                 s += '%s%s%s'%(math_left, L, math_right)
             else:
                 s += '%s'%L
```



```
sage: c = plot(sin(x))
sage: view(c) #fails with undefined control sequence \pgfsys
sage: c._show_axes = False
sage: view(c) #works and places the figure nicely
```

Apparently the issue is with the axes.

To get the code that sages tries to compile you can do

```
sage: from sage.misc.latex import _latex_file_
sage: s = _latex_file_(latex(c))
sage: f = open('/tmp/sage.tex','w'); f.write(s); f.close()
```


Any idea on how to tackle this?

One more issue (this, I think, is a bug upstream):

```
sage: c = text('Hello World!',(1,0))
sage: latex(c)
...
IOError: [Errno 32] Broken pipe
```



---

Comment by git created at 2016-02-29 14:33:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by etn40ff created at 2016-02-29 14:44:04

Changing status from needs_work to needs_review.


---

Comment by etn40ff created at 2016-02-29 14:44:04

I managed to fix the alignment issue using the ambient `adjustbox` instead of `\makebox`; this requires an extra package but at least produces the desired output.

I can't replicate the issue with text after recompiling sage. Running doctest now.


---

Comment by etn40ff created at 2016-03-01 09:25:08

Ok doctesting works fine on my machine (and on a couple of instances of patchbot) but one test fails on other patchbots.
It looks like something related to the installation of latex on those machines since the error is


```
LaTeX Error: File `utf8x.def' not found
```



---

Comment by git created at 2016-03-02 07:20:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-02 07:28:32

I prefer to avoid the extra package `adjustbox` as it is here used just to resize the figure to the text width, which can be accomplished by standard latex commands and an existing package `graphicx`. The "standard" approach has a merit of being faster.


---

Comment by klee created at 2016-03-07 07:05:57

If there's no objection, I give positive review.


---

Comment by klee created at 2016-03-07 07:05:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-07 21:43:25

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-03-07 21:43:25


```
sage -t --long src/sage/repl/rich_output/pretty_print.py
**********************************************************************
File "src/sage/repl/rich_output/pretty_print.py", line 224, in sage.repl.rich_output.pretty_print.pretty_print
Failed example:
    pretty_print(ZZ, 123, plt)    # latex output
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.pretty_print.pretty_print[7]>", line 1, in <module>
        pretty_print(ZZ, Integer(123), plt)    # latex output
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 247, in pretty_print
        SequencePrettyPrinter(*args, **kwds).pretty_print()
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 161, in pretty_print
        get_display_manager().display_immediately(args, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 791, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 633, in _rich_output_formatter
        obj, plain_text=plain_text, **rich_repr_kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 535, in _preferred_text_formatter
        out = self._backend.latex_formatter(obj, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_base.py", line 481, in latex_formatter
        mathjax = MathJax().eval(obj, mode='plain', combine_all=True)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 1950, in eval
        x = latex(x, combine_all=combine_all)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 924, in __call__
        return LatexExpr(f(x, combine_all=combine_all))
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 207, in tuple_function
        return " ".join([latex(v) for v in x])
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 920, in __call__
        return LatexExpr(x._latex_())
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3266, in _latex_
        self.save(filename=tmpfilename, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 471, in wrapper
        return func(*args, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3199, in save
        raise ValueError("Matplotlib requires either xelatex, "
    ValueError: Matplotlib requires either xelatex, lualatex, or pdflatex.
**********************************************************************
1 item had failures:
   1 of  10 in sage.repl.rich_output.pretty_print.pretty_print
    [33 tests, 1 failure, 4.00 s]
```



---

Comment by klee created at 2016-03-08 00:24:56

The last failure is just due to the lack of latex on the system as stated in the error output. As the doctest clearly indicates that it produces latex output (and requires latex installed on the system), I think the blame should be on the system or on the doctesting mechanism of Sage, rather than the patch.


---

Comment by git created at 2016-03-08 10:40:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by etn40ff created at 2016-03-08 10:42:10

I do not have a sage install without latex to test this


---

Comment by tscrim created at 2016-03-08 22:14:19

It would be nice if the poseidon buildbot would come around to this ticket again, but the test will get skipped unless someone specifically adds `latex` to the optional flags. So based on this fact and this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/K1xtiWcNjvw), I'm going to set this back to a positive review.


---

Comment by tscrim created at 2016-03-08 22:14:19

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-03-09 08:29:00

Resolution: fixed
