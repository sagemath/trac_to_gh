# Issue 14594: Export graphics objects to PGF/TikZ

archive/issues_014594.json:
```json
{
    "body": "Assignee: jason, was\n\nKeywords: matplotlib, plot, TikZ, days49\n\nThis patch allows  to produce PGF/TikZ output than can than be included in LaTeX documents. It is based on the new pgf backend included in matplotlib-1.2+. \n\nThe backend still has some issues that cripple this patch:\n* the first time that it is run it produce this warning:\n\nsage: line([(0,0), (1,1)],axes=False).save(\"/tmp/sage.pgf\")\n/opt/sage/sage-5.10.rc2/local/lib/python2.7/site-packages/matplotlib/tight_bbox.py:55: UserWarning: bbox_inches option for pgf backend is not implemented yet. \n\"implemented yet.\" % (format))\n\n* closing sage after using save() give this other error:\n\nException AttributeError: \"'NoneType' object has no attribute 'isdir'\" in <bound method LatexManager.__del__ of <matplotlib.backends.backend_pgf.LatexManager instance at 0x7d375a8>> ignored\n\n* finally not all the graphics primitives can be plotted at the moment: printing some text() will trigger \nRuntimeError: Cannot get window extent w/o renderer\n\nIssue created by migration from https://trac.sagemath.org/ticket/14798\n\n",
    "created_at": "2013-06-21T16:18:01Z",
    "labels": [
        "graphics",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Export graphics objects to PGF/TikZ",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14594",
    "user": "@etn40ff"
}
```
Assignee: jason, was

Keywords: matplotlib, plot, TikZ, days49

This patch allows  to produce PGF/TikZ output than can than be included in LaTeX documents. It is based on the new pgf backend included in matplotlib-1.2+. 

The backend still has some issues that cripple this patch:
* the first time that it is run it produce this warning:

sage: line([(0,0), (1,1)],axes=False).save("/tmp/sage.pgf")
/opt/sage/sage-5.10.rc2/local/lib/python2.7/site-packages/matplotlib/tight_bbox.py:55: UserWarning: bbox_inches option for pgf backend is not implemented yet. 
"implemented yet." % (format))

* closing sage after using save() give this other error:

Exception AttributeError: "'NoneType' object has no attribute 'isdir'" in <bound method LatexManager.__del__ of <matplotlib.backends.backend_pgf.LatexManager instance at 0x7d375a8>> ignored

* finally not all the graphics primitives can be plotted at the moment: printing some text() will trigger 
RuntimeError: Cannot get window extent w/o renderer

Issue created by migration from https://trac.sagemath.org/ticket/14798





---

archive/issue_comments_185508.json:
```json
{
    "body": "This doesn't apply cleanly to Sage 5.11.beta3. I would recommend *not* making all of the white space changes: it makes your patch much more likely to lead to conflicts.",
    "created_at": "2013-06-21T21:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185508",
    "user": "@jhpalmieri"
}
```

This doesn't apply cleanly to Sage 5.11.beta3. I would recommend *not* making all of the white space changes: it makes your patch much more likely to lead to conflicts.



---

archive/issue_comments_185509.json:
```json
{
    "body": "Attachment [trac_14798_pgf_tikz_output.patch](tarball://root/attachments/some-uuid/ticket14798/trac_14798_pgf_tikz_output.patch) by @etn40ff created at 2013-06-23 15:48:18\n\nrebased for 5.11beta3",
    "created_at": "2013-06-23T15:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185509",
    "user": "@etn40ff"
}
```

Attachment [trac_14798_pgf_tikz_output.patch](tarball://root/attachments/some-uuid/ticket14798/trac_14798_pgf_tikz_output.patch) by @etn40ff created at 2013-06-23 15:48:18

rebased for 5.11beta3



---

archive/issue_comments_185510.json:
```json
{
    "body": "Sorry for the issue with the last patch: I was working on 5.10. I also followed your advice on spaces.\n\nI clicked on attach file twice so now there are two copies of the patch; is there a way to remove one of them.",
    "created_at": "2013-06-23T15:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185510",
    "user": "@etn40ff"
}
```

Sorry for the issue with the last patch: I was working on 5.10. I also followed your advice on spaces.

I clicked on attach file twice so now there are two copies of the patch; is there a way to remove one of them.



---

archive/issue_comments_185511.json:
```json
{
    "body": "Replying to [comment:2 etn40ff]:\n> I clicked on attach file twice so now there are two copies of the patch; is there a way to remove one of them.\n\nYes, I could delete one of them, or both (as I can't rename attachments, so you could afterwards reupload your current patch without a sequence number).\n\nNext time make sure you check the \"replace existing bla\" box, then the attachment will get updated.",
    "created_at": "2013-06-24T13:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185511",
    "user": "@nexttime"
}
```

Replying to [comment:2 etn40ff]:
> I clicked on attach file twice so now there are two copies of the patch; is there a way to remove one of them.

Yes, I could delete one of them, or both (as I can't rename attachments, so you could afterwards reupload your current patch without a sequence number).

Next time make sure you check the "replace existing bla" box, then the attachment will get updated.



---

archive/issue_comments_185512.json:
```json
{
    "body": "thank you! it should be enough to remove  trac_14798_pgf_tikz_output.2.patch since it is identical to the other file",
    "created_at": "2013-06-24T19:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185512",
    "user": "@etn40ff"
}
```

thank you! it should be enough to remove  trac_14798_pgf_tikz_output.2.patch since it is identical to the other file



---

archive/issue_comments_185513.json:
```json
{
    "body": "Replying to [comment:4 etn40ff]:\n> thank you! it should be enough to remove  trac_14798_pgf_tikz_output.2.patch since it is identical to the other file\n\nDone and done.",
    "created_at": "2013-06-24T19:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185513",
    "user": "@nexttime"
}
```

Replying to [comment:4 etn40ff]:
> thank you! it should be enough to remove  trac_14798_pgf_tikz_output.2.patch since it is identical to the other file

Done and done.



---

archive/issue_comments_185514.json:
```json
{
    "body": "I just made a few cosmetic changes.\n----\nNew commits:",
    "created_at": "2014-07-18T19:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185514",
    "user": "@fchapoton"
}
```

I just made a few cosmetic changes.
----
New commits:



---

archive/issue_comments_185515.json:
```json
{
    "body": "Thank you for the cleanup.\nI gave this patch another spin and it looks like both the first and third issue got solved by upgrading to matplotlib 1.3. \n\nThe second one is still present. I looked into it: it depends on the method _cleanup of the class LatexManager in matplotlib (the definition is in src/lib/matplotlib/backends/backend_pgf.py). Apparently when calling _cleanup python/sage does not know any more of the existence of the module os.path. I have no idea of how this is possible.",
    "created_at": "2014-07-19T11:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185515",
    "user": "@etn40ff"
}
```

Thank you for the cleanup.
I gave this patch another spin and it looks like both the first and third issue got solved by upgrading to matplotlib 1.3. 

The second one is still present. I looked into it: it depends on the method _cleanup of the class LatexManager in matplotlib (the definition is in src/lib/matplotlib/backends/backend_pgf.py). Apparently when calling _cleanup python/sage does not know any more of the existence of the module os.path. I have no idea of how this is possible.



---

archive/issue_comments_185516.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-22T18:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185516",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185517.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-08T20:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185517",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185518.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-18T20:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185518",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185519.json:
```json
{
    "body": "The cause of the second issue is explained in the Python doc about `__del__` method, which is used in the class `LatexManager` in the `.../lib/matplotlib/backends/backend_pgf.py` file. The method tries to close temporary files whose list is kept in the class attribute `_unclean_instances`, by calling `_cleanup(self)` method,  which in turn uses the `os.path` module. But as Sage is shutting down, the last module is in state of being destroyed. Thus an exception raises (but ignored).\n\nSimply speaking, the `__del__` method is doing too much at a critical moment.\n\nI don't know the appropriate way of dealing with this (bug?). Should it be dealt in Sage or at upstream?",
    "created_at": "2015-09-21T09:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185519",
    "user": "@kwankyu"
}
```

The cause of the second issue is explained in the Python doc about `__del__` method, which is used in the class `LatexManager` in the `.../lib/matplotlib/backends/backend_pgf.py` file. The method tries to close temporary files whose list is kept in the class attribute `_unclean_instances`, by calling `_cleanup(self)` method,  which in turn uses the `os.path` module. But as Sage is shutting down, the last module is in state of being destroyed. Thus an exception raises (but ignored).

Simply speaking, the `__del__` method is doing too much at a critical moment.

I don't know the appropriate way of dealing with this (bug?). Should it be dealt in Sage or at upstream?



---

archive/issue_comments_185520.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-24T16:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185520",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185521.json:
```json
{
    "body": "I have just rebased the branch.\n\nI have no opinion on how to solve this \"vanishing os\" issue.",
    "created_at": "2015-09-24T16:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185521",
    "user": "@fchapoton"
}
```

I have just rebased the branch.

I have no opinion on how to solve this "vanishing os" issue.



---

archive/issue_comments_185522.json:
```json
{
    "body": "Reported to the upstream matplotlib community about the second issue. Loaded a patch and requested to pull: https://github.com/matplotlib/matplotlib/pull/5144\n\nWith the patch, the second issue resolves in Sage.",
    "created_at": "2015-09-25T19:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185522",
    "user": "@kwankyu"
}
```

Reported to the upstream matplotlib community about the second issue. Loaded a patch and requested to pull: https://github.com/matplotlib/matplotlib/pull/5144

With the patch, the second issue resolves in Sage.



---

archive/issue_comments_185523.json:
```json
{
    "body": "The upstream discussion is now moved to https://github.com/matplotlib/matplotlib/pull/5249",
    "created_at": "2015-11-05T05:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185523",
    "user": "@kwankyu"
}
```

The upstream discussion is now moved to https://github.com/matplotlib/matplotlib/pull/5249



---

archive/issue_comments_185524.json:
```json
{
    "body": "The upstream patch was merged to matplotlib 1.5.1, which was released recently. So it remains only to upgrade Sage's matplotlib to the latest stable version, before this ticket is ready for a review.",
    "created_at": "2016-01-14T09:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185524",
    "user": "@kwankyu"
}
```

The upstream patch was merged to matplotlib 1.5.1, which was released recently. So it remains only to upgrade Sage's matplotlib to the latest stable version, before this ticket is ready for a review.



---

archive/issue_comments_185525.json:
```json
{
    "body": "Matplotlib is now updated to 1.5.1: #19988",
    "created_at": "2016-02-22T15:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185525",
    "user": "@etn40ff"
}
```

Matplotlib is now updated to 1.5.1: #19988



---

archive/issue_comments_185526.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-02-22T15:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185526",
    "user": "@etn40ff"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_185527.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-02-26T13:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185527",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_185528.json:
```json
{
    "body": "ok, looks good to me. Let it go.\n\nI am just slightly worried about the fact that \"view\" will not work.",
    "created_at": "2016-02-26T13:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185528",
    "user": "@fchapoton"
}
```

ok, looks good to me. Let it go.

I am just slightly worried about the fact that "view" will not work.



---

archive/issue_comments_185529.json:
```json
{
    "body": "Looks good to me too. \n\nWhat do you mean by \"view\"?",
    "created_at": "2016-02-26T14:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185529",
    "user": "@kwankyu"
}
```

Looks good to me too. 

What do you mean by "view"?



---

archive/issue_comments_185530.json:
```json
{
    "body": "with this ticket:\n\n```\nsage: c=line([(0,0),(1,1)])\nsage: view(c)\n...\n!  ==> Fatal error occurred, no output PDF file produced!\n\nLatex error\n```\n",
    "created_at": "2016-02-26T14:06:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185530",
    "user": "@fchapoton"
}
```

with this ticket:

```
sage: c=line([(0,0),(1,1)])
sage: view(c)
...
!  ==> Fatal error occurred, no output PDF file produced!

Latex error
```




---

archive/issue_comments_185531.json:
```json
{
    "body": "By its doc, \"view\" is supposed to give a latex representation of the object. Did it work somehow for a graphics object?",
    "created_at": "2016-02-26T14:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185531",
    "user": "@kwankyu"
}
```

By its doc, "view" is supposed to give a latex representation of the object. Did it work somehow for a graphics object?



---

archive/issue_comments_185532.json:
```json
{
    "body": "Well, it previously used the repr, so display the text \"Graphics object ..\"\n\nNow it is broken..",
    "created_at": "2016-02-26T14:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185532",
    "user": "@fchapoton"
}
```

Well, it previously used the repr, so display the text "Graphics object .."

Now it is broken..



---

archive/issue_comments_185533.json:
```json
{
    "body": "I  have no access to a sage install today but I can look into this later on. What would you think is the best option for view? Shall it return repr or shall it return the pgf/latex code?\nS.",
    "created_at": "2016-02-26T14:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185533",
    "user": "@etn40ff"
}
```

I  have no access to a sage install today but I can look into this later on. What would you think is the best option for view? Shall it return repr or shall it return the pgf/latex code?
S.



---

archive/issue_comments_185534.json:
```json
{
    "body": "The previous behaviour seems not very useful. It would be nice to give the graphic image itself included by latex. This could be done without using the pgf output. Just include .png file. Anyway pgf is limited and cannot represent all graphics, as far as I know.\n\nBy the way, my mac just finished doctesting for Sage 7.1.beta5 with the current patch merged. It reports some failures.\n\n```\n----------------------------------------------------------------------\nsage -t src/sage/structure/sage_object.pyx  # 1 doctest failed\nsage -t src/sage/dev/git_interface.py  # 2 doctests failed\nsage -t src/sage/repl/rich_output/pretty_print.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\n\nI will test again without the patch...",
    "created_at": "2016-02-26T14:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185534",
    "user": "@kwankyu"
}
```

The previous behaviour seems not very useful. It would be nice to give the graphic image itself included by latex. This could be done without using the pgf output. Just include .png file. Anyway pgf is limited and cannot represent all graphics, as far as I know.

By the way, my mac just finished doctesting for Sage 7.1.beta5 with the current patch merged. It reports some failures.

```
----------------------------------------------------------------------
sage -t src/sage/structure/sage_object.pyx  # 1 doctest failed
sage -t src/sage/dev/git_interface.py  # 2 doctests failed
sage -t src/sage/repl/rich_output/pretty_print.py  # 1 doctest failed
----------------------------------------------------------------------
```


I will test again without the patch...



---

archive/issue_comments_185535.json:
```json
{
    "body": "we should rather step back for a moment",
    "created_at": "2016-02-26T14:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185535",
    "user": "@fchapoton"
}
```

we should rather step back for a moment



---

archive/issue_comments_185536.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-02-26T14:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185536",
    "user": "@fchapoton"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_185537.json:
```json
{
    "body": "After retry, the first and third failures seem to be related with this patch.",
    "created_at": "2016-02-26T14:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185537",
    "user": "@kwankyu"
}
```

After retry, the first and third failures seem to be related with this patch.



---

archive/issue_comments_185538.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-28T13:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185538",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185539.json:
```json
{
    "body": "Replying to [comment:31 etn40ff]:\n> I  have no access to a sage install today but I can look into this later on. What would you think is the best option for view? Shall it return repr or shall it return the pgf/latex code?\n\nIt should return the pgf/latex code so the behavior remains consistent.\n\nAlso you have to do some setup for tikz code:\n\n```python\nfrom sage.graphs.graph_latex import setup_latex_preamble\nsetup_latex_preamble()\n```\n\nThat could be why `view` is broken.",
    "created_at": "2016-02-28T16:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185539",
    "user": "@tscrim"
}
```

Replying to [comment:31 etn40ff]:
> I  have no access to a sage install today but I can look into this later on. What would you think is the best option for view? Shall it return repr or shall it return the pgf/latex code?

It should return the pgf/latex code so the behavior remains consistent.

Also you have to do some setup for tikz code:

```python
from sage.graphs.graph_latex import setup_latex_preamble
setup_latex_preamble()
```

That could be why `view` is broken.



---

archive/issue_comments_185540.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-29T06:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185540",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185541.json:
```json
{
    "body": "Fixed `_latex_()` method of `Graphics` according to the suggestions by tscrim. No more doctest failures. But check if the output of `view(g)` is satisfying.",
    "created_at": "2016-02-29T06:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185541",
    "user": "@kwankyu"
}
```

Fixed `_latex_()` method of `Graphics` according to the suggestions by tscrim. No more doctest failures. But check if the output of `view(g)` is satisfying.



---

archive/issue_comments_185542.json:
```json
{
    "body": "Dear All,\nthank you for dealing with this while I had not sage to play with. \nI am back at it now and I agree with the changes made so far. \n\nOne thing I am not convinced of is how the output of `view` looks like: the\nfigure is all squashed to the right side. \n\nA possible fix to this is to enclose the output of `latex()` into a\n`\\makebox[\\textwidth]{` `}`.  This unfortunately creates some problem with latex\nitself. Somehow if we put things inside a `\\makebox` environment then latex\ncomplains about undefined control sequence `\\pgfsys`. The latex code works\nperfectly without the `\\makebox`. To replicate this do as follows:\n\nWith the current code\n\n```\nsage: c = plot(sin(x))\nsage: view(c)\n```\n\nworks but the figure is all squashed to the right.\n\nApply this patch then and try again\n\n```\ndiff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py\nindex de63252..ee62c3e 100644\n--- a/src/sage/misc/latex.py\n+++ b/src/sage/misc/latex.py\n@@ -1768,7 +1768,9 @@ def _latex_file_(objects, title='SAGE', debug=False, \\\n         for i in range(len(objects)):\n             x = objects[i]\n             L = latex(x)\n-            if not '\\\\begin{verbatim}' in L:\n+            if '\\\\begin{pgfpicture}' in L:\n+                s += '\\n\\\\makebox[\\\\textwidth]{\\n%s\\n}\\n'%L\n+            elif not '\\\\begin{verbatim}' in L:\n                 s += '%s%s%s'%(math_left, L, math_right)\n             else:\n                 s += '%s'%L\n```\n\n\n\n```\nsage: c = plot(sin(x))\nsage: view(c) #fails with undefined control sequence \\pgfsys\nsage: c._show_axes = False\nsage: view(c) #works and places the figure nicely\n```\n\nApparently the issue is with the axes.\n\nTo get the code that sages tries to compile you can do\n\n```\nsage: from sage.misc.latex import _latex_file_\nsage: s = _latex_file_(latex(c))\nsage: f = open('/tmp/sage.tex','w'); f.write(s); f.close()\n```\n\n\nAny idea on how to tackle this?\n\nOne more issue (this, I think, is a bug upstream):\n\n```\nsage: c = text('Hello World!',(1,0))\nsage: latex(c)\n...\nIOError: [Errno 32] Broken pipe\n```\n",
    "created_at": "2016-02-29T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185542",
    "user": "@etn40ff"
}
```

Dear All,
thank you for dealing with this while I had not sage to play with. 
I am back at it now and I agree with the changes made so far. 

One thing I am not convinced of is how the output of `view` looks like: the
figure is all squashed to the right side. 

A possible fix to this is to enclose the output of `latex()` into a
`\makebox[\textwidth]{` `}`.  This unfortunately creates some problem with latex
itself. Somehow if we put things inside a `\makebox` environment then latex
complains about undefined control sequence `\pgfsys`. The latex code works
perfectly without the `\makebox`. To replicate this do as follows:

With the current code

```
sage: c = plot(sin(x))
sage: view(c)
```

works but the figure is all squashed to the right.

Apply this patch then and try again

```
diff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py
index de63252..ee62c3e 100644
--- a/src/sage/misc/latex.py
+++ b/src/sage/misc/latex.py
@@ -1768,7 +1768,9 @@ def _latex_file_(objects, title='SAGE', debug=False, \
         for i in range(len(objects)):
             x = objects[i]
             L = latex(x)
-            if not '\\begin{verbatim}' in L:
+            if '\\begin{pgfpicture}' in L:
+                s += '\n\\makebox[\\textwidth]{\n%s\n}\n'%L
+            elif not '\\begin{verbatim}' in L:
                 s += '%s%s%s'%(math_left, L, math_right)
             else:
                 s += '%s'%L
```



```
sage: c = plot(sin(x))
sage: view(c) #fails with undefined control sequence \pgfsys
sage: c._show_axes = False
sage: view(c) #works and places the figure nicely
```

Apparently the issue is with the axes.

To get the code that sages tries to compile you can do

```
sage: from sage.misc.latex import _latex_file_
sage: s = _latex_file_(latex(c))
sage: f = open('/tmp/sage.tex','w'); f.write(s); f.close()
```


Any idea on how to tackle this?

One more issue (this, I think, is a bug upstream):

```
sage: c = text('Hello World!',(1,0))
sage: latex(c)
...
IOError: [Errno 32] Broken pipe
```




---

archive/issue_comments_185543.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-29T14:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185543",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185544.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-02-29T14:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185544",
    "user": "@etn40ff"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_185545.json:
```json
{
    "body": "I managed to fix the alignment issue using the ambient `adjustbox` instead of `\\makebox`; this requires an extra package but at least produces the desired output.\n\nI can't replicate the issue with text after recompiling sage. Running doctest now.",
    "created_at": "2016-02-29T14:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185545",
    "user": "@etn40ff"
}
```

I managed to fix the alignment issue using the ambient `adjustbox` instead of `\makebox`; this requires an extra package but at least produces the desired output.

I can't replicate the issue with text after recompiling sage. Running doctest now.



---

archive/issue_comments_185546.json:
```json
{
    "body": "Ok doctesting works fine on my machine (and on a couple of instances of patchbot) but one test fails on other patchbots.\nIt looks like something related to the installation of latex on those machines since the error is\n\n\n```\nLaTeX Error: File `utf8x.def' not found\n```\n",
    "created_at": "2016-03-01T09:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185546",
    "user": "@etn40ff"
}
```

Ok doctesting works fine on my machine (and on a couple of instances of patchbot) but one test fails on other patchbots.
It looks like something related to the installation of latex on those machines since the error is


```
LaTeX Error: File `utf8x.def' not found
```




---

archive/issue_comments_185547.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-02T07:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185547",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185548.json:
```json
{
    "body": "I prefer to avoid the extra package `adjustbox` as it is here used just to resize the figure to the text width, which can be accomplished by standard latex commands and an existing package `graphicx`. The \"standard\" approach has a merit of being faster.",
    "created_at": "2016-03-02T07:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185548",
    "user": "@kwankyu"
}
```

I prefer to avoid the extra package `adjustbox` as it is here used just to resize the figure to the text width, which can be accomplished by standard latex commands and an existing package `graphicx`. The "standard" approach has a merit of being faster.



---

archive/issue_comments_185549.json:
```json
{
    "body": "If there's no objection, I give positive review.",
    "created_at": "2016-03-07T07:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185549",
    "user": "@kwankyu"
}
```

If there's no objection, I give positive review.



---

archive/issue_comments_185550.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-07T07:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185550",
    "user": "@kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_185551.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-07T21:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185551",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_185552.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/repl/rich_output/pretty_print.py\n**********************************************************************\nFile \"src/sage/repl/rich_output/pretty_print.py\", line 224, in sage.repl.rich_output.pretty_print.pretty_print\nFailed example:\n    pretty_print(ZZ, 123, plt)    # latex output\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.pretty_print.pretty_print[7]>\", line 1, in <module>\n        pretty_print(ZZ, Integer(123), plt)    # latex output\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 247, in pretty_print\n        SequencePrettyPrinter(*args, **kwds).pretty_print()\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py\", line 161, in pretty_print\n        get_display_manager().display_immediately(args, **kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 791, in display_immediately\n        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 633, in _rich_output_formatter\n        obj, plain_text=plain_text, **rich_repr_kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 535, in _preferred_text_formatter\n        out = self._backend.latex_formatter(obj, **kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_base.py\", line 481, in latex_formatter\n        mathjax = MathJax().eval(obj, mode='plain', combine_all=True)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py\", line 1950, in eval\n        x = latex(x, combine_all=combine_all)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py\", line 924, in __call__\n        return LatexExpr(f(x, combine_all=combine_all))\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py\", line 207, in tuple_function\n        return \" \".join([latex(v) for v in x])\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py\", line 920, in __call__\n        return LatexExpr(x._latex_())\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 3266, in _latex_\n        self.save(filename=tmpfilename, **kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/decorators.py\", line 471, in wrapper\n        return func(*args, **kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 3199, in save\n        raise ValueError(\"Matplotlib requires either xelatex, \"\n    ValueError: Matplotlib requires either xelatex, lualatex, or pdflatex.\n**********************************************************************\n1 item had failures:\n   1 of  10 in sage.repl.rich_output.pretty_print.pretty_print\n    [33 tests, 1 failure, 4.00 s]\n```\n",
    "created_at": "2016-03-07T21:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185552",
    "user": "@vbraun"
}
```


```
sage -t --long src/sage/repl/rich_output/pretty_print.py
**********************************************************************
File "src/sage/repl/rich_output/pretty_print.py", line 224, in sage.repl.rich_output.pretty_print.pretty_print
Failed example:
    pretty_print(ZZ, 123, plt)    # latex output
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.pretty_print.pretty_print[7]>", line 1, in <module>
        pretty_print(ZZ, Integer(123), plt)    # latex output
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 247, in pretty_print
        SequencePrettyPrinter(*args, **kwds).pretty_print()
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 161, in pretty_print
        get_display_manager().display_immediately(args, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 791, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 633, in _rich_output_formatter
        obj, plain_text=plain_text, **rich_repr_kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 535, in _preferred_text_formatter
        out = self._backend.latex_formatter(obj, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_base.py", line 481, in latex_formatter
        mathjax = MathJax().eval(obj, mode='plain', combine_all=True)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 1950, in eval
        x = latex(x, combine_all=combine_all)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 924, in __call__
        return LatexExpr(f(x, combine_all=combine_all))
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 207, in tuple_function
        return " ".join([latex(v) for v in x])
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/latex.py", line 920, in __call__
        return LatexExpr(x._latex_())
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3266, in _latex_
        self.save(filename=tmpfilename, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 471, in wrapper
        return func(*args, **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3199, in save
        raise ValueError("Matplotlib requires either xelatex, "
    ValueError: Matplotlib requires either xelatex, lualatex, or pdflatex.
**********************************************************************
1 item had failures:
   1 of  10 in sage.repl.rich_output.pretty_print.pretty_print
    [33 tests, 1 failure, 4.00 s]
```




---

archive/issue_comments_185553.json:
```json
{
    "body": "The last failure is just due to the lack of latex on the system as stated in the error output. As the doctest clearly indicates that it produces latex output (and requires latex installed on the system), I think the blame should be on the system or on the doctesting mechanism of Sage, rather than the patch.",
    "created_at": "2016-03-08T00:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185553",
    "user": "@kwankyu"
}
```

The last failure is just due to the lack of latex on the system as stated in the error output. As the doctest clearly indicates that it produces latex output (and requires latex installed on the system), I think the blame should be on the system or on the doctesting mechanism of Sage, rather than the patch.



---

archive/issue_comments_185554.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-08T10:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185554",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_185555.json:
```json
{
    "body": "I do not have a sage install without latex to test this",
    "created_at": "2016-03-08T10:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185555",
    "user": "@etn40ff"
}
```

I do not have a sage install without latex to test this



---

archive/issue_comments_185556.json:
```json
{
    "body": "It would be nice if the poseidon buildbot would come around to this ticket again, but the test will get skipped unless someone specifically adds `latex` to the optional flags. So based on this fact and this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/K1xtiWcNjvw), I'm going to set this back to a positive review.",
    "created_at": "2016-03-08T22:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185556",
    "user": "@tscrim"
}
```

It would be nice if the poseidon buildbot would come around to this ticket again, but the test will get skipped unless someone specifically adds `latex` to the optional flags. So based on this fact and this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/K1xtiWcNjvw), I'm going to set this back to a positive review.



---

archive/issue_comments_185557.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-03-08T22:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185557",
    "user": "@tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_185558.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-09T08:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14594#issuecomment-185558",
    "user": "@vbraun"
}
```

Resolution: fixed
