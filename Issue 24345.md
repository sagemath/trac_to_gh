# Issue 24345: py3: fixes to sage.structure.sage_object

Issue created by migration from https://trac.sagemath.org/ticket/24582

Original creator: embray

Original creation time: 2018-01-22 13:12:40

CC:  jdemeyer

Along with some related fixes to `sage.misc.explain_pickle` (which otherwise still has many failures on Python 3 due mostly to string/bytes differences).

Most of these fixes have to do with pickling, especially minor differences in the API of the `pickle` module.


---

Comment by git created at 2018-01-22 13:12:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-22 13:14:12

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-13 19:35:26

I haven't looked in detail, but I wonder if `SageUnpickler` could be written to work for both Python 2 and Python 3.


---

Comment by chapoton created at 2018-02-14 08:47:25

green bot


---

Comment by embray created at 2018-02-14 15:46:00

Replying to [comment:4 jdemeyer]:
> I haven't looked in detail, but I wonder if `SageUnpickler` could be written to work for both Python 2 and Python 3.

*probably* not, since in Python 2 the `cPickle.Unpickler` class has some oddities, and in particular its `find_globals` attribute has some strange behavior.  But I agree it might be worth a try...


---

Comment by embray created at 2018-02-14 16:05:46

Oh I remember now, the only reason the tests for `SageUnpickler` even work on Python 2 is that it's subclassing the pure Python implementation in that case, which is less strange but also slower.

But perhaps I could make a single `SageUnpickler` class that delegates to the preferred underlying implementation.


---

Comment by chapoton created at 2018-03-11 12:38:11

Maybe it is time to start moving forward here again ?


---

Comment by chapoton created at 2018-03-11 12:40:03

In python3-sage, trying to run `./sage -t src/sage/combinat/necklace.py`:

```
File "src/sage/combinat/necklace.py", line 104, in sage.combinat.necklace.Necklaces_evaluation.__init__
Failed example:
    N == loads(dumps(N))
Exception raised:
    Traceback (most recent call last):
      File "sage/structure/sage_object.pyx", line 1456, in sage.structure.sage_object.unpickle_global (build/cythonized/sage/structure/sage_object.c:15713)
    ModuleNotFoundError: No module named '__builtin__'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 548, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 958, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.necklace.Necklaces_evaluation.__init__[1]>", line 1, in <module>
        N == loads(dumps(N))
      File "sage/structure/sage_object.pyx", line 1557, in sage.structure.sage_object.loads (build/cythonized/sage/structure/sage_object.c:16726)
      File "sage/structure/sage_object.pyx", line 1504, in sage.structure.sage_object.SageUnpickler.find_class (build/cythonized/sage/structure/sage_object.c:15991)
      File "sage/structure/sage_object.pyx", line 1458, in sage.structure.sage_object.unpickle_global (build/cythonized/sage/structure/sage_object.c:15759)
      File "sage/structure/sage_object.pyx", line 1445, in sage.structure.sage_object.unpickle_global.error (build/cythonized/sage/structure/sage_object.c:15321)
    ImportError: cannot import getattr from __builtin__, call register_unpickle_override('__builtin__', 'getattr', ...) to fix this
```



---

Comment by embray created at 2018-03-12 14:08:32

I think I fixed that issue, but I forget what the cause was (I don't think it's related to this ticket).

I started working on a `SageUnpickler` class that could work on Python 2 and 3 but it was a bit tricky, and I got sidetracked.  I'll take another shot at it though--it's certainly doable.


---

Comment by embray created at 2018-03-12 14:13:43

Replying to [comment:10 embray]:
> I think I fixed that issue, but I forget what the cause was (I don't think it's related to this ticket).

I remember now. It _is_ related to this.  On Python 3 we generally want to pass `fix_imports=False`.  This is a trick that makes pickles created on Python 3 loadable on Python 2.  Problem is, then it _isn't_ loadable on Python 3.  So at least by default we want to disable that (though we may want to accept it as an option on Python 3...)


---

Comment by embray created at 2018-03-12 14:15:33

That, or we just use the most recent pickle protocol on Python 3--if a pickle only needs to be loadable on Python 3 then there's no reason to use protocol version=2.  But maybe we should add an option on Sage's `dumps()` option to make pickles compatible with Python 2, in which case it would use `protocol=2` and `fix_imports=True`.


---

Comment by embray created at 2018-03-12 14:21:18

Also, is there a reason the pickle-related functions live in `sage.structure.sage_object`?  Although the `SageObject` class has `.dumps()` and `.loads()` methods those are just wrappers for the `dumps()` and `loads()` functions.

ISTM the pickle-specific utilities should live elsewhere.


---

Comment by embray created at 2018-04-12 15:27:27

Further work on this should probably incorporate #25153, if that ticket is accepted.


---

Comment by chapoton created at 2018-06-04 06:49:41

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-06-04 06:49:41

branch does not apply


---

Comment by chapoton created at 2018-06-20 18:25:02

Maybe this one should be given a rather high priority, no ?

I see many pickling failures in the python3 doctests.


---

Comment by embray created at 2018-06-21 12:57:02

Yes, I keep picking up work on this at like...the end of the day, getting distracted by something else, and forgetting it again.  I need to re-implement the `SageUnpickler` class to work on both Python 2 and 3, which is not hard, I just...have to do it.

Now that #25153 is closed that helps too.


---

Comment by git created at 2018-06-22 09:10:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-22 09:11:04

So far just rebased on #25153.  Going to look into refactoring `SageUnpickler` now.


---

Comment by git created at 2018-06-22 09:44:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-22 13:55:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-22 14:01:08

Ok, I reworked `SageUnpickler` so that it works on both Python 2 and 3 (most of the Python-specific differences are pushed down to a `_BaseUnpickler` class that bracketed by an `IF PY_MAJOR_VERSION == 2` statement in the Cython code).

For symmetry's sake I also added a `SagePickler` class which encapsulates the default pickling behavior we want (for now, always use pickle protocol 2, with `fix_imports=True` on Python 3).  The intent is to have the best possible pickle compatibility between Python 2 and 3.  This is hard to test though--to do so we might have to make a few sample pickles (enough to test things like import fixups and str/bytes issues but not as many as comprehensive as the old picklejar) on both Python 2 and 3 and ensure that they can be loaded.


---

Comment by embray created at 2018-06-22 14:01:08

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-25 08:45:48

doc does not build

```
docstring of sage.misc.persist.SageUnpickler:21: WARNING: Inline interpreted text or phrase reference start-string without end-string.
```


maybe because of

```
+      `pickle.Unpickler constructor.
```



---

Comment by chapoton created at 2018-06-25 08:45:48

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-06-25 09:16:48

I was afraid of that.  I need to get better about testing the doc build when I add any significant quantity of docstrings...


---

Comment by git created at 2018-06-25 09:21:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-25 10:03:42

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-06-25 10:03:42

Docs work now.


---

Comment by chapoton created at 2018-06-25 12:57:05

pyflakes plugin is not happy


---

Comment by chapoton created at 2018-06-25 14:54:58

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-25 15:43:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-06-25 15:44:00

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-26 07:19:38

Do we know if this fixes some/most/all of the python3 pickling issues ?


---

Comment by chapoton created at 2018-06-27 07:00:12

This does not fix the pickle issue with python 3, though the error changes. 
My touchstone file is `./sage -t src/sage/combinat/interval_posets.py`
and there:

```
   Failure in _test_elements
    The following tests failed: _test_elements
      Failure in _test_pickling:
      Traceback (most recent call last):
        File "sage/misc/persist.pyx", line 540, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5187)
          __import__(module)
      ModuleNotFoundError: No module named '__builtin__'
    <BLANKLINE>
      During handling of the above exception, another exception occurred:
    <BLANKLINE>
      Traceback (most recent call last):
        File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/sage_unittest.py", line 294, in run
          test_method(tester = tester)
        File "sage/structure/sage_object.pyx", line 683, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5024)
          tester.assertEqual(loads(dumps(self)), self)
        File "sage/misc/persist.pyx", line 960, in sage.misc.persist.loads (build/cythonized/sage/misc/persist.c:7648)
          return unpickler.load()
        File "sage/misc/persist.pyx", line 736, in sage.misc.persist._BaseUnpickler.find_class (build/cythonized/sage/misc/persist.c:6386)
          return unpickle_global(module, name)
        File "sage/misc/persist.pyx", line 542, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5232)
          error()
        File "sage/misc/persist.pyx", line 529, in sage.misc.persist.unpickle_global.error (build/cythonized/sage/misc/persist.c:4797)
          raise ImportError("cannot import {1} from {0}, call "
      ImportError: cannot import getattr from __builtin__, call register_unpickle_override('__builtin__', 'getattr', ...) to fix this
```



---

Comment by embray created at 2018-06-27 12:14:09

This certainly lays the groundwork to fix issues like that, but I'll have a look at whatever's going on there.

The above issue is that it's creating pickles with Python 2 backwards-compatibility (the `fix_imports=True` argument to `pickle.dumps`).  However, the reverse should also work when loading such pickles on Python 3.


---

Comment by embray created at 2018-06-27 12:27:26

Ahah, I think I see the problem.  The `fix_imports` stuff is actually implemented as the base implementation of `find_class` which we outright override.  For it to work we still need to call the base class's `find_class`.


---

Comment by git created at 2018-06-27 13:25:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-06-27 13:25:54

This should fix it.  I confirmed that `./sage -t src/sage/combinat/interval_posets.py` works (as should other tests plagued by the same problem).


---

Comment by chapoton created at 2018-06-27 19:35:08

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-06-27 19:35:08

I am ready to give it a try.


---

Comment by vbraun created at 2018-06-29 22:34:05

Resolution: fixed
