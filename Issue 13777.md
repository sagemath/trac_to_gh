# Issue 13777: Faster int -> Integer coercion for common ints

Issue created by migration from https://trac.sagemath.org/ticket/13981

Original creator: robertwb

Original creation time: 2013-01-22 05:37:43

Assignee: AlexGhitza

Defaulting to the same range as Python, namely [-1, 256].


---

Attachment


---

Comment by robertwb created at 2013-01-22 06:27:43

Changing status from new to needs_review.


---

Attachment


---

Comment by zimmerma created at 2013-01-23 08:12:14

Robert, please could you explain the rationale behind this ticket?
Also, any hint on how to review it would be welcome. Is there any standard efficiency test?

Paul


---

Comment by zimmerma created at 2013-01-23 08:12:14

Changing status from needs_review to needs_info.


---

Comment by zimmerma created at 2013-01-23 08:16:31

Robert, the first patch failed to apply to 5.5:

```
sage: hg_sage.import_patch("/tmp/13981-fast-int-ZZ.patch")
cd "/localdisk/tmp/sage-5.5/devel/sage" && sage --hg import   "/tmp/13981-fast-int-ZZ.patch"
applying /tmp/13981-fast-int-ZZ.patch
patching file sage/rings/integer.pyx
Hunk #1 FAILED at 5666
1 out of 2 hunks FAILED -- saving rejects to file sage/rings/integer.pyx.rej
abort: patch failed to apply
```

Paul


---

Comment by robertwb created at 2013-01-23 17:45:32

Ticket #12615 is a dependency, you need to apply that first. 

I can't think of any standard efficiency tests, but this is most useful when creating a large number of small Sage integers. For example, 

Before:


```
sage: sage: E = EllipticCurve('37a')             
sage: sage: v = E.anlist(10000, python_ints=True)
sage: sage: %timeit [ZZ(a) for a in v]           
25 loops, best of 3: 15.5 ms per loop
```


After:


```
sage: E = EllipticCurve('37a')             
sage: v = E.anlist(10000, python_ints=True)
sage: %timeit [ZZ(a) for a in v]           
25 loops, best of 3: 12.8 ms per loop
```


It'll be faster elsewhere, but it's mostly a tiny improvement all over the place. Startup time may also be slightly improved (despite initializing the pool). The most important is to review the code for correctness (and of course verify the tests pass).


---

Comment by zimmerma created at 2013-01-24 08:03:17

Robert, I see nothing wrong in this patch, except the description says `[-1, 256]` but the code says `[-5, 256]`. Where is the default Python range documented?

Paul


---

Comment by zimmerma created at 2013-01-24 09:23:53

all doctests pass. The only issue is that in comment [comment:5].

Paul


---

Comment by robertwb created at 2014-01-28 05:09:37

Changing status from needs_info to needs_review.


---

Comment by robertwb created at 2014-01-28 05:09:37

New commits:


---

Comment by jdemeyer created at 2014-01-28 17:15:11

I think this should be fixed also. Otherwise, I don't really see the point.

```
sage: 20 is 20
False
```



---

Comment by jdemeyer created at 2014-01-28 17:15:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-01-30 12:02:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by robertwb created at 2014-02-04 04:58:25

Changing status from needs_work to needs_review.


---

Comment by robertwb created at 2014-02-04 04:58:25

This helps for all the coercions. I did a bit of playing around with `Integer(20) is Integer(20)` and a bunch of stuff broke (probably due to people mutating `Integer(0)` for example), so let's split that off as a separate feature request. (By the time you get there you've already committed to making a new Integer..


---

Comment by mmezzarobba created at 2014-02-22 22:30:37

I fixed a typo and saved a few more cycles (I think) by changing two `cdef long`s into `DEF`s. The branch merges cleanly and all tests pass. Can you please check the changes and set the ticket to positive review (after reverting my patch if you disagree)?


---

Comment by zimmerma created at 2014-02-25 08:46:08

sorry with the change to git I don't know how to review that ticket (and no time currently to learn how to)

Paul


---

Comment by mmezzarobba created at 2014-02-25 10:02:41

New commits:


---

Comment by mmezzarobba created at 2014-02-25 10:08:42

[Hmm, there was a typo in the branch name, sorry for that.]

Replying to [comment:16 zimmerma]:
> sorry with the change to git I don't know how to review that ticket (and no time currently to learn how to)

I think all that remains to do is for someone to have a look at my patch (http://git.sagemath.org/sage.git/commit/?id=9ab4bd04dfac93d95c7b169be62a3054f2eef850).

If you want to test it:
* checkout the corresponding branch (using something like `git checkout trac/u/mmezzarobba/13981-small_int`);
* optionally, merge in the main development branch (`git merge develop`);
* rebuild sage, test;
* use `git checkout master` or `git checkout develop` to go back to the mainline when you are done.


---

Comment by robertwb created at 2014-02-25 18:09:18

Your change looks fine to me.


---

Comment by mmezzarobba created at 2014-02-25 20:33:12

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2014-02-26 08:15:29

Marc, where should I do `git checkout ...`?

```
tarte% pwd
/localdisk/tmp/sage-6.0
tarte% git checkout trac/u/mmezzarobba/13981-small_int
error: pathspec 'trac/u/mmezzarobba/13981-small_int' did not match any file(s) known to git.
```



---

Comment by rws created at 2014-02-26 08:56:22

`sage -dev checkout --ticket=13981` or within sage: `dev.checkout(ticket='13981')`


---

Comment by zimmerma created at 2014-02-26 09:02:59

many thanks!

Paul


---

Comment by zimmerma created at 2014-02-26 09:06:52

I confirm the speedup on my machine.

Vanilla 6.0:

```
sage: sage: E = EllipticCurve('37a')    
sage: v = E.anlist(10000, python_ints=True)
sage: %timeit [ZZ(a) for a in v]       
100 loops, best of 3: 15.3 ms per loop
```


With the patch applied:

```
sage: sage: E = EllipticCurve('37a')    
sage: v = E.anlist(10000, python_ints=True)
sage: %timeit [ZZ(a) for a in v]       
100 loops, best of 3: 13.2 ms per loop
```

Paul


---

Comment by vbraun created at 2014-03-02 16:15:22

Resolution: fixed
