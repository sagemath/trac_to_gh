# Issue 33026: Add github action running on each push

Issue created by migration from https://trac.sagemath.org/ticket/33263

Original creator: @tobiasdiez

Original creation time: 2022-01-31 20:24:42

CC:  mkoeppe chapoton

Add a github action that runs on each push. Since it uses the most recent docker image as the base, the runtime is relatively short with about 2h. The idea is to get quick feedback on PRs without the need to wait until the patchbot picks it up. After this ticket is merged, we can add a badge in the ticket similar to the linter workflow.

Example run: https://github.com/tobiasdiez/sage/actions/runs/1773704682
(it works but one doctest and the pytests are failing; I think there are already tickets for these issues)


---

Comment by @tobiasdiez created at 2022-01-31 20:25:56

Changing status from new to needs_review.


---

Comment by git created at 2022-01-31 20:26:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-31 22:13:27

Why not just `configure --prefix=/sage/local`?


---

Comment by mkoeppe created at 2022-01-31 22:15:22

Which jobs does it cancel?


---

Comment by mkoeppe created at 2022-01-31 22:18:13

You may want to use #33233


---

Comment by mkoeppe created at 2022-01-31 22:32:43

Replying to [comment:4 mkoeppe]:
> Which jobs does it cancel?
Also perhaps the new built-in `concurrency` stuff can be used? https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#concurrency


---

Comment by git created at 2022-02-01 13:29:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-01 13:31:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-01 13:32:50

Thanks for the feedback. I've now used `--prefix` and `concurrency` (to cancel previous runs of the same workflow for the same branch).


---

Comment by @tobiasdiez created at 2022-02-01 13:33:31

Replying to [comment:5 mkoeppe]:
> You may want to use #33233

The idea is that this workflow never fails (otherwise the branch is not merged). Thus the base line is "always green".


---

Comment by @tobiasdiez created at 2022-02-01 13:42:33

Replying to [comment:3 mkoeppe]:
> Why not just `configure --prefix=/sage/local`?

But now it seems to rebuild all python packages instead of using them from the docker image as before. Is this a bug in prefix or did I use it wrong?


---

Comment by mkoeppe created at 2022-02-01 15:44:41

Sorry, it should be `configure --prefix=/sage/local --with-sage-venv`


---

Comment by mkoeppe created at 2022-02-01 15:45:48

Replying to [comment:10 gh-tobiasdiez]:
> Replying to [comment:5 mkoeppe]:
> > You may want to use #33233
> 
> The idea is that this workflow never fails (otherwise the branch is not merged). Thus the base line is "always green".

The patchbot makes the same optimistic assumption, which is why it's broken so often...


---

Comment by git created at 2022-02-01 15:51:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-01 16:39:58

Replying to [comment:13 mkoeppe]:
> Sorry, it should be `configure --prefix=/sage/local --with-sage-venv`

Thanks, that worked well!


---

Comment by mkoeppe created at 2022-02-01 20:32:21

Another idea, for a much faster build, would be to just work out of `/sage`, merging the current commit.


---

Comment by @tobiasdiez created at 2022-02-02 09:30:46

I think with a bit more than 1.5h runtime, it is already reasonably fast. The actual build also only takes about 35mins, the rest is spent on the tests. Further optimization in my opinion will be a trade-off between time savings and reduced reliability, because you then have to think about invalidation of the cythonize cache etc. The point of this ticket is to pursue a different approach than the patchbot and really start from a clean state. I would propose to first gain experience with this, before we implement more fancy caching mechanisms (and in this case I would also prefer github actions builtin cache mechanism).


---

Comment by mkoeppe created at 2022-02-02 18:10:46

Sure, sounds good.


---

Comment by mkoeppe created at 2022-02-02 18:21:15

However I think it should only be run for branches on tickets set to `needs_review`. 
After making `git-trac` available (see #33222), you can use something like `git trac search --branch u/mkoeppe/upgrade_giac_to_1_7_0`
and `git trac print 33263 | grep '^Status: needs_review'` for this


---

Comment by mkoeppe created at 2022-02-02 18:22:26

Hm... no, people set "needs_review" after a push, not before


---

Comment by mkoeppe created at 2022-02-02 18:33:58

OK, let's just merge it and try it out. I'd suggest to set #33103 as a dependency and already put `dev` instead of `9.5` as image tag


---

Comment by git created at 2022-02-03 10:53:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-03 10:56:18

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-02-03 10:56:18

Replying to [comment:22 mkoeppe]:
> OK, let's just merge it and try it out. I'd suggest to set #33103 as a dependency and already put `dev` instead of `9.5` as image tag

Thanks for the review. It now uses `dev` and I set the ticket to positive review now (please intervene if I misunderstood you).


---

Comment by @tobiasdiez created at 2022-02-14 20:23:33

Increasing priority as the badge is already added to the trac ticket (so that I don't have to login in the VM and change the config multiple times).


---

Comment by @tobiasdiez created at 2022-02-14 20:23:33

Changing priority from major to critical.


---

Comment by vbraun created at 2022-02-16 23:57:16

Resolution: fixed
