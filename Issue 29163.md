# Issue 29163: Cotangent producing incorrect real/imaginary parts.

archive/issues_029163.json:
```json
{
    "body": "Keywords: defect cotangent complex\n\nWhile doing some complex analysis, I encountered a bug when evaluating the cotangent function of a complex number when multiplied by a complex number.  When p and q are complex, real(p*cot(q)) or imag(p*cot(q)) produces a wrong result, while real(p/tan(q)) or imag(p/tan(q)) produces the correct result.\n\nFor example:\n\n\n```\nsage: a=(1+2*i)/tan(3+4*i)                                                                                                                                                                                 \nsage: b=(1+2*i)*cot(3+4*i)\nsage: a.real().n()                                                                                                                                                                                         \n2.00110119720514\nsage: b.real().n()                                                                                                                                                                                         \n-2.00147637268110\nsage: a.imag().n()                                                                                                                                                                                         \n-1.00101956794753\nsage: b.imag().n()                                                                                                                                                                                         \n1.00026921699559\n```\n\n\nAdditionally, when trying to numerically evaluate b with cotangent, it simply returns an error.  The numerical evaluation of a with tangent is returned without error.\n\n\n```\nsage: a.n()                                                                                                                                                                                                \n2.00110119720513 - 1.00101956794753*I\nsage: b.n()                                                                                                                                                                                                \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-97-d3276c847f4d> in <module>\n----> 1 b.n()\n\n/usr/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8033)()\n    857             0.666666666666667\n    858         \"\"\"\n--> 859         return self.numerical_approx(prec, digits, algorithm)\n    860 \n    861     def _mpmath_(self, prec=53, rounding=None):\n\n/usr/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:34713)()\n   5998             res = x.pyobject()\n   5999         else:\n-> 6000             raise TypeError(\"cannot evaluate symbolic expression numerically\")\n   6001 \n   6002         # Important -- the  we get might not be a valid output for numerical_approx in\n\nTypeError: cannot evaluate symbolic expression numerically\n```\n\n\nI conducted this same test using both tangent and cotangent in Maxima.  They are both correct, and agree with the results involving tangent in Sage.  But for whatever reason in Sage, cotangent does not seem to work correctly when evaluating numerically or getting the real/imaginary part.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29400\n\n",
    "created_at": "2020-03-24T16:02:42Z",
    "labels": [
        "numerical",
        "minor",
        "bug"
    ],
    "title": "Cotangent producing incorrect real/imaginary parts.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29163",
    "user": "@TheFool5"
}
```
Keywords: defect cotangent complex

While doing some complex analysis, I encountered a bug when evaluating the cotangent function of a complex number when multiplied by a complex number.  When p and q are complex, real(p*cot(q)) or imag(p*cot(q)) produces a wrong result, while real(p/tan(q)) or imag(p/tan(q)) produces the correct result.

For example:


```
sage: a=(1+2*i)/tan(3+4*i)                                                                                                                                                                                 
sage: b=(1+2*i)*cot(3+4*i)
sage: a.real().n()                                                                                                                                                                                         
2.00110119720514
sage: b.real().n()                                                                                                                                                                                         
-2.00147637268110
sage: a.imag().n()                                                                                                                                                                                         
-1.00101956794753
sage: b.imag().n()                                                                                                                                                                                         
1.00026921699559
```


Additionally, when trying to numerically evaluate b with cotangent, it simply returns an error.  The numerical evaluation of a with tangent is returned without error.


```
sage: a.n()                                                                                                                                                                                                
2.00110119720513 - 1.00101956794753*I
sage: b.n()                                                                                                                                                                                                
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-97-d3276c847f4d> in <module>
----> 1 b.n()

/usr/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.n (build/cythonized/sage/structure/element.c:8033)()
    857             0.666666666666667
    858         """
--> 859         return self.numerical_approx(prec, digits, algorithm)
    860 
    861     def _mpmath_(self, prec=53, rounding=None):

/usr/lib/python3.8/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.numerical_approx (build/cythonized/sage/symbolic/expression.cpp:34713)()
   5998             res = x.pyobject()
   5999         else:
-> 6000             raise TypeError("cannot evaluate symbolic expression numerically")
   6001 
   6002         # Important -- the  we get might not be a valid output for numerical_approx in

TypeError: cannot evaluate symbolic expression numerically
```


I conducted this same test using both tangent and cotangent in Maxima.  They are both correct, and agree with the results involving tangent in Sage.  But for whatever reason in Sage, cotangent does not seem to work correctly when evaluating numerically or getting the real/imaginary part.

Issue created by migration from https://trac.sagemath.org/ticket/29400





---

archive/issue_comments_412886.json:
```json
{
    "body": "Changing component from numerical to symbolics.",
    "created_at": "2020-03-25T06:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412886",
    "user": "@TheFool5"
}
```

Changing component from numerical to symbolics.



---

archive/issue_comments_412887.json:
```json
{
    "body": "After further symbolic testing, I was able to show that getting the real or imaginary part contains a sign error when using cotangent.\n\n\n```\nsage: var('a b c d')                                                                                                                                                                                                                         \n(a, b, c, d)\nsage: assume(a,'real')\nsage: assume(b,'real')                                                                                                                                                                                                                       \nsage: assume(c,'real')                                                                                                                                                                                                                       \nsage: assume(b,'real')                                                                                                                                                                                                                       \nsage: x=(a+b*i)/tan(c+d*i)                                                                                                                                                                                                                   \nsage: y=(a+b*i)*cot(c+d*i)                                                                                                                                                                                                                   \nsage: x.real().trig_reduce().simplify_full()                                                                                                                                                                                                 \n(a*cos(c)*sin(c) + b*cosh(d)*sinh(d))/(cosh(d)^2 + sin(c)^2 - 1)\nsage: y.real().trig_reduce().simplify_full()                                                                                                                                                                                                 \n(a*cos(c)*sin(c) - b*cosh(d)*sinh(d))/(sin(c)^2 + sinh(d)^2)\n```\n\n\nThe numerator of y clearly has a sign error, so the formula being used to get the real part is incorrect when using cotangent.  The denominators are equivalent because cosh<sup>2</sup>(d)-1=sinh<sup>2</sup>(d).  A similar sign error is present when taking the imaginary part.\n\n\n```\nsage: x.imag().trig_reduce().simplify_full()                                                                                                                                                                                                 \n(b*cos(c)*sin(c) - a*cosh(d)*sinh(d))/(cosh(d)^2 + sin(c)^2 - 1)\nsage: y.imag().trig_reduce().simplify_full()                                                                                                                                                                                                 \n(b*cos(c)*sin(c) + a*cosh(d)*sinh(d))/(sin(c)^2 + sinh(d)^2)\n```\n",
    "created_at": "2020-03-25T06:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412887",
    "user": "@TheFool5"
}
```

After further symbolic testing, I was able to show that getting the real or imaginary part contains a sign error when using cotangent.


```
sage: var('a b c d')                                                                                                                                                                                                                         
(a, b, c, d)
sage: assume(a,'real')
sage: assume(b,'real')                                                                                                                                                                                                                       
sage: assume(c,'real')                                                                                                                                                                                                                       
sage: assume(b,'real')                                                                                                                                                                                                                       
sage: x=(a+b*i)/tan(c+d*i)                                                                                                                                                                                                                   
sage: y=(a+b*i)*cot(c+d*i)                                                                                                                                                                                                                   
sage: x.real().trig_reduce().simplify_full()                                                                                                                                                                                                 
(a*cos(c)*sin(c) + b*cosh(d)*sinh(d))/(cosh(d)^2 + sin(c)^2 - 1)
sage: y.real().trig_reduce().simplify_full()                                                                                                                                                                                                 
(a*cos(c)*sin(c) - b*cosh(d)*sinh(d))/(sin(c)^2 + sinh(d)^2)
```


The numerator of y clearly has a sign error, so the formula being used to get the real part is incorrect when using cotangent.  The denominators are equivalent because cosh<sup>2</sup>(d)-1=sinh<sup>2</sup>(d).  A similar sign error is present when taking the imaginary part.


```
sage: x.imag().trig_reduce().simplify_full()                                                                                                                                                                                                 
(b*cos(c)*sin(c) - a*cosh(d)*sinh(d))/(cosh(d)^2 + sin(c)^2 - 1)
sage: y.imag().trig_reduce().simplify_full()                                                                                                                                                                                                 
(b*cos(c)*sin(c) + a*cosh(d)*sinh(d))/(sin(c)^2 + sinh(d)^2)
```




---

archive/issue_comments_412888.json:
```json
{
    "body": "Thanks for pointing out the bugs, and for your further comments.\n\nI think these are two different issues, so I have opened a new ticket (#29409) to discuss the `TypeError` caused by `b.n()`, which I think it is easy to fix. \n\nThis ticket can focus on fixing the erroneous results that are described in the title. I have no idea what is wrong, but I did notice that there is no need for `a` and `b` in your example: the sign error already arises in the imaginary part of `cot(c + d*I)`.\n\n```\nsage: var('c d')\n(c, d)\nsage: assume(c,'real')\nsage: assume(d,'real')\nsage: cot(c + d*I).imag().trig_reduce().simplify_full()\ncosh(d)*sinh(d)/(sin(c)^2 + sinh(d)^2)\nsage: (1/tan(c + d*I)).imag().trig_reduce().simplify_full()\n-cosh(d)*sinh(d)/(cosh(d)^2 + sin(c)^2 - 1)\n```\n\nThere does not seem to be a sign error if we use a complex variable, instead of writing out `c + d*I`:\n\n```\nsage: var('z')\nz\nsage: cot(z*I).imag()\n-cosh(real_part(z))*sinh(real_part(z))/(sin(imag_part(z))^2 + sinh(real_part(z))^2)\n```\n",
    "created_at": "2020-03-26T05:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412888",
    "user": "@DaveWitteMorris"
}
```

Thanks for pointing out the bugs, and for your further comments.

I think these are two different issues, so I have opened a new ticket (#29409) to discuss the `TypeError` caused by `b.n()`, which I think it is easy to fix. 

This ticket can focus on fixing the erroneous results that are described in the title. I have no idea what is wrong, but I did notice that there is no need for `a` and `b` in your example: the sign error already arises in the imaginary part of `cot(c + d*I)`.

```
sage: var('c d')
(c, d)
sage: assume(c,'real')
sage: assume(d,'real')
sage: cot(c + d*I).imag().trig_reduce().simplify_full()
cosh(d)*sinh(d)/(sin(c)^2 + sinh(d)^2)
sage: (1/tan(c + d*I)).imag().trig_reduce().simplify_full()
-cosh(d)*sinh(d)/(cosh(d)^2 + sin(c)^2 - 1)
```

There does not seem to be a sign error if we use a complex variable, instead of writing out `c + d*I`:

```
sage: var('z')
z
sage: cot(z*I).imag()
-cosh(real_part(z))*sinh(real_part(z))/(sin(imag_part(z))^2 + sinh(real_part(z))^2)
```




---

archive/issue_comments_412889.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412889",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_412890.json:
```json
{
    "body": "Attachment [cot_as_real_imag.patch](tarball://root/attachments/some-uuid/ticket29400/cot_as_real_imag.patch) by @DaveWitteMorris created at 2020-05-19 06:47:16\n\ncorrect sign error in imaginary part of cotangent",
    "created_at": "2020-05-19T06:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412890",
    "user": "@DaveWitteMorris"
}
```

Attachment [cot_as_real_imag.patch](tarball://root/attachments/some-uuid/ticket29400/cot_as_real_imag.patch) by @DaveWitteMorris created at 2020-05-19 06:47:16

correct sign error in imaginary part of cotangent



---

archive/issue_comments_412891.json:
```json
{
    "body": "Changing keywords from \"defect cotangent complex\" to \"defect cotangent  sympy\".",
    "created_at": "2020-05-19T06:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412891",
    "user": "@DaveWitteMorris"
}
```

Changing keywords from "defect cotangent complex" to "defect cotangent  sympy".



---

archive/issue_comments_412892.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2020-05-19T06:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412892",
    "user": "@DaveWitteMorris"
}
```

Changing priority from minor to major.



---

archive/issue_comments_412893.json:
```json
{
    "body": "This is a sympy bug, so I reported it upstream ([#19366](https://github.com/sympy/sympy/issues/19366)). The imaginary part of the `as_real_imag` method of sympy's cotangent class (`sympy.functions.elementary.trigonometric.cot`) has the wrong sign.\n\n```\n1453      def as_real_imag(self, deep=True, **hints):\n1454          re, im = self._as_real_imag(deep=deep, **hints)\n1455          if im:\n1456              denom = cos(2*re) - cosh(2*im)\n1457 -            return (-sin(2*re)/denom, -sinh(2*im)/denom)\n1457 +            return (-sin(2*re)/denom, sinh(2*im)/denom)\n1458          else:\n1459              return (self.func(re), S.Zero)\n```\n",
    "created_at": "2020-05-19T06:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412893",
    "user": "@DaveWitteMorris"
}
```

This is a sympy bug, so I reported it upstream ([#19366](https://github.com/sympy/sympy/issues/19366)). The imaginary part of the `as_real_imag` method of sympy's cotangent class (`sympy.functions.elementary.trigonometric.cot`) has the wrong sign.

```
1453      def as_real_imag(self, deep=True, **hints):
1454          re, im = self._as_real_imag(deep=deep, **hints)
1455          if im:
1456              denom = cos(2*re) - cosh(2*im)
1457 -            return (-sin(2*re)/denom, -sinh(2*im)/denom)
1457 +            return (-sin(2*re)/denom, sinh(2*im)/denom)
1458          else:
1459              return (self.func(re), S.Zero)
```




---

archive/issue_comments_412894.json:
```json
{
    "body": "This is fixed in [sympy pull request 19468](https://github.com/sympy/sympy/pull/19468). I hope this will be merged in sympy 1.7.",
    "created_at": "2020-05-31T17:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412894",
    "user": "@DaveWitteMorris"
}
```

This is fixed in [sympy pull request 19468](https://github.com/sympy/sympy/pull/19468). I hope this will be merged in sympy 1.7.



---

archive/issue_comments_412895.json:
```json
{
    "body": "The pull request has been merged into sympy master.",
    "created_at": "2020-06-03T00:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412895",
    "user": "@DaveWitteMorris"
}
```

The pull request has been merged into sympy master.



---

archive/issue_comments_412896.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-06-03T00:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412896",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_412897.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412897",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_412898.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412898",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_412899.json:
```json
{
    "body": "Testing in `CoCalc` shows that this was already fixed in 9.3 (presumably because Sympy was updated to 1.7 in #30985).\n\n```\nsage: a=(1+2*i)/tan(3+4*i)\nsage: b=(1+2*i)*cot(3+4*i)\nsage: a.real().n() - b.real().n()\n4.44089209850063e-16\n```\n\nSo we just need a doctest.",
    "created_at": "2021-10-08T05:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412899",
    "user": "@DaveWitteMorris"
}
```

Testing in `CoCalc` shows that this was already fixed in 9.3 (presumably because Sympy was updated to 1.7 in #30985).

```
sage: a=(1+2*i)/tan(3+4*i)
sage: b=(1+2*i)*cot(3+4*i)
sage: a.real().n() - b.real().n()
4.44089209850063e-16
```

So we just need a doctest.



---

archive/issue_comments_412900.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-10-08T05:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412900",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_412901.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-09T17:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412901",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_412902.json:
```json
{
    "body": "The PR just adds a doctest to verify that `cot(1 + i).imag().n()` is equal to `(1/tan(1 + i)).imag().n()` (modulo to an error tolerance of `10^-12`). It fails in 9.2:\n\n```\nsage: cot(1 + i).imag().n() - (1/tan(1 + i)).imag().n()\n1.73602828579185\n```\n\nBut it passes in 9.3:\n\n```\nsage: cot(1 + i).imag().n() - (1/tan(1 + i)).imag().n()\n-1.11022302462516e-16\n```\n\n----\nNew commits:",
    "created_at": "2021-10-09T17:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412902",
    "user": "@DaveWitteMorris"
}
```

The PR just adds a doctest to verify that `cot(1 + i).imag().n()` is equal to `(1/tan(1 + i)).imag().n()` (modulo to an error tolerance of `10^-12`). It fails in 9.2:

```
sage: cot(1 + i).imag().n() - (1/tan(1 + i)).imag().n()
1.73602828579185
```

But it passes in 9.3:

```
sage: cot(1 + i).imag().n() - (1/tan(1 + i)).imag().n()
-1.11022302462516e-16
```

----
New commits:



---

archive/issue_comments_412903.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-10T04:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412903",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_412904.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-10-10T05:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412904",
    "user": "@DaveWitteMorris"
}
```

Thanks!



---

archive/issue_comments_412905.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-10T22:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29163#issuecomment-412905",
    "user": "vbraun"
}
```

Resolution: fixed
