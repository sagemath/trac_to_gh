# Issue 32976: Avoid SAGE_TMP for truly transient files and directories

Issue created by migration from https://trac.sagemath.org/ticket/33213

Original creator: mjo

Original creation time: 2022-01-22 03:02:39

CC:  slelievre tscrim fbissey

In many cases, we use `tmp_dir()`, `tmp_filename()` and `SAGE_TMP` where the standard python library functions would be more appropriate. Picking a doctest at random,


```
sage: q = Tachyon()                                                                                                                                              
sage: q.light((1,1,11), 1,(1,1,1))                                                                                                                               
sage: q.texture('s')                                                                                                                                             
sage: q.sphere((0,-1,1),1,'s')                                                                                                                                   
sage: tempname = tmp_filename()                                                                                                                                  
sage: q.save_image(tempname)
```


would be much better off with the last two lines,


```
sage: with tempfile.NamedTemporaryFile() as f:
....:     q.save_image(f.name)
```


That's simpler, cleans up the file immediately, and uses the OS's temporary storage rather than the user's home directory. The last bit can make a big difference when (for example) `/tmp` is mounted in RAM to minimize accesses to a slow disk.

Not important, just something to kill time on a rainy day.


---

Comment by mjo created at 2022-02-15 15:17:17

I've posted a work-in-progress branch that raises a question. The python docs,

  https://docs.python.org/3/library/tempfile.html

state that, in regards to a named temporary file,

> Whether the name can be used to open the file a second time, while the named temporary
> file is still open, varies across platforms (it can be so used on Unix; it cannot on
> Windows NT or later)

So in many cases, where I would have liked to have done


```
sage: with tempfile.NamedTemporaryFile() as f:
....:     q.save_image(f.name)
```


I have instead done something like


```
sage: f = tempfile.NamedTemporaryFile(delete=False); f.close()
sage: q.save_image(f.name)
sage: os.remove(f.name)
```


or


```
sage: with tempfile.TemporaryDirectory() as d:
....:     filename = os.path.join(d, "foo.png") 
....:     q.save_image(filename)
```


to avoid the `save_image` call reopening the same name. However, the docs are unclear about what "on Windows" means. So the two examples above can be simplified if this is not a problem on cygwin.
----
Last 10 new commits:


---

Comment by git created at 2022-02-17 11:53:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-18 00:26:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-02-18 00:31:02

Making #8784 a dependency because we can avoid many contortions on this branch if we don't have to keep sage-cleaner aware of where the `spawned_processes` file lives.


---

Comment by was created at 2022-02-18 00:37:29

How did you solve the problems that sage-cleaner solves?  It's not like I wrote it for no reason.  There are many situations in practice that people hit where temp files and subprocess get left around.  Make sure that at least the following works:

1. Start sage.  Do something that creates a temp file and also something that spawns a subprocess.
2. Segfault the sage that you started, e.g., by doing something stupid with Cython.

What happens?  Are all temp files and spawned processes properly cleaned up?

It's an unfortunate reality that we make Cython relatively easy to use, hence it's easy from the command line or notebook to segfault a running Sage process.

Just curious.  I never liked or wanted to write sage-cleaner, but I couldn't think of any better approach to make end users happy.


---

Comment by mjo created at 2022-02-18 01:33:50

Replying to [comment:5 was]:
> How did you solve the problems that sage-cleaner solves?  It's not like I wrote it for no reason.  There are many situations in practice that people hit where temp files and subprocess get left around.  Make sure that at least the following works:
> 
> 1. Start sage.  Do something that creates a temp file and also something that spawns a subprocess.
> 2. Segfault the sage that you started, e.g., by doing something stupid with Cython.
> 
> What happens?  Are all temp files and spawned processes properly cleaned up?

1. Now that all temporary files are created in `/tmp` or equivalent, they'll be cleaned up by the system eventually. In the event of a crash, I would say that this is preferable, because those temporary files can contain important debugging information.

2. Sage doesn't segfault. More seriously, it depends on the process. In the simplest case, the subprocess will continue doing whatever it's doing until it completes, and will then terminate. Next would be subprocesses that communicate with the parent; eventually they'll be sent a SIGPIPE and commit suicide. If you go out of your way to launch something that is basically a daemon, though, it can indeed outlive the parent.

For (2) to be an issue, you have to launch a standalone process that never terminates, detach it from the parent, compile a C extension, load the extension into your current session, and then cause it to segfault. I don't think cleaning up after that situation should be the responsibility of _any_ application; but especially not of a computer algebra system.

If you intend to do something like that frequently (or host a service for users who will...), there are better solutions these days -- cgroups on linux being the best example. Keeping in mind that sage-cleaner works by parsing a `spawned_processes` file that must be updated every time a process is launched, solving the problem at the OS level in particular has the advantage that it will catch sub-subprocesses. Sage-cleaner generally cannot (unless the subprocess is also sage), because the subprocess doesn't know that it's supposed to add a line item to `spawned_processes`.


---

Comment by mjo created at 2022-02-18 01:53:10

I should also point out that it's not critical that we remove sage-cleaner at this point. The main hurdle wrt the removal of `SAGE_TMP` is that sage-cleaner and the sage library (`register_spawned_process()`) need to agree on a location for the spawned processes file. The current branch uses a temporary file in the library that lives for the duration of the sage session, and that's of no use to sage-cleaner due to the random name. We could still store the spawned processes file with a fixed name in `DOT_SAGE`, though, probably with the current sage PID tacked onto the path somewhere.

I saw this as a good time to remove it because its one _crucial_ job -- to clean up `SAGE_TMP` under `$HOME` -- is now obsolete.


---

Comment by git created at 2022-02-18 04:08:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2022-02-18 04:11:17

Changing status from new to needs_review.


---

Comment by mjo created at 2022-02-18 04:11:17

I believe I've fixed all of the test failures so I'm setting this to `needs_review` to see what the patchbots think.


---

Comment by dimpase created at 2022-02-18 12:23:33

testing on https://github.com/sagemath/sagetrac-mirror/actions/runs/1864348438


---

Comment by was created at 2022-02-18 14:39:34

Thanks `@`mjo for your explanation.   Your responses don't necessarily apply in the context of users that got me to write the sage-cleaner in the first place, and they will probably be pretty annoyed if they ever realize what happened.  Sage is different than some more less complicated computer algebra software like Magma, because Sage much more frequently spawns subprocesses.  Fortunately, over the years the number of subprocesses Sage spawns has been reduced due to writing and using C library interfaces instead of pexpect, etc.

Regarding /tmp, unless you specifically set something up to periodically clean up files, unless things have changed a lot, don't most Linux distros *not* automatically delete files from there, possibly until a reboot?  You're making a huge change from "temp files get cleaned up by Sage itself quickly" to "maybe someday the system will clean them up".  Maybe at this point that is the right change, but it's important to acknowledge that it is a significant change.

I agree that when users are using Linux, have sufficient privileges to use containers, and also actually know how to use them, then these same problems can be solved in a more robust way.   However, this is a small percentage of users of Sage.  Many users use other operating systems or don't have admin permissions.

CoCalc is the main platform for running Sage that I care about these days, and every individual "project" is its own container, /tmp is extremely ephemeral, etc., so everything you say applies there.  That said, users of CoCalc can't use Docker or other container mechanisms themselves within projects, due to security constraints.  

In any case, I'm not personally worried about these changes having any adverse impact for me.    However, I'm leaving this comment here so people who are impacted can maybe know they may have to revert these patches for their own install of Sage.  Probably the way things will go is that this gets merged, and a year later certain environments start finding that Sage is leaving around clutter in a way that Sage didn't for the last decade, but users don't know why.   Hopefully they google and find this comment.


---

Comment by mjo created at 2022-02-18 15:35:13

Replying to [comment:11 was]:
> 
> Regarding /tmp, unless you specifically set something up to periodically clean up files, unless things have changed a lot, don't most Linux distros *not* automatically delete files from there, possibly until a reboot?  You're making a huge change from "temp files get cleaned up by Sage itself quickly" to "maybe someday the system will clean them up".  Maybe at this point that is the right change, but it's important to acknowledge that it is a significant change.... Probably the way things will go is that this gets merged, and a year later certain environments start finding that Sage is leaving around clutter in a way that Sage didn't for the last decade, but users don't know why. Hopefully they google and find this comment. 

Systemd comes with a timer (like a cron job) to clean up `/tmp`, but I'm not familiar with its out-of-the-box configuration on mainstream distros. I still use OpenRC myself, where a reboot is what triggers it.

On systems like mine, "leftover junk" is a fair criticism, but keep in mind the bigger picture: the python `tempfile.TemporaryDirectory()` and `tempfile.NamedTemporaryFile()` functions _automatically remove the file/directory as soon as it's done being used._  In this branch, I've changed a bunch of manual `SAGE_TMP` code to use those two functions, so a lot of what would have been leftover junk is now simply not created in the first place. Any remaining junk is due to sage's own `tmp_filename()` and `tmp_dir()`, which expect you to clean up the file yourself, or assume that sage-cleaner will do it eventually.

If this gets merged, we can deprecate `tmp_filename()` and `tmp_dir()` as obsolete in favor of the python functions. Over a hopefully-short amount of time, that should eliminate the leftover junk at the source.


---

Comment by dimpase created at 2022-02-18 15:39:00

indeed, I am not at all worried about junk left at `/tmp`, as, at least as far as documentation of Python is correct, the facility of  [NamedTemporaryFile](https://docs.python.org/3/library/tempfile.html#tempfile.NamedTemporaryFile) cleans up after itself automatically (I guess it uses POSIX's `tmpfile(3)` behind the scene).

I am a bit puzzled by the need to manually keep them open using `delete=False` the call to `NamedTemporaryFile`.  Is it because one wants to keep them for the duration of a Sage session?


---

Comment by mjo created at 2022-02-18 15:40:57

Replying to [comment:13 dimpase]:
> 
> I am a bit puzzled by the need to manually keep them open using `delete=False` the call to `NamedTemporaryFile`.  Is it because one wants to keep them for the duration of a Sage session?

If you're referring to my new code (in many doctests), then this is simply a precaution for cygwin (see comment:1). I would love to simplify it if someone with a cygwin installation says that the "on Windows" warning doesn't apply there.


---

Comment by mjo created at 2022-02-18 15:44:09

Replying to [comment:14 mjo]:
>
> If you're referring to my new code (in many doctests), then this is simply a precaution for cygwin (see comment:1). I would love to simplify it if someone with a cygwin installation says that the "on Windows" warning doesn't apply there.

(If it DOES apply on cygwin, we could improve this in the future by updating the functions that now take a filename to also accept an open file handle; that will avoid re-`open()`ing it.)


---

Comment by dimpase created at 2022-02-18 15:45:10

Cygwin is POSIX emulator, so `on Windows` doesn't really apply to it.


---

Comment by mjo created at 2022-02-18 15:48:17

Replying to [comment:16 dimpase]:
> Cygwin is POSIX emulator, so `on Windows` doesn't really apply to it.

You have two wishes remaining =)

I'm "happy" to go back and change all of those doctests, but I'd like confirmation before I spend half a day doing it.


---

Comment by dimpase created at 2022-02-18 16:03:22

Perhaps slelievre can test this on Cygwin - if you specify in some detail what to look for.


---

Comment by mjo created at 2022-02-18 16:09:07

Replying to [comment:18 dimpase]:
> Perhaps slelievre can test this on Cygwin - if you specify in some detail what to look for.

We just need to know if this works,


```
sage: import tempfile
sage: p = plot(sin(x), x, (-pi, pi))
sage: with tempfile.NamedTemporaryFile(suffix=".png") as f:
....:     p.save(filename=f.name)
....: 
```


or if the fact that `save()` reopens the (already open) file causes problem.


---

Comment by git created at 2022-02-18 16:18:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2022-02-18 16:20:20

That last commit should avoid most leftover junk in the meantime, too. It's easy so why not.


---

Comment by dimpase created at 2022-02-18 16:47:45

`@`was - this ticket, and its dependency #8784, are also to properly fix #33027


---

Comment by was created at 2022-02-18 16:50:35

Hi everybody - thanks for the comments. **I just want to be clear that I am in no way suggesting blocking this ticket moving forward with a positive review.**  I just want to record my misgivings here, so they may be helpful for anybody that might hit problems as a result.  I'm not a fan of this stupid sage-cleaner hack that I wrote long ago, and I'm happy to see it get deleted.


---

Comment by mkoeppe created at 2022-02-18 19:27:02

The changes to using `TemporaryDirectory` in doctests are easy to review and are definitely a great improvement that we should merge as soon as possible.

However, I would suggest to split this ticket, so that the wholesale removal of the cleaner is in its own ticket. In particular, user code may continue to use `SAGE_TMP`, as this was the advertised interface since the beginning of time. So we need a transition period here. Perhaps a deprecation warning that the cleaner issues when it actually finds something to clean.


---

Comment by mjo created at 2022-02-18 23:47:27

Replying to [comment:24 mkoeppe]:
> The changes to using `TemporaryDirectory` in doctests are easy to review and are definitely a great improvement that we should merge as soon as possible.
> 
> However, I would suggest to split this ticket, so that the wholesale removal of the cleaner is in its own ticket. In particular, user code may continue to use `SAGE_TMP`, as this was the advertised interface since the beginning of time. So we need a transition period here. Perhaps a deprecation warning that the cleaner issues when it actually finds something to clean.

To my surprise, `SAGE_TMP` was actually undocumented. It's not in the reference manual or the developer guide, and it had no docstring. But you're probably right that a few sage developers managed to use it in their own code.

If we want to raise a deprecation warning for it, I can do so in a way that doesn't affect the rest of this ticket by changing `SAGE_TMP` to return a `tempfile.TemporaryDirectory()` instead of the old `DOT_SAGE` value. Then its use won't create anything that would require sage-cleaner to remove.


---

Comment by mkoeppe created at 2022-02-18 23:54:37

I'm still -1 on removing the `sage-cleaner` here on the same ticket. 

In particular I don't think the explanation why the process-killing part of it should suddenly no longer be necessary is very convincing. Let's please not introduce big changes like this without a proper transition plan.


---

Comment by mjo created at 2022-02-19 00:04:19

Replying to [comment:26 mkoeppe]:
> I'm still -1 on removing the `sage-cleaner` here on the same ticket. 
> 
> In particular I don't think the explanation why the process-killing part of it should suddenly no longer be necessary is very convincing. 

That's mainly because of #8784.


---

Comment by mkoeppe created at 2022-02-19 00:08:56

Let's confirm this in practice please by doing the deprecation warnings whenever the cleaner kills or deletes something.


---

Comment by mjo created at 2022-02-19 00:31:29

Replying to [comment:28 mkoeppe]:
> Let's confirm this in practice please by doing the deprecation warnings whenever the cleaner kills or deletes something.

It doesn't really delete anything except the files created specifically for the benefit of sage-cleaner, and some legacy paths whose locations were changed in the `fix_old_mistakes()` funtion.

I'm not strongly opposed to leaving sage-cleaner alone, but a deprecation warning on killed processes is going to produce false positives on every process that would have terminated nicely but was killed prematurely by sage-cleaner, i.e. most of them.


---

Comment by dimpase created at 2022-02-19 01:05:13

Perhaps it would be interesting to know whether after the changes (but keeping the cleaner in) the cleaner would still have anything to kill.
(my understanding it starts after Sage terminates, so most likely it won't have to do anything)


---

Comment by mkoeppe created at 2022-02-19 01:08:52

Replying to [comment:29 mjo]:
> Replying to [comment:28 mkoeppe]:
> > whenever the cleaner [...] deletes something.
> 
> It doesn't really delete anything except the files created specifically for the benefit of sage-cleaner

You are right, thanks.


---

Comment by slelievre created at 2022-02-19 11:24:53

Replying to [comment:18 dimpase]:
> Perhaps slelievre can test this on Cygwin

My attempts to build 9.5 beta and rc
releases fail on `sagemath_doc_html`.

My attempts to build the 9.6 beta releases
fail earlier, on `sagelib` I think.


---

Comment by mjo created at 2022-02-19 11:57:14

Replying to [comment:32 slelievre]:
> 
> My attempts to build the 9.6 beta releases
> fail earlier, on `sagelib` I think.
> 

Fortunately this is only a python question... if you don't mind, does this work?


```
>>> import tempfile
>>> with tempfile.NamedTemporaryFile(suffix=".txt") as f:
...     with open(f.name, "w") as g:
...         _ = g.write("Hello, world!")
...     with open(f.name) as h:
...         contents = h.read()
... 
>>> print(contents)
Hello, world!
```



---

Comment by mkoeppe created at 2022-02-19 20:38:38

Replying to [comment:24 mkoeppe]:
> The changes to using `TemporaryDirectory` in doctests are easy to review and are definitely a great improvement that we should merge as soon as possible.
> 
> However, I would suggest to split this ticket

I've opened #33383 for the easy to review changes in the doctests.


---

Comment by slelievre created at 2022-02-21 18:12:26

Replying to [comment:33 mjo]:
> does this work?
> 
> {{{
> >>> import tempfile
> >>> with tempfile.NamedTemporaryFile(suffix=".txt") as f:
> ...     with open(f.name, "w") as g:
> ...         _ = g.write("Hello, world!")
> ...     with open(f.name) as h:
> ...         contents = h.read()
> ... 
> >>> print(contents)
> Hello, world!
> }}}

Yes, it works in Cygwin with Python 3.7.12, Python 3.8.12, Python 3.9.10.


---

Comment by mjo created at 2022-02-21 19:17:18

Replying to [comment:35 slelievre]:
> 
> Yes, it works in Cygwin with Python 3.7.12, Python 3.8.12, Python 3.9.10.

Thank you! That means I can go back and simplify a lot of stuff.


---

Comment by git created at 2022-02-22 01:48:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-02-22 01:51:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-22 20:05:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-02-23 10:59:38

Ok, back to patchbots.

This branch is based on #32987 which deprecates `sage_makedirs` (also now redundant), and _does not_ remove sage-cleaner. We can do that in another ticket.


---

Comment by mjo created at 2022-02-23 10:59:38

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-23 17:30:28

This one needs to be reverted:

```
diff --git a/src/doc/en/reference/interfaces/index.rst b/src/doc/en/reference/interfaces/index.rst
index d007f67..f09fc62 100644
--- a/src/doc/en/reference/interfaces/index.rst
+++ b/src/doc/en/reference/interfaces/index.rst
@@ -108,7 +108,6 @@ and testing to make sure nothing funny is going on).
    sage/interfaces/tachyon
    sage/interfaces/tides
 
-   sage/interfaces/cleaner
    sage/interfaces/quit
    sage/interfaces/read_data
 
```



---

Comment by mkoeppe created at 2022-02-23 17:31:32

Should `tempfile` become a global import (`sage.all`) to make the repeated imports in doctests unnecessary?


---

Comment by mkoeppe created at 2022-02-23 17:33:32

Also `src/sage/interfaces/expect.py` still has cleaner-related changes


---

Comment by git created at 2022-02-23 17:56:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-02-23 18:00:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2022-02-23 18:00:56

Replying to [comment:43 mkoeppe]:
> This one needs to be reverted:

Thanks, done. I also removed the `cleaner()` function from `sage.interfaces.cleaner`, since it was replaced by `register_spawned_process()` in `sage.interfaces.quit`.


---

Comment by mjo created at 2022-02-23 18:02:28

Replying to [comment:44 mkoeppe]:
> Should `tempfile` become a global import (`sage.all`) to make the repeated imports in doctests unnecessary?

I don't have a strong opinion either way. The main downside is that it would clutter the global namespace for something that is pretty much only used for doctests. On the other hand, if we import it automatically only during doctesting, then the examples can't be copy & pasted.


---

Comment by mjo created at 2022-02-23 18:04:04

Replying to [comment:45 mkoeppe]:
> Also `src/sage/interfaces/expect.py` still has cleaner-related changes

Which one? The change from `cleaner()` to `register_spawned_process()` is intentional, and will make it easier to remove the cleaner in the future.


---

Comment by mkoeppe created at 2022-02-23 18:09:32

Replying to [comment:49 mjo]:
> if we import it automatically only during doctesting

definitely we shouldn't do that


---

Comment by mkoeppe created at 2022-03-27 16:52:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-29 01:16:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-03-29 01:17:03

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-30 00:09:18


```
sage -t --long --random-seed=286814129660227055850621679081389420825 src/sage/misc/latex.py
**********************************************************************
File "src/sage/misc/latex.py", line 1970, in sage.misc.latex.?
Failed example:
    with tempfile.NamedTemporaryFile(suffix=".png") as f:
        png(ZZ[x], f.name) # random, optional - latex imagemagick
Exception raised:
```

the `# optional` is on the wrong line


---

Comment by mkoeppe created at 2022-03-30 00:09:25

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-30 00:36:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-03-30 00:37:29

Thanks, fixed.


---

Comment by mjo created at 2022-03-30 00:37:29

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-30 01:03:46


```
--- a/src/sage/repl/attach.py
+++ b/src/sage/repl/attach.py
@@ -170,12 +170,14 @@ def load_attach_path(path=None, replace=False):
...
+    We put a new, empty direcoty on the attach path for testing
```

"directory"


---

Comment by mkoeppe created at 2022-03-30 01:08:53

Overall, I'm a bit unsure about changes like this one to the doctests. 
What is lost for the user is being able to copy-paste the code and then inspect the
generated file.

```
diff --git a/src/sage/numerical/mip.pyx b/src/sage/numerical/mip.pyx
index d966be1..4bf61d1 100644
--- a/src/sage/numerical/mip.pyx
+++ b/src/sage/numerical/mip.pyx
@@ -1336,7 +1336,9 @@ cdef class MixedIntegerLinearProgram(SageObject):
             sage: x = p.new_variable(nonnegative=True)
             sage: p.set_objective(x[1] + x[2])
             sage: p.add_constraint(-3*x[1] + 2*x[2], max=2,name="OneConstraint")
-            sage: p.write_mps(os.path.join(SAGE_TMP, "lp_problem.mps"))
+            sage: import tempfile
+            sage: with tempfile.NamedTemporaryFile(suffix=".mps") as f:
+            ....:     p.write_mps(f.name)
             Writing problem data to ...
             17 records were written
```



---

Comment by git created at 2022-03-30 01:13:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-03-30 01:18:29

Replying to [comment:59 mkoeppe]:
> "directory"

also fixed


---

Comment by mjo created at 2022-03-30 01:35:35

Replying to [comment:60 mkoeppe]:
> Overall, I'm a bit unsure about changes like this one to the doctests. 
> What is lost for the user is being able to copy-paste the code and then inspect the
> generated file.

In many cases, the point of the method is that it writes what would normally be shown to the user to a file instead. If you want to see this MILP, for example, then `p.show()` can be used instead. I'm dodging your point, but looking back, many of these tests are in the same spirit.

In general, I would say it's bad practice to give users code that will write to a temporary file and teach them to expect it to remain there. It's better to have these copy/paste examples fail immediately, so that the user will pick a non-temporary path for his own experiments. Otherwise he could lose some work when sage exits or when the machine reboots.


---

Comment by git created at 2022-04-25 10:45:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-05-01 01:08:26

I've split out #33779: Remove use of `SAGE_TMP` in `sage.interfaces.latte`


---

Comment by mkoeppe created at 2022-05-01 01:18:53

Replying to [comment:25 mjo]:
> Replying to [comment:24 mkoeppe]:
> > user code may continue to use `SAGE_TMP`, as this was the advertised interface since the beginning of time. So we need a transition period here. [...]
> 
> To my surprise, `SAGE_TMP` was actually undocumented. It's not in the reference manual or the developer guide, and it had no docstring. But you're probably right that a few sage developers managed to use it in their own code.

Current branch still removes `SAGE_TMP`. This needs to be backed out. Likewise the removal of `ECL_TMP`, `SPYX_TMP` - they are part of the public API.


---

Comment by git created at 2022-05-03 11:35:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2022-05-03 11:43:45

I replaced the removal of `SAGE_TMP` by a deprecation, and likewise with the rename `SPYX_TMP` -> `spyx_tmp()`.

I don't fully agree with doing the same for `ECL_TMP` since sage doesn't use it any more: anyone using it will have their code implicitly broken rather than explicitly. Nevertheless, I doubt anyone is using it, so I've put it back with a deprecation and relocated the path somewhere under the system's temporary location.


---

Comment by mkoeppe created at 2022-05-03 14:28:03

Could you move the new functions `spyx_tmp` to `sage.misc.temporary_file`, like I tried in #32986? This would help with modularization


---

Comment by mkoeppe created at 2022-05-03 14:38:40

I've opened #33790 for the ECL/Maxima stuff - I'd like to run this by the ECL/Maxima people


---

Comment by git created at 2022-05-04 00:25:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-04 02:59:25

Thanks. I've opened #33793 for this


---

Comment by mkoeppe created at 2022-05-04 03:08:18

I forgot to say I'll probably want to keep `sage.misc.temporary_file` without a dependence on Cython modules such as cachefunc


---

Comment by git created at 2022-05-04 14:41:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-05-04 19:26:14

Opened #33797, #33799


---

Comment by mkoeppe created at 2022-05-09 23:30:53

Opened #33829, #33837


---

Comment by dimpase created at 2022-06-10 10:16:41

need to get rid of SAGE_TMP in `msolve.py`

```
src/sage/rings/polynomial/msolve.py:from sage.misc.all import SAGE_TMP
src/sage/rings/polynomial/msolve.py:    msolve_in = tempfile.NamedTemporaryFile(dir=SAGE_TMP, mode='w',
...
```

----
Last 10 new commits:


---

Comment by dimpase created at 2022-06-10 10:16:41

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2022-06-10 10:17:09

rebased over the latest 9.7.beta1


---

Comment by git created at 2022-06-10 10:38:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-10 10:44:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-06-10 10:45:18

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2022-06-10 10:45:18

Matthias, is it OK with you?


---

Comment by mkoeppe created at 2022-06-10 19:42:13

Is it still on top of #33829?


---

Comment by dimpase created at 2022-06-10 22:30:34

Replying to [comment:87 mkoeppe]:
> Is it still on top of #33829?
it is. Is it wrong?


---

Comment by mkoeppe created at 2022-06-11 18:33:35

I haven't reviewed the changes on the ticket. The parts that I was able to review have been split out to separate tickets.


---

Comment by mkoeppe created at 2022-06-11 18:33:35

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2022-06-11 18:36:28

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-06-13 10:15:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2022-06-13 10:16:16

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-06-13 10:59:41

rebased over #33829, #33790 (and 9.7.beta2), all good


---

Comment by dimpase created at 2022-06-13 10:59:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-06-21 23:22:55

Resolution: fixed


---

Comment by mkoeppe created at 2022-06-25 20:26:26

The branch includes a rebased version of #32716


---

Comment by mkoeppe created at 2022-09-27 17:51:46

Follow-up discussion in https://groups.google.com/g/sage-devel/c/jpwUb8OCVVc


---

Comment by jhpalmieri created at 2022-10-12 18:29:29

Follow-up ticket: #34593
