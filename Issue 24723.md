# Issue 24723: prime_pi errors

Issue created by migration from Trac.

Original creator: gianluca.amato.74

Original creation time: 2018-03-12 19:14:43

CC:  slelievre

Keywords: primes prime_pi

The prime_pi function sometimes computes a wrong result. In particular, I found the following errors:

* prime_pi(14783545363230719)
  returns 408351706116074, it should be 408351706116078
* prime_pi(5685979153167559)
  returns 161319877461134, it should be 161319877461136
* prime_pi(642763101936913)
  returns 19439675999018, it should be 19439675999019

The correct countings are computed using Kim Walisch's [primecount](https://github.com/kimwalisch/primecount/) library, with different algorithms: Deleglise-Rivat, Lagarias-Miller-Odlyzko and Lehmer's formula. (not. All of them return the same result.

Note that while the arguments to prime_pi in the first two examples exceed the value 2!^50, causing the appearance of a warning ("computation of prime_pi for x >= 2!^50 has not been as thoroughly tested as for smaller values"), the argument  of the last example is within the range of inputs considered to be safe.

Actually, instead of fixing the current code, it could be easier to rewrite the prime_pi function and let it use the primecount library. This would have the additional advantage of being much faster than the current code.


---

Comment by vdelecroix created at 2018-03-13 08:24:14

Could you add timings in the ticket description? Did you check with PARI/GP?

First step would be to make primecount a proper optional package and interface it. In a second time it can be discussed whether this needs to be a standard package (ie coming with default Sage installation). As a parallel task, the fact that `prime_pi` is wrong is really bad and could be temporarilly fixed with a [stopgap http://doc.sagemath.org/html/en/reference/misc/sage/misc/stopgap.html].


---

Comment by vdelecroix created at 2018-03-13 16:20:54

See #24966 for actually packaging primecount.


---

Comment by gianluca.amato.74 created at 2018-03-14 08:07:51

I changed the description of the ticket adding execution times. I did not try using Pari/GP because Pari primepi function is very very slow (at least until the latest release, there is some minor improvement in the development code). It works by enumerating one by one all prime numbers, together with a table of pre-computed values. Just to give an example, although primepi(200000000507)=8007105083 is pre-computed. computing primepi(251000000000) requires 372 seconds, while [SageMath](SageMath) and primecount only take less than a second.


---

Comment by gianluca.amato.74 created at 2018-03-14 08:19:27

Added some context information to the ticket description.


---

Comment by ohanar created at 2018-03-14 22:34:30

When I wrote the current `prime_pi` code, there was no open source implementations of fast prime counting. I agree that the best long term solution is to use the `primecount` library.


---

Comment by gianluca.amato.74 created at 2018-03-14 23:43:12

Fixed typos.


---

Comment by vdelecroix created at 2018-06-09 12:49:24

I can confirm the behavior of the last example

```
sage: %time prime_pi(642763101936913)
CPU times: user 4min 29s, sys: 16.1 ms, total: 4min 29s
Wall time: 4min 29s
19439675999018
```

and thanks to #24966 this can be checked with

```
sage: from sage.interfaces import primecount
sage: %time primecount.prime_pi(642763101936913)
CPU times: user 4.88 s, sys: 61.8 ms, total: 4.94 s
Wall time: 1.24 s
19439675999019
```



---

Comment by mmarco created at 2021-11-12 20:44:52

Since primecount has been an optional package for several years, maybe it would be a good idea to upgrade it to standard and just call it?


---

Comment by was created at 2021-11-12 20:48:55

Or if nobody has time to work on this, maybe somebody could replace the message ""computation of prime_pi for `x >= 2^50` has not been as thoroughly tested as for smaller values", which is only triggered for large input, by a similar message triggered by any `x >= 10^6` say?  The message could be "computation of prime_pi has known bugs (see #24960)".


---

Comment by mmarco created at 2021-11-12 20:58:19

Replying to [comment:9 mmarco]:
> Since primecount has been an optional package for several years, maybe it would be a good idea to upgrade it to standard and just call it?


Of course, in that case we should reconsider #32412


---

Comment by dimpase created at 2021-11-12 22:34:29

I think we should upgrade `primecount` spkg and use it in `prime_pi`. And revert #32412


---

Comment by mkoeppe created at 2021-11-12 22:38:15

See #32412#comment:7 for how to do the primecount Cython interfaces properly


---

Comment by mmarco created at 2021-11-12 23:22:44

Replying to [comment:12 dimpase]:
> I think we should upgrade `primecount` spkg and use it in `prime_pi`. And revert #32412
+1

The difference in speed in huge. Not to mention the correctness.

Is the cmake dependency really a no-go for making it standard?


---

Comment by mkoeppe created at 2021-11-12 23:24:40

Replying to [comment:14 mmarco]:
> Is the cmake dependency really a no-go for making it standard?

No, that's outdated. `cmake` is a standard package now.


---

Comment by mmarco created at 2021-11-14 16:42:29

Replying to [comment:13 mkoeppe]:
> See #32412#comment:7 for how to do the primecount Cython interfaces properly

So we should move the current cython code to a pip package, and then instruct sage to pip-install it instead of using a sage SPKG?


---

Comment by mkoeppe created at 2021-11-14 17:50:56

Yes, either the current cython code should become a pip-installable package; or switch to using https://pypi.org/project/primecount/ (but see https://github.com/hearot/primecount-python/issues/3).

The pip-installable package can then become an SPKG.


---

Comment by dimpase created at 2021-11-14 22:51:18

I think it's more urgent to provide a bug-free `prime_pi` than to package the implementation nicely.


---

Comment by mkoeppe created at 2021-11-14 22:54:06

It's 10 minutes of work to package it.


---

Comment by dimpase created at 2021-11-14 23:49:06

if you know what to do, yes. 
if not, who knows.


---

Comment by mkoeppe created at 2021-11-14 23:57:04

In this case, one copies and adjusts something that works, such as https://github.com/sagemath/memory_allocator


---

Comment by dimpase created at 2021-11-15 11:33:52

I've posted some not yet complete thing on #25009


---

Comment by dimpase created at 2021-11-16 11:17:34

A quick thing would be to put a deprecation warning in `prime_pi` et al., telling users to use `prime_pi` from `primecount` instead. Would this be acceptable way to resolve this ticket?
(note that also `prime_pi` has 2nd optional parameter, and providing an implementation for it would be work...)

And then it can be just removed, witin a year or so.


---

Comment by dimpase created at 2021-11-16 11:18:00

Changing priority from minor to major.


---

Comment by gianluca.amato.74 created at 2021-11-16 11:52:12

I don't understand in all the details what the second parameter of `prime_pi` does, but in any case it just changes the inner workings of the function, not its input/output behavior. Therefore, I think that, when implemented trough `primecount`, it would be possible to just keep the second parameter for compatibility reasons but ignore its value.


---

Comment by dimpase created at 2021-11-16 14:12:12

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-11-16 14:12:12

one has to decide what to do with the optional (usless) 2nd parameter to `prime_pi()`
----
New commits:


---

Comment by slelievre created at 2021-11-16 19:56:58

Changing keywords from "primes prime_pi" to "primes prime_pi primecount".


---

Comment by dimpase created at 2021-11-16 20:33:32

should `primecount` to be added to dependencies of, hmm, `sagelib` ? 
Because on a slow 32-bit machine I see how building docs is failing (if I start `make ptest` right after `./configure`), as it needs `prime_pi`, which in turn depends on `primecount`, or, more precisely, on `sage.interfaces.primecount`.


---

Comment by mkoeppe created at 2021-11-16 20:44:21

comment:21.


---

Comment by dimpase created at 2021-11-16 20:58:22

I finally built and tested this on a 32-bit host, the only one test error there, it is due to a different error message, `int is too big` vs `Python int is too big`.

Needs some dots to be added.


---

Comment by dimpase created at 2021-11-16 20:59:42

Replying to [comment:30 mkoeppe]:
> comment:21.
I don't understand, do you mean that `primecount` is the only package that needs this treatment?


---

Comment by git created at 2021-11-16 21:19:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-16 21:50:43

Do we also need

```diff
--- a/build/pkgs/sagelib/dependencies
+++ b/build/pkgs/sagelib/dependencies
`@``@` -1,4 +1,4 `@``@`
-FORCE $(SCRIPTS) arb boost_cropped $(BLAS) brial cliquer cypari cysignals cython ecl eclib ecm flint libgd gap giac givaro glpk gmpy2 gsl iml jinja2 jupyter_core lcalc lrcalc libbraiding libhomfly libpng linbox m4ri m4rie memory_allocator mpc mpfi mpfr $(MP_LIBRARY) ntl numpy pari pip pkgconfig planarity ppl pplpy pycygwin $(PYTHON) ratpoints rw sage_conf singular symmetrica zn_poly $(PCFILES) | $(PYTHON_TOOLCHAIN) sage_setup
+FORCE $(SCRIPTS) arb boost_cropped $(BLAS) brial cliquer cypari cysignals cython ecl eclib ecm flint libgd gap giac givaro glpk gmpy2 gsl iml jinja2 jupyter_core lcalc lrcalc libbraiding libhomfly libpng linbox m4ri m4rie memory_allocator mpc mpfi mpfr $(MP_LIBRARY) ntl numpy pari pip pkgconfig planarity ppl pplpy primecount pycygwin $(PYTHON) ratpoints rw sage_conf singular symmetrica zn_poly $(PCFILES) | $(PYTHON_TOOLCHAIN) sage_setup
 
 ----------
 All lines of this file are ignored except the first.
diff --git a/src/pyproject.toml.m4 b/src/pyproject.toml.m4
index 125da7ac1c..6b6402884a 100644
--- a/src/pyproject.toml.m4
+++ b/src/pyproject.toml.m4
`@``@` -18,6 +18,7 `@``@` requires = [
         numpy          \
         pkgconfig      \
         pplpy          \
+        primecount     \
         memory_allocator \
                     ')]
 build-backend = "setuptools.build_meta"
```

to avoid possible races? Still, this does not seem to be relevant for the issue in comment:28.


---

Comment by mkoeppe created at 2021-11-16 22:22:24

Replying to [comment:32 dimpase]:
> Replying to [comment:30 mkoeppe]:
> > comment:21.
> I don't understand, do you mean that `primecount` is the only package that needs this treatment?

You were asking how to do dependencies right. The answer is: The bindings need to go into a separate Python package -- that will look just like `memory_allocator`. In this way, `sagelib` will not acquire another compile-time dependency. Modularization = do not pile on additional compile-time dependencies.


---

Comment by dimpase created at 2021-11-16 22:39:11

I think we're talking about different issues. I saw an error during docbuild stage which came from
`src/sage/interfaces/primecount.pyx` not yet built at that moment. The external library spkg `primecount` was already built at that moment.


---

Comment by mkoeppe created at 2021-11-16 22:41:25

As I have explained, `src/sage/interfaces/primecount.pyx` should not be part of sagelib. This is why it was deprecated!


---

Comment by dimpase created at 2021-11-16 22:48:40

I asked you whether it's the only Cython file out there left that should not be a part of sagelib.
You didn't reply - I assume this means it is not. 

I don't have mental capacity now to learn the ideal modern design, I just want this ticket done in the most direct way.
Modularisation can be done on another ticket.


---

Comment by dimpase created at 2021-11-17 14:14:16

I was relieved today from teaching computer graphics next term, so I have some spare mental capacity now :-)

Note that `src/sage/functions/prime_pi.pyx` relies heavily on `sagelib` (e.g. on SR). 

What does not rely on sagelib (or on Sage at all) is  `src/sage/interfaces/primecount.pyx`, 
which is not even touched by this ticket (it's touched by  #25009).
 
The latter indeed can be spun off, modelling on `memory_allocator`
(I suppose after it's done, one would only need to change one import statement in `src/sage/functions/prime_pi.pyx`.)


---

Comment by git created at 2021-11-25 12:16:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-11-25 13:47:27

we will proceed with this on #32894, which includes commits on this ticket's branch.


---

Comment by mkoeppe created at 2021-12-02 18:57:07

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-03 18:41:01

Resolution: invalid
