# Issue 22380: Make the cython example using singular works in distros too

archive/issues_022380.json:
```json
{
    "body": "CC:  @jdemeyer\n\nThere is currently an old cython example in `cython.py` that relies on the location of the header has installed in sage (which is different from upstream - at least in singular-4.1.0.p1). Gentoo and probably other distro respect upstream layout which causes doctest to fail.\n\n\n```\n        sage: code = [\n        ....: \"#clang C++\",\n        ....: \"#clib m readline Singular givaro ntl gmpxx gmp\",\n        ....: \"from sage.rings.polynomial.multi_polynomial_libsingular cimport MPolynomial_libsingular\",\n        ....: \"from sage.libs.singular.polynomial cimport singular_polynomial_pow\",\n        ....: \"def test(MPolynomial_libsingular p):\",\n        ....: \"    singular_polynomial_pow(&p._poly, p._poly, 2, p._parent_ring)\"]\n        sage: cython(os.linesep.join(code))\n```\n\n\nSince singular provides a .pc file it can be made irrelevant by calling pkgconfig. We can also use the opportunity to clean the libraries used, some of which are not relevant anymore.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22617\n\n",
    "created_at": "2017-03-16T08:52:01Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Make the cython example using singular works in distros too",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22380",
    "user": "https://github.com/kiwifb"
}
```
CC:  @jdemeyer

There is currently an old cython example in `cython.py` that relies on the location of the header has installed in sage (which is different from upstream - at least in singular-4.1.0.p1). Gentoo and probably other distro respect upstream layout which causes doctest to fail.


```
        sage: code = [
        ....: "#clang C++",
        ....: "#clib m readline Singular givaro ntl gmpxx gmp",
        ....: "from sage.rings.polynomial.multi_polynomial_libsingular cimport MPolynomial_libsingular",
        ....: "from sage.libs.singular.polynomial cimport singular_polynomial_pow",
        ....: "def test(MPolynomial_libsingular p):",
        ....: "    singular_polynomial_pow(&p._poly, p._poly, 2, p._parent_ring)"]
        sage: cython(os.linesep.join(code))
```


Since singular provides a .pc file it can be made irrelevant by calling pkgconfig. We can also use the opportunity to clean the libraries used, some of which are not relevant anymore.

Issue created by migration from https://trac.sagemath.org/ticket/22617





---

archive/issue_comments_310777.json:
```json
{
    "body": "`@` Jeroen I had a moment of uncertainty when reviewing the upgrade to singular 4.1.0.p1 because of the location of the headers if you remember. This makes it all irrelevant and I believe introduce better practice if you link to something that provides a .pc file.\n----\nNew commits:",
    "created_at": "2017-03-16T08:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310777",
    "user": "https://github.com/kiwifb"
}
```

`@` Jeroen I had a moment of uncertainty when reviewing the upgrade to singular 4.1.0.p1 because of the location of the headers if you remember. This makes it all irrelevant and I believe introduce better practice if you link to something that provides a .pc file.
----
New commits:



---

archive/issue_comments_310778.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-16T08:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310778",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_310779.json:
```json
{
    "body": "Please add a comment in the code that this is just a temporary hack and that #22461 should fix a lot of issues like this one with `cython()`.",
    "created_at": "2017-03-16T09:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310779",
    "user": "https://github.com/jdemeyer"
}
```

Please add a comment in the code that this is just a temporary hack and that #22461 should fix a lot of issues like this one with `cython()`.



---

archive/issue_comments_310780.json:
```json
{
    "body": "Didn't know about #22461. Will update ASAP.",
    "created_at": "2017-03-16T09:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310780",
    "user": "https://github.com/kiwifb"
}
```

Didn't know about #22461. Will update ASAP.



---

archive/issue_comments_310781.json:
```json
{
    "body": "Replying to [comment:1 fbissey]:\n> I believe introduce better practice if you link to something that provides a .pc file.\n\nI totally *disagree* that using Sage-specific things like `#cargs` is a better practice, but I can live with it as temporary work-around.",
    "created_at": "2017-03-16T09:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310781",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:1 fbissey]:
> I believe introduce better practice if you link to something that provides a .pc file.

I totally *disagree* that using Sage-specific things like `#cargs` is a better practice, but I can live with it as temporary work-around.



---

archive/issue_comments_310782.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Replying to [comment:1 fbissey]:\n> > I believe introduce better practice if you link to something that provides a .pc file.\n> \n> I totally *disagree* that using Sage-specific things like `#cargs` is a better practice, but I can live with it as temporary work-around.\n\nIt may be a bit hacky but it is the better option. Passing the macros is a pita and `pkgconfig.cflags` give them in the right format. I could isolate the macros from the include one way or another. But ultimately `cinclude` will feed into distutils `include_dirs` which in my opinion has a defect that make it unsuitable for \"programatic use\". If you give `include_dirs` and it's value is empty the generated compile line will include a naked \"-I \" which will usually break compilation. You don't have those problems using `cargs`.\n\nI'll grant you that's a hack , but it is still better practice to use the .pc file when it is available rather than sprinkling random libraries and include dir. That's the \"better practice\" I am talking about :)",
    "created_at": "2017-03-16T10:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310782",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:4 jdemeyer]:
> Replying to [comment:1 fbissey]:
> > I believe introduce better practice if you link to something that provides a .pc file.
> 
> I totally *disagree* that using Sage-specific things like `#cargs` is a better practice, but I can live with it as temporary work-around.

It may be a bit hacky but it is the better option. Passing the macros is a pita and `pkgconfig.cflags` give them in the right format. I could isolate the macros from the include one way or another. But ultimately `cinclude` will feed into distutils `include_dirs` which in my opinion has a defect that make it unsuitable for "programatic use". If you give `include_dirs` and it's value is empty the generated compile line will include a naked "-I " which will usually break compilation. You don't have those problems using `cargs`.

I'll grant you that's a hack , but it is still better practice to use the .pc file when it is available rather than sprinkling random libraries and include dir. That's the "better practice" I am talking about :)



---

archive/issue_comments_310783.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-16T10:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310783",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310784.json:
```json
{
    "body": "Comment added.",
    "created_at": "2017-03-16T10:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310784",
    "user": "https://github.com/kiwifb"
}
```

Comment added.



---

archive/issue_comments_310785.json:
```json
{
    "body": "If the patchbot tests pass, this is good for me.",
    "created_at": "2017-03-16T14:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310785",
    "user": "https://github.com/jdemeyer"
}
```

If the patchbot tests pass, this is good for me.



---

archive/issue_comments_310786.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-21T09:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310786",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310787.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-30T22:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22380#issuecomment-310787",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_058995.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-03-30T22:34:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22380",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22380#event-58995"
}
```
