# Issue 22380: Make the cython example using singular works in distros too

Issue created by migration from https://trac.sagemath.org/ticket/22617

Original creator: fbissey

Original creation time: 2017-03-16 08:52:01

CC:  jdemeyer

There is currently an old cython example in `cython.py` that relies on the location of the header has installed in sage (which is different from upstream - at least in singular-4.1.0.p1). Gentoo and probably other distro respect upstream layout which causes doctest to fail.


```
        sage: code = [
        ....: "#clang C++",
        ....: "#clib m readline Singular givaro ntl gmpxx gmp",
        ....: "from sage.rings.polynomial.multi_polynomial_libsingular cimport MPolynomial_libsingular",
        ....: "from sage.libs.singular.polynomial cimport singular_polynomial_pow",
        ....: "def test(MPolynomial_libsingular p):",
        ....: "    singular_polynomial_pow(&p._poly, p._poly, 2, p._parent_ring)"]
        sage: cython(os.linesep.join(code))
```


Since singular provides a .pc file it can be made irrelevant by calling pkgconfig. We can also use the opportunity to clean the libraries used, some of which are not relevant anymore.


---

Comment by fbissey created at 2017-03-16 08:55:05

`@` Jeroen I had a moment of uncertainty when reviewing the upgrade to singular 4.1.0.p1 because of the location of the headers if you remember. This makes it all irrelevant and I believe introduce better practice if you link to something that provides a .pc file.
----
New commits:


---

Comment by fbissey created at 2017-03-16 08:55:05

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-03-16 09:54:26

Please add a comment in the code that this is just a temporary hack and that #22461 should fix a lot of issues like this one with `cython()`.


---

Comment by fbissey created at 2017-03-16 09:55:41

Didn't know about #22461. Will update ASAP.


---

Comment by jdemeyer created at 2017-03-16 09:56:07

Replying to [comment:1 fbissey]:
> I believe introduce better practice if you link to something that provides a .pc file.

I totally _disagree_ that using Sage-specific things like `#cargs` is a better practice, but I can live with it as temporary work-around.


---

Comment by fbissey created at 2017-03-16 10:28:30

Replying to [comment:4 jdemeyer]:
> Replying to [comment:1 fbissey]:
> > I believe introduce better practice if you link to something that provides a .pc file.
> 
> I totally _disagree_ that using Sage-specific things like `#cargs` is a better practice, but I can live with it as temporary work-around.

It may be a bit hacky but it is the better option. Passing the macros is a pita and `pkgconfig.cflags` give them in the right format. I could isolate the macros from the include one way or another. But ultimately `cinclude` will feed into distutils `include_dirs` which in my opinion has a defect that make it unsuitable for "programatic use". If you give `include_dirs` and it's value is empty the generated compile line will include a naked "-I " which will usually break compilation. You don't have those problems using `cargs`.

I'll grant you that's a hack , but it is still better practice to use the .pc file when it is available rather than sprinkling random libraries and include dir. That's the "better practice" I am talking about :)


---

Comment by git created at 2017-03-16 10:47:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-03-16 10:47:44

Comment added.


---

Comment by jdemeyer created at 2017-03-16 14:10:20

If the patchbot tests pass, this is good for me.


---

Comment by jdemeyer created at 2017-03-21 09:37:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-30 22:34:41

Resolution: fixed
