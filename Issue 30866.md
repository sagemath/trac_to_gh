# Issue 30866: sage.numerical.backends: Replace use of TestSuite by pytest

Issue created by migration from https://trac.sagemath.org/ticket/31103

Original creator: mkoeppe

Original creation time: 2020-12-24 20:01:56

CC:  @tobiasdiez nthiery tscrim chapoton yzh

`sage.numerical.backends` provides an opportunity to study use of `pytest` as a replacement for `TestSuite` (proposed in #30738) in a small self-contained codebase.

`GenericBackend` defines an API and a small number of `_test_` methods to check that the API is implemented correctly by the backend implementations. 

Apart from converting from `TestSuite` to pytest, this would be a good opportunity to expand the tests to replace what is currently tested using copy-pasted doctests.

Important design constraint:
 - The testing framework must be extensible by user-defined classes (or classes from separately installed Python packages - such as the existing `sage_numerical_backends_coin`).


---

Comment by @tobiasdiez created at 2020-12-25 11:12:29

What should happen with the generic tests methods like `_test_new, _test_not_implemented_methods, _test_category, _test_pickling` that sadly make the "small self-contained" part hard?


---

Comment by mkoeppe created at 2020-12-25 18:26:48

Great point. This brings me to the question whether it would be possible to either
- invoke the existing `TestSuite` as one pytest method or
- dynamically generate adapter methods that invoke the existing `_test` methods.


---

Comment by @tobiasdiez created at 2020-12-26 15:15:01

Changing status from new to needs_review.


---

Comment by git created at 2020-12-26 15:15:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2020-12-26 15:22:44

Replying to [comment:2 mkoeppe]:
> - invoke the existing `TestSuite` as one pytest method or
That's a great idea, making it possible to step-by-step migrate more test methods without the need to do everything at once! I've used it now.

> - dynamically generate adapter methods that invoke the existing `_test` methods.

That might also work, but is more work since the `_test` methods are instance methods, and for pytest the adapter method would need to be provided with the instance (which in the current design is passed to the `TestSuite`). It's probably easier to simply rewrite the test method in pytest.


---

Comment by mkoeppe created at 2020-12-26 18:33:41

Thanks a lot!


---

Comment by mkoeppe created at 2020-12-26 18:40:31

Some quick remarks (I haven't had a chance to test it yet):
- I'd suggest to rename `test_old_testsuite` to something more specific like `test_sage_unittest_testsuite`.
- In the addition to `src/bin/sage-runtests` - this needs to work without error if `pytest` is not installed (currently it is only an optional package - see #31110)


---

Comment by mkoeppe created at 2020-12-26 18:42:41

Also, perhaps `src/bin/sage-runtests` should only invoke `pytest` if it is testing directories/packages that contain pytest tests (any heuristic for checking this is fine).


---

Comment by git created at 2020-12-26 19:27:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-26 19:27:58

Replying to [comment:8 mkoeppe]:
> Some quick remarks (I haven't had a chance to test it yet):
> - I'd suggest to rename `test_old_testsuite` to something more specific like `test_sage_unittest_testsuite`.
> - In the addition to `src/bin/sage-runtests` - this needs to work without error if `pytest` is not installed (currently it is only an optional package - see #31110)

Thanks! Done.


---

Comment by @tobiasdiez created at 2020-12-26 19:29:23

Replying to [comment:10 mkoeppe]:
> Also, perhaps `src/bin/sage-runtests` should only invoke `pytest` if it is testing directories/packages that contain pytest tests (any heuristic for checking this is fine). 

Mhh, pytest has its own test discovery bult-in, so I think its fine to just pass the path to it and let it look for the files. What advantages do you see of using a custom heuristic beforehand?


---

Comment by mkoeppe created at 2020-12-26 19:50:27

Replying to [comment:13 gh-tobiasdiez]:
> What advantages do you see of using a custom heuristic beforehand?

When pytest is not installed and you run `sage -t` on all of Sage, it should warn that the pytest-dependent tests are not run. (Your latest commit does that.)

But it should probably not warn if a user invokes `sage -t` on a part of Sage that does not use pytest yet -- to be less annoying.


---

Comment by mkoeppe created at 2020-12-26 19:56:38

Shouldn't `test_sage_unittest_testsuite` be provided by something more general than `GenericBackendTests`? (in other words, should `GenericBackendTests` not derive from some other class?)


---

Comment by @tobiasdiez created at 2020-12-26 20:17:42

Replying to [comment:15 mkoeppe]:
> Shouldn't `test_sage_unittest_testsuite` be provided by something more general than `GenericBackendTests`? (in other words, should `GenericBackendTests` not derive from some other class?)

Good idea for later purposes. However, it doesn't remove the test_sage_unittest_testsuite method in GenericBackendTests since all backend tests ignore test_pickling, so this still has to be done there.


---

Comment by git created at 2020-12-26 20:19:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-27 03:24:27

Great. Could you add a docstring for `test_sage_unittest_testsuite` to explain that "subclasses can override this method if they need to skip some tests".

We should also clarify whether `..._test.py` should be exempt from our rule that every function needs a docstring and a doctest. If so, probably the patchbot will need some adjustments so it will not complain.


---

Comment by git created at 2020-12-27 09:44:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-27 09:49:19

Replying to [comment:18 mkoeppe]:
> We should also clarify whether `..._test.py` should be exempt from our rule that every function needs a docstring and a doctest. If so, probably the patchbot will need some adjustments so it will not complain.
> 
That's a good idea. Tests indeed usually don't have docstrings (because they are only supposed to test one thing, which can be described by the name of the test method).

I think we also should fix our convention concerning the naming of the test files. There are three possibilities:

- `object_test.py` in the same folder as the module `object.py` (advantage: group test with object)
- `test_object.py` in the same folder as the module `object.py` (advantage: group tests)
- either of the above but in a new `test` folder (advantage: clear separation of tests and source)


---

Comment by mkoeppe created at 2020-12-27 17:31:51

I have a strong preference for the first option, `object_test.py` in the same folder... because somehow it is the closest to our current practice of keeping tests as close as possible to the module.


---

Comment by @tobiasdiez created at 2020-12-27 18:17:01

Ok, I've added this convention to #31003.


---

Comment by @tobiasdiez created at 2021-01-15 12:16:19

This and #31003 still need review.


---

Comment by @tobiasdiez created at 2021-01-23 23:05:13

Matthias, do you encounter the same cython module issue if you run `sage-runtests` from this branch (you can exit the normal doctests with Ctrl+C)?


---

Comment by mkoeppe created at 2021-01-24 01:11:57

Yes

```
(sage-sh) mkoeppe@egret:worktree-algebraic-2018-spring$ pytest src
=========================================================================== test session starts ===========================================================================
platform darwin -- Python 3.9.1, pytest-6.2.1, py-1.10.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src
collected 0 items / 8 errors                                                                                                                                              

================================================================================= ERRORS ==================================================================================
_____________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py _____________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/cvxopt_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/cvxopt_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
____________________________________________________ ERROR collecting sage/numerical/backends/generic_backend_test.py _____________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/generic_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
______________________________________________________ ERROR collecting sage/numerical/backends/glpk_backend_test.py ______________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/glpk_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
___________________________________________________ ERROR collecting sage/numerical/backends/glpk_exact_backend_test.py ___________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_exact_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/glpk_exact_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
_________________________________________________ ERROR collecting sage/numerical/backends/interactivelp_backend_test.py __________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/interactivelp_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/interactivelp_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
______________________________________________________ ERROR collecting sage/numerical/backends/ppl_backend_test.py _______________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/ppl_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/ppl_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
___________________________________________________________ ERROR collecting sage/structure/sage_object_test.py ___________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/structure/__init__.py:2: in <module>
    import sage.structure.element
E   ModuleNotFoundError: No module named 'sage.structure.element'
_____________________________________________________________ ERROR collecting sage/tests/deprecation_test.py _____________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/tests/deprecation_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/tests/deprecation_test.py:12: in <module>
    from sage.misc.superseded import deprecated_function_alias
src/sage/misc/superseded.py:29: in <module>
    from sage.misc.lazy_attribute import lazy_attribute
E   ModuleNotFoundError: No module named 'sage.misc.lazy_attribute'
========================================================================= short test summary info =========================================================================
ERROR src/sage/numerical/backends/cvxopt_backend_test.py
ERROR src/sage/numerical/backends/generic_backend_test.py
ERROR src/sage/numerical/backends/glpk_backend_test.py
ERROR src/sage/numerical/backends/glpk_exact_backend_test.py
ERROR src/sage/numerical/backends/interactivelp_backend_test.py
ERROR src/sage/numerical/backends/ppl_backend_test.py
ERROR src/sage/structure/sage_object_test.py
ERROR src/sage/tests/deprecation_test.py
```



---

Comment by @tobiasdiez created at 2021-01-24 12:24:36

Running `pytest` directly only works if you have an editable install, so that's not a surprise. But does it work if you run `sage-runtests` which now invokes pytest (using python code). From what I read, this should work.


---

Comment by mkoeppe created at 2021-01-24 18:28:16

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-01-24 18:28:16

Sorry, I missed that.


```
$ ./sage -tp src/sage/numerical/backends/
too many failed tests, not using stored timings
Running doctests with ID 2021-01-24-10-26-16-7200536b.
Using --optional=build,ccache,dochtml,homebrew,pip,saclib,sage,sage_spkg
Sorting sources by runtime so that slower doctests are run first....
Doctesting 25 files using 8 threads.
sage -t --random-seed=0 src/sage/numerical/backends/interactivelp_backend.pxd
    [0 tests, 0.00 s]
[...]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.4 seconds
    cpu time: 7.3 seconds
    cumulative wall time: 12.9 seconds
=========================================================================== test session starts ===========================================================================
platform darwin -- Python 3.9.1, pytest-6.2.1, py-1.10.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src, configfile: tox.ini
collected 0 items / 6 errors                                                                                                                                              

================================================================================= ERRORS ==================================================================================
_____________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py _____________________________________________________
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:986: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:680: in _load_unlocked
    ???
local/lib/python3.9/site-packages/_pytest/assertion/rewrite.py:170: in exec_module
    exec(co, module.__dict__)
local/lib/python3.9/site-packages/sage/numerical/backends/cvxopt_backend_test.py:6: in <module>
    class TestCVXOPTBackend(GenericBackendTests):
local/lib/python3.9/site-packages/sage/numerical/backends/cvxopt_backend_test.py:12: in TestCVXOPTBackend
    def test_sage_unittest_testsuite(self, sage_object: SageObject):
E   NameError: name 'SageObject' is not defined
____________________________________________________ ERROR collecting sage/numerical/backends/generic_backend_test.py _____________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.generic_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/generic_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/generic_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
______________________________________________________ ERROR collecting sage/numerical/backends/glpk_backend_test.py ______________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.glpk_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/glpk_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
___________________________________________________ ERROR collecting sage/numerical/backends/glpk_exact_backend_test.py ___________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.glpk_exact_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/glpk_exact_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_exact_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
_________________________________________________ ERROR collecting sage/numerical/backends/interactivelp_backend_test.py __________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.interactivelp_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/interactivelp_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/interactivelp_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
______________________________________________________ ERROR collecting sage/numerical/backends/ppl_backend_test.py _______________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.ppl_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/ppl_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/ppl_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
========================================================================= short test summary info =========================================================================
ERROR src/sage/numerical/backends/cvxopt_backend_test.py - NameError: name 'SageObject' is not defined
ERROR src/sage/numerical/backends/generic_backend_test.py
ERROR src/sage/numerical/backends/glpk_backend_test.py
ERROR src/sage/numerical/backends/glpk_exact_backend_test.py
ERROR src/sage/numerical/backends/interactivelp_backend_test.py
ERROR src/sage/numerical/backends/ppl_backend_test.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 6 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================================================ 6 errors in 0.55s ============================================================================
```



---

Comment by @tobiasdiez created at 2021-01-24 18:42:06

Ok, thanks for the feedback. I'll have a look.


---

Comment by mkoeppe created at 2021-01-31 22:18:01

Any progress here? There's some momentum to add more tests to generic_backend, and it would be great if they could be done in the new framework already


---

Comment by @tobiasdiez created at 2021-01-31 23:51:50

By default, pytest expects the compiled cython files to be in the same folder (inplace install). To support sage's build system, one needs to modify `sys.path` in the conftest file as shown here: https://stackoverflow.com/questions/20971619/ensuring-py-test-includes-the-application-directory-in-sys-path
What is the correct SAGE_XYZ folder to specify there? SAGE_LOCAL?

Moreover, it could be a problem that the test files are present twice (in local and src), which I think leads to the other errors above. Maybe https://docs.pytest.org/en/stable/pythonpath.html helps.

I will have a look at these things, but it will take some time as I have to destroy my nicely working inplace install for this. Feel free to play around with the above linked code.


---

Comment by mkoeppe created at 2021-02-01 02:43:49

In an install without pytest, I am getting:

```
./sage -t src/sage/numerical/backends/
...
Pytest is not installed, skip checking tests that rely on it.
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/bin/sage-runtests", line 196, in <module>
    sys.exit(exit_code_pytest)
NameError: name 'exit_code_pytest' is not defined
```



---

Comment by git created at 2021-02-01 02:46:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-01 02:58:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-01 02:59:33

This version works for me


---

Comment by mkoeppe created at 2021-02-01 03:03:19

Replying to [comment:30 gh-tobiasdiez]:
> Maybe https://docs.pytest.org/en/stable/pythonpath.html helps.

Yes, it did!


---

Comment by mkoeppe created at 2021-02-01 03:16:29

The only remaining problem that I have is that I need to update the 3 standalone packages providing additional backends (https://github.com/mkoeppe/sage-numerical-backends-coin, ...) to also invoke pytest - and to do make sure this does not cause errors on older Sage versions.


---

Comment by mkoeppe created at 2021-02-01 03:23:02

To keep the work limited, perhaps it's best to keep the old `_test_` methods so that the test coverage of the backend packages is not sacrificed.  We will delete the `_test_` methods later.


---

Comment by git created at 2021-02-01 03:26:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-01 03:27:45

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-02-01 09:27:42

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2021-02-01 09:27:42

Thanks a lot for having a look at this. Your changes look good to me!


---

Comment by mkoeppe created at 2021-02-01 16:48:48

Adding #30551 as a dependency because of `from __future__ import annotations`. Or can we avoid it?


---

Comment by vbraun created at 2021-05-27 20:30:05

Resolution: fixed


---

Comment by saraedum created at 2021-09-20 16:08:13

This seems to break our workflow at https://github.com/flatsurf/e-antic. We are running some [SageMath](SageMath) doctests with `sage-runtests`. The tests all pass and then we see:

```
collected 0 items

====================================================== no tests ran in 0.00s ======================================================
```


The problem is that this now returns with exit code 5, i.e., the CI assumes that the tests have failed.


---

Comment by saraedum created at 2021-09-20 16:22:11

A workaround is to drop a `test_nothing.py` file in the directory where the doctests are run:

```
def test_nothing():pass
```



---

Comment by mkoeppe created at 2021-09-20 16:30:30

Help with fixing this properly is welcome. The developer who worked on the pytest stuff has disappeared


---

Comment by @tobiasdiez created at 2021-09-21 11:58:35

A proper fix would probably be to add an additional if check if the pytest return code is 5 here:

```
+    if err == 0:
+        sys.exit(exit_code_pytest)
+    else:
+        sys.exit(err)
```

See also the discussion in https://github.com/pytest-dev/pytest/issues/2393.

I sadly don't have the time to implement it though.


---

Comment by saraedum created at 2021-11-13 02:20:52

The workaround in #31103#comment:45 does not work if the tested module contains some sage metaclass machinery since pytest is unvoked with `--import-mode importlib`, there is an error because the module is not in `sys.modules` and this confuses `nested_class.pyx`.

In that case, there is an error and not only an error code 5.

```
  ==================================== ERRORS ====================================
  ____________________ ERROR collecting pyflatsurf/vector.py _____________________
  ../src/pyflatsurf/vector.py:285: in <module>
      class Vectors(UniqueRepresentation, Parent):
  sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2314)
      ???
  E   KeyError: 'vector'
```



---

Comment by saraedum created at 2021-11-13 02:29:33

Another workaround is to just pretend that pytest is not installed:


```
$ cat no-pytest/pytest.py
raise ModuleNotFoundError
$ PYTHONPATH=no-pytest:$PYTHONPATH sage -tp ...
```


But I actually think we should make this a bit more convenient than having to hack the module search path.


---

Comment by @tobiasdiez created at 2021-11-17 21:12:06

I guess the issue with the modules is the same as #31924.


---

Comment by @tobiasdiez created at 2021-11-17 21:30:24

And the exit code 5 issue should be fixed with #32892.
