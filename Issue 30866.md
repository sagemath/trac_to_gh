# Issue 30866: sage.numerical.backends: Replace use of TestSuite by pytest

archive/issues_030866.json:
```json
{
    "body": "CC:  @tobiasdiez @nthiery @tscrim @fchapoton @yuan-zhou\n\n`sage.numerical.backends` provides an opportunity to study use of `pytest` as a replacement for `TestSuite` (proposed in #30738) in a small self-contained codebase.\n\n`GenericBackend` defines an API and a small number of `_test_` methods to check that the API is implemented correctly by the backend implementations. \n\nApart from converting from `TestSuite` to pytest, this would be a good opportunity to expand the tests to replace what is currently tested using copy-pasted doctests.\n\nImportant design constraint:\n- The testing framework must be extensible by user-defined classes (or classes from separately installed Python packages - such as the existing `sage_numerical_backends_coin`).\n\nIssue created by migration from https://trac.sagemath.org/ticket/31103\n\n",
    "created_at": "2020-12-24T20:01:56Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "sage.numerical.backends: Replace use of TestSuite by pytest",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30866",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @tobiasdiez @nthiery @tscrim @fchapoton @yuan-zhou

`sage.numerical.backends` provides an opportunity to study use of `pytest` as a replacement for `TestSuite` (proposed in #30738) in a small self-contained codebase.

`GenericBackend` defines an API and a small number of `_test_` methods to check that the API is implemented correctly by the backend implementations. 

Apart from converting from `TestSuite` to pytest, this would be a good opportunity to expand the tests to replace what is currently tested using copy-pasted doctests.

Important design constraint:
- The testing framework must be extensible by user-defined classes (or classes from separately installed Python packages - such as the existing `sage_numerical_backends_coin`).

Issue created by migration from https://trac.sagemath.org/ticket/31103





---

archive/issue_comments_440617.json:
```json
{
    "body": "What should happen with the generic tests methods like `_test_new, _test_not_implemented_methods, _test_category, _test_pickling` that sadly make the \"small self-contained\" part hard?",
    "created_at": "2020-12-25T11:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440617",
    "user": "https://github.com/tobiasdiez"
}
```

What should happen with the generic tests methods like `_test_new, _test_not_implemented_methods, _test_category, _test_pickling` that sadly make the "small self-contained" part hard?



---

archive/issue_comments_440618.json:
```json
{
    "body": "Great point. This brings me to the question whether it would be possible to either\n- invoke the existing `TestSuite` as one pytest method or\n- dynamically generate adapter methods that invoke the existing `_test` methods.",
    "created_at": "2020-12-25T18:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440618",
    "user": "https://github.com/mkoeppe"
}
```

Great point. This brings me to the question whether it would be possible to either
- invoke the existing `TestSuite` as one pytest method or
- dynamically generate adapter methods that invoke the existing `_test` methods.



---

archive/issue_comments_440619.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-26T15:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440619",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_440620.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-12-26T15:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440620",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_440621.json:
```json
{
    "body": "Replying to [comment:2 mkoeppe]:\n> - invoke the existing `TestSuite` as one pytest method or\nThat's a great idea, making it possible to step-by-step migrate more test methods without the need to do everything at once! I've used it now.\n\n> - dynamically generate adapter methods that invoke the existing `_test` methods.\n\nThat might also work, but is more work since the `_test` methods are instance methods, and for pytest the adapter method would need to be provided with the instance (which in the current design is passed to the `TestSuite`). It's probably easier to simply rewrite the test method in pytest.",
    "created_at": "2020-12-26T15:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440621",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:2 mkoeppe]:
> - invoke the existing `TestSuite` as one pytest method or
That's a great idea, making it possible to step-by-step migrate more test methods without the need to do everything at once! I've used it now.

> - dynamically generate adapter methods that invoke the existing `_test` methods.

That might also work, but is more work since the `_test` methods are instance methods, and for pytest the adapter method would need to be provided with the instance (which in the current design is passed to the `TestSuite`). It's probably easier to simply rewrite the test method in pytest.



---

archive/issue_comments_440622.json:
```json
{
    "body": "Thanks a lot!",
    "created_at": "2020-12-26T18:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440622",
    "user": "https://github.com/mkoeppe"
}
```

Thanks a lot!



---

archive/issue_comments_440623.json:
```json
{
    "body": "Some quick remarks (I haven't had a chance to test it yet):\n- I'd suggest to rename `test_old_testsuite` to something more specific like `test_sage_unittest_testsuite`.\n- In the addition to `src/bin/sage-runtests` - this needs to work without error if `pytest` is not installed (currently it is only an optional package - see #31110)",
    "created_at": "2020-12-26T18:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440623",
    "user": "https://github.com/mkoeppe"
}
```

Some quick remarks (I haven't had a chance to test it yet):
- I'd suggest to rename `test_old_testsuite` to something more specific like `test_sage_unittest_testsuite`.
- In the addition to `src/bin/sage-runtests` - this needs to work without error if `pytest` is not installed (currently it is only an optional package - see #31110)



---

archive/issue_comments_440624.json:
```json
{
    "body": "Also, perhaps `src/bin/sage-runtests` should only invoke `pytest` if it is testing directories/packages that contain pytest tests (any heuristic for checking this is fine).",
    "created_at": "2020-12-26T18:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440624",
    "user": "https://github.com/mkoeppe"
}
```

Also, perhaps `src/bin/sage-runtests` should only invoke `pytest` if it is testing directories/packages that contain pytest tests (any heuristic for checking this is fine).



---

archive/issue_comments_440625.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-26T19:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440626.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Some quick remarks (I haven't had a chance to test it yet):\n> - I'd suggest to rename `test_old_testsuite` to something more specific like `test_sage_unittest_testsuite`.\n> - In the addition to `src/bin/sage-runtests` - this needs to work without error if `pytest` is not installed (currently it is only an optional package - see #31110)\n\nThanks! Done.",
    "created_at": "2020-12-26T19:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440626",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:8 mkoeppe]:
> Some quick remarks (I haven't had a chance to test it yet):
> - I'd suggest to rename `test_old_testsuite` to something more specific like `test_sage_unittest_testsuite`.
> - In the addition to `src/bin/sage-runtests` - this needs to work without error if `pytest` is not installed (currently it is only an optional package - see #31110)

Thanks! Done.



---

archive/issue_comments_440627.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> Also, perhaps `src/bin/sage-runtests` should only invoke `pytest` if it is testing directories/packages that contain pytest tests (any heuristic for checking this is fine). \n\nMhh, pytest has its own test discovery bult-in, so I think its fine to just pass the path to it and let it look for the files. What advantages do you see of using a custom heuristic beforehand?",
    "created_at": "2020-12-26T19:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440627",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:10 mkoeppe]:
> Also, perhaps `src/bin/sage-runtests` should only invoke `pytest` if it is testing directories/packages that contain pytest tests (any heuristic for checking this is fine). 

Mhh, pytest has its own test discovery bult-in, so I think its fine to just pass the path to it and let it look for the files. What advantages do you see of using a custom heuristic beforehand?



---

archive/issue_comments_440628.json:
```json
{
    "body": "Replying to [comment:13 gh-tobiasdiez]:\n> What advantages do you see of using a custom heuristic beforehand?\n\nWhen pytest is not installed and you run `sage -t` on all of Sage, it should warn that the pytest-dependent tests are not run. (Your latest commit does that.)\n\nBut it should probably not warn if a user invokes `sage -t` on a part of Sage that does not use pytest yet -- to be less annoying.",
    "created_at": "2020-12-26T19:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440628",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:13 gh-tobiasdiez]:
> What advantages do you see of using a custom heuristic beforehand?

When pytest is not installed and you run `sage -t` on all of Sage, it should warn that the pytest-dependent tests are not run. (Your latest commit does that.)

But it should probably not warn if a user invokes `sage -t` on a part of Sage that does not use pytest yet -- to be less annoying.



---

archive/issue_comments_440629.json:
```json
{
    "body": "Shouldn't `test_sage_unittest_testsuite` be provided by something more general than `GenericBackendTests`? (in other words, should `GenericBackendTests` not derive from some other class?)",
    "created_at": "2020-12-26T19:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440629",
    "user": "https://github.com/mkoeppe"
}
```

Shouldn't `test_sage_unittest_testsuite` be provided by something more general than `GenericBackendTests`? (in other words, should `GenericBackendTests` not derive from some other class?)



---

archive/issue_comments_440630.json:
```json
{
    "body": "Replying to [comment:15 mkoeppe]:\n> Shouldn't `test_sage_unittest_testsuite` be provided by something more general than `GenericBackendTests`? (in other words, should `GenericBackendTests` not derive from some other class?)\n\nGood idea for later purposes. However, it doesn't remove the test_sage_unittest_testsuite method in GenericBackendTests since all backend tests ignore test_pickling, so this still has to be done there.",
    "created_at": "2020-12-26T20:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440630",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:15 mkoeppe]:
> Shouldn't `test_sage_unittest_testsuite` be provided by something more general than `GenericBackendTests`? (in other words, should `GenericBackendTests` not derive from some other class?)

Good idea for later purposes. However, it doesn't remove the test_sage_unittest_testsuite method in GenericBackendTests since all backend tests ignore test_pickling, so this still has to be done there.



---

archive/issue_comments_440631.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-26T20:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440631",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440632.json:
```json
{
    "body": "Great. Could you add a docstring for `test_sage_unittest_testsuite` to explain that \"subclasses can override this method if they need to skip some tests\".\n\nWe should also clarify whether `..._test.py` should be exempt from our rule that every function needs a docstring and a doctest. If so, probably the patchbot will need some adjustments so it will not complain.",
    "created_at": "2020-12-27T03:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440632",
    "user": "https://github.com/mkoeppe"
}
```

Great. Could you add a docstring for `test_sage_unittest_testsuite` to explain that "subclasses can override this method if they need to skip some tests".

We should also clarify whether `..._test.py` should be exempt from our rule that every function needs a docstring and a doctest. If so, probably the patchbot will need some adjustments so it will not complain.



---

archive/issue_comments_440633.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-27T09:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440633",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440634.json:
```json
{
    "body": "Replying to [comment:18 mkoeppe]:\n> We should also clarify whether `..._test.py` should be exempt from our rule that every function needs a docstring and a doctest. If so, probably the patchbot will need some adjustments so it will not complain.\n> \nThat's a good idea. Tests indeed usually don't have docstrings (because they are only supposed to test one thing, which can be described by the name of the test method).\n\nI think we also should fix our convention concerning the naming of the test files. There are three possibilities:\n\n- `object_test.py` in the same folder as the module `object.py` (advantage: group test with object)\n- `test_object.py` in the same folder as the module `object.py` (advantage: group tests)\n- either of the above but in a new `test` folder (advantage: clear separation of tests and source)",
    "created_at": "2020-12-27T09:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440634",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:18 mkoeppe]:
> We should also clarify whether `..._test.py` should be exempt from our rule that every function needs a docstring and a doctest. If so, probably the patchbot will need some adjustments so it will not complain.
> 
That's a good idea. Tests indeed usually don't have docstrings (because they are only supposed to test one thing, which can be described by the name of the test method).

I think we also should fix our convention concerning the naming of the test files. There are three possibilities:

- `object_test.py` in the same folder as the module `object.py` (advantage: group test with object)
- `test_object.py` in the same folder as the module `object.py` (advantage: group tests)
- either of the above but in a new `test` folder (advantage: clear separation of tests and source)



---

archive/issue_comments_440635.json:
```json
{
    "body": "I have a strong preference for the first option, `object_test.py` in the same folder... because somehow it is the closest to our current practice of keeping tests as close as possible to the module.",
    "created_at": "2020-12-27T17:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440635",
    "user": "https://github.com/mkoeppe"
}
```

I have a strong preference for the first option, `object_test.py` in the same folder... because somehow it is the closest to our current practice of keeping tests as close as possible to the module.



---

archive/issue_comments_440636.json:
```json
{
    "body": "Ok, I've added this convention to #31003.",
    "created_at": "2020-12-27T18:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440636",
    "user": "https://github.com/tobiasdiez"
}
```

Ok, I've added this convention to #31003.



---

archive/issue_comments_440637.json:
```json
{
    "body": "This and #31003 still need review.",
    "created_at": "2021-01-15T12:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440637",
    "user": "https://github.com/tobiasdiez"
}
```

This and #31003 still need review.



---

archive/issue_comments_440638.json:
```json
{
    "body": "Matthias, do you encounter the same cython module issue if you run `sage-runtests` from this branch (you can exit the normal doctests with Ctrl+C)?",
    "created_at": "2021-01-23T23:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440638",
    "user": "https://github.com/tobiasdiez"
}
```

Matthias, do you encounter the same cython module issue if you run `sage-runtests` from this branch (you can exit the normal doctests with Ctrl+C)?



---

archive/issue_comments_440639.json:
```json
{
    "body": "Yes\n\n```\n(sage-sh) mkoeppe@egret:worktree-algebraic-2018-spring$ pytest src\n=========================================================================== test session starts ===========================================================================\nplatform darwin -- Python 3.9.1, pytest-6.2.1, py-1.10.0, pluggy-0.13.1\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src\ncollected 0 items / 8 errors                                                                                                                                              \n\n================================================================================= ERRORS ==================================================================================\n_____________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py _____________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/cvxopt_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/numerical/backends/cvxopt_backend_test.py:2: in <module>\n    from sage.numerical.backends.generic_backend_test import GenericBackendTests\nsrc/sage/numerical/backends/generic_backend_test.py:2: in <module>\n    from .generic_backend import GenericBackend\nE   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'\n____________________________________________________ ERROR collecting sage/numerical/backends/generic_backend_test.py _____________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/generic_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/numerical/backends/generic_backend_test.py:2: in <module>\n    from .generic_backend import GenericBackend\nE   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'\n______________________________________________________ ERROR collecting sage/numerical/backends/glpk_backend_test.py ______________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/numerical/backends/glpk_backend_test.py:2: in <module>\n    from sage.numerical.backends.generic_backend_test import GenericBackendTests\nsrc/sage/numerical/backends/generic_backend_test.py:2: in <module>\n    from .generic_backend import GenericBackend\nE   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'\n___________________________________________________ ERROR collecting sage/numerical/backends/glpk_exact_backend_test.py ___________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_exact_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/numerical/backends/glpk_exact_backend_test.py:2: in <module>\n    from sage.numerical.backends.generic_backend_test import GenericBackendTests\nsrc/sage/numerical/backends/generic_backend_test.py:2: in <module>\n    from .generic_backend import GenericBackend\nE   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'\n_________________________________________________ ERROR collecting sage/numerical/backends/interactivelp_backend_test.py __________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/interactivelp_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/numerical/backends/interactivelp_backend_test.py:2: in <module>\n    from sage.numerical.backends.generic_backend_test import GenericBackendTests\nsrc/sage/numerical/backends/generic_backend_test.py:2: in <module>\n    from .generic_backend import GenericBackend\nE   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'\n______________________________________________________ ERROR collecting sage/numerical/backends/ppl_backend_test.py _______________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/ppl_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/numerical/backends/ppl_backend_test.py:2: in <module>\n    from sage.numerical.backends.generic_backend_test import GenericBackendTests\nsrc/sage/numerical/backends/generic_backend_test.py:2: in <module>\n    from .generic_backend import GenericBackend\nE   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'\n___________________________________________________________ ERROR collecting sage/structure/sage_object_test.py ___________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/structure/sage_object_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/structure/__init__.py:2: in <module>\n    import sage.structure.element\nE   ModuleNotFoundError: No module named 'sage.structure.element'\n_____________________________________________________________ ERROR collecting sage/tests/deprecation_test.py _____________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/tests/deprecation_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/tests/deprecation_test.py:12: in <module>\n    from sage.misc.superseded import deprecated_function_alias\nsrc/sage/misc/superseded.py:29: in <module>\n    from sage.misc.lazy_attribute import lazy_attribute\nE   ModuleNotFoundError: No module named 'sage.misc.lazy_attribute'\n========================================================================= short test summary info =========================================================================\nERROR src/sage/numerical/backends/cvxopt_backend_test.py\nERROR src/sage/numerical/backends/generic_backend_test.py\nERROR src/sage/numerical/backends/glpk_backend_test.py\nERROR src/sage/numerical/backends/glpk_exact_backend_test.py\nERROR src/sage/numerical/backends/interactivelp_backend_test.py\nERROR src/sage/numerical/backends/ppl_backend_test.py\nERROR src/sage/structure/sage_object_test.py\nERROR src/sage/tests/deprecation_test.py\n```\n",
    "created_at": "2021-01-24T01:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440639",
    "user": "https://github.com/mkoeppe"
}
```

Yes

```
(sage-sh) mkoeppe@egret:worktree-algebraic-2018-spring$ pytest src
=========================================================================== test session starts ===========================================================================
platform darwin -- Python 3.9.1, pytest-6.2.1, py-1.10.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src
collected 0 items / 8 errors                                                                                                                                              

================================================================================= ERRORS ==================================================================================
_____________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py _____________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/cvxopt_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/cvxopt_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
____________________________________________________ ERROR collecting sage/numerical/backends/generic_backend_test.py _____________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/generic_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
______________________________________________________ ERROR collecting sage/numerical/backends/glpk_backend_test.py ______________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/glpk_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
___________________________________________________ ERROR collecting sage/numerical/backends/glpk_exact_backend_test.py ___________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_exact_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/glpk_exact_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
_________________________________________________ ERROR collecting sage/numerical/backends/interactivelp_backend_test.py __________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/interactivelp_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/interactivelp_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
______________________________________________________ ERROR collecting sage/numerical/backends/ppl_backend_test.py _______________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/ppl_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/numerical/backends/ppl_backend_test.py:2: in <module>
    from sage.numerical.backends.generic_backend_test import GenericBackendTests
src/sage/numerical/backends/generic_backend_test.py:2: in <module>
    from .generic_backend import GenericBackend
E   ModuleNotFoundError: No module named 'sage.numerical.backends.generic_backend'
___________________________________________________________ ERROR collecting sage/structure/sage_object_test.py ___________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/structure/__init__.py:2: in <module>
    import sage.structure.element
E   ModuleNotFoundError: No module named 'sage.structure.element'
_____________________________________________________________ ERROR collecting sage/tests/deprecation_test.py _____________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/tests/deprecation_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/tests/deprecation_test.py:12: in <module>
    from sage.misc.superseded import deprecated_function_alias
src/sage/misc/superseded.py:29: in <module>
    from sage.misc.lazy_attribute import lazy_attribute
E   ModuleNotFoundError: No module named 'sage.misc.lazy_attribute'
========================================================================= short test summary info =========================================================================
ERROR src/sage/numerical/backends/cvxopt_backend_test.py
ERROR src/sage/numerical/backends/generic_backend_test.py
ERROR src/sage/numerical/backends/glpk_backend_test.py
ERROR src/sage/numerical/backends/glpk_exact_backend_test.py
ERROR src/sage/numerical/backends/interactivelp_backend_test.py
ERROR src/sage/numerical/backends/ppl_backend_test.py
ERROR src/sage/structure/sage_object_test.py
ERROR src/sage/tests/deprecation_test.py
```




---

archive/issue_comments_440640.json:
```json
{
    "body": "Running `pytest` directly only works if you have an editable install, so that's not a surprise. But does it work if you run `sage-runtests` which now invokes pytest (using python code). From what I read, this should work.",
    "created_at": "2021-01-24T12:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440640",
    "user": "https://github.com/tobiasdiez"
}
```

Running `pytest` directly only works if you have an editable install, so that's not a surprise. But does it work if you run `sage-runtests` which now invokes pytest (using python code). From what I read, this should work.



---

archive/issue_comments_440641.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-24T18:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440641",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440642.json:
```json
{
    "body": "Sorry, I missed that.\n\n\n```\n$ ./sage -tp src/sage/numerical/backends/\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-01-24-10-26-16-7200536b.\nUsing --optional=build,ccache,dochtml,homebrew,pip,saclib,sage,sage_spkg\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 25 files using 8 threads.\nsage -t --random-seed=0 src/sage/numerical/backends/interactivelp_backend.pxd\n    [0 tests, 0.00 s]\n[...]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 4.4 seconds\n    cpu time: 7.3 seconds\n    cumulative wall time: 12.9 seconds\n=========================================================================== test session starts ===========================================================================\nplatform darwin -- Python 3.9.1, pytest-6.2.1, py-1.10.0, pluggy-0.13.1\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src, configfile: tox.ini\ncollected 0 items / 6 errors                                                                                                                                              \n\n================================================================================= ERRORS ==================================================================================\n_____________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py _____________________________________________________\n/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:986: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:680: in _load_unlocked\n    ???\nlocal/lib/python3.9/site-packages/_pytest/assertion/rewrite.py:170: in exec_module\n    exec(co, module.__dict__)\nlocal/lib/python3.9/site-packages/sage/numerical/backends/cvxopt_backend_test.py:6: in <module>\n    class TestCVXOPTBackend(GenericBackendTests):\nlocal/lib/python3.9/site-packages/sage/numerical/backends/cvxopt_backend_test.py:12: in TestCVXOPTBackend\n    def test_sage_unittest_testsuite(self, sage_object: SageObject):\nE   NameError: name 'SageObject' is not defined\n____________________________________________________ ERROR collecting sage/numerical/backends/generic_backend_test.py _____________________________________________________\nimport file mismatch:\nimported module 'sage.numerical.backends.generic_backend_test' has this __file__ attribute:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/generic_backend_test.py\nwhich is not the same as the test file we want to collect:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/generic_backend_test.py\nHINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules\n______________________________________________________ ERROR collecting sage/numerical/backends/glpk_backend_test.py ______________________________________________________\nimport file mismatch:\nimported module 'sage.numerical.backends.glpk_backend_test' has this __file__ attribute:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/glpk_backend_test.py\nwhich is not the same as the test file we want to collect:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_backend_test.py\nHINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules\n___________________________________________________ ERROR collecting sage/numerical/backends/glpk_exact_backend_test.py ___________________________________________________\nimport file mismatch:\nimported module 'sage.numerical.backends.glpk_exact_backend_test' has this __file__ attribute:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/glpk_exact_backend_test.py\nwhich is not the same as the test file we want to collect:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_exact_backend_test.py\nHINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules\n_________________________________________________ ERROR collecting sage/numerical/backends/interactivelp_backend_test.py __________________________________________________\nimport file mismatch:\nimported module 'sage.numerical.backends.interactivelp_backend_test' has this __file__ attribute:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/interactivelp_backend_test.py\nwhich is not the same as the test file we want to collect:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/interactivelp_backend_test.py\nHINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules\n______________________________________________________ ERROR collecting sage/numerical/backends/ppl_backend_test.py _______________________________________________________\nimport file mismatch:\nimported module 'sage.numerical.backends.ppl_backend_test' has this __file__ attribute:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/ppl_backend_test.py\nwhich is not the same as the test file we want to collect:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/ppl_backend_test.py\nHINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules\n========================================================================= short test summary info =========================================================================\nERROR src/sage/numerical/backends/cvxopt_backend_test.py - NameError: name 'SageObject' is not defined\nERROR src/sage/numerical/backends/generic_backend_test.py\nERROR src/sage/numerical/backends/glpk_backend_test.py\nERROR src/sage/numerical/backends/glpk_exact_backend_test.py\nERROR src/sage/numerical/backends/interactivelp_backend_test.py\nERROR src/sage/numerical/backends/ppl_backend_test.py\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 6 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n============================================================================ 6 errors in 0.55s ============================================================================\n```\n",
    "created_at": "2021-01-24T18:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440642",
    "user": "https://github.com/mkoeppe"
}
```

Sorry, I missed that.


```
$ ./sage -tp src/sage/numerical/backends/
too many failed tests, not using stored timings
Running doctests with ID 2021-01-24-10-26-16-7200536b.
Using --optional=build,ccache,dochtml,homebrew,pip,saclib,sage,sage_spkg
Sorting sources by runtime so that slower doctests are run first....
Doctesting 25 files using 8 threads.
sage -t --random-seed=0 src/sage/numerical/backends/interactivelp_backend.pxd
    [0 tests, 0.00 s]
[...]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.4 seconds
    cpu time: 7.3 seconds
    cumulative wall time: 12.9 seconds
=========================================================================== test session starts ===========================================================================
platform darwin -- Python 3.9.1, pytest-6.2.1, py-1.10.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src, configfile: tox.ini
collected 0 items / 6 errors                                                                                                                                              

================================================================================= ERRORS ==================================================================================
_____________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py _____________________________________________________
/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:986: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:680: in _load_unlocked
    ???
local/lib/python3.9/site-packages/_pytest/assertion/rewrite.py:170: in exec_module
    exec(co, module.__dict__)
local/lib/python3.9/site-packages/sage/numerical/backends/cvxopt_backend_test.py:6: in <module>
    class TestCVXOPTBackend(GenericBackendTests):
local/lib/python3.9/site-packages/sage/numerical/backends/cvxopt_backend_test.py:12: in TestCVXOPTBackend
    def test_sage_unittest_testsuite(self, sage_object: SageObject):
E   NameError: name 'SageObject' is not defined
____________________________________________________ ERROR collecting sage/numerical/backends/generic_backend_test.py _____________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.generic_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/generic_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/generic_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
______________________________________________________ ERROR collecting sage/numerical/backends/glpk_backend_test.py ______________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.glpk_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/glpk_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
___________________________________________________ ERROR collecting sage/numerical/backends/glpk_exact_backend_test.py ___________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.glpk_exact_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/glpk_exact_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/glpk_exact_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
_________________________________________________ ERROR collecting sage/numerical/backends/interactivelp_backend_test.py __________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.interactivelp_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/interactivelp_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/interactivelp_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
______________________________________________________ ERROR collecting sage/numerical/backends/ppl_backend_test.py _______________________________________________________
import file mismatch:
imported module 'sage.numerical.backends.ppl_backend_test' has this __file__ attribute:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/numerical/backends/ppl_backend_test.py
which is not the same as the test file we want to collect:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/numerical/backends/ppl_backend_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
========================================================================= short test summary info =========================================================================
ERROR src/sage/numerical/backends/cvxopt_backend_test.py - NameError: name 'SageObject' is not defined
ERROR src/sage/numerical/backends/generic_backend_test.py
ERROR src/sage/numerical/backends/glpk_backend_test.py
ERROR src/sage/numerical/backends/glpk_exact_backend_test.py
ERROR src/sage/numerical/backends/interactivelp_backend_test.py
ERROR src/sage/numerical/backends/ppl_backend_test.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 6 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================================================ 6 errors in 0.55s ============================================================================
```




---

archive/issue_comments_440643.json:
```json
{
    "body": "Ok, thanks for the feedback. I'll have a look.",
    "created_at": "2021-01-24T18:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440643",
    "user": "https://github.com/tobiasdiez"
}
```

Ok, thanks for the feedback. I'll have a look.



---

archive/issue_comments_440644.json:
```json
{
    "body": "Any progress here? There's some momentum to add more tests to generic_backend, and it would be great if they could be done in the new framework already",
    "created_at": "2021-01-31T22:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440644",
    "user": "https://github.com/mkoeppe"
}
```

Any progress here? There's some momentum to add more tests to generic_backend, and it would be great if they could be done in the new framework already



---

archive/issue_comments_440645.json:
```json
{
    "body": "By default, pytest expects the compiled cython files to be in the same folder (inplace install). To support sage's build system, one needs to modify `sys.path` in the conftest file as shown here: https://stackoverflow.com/questions/20971619/ensuring-py-test-includes-the-application-directory-in-sys-path\nWhat is the correct SAGE_XYZ folder to specify there? SAGE_LOCAL?\n\nMoreover, it could be a problem that the test files are present twice (in local and src), which I think leads to the other errors above. Maybe https://docs.pytest.org/en/stable/pythonpath.html helps.\n\nI will have a look at these things, but it will take some time as I have to destroy my nicely working inplace install for this. Feel free to play around with the above linked code.",
    "created_at": "2021-01-31T23:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440645",
    "user": "https://github.com/tobiasdiez"
}
```

By default, pytest expects the compiled cython files to be in the same folder (inplace install). To support sage's build system, one needs to modify `sys.path` in the conftest file as shown here: https://stackoverflow.com/questions/20971619/ensuring-py-test-includes-the-application-directory-in-sys-path
What is the correct SAGE_XYZ folder to specify there? SAGE_LOCAL?

Moreover, it could be a problem that the test files are present twice (in local and src), which I think leads to the other errors above. Maybe https://docs.pytest.org/en/stable/pythonpath.html helps.

I will have a look at these things, but it will take some time as I have to destroy my nicely working inplace install for this. Feel free to play around with the above linked code.



---

archive/issue_comments_440646.json:
```json
{
    "body": "In an install without pytest, I am getting:\n\n```\n./sage -t src/sage/numerical/backends/\n...\nPytest is not installed, skip checking tests that rely on it.\nTraceback (most recent call last):\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/bin/sage-runtests\", line 196, in <module>\n    sys.exit(exit_code_pytest)\nNameError: name 'exit_code_pytest' is not defined\n```\n",
    "created_at": "2021-02-01T02:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440646",
    "user": "https://github.com/mkoeppe"
}
```

In an install without pytest, I am getting:

```
./sage -t src/sage/numerical/backends/
...
Pytest is not installed, skip checking tests that rely on it.
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/bin/sage-runtests", line 196, in <module>
    sys.exit(exit_code_pytest)
NameError: name 'exit_code_pytest' is not defined
```




---

archive/issue_comments_440647.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-01T02:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440647",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440648.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-01T02:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440648",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440649.json:
```json
{
    "body": "This version works for me",
    "created_at": "2021-02-01T02:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440649",
    "user": "https://github.com/mkoeppe"
}
```

This version works for me



---

archive/issue_comments_440650.json:
```json
{
    "body": "Replying to [comment:30 gh-tobiasdiez]:\n> Maybe https://docs.pytest.org/en/stable/pythonpath.html helps.\n\nYes, it did!",
    "created_at": "2021-02-01T03:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440650",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:30 gh-tobiasdiez]:
> Maybe https://docs.pytest.org/en/stable/pythonpath.html helps.

Yes, it did!



---

archive/issue_comments_440651.json:
```json
{
    "body": "The only remaining problem that I have is that I need to update the 3 standalone packages providing additional backends (https://github.com/mkoeppe/sage-numerical-backends-coin, ...) to also invoke pytest - and to do make sure this does not cause errors on older Sage versions.",
    "created_at": "2021-02-01T03:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440651",
    "user": "https://github.com/mkoeppe"
}
```

The only remaining problem that I have is that I need to update the 3 standalone packages providing additional backends (https://github.com/mkoeppe/sage-numerical-backends-coin, ...) to also invoke pytest - and to do make sure this does not cause errors on older Sage versions.



---

archive/issue_comments_440652.json:
```json
{
    "body": "To keep the work limited, perhaps it's best to keep the old `_test_` methods so that the test coverage of the backend packages is not sacrificed.  We will delete the `_test_` methods later.",
    "created_at": "2021-02-01T03:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440652",
    "user": "https://github.com/mkoeppe"
}
```

To keep the work limited, perhaps it's best to keep the old `_test_` methods so that the test coverage of the backend packages is not sacrificed.  We will delete the `_test_` methods later.



---

archive/issue_comments_440653.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-01T03:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440654.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-01T03:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440654",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440655.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-01T09:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440655",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_440656.json:
```json
{
    "body": "Thanks a lot for having a look at this. Your changes look good to me!",
    "created_at": "2021-02-01T09:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440656",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks a lot for having a look at this. Your changes look good to me!



---

archive/issue_comments_440657.json:
```json
{
    "body": "Adding #30551 as a dependency because of `from __future__ import annotations`. Or can we avoid it?",
    "created_at": "2021-02-01T16:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440657",
    "user": "https://github.com/mkoeppe"
}
```

Adding #30551 as a dependency because of `from __future__ import annotations`. Or can we avoid it?



---

archive/issue_comments_440658.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:30:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440658",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_028305.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:30:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30866#event-28305"
}
```



---

archive/issue_comments_440659.json:
```json
{
    "body": "This seems to break our workflow at https://github.com/flatsurf/e-antic. We are running some [SageMath](SageMath) doctests with `sage-runtests`. The tests all pass and then we see:\n\n```\ncollected 0 items\n\n====================================================== no tests ran in 0.00s ======================================================\n```\n\n\nThe problem is that this now returns with exit code 5, i.e., the CI assumes that the tests have failed.",
    "created_at": "2021-09-20T16:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440659",
    "user": "https://github.com/saraedum"
}
```

This seems to break our workflow at https://github.com/flatsurf/e-antic. We are running some [SageMath](SageMath) doctests with `sage-runtests`. The tests all pass and then we see:

```
collected 0 items

====================================================== no tests ran in 0.00s ======================================================
```


The problem is that this now returns with exit code 5, i.e., the CI assumes that the tests have failed.



---

archive/issue_comments_440660.json:
```json
{
    "body": "A workaround is to drop a `test_nothing.py` file in the directory where the doctests are run:\n\n```\ndef test_nothing():pass\n```\n",
    "created_at": "2021-09-20T16:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440660",
    "user": "https://github.com/saraedum"
}
```

A workaround is to drop a `test_nothing.py` file in the directory where the doctests are run:

```
def test_nothing():pass
```




---

archive/issue_comments_440661.json:
```json
{
    "body": "Help with fixing this properly is welcome. The developer who worked on the pytest stuff has disappeared",
    "created_at": "2021-09-20T16:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440661",
    "user": "https://github.com/mkoeppe"
}
```

Help with fixing this properly is welcome. The developer who worked on the pytest stuff has disappeared



---

archive/issue_comments_440662.json:
```json
{
    "body": "A proper fix would probably be to add an additional if check if the pytest return code is 5 here:\n\n```\n+    if err == 0:\n+        sys.exit(exit_code_pytest)\n+    else:\n+        sys.exit(err)\n```\n\nSee also the discussion in https://github.com/pytest-dev/pytest/issues/2393.\n\nI sadly don't have the time to implement it though.",
    "created_at": "2021-09-21T11:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440662",
    "user": "https://github.com/tobiasdiez"
}
```

A proper fix would probably be to add an additional if check if the pytest return code is 5 here:

```
+    if err == 0:
+        sys.exit(exit_code_pytest)
+    else:
+        sys.exit(err)
```

See also the discussion in https://github.com/pytest-dev/pytest/issues/2393.

I sadly don't have the time to implement it though.



---

archive/issue_comments_440663.json:
```json
{
    "body": "The workaround in #31103#comment:45 does not work if the tested module contains some sage metaclass machinery since pytest is unvoked with `--import-mode importlib`, there is an error because the module is not in `sys.modules` and this confuses `nested_class.pyx`.\n\nIn that case, there is an error and not only an error code 5.\n\n```\n  ==================================== ERRORS ====================================\n  ____________________ ERROR collecting pyflatsurf/vector.py _____________________\n  ../src/pyflatsurf/vector.py:285: in <module>\n      class Vectors(UniqueRepresentation, Parent):\n  sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2314)\n      ???\n  E   KeyError: 'vector'\n```\n",
    "created_at": "2021-11-13T02:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440663",
    "user": "https://github.com/saraedum"
}
```

The workaround in #31103#comment:45 does not work if the tested module contains some sage metaclass machinery since pytest is unvoked with `--import-mode importlib`, there is an error because the module is not in `sys.modules` and this confuses `nested_class.pyx`.

In that case, there is an error and not only an error code 5.

```
  ==================================== ERRORS ====================================
  ____________________ ERROR collecting pyflatsurf/vector.py _____________________
  ../src/pyflatsurf/vector.py:285: in <module>
      class Vectors(UniqueRepresentation, Parent):
  sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2314)
      ???
  E   KeyError: 'vector'
```




---

archive/issue_comments_440664.json:
```json
{
    "body": "Another workaround is to just pretend that pytest is not installed:\n\n\n```\n$ cat no-pytest/pytest.py\nraise ModuleNotFoundError\n$ PYTHONPATH=no-pytest:$PYTHONPATH sage -tp ...\n```\n\n\nBut I actually think we should make this a bit more convenient than having to hack the module search path.",
    "created_at": "2021-11-13T02:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440664",
    "user": "https://github.com/saraedum"
}
```

Another workaround is to just pretend that pytest is not installed:


```
$ cat no-pytest/pytest.py
raise ModuleNotFoundError
$ PYTHONPATH=no-pytest:$PYTHONPATH sage -tp ...
```


But I actually think we should make this a bit more convenient than having to hack the module search path.



---

archive/issue_comments_440665.json:
```json
{
    "body": "I guess the issue with the modules is the same as #31924.",
    "created_at": "2021-11-17T21:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440665",
    "user": "https://github.com/tobiasdiez"
}
```

I guess the issue with the modules is the same as #31924.



---

archive/issue_comments_440666.json:
```json
{
    "body": "And the exit code 5 issue should be fixed with #32892.",
    "created_at": "2021-11-17T21:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30866#issuecomment-440666",
    "user": "https://github.com/tobiasdiez"
}
```

And the exit code 5 issue should be fixed with #32892.
