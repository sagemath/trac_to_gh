# Issue 26503: create a python3 test make target

Issue created by migration from https://trac.sagemath.org/ticket/26740

Original creator: chapoton

Original creation time: 2018-11-22 14:27:29

CC:  jdemeyer tscrim fbissey embray vbraun

to prevent regression by testing submodules already known to be ok.



---

Comment by chapoton created at 2018-11-22 14:28:19

New commits:


---

Comment by chapoton created at 2018-11-22 14:28:19

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-11-22 15:32:49

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-11-22 15:32:49

errors when not using this option..


---

Comment by chapoton created at 2018-11-22 19:34:56

Oh, well, this seems to work correctly. Feedback would be appreciated.


---

Comment by chapoton created at 2018-11-22 19:34:56

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-11-22 20:01:41

I think that's a lofty goal but I have reservations until I understand how it impact and work with distro (like me). What happens when you
hit this section with python2?

```
@@ -690,6 +690,13 @@ class DocTestController(SageObject):
             Doctesting the Sage notebook.
             sage: DC.files[0][-6:]  # py2
             'sagenb'
+
+        ::
+
+            sage: DD = DocTestDefaults(python3 = True)
+            sage: DC = DocTestController(DD, [])
+            sage: DC.add_files()
+            Doctesting modules compatible with Python 3
         """
         opj = os.path.join
         from sage.env import SAGE_SRC, SAGE_DOC_SRC, SAGE_ROOT
```


As a distro with sage installed for python2 and python3 do I have to run something like `S{sage-python3} -t --python3 --long`, but not `--all`, to run the appropriate doctests?


---

Comment by chapoton created at 2018-11-22 20:47:06

There is no reason for you to worry at all. It has no effect on the distro side, as far as I can tell.

This introduces a new option "--python3" when running the doctests. Maybe a better name would be "--python3only" or "--python3-valid-modules-only".

The only effect of using this option is to select a pre-defined list of modules whose doctests will be launched.

If you use the option with sage2, it will just test those files.

If you use this option with sage3, exactly the same.

The crop in your comment just doctests that this option exists and works. It does not launch the associated behaviour.

The goal of this ticket is to allow our release manager to have a builtbot that checks that no regression happens, namely that once a module is ok for python3, it will be checked to remain so.


---

Comment by fbissey created at 2018-11-22 20:50:25

Thank you for taking the time to answer. Just to be sure, I could run the test as I suggested on a distro to check for regression or problem with my distro regarding python3?


---

Comment by chapoton created at 2018-11-23 07:42:15

Right, if you provide sage3 on your distro, you could indeed use this option to check that all these tests do pass as they should.


---

Comment by git created at 2018-11-23 20:24:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-11-26 14:56:43

I don't really see the point.  Just let them fail.  If regressions happen they will usually be small, and will be reduced over time.  Before long hopefully there will, or should, be none, in which case this will be a useless feature.

What I think would be more useful, which is something I _have_ wanted for other purposes as well, is a way to provide `./sage -t -a` a custom list of "known failures" which could be provided on a machine by machine basis (e.g. known failures for a specific platform being tested on).  This could be passed, for example, to any Python 3 builders if you wanted.  It would also be helpful to know when tests that are expected to fail start passing :)


---

Comment by chapoton created at 2018-11-26 15:00:21

The point is to move the responsability of fixing the new failing doctests from me (or should I say us?) to the ticket owners..


---

Comment by embray created at 2018-11-26 15:33:27

I'm not opposed to that of course, but I think a more generic way to list known-failures or exclusions would be better.  This also obviates the need for a special make target since this can just be passed in the `TEST_OPTS` variable.


---

Comment by vbraun created at 2018-11-27 15:19:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-11-27 15:19:20

Being able to pass in a list of known failures might be useful, feel free to open a ticket for that. Until then: The perfect is the enemy of the good.


---

Comment by embray created at 2018-11-27 16:05:41

I disagree--this can very easily be improved.  Just give me a day or two.


---

Comment by embray created at 2018-11-27 16:05:41

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-11-27 16:09:12

All that's required is to remove the "python 3" specific stuff, and change that option to be able to read a list of filenames/directories (possibly optionally from a file as well).  We could even add a file listing known Python 3 failures to the repository which I wouldn't mind, but it's silly to hard-code this when a few small changes can upgrade it to a more generally useful feature that won't just have to be ripped out later when it becomes obsolete.


---

Comment by vbraun created at 2018-11-27 16:15:55

OK, you have 2 days. And make sure that the known python3 failures are in the repo so I don't have to manually maintain them on a dozen buildbots.


---

Comment by embray created at 2018-11-27 16:23:07

I mean, I don't know what you mean by "a dozen buildbots" as that's a setting that can just go in the builder settings for Python 3 builds, which is one place.  The builder settings have to be updated either way.  But I'm happy to maintain a list in the repo for now since they can be scratched off alongside changes that fix them.


---

Comment by vbraun created at 2018-11-27 16:42:11

Thanks, looking forward to having a py3 buildbot...


---

Comment by embray created at 2018-11-28 07:58:18

It occurs to me I initially misread the patch on this ticket--I thought the hard-coded `python3_files` was for some reason a list of known failures to _exclude_, but in fact it's a list of sub-packages that are known passing.  In which case this could have been done without adding anything to the doctest runner.  Rather, just put this list in a file or something and (as a compromise, for simplicity's sake) keep the separate makefile target and do the rough equivalent of `./sage -t --long $(cat list-of-known-passing.txt)`.

However, I still think having the converse--an ability to list known failures--would be very useful in general.


---

Comment by embray created at 2018-11-28 08:05:43

Frédéric, does your list of "known passing" include with flags like `--long`?  Or are we not worrying about that for now?  I'm just curious because I want to see about generating the converse list, of test modules with known failures.


---

Attachment


---

Comment by chapoton created at 2018-11-28 08:24:24

I have attached the list of failing files in 8.5.b5. This is the result of a patchbot run, so it was done with "--long" but not using any other optional option.

*EDIT*:
There is a script attached to #26212 that takes a patchbot log and extract useful information, including the list of failing modules.


---

Comment by embray created at 2018-11-28 08:50:15

Thanks.  Interestingly, I just ran the tests against current develop branch _without_ `--long` and got 309 failing files: more than the log you attached.  Perhaps YMMV depending on your system, or the order in which the test were run.  Still, pretty good!  A lot of progress (~150 more passing) since I last tried.


---

Comment by embray created at 2018-11-28 15:00:13

Please see #26785 and its companion #26784.

One minor concern I have is that because this list of "known failures" is more fine-grained than the list of "expected passes" in this ticket, it could be a little more difficult to manage especially w.r.t. merge conflicts.  I would like to give it a try though.  Merge conflicts shouldn't be too much trouble since we want to mostly be removing lines from the file and never adding them.


---

Comment by chapoton created at 2018-12-03 13:43:16

I am not very happy (for the present task) with the idea that Erik proposed to store a list of failing files. And I dislike even more a list of failing files than a list of failing modules. My only aim here (yes it's scaffolding, but that is useful and can be removed once used) is to prevent regression by using this make target as a lock.

Storing and testing a list of successful python-3 modules has two advantages : it needs much less maintenance work, as it will change less often. And we do not want to run for nothing the doctests that will be failing.

Maybe other opinions would help to arbitrate (`@`jdemeyer, `@`fbissey). If somebody else review #26785 and #26784, I will certainly not object in any manner.


---

Comment by embray created at 2018-12-11 10:05:47

I don't really understand your point--this accomplishes the same purpose.  It's still effectively storing a list of "successful" modules in the form of the list of all tests, minus those that are known failures.

> And we do not want to run for nothing the doctests that will be failing.

It's not for nothing: In fact it can inform you when some files' tests start passing e.g. due to something that was fixed.


---

Comment by embray created at 2018-12-11 10:09:41

I thought I made this point elsewhere, but should add your patch could be implemented as a file like `python3-known-passing.txt`:


```
src/sage/foo
src/sage/bar
src/sage/whatever
...
```



```
$ cat python3-known-passing.txt | xargs ./sage -t --long -p
```


No need for special "hacks".


---

Comment by vbraun created at 2018-12-25 11:30:48

So how about turning your one-liner into a makefile target? Both positive and negative lists can be useful for different use cases...


---

Comment by chapoton created at 2019-01-16 16:36:50

another tentative, as suggested by Erik
----
New commits:


---

Comment by git created at 2019-01-16 16:43:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-01-16 16:43:48

ok, ready for review


---

Comment by chapoton created at 2019-01-16 16:43:48

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-01-16 16:47:20

Why is `python3-known-passing.txt` one long line? Isn't the whole point of `xargs` to support a file with one filename per line?


---

Comment by chapoton created at 2019-01-16 16:53:33

Because this is the (only) way I managed to get it work. If you feel able to do better, please help!


---

Comment by chapoton created at 2019-01-16 16:55:34

it turns out that one can split the lines, coming soon


---

Comment by git created at 2019-01-16 16:58:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-01-16 17:00:29

done. Better like that ?


---

Comment by embray created at 2019-01-16 17:44:49

Just to avoid top-level file proliferation, can this .txt file go in `misc/` or something?


---

Comment by chapoton created at 2019-01-16 19:22:53

Just tell me where exactly I should put that and I will do so..


---

Comment by jhpalmieri created at 2019-01-16 19:39:21

Maybe create a file in `src/ext/doctest/`?


---

Comment by git created at 2019-01-16 19:42:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-16 19:42:42

done, thanks


---

Comment by chapoton created at 2019-01-17 10:13:40

This works well on my usual python3-test machine, where the selected passing doctests are known to pass since many months. Before putting it on a buildbot, could other people please launch the new make target on python3-sage installations on various machines ? We need to see if some failures happen in these modules in other architectures and os.


---

Comment by jhpalmieri created at 2019-01-17 16:31:27

It worked for me on OS X. On some future ticket, we should add a `ptestlong` option.


---

Comment by chapoton created at 2019-01-18 09:04:11

Thanks John. Anybody else ? Maybe we can consider that this is ready for positive review ? Volker, what do you think ?


---

Comment by embray created at 2019-01-18 12:46:02

I literally just meant adding a top-level directory called `misc/`, but either way.


---

Comment by chapoton created at 2019-01-18 12:46:55

would you please try it on Cygwin ?


---

Comment by embray created at 2019-01-18 13:54:00

I would but my Windows machine is currently occupied building the Sage 8.6 release.  I'm not sure it's really needed though: There's nothing very special about Python 2 vs Python 3 on Cygwin that I'm aware of as it pertains to Sage.


---

Comment by jdemeyer created at 2019-01-18 14:00:45

I can test on `ppc64le`


---

Comment by jdemeyer created at 2019-01-18 14:16:25

On `Linux sardonis 4.4.0-141-generic #167-Ubuntu SMP Wed Dec 5 10:33:00 UTC 2018 ppc64le ppc64le ppc64le GNU/Linux`:

```
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 367.5 seconds
    cpu time: 4433.2 seconds
    cumulative wall time: 4408.9 seconds
```



---

Comment by chapoton created at 2019-01-18 15:54:44

Thanks. Would somebody be brave enough to set a positive review ?


---

Comment by vbraun created at 2019-01-18 16:10:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-24 18:17:55

Resolution: fixed
