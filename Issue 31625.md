# Issue 31625: memory leak in prime_range

Issue created by migration from https://trac.sagemath.org/ticket/31862

Original creator: @rarora7777

Original creation time: 2021-05-27 01:45:18

CC:  slelievre

Keywords: memory leak

There seems to be a memory leak in the `prime_range` function. The leak happens regardless of the algorithm used, whether `pari_primes` or `pari_isprime`.


```
import os, psutil
import gc
process = psutil.Process(os.getpid())

# Memory leak in prime_range() function: memory usage grows on every iteration 
# and doesn't free up even after a gc.collect() statement.
for i in range(10):
     pr = prime_range(1000000)
     print(f'{process.memory_info().rss/1e6:.0f} MB')

gc.collect()
print(f'After GC collect: {process.memory_info().rss/1e6:.0f} MB')


# using pari_isprime
for i in range(10):
     pr = prime_range(start=1, stop=1000000, algorithm="pari_isprime")
     print(f'{process.memory_info().rss/1e6:.0f} MB')

gc.collect()
print(f'After GC collect: {process.memory_info().rss/1e6:.0f} MB')
```


Output:

```
257 MB
260 MB
262 MB
265 MB
267 MB
271 MB
272 MB
276 MB
278 MB
281 MB
After GC collect: 281 MB
283 MB
287 MB
288 MB
292 MB
294 MB
297 MB
299 MB
302 MB
304 MB
307 MB
After GC collect: 307 MB
```




---

Comment by alexjbest created at 2021-05-27 06:01:01

I can't reproduce this, which version of Sage/OS are you using? What does it look like if you take i up to 100?


---

Comment by @rarora7777 created at 2021-05-27 13:17:14

I'm using version 9.2 on Windows, the latest release from Github. I'm using Windows 10 Enterprise version 21H1.

The behaviour continues even if I increase the number of iterations to 100 or 1000.


---

Comment by edgarcosta created at 2021-06-04 14:53:27

I also couldn't reproduce this.
I took it up to 500 on OSX with

```
i=0 221 MB
i=1 221 MB
i=2 221 MB
i=3 221 MB
i=4 222 MB
...
i=71 223 MB 
... (and then oscillates between 222 and 223)
i=93 223 MB
...
i=95 223 MB
... (and then oscillates between 223 and 224)
i=412 224 MB
...
i=499 224 MB
185
After GC collect: 224 MB
i = 0 224 MB
i = 1 223 MB
...
i = 499 223 MB
0
After GC collect: 223 MB
```



---

Comment by @rarora7777 created at 2021-06-04 15:25:24

Thanks for testing. It definitely seems OS-specific, then. I tried on a couple of different Windows computers and observed the leak. On the other hand, I **did not** observe a leak on my WSL-based Ubuntu setup.


---

Comment by slelievre created at 2021-06-04 15:53:48

Changing keywords from "memory leak" to "memory leak, cygwin".
