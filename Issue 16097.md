# Issue 16097: Toric divisors from fans in sublattices

archive/issues_016097.json:
```json
{
    "body": "CC:  @vbraun @novoselt jakobkroeker\n\nKeywords: toric\n\nCurrently, there's a problem with toric divisors of toric varieties created from fans that live in a sublattice.\n\nThe following examples illustrates that:\n\n```\nsage: N = ToricLattice(3)\nsage: S = N.submodule([(1,0,0), (0, 1, 0)])\nsage: cones = [Cone([B[0], B[1]]), Cone([B[1], -B[0]-B[1]]), Cone([-B[0]-B[1], B[0]])]\nsage: f = Fan(cones)\nsage: X = ToricVariety(f)\nsage: X.is_complete()\nTrue\nThe empty polyhedron in QQ^3\nsage: (-X.K()).polyhedron()\nA 3-dimensional polyhedron in QQ^3 defined as the convex hull of 3 vertices and 1 line\n```\n\nHowever, the real polyhedron should be a two-dimensional compact polygon:\n\n```\nsage: (-toric_varieties.P(2).K()).polyhedron()\nA 2-dimensional polyhedron in QQ^2 defined as the convex hull of 3 vertices\n```\n\n\nI'll attach a branch with a fix soon.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16334\n\n",
    "created_at": "2014-05-12T12:07:26Z",
    "labels": [
        "algebraic geometry",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Toric divisors from fans in sublattices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16097",
    "user": "jkeitel"
}
```
CC:  @vbraun @novoselt jakobkroeker

Keywords: toric

Currently, there's a problem with toric divisors of toric varieties created from fans that live in a sublattice.

The following examples illustrates that:

```
sage: N = ToricLattice(3)
sage: S = N.submodule([(1,0,0), (0, 1, 0)])
sage: cones = [Cone([B[0], B[1]]), Cone([B[1], -B[0]-B[1]]), Cone([-B[0]-B[1], B[0]])]
sage: f = Fan(cones)
sage: X = ToricVariety(f)
sage: X.is_complete()
True
The empty polyhedron in QQ^3
sage: (-X.K()).polyhedron()
A 3-dimensional polyhedron in QQ^3 defined as the convex hull of 3 vertices and 1 line
```

However, the real polyhedron should be a two-dimensional compact polygon:

```
sage: (-toric_varieties.P(2).K()).polyhedron()
A 2-dimensional polyhedron in QQ^2 defined as the convex hull of 3 vertices
```


I'll attach a branch with a fix soon.

Issue created by migration from https://trac.sagemath.org/ticket/16334





---

archive/issue_comments_209929.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-12T12:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209929",
    "user": "jkeitel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_209930.json:
```json
{
    "body": "Alright, here's a short patch that fixes the problem. I don't know whether it's the best way of working around this, but it's simple and does the trick.\n\nVolker, could you have a look? :)",
    "created_at": "2014-05-12T12:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209930",
    "user": "jkeitel"
}
```

Alright, here's a short patch that fixes the problem. I don't know whether it's the best way of working around this, but it's simple and does the trick.

Volker, could you have a look? :)



---

archive/issue_comments_209931.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-05-12T12:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209931",
    "user": "jkeitel"
}
```

New commits:



---

archive/issue_comments_209932.json:
```json
{
    "body": "I am confused - the polyhedron of the toric variety whose fan is in the lattice N lives in the dual lattice M, why is it intersected with the sublattice where the fan lives?",
    "created_at": "2014-05-12T22:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209932",
    "user": "@novoselt"
}
```

I am confused - the polyhedron of the toric variety whose fan is in the lattice N lives in the dual lattice M, why is it intersected with the sublattice where the fan lives?



---

archive/issue_comments_209933.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-13T08:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209933",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_209934.json:
```json
{
    "body": "Hi Andrey,\n\nthanks for having a look at this. You're of course right.\nI've changed the code and am now using a doctest that would give an incorrect result for the previous patch.\n\nBest,\nJan",
    "created_at": "2014-05-13T08:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209934",
    "user": "jkeitel"
}
```

Hi Andrey,

thanks for having a look at this. You're of course right.
I've changed the code and am now using a doctest that would give an incorrect result for the previous patch.

Best,
Jan



---

archive/issue_comments_209935.json:
```json
{
    "body": "Looks good to me... Andrey, any further thoughts?",
    "created_at": "2014-05-13T08:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209935",
    "user": "@vbraun"
}
```

Looks good to me... Andrey, any further thoughts?



---

archive/issue_comments_209936.json:
```json
{
    "body": "I think this polyhedron should live in the `fan.dual_lattice()`, so instead of lifting the generators and taking the intersection with their span (which is something pretty random), the correct approach is to push previously used inequalities into this dual lattice (which is a quotient, so has smaller dimension).",
    "created_at": "2014-05-13T18:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209936",
    "user": "@novoselt"
}
```

I think this polyhedron should live in the `fan.dual_lattice()`, so instead of lifting the generators and taking the intersection with their span (which is something pretty random), the correct approach is to push previously used inequalities into this dual lattice (which is a quotient, so has smaller dimension).



---

archive/issue_comments_209937.json:
```json
{
    "body": "Okay, if I understand you correctly, that's actually quite easy to realise. I have a patch that does this and I'll push it tomorrow when I'm back at the institute.",
    "created_at": "2014-05-13T21:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209937",
    "user": "jkeitel"
}
```

Okay, if I understand you correctly, that's actually quite easy to realise. I have a patch that does this and I'll push it tomorrow when I'm back at the institute.



---

archive/issue_comments_209938.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-19T16:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209938",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_209939.json:
```json
{
    "body": "Sorry, it took a bit longer because something else came up. The newest change tries to do what you just suggested, but since polyhedra corresponding to divisors do not necessarily have to be lattice polytopes, it looks a bit clumsy. Could you have a look and check whether there's a nicer way of doing it?\n\nBest, Jan",
    "created_at": "2014-05-19T16:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209939",
    "user": "jkeitel"
}
```

Sorry, it took a bit longer because something else came up. The newest change tries to do what you just suggested, but since polyhedra corresponding to divisors do not necessarily have to be lattice polytopes, it looks a bit clumsy. Could you have a look and check whether there's a nicer way of doing it?

Best, Jan



---

archive/issue_comments_209940.json:
```json
{
    "body": "Unfortunately, the diff on trac seems to be broken. Something else has come up and I'm not sure what to do about it.\n\nConsider the following:\n\n```\nsage: N = ToricLattice(4)\nsage: S = N.submodule([(1,0,0,0), (0,1,0,0)])\nsage: B = S.basis()\nsage: S.dual()\n2-d lattice, quotient of 4-d lattice M by Sublattice <M(0, 0, 1, 0), M(0, 0, 0, 1)>\nsage: S.dual().gens()\n(M[0, 1, 0, 0], M[1, 0, 0, 0])\nsage: S.gens()\n(N(1, 0, 0, 0), N(0, 1, 0, 0))\n```\n\nUsually, we have that `i`th generator of a lattice is 'dual' (don't know whether that's the right adjective) to the `i`th generator of the dual lattice. Here, however, there is an additional reordering going on.\n\nAs a consequence, we have the following behavior:\n\n```\nsage: cones = [Cone([B[0], B[1]]), Cone([B[1], -3*B[0]-2*B[1]]), Cone([-3*B[0]-2*B[1], B[0]])]\nsage: X = ToricVariety(Fan(cones))\nsage: p = (-X.K()).polyhedron(); p\nA 2-dimensional polyhedron in QQ^2 defined as the convex hull of 3 vertices\nsage: p.integral_points()\n((-1, -1), (-1, 0), (-1, 1), (-1, 2), (0, -1), (0, 0), (1, -1))\nsage: (-X.K()).sections()\n(M[-1, -1, 0, 0],\n M[0, -1, 0, 0],\n M[1, -1, 0, 0],\n M[2, -1, 0, 0],\n M[-1, 0, 0, 0],\n M[0, 0, 0, 0],\n M[-1, 1, 0, 0])\n```\n\nwhich leads directly to this (obviously incorrect, see the `z1^-3`) output:\n\n```\nsage: (-X.K()).sections_monomials()\n(z1^6, z0*z1^3, z0^2, z0^3/z1^3, z1^4*z2, z0*z1*z2, z1^2*z2^2)\n```\n\n\nWhat should be changed? Finding the generators of a dual of a lattice? The polyhedron method of the divisor? The monomial method of the divisor?",
    "created_at": "2014-06-16T09:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209940",
    "user": "jkeitel"
}
```

Unfortunately, the diff on trac seems to be broken. Something else has come up and I'm not sure what to do about it.

Consider the following:

```
sage: N = ToricLattice(4)
sage: S = N.submodule([(1,0,0,0), (0,1,0,0)])
sage: B = S.basis()
sage: S.dual()
2-d lattice, quotient of 4-d lattice M by Sublattice <M(0, 0, 1, 0), M(0, 0, 0, 1)>
sage: S.dual().gens()
(M[0, 1, 0, 0], M[1, 0, 0, 0])
sage: S.gens()
(N(1, 0, 0, 0), N(0, 1, 0, 0))
```

Usually, we have that `i`th generator of a lattice is 'dual' (don't know whether that's the right adjective) to the `i`th generator of the dual lattice. Here, however, there is an additional reordering going on.

As a consequence, we have the following behavior:

```
sage: cones = [Cone([B[0], B[1]]), Cone([B[1], -3*B[0]-2*B[1]]), Cone([-3*B[0]-2*B[1], B[0]])]
sage: X = ToricVariety(Fan(cones))
sage: p = (-X.K()).polyhedron(); p
A 2-dimensional polyhedron in QQ^2 defined as the convex hull of 3 vertices
sage: p.integral_points()
((-1, -1), (-1, 0), (-1, 1), (-1, 2), (0, -1), (0, 0), (1, -1))
sage: (-X.K()).sections()
(M[-1, -1, 0, 0],
 M[0, -1, 0, 0],
 M[1, -1, 0, 0],
 M[2, -1, 0, 0],
 M[-1, 0, 0, 0],
 M[0, 0, 0, 0],
 M[-1, 1, 0, 0])
```

which leads directly to this (obviously incorrect, see the `z1^-3`) output:

```
sage: (-X.K()).sections_monomials()
(z1^6, z0*z1^3, z0^2, z0^3/z1^3, z1^4*z2, z0*z1*z2, z1^2*z2^2)
```


What should be changed? Finding the generators of a dual of a lattice? The polyhedron method of the divisor? The monomial method of the divisor?



---

archive/issue_comments_209941.json:
```json
{
    "body": "Just reordering may not be sufficient in more complicated examples.\n\nI think the assumption is that pairing between dual lattices is the \"usual dot product\", i.e. sum of products of corresponding components. If this is not the case for a particular representation, then everything will go wrong. Solutions are to either set generators of the dual upon construction correctly or set the pairing properly. Given that * is natural for pairing, it may be a bit counterintuitive to have `M(1,0) * N(0,1) == 1`, so forcing a correct basis seems like a better option.",
    "created_at": "2014-06-17T02:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209941",
    "user": "@novoselt"
}
```

Just reordering may not be sufficient in more complicated examples.

I think the assumption is that pairing between dual lattices is the "usual dot product", i.e. sum of products of corresponding components. If this is not the case for a particular representation, then everything will go wrong. Solutions are to either set generators of the dual upon construction correctly or set the pairing properly. Given that * is natural for pairing, it may be a bit counterintuitive to have `M(1,0) * N(0,1) == 1`, so forcing a correct basis seems like a better option.



---

archive/issue_comments_209942.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-06-17T06:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16097#issuecomment-209942",
    "user": "jkeitel"
}
```

Changing status from needs_review to needs_work.
