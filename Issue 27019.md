# Issue 27019: Re-enable USE_TLS=1 when building OpenBLAS SPKG

Issue created by migration from https://trac.sagemath.org/ticket/27256

Original creator: embray

Original creation time: 2019-02-11 20:37:16

OpenBLAS has a flag that can be passed at build time called `USE_TLS`.

This enables or disables an "experimental" feature which makes some changes to memory allocation models for multi-threaded code, where previously threads had to share some global data structures related to memory allocation that were protected by locks.  With `USE_TLS=1` a different data structure is used such that thread-specific data is stored in thread-local storage, rather than global variables.  This seems (unsurprisingly) to introduce some performance benefits in many cases, though the details are a bit vague.

In OpenBLAS v0.3.3 this feature was enabled by default, and to my knowledge did not cause any problems.  However, in v0.3.5 it's now disabled by default.

I would suggest that we re-enable it, until and unless it is known to cause any problems.  And incidentally, so-doing would fix #27213, which was caused by code paths that are only compiled if `USE_TLS=0`.   The alternative fix to #27213 would be to apply a patch, but I think it would be better to go ahead and re-enable this flag, since it purportedly has performance benefits, and no downside that we currently know of.


---

Comment by embray created at 2019-02-18 11:27:20

Confirmed that this fixes #27213.  It should have no (known) detriment on other platforms we support, since this option was the _default_ on OpenBLAS 0.3.3.
----
New commits:


---

Comment by embray created at 2019-02-18 11:27:20

Changing status from new to needs_review.


---

Comment by fbissey created at 2019-02-18 19:23:32

Hopefully they have really fixed that code path on all platforms. This was the stuff that was causing error about not being able to allocate more thread or something. There was a problem with how they were counting threads.


---

Comment by embray created at 2019-02-20 13:19:20

Replying to [comment:2 fbissey]:
> Hopefully they have really fixed that code path on all platforms. This was the stuff that was causing error about not being able to allocate more thread or something. There was a problem with how they were counting threads.

Could you be more specific? I'm not sure exactly what you're referring to or on what platform.

FWIW this is the PR to fix it.  The problem affected a lot of things beyond just Cygwin, badly enough that I think there should be an 0.3.6 release, with 0.3.5 marked as verboten: https://github.com/xianyi/OpenBLAS/pull/2004/files


---

Comment by fbissey created at 2019-02-20 18:07:09

I'll just refer to the release notes for openblas-0.3.3

```
thread memory allocation has been switched back to the method
used before version 0.3.1 due to unexpected problems caused by
the new code under some circumstances. A new compile-time option
USE_TLS has been added to allow enabling the new code instead,
and it is hoped that this can become the default again in the next version.
```

There was a number of reports that forced this switch back and it is still not the default as of 0.3.5. However I am ok with it if you think it is safe and the bots are OK.


---

Comment by embray created at 2019-02-21 10:31:47

Well, all I can say is that in 0.3.3 `USE_TLS=1` _was_ the default, and was working fine as far as I know.  Obviously if there is some specific report of a problem that can be attributed to it that's different, but I don't know of any.


---

Comment by fbissey created at 2019-02-24 02:44:38

Let's just go ahead with it. If there is a problem we'll know soon enough.


---

Comment by fbissey created at 2019-02-24 02:44:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-25 18:52:49

Resolution: fixed


---

Comment by embray created at 2019-03-19 12:21:54

Follow-up in #27438 without which this is broken.
