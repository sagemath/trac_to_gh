# Issue 10358: Let PIL search '.../lib64' directories for optional libraries if appropriate

Issue created by migration from https://trac.sagemath.org/ticket/10359

Original creator: leif

Original creation time: 2010-12-01 03:51:50

Assignee: tbd

CC:  koen mpatel jdemeyer hivert vbraun

Keywords: Python Imaging libary JPEG TIFF PNG

PIL fails to find optional (system) libraries on Linux systems where e.g. `/usr/lib64` is *not* a symbolic link to `/usr/lib`. This is the case on e.g. 64-bit Fedora, CentOS and openSUSE systems.

[Reported by Koen](http://trac.sagemath.org/sage_trac/ticket/9864#comment:34):
  _I'm having issues with PIL 1.1.6.p2 (the release version) not finding its JPEG libraries. These are located in /usr/lib64 on CentOS 5.5 / OpenSuse, however the default library path only considers /usr/lib. Adding /usr/lib64 as a library path fixes the problem in my stand-alone PIL build. I'm not quite sure how to patch the setup.py in SAGE to add this path by default._


---

Comment by leif created at 2010-12-01 06:08:02

SPKG patch to get the p4 from the p3 (from #9864). For reference / review.


---

Comment by leif created at 2010-12-01 06:17:09

Changing status from new to needs_review.


---

Attachment

*New spkg: http://spkg-upload.googlecode.com/files/pil-1.1.6.p4.spkg*

*md5sum:* `73c8f01c0cd6923f7636147b350a6c70  pil-1.1.6.p4.spkg`


---

Comment by leif created at 2010-12-01 06:33:44

For convenience, here's the new, second patch we now apply to `setup.py`:

```patch
diff -Nur src-dont-add-system-libs-if-binary-build/setup.py src-search-lib64-dirs-if-appropriate/setup.py
--- src-dont-add-system-libs-if-binary-build/setup.py	2010-12-01 05:02:59.000000000 +0100
+++ src-search-lib64-dirs-if-appropriate/setup.py	2010-12-01 06:16:25.000000000 +0100
@@ -34,12 +34,12 @@
 #
 # TIFF_ROOT = libinclude("/opt/tiff")
 
-SAGE_BINARY_BUILD = False
-if 'SAGE_BINARY_BUILD' in os.environ and os.environ['SAGE_BINARY_BUILD'] == 'yes':
-    SAGE_BINARY_BUILD = True
+SAGE_BINARY_BUILD = os.environ.get('SAGE_BINARY_BUILD','no') == 'yes'
 
 if SAGE_BINARY_BUILD:
-    print("Installing in binary build mode.")
+    print("Installing in binary build mode, i.e. not including system libraries.")
+    print("Copy the desired system libraries to SAGE_LOCAL/lib before building")
+    print("Sage if you want them to be included in your binary distribution.")
     FREETYPE_ROOT = JPEG_ROOT = TIFF_ROOT = ZLIB_ROOT = TCL_ROOT = \
         libinclude(os.environ['SAGE_LOCAL'])
 else:
@@ -99,11 +99,27 @@
 except ImportError:
     _tkinter = None
 
-if 'SAGE_PIL_NOTK' in os.environ and os.environ['SAGE_PIL_NOTK'] == 'yes':
-    print("Disabling TK in PIL build.")
+if os.environ.get('SAGE_PIL_NOTK','no') == 'yes':
+    print("Disabling Tkinter (Tcl/Tk) support in PIL build.")
     # Force None, so don't build tk -- this helps on some platforms.
     _tkinter = None
 
+
+# On 64-bit Fedora etc., search e.g. /usr/lib64 rather than the (32-bit)
+# /usr/lib directory (cf. #10359):
+check_lib64 = sysconfig.get_config_var("SIZEOF_VOID_P") == 8 # 64-bit pointers
+ 
+def lib_or_lib64(prefix):
+    lib = os.path.join(prefix, "lib")
+    lib64 = os.path.join(prefix, "lib64")
+
+    if ( check_lib64 and os.path.exists(lib64) and
+         os.path.realpath(lib64) != os.path.realpath(lib) ):
+        return lib64
+    else:
+        return lib 
+
+
 def add_directory(path, dir, where=None):
     if dir and os.path.isdir(dir) and dir not in path:
         if where is None:
@@ -159,6 +175,7 @@
 #            add_directory(library_dirs, "/usr/local/lib")
             # FIXME: check /opt/stuff directories here?
 
+            # Note: Within Sage, prefix is SAGE_LOCAL.
             prefix = sysconfig.get_config_var("prefix")
             if prefix:
                 add_directory(library_dirs, os.path.join(prefix, "lib"))
@@ -210,10 +227,12 @@
         # add standard directories
 
         if not SAGE_BINARY_BUILD:
-            add_directory(library_dirs, "/usr/local/lib")
+            # Only add / search system directories if we're not building
+            # a binary distribution, and if at all, add the proper ones (#10359):
+            add_directory(library_dirs, lib_or_lib64("/usr/local"))
             add_directory(include_dirs, "/usr/local/include")
 
-            add_directory(library_dirs, "/usr/lib")
+            add_directory(library_dirs, lib_or_lib64("/usr"))
             add_directory(include_dirs, "/usr/include")
 
         #
@@ -223,6 +242,10 @@
         self.compiler.library_dirs = library_dirs + self.compiler.library_dirs
         self.compiler.include_dirs = include_dirs + self.compiler.include_dirs
 
+        # DEBUG;
+        print "Searching the following library directories:\n", self.compiler.library_dirs
+        print "Searching the following include directories:\n", self.compiler.include_dirs
+
         #
         # look for available libraries
```


(Note that this one is _based on the first one_; both affect similar parts, so the second one cannot be applied independently of the previous, first one. We _may_ merge them later, though they fix different issues.)

P.S.: Note also that #9864 (which this spkg is based on) currently still needs review, too.


---

Comment by Koen created at 2010-12-01 14:29:04

I have tested the updated package on CentOS 5.5 and OpenSuse 11.2; it is now able to successfully locate libjpeg and it enables JPEG support properly.


---

Comment by jdemeyer created at 2010-12-02 23:23:31

Authors: do you think it makes sense to include this as it is in the next alpha?


---

Comment by leif created at 2010-12-03 00:03:01

Replying to [comment:5 jdemeyer]:
> Authors: do you think it makes sense to include this as it is in the next alpha?

Well, neither this nor the ticket / spkg it is based on has a formal positive review yet, but I won't object to including it...

Are you ok with the "two-phase" `patch`? (Don't remove the GNU patch spkg from the alpha then!)


---

Comment by leif created at 2010-12-03 00:15:55

Changing keywords from "Python Imaging libary JPEG TIFF PNG" to "Python Imaging libary JPEG TIFF PNG CentOS Fedora openSUSE RedHat RHEL".


---

Comment by drkirkby created at 2010-12-03 03:10:04

I would not do any of this on Solaris. The run-time linker should take the library from the correct directory, based on whether it's 32-bit or 64-bit. It would be 

`/lib/`isainfo -n`/`

where for all modern machines, `isainfo -n` will return either `sparcv9` or `amd64`

Is there some equivalent of `isainfo -n` which exists on Linux, and so one would not have code that is depends on the distribution? 

Dave


---

Comment by leif created at 2010-12-03 06:49:36

Replying to [comment:8 drkirkby]:
> I would not do any of this on Solaris. The run-time linker should take the library from the correct directory, based on whether it's 32-bit or 64-bit. It would be 
> 
> `/lib/`isainfo -n`/`
> 
> where for all modern machines, `isainfo -n` will return either `sparcv9` or `amd64`

And I wouldn't mess around with `SAGE64` and dumb flag files on operating systems that don't need it (which is solely for _your_ and John P.'s convenience if you forget to set it on your preferred OSs).


I don't know what you mean by _"any of" this_, but:

_Does this change break anything on Solaris or other OSs?_ No.

_Is this change a regression on Solaris or other OSs?_ No.


So if you want to do similar on Solaris (e.g. adding `.../lib/64` dirs if appropriate), please read the (Python!) code, our [comment:ticket:9864:38 previous answers], and open another ticket for that.


---

Comment by jdemeyer created at 2010-12-03 08:45:08

Replying to [comment:6 leif]:
> Are you ok with the "two-phase" `patch`? (Don't remove the GNU patch spkg from the alpha then!)

I have no problems with that.  It's nice to see the `patch` package used like this!  As far as I know, there hasn't been a single problem with `patch`, so I don't plan to unmerge it.


---

Comment by vbraun created at 2010-12-03 13:01:00

Clearly its dumb of PIL to look in any particular hard-coded directory to see whether libjpeg is available. The only correct way (TM) is to build a test program and see if it compiles, as the autotools would do. We do have a configurable library search path precisely so that `configure` does not need to know the location of each library. Did you file an upstream bug report?

That being said, the band-aid of having a better hard-coded directory is probably the best we can do until upstream fixes their broken `setup.py`.


---

Comment by leif created at 2010-12-03 16:25:09

Replying to [comment:11 vbraun]:
> Clearly its dumb of PIL to look in any particular hard-coded directory to see whether libjpeg is available. The only correct way (TM) is to build a test program and see if it compiles, as the autotools would do. We do have a configurable library search path precisely so that `configure` does not need to know the location of each library. Did you file an upstream bug report?

Unfortunately<sup>TM</sup>, upstream might not consider this a problem, since (I think) usually PIL would find those libraries - if installed - where (a system-wide) Python was installed, though not necessarily (regarding the `lib64` issue).

> That being said, the band-aid of having a better hard-coded directory is probably the best we can do until upstream fixes their broken `setup.py`. 

The latest, 1.1.7, isn't much better.

(And I think they won't accept our `if SAGE_BINARY_BUILD = "yes"` fixes... ;-) )

It also has

```python
...
# Library pointers.
#
# Use None to look for the libraries in well-known library locations.
# Use a string to specify a single directory, for both the library and
# the include files.  Use a tuple to specify separate directories:
# (libpath, includepath).  Examples:
#
# JPEG_ROOT = "/home/libraries/jpeg-6b"
# TIFF_ROOT = "/opt/tiff/lib", "/opt/tiff/include"
#
# If you have "lib" and "include" directories under a common parent,
# you can use the "libinclude" helper:
#
# TIFF_ROOT = libinclude("/opt/tiff")

...

# Override settings

try:
    from setup_site import *
except ImportError:
    pass
```

so one could provide such a file giving the exact locations. One could even create it in `spkg-install`, and / or create symbolic links in `SAGE_LOCAL/{include,lib}`.


Btw, `isainfo` on Solaris only tells us what _the kernel_ is built for or supports, not if Sage or Sage's Python was built 32- or 64-bit.


---

Comment by jdemeyer created at 2010-12-05 09:54:03

Changing priority from major to blocker.


---

Comment by vbraun created at 2010-12-05 10:55:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2010-12-05 10:55:46

As an incremental step towards a working PIL, the bandaid in this patch is fine.

For the record, I tested that the jpeg plugin works with:

```
sage: import Image
sage: im = Image.open("image.jpg")
sage: print im.format, im.size
JPEG (1600, 900)
```

and 

```
[vbraun@localhost sage]$ ldd $SAGE_LOCAL/lib/python2.6/site-packages/PIL/_imaging.so | grep libjpeg
	libjpeg.so.62 => /usr/lib64/libjpeg.so.62 (0x00007fc3b38ea000)
```


Leif, we should still report it upstream. Yes they might not care that their package is broken on everything but Debian, but then they might and at least there will be a paper trail to this ticket. Since you wrote the patch, I think you should have the honours :-)


---

Comment by jdemeyer created at 2010-12-05 11:11:24

Resolution: fixed
