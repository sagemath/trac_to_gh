# Issue 16414: NumberField to SymbolicRing: rational but still approximate

archive/issues_016414.json:
```json
{
    "body": "CC:  kcrisman\n\nI noticed this in comment:18:ticket:14239.\n\n\n```\nsage: poly = QQ[x](x^7 - x - 1)\nsage: root = sorted(poly.roots(QQbar, False), key=imag)[0]\nsage: root\n-0.3636235193291805? - 0.9525611952610331?*I\nsage: nf = NumberField(poly, \"y\", embedding=CC(root))\nsage: z = SR(nf.gen()); z\n-3775/3963*I - 2573/7076\nsage: poly(QQbar(z)).is_zero()\nFalse\n```\n\n\nThe problem here for me as a user is the fact that when I see rational numbers in some expression, I expect them to be accurate. But the conversion to SR here uses `solve(to_poly_solve=True)`, which according to its documentation may yield approximate solutions. I'm still surprised that these approximate solutions may take the form of elements from \u211a[I]. I guess some code further down the line might get confused as well, since these conversions look as if they were exact.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16651\n\n",
    "created_at": "2014-07-12T22:15:53Z",
    "labels": [
        "number fields",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "NumberField to SymbolicRing: rational but still approximate",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16414",
    "user": "gagern"
}
```
CC:  kcrisman

I noticed this in comment:18:ticket:14239.


```
sage: poly = QQ[x](x^7 - x - 1)
sage: root = sorted(poly.roots(QQbar, False), key=imag)[0]
sage: root
-0.3636235193291805? - 0.9525611952610331?*I
sage: nf = NumberField(poly, "y", embedding=CC(root))
sage: z = SR(nf.gen()); z
-3775/3963*I - 2573/7076
sage: poly(QQbar(z)).is_zero()
False
```


The problem here for me as a user is the fact that when I see rational numbers in some expression, I expect them to be accurate. But the conversion to SR here uses `solve(to_poly_solve=True)`, which according to its documentation may yield approximate solutions. I'm still surprised that these approximate solutions may take the form of elements from ℚ[I]. I guess some code further down the line might get confused as well, since these conversions look as if they were exact.

Issue created by migration from https://trac.sagemath.org/ticket/16651





---

archive/issue_comments_215631.json:
```json
{
    "body": "Cc-ing kcrisman since his commit [3278794](http://git.sagemath.org/sage.git/commit/?id=3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?\n\nI've written code for #14239 to suite my perceived needs there. Including a fallback from `to_poly_solve=False` to `to_poly_solve=True` for which I don't have a test case either. It might turn out that we went very similar things in both these places, and we want to factor them out into some common function. For the moment I felt that having separate code might increase chances that my code gets a positive review, since new code is less likely to break expectations than tinkering with existing code.",
    "created_at": "2014-07-13T01:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215631",
    "user": "gagern"
}
```

Cc-ing kcrisman since his commit [3278794](http://git.sagemath.org/sage.git/commit/?id=3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?

I've written code for #14239 to suite my perceived needs there. Including a fallback from `to_poly_solve=False` to `to_poly_solve=True` for which I don't have a test case either. It might turn out that we went very similar things in both these places, and we want to factor them out into some common function. For the moment I felt that having separate code might increase chances that my code gets a positive review, since new code is less likely to break expectations than tinkering with existing code.



---

archive/issue_comments_215632.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-07-15T02:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215632",
    "user": "vbraun"
}
```

New commits:



---

archive/issue_comments_215633.json:
```json
{
    "body": "Changing component from number fields to symbolics.",
    "created_at": "2014-07-15T02:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215633",
    "user": "vbraun"
}
```

Changing component from number fields to symbolics.



---

archive/issue_comments_215634.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-07-15T03:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215634",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_215635.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-15T04:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215635",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_215636.json:
```json
{
    "body": "Doctests all pass now...",
    "created_at": "2014-07-15T04:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215636",
    "user": "vbraun"
}
```

Doctests all pass now...



---

archive/issue_comments_215637.json:
```json
{
    "body": "I guess it might be next week before I find the time to have a closer look at this. And I don't know the code in this area, and have little experience with Maxima itself either. In any case, would I be correct to assume that `options='algexact:true'` is the critical point here?\n\nNotes to self or any other reviewer:\n* Omitting `multiplicities` in the condition makes sense, since `to_poly_solve=True, multiplicities=True` would already raise a `NotImplementedException` earlier on.\n* Not messing around with `repr(x) in \u2026` is certainly a good thing.\n* The move from `Y = \u2026.sage()` to `T = string_to_list_of_solutions(repr(s))` I don't understand yet. Need a closer look.\n* The rationale behind `ignore_exceptions` I don't understand either yet.\n\nA lot of this appears to be drive-by-fixes which make sense but are not immediately related to this bug here. Is that correct? Can you come up with doctests for the things these fix, if it's more than code simplification? For example I suppose that having one variable name as a substring of another might confuse this `repr(x)` hackery.\n\nI would prefer changing the `while todo: ex = todo.pop()` back to `for eq in todo:`. As it stands now, the idiom suggests that you might be adding stuff to the list within the loop. This even had me concerned about infinite loops for a moment. But you don't do that, you simply iterate over the list.",
    "created_at": "2014-07-15T08:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215637",
    "user": "gagern"
}
```

I guess it might be next week before I find the time to have a closer look at this. And I don't know the code in this area, and have little experience with Maxima itself either. In any case, would I be correct to assume that `options='algexact:true'` is the critical point here?

Notes to self or any other reviewer:
* Omitting `multiplicities` in the condition makes sense, since `to_poly_solve=True, multiplicities=True` would already raise a `NotImplementedException` earlier on.
* Not messing around with `repr(x) in …` is certainly a good thing.
* The move from `Y = ….sage()` to `T = string_to_list_of_solutions(repr(s))` I don't understand yet. Need a closer look.
* The rationale behind `ignore_exceptions` I don't understand either yet.

A lot of this appears to be drive-by-fixes which make sense but are not immediately related to this bug here. Is that correct? Can you come up with doctests for the things these fix, if it's more than code simplification? For example I suppose that having one variable name as a substring of another might confuse this `repr(x)` hackery.

I would prefer changing the `while todo: ex = todo.pop()` back to `for eq in todo:`. As it stands now, the idiom suggests that you might be adding stuff to the list within the loop. This even had me concerned about infinite loops for a moment. But you don't do that, you simply iterate over the list.



---

archive/issue_comments_215638.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-15T12:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215638",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_215639.json:
```json
{
    "body": "Thanks, I switched to the while because the original code did add/remove stuff. But that was all wrong, and I forgot to switch it back. \n\nThe main bug of the entire logic was that `X` was being iterated over and modified at the same time, so some solutions were skipped while other solutions were ran twice through Maxima. The first call to Maxima yielded a floating-point answer, and in the subsequent call Maxima converted the floating-point number to a rational.\n\nThere was a similar bug when solve originally found no solution, causing maxima `to_poly_solve` to be called twice. I fixed that, too.\n\nThe main doctest is the one you gave where some numerical solutions were incorrectly returned as rational.",
    "created_at": "2014-07-15T12:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215639",
    "user": "vbraun"
}
```

Thanks, I switched to the while because the original code did add/remove stuff. But that was all wrong, and I forgot to switch it back. 

The main bug of the entire logic was that `X` was being iterated over and modified at the same time, so some solutions were skipped while other solutions were ran twice through Maxima. The first call to Maxima yielded a floating-point answer, and in the subsequent call Maxima converted the floating-point number to a rational.

There was a similar bug when solve originally found no solution, causing maxima `to_poly_solve` to be called twice. I fixed that, too.

The main doctest is the one you gave where some numerical solutions were incorrectly returned as rational.



---

archive/issue_comments_215640.json:
```json
{
    "body": "Btw the `options='algexact:true'` is suggested by the maximal manual. It makes it more likely to find an exact solution.",
    "created_at": "2014-07-15T19:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215640",
    "user": "vbraun"
}
```

Btw the `options='algexact:true'` is suggested by the maximal manual. It makes it more likely to find an exact solution.



---

archive/issue_comments_215641.json:
```json
{
    "body": "> Cc-ing kcrisman since his commit [3278794](http://git.sagemath.org/sage.git/commit/?id=3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?\n\nThis was because of comment:7:ticket:6642.  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.\n\nBut I'm very happy if someone cleans up whatever code I contributed so long ago - I wrangled over that in various ways to make sure that if somebody really wanted a solution they would get one, but it was certainly just to get things done.  Thanks for looking into it!",
    "created_at": "2014-07-17T02:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215641",
    "user": "kcrisman"
}
```

> Cc-ing kcrisman since his commit [3278794](http://git.sagemath.org/sage.git/commit/?id=3278794b9a63e706b9ccef52435575a79f9a64ce) for #6642 introduced the use of `to_poly_solve=True` for `NumberFieldElement`, without any example of when this might be of use. Can you give an example of when this would be useful?

This was because of comment:7:ticket:6642.  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.

But I'm very happy if someone cleans up whatever code I contributed so long ago - I wrangled over that in various ways to make sure that if somebody really wanted a solution they would get one, but it was certainly just to get things done.  Thanks for looking into it!



---

archive/issue_comments_215642.json:
```json
{
    "body": "Replying to [comment:12 kcrisman]:\n> This was because of comment:7:ticket:6642.  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.\n\nMust have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?\n\nIn that case, I might as well remove the whole `to_poly_solve=True` stuff from my commit for #14239, since I'd filter out inexact solutions in any case.\n\n(Sorry, had to edit this comment; I hadn't realized we were not talking on #14239 already.)",
    "created_at": "2014-07-17T07:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215642",
    "user": "gagern"
}
```

Replying to [comment:12 kcrisman]:
> This was because of comment:7:ticket:6642.  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.

Must have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?

In that case, I might as well remove the whole `to_poly_solve=True` stuff from my commit for #14239, since I'd filter out inexact solutions in any case.

(Sorry, had to edit this comment; I hadn't realized we were not talking on #14239 already.)



---

archive/issue_comments_215643.json:
```json
{
    "body": "For `NumberFieldElement` I wonder whether it would be better to not use an approximate solution, but instead convert to `QQbar` and then embed that into `SR`. Only if there exists no radical solution, to be sure. Visually it would look the same: numbers get printed as an approximation. Mathematically, though, things would be exact.\n\nThere might be downsides, of course. Some computations might fail because they aren't defined for algebraic numbers. Some others might take considerably longer. And there would be no reasonable way to deprecate current behavior, because we have to return one or the other, there seems to be no reasonable way in between. How would one go about discussing a possible change like this?\n\nIn any case, that would be a different ticket, since this one here is about the incorrect rationals, which I'll try to review this weekend. Converting to `QQbar` would also require #5355 to be addressed first.",
    "created_at": "2014-07-17T07:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215643",
    "user": "gagern"
}
```

For `NumberFieldElement` I wonder whether it would be better to not use an approximate solution, but instead convert to `QQbar` and then embed that into `SR`. Only if there exists no radical solution, to be sure. Visually it would look the same: numbers get printed as an approximation. Mathematically, though, things would be exact.

There might be downsides, of course. Some computations might fail because they aren't defined for algebraic numbers. Some others might take considerably longer. And there would be no reasonable way to deprecate current behavior, because we have to return one or the other, there seems to be no reasonable way in between. How would one go about discussing a possible change like this?

In any case, that would be a different ticket, since this one here is about the incorrect rationals, which I'll try to review this weekend. Converting to `QQbar` would also require #5355 to be addressed first.



---

archive/issue_comments_215644.json:
```json
{
    "body": "Considering that there is only so much that you can do for a univariate polyonomial, I guess its true that you don't benefit from `to_poly_solve=True` in #14239.\n\nIf you have fundamental questions about `NumberFieldElement` you should post to sage-devel. None of its original authors will read this ticket.",
    "created_at": "2014-07-17T14:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215644",
    "user": "vbraun"
}
```

Considering that there is only so much that you can do for a univariate polyonomial, I guess its true that you don't benefit from `to_poly_solve=True` in #14239.

If you have fundamental questions about `NumberFieldElement` you should post to sage-devel. None of its original authors will read this ticket.



---

archive/issue_comments_215645.json:
```json
{
    "body": "> > This was because of comment:7:ticket:6642.  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.\n> \n> Must have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?\n\nAbsolutely not.  `to_poly_solve` was added to get lots more exact solution.  As a byproduct of that, occasionally inexact solutions are returned.  See the documentation for `solve?` or `x.solve?` for lots of examples.",
    "created_at": "2014-07-18T14:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215645",
    "user": "kcrisman"
}
```

> > This was because of comment:7:ticket:6642.  Basically, the problem is that Barton's `to_poly_solve` stuff depends on `algsys` which does not guarantee exact solutions, though it very often gives them.  But in order for that doctest to work we made that change, as you can see by reading the full set of comments on the ticket.
> 
> Must have been asleep when reading that ticket, sorry. So the way I understand it now, the `to_poly_solve=True` was introduced specifically to allow for approximate solutions. There is no example of a polynomial equation where `to_poly_solve=True` would find an *exact* solution that `to_poly_solve=False` missed, right?

Absolutely not.  `to_poly_solve` was added to get lots more exact solution.  As a byproduct of that, occasionally inexact solutions are returned.  See the documentation for `solve?` or `x.solve?` for lots of examples.



---

archive/issue_comments_215646.json:
```json
{
    "body": "Replying to [comment:16 kcrisman]:\n> Absolutely not.  `to_poly_solve` was added to get lots more exact solution. \n\nBut the cases where you do get more exact solutions are not univariate polynomials.",
    "created_at": "2014-07-18T14:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215646",
    "user": "vbraun"
}
```

Replying to [comment:16 kcrisman]:
> Absolutely not.  `to_poly_solve` was added to get lots more exact solution. 

But the cases where you do get more exact solutions are not univariate polynomials.



---

archive/issue_comments_215647.json:
```json
{
    "body": "> > Absolutely not.  `to_poly_solve` was added to get lots more exact solution. \n> \n> But the cases where you do get more exact solutions are not univariate polynomials.\nHmm, that is most likely true, since the point is to solve things that are not polynomials (you convert them to polys), though I'm not 100% sure - I would want to confirm that with Barton.",
    "created_at": "2014-08-15T11:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215647",
    "user": "kcrisman"
}
```

> > Absolutely not.  `to_poly_solve` was added to get lots more exact solution. 
> 
> But the cases where you do get more exact solutions are not univariate polynomials.
Hmm, that is most likely true, since the point is to solve things that are not polynomials (you convert them to polys), though I'm not 100% sure - I would want to confirm that with Barton.



---

archive/issue_comments_215648.json:
```json
{
    "body": "The only thing like that I could find in the documentation was\n\n```\nto_poly_solve(x^(2*a) + x^a + 1,x);\n```\n\nbut that's for a generic variable `a`.",
    "created_at": "2014-08-27T16:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215648",
    "user": "kcrisman"
}
```

The only thing like that I could find in the documentation was

```
to_poly_solve(x^(2*a) + x^a + 1,x);
```

but that's for a generic variable `a`.



---

archive/issue_comments_215649.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-01T08:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215649",
    "user": "rws"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_215650.json:
```json
{
    "body": "The buildbot error is unrelated, the changes look good. I just removed some pidgin fom the text.\n----\nNew commits:",
    "created_at": "2014-09-01T08:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215650",
    "user": "rws"
}
```

The buildbot error is unrelated, the changes look good. I just removed some pidgin fom the text.
----
New commits:



---

archive/issue_comments_215651.json:
```json
{
    "body": "If you're going to fix language that didn't need fixing (\"the use\" isn't necessary, imo, but the fix is fine too), then one should fix\n* \n\n```\n``force``\n``'force'``\n```\n\n* \n\n```\nan univariate\na univariate\n```\n",
    "created_at": "2014-09-02T12:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215651",
    "user": "kcrisman"
}
```

If you're going to fix language that didn't need fixing ("the use" isn't necessary, imo, but the fix is fine too), then one should fix
* 

```
``force``
``'force'``
```

* 

```
an univariate
a univariate
```




---

archive/issue_comments_215652.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-06T11:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16414#issuecomment-215652",
    "user": "vbraun"
}
```

Resolution: fixed
