# Issue 12459: Get rid of spkg/base/dir-0.1-install

Issue created by migration from https://trac.sagemath.org/ticket/12631

Original creator: jdemeyer

Original creation time: 2012-03-05 15:44:55

Assignee: GeorgSWeber

The script `spkg/base/dir-0.1-install` does so little that it can easily be merged inside `spkg/install`.


---

Comment by jhpalmieri created at 2012-03-05 22:14:30

It would be nice not to create `$SAGE_ROOT/tmp` until needed. It would require modifying a script or two: `sage-apply-ticket` (and possibly `sage-maketest`, but I don't think so). The following might be all that's required:

```diff
diff --git a/sage-apply-ticket b/sage-apply-ticket
--- a/sage-apply-ticket
+++ b/sage-apply-ticket
@@ -525,7 +525,13 @@ def apply_and_test(n, patches, directory
 
 def archive_log(ticketnum, tmp_file):
     dir = os.getcwd()
-    os.chdir(SAGE_ROOT+'/tmp')
+    tmpdir = os.path.join(SAGE_ROOT, 'tmp')
+    try:
+        os.makedirs(tmpdir)
+    except OSError:
+        if not os.path.isdir(tmpdir):
+            raise
+    os.chdir(tmpdir)
     os.system('cp %s %s-mergelog'%(tmp_file,ticketnum))
     os.system('tar -rf mergelog.tar %s-mergelog'%(ticketnum))
     os.system('rm %s-mergelog'%(ticketnum))
```

But this could certainly go on another ticket.


---

Comment by jdemeyer created at 2012-03-07 15:55:16

The problem is that I can't be entirely sure which parts of Sage require "$SAGE_ROOT/tmp".  I think it is safer to just create it from the beginning.


---

Comment by jhpalmieri created at 2012-03-23 15:31:26

Is this ready for review?


---

Comment by jdemeyer created at 2012-03-23 15:38:00

We need to fix #12311 first.


---

Comment by jdemeyer created at 2012-04-03 09:32:01

I added the following patch to SAGE_ROOT's `spkg-install` (this ensures that upgraded Sage versions don't have untracked files):

```diff
--- a/spkg/root-spkg-install
+++ b/spkg/root-spkg-install
@@ -14,8 +14,10 @@

 # Remove the spkg/base repository, this is needed for upgrading from
 # Sage versions 4.x, see Trac #11073.
+# Also remove files for "dir" (see #12631) and "bzip2" (see #12102),
+# which are no longer base packages.
 cd "$SAGE_ROOT/spkg/base" && \
-rm -rf .hg* json_bundle.py stdint.h_Solaris9 sage-* text-* *.sh
+rm -rf .hg* json_bundle.py stdint.h_Solaris9 sage-* text-* *.sh dir-* bzip2-*

 TARGET="$SAGE_ROOT"
```



---

Comment by jdemeyer created at 2012-04-04 09:39:45

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2012-04-04 09:39:45

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-04-04 09:40:27

Making this a blocker because the removal of those untracked files from `spkg/base` is quite important.


---

Comment by jhpalmieri created at 2012-04-04 15:01:09

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-04-04 15:01:09

The patch makes sense, it builds from scratch, and I upgraded almost successfully from Sage 4.7.1. I think that's good enough. "Almost successfully" means that when I do `hg status` in `SAGE_ROOT/devel/sage`, I see

```
? sage/rings/finite_field_givaro.pyx
```

(The other repositories are clean.) I can't imagine that this is related to this ticket, so I'm giving this a positive review.


---

Comment by jdemeyer created at 2012-04-07 06:40:51

Added

```diff
diff --git a/spkg/install b/spkg/install
--- a/spkg/install
+++ b/spkg/install
@@ -64,6 +64,7 @@
 mkdir -p "$SAGE_ROOT/tmp"
 mkdir -p "$SAGE_LOGS"
 mkdir -p "$SAGE_LOCAL/bin"
+mkdir -p "$SAGE_LOCAL/etc"
 mkdir -p "$SAGE_LOCAL/lib"
 mkdir -p "$SAGE_ROOT/spkg/installed"

```

since it's needed for PARI.  It's clearly within the spirit of the original patch, I hope it's okay to keep the positive_review.


---

Comment by jdemeyer created at 2012-04-07 15:10:18

Resolution: fixed


---

Attachment
