# Issue 13922: Avoid a regression in the creation of homsets

archive/issues_013718.json:
```json
{
    "assignees": [],
    "body": "By #715 and related tickets, one observes a dramatic regression in the following example.\n\n```\nsage: p = polar_plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color=\"red\",plot_points=1000) \n```\n\nFirst of all, it is very strange that the following homset is created several thousands of times:\n\n```\nSet of Homomorphisms from Integer Ring to Real Interval Field with 64 bits of precision\n```\nThis also occurs *without* #715. Hence, enabling garbage collection seems not to be to blame.\n\nHowever, the *creation time* for the homsets increases clearly, which is shown by prun.\n\nDepends on #715\n\nCC:  @jpflori @zimmermann6 @vbraun @robertwb @nbruin @malb @orlitzky\n\nReviewer: **Volker Braun**\n\nAuthor: **Simon King**\n\nMerged: **sage-5.7.beta3**\n\nComponent: **performance**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13922_\n\n",
    "closed_at": "2013-02-05T08:20:35Z",
    "created_at": "2013-01-07T13:10:10Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/performance",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Avoid a regression in the creation of homsets",
    "type": "issue",
    "updated_at": "2013-02-05T08:20:35Z",
    "url": "https://github.com/sagemath/sage/issues/13922",
    "user": "https://github.com/simon-king-jena"
}
```
By #715 and related tickets, one observes a dramatic regression in the following example.

```
sage: p = polar_plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color="red",plot_points=1000) 
```

First of all, it is very strange that the following homset is created several thousands of times:

```
Set of Homomorphisms from Integer Ring to Real Interval Field with 64 bits of precision
```
This also occurs *without* #715. Hence, enabling garbage collection seems not to be to blame.

However, the *creation time* for the homsets increases clearly, which is shown by prun.

Depends on #715

CC:  @jpflori @zimmermann6 @vbraun @robertwb @nbruin @malb @orlitzky

Reviewer: **Volker Braun**

Author: **Simon King**

Merged: **sage-5.7.beta3**

Component: **performance**

_Issue created by migration from https://trac.sagemath.org/ticket/13922_





---

archive/issue_events_196359.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-07T13:10:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196359"
}
```



---

archive/issue_events_196360.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-07T13:10:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/performance",
    "label_color": "696969",
    "label_name": "performance",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196360"
}
```



---

archive/issue_events_196361.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-07T13:10:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196361"
}
```



---

archive/issue_events_196362.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-07T13:10:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196362"
}
```



---

archive/issue_comments_164694.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nPS: There is almost no regression in this example, if #13014 is reverted, as Jeroen reported on sage-devel. Still, both problems should be addressed:\n\n1. The previously existing repeated creation of a homset.\n2. The new slowdown in the creation of homsets.",
    "created_at": "2013-01-07T14:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164694",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

PS: There is almost no regression in this example, if #13014 is reverted, as Jeroen reported on sage-devel. Still, both problems should be addressed:

1. The previously existing repeated creation of a homset.
2. The new slowdown in the creation of homsets.



---

archive/issue_comments_164695.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\n#13014 has to do with gcd/lcm, and apparently gcd is used quite a lot in this example, according to [#715, [comment:366](#comment:366)](https://github.com/sagemath/sage/issues/715#comment:366) - WHY??",
    "created_at": "2013-01-07T14:42:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164695",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

#13014 has to do with gcd/lcm, and apparently gcd is used quite a lot in this example, according to [#715, [comment:366](#comment:366)](https://github.com/sagemath/sage/issues/715#comment:366) - WHY??



---

archive/issue_comments_164696.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI take it that whenever you write `pi/2` we first see if that can be simplified to just the numerator. Which requires a gcd, and #13014 changed gcd of symbolics to be more expensive.\n\nReally the example is very poor, a python function returning a symbolic expression. If you just had a symbolic function then the `fast_callable` trickery could do its job. Just leave out the `lambda t:` and it is >100 times faster!\n\n```\nsage: var('t')\nt\nsage: %time p = polar_plot((100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color=\"red\",plot_points=1000)\nCPU times: user 0.04 s, sys: 0.00 s, total: 0.04 s\nWall time: 0.05 s\n```",
    "created_at": "2013-01-07T15:22:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164696",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:3" align="right">comment:3</div>

I take it that whenever you write `pi/2` we first see if that can be simplified to just the numerator. Which requires a gcd, and #13014 changed gcd of symbolics to be more expensive.

Really the example is very poor, a python function returning a symbolic expression. If you just had a symbolic function then the `fast_callable` trickery could do its job. Just leave out the `lambda t:` and it is >100 times faster!

```
sage: var('t')
t
sage: %time p = polar_plot((100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color="red",plot_points=1000)
CPU times: user 0.04 s, sys: 0.00 s, total: 0.04 s
Wall time: 0.05 s
```



---

archive/issue_comments_164697.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIndeed, without the lambda, only one set of morphisms is created, namely Set of Morphisms from Set of Python objects of type `'sage.ext.fast_eval.FastDoubleFunc'` to Symbolic Ring in Category of sets.",
    "created_at": "2013-01-07T15:34:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164697",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:4" align="right">comment:4</div>

Indeed, without the lambda, only one set of morphisms is created, namely Set of Morphisms from Set of Python objects of type `'sage.ext.fast_eval.FastDoubleFunc'` to Symbolic Ring in Category of sets.



---

archive/issue_comments_164698.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI defined `f = lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2)` and evaluated it on both integers, rationals and symbolic constants. But alas, no repeated creation of the same homset occurs in the process.\n\nSo, why are the homsets not taken from cache when calling `polar_plot`? The same happens with `plot`, by the way.",
    "created_at": "2013-01-07T15:41:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164698",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

I defined `f = lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2)` and evaluated it on both integers, rationals and symbolic constants. But alas, no repeated creation of the same homset occurs in the process.

So, why are the homsets not taken from cache when calling `polar_plot`? The same happens with `plot`, by the way.



---

archive/issue_comments_164699.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nEven when setting the number of evaluation points to 3, one gets loads of homsets. So, evaluation is probably not the culprit.",
    "created_at": "2013-01-07T15:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164699",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

Even when setting the number of evaluation points to 3, one gets loads of homsets. So, evaluation is probably not the culprit.



---

archive/issue_comments_164700.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI tried to simplify the circumstances a bit (smaller number of evaluation points, no symbolic expression in the definition of the plot range. However,\n\n```\nsage: t = var('t')\nsage: f = lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2)\nsage: p = plot(f, -4, 3,plot_points=3)\n```\nis still nasty.",
    "created_at": "2013-01-07T15:59:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164700",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

I tried to simplify the circumstances a bit (smaller number of evaluation points, no symbolic expression in the definition of the plot range. However,

```
sage: t = var('t')
sage: f = lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2)
sage: p = plot(f, -4, 3,plot_points=3)
```
is still nasty.



---

archive/issue_comments_164701.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThe plot is adaptive, so even if you specify 3 points it uses many more.\n\nAbout the caching, is the problem that the cache gets deleted too quickly? Between two evaluations of the lambda there is nothing that holds a reference to the symbolic expression. So all coercion caches should be free to be garbage collected.",
    "created_at": "2013-01-07T16:08:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164701",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">comment:8</div>

The plot is adaptive, so even if you specify 3 points it uses many more.

About the caching, is the problem that the cache gets deleted too quickly? Between two evaluations of the lambda there is nothing that holds a reference to the symbolic expression. So all coercion caches should be free to be garbage collected.



---

archive/issue_comments_164702.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@vbraun](#comment:8):\n> About the caching, is the problem that the cache gets deleted too quickly?\n\nHave we been using weak references to cache homsets prior to #715?\n\n> Between two evaluations of the lambda there is nothing that holds a reference to the symbolic expression. So all coercion caches should be free to be garbage collected.\n\nHere is the problem:\n\n```\nQQ.gcd(3.14159,2*3.14159)\n```\ncreates two times `Set of Homomorphisms from Integer Ring to Real Interval Field with 64 bits of precision in Category of euclidean domains`. So, no symbolics involved at this point.",
    "created_at": "2013-01-07T16:20:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164702",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@vbraun](#comment:8):
> About the caching, is the problem that the cache gets deleted too quickly?

Have we been using weak references to cache homsets prior to #715?

> Between two evaluations of the lambda there is nothing that holds a reference to the symbolic expression. So all coercion caches should be free to be garbage collected.

Here is the problem:

```
QQ.gcd(3.14159,2*3.14159)
```
creates two times `Set of Homomorphisms from Integer Ring to Real Interval Field with 64 bits of precision in Category of euclidean domains`. So, no symbolics involved at this point.



---

archive/issue_comments_164703.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThe cache of the Hom function seems not to be used, even though the Hom function is called. Namely, defining\n\n```\nsage: H = Hom(ZZ, RealIntervalField(prec=64), category=EuclideanDomains())\n```\nI still find that\n\n```\nsage: QQ.gcd(3.14159,2*3.14159)\n```\ncreates two copies of H each time it is called. Odd.",
    "created_at": "2013-01-07T16:26:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164703",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

The cache of the Hom function seems not to be used, even though the Hom function is called. Namely, defining

```
sage: H = Hom(ZZ, RealIntervalField(prec=64), category=EuclideanDomains())
```
I still find that

```
sage: QQ.gcd(3.14159,2*3.14159)
```
creates two copies of H each time it is called. Odd.



---

archive/issue_comments_164704.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nGot it!!!\n\n`RealIntervalField(prec=64)` should be a unique parent, but it isn't! It is created in two different addresses in memory during QQ.gcd(3.14159,2*3.14159). So, apparently the `RealIntervalField` constructor is not called in `QQ.gcd`. That would be a clear bug.",
    "created_at": "2013-01-07T16:29:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164704",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

Got it!!!

`RealIntervalField(prec=64)` should be a unique parent, but it isn't! It is created in two different addresses in memory during QQ.gcd(3.14159,2*3.14159). So, apparently the `RealIntervalField` constructor is not called in `QQ.gcd`. That would be a clear bug.



---

archive/issue_comments_164705.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nMy apologies to whoever created `QQ.gcd`. It now seems that the coercion into `QQ` is to blame:\n\n```\nsage: a = QQ(3.14159)\n```\ninternally creates a new copy of `RealIntervalField(prec=64)`, and hence a new homset.",
    "created_at": "2013-01-07T16:32:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164705",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

My apologies to whoever created `QQ.gcd`. It now seems that the coercion into `QQ` is to blame:

```
sage: a = QQ(3.14159)
```
internally creates a new copy of `RealIntervalField(prec=64)`, and hence a new homset.



---

archive/issue_comments_164706.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nLook into `sage.rings.real_mpfi.RealIntervalFieldElement.simplest_rational`: It calls `RealIntervalField_class` directly, but should call the `RealField` constructor (or, if the overhead of calling a function matters, should look into the cache first).",
    "created_at": "2013-01-07T16:38:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164706",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

Look into `sage.rings.real_mpfi.RealIntervalFieldElement.simplest_rational`: It calls `RealIntervalField_class` directly, but should call the `RealField` constructor (or, if the overhead of calling a function matters, should look into the cache first).



---

archive/issue_comments_164707.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nWith the following patch, the homsets are taken from cache. I don't know about timings (calling overhead) yet.\n\n```diff\ndiff --git a/sage/rings/real_mpfi.pyx b/sage/rings/real_mpfi.pyx\n--- a/sage/rings/real_mpfi.pyx\n+++ b/sage/rings/real_mpfi.pyx\n@@ -2826,7 +2826,7 @@\n         # First, we try using approximate arithmetic of slightly higher\n         # precision.\n         cdef RealIntervalFieldElement highprec\n-        highprec = RealIntervalField_class(int(self.prec() * 1.2))(self)\n+        highprec = RealIntervalField(int(self.prec() * 1.2))(self)\n \n         cdef Rational try1 = highprec._simplest_rational_helper()\n```",
    "created_at": "2013-01-07T16:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164707",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:14" align="right">comment:14</div>

With the following patch, the homsets are taken from cache. I don't know about timings (calling overhead) yet.

```diff
diff --git a/sage/rings/real_mpfi.pyx b/sage/rings/real_mpfi.pyx
--- a/sage/rings/real_mpfi.pyx
+++ b/sage/rings/real_mpfi.pyx
@@ -2826,7 +2826,7 @@
         # First, we try using approximate arithmetic of slightly higher
         # precision.
         cdef RealIntervalFieldElement highprec
-        highprec = RealIntervalField_class(int(self.prec() * 1.2))(self)
+        highprec = RealIntervalField(int(self.prec() * 1.2))(self)
 
         cdef Rational try1 = highprec._simplest_rational_helper()
```



---

archive/issue_comments_164708.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nPS: How could that fix be tested against?",
    "created_at": "2013-01-07T16:45:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164708",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

PS: How could that fix be tested against?



---

archive/issue_events_196363.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-07T17:06:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196363"
}
```



---

archive/issue_comments_164709.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThe attached patch is preliminary, as it is not tested, and I don't know if I was over-eager to cdefine stuff.\n\nAnyway. Without the patch, it is\n\n```\nsage: %timeit a = QQ.gcd(3.14159,2*3.14159)\n125 loops, best of 3: 4.58 ms per loop\nsage: var('t')\nt\nsage: %time p = plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color=\"red\",plot_points=1000) \nCPU times: user 87.06 s, sys: 0.69 s, total: 87.75 s\nWall time: 88.15 s\n```\n\nWith the patch, it is\n\n```\nsage: %timeit a = QQ.gcd(3.14159,2*3.14159)\n125 loops, best of 3: 2.33 ms per loop\nsage: var('t')\nt\nsage: %time p = plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color=\"red\",plot_points=1000) \nCPU times: user 55.41 s, sys: 0.00 s, total: 55.41 s\nWall time: 55.48 s\n```\n\nWould that be enough to fix the regression completely?",
    "created_at": "2013-01-07T17:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164709",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

The attached patch is preliminary, as it is not tested, and I don't know if I was over-eager to cdefine stuff.

Anyway. Without the patch, it is

```
sage: %timeit a = QQ.gcd(3.14159,2*3.14159)
125 loops, best of 3: 4.58 ms per loop
sage: var('t')
t
sage: %time p = plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color="red",plot_points=1000) 
CPU times: user 87.06 s, sys: 0.69 s, total: 87.75 s
Wall time: 88.15 s
```

With the patch, it is

```
sage: %timeit a = QQ.gcd(3.14159,2*3.14159)
125 loops, best of 3: 2.33 ms per loop
sage: var('t')
t
sage: %time p = plot(lambda t: (100/(100+(t-pi/2)^8))*(2-sin(7*t)-cos(30*t)/2), -pi/4, 3*pi/2, color="red",plot_points=1000) 
CPU times: user 55.41 s, sys: 0.00 s, total: 55.41 s
Wall time: 55.48 s
```

Would that be enough to fix the regression completely?



---

archive/issue_comments_164710.json:
```json
{
    "body": "Author: **Simon King**",
    "created_at": "2013-01-07T17:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164710",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Simon King**



---

archive/issue_comments_164711.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI haven't tested this yet, but the code looks good to me and clearly fixes a bug.",
    "created_at": "2013-01-07T18:26:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164711",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:17" align="right">comment:17</div>

I haven't tested this yet, but the code looks good to me and clearly fixes a bug.



---

archive/issue_comments_164712.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nNot introduced by this patch, so shouldn't be held against it, but ...\n\n```\nRealIntervalField_cache = {}\n```\nIs a strong cache! So `RealIntervalField`s get nailed in memory. That's a very good argument for ensuring that \"increase precision\" leads to a very predictable and sparse list of precisions, to minimize the costs from this.",
    "created_at": "2013-01-07T21:08:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164712",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:18" align="right">comment:18</div>

Not introduced by this patch, so shouldn't be held against it, but ...

```
RealIntervalField_cache = {}
```
Is a strong cache! So `RealIntervalField`s get nailed in memory. That's a very good argument for ensuring that "increase precision" leads to a very predictable and sparse list of precisions, to minimize the costs from this.



---

archive/issue_comments_164713.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@nbruin](#comment:18):\n> Not introduced by this patch, so shouldn't be held against it, but ...\n> \n> ```\n> RealIntervalField_cache = {}\n> ```\n> Is a strong cache!\n\nYes. And since `RealIntervalField` is a very simple function (taking just one integer and one bool as argument), I would actually suggest to let `RealIntervalField_class` inherit from `UniqueRepresentation` and make `RealIntervalField` and alias for `RealIntervalField_class`. The point is that `UniqueRepresentation` will soonish have a weak cache (namely: If all the problems with #715 and #11521 are sorted out). See #12215.\n\nThe questions are:\n\n1. Do we want to the change from a custom constructor function to `UniqueRepresentation`?\n2. Do we want to change it *here*, or shall we have a quick fix for now and do it properly on a different ticket?\n\nI expect that it would be relatively harmless to use `UniqueRepresentation` in this case. Shall I try?",
    "created_at": "2013-01-07T21:27:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164713",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@nbruin](#comment:18):
> Not introduced by this patch, so shouldn't be held against it, but ...
> 
> ```
> RealIntervalField_cache = {}
> ```
> Is a strong cache!

Yes. And since `RealIntervalField` is a very simple function (taking just one integer and one bool as argument), I would actually suggest to let `RealIntervalField_class` inherit from `UniqueRepresentation` and make `RealIntervalField` and alias for `RealIntervalField_class`. The point is that `UniqueRepresentation` will soonish have a weak cache (namely: If all the problems with #715 and #11521 are sorted out). See #12215.

The questions are:

1. Do we want to the change from a custom constructor function to `UniqueRepresentation`?
2. Do we want to change it *here*, or shall we have a quick fix for now and do it properly on a different ticket?

I expect that it would be relatively harmless to use `UniqueRepresentation` in this case. Shall I try?



---

archive/issue_comments_164714.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@simon-king-jena](#comment:19):\n> I expect that it would be relatively harmless to use `UniqueRepresentation` in this case.\n\nI stand corrected. `UniqueRepresentation` is a Python class, and thus can not be used as a base class of a Cython class like `RealIntervalField_class`.",
    "created_at": "2013-01-07T21:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164714",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@simon-king-jena](#comment:19):
> I expect that it would be relatively harmless to use `UniqueRepresentation` in this case.

I stand corrected. `UniqueRepresentation` is a Python class, and thus can not be used as a base class of a Cython class like `RealIntervalField_class`.



---

archive/issue_comments_164715.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nQuestion to Robert: Is it possible to use a metaclass in Cython?\n\nI tried:\n\n```\ncdef class Test:\n    __metaclass__ = ClasscallMetaclass\n    @staticmethod\n    def __classcall__(cls,data):\n        print \"classcall\"\n        O = super(cls,cls).__new__(cls,data)\n        cls.__init__(O,data)\n        return O\n    def __init__(self, data):\n        print \"init\"\n\nclass Test2:\n    __metaclass__ = ClasscallMetaclass\n    @staticmethod\n    def __classcall__(cls,data):\n        print \"classcall\"\n        O = super(cls,cls).__new__(cls,data)\n        cls.__init__(O,data)\n        return O\n    def __init__(self, data):\n        print \"init\"\n```\n\nWhile I obtain\n\n```\nsage: Test2('bla')\nclasscall\ninit\n<...Test2 object at 0x6128680>\n```\nI only get\n\n```\nsage: Test('bla')\ninit\n<...Test object at 0x72eddc0>\n```\nwith the Cython function. Hence, it compiles with the metaclass, but apparently it has no effect.",
    "created_at": "2013-01-07T21:49:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164715",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Question to Robert: Is it possible to use a metaclass in Cython?

I tried:

```
cdef class Test:
    __metaclass__ = ClasscallMetaclass
    @staticmethod
    def __classcall__(cls,data):
        print "classcall"
        O = super(cls,cls).__new__(cls,data)
        cls.__init__(O,data)
        return O
    def __init__(self, data):
        print "init"

class Test2:
    __metaclass__ = ClasscallMetaclass
    @staticmethod
    def __classcall__(cls,data):
        print "classcall"
        O = super(cls,cls).__new__(cls,data)
        cls.__init__(O,data)
        return O
    def __init__(self, data):
        print "init"
```

While I obtain

```
sage: Test2('bla')
classcall
init
<...Test2 object at 0x6128680>
```
I only get

```
sage: Test('bla')
init
<...Test object at 0x72eddc0>
```
with the Cython function. Hence, it compiles with the metaclass, but apparently it has no effect.



---

archive/issue_comments_164716.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI think metaclasses are only supported for non-cdef classes.  (This should probably be a compile-time error rather than silently ignoring it.)\n\nThere's also sage.structure.factory.UniqueFactory.  It may also be worth holding a strong reference to the last N (for some small N) parents created to avoid creating the same one over and over.\n\nIn any case, this isn't a regression, so I'd be happy to get this fix in and post a follow-up ticket to ensure uniqueness.",
    "created_at": "2013-01-07T21:54:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164716",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:22" align="right">comment:22</div>

I think metaclasses are only supported for non-cdef classes.  (This should probably be a compile-time error rather than silently ignoring it.)

There's also sage.structure.factory.UniqueFactory.  It may also be worth holding a strong reference to the last N (for some small N) parents created to avoid creating the same one over and over.

In any case, this isn't a regression, so I'd be happy to get this fix in and post a follow-up ticket to ensure uniqueness.



---

archive/issue_events_196364.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-30T15:24:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196364"
}
```



---

archive/issue_events_196365.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-30T15:24:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196365"
}
```



---

archive/issue_comments_164717.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nWell then lets get it in ;-)",
    "created_at": "2013-01-30T15:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164717",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:23" align="right">comment:23</div>

Well then lets get it in ;-)



---

archive/issue_comments_164718.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2013-01-30T15:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164718",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_events_196366.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-30T19:15:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196366"
}
```



---

archive/issue_events_196367.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-30T19:15:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196367"
}
```



---

archive/issue_comments_164719.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThe following Cython-generated file needs to be added to `.hgignore`:\n\n```\nsage/rings/real_mpfi.h\n```",
    "created_at": "2013-01-30T19:15:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164719",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

The following Cython-generated file needs to be added to `.hgignore`:

```
sage/rings/real_mpfi.h
```



---

archive/issue_comments_164720.json:
```json
{
    "body": "Attachment: **[trac_13922_faster_QQgcd.patch.gz](https://github.com/sagemath/sage/files/ticket13922/trac_13922_faster_QQgcd.patch.gz)**",
    "created_at": "2013-01-30T21:29:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164720",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac_13922_faster_QQgcd.patch.gz](https://github.com/sagemath/sage/files/ticket13922/trac_13922_faster_QQgcd.patch.gz)**



---

archive/issue_events_196368.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-30T21:30:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196368"
}
```



---

archive/issue_events_196369.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-30T21:30:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196369"
}
```



---

archive/issue_comments_164721.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jdemeyer](#comment:24):\n> The following Cython-generated file needs to be added to `.hgignore`:\n> \n> ```\n> sage/rings/real_mpfi.h\n> ```\n\nDone. And I hope it is ok if I revert it to \"positive review\".",
    "created_at": "2013-01-30T21:30:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164721",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jdemeyer](#comment:24):
> The following Cython-generated file needs to be added to `.hgignore`:
> 
> ```
> sage/rings/real_mpfi.h
> ```

Done. And I hope it is ok if I revert it to "positive review".



---

archive/issue_comments_164722.json:
```json
{
    "body": "Merged: **sage-5.7.beta3**",
    "created_at": "2013-02-05T08:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13922#issuecomment-164722",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.7.beta3**



---

archive/issue_events_196370.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-05T08:20:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196370"
}
```



---

archive/issue_events_196371.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-05T08:20:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13922",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13922#event-196371"
}
```
