# Issue 13836: Fix variable dependence in PiecewisePolynomial

archive/issues_013632.json:
```json
{
    "body": "When using the example in the documentation of the function the following results are displayed for critical points:\n\n```\nsage: R.<x> = QQ[]\nsage: f1 = x^0\nsage: f2 = 10*x - x^2\nsage: f3 = 3*x^4 - 156*x^3 + 3036*x^2 - 26208*x\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])\nsage: f.critical_points()\n[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]\n```\n\nWhen doing the same with y instead of x as a variable an empty list is returned as a result:\n\n```\nsage: R.<y> = QQ[]                                        \nsage: f1 = y^0                                            \nsage: f2 = 10*y - y^2                                     \nsage: f3 = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y           \nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])\nsage: f.critical_points()                                 \n[]\n```\n\nThis behavior does not change even if y is explicitly defined as the variable:\n\n```\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]],y)\nsage: f.critical_points()                                   \n[]\n```\n\nA variable besides default_variable() is also used (to varying effects) in the functions trapezoid(), derivative(), tangent_line() and convolution(). The fourier series functions that find coefficients use a variable other than default_variable() in the code, but it doesn't affect output, and probably doesn't need to be changed. However, the _fourier_series_helper() function probably should be changed.\n\n```\nsage: y = var('y')\nsage: f(y) = y^2\nsage: f = Piecewise([[(-1, 1),f]])\nsage: f._fourier_series_helper(3, 1, lambda n: 1)\n-4*cos(pi*x)/pi^2 + cos(2*pi*x)/pi^2 + 1/3\n```\n\nIt should be possible to obtain consistent results no matter what the name of the variable is.\n\nApply :\n* [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)\n* [attachment:trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)\n\n\n**Assignee:** @burcin\n\n**CC:**  @wdjoyner pbutler @kcrisman\n\n**Keywords:** Piecewise, critical_points\n\n**Reviewer:** Burcin Erocal\n\n**Author:** Andrew Fleckenstein\n\n**Merged:** sage-5.10.beta4\n\nIssue created by migration from https://trac.sagemath.org/ticket/13836\n\n",
    "closed_at": "2013-05-19T08:38:01Z",
    "created_at": "2012-12-16T16:38:36Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.10",
    "title": "Fix variable dependence in PiecewisePolynomial",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/13836",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```
When using the example in the documentation of the function the following results are displayed for critical points:

```
sage: R.<x> = QQ[]
sage: f1 = x^0
sage: f2 = 10*x - x^2
sage: f3 = 3*x^4 - 156*x^3 + 3036*x^2 - 26208*x
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])
sage: f.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
```

When doing the same with y instead of x as a variable an empty list is returned as a result:

```
sage: R.<y> = QQ[]                                        
sage: f1 = y^0                                            
sage: f2 = 10*y - y^2                                     
sage: f3 = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y           
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])
sage: f.critical_points()                                 
[]
```

This behavior does not change even if y is explicitly defined as the variable:

```
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]],y)
sage: f.critical_points()                                   
[]
```

A variable besides default_variable() is also used (to varying effects) in the functions trapezoid(), derivative(), tangent_line() and convolution(). The fourier series functions that find coefficients use a variable other than default_variable() in the code, but it doesn't affect output, and probably doesn't need to be changed. However, the _fourier_series_helper() function probably should be changed.

```
sage: y = var('y')
sage: f(y) = y^2
sage: f = Piecewise([[(-1, 1),f]])
sage: f._fourier_series_helper(3, 1, lambda n: 1)
-4*cos(pi*x)/pi^2 + cos(2*pi*x)/pi^2 + 1/3
```

It should be possible to obtain consistent results no matter what the name of the variable is.

Apply :
* [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)
* [attachment:trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)


**Assignee:** @burcin

**CC:**  @wdjoyner pbutler @kcrisman

**Keywords:** Piecewise, critical_points

**Reviewer:** Burcin Erocal

**Author:** Andrew Fleckenstein

**Merged:** sage-5.10.beta4

Issue created by migration from https://trac.sagemath.org/ticket/13836





---

archive/attachments_019339.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13836_piecewise_critpoints_fix.patch",
    "asset_url": "tarball://root/attachments/ticket13836/trac_13836_piecewise_critpoints_fix.patch",
    "created_at": "2012-12-17T14:20:56Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_fix.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```



---

archive/issue_comments_165411.json:
```json
{
    "body": "**Attachment:** [trac_13836_piecewise_critpoints_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_fix.patch)",
    "created_at": "2012-12-17T14:20:56Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165411",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Attachment:** [trac_13836_piecewise_critpoints_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_fix.patch)



---

archive/issue_comments_165412.json:
```json
{
    "body": "<a id='comment:1'></a>\nYes, the code practically forced x to be the variable. It should be fine now, the fix was simple.",
    "created_at": "2012-12-17T14:25:23Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165412",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:1'></a>
Yes, the code practically forced x to be the variable. It should be fine now, the fix was simple.



---

archive/issue_events_118701.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2012-12-17T14:31:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118701"
}
```



---

archive/issue_comments_165413.json:
```json
{
    "body": "**Reviewer:** Burcin Erocal",
    "created_at": "2012-12-17T14:45:29Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165413",
    "user": "https://github.com/burcin"
}
```

**Reviewer:** Burcin Erocal



---

archive/issue_events_118702.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2012-12-17T14:45:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118702"
}
```



---

archive/issue_events_118703.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2012-12-17T14:45:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118703"
}
```



---

archive/issue_comments_165414.json:
```json
{
    "body": "<a id='comment:3'></a>\nThanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.\n\nIt would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.",
    "created_at": "2012-12-17T14:45:29Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165414",
    "user": "https://github.com/burcin"
}
```

<a id='comment:3'></a>
Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.

It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.



---

archive/attachments_019340.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13836_piecewise_critpoints_withdoc.patch",
    "asset_url": "tarball://root/attachments/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch",
    "created_at": "2012-12-18T00:13:06Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```



---

archive/issue_comments_165415.json:
```json
{
    "body": "**Attachment:** [trac_13836_piecewise_critpoints_withdoc.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch)",
    "created_at": "2012-12-18T00:13:06Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165415",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Attachment:** [trac_13836_piecewise_critpoints_withdoc.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch)



---

archive/issue_comments_165416.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [burcin](#comment%3A3):\n> Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.\n> \n> It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.\n\nI put in the doctests in the ...withdoc.patch, as well as a testing of the `var` argument and the `default_variable()` function, it worked surprisingly well :-D",
    "created_at": "2012-12-18T00:14:52Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165416",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:4'></a>
Replying to [burcin](#comment%3A3):
> Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.
> 
> It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.

I put in the doctests in the ...withdoc.patch, as well as a testing of the `var` argument and the `default_variable()` function, it worked surprisingly well :-D



---

archive/issue_comments_165417.json:
```json
{
    "body": "**Changing author** from \"Christian Kuper\" to \"Andrew Fleckenstein\".",
    "created_at": "2012-12-21T14:12:56Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165417",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Changing author** from "Christian Kuper" to "Andrew Fleckenstein".



---

archive/issue_events_118704.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2012-12-21T14:12:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118704"
}
```



---

archive/issue_events_118705.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2012-12-21T14:12:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118705"
}
```



---

archive/issue_comments_165418.json:
```json
{
    "body": "<a id='comment:6'></a>\nHello Andrew,\n\nthank you for the patch. It indeed seems to solve the reported problem. However, allow me to make a few remarks:\n\n* I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches\n* I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial. I can do the following:\n\n```\nsage: f1(y) = y^0\nsage: f2(y) = 10*y - y^2\nsage: f3(y) = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)\nsage: f.critical_points()\n[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]\nsage: z = var(\"z\")                                           \nsage: g = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], z)\nsage: g.critical_points()\n[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]\n```\n* From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.\n* The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:\n\n```\n\nsage: f2(y) = e^2*y - y^2\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)\nsage: f.critical_points()\n...\nValueError: No differentiation variable specified.\n\n```\n\n* I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):\n\n```\nsage: g.derivative()\nPiecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]\n```\n\nChristian",
    "created_at": "2012-12-22T14:26:12Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165418",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:6'></a>
Hello Andrew,

thank you for the patch. It indeed seems to solve the reported problem. However, allow me to make a few remarks:

* I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches
* I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial. I can do the following:

```
sage: f1(y) = y^0
sage: f2(y) = 10*y - y^2
sage: f3(y) = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
sage: f.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
sage: z = var("z")                                           
sage: g = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], z)
sage: g.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
```
* From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.
* The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:

```

sage: f2(y) = e^2*y - y^2
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
sage: f.critical_points()
...
ValueError: No differentiation variable specified.

```

* I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):

```
sage: g.derivative()
Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]
```

Christian



---

archive/issue_events_118706.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2012-12-22T14:26:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118706"
}
```



---

archive/issue_events_118707.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2012-12-22T14:26:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118707"
}
```



---

archive/issue_events_118708.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2012-12-22T15:48:59Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "rename": {
        "from": "PiecewisePolynomial.critical_points() results depend on variable of function",
        "to": "Fix variable dependence in PiecewisePolynomial"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118708"
}
```



---

archive/issue_comments_165419.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -30,6 +30,8 @@\n []\n ```\n \n-IMHO it should be possible to optain correct results no matter what the name of the variable is.\n+The wrong variable is also used (to varying effects) in the functions trapezoid() and derivative(). Multiple fourier series functions also use the wrong variable, but it doesn't affect the result. The Laplace transform also uses the wrong variable, but only if you aren't explicit about it.\n+\n+It should be possible to obtain correct results no matter what the name of the variable is.\n \n \n``````\n",
    "created_at": "2012-12-22T15:48:59Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165419",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -30,6 +30,8 @@
 []
 ```
 
-IMHO it should be possible to optain correct results no matter what the name of the variable is.
+The wrong variable is also used (to varying effects) in the functions trapezoid() and derivative(). Multiple fourier series functions also use the wrong variable, but it doesn't affect the result. The Laplace transform also uses the wrong variable, but only if you aren't explicit about it.
+
+It should be possible to obtain correct results no matter what the name of the variable is.
 
 
``````




---

archive/issue_comments_165420.json:
```json
{
    "body": "<a id='comment:9'></a>\nI was going to change laplace too, but after looking at it more closely I decided to leave it alone.\nI had no idea what to do with convolution().\n\nReplying to [christiankuper](#comment%3A6):\n> * I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches\n\nNo, it was a mistake, sorry.\n> * I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial.\n\nI put this in the doctest because Burcin suggested I made sure that default_variable() worked well, but it does seem a little redundant.\n> * From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.\n\nFixed this.\n> * The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:\n> \n> ```\n> \n> sage: f2(y) = e^2*y - y^2\n> sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)\n> sage: f.critical_points()\n> ...\n> ValueError: No differentiation variable specified.\n> \n> ```\n> \n\nThis also fails if you try to do it in the current version of SAGE (with x as a variable). So yes, it is a bug in maxima. Also, I get the error\n\n```\nTypeError: ECL says: Error executing code in Maxima: allroots: expected\na polynomial in one variable; found variables [%e,x]\n```\ninstead of a ValueError.\n> * I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):\n> \n> ```\n> sage: g.derivative()\n> Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]\n> ```\n\nChanged the description to reflect this.",
    "created_at": "2012-12-22T21:04:17Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165420",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:9'></a>
I was going to change laplace too, but after looking at it more closely I decided to leave it alone.
I had no idea what to do with convolution().

Replying to [christiankuper](#comment%3A6):
> * I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches

No, it was a mistake, sorry.
> * I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial.

I put this in the doctest because Burcin suggested I made sure that default_variable() worked well, but it does seem a little redundant.
> * From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.

Fixed this.
> * The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:
> 
> ```
> 
> sage: f2(y) = e^2*y - y^2
> sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
> sage: f.critical_points()
> ...
> ValueError: No differentiation variable specified.
> 
> ```
> 

This also fails if you try to do it in the current version of SAGE (with x as a variable). So yes, it is a bug in maxima. Also, I get the error

```
TypeError: ECL says: Error executing code in Maxima: allroots: expected
a polynomial in one variable; found variables [%e,x]
```
instead of a ValueError.
> * I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):
> 
> ```
> sage: g.derivative()
> Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]
> ```

Changed the description to reflect this.



---

archive/issue_comments_165421.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -30,8 +30,16 @@\n []\n ```\n \n-The wrong variable is also used (to varying effects) in the functions trapezoid() and derivative(). Multiple fourier series functions also use the wrong variable, but it doesn't affect the result. The Laplace transform also uses the wrong variable, but only if you aren't explicit about it.\n+A variable besides default_variable() is also used (to varying effects) in the functions trapezoid(), derivative(), tangent_line() and convolution(). The fourier series functions that find coefficients use a variable other than default_variable() in the code, but it doesn't affect output, and probably doesn't need to be changed. However, the _fourier_series_helper() function probably should be changed.\n \n-It should be possible to obtain correct results no matter what the name of the variable is.\n+```\n+sage: y = var('y')\n+sage: f(y) = y^2\n+sage: f = Piecewise([[(-1, 1),f]])\n+sage: f._fourier_series_helper(3, 1, lambda n: 1)\n+-4*cos(pi*x)/pi^2 + cos(2*pi*x)/pi^2 + 1/3\n+```\n+\n+It should be possible to obtain consistent results no matter what the name of the variable is.\n \n \n``````\n",
    "created_at": "2012-12-22T21:04:17Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165421",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -30,8 +30,16 @@
 []
 ```
 
-The wrong variable is also used (to varying effects) in the functions trapezoid() and derivative(). Multiple fourier series functions also use the wrong variable, but it doesn't affect the result. The Laplace transform also uses the wrong variable, but only if you aren't explicit about it.
+A variable besides default_variable() is also used (to varying effects) in the functions trapezoid(), derivative(), tangent_line() and convolution(). The fourier series functions that find coefficients use a variable other than default_variable() in the code, but it doesn't affect output, and probably doesn't need to be changed. However, the _fourier_series_helper() function probably should be changed.
 
-It should be possible to obtain correct results no matter what the name of the variable is.
+```
+sage: y = var('y')
+sage: f(y) = y^2
+sage: f = Piecewise([[(-1, 1),f]])
+sage: f._fourier_series_helper(3, 1, lambda n: 1)
+-4*cos(pi*x)/pi^2 + cos(2*pi*x)/pi^2 + 1/3
+```
+
+It should be possible to obtain consistent results no matter what the name of the variable is.
 
 
``````




---

archive/issue_events_118709.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2012-12-25T17:30:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118709"
}
```



---

archive/issue_events_118710.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2012-12-25T17:30:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118710"
}
```



---

archive/issue_comments_165422.json:
```json
{
    "body": "<a id='comment:11'></a>\nCould you please \n\n* fold the patches into one patch\n\n* replace everywhere the sentence \"trac #13836\" by the automatic link <code>:trac:\\`13836\\`</code>",
    "created_at": "2013-01-04T14:05:39Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165422",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>
Could you please 

* fold the patches into one patch

* replace everywhere the sentence "trac #13836" by the automatic link <code>:trac:\`13836\`</code>



---

archive/issue_comments_165423.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [chapoton](#comment%3A11):\n> * replace everywhere the sentence \"trac #13836\" by the automatic link :trac:`13836`\n\nI'm not sure where I need to do this. Do you mean in the doctests?",
    "created_at": "2013-01-04T14:23:30Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165423",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:13'></a>
Replying to [chapoton](#comment%3A11):
> * replace everywhere the sentence "trac #13836" by the automatic link :trac:`13836`

I'm not sure where I need to do this. Do you mean in the doctests?



---

archive/issue_comments_165424.json:
```json
{
    "body": "<a id='comment:14'></a>\n> > * replace everywhere the sentence \"trac #13836\" by the automatic link :trac:`13836`\n\n> I'm not sure where I need to do this. Do you mean in the doctests?\n\nCorrect, in [attachment:trac_13836_piecewise_critpoints_withdoc.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch) and [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch) there are three references to `#13836`.\n\nOr is only [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch) needed?  You should make that clear in the ticket Description.",
    "created_at": "2013-01-04T14:59:44Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165424",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:14'></a>
> > * replace everywhere the sentence "trac #13836" by the automatic link :trac:`13836`

> I'm not sure where I need to do this. Do you mean in the doctests?

Correct, in [attachment:trac_13836_piecewise_critpoints_withdoc.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch) and [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch) there are three references to `#13836`.

Or is only [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch) needed?  You should make that clear in the ticket Description.



---

archive/issue_comments_165425.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -42,4 +42,5 @@\n \n It should be possible to obtain consistent results no matter what the name of the variable is.\n \n+Reviewers: The final patch is trac_13836_piecewise_var_fix.patch. This is the only patch that needs to be reviewed, all other patches were works in progress.\n \n``````\n",
    "created_at": "2013-01-05T22:56:53Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165425",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -42,4 +42,5 @@
 
 It should be possible to obtain consistent results no matter what the name of the variable is.
 
+Reviewers: The final patch is trac_13836_piecewise_var_fix.patch. This is the only patch that needs to be reviewed, all other patches were works in progress.
 
``````




---

archive/issue_comments_165426.json:
```json
{
    "body": "<a id='comment:16'></a>\nSorry, the syntax of the `:trac:` is not quite correct in the latest patch. It should contain <code>\\`</code> symbols, namely <code>:trac:\\`13836\\`</code>\n\nYou should check that it gives a good result when asking for the doc in the notebook.",
    "created_at": "2013-01-06T09:06:05Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165426",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>
Sorry, the syntax of the `:trac:` is not quite correct in the latest patch. It should contain <code>\`</code> symbols, namely <code>:trac:\`13836\`</code>

You should check that it gives a good result when asking for the doc in the notebook.



---

archive/issue_comments_165427.json:
```json
{
    "body": "<a id='comment:17'></a>\nHello Andrew,\n\nI think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using \"x\" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.\n\nWhat would be even nicer than using the default_variable IMHO would be the use of the \"var\" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.\n\nChristian",
    "created_at": "2013-01-07T14:51:37Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165427",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:17'></a>
Hello Andrew,

I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using "x" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.

What would be even nicer than using the default_variable IMHO would be the use of the "var" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.

Christian



---

archive/issue_events_118711.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2013-01-07T14:51:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118711"
}
```



---

archive/issue_events_118712.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2013-01-07T14:51:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118712"
}
```



---

archive/issue_comments_165428.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [christiankuper](#comment%3A17):\n> Hello Andrew,\n> \n> I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using \"x\" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.\n> \n> What would be even nicer than using the default_variable IMHO would be the use of the \"var\" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.\n> \n> Christian\n\nI fixed the critical_points inconsistency, thank you for pointing that out. As for the default_variable(), I was just using what was already written for the purpose, I think it's rather helpful. If var is undefined, we have to end up using default_variable() anyway, so IMHO it would be better to keep it a little simpler.\n\nAndrew\n\nP.S., I fixed a small grammatical error in the docstring for default_variable().",
    "created_at": "2013-01-14T14:13:37Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165428",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:18'></a>
Replying to [christiankuper](#comment%3A17):
> Hello Andrew,
> 
> I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using "x" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.
> 
> What would be even nicer than using the default_variable IMHO would be the use of the "var" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.
> 
> Christian

I fixed the critical_points inconsistency, thank you for pointing that out. As for the default_variable(), I was just using what was already written for the purpose, I think it's rather helpful. If var is undefined, we have to end up using default_variable() anyway, so IMHO it would be better to keep it a little simpler.

Andrew

P.S., I fixed a small grammatical error in the docstring for default_variable().



---

archive/issue_events_118713.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-01-14T14:41:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118713"
}
```



---

archive/issue_events_118714.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-01-14T14:41:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118714"
}
```



---

archive/issue_comments_165429.json:
```json
{
    "body": "<a id='comment:20'></a>\nHello Andrew,\n\nsorry for the long silence but now finally I find time to look into your patch. Running the doctest I currently get one failure:\n\n```\n**********************************************************************\nFile \"/opt/sage-dev3/devel/sage-main/sage/functions/piecewise.py\", line 501:\n    sage: f.trapezoid(4)\nExpected:\n    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*y], [(1/2, 1), 9/2*y - 2], [(1, 3/2), 1/2*y + 2], [(3/2, 2), -7/2*y + 8]]\nGot:\n    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*x], [(1/2, 1), 9/2*x - 2], [(1, 3/2), 1/2*x + 2], [(3/2, 2), -7/2*x + 8]]\n**********************************************************************\n```\n\nI am not sure why this is happening but will try to look into it.\n\nChristian",
    "created_at": "2013-02-10T16:45:55Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165429",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:20'></a>
Hello Andrew,

sorry for the long silence but now finally I find time to look into your patch. Running the doctest I currently get one failure:

```
**********************************************************************
File "/opt/sage-dev3/devel/sage-main/sage/functions/piecewise.py", line 501:
    sage: f.trapezoid(4)
Expected:
    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*y], [(1/2, 1), 9/2*y - 2], [(1, 3/2), 1/2*y + 2], [(3/2, 2), -7/2*y + 8]]
Got:
    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*x], [(1/2, 1), 9/2*x - 2], [(1, 3/2), 1/2*x + 2], [(3/2, 2), -7/2*x + 8]]
**********************************************************************
```

I am not sure why this is happening but will try to look into it.

Christian



---

archive/issue_events_118715.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2013-02-10T16:46:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118715"
}
```



---

archive/issue_events_118716.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2013-02-10T16:46:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118716"
}
```



---

archive/issue_comments_165430.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [christiankuper](#comment%3A20):\n> Running the doctest I currently get one failure:\n\nThat's weird, because when I test piecewise.py everything passes:\n\n```\nandrew@andrew-laptop ~/sage-5.6/devel/sage $ ../../sage -t --long sage/functions/piecewise.py \nsage -t --long \"devel/sage-main/sage/functions/piecewise.py\"\n\t [26.7 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 26.7 seconds\n\n```\n\nI also manually tested the code, (which I assumed to be my addition to the trapezoid docstring) and achieved the expected results.",
    "created_at": "2013-02-10T23:11:09Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165430",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:22'></a>
Replying to [christiankuper](#comment%3A20):
> Running the doctest I currently get one failure:

That's weird, because when I test piecewise.py everything passes:

```
andrew@andrew-laptop ~/sage-5.6/devel/sage $ ../../sage -t --long sage/functions/piecewise.py 
sage -t --long "devel/sage-main/sage/functions/piecewise.py"
	 [26.7 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 26.7 seconds

```

I also manually tested the code, (which I assumed to be my addition to the trapezoid docstring) and achieved the expected results.



---

archive/issue_comments_165431.json:
```json
{
    "body": "<a id='comment:23'></a>\nHmm, that really is weird. Hopefully I loaded the correct patch (trac_13836_piecewise_var_fix.patch?).",
    "created_at": "2013-02-11T18:48:48Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165431",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:23'></a>
Hmm, that really is weird. Hopefully I loaded the correct patch (trac_13836_piecewise_var_fix.patch?).



---

archive/issue_comments_165432.json:
```json
{
    "body": "<a id='comment:24'></a>\nHello Andrew,\n\nfinally found the time to study this patch again. Meanwhile I updated to 5.7 and could not reproduce the error I reported. However, two new ones popped up, although the second one IMHO is just related to me not having build the complete doc.\n\n```\nThe following tests failed:\n\n\n\tsage -t  --long -force_lib \"devel/sage/doc/en/constructions/calculus.rst\"\n\tsage -t  --long -force_lib \"devel/sage/sage/misc/sagedoc.py\"\n```\n\nThe details from the log file:\n\n```\nsage -t  --long -force_lib \"devel/sage/doc/en/constructions/calculus.rst\"\n**********************************************************************\nFile \"/opt/sage-dev3/devel/sage/doc/en/constructions/calculus.rst\", line 377:\n    sage: f.fourier_series_partial_sum(3,pi)\nException raised:\n    Traceback (most recent call last):\n      File \"/opt/sage-dev3/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/opt/sage-dev3/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/opt/sage-dev3/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_16[7]>\", line 1, in <module>\n        f.fourier_series_partial_sum(Integer(3),pi)###line 377:\n    sage: f.fourier_series_partial_sum(3,pi)\n      File \"/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py\", line 1192, in fourier_series_partial_sum\n        return self._fourier_series_helper(N, L, lambda n: 1)\n      File \"/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py\", line 1161, in _fourier_series_helper\n        x = self.default_variable()\n      File \"/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py\", line 719, in default_variable\n        fun = SR(fun)\n      File \"parent.pyx\", line 834, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7415)\n      File \"coerce_maps.pyx\", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3583)\n      File \"coerce_maps.pyx\", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3485)\n      File \"ring.pyx\", line 284, in sage.symbolic.ring.SymbolicRing._element_constructor_ (sage/symbolic/ring.cpp:4879)\n    TypeError\n```\n\nI believe that the error is caused by the fact that piecewise.default_variable() raises a TypeError when lambda functions are used (the example in calculus.rst uses lambda functions). Correct me if I am worng but I don't think this is related to anything you changed in piecewise.\n\nSo I do not know whether this patch can be set to positive review or whether that bug needs to be fixed first.\n\nChristian",
    "created_at": "2013-03-03T12:59:44Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165432",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:24'></a>
Hello Andrew,

finally found the time to study this patch again. Meanwhile I updated to 5.7 and could not reproduce the error I reported. However, two new ones popped up, although the second one IMHO is just related to me not having build the complete doc.

```
The following tests failed:


	sage -t  --long -force_lib "devel/sage/doc/en/constructions/calculus.rst"
	sage -t  --long -force_lib "devel/sage/sage/misc/sagedoc.py"
```

The details from the log file:

```
sage -t  --long -force_lib "devel/sage/doc/en/constructions/calculus.rst"
**********************************************************************
File "/opt/sage-dev3/devel/sage/doc/en/constructions/calculus.rst", line 377:
    sage: f.fourier_series_partial_sum(3,pi)
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage-dev3/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/opt/sage-dev3/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/opt/sage-dev3/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_16[7]>", line 1, in <module>
        f.fourier_series_partial_sum(Integer(3),pi)###line 377:
    sage: f.fourier_series_partial_sum(3,pi)
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 1192, in fourier_series_partial_sum
        return self._fourier_series_helper(N, L, lambda n: 1)
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 1161, in _fourier_series_helper
        x = self.default_variable()
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 719, in default_variable
        fun = SR(fun)
      File "parent.pyx", line 834, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7415)
      File "coerce_maps.pyx", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3583)
      File "coerce_maps.pyx", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3485)
      File "ring.pyx", line 284, in sage.symbolic.ring.SymbolicRing._element_constructor_ (sage/symbolic/ring.cpp:4879)
    TypeError
```

I believe that the error is caused by the fact that piecewise.default_variable() raises a TypeError when lambda functions are used (the example in calculus.rst uses lambda functions). Correct me if I am worng but I don't think this is related to anything you changed in piecewise.

So I do not know whether this patch can be set to positive review or whether that bug needs to be fixed first.

Christian



---

archive/issue_comments_165433.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [christiankuper](#comment%3A24):\n> Correct me if I am worng but I don't think this is related to anything you changed in piecewise.\n\nI don't know any better than you do, perhaps we could get someone else's opinion?",
    "created_at": "2013-03-14T12:40:00Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165433",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:25'></a>
Replying to [christiankuper](#comment%3A24):
> Correct me if I am worng but I don't think this is related to anything you changed in piecewise.

I don't know any better than you do, perhaps we could get someone else's opinion?



---

archive/issue_comments_165434.json:
```json
{
    "body": "<a id='comment:26'></a>\nJust spent a few hours testing and looking into this patch. Forget what I said before: This error  IS caused by this patch. After applying the patch piecewise.py cannot handle lambda functions any more.\n\nChristian",
    "created_at": "2013-03-29T17:02:40Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165434",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:26'></a>
Just spent a few hours testing and looking into this patch. Forget what I said before: This error  IS caused by this patch. After applying the patch piecewise.py cannot handle lambda functions any more.

Christian



---

archive/issue_comments_165435.json:
```json
{
    "body": "Catch errors due to lambda functions",
    "created_at": "2013-03-29T18:14:15Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165435",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

Catch errors due to lambda functions



---

archive/attachments_019341.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13836-rev.patch",
    "asset_url": "tarball://root/attachments/ticket13836/trac_13836-rev.patch",
    "created_at": "2013-03-29T18:16:31Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```



---

archive/issue_comments_165436.json:
```json
{
    "body": "<a id='comment:27'></a>\n**Attachment:** [trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch)",
    "created_at": "2013-03-29T18:16:31Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165436",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:27'></a>
**Attachment:** [trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch)



---

archive/issue_comments_165437.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -44,3 +44,7 @@\n \n Reviewers: The final patch is trac_13836_piecewise_var_fix.patch. This is the only patch that needs to be reviewed, all other patches were works in progress.\n \n+Apply :\n+* [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)\n+* [attachment:trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch)\n+\n``````\n",
    "created_at": "2013-03-29T18:16:31Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165437",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -44,3 +44,7 @@
 
 Reviewers: The final patch is trac_13836_piecewise_var_fix.patch. This is the only patch that needs to be reviewed, all other patches were works in progress.
 
+Apply :
+* [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)
+* [attachment:trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch)
+
``````




---

archive/issue_comments_165438.json:
```json
{
    "body": "<a id='comment:28'></a>\nHello Andrew,\n\nI added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?\n\nChristian",
    "created_at": "2013-03-29T18:32:32Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165438",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:28'></a>
Hello Andrew,

I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?

Christian



---

archive/issue_comments_165439.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [christiankuper](#comment%3A28):\n> Hello Andrew,\n> \n> I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?\n> \n> Christian\n\nLooks good to me! Thanks for figuring it out, I was kind of lost at this part.\n\nAndrew",
    "created_at": "2013-04-01T14:24:07Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165439",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:29'></a>
Replying to [christiankuper](#comment%3A28):
> Hello Andrew,
> 
> I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?
> 
> Christian

Looks good to me! Thanks for figuring it out, I was kind of lost at this part.

Andrew



---

archive/issue_comments_165440.json:
```json
{
    "body": "<a id='comment:30'></a>\n> \n> Looks good to me! Thanks for figuring it out, I was kind of lost at this part.\n> \n> Andrew\n\nI would suggest you put the ticket to 'needs_review' then.",
    "created_at": "2013-04-01T17:46:41Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165440",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:30'></a>
> 
> Looks good to me! Thanks for figuring it out, I was kind of lost at this part.
> 
> Andrew

I would suggest you put the ticket to 'needs_review' then.



---

archive/issue_events_118717.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-04-01T17:47:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118717"
}
```



---

archive/issue_events_118718.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-04-01T17:47:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118718"
}
```



---

archive/issue_comments_165441.json:
```json
{
    "body": "<a id='comment:32'></a>\nAs I could find no more bugs I will put the patch on positive_review. Thanks for the fix.\n\nChristian",
    "created_at": "2013-04-07T12:29:28Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165441",
    "user": "https://trac.sagemath.org/admin/accounts/users/christiankuper"
}
```

<a id='comment:32'></a>
As I could find no more bugs I will put the patch on positive_review. Thanks for the fix.

Christian



---

archive/issue_events_118719.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2013-04-07T12:29:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118719"
}
```



---

archive/issue_events_118720.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/christiankuper",
    "created_at": "2013-04-07T12:29:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118720"
}
```



---

archive/issue_comments_165442.json:
```json
{
    "body": "<a id='comment:33'></a>\n[attachment:trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch) needs a proper commit message.",
    "created_at": "2013-04-08T08:32:16Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165442",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
[attachment:trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch) needs a proper commit message.



---

archive/issue_events_118721.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-08T10:46:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118721"
}
```



---

archive/issue_events_118722.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-08T10:46:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118722"
}
```



---

archive/issue_comments_165443.json:
```json
{
    "body": "<a id='comment:34'></a>\nThe documentation doesn't build properly:\n\n```\ndochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.critical_points:23: WARNING: Literal block expected; none found.\ndochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.trapezoid:36: WARNING: Literal block expected; none found.\n```",
    "created_at": "2013-04-08T10:46:14Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165443",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>
The documentation doesn't build properly:

```
dochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.critical_points:23: WARNING: Literal block expected; none found.
dochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.trapezoid:36: WARNING: Literal block expected; none found.
```



---

archive/attachments_019342.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13836-rev-commit.patch",
    "asset_url": "tarball://root/attachments/ticket13836/trac_13836-rev-commit.patch",
    "created_at": "2013-04-17T12:38:57Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```



---

archive/issue_comments_165444.json:
```json
{
    "body": "**Attachment:** [trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)",
    "created_at": "2013-04-17T12:38:57Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165444",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Attachment:** [trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)



---

archive/issue_comments_165445.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -46,5 +46,5 @@\n \n Apply :\n * [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)\n-* [attachment:trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch)\n+* [attachment:trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)\n \n``````\n",
    "created_at": "2013-04-17T12:40:23Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165445",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -46,5 +46,5 @@
 
 Apply :
 * [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)
-* [attachment:trac_13836-rev.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev.patch)
+* [attachment:trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)
 
``````




---

archive/attachments_019343.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13836_piecewise_var_fix.patch",
    "asset_url": "tarball://root/attachments/ticket13836/trac_13836_piecewise_var_fix.patch",
    "created_at": "2013-04-17T12:40:23Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```



---

archive/issue_comments_165446.json:
```json
{
    "body": "<a id='comment:35'></a>\n**Attachment:** [trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)",
    "created_at": "2013-04-17T12:40:23Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165446",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

<a id='comment:35'></a>
**Attachment:** [trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)



---

archive/issue_events_118723.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-04-17T12:40:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118723"
}
```



---

archive/issue_events_118724.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-04-17T12:40:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118724"
}
```



---

archive/issue_comments_165447.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -42,8 +42,6 @@\n \n It should be possible to obtain consistent results no matter what the name of the variable is.\n \n-Reviewers: The final patch is trac_13836_piecewise_var_fix.patch. This is the only patch that needs to be reviewed, all other patches were works in progress.\n-\n Apply :\n * [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)\n * [attachment:trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)\n``````\n",
    "created_at": "2013-04-17T12:41:20Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165447",
    "user": "https://trac.sagemath.org/admin/accounts/users/afleckenstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -42,8 +42,6 @@
 
 It should be possible to obtain consistent results no matter what the name of the variable is.
 
-Reviewers: The final patch is trac_13836_piecewise_var_fix.patch. This is the only patch that needs to be reviewed, all other patches were works in progress.
-
 Apply :
 * [attachment:trac_13836_piecewise_var_fix.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836_piecewise_var_fix.patch)
 * [attachment:trac_13836-rev-commit.patch](https://github.com/sagemath/sage/files/ticket13836/trac_13836-rev-commit.patch)
``````




---

archive/issue_events_118725.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-05-15T13:30:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118725"
}
```



---

archive/issue_events_118726.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/afleckenstein",
    "created_at": "2013-05-15T13:30:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118726"
}
```



---

archive/issue_comments_165448.json:
```json
{
    "body": "**Merged:** sage-5.10.beta4",
    "created_at": "2013-05-19T08:38:01Z",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13836#issuecomment-165448",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.10.beta4



---

archive/issue_events_118727.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-19T08:38:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118727"
}
```



---

archive/issue_events_118728.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-19T08:38:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13836",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13836#event-118728"
}
```
