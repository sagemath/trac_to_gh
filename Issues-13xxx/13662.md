# Issue 13662: matrix() fails for polynomial quotient rings over inexact rings

archive/issues_013458.json:
```json
{
    "body": "Currently, the following code fails:\n\n```\nsage: R.<x> = Zp(3,2)[]\nsage: S.<xbar> = R.quo(x^2+1)\nsage: xbar.matrix()\nTypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 2 + 2*3 + O(3^2), 0, O(3^2)]!\n```\n\nThe problem is that the p-adic quotient with remainder does not determine the degree of the result and therefore `p%f` might have (inexact zero) coefficients beyond its degree:\n\n```\nsage: R.<x> = Qp(3,5)[]\nsage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))\nsage: xbar^3\n(O(3^5))*xbar^3 + (O(3^2))*xbar^2 + (2*3 + O(3^2))*xbar\n```\n\nJust throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any leading inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:\n\n```\nsage: R.<x> = Qp(3,5)[]\nsage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))\nsage: xbar^3\n(2*3 + O(3^2))*xbar + (O(3^3))\n```\n\n**Assignee:** @roed314\n\n**CC:**  boerner\n\n**Keywords:** sd59, days71\n\n**Branch:** [u/saraedum/ticket/13662](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/13662)\n\n**Commit:** [f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599](https://github.com/sagemath/sagetrac-mirror/commit/f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599)\n\n**Author:** Julian Rueth\n\n**Dependencies:** #14482\n\nIssue created by migration from https://trac.sagemath.org/ticket/13662\n\n",
    "created_at": "2012-10-27T20:43:04Z",
    "labels": [
        "component: padics",
        "minor",
        "bug",
        "needs work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "title": "matrix() fails for polynomial quotient rings over inexact rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/13662",
    "user": "https://github.com/saraedum"
}
```
Currently, the following code fails:

```
sage: R.<x> = Zp(3,2)[]
sage: S.<xbar> = R.quo(x^2+1)
sage: xbar.matrix()
TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 2 + 2*3 + O(3^2), 0, O(3^2)]!
```

The problem is that the p-adic quotient with remainder does not determine the degree of the result and therefore `p%f` might have (inexact zero) coefficients beyond its degree:

```
sage: R.<x> = Qp(3,5)[]
sage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))
sage: xbar^3
(O(3^5))*xbar^3 + (O(3^2))*xbar^2 + (2*3 + O(3^2))*xbar
```

Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any leading inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:

```
sage: R.<x> = Qp(3,5)[]
sage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))
sage: xbar^3
(2*3 + O(3^2))*xbar + (O(3^3))
```

**Assignee:** @roed314

**CC:**  boerner

**Keywords:** sd59, days71

**Branch:** [u/saraedum/ticket/13662](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/13662)

**Commit:** [f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599](https://github.com/sagemath/sagetrac-mirror/commit/f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599)

**Author:** Julian Rueth

**Dependencies:** #14482

Issue created by migration from https://trac.sagemath.org/ticket/13662





---

archive/attachments_018476.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13662.patch",
    "asset_url": "tarball://root/attachments/ticket13662/trac_13662.patch",
    "created_at": "2012-10-27T20:46:46Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13662/trac_13662.patch",
    "user": "https://github.com/saraedum"
}
```



---

archive/issue_comments_162620.json:
```json
{
    "body": "Attachment [trac_13662.patch](https://github.com/sagemath/sage/files/ticket13662/trac_13662.patch) by @saraedum created at 2012-10-27 20:46:46",
    "created_at": "2012-10-27T20:46:46Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162620",
    "user": "https://github.com/saraedum"
}
```

Attachment [trac_13662.patch](https://github.com/sagemath/sage/files/ticket13662/trac_13662.patch) by @saraedum created at 2012-10-27 20:46:46



---

archive/issue_comments_162621.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think this patch is dangerous. Just truncating the list of coefficients without checking will make this code very prone to producing erroneous results silently.\n\nIn this case there is another solution anyway: The present code computes the coefficients of `[self,x*self,x<sup>2*self,...,x</sup>(d-1)*self]` and puts that into a matrix. If your arithmetic is to be trusted, that's probably the more efficient way of doing it. However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.\n\nThere may be other, better solutions too and perhaps the current approach (if equipped with reasonable checks) turns out to be good/better/more efficient and acceptable, but in its current form it seems to me it is masking the underlying problem rather than resolving it.",
    "created_at": "2012-10-29T17:43:22Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162621",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'></a>
I think this patch is dangerous. Just truncating the list of coefficients without checking will make this code very prone to producing erroneous results silently.

In this case there is another solution anyway: The present code computes the coefficients of `[self,x*self,x<sup>2*self,...,x</sup>(d-1)*self]` and puts that into a matrix. If your arithmetic is to be trusted, that's probably the more efficient way of doing it. However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.

There may be other, better solutions too and perhaps the current approach (if equipped with reasonable checks) turns out to be good/better/more efficient and acceptable, but in its current form it seems to me it is masking the underlying problem rather than resolving it.



---

archive/issue_events_116744.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-04-14T13:58:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116744"
}
```



---

archive/issue_comments_162622.json:
```json
{
    "body": "<a id='comment:2'></a>\nI believe this is a duplicate of #13263, however given Nils comment here, I suggest we close #13263.",
    "created_at": "2013-04-14T13:58:59Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162622",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
I believe this is a duplicate of #13263, however given Nils comment here, I suggest we close #13263.



---

archive/issue_events_116745.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116745"
}
```



---

archive/issue_events_116746.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116746"
}
```



---

archive/issue_comments_162623.json:
```json
{
    "body": "**Branch:** [u/saraedum/ticket/13662](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/13662)",
    "created_at": "2013-09-12T15:48:22Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162623",
    "user": "https://github.com/saraedum"
}
```

**Branch:** [u/saraedum/ticket/13662](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/13662)



---

archive/issue_comments_162624.json:
```json
{
    "body": "**Dependencies:** #14482",
    "created_at": "2013-09-12T15:48:28Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162624",
    "user": "https://github.com/saraedum"
}
```

**Dependencies:** #14482



---

archive/issue_events_116747.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2013-09-12T15:49:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116747"
}
```



---

archive/issue_events_116748.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2013-09-12T15:49:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116748"
}
```



---

archive/issue_events_116749.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2013-09-12T15:50:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116749"
}
```



---

archive/issue_events_116750.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2013-09-12T15:50:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116750"
}
```



---

archive/issue_comments_162625.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe comments are correct. This patch is dangerous. I'm fixing this now.",
    "created_at": "2013-09-12T15:50:20Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162625",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:7'></a>
The comments are correct. This patch is dangerous. I'm fixing this now.



---

archive/issue_events_116751.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116751"
}
```



---

archive/issue_events_116752.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116752"
}
```



---

archive/issue_events_116753.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116753"
}
```



---

archive/issue_events_116754.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116754"
}
```



---

archive/issue_events_116755.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116755"
}
```



---

archive/issue_events_116756.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116756"
}
```



---

archive/issue_comments_162626.json:
```json
{
    "body": "**Commit:** [50132187410c11a5c4a5407a28453d14446b87d2](https://github.com/sagemath/sagetrac-mirror/commit/50132187410c11a5c4a5407a28453d14446b87d2)",
    "created_at": "2014-06-25T21:39:17Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162626",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [50132187410c11a5c4a5407a28453d14446b87d2](https://github.com/sagemath/sagetrac-mirror/commit/50132187410c11a5c4a5407a28453d14446b87d2)



---

archive/issue_comments_162627.json:
```json
{
    "body": "<a id='comment:11'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/81e66ebd53f4e76adac2511cf7127ef7bb5cc7a7\">81e66eb</a></td><td><code>Merge branch 'develop' into ticket/13662</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/50132187410c11a5c4a5407a28453d14446b87d2\">5013218</a></td><td><code>Improve handling of leading zero coefficients in polynomial quotient rings</code></td></tr></table>\n",
    "created_at": "2014-06-25T21:39:17Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162627",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/81e66ebd53f4e76adac2511cf7127ef7bb5cc7a7">81e66eb</a></td><td><code>Merge branch 'develop' into ticket/13662</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/50132187410c11a5c4a5407a28453d14446b87d2">5013218</a></td><td><code>Improve handling of leading zero coefficients in polynomial quotient rings</code></td></tr></table>




---

archive/issue_comments_162628.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd59\".",
    "created_at": "2014-06-25T21:39:35Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162628",
    "user": "https://github.com/saraedum"
}
```

**Changing keywords** from "" to "sd59".



---

archive/issue_events_116757.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-25T21:39:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116757"
}
```



---

archive/issue_events_116758.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-25T21:39:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116758"
}
```



---

archive/issue_comments_162629.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [nbruin](#comment%3A1):\n> However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.\n\nI decided to just reduce leading zero coefficients mod `f` explicitly when creating the quotient ring elements. This appears to be the right thing to do to me. A different algorithm to compute the matrix would be an alternative of course. I just did what appeared to be easier to implement.",
    "created_at": "2014-06-25T21:43:04Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162629",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:13'></a>
Replying to [nbruin](#comment%3A1):
> However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.

I decided to just reduce leading zero coefficients mod `f` explicitly when creating the quotient ring elements. This appears to be the right thing to do to me. A different algorithm to compute the matrix would be an alternative of course. I just did what appeared to be easier to implement.



---

archive/issue_events_116759.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-29T08:24:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116759"
}
```



---

archive/issue_events_116760.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-29T08:24:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116760"
}
```



---

archive/issue_comments_162630.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis failing doctest is a problem:\n\n```\n             sage: L.series(4)         # takes a long time (several seconds)\n-            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)\n+            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)\n```\nThe precision should only go down by this change.",
    "created_at": "2014-06-29T08:25:17Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162630",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:15'></a>
This failing doctest is a problem:

```
             sage: L.series(4)         # takes a long time (several seconds)
-            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
+            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
```
The precision should only go down by this change.



---

archive/issue_comments_162631.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,4 +7,20 @@\n TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]\n ```\n \n-The attached patch fixes this.\n+The problem is that the p-adic quotient with remainder does not determine the degree of the result and therefore `p%f` might have (inexact zero) coefficients beyond its degree:\n+\n+```\n+sage: R.<x> = Qp(3,5)[]\n+sage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))\n+sage: xbar^3\n+(O(3^5))*xbar^3 + (O(3^2))*xbar^2 + (2*3 + O(3^2))*xbar\n+```\n+\n+Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:\n+\n+```\n+sage: R.<x> = Qp(3,5)[]\n+sage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))\n+sage: xbar^3\n+(2*3 + O(3^2))*xbar + (O(3^3))\n+```\n``````\n",
    "created_at": "2014-06-29T20:26:06Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162631",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,4 +7,20 @@
 TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]
 ```
 
-The attached patch fixes this.
+The problem is that the p-adic quotient with remainder does not determine the degree of the result and therefore `p%f` might have (inexact zero) coefficients beyond its degree:
+
+```
+sage: R.<x> = Qp(3,5)[]
+sage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))
+sage: xbar^3
+(O(3^5))*xbar^3 + (O(3^2))*xbar^2 + (2*3 + O(3^2))*xbar
+```
+
+Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:
+
+```
+sage: R.<x> = Qp(3,5)[]
+sage: S.<xbar> = R.quo(x^2 + (O(3^2)*x) + (3+O(3^2)))
+sage: xbar^3
+(2*3 + O(3^2))*xbar + (O(3^3))
+```
``````




---

archive/issue_comments_162632.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -16,7 +16,7 @@\n (O(3^5))*xbar^3 + (O(3^2))*xbar^2 + (2*3 + O(3^2))*xbar\n ```\n \n-Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:\n+Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any leading inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:\n \n ```\n sage: R.<x> = Qp(3,5)[]\n``````\n",
    "created_at": "2014-06-29T20:26:49Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162632",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -16,7 +16,7 @@
 (O(3^5))*xbar^3 + (O(3^2))*xbar^2 + (2*3 + O(3^2))*xbar
 ```
 
-Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:
+Just throwing away such coefficients would be wrong however. In the above example this would give `(2*3 + O(3^2))*xbar` with an *exact* constant coefficient `0` which is incorrect. The correct thing to do is to reduce any leading inexact zero coefficients with the defining equation of the quotient. This is done in this ticket and gives the correct result:
 
 ```
 sage: R.<x> = Qp(3,5)[]
``````




---

archive/issue_comments_162633.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,9 +2,9 @@\n \n ```\n sage: R.<x> = Zp(3,2)[]\n-sage: S.<xbar> = R.quo(x^2)\n+sage: S.<xbar> = R.quo(x^2+1)\n sage: xbar.matrix()\n-TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]\n+TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 2 + 2*3 + O(3^2), 0, O(3^2)]!\n ```\n \n The problem is that the p-adic quotient with remainder does not determine the degree of the result and therefore `p%f` might have (inexact zero) coefficients beyond its degree:\n``````\n",
    "created_at": "2014-06-29T20:32:56Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162633",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,9 +2,9 @@
 
 ```
 sage: R.<x> = Zp(3,2)[]
-sage: S.<xbar> = R.quo(x^2)
+sage: S.<xbar> = R.quo(x^2+1)
 sage: xbar.matrix()
-TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]
+TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 2 + 2*3 + O(3^2), 0, O(3^2)]!
 ```
 
 The problem is that the p-adic quotient with remainder does not determine the degree of the result and therefore `p%f` might have (inexact zero) coefficients beyond its degree:
``````




---

archive/issue_comments_162634.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [saraedum](#comment%3A15):\n> This failing doctest is a problem:\n> \n> ```\n>              sage: L.series(4)         # takes a long time (several seconds)\n> -            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)\n> +            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)\n> ```\n> The precision should only go down by this change.\n\nI put a comment in the last commit which clarifies what is happening here.",
    "created_at": "2014-06-29T21:19:35Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162634",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:19'></a>
Replying to [saraedum](#comment%3A15):
> This failing doctest is a problem:
> 
> ```
>              sage: L.series(4)         # takes a long time (several seconds)
> -            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
> +            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
> ```
> The precision should only go down by this change.

I put a comment in the last commit which clarifies what is happening here.



---

archive/issue_comments_162635.json:
```json
{
    "body": "<a id='comment:20'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7ab7a907bea0612521e5e7d76e1f9f14bc2964bc\">7ab7a90</a></td><td><code>Make sure that quotient ring elements have no leading zero coefficients</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/73c5c05998c375a92b938dde4104c1d87fbf5b1d\">73c5c05</a></td><td><code>Minor fix to docstring of pAdicLseries.alpha()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ce6984ad2c58e11fce661af3cc276f240170c61\">6ce6984</a></td><td><code>Slight precision gain for a p-adic L-series</code></td></tr></table>\n",
    "created_at": "2014-06-29T21:33:44Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162635",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7ab7a907bea0612521e5e7d76e1f9f14bc2964bc">7ab7a90</a></td><td><code>Make sure that quotient ring elements have no leading zero coefficients</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/73c5c05998c375a92b938dde4104c1d87fbf5b1d">73c5c05</a></td><td><code>Minor fix to docstring of pAdicLseries.alpha()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ce6984ad2c58e11fce661af3cc276f240170c61">6ce6984</a></td><td><code>Slight precision gain for a p-adic L-series</code></td></tr></table>




---

archive/issue_comments_162636.json:
```json
{
    "body": "**Changing commit** from \"[50132187410c11a5c4a5407a28453d14446b87d2](https://github.com/sagemath/sagetrac-mirror/commit/50132187410c11a5c4a5407a28453d14446b87d2)\" to \"[6ce6984ad2c58e11fce661af3cc276f240170c61](https://github.com/sagemath/sagetrac-mirror/commit/6ce6984ad2c58e11fce661af3cc276f240170c61)\".",
    "created_at": "2014-06-29T21:33:44Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162636",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[50132187410c11a5c4a5407a28453d14446b87d2](https://github.com/sagemath/sagetrac-mirror/commit/50132187410c11a5c4a5407a28453d14446b87d2)" to "[6ce6984ad2c58e11fce661af3cc276f240170c61](https://github.com/sagemath/sagetrac-mirror/commit/6ce6984ad2c58e11fce661af3cc276f240170c61)".



---

archive/issue_events_116761.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-29T21:34:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116761"
}
```



---

archive/issue_events_116762.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-06-29T21:34:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116762"
}
```



---

archive/issue_events_116763.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-06-30T08:11:53Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "rename": {
        "from": "matrix() fails for polynomial quoutient rings over inexact rings",
        "to": "matrix() fails for polynomial quotient rings over inexact rings"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116763"
}
```



---

archive/issue_events_116764.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116764"
}
```



---

archive/issue_events_116765.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116765"
}
```



---

archive/issue_comments_162637.json:
```json
{
    "body": "<a id='comment:24'></a>\nMichel, I imagine you know how to do the L-series computations, so you can probably even verify that the added precision did not produce incorrect coefficients.",
    "created_at": "2015-02-02T22:25:42Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162637",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:24'></a>
Michel, I imagine you know how to do the L-series computations, so you can probably even verify that the added precision did not produce incorrect coefficients.



---

archive/issue_comments_162638.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599\">f6a90b0</a></td><td><code>Merge branch 'develop' into t/13662/ticket/13662</code></td></tr></table>\n",
    "created_at": "2016-03-16T20:50:42Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162638",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599">f6a90b0</a></td><td><code>Merge branch 'develop' into t/13662/ticket/13662</code></td></tr></table>




---

archive/issue_comments_162639.json:
```json
{
    "body": "**Changing commit** from \"[6ce6984ad2c58e11fce661af3cc276f240170c61](https://github.com/sagemath/sagetrac-mirror/commit/6ce6984ad2c58e11fce661af3cc276f240170c61)\" to \"[f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599](https://github.com/sagemath/sagetrac-mirror/commit/f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599)\".",
    "created_at": "2016-03-16T20:50:42Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162639",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[6ce6984ad2c58e11fce661af3cc276f240170c61](https://github.com/sagemath/sagetrac-mirror/commit/6ce6984ad2c58e11fce661af3cc276f240170c61)" to "[f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599](https://github.com/sagemath/sagetrac-mirror/commit/f6a90b0d5b3f800d3a4e6cdcc4c60f42f9f49599)".



---

archive/issue_comments_162640.json:
```json
{
    "body": "<a id='comment:26'></a>\nQuick question about formatting, why when you are looking at examples like:\n\n```\nsage: E = EllipticCurve('37a1')\nsage: E.is_ordinary(3)\nFalse\nsage: E.is_ordinary(5)\nTrue\nsage: L = E.padic_lseries(3)\nsage: alpha = L.alpha(10)\nsage: alpha^2 - E.ap(3)*alpha + 3\n(O(3^11))*alpha + (O(3^11))\nsage: L = E.padic_lseries(5)\nsage: alpha = L.alpha(10)\nsage: alpha^2 - E.ap(5)*alpha + 5\nO(5^10)\n```\nWhat's going on in the ordinary versus supersingular case?",
    "created_at": "2016-03-24T00:12:40Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162640",
    "user": "https://github.com/adeines"
}
```

<a id='comment:26'></a>
Quick question about formatting, why when you are looking at examples like:

```
sage: E = EllipticCurve('37a1')
sage: E.is_ordinary(3)
False
sage: E.is_ordinary(5)
True
sage: L = E.padic_lseries(3)
sage: alpha = L.alpha(10)
sage: alpha^2 - E.ap(3)*alpha + 3
(O(3^11))*alpha + (O(3^11))
sage: L = E.padic_lseries(5)
sage: alpha = L.alpha(10)
sage: alpha^2 - E.ap(5)*alpha + 5
O(5^10)
```
What's going on in the ordinary versus supersingular case?



---

archive/issue_comments_162641.json:
```json
{
    "body": "**Changing keywords** from \"sd59\" to \"sd59, days71\".",
    "created_at": "2016-03-31T16:25:46Z",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13662#issuecomment-162641",
    "user": "https://github.com/jbalakrishnan"
}
```

**Changing keywords** from "sd59" to "sd59, days71".



---

archive/issue_events_116766.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-04-08T11:18:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116766"
}
```



---

archive/issue_events_116767.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2016-04-08T11:18:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13662",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13662#event-116767"
}
```
