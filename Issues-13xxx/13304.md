# Issue 13304: Very inefficient scalar multiplication on FreeModule_ambient with somewhat large rank

archive/issues_013132.json:
```json
{
    "assignees": [
        "https://github.com/dansme"
    ],
    "body": "<div id=\"comment:0\"></div>\n\nAs reported in a [thread in sage-support](https://groups.google.com/d/topic/sage-support/jlLTyY-8H8c/discussion) trivial scalar multiplication in `FreeModule_ambient` can be extremely slow or lead to out of memory errors:\n\n```\nn = 10000\nv = vector([0]*n)   # ok so far\nv2 = v/1            # kaboom\n```\n\nThe problem is that, during coercion, `_an_element_impl()` and in turn `gen(0)` of `FreeModule_ambient` gets called. The default implementation of `gen` calls `basis()`, computing the entire standard basis, and then returns the first basis vector.\n\n\n\nCC:  @jdemeyer\n\nComponent: **linear algebra**\n\nAuthor: **Daniel Smertnig, Marc Mezzarobba**\n\nBranch/Commit: **[`8f09d51`](https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce)**\n\nReviewer: **Vincent Delecroix**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13304_\n\n",
    "closed_at": "2015-02-21T12:40:44Z",
    "created_at": "2012-07-27T11:24:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Very inefficient scalar multiplication on FreeModule_ambient with somewhat large rank",
    "type": "issue",
    "updated_at": "2015-02-21T12:40:44Z",
    "url": "https://github.com/sagemath/sage/issues/13304",
    "user": "https://github.com/dansme"
}
```
<div id="comment:0"></div>

As reported in a [thread in sage-support](https://groups.google.com/d/topic/sage-support/jlLTyY-8H8c/discussion) trivial scalar multiplication in `FreeModule_ambient` can be extremely slow or lead to out of memory errors:

```
n = 10000
v = vector([0]*n)   # ok so far
v2 = v/1            # kaboom
```

The problem is that, during coercion, `_an_element_impl()` and in turn `gen(0)` of `FreeModule_ambient` gets called. The default implementation of `gen` calls `basis()`, computing the entire standard basis, and then returns the first basis vector.



CC:  @jdemeyer

Component: **linear algebra**

Author: **Daniel Smertnig, Marc Mezzarobba**

Branch/Commit: **[`8f09d51`](https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce)**

Reviewer: **Vincent Delecroix**

_Issue created by migration from https://trac.sagemath.org/ticket/13304_





---

archive/issue_events_183758.json:
```json
{
    "actor": "https://github.com/dansme",
    "created_at": "2012-07-27T11:24:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183758"
}
```



---

archive/issue_events_183759.json:
```json
{
    "actor": "https://github.com/dansme",
    "created_at": "2012-07-27T11:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "c: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183759"
}
```



---

archive/issue_events_183760.json:
```json
{
    "actor": "https://github.com/dansme",
    "created_at": "2012-07-27T11:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183760"
}
```



---

archive/issue_events_183761.json:
```json
{
    "actor": "https://github.com/dansme",
    "created_at": "2012-07-27T11:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183761"
}
```



---

archive/issue_events_183762.json:
```json
{
    "actor": "https://github.com/dansme",
    "created_at": "2012-07-27T11:24:49Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "subject": "https://github.com/dansme",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183762"
}
```



---

archive/issue_comments_153755.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAttachment: **[trac_13304_gen_speedup.patch.gz](https://github.com/sagemath/sage/files/ticket13304/trac_13304_gen_speedup.patch.gz)**\n\nThe patch overrides `gen` in `FreeModule_ambient` to avoid generating the entire standard basis.",
    "created_at": "2012-07-27T11:27:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153755",
    "user": "https://github.com/dansme"
}
```

<div id="comment:1" align="right">comment:1</div>

Attachment: **[trac_13304_gen_speedup.patch.gz](https://github.com/sagemath/sage/files/ticket13304/trac_13304_gen_speedup.patch.gz)**

The patch overrides `gen` in `FreeModule_ambient` to avoid generating the entire standard basis.



---

archive/issue_events_183763.json:
```json
{
    "actor": "https://github.com/dansme",
    "created_at": "2012-07-31T09:47:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183763"
}
```



---

archive/issue_comments_153756.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThe change looks fine to me and passes all tests. Maybe you should\n- fill in your real name as Author of this ticket\n- add your name to the author section of the file\n- mark the doctest with the ticket number as an in-line comment\n- explain the speed efficiency gained after applying the patch.",
    "created_at": "2012-08-30T11:12:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153756",
    "user": "https://github.com/sagetrac-tfeulner"
}
```

<div id="comment:3" align="right">comment:3</div>

The change looks fine to me and passes all tests. Maybe you should
- fill in your real name as Author of this ticket
- add your name to the author section of the file
- mark the doctest with the ticket number as an in-line comment
- explain the speed efficiency gained after applying the patch.



---

archive/issue_comments_153757.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIt's possible that calling `base_ring().one_element()` is a bit faster than converting the integer 1 into the ring every time. The method `one_element`normally gets cached.\n\nWhat's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast. With your patch this caching doesn't get triggered by asking for one basis vector any more. Code that previously benefited m might see a decrease in speed (which can be solved by first explicitly asking for the whole basis to trigger caching).\n\nIt might still be a good idea to not cache, but you might document the possible pitfall.",
    "created_at": "2012-08-30T15:54:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153757",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

It's possible that calling `base_ring().one_element()` is a bit faster than converting the integer 1 into the ring every time. The method `one_element`normally gets cached.

What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast. With your patch this caching doesn't get triggered by asking for one basis vector any more. Code that previously benefited m might see a decrease in speed (which can be solved by first explicitly asking for the whole basis to trigger caching).

It might still be a good idea to not cache, but you might document the possible pitfall.



---

archive/issue_comments_153758.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThe question is, in which situations do we actually ask for the basis of the ambient space? I found out that there is a similar problem when constructing subspaces, see\n[sage-devel](https://groups.google.com/d/topic/sage-devel/ULcyJECqT4M/discussion). Unfortunately, this is not solved with this patch.\n\nSurprisingly, there is a difference between the fields `GF(4, 'a')` and `QQ`.",
    "created_at": "2012-08-31T06:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153758",
    "user": "https://github.com/sagetrac-tfeulner"
}
```

<div id="comment:5" align="right">comment:5</div>

The question is, in which situations do we actually ask for the basis of the ambient space? I found out that there is a similar problem when constructing subspaces, see
[sage-devel](https://groups.google.com/d/topic/sage-devel/ULcyJECqT4M/discussion). Unfortunately, this is not solved with this patch.

Surprisingly, there is a difference between the fields `GF(4, 'a')` and `QQ`.



---

archive/issue_events_183764.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183764"
}
```



---

archive/issue_events_183765.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183765"
}
```



---

archive/issue_events_183766.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-12-02T15:57:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183766"
}
```



---

archive/issue_events_183767.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-12-02T15:57:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183767"
}
```



---

archive/issue_comments_153759.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\n(from the previous comments, it looks like the patch in its current state is not waiting for a review)",
    "created_at": "2013-12-02T15:57:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153759",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:7" align="right">comment:7</div>

(from the previous comments, it looks like the patch in its current state is not waiting for a review)



---

archive/issue_events_183768.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183768"
}
```



---

archive/issue_events_183769.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183769"
}
```



---

archive/issue_comments_153760.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nSee also #10262.\n\nReplying to [@nbruin](#comment%3A4):\n> What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast.\n\nIf I understand correctly, the basis we are talking about is essentially the identity matrix. In fact, I am not convinced caching it (strongly at least) is such a good idea even in general\u2014either recomputing it or computing whatever information one really needs instead sounds better in all cases I can think of. But in any case I think it is insane to call a function that may keep in cache a basis of, say, \u2124<sup>10000</sup>, unless one absolutely needs the whole basis!",
    "created_at": "2014-03-16T12:55:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153760",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:9" align="right">comment:9</div>

See also #10262.

Replying to [@nbruin](#comment%3A4):
> What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast.

If I understand correctly, the basis we are talking about is essentially the identity matrix. In fact, I am not convinced caching it (strongly at least) is such a good idea even in general—either recomputing it or computing whatever information one really needs instead sounds better in all cases I can think of. But in any case I think it is insane to call a function that may keep in cache a basis of, say, ℤ<sup>10000</sup>, unless one absolutely needs the whole basis!



---

archive/issue_comments_153761.json:
```json
{
    "body": "Author: **Daniel Smertnig, Marc Mezzarobba**",
    "created_at": "2014-03-16T13:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153761",
    "user": "https://github.com/mezzarobba"
}
```

Author: **Daniel Smertnig, Marc Mezzarobba**



---

archive/issue_comments_153762.json:
```json
{
    "body": "Branch: **[u/mmezzarobba/13304-free_module_ambient+coerce](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/13304-free_module_ambient+coerce)**",
    "created_at": "2014-03-16T13:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153762",
    "user": "https://github.com/mezzarobba"
}
```

Branch: **[u/mmezzarobba/13304-free_module_ambient+coerce](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/13304-free_module_ambient+coerce)**



---

archive/issue_comments_153763.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3c87ef3761f382386c9080e1650fd950e4a8d5eb\"><code>3c87ef3</code></a></td><td><code>Trac 13304: FreeModule_Ambient.gen speedup</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8fd7f887c5485001dbb8f6b2919db06ae8e686e2\"><code>8fd7f88</code></a></td><td><code>Implement reviewer suggestions, + cosmetic changes</code></td></tr></table>\n",
    "created_at": "2014-03-16T13:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153763",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:10"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3c87ef3761f382386c9080e1650fd950e4a8d5eb"><code>3c87ef3</code></a></td><td><code>Trac 13304: FreeModule_Ambient.gen speedup</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8fd7f887c5485001dbb8f6b2919db06ae8e686e2"><code>8fd7f88</code></a></td><td><code>Implement reviewer suggestions, + cosmetic changes</code></td></tr></table>




---

archive/issue_comments_153764.json:
```json
{
    "body": "Commit: **[`8fd7f88`](https://github.com/sagemath/sagetrac-mirror/commit/8fd7f887c5485001dbb8f6b2919db06ae8e686e2)**",
    "created_at": "2014-03-16T13:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153764",
    "user": "https://github.com/mezzarobba"
}
```

Commit: **[`8fd7f88`](https://github.com/sagemath/sagetrac-mirror/commit/8fd7f887c5485001dbb8f6b2919db06ae8e686e2)**



---

archive/issue_events_183770.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2014-03-16T13:26:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183770"
}
```



---

archive/issue_events_183771.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2014-03-16T13:26:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183771"
}
```



---

archive/issue_comments_153765.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI opened a separate ticket (#15953) for the more general issue of whether and when to cache the basis.",
    "created_at": "2014-03-16T13:26:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153765",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:11" align="right">comment:11</div>

I opened a separate ticket (#15953) for the more general issue of whether and when to cache the basis.



---

archive/issue_events_183772.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2014-03-25T08:17:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183772"
}
```



---

archive/issue_events_183773.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2014-03-25T08:17:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183773"
}
```



---

archive/issue_events_183774.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183774"
}
```



---

archive/issue_events_183775.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183775"
}
```



---

archive/issue_events_183776.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183776"
}
```



---

archive/issue_events_183777.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183777"
}
```



---

archive/issue_comments_153766.json:
```json
{
    "body": "Changed branch from **[u/mmezzarobba/13304-free_module_ambient+coerce](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/13304-free_module_ambient+coerce)** to **[public/ticket/13304](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/13304)**",
    "created_at": "2014-10-10T19:32:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153766",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/mmezzarobba/13304-free_module_ambient+coerce](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/13304-free_module_ambient+coerce)** to **[public/ticket/13304](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/13304)**



---

archive/issue_comments_153767.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI just made a small clean-up and checked that doc builds and look nice.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8fba50fce907d370e717f29503cb89b31f94a219\"><code>8fba50f</code></a></td><td><code>Merge with 6.4.beta4</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce\"><code>8f09d51</code></a></td><td><code>trac #13304 put raise statement into py3 shape, plus minor cleanup</code></td></tr></table>\n",
    "created_at": "2014-10-10T19:32:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153767",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:15" align="right">comment:15</div>

I just made a small clean-up and checked that doc builds and look nice.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8fba50fce907d370e717f29503cb89b31f94a219"><code>8fba50f</code></a></td><td><code>Merge with 6.4.beta4</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce"><code>8f09d51</code></a></td><td><code>trac #13304 put raise statement into py3 shape, plus minor cleanup</code></td></tr></table>




---

archive/issue_comments_153768.json:
```json
{
    "body": "Changed commit from **[`8fd7f88`](https://github.com/sagemath/sagetrac-mirror/commit/8fd7f887c5485001dbb8f6b2919db06ae8e686e2)** to **[`8f09d51`](https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce)**",
    "created_at": "2014-10-10T19:32:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153768",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[`8fd7f88`](https://github.com/sagemath/sagetrac-mirror/commit/8fd7f887c5485001dbb8f6b2919db06ae8e686e2)** to **[`8f09d51`](https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce)**



---

archive/issue_comments_153769.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nFr\u00e9d\u00e9ric, did you review the commits prior to yours?",
    "created_at": "2015-02-05T16:21:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153769",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:16" align="right">comment:16</div>

Frédéric, did you review the commits prior to yours?



---

archive/issue_comments_153770.json:
```json
{
    "body": "Reviewer: **Vincent Delecroix**",
    "created_at": "2015-02-08T15:55:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153770",
    "user": "https://github.com/videlec"
}
```

Reviewer: **Vincent Delecroix**



---

archive/issue_events_183778.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-02-08T15:55:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183778"
}
```



---

archive/issue_events_183779.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-02-08T15:55:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183779"
}
```



---

archive/issue_comments_153771.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nHello,\n\nYou got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way\n\n```\n    coefficient_ring = parent.basis()[0][0].parent()\n```\nIn particular the following also takes life time for the very same reason\n\n```\nsage: V = ZZ['x']^50000\nsage: V([0]*50000)\n```",
    "created_at": "2015-02-08T15:55:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153771",
    "user": "https://github.com/videlec"
}
```

<div id="comment:17" align="right">comment:17</div>

Hello,

You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way

```
    coefficient_ring = parent.basis()[0][0].parent()
```
In particular the following also takes life time for the very same reason

```
sage: V = ZZ['x']^50000
sage: V([0]*50000)
```



---

archive/issue_comments_153772.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@videlec](#comment%3A17):\n> You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way\n> \n> ```\n>     coefficient_ring = parent.basis()[0][0].parent()\n> ```\n> In particular the following also takes life time for the very same reason\n> \n> ```\n> sage: V = ZZ['x']^50000\n> sage: V([0]*50000)\n> ```\n\nDoes it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?",
    "created_at": "2015-02-08T16:05:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153772",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@videlec](#comment%3A17):
> You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way
> 
> ```
>     coefficient_ring = parent.basis()[0][0].parent()
> ```
> In particular the following also takes life time for the very same reason
> 
> ```
> sage: V = ZZ['x']^50000
> sage: V([0]*50000)
> ```

Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?



---

archive/issue_comments_153773.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@mezzarobba](#comment%3A18):\n> Replying to [@videlec](#comment%3A17):\n> > You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way\n> > \n> > ```\n> >     coefficient_ring = parent.basis()[0][0].parent()\n> > ```\n> > In particular the following also takes life time for the very same reason\n> > \n> > ```\n> > sage: V = ZZ['x']^50000\n> > sage: V([0]*50000)\n> > ```\n> \n> \n> Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?\n\nSecond option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?",
    "created_at": "2015-02-08T16:29:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153773",
    "user": "https://github.com/videlec"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@mezzarobba](#comment%3A18):
> Replying to [@videlec](#comment%3A17):
> > You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way
> > 
> > ```
> >     coefficient_ring = parent.basis()[0][0].parent()
> > ```
> > In particular the following also takes life time for the very same reason
> > 
> > ```
> > sage: V = ZZ['x']^50000
> > sage: V([0]*50000)
> > ```
> 
> 
> Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?

Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?



---

archive/issue_comments_153774.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@videlec](#comment%3A19):\n> Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?\n\nNo, please feel free to do it here if you like. (I can't do it myself at the moment.)",
    "created_at": "2015-02-08T16:35:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153774",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@videlec](#comment%3A19):
> Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?

No, please feel free to do it here if you like. (I can't do it myself at the moment.)



---

archive/issue_comments_153775.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nWow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?",
    "created_at": "2015-02-08T17:14:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153775",
    "user": "https://github.com/videlec"
}
```

<div id="comment:21" align="right">comment:21</div>

Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?



---

archive/issue_comments_153776.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@videlec](#comment%3A21):\n> Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?\n\nThe problem mentioned in [comment:17](#comment%3A17) and the follow-ups needs #17585. In the meantime I am running the test for this branch on sage-6.6.beta0 and will set a positive review accordinlgy.\n\nVincent",
    "created_at": "2015-02-20T15:24:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153776",
    "user": "https://github.com/videlec"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@videlec](#comment%3A21):
> Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?

The problem mentioned in [comment:17](#comment%3A17) and the follow-ups needs #17585. In the meantime I am running the test for this branch on sage-6.6.beta0 and will set a positive review accordinlgy.

Vincent



---

archive/issue_events_183780.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-02-20T15:54:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183780"
}
```



---

archive/issue_events_183781.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-02-20T15:54:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183781"
}
```



---

archive/issue_comments_153777.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI think that #17585 provides a better and more fundamental fix to the problem: the line\n\n```\ncoefficient_ring = parent.basis()[0][0].parent()\n```\nis just removed completely.",
    "created_at": "2015-02-20T16:08:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153777",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

I think that #17585 provides a better and more fundamental fix to the problem: the line

```
coefficient_ring = parent.basis()[0][0].parent()
```
is just removed completely.



---

archive/issue_events_183782.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-02-20T16:16:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183782"
}
```



---

archive/issue_events_183783.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-02-20T16:16:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183783"
}
```



---

archive/issue_comments_153778.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nActually, #17585 fixes\n\n```\nsage: V = ZZ['x']^50000\nsage: V([0]*50000)\n```\nbut not\n\n```\nsage: vector([0]*50000)/1\n```\n\nSince this ticket looks quite independent of #17585, it makes sense to have both.\n\nI do suggest to add the *two* doctests above, since they clearly test different issues.",
    "created_at": "2015-02-20T16:16:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153778",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

Actually, #17585 fixes

```
sage: V = ZZ['x']^50000
sage: V([0]*50000)
```
but not

```
sage: vector([0]*50000)/1
```

Since this ticket looks quite independent of #17585, it makes sense to have both.

I do suggest to add the *two* doctests above, since they clearly test different issues.



---

archive/issue_comments_153779.json:
```json
{
    "body": "Work Issues: **add doctest**",
    "created_at": "2015-02-20T16:16:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153779",
    "user": "https://github.com/jdemeyer"
}
```

Work Issues: **add doctest**



---

archive/issue_comments_153780.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment%3A25):\n> Actually, #17585 fixes\n> \n> ```\n> sage: V = ZZ['x']^50000\n> sage: V([0]*50000)\n> ```\n> but not\n> \n> ```\n> sage: vector([0]*50000)/1\n> ```\n> \n> Since this ticket looks quite independent of #17585, it makes sense to have both.\n> \n> I do suggest to add the *two* doctests above, since they clearly test different issues.\n\nThe first one should go in #17585, no?",
    "created_at": "2015-02-20T16:24:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153780",
    "user": "https://github.com/videlec"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment%3A25):
> Actually, #17585 fixes
> 
> ```
> sage: V = ZZ['x']^50000
> sage: V([0]*50000)
> ```
> but not
> 
> ```
> sage: vector([0]*50000)/1
> ```
> 
> Since this ticket looks quite independent of #17585, it makes sense to have both.
> 
> I do suggest to add the *two* doctests above, since they clearly test different issues.

The first one should go in #17585, no?



---

archive/issue_comments_153781.json:
```json
{
    "body": "Changed work issues from **add doctest** to none",
    "created_at": "2015-02-20T16:38:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153781",
    "user": "https://github.com/jdemeyer"
}
```

Changed work issues from **add doctest** to none



---

archive/issue_comments_153782.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nSorry, there was a misunderstanding. I thought that this ticket fixed both issues.",
    "created_at": "2015-02-20T16:38:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153782",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Sorry, there was a misunderstanding. I thought that this ticket fixed both issues.



---

archive/issue_events_183784.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-02-20T16:38:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183784"
}
```



---

archive/issue_events_183785.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-02-20T16:38:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183785"
}
```



---

archive/issue_events_183786.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-21T12:40:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183786"
}
```



---

archive/issue_events_183787.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "efe44a00750a046494f9964e8e4ac6c45bfb3197",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-02-21T12:40:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13304#event-183787"
}
```



---

archive/issue_comments_153783.json:
```json
{
    "body": "Changed branch from **[public/ticket/13304](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/13304)** to **[`8f09d51`](https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce)**",
    "created_at": "2015-02-21T12:40:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13304#issuecomment-153783",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/ticket/13304](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/13304)** to **[`8f09d51`](https://github.com/sagemath/sagetrac-mirror/commit/8f09d5198e060add5dea75ed240739f6485ba8ce)**
