# Issue 13336: farey_symbol.pyx fails to build on Cygwin

archive/issues_013164.json:
```json
{
    "body": "Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).\n\nThe patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern \"C\" stuff but without the dllspec(import) stuff.\n\nAssignee: tbd\n\nKeywords: cygwin linking\n\nReviewer: Dmitrii Pasechnik\n\nAuthor: Jean-Pierre Flori\n\nMerged: sage-5.3.beta1\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13336\n\n",
    "closed_at": "2012-08-12T19:02:44Z",
    "created_at": "2012-08-04T08:52:06Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.3",
    "title": "farey_symbol.pyx fails to build on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13336",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).

The patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern "C" stuff but without the dllspec(import) stuff.

Assignee: tbd

Keywords: cygwin linking

Reviewer: Dmitrii Pasechnik

Author: Jean-Pierre Flori

Merged: sage-5.3.beta1

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13336





---

archive/issue_comments_204919.json:
```json
{
    "body": "<a id='comment:1'></a>\nwith these flags on, I still get\n\n```\ng++ -shared -Wl,--enable-auto-image-base -L/home/Dima/sage-5.2.rc1/local/lib build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/sl2z.o -L/home/Dima/sage-5.2.rc1/local/lib -L/home/Dima/sage-5.2.rc1/local/lib/python2.7/config -lcsage -lgmp -lgmpxx -lstdc++ -lntl -lpython2.7 -o build/lib.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.dll -Wl,--enable-auto-import\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK18is_element_general9is_memberERK4SL2Z':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:183: undefined reference to `__imp__convert_to_SL2Z'\n[... etc ...]\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:655: undefined reference to `__imp__convert_to_cusp'\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol13get_fractionsEv':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:664: undefined reference to `__imp__convert_to_rational'\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol20get_pairing_matricesEv':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:705: undefined reference to `__imp__convert_to_SL2Z'\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `is_element_GammaH':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:132: undefined reference to `__imp__convert_to_long'\ncollect2: ld returned 1 exit status\n```\nSo it looks like that the linker cannot find objects which are part of the Farey module (i.e. from sl2z.o, etc)?! \n\nLooks like some g++/dll linking weirdness to me.",
    "created_at": "2012-08-04T11:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204919",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
with these flags on, I still get

```
g++ -shared -Wl,--enable-auto-image-base -L/home/Dima/sage-5.2.rc1/local/lib build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/sl2z.o -L/home/Dima/sage-5.2.rc1/local/lib -L/home/Dima/sage-5.2.rc1/local/lib/python2.7/config -lcsage -lgmp -lgmpxx -lstdc++ -lntl -lpython2.7 -o build/lib.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.dll -Wl,--enable-auto-import
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK18is_element_general9is_memberERK4SL2Z':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:183: undefined reference to `__imp__convert_to_SL2Z'
[... etc ...]
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:655: undefined reference to `__imp__convert_to_cusp'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol13get_fractionsEv':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:664: undefined reference to `__imp__convert_to_rational'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol20get_pairing_matricesEv':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:705: undefined reference to `__imp__convert_to_SL2Z'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `is_element_GammaH':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:132: undefined reference to `__imp__convert_to_long'
collect2: ld returned 1 exit status
```
So it looks like that the linker cannot find objects which are part of the Farey module (i.e. from sl2z.o, etc)?! 

Looks like some g++/dll linking weirdness to me.



---

archive/issue_comments_204920.json:
```json
{
    "body": "<a id='comment:2'></a>\nYes...\nIn fact we'll get the same problem later with the wrapper_* things in ext/interpreter.\n\nWhat's strange is that I don't remember getting it here the last time.\nBut I kind of so much tweaked the files back then that it must have been that as well.\n\nI think the problem is as follows:\nAs convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.\nThen if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.\nBut when you want to directly link farey_symbol.o and farey.o together, ld whines...",
    "created_at": "2012-08-04T18:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204920",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:2'></a>
Yes...
In fact we'll get the same problem later with the wrapper_* things in ext/interpreter.

What's strange is that I don't remember getting it here the last time.
But I kind of so much tweaked the files back then that it must have been that as well.

I think the problem is as follows:
As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.
Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.
But when you want to directly link farey_symbol.o and farey.o together, ld whines...



---

archive/issue_comments_204921.json:
```json
{
    "body": "<a id='comment:3'></a>\nAnd obviously I've deleted my 5.1.rc1 install so I have to figure out what let the files compile the last time :)",
    "created_at": "2012-08-04T18:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204921",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:3'></a>
And obviously I've deleted my 5.1.rc1 install so I have to figure out what let the files compile the last time :)



---

archive/issue_comments_204922.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [jpflori](#comment%3A2):\n> I think the problem is as follows:\n> As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.\n> Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.\n> But when you want to directly link farey_symbol.o and farey.o together, ld whines...\n\n\nThis seems to be the problem.\nIf you remove the DL_IMPORT lines in farey_symbol.h (generated by Cython), you'll link correctly.\n\nI've got some ideas from here:\nhttp://stackoverflow.com/questions/3704374/linking-error-lnk2019-in-msvc-unresolved-symbols-with-imp-prefix-but-shoul",
    "created_at": "2012-08-04T19:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204922",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:4'></a>
Replying to [jpflori](#comment%3A2):
> I think the problem is as follows:
> As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.
> Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.
> But when you want to directly link farey_symbol.o and farey.o together, ld whines...


This seems to be the problem.
If you remove the DL_IMPORT lines in farey_symbol.h (generated by Cython), you'll link correctly.

I've got some ideas from here:
http://stackoverflow.com/questions/3704374/linking-error-lnk2019-in-msvc-unresolved-symbols-with-imp-prefix-but-shoul



---

archive/issue_comments_204923.json:
```json
{
    "body": "<a id='comment:5'></a>\nPatch coming.",
    "created_at": "2012-08-04T19:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204923",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:5'></a>
Patch coming.



---

archive/issue_comments_204924.json:
```json
{
    "body": "Attachment [trac_13336-linking.patch](tarball://root/attachments/some-uuid/ticket13336/trac_13336-linking.patch) by jpflori created at 2012-08-04 19:07:05\n\nFix linking problem.",
    "created_at": "2012-08-04T19:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204924",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_13336-linking.patch](tarball://root/attachments/some-uuid/ticket13336/trac_13336-linking.patch) by jpflori created at 2012-08-04 19:07:05

Fix linking problem.



---

archive/issue_comments_204925.json:
```json
{
    "body": "Changing keywords from \"\" to \"cygwin linking\".",
    "created_at": "2012-08-04T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204925",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing keywords from "" to "cygwin linking".



---

archive/issue_comments_204926.json:
```json
{
    "body": "Changing author from \"\" to \"Jean-Pierre Flori\"",
    "created_at": "2012-08-04T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204926",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing author from "" to "Jean-Pierre Flori"



---

archive/issue_comments_204927.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-04T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204927",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_204928.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-Missing gmpxx and gmp dependencies and use of --enable-auto-import for the linker.\n+Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).\n+\n+The patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern \"C\" stuff but without the dllspec(import) stuff.\n``````\n",
    "created_at": "2012-08-04T19:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204928",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-Missing gmpxx and gmp dependencies and use of --enable-auto-import for the linker.
+Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).
+
+The patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern "C" stuff but without the dllspec(import) stuff.
``````




---

archive/issue_comments_204929.json:
```json
{
    "body": "<a id='comment:7'></a>\nOK, this does the trick here. I'll give it a positive review as soon as the patchbot gives OK.\nThe next stop looks like a ginac-related problem at #13337",
    "created_at": "2012-08-05T03:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204929",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
OK, this does the trick here. I'll give it a positive review as soon as the patchbot gives OK.
The next stop looks like a ginac-related problem at #13337



---

archive/issue_comments_204930.json:
```json
{
    "body": "<a id='comment:8'></a>\nLooks good.",
    "created_at": "2012-08-08T04:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204930",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
Looks good.



---

archive/issue_comments_204931.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-08-08T04:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204931",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_204932.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dmitrii Pasechnik\"",
    "created_at": "2012-08-08T12:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204932",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Dmitrii Pasechnik"



---

archive/issue_comments_204933.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-12T19:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204933",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_043011.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-12T19:02:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13336#event-43011"
}
```



---

archive/issue_comments_204934.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.3.beta1\"",
    "created_at": "2012-08-12T19:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204934",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.3.beta1"



---

archive/issue_comments_204935.json:
```json
{
    "body": "<a id='comment:11'></a>\nReal Cython fix in #23004.",
    "created_at": "2017-05-15T16:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13336#issuecomment-204935",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Real Cython fix in #23004.
