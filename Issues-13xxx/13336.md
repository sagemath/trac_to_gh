# Issue 13336: farey_symbol.pyx fails to build on Cygwin

archive/issues_013164.json:
```json
{
    "assignees": [],
    "body": "Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).\n\nThe patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern \"C\" stuff but without the dllspec(import) stuff.\n\nKeywords: **cygwin linking**\n\nReviewer: **Dmitrii Pasechnik**\n\nAuthor: **Jean-Pierre Flori**\n\nMerged: **sage-5.3.beta1**\n\nComponent: **porting: Cygwin**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13336_\n\n",
    "closed_at": "2012-08-12T19:02:44Z",
    "created_at": "2012-08-04T08:52:06Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "farey_symbol.pyx fails to build on Cygwin",
    "type": "issue",
    "updated_at": "2017-05-15T16:43:04Z",
    "url": "https://github.com/sagemath/sage/issues/13336",
    "user": "https://github.com/jpflori"
}
```
Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).

The patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern "C" stuff but without the dllspec(import) stuff.

Keywords: **cygwin linking**

Reviewer: **Dmitrii Pasechnik**

Author: **Jean-Pierre Flori**

Merged: **sage-5.3.beta1**

Component: **porting: Cygwin**

_Issue created by migration from https://trac.sagemath.org/ticket/13336_





---

archive/issue_events_186135.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-08-04T08:52:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "milestone_number": null,
    "milestone_title": "sage-5.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186135"
}
```



---

archive/issue_events_186136.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-08-04T08:52:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186136"
}
```



---

archive/issue_events_186137.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-08-04T08:52:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186137"
}
```



---

archive/issue_events_186138.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-08-04T08:52:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186138"
}
```



---

archive/issue_comments_154693.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nwith these flags on, I still get\n\n```\ng++ -shared -Wl,--enable-auto-image-base -L/home/Dima/sage-5.2.rc1/local/lib build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/sl2z.o -L/home/Dima/sage-5.2.rc1/local/lib -L/home/Dima/sage-5.2.rc1/local/lib/python2.7/config -lcsage -lgmp -lgmpxx -lstdc++ -lntl -lpython2.7 -o build/lib.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.dll -Wl,--enable-auto-import\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK18is_element_general9is_memberERK4SL2Z':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:183: undefined reference to `__imp__convert_to_SL2Z'\n[... etc ...]\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:655: undefined reference to `__imp__convert_to_cusp'\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol13get_fractionsEv':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:664: undefined reference to `__imp__convert_to_rational'\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol20get_pairing_matricesEv':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:705: undefined reference to `__imp__convert_to_SL2Z'\nbuild/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `is_element_GammaH':\n/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:132: undefined reference to `__imp__convert_to_long'\ncollect2: ld returned 1 exit status\n```\nSo it looks like that the linker cannot find objects which are part of the Farey module (i.e. from sl2z.o, etc)?! \n\nLooks like some g++/dll linking weirdness to me.",
    "created_at": "2012-08-04T11:32:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154693",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:1" align="right">comment:1</div>

with these flags on, I still get

```
g++ -shared -Wl,--enable-auto-image-base -L/home/Dima/sage-5.2.rc1/local/lib build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/sl2z.o -L/home/Dima/sage-5.2.rc1/local/lib -L/home/Dima/sage-5.2.rc1/local/lib/python2.7/config -lcsage -lgmp -lgmpxx -lstdc++ -lntl -lpython2.7 -o build/lib.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.dll -Wl,--enable-auto-import
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK18is_element_general9is_memberERK4SL2Z':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:183: undefined reference to `__imp__convert_to_SL2Z'
[... etc ...]
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:655: undefined reference to `__imp__convert_to_cusp'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol13get_fractionsEv':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:664: undefined reference to `__imp__convert_to_rational'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol20get_pairing_matricesEv':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:705: undefined reference to `__imp__convert_to_SL2Z'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `is_element_GammaH':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:132: undefined reference to `__imp__convert_to_long'
collect2: ld returned 1 exit status
```
So it looks like that the linker cannot find objects which are part of the Farey module (i.e. from sl2z.o, etc)?! 

Looks like some g++/dll linking weirdness to me.



---

archive/issue_comments_154694.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nYes...\nIn fact we'll get the same problem later with the wrapper_* things in ext/interpreter.\n\nWhat's strange is that I don't remember getting it here the last time.\nBut I kind of so much tweaked the files back then that it must have been that as well.\n\nI think the problem is as follows:\nAs convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.\nThen if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.\nBut when you want to directly link farey_symbol.o and farey.o together, ld whines...",
    "created_at": "2012-08-04T18:44:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154694",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:2" align="right">comment:2</div>

Yes...
In fact we'll get the same problem later with the wrapper_* things in ext/interpreter.

What's strange is that I don't remember getting it here the last time.
But I kind of so much tweaked the files back then that it must have been that as well.

I think the problem is as follows:
As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.
Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.
But when you want to directly link farey_symbol.o and farey.o together, ld whines...



---

archive/issue_comments_154695.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAnd obviously I've deleted my 5.1.rc1 install so I have to figure out what let the files compile the last time :)",
    "created_at": "2012-08-04T18:45:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154695",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:3" align="right">comment:3</div>

And obviously I've deleted my 5.1.rc1 install so I have to figure out what let the files compile the last time :)



---

archive/issue_comments_154696.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@jpflori](#comment:2):\n> I think the problem is as follows:\n> As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.\n> Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.\n> But when you want to directly link farey_symbol.o and farey.o together, ld whines...\n\nThis seems to be the problem.\nIf you remove the DL_IMPORT lines in farey_symbol.h (generated by Cython), you'll link correctly.\n\nI've got some ideas from here:\nhttp://stackoverflow.com/questions/3704374/linking-error-lnk2019-in-msvc-unresolved-symbols-with-imp-prefix-but-shoul",
    "created_at": "2012-08-04T19:01:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154696",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@jpflori](#comment:2):
> I think the problem is as follows:
> As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.
> Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.
> But when you want to directly link farey_symbol.o and farey.o together, ld whines...

This seems to be the problem.
If you remove the DL_IMPORT lines in farey_symbol.h (generated by Cython), you'll link correctly.

I've got some ideas from here:
http://stackoverflow.com/questions/3704374/linking-error-lnk2019-in-msvc-unresolved-symbols-with-imp-prefix-but-shoul



---

archive/issue_comments_154697.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nPatch coming.",
    "created_at": "2012-08-04T19:06:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154697",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:5" align="right">comment:5</div>

Patch coming.



---

archive/issue_comments_154698.json:
```json
{
    "body": "Attachment: **[trac_13336-linking.patch.gz](https://github.com/sagemath/sage/files/ticket13336/trac_13336-linking.patch.gz)**\n\nFix linking problem.",
    "created_at": "2012-08-04T19:07:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154698",
    "user": "https://github.com/jpflori"
}
```

Attachment: **[trac_13336-linking.patch.gz](https://github.com/sagemath/sage/files/ticket13336/trac_13336-linking.patch.gz)**

Fix linking problem.



---

archive/issue_comments_154699.json:
```json
{
    "body": "Changed keywords from none to **cygwin linking**",
    "created_at": "2012-08-04T19:10:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154699",
    "user": "https://github.com/jpflori"
}
```

Changed keywords from none to **cygwin linking**



---

archive/issue_comments_154700.json:
```json
{
    "body": "Author: **Jean-Pierre Flori**",
    "created_at": "2012-08-04T19:10:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154700",
    "user": "https://github.com/jpflori"
}
```

Author: **Jean-Pierre Flori**



---

archive/issue_events_186139.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-08-04T19:10:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186139"
}
```



---

archive/issue_comments_154701.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-Missing gmpxx and gmp dependencies and use of --enable-auto-import for the linker.\n+Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).\n+\n+The patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern \"C\" stuff but without the dllspec(import) stuff.\n``````\n",
    "created_at": "2012-08-04T19:10:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154701",
    "user": "https://github.com/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-Missing gmpxx and gmp dependencies and use of --enable-auto-import for the linker.
+Because of DL_IMPORT stuff in headers generated by Cython and corresponding _ _ imp _ _ prefixes added in object files, farey.o cannot be linked to farey_symbol.o (it could with farey_symbol.dll if we generated it...).
+
+The patch here does not include farey_symbol.h but directly declare the prototype of the needed functions in farey.cpp, with the extern "C" stuff but without the dllspec(import) stuff.
``````




---

archive/issue_comments_154702.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOK, this does the trick here. I'll give it a positive review as soon as the patchbot gives OK.\nThe next stop looks like a ginac-related problem at #13337",
    "created_at": "2012-08-05T03:51:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154702",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">comment:7</div>

OK, this does the trick here. I'll give it a positive review as soon as the patchbot gives OK.
The next stop looks like a ginac-related problem at #13337



---

archive/issue_comments_154703.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nLooks good.",
    "created_at": "2012-08-08T04:10:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154703",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

Looks good.



---

archive/issue_events_186140.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2012-08-08T04:10:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186140"
}
```



---

archive/issue_events_186141.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2012-08-08T04:10:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186141"
}
```



---

archive/issue_comments_154704.json:
```json
{
    "body": "Reviewer: **Dmitrii Pasechnik**",
    "created_at": "2012-08-08T12:35:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154704",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Dmitrii Pasechnik**



---

archive/issue_events_186142.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-12T19:02:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186142"
}
```



---

archive/issue_events_186143.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-12T19:02:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13336#event-186143"
}
```



---

archive/issue_comments_154705.json:
```json
{
    "body": "Merged: **sage-5.3.beta1**",
    "created_at": "2012-08-12T19:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154705",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.3.beta1**



---

archive/issue_comments_154706.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReal Cython fix in #23004.",
    "created_at": "2017-05-15T16:43:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13336#issuecomment-154706",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Real Cython fix in #23004.
