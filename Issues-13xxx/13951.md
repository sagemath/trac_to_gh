# Issue 13951: (non)archimedian_local_height broken for rational points on elliptic curves over Q

archive/issues_013747.json:
```json
{
    "body": "Computing local heights uses functions that are only available when the base field is a NumberField, and not over the RationalField:\n\n```\nsage: E = EllipticCurve([0, 0, 0, -36, 0])\nsage: P = E(-3, 9)\nsage: P.archimedian_local_height()\n...\nAttributeError: 'RationalField_with_category' object has no attribute 'places'\nsage: P.nonarchimedian_local_height()\n...\nAttributeError: 'RationalField_with_category' object has no attribute 'factor'\n```\n\nNote: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n\nApply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac_13951_extra.patch]\n\nAssignee: @JohnCremona\n\nKeywords: local heights\n\nReviewer: John Cremona, Peter Bruin\n\nAuthor: Peter Bruin, John Cremona\n\nMerged: sage-5.13.beta4\n\nDependencies: #12509, #13953, #14609\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13951\n\n",
    "closed_at": "2013-11-24T17:26:22Z",
    "created_at": "2013-01-14T17:27:29Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "(non)archimedian_local_height broken for rational points on elliptic curves over Q",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13951",
    "user": "https://github.com/pjbruin"
}
```
Computing local heights uses functions that are only available when the base field is a NumberField, and not over the RationalField:

```
sage: E = EllipticCurve([0, 0, 0, -36, 0])
sage: P = E(-3, 9)
sage: P.archimedian_local_height()
...
AttributeError: 'RationalField_with_category' object has no attribute 'places'
sage: P.nonarchimedian_local_height()
...
AttributeError: 'RationalField_with_category' object has no attribute 'factor'
```

Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).

Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac_13951_extra.patch]

Assignee: @JohnCremona

Keywords: local heights

Reviewer: John Cremona, Peter Bruin

Author: Peter Bruin, John Cremona

Merged: sage-5.13.beta4

Dependencies: #12509, #13953, #14609

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13951





---

archive/issue_comments_217831.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -11,4 +11,4 @@\n AttributeError: 'RationalField_with_category' object has no attribute 'factor'\n ```\n \n-Note: at the moment this bug only shows up for non-torsion points because of a different bug (asking for local heights of torsion points always returns 0, which is in general incorrect).\n+Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n``````\n",
    "created_at": "2013-01-14T17:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217831",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -11,4 +11,4 @@
 AttributeError: 'RationalField_with_category' object has no attribute 'factor'
 ```
 
-Note: at the moment this bug only shows up for non-torsion points because of a different bug (asking for local heights of torsion points always returns 0, which is in general incorrect).
+Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).
``````




---

archive/issue_comments_217832.json:
```json
{
    "body": "Author: Peter Bruin",
    "created_at": "2013-01-14T18:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217832",
    "user": "https://github.com/pjbruin"
}
```

Author: Peter Bruin



---

archive/issue_comments_217833.json:
```json
{
    "body": "Changing author from \"Peter Bruin\" to \"\"",
    "created_at": "2013-01-14T18:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217833",
    "user": "https://github.com/pjbruin"
}
```

Changing author from "Peter Bruin" to ""



---

archive/issue_comments_217834.json:
```json
{
    "body": "<a id='comment:4'></a>\nFor global heights over QQ we just call pari, but here I suggest that we call the local height functions implemented over number fields, which should be straightforward (but not completely trivial).   Must be based on #12509.  I should have time to do this next week if no-one else does it first.",
    "created_at": "2013-01-14T20:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217834",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>
For global heights over QQ we just call pari, but here I suggest that we call the local height functions implemented over number fields, which should be straightforward (but not completely trivial).   Must be based on #12509.  I should have time to do this next week if no-one else does it first.



---

archive/issue_comments_217835.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [cremona](#comment%3A4):\n> For global heights over QQ we just call pari, but here I suggest that we call the local height functions implemented over number fields, which should be straightforward (but not completely trivial).\n\n\nYes, that was what I was thinking too.",
    "created_at": "2013-01-14T20:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217835",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:5'></a>
Replying to [cremona](#comment%3A4):
> For global heights over QQ we just call pari, but here I suggest that we call the local height functions implemented over number fields, which should be straightforward (but not completely trivial).


Yes, that was what I was thinking too.



---

archive/issue_comments_217836.json:
```json
{
    "body": "Attachment [trac13951-local_heights_QQ.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-local_heights_QQ.patch) by @pjbruin created at 2013-06-05 20:22:50\n\nbased on 5.9 + #12509 + #13953",
    "created_at": "2013-06-05T20:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217836",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac13951-local_heights_QQ.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-local_heights_QQ.patch) by @pjbruin created at 2013-06-05 20:22:50

based on 5.9 + #12509 + #13953



---

archive/issue_comments_217837.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-06-05T20:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217837",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_217838.json:
```json
{
    "body": "Author: pbruin",
    "created_at": "2013-06-05T20:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217838",
    "user": "https://github.com/pjbruin"
}
```

Author: pbruin



---

archive/issue_comments_217839.json:
```json
{
    "body": "Dependencies: #12509, #13953",
    "created_at": "2013-06-05T22:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217839",
    "user": "https://github.com/pjbruin"
}
```

Dependencies: #12509, #13953



---

archive/issue_comments_217840.json:
```json
{
    "body": "Changing author from \"pbruin\" to \"Peter Bruin\"",
    "created_at": "2013-06-05T22:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217840",
    "user": "https://github.com/pjbruin"
}
```

Changing author from "pbruin" to "Peter Bruin"



---

archive/issue_comments_217841.json:
```json
{
    "body": "<a id='comment:8'></a>\nI am looking at this now.  I note that the two prerequisites are already merged in 5.10.beta3/4 and plan to test on 5.10.rc0.\n\nOne preliminary comment:  the little function to compute the local degree at an archimedean place by testing if the image of the generator under the embedding has 0 imaginary part looks very ugly to me (and it is possible that I wrote it).  Surely there is a better way?  I looked to see what I did for the period functions in period_lattice.py to test whether an embedding was real or not: there, the given embedding is first refined to an embedding into AA if real or QQbar if not, using sage.rings.number_fields.refine_embedding, which in turn tests whether the codomain of the embedding passes sage.rings.real_mpfr.is_RealField().  Would that be better?",
    "created_at": "2013-06-06T08:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217841",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>
I am looking at this now.  I note that the two prerequisites are already merged in 5.10.beta3/4 and plan to test on 5.10.rc0.

One preliminary comment:  the little function to compute the local degree at an archimedean place by testing if the image of the generator under the embedding has 0 imaginary part looks very ugly to me (and it is possible that I wrote it).  Surely there is a better way?  I looked to see what I did for the period functions in period_lattice.py to test whether an embedding was real or not: there, the given embedding is first refined to an embedding into AA if real or QQbar if not, using sage.rings.number_fields.refine_embedding, which in turn tests whether the codomain of the embedding passes sage.rings.real_mpfr.is_RealField().  Would that be better?



---

archive/issue_comments_217842.json:
```json
{
    "body": "<a id='comment:9'></a>\nA second comment, of a different kind:  how can it have happened and never been noticied that these related functions are all spelled wrong!  It is \"archimedean\" and not \"archimedian\" (think \"Archimedes\").\n\nI don't think I will be able to resist correcting all these: about 24 occurrences including doctests.  Interestingly, in almost all places the word is spelled correctly in comments.  But should we just deprecate the old spelling?  I will consult sage-devel.\n\n1. In line 2858 of the patched file I removed the division by K.degree() since that is 1.  This appeared to cut the time to doctest this file (with --long) by a few seconds, but that might have been a freak!\n\n2. The global height function would now work without calling pari, hence with no special case needed for K==QQ.  Alternatively, we could easily add an \"algorithm\" parameter which could be either \"sage\" or \"pari\", with \"pari\" the default.  I think that over QQ pari uses Mestre's AGM method for the real place, which is likely to be faster.  Having the choice of algorithm would make it easy to add a doctest to compare the two;  there should already be a doctest showing that the global height is the sum of the arch. and non-arch. heights which would actually be a test since we are computing them entirely indepependently!\n\n3. The non-arch. height has a parameter \"weighted\" which is not documented and should be, with doctests shoing its use.  Similarly with the is_minimal parameter.  And for consistency, surely the arch. height should also have a weighted parameter?\n\nSorry to be awkward;  mathematically the patch is certainly ok!\n\nI have a second patch which deals only with (1) spelling corrrections, but no deprecation warning, (2) not dividing by K.degree() when it is 1.  I can add to that after this discussion, so will not upload it yet.",
    "created_at": "2013-06-06T09:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217842",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>
A second comment, of a different kind:  how can it have happened and never been noticied that these related functions are all spelled wrong!  It is "archimedean" and not "archimedian" (think "Archimedes").

I don't think I will be able to resist correcting all these: about 24 occurrences including doctests.  Interestingly, in almost all places the word is spelled correctly in comments.  But should we just deprecate the old spelling?  I will consult sage-devel.

1. In line 2858 of the patched file I removed the division by K.degree() since that is 1.  This appeared to cut the time to doctest this file (with --long) by a few seconds, but that might have been a freak!

2. The global height function would now work without calling pari, hence with no special case needed for K==QQ.  Alternatively, we could easily add an "algorithm" parameter which could be either "sage" or "pari", with "pari" the default.  I think that over QQ pari uses Mestre's AGM method for the real place, which is likely to be faster.  Having the choice of algorithm would make it easy to add a doctest to compare the two;  there should already be a doctest showing that the global height is the sum of the arch. and non-arch. heights which would actually be a test since we are computing them entirely indepependently!

3. The non-arch. height has a parameter "weighted" which is not documented and should be, with doctests shoing its use.  Similarly with the is_minimal parameter.  And for consistency, surely the arch. height should also have a weighted parameter?

Sorry to be awkward;  mathematically the patch is certainly ok!

I have a second patch which deals only with (1) spelling corrrections, but no deprecation warning, (2) not dividing by K.degree() when it is 1.  I can add to that after this discussion, so will not upload it yet.



---

archive/issue_comments_217843.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [cremona](#comment%3A8):\n> I am looking at this now.  I note that the two prerequisites are already merged in 5.10.beta3/4 and plan to test on 5.10.rc0.\n> \n> One preliminary comment:  the little function to compute the local degree at an archimedean place by testing if the image of the generator under the embedding has 0 imaginary part looks very ugly to me (and it is possible that I wrote it).  Surely there is a better way?  I looked to see what I did for the period functions in period_lattice.py to test whether an embedding was real or not: there, the given embedding is first refined to an embedding into AA if real or QQbar if not, using sage.rings.number_fields.refine_embedding, which in turn tests whether the codomain of the embedding passes sage.rings.real_mpfr.is_RealField().  Would that be better?\n> \n> \n\nOne easy solution would be to rely on the fact that K.places() returns the r_1 real embeddings followed by the r_2 complex embeddings:\n\n\n```\nr1, r2 = K.signature()\npl = K.places()\nreturn (sum(self.archimedian_local_height(pl[i], prec) for i in range(r1))\n        + 2 * sum(self.archimedian_local_height(pl[i], prec) for i in range(r1, r1 + r2))) / K.degree()\n\n```\nThis leaves the job of distinguishing real and complex places to the NumberField code.  I just tested this and it appears to work",
    "created_at": "2013-06-06T09:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217843",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:10'></a>
Replying to [cremona](#comment%3A8):
> I am looking at this now.  I note that the two prerequisites are already merged in 5.10.beta3/4 and plan to test on 5.10.rc0.
> 
> One preliminary comment:  the little function to compute the local degree at an archimedean place by testing if the image of the generator under the embedding has 0 imaginary part looks very ugly to me (and it is possible that I wrote it).  Surely there is a better way?  I looked to see what I did for the period functions in period_lattice.py to test whether an embedding was real or not: there, the given embedding is first refined to an embedding into AA if real or QQbar if not, using sage.rings.number_fields.refine_embedding, which in turn tests whether the codomain of the embedding passes sage.rings.real_mpfr.is_RealField().  Would that be better?
> 
> 

One easy solution would be to rely on the fact that K.places() returns the r_1 real embeddings followed by the r_2 complex embeddings:


```
r1, r2 = K.signature()
pl = K.places()
return (sum(self.archimedian_local_height(pl[i], prec) for i in range(r1))
        + 2 * sum(self.archimedian_local_height(pl[i], prec) for i in range(r1, r1 + r2))) / K.degree()

```
This leaves the job of distinguishing real and complex places to the NumberField code.  I just tested this and it appears to work



---

archive/issue_comments_217844.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [pbruin](#comment%3A10):\n> Replying to [cremona](#comment%3A8):\n> > I am looking at this now.  I note that the two prerequisites are already merged in 5.10.beta3/4 and plan to test on 5.10.rc0.\n> > \n> > One preliminary comment:  the little function to compute the local degree at an archimedean place by testing if the image of the generator under the embedding has 0 imaginary part looks very ugly to me (and it is possible that I wrote it).  Surely there is a better way?  I looked to see what I did for the period functions in period_lattice.py to test whether an embedding was real or not: there, the given embedding is first refined to an embedding into AA if real or QQbar if not, using sage.rings.number_fields.refine_embedding, which in turn tests whether the codomain of the embedding passes sage.rings.real_mpfr.is_RealField().  Would that be better?\n> > \n> > \n\n> One easy solution would be to rely on the fact that K.places() returns the r_1 real embeddings followed by the r_2 complex embeddings:\n> \n> \n> \n> ```\n> r1, r2 = K.signature()\n> pl = K.places()\n> return (sum(self.archimedian_local_height(pl[i], prec) for i in range(r1))\n>         + 2 * sum(self.archimedian_local_height(pl[i], prec) for i in range(r1, r1 + r2))) / K.degree()\n> \n> ```\n> This leaves the job of distinguishing real and complex places to the NumberField code.  I just tested this and it appears to work\n\n\nI like that a lot.  Since I am already working on a second patch, I will put that in.  Thanks.",
    "created_at": "2013-06-06T09:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217844",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:11'></a>
Replying to [pbruin](#comment%3A10):
> Replying to [cremona](#comment%3A8):
> > I am looking at this now.  I note that the two prerequisites are already merged in 5.10.beta3/4 and plan to test on 5.10.rc0.
> > 
> > One preliminary comment:  the little function to compute the local degree at an archimedean place by testing if the image of the generator under the embedding has 0 imaginary part looks very ugly to me (and it is possible that I wrote it).  Surely there is a better way?  I looked to see what I did for the period functions in period_lattice.py to test whether an embedding was real or not: there, the given embedding is first refined to an embedding into AA if real or QQbar if not, using sage.rings.number_fields.refine_embedding, which in turn tests whether the codomain of the embedding passes sage.rings.real_mpfr.is_RealField().  Would that be better?
> > 
> > 

> One easy solution would be to rely on the fact that K.places() returns the r_1 real embeddings followed by the r_2 complex embeddings:
> 
> 
> 
> ```
> r1, r2 = K.signature()
> pl = K.places()
> return (sum(self.archimedian_local_height(pl[i], prec) for i in range(r1))
>         + 2 * sum(self.archimedian_local_height(pl[i], prec) for i in range(r1, r1 + r2))) / K.degree()
> 
> ```
> This leaves the job of distinguishing real and complex places to the NumberField code.  I just tested this and it appears to work


I like that a lot.  Since I am already working on a second patch, I will put that in.  Thanks.



---

archive/issue_comments_217845.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [cremona](#comment%3A9):\n> A second comment, of a different kind:  how can it have happened and never been noticied that these related functions are all spelled wrong!  It is \"archimedean\" and not \"archimedian\" (think \"Archimedes\").\n\n\nI agree with the spelling \"archimedean\".  (It is \"archimedisch\" in German and Dutch, and \"archim\u00e9dien\" in French, but in these cases the \"i\" is part of the suffix.  Similarly, \"Euclidean geometry\" vs. \"g\u00e9om\u00e9trie euclidienne\" etc.)\n\nIf we are changing the spelling anyway, should we also write \"non_archimedean_local_height\" instead of \"nonarchimedean_local_height\" for readability?\n\nI also noticed that \"independent\" is spelled \"independant\" in three places in the documentation.\n\n> I don't think I will be able to resist correcting all these: about 24 occurrences including doctests.  Interestingly, in almost all places the word is spelled correctly in comments.  But should we just deprecate the old spelling?  I will consult sage-devel.\n> \n> 1. In line 2858 of the patched file I removed the division by K.degree() since that is 1.  This appeared to cut the time to doctest this file (with --long) by a few seconds, but that might have been a freak!\n\n\nYes, the division by K.degree() should clearly be omitted.\n\n>    2. The global height function would now work without calling pari, hence with no special case needed for K==QQ.  Alternatively, we could easily add an \"algorithm\" parameter which could be either \"sage\" or \"pari\", with \"pari\" the default.  I think that over QQ pari uses Mestre's AGM method for the real place, which is likely to be faster.  Having the choice of algorithm would make it easy to add a doctest to compare the two;  there should already be a doctest showing that the global height is the sum of the arch. and non-arch. heights which would actually be a test since we are computing them entirely indepependently!\n\n\nAs far as I can see the doctest verifying that the height equals the sum of the archimedean and non-archimedean local heights is not there yet, but there should certainly be one!\n\n>    3. The non-arch. height has a parameter \"weighted\" which is not documented and should be, with doctests shoing its use.  Similarly with the is_minimal parameter.  And for consistency, surely the arch. height should also have a weighted parameter?\n\n\nYes, that sounds reasonable.",
    "created_at": "2013-06-06T10:17:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217845",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:12'></a>
Replying to [cremona](#comment%3A9):
> A second comment, of a different kind:  how can it have happened and never been noticied that these related functions are all spelled wrong!  It is "archimedean" and not "archimedian" (think "Archimedes").


I agree with the spelling "archimedean".  (It is "archimedisch" in German and Dutch, and "archimédien" in French, but in these cases the "i" is part of the suffix.  Similarly, "Euclidean geometry" vs. "géométrie euclidienne" etc.)

If we are changing the spelling anyway, should we also write "non_archimedean_local_height" instead of "nonarchimedean_local_height" for readability?

I also noticed that "independent" is spelled "independant" in three places in the documentation.

> I don't think I will be able to resist correcting all these: about 24 occurrences including doctests.  Interestingly, in almost all places the word is spelled correctly in comments.  But should we just deprecate the old spelling?  I will consult sage-devel.
> 
> 1. In line 2858 of the patched file I removed the division by K.degree() since that is 1.  This appeared to cut the time to doctest this file (with --long) by a few seconds, but that might have been a freak!


Yes, the division by K.degree() should clearly be omitted.

>    2. The global height function would now work without calling pari, hence with no special case needed for K==QQ.  Alternatively, we could easily add an "algorithm" parameter which could be either "sage" or "pari", with "pari" the default.  I think that over QQ pari uses Mestre's AGM method for the real place, which is likely to be faster.  Having the choice of algorithm would make it easy to add a doctest to compare the two;  there should already be a doctest showing that the global height is the sum of the arch. and non-arch. heights which would actually be a test since we are computing them entirely indepependently!


As far as I can see the doctest verifying that the height equals the sum of the archimedean and non-archimedean local heights is not there yet, but there should certainly be one!

>    3. The non-arch. height has a parameter "weighted" which is not documented and should be, with doctests shoing its use.  Similarly with the is_minimal parameter.  And for consistency, surely the arch. height should also have a weighted parameter?


Yes, that sounds reasonable.



---

archive/issue_comments_217846.json:
```json
{
    "body": "<a id='comment:13'></a>\nAnd maybe the global height function should also have a parameter \"weighted\", where True means no division by the degree of the number field.  Instead of \"weighted\" the parameter could be called something like \"absolute\" or \"normalised\", where True means that we *do* divide by the degree.",
    "created_at": "2013-06-06T11:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217846",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>
And maybe the global height function should also have a parameter "weighted", where True means no division by the degree of the number field.  Instead of "weighted" the parameter could be called something like "absolute" or "normalised", where True means that we *do* divide by the degree.



---

archive/issue_comments_217847.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [pbruin](#comment%3A13):\n> And maybe the global height function should also have a parameter \"weighted\", where True means no division by the degree of the number field.  Instead of \"weighted\" the parameter could be called something like \"absolute\" or \"normalised\", where True means that we *do* divide by the degree.\n\n\nOK, I am working on it.  For non-arch. places the default, only relevant for a single place,  is weighted=False but when it adds up all the non-arch contributions it puts in the weightings as that is needed for the global height.  When weighting is False the local height is divided by the local degree.  Now for arch. places there is currently no weighting for individual places but we multiply by the local degree when adding up all the arch. contributions.  So I think that the consistent thing to do would be have weighting=True mean that at complex places the local height would be multiplied by 2, then again the total arch. contribution would be obtained by adding up the individual ones, weighted, but the default for a single place would be to have weighting=False and return the same as now.\n\nThe only thing about all that which puzzles me is that in the non-arch. case we divide by the local degree when weighting=False, while for arch. places we multiply by it when weighting=True.  This suggests to me that our conventions for the non-weighted local heights are inconsistent.  What do you think?",
    "created_at": "2013-06-06T11:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217847",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'></a>
Replying to [pbruin](#comment%3A13):
> And maybe the global height function should also have a parameter "weighted", where True means no division by the degree of the number field.  Instead of "weighted" the parameter could be called something like "absolute" or "normalised", where True means that we *do* divide by the degree.


OK, I am working on it.  For non-arch. places the default, only relevant for a single place,  is weighted=False but when it adds up all the non-arch contributions it puts in the weightings as that is needed for the global height.  When weighting is False the local height is divided by the local degree.  Now for arch. places there is currently no weighting for individual places but we multiply by the local degree when adding up all the arch. contributions.  So I think that the consistent thing to do would be have weighting=True mean that at complex places the local height would be multiplied by 2, then again the total arch. contribution would be obtained by adding up the individual ones, weighted, but the default for a single place would be to have weighting=False and return the same as now.

The only thing about all that which puzzles me is that in the non-arch. case we divide by the local degree when weighting=False, while for arch. places we multiply by it when weighting=True.  This suggests to me that our conventions for the non-weighted local heights are inconsistent.  What do you think?



---

archive/issue_comments_217848.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [cremona](#comment%3A14):\n> Replying to [pbruin](#comment%3A13):\n> > And maybe the global height function should also have a parameter \"weighted\", where True means no division by the degree of the number field.  Instead of \"weighted\" the parameter could be called something like \"absolute\" or \"normalised\", where True means that we *do* divide by the degree.\n\n> \n> OK, I am working on it.  For non-arch. places the default, only relevant for a single place,  is weighted=False but when it adds up all the non-arch contributions it puts in the weightings as that is needed for the global height.  When weighting is False the local height is divided by the local degree.  Now for arch. places there is currently no weighting for individual places but we multiply by the local degree when adding up all the arch. contributions.  So I think that the consistent thing to do would be have weighting=True mean that at complex places the local height would be multiplied by 2, then again the total arch. contribution would be obtained by adding up the individual ones, weighted, but the default for a single place would be to have weighting=False and return the same as now.\n\n\nIt seems to me that the parameter \"weighted\" still makes sense if v = None: we should take the weighted sum of the local heights at all (non-)Archimedean places, and if weighted = False, we divide this sum by the degree of K.\n\nAlthough it would certainly be good to have a parameter \"weighted\" for archimedean_local_height, the drawback is that we would again need to distinguish between real and complex places.  With the above way of eliminating the local_degree function, this is only avoided because we know which one it is because of our position in the list of all places.\n\n> The only thing about all that which puzzles me is that in the non-arch. case we divide by the local degree when weighting=False, while for arch. places we multiply by it when weighting=True.  This suggests to me that our conventions for the non-weighted local heights are inconsistent.  What do you think?\n\n\nThe current conventions for the return values of (non)archimedian_local_height are consistent.  The difference is that the calculation is done differently: for v Archimedean we compute with the smaller of the two all the time and multiply by the local degree at the end if necessary, while for v non-Archimedean we compute with the larger of the two and divide by the local degree at the end if necessary.",
    "created_at": "2013-06-06T12:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217848",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:15'></a>
Replying to [cremona](#comment%3A14):
> Replying to [pbruin](#comment%3A13):
> > And maybe the global height function should also have a parameter "weighted", where True means no division by the degree of the number field.  Instead of "weighted" the parameter could be called something like "absolute" or "normalised", where True means that we *do* divide by the degree.

> 
> OK, I am working on it.  For non-arch. places the default, only relevant for a single place,  is weighted=False but when it adds up all the non-arch contributions it puts in the weightings as that is needed for the global height.  When weighting is False the local height is divided by the local degree.  Now for arch. places there is currently no weighting for individual places but we multiply by the local degree when adding up all the arch. contributions.  So I think that the consistent thing to do would be have weighting=True mean that at complex places the local height would be multiplied by 2, then again the total arch. contribution would be obtained by adding up the individual ones, weighted, but the default for a single place would be to have weighting=False and return the same as now.


It seems to me that the parameter "weighted" still makes sense if v = None: we should take the weighted sum of the local heights at all (non-)Archimedean places, and if weighted = False, we divide this sum by the degree of K.

Although it would certainly be good to have a parameter "weighted" for archimedean_local_height, the drawback is that we would again need to distinguish between real and complex places.  With the above way of eliminating the local_degree function, this is only avoided because we know which one it is because of our position in the list of all places.

> The only thing about all that which puzzles me is that in the non-arch. case we divide by the local degree when weighting=False, while for arch. places we multiply by it when weighting=True.  This suggests to me that our conventions for the non-weighted local heights are inconsistent.  What do you think?


The current conventions for the return values of (non)archimedian_local_height are consistent.  The difference is that the calculation is done differently: for v Archimedean we compute with the smaller of the two all the time and multiply by the local degree at the end if necessary, while for v non-Archimedean we compute with the larger of the two and divide by the local degree at the end if necessary.



---

archive/issue_comments_217849.json:
```json
{
    "body": "<a id='comment:16'></a>\nI am right now rebasing this on top of #14609 which I wil add to the prerequisites.  This was rather messy, and the result will be a single new patch instead of the second additional reviewer's patch.\nNot quite ready yet...",
    "created_at": "2013-06-07T11:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217849",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:16'></a>
I am right now rebasing this on top of #14609 which I wil add to the prerequisites.  This was rather messy, and the result will be a single new patch instead of the second additional reviewer's patch.
Not quite ready yet...



---

archive/issue_comments_217850.json:
```json
{
    "body": "Changing dependencies from \"#12509, #13953\" to \"#12509, #13953, #14609\"",
    "created_at": "2013-06-07T12:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217850",
    "user": "https://github.com/JohnCremona"
}
```

Changing dependencies from "#12509, #13953" to "#12509, #13953, #14609"



---

archive/issue_comments_217851.json:
```json
{
    "body": "Changing author from \"Peter Bruin\" to \"Peter Bruin, John Cremona\"",
    "created_at": "2013-06-07T12:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217851",
    "user": "https://github.com/JohnCremona"
}
```

Changing author from "Peter Bruin" to "Peter Bruin, John Cremona"



---

archive/issue_comments_217852.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,3 +12,5 @@\n ```\n \n Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n+ \n+Apply:  trac13951-local_heights.patch\n``````\n",
    "created_at": "2013-06-07T12:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217852",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,3 +12,5 @@
 ```
 
 Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).
+ 
+Apply:  trac13951-local_heights.patch
``````




---

archive/issue_comments_217853.json:
```json
{
    "body": "Reviewer: John Cremona, Peter Bruin",
    "created_at": "2013-06-07T12:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217853",
    "user": "https://github.com/JohnCremona"
}
```

Reviewer: John Cremona, Peter Bruin



---

archive/issue_comments_217854.json:
```json
{
    "body": "<a id='comment:18'></a>\nPeter, this is ready for review again.  It would be useful if you could review the changes I made before we ask a 3rd party;  I am sorry that because of the rebasing, by patch is not separate.\n\nI did not add a weighted parameter to the archimedean height, for the reasons discussed.\n\nI was about to add a normalised parameter to the global height, defaulting to True, but changed my mind since that would require having two different cached values, one normalised and one not, and I was lazy.\n\nBy the way, I did verify using independent code in eclib that the examples you added (local heights over QQ) give the correct values.",
    "created_at": "2013-06-07T12:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217854",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:18'></a>
Peter, this is ready for review again.  It would be useful if you could review the changes I made before we ask a 3rd party;  I am sorry that because of the rebasing, by patch is not separate.

I did not add a weighted parameter to the archimedean height, for the reasons discussed.

I was about to add a normalised parameter to the global height, defaulting to True, but changed my mind since that would require having two different cached values, one normalised and one not, and I was lazy.

By the way, I did verify using independent code in eclib that the examples you added (local heights over QQ) give the correct values.



---

archive/issue_comments_217855.json:
```json
{
    "body": "<a id='comment:19'></a>\nOK, I will install 5.10.rc1 and review the patch.  One quick comment: the parameter \"prec\" in non_archimedean_local_height is documented twice (lines 2801-2806).",
    "created_at": "2013-06-07T12:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217855",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>
OK, I will install 5.10.rc1 and review the patch.  One quick comment: the parameter "prec" in non_archimedean_local_height is documented twice (lines 2801-2806).



---

archive/issue_comments_217856.json:
```json
{
    "body": "rebased on 5.10.rc0 and extended: replaces previous patch",
    "created_at": "2013-06-07T13:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217856",
    "user": "https://github.com/JohnCremona"
}
```

rebased on 5.10.rc0 and extended: replaces previous patch



---

archive/issue_comments_217857.json:
```json
{
    "body": "<a id='comment:20'></a>\nAttachment [trac13951-local_heights.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-local_heights.patch) by @JohnCremona created at 2013-06-07 13:01:36\n\nReplying to [pbruin](#comment%3A19):\n> OK, I will install 5.10.rc1 and review the patch.  One quick comment: the parameter \"prec\" in non_archimedean_local_height is documented twice (lines 2801-2806).\n\n\nLet me fix that one right away to save you trouble.  Done!",
    "created_at": "2013-06-07T13:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217857",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:20'></a>
Attachment [trac13951-local_heights.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-local_heights.patch) by @JohnCremona created at 2013-06-07 13:01:36

Replying to [pbruin](#comment%3A19):
> OK, I will install 5.10.rc1 and review the patch.  One quick comment: the parameter "prec" in non_archimedean_local_height is documented twice (lines 2801-2806).


Let me fix that one right away to save you trouble.  Done!



---

archive/issue_comments_217858.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,5 +12,5 @@\n ```\n \n Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n- \n-Apply:  trac13951-local_heights.patch\n+\n+Apply: trac13951-local_heights.patch, trac13951-local_heights_2.patch\n``````\n",
    "created_at": "2013-06-08T20:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217858",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,5 +12,5 @@
 ```
 
 Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).
- 
-Apply:  trac13951-local_heights.patch
+
+Apply: trac13951-local_heights.patch, trac13951-local_heights_2.patch
``````




---

archive/issue_comments_217859.json:
```json
{
    "body": "<a id='comment:21'></a>\nThanks!  The only problem was a warning while building the documentation.  The new patch fixes this and polishes the documentation of [[non_]archimedean_local_]height.\n\nI now added a \"weighted\" flag to the global height function (only the normalised height is cached) and to archimedean_local_height.  For the latter I reintroduced the ugly way of checking whether an Archimedean place is real (v.im_gens()[0] in rings.RR).  However, this is only needed when the user directly calls archimedean_local_height(v, weighted=True), not when v = None.",
    "created_at": "2013-06-08T20:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217859",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:21'></a>
Thanks!  The only problem was a warning while building the documentation.  The new patch fixes this and polishes the documentation of [[non_]archimedean_local_]height.

I now added a "weighted" flag to the global height function (only the normalised height is cached) and to archimedean_local_height.  For the latter I reintroduced the ugly way of checking whether an Archimedean place is real (v.im_gens()[0] in rings.RR).  However, this is only needed when the user directly calls archimedean_local_height(v, weighted=True), not when v = None.



---

archive/issue_comments_217860.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [cremona](#comment%3A18):\n\n> I was about to add a normalised parameter to the global height, defaulting to True, but changed my mind since that would require having two different cached values, one normalised and one not, and I was lazy.\n\n\nProbably \"normalised\" (default True) is more intuitive than \"weighted\" (default False); I changed this in the latest patch, together with some minimal extra polishing of the documentation.",
    "created_at": "2013-06-08T21:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217860",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:22'></a>
Replying to [cremona](#comment%3A18):

> I was about to add a normalised parameter to the global height, defaulting to True, but changed my mind since that would require having two different cached values, one normalised and one not, and I was lazy.


Probably "normalised" (default True) is more intuitive than "weighted" (default False); I changed this in the latest patch, together with some minimal extra polishing of the documentation.



---

archive/issue_comments_217861.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [pbruin](#comment%3A22):\n> Replying to [cremona](#comment%3A18):\n> \n> > I was about to add a normalised parameter to the global height, defaulting to True, but changed my mind since that would require having two different cached values, one normalised and one not, and I was lazy.\n\n> \n> Probably \"normalised\" (default True) is more intuitive than \"weighted\" (default False); I changed this in the latest patch, together with some minimal extra polishing of the documentation.\n\n\nThanks for doing the extra work on this, whic certainly makes it better.  I'll look at it today.",
    "created_at": "2013-06-09T11:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217861",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:23'></a>
Replying to [pbruin](#comment%3A22):
> Replying to [cremona](#comment%3A18):
> 
> > I was about to add a normalised parameter to the global height, defaulting to True, but changed my mind since that would require having two different cached values, one normalised and one not, and I was lazy.

> 
> Probably "normalised" (default True) is more intuitive than "weighted" (default False); I changed this in the latest patch, together with some minimal extra polishing of the documentation.


Thanks for doing the extra work on this, whic certainly makes it better.  I'll look at it today.



---

archive/issue_comments_217862.json:
```json
{
    "body": "<a id='comment:24'></a>\nOne small point:  on line 2618 you set w=1, which will be a python int, and then you multiply the final returned height by w (in 3 places, 2 with the cached value and one when it is computed).  Maybe I am old-fashioned, but I don't like multiplying by 1: can we reply on python doing nothing when that value of 1 is a plain python int?  If it were not for this scaling needing to be done in three places I would suggest not defining w at all and ending the function with\n\n```\nif normalised:\n    return height\nelse:\n    return height * K.degree()\n```\nbut it is not very nice to add that three times.\n\nPerhaps multiplying by one in the usual (and default) case is not serious.\n\nThe only other thing to point out is that there is no new doctest to show the effect of the normalisation parameter.  How about:\n\n```\nsage: E = EllipticCurve('37a1')\nsage: P = E([0,0])\nsage: P.height()\n0.0511114082399688\nsage: P.height(normalised=False)\n0.0511114082399688\nsage: K.<z> = CyclotomicField(5) # or perhaps something simpler\nsage: EK = E.change_ring(K)\nsage: PK = EK([0,0])\nsage: PK.height()\n0.0511114082399688\nsage: PK.height(normalised=False)\n0.204445632959875\n```",
    "created_at": "2013-06-09T14:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217862",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'></a>
One small point:  on line 2618 you set w=1, which will be a python int, and then you multiply the final returned height by w (in 3 places, 2 with the cached value and one when it is computed).  Maybe I am old-fashioned, but I don't like multiplying by 1: can we reply on python doing nothing when that value of 1 is a plain python int?  If it were not for this scaling needing to be done in three places I would suggest not defining w at all and ending the function with

```
if normalised:
    return height
else:
    return height * K.degree()
```
but it is not very nice to add that three times.

Perhaps multiplying by one in the usual (and default) case is not serious.

The only other thing to point out is that there is no new doctest to show the effect of the normalisation parameter.  How about:

```
sage: E = EllipticCurve('37a1')
sage: P = E([0,0])
sage: P.height()
0.0511114082399688
sage: P.height(normalised=False)
0.0511114082399688
sage: K.<z> = CyclotomicField(5) # or perhaps something simpler
sage: EK = E.change_ring(K)
sage: PK = EK([0,0])
sage: PK.height()
0.0511114082399688
sage: PK.height(normalised=False)
0.204445632959875
```



---

archive/issue_comments_217863.json:
```json
{
    "body": "<a id='comment:25'></a>\nI updated trac13951-local_heights_2.patch; height() now only has one return statement, and multiplication by the degree, if necessary, is done at the very end.  You are right that I should have made a doctest; I added the one you suggested.",
    "created_at": "2013-06-10T11:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217863",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:25'></a>
I updated trac13951-local_heights_2.patch; height() now only has one return statement, and multiplication by the degree, if necessary, is done at the very end.  You are right that I should have made a doctest; I added the one you suggested.



---

archive/issue_comments_217864.json:
```json
{
    "body": "Attachment [trac13951-local_heights_2.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-local_heights_2.patch) by @pjbruin created at 2013-06-10 11:51:07\n\napply after trac13591-local_heights.patch",
    "created_at": "2013-06-10T11:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217864",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac13951-local_heights_2.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-local_heights_2.patch) by @pjbruin created at 2013-06-10 11:51:07

apply after trac13591-local_heights.patch



---

archive/issue_comments_217865.json:
```json
{
    "body": "<a id='comment:26'></a>\nExcellent, now I am happy with everything.\n\nAt this point we need a reviewer for our combined work, unless some independent third party is  happy that we have each reviewed the other's work and can give the pair of patches a combined positive review.\n\nJohn",
    "created_at": "2013-06-10T13:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217865",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:26'></a>
Excellent, now I am happy with everything.

At this point we need a reviewer for our combined work, unless some independent third party is  happy that we have each reviewed the other's work and can give the pair of patches a combined positive review.

John



---

archive/issue_comments_217866.json:
```json
{
    "body": "<a id='comment:27'></a>\nI was willing to review this, but unfortunately it does not apply to 5.10. It needs to be rebased.\n\n```\n...\npatching file sage/schemes/elliptic_curves/ell_point.py\nHunk #1 FAILED at 138\nHunk #3 succeeded at 2390 with fuzz 2 (offset -17 lines).\n...\n```",
    "created_at": "2013-06-22T20:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217866",
    "user": "https://github.com/categorie"
}
```

<a id='comment:27'></a>
I was willing to review this, but unfortunately it does not apply to 5.10. It needs to be rebased.

```
...
patching file sage/schemes/elliptic_curves/ell_point.py
Hunk #1 FAILED at 138
Hunk #3 succeeded at 2390 with fuzz 2 (offset -17 lines).
...
```



---

archive/issue_comments_217867.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-06-22T20:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217867",
    "user": "https://github.com/categorie"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217868.json:
```json
{
    "body": "<a id='comment:28'></a>\nThat is strange, I just checked that both patches apply without any problems to a fresh copy of 5.11.rc3:\n\n```\nsage: hg_sage.qimport('trac13951-local_heights.patch')\ncd \"/home/staff/pbruin/src/sage-5.11.beta3/devel/sage\" && sage --hg qimport  /home/staff/pbruin/src/sage-5.11.beta3/trac13951-local_heights.patch\nadding trac13951-local_heights.patch to series file\nsage: hg_sage.qpush()\ncd \"/home/staff/pbruin/src/sage-5.11.beta3/devel/sage\" && sage --hg qpush  \napplying trac13951-local_heights.patch\nnow at: trac13951-local_heights.patch\nsage: hg_sage.qimport('trac13951-local_heights_2.patch')\ncd \"/home/staff/pbruin/src/sage-5.11.beta3/devel/sage\" && sage --hg qimport  /home/staff/pbruin/src/sage-5.11.beta3/trac13951-local_heights_2.patch\nadding trac13951-local_heights_2.patch to series file\nsage: hg_sage.qpush()\ncd \"/home/staff/pbruin/src/sage-5.11.beta3/devel/sage\" && sage --hg qpush  \napplying trac13951-local_heights_2.patch\nnow at: trac13951-local_heights_2.patch\nsage: hg_sage.qapplied()\ncd \"/home/staff/pbruin/src/sage-5.11.beta3/devel/sage\" && sage --hg qapplied  \ntrac13951-local_heights.patch\ntrac13951-local_heights_2.patch\n```",
    "created_at": "2013-06-25T12:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217868",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:28'></a>
That is strange, I just checked that both patches apply without any problems to a fresh copy of 5.11.rc3:

```
sage: hg_sage.qimport('trac13951-local_heights.patch')
cd "/home/staff/pbruin/src/sage-5.11.beta3/devel/sage" && sage --hg qimport  /home/staff/pbruin/src/sage-5.11.beta3/trac13951-local_heights.patch
adding trac13951-local_heights.patch to series file
sage: hg_sage.qpush()
cd "/home/staff/pbruin/src/sage-5.11.beta3/devel/sage" && sage --hg qpush  
applying trac13951-local_heights.patch
now at: trac13951-local_heights.patch
sage: hg_sage.qimport('trac13951-local_heights_2.patch')
cd "/home/staff/pbruin/src/sage-5.11.beta3/devel/sage" && sage --hg qimport  /home/staff/pbruin/src/sage-5.11.beta3/trac13951-local_heights_2.patch
adding trac13951-local_heights_2.patch to series file
sage: hg_sage.qpush()
cd "/home/staff/pbruin/src/sage-5.11.beta3/devel/sage" && sage --hg qpush  
applying trac13951-local_heights_2.patch
now at: trac13951-local_heights_2.patch
sage: hg_sage.qapplied()
cd "/home/staff/pbruin/src/sage-5.11.beta3/devel/sage" && sage --hg qapplied  
trac13951-local_heights.patch
trac13951-local_heights_2.patch
```



---

archive/issue_comments_217869.json:
```json
{
    "body": "<a id='comment:29'></a>\nHmmmm, I still cannot do it. I was not able to figure out what is wrong with my new 5.10 installation. Well, I am sorry, but I won't be able to get a new copy and do it again before leaving on holidays. So the ticket has to wait review for a few weeks unless someone else picks it up first.\n\nSorry.",
    "created_at": "2013-06-27T08:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217869",
    "user": "https://github.com/categorie"
}
```

<a id='comment:29'></a>
Hmmmm, I still cannot do it. I was not able to figure out what is wrong with my new 5.10 installation. Well, I am sorry, but I won't be able to get a new copy and do it again before leaving on holidays. So the ticket has to wait review for a few weeks unless someone else picks it up first.

Sorry.



---

archive/issue_comments_217870.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-06-27T08:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217870",
    "user": "https://github.com/categorie"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217871.json:
```json
{
    "body": "<a id='comment:30'></a>\nFor patchbot:\n\nApply trac13951-local_heights.patch, trac13951-local_heights_2.patch",
    "created_at": "2013-07-15T21:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217871",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:30'></a>
For patchbot:

Apply trac13951-local_heights.patch, trac13951-local_heights_2.patch



---

archive/issue_comments_217872.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,4 +13,5 @@\n \n Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n \n-Apply: trac13951-local_heights.patch, trac13951-local_heights_2.patch\n+Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac13951-docstring_raw.patch]\n+\n``````\n",
    "created_at": "2013-07-16T13:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217872",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,4 +13,5 @@
 
 Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).
 
-Apply: trac13951-local_heights.patch, trac13951-local_heights_2.patch
+Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac13951-docstring_raw.patch]
+
``````




---

archive/issue_comments_217873.json:
```json
{
    "body": "<a id='comment:31'></a>\nPatchbot complains about the non-ASCII character in \"N\u00e9ron\".  I assume this isn't a problem, cf. the discussion about \u0428 in a docstring in #14561.  The relevant file is already UTF-8-encoded; I'll just make the docstring start with `r\"\"\"`.",
    "created_at": "2013-07-16T13:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217873",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:31'></a>
Patchbot complains about the non-ASCII character in "Néron".  I assume this isn't a problem, cf. the discussion about Ш in a docstring in #14561.  The relevant file is already UTF-8-encoded; I'll just make the docstring start with `r"""`.



---

archive/issue_comments_217874.json:
```json
{
    "body": "Label docstring as \"raw\" due to UTF-8 character",
    "created_at": "2013-07-16T13:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217874",
    "user": "https://github.com/pjbruin"
}
```

Label docstring as "raw" due to UTF-8 character



---

archive/issue_comments_217875.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,5 +13,5 @@\n \n Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n \n-Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac13951-docstring_raw.patch]\n+Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch]\n \n``````\n",
    "created_at": "2013-07-18T07:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217875",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,5 +13,5 @@
 
 Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).
 
-Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac13951-docstring_raw.patch]
+Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch]
 
``````




---

archive/issue_comments_217876.json:
```json
{
    "body": "<a id='comment:32'></a>\nAttachment [trac13951-docstring_raw.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-docstring_raw.patch) by @pjbruin created at 2013-07-18 07:34:37\n\nThe last patch wasn't necessary, see the comments at #14746.\n\nPatchbot: apply trac13951-local_heights.patch, trac13951-local_heights_2.patch",
    "created_at": "2013-07-18T07:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217876",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:32'></a>
Attachment [trac13951-docstring_raw.patch](tarball://root/attachments/some-uuid/ticket13951/trac13951-docstring_raw.patch) by @pjbruin created at 2013-07-18 07:34:37

The last patch wasn't necessary, see the comments at #14746.

Patchbot: apply trac13951-local_heights.patch, trac13951-local_heights_2.patch



---

archive/issue_events_045352.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13951#event-45352"
}
```



---

archive/issue_comments_217877.json:
```json
{
    "body": "Attachment [trac_13951_extra.patch](tarball://root/attachments/some-uuid/ticket13951/trac_13951_extra.patch) by @JohnCremona created at 2013-09-07 17:08:43\n\nSmall additional fix",
    "created_at": "2013-09-07T17:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217877",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [trac_13951_extra.patch](tarball://root/attachments/some-uuid/ticket13951/trac_13951_extra.patch) by @JohnCremona created at 2013-09-07 17:08:43

Small additional fix



---

archive/issue_comments_217878.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,5 +13,4 @@\n \n Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).\n \n-Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch]\n-\n+Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac_13951_extra.patch]\n``````\n",
    "created_at": "2013-09-07T17:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217878",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,5 +13,4 @@
 
 Note: at the moment this bug only shows up for non-torsion points because of bug #13953 (asking for local heights of torsion points always returns 0, which is in general incorrect).
 
-Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch]
-
+Apply: [attachment:trac13951-local_heights.patch], [attachment:trac13951-local_heights_2.patch], [attachment:trac_13951_extra.patch]
``````




---

archive/issue_comments_217879.json:
```json
{
    "body": "<a id='comment:35'></a>\nI added an additional bugfix and doctest in the patch trac_13951_extra.patch.\n\nPeter, there's a patch by you not listed in the description.  Is that intended to be applied too?",
    "created_at": "2013-09-07T17:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217879",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:35'></a>
I added an additional bugfix and doctest in the patch trac_13951_extra.patch.

Peter, there's a patch by you not listed in the description.  Is that intended to be applied too?



---

archive/issue_comments_217880.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [cremona](#comment%3A35):\n> I added an additional bugfix and doctest in the patch trac_13951_extra.patch.\n\n\nGood!\n\n> Peter, there's a patch by you not listed in the description.  Is that intended to be applied too?\n\n\nNo, the idea of that patch was to mark some docstring because of an accented character, but it did the wrong thing (using `r\"\"\"`, which just prevents backslashes from being interpreted).  In fact, nothing had to be done since the file was already UTF-8-encoded.",
    "created_at": "2013-09-07T17:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217880",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:36'></a>
Replying to [cremona](#comment%3A35):
> I added an additional bugfix and doctest in the patch trac_13951_extra.patch.


Good!

> Peter, there's a patch by you not listed in the description.  Is that intended to be applied too?


No, the idea of that patch was to mark some docstring because of an accented character, but it did the wrong thing (using `r"""`, which just prevents backslashes from being interpreted).  In fact, nothing had to be done since the file was already UTF-8-encoded.



---

archive/issue_comments_217881.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [cremona](#comment%3A26):\n> Excellent, now I am happy with everything.\n> \n> At this point we need a reviewer for our combined work, unless some independent third party is  happy that we have each reviewed the other's work and can give the pair of patches a combined positive review.\n\n\nI assume Jeroen Demeyer's comment on sage-support when you mentioned this ticket\n(https://groups.google.com/forum/#!topic/sage-support/xe69MXW0aSE) qualifies as such!",
    "created_at": "2013-11-22T23:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217881",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:37'></a>
Replying to [cremona](#comment%3A26):
> Excellent, now I am happy with everything.
> 
> At this point we need a reviewer for our combined work, unless some independent third party is  happy that we have each reviewed the other's work and can give the pair of patches a combined positive review.


I assume Jeroen Demeyer's comment on sage-support when you mentioned this ticket
(https://groups.google.com/forum/#!topic/sage-support/xe69MXW0aSE) qualifies as such!



---

archive/issue_comments_217882.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-22T23:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217882",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_045353.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-24T17:26:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13951#event-45353"
}
```



---

archive/issue_comments_217883.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-11-24T17:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217883",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_217884.json:
```json
{
    "body": "Merged: sage-5.13.beta4",
    "created_at": "2013-11-24T17:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13951#issuecomment-217884",
    "user": "https://github.com/jdemeyer"
}
```

Merged: sage-5.13.beta4
