# Issue 13655: anonymous symbols lose their identity when passed through maxima

archive/issues_013451.json:
```json
{
    "assignees": [
        "https://github.com/burcin"
    ],
    "body": "When a symbol returned by `SR.symbol()` is passed through Maxima, it is turned into another symbol. They compare equal (because comparison invokes Maxima, probably) but they are not the same object.\n\nThis sounds as if it should not make a big difference, but it does in the case of Taylor series. In this example, I try to obtain taylor series coefficients. The call to `coefficient` returns zero, however, because the variable has changed identity because the Taylor series was generated by Maxima.\n\n\n```\nsage: s = SR.symbol()\nsage: converted_s = s._maxima_().sage()\nsage: converted_s is s\nFalse\nsage: bool(converted_s == s)\nTrue\nsage: x1 = var('x1')\nsage: converted_x1 = x1._maxima_().sage()\nsage: converted_x1 is x1\nTrue\nsage: bool(converted_x1 == x1)\nTrue\nsage: (3*x1).coefficient(converted_x1)\n3\nsage: (3*s).coefficient(converted_s)\n0\nsage: (x1^2 + 3*x1 + 1).taylor(x1,0,2).coefficient(x1)\n3\nsage: (s^2 + 3*s + 1).taylor(s,0,2).coefficient(s)\n0\n\n```\n\nComponent: **interfaces**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13655_\n\n",
    "created_at": "2012-10-26T13:40:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "anonymous symbols lose their identity when passed through maxima",
    "type": "issue",
    "updated_at": "2022-12-29T01:28:25Z",
    "url": "https://github.com/sagemath/sage/issues/13655",
    "user": "https://github.com/tkluck"
}
```
When a symbol returned by `SR.symbol()` is passed through Maxima, it is turned into another symbol. They compare equal (because comparison invokes Maxima, probably) but they are not the same object.

This sounds as if it should not make a big difference, but it does in the case of Taylor series. In this example, I try to obtain taylor series coefficients. The call to `coefficient` returns zero, however, because the variable has changed identity because the Taylor series was generated by Maxima.


```
sage: s = SR.symbol()
sage: converted_s = s._maxima_().sage()
sage: converted_s is s
False
sage: bool(converted_s == s)
True
sage: x1 = var('x1')
sage: converted_x1 = x1._maxima_().sage()
sage: converted_x1 is x1
True
sage: bool(converted_x1 == x1)
True
sage: (3*x1).coefficient(converted_x1)
3
sage: (3*s).coefficient(converted_s)
0
sage: (x1^2 + 3*x1 + 1).taylor(x1,0,2).coefficient(x1)
3
sage: (s^2 + 3*s + 1).taylor(s,0,2).coefficient(s)
0

```

Component: **interfaces**

_Issue created by migration from https://trac.sagemath.org/ticket/13655_





---

archive/issue_events_191091.json:
```json
{
    "actor": "https://github.com/tkluck",
    "created_at": "2012-10-26T13:40:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191091"
}
```



---

archive/issue_events_191092.json:
```json
{
    "actor": "https://github.com/tkluck",
    "created_at": "2012-10-26T13:40:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "c: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191092"
}
```



---

archive/issue_events_191093.json:
```json
{
    "actor": "https://github.com/tkluck",
    "created_at": "2012-10-26T13:40:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191093"
}
```



---

archive/issue_events_191094.json:
```json
{
    "actor": "https://github.com/tkluck",
    "created_at": "2012-10-26T13:40:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191094"
}
```



---

archive/issue_events_191095.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2012-10-26T13:40:40Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "subject": "https://github.com/tkluck",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191095"
}
```



---

archive/issue_comments_160272.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe problem is a little more widespread:\n\n```\nsage: s = SR.symbol()\nsage: s1 = s._maxima_().sage()\nsage: s2 = sage.calculus.calculus.maxima(s).sage()\nsage: s3 = integrate(s,s).variables()[0]\nsage: [id(s),id(s1),id(s2),id(s3)]\n[140326504362424, 96060840, 96060840, 96060696]\nsage: (s^2 + 3*s + 1).taylor(s,0,2).coefficient(s3)\n0\nsage: (s1^2 + 3*s1 + 1).taylor(s1,0,2).coefficient(s3)\n0\nsage: (s3^2 + 3*s3 + 1).taylor(s3,0,2).coefficient(s1)\n3\n```\n\n```\nsage: s = SR('t')\nsage: s1 = s._maxima_().sage()\nsage: s2 = sage.calculus.calculus.maxima(s).sage()\nsage: s3 = integrate(s,s).variables()[0]\nsage: [id(s),id(s1),id(s2),id(s3)]\n[95996024, 95996024, 95996024, 96062064]\nsage: (s^2 + 3*s + 1).taylor(s,0,2).coefficient(s3)\n3\nsage: L=[integrate(s,s).variables()[0] for i in range(10)]\nsage: [id(l) for  l in L]\n[96062928, 96061704, 96062568, 96061200, 97231576, 97231504, 97231936, 97232008, 97232080, 97232152]\n```\nAs you see, the variables produced by integrate, which go through the symbol-based interface with libmaxima (i.e., no direct string translations) don't maintain symbol identity at all. However, that doesn't always seem to affect how they behave (perhaps the python wrapper id doesn't reflect the identity of the wrapped pynac entity).\n\nPerhaps `SR.symbol` produces an \"uninterned\" symbol? In that case, the most straightforward solution would be to let `SR.symbol()` produce interned symbols. That would leak memory, but converting symbols to maxima already does (because we have to interface with a non-refcounting system)",
    "created_at": "2012-10-26T15:21:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160272",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

The problem is a little more widespread:

```
sage: s = SR.symbol()
sage: s1 = s._maxima_().sage()
sage: s2 = sage.calculus.calculus.maxima(s).sage()
sage: s3 = integrate(s,s).variables()[0]
sage: [id(s),id(s1),id(s2),id(s3)]
[140326504362424, 96060840, 96060840, 96060696]
sage: (s^2 + 3*s + 1).taylor(s,0,2).coefficient(s3)
0
sage: (s1^2 + 3*s1 + 1).taylor(s1,0,2).coefficient(s3)
0
sage: (s3^2 + 3*s3 + 1).taylor(s3,0,2).coefficient(s1)
3
```

```
sage: s = SR('t')
sage: s1 = s._maxima_().sage()
sage: s2 = sage.calculus.calculus.maxima(s).sage()
sage: s3 = integrate(s,s).variables()[0]
sage: [id(s),id(s1),id(s2),id(s3)]
[95996024, 95996024, 95996024, 96062064]
sage: (s^2 + 3*s + 1).taylor(s,0,2).coefficient(s3)
3
sage: L=[integrate(s,s).variables()[0] for i in range(10)]
sage: [id(l) for  l in L]
[96062928, 96061704, 96062568, 96061200, 97231576, 97231504, 97231936, 97232008, 97232080, 97232152]
```
As you see, the variables produced by integrate, which go through the symbol-based interface with libmaxima (i.e., no direct string translations) don't maintain symbol identity at all. However, that doesn't always seem to affect how they behave (perhaps the python wrapper id doesn't reflect the identity of the wrapped pynac entity).

Perhaps `SR.symbol` produces an "uninterned" symbol? In that case, the most straightforward solution would be to let `SR.symbol()` produce interned symbols. That would leak memory, but converting symbols to maxima already does (because we have to interface with a non-refcounting system)



---

archive/issue_comments_160273.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nWhat do you mean by an \"uninterned\" symbol? Is that a Sage, a Pynac, or a Maxima concept?",
    "created_at": "2012-10-26T16:04:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160273",
    "user": "https://github.com/tkluck"
}
```

<div id="comment:2" align="right">comment:2</div>

What do you mean by an "uninterned" symbol? Is that a Sage, a Pynac, or a Maxima concept?



---

archive/issue_comments_160274.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nYou can google \"string interning\". It's a standard technique that is usually employed for symbol-type objects. For \"interned\" objects, equality implies identity. I suspect Pynac does something like that internally.\n\nSome systems have both interned and uninterned strings/symbols. Using the latter in a context where the former is expected results exactly in the behaviour you observed. That's why I mentioned it, but a pynac expert (which I'm not) can probably quickly tell if this is the problem here.",
    "created_at": "2012-10-26T16:54:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160274",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

You can google "string interning". It's a standard technique that is usually employed for symbol-type objects. For "interned" objects, equality implies identity. I suspect Pynac does something like that internally.

Some systems have both interned and uninterned strings/symbols. Using the latter in a context where the former is expected results exactly in the behaviour you observed. That's why I mentioned it, but a pynac expert (which I'm not) can probably quickly tell if this is the problem here.



---

archive/issue_comments_160275.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nbruin](#comment:3):\n> Some systems have both interned and uninterned strings/symbols. Using the latter in a context where the former is expected results exactly in the behaviour you observed. That's why I mentioned it, but a pynac expert (which I'm not) can probably quickly tell if this is the problem here.\n\n`SR.symbol()` is intended to return uninterned symbols when called without an argument. In the source, you will see that there is a branch `if name is None:` where `pynac_symbol_registry[name] = e` is not called. My intention was to let the user create symbolic variables without the risk of picking the name of a variable used in the input. \n\nThe conversion back from Maxima always creates an interned symbol if it cannot find one already existing in the registry. I admit that this use case never occured to me before. So we have a bug.\n\nI don't want to lose the current `SR.symbol()` behavior (uninterned symbols). One possible solution here is to keep two symbol registries. Keeping the current one and introducing a new one which contains all symbols including the \"uninterned\" ones, to be used for Maxima conversions.",
    "created_at": "2012-11-07T13:40:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160275",
    "user": "https://github.com/burcin"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nbruin](#comment:3):
> Some systems have both interned and uninterned strings/symbols. Using the latter in a context where the former is expected results exactly in the behaviour you observed. That's why I mentioned it, but a pynac expert (which I'm not) can probably quickly tell if this is the problem here.

`SR.symbol()` is intended to return uninterned symbols when called without an argument. In the source, you will see that there is a branch `if name is None:` where `pynac_symbol_registry[name] = e` is not called. My intention was to let the user create symbolic variables without the risk of picking the name of a variable used in the input. 

The conversion back from Maxima always creates an interned symbol if it cannot find one already existing in the registry. I admit that this use case never occured to me before. So we have a bug.

I don't want to lose the current `SR.symbol()` behavior (uninterned symbols). One possible solution here is to keep two symbol registries. Keeping the current one and introducing a new one which contains all symbols including the "uninterned" ones, to be used for Maxima conversions.



---

archive/issue_comments_160276.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@burcin](#comment:4):\n> `SR.symbol()` is intended to return uninterned symbols when called without an argument. In the source, you will see that there is a branch `if name is None:` where `pynac_symbol_registry[name] = e` is not called. My intention was to let the user create symbolic variables without the risk of picking the name of a variable used in the input. \n\nMaxima (or lisp for that matter) does have uninterned symbols as well. You won't recognize them from their string representation, though (unless you introduce a naming convention). However, if upon creation you store an attribute on them, you can still identify them as \"uninterned\" and create the corresponding uninterned symbol in Pynac as well. For the binary libmaxima interface this is pretty straightforward. For string-based (and there is really not much reason anymore to keep using that for calculus other than laziness for moving the remaining routines over) it's a little trickier.\n\n**EDIT:** However, this is not going to help with translation between the two systems: If you want to log the mapping between uninterned symbols by identity then they're not really uninterned anymore (or at least, they'll leak memory just as normal symbols do).",
    "created_at": "2012-11-07T16:02:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160276",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@burcin](#comment:4):
> `SR.symbol()` is intended to return uninterned symbols when called without an argument. In the source, you will see that there is a branch `if name is None:` where `pynac_symbol_registry[name] = e` is not called. My intention was to let the user create symbolic variables without the risk of picking the name of a variable used in the input. 

Maxima (or lisp for that matter) does have uninterned symbols as well. You won't recognize them from their string representation, though (unless you introduce a naming convention). However, if upon creation you store an attribute on them, you can still identify them as "uninterned" and create the corresponding uninterned symbol in Pynac as well. For the binary libmaxima interface this is pretty straightforward. For string-based (and there is really not much reason anymore to keep using that for calculus other than laziness for moving the remaining routines over) it's a little trickier.

**EDIT:** However, this is not going to help with translation between the two systems: If you want to log the mapping between uninterned symbols by identity then they're not really uninterned anymore (or at least, they'll leak memory just as normal symbols do).



---

archive/issue_events_191096.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191096"
}
```



---

archive/issue_events_191097.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191097"
}
```



---

archive/issue_events_191098.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191098"
}
```



---

archive/issue_events_191099.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191099"
}
```



---

archive/issue_events_191100.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191100"
}
```



---

archive/issue_events_191101.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191101"
}
```



---

archive/issue_events_191102.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191102"
}
```



---

archive/issue_events_191103.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191103"
}
```



---

archive/issue_events_191104.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-01-13T16:16:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "c: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191104"
}
```



---

archive/issue_events_191105.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-01-13T16:16:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191105"
}
```



---

archive/issue_events_191106.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2015-01-13T16:16:41Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "subject": "https://github.com/rwst",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191106"
}
```



---

archive/issue_events_191107.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2015-01-13T16:16:41Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "subject": "https://github.com/rwst",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191107"
}
```



---

archive/issue_events_191108.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2015-01-13T16:55:48Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "subject": "https://github.com/rwst",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191108"
}
```



---

archive/issue_events_191109.json:
```json
{
    "actor": "https://github.com/burcin",
    "created_at": "2015-01-13T16:55:48Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "subject": "https://github.com/rwst",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191109"
}
```



---

archive/issue_comments_160277.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOops, how did I do that?",
    "created_at": "2015-01-13T16:55:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160277",
    "user": "https://github.com/rwst"
}
```

<div id="comment:11" align="right">comment:11</div>

Oops, how did I do that?



---

archive/issue_comments_160278.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSee also [this sage-devel discussion](https://groups.google.com/forum/#!topic/sage-devel/ktAt5_9xhOk) which apparently is about the same issue.",
    "created_at": "2016-01-22T16:00:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13655#issuecomment-160278",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:12" align="right">comment:12</div>

See also [this sage-devel discussion](https://groups.google.com/forum/#!topic/sage-devel/ktAt5_9xhOk) which apparently is about the same issue.



---

archive/issue_events_191110.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:28:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13655",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13655#event-191110"
}
```
