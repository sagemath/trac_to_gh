# Issue 13674: Cholesky decomposition for sparse matrices

archive/issues_013470.json:
```json
{
    "body": "The Cholesky decomposition are implemented in the file [sage/matrix/matrix2.pyx](../tree/master/sage/matrix/matrix2.pyx) for some subfield of the algebraic numbers.\n\nIn this implementation the base ring must be exact or, for numerical work, a\nmatrix with a base ring of ``RDF`` or ``CDF`` must be used.\n\nFor the numerical work it's used the Cholesky decomposition implemented in [sage/matrix/matrix_double_dense.pyx](../tree/master/sage/matrix/matrix_double_dense.pyx) and because of this a error raised when try to compute the numerical Cholesky decomposition of a sparse matrix.\n\n```\nsage: A = matrix(QQ, [[1, 1], [1, 2]]) \nsage: A.cholesky()                    \n[1 0]\n[1 1]\nsage: A = matrix(QQ, [[1, 1], [1, 2]], sparse=True)\nsage: A.cholesky()                                 \n[1 0]\n[1 1]\nsage: A = matrix(RDF, [[1, 1], [1, 2]], sparse=True)  \nsage: A = matrix(RDF, [[1, 1], [1, 2]])             \nsage: A.cholesky()                                  \n[1.0 0.0]\n[1.0 1.0]\nsage: A = matrix(RDF, [[1, 1], [1, 2]], sparse=True)\nsage: A.cholesky()                                  \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/home/raniere/opt/sage/devel/sage-rcm/sage/matrix/<ipython console> in <module>()\n\n/home/raniere/opt/sage/local/lib/python2.7/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.cholesky (sage/matrix/matrix2.c:47738)()\n   9867             if not self.base_ring().is_exact():\n   9868                 msg = 'base ring of the matrix must be exact, not {0}'\n-> 9869                 raise TypeError(msg.format(self.base_ring()))\n   9870             try:\n   9871                 posdef = self.is_positive_definite()\n\nTypeError: base ring of the matrix must be exact, not Real Double Field\n```\n\nFor this solve this ticket the numerical sparce Cholesky decompostion need to be implemented.\n\nFor more information about this topic see https://groups.google.com/forum/?fromgroups=#!topic/sage-support/do55Fayur6U.\n\nAssignee: @bollu\n\nCC:  @orlitzky @collares\n\nKeywords: matrix, decomposition, cholesky, sparse\n\nReviewer: Dima Pasechnik\n\nAuthor: Siddharth Bhat, Michael Orlitzky\n\nBranch: 954b9ba39b23216f08e4e13190e3762d161e61ec\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13674\n\n",
    "closed_at": "2021-12-12T15:09:05Z",
    "created_at": "2012-10-31T00:11:06Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Cholesky decomposition for sparse matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13674",
    "user": "https://trac.sagemath.org/admin/accounts/users/r.gaia.cs"
}
```
The Cholesky decomposition are implemented in the file [sage/matrix/matrix2.pyx](../tree/master/sage/matrix/matrix2.pyx) for some subfield of the algebraic numbers.

In this implementation the base ring must be exact or, for numerical work, a
matrix with a base ring of ``RDF`` or ``CDF`` must be used.

For the numerical work it's used the Cholesky decomposition implemented in [sage/matrix/matrix_double_dense.pyx](../tree/master/sage/matrix/matrix_double_dense.pyx) and because of this a error raised when try to compute the numerical Cholesky decomposition of a sparse matrix.

```
sage: A = matrix(QQ, [[1, 1], [1, 2]]) 
sage: A.cholesky()                    
[1 0]
[1 1]
sage: A = matrix(QQ, [[1, 1], [1, 2]], sparse=True)
sage: A.cholesky()                                 
[1 0]
[1 1]
sage: A = matrix(RDF, [[1, 1], [1, 2]], sparse=True)  
sage: A = matrix(RDF, [[1, 1], [1, 2]])             
sage: A.cholesky()                                  
[1.0 0.0]
[1.0 1.0]
sage: A = matrix(RDF, [[1, 1], [1, 2]], sparse=True)
sage: A.cholesky()                                  
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/home/raniere/opt/sage/devel/sage-rcm/sage/matrix/<ipython console> in <module>()

/home/raniere/opt/sage/local/lib/python2.7/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.cholesky (sage/matrix/matrix2.c:47738)()
   9867             if not self.base_ring().is_exact():
   9868                 msg = 'base ring of the matrix must be exact, not {0}'
-> 9869                 raise TypeError(msg.format(self.base_ring()))
   9870             try:
   9871                 posdef = self.is_positive_definite()

TypeError: base ring of the matrix must be exact, not Real Double Field
```

For this solve this ticket the numerical sparce Cholesky decompostion need to be implemented.

For more information about this topic see https://groups.google.com/forum/?fromgroups=#!topic/sage-support/do55Fayur6U.

Assignee: @bollu

CC:  @orlitzky @collares

Keywords: matrix, decomposition, cholesky, sparse

Reviewer: Dima Pasechnik

Author: Siddharth Bhat, Michael Orlitzky

Branch: 954b9ba39b23216f08e4e13190e3762d161e61ec

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13674





---

archive/issue_events_044338.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44338"
}
```



---

archive/issue_events_044339.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44339"
}
```



---

archive/issue_events_044340.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44340"
}
```



---

archive/issue_events_044341.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44341"
}
```



---

archive/issue_events_044342.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44342"
}
```



---

archive/issue_events_044343.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44343"
}
```



---

archive/issue_events_044344.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44344"
}
```



---

archive/issue_comments_212024.json:
```json
{
    "body": "Changing assignee from jason, was to @bollu.",
    "created_at": "2021-01-23T22:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212024",
    "user": "https://github.com/bollu"
}
```

Changing assignee from jason, was to @bollu.



---

archive/issue_comments_212025.json:
```json
{
    "body": "<a id='comment:5'></a>\nI have a solution implemented at https://github.com/bollu/sage/tree/u/gh-bollu/jan-24-cholesky-for-sparse-numerical-matrices.",
    "created_at": "2021-01-23T22:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212025",
    "user": "https://github.com/bollu"
}
```

<a id='comment:5'></a>
I have a solution implemented at https://github.com/bollu/sage/tree/u/gh-bollu/jan-24-cholesky-for-sparse-numerical-matrices.



---

archive/issue_comments_212026.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-bollu/jan-24-cholesky-for-sparse-numerical-matrices\"",
    "created_at": "2021-01-23T22:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212026",
    "user": "https://github.com/bollu"
}
```

Changing branch from "" to "u/gh-bollu/jan-24-cholesky-for-sparse-numerical-matrices"



---

archive/issue_comments_212027.json:
```json
{
    "body": "Changing author from \"\" to \"Siddharth Bhat\"",
    "created_at": "2021-01-23T22:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212027",
    "user": "https://github.com/bollu"
}
```

Changing author from "" to "Siddharth Bhat"



---

archive/issue_comments_212028.json:
```json
{
    "body": "Changing commit from \"\" to \"4351684e89139ada783572c9929aa8a54d1890c0\"",
    "created_at": "2021-01-23T22:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212028",
    "user": "https://github.com/bollu"
}
```

Changing commit from "" to "4351684e89139ada783572c9929aa8a54d1890c0"



---

archive/issue_comments_212029.json:
```json
{
    "body": "<a id='comment:6'></a>\nNew commits:\n|                                                                                                                                          |                                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|\n|[4351684](https://github.com/sagemath/sagetrac-mirror/commit/4351684e89139ada783572c9929aa8a54d1890c0)|`Trac #13674: implement Chokesly factorization for sparse numerical matrices`|",
    "created_at": "2021-01-23T22:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212029",
    "user": "https://github.com/bollu"
}
```

<a id='comment:6'></a>
New commits:
|                                                                                                                                          |                                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|
|[4351684](https://github.com/sagemath/sagetrac-mirror/commit/4351684e89139ada783572c9929aa8a54d1890c0)|`Trac #13674: implement Chokesly factorization for sparse numerical matrices`|



---

archive/issue_comments_212030.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-23T22:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212030",
    "user": "https://github.com/bollu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_212031.json:
```json
{
    "body": "<a id='comment:8'></a>\nThings I don't understand very well:\n- What's the correct solution for dense matrices? while the above code works, there should be a fast way to supply an entire dense matrix to `cvxopt`? The best idea I had was to use `cvxopt.matrix(sagemat.to_numpy())`; perhaps there are faster methods I am unaware of?\n- Similarly, when building the sparse matrix, I coerce the matrix entries into a `float`. What is the correct way to hand the matrix entries off to `cvxopt`?\n- On the google groups thread(https://groups.google.com/g/cvxopt/c/xQ-lR9ESijg/discussion), there was some discussion about also getting a good permutation for cholesky. I'd like to submit this patch next once I figure the API out. Any pointers to this would be appreciated!",
    "created_at": "2021-01-23T22:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212031",
    "user": "https://github.com/bollu"
}
```

<a id='comment:8'></a>
Things I don't understand very well:
- What's the correct solution for dense matrices? while the above code works, there should be a fast way to supply an entire dense matrix to `cvxopt`? The best idea I had was to use `cvxopt.matrix(sagemat.to_numpy())`; perhaps there are faster methods I am unaware of?
- Similarly, when building the sparse matrix, I coerce the matrix entries into a `float`. What is the correct way to hand the matrix entries off to `cvxopt`?
- On the google groups thread(https://groups.google.com/g/cvxopt/c/xQ-lR9ESijg/discussion), there was some discussion about also getting a good permutation for cholesky. I'd like to submit this patch next once I figure the API out. Any pointers to this would be appreciated!



---

archive/issue_comments_212032.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dima Pasechnik\"",
    "created_at": "2021-01-26T07:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212032",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Dima Pasechnik"



---

archive/issue_events_044345.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-26T07:23:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44345"
}
```



---

archive/issue_events_044346.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-26T07:23:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44346"
}
```



---

archive/issue_comments_212033.json:
```json
{
    "body": "<a id='comment:10'></a>\nOhhkay. So, the title of this ticket is a bit misleading. It's not a cholesky for sparse matrices that's missing, but rather a cholesky decomposition for matrices over inexact rings. For example,\n\n```\nsage: A = matrix(RR, [[1, 1], [1, 2]])                                          \nsage: A.cholesky()\n...\nTypeError: base ring of the matrix must be exact, not Real Field with 53 bits of precision\n```\n\nThe use of `RealField(100)` or any similar ring produces the same result. The problem only appears related to sparse matrices because there is a special case implemented for dense matrices over `RDF`, but not sparse matrices over `RDF`. Thus, over `RDF`, the sparse implementation is indeed just \"missing\" (it could use the dense implementation without hurting anything).\n\nBut regardless, the real problem to be solved here is that we need a numerically-stable cholesky factorization that works for most inexact rings. That implementation can then be used (in the meantime) for both the dense and sparse methods, until someone decides to come along and speed it up in the sparse case. I've essentially already done this on #10332, which adds a numerically-stable `block_ldlt()` method for all Hermitian matrices. When your matrix is positive-definite, the block-LDLT factorization can be turned into a cholesky factorization after taking the square root of `D`.\n\nSo my suggestion for this ticket is to use `block_ldlt()` from the other ticket instead of adding a special case that relies on `cvxopt`. By using `block_ldlt()`, you allow the `cholesky()` method to work on fields like `RR` that `cvxopt` doesn't know about. It should also simplify the code a little bit, at the price of some administrative overhead: you'll have to,\n\n1. Rebase your git branch onto u/mjo/ticket/10332\n2. Make this ticket depend on #10332\n3. Update the patch to use `block_ldlt()` instead of calling cvxopt.\n\nI think (3) is pretty self-explanatory after reading the docs for `block_ldlt()`, but if not, I'm happy to help. E.g.\n\n```\nsage: A = matrix(QQ, [[9, 0, 3], [0, 1, 0], [3, 0, 25/4]])                      \nsage: A.is_positive_definite()                                                  \nTrue\nsage: P,L,D = A.block_ldlt()                                                    \nsage: L*D.apply_map(sqrt)                                                       \n[           3            0            0]\n[           0            1            0]\n[           1            0 1/2*sqrt(21)]\nsage: A.cholesky()                                                              \n[                 3                  0                  0]\n[                 0                  1                  0]\n[                 1                  0 2.291287847477920?]\n```\n\nYou might be able to save a few microseconds by using the internal `_block_ldlt()` method instead of the nice public one as well.",
    "created_at": "2021-01-26T16:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212033",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:10'></a>
Ohhkay. So, the title of this ticket is a bit misleading. It's not a cholesky for sparse matrices that's missing, but rather a cholesky decomposition for matrices over inexact rings. For example,

```
sage: A = matrix(RR, [[1, 1], [1, 2]])                                          
sage: A.cholesky()
...
TypeError: base ring of the matrix must be exact, not Real Field with 53 bits of precision
```

The use of `RealField(100)` or any similar ring produces the same result. The problem only appears related to sparse matrices because there is a special case implemented for dense matrices over `RDF`, but not sparse matrices over `RDF`. Thus, over `RDF`, the sparse implementation is indeed just "missing" (it could use the dense implementation without hurting anything).

But regardless, the real problem to be solved here is that we need a numerically-stable cholesky factorization that works for most inexact rings. That implementation can then be used (in the meantime) for both the dense and sparse methods, until someone decides to come along and speed it up in the sparse case. I've essentially already done this on #10332, which adds a numerically-stable `block_ldlt()` method for all Hermitian matrices. When your matrix is positive-definite, the block-LDLT factorization can be turned into a cholesky factorization after taking the square root of `D`.

So my suggestion for this ticket is to use `block_ldlt()` from the other ticket instead of adding a special case that relies on `cvxopt`. By using `block_ldlt()`, you allow the `cholesky()` method to work on fields like `RR` that `cvxopt` doesn't know about. It should also simplify the code a little bit, at the price of some administrative overhead: you'll have to,

1. Rebase your git branch onto u/mjo/ticket/10332
2. Make this ticket depend on #10332
3. Update the patch to use `block_ldlt()` instead of calling cvxopt.

I think (3) is pretty self-explanatory after reading the docs for `block_ldlt()`, but if not, I'm happy to help. E.g.

```
sage: A = matrix(QQ, [[9, 0, 3], [0, 1, 0], [3, 0, 25/4]])                      
sage: A.is_positive_definite()                                                  
True
sage: P,L,D = A.block_ldlt()                                                    
sage: L*D.apply_map(sqrt)                                                       
[           3            0            0]
[           0            1            0]
[           1            0 1/2*sqrt(21)]
sage: A.cholesky()                                                              
[                 3                  0                  0]
[                 0                  1                  0]
[                 1                  0 2.291287847477920?]
```

You might be able to save a few microseconds by using the internal `_block_ldlt()` method instead of the nice public one as well.



---

archive/issue_comments_212034.json:
```json
{
    "body": "<a id='comment:11'></a>\nThanks a lot for the link! My only concern is with that of sparseness; the reason I choose to jump hoops with `cvxopt` is for the performance wins for *large* sparse matrices, that I get from running discrete differential geometry algorithms such as geodesics in heat: https://arxiv.org/abs/1204.6216\n\nI'll be glad to benchmark the code, and see which method is faster; I think the route you propose is performant for dense inexact matrices for sure. I'm unsure about the sparse case. Could you please shed some light on the performance characteristics of the linked implementation?",
    "created_at": "2021-01-26T17:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212034",
    "user": "https://github.com/bollu"
}
```

<a id='comment:11'></a>
Thanks a lot for the link! My only concern is with that of sparseness; the reason I choose to jump hoops with `cvxopt` is for the performance wins for *large* sparse matrices, that I get from running discrete differential geometry algorithms such as geodesics in heat: https://arxiv.org/abs/1204.6216

I'll be glad to benchmark the code, and see which method is faster; I think the route you propose is performant for dense inexact matrices for sure. I'm unsure about the sparse case. Could you please shed some light on the performance characteristics of the linked implementation?



---

archive/issue_comments_212035.json:
```json
{
    "body": "<a id='comment:12'></a>\n`block_ldlt()` will be pretty slow on large sparse matrices since the implementation scans the matrix (without regard for sparsity) looking for pivots. It's main benefit (with respect to `cholmod`) is that it would work for other fields, like sparse matrices over `RR`.\n\nIf you need the performance for sparse matrices over `RDF` then something like `cholmod` is indeed the way to go. I'm surprised we don't have a special matrix subclass for sparse `RDF` matrices already; my first attempt would be to override `cholesky()` there, similar to how `cholesky()` is overridden in `matrix_double_dense.pyx` for dense matrices.",
    "created_at": "2021-01-26T18:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212035",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:12'></a>
`block_ldlt()` will be pretty slow on large sparse matrices since the implementation scans the matrix (without regard for sparsity) looking for pivots. It's main benefit (with respect to `cholmod`) is that it would work for other fields, like sparse matrices over `RR`.

If you need the performance for sparse matrices over `RDF` then something like `cholmod` is indeed the way to go. I'm surprised we don't have a special matrix subclass for sparse `RDF` matrices already; my first attempt would be to override `cholesky()` there, similar to how `cholesky()` is overridden in `matrix_double_dense.pyx` for dense matrices.



---

archive/issue_comments_212036.json:
```json
{
    "body": "<a id='comment:13'></a>\nIndeed, for sparse matrices over RDF the cholmod interface of cvxopt is probably as fast as it can get (precision is of course another question).\n\nIn general, I'd be looking at wrapping up arb's [cholesky](https://arblib.org/arb_mat.html#cholesky-decomposition-and-solving) and LDLs,\nas something more robust than a naive attempt to implement this stuff.",
    "created_at": "2021-01-26T18:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212036",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>
Indeed, for sparse matrices over RDF the cholmod interface of cvxopt is probably as fast as it can get (precision is of course another question).

In general, I'd be looking at wrapping up arb's [cholesky](https://arblib.org/arb_mat.html#cholesky-decomposition-and-solving) and LDLs,
as something more robust than a naive attempt to implement this stuff.



---

archive/issue_comments_212037.json:
```json
{
    "body": "<a id='comment:14'></a>\nNow that I know you want it to be fast (as opposed to \"just not crash\"), here's my revised advice:\n\n1. Add a new subclass for sparse real double matrices in `sage/matrix/matrix_real_double_sparse.pyx`, and override only the `cholesky()` method there, with an implementation that uses `cholmod`.\n2. Add a case to `src/sage/matrix/matrix_space.py` that tells the matrix constructor to use your new subclass when the ring is `RDF` and `sparse=True`. Something like,\n\n```\nif R is sage.rings.real_double.RDF:\n    from . import matrix_real_double_sparse\n    return matrix_real_double_sparse.Matrix_real_double_sparse\n```\n3. I'll handle the other inexact rings whenever #10332 gets merged with a generic slow implementation based on `block_ldlt()`.\n\nThe subclass approach will avoid using `cholmod` where it's inappropriate. If you're not familiar with cython, the syntax isn't that much different than plain python. Here's an example pyx and pxd file that creates a subclass.\n\nsrc/sage/matrix/matrix_real_double_sparse.pxd:\n\n```\nfrom .matrix_generic_sparse cimport Matrix_generic_sparse\n\ncdef class Matrix_real_double_sparse(Matrix_generic_sparse):\n    pass\n```\n\nsrc/sage/matrix/matrix_real_double_sparse.pyx:\n\n```\nfrom .matrix_generic_sparse cimport Matrix_generic_sparse\n\ncdef class Matrix_real_double_sparse(Matrix_generic_sparse):\n    def cholesky(self):\n        print(\"DEBUG: subclass method\")\n        return None\n```",
    "created_at": "2021-01-27T00:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212037",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:14'></a>
Now that I know you want it to be fast (as opposed to "just not crash"), here's my revised advice:

1. Add a new subclass for sparse real double matrices in `sage/matrix/matrix_real_double_sparse.pyx`, and override only the `cholesky()` method there, with an implementation that uses `cholmod`.
2. Add a case to `src/sage/matrix/matrix_space.py` that tells the matrix constructor to use your new subclass when the ring is `RDF` and `sparse=True`. Something like,

```
if R is sage.rings.real_double.RDF:
    from . import matrix_real_double_sparse
    return matrix_real_double_sparse.Matrix_real_double_sparse
```
3. I'll handle the other inexact rings whenever #10332 gets merged with a generic slow implementation based on `block_ldlt()`.

The subclass approach will avoid using `cholmod` where it's inappropriate. If you're not familiar with cython, the syntax isn't that much different than plain python. Here's an example pyx and pxd file that creates a subclass.

src/sage/matrix/matrix_real_double_sparse.pxd:

```
from .matrix_generic_sparse cimport Matrix_generic_sparse

cdef class Matrix_real_double_sparse(Matrix_generic_sparse):
    pass
```

src/sage/matrix/matrix_real_double_sparse.pyx:

```
from .matrix_generic_sparse cimport Matrix_generic_sparse

cdef class Matrix_real_double_sparse(Matrix_generic_sparse):
    def cholesky(self):
        print("DEBUG: subclass method")
        return None
```



---

archive/issue_comments_212038.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [dimpase](#comment%3A13):\n> \n> In general, I'd be looking at wrapping up arb's [cholesky](https://arblib.org/arb_mat.html#cholesky-decomposition-and-solving) and LDLs,\n> as something more robust than a naive attempt to implement this stuff. \n\n\nFor things like cholesky over `RR` this would likely be better than a naive implementation based on `block_ldlt()`, but the big problem I was solving by reimplementing block-LDLT was to gain a factorization that works on indefinite matrices.",
    "created_at": "2021-01-27T00:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212038",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>
Replying to [dimpase](#comment%3A13):
> 
> In general, I'd be looking at wrapping up arb's [cholesky](https://arblib.org/arb_mat.html#cholesky-decomposition-and-solving) and LDLs,
> as something more robust than a naive attempt to implement this stuff. 


For things like cholesky over `RR` this would likely be better than a naive implementation based on `block_ldlt()`, but the big problem I was solving by reimplementing block-LDLT was to gain a factorization that works on indefinite matrices.



---

archive/issue_comments_212039.json:
```json
{
    "body": "<a id='comment:16'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212039",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_044347.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44347"
}
```



---

archive/issue_events_044348.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-15T22:07:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44348"
}
```



---

archive/issue_comments_212040.json:
```json
{
    "body": "<a id='comment:17'></a>\nTicket #31619 allows `cholesky()` and `is_positive_definite()` to work over inexact rings as promised, but it will be slower than necessary for sparse RDF matrices. A matrix subclass that delegates to `cholmod()` in that case is the last missing piece.",
    "created_at": "2021-04-29T12:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212040",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:17'></a>
Ticket #31619 allows `cholesky()` and `is_positive_definite()` to work over inexact rings as promised, but it will be slower than necessary for sparse RDF matrices. A matrix subclass that delegates to `cholmod()` in that case is the last missing piece.



---

archive/issue_events_044349.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44349"
}
```



---

archive/issue_events_044350.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44350"
}
```



---

archive/issue_comments_212041.json:
```json
{
    "body": "<a id='comment:18'></a>\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212041",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_212042.json:
```json
{
    "body": "<a id='comment:19'></a>\ncvxopt is now a pseudo-optional package, but we should still be able to use the approach in[comment:14](#comment%3A14). We can `super()` if cvxopt isn't available.",
    "created_at": "2021-11-20T21:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212042",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:19'></a>
cvxopt is now a pseudo-optional package, but we should still be able to use the approach in[comment:14](#comment%3A14). We can `super()` if cvxopt isn't available.



---

archive/issue_comments_212043.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-20T21:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212043",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_212044.json:
```json
{
    "body": "Changing author from \"Siddharth Bhat\" to \"Siddharth Bhat, Michael Orlitzky\"",
    "created_at": "2021-11-23T00:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212044",
    "user": "https://github.com/orlitzky"
}
```

Changing author from "Siddharth Bhat" to "Siddharth Bhat, Michael Orlitzky"



---

archive/issue_comments_212045.json:
```json
{
    "body": "Changing commit from \"4351684e89139ada783572c9929aa8a54d1890c0\" to \"954b9ba39b23216f08e4e13190e3762d161e61ec\"",
    "created_at": "2021-11-23T00:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212045",
    "user": "https://github.com/orlitzky"
}
```

Changing commit from "4351684e89139ada783572c9929aa8a54d1890c0" to "954b9ba39b23216f08e4e13190e3762d161e61ec"



---

archive/issue_comments_212046.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-23T00:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212046",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_212047.json:
```json
{
    "body": "<a id='comment:20'></a>\nThis should work for both `RDF` and `CDF`, but it would be nice to have some more serious examples for test cases. The cvxopt interface is a little sketchy so I'd like to be *sure* that we're using it \"correctly,\" insofar as is possible for an undocumented interface.",
    "created_at": "2021-11-23T00:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212047",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:20'></a>
This should work for both `RDF` and `CDF`, but it would be nice to have some more serious examples for test cases. The cvxopt interface is a little sketchy so I'd like to be *sure* that we're using it "correctly," insofar as is possible for an undocumented interface.



---

archive/issue_comments_212048.json:
```json
{
    "body": "Changing branch from \"u/gh-bollu/jan-24-cholesky-for-sparse-numerical-matrices\" to \"u/mjo/ticket/13674\"",
    "created_at": "2021-11-23T00:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212048",
    "user": "https://github.com/orlitzky"
}
```

Changing branch from "u/gh-bollu/jan-24-cholesky-for-sparse-numerical-matrices" to "u/mjo/ticket/13674"



---

archive/issue_comments_212049.json:
```json
{
    "body": "<a id='comment:21'></a>\nlgtm",
    "created_at": "2021-11-27T21:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212049",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>
lgtm



---

archive/issue_comments_212050.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-27T21:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212050",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_212051.json:
```json
{
    "body": "Changing branch from \"u/mjo/ticket/13674\" to \"954b9ba39b23216f08e4e13190e3762d161e61ec\"",
    "created_at": "2021-12-12T15:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212051",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mjo/ticket/13674" to "954b9ba39b23216f08e4e13190e3762d161e61ec"



---

archive/issue_events_044351.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13674#event-44351"
}
```



---

archive/issue_comments_212052.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-12T15:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212052",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_212053.json:
```json
{
    "body": "<a id='comment:23'></a>\nI am seeing failures such as the one below on aarch64:\n\n```\nsage -t --long --random-seed=138452687149883420730489596915102319785 /nix/store/1jyscb1slmz6134mlsfs9gfjs4kv8w8i-sage-src-9.5.beta8/src/sage/matrix/matrix_double_sparse.pyx\n**********************************************************************\nFile \"/nix/store/1jyscb1slmz6134mlsfs9gfjs4kv8w8i-sage-src-9.5.beta8/src/sage/matrix/matrix_double_sparse.pyx\", line 95, in sage.matrix.matrix_double_sparse.Matrix_double_sparse.cholesky\nFailed example:\n    L = A.cholesky()\nException raised:\n    Traceback (most recent call last):\n      File \"/nix/store/vwd2z6p52kzhidwwvwavgw9jxp1165qh-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/vwd2z6p52kzhidwwvwavgw9jxp1165qh-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1096, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.matrix.matrix_double_sparse.Matrix_double_sparse.cholesky[20]>\", line 1, in <module>\n        L = A.cholesky()\n      File \"sage/matrix/matrix_double_sparse.pyx\", line 110, in sage.matrix.matrix_double_sparse.Matrix_double_sparse.cholesky (build/cythonized/sage/matrix/matrix_double_sparse.c:2820)\n        raise ValueError(\"matrix is not Hermitian\")\n    ValueError: matrix is not Hermitian\n```",
    "created_at": "2021-12-14T22:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212053",
    "user": "https://github.com/collares"
}
```

<a id='comment:23'></a>
I am seeing failures such as the one below on aarch64:

```
sage -t --long --random-seed=138452687149883420730489596915102319785 /nix/store/1jyscb1slmz6134mlsfs9gfjs4kv8w8i-sage-src-9.5.beta8/src/sage/matrix/matrix_double_sparse.pyx
**********************************************************************
File "/nix/store/1jyscb1slmz6134mlsfs9gfjs4kv8w8i-sage-src-9.5.beta8/src/sage/matrix/matrix_double_sparse.pyx", line 95, in sage.matrix.matrix_double_sparse.Matrix_double_sparse.cholesky
Failed example:
    L = A.cholesky()
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/vwd2z6p52kzhidwwvwavgw9jxp1165qh-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/vwd2z6p52kzhidwwvwavgw9jxp1165qh-python3-3.9.6-env/lib/python3.9/site-packages/sage/doctest/forker.py", line 1096, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix_double_sparse.Matrix_double_sparse.cholesky[20]>", line 1, in <module>
        L = A.cholesky()
      File "sage/matrix/matrix_double_sparse.pyx", line 110, in sage.matrix.matrix_double_sparse.Matrix_double_sparse.cholesky (build/cythonized/sage/matrix/matrix_double_sparse.c:2820)
        raise ValueError("matrix is not Hermitian")
    ValueError: matrix is not Hermitian
```



---

archive/issue_comments_212054.json:
```json
{
    "body": "Changing commit from \"954b9ba39b23216f08e4e13190e3762d161e61ec\" to \"\"",
    "created_at": "2021-12-14T22:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212054",
    "user": "https://github.com/collares"
}
```

Changing commit from "954b9ba39b23216f08e4e13190e3762d161e61ec" to ""



---

archive/issue_comments_212055.json:
```json
{
    "body": "<a id='comment:24'></a>\n`@`gh-collares - please open a new ticket for this.",
    "created_at": "2021-12-14T22:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212055",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
`@`gh-collares - please open a new ticket for this.



---

archive/issue_comments_212056.json:
```json
{
    "body": "<a id='comment:25'></a>\nOpened #33023 for the test failure, thanks for letting me know about the correct procedure. I didn't know the \"Commit\" field would be cleared when I posted my first comment, sorry about that.",
    "created_at": "2021-12-14T23:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212056",
    "user": "https://github.com/collares"
}
```

<a id='comment:25'></a>
Opened #33023 for the test failure, thanks for letting me know about the correct procedure. I didn't know the "Commit" field would be cleared when I posted my first comment, sorry about that.



---

archive/issue_comments_212057.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [gh-collares](#comment%3A25):\n> Opened #33023 for the test failure, thanks for letting me know about the correct procedure. I didn't know the \"Commit\" field would be cleared when I posted my first comment, sorry about that.\n\n\nThanks, the commit field thing is no big deal, that always happens. I'll see if I can reproduce the problem. The matrix is Hermitian by construction (unless I've made some typo I can't see) so it should be interesting.",
    "created_at": "2021-12-14T23:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13674",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13674#issuecomment-212057",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:26'></a>
Replying to [gh-collares](#comment%3A25):
> Opened #33023 for the test failure, thanks for letting me know about the correct procedure. I didn't know the "Commit" field would be cleared when I posted my first comment, sorry about that.


Thanks, the commit field thing is no big deal, that always happens. I'll see if I can reproduce the problem. The matrix is Hermitian by construction (unless I've made some typo I can't see) so it should be interesting.
