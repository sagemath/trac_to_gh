# Issue 13646: Bug in p.add_constraint (when input is True/False)

archive/issues_013442.json:
```json
{
    "body": "That awful thing again. See bug report at :\nhttps://groups.google.com/d/topic/sage-support/VVTWhE0w7i0/discussion\n\nThe problem is that the linear functions need to integrate with the rest of sage to play nice. The patched mip.pyx adds a parent class for linear functions and suitable coercion and rich comparison. Now the following works as expected:\n\n```\nsage: p = MixedIntegerLinearProgram()\nsage: x = p.new_variable()\nsage: x[1] >= 10\n10 <= x_0\nsage: 10 <= x[1]\n10 <= x_0\n```\n\nApply [attachment:trac_13646_fix_mip.patch]\n\nAssignee: @nathanncohen\n\nCC:  @vbraun @ypfmde @dimpase @ptrrsn\n\nReviewer: Dmitrii Pasechnik\n\nAuthor: Nathann Cohen, Volker Braun\n\nMerged: sage-5.5.beta1\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13646\n\n",
    "closed_at": "2012-11-01T12:03:53Z",
    "created_at": "2012-10-23T09:45:09Z",
    "labels": [
        "component: linear programming",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.5",
    "title": "Bug in p.add_constraint (when input is True/False)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13646",
    "user": "https://github.com/nathanncohen"
}
```
That awful thing again. See bug report at :
https://groups.google.com/d/topic/sage-support/VVTWhE0w7i0/discussion

The problem is that the linear functions need to integrate with the rest of sage to play nice. The patched mip.pyx adds a parent class for linear functions and suitable coercion and rich comparison. Now the following works as expected:

```
sage: p = MixedIntegerLinearProgram()
sage: x = p.new_variable()
sage: x[1] >= 10
10 <= x_0
sage: 10 <= x[1]
10 <= x_0
```

Apply [attachment:trac_13646_fix_mip.patch]

Assignee: @nathanncohen

CC:  @vbraun @ypfmde @dimpase @ptrrsn

Reviewer: Dmitrii Pasechnik

Author: Nathann Cohen, Volker Braun

Merged: sage-5.5.beta1

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13646





---

archive/issue_comments_206335.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-23T09:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206335",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_206336.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-10-23T10:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206336",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206337.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-23T10:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206337",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206338.json:
```json
{
    "body": "<a id='comment:3'></a>\nHere it is ! There was some bad side effect with the previous patch `:-)`\n\nNathann",
    "created_at": "2012-10-23T10:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206338",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:3'></a>
Here it is ! There was some bad side effect with the previous patch `:-)`

Nathann



---

archive/issue_comments_206339.json:
```json
{
    "body": "<a id='comment:4'></a>\nRHAAAAAAAAAAAAAAAAA",
    "created_at": "2012-10-23T10:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206339",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:4'></a>
RHAAAAAAAAAAAAAAAAA



---

archive/issue_comments_206340.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-10-23T10:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206340",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_206341.json:
```json
{
    "body": "<a id='comment:5'></a>\nDon't just raise the error on some hand-picked \"wrong\" values. Add an else: branch to the last if-statement in __init__ as a catch-all.",
    "created_at": "2012-10-23T10:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206341",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>
Don't just raise the error on some hand-picked "wrong" values. Add an else: branch to the last if-statement in __init__ as a catch-all.



---

archive/issue_comments_206342.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-23T11:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206342",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_206343.json:
```json
{
    "body": "<a id='comment:6'></a>\nActually the patch works. My version of Sage doesn't pass all tests, but it seems to come from somewhere else..\n\n> Don't just raise the error on some hand-picked \"wrong\" values. Add an else: branch to the last if-statement in __init__ as a catch-all.\n\n\nWell, True and False are what is returned when the left side is an integer, and only then. Plus I have no idea how to solve this bug in any different way `O_o`\n\nI do not get what you mean by your ``Add an else: branch to the last if-statement in __init__ as a catch-all.`` either `O_o`\n\nNathann",
    "created_at": "2012-10-23T11:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206343",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:6'></a>
Actually the patch works. My version of Sage doesn't pass all tests, but it seems to come from somewhere else..

> Don't just raise the error on some hand-picked "wrong" values. Add an else: branch to the last if-statement in __init__ as a catch-all.


Well, True and False are what is returned when the left side is an integer, and only then. Plus I have no idea how to solve this bug in any different way `O_o`

I do not get what you mean by your ``Add an else: branch to the last if-statement in __init__ as a catch-all.`` either `O_o`

Nathann



---

archive/issue_comments_206344.json:
```json
{
    "body": "Changing author from \"Nathann Cohen\" to \"Nathann Cohen, Volker Braun\"",
    "created_at": "2012-10-23T14:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206344",
    "user": "https://github.com/vbraun"
}
```

Changing author from "Nathann Cohen" to "Nathann Cohen, Volker Braun"



---

archive/issue_comments_206345.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n That awful thing again. See bug report at :\n https://groups.google.com/d/topic/sage-support/VVTWhE0w7i0/discussion\n \n-Nathann\n+The problem is that the linear functions need to integrate with the rest of sage to play nice. The patched mip.pyx adds a parent class for linear functions and suitable coercion and rich comparison. Now the following works as expected:\n+\n+```\n+sage: p = MixedIntegerLinearProgram()\n+sage: x = p.new_variable()\n+sage: x[1] >= 10\n+10 <= x_0\n+sage: 10 <= x[1]\n+10 <= x_0\n+```\n``````\n",
    "created_at": "2012-10-23T14:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206345",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
 That awful thing again. See bug report at :
 https://groups.google.com/d/topic/sage-support/VVTWhE0w7i0/discussion
 
-Nathann
+The problem is that the linear functions need to integrate with the rest of sage to play nice. The patched mip.pyx adds a parent class for linear functions and suitable coercion and rich comparison. Now the following works as expected:
+
+```
+sage: p = MixedIntegerLinearProgram()
+sage: x = p.new_variable()
+sage: x[1] >= 10
+10 <= x_0
+sage: 10 <= x[1]
+10 <= x_0
+```
``````




---

archive/issue_comments_206346.json:
```json
{
    "body": "<a id='comment:7'></a>\nI've folded your changes into my patch.\n\nThere are two things to do. 1) the chained inequalities need a parent as well, analogous to linear functions. 2) the base ring of the linear functions needs to match the capabilities of the backend. I've hardcoded the base ring as RDF for now. But somebody needs to add a method to the backends to query their supported base ring so we can plug that into the linear functions parent.\n\nBut I think those can be dealt with separately, and I'll leave them as an exercise for you :-) The biggest usability wart is patched, at least.",
    "created_at": "2012-10-23T14:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206346",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>
I've folded your changes into my patch.

There are two things to do. 1) the chained inequalities need a parent as well, analogous to linear functions. 2) the base ring of the linear functions needs to match the capabilities of the backend. I've hardcoded the base ring as RDF for now. But somebody needs to add a method to the backends to query their supported base ring so we can plug that into the linear functions parent.

But I think those can be dealt with separately, and I'll leave them as an exercise for you :-) The biggest usability wart is patched, at least.



---

archive/issue_comments_206347.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -11,3 +11,5 @@\n sage: 10 <= x[1]\n 10 <= x_0\n ```\n+\n+Apply [attachment:trac_13646_fix_mip.patch]\n``````\n",
    "created_at": "2012-10-23T14:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206347",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -11,3 +11,5 @@
 sage: 10 <= x[1]
 10 <= x_0
 ```
+
+Apply [attachment:trac_13646_fix_mip.patch]
``````




---

archive/issue_comments_206348.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [vbraun](#comment%3A7):\n> I've folded your changes into my patch.\n> \n> There are two things to do. 1) the chained inequalities need a parent as well, analogous to linear functions. 2) the base ring of the linear functions needs to match the capabilities of the backend. I've hardcoded the base ring as RDF for now. But somebody needs to add a method to the backends to query their supported base ring so we can plug that into the linear functions parent.\n> \n> But I think those can be dealt with separately, and I'll leave them as an exercise for you :-) The biggest usability wart is patched, at least.\n> \n\n\nI don't think I understand the logic of the design to be able to do the exercise. Why does the base ring need to be hardcoded to anything? Ideally, I would like to see this coordinated with #12533.",
    "created_at": "2012-10-23T15:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206348",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
Replying to [vbraun](#comment%3A7):
> I've folded your changes into my patch.
> 
> There are two things to do. 1) the chained inequalities need a parent as well, analogous to linear functions. 2) the base ring of the linear functions needs to match the capabilities of the backend. I've hardcoded the base ring as RDF for now. But somebody needs to add a method to the backends to query their supported base ring so we can plug that into the linear functions parent.
> 
> But I think those can be dealt with separately, and I'll leave them as an exercise for you :-) The biggest usability wart is patched, at least.
> 


I don't think I understand the logic of the design to be able to do the exercise. Why does the base ring need to be hardcoded to anything? Ideally, I would like to see this coordinated with #12533.



---

archive/issue_comments_206349.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2012-10-23T15:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206349",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_206350.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-10-23T15:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206350",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_206351.json:
```json
{
    "body": "<a id='comment:10'></a>\nThe base ring should not be hardcoded. But you can't hook into Sage's coercion system if you don't have an idea of what your base ring is. So until somebody fixes the backends to report whatever the base ring is, it'll be RDF.",
    "created_at": "2012-10-23T15:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206351",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
The base ring should not be hardcoded. But you can't hook into Sage's coercion system if you don't have an idea of what your base ring is. So until somebody fixes the backends to report whatever the base ring is, it'll be RDF.



---

archive/issue_comments_206352.json:
```json
{
    "body": "<a id='comment:11'></a>\nNot to mention that having RDF as a BaseRing would mean that a call to p.show() (that currently displays the LP's constraints) would result in ugly 1.0000000 everywhere instead of 1. No way -- I prefer having neat 1.0 than being able to write 5 <=variable.\n\nQQ would be much better... Because of #12533 of course, and it would also be less destructive to everything else.\n\nBy the way, why did you replace Sum by p.sum ? I won't begin to say that it is not a backward compatible change -- I'm usually the least to worry about this. But given that it would completely break something like years of code I have, I would at least like to know why `:-P`\n\nNathann",
    "created_at": "2012-10-23T16:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206352",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:11'></a>
Not to mention that having RDF as a BaseRing would mean that a call to p.show() (that currently displays the LP's constraints) would result in ugly 1.0000000 everywhere instead of 1. No way -- I prefer having neat 1.0 than being able to write 5 <=variable.

QQ would be much better... Because of #12533 of course, and it would also be less destructive to everything else.

By the way, why did you replace Sum by p.sum ? I won't begin to say that it is not a backward compatible change -- I'm usually the least to worry about this. But given that it would completely break something like years of code I have, I would at least like to know why `:-P`

Nathann



---

archive/issue_comments_206353.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2012-10-23T16:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206353",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_206354.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#12533\"",
    "created_at": "2012-10-23T16:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206354",
    "user": "https://github.com/nathanncohen"
}
```

Changing dependencies from "" to "#12533"



---

archive/issue_comments_206355.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-10-23T16:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206355",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_206356.json:
```json
{
    "body": "<a id='comment:14'></a>\nThe output is fine, it prints 1.0 in `p.show()`. Did you actually try it?\n\nAlso, right now the coefficients aren't converted into the base ring unless the coercion framework requires it. This is something that should be fixed as well, so coefficients always live in the respective base ring. But thats another thing for later when the backends report their base ring.\n\nWith a stand-alone `Sum` function you can't do the empty sum - what would be its parent?",
    "created_at": "2012-10-23T16:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206356",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>
The output is fine, it prints 1.0 in `p.show()`. Did you actually try it?

Also, right now the coefficients aren't converted into the base ring unless the coercion framework requires it. This is something that should be fixed as well, so coefficients always live in the respective base ring. But thats another thing for later when the backends report their base ring.

With a stand-alone `Sum` function you can't do the empty sum - what would be its parent?



---

archive/issue_comments_206357.json:
```json
{
    "body": "<a id='comment:15'></a>\n> The output is fine, it prints 1.0 in `p.show()`. Did you actually try it?\n\n\nI did not. I thought that it was one of the things you were leaving for later, while you indeed say the opposite in your message. Hadn't noticed that part.\n\n> Also, right now the coefficients aren't converted into the base ring unless the coercion framework requires it. This is something that should be fixed as well, so coefficients always live in the respective base ring. But thats another thing for later when the backends report their base ring.\n> \n> With a stand-alone `Sum` function you can't do the empty sum - what would be its parent?\n\n\nIt used to return None, and I lived fine with it.\n\nCould you please answer my question about sum to p.sum ?\n\nNathann",
    "created_at": "2012-10-23T16:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206357",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:15'></a>
> The output is fine, it prints 1.0 in `p.show()`. Did you actually try it?


I did not. I thought that it was one of the things you were leaving for later, while you indeed say the opposite in your message. Hadn't noticed that part.

> Also, right now the coefficients aren't converted into the base ring unless the coercion framework requires it. This is something that should be fixed as well, so coefficients always live in the respective base ring. But thats another thing for later when the backends report their base ring.
> 
> With a stand-alone `Sum` function you can't do the empty sum - what would be its parent?


It used to return None, and I lived fine with it.

Could you please answer my question about sum to p.sum ?

Nathann



---

archive/issue_comments_206358.json:
```json
{
    "body": "<a id='comment:16'></a>\nReturning `None` as the value of a sum is not cool, stuff will almost certainly break if you return nothing and not the neutral element in the module. `None` is also the value of undefined variables (e.g. typos), this is rather dangerous. This is why I switched sum to a method, so that it can return the correct neutral element. As a side effect it saves you from manually importing `Sum` and it makes it discoverable by tab completion.\n\nI'll put in a deprecation for `Sum`.",
    "created_at": "2012-10-23T16:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206358",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>
Returning `None` as the value of a sum is not cool, stuff will almost certainly break if you return nothing and not the neutral element in the module. `None` is also the value of undefined variables (e.g. typos), this is rather dangerous. This is why I switched sum to a method, so that it can return the correct neutral element. As a side effect it saves you from manually importing `Sum` and it makes it discoverable by tab completion.

I'll put in a deprecation for `Sum`.



---

archive/issue_comments_206359.json:
```json
{
    "body": "<a id='comment:17'></a>\nI've also removed the deep copy, now naive addition is only about 2x slower than using sum:\n\n```\nsage: P = MixedIntegerLinearProgram()\nsage: x = P.new_variable(binary=True)\n\nsage: %prun for i in [0..290]: c = sum(x[j]*(j-i) for j in [0..290])\n         99278 function calls in 1.681 seconds\n\nsage: %prun for i in [0..290]: c = P.sum(x[j]*(j-i) for j in [0..290])\n         98405 function calls in 0.928 seconds\n```",
    "created_at": "2012-10-23T17:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206359",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>
I've also removed the deep copy, now naive addition is only about 2x slower than using sum:

```
sage: P = MixedIntegerLinearProgram()
sage: x = P.new_variable(binary=True)

sage: %prun for i in [0..290]: c = sum(x[j]*(j-i) for j in [0..290])
         99278 function calls in 1.681 seconds

sage: %prun for i in [0..290]: c = P.sum(x[j]*(j-i) for j in [0..290])
         98405 function calls in 0.928 seconds
```



---

archive/issue_comments_206360.json:
```json
{
    "body": "Changing dependencies from \"#12533\" to \"\"",
    "created_at": "2012-10-24T09:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206360",
    "user": "https://github.com/vbraun"
}
```

Changing dependencies from "#12533" to ""



---

archive/issue_comments_206361.json:
```json
{
    "body": "<a id='comment:19'></a>\nVolker,\n\nBefore anything, please consider that your patches *DO* break a lot of code I (and some others probably that I do not know) have been using for a while, and that I have a very hard time keeping from shouting by myself in my office when I see you do that without caring about those consequences in any way.\n\nNow that this is said, your patch has good aspects too. So let's talk about it, without forgetting this important detail.\n\n> Returning `None` as the value of a sum is not cool,\n\n\nYeah.... Let's not make a mess of a code just because of that.\n\n> stuff will almost certainly break if you return nothing and not the neutral element in the module.\n\n\nWell, please consider that it just *does not*. All the code that you touch has been running for a while now, it wasn't even a module, and there was nothing wrong with it, except this ``4 <= variable`` thing. So NO, having it return None sometimes is not a problem by itself. I don't have to explain why as you just have to accept that it does not. And I swear this code has been used.\n\n> `None` is also the value of undefined variables (e.g. typos), this is rather dangerous.\n\n\nIn this case True/False are the value of undefined linear expressions. No problem with None. You shouldn't say such things without knowing how this code is used.\n\n> This is why I switched sum to a method, \n\n\nYeah, and it destroys years of source code I have. As I said, I don't mind much if the changes are good, but it would be very impolite of you to not inquire about it before sending that patch.\n\n> so that it can return the correct neutral element. As a side effect it saves you from manually importing `Sum` and it makes it discoverable by tab completion.\n> \n> I'll put in a deprecation for `Sum`.\n\n\nDo we agree if we say that this change with Sum has *NOTHING TO DO* with the change of base ring ? As you hardcode the basering once, you could hardcode it twice (once in MILP, another in Sum), and anyway because we are dealing with RDF and nothing more complicated this Sum may all the same return int(0) when it is empty for all we care ?\nIt could even return MixedIntegerLinearProgram.base_ring()[1] for all we care ?\n\nIf these changes are disjoint, please say so. I would be glad to have this patch only fix the bug reported, and create another ticket for the change from Sum to p.sum. This latter part is more problematic, I mentionned many times that it destroyed years of code, but it seems to be a nice change anyway so why not, after all ?\nBut it would be nice to do this in a different ticket. If only to be able to actually see what this patch does with respect to the bug reported `:-P`\n\nThank you for your help in solving this thing though. I had no idea how to do that `:-)`\n\nNathann",
    "created_at": "2012-10-24T12:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206361",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:19'></a>
Volker,

Before anything, please consider that your patches *DO* break a lot of code I (and some others probably that I do not know) have been using for a while, and that I have a very hard time keeping from shouting by myself in my office when I see you do that without caring about those consequences in any way.

Now that this is said, your patch has good aspects too. So let's talk about it, without forgetting this important detail.

> Returning `None` as the value of a sum is not cool,


Yeah.... Let's not make a mess of a code just because of that.

> stuff will almost certainly break if you return nothing and not the neutral element in the module.


Well, please consider that it just *does not*. All the code that you touch has been running for a while now, it wasn't even a module, and there was nothing wrong with it, except this ``4 <= variable`` thing. So NO, having it return None sometimes is not a problem by itself. I don't have to explain why as you just have to accept that it does not. And I swear this code has been used.

> `None` is also the value of undefined variables (e.g. typos), this is rather dangerous.


In this case True/False are the value of undefined linear expressions. No problem with None. You shouldn't say such things without knowing how this code is used.

> This is why I switched sum to a method, 


Yeah, and it destroys years of source code I have. As I said, I don't mind much if the changes are good, but it would be very impolite of you to not inquire about it before sending that patch.

> so that it can return the correct neutral element. As a side effect it saves you from manually importing `Sum` and it makes it discoverable by tab completion.
> 
> I'll put in a deprecation for `Sum`.


Do we agree if we say that this change with Sum has *NOTHING TO DO* with the change of base ring ? As you hardcode the basering once, you could hardcode it twice (once in MILP, another in Sum), and anyway because we are dealing with RDF and nothing more complicated this Sum may all the same return int(0) when it is empty for all we care ?
It could even return MixedIntegerLinearProgram.base_ring()[1] for all we care ?

If these changes are disjoint, please say so. I would be glad to have this patch only fix the bug reported, and create another ticket for the change from Sum to p.sum. This latter part is more problematic, I mentionned many times that it destroyed years of code, but it seems to be a nice change anyway so why not, after all ?
But it would be nice to do this in a different ticket. If only to be able to actually see what this patch does with respect to the bug reported `:-P`

Thank you for your help in solving this thing though. I had no idea how to do that `:-)`

Nathann



---

archive/issue_comments_206362.json:
```json
{
    "body": "<a id='comment:20'></a>\nI found a lot of places in the graphs stuff where `Sum(...) + Sum(...)` occurs. As soon as one of the sums returns ``None`` this will raise a `TypeError`. And the problem is precisely that it can't return `MixedIntegerLinearProgram.base_ring()` because that requires an instance of `MixedIntegerLinearProgram`. Right now the Sum is just deprecated, so you have at least a year to replace `Sum()` -> `p.sum()`. Which is a pretty simple search&replace. No code will break with this patch, you only get a deprecation warning the first time that you use `Sum`.\n\nWe will remove the hardcoded RDF in #13650, so its just a matter of time until its gone. Its not an option to hardcode RDF in Sum in the long run.",
    "created_at": "2012-10-24T12:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206362",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>
I found a lot of places in the graphs stuff where `Sum(...) + Sum(...)` occurs. As soon as one of the sums returns ``None`` this will raise a `TypeError`. And the problem is precisely that it can't return `MixedIntegerLinearProgram.base_ring()` because that requires an instance of `MixedIntegerLinearProgram`. Right now the Sum is just deprecated, so you have at least a year to replace `Sum()` -> `p.sum()`. Which is a pretty simple search&replace. No code will break with this patch, you only get a deprecation warning the first time that you use `Sum`.

We will remove the hardcoded RDF in #13650, so its just a matter of time until its gone. Its not an option to hardcode RDF in Sum in the long run.



---

archive/issue_comments_206363.json:
```json
{
    "body": "<a id='comment:21'></a>\n> I found a lot of places in the graphs stuff where `Sum(...) + Sum(...)` occurs. As soon as one of the sums returns ``None`` this will raise a `TypeError`. \n\n\nAnd if it never did, it may be because there is mathematical reason for that, or did you make sure of the opposite ?\n\n> And the problem is precisely that it can't return `MixedIntegerLinearProgram.base_ring()` because that requires an instance of `MixedIntegerLinearProgram`. \n\n\nHow come you ignored my question about returning int(0) ?\n\n> Right now the Sum is just deprecated, so you have at least a year to replace `Sum()` -> `p.sum()`. Which is a pretty simple search&replace. No code will break with this patch, you only get a deprecation warning the first time that you use `Sum`.\n\n\nNice.\n\n> We will remove the hardcoded RDF in #13650, so its just a matter of time until its gone. Its not an option to hardcode RDF in Sum in the long run.\n\n\nIt has been an option to not have a base ring at all for a very long while now.\n\nNathann",
    "created_at": "2012-10-24T12:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206363",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:21'></a>
> I found a lot of places in the graphs stuff where `Sum(...) + Sum(...)` occurs. As soon as one of the sums returns ``None`` this will raise a `TypeError`. 


And if it never did, it may be because there is mathematical reason for that, or did you make sure of the opposite ?

> And the problem is precisely that it can't return `MixedIntegerLinearProgram.base_ring()` because that requires an instance of `MixedIntegerLinearProgram`. 


How come you ignored my question about returning int(0) ?

> Right now the Sum is just deprecated, so you have at least a year to replace `Sum()` -> `p.sum()`. Which is a pretty simple search&replace. No code will break with this patch, you only get a deprecation warning the first time that you use `Sum`.


Nice.

> We will remove the hardcoded RDF in #13650, so its just a matter of time until its gone. Its not an option to hardcode RDF in Sum in the long run.


It has been an option to not have a base ring at all for a very long while now.

Nathann



---

archive/issue_comments_206364.json:
```json
{
    "body": "<a id='comment:22'></a>\nHaving `Sum()` return `int(0)` is also tricky, think about\n\n```\np.add_constraint( Sum(...) <= 123 )\n```\nNow this breaks because int(0) <= 123 evaluates to ``True``. Since neither the left nor the right hand side is of type `LinearFunction`, there is no type information to construct a `LinearConstraint`.\n\nIt wasn't really ever an option to not play nice with the coercion system, you just let users again and again fall into the same trap ;-) But since now there is a QQ in addition to RDF backends its even more pressing to fix this up, I think.",
    "created_at": "2012-10-24T13:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206364",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>
Having `Sum()` return `int(0)` is also tricky, think about

```
p.add_constraint( Sum(...) <= 123 )
```
Now this breaks because int(0) <= 123 evaluates to ``True``. Since neither the left nor the right hand side is of type `LinearFunction`, there is no type information to construct a `LinearConstraint`.

It wasn't really ever an option to not play nice with the coercion system, you just let users again and again fall into the same trap ;-) But since now there is a QQ in addition to RDF backends its even more pressing to fix this up, I think.



---

archive/issue_comments_206365.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [ncohen](#comment%3A21):\n> > I found a lot of places in the graphs stuff where `Sum(...) + Sum(...)` occurs. As soon as one of the sums returns ``None`` this will raise a `TypeError`. \n\n> \n> And if it never did, it may be because there is mathematical reason for that, or did you make sure of the opposite ?\n\n\nOne surely can code in a very dangerous style, but this does not mean that it should be forced upon the many Sage users.\nE.g. #12091 (largely a duplicate of the current ticket) is a very good example (actually, #12091 seems to be fixed by the Volker's patch---at least the 1st example in the ticket description is fixed!) of pitfalls the current LP code is creating.\n\nFor one, I would kill for Sum() returning what it should, and not None.\n\nIt's sad it might break some private code, but it's a fact of life. Sage cannot always maintain the backward compatibility, after all. E.g. a move to Python 3 will break stuff for a lot of people. Please show us a typical fragment broken by Volker's patch, and we will see the best workaround. (Well, it could be that all it needs is a private definition of Sum(), can't tell without looking.)\n \n> > We will remove the hardcoded RDF in #13650, so its just a matter of time until its gone. Its not an option to hardcode RDF in Sum in the long run.\n\n> \n> It has been an option to not have a base ring at all for a very long while now.\n\n\nSure, but it was a bad design decision not to have one.",
    "created_at": "2012-10-24T13:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206365",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
Replying to [ncohen](#comment%3A21):
> > I found a lot of places in the graphs stuff where `Sum(...) + Sum(...)` occurs. As soon as one of the sums returns ``None`` this will raise a `TypeError`. 

> 
> And if it never did, it may be because there is mathematical reason for that, or did you make sure of the opposite ?


One surely can code in a very dangerous style, but this does not mean that it should be forced upon the many Sage users.
E.g. #12091 (largely a duplicate of the current ticket) is a very good example (actually, #12091 seems to be fixed by the Volker's patch---at least the 1st example in the ticket description is fixed!) of pitfalls the current LP code is creating.

For one, I would kill for Sum() returning what it should, and not None.

It's sad it might break some private code, but it's a fact of life. Sage cannot always maintain the backward compatibility, after all. E.g. a move to Python 3 will break stuff for a lot of people. Please show us a typical fragment broken by Volker's patch, and we will see the best workaround. (Well, it could be that all it needs is a private definition of Sum(), can't tell without looking.)
 
> > We will remove the hardcoded RDF in #13650, so its just a matter of time until its gone. Its not an option to hardcode RDF in Sum in the long run.

> 
> It has been an option to not have a base ring at all for a very long while now.


Sure, but it was a bad design decision not to have one.



---

archive/issue_comments_206366.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-24T23:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206366",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_206367.json:
```json
{
    "body": "<a id='comment:24'></a>\nwith #13650, looks set to go. Tested with various (optional) backends, too.",
    "created_at": "2012-10-24T23:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206367",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
with #13650, looks set to go. Tested with various (optional) backends, too.



---

archive/issue_comments_206368.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dima Pasechnik\"",
    "created_at": "2012-10-24T23:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206368",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Dima Pasechnik"



---

archive/issue_comments_206369.json:
```json
{
    "body": "<a id='comment:26'></a>\nbefore I forgot: with Gurobi version 5.0, its LP output format has changed a bit. It numbers the constraints now:\n\n```\n    Constraints:\n      R0: x_0 + x_1 <= 10.0\n      R2: x_0 <= 4.0\n```\nrather than\n\n```\n    Constraints:\n      x_0 + x_1 <= 10.0\n      x_0 <= 4.0\n```\n\nNathann, do we want a doctest patch for this? (Well, I imagine that on older systems, or for license-related reasons, people still use version 4).",
    "created_at": "2012-10-25T00:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206369",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
before I forgot: with Gurobi version 5.0, its LP output format has changed a bit. It numbers the constraints now:

```
    Constraints:
      R0: x_0 + x_1 <= 10.0
      R2: x_0 <= 4.0
```
rather than

```
    Constraints:
      x_0 + x_1 <= 10.0
      x_0 <= 4.0
```

Nathann, do we want a doctest patch for this? (Well, I imagine that on older systems, or for license-related reasons, people still use version 4).



---

archive/issue_comments_206370.json:
```json
{
    "body": "<a id='comment:27'></a>\nHonestly, I would have liked to review that patch, but today I turn my computer on and I see it reviewed. There's nothing I can do about that. Concerning doctests : I do not remember that Gurobi \"changed\" at some point with respect to labels, but maybe you are right. There may be a way in Gurobi to check which version is used, but to me it is much more trouble than is necessary. Well, that's up to you ! It is also extremely difficult to play with differents versions of Gurobi at the same time to test those things.\n\nHave fun with the code, I'll be out of it for the next days... My days are stolen by people around me this time, and I need to do what I have to during the short time that I have left.\n\nNathann",
    "created_at": "2012-10-25T08:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206370",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:27'></a>
Honestly, I would have liked to review that patch, but today I turn my computer on and I see it reviewed. There's nothing I can do about that. Concerning doctests : I do not remember that Gurobi "changed" at some point with respect to labels, but maybe you are right. There may be a way in Gurobi to check which version is used, but to me it is much more trouble than is necessary. Well, that's up to you ! It is also extremely difficult to play with differents versions of Gurobi at the same time to test those things.

Have fun with the code, I'll be out of it for the next days... My days are stolen by people around me this time, and I need to do what I have to during the short time that I have left.

Nathann



---

archive/issue_comments_206371.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [ncohen](#comment%3A27):\n> Honestly, I would have liked to review that patch, but today I turn my computer on and I see it reviewed. \n\n\n?\u05d0\u05dd \u05d0\u05d9\u05df \u05d0\u05e0\u05d9 \u05dc\u05d9, \u05de\u05d9 \u05dc\u05d9? \u05d5\u05db\u05e9\u05d0\u05e0\u05d9 \u05dc\u05e2\u05e6\u05de\u05d9, \u05de\u05d4 \u05d0\u05e0\u05d9? \u05d5\u05d0\u05dd \u05dc\u05d0 \u05e2\u05db\u05e9\u05d9\u05d5, \u05d0\u05d9\u05de\u05ea\u05d9 ;-)",
    "created_at": "2012-10-26T17:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206371",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>
Replying to [ncohen](#comment%3A27):
> Honestly, I would have liked to review that patch, but today I turn my computer on and I see it reviewed. 


?אם אין אני לי, מי לי? וכשאני לעצמי, מה אני? ואם לא עכשיו, אימתי ;-)



---

archive/issue_comments_206372.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-10-30T08:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206372",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_206373.json:
```json
{
    "body": "<a id='comment:29'></a>\nThe patch needs a proper commit message.",
    "created_at": "2012-10-30T08:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206373",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
The patch needs a proper commit message.



---

archive/issue_comments_206374.json:
```json
{
    "body": "Attachment [trac_13646_fix_mip.patch](tarball://root/attachments/some-uuid/ticket13646/trac_13646_fix_mip.patch) by @vbraun created at 2012-10-30 10:09:58\n\nUpdated patch",
    "created_at": "2012-10-30T10:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206374",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_13646_fix_mip.patch](tarball://root/attachments/some-uuid/ticket13646/trac_13646_fix_mip.patch) by @vbraun created at 2012-10-30 10:09:58

Updated patch



---

archive/issue_comments_206375.json:
```json
{
    "body": "<a id='comment:30'></a>\nOops, fixed. I was going to suggest that the patchbot should check this but it does already ;-)",
    "created_at": "2012-10-30T10:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206375",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:30'></a>
Oops, fixed. I was going to suggest that the patchbot should check this but it does already ;-)



---

archive/issue_comments_206376.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-10-30T10:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206376",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_206377.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [vbraun](#comment%3A30):\n> Oops, fixed. I was going to suggest that the patchbot should check this but it does already ;-)\n\nYeah, AI in action! Bots are taking over Sage development!",
    "created_at": "2012-10-30T10:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206377",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>
Replying to [vbraun](#comment%3A30):
> Oops, fixed. I was going to suggest that the patchbot should check this but it does already ;-)

Yeah, AI in action! Bots are taking over Sage development!



---

archive/issue_comments_206378.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.5.beta1\"",
    "created_at": "2012-11-01T12:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206378",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.5.beta1"



---

archive/issue_events_038088.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-01T12:03:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13646#event-38088"
}
```



---

archive/issue_comments_206379.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-01T12:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206379",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_206380.json:
```json
{
    "body": "Changing reviewer from \"Dima Pasechnik\" to \"Dmitrii Pasechnik\"",
    "created_at": "2012-12-16T16:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13646#issuecomment-206380",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "Dima Pasechnik" to "Dmitrii Pasechnik"
