# Issue 13875: Test memory allocation in distances_all_pairs

archive/issues_013671.json:
```json
{
    "body": "This patch adds tests on memory allocation in the distances_all_pairs module. This is to prevent returning NULL pointers when the memory space is insufficient to allocate data structure.\n\nThese tests are not doctested since the behavior depends on the computer (ram).\n\n**Assignee:** @jasongrout, @nathanncohen, @rlmill\n\n**CC:**  @nathanncohen\n\n**Reviewer:** Nathann Cohen\n\n**Author:** David Coudert\n\n**Merged:** sage-5.6.rc0\n\n**Dependencies:** #13808\n\nIssue created by migration from https://trac.sagemath.org/ticket/13875\n\n",
    "closed_at": "2013-01-12T08:53:33Z",
    "created_at": "2012-12-28T11:35:13Z",
    "labels": [
        "component: graph theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.6",
    "title": "Test memory allocation in distances_all_pairs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13875",
    "user": "https://github.com/dcoudert"
}
```
This patch adds tests on memory allocation in the distances_all_pairs module. This is to prevent returning NULL pointers when the memory space is insufficient to allocate data structure.

These tests are not doctested since the behavior depends on the computer (ram).

**Assignee:** @jasongrout, @nathanncohen, @rlmill

**CC:**  @nathanncohen

**Reviewer:** Nathann Cohen

**Author:** David Coudert

**Merged:** sage-5.6.rc0

**Dependencies:** #13808

Issue created by migration from https://trac.sagemath.org/ticket/13875





---

archive/issue_comments_202697.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2012-12-28T11:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202697",
    "user": "https://github.com/dcoudert"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_202698.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2012-12-28T11:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202698",
    "user": "https://github.com/nathanncohen"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_202699.json:
```json
{
    "body": "**Dependencies:** #13808",
    "created_at": "2012-12-28T11:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202699",
    "user": "https://github.com/nathanncohen"
}
```

**Dependencies:** #13808



---

archive/issue_comments_202700.json:
```json
{
    "body": "<a id='comment:2'></a>\nHellooooooooooooooo !!!\n\nYou cannot do things like `if distances==NULL or predecessor==NULL:` and raise an exception in that case. If distances has been allocated and predecessor hasn't, then an exception is raised before `distances` is freed.\n\nBesides, I expect this patch to be incompatible with your hyperbolicity patch. This ticket should depend on #13808 !\n\nOh. And I am not sure that it is wise to return as a message \"Not enough space\". Sometimes there is sufficient memory available, but not a contiguous segment as long as you need it to be. In such cases there is sufficient memory, just not allocated as it should. Something like `raise MemoryError()` is ok I guess.\n\nNathann",
    "created_at": "2012-12-28T11:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202700",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:2'></a>
Hellooooooooooooooo !!!

You cannot do things like `if distances==NULL or predecessor==NULL:` and raise an exception in that case. If distances has been allocated and predecessor hasn't, then an exception is raised before `distances` is freed.

Besides, I expect this patch to be incompatible with your hyperbolicity patch. This ticket should depend on #13808 !

Oh. And I am not sure that it is wise to return as a message "Not enough space". Sometimes there is sufficient memory available, but not a contiguous segment as long as you need it to be. In such cases there is sufficient memory, just not allocated as it should. Something like `raise MemoryError()` is ok I guess.

Nathann



---

archive/issue_comments_202701.json:
```json
{
    "body": "<a id='comment:3'></a>\n> You cannot do things like `if distances==NULL or predecessor==NULL:` and raise an exception in that case. If distances has been allocated and predecessor hasn't, then an exception is raised before `distances` is freed.\n\n\ndone.\n\n> Besides, I expect this patch to be incompatible with your hyperbolicity patch. This ticket should depend on #13808 !\n\n\nNo, this ticket is hopefully independent on the hyperbolicity patch. Furthermore, it don't change the behavior of the hyperbolicity patch. I have tested all possible combinations and I have no conflicts.\n\n> Oh. And I am not sure that it is wise to return as a message \"Not enough space\". Sometimes there is sufficient memory available, but not a contiguous segment as long as you need it to be. In such cases there is sufficient memory, just not allocated as it should. Something like `raise MemoryError()` is ok I guess.\n\n\ndone.",
    "created_at": "2012-12-28T12:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202701",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>
> You cannot do things like `if distances==NULL or predecessor==NULL:` and raise an exception in that case. If distances has been allocated and predecessor hasn't, then an exception is raised before `distances` is freed.


done.

> Besides, I expect this patch to be incompatible with your hyperbolicity patch. This ticket should depend on #13808 !


No, this ticket is hopefully independent on the hyperbolicity patch. Furthermore, it don't change the behavior of the hyperbolicity patch. I have tested all possible combinations and I have no conflicts.

> Oh. And I am not sure that it is wise to return as a message "Not enough space". Sometimes there is sufficient memory available, but not a contiguous segment as long as you need it to be. In such cases there is sufficient memory, just not allocated as it should. Something like `raise MemoryError()` is ok I guess.


done.



---

archive/issue_comments_202702.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2012-12-28T12:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202702",
    "user": "https://github.com/dcoudert"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_202703.json:
```json
{
    "body": "<a id='comment:4'></a>\n?.. BUt in the hyperbolicity patch you test that the pointers you are given by these methods are not null, don't you ? ANd after your patch they cannot be NULL anymore ?...\n\nNathann",
    "created_at": "2012-12-28T12:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202703",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:4'></a>
?.. BUt in the hyperbolicity patch you test that the pointers you are given by these methods are not null, don't you ? ANd after your patch they cannot be NULL anymore ?...

Nathann



---

archive/issue_comments_202704.json:
```json
{
    "body": "**Changing dependencies** from \"#13808\" to \"\".",
    "created_at": "2012-12-28T14:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202704",
    "user": "https://github.com/dcoudert"
}
```

**Changing dependencies** from "#13808" to "".



---

archive/issue_comments_202705.json:
```json
{
    "body": "<a id='comment:5'></a>\nIf we have to indicate dependencies, it's in the other way. We may change patch #13808 according the behavior of this one, but this patch don't depend on patch #13808. I have therefore removed the dependency.\n\nFurthermore, it is true that with this patch some tests in patch #13808 become useless. However, I think it is better to be on the safe side and to let them in case something else happen. The cost of these tests is clearly negligible.",
    "created_at": "2012-12-28T14:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202705",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:5'></a>
If we have to indicate dependencies, it's in the other way. We may change patch #13808 according the behavior of this one, but this patch don't depend on patch #13808. I have therefore removed the dependency.

Furthermore, it is true that with this patch some tests in patch #13808 become useless. However, I think it is better to be on the safe side and to let them in case something else happen. The cost of these tests is clearly negligible.



---

archive/issue_comments_202706.json:
```json
{
    "body": "<a id='comment:6'></a>\nYoooooooooo !!\n\nWell, the point of not having #13808 depend on this very patch is that #13808 is complicated enough *AND* already reviewed. And what's the point of testing whether the pointers are not null when the function cannot return NULL pointers ? It is checked, the function just can't return NULL pointers `O_o` The cost is negligible but what's the point as what it does is useless ? The code is not that easy to read, so let's remove the maximum amount of useless stuff ! And if we happen to copy/paste code from this file to another one, we won't copy useless checks at the same time ! `O_o`\n\nNathann",
    "created_at": "2012-12-28T22:23:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202706",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:6'></a>
Yoooooooooo !!

Well, the point of not having #13808 depend on this very patch is that #13808 is complicated enough *AND* already reviewed. And what's the point of testing whether the pointers are not null when the function cannot return NULL pointers ? It is checked, the function just can't return NULL pointers `O_o` The cost is negligible but what's the point as what it does is useless ? The code is not that easy to read, so let's remove the maximum amount of useless stuff ! And if we happen to copy/paste code from this file to another one, we won't copy useless checks at the same time ! `O_o`

Nathann



---

archive/issue_comments_202707.json:
```json
{
    "body": "<a id='comment:7'></a>\nOK, you win ;-)\nI have removed the test in hyperbolicity.pyx and so added the dependency.",
    "created_at": "2012-12-29T00:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202707",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>
OK, you win ;-)
I have removed the test in hyperbolicity.pyx and so added the dependency.



---

archive/issue_comments_202708.json:
```json
{
    "body": "**Dependencies:** #13808",
    "created_at": "2012-12-29T00:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202708",
    "user": "https://github.com/dcoudert"
}
```

**Dependencies:** #13808



---

archive/issue_comments_202709.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2012-12-29T09:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202709",
    "user": "https://github.com/nathanncohen"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_202710.json:
```json
{
    "body": "<a id='comment:8'></a>\n`^^;`\n\nThanks !\n\nAs before, though, there are memory leaks if `t_prec` is allocated but not `prec`.\n\n```\n t_prec = <unsigned short *> sage_malloc(n*n*sizeof(short)) \n if t_prec==NULL: \n     raise MemoryError() \n prec = <unsigned short **> sage_malloc(n*sizeof(short *)) \n if prec==NULL: \n     raise MemoryError() \n```\n\nYou should add a `sage_free(t_prec)` before the second `raise MemoryError()`, and it hppens several timees in the file.\n\nNathann",
    "created_at": "2012-12-29T09:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202710",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'></a>
`^^;`

Thanks !

As before, though, there are memory leaks if `t_prec` is allocated but not `prec`.

```
 t_prec = <unsigned short *> sage_malloc(n*n*sizeof(short)) 
 if t_prec==NULL: 
     raise MemoryError() 
 prec = <unsigned short **> sage_malloc(n*sizeof(short *)) 
 if prec==NULL: 
     raise MemoryError() 
```

You should add a `sage_free(t_prec)` before the second `raise MemoryError()`, and it hppens several timees in the file.

Nathann



---

archive/attachments_018745.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13875.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket13875/trac_13875.patch",
    "created_at": "2012-12-29T10:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/dcoudert"
}
```



---

archive/issue_comments_202711.json:
```json
{
    "body": "<a id='comment:9'></a>\nFixed.",
    "created_at": "2012-12-29T10:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202711",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:9'></a>
Fixed.



---

archive/issue_comments_202712.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2012-12-29T10:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202712",
    "user": "https://github.com/dcoudert"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_202713.json:
```json
{
    "body": "**Reviewer:** Nathann Cohen",
    "created_at": "2012-12-29T11:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202713",
    "user": "https://github.com/nathanncohen"
}
```

**Reviewer:** Nathann Cohen



---

archive/issue_comments_202714.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-12-29T11:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202714",
    "user": "https://github.com/nathanncohen"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_202715.json:
```json
{
    "body": "<a id='comment:10'></a>\nLooks good `:-)`\n\n(and I love my hggett script `:-P`)\n\nNathann",
    "created_at": "2012-12-29T11:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202715",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>
Looks good `:-)`

(and I love my hggett script `:-P`)

Nathann



---

archive/issue_comments_202716.json:
```json
{
    "body": "<a id='comment:11'></a>\nThanks for the review and for the script ;-)",
    "created_at": "2012-12-29T11:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202716",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:11'></a>
Thanks for the review and for the script ;-)



---

archive/issue_events_045331.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-12T08:53:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13875#event-45331"
}
```



---

archive/issue_comments_202717.json:
```json
{
    "body": "**Merged:** sage-5.6.rc0",
    "created_at": "2013-01-12T08:53:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13875#issuecomment-202717",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.6.rc0
