# Issue 13998: hash of a pickled Sequence is broken

archive/issues_013794.json:
```json
{
    "body": "The following works::\n\n```\n    sage: M = ModularSymbols(1,12,sign=1)\n    sage: M\n    Modular Symbols space of dimension 2 for Gamma_0(1) of weight 12 with sign 1 over Rational Field\n    sage: S = M.cuspidal_submodule().decomposition()[0].free_module().basis()\n    sage: type(S)\n    <class 'sage.structure.sequence.Sequence_generic'>\n    sage: S\n    [\n    (1, 0)\n    ]\n    sage: hash(S)\n    979268961\n```\n\nBut if you do the same from a certain pickled object, it is broken (tested on sage-4.7 and sage-5.6.rc0)::\n\n```\n    sage: M = load('http://sage.math.washington.edu/home/slabbe/LMFDB/mstest.sobj')\n    Attempting to load remote file: http://sage.math.washington.edu/home/slabbe/LMFDB/mstest.sobj\n    Loading: [.]\n    sage: M\n    Modular Symbols space of dimension 2 for Gamma_0(1) of weight 12 with sign 1 over Rational Field\n    sage: S = M.cuspidal_submodule().decomposition()[0].free_module().basis()\n    sage: type(S)\n    <class 'sage.structure.sequence.Sequence_generic'>\n    sage: S\n    [\n    (1, 0)\n    ]\n    sage: hash(S)\n    Traceback (most recent call last)\n    ...\n    AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'\n```\n\nThis particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage. Let's fix this problem !!!\n\n\n\n**Assignee:** @seblabbe\n\n**Reviewer:** Stephan Ehlen\n\n**Author:** S\u00e9bastien Labb\u00e9\n\n**Merged:** sage-5.7.beta2\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13998\n\n",
    "closed_at": "2013-01-30T07:36:13Z",
    "created_at": "2013-01-23T16:38:17Z",
    "labels": [
        "component: pickling",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "hash of a pickled Sequence is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13998",
    "user": "https://github.com/seblabbe"
}
```
The following works::

```
    sage: M = ModularSymbols(1,12,sign=1)
    sage: M
    Modular Symbols space of dimension 2 for Gamma_0(1) of weight 12 with sign 1 over Rational Field
    sage: S = M.cuspidal_submodule().decomposition()[0].free_module().basis()
    sage: type(S)
    <class 'sage.structure.sequence.Sequence_generic'>
    sage: S
    [
    (1, 0)
    ]
    sage: hash(S)
    979268961
```

But if you do the same from a certain pickled object, it is broken (tested on sage-4.7 and sage-5.6.rc0)::

```
    sage: M = load('http://sage.math.washington.edu/home/slabbe/LMFDB/mstest.sobj')
    Attempting to load remote file: http://sage.math.washington.edu/home/slabbe/LMFDB/mstest.sobj
    Loading: [.]
    sage: M
    Modular Symbols space of dimension 2 for Gamma_0(1) of weight 12 with sign 1 over Rational Field
    sage: S = M.cuspidal_submodule().decomposition()[0].free_module().basis()
    sage: type(S)
    <class 'sage.structure.sequence.Sequence_generic'>
    sage: S
    [
    (1, 0)
    ]
    sage: hash(S)
    Traceback (most recent call last)
    ...
    AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
```

This particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage. Let's fix this problem !!!



**Assignee:** @seblabbe

**Reviewer:** Stephan Ehlen

**Author:** Sébastien Labbé

**Merged:** sage-5.7.beta2

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/13998





---

archive/issue_comments_218794.json:
```json
{
    "body": "<a id='comment:1'></a>\nHere is a way to reproduce the problem on a recent version of Sage:\n\n```\nsage: S = Sequence([])\nsage: S.set_immutable()\nsage: del S._Sequence_generic__hash\nsage: hash(S)\nTraceback (most recent call last):\n...\nAttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'\nsage:\nsage: S._Sequence__hash = 34  # providing this value should fix the above error but it doesn't:\nsage: hash(S)\nTraceback (most recent call last):\n...\nAttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'\n```\n\nThis is what I am going to use to doctest the fix.",
    "created_at": "2013-01-23T17:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218794",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:1'></a>
Here is a way to reproduce the problem on a recent version of Sage:

```
sage: S = Sequence([])
sage: S.set_immutable()
sage: del S._Sequence_generic__hash
sage: hash(S)
Traceback (most recent call last):
...
AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
sage:
sage: S._Sequence__hash = 34  # providing this value should fix the above error but it doesn't:
sage: hash(S)
Traceback (most recent call last):
...
AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
```

This is what I am going to use to doctest the fix.



---

archive/issue_comments_218795.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-01-23T18:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218795",
    "user": "https://github.com/seblabbe"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_218796.json:
```json
{
    "body": "<a id='comment:2'></a>\nAttachment [trac_13998_unpickle_sequence-sl.patch](tarball://root/attachments/some-uuid/ticket13998/trac_13998_unpickle_sequence-sl.patch) by @seblabbe created at 2013-01-23 18:04:12",
    "created_at": "2013-01-23T18:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218796",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:2'></a>
Attachment [trac_13998_unpickle_sequence-sl.patch](tarball://root/attachments/some-uuid/ticket13998/trac_13998_unpickle_sequence-sl.patch) by @seblabbe created at 2013-01-23 18:04:12



---

archive/issue_comments_218797.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -36,6 +36,6 @@\n     AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'\n ```\n \n-This particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage.\n+This particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage. Let's fix this problem !!!\n \n \n``````\n",
    "created_at": "2013-01-23T18:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218797",
    "user": "https://github.com/seblabbe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -36,6 +36,6 @@
     AttributeError: 'Sequence_generic' object has no attribute '_Sequence_generic__hash'
 ```
 
-This particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage.
+This particular problem was reported by LMFDB developper who understands that Sage do not guarrenty that pickled object are supported by later version of Sage. Let's fix this problem !!!
 
 
``````




---

archive/issue_comments_218798.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-01-24T16:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218798",
    "user": "https://trac.sagemath.org/admin/accounts/users/ehlen"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_218799.json:
```json
{
    "body": "<a id='comment:4'></a>\nI tested the patch with sage version 5.5.\n\nI tested that:\n* The described bug does not occur anymore with the pickled object (see also my remark below).\n* The buggy behaviour described in comment 1 is now fixed.\n* The patch adds doctests for the patch with reference to the trac ticket.\n* The doctests complete without any errors.\n* The sage documentation builds fine.\n\nRemark: In fact, the pickled object was provided by me and belongs to a large collection that serves the LMFDB (www.lmfdb.org) website currently. This means that the bug affected >13000 pickled objects. Now the first example from above works with the objects taken from the database\n(I tested a few, not all of them.)",
    "created_at": "2013-01-24T16:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218799",
    "user": "https://trac.sagemath.org/admin/accounts/users/ehlen"
}
```

<a id='comment:4'></a>
I tested the patch with sage version 5.5.

I tested that:
* The described bug does not occur anymore with the pickled object (see also my remark below).
* The buggy behaviour described in comment 1 is now fixed.
* The patch adds doctests for the patch with reference to the trac ticket.
* The doctests complete without any errors.
* The sage documentation builds fine.

Remark: In fact, the pickled object was provided by me and belongs to a large collection that serves the LMFDB (www.lmfdb.org) website currently. This means that the bug affected >13000 pickled objects. Now the first example from above works with the objects taken from the database
(I tested a few, not all of them.)



---

archive/issue_comments_218800.json:
```json
{
    "body": "<a id='comment:5'></a>\nPlease fill in the Author / Reviewer fields.",
    "created_at": "2013-01-25T16:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218800",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Please fill in the Author / Reviewer fields.



---

archive/issue_comments_218801.json:
```json
{
    "body": "**Author:** S\u00e9bastien Labb\u00e9",
    "created_at": "2013-01-25T16:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218801",
    "user": "https://github.com/seblabbe"
}
```

**Author:** Sébastien Labbé



---

archive/issue_comments_218802.json:
```json
{
    "body": "**Reviewer:** Stephan Ehlen",
    "created_at": "2013-01-25T16:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218802",
    "user": "https://github.com/seblabbe"
}
```

**Reviewer:** Stephan Ehlen



---

archive/issue_events_045524.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-30T07:36:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13998#event-45524"
}
```



---

archive/issue_comments_218803.json:
```json
{
    "body": "**Merged:** sage-5.7.beta2",
    "created_at": "2013-01-30T07:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218803",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.7.beta2



---

archive/issue_comments_218804.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2013-01-30T07:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13998#issuecomment-218804",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed
