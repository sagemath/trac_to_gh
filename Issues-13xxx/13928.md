# Issue 13928: Problematic file filter in skip() from sage-ptest

archive/issues_013724.json:
```json
{
    "assignees": [],
    "body": "My computer has no processor, and that's because `sage -tp 4` refuses to test any file whose path contains the string `\"/.\"`. That's a problem, for on my machine `SAGE_ROOT=/home/ncohen/.Sage` and all files get filtered. This patch removes this test, hoping that it was totally useless in the first place, which sounds.... unlikely `O_o`\n\n```\n~/sage/sage/graphs$ sage -tp 4 .\nGlobal iterations: 1\nFile iterations: 1\nUsing cached timings to run longest doctests first.\nDoctesting 0 files doing 0 jobs in parallel\nTraceback (most recent call last):\n  File \"/home/ncohen/.Sage/local/bin/sage-ptest\", line 445, in <module>\n    p = multiprocessing.Pool(numthreads)\n  File \"/home/ncohen/.Sage/local/lib/python/multiprocessing/__init__.py\", line 232, in Pool\n    return Pool(processes, initializer, initargs, maxtasksperchild)\n  File \"/home/ncohen/.Sage/local/lib/python/multiprocessing/pool.py\", line 129, in __init__\n    raise ValueError(\"Number of processes must be at least 1\")\nValueError: Number of processes must be at least 1\n~/sage/sage/graphs$ \n```\n\nApply the patch to SAGE_ROOT/local/bin/\n\nNathann\n\nSee the report on sage-devel : https://groups.google.com/forum/?hl=fr&fromgroups=#!topic/sage-devel/Ae8wLR0EgHA\n\n**Assignee:** mvngu\n\n**CC:**  @jdemeyer @hivert @nthiery\n\n**Reviewer:** Nils Bruin, John Palmieri\n\nIssue created by migration from https://trac.sagemath.org/ticket/13928\n\n",
    "closed_at": "2013-03-07T08:10:20Z",
    "created_at": "2013-01-08T15:05:31Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20coverage",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/duplicate"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Problematic file filter in skip() from sage-ptest",
    "type": "issue",
    "updated_at": "2013-04-25T12:58:41Z",
    "url": "https://github.com/sagemath/sage/issues/13928",
    "user": "https://github.com/nathanncohen"
}
```
My computer has no processor, and that's because `sage -tp 4` refuses to test any file whose path contains the string `"/."`. That's a problem, for on my machine `SAGE_ROOT=/home/ncohen/.Sage` and all files get filtered. This patch removes this test, hoping that it was totally useless in the first place, which sounds.... unlikely `O_o`

```
~/sage/sage/graphs$ sage -tp 4 .
Global iterations: 1
File iterations: 1
Using cached timings to run longest doctests first.
Doctesting 0 files doing 0 jobs in parallel
Traceback (most recent call last):
  File "/home/ncohen/.Sage/local/bin/sage-ptest", line 445, in <module>
    p = multiprocessing.Pool(numthreads)
  File "/home/ncohen/.Sage/local/lib/python/multiprocessing/__init__.py", line 232, in Pool
    return Pool(processes, initializer, initargs, maxtasksperchild)
  File "/home/ncohen/.Sage/local/lib/python/multiprocessing/pool.py", line 129, in __init__
    raise ValueError("Number of processes must be at least 1")
ValueError: Number of processes must be at least 1
~/sage/sage/graphs$ 
```

Apply the patch to SAGE_ROOT/local/bin/

Nathann

See the report on sage-devel : https://groups.google.com/forum/?hl=fr&fromgroups=#!topic/sage-devel/Ae8wLR0EgHA

**Assignee:** mvngu

**CC:**  @jdemeyer @hivert @nthiery

**Reviewer:** Nils Bruin, John Palmieri

Issue created by migration from https://trac.sagemath.org/ticket/13928





---

archive/issue_events_165780.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-01-08T15:05:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20coverage",
    "label_color": "08517b",
    "label_name": "component: doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165780"
}
```



---

archive/issue_events_165781.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-01-08T15:05:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165781"
}
```



---

archive/issue_events_165782.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-01-08T15:05:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "008080",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165782"
}
```



---

archive/issue_comments_167108.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n My computer has no processor, and that's because `sage -tp 4` refuses to test any file whose path contains the string `\"/.\"`. That's a problem, for on my machine `SAGE_ROOT=/home/ncohen/.Sage` and all files get filtered. This patch removes this test, hoping that it was totally useless in the first place, which sounds.... unlikely `O_o`\n+\n+```\n+~/sage/sage/graphs$ sage -tp 4 .\n+Global iterations: 1\n+File iterations: 1\n+Using cached timings to run longest doctests first.\n+Doctesting 0 files doing 0 jobs in parallel\n+Traceback (most recent call last):\n+  File \"/home/ncohen/.Sage/local/bin/sage-ptest\", line 445, in <module>\n+    p = multiprocessing.Pool(numthreads)\n+  File \"/home/ncohen/.Sage/local/lib/python/multiprocessing/__init__.py\", line 232, in Pool\n+    return Pool(processes, initializer, initargs, maxtasksperchild)\n+  File \"/home/ncohen/.Sage/local/lib/python/multiprocessing/pool.py\", line 129, in __init__\n+    raise ValueError(\"Number of processes must be at least 1\")\n+ValueError: Number of processes must be at least 1\n+~/sage/sage/graphs$ \n+```\n \n Apply the patch to SAGE_ROOT/local/bin/\n \n``````\n",
    "created_at": "2013-01-08T15:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167108",
    "user": "https://github.com/nathanncohen"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,21 @@
 My computer has no processor, and that's because `sage -tp 4` refuses to test any file whose path contains the string `"/."`. That's a problem, for on my machine `SAGE_ROOT=/home/ncohen/.Sage` and all files get filtered. This patch removes this test, hoping that it was totally useless in the first place, which sounds.... unlikely `O_o`
+
+```
+~/sage/sage/graphs$ sage -tp 4 .
+Global iterations: 1
+File iterations: 1
+Using cached timings to run longest doctests first.
+Doctesting 0 files doing 0 jobs in parallel
+Traceback (most recent call last):
+  File "/home/ncohen/.Sage/local/bin/sage-ptest", line 445, in <module>
+    p = multiprocessing.Pool(numthreads)
+  File "/home/ncohen/.Sage/local/lib/python/multiprocessing/__init__.py", line 232, in Pool
+    return Pool(processes, initializer, initargs, maxtasksperchild)
+  File "/home/ncohen/.Sage/local/lib/python/multiprocessing/pool.py", line 129, in __init__
+    raise ValueError("Number of processes must be at least 1")
+ValueError: Number of processes must be at least 1
+~/sage/sage/graphs$ 
+```
 
 Apply the patch to SAGE_ROOT/local/bin/
 
``````




---

archive/issue_events_165783.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-01-08T15:07:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165783"
}
```



---

archive/issue_comments_167109.json:
```json
{
    "body": "<a id='comment:2'></a>\nThat's not a bug (skipping files in directories starting with `.`), but a feature.\n\nThe real bug is the exception raised (if no files to test remain).  But we should probably report *why* (or *that*) such files get skipped, or (because there can potentially be many) at least document this somewhere (if it isn't already; a comment in `sage-ptest` would probably have sufficed in your case... ;-) )",
    "created_at": "2013-01-08T17:17:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167109",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:2'></a>
That's not a bug (skipping files in directories starting with `.`), but a feature.

The real bug is the exception raised (if no files to test remain).  But we should probably report *why* (or *that*) such files get skipped, or (because there can potentially be many) at least document this somewhere (if it isn't already; a comment in `sage-ptest` would probably have sufficed in your case... ;-) )



---

archive/issue_comments_167110.json:
```json
{
    "body": "<a id='comment:3'></a>\nP.S.:  You'll also have noticed the many `XXX`s (due to me) in that file... :-)",
    "created_at": "2013-01-08T17:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167110",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>
P.S.:  You'll also have noticed the many `XXX`s (due to me) in that file... :-)



---

archive/issue_comments_167111.json:
```json
{
    "body": "<a id='comment:4'></a>\nMaybe the test shouldn't filter the absolute path, but the path relative to `SAGE_ROOT`. I don't see why we should skip directories starting with `.` if they are not in the Sage library (if I want to test some random collection of files in one of my own directories, why can't the directory start with a `.`?). So \n\n```python\nG = os.path.realpath(G)\nif G.startswith(SAGE_ROOT):\n    if os.path.sep + '.' in G[len(SAGE_ROOT):].lstrip(os.path.sep + '.'):\n        return True\n\n    # perhaps also put this here:\n    if G.find(os.path.join('doc', 'output')) != -1:\n        return True\n```",
    "created_at": "2013-01-08T17:56:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167111",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>
Maybe the test shouldn't filter the absolute path, but the path relative to `SAGE_ROOT`. I don't see why we should skip directories starting with `.` if they are not in the Sage library (if I want to test some random collection of files in one of my own directories, why can't the directory start with a `.`?). So 

```python
G = os.path.realpath(G)
if G.startswith(SAGE_ROOT):
    if os.path.sep + '.' in G[len(SAGE_ROOT):].lstrip(os.path.sep + '.'):
        return True

    # perhaps also put this here:
    if G.find(os.path.join('doc', 'output')) != -1:
        return True
```



---

archive/issue_comments_167112.json:
```json
{
    "body": "<a id='comment:5'></a>\nHmmm, it's IMHO ok (or adequate) to skip hidden directories, no matter whether they're below `SAGE_ROOT` or not.\n\nFeel free to implement an option to disable this feature... ;-P",
    "created_at": "2013-01-08T18:05:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167112",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
Hmmm, it's IMHO ok (or adequate) to skip hidden directories, no matter whether they're below `SAGE_ROOT` or not.

Feel free to implement an option to disable this feature... ;-P



---

archive/issue_comments_167113.json:
```json
{
    "body": "<a id='comment:6'></a>\n> Hmmm, it's IMHO ok (or adequate) to skip hidden directories, no matter whether they're below `SAGE_ROOT` or not.\n> \n> Feel free to implement an option to disable this feature... ;-P\n\nHere is a patch using John's code.... Leif do you really find adequate that `make ptestlong` does not work when I install Sage ? `O_o`\nAs John I really do not get why all filenames containing `/.` should be filtered. But it's clearly a problem for me if I have to install Sage in my home directory, in a .Sage subfolder, and find out that I am unable to test Sage's code in parallel !\n\nNathann",
    "created_at": "2013-01-08T18:45:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167113",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:6'></a>
> Hmmm, it's IMHO ok (or adequate) to skip hidden directories, no matter whether they're below `SAGE_ROOT` or not.
> 
> Feel free to implement an option to disable this feature... ;-P

Here is a patch using John's code.... Leif do you really find adequate that `make ptestlong` does not work when I install Sage ? `O_o`
As John I really do not get why all filenames containing `/.` should be filtered. But it's clearly a problem for me if I have to install Sage in my home directory, in a .Sage subfolder, and find out that I am unable to test Sage's code in parallel !

Nathann



---

archive/issue_comments_167114.json:
```json
{
    "body": "<a id='comment:7'></a>\nNathann, in your patch, lines 158-159 duplicate the test in lines 161-162. You should delete 161-162.\n\nLeif: why shouldn't I be able to (p)test files in `~/.sage`, for example? I think when we try to test a subdirectory of `SAGE_ROOT`, we can skip files based on names of directories (relative to `SAGE_ROOT`), but shouldn't the user be able to test anything outside of the Sage installation?",
    "created_at": "2013-01-08T19:04:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167114",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
Nathann, in your patch, lines 158-159 duplicate the test in lines 161-162. You should delete 161-162.

Leif: why shouldn't I be able to (p)test files in `~/.sage`, for example? I think when we try to test a subdirectory of `SAGE_ROOT`, we can skip files based on names of directories (relative to `SAGE_ROOT`), but shouldn't the user be able to test anything outside of the Sage installation?



---

archive/issue_comments_167115.json:
```json
{
    "body": "<a id='comment:8'></a>\n> Nathann, in your patch, lines 158-159 duplicate the test in lines 161-162. You should delete 161-162.\n\n(Gloops. Fixed)",
    "created_at": "2013-01-08T19:05:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167115",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'></a>
> Nathann, in your patch, lines 158-159 duplicate the test in lines 161-162. You should delete 161-162.

(Gloops. Fixed)



---

archive/issue_comments_167116.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [@nathanncohen](#comment%3A6):\n> As John I really do not get why all filenames containing `/.` should be filtered. But it's clearly a problem for me if I have to install Sage in my home directory, in a .Sage subfolder, and find out that I am unable to test Sage's code in parallel !\n\nWell, rename the folder to something not starting with a dot, then run `sage -tp ...` or `make ptest[long]` or whatever... ;-)\n\nThe exception raised if no files to test remain should get fixed though, giving a reasonable message instead.  [We could also issue a warning (once!) if `SAGE_ROOT` or some specified directory's path contains a hidden directory.]\n\nThe filtering really needs an overhaul, but probably on another ticket...  (For example, the whole tree below a hidden directory should get pruned [once], instead of testing each file's path -- at least by default.  See the `XXX`s for similar issues...)",
    "created_at": "2013-01-08T19:07:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167116",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:9'></a>
Replying to [@nathanncohen](#comment%3A6):
> As John I really do not get why all filenames containing `/.` should be filtered. But it's clearly a problem for me if I have to install Sage in my home directory, in a .Sage subfolder, and find out that I am unable to test Sage's code in parallel !

Well, rename the folder to something not starting with a dot, then run `sage -tp ...` or `make ptest[long]` or whatever... ;-)

The exception raised if no files to test remain should get fixed though, giving a reasonable message instead.  [We could also issue a warning (once!) if `SAGE_ROOT` or some specified directory's path contains a hidden directory.]

The filtering really needs an overhaul, but probably on another ticket...  (For example, the whole tree below a hidden directory should get pruned [once], instead of testing each file's path -- at least by default.  See the `XXX`s for similar issues...)



---

archive/issue_comments_167117.json:
```json
{
    "body": "<a id='comment:10'></a>\nCome on, Leif, why don't you consider it a bug when I can't install Sage wherever I want and use it to do something I need to do ? What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !\n\nNathann",
    "created_at": "2013-01-08T19:12:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167117",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>
Come on, Leif, why don't you consider it a bug when I can't install Sage wherever I want and use it to do something I need to do ? What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !

Nathann



---

archive/issue_comments_167118.json:
```json
{
    "body": "<a id='comment:11'></a>\nWith or without Nathann's patch, we should fix the actual bug:\n\n```diff\ndiff --git a/sage-ptest b/sage-ptest\n--- a/sage-ptest\n+++ b/sage-ptest\n@@ -429,6 +429,7 @@ for gr in range(0,numglobaliteration):\n     interrupt = False\n \n     numthreads = min(numthreads, len(files))  # don't use more threads than files\n+    numthreads = max(numthreads, 1) # use at least one thread\n         \n     if len(files) == 1:\n         file_str = \"1 file\"\n```\nalthough as Leif says we could also give a warning if no files will be tested, and also a warning about the hidden directory issue. For example:\n\n```diff\ndiff --git a/sage-ptest b/sage-ptest\n--- a/sage-ptest\n+++ b/sage-ptest\n@@ -358,6 +358,15 @@ for gr in range(0,numglobaliteration):\n \n     infiles.sort()\n \n+    for F in infiles:\n+        F = abspath(F)\n+        if os.path.sep + '.' in F.lstrip(os.path.sep + '.'):\n+            print \"\"\"Warning:\n+\n+   %s\n+\n+will be not be tested because it is in a hidden directory.\"\"\" % F\n+\n     files = list()\n \n     t0 = time.time()\n```",
    "created_at": "2013-01-08T19:19:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167118",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
With or without Nathann's patch, we should fix the actual bug:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -429,6 +429,7 @@ for gr in range(0,numglobaliteration):
     interrupt = False
 
     numthreads = min(numthreads, len(files))  # don't use more threads than files
+    numthreads = max(numthreads, 1) # use at least one thread
         
     if len(files) == 1:
         file_str = "1 file"
```
although as Leif says we could also give a warning if no files will be tested, and also a warning about the hidden directory issue. For example:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -358,6 +358,15 @@ for gr in range(0,numglobaliteration):
 
     infiles.sort()
 
+    for F in infiles:
+        F = abspath(F)
+        if os.path.sep + '.' in F.lstrip(os.path.sep + '.'):
+            print """Warning:
+
+   %s
+
+will be not be tested because it is in a hidden directory.""" % F
+
     files = list()
 
     t0 = time.time()
```



---

archive/issue_comments_167119.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [@nathanncohen](#comment%3A10):\n> Come on, Leif, why don't you consider it a bug when I can't install Sage wherever I want and use it to do something I need to do ?\n\nWhy do you install Sage into a hidden directory, or [`<flame>` *why would anybody want to do so* `</flame>`] ? \n\n> What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !\n\nAt least the one who implemented it knows, and others would perhaps be surprised if we didn't.\n\nI thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.",
    "created_at": "2013-01-08T19:22:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167119",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:12'></a>
Replying to [@nathanncohen](#comment%3A10):
> Come on, Leif, why don't you consider it a bug when I can't install Sage wherever I want and use it to do something I need to do ?

Why do you install Sage into a hidden directory, or [`<flame>` *why would anybody want to do so* `</flame>`] ? 

> What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !

At least the one who implemented it knows, and others would perhaps be surprised if we didn't.

I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.



---

archive/issue_comments_167120.json:
```json
{
    "body": "<a id='comment:13'></a>\n> Why do you install Sage into a hidden directory, or [`<flame>` *why would anybody want to do so* `</flame>`] ? \n\nI use a computer on which I am not root, I can only write stuff to my home directory, and I have many things to install. So I don't want to see then when I do \"ls\" in my home directory. Happened to me thousands of times.\n\n> > What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !\n\n> \n> At least the one who implemented it knows, and others would perhaps be surprised if we didn't.\n> \n> I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.\n\nThen what's the problem with filtering the `/.` that appear in SAGE_ROOT ?\n\nNathann",
    "created_at": "2013-01-08T19:27:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167120",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:13'></a>
> Why do you install Sage into a hidden directory, or [`<flame>` *why would anybody want to do so* `</flame>`] ? 

I use a computer on which I am not root, I can only write stuff to my home directory, and I have many things to install. So I don't want to see then when I do "ls" in my home directory. Happened to me thousands of times.

> > What's the point of filtering `/.` directories anyway, I would be surprised if anybody knows it actually does that !

> 
> At least the one who implemented it knows, and others would perhaps be surprised if we didn't.
> 
> I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.

Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?

Nathann



---

archive/issue_comments_167121.json:
```json
{
    "body": "<a id='comment:14'></a>\nPerhaps there's a middle way that satisfies both leif and nathan: I can see why filenames starting with a \".\" should be skipped during discovery and recursion, but if a dotted filename gets explicitly included in the pathname, the user is clearly asking for testing that file, so why not?\n\nCompare the behaviour of `ls -R <path name>`, for instance. It won't list/recurse into any dotted files *within* `<path name>`, but it will happily work if any of the components of `<path name>` have a dot in them.\n\nI don't know where/how `make ptest` gets a list of to-be-tested files, but I'd think that you want to filter out dotted files there (i.e., when you're discovering new leafs/nodes), rather than when you've assembled a full path name already. That basically means: let `populatefilelist` do the hard work, not `skip` (in fact, shouldn't everything of skip be absorbed in there?)\n\n(But really ... why *would* you want to install software in a dotted directory? Do you want to hide it from your sysadmin?)\n\nAnyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not *have* a canonical `realpath` anyway, showing that relying on it is a logical flaw.",
    "created_at": "2013-01-08T19:37:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167121",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:14'></a>
Perhaps there's a middle way that satisfies both leif and nathan: I can see why filenames starting with a "." should be skipped during discovery and recursion, but if a dotted filename gets explicitly included in the pathname, the user is clearly asking for testing that file, so why not?

Compare the behaviour of `ls -R <path name>`, for instance. It won't list/recurse into any dotted files *within* `<path name>`, but it will happily work if any of the components of `<path name>` have a dot in them.

I don't know where/how `make ptest` gets a list of to-be-tested files, but I'd think that you want to filter out dotted files there (i.e., when you're discovering new leafs/nodes), rather than when you've assembled a full path name already. That basically means: let `populatefilelist` do the hard work, not `skip` (in fact, shouldn't everything of skip be absorbed in there?)

(But really ... why *would* you want to install software in a dotted directory? Do you want to hide it from your sysadmin?)

Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not *have* a canonical `realpath` anyway, showing that relying on it is a logical flaw.



---

archive/issue_comments_167122.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [@nathanncohen](#comment%3A13):\n> > Why do you install Sage into a hidden directory, or [`<flame>` *why would anybody want to do so* `</flame>`] ? \n\n> \n> I use a computer on which I am not root, I can only write stuff to my home directory, and I have many things to install. So I don't want to see then when I do \"ls\" in my home directory. Happened to me thousands of times.\n\nCreate some [visible] subdirectory that contains all the stuff that you don't want to see?\n\n(On [other people's] Windows for example, the first thing I usually do is to create a `Deskbottom` folder, to move the useless things to... :-) )\n\n\n\n\n> > I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.\n\n> \n> Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?\n\nI'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.",
    "created_at": "2013-01-08T19:44:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167122",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>
Replying to [@nathanncohen](#comment%3A13):
> > Why do you install Sage into a hidden directory, or [`<flame>` *why would anybody want to do so* `</flame>`] ? 

> 
> I use a computer on which I am not root, I can only write stuff to my home directory, and I have many things to install. So I don't want to see then when I do "ls" in my home directory. Happened to me thousands of times.

Create some [visible] subdirectory that contains all the stuff that you don't want to see?

(On [other people's] Windows for example, the first thing I usually do is to create a `Deskbottom` folder, to move the useless things to... :-) )




> > I thought it was obvious, but we don't want to hardcode the various names of the hidden directories of revision control systems.

> 
> Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?

I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.



---

archive/issue_comments_167123.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@nbruin](#comment%3A14):\n> Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not *have* a canonical `realpath` anyway, showing that relying on it is a logical flaw.\n\nThanks.  I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so, unfortunately.  This is a real mess with filesystems that get mounted on different directories (for example depending on the machine or the operating system you currently booted), and by the way -- at least in my case -- always blows up the log files [and screen output] because the \"real path\" is three to ten times longer than the specified one, i.e., the one with symlinks.",
    "created_at": "2013-01-08T19:54:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167123",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'></a>
Replying to [@nbruin](#comment%3A14):
> Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not *have* a canonical `realpath` anyway, showing that relying on it is a logical flaw.

Thanks.  I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so, unfortunately.  This is a real mess with filesystems that get mounted on different directories (for example depending on the machine or the operating system you currently booted), and by the way -- at least in my case -- always blows up the log files [and screen output] because the "real path" is three to ten times longer than the specified one, i.e., the one with symlinks.



---

archive/issue_comments_167124.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [@nbruin](#comment%3A14):\n> Perhaps there's a middle way that satisfies both leif and nathan: I can see why filenames starting with a \".\" should be skipped during discovery and recursion, but if a dotted filename gets explicitly included in the pathname, the user is clearly asking for testing that file, so why not?\n\nSounds good to me.\n\n> Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not *have* a canonical `realpath` anyway, showing that relying on it is a logical flaw.\n\nI agree about using the path as presented by the user. Note though that `realpath` is used several other places in the file, for example line 308:\n\n```\nif os.path.realpath(appendstr).startswith(BUILD_DIR):\n```\nwhere `BUILD_DIR` was also defined using `realpath`. So if it's problematic, other parts of the file need to be fixed (as does the [Python documentation](http://docs.python.org/2/library/os.path.html?highlight=realpath#os.path.realpath), unless they're using the word \"canonical\" in a, ahem, noncanonical way). Or they don't need to be fixed, and they might produce false positives: some files will get tested which perhaps shouldn't. But it's better to test too many than to skip some, I think: false positives are better than false negatives.\n\nReplying to [@nexttime](#comment%3A15):\n> Replying to [@nathanncohen](#comment%3A13):\n\n> > Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?\n\n> \n> I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.\n\nI think he means, what's wrong with just filtering subdirectories of `SAGE_ROOT` (and its subdirectories) which start with `.`? This would be consistent with Nils' suggestion.",
    "created_at": "2013-01-08T19:56:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167124",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'></a>
Replying to [@nbruin](#comment%3A14):
> Perhaps there's a middle way that satisfies both leif and nathan: I can see why filenames starting with a "." should be skipped during discovery and recursion, but if a dotted filename gets explicitly included in the pathname, the user is clearly asking for testing that file, so why not?

Sounds good to me.

> Anyway, your current patch is fragile and not an improvement (other than that it apparently fixes your particular problem). Any time you require a `realpath` you're probably doing something wrong. It's a very expensive operation and it's fragile. You should really work with file paths as presented to you. The user probably had a reason for presenting the path to you in the way he/she did. Don't second-guess him/her. In fact, with remounting and loop mounting, files might not *have* a canonical `realpath` anyway, showing that relying on it is a logical flaw.

I agree about using the path as presented by the user. Note though that `realpath` is used several other places in the file, for example line 308:

```
if os.path.realpath(appendstr).startswith(BUILD_DIR):
```
where `BUILD_DIR` was also defined using `realpath`. So if it's problematic, other parts of the file need to be fixed (as does the [Python documentation](http://docs.python.org/2/library/os.path.html?highlight=realpath#os.path.realpath), unless they're using the word "canonical" in a, ahem, noncanonical way). Or they don't need to be fixed, and they might produce false positives: some files will get tested which perhaps shouldn't. But it's better to test too many than to skip some, I think: false positives are better than false negatives.

Replying to [@nexttime](#comment%3A15):
> Replying to [@nathanncohen](#comment%3A13):

> > Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?

> 
> I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.

I think he means, what's wrong with just filtering subdirectories of `SAGE_ROOT` (and its subdirectories) which start with `.`? This would be consistent with Nils' suggestion.



---

archive/issue_comments_167125.json:
```json
{
    "body": "<a id='comment:18'></a>\n> Create some [visible] subdirectory that contains all the stuff that you don't want to see?\n\n`O_o`\n\nIt's my home folder. Not Sage's. It's there because I invited it, but it's not about to make rules there `:-P`\n\n> I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.\n\nOh. I mean that we could ask Sage to ignore the `/.` that belong to SAGE_ROOT, and not the other ones. Let us assume that my SAGE_ROOT variable contains a `/.` (it does). Then SAGE_ROOT/subfolder/ will *not* be ignored, but SAGE_ROOT/.subfolder/ would !\n\nThis way, no problem with .hg folders located in SAGE_ROOT. But I can type `make ptestlong`.\n\nNathann",
    "created_at": "2013-01-08T19:58:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167125",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:18'></a>
> Create some [visible] subdirectory that contains all the stuff that you don't want to see?

`O_o`

It's my home folder. Not Sage's. It's there because I invited it, but it's not about to make rules there `:-P`

> I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.

Oh. I mean that we could ask Sage to ignore the `/.` that belong to SAGE_ROOT, and not the other ones. Let us assume that my SAGE_ROOT variable contains a `/.` (it does). Then SAGE_ROOT/subfolder/ will *not* be ignored, but SAGE_ROOT/.subfolder/ would !

This way, no problem with .hg folders located in SAGE_ROOT. But I can type `make ptestlong`.

Nathann



---

archive/issue_comments_167126.json:
```json
{
    "body": "<a id='comment:19'></a>\nAh, got it. `populatefilelist` uses `os.walk` to recurse into the directory tree and that has no problem following into hidden files. Hence the solution to prune these afterwards. That's the wrong approach of course: You shouldn't follow/include these things in the first place. So `os.walk` is the wrong tool. Nathan, you got your job cut out for you: rewrite `populatefilelist` to include files into the list a little more prudently, so that `skip` doesn't have to do so much pruning.\n\nActually, `os.walk` *is* the proper tool, but you have to run it with `topdown=True` (which is the default anyway). See [os.walk documentation](http://docs.python.org/2/library/os.html#os.walk). Then you can edit `dirnames` in-place, to affect further recursions. So, if you write something like this in `populatefilelist`:\n\n```\nfor path,dirnames,lfiles in os.walk(walkdir):\n    dirnames[:]=(n for n in dirnames if len(n) == 0 or n[0] != '.')\n    lfiles[:]=(n for n in lfiles if len(n) == 0 or n[0] != '.')\n    <do your processing here>\n```\nthere shouldn't be a need for `skip` to explicitly filter out dotted filenames anymore.",
    "created_at": "2013-01-08T21:22:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167126",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:19'></a>
Ah, got it. `populatefilelist` uses `os.walk` to recurse into the directory tree and that has no problem following into hidden files. Hence the solution to prune these afterwards. That's the wrong approach of course: You shouldn't follow/include these things in the first place. So `os.walk` is the wrong tool. Nathan, you got your job cut out for you: rewrite `populatefilelist` to include files into the list a little more prudently, so that `skip` doesn't have to do so much pruning.

Actually, `os.walk` *is* the proper tool, but you have to run it with `topdown=True` (which is the default anyway). See [os.walk documentation](http://docs.python.org/2/library/os.html#os.walk). Then you can edit `dirnames` in-place, to affect further recursions. So, if you write something like this in `populatefilelist`:

```
for path,dirnames,lfiles in os.walk(walkdir):
    dirnames[:]=(n for n in dirnames if len(n) == 0 or n[0] != '.')
    lfiles[:]=(n for n in lfiles if len(n) == 0 or n[0] != '.')
    <do your processing here>
```
there shouldn't be a need for `skip` to explicitly filter out dotted filenames anymore.



---

archive/issue_comments_167127.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@jhpalmieri](#comment%3A17):\n> Replying to [@nexttime](#comment%3A15):\n> > Replying to [@nathanncohen](#comment%3A13):\n\n> \n> > > Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?\n\n> > \n> > I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.\n\n> \n> I think he means, what's wrong with just filtering subdirectories of `SAGE_ROOT` (and its subdirectories) which start with `.`? This would be consistent with Nils' suggestion.\n\nWell, I'd say it's even *more likely* that the tree(s) contain(s) (e.g.) `.svn` or `.git` directories if someone tests files *outside* `SAGE_ROOT`.  Feeding `sage -t ...` with complex <code>\\`find ... -prune ...\\`</code> expressions is certainly pretty inconvenient.\n\nWe could of course introduce yet another Sage environment variable containing the directory names to skip... ;-)\n[and only skip them if they're really *below* the directories specified, as Nils suggested.]",
    "created_at": "2013-01-08T21:50:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167127",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:20'></a>
Replying to [@jhpalmieri](#comment%3A17):
> Replying to [@nexttime](#comment%3A15):
> > Replying to [@nathanncohen](#comment%3A13):

> 
> > > Then what's the problem with filtering the `/.` that appear in SAGE_ROOT ?

> > 
> > I'm not sure what you mean by that.  Of course RCSs' directories can be located anywhere, not just below `SAGE_ROOT`, and even for the latter aren't necessarily [just] Mercurial's `.hg` directories.

> 
> I think he means, what's wrong with just filtering subdirectories of `SAGE_ROOT` (and its subdirectories) which start with `.`? This would be consistent with Nils' suggestion.

Well, I'd say it's even *more likely* that the tree(s) contain(s) (e.g.) `.svn` or `.git` directories if someone tests files *outside* `SAGE_ROOT`.  Feeding `sage -t ...` with complex <code>\`find ... -prune ...\`</code> expressions is certainly pretty inconvenient.

We could of course introduce yet another Sage environment variable containing the directory names to skip... ;-)
[and only skip them if they're really *below* the directories specified, as Nils suggested.]



---

archive/issue_comments_167128.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [@nexttime](#comment%3A20):\n> Well, I'd say it's even *more likely* that the tree(s) contain(s) (e.g.) `.svn` or `.git` directories if someone tests files *outside* `SAGE_ROOT`.  Feeding `sage -t ...` with complex <code>\\`find ... -prune ...\\`</code> expressions is certainly pretty inconvenient.\n\nI'm happy with Nils' suggestion to not skip any directories passed explicitly as arguments, but to skip any subdirectories of those which are hidden.",
    "created_at": "2013-01-08T22:15:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167128",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>
Replying to [@nexttime](#comment%3A20):
> Well, I'd say it's even *more likely* that the tree(s) contain(s) (e.g.) `.svn` or `.git` directories if someone tests files *outside* `SAGE_ROOT`.  Feeding `sage -t ...` with complex <code>\`find ... -prune ...\`</code> expressions is certainly pretty inconvenient.

I'm happy with Nils' suggestion to not skip any directories passed explicitly as arguments, but to skip any subdirectories of those which are hidden.



---

archive/issue_comments_167129.json:
```json
{
    "body": "Rationalized dotted-name pruning procedure",
    "created_at": "2013-01-08T22:19:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167129",
    "user": "https://github.com/nbruin"
}
```

Rationalized dotted-name pruning procedure



---

archive/issue_comments_167130.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Attachment:** [13928-prune_hidden.patch.gz](https://github.com/sagemath/sage/files/ticket13928/13928-prune_hidden.patch.gz)\n\nAttached rationalized pruning patch. This walks the dirtree more efficiently, because it won't even descend into dotted names. It's also agnostic of the pathname on which it starts, so if dots are present there, things should still work.\n\nThis should allow Nathan to continue his crazy naming schemes and improve and (unnecessarily) speed up the whole procedure. There's a lot more that can be rationalized about `sage-ptest`, but I think this is at least a step in the right direction.",
    "created_at": "2013-01-08T22:22:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167130",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:22'></a>
**Attachment:** [13928-prune_hidden.patch.gz](https://github.com/sagemath/sage/files/ticket13928/13928-prune_hidden.patch.gz)

Attached rationalized pruning patch. This walks the dirtree more efficiently, because it won't even descend into dotted names. It's also agnostic of the pathname on which it starts, so if dots are present there, things should still work.

This should allow Nathan to continue his crazy naming schemes and improve and (unnecessarily) speed up the whole procedure. There's a lot more that can be rationalized about `sage-ptest`, but I think this is at least a step in the right direction.



---

archive/issue_comments_167131.json:
```json
{
    "body": "<a id='comment:23'></a>\nThis looks okay to me after some superficial testing. We should still fix the issue where if the number of files is zero, it exits with a stupid error message. One possible fix is the first patch in [comment:11]. Another option:\n\n```diff\ndiff --git a/sage-ptest b/sage-ptest\n--- a/sage-ptest\n+++ b/sage-ptest\n@@ -429,6 +429,11 @@ for gr in range(0,numglobaliteration):\n     interrupt = False\n \n     numthreads = min(numthreads, len(files))  # don't use more threads than files\n+    if len(files) == 0:\n+        print \"\"\"\n+Warning: no files to test!\n+\"\"\"\n+        sys.exit(0)\n         \n     if len(files) == 1:\n         file_str = \"1 file\"\n```",
    "created_at": "2013-01-08T22:32:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167131",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>
This looks okay to me after some superficial testing. We should still fix the issue where if the number of files is zero, it exits with a stupid error message. One possible fix is the first patch in [comment:11]. Another option:

```diff
diff --git a/sage-ptest b/sage-ptest
--- a/sage-ptest
+++ b/sage-ptest
@@ -429,6 +429,11 @@ for gr in range(0,numglobaliteration):
     interrupt = False
 
     numthreads = min(numthreads, len(files))  # don't use more threads than files
+    if len(files) == 0:
+        print """
+Warning: no files to test!
+"""
+        sys.exit(0)
         
     if len(files) == 1:
         file_str = "1 file"
```



---

archive/issue_comments_167132.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [@jhpalmieri](#comment%3A23):\n> This looks okay to me after some superficial testing. We should still fix the issue where if the number of files is zero, it exits with a stupid error message. One possible fix is the first patch in [comment:11]. Another option:\n> \n> ```diff\n> diff --git a/sage-ptest b/sage-ptest\n> --- a/sage-ptest\n> +++ b/sage-ptest\n> @@ -429,6 +429,11 @@ for gr in range(0,numglobaliteration):\n>      interrupt = False\n>  \n>      numthreads = min(numthreads, len(files))  # don't use more threads than files\n> +    if len(files) == 0:\n> +        print \"\"\"\n> +Warning: no files to test!\n> +\"\"\"\n> +        sys.exit(0)\n>          \n>      if len(files) == 1:\n>          file_str = \"1 file\"\n> ```\n\nI prefer the latter.  Although it should still inform the user how long it took to doctest 0 files, similar to what `sage -b` does (\"Time to execute 0 commands ...\").\n\nNo, seriously, a warning would IMHO only make sense if we print it for every *specified* directory that didn't contain files to test.  (If no files remain at all, it's obvious that no file got tested, and from a script one would presumably just test the exit status, which [in what you propose] is 0 anyway.)",
    "created_at": "2013-01-08T23:03:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167132",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:24'></a>
Replying to [@jhpalmieri](#comment%3A23):
> This looks okay to me after some superficial testing. We should still fix the issue where if the number of files is zero, it exits with a stupid error message. One possible fix is the first patch in [comment:11]. Another option:
> 
> ```diff
> diff --git a/sage-ptest b/sage-ptest
> --- a/sage-ptest
> +++ b/sage-ptest
> @@ -429,6 +429,11 @@ for gr in range(0,numglobaliteration):
>      interrupt = False
>  
>      numthreads = min(numthreads, len(files))  # don't use more threads than files
> +    if len(files) == 0:
> +        print """
> +Warning: no files to test!
> +"""
> +        sys.exit(0)
>          
>      if len(files) == 1:
>          file_str = "1 file"
> ```

I prefer the latter.  Although it should still inform the user how long it took to doctest 0 files, similar to what `sage -b` does ("Time to execute 0 commands ...").

No, seriously, a warning would IMHO only make sense if we print it for every *specified* directory that didn't contain files to test.  (If no files remain at all, it's obvious that no file got tested, and from a script one would presumably just test the exit status, which [in what you propose] is 0 anyway.)



---

archive/issue_comments_167133.json:
```json
{
    "body": "<a id='comment:25'></a>\nP.S.:  From a mathematical perspective, one should still print \"All tests passed!\" of course.",
    "created_at": "2013-01-08T23:05:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167133",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:25'></a>
P.S.:  From a mathematical perspective, one should still print "All tests passed!" of course.



---

archive/issue_comments_167134.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [@nexttime](#comment%3A16):\n> I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so\n\nThat is absolutely untrue. You're probably refering to #5852, but that was about *fixing* the way *how* `sage` resolves symbolic links. I never made the decision to resolve all symbolic links in `SAGE_ROOT`.",
    "created_at": "2013-01-09T07:11:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167134",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Replying to [@nexttime](#comment%3A16):
> I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so

That is absolutely untrue. You're probably refering to #5852, but that was about *fixing* the way *how* `sage` resolves symbolic links. I never made the decision to resolve all symbolic links in `SAGE_ROOT`.



---

archive/issue_comments_167135.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [@jdemeyer](#comment%3A26):\n> Replying to [@nexttime](#comment%3A16):\n> > I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so\n\n> That is absolutely untrue. You're probably refering to #5852, but that was about *fixing* the way *how* `sage` resolves symbolic links. I never made the decision to resolve all symbolic links in `SAGE_ROOT`.\n\nWell, we used `realpath()` and the like in a few places (mostly to check whether two filenames actually refer to the same file), but never fully \"expanded\" `SAGE_ROOT` \"from the beginning\", i.e., in the main `sage` script.  I recall you implemented the latter, so it's IMHO fair to say (or assume) you were in favour of doing so...\n\nSince then, nearly no Sage component ever sees what the user specified (or is willing to use), hence presents the user only and always the fully dereferenced form, which is certainly annoying to a couple of people (and also causes some technical trouble, as mentioned earlier).",
    "created_at": "2013-01-09T16:16:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167135",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:27'></a>
Replying to [@jdemeyer](#comment%3A26):
> Replying to [@nexttime](#comment%3A16):
> > I was always against resolving all symbolic links in `SAGE_ROOT`, but Jeroen decided to do so

> That is absolutely untrue. You're probably refering to #5852, but that was about *fixing* the way *how* `sage` resolves symbolic links. I never made the decision to resolve all symbolic links in `SAGE_ROOT`.

Well, we used `realpath()` and the like in a few places (mostly to check whether two filenames actually refer to the same file), but never fully "expanded" `SAGE_ROOT` "from the beginning", i.e., in the main `sage` script.  I recall you implemented the latter, so it's IMHO fair to say (or assume) you were in favour of doing so...

Since then, nearly no Sage component ever sees what the user specified (or is willing to use), hence presents the user only and always the fully dereferenced form, which is certainly annoying to a couple of people (and also causes some technical trouble, as mentioned earlier).



---

archive/issue_comments_167136.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [@nexttime](#comment%3A27):\n> never fully \"expanded\" `SAGE_ROOT` \"from the beginning\", i.e., in the main `sage` script.  I recall you implemented the latter\n\nThis is not true, go and read the patch at #5852 and notice that\n\n```\nSAGE_ROOT=`realpath    \"$0\" 2> /dev/null` || \\\n```\nwas already there.",
    "created_at": "2013-01-09T16:20:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167136",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Replying to [@nexttime](#comment%3A27):
> never fully "expanded" `SAGE_ROOT` "from the beginning", i.e., in the main `sage` script.  I recall you implemented the latter

This is not true, go and read the patch at #5852 and notice that

```
SAGE_ROOT=`realpath    "$0" 2> /dev/null` || \
```
was already there.



---

archive/issue_comments_167137.json:
```json
{
    "body": "**Changing author** from \"Nathann Cohen\" to \"Nils Bruin, John H Palmieri\".",
    "created_at": "2013-01-10T15:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167137",
    "user": "https://github.com/nathanncohen"
}
```

**Changing author** from "Nathann Cohen" to "Nils Bruin, John H Palmieri".



---

archive/issue_comments_167138.json:
```json
{
    "body": "<a id='comment:29'></a>\nHere it is ! Do you like it this way ? `:-)`\n\nNathann",
    "created_at": "2013-01-10T15:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167138",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:29'></a>
Here it is ! Do you like it this way ? `:-)`

Nathann



---

archive/issue_comments_167139.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Attachment:** [trac_13928.patch.gz](https://github.com/sagemath/sage/files/ticket13928/trac_13928.patch.gz)\n\nHello ! Could someone give this short patch a review ? I almost forgot its very existence `^^;`\n\nNathann",
    "created_at": "2013-02-22T09:13:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167139",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:30'></a>
**Attachment:** [trac_13928.patch.gz](https://github.com/sagemath/sage/files/ticket13928/trac_13928.patch.gz)

Hello ! Could someone give this short patch a review ? I almost forgot its very existence `^^;`

Nathann



---

archive/issue_comments_167140.json:
```json
{
    "body": "<a id='comment:31'></a>\nHi Nathann,\n\nIt looks like this will be superseded by the work at #12415: at least, the patches there completely remove the file sage-ptest. So I think we should close this and you should take the discussion there. Note that there has been a lot of activity on that ticket lately \u2013 it has not stagnated \u2013 and putting in a patch here would just cause them to rebase. Also, they may still be ignoring paths containing \"/.\", so you should intervene if you want that changed.",
    "created_at": "2013-02-26T15:43:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167140",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:31'></a>
Hi Nathann,

It looks like this will be superseded by the work at #12415: at least, the patches there completely remove the file sage-ptest. So I think we should close this and you should take the discussion there. Note that there has been a lot of activity on that ticket lately – it has not stagnated – and putting in a patch here would just cause them to rebase. Also, they may still be ignoring paths containing "/.", so you should intervene if you want that changed.



---

archive/issue_comments_167141.json:
```json
{
    "body": "<a id='comment:32'></a>\nOkay, I was wrong. It looks like #12415 will ignore files in directories starting with \".\" within the Sage library, but they will have no problem testing files if the entire Sage directory is contained in \"/home/user/.Sage/...\". So I propose we don't work further on this ticket and just wait for #12415 (or help with it, if that's possible).",
    "created_at": "2013-02-26T16:48:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167141",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:32'></a>
Okay, I was wrong. It looks like #12415 will ignore files in directories starting with "." within the Sage library, but they will have no problem testing files if the entire Sage directory is contained in "/home/user/.Sage/...". So I propose we don't work further on this ticket and just wait for #12415 (or help with it, if that's possible).



---

archive/issue_events_165784.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-02-26T17:01:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165784"
}
```



---

archive/issue_comments_167142.json:
```json
{
    "body": "<a id='comment:33'></a>\nThank you for telling me ! `:-)`\n\nNathann\n\n(This ticket is to be closed, as #12415 will do the job)",
    "created_at": "2013-02-26T17:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167142",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:33'></a>
Thank you for telling me ! `:-)`

Nathann

(This ticket is to be closed, as #12415 will do the job)



---

archive/issue_events_165785.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-02-26T17:01:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165785"
}
```



---

archive/issue_events_165786.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2013-02-26T17:01:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165786"
}
```



---

archive/issue_events_165787.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T08:10:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "008080",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165787"
}
```



---

archive/issue_comments_167143.json:
```json
{
    "body": "**Changing author** from \"Nils Bruin, John H Palmieri\" to \"\".",
    "created_at": "2013-03-07T08:10:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167143",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Nils Bruin, John H Palmieri" to "".



---

archive/issue_events_165788.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T08:10:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165788"
}
```



---

archive/issue_events_165789.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T08:10:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13928#event-165789"
}
```



---

archive/issue_comments_167144.json:
```json
{
    "body": "**Reviewer:** Nils Bruin, John H Palmieri",
    "created_at": "2013-03-07T08:10:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167144",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Nils Bruin, John H Palmieri



---

archive/issue_comments_167145.json:
```json
{
    "body": "**Changing reviewer** from \"Nils Bruin, John H Palmieri\" to \"Nils Bruin, John Palmieri\".",
    "created_at": "2013-04-25T12:58:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13928#issuecomment-167145",
    "user": "https://github.com/jdemeyer"
}
```

**Changing reviewer** from "Nils Bruin, John H Palmieri" to "Nils Bruin, John Palmieri".
