# Issue 13589: Controlling C3 to solve once for all the Method Resolution Order issues for category classes

archive/issues_013385.json:
```json
{
    "assignees": [],
    "body": "\n```rst\nTeaser\n------\n\nPython handles multiple inheritance by computing, for each class,\na linear extension of all its super classes (the Method Resolution\nOrder, MRO). The MRO is calculated recursively from local\ninformation (the *ordered* list of the direct super classes), with\nthe so-called ``C3`` algorithm. This algorithm can fail if the local\ninformation is not consistent; worst, there exist hiearchies of\nclasses with provably no consistent local information.\n\nFor large hierarchy of classes, like those derived from categories in\nSage, maintaining consistent local information by hand does not scale\nand leads to unpredictable ``C3`` failures (the dreaded \"could not\nfind a consistent method resolution order\"); a maintenance nightmare.\n\nThis patch implements a final solution to this problem. Namely, it\nallows for building automatically the local information from the bare\nclass hierarchy in such a way that guarantees that the ``C3``\nalgorithm will never fail.\n\nErr, but you said that this was provably impossible? Well, not if\none relaxes a bit the hypotheses, but that's not something one\nwould want to do by hand :-)\n\nDetails\n-------\n\nPlease see the extensive documentation at the top of the file\nsage/misc/c3_controlled.py in the attached patch.\n\nContent of the patch\n--------------------\n\n- Implement controlled C3 in sage.misc.c3_controlled.\n\n- Implement a total order in Category, and have Category use\n  C3 controlled by this order instead of plain C3.\n\n- Tweak the current total order to minimize changes in the order of\n  categories.\n\n- Update doctests w.r.t. remaining changes of in the order of\n  categories.\n\n- Remove a coupld doctests displaying \"all_super_categories\" that did not bring useful information to the user nor intesting test, yet needed to be constantly updated; nothing but a good source of conflicts.\n\n- Rewrite doctests in sage.misc.c3 to be independent of categories\n  since those do not use anymore this implementation of C3.\n\n- Resolve some ambiguities to make the code more independent of the\n  order of categories. In particular, FiniteCoxeterGroups prefer\n  __iter__ and some_elements from CoxeterGroups to that of\n  FiniteGroups.\n\n- Update the section in the primer about order of categories.\n\n- Provide further tools in ``sage.misc.c3_controlled`` to\n  experiment with C3 and friends.\n\n- Extract category_sample from category_graph\n\nCredits\n-------\n\nThis patch is a followup to a study of the C3 algorithm together with\nFlorent Hivert, and to discussions with Simon King and his\nimplementation of C3.\n```\n\n**__Apply__**\n\n- [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)\n\n\nDepends on #12894\n\nDepends on #12876\n\nDepends on #11935\n\nDepends on #12895\n\nDepends on #10193\n\n**Assignee:** @nthiery\n\n**CC:**  sage-combinat @simon-king-jena\n\n**Keywords:** method resolution order, C3\n\n**Reviewer:** Simon King, Florent Hivert\n\n**Author:** Nicolas M. Thi\u00e9ry, Simon King\n\n**Merged:** sage-5.12.beta0\n\nIssue created by migration from https://trac.sagemath.org/ticket/13589\n\n",
    "closed_at": "2013-08-02T14:15:01Z",
    "created_at": "2012-10-09T10:11:07Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20categories",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.12",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Controlling C3 to solve once for all the Method Resolution Order issues for category classes",
    "type": "issue",
    "updated_at": "2014-10-06T16:59:02Z",
    "url": "https://github.com/sagemath/sage/issues/13589",
    "user": "https://github.com/nthiery"
}
```

```rst
Teaser
------

Python handles multiple inheritance by computing, for each class,
a linear extension of all its super classes (the Method Resolution
Order, MRO). The MRO is calculated recursively from local
information (the *ordered* list of the direct super classes), with
the so-called ``C3`` algorithm. This algorithm can fail if the local
information is not consistent; worst, there exist hiearchies of
classes with provably no consistent local information.

For large hierarchy of classes, like those derived from categories in
Sage, maintaining consistent local information by hand does not scale
and leads to unpredictable ``C3`` failures (the dreaded "could not
find a consistent method resolution order"); a maintenance nightmare.

This patch implements a final solution to this problem. Namely, it
allows for building automatically the local information from the bare
class hierarchy in such a way that guarantees that the ``C3``
algorithm will never fail.

Err, but you said that this was provably impossible? Well, not if
one relaxes a bit the hypotheses, but that's not something one
would want to do by hand :-)

Details
-------

Please see the extensive documentation at the top of the file
sage/misc/c3_controlled.py in the attached patch.

Content of the patch
--------------------

- Implement controlled C3 in sage.misc.c3_controlled.

- Implement a total order in Category, and have Category use
  C3 controlled by this order instead of plain C3.

- Tweak the current total order to minimize changes in the order of
  categories.

- Update doctests w.r.t. remaining changes of in the order of
  categories.

- Remove a coupld doctests displaying "all_super_categories" that did not bring useful information to the user nor intesting test, yet needed to be constantly updated; nothing but a good source of conflicts.

- Rewrite doctests in sage.misc.c3 to be independent of categories
  since those do not use anymore this implementation of C3.

- Resolve some ambiguities to make the code more independent of the
  order of categories. In particular, FiniteCoxeterGroups prefer
  __iter__ and some_elements from CoxeterGroups to that of
  FiniteGroups.

- Update the section in the primer about order of categories.

- Provide further tools in ``sage.misc.c3_controlled`` to
  experiment with C3 and friends.

- Extract category_sample from category_graph

Credits
-------

This patch is a followup to a study of the C3 algorithm together with
Florent Hivert, and to discussions with Simon King and his
implementation of C3.
```

**__Apply__**

- [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)


Depends on #12894

Depends on #12876

Depends on #11935

Depends on #12895

Depends on #10193

**Assignee:** @nthiery

**CC:**  sage-combinat @simon-king-jena

**Keywords:** method resolution order, C3

**Reviewer:** Simon King, Florent Hivert

**Author:** Nicolas M. Thi√©ry, Simon King

**Merged:** sage-5.12.beta0

Issue created by migration from https://trac.sagemath.org/ticket/13589





---

archive/issue_events_160879.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2012-10-09T10:11:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160879"
}
```



---

archive/issue_events_160880.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2012-10-09T10:11:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20categories",
    "label_color": "08517b",
    "label_name": "component: categories",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160880"
}
```



---

archive/issue_events_160881.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2012-10-09T10:11:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160881"
}
```



---

archive/issue_comments_161325.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -20,10 +20,24 @@\n one relaxes a bit the hypotheses, but that's not something one\n would want to do by hand :-)\n \n+Details\n \n+---\n \n-Details: please see the extensive documentation at the top of the file sage/misc/c3_controlled.py in the attached patch.\n+Please see the extensive documentation at the top of the file sage/misc/c3_controlled.py in the attached patch.\n \n-Status: the patch is functional, but still breaks a couple things here and there. In particular, some doctests need to be updated w.r.t. some changes in MRO and super_categories output. I will fix this as soon as the principle will be accepted.\n+Status\n \n-Credits: this patch is a followup to a study of the C3 algorithm together with Florent Hivert, and to discussions with Simon King and his implementation of C3.\n+---\n+\n+The patch is functional, but still breaks a couple things here and there. In particular, some doctests need to be updated w.r.t. some changes in MRO and super_categories output. I will fix this as soon as the principle will be accepted.\n+\n+The patch is also available on the Sage-Combinat queue (guarded out by\n+default by +functorial_construction).\n+\n+Credits\n+\n+---\n+\n+This patch is a followup to a study of the C3 algorithm together with Florent Hivert, and to discussions with Simon King and his implementation of C3.\n+\n``````\n",
    "created_at": "2012-10-09T10:18:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161325",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -20,10 +20,24 @@
 one relaxes a bit the hypotheses, but that's not something one
 would want to do by hand :-)
 
+Details
 
+---
 
-Details: please see the extensive documentation at the top of the file sage/misc/c3_controlled.py in the attached patch.
+Please see the extensive documentation at the top of the file sage/misc/c3_controlled.py in the attached patch.
 
-Status: the patch is functional, but still breaks a couple things here and there. In particular, some doctests need to be updated w.r.t. some changes in MRO and super_categories output. I will fix this as soon as the principle will be accepted.
+Status
 
-Credits: this patch is a followup to a study of the C3 algorithm together with Florent Hivert, and to discussions with Simon King and his implementation of C3.
+---
+
+The patch is functional, but still breaks a couple things here and there. In particular, some doctests need to be updated w.r.t. some changes in MRO and super_categories output. I will fix this as soon as the principle will be accepted.
+
+The patch is also available on the Sage-Combinat queue (guarded out by
+default by +functorial_construction).
+
+Credits
+
+---
+
+This patch is a followup to a study of the C3 algorithm together with Florent Hivert, and to discussions with Simon King and his implementation of C3.
+
``````




---

archive/issue_comments_161326.json:
```json
{
    "body": "**Changing dependencies** from \"#13501\" to \"#13501, #12894\".",
    "created_at": "2012-10-09T10:21:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161326",
    "user": "https://github.com/nthiery"
}
```

**Changing dependencies** from "#13501" to "#13501, #12894".



---

archive/issue_comments_161327.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nHello,\n\nCould you update your patch, there is several hunk in the last sage versions (i work without combinat to use NCSF...)\n\n```\npatching file sage/categories/category.py\nHunk #6 FAILED at 1090\nHunk #7 FAILED at 1200\nHunk #9 FAILED at 2003\nHunk #10 FAILED at 2084\n4 out of 11 hunks FAILED -- saving rejects to file sage/categories/category.py.rej\nabort: patch failed to apply\n```\n\nFurthermore, it could be useful to add that quickly in sage. The graded Hopf algebras seems to be the last bastion before recurrent MRO errors.\n\nThanks, Jean-Baptiste",
    "created_at": "2013-05-10T09:30:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161327",
    "user": "https://github.com/sagetrac-elixyre"
}
```

<a id='comment:3'>**Comment 3:**</a>
Hello,

Could you update your patch, there is several hunk in the last sage versions (i work without combinat to use NCSF...)

```
patching file sage/categories/category.py
Hunk #6 FAILED at 1090
Hunk #7 FAILED at 1200
Hunk #9 FAILED at 2003
Hunk #10 FAILED at 2084
4 out of 11 hunks FAILED -- saving rejects to file sage/categories/category.py.rej
abort: patch failed to apply
```

Furthermore, it could be useful to add that quickly in sage. The graded Hopf algebras seems to be the last bastion before recurrent MRO errors.

Thanks, Jean-Baptiste



---

archive/issue_comments_161328.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nI currently have\n\n```\ntrac_14159_weak_value_triple_dict.patch\ntrac_14159_use_cdef_get.patch\ntrac_13184_sage_5.9.beta.patch\ntrac_14287-rebased.patch\ntrac_14217_base_functionality.patch\ntrac_12876_category_abstract_classes_for_hom.patch\ntrac11935_weak_pickling_by_construction-nt.patch\ntrac_11935-weak_pickling_by_construction-review-ts.patch\ntrac_14249-coercion_without_an_element.patch\ntrac_12894-classcall_setter-nt.patch\ntrac_12895-subcategory-methods-nt.patch\ntrac_12895-review.patch\n```\non top of sage-5.9.rc0 (these all have positive review or are even merged in sage-5.10.beta), and then the patch fails to apply like this:\n\n```\nF\u00fcge trac_13589-categories-c3_under_control-nt.patch zur Seriendatei hinzu\nWende trac_13589-categories-c3_under_control-nt.patch an\nWende Patch auf Datei sage/categories/category.py an\nFEHLSCHLAG von Teilst\u00fcck #1 in Zeile 94\nTeilst\u00fcck #6 wurde erfolgreich in Zeile 1105 mit Unsch\u00e4rfe 1 angewandt (16 Zeilen verschoben).\nFEHLSCHLAG von Teilst\u00fcck #7 in Zeile 1289\nTeilst\u00fcck #9 wurde erfolgreich in Zeile 2152 mit Unsch\u00e4rfe 1 angewandt (58 Zeilen verschoben).\n2 von 11 Teilst\u00fccken sind FEHLGESCHLAGEN -- speichere Ausschuss in Datei sage/categories/category.py.rej\nPatch schlug fehl und Fortsetzung unm\u00f6glich (versuche -v)\nPatch schlug fehl, Fehlerabschnitte noch im Arbeitsverzeichnis\nFehler beim Anwenden. Bitte beheben und trac_13589-categories-c3_under_control-nt.patch aktualisieren\n```\n\nSo, there is some improvement with respect to what Jean-Baptiste reports. Nevertheless, it seems that dependencies should be stated, and probably the patch needs rebasing.",
    "created_at": "2013-05-25T07:29:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161328",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'>**Comment 4:**</a>
I currently have

```
trac_14159_weak_value_triple_dict.patch
trac_14159_use_cdef_get.patch
trac_13184_sage_5.9.beta.patch
trac_14287-rebased.patch
trac_14217_base_functionality.patch
trac_12876_category_abstract_classes_for_hom.patch
trac11935_weak_pickling_by_construction-nt.patch
trac_11935-weak_pickling_by_construction-review-ts.patch
trac_14249-coercion_without_an_element.patch
trac_12894-classcall_setter-nt.patch
trac_12895-subcategory-methods-nt.patch
trac_12895-review.patch
```
on top of sage-5.9.rc0 (these all have positive review or are even merged in sage-5.10.beta), and then the patch fails to apply like this:

```
F√ºge trac_13589-categories-c3_under_control-nt.patch zur Seriendatei hinzu
Wende trac_13589-categories-c3_under_control-nt.patch an
Wende Patch auf Datei sage/categories/category.py an
FEHLSCHLAG von Teilst√ºck #1 in Zeile 94
Teilst√ºck #6 wurde erfolgreich in Zeile 1105 mit Unsch√§rfe 1 angewandt (16 Zeilen verschoben).
FEHLSCHLAG von Teilst√ºck #7 in Zeile 1289
Teilst√ºck #9 wurde erfolgreich in Zeile 2152 mit Unsch√§rfe 1 angewandt (58 Zeilen verschoben).
2 von 11 Teilst√ºcken sind FEHLGESCHLAGEN -- speichere Ausschuss in Datei sage/categories/category.py.rej
Patch schlug fehl und Fortsetzung unm√∂glich (versuche -v)
Patch schlug fehl, Fehlerabschnitte noch im Arbeitsverzeichnis
Fehler beim Anwenden. Bitte beheben und trac_13589-categories-c3_under_control-nt.patch aktualisieren
```

So, there is some improvement with respect to what Jean-Baptiste reports. Nevertheless, it seems that dependencies should be stated, and probably the patch needs rebasing.



---

archive/issue_comments_161329.json:
```json
{
    "body": "<a id='comment:5'>**Comment 5:**</a>\nIn particular, the patch uses some `CategoryWithAxiom`, which is not defined here or in the given dependencies.",
    "created_at": "2013-05-25T07:48:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161329",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'>**Comment 5:**</a>
In particular, the patch uses some `CategoryWithAxiom`, which is not defined here or in the given dependencies.



---

archive/issue_comments_161330.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nI have not been able to find `CategoryWithAxiom` or `category with axiom` on trac.",
    "created_at": "2013-05-25T07:50:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161330",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'>**Comment 6:**</a>
I have not been able to find `CategoryWithAxiom` or `category with axiom` on trac.



---

archive/issue_comments_161331.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nYes, this patch still needs a bit of work. It should be ready tuesday or so. You can have a look at the text in the patch where I describe the purpose and principle of the patch, but don't waste time with a more detailed review at this point!\n\nThanks!",
    "created_at": "2013-05-25T13:35:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161331",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:7'>**Comment 7:**</a>
Yes, this patch still needs a bit of work. It should be ready tuesday or so. You can have a look at the text in the patch where I describe the purpose and principle of the patch, but don't waste time with a more detailed review at this point!

Thanks!



---

archive/issue_comments_161332.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nHi Nicolas,\n\nOK, I thought this is next, after #11935.\n\nBest regards,\n Simon",
    "created_at": "2013-05-25T13:38:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161332",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'>**Comment 8:**</a>
Hi Nicolas,

OK, I thought this is next, after #11935.

Best regards,
 Simon



---

archive/issue_comments_161333.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\n#12895 was next! And now I have to run behind :-)\nThanks for all your review work! I'll pile up some stuff for you soon and let you know :-)",
    "created_at": "2013-05-25T13:53:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161333",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:9'>**Comment 9:**</a>
#12895 was next! And now I have to run behind :-)
Thanks for all your review work! I'll pile up some stuff for you soon and let you know :-)



---

archive/issue_comments_161334.json:
```json
{
    "body": "**Changing dependencies** from \"#13501, #12894\" to \"#13501, #12894, #12895\".",
    "created_at": "2013-05-31T04:39:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161334",
    "user": "https://github.com/nthiery"
}
```

**Changing dependencies** from "#13501, #12894" to "#13501, #12894, #12895".



---

archive/issue_events_160882.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2013-05-31T04:39:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160882"
}
```



---

archive/issue_comments_161335.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nHi Simon,\n\nThe updated patch should be roughly close to completion. Most if not all tests should pass (they did when I was working on the patch in git; I may have screwed up my export back to mercurial, and/or some dependencies).\n\nI still need to scan once again through the patch to check that everything is 100% doctested, and I also want to reread the explanations in sage.misc.c3_controlled. I'll do that tomorrow. But I think you can start reviewing it in particular checking whether the whole logic makes sense to you. Let me know if/when you start working on it so that we avoid conflicts.\n\nThanks!\n                                Nicolas",
    "created_at": "2013-05-31T04:44:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161335",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:11'>**Comment 11:**</a>
Hi Simon,

The updated patch should be roughly close to completion. Most if not all tests should pass (they did when I was working on the patch in git; I may have screwed up my export back to mercurial, and/or some dependencies).

I still need to scan once again through the patch to check that everything is 100% doctested, and I also want to reread the explanations in sage.misc.c3_controlled. I'll do that tomorrow. But I think you can start reviewing it in particular checking whether the whole logic makes sense to you. Let me know if/when you start working on it so that we avoid conflicts.

Thanks!
                                Nicolas



---

archive/issue_comments_161336.json:
```json
{
    "body": "**Changing dependencies** from \"#13501, #12894, #12895\" to \"#13501, #12894, #12876, #11935, #12895\".",
    "created_at": "2013-05-31T04:45:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161336",
    "user": "https://github.com/nthiery"
}
```

**Changing dependencies** from "#13501, #12894, #12895" to "#13501, #12894, #12876, #11935, #12895".



---

archive/issue_comments_161337.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nFor info: I am running the tests now and will report when I wake up.",
    "created_at": "2013-05-31T04:45:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161337",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:13'>**Comment 13:**</a>
For info: I am running the tests now and will report when I wake up.



---

archive/issue_comments_161338.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nAll long tests passed on my machine with 5.10beta4 and the following patches applied:\n\n```\ntrac_14612-gyw_test_speedup-ts.patch\ntrac_14574-folded.patch\ntrac_13735_fix_repr_lincomb.patch\ntrac_14123-binary-trees-maps-rebase-cs.patch\ntrac_12876_category_abstract_classes_for_hom.patch\ntrac11935_weak_pickling_by_construction-nt.patch\ntrac_11935-weak_pickling_by_construction-review-ts.patch\ntrac_12895-subcategory-methods-nt.patch\ntrac_13589-categories-c3_under_control-nt.patch\n```",
    "created_at": "2013-05-31T10:37:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161338",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:14'>**Comment 14:**</a>
All long tests passed on my machine with 5.10beta4 and the following patches applied:

```
trac_14612-gyw_test_speedup-ts.patch
trac_14574-folded.patch
trac_13735_fix_repr_lincomb.patch
trac_14123-binary-trees-maps-rebase-cs.patch
trac_12876_category_abstract_classes_for_hom.patch
trac11935_weak_pickling_by_construction-nt.patch
trac_11935-weak_pickling_by_construction-review-ts.patch
trac_12895-subcategory-methods-nt.patch
trac_13589-categories-c3_under_control-nt.patch
```



---

archive/issue_comments_161339.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\nOk, patchbot is happy too except for coverage in c3_controlled, doctest continuations, startup time and startup modules. The two first ones will be easy fixes. I'll investigate the two others this morning.",
    "created_at": "2013-05-31T10:42:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161339",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:15'>**Comment 15:**</a>
Ok, patchbot is happy too except for coverage in c3_controlled, doctest continuations, startup time and startup modules. The two first ones will be easy fixes. I'll investigate the two others this morning.



---

archive/issue_comments_161340.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -24,20 +24,48 @@\n \n ---\n \n-Please see the extensive documentation at the top of the file sage/misc/c3_controlled.py in the attached patch.\n+Please see the extensive documentation at the top of the file\n+sage/misc/c3_controlled.py in the attached patch.\n+\n+Content of the patch\n+\n+---\n+\n+- Implement controlled C3 in sage.misc.c3_controlled.\n+\n+- Implement a total order in Category, and have Category use\n+  c3 controlled by this order instead of plain c3.\n+\n+- Tweak the current total order to minimize changes in the order of\n+  categories.\n+\n+- Update doctests w.r.t. remaining changes of in the order of\n+  categories.\n+\n+- Rewrite doctests in sage.misc.c3 to be independent of categories\n+  since those do not use anymore this implementation of C3.\n+\n+- Resolve some ambiguities to make the code more independent of the\n+  order of categories. In particular, FiniteCoxeterGroups prefer\n+  `__iter__` and some_elements from CoxeterGroups to that of\n+  FiniteGroups.\n+\n+- Update the section in the primer about order of categories.\n+\n+- Provide further tools in :mod:`sage.misc.c3_controlled` to\n+  experiment with C3 and friends.\n \n Status\n \n ---\n \n-The patch is functional, but still breaks a couple things here and there. In particular, some doctests need to be updated w.r.t. some changes in MRO and super_categories output. I will fix this as soon as the principle will be accepted.\n-\n-The patch is also available on the Sage-Combinat queue (guarded out by\n-default by +functorial_construction).\n+Completely ready for review.\n \n Credits\n \n ---\n \n-This patch is a followup to a study of the C3 algorithm together with Florent Hivert, and to discussions with Simon King and his implementation of C3.\n+This patch is a followup to a study of the C3 algorithm together with\n+Florent Hivert, and to discussions with Simon King and his\n+implementation of C3.\n \n``````\n",
    "created_at": "2013-05-31T17:14:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161340",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -24,20 +24,48 @@
 
 ---
 
-Please see the extensive documentation at the top of the file sage/misc/c3_controlled.py in the attached patch.
+Please see the extensive documentation at the top of the file
+sage/misc/c3_controlled.py in the attached patch.
+
+Content of the patch
+
+---
+
+- Implement controlled C3 in sage.misc.c3_controlled.
+
+- Implement a total order in Category, and have Category use
+  c3 controlled by this order instead of plain c3.
+
+- Tweak the current total order to minimize changes in the order of
+  categories.
+
+- Update doctests w.r.t. remaining changes of in the order of
+  categories.
+
+- Rewrite doctests in sage.misc.c3 to be independent of categories
+  since those do not use anymore this implementation of C3.
+
+- Resolve some ambiguities to make the code more independent of the
+  order of categories. In particular, FiniteCoxeterGroups prefer
+  `__iter__` and some_elements from CoxeterGroups to that of
+  FiniteGroups.
+
+- Update the section in the primer about order of categories.
+
+- Provide further tools in :mod:`sage.misc.c3_controlled` to
+  experiment with C3 and friends.
 
 Status
 
 ---
 
-The patch is functional, but still breaks a couple things here and there. In particular, some doctests need to be updated w.r.t. some changes in MRO and super_categories output. I will fix this as soon as the principle will be accepted.
-
-The patch is also available on the Sage-Combinat queue (guarded out by
-default by +functorial_construction).
+Completely ready for review.
 
 Credits
 
 ---
 
-This patch is a followup to a study of the C3 algorithm together with Florent Hivert, and to discussions with Simon King and his implementation of C3.
+This patch is a followup to a study of the C3 algorithm together with
+Florent Hivert, and to discussions with Simon King and his
+implementation of C3.
 
``````




---

archive/issue_comments_161341.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\nHi Simon,\n\nThe patch is now completely ready for review:\n- I fixed the coverage and continuation issue. \n- I cythoned sage.misc.c3_controlled; hopefuly this will fix the startup time regression\n- I went through the whole module, improved the doc and threw away some scories.\n- I don't know why the bot complains about the non existent modules sage.categories.inspect and itertools. I guess its just confused. As for sage.misc.c3_controlled, well yes, it's new :-)\n- I am running all long tests, and will report soon.\n\nThanks for your upcoming review!\n\nOff to work on the main functorial construction patch!\n\n                          Nicolas",
    "created_at": "2013-05-31T17:19:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161341",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:17'>**Comment 17:**</a>
Hi Simon,

The patch is now completely ready for review:
- I fixed the coverage and continuation issue. 
- I cythoned sage.misc.c3_controlled; hopefuly this will fix the startup time regression
- I went through the whole module, improved the doc and threw away some scories.
- I don't know why the bot complains about the non existent modules sage.categories.inspect and itertools. I guess its just confused. As for sage.misc.c3_controlled, well yes, it's new :-)
- I am running all long tests, and will report soon.

Thanks for your upcoming review!

Off to work on the main functorial construction patch!

                          Nicolas



---

archive/issue_comments_161342.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nOops, I had forgotten a little improvement I wanted to do in the implementation of the total order. It looks a tiny bit less hacky now and could be a tiny bit faster.\n\nAll test pass. Running long tests now.",
    "created_at": "2013-05-31T18:35:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161342",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:18'>**Comment 18:**</a>
Oops, I had forgotten a little improvement I wanted to do in the implementation of the total order. It looks a tiny bit less hacky now and could be a tiny bit faster.

All test pass. Running long tests now.



---

archive/issue_comments_161343.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nGosh, I had fumbled my export and uploaded the wrong patch. Fixed!",
    "created_at": "2013-05-31T19:01:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161343",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:19'>**Comment 19:**</a>
Gosh, I had fumbled my export and uploaded the wrong patch. Fixed!



---

archive/issue_comments_161344.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,8 @@\n+\n+```rst\n+Teaser\n+------\n+\n Python handles multiple inheritance by computing, for each class,\n a linear extension of all its super classes (the Method Resolution\n Order, MRO). The MRO is calculated recursively from local\n@@ -21,20 +26,18 @@\n would want to do by hand :-)\n \n Details\n-\n----\n+-------\n \n Please see the extensive documentation at the top of the file\n sage/misc/c3_controlled.py in the attached patch.\n \n Content of the patch\n-\n----\n+--------------------\n \n - Implement controlled C3 in sage.misc.c3_controlled.\n \n - Implement a total order in Category, and have Category use\n-  c3 controlled by this order instead of plain c3.\n+  C3 controlled by this order instead of plain C3.\n \n - Tweak the current total order to minimize changes in the order of\n   categories.\n@@ -47,25 +50,19 @@\n \n - Resolve some ambiguities to make the code more independent of the\n   order of categories. In particular, FiniteCoxeterGroups prefer\n-  `__iter__` and some_elements from CoxeterGroups to that of\n+  __iter__ and some_elements from CoxeterGroups to that of\n   FiniteGroups.\n \n - Update the section in the primer about order of categories.\n \n-- Provide further tools in :mod:`sage.misc.c3_controlled` to\n+- Provide further tools in ``sage.misc.c3_controlled`` to\n   experiment with C3 and friends.\n \n-Status\n-\n----\n-\n-Completely ready for review.\n-\n Credits\n-\n----\n+-------\n \n This patch is a followup to a study of the C3 algorithm together with\n Florent Hivert, and to discussions with Simon King and his\n implementation of C3.\n+```\n \n``````\n",
    "created_at": "2013-05-31T19:05:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161344",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,8 @@
+
+```rst
+Teaser
+------
+
 Python handles multiple inheritance by computing, for each class,
 a linear extension of all its super classes (the Method Resolution
 Order, MRO). The MRO is calculated recursively from local
@@ -21,20 +26,18 @@
 would want to do by hand :-)
 
 Details
-
----
+-------
 
 Please see the extensive documentation at the top of the file
 sage/misc/c3_controlled.py in the attached patch.
 
 Content of the patch
-
----
+--------------------
 
 - Implement controlled C3 in sage.misc.c3_controlled.
 
 - Implement a total order in Category, and have Category use
-  c3 controlled by this order instead of plain c3.
+  C3 controlled by this order instead of plain C3.
 
 - Tweak the current total order to minimize changes in the order of
   categories.
@@ -47,25 +50,19 @@
 
 - Resolve some ambiguities to make the code more independent of the
   order of categories. In particular, FiniteCoxeterGroups prefer
-  `__iter__` and some_elements from CoxeterGroups to that of
+  __iter__ and some_elements from CoxeterGroups to that of
   FiniteGroups.
 
 - Update the section in the primer about order of categories.
 
-- Provide further tools in :mod:`sage.misc.c3_controlled` to
+- Provide further tools in ``sage.misc.c3_controlled`` to
   experiment with C3 and friends.
 
-Status
-
----
-
-Completely ready for review.
-
 Credits
-
----
+-------
 
 This patch is a followup to a study of the C3 algorithm together with
 Florent Hivert, and to discussions with Simon King and his
 implementation of C3.
+```
 
``````




---

archive/issue_comments_161345.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nShoot, the Cythonisation has broken one longtest failure in sage.misc.c3_controlled. I am investigating this; the rest can be reviewed in the mean time.\n\nThe cythonization has not improved the startup time. It's not yet clear to me what can be causing the slower startup time. To be investigated ...",
    "created_at": "2013-06-01T04:41:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161345",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:21'>**Comment 21:**</a>
Shoot, the Cythonisation has broken one longtest failure in sage.misc.c3_controlled. I am investigating this; the rest can be reviewed in the mean time.

The cythonization has not improved the startup time. It's not yet clear to me what can be causing the slower startup time. To be investigated ...



---

archive/issue_comments_161346.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\nSome random remarks:\n\n- Why is `Category._cmp_key` a cached method and not a lazy attribute?\n- Why is `CategoryWithParameters._cmp_key` a method and not a lazy attribute or at least a cached method?\n- Why has this example\n\n  ```\n  sage: Groups().example().algebra(ZZ).categories()\n  ...\n  ```\n  been completely removed from sage/categories/groups.py? Similarly `sage: Modules(Integers(9)).all_super_categories()` from sage/categories/modules.py etc.\n- In the documentation of primer.py:\n\n  ```rst\n  However this must be considered as an *implementation detail*: `C_1` \n  and `C_2` are incomparable categories, then the order in which they \n  appear must be mathematically irrelevant:\n  ```\n  I guess there is \"If\" missing after the first colon.\n- In sage/misc/c3_controlled.pyx, line 123: Should be \"classes that an object inherits from.\", not \"classes that an object inherit from.\"\n- ... line 139, \"However, this has several inconvenients:\" I guess this should be \"However, this has several drawbacks\" or \"However, this is inconvenient in several regards\" or so.\n\n\nDo I understand correctly: As you outline in lines 148-166, the creation of classes will become slower (`O(n^3)` instead of `O(n^2)` for getting the MRO, etc) if one explicitly puts the desired MRO into a long list of bases. This would certainly be a reason for an increased startup time and other regressions. Therefore, in a first step, you compute *short* lists of bases that ensure that the C3 algorithm still reconstruct the intended MRO. However, is this additional step (namely: Computing lists of bases) takes some time, not affecting the startup time?\n\nI still have to read the actual code (and not just the documentation). One question, though, which is in the spirit of #11935. In sage.categories.category, you have\n\n```python\n        (result, bases) = C3_sorted_merge([cat._all_super_categories \n                                           for cat in self._super_categories] + \n                                          [self._super_categories], \n                                          key = attrcall('_cmp_key')) \n        self._super_categories_for_classes = bases \n        return [self] + result \n```\nI guess in many cases the result will be the same up to the base rings. Shouldn't we think of a way to avoid duplication of work? I could imagine that here is the reason for the startup time regression.",
    "created_at": "2013-06-01T13:38:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161346",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'>**Comment 22:**</a>
Some random remarks:

- Why is `Category._cmp_key` a cached method and not a lazy attribute?
- Why is `CategoryWithParameters._cmp_key` a method and not a lazy attribute or at least a cached method?
- Why has this example

  ```
  sage: Groups().example().algebra(ZZ).categories()
  ...
  ```
  been completely removed from sage/categories/groups.py? Similarly `sage: Modules(Integers(9)).all_super_categories()` from sage/categories/modules.py etc.
- In the documentation of primer.py:

  ```rst
  However this must be considered as an *implementation detail*: `C_1` 
  and `C_2` are incomparable categories, then the order in which they 
  appear must be mathematically irrelevant:
  ```
  I guess there is "If" missing after the first colon.
- In sage/misc/c3_controlled.pyx, line 123: Should be "classes that an object inherits from.", not "classes that an object inherit from."
- ... line 139, "However, this has several inconvenients:" I guess this should be "However, this has several drawbacks" or "However, this is inconvenient in several regards" or so.


Do I understand correctly: As you outline in lines 148-166, the creation of classes will become slower (`O(n^3)` instead of `O(n^2)` for getting the MRO, etc) if one explicitly puts the desired MRO into a long list of bases. This would certainly be a reason for an increased startup time and other regressions. Therefore, in a first step, you compute *short* lists of bases that ensure that the C3 algorithm still reconstruct the intended MRO. However, is this additional step (namely: Computing lists of bases) takes some time, not affecting the startup time?

I still have to read the actual code (and not just the documentation). One question, though, which is in the spirit of #11935. In sage.categories.category, you have

```python
        (result, bases) = C3_sorted_merge([cat._all_super_categories 
                                           for cat in self._super_categories] + 
                                          [self._super_categories], 
                                          key = attrcall('_cmp_key')) 
        self._super_categories_for_classes = bases 
        return [self] + result 
```
I guess in many cases the result will be the same up to the base rings. Shouldn't we think of a way to avoid duplication of work? I could imagine that here is the reason for the startup time regression.



---

archive/issue_comments_161347.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nReplying to [@simon-king-jena](#comment%3A22):\n> Some random remarks:\n> \n> - Why is `Category._cmp_key` a cached method and not a lazy attribute?\n> - Why is `CategoryWithParameters._cmp_key` a method and not a lazy attribute or at least a cached method?\n\nTo be discussed. If I remember correctly, it's slightly easier to use\nsuper in cached methods than attributes, but I guess both would work.\n\n> - Why has this example\n> \n>   ```\n>   sage: Groups().example().algebra(ZZ).categories()\n>   ...\n>   ```\n>   been completely removed from sage/categories/groups.py? Similarly `sage: Modules(Integers(9)).all_super_categories()` from sage/categories/modules.py etc.\n\nBecause they neither bring useful test or information, and\nneed to be updated whenever the category order changes which is a good\nsource of conflicts.\n\n> - In the documentation of primer.py:\n> \n>   ```rst\n>   However this must be considered as an *implementation detail*: `C_1` \n>   and `C_2` are incomparable categories, then the order in which they \n>   appear must be mathematically irrelevant:\n>   ```\n>   I guess there is \"If\" missing after the first colon.\n> - In sage/misc/c3_controlled.pyx, line 123: Should be \"classes that an object inherits from.\", not \"classes that an object inherit from.\"\n> - ... line 139, \"However, this has several inconvenients:\" I guess this should be \"However, this has several drawbacks\" or \"However, this is inconvenient in several regards\" or so.\n\nThanks, I'll fix that! Probably on Monday, together with the fix for\nthe failing long test.\n\n> Do I understand correctly: As you outline in lines 148-166, the creation of classes will become slower (`O(n^3)` instead of `O(n^2)` for getting the MRO, etc) if one explicitly puts the desired MRO into a long list of bases. This would certainly be a reason for an increased startup time and other regressions. Therefore, in a first step, you compute *short* lists of bases that ensure that the C3 algorithm still reconstruct the intended MRO. However, is this additional step (namely: Computing lists of bases) takes some time, not affecting the startup time?\n\nPlease read further :-) That would be `O(n^3)` if one was brute forcing\nthe complete mro in the list of bases. Luckily it's more clever than\nthat! New bases are only added when absolutely necessary; in fact, in\nthe current situation it turns out that no base is actually added even\nfor non trivial categories like Fields or GradedHopfAlgebrasWithBasis.\n\n> I still have to read the actual code (and not just the documentation). One question, though, which is in the spirit of #11935. In sage.categories.category, you have\n> \n> ```python\n>         (result, bases) = C3_sorted_merge([cat._all_super_categories \n>                                            for cat in self._super_categories] + \n>                                           [self._super_categories], \n>                                           key = attrcall('_cmp_key')) \n>         self._super_categories_for_classes = bases \n>         return [self] + result \n> ```\n> I guess in many cases the result will be the same up to the base rings. Shouldn't we think of a way to avoid duplication of work? I could imagine that here is the reason for the startup time regression.\n\nThis code is only called if all_super_categories is called. And by\n#11935 this should happen only once for all base ring in the same\ncategory.  (unless one calls explicitly all_super_categories).  I have\nnot kept the timings under hand, but I did not see a difference in our\nusual elliptic curves benchmark.\n\nCheers,\n                              Nicolas",
    "created_at": "2013-06-01T15:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161347",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:23'>**Comment 23:**</a>
Replying to [@simon-king-jena](#comment%3A22):
> Some random remarks:
> 
> - Why is `Category._cmp_key` a cached method and not a lazy attribute?
> - Why is `CategoryWithParameters._cmp_key` a method and not a lazy attribute or at least a cached method?

To be discussed. If I remember correctly, it's slightly easier to use
super in cached methods than attributes, but I guess both would work.

> - Why has this example
> 
>   ```
>   sage: Groups().example().algebra(ZZ).categories()
>   ...
>   ```
>   been completely removed from sage/categories/groups.py? Similarly `sage: Modules(Integers(9)).all_super_categories()` from sage/categories/modules.py etc.

Because they neither bring useful test or information, and
need to be updated whenever the category order changes which is a good
source of conflicts.

> - In the documentation of primer.py:
> 
>   ```rst
>   However this must be considered as an *implementation detail*: `C_1` 
>   and `C_2` are incomparable categories, then the order in which they 
>   appear must be mathematically irrelevant:
>   ```
>   I guess there is "If" missing after the first colon.
> - In sage/misc/c3_controlled.pyx, line 123: Should be "classes that an object inherits from.", not "classes that an object inherit from."
> - ... line 139, "However, this has several inconvenients:" I guess this should be "However, this has several drawbacks" or "However, this is inconvenient in several regards" or so.

Thanks, I'll fix that! Probably on Monday, together with the fix for
the failing long test.

> Do I understand correctly: As you outline in lines 148-166, the creation of classes will become slower (`O(n^3)` instead of `O(n^2)` for getting the MRO, etc) if one explicitly puts the desired MRO into a long list of bases. This would certainly be a reason for an increased startup time and other regressions. Therefore, in a first step, you compute *short* lists of bases that ensure that the C3 algorithm still reconstruct the intended MRO. However, is this additional step (namely: Computing lists of bases) takes some time, not affecting the startup time?

Please read further :-) That would be `O(n^3)` if one was brute forcing
the complete mro in the list of bases. Luckily it's more clever than
that! New bases are only added when absolutely necessary; in fact, in
the current situation it turns out that no base is actually added even
for non trivial categories like Fields or GradedHopfAlgebrasWithBasis.

> I still have to read the actual code (and not just the documentation). One question, though, which is in the spirit of #11935. In sage.categories.category, you have
> 
> ```python
>         (result, bases) = C3_sorted_merge([cat._all_super_categories 
>                                            for cat in self._super_categories] + 
>                                           [self._super_categories], 
>                                           key = attrcall('_cmp_key')) 
>         self._super_categories_for_classes = bases 
>         return [self] + result 
> ```
> I guess in many cases the result will be the same up to the base rings. Shouldn't we think of a way to avoid duplication of work? I could imagine that here is the reason for the startup time regression.

This code is only called if all_super_categories is called. And by
#11935 this should happen only once for all base ring in the same
category.  (unless one calls explicitly all_super_categories).  I have
not kept the timings under hand, but I did not see a difference in our
usual elliptic curves benchmark.

Cheers,
                              Nicolas



---

archive/issue_comments_161348.json:
```json
{
    "body": "<a id='comment:24'>**Comment 24:**</a>\nFor the record, the only failing example is this:\n\n```\nFile \"devel/sage/sage/misc/c3_controlled.pyx\", line 266, in sage.misc.c3_controlled\nFailed example:\n    for l in L:                                          # long time\n        x = HierarchyElement(10, l.to_poset())\n        assert x.mro            == list(P)\n        assert x.mro_controlled == list(P)\n        assert x.all_bases_len() == 15\n        assert x.all_bases_controlled_len() == 19\n        try:\n            x.mro_standard\n            assert False\n        except:\n            pass\nException raised:\n    Traceback (most recent call last):\n      File \"/home/simon/SAGE/prerelease/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 466, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/simon/SAGE/prerelease/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 825, in execute\n        exec compiled in globs\n      File \"<doctest sage.misc.c3_controlled[35]>\", line 6, in <module>\n        assert x.all_bases_controlled_len() == Integer(19)\n    AssertionError\n```\n\nIndeed, on the command line, I get\n\n```\nsage: for l in L:\n....:     print \"l =\",l\n....:     x = HierarchyElement(10, l.to_poset())\n....:     print x.all_bases_controlled_len()\n....:     \nl = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1]\n19\nl = [10, 9, 8, 7, 6, 5, 4, 3, 1, 2]\n19\nl = [10, 9, 8, 7, 6, 5, 4, 2, 3, 1]\n19\nl = [10, 9, 8, 7, 6, 5, 4, 2, 1, 3]\n19\nl = [10, 9, 8, 7, 6, 5, 4, 1, 3, 2]\n19\nl = [10, 9, 8, 7, 6, 5, 4, 1, 2, 3]\n19\nl = [10, 9, 8, 7, 6, 5, 3, 4, 2, 1]\n18\n...\nl = [10, 7, 9, 8, 5, 6, 4, 1, 3, 2]\n20\nl = [10, 7, 9, 8, 5, 6, 4, 1, 2, 3]\n20\nl = [10, 7, 9, 8, 5, 6, 3, 4, 2, 1]\n18\nl = [10, 7, 9, 8, 5, 6, 3, 4, 1, 2]\n18\n...\nl = [10, 7, 9, 8, 4, 5, 6, 1, 3, 2]\n20\nl = [10, 7, 9, 8, 4, 5, 6, 1, 2, 3]\n20\nl = [10, 7, 9, 8, 4, 5, 1, 6, 3, 2]\n17\nl = [10, 7, 9, 8, 4, 5, 1, 6, 2, 3]\n17\nl = [10, 7, 9, 6, 8, 5, 4, 3, 2, 1]\n19\n...\nl = [10, 7, 9, 6, 8, 5, 4, 1, 2, 3]\n19\nl = [10, 7, 9, 6, 8, 5, 3, 4, 2, 1]\n16\nl = [10, 7, 9, 6, 8, 5, 3, 4, 1, 2]\n16\nl = [10, 7, 9, 6, 8, 4, 5, 3, 2, 1]\n18\nl = [10, 7, 9, 6, 8, 4, 5, 3, 1, 2]\n18\nl = [10, 7, 9, 6, 8, 4, 5, 2, 3, 1]\n18\nl = [10, 7, 9, 6, 8, 4, 5, 2, 1, 3]\n18\nl = [10, 7, 9, 6, 8, 4, 5, 1, 3, 2]\n18\nl = [10, 7, 9, 6, 8, 4, 5, 1, 2, 3]\n18\nl = [10, 7, 9, 6, 8, 4, 2, 5, 3, 1]\n17\nl = [10, 7, 9, 6, 8, 4, 2, 5, 1, 3]\n17\nl = [10, 7, 9, 6, 4, 8, 5, 3, 2, 1]\n19\nl = [10, 7, 9, 6, 4, 8, 5, 3, 1, 2]\n19\n...\nl = [10, 7, 4, 8, 9, 6, 5, 1, 2, 3]\n19\nl = [10, 7, 4, 8, 9, 6, 2, 5, 3, 1]\n16\nl = [10, 7, 4, 8, 9, 6, 2, 5, 1, 3]\n16\nl = [10, 7, 4, 8, 9, 5, 6, 3, 2, 1]\n18\nl = [10, 7, 4, 8, 9, 5, 6, 3, 1, 2]\n18\n...\nl = [10, 7, 4, 8, 5, 9, 6, 1, 2, 3]\n17\nl = [10, 7, 4, 8, 5, 9, 1, 6, 3, 2]\n16\nl = [10, 7, 4, 8, 5, 9, 1, 6, 2, 3]\n16\nsage:\n```\n\nI am not surprise that some posets are easier to control than others. Why do you expect that `all_bases_controlled_len` is the same in all cases?",
    "created_at": "2013-06-01T15:47:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161348",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'>**Comment 24:**</a>
For the record, the only failing example is this:

```
File "devel/sage/sage/misc/c3_controlled.pyx", line 266, in sage.misc.c3_controlled
Failed example:
    for l in L:                                          # long time
        x = HierarchyElement(10, l.to_poset())
        assert x.mro            == list(P)
        assert x.mro_controlled == list(P)
        assert x.all_bases_len() == 15
        assert x.all_bases_controlled_len() == 19
        try:
            x.mro_standard
            assert False
        except:
            pass
Exception raised:
    Traceback (most recent call last):
      File "/home/simon/SAGE/prerelease/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 466, in _run
        self.execute(example, compiled, test.globs)
      File "/home/simon/SAGE/prerelease/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 825, in execute
        exec compiled in globs
      File "<doctest sage.misc.c3_controlled[35]>", line 6, in <module>
        assert x.all_bases_controlled_len() == Integer(19)
    AssertionError
```

Indeed, on the command line, I get

```
sage: for l in L:
....:     print "l =",l
....:     x = HierarchyElement(10, l.to_poset())
....:     print x.all_bases_controlled_len()
....:     
l = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
19
l = [10, 9, 8, 7, 6, 5, 4, 3, 1, 2]
19
l = [10, 9, 8, 7, 6, 5, 4, 2, 3, 1]
19
l = [10, 9, 8, 7, 6, 5, 4, 2, 1, 3]
19
l = [10, 9, 8, 7, 6, 5, 4, 1, 3, 2]
19
l = [10, 9, 8, 7, 6, 5, 4, 1, 2, 3]
19
l = [10, 9, 8, 7, 6, 5, 3, 4, 2, 1]
18
...
l = [10, 7, 9, 8, 5, 6, 4, 1, 3, 2]
20
l = [10, 7, 9, 8, 5, 6, 4, 1, 2, 3]
20
l = [10, 7, 9, 8, 5, 6, 3, 4, 2, 1]
18
l = [10, 7, 9, 8, 5, 6, 3, 4, 1, 2]
18
...
l = [10, 7, 9, 8, 4, 5, 6, 1, 3, 2]
20
l = [10, 7, 9, 8, 4, 5, 6, 1, 2, 3]
20
l = [10, 7, 9, 8, 4, 5, 1, 6, 3, 2]
17
l = [10, 7, 9, 8, 4, 5, 1, 6, 2, 3]
17
l = [10, 7, 9, 6, 8, 5, 4, 3, 2, 1]
19
...
l = [10, 7, 9, 6, 8, 5, 4, 1, 2, 3]
19
l = [10, 7, 9, 6, 8, 5, 3, 4, 2, 1]
16
l = [10, 7, 9, 6, 8, 5, 3, 4, 1, 2]
16
l = [10, 7, 9, 6, 8, 4, 5, 3, 2, 1]
18
l = [10, 7, 9, 6, 8, 4, 5, 3, 1, 2]
18
l = [10, 7, 9, 6, 8, 4, 5, 2, 3, 1]
18
l = [10, 7, 9, 6, 8, 4, 5, 2, 1, 3]
18
l = [10, 7, 9, 6, 8, 4, 5, 1, 3, 2]
18
l = [10, 7, 9, 6, 8, 4, 5, 1, 2, 3]
18
l = [10, 7, 9, 6, 8, 4, 2, 5, 3, 1]
17
l = [10, 7, 9, 6, 8, 4, 2, 5, 1, 3]
17
l = [10, 7, 9, 6, 4, 8, 5, 3, 2, 1]
19
l = [10, 7, 9, 6, 4, 8, 5, 3, 1, 2]
19
...
l = [10, 7, 4, 8, 9, 6, 5, 1, 2, 3]
19
l = [10, 7, 4, 8, 9, 6, 2, 5, 3, 1]
16
l = [10, 7, 4, 8, 9, 6, 2, 5, 1, 3]
16
l = [10, 7, 4, 8, 9, 5, 6, 3, 2, 1]
18
l = [10, 7, 4, 8, 9, 5, 6, 3, 1, 2]
18
...
l = [10, 7, 4, 8, 5, 9, 6, 1, 2, 3]
17
l = [10, 7, 4, 8, 5, 9, 1, 6, 3, 2]
16
l = [10, 7, 4, 8, 5, 9, 1, 6, 2, 3]
16
sage:
```

I am not surprise that some posets are easier to control than others. Why do you expect that `all_bases_controlled_len` is the same in all cases?



---

archive/issue_comments_161349.json:
```json
{
    "body": "<a id='comment:25'>**Comment 25:**</a>\nReplying to [@simon-king-jena](#comment%3A24):\n> I am not surprise that some posets are easier to control than others. Why do you expect that `all_bases_controlled_len` is the same in all cases?\n\nThe fact that the number of bases to be added does not depend on the linear extension is certainly specific to this poset. But before cythonisation this used to be the case. So I need to investigate what went wrong!",
    "created_at": "2013-06-02T12:05:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161349",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:25'>**Comment 25:**</a>
Replying to [@simon-king-jena](#comment%3A24):
> I am not surprise that some posets are easier to control than others. Why do you expect that `all_bases_controlled_len` is the same in all cases?

The fact that the number of bases to be added does not depend on the linear extension is certainly specific to this poset. But before cythonisation this used to be the case. So I need to investigate what went wrong!



---

archive/issue_comments_161350.json:
```json
{
    "body": "<a id='comment:26'>**Comment 26:**</a>\nHi Simon!\n\nIt turns out that I had just fooled myself because of a typo in the test. Even for this example, the number of bases to be added *does* depend on the linear extension.\n\nSo all is good, the python/cython implementations agree.\n\nThe updated patch:\n\n- fixes the typos you mentionned\n- reworks a bit the text to make it clearer that the code implements an optimized \"add bases\" trick which does not have the drawbacks of the brute force approach.\n- fixes the incorrect doctest, and gather some stats on the number of bases to be added for each linear extension\n- mentions the removed doctests, and the rationale for removing them, in the patch header\n\nThere remains to decide between a lazy attribute or a cached method for _cmp_key. Any idea on how to investigate the startup time welcome.\n\nCheers,\n                            Nicolas",
    "created_at": "2013-06-03T14:51:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161350",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:26'>**Comment 26:**</a>
Hi Simon!

It turns out that I had just fooled myself because of a typo in the test. Even for this example, the number of bases to be added *does* depend on the linear extension.

So all is good, the python/cython implementations agree.

The updated patch:

- fixes the typos you mentionned
- reworks a bit the text to make it clearer that the code implements an optimized "add bases" trick which does not have the drawbacks of the brute force approach.
- fixes the incorrect doctest, and gather some stats on the number of bases to be added for each linear extension
- mentions the removed doctests, and the rationale for removing them, in the patch header

There remains to decide between a lazy attribute or a cached method for _cmp_key. Any idea on how to investigate the startup time welcome.

Cheers,
                            Nicolas



---

archive/issue_comments_161351.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -45,6 +45,8 @@\n - Update doctests w.r.t. remaining changes of in the order of\n   categories.\n \n+- Remove a coupld doctests displaying \"all_super_categories\" that did not bring useful information to the user nor intesting test, yet needed to be constantly updated; nothing but a good source of conflicts.\n+\n - Rewrite doctests in sage.misc.c3 to be independent of categories\n   since those do not use anymore this implementation of C3.\n \n``````\n",
    "created_at": "2013-06-03T16:14:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161351",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -45,6 +45,8 @@
 - Update doctests w.r.t. remaining changes of in the order of
   categories.
 
+- Remove a coupld doctests displaying "all_super_categories" that did not bring useful information to the user nor intesting test, yet needed to be constantly updated; nothing but a good source of conflicts.
+
 - Rewrite doctests in sage.misc.c3 to be independent of categories
   since those do not use anymore this implementation of C3.
 
``````




---

archive/issue_comments_161352.json:
```json
{
    "body": "<a id='comment:28'>**Comment 28:**</a>\nHi Simon,\n\nWhile playing with larger hierarchy of classes for the functorial construction patch, I stumbled on one execution path which was not treated correctly. I'll post an updated patch shortly.",
    "created_at": "2013-06-05T19:02:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161352",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:28'>**Comment 28:**</a>
Hi Simon,

While playing with larger hierarchy of classes for the functorial construction patch, I stumbled on one execution path which was not treated correctly. I'll post an updated patch shortly.



---

archive/issue_comments_161353.json:
```json
{
    "body": "**Attachment:** [c3-fix-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/c3-fix-nt.patch.gz)",
    "created_at": "2013-06-05T21:35:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161353",
    "user": "https://github.com/nthiery"
}
```

**Attachment:** [c3-fix-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/c3-fix-nt.patch.gz)



---

archive/issue_comments_161354.json:
```json
{
    "body": "<a id='comment:29'>**Comment 29:**</a>\nReplying to [@nthiery](#comment%3A28):\n> While playing with larger hierarchy of classes for the functorial construction patch, I stumbled on one execution path which was not treated correctly. I'll post an updated patch shortly.\n\nOk, the updated patch includes the (hopefuly) now correct implementation together with relevant tests. At this occasion, I declared a couple more variables for cython and added some debugging code (commented out by default).\n\nYou can look at :attachment:c3-fix-nt.patch if you just want to see the changes.\n\nI guess last time I wrote such a long function was when I played around with F5! It would be a good candidate for a computer assisted proof of correctness or for automatic test generation.",
    "created_at": "2013-06-05T21:43:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161354",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:29'>**Comment 29:**</a>
Replying to [@nthiery](#comment%3A28):
> While playing with larger hierarchy of classes for the functorial construction patch, I stumbled on one execution path which was not treated correctly. I'll post an updated patch shortly.

Ok, the updated patch includes the (hopefuly) now correct implementation together with relevant tests. At this occasion, I declared a couple more variables for cython and added some debugging code (commented out by default).

You can look at :attachment:c3-fix-nt.patch if you just want to see the changes.

I guess last time I wrote such a long function was when I played around with F5! It would be a good candidate for a computer assisted proof of correctness or for automatic test generation.



---

archive/issue_comments_161355.json:
```json
{
    "body": "<a id='comment:30'>**Comment 30:**</a>\nI forgot to mention: all long tests pass on my machine.",
    "created_at": "2013-06-05T21:43:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161355",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:30'>**Comment 30:**</a>
I forgot to mention: all long tests pass on my machine.



---

archive/issue_comments_161356.json:
```json
{
    "body": "<a id='comment:31'>**Comment 31:**</a>\nReplying to [@nthiery](#comment%3A29):\n> I guess last time I wrote such a long function was when I played around with F5! It would be a good candidate for a computer assisted proof of correctness or for automatic test generation.\n\nDo we have those things (I mean \"computer assisted correctness proofs\", not \"F5\") in Sage?\n\nI am travelling this week. So, I will probably not be able to finish the review right now.",
    "created_at": "2013-06-05T22:20:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161356",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'>**Comment 31:**</a>
Replying to [@nthiery](#comment%3A29):
> I guess last time I wrote such a long function was when I played around with F5! It would be a good candidate for a computer assisted proof of correctness or for automatic test generation.

Do we have those things (I mean "computer assisted correctness proofs", not "F5") in Sage?

I am travelling this week. So, I will probably not be able to finish the review right now.



---

archive/issue_comments_161357.json:
```json
{
    "body": "<a id='comment:32'>**Comment 32:**</a>\n> Do we have those things (I mean \"computer assisted correctness proofs\", not \"F5\") in Sage?\n\nNope. But we have experts in Orsay in the office next to ours :-)\n\n> I am travelling this week. So, I will probably not be able to finish the review right now.\n\nOk.",
    "created_at": "2013-06-05T23:04:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161357",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:32'>**Comment 32:**</a>
> Do we have those things (I mean "computer assisted correctness proofs", not "F5") in Sage?

Nope. But we have experts in Orsay in the office next to ours :-)

> I am travelling this week. So, I will probably not be able to finish the review right now.

Ok.



---

archive/issue_comments_161358.json:
```json
{
    "body": "**Changing dependencies** from \"#13501, #12894, #12876, #11935, #12895\" to \"#12894, #12876, #11935, #12895\".",
    "created_at": "2013-06-12T00:02:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161358",
    "user": "https://github.com/nthiery"
}
```

**Changing dependencies** from "#13501, #12894, #12876, #11935, #12895" to "#12894, #12876, #11935, #12895".



---

archive/issue_comments_161359.json:
```json
{
    "body": "<a id='comment:34'>**Comment 34:**</a>\nApply [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)",
    "created_at": "2013-06-12T01:22:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161359",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:34'>**Comment 34:**</a>
Apply [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)



---

archive/issue_comments_161360.json:
```json
{
    "body": "<a id='comment:35'>**Comment 35:**</a>\n**Attachment:** [trac_13589-categories-c3_under_control-category_sample-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-category_sample-nt.patch.gz)\n\nThe updated patch includes a method category_sample which saves a couple lines and which I needed anyway later on. [attachment:trac_13589-categories-c3_under_control-category_sample-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-category_sample-nt.patch) shows the diff.",
    "created_at": "2013-06-12T01:47:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161360",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:35'>**Comment 35:**</a>
**Attachment:** [trac_13589-categories-c3_under_control-category_sample-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-category_sample-nt.patch.gz)

The updated patch includes a method category_sample which saves a couple lines and which I needed anyway later on. [attachment:trac_13589-categories-c3_under_control-category_sample-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-category_sample-nt.patch) shows the diff.



---

archive/issue_comments_161361.json:
```json
{
    "body": "<a id='comment:36'>**Comment 36:**</a>\nArr, I can't wait until we have a more semantic way to specify which patches to apply; this is way too error prone to trivial syntax errors ...\n\nApply: [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)",
    "created_at": "2013-06-12T02:43:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161361",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:36'>**Comment 36:**</a>
Arr, I can't wait until we have a more semantic way to specify which patches to apply; this is way too error prone to trivial syntax errors ...

Apply: [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)



---

archive/issue_comments_161362.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -60,6 +60,10 @@\n - Provide further tools in ``sage.misc.c3_controlled`` to\n   experiment with C3 and friends.\n \n+- Extract category_sample from category_graph\n+\n+Apply: [attachment:trac_13589-categories-c3_under_control-nt.patch]\n+\n Credits\n -------\n \n``````\n",
    "created_at": "2013-06-12T02:45:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161362",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -60,6 +60,10 @@
 - Provide further tools in ``sage.misc.c3_controlled`` to
   experiment with C3 and friends.
 
+- Extract category_sample from category_graph
+
+Apply: [attachment:trac_13589-categories-c3_under_control-nt.patch]
+
 Credits
 -------
 
``````




---

archive/issue_comments_161363.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -62,7 +62,7 @@\n \n - Extract category_sample from category_graph\n \n-Apply: [attachment:trac_13589-categories-c3_under_control-nt.patch]\n+Apply: trac_13589-categories-c3_under_control-nt.patch\n \n Credits\n -------\n``````\n",
    "created_at": "2013-06-19T14:38:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161363",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -62,7 +62,7 @@
 
 - Extract category_sample from category_graph
 
-Apply: [attachment:trac_13589-categories-c3_under_control-nt.patch]
+Apply: trac_13589-categories-c3_under_control-nt.patch
 
 Credits
 -------
``````




---

archive/issue_comments_161364.json:
```json
{
    "body": "**Changing dependencies** from \"#12894, #12876, #11935, #12895\" to \"#12894, #12876, #11935, #12895, #10193\".",
    "created_at": "2013-06-19T14:50:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161364",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing dependencies** from "#12894, #12876, #11935, #12895" to "#12894, #12876, #11935, #12895, #10193".



---

archive/issue_comments_161365.json:
```json
{
    "body": "<a id='comment:40'>**Comment 40:**</a>\nApply: trac_13589-categories-c3_under_control-nt.patch",
    "created_at": "2013-06-19T14:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161365",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'>**Comment 40:**</a>
Apply: trac_13589-categories-c3_under_control-nt.patch



---

archive/issue_comments_161366.json:
```json
{
    "body": "<a id='comment:41'>**Comment 41:**</a>\nNicolas and I just discussed: `_cmp_key` should at least be a cached method, not a plain method, so that it plays nicely with super(...). However, we may try whether lazy attributes would work, because Nicolas calls super(...) only to compute the value, but the value that should eventually be used does not depend on the class.",
    "created_at": "2013-06-19T15:15:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161366",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:41'>**Comment 41:**</a>
Nicolas and I just discussed: `_cmp_key` should at least be a cached method, not a plain method, so that it plays nicely with super(...). However, we may try whether lazy attributes would work, because Nicolas calls super(...) only to compute the value, but the value that should eventually be used does not depend on the class.



---

archive/issue_comments_161367.json:
```json
{
    "body": "<a id='comment:42'>**Comment 42:**</a>\nThis is a minimal example of what Nicolas wants to do:\n\n```\nsage: class A(object):\n    @lazy_attribute\n    def x(self):\n        print \"computing the attribute with A\"\n        return 1\n....:     \nsage: class B(A):\n    @lazy_attribute\n    def x(self):\n        print \"this is lazy attribute with B\"\n        r= super(B,self).x\n        self.y = r\n        return r\n....:     \nsage: b = B()\nsage: b.x\nthis is lazy attribute with B\ncomputing the attribute with A\n1\nsage: b.y\n1\n```\n\nSo, it seems to work with lazy attribute, and this will be much faster than calling a method (repeatedly). Trying to change it now.",
    "created_at": "2013-06-19T15:21:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161367",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:42'>**Comment 42:**</a>
This is a minimal example of what Nicolas wants to do:

```
sage: class A(object):
    @lazy_attribute
    def x(self):
        print "computing the attribute with A"
        return 1
....:     
sage: class B(A):
    @lazy_attribute
    def x(self):
        print "this is lazy attribute with B"
        r= super(B,self).x
        self.y = r
        return r
....:     
sage: b = B()
sage: b.x
this is lazy attribute with B
computing the attribute with A
1
sage: b.y
1
```

So, it seems to work with lazy attribute, and this will be much faster than calling a method (repeatedly). Trying to change it now.



---

archive/issue_comments_161368.json:
```json
{
    "body": "For speed reasons, make _cmp_key a lazy attribute, not a (cached) method",
    "created_at": "2013-06-19T15:48:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161368",
    "user": "https://github.com/simon-king-jena"
}
```

For speed reasons, make _cmp_key a lazy attribute, not a (cached) method



---

archive/issue_comments_161369.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -62,7 +62,11 @@\n \n - Extract category_sample from category_graph\n \n-Apply: trac_13589-categories-c3_under_control-nt.patch\n+Apply\n+-----\n+\n+- trac_13589-categories-c3_under_control-nt.patch\n+- trac13589_cmp_key_attribute.patch\n \n Credits\n -------\n``````\n",
    "created_at": "2013-06-19T15:50:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161369",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -62,7 +62,11 @@
 
 - Extract category_sample from category_graph
 
-Apply: trac_13589-categories-c3_under_control-nt.patch
+Apply
+-----
+
+- trac_13589-categories-c3_under_control-nt.patch
+- trac13589_cmp_key_attribute.patch
 
 Credits
 -------
``````




---

archive/issue_comments_161370.json:
```json
{
    "body": "<a id='comment:43'>**Comment 43:**</a>\n**Attachment:** [trac13589_cmp_key_attribute.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch.gz)\n\nApply: trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch",
    "created_at": "2013-06-19T15:50:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161370",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:43'>**Comment 43:**</a>
**Attachment:** [trac13589_cmp_key_attribute.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch.gz)

Apply: trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch



---

archive/issue_comments_161371.json:
```json
{
    "body": "<a id='comment:44'>**Comment 44:**</a>\nTo me, the code looks fine. Patchbot does not report any errors. However, it reports a significant increase of 2.5% of startup time.\n\nHow can this be analysed?",
    "created_at": "2013-06-19T16:35:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161371",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:44'>**Comment 44:**</a>
To me, the code looks fine. Patchbot does not report any errors. However, it reports a significant increase of 2.5% of startup time.

How can this be analysed?



---

archive/issue_comments_161372.json:
```json
{
    "body": "<a id='comment:45'>**Comment 45:**</a>\nSomething findings:\n\n- C3_sorted_merge was called 121 times with the current patch during startup.\n- C3_sorted_merge is called on different Groupoids, which should not happen, because all groupoids have the same super categories. Solution: Make it `CategoryWithParameters`. Then, C3_sorted_merge is only called 93 times during startup.\n- There are some optimizations possible in C3_sorted_merge:\n\n```\nsage: L1 = Fields().all_super_categories()\nsage: L2 = Algebras(QQ).all_super_categories()\nsage: cython(\"\"\"\ndef test1(list L):\n    cdef list out = L[::-1]\ndef test2(list L):\n    cdef list out = list(reversed(L))\n\"\"\")\n....: \nsage: %timeit test1(L1)\n1000000 loops, best of 3: 541 ns per loop\nsage: %timeit test2(L1)\n100000 loops, best of 3: 2.25 us per loop\n```\nand\n\n```\nsage: cython(\"\"\"\n....: def test1(list L):\n....:     cdef set S = set(x for x in L)\n....: def test2(list L):\n....:     cdef set S = set([x for x in L])\n....: \"\"\")\n....: \nsage: %timeit test1(L1)\n100000 loops, best of 3: 3.91 us per loop\nsage: %timeit test2(L1)\n100000 loops, best of 3: 3.99 us per loop\nsage: %timeit test1(L1)\n100000 loops, best of 3: 3.89 us per loop\nsage: %timeit test1(L1)\n100000 loops, best of 3: 3.89 us per loop\nsage: %timeit test2(L1)\n100000 loops, best of 3: 4.06 us per loop\n```\n\nIn both examples above, test2 is what is currently done in C3_sorted_merge, and test1 is apparently what *should* be done. I am preparing a patch now.",
    "created_at": "2013-06-19T20:33:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161372",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:45'>**Comment 45:**</a>
Something findings:

- C3_sorted_merge was called 121 times with the current patch during startup.
- C3_sorted_merge is called on different Groupoids, which should not happen, because all groupoids have the same super categories. Solution: Make it `CategoryWithParameters`. Then, C3_sorted_merge is only called 93 times during startup.
- There are some optimizations possible in C3_sorted_merge:

```
sage: L1 = Fields().all_super_categories()
sage: L2 = Algebras(QQ).all_super_categories()
sage: cython("""
def test1(list L):
    cdef list out = L[::-1]
def test2(list L):
    cdef list out = list(reversed(L))
""")
....: 
sage: %timeit test1(L1)
1000000 loops, best of 3: 541 ns per loop
sage: %timeit test2(L1)
100000 loops, best of 3: 2.25 us per loop
```
and

```
sage: cython("""
....: def test1(list L):
....:     cdef set S = set(x for x in L)
....: def test2(list L):
....:     cdef set S = set([x for x in L])
....: """)
....: 
sage: %timeit test1(L1)
100000 loops, best of 3: 3.91 us per loop
sage: %timeit test2(L1)
100000 loops, best of 3: 3.99 us per loop
sage: %timeit test1(L1)
100000 loops, best of 3: 3.89 us per loop
sage: %timeit test1(L1)
100000 loops, best of 3: 3.89 us per loop
sage: %timeit test2(L1)
100000 loops, best of 3: 4.06 us per loop
```

In both examples above, test2 is what is currently done in C3_sorted_merge, and test1 is apparently what *should* be done. I am preparing a patch now.



---

archive/issue_comments_161373.json:
```json
{
    "body": "<a id='comment:46'>**Comment 46:**</a>\nAnother observation: key(O) is called repeatedly, even though its result is already stored in O_key, so, it should be used consistently.",
    "created_at": "2013-06-19T20:52:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161373",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'>**Comment 46:**</a>
Another observation: key(O) is called repeatedly, even though its result is already stored in O_key, so, it should be used consistently.



---

archive/issue_comments_161374.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -67,6 +67,7 @@\n \n - trac_13589-categories-c3_under_control-nt.patch\n - trac13589_cmp_key_attribute.patch\n+- trac13589_improve_startuptime.patch\n \n Credits\n -------\n``````\n",
    "created_at": "2013-06-19T20:55:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161374",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -67,6 +67,7 @@
 
 - trac_13589-categories-c3_under_control-nt.patch
 - trac13589_cmp_key_attribute.patch
+- trac13589_improve_startuptime.patch
 
 Credits
 -------
``````




---

archive/issue_comments_161375.json:
```json
{
    "body": "<a id='comment:47'>**Comment 47:**</a>\nApply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch",
    "created_at": "2013-06-19T20:55:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161375",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'>**Comment 47:**</a>
Apply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch



---

archive/issue_comments_161376.json:
```json
{
    "body": "<a id='comment:48'>**Comment 48:**</a>\nOn my computer, running startuptime once, it seemed to me that the problem was close to being solved. However, the patchbot still sees a slow-down of 2.5% with very high confidence.\n\nSo, let's try to find further tweaks.",
    "created_at": "2013-06-20T06:22:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161376",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:48'>**Comment 48:**</a>
On my computer, running startuptime once, it seemed to me that the problem was close to being solved. However, the patchbot still sees a slow-down of 2.5% with very high confidence.

So, let's try to find further tweaks.



---

archive/issue_comments_161377.json:
```json
{
    "body": "<a id='comment:49'>**Comment 49:**</a>\nHere is another potential improvement:\n\n```\nsage: cython(\"\"\"\n....: cpdef inline sort_key(object x):\n....:     return x._cmp_key\n....: def test(list L, key):\n....:     cdef list out = sorted(L, key=key, reverse=True)\n....: \"\"\")\n....: \nsage: class C(object):   \n....:     def __init__(self, n):\n....:         self._cmp_key = n\n....:         \nsage: L = [C(ZZ.random_element(1,10^6)) for _ in range(10000)]\nsage: from operator import attrgetter\nsage: sk = attrgetter('_cmp_key')\nsage: %timeit test(L,sort_key)\n100 loops, best of 3: 10.8 ms per loop\nsage: %timeit test(L,sk)\n100 loops, best of 3: 12.9 ms per loop\nsage: %timeit test(L,sort_key)\n100 loops, best of 3: 10.8 ms per loop\nsage: %timeit test(L,sk)\n100 loops, best of 3: 12.9 ms per loop\n```\n\nSo, in C3_controlled, we could implement this cpdef inline function as the default key for comparison.\n\nIn addition, we could decide that the key *must* return a tuple, because this is the format of Category._cmp_key. But this would mean we loose flexibility.",
    "created_at": "2013-06-20T12:37:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161377",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:49'>**Comment 49:**</a>
Here is another potential improvement:

```
sage: cython("""
....: cpdef inline sort_key(object x):
....:     return x._cmp_key
....: def test(list L, key):
....:     cdef list out = sorted(L, key=key, reverse=True)
....: """)
....: 
sage: class C(object):   
....:     def __init__(self, n):
....:         self._cmp_key = n
....:         
sage: L = [C(ZZ.random_element(1,10^6)) for _ in range(10000)]
sage: from operator import attrgetter
sage: sk = attrgetter('_cmp_key')
sage: %timeit test(L,sort_key)
100 loops, best of 3: 10.8 ms per loop
sage: %timeit test(L,sk)
100 loops, best of 3: 12.9 ms per loop
sage: %timeit test(L,sort_key)
100 loops, best of 3: 10.8 ms per loop
sage: %timeit test(L,sk)
100 loops, best of 3: 12.9 ms per loop
```

So, in C3_controlled, we could implement this cpdef inline function as the default key for comparison.

In addition, we could decide that the key *must* return a tuple, because this is the format of Category._cmp_key. But this would mean we loose flexibility.



---

archive/issue_comments_161378.json:
```json
{
    "body": "<a id='comment:50'>**Comment 50:**</a>\nLet's do some statistics.\n\nThis is what I get in three runs of `sage -startuptime`, when only the dependencies of this ticket are applied.\n\n```\n    29.550   1376.061          4  sage.all\nTotal time (sum over exclusive time): 1455.386ms\n    30.054   1389.055          4  sage.all\nTotal time (sum over exclusive time): 1469.172ms\n    29.410   1376.077          4  sage.all\nTotal time (sum over exclusive time): 1455.600ms\n```\n\nAdding the first patch from here\n\n```\n    28.707   1390.722          4  sage.all\nTotal time (sum over exclusive time): 1470.469ms\n    28.887   1397.835          4  sage.all\nTotal time (sum over exclusive time): 1477.698ms\n    28.699   1409.829          4  sage.all\nTotal time (sum over exclusive time): 1489.124ms\n```\n\nIs that really a significant slow-down? I don't think so.\n\nAnd when applying the other patches (including an update of the last, that I did not post yet):\n\n```\n    29.099   1386.676          4  sage.all\nTotal time (sum over exclusive time): 1466.655ms\n    29.705   1391.458          4  sage.all\nTotal time (sum over exclusive time): 1471.162ms\n    35.740   1480.115          4  sage.all\nTotal time (sum over exclusive time): 1574.091ms\n```\n\nWhat does this give us?",
    "created_at": "2013-06-20T12:55:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161378",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:50'>**Comment 50:**</a>
Let's do some statistics.

This is what I get in three runs of `sage -startuptime`, when only the dependencies of this ticket are applied.

```
    29.550   1376.061          4  sage.all
Total time (sum over exclusive time): 1455.386ms
    30.054   1389.055          4  sage.all
Total time (sum over exclusive time): 1469.172ms
    29.410   1376.077          4  sage.all
Total time (sum over exclusive time): 1455.600ms
```

Adding the first patch from here

```
    28.707   1390.722          4  sage.all
Total time (sum over exclusive time): 1470.469ms
    28.887   1397.835          4  sage.all
Total time (sum over exclusive time): 1477.698ms
    28.699   1409.829          4  sage.all
Total time (sum over exclusive time): 1489.124ms
```

Is that really a significant slow-down? I don't think so.

And when applying the other patches (including an update of the last, that I did not post yet):

```
    29.099   1386.676          4  sage.all
Total time (sum over exclusive time): 1466.655ms
    29.705   1391.458          4  sage.all
Total time (sum over exclusive time): 1471.162ms
    35.740   1480.115          4  sage.all
Total time (sum over exclusive time): 1574.091ms
```

What does this give us?



---

archive/issue_comments_161379.json:
```json
{
    "body": "<a id='comment:51'>**Comment 51:**</a>\nI've updated the patch, FWIW.\n\nApply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch",
    "created_at": "2013-06-20T13:00:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161379",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:51'>**Comment 51:**</a>
I've updated the patch, FWIW.

Apply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch



---

archive/issue_comments_161380.json:
```json
{
    "body": "<a id='comment:52'>**Comment 52:**</a>\nAny idea what we shall do about the regression at startup?",
    "created_at": "2013-06-26T13:21:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161380",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:52'>**Comment 52:**</a>
Any idea what we shall do about the regression at startup?



---

archive/issue_comments_161381.json:
```json
{
    "body": "<a id='comment:53'>**Comment 53:**</a>\nHere is another possibility to speed things up: Replace itertools.count() by a cpdef method, defined in some auxiliary file.\n\nTiming:\n\n```\nsage: cython(\"\"\"\ncdef long counter = 0\ncpdef count1():\n    global counter\n    counter += 1\n    return counter\ndef count2():\n    cdef long c = 0\n    while True:\n        c += 1\n        yield c\n\"\"\")\nsage: C = count1\nsage: %timeit a = C()\n10000000 loops, best of 3: 73.8 ns per loop\nsage: C = count2()\nsage: %timeit a = C.next()\n1000000 loops, best of 3: 252 ns per loop\nsage: import itertools\nsage: C = itertools.count()\nsage: %timeit a = C.next()\n1000000 loops, best of 3: 231 ns per loop\n```\n\nNote that this would also make the startup_module plugin happy, since it complains about the new import of itertools during startup.",
    "created_at": "2013-06-26T13:33:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161381",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:53'>**Comment 53:**</a>
Here is another possibility to speed things up: Replace itertools.count() by a cpdef method, defined in some auxiliary file.

Timing:

```
sage: cython("""
cdef long counter = 0
cpdef count1():
    global counter
    counter += 1
    return counter
def count2():
    cdef long c = 0
    while True:
        c += 1
        yield c
""")
sage: C = count1
sage: %timeit a = C()
10000000 loops, best of 3: 73.8 ns per loop
sage: C = count2()
sage: %timeit a = C.next()
1000000 loops, best of 3: 252 ns per loop
sage: import itertools
sage: C = itertools.count()
sage: %timeit a = C.next()
1000000 loops, best of 3: 231 ns per loop
```

Note that this would also make the startup_module plugin happy, since it complains about the new import of itertools during startup.



---

archive/issue_comments_161382.json:
```json
{
    "body": "Several attempts to improve startuptime",
    "created_at": "2013-06-26T13:42:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161382",
    "user": "https://github.com/simon-king-jena"
}
```

Several attempts to improve startuptime



---

archive/issue_comments_161383.json:
```json
{
    "body": "<a id='comment:54'>**Comment 54:**</a>\n**Attachment:** [trac13589_improve_startuptime.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch.gz)\n\nThanks for the timings! The startup gain should be of roughly 50*(231-74)ns which will be anyway far less than a ms and negligible. I would thus tend to stick to the standard Python module itertools, and ignore the little indicator from the startup module plugin.\n\nAs for the time increase: I will post a poll on sage-devel later today.",
    "created_at": "2013-06-26T13:45:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161383",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:54'>**Comment 54:**</a>
**Attachment:** [trac13589_improve_startuptime.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch.gz)

Thanks for the timings! The startup gain should be of roughly 50*(231-74)ns which will be anyway far less than a ms and negligible. I would thus tend to stick to the standard Python module itertools, and ignore the little indicator from the startup module plugin.

As for the time increase: I will post a poll on sage-devel later today.



---

archive/issue_comments_161384.json:
```json
{
    "body": "<a id='comment:55'>**Comment 55:**</a>\nReplying to [@nthiery](#comment%3A54):\n> Thanks for the timings! The startup gain should be of roughly 50*(231-74)ns which will be anyway far less than a ms and negligible. I would thus tend to stick to the standard Python module itertools, and ignore the little indicator from the startup module plugin.\n\nToo late... I already posted an update of my patch.\n\nWell, I'd say let the patchbot try, at least.\n \n> As for the time increase: I will post a poll on sage-devel later today.\n\nThank you.\n\nI've put the cpdef counter into sage.misc.c3_controlled---I think this is a good place, given that it is needed when applying the controlled c3 in categories.\n\nWith the original patch, one had `Category._cmp_key_generator.next()`, hence, two attribute lookups and a function call. With the new patch, one just has one function call, which also seems to be faster than the function call to `next()`.\n\nLet us keep our fingers crossed concerning the findings of the patchbot...\n\nApply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch",
    "created_at": "2013-06-26T13:47:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161384",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:55'>**Comment 55:**</a>
Replying to [@nthiery](#comment%3A54):
> Thanks for the timings! The startup gain should be of roughly 50*(231-74)ns which will be anyway far less than a ms and negligible. I would thus tend to stick to the standard Python module itertools, and ignore the little indicator from the startup module plugin.

Too late... I already posted an update of my patch.

Well, I'd say let the patchbot try, at least.
 
> As for the time increase: I will post a poll on sage-devel later today.

Thank you.

I've put the cpdef counter into sage.misc.c3_controlled---I think this is a good place, given that it is needed when applying the controlled c3 in categories.

With the original patch, one had `Category._cmp_key_generator.next()`, hence, two attribute lookups and a function call. With the new patch, one just has one function call, which also seems to be faster than the function call to `next()`.

Let us keep our fingers crossed concerning the findings of the patchbot...

Apply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch



---

archive/issue_comments_161385.json:
```json
{
    "body": "<a id='comment:56'>**Comment 56:**</a>\nIn the computation of _cmp_key, it says:\n\n```\n    atoms = (\"FacadeSets\", \"Finite\", \"Infinite\", \"EnumeratedSets\", \"FiniteDimensionalModulesWithBasis\", \"GradedModules\", \"ModulesWithBasis\", \"AdditiveMagmas\", \"Magmas\", \"Semigroups\", \"Monoids\", \"FinitePermutationGroups\", \"Rngs\", \"Domains\")\n    classname = self.__class__.__name__\n    flag = 0\n    for i, axiom in enumerate(atoms):\n        if classname.startswith(axiom):\n            flag = flag | (1 << i)\n```\n\nFirst a Python question: Will the tuple `atoms` be constructed repeatedly in this method? If this is the case, it might be better to move it to module level.\n\nSecond question: With the exception of \"Finite\" and \"FiniteDimensionalModulesWithBases\", the atoms are pairwise incompatible, in the sense of \"if classname starts with one of the atoms, then it will certainly not start with any other atom\". Hence, it seems possible to rewrite it such that the `for` loop is quit after the first case in which the `if` clause is true.\n\nBut again, probably a speed gain in a method that is called only once will be negligible.",
    "created_at": "2013-06-26T15:29:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161385",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:56'>**Comment 56:**</a>
In the computation of _cmp_key, it says:

```
    atoms = ("FacadeSets", "Finite", "Infinite", "EnumeratedSets", "FiniteDimensionalModulesWithBasis", "GradedModules", "ModulesWithBasis", "AdditiveMagmas", "Magmas", "Semigroups", "Monoids", "FinitePermutationGroups", "Rngs", "Domains")
    classname = self.__class__.__name__
    flag = 0
    for i, axiom in enumerate(atoms):
        if classname.startswith(axiom):
            flag = flag | (1 << i)
```

First a Python question: Will the tuple `atoms` be constructed repeatedly in this method? If this is the case, it might be better to move it to module level.

Second question: With the exception of "Finite" and "FiniteDimensionalModulesWithBases", the atoms are pairwise incompatible, in the sense of "if classname starts with one of the atoms, then it will certainly not start with any other atom". Hence, it seems possible to rewrite it such that the `for` loop is quit after the first case in which the `if` clause is true.

But again, probably a speed gain in a method that is called only once will be negligible.



---

archive/issue_comments_161386.json:
```json
{
    "body": "<a id='comment:57'>**Comment 57:**</a>\nWe have to save a total of about 70 ms in 93 function calls. This is not much, and perhaps it could be obtained by cythoning the computation of _cmp_key.\n\nAlso, you do\n\n```\nassert not isinstance(self, JoinCategory)\n```\nand later comment\n\n```\nfor cat in self._super_categories: # not self.super_categories() to avoid join categories! \n```\nSo, is the assertion not needed, after all?",
    "created_at": "2013-06-27T13:08:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161386",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:57'>**Comment 57:**</a>
We have to save a total of about 70 ms in 93 function calls. This is not much, and perhaps it could be obtained by cythoning the computation of _cmp_key.

Also, you do

```
assert not isinstance(self, JoinCategory)
```
and later comment

```
for cat in self._super_categories: # not self.super_categories() to avoid join categories! 
```
So, is the assertion not needed, after all?



---

archive/issue_comments_161387.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -65,9 +65,10 @@\n Apply\n -----\n \n-- trac_13589-categories-c3_under_control-nt.patch\n-- trac13589_cmp_key_attribute.patch\n-- trac13589_improve_startuptime.patch\n+- [attachment:trac_13589-categories-c3_under_control-nt.patch]\n+- [attachment:trac13589_cmp_key_attribute.patch]\n+- [attachment:trac13589_improve_startuptime.patch]\n+- [attachment:trac13589_cython_cmp_key.patch]\n \n Credits\n -------\n``````\n",
    "created_at": "2013-06-27T17:28:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161387",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -65,9 +65,10 @@
 Apply
 -----
 
-- trac_13589-categories-c3_under_control-nt.patch
-- trac13589_cmp_key_attribute.patch
-- trac13589_improve_startuptime.patch
+- [attachment:trac_13589-categories-c3_under_control-nt.patch]
+- [attachment:trac13589_cmp_key_attribute.patch]
+- [attachment:trac13589_improve_startuptime.patch]
+- [attachment:trac13589_cython_cmp_key.patch]
 
 Credits
 -------
``````




---

archive/issue_comments_161388.json:
```json
{
    "body": "<a id='comment:58'>**Comment 58:**</a>\nAre the patch bots out of work? I've not seen any non-grey blob recently.\n\nAnyway. I implemented a Cython version of the _cmp_key attribute. It is similar to lazy attribute, but avoids some overhead, because it is known that it is applied to instances that allow for attribute assignment.\n\nCertainly there can not be a big speed-up. We are talking here about the attempt to make 90 function calls 1 ms faster in each run. I'd really be interested to know what the startup_time plugin finds. So, let us hope that the patch bots resume work soon...\n\nOf course, it could be that we will eventually disregard my startup time patches, should it turn out that they don't help.\n\nApply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch trac13589_cython_cmp_key.patch",
    "created_at": "2013-06-27T17:28:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161388",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:58'>**Comment 58:**</a>
Are the patch bots out of work? I've not seen any non-grey blob recently.

Anyway. I implemented a Cython version of the _cmp_key attribute. It is similar to lazy attribute, but avoids some overhead, because it is known that it is applied to instances that allow for attribute assignment.

Certainly there can not be a big speed-up. We are talking here about the attempt to make 90 function calls 1 ms faster in each run. I'd really be interested to know what the startup_time plugin finds. So, let us hope that the patch bots resume work soon...

Of course, it could be that we will eventually disregard my startup time patches, should it turn out that they don't help.

Apply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch trac13589_cython_cmp_key.patch



---

archive/issue_comments_161389.json:
```json
{
    "body": "<a id='comment:59'>**Comment 59:**</a>\nI did some timings. My benchmark is: Delete and recreated `Rings()._cmp_key` in a tight loop.\n\nWith only the first two patches, I get:\n\n```\nsage: C = Rings()\nsage: C._cmp_key\n(6016, 12)\nsage: timeit(\"if C._cmp_key: del C._cmp_key\", number=100000)\n100000 loops, best of 3: 12.9 \u00b5s per loop\nsage: C._cmp_key\n(6016, 300059)\n```\n\nWith all four patches, I get:\n\n```\nsage: C = Rings()\nsage: C._cmp_key\n(6016, 12)\nsage: timeit(\"if C._cmp_key: del C._cmp_key\", number=100000)\n100000 loops, best of 3: 901 ns per loop\nsage: C._cmp_key\n(6016, 300059)\n```\n\nSince the time needed to delete the attribute should be the same, it follows that the last two patches save 12 \u00b5s for each creation of the _cmp_key attribute. Better than nothing, but by far not enough to sum up to 70 ms.",
    "created_at": "2013-06-27T19:39:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161389",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:59'>**Comment 59:**</a>
I did some timings. My benchmark is: Delete and recreated `Rings()._cmp_key` in a tight loop.

With only the first two patches, I get:

```
sage: C = Rings()
sage: C._cmp_key
(6016, 12)
sage: timeit("if C._cmp_key: del C._cmp_key", number=100000)
100000 loops, best of 3: 12.9 ¬µs per loop
sage: C._cmp_key
(6016, 300059)
```

With all four patches, I get:

```
sage: C = Rings()
sage: C._cmp_key
(6016, 12)
sage: timeit("if C._cmp_key: del C._cmp_key", number=100000)
100000 loops, best of 3: 901 ns per loop
sage: C._cmp_key
(6016, 300059)
```

Since the time needed to delete the attribute should be the same, it follows that the last two patches save 12 ¬µs for each creation of the _cmp_key attribute. Better than nothing, but by far not enough to sum up to 70 ms.



---

archive/issue_comments_161390.json:
```json
{
    "body": "<a id='comment:60'>**Comment 60:**</a>\nI have cythoned the _cmp_key attribute of `CategoryWithParameters` as well. The raw improvement is:\n\nWithout the first two patches:\n\n```\nsage: C = Algebras(FractionField(QQ['x']))\nsage: timeit(\"if C._cmp_key: del C._cmp_key\", number=100000)\n100000 loops, best of 3: 5.38 \u00b5s per loop\n```\n\nWith all patches:\n\n```\nsage: C = Algebras(FractionField(QQ['x']))\nsage: timeit(\"if C._cmp_key: del C._cmp_key\", number=100000)\n100000 loops, best of 3: 1.28 \u00b5s per loop\n```\n\nBut I think the startup time is what we are really interested in. My starting point is sage-5.11.b3 with these patches applied:\n\n```\ntrac_14471_dynamic_class_hash.patch\ntrac_14471-review.patch\ntrac_14516-crystals_speedup-ts.2.patch\ntrac_14722-lazy_import_at_startup-nt.patch\n```\n\nI am giving the total time provided by sage -startuptime, in 5 consecutive runs:\n\n```\nTotal time (sum over exclusive time): 1485.052ms\nTotal time (sum over exclusive time): 1499.287ms\nTotal time (sum over exclusive time): 1499.921ms\nTotal time (sum over exclusive time): 1492.086ms\nTotal time (sum over exclusive time): 1493.375ms\n```\n\nAfter applying the first two patches, I get:\n\n```\nTotal time (sum over exclusive time): 1495.342ms\nTotal time (sum over exclusive time): 1504.880ms\nTotal time (sum over exclusive time): 1502.199ms\nTotal time (sum over exclusive time): 1497.281ms\nTotal time (sum over exclusive time): 1508.277ms\n```\n\nAnd after applying the other two patches, I get:\n\n```\nTotal time (sum over exclusive time): 1499.909ms\nTotal time (sum over exclusive time): 1498.731ms\nTotal time (sum over exclusive time): 1499.289ms\nTotal time (sum over exclusive time): 1502.179ms\nTotal time (sum over exclusive time): 1489.887ms\n```\n\nI think one sees a tendency. But we'd really need to see what the startup-time plugin has to say!\n\nApply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch trac13589_cython_cmp_key.patch",
    "created_at": "2013-06-27T20:20:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161390",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:60'>**Comment 60:**</a>
I have cythoned the _cmp_key attribute of `CategoryWithParameters` as well. The raw improvement is:

Without the first two patches:

```
sage: C = Algebras(FractionField(QQ['x']))
sage: timeit("if C._cmp_key: del C._cmp_key", number=100000)
100000 loops, best of 3: 5.38 ¬µs per loop
```

With all patches:

```
sage: C = Algebras(FractionField(QQ['x']))
sage: timeit("if C._cmp_key: del C._cmp_key", number=100000)
100000 loops, best of 3: 1.28 ¬µs per loop
```

But I think the startup time is what we are really interested in. My starting point is sage-5.11.b3 with these patches applied:

```
trac_14471_dynamic_class_hash.patch
trac_14471-review.patch
trac_14516-crystals_speedup-ts.2.patch
trac_14722-lazy_import_at_startup-nt.patch
```

I am giving the total time provided by sage -startuptime, in 5 consecutive runs:

```
Total time (sum over exclusive time): 1485.052ms
Total time (sum over exclusive time): 1499.287ms
Total time (sum over exclusive time): 1499.921ms
Total time (sum over exclusive time): 1492.086ms
Total time (sum over exclusive time): 1493.375ms
```

After applying the first two patches, I get:

```
Total time (sum over exclusive time): 1495.342ms
Total time (sum over exclusive time): 1504.880ms
Total time (sum over exclusive time): 1502.199ms
Total time (sum over exclusive time): 1497.281ms
Total time (sum over exclusive time): 1508.277ms
```

And after applying the other two patches, I get:

```
Total time (sum over exclusive time): 1499.909ms
Total time (sum over exclusive time): 1498.731ms
Total time (sum over exclusive time): 1499.289ms
Total time (sum over exclusive time): 1502.179ms
Total time (sum over exclusive time): 1489.887ms
```

I think one sees a tendency. But we'd really need to see what the startup-time plugin has to say!

Apply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch trac13589_cython_cmp_key.patch



---

archive/issue_comments_161391.json:
```json
{
    "body": "<a id='comment:61'>**Comment 61:**</a>\nI don't know about statistics, but here it goes:\n\n```\nsage: T1 = stats.TimeSeries([1485.052,1499.287,1499.921,1492.086,1493.375])\nsage: T2 = stats.TimeSeries([1495.342,1504.880,1502.199,1497.281,1508.277])\nsage: T3 = stats.TimeSeries([1499.909,1498.731,1499.289,1502.179,1489.887])\nsage: T1.mean(), T1.variance()\n(1493.9442000000001, 36.77894170000064)\nsage: T2.mean(), T2.variance()\n(1501.5958, 28.378941700000148)\nsage: T3.mean(), T3.variance()\n(1497.999, 22.281242000000503)\n```\n\nI guess five runs are simply not enough to get anything significant, but the means seem to indicate that the last two patches reduce the regression by 50%. Admittedly, what is 4 ms, if the variance is 22 ms?",
    "created_at": "2013-06-27T20:54:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161391",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:61'>**Comment 61:**</a>
I don't know about statistics, but here it goes:

```
sage: T1 = stats.TimeSeries([1485.052,1499.287,1499.921,1492.086,1493.375])
sage: T2 = stats.TimeSeries([1495.342,1504.880,1502.199,1497.281,1508.277])
sage: T3 = stats.TimeSeries([1499.909,1498.731,1499.289,1502.179,1489.887])
sage: T1.mean(), T1.variance()
(1493.9442000000001, 36.77894170000064)
sage: T2.mean(), T2.variance()
(1501.5958, 28.378941700000148)
sage: T3.mean(), T3.variance()
(1497.999, 22.281242000000503)
```

I guess five runs are simply not enough to get anything significant, but the means seem to indicate that the last two patches reduce the regression by 50%. Admittedly, what is 4 ms, if the variance is 22 ms?



---

archive/issue_comments_161392.json:
```json
{
    "body": "<a id='comment:62'>**Comment 62:**</a>\nLet's try a bit more. I created time series T0,T1,T2 for 20 startup-time tests, for only the dependencies, the first two patches or all patches. I got time series\n\n```\nsage: sage: T0.list()\n[1489.553,\n 1480.942,\n 1478.854,\n 1486.503,\n 1475.071,\n 1475.266,\n 1479.731,\n 1476.892,\n 1496.149,\n 1489.795,\n 1485.942,\n 1492.043,\n 1484.346,\n 1482.017,\n 1488.826,\n 1473.604,\n 1490.681,\n 1488.502,\n 1488.512,\n 1485.275]\nsage: T1.list()\n[1549.77,\n 1533.565,\n 1530.685,\n 1532.984,\n 1530.423,\n 1528.377,\n 1534.03,\n 1522.763,\n 1534.116,\n 1531.709,\n 1529.705,\n 1561.183,\n 1534.724,\n 1524.297,\n 1533.473,\n 1540.683,\n 1531.19,\n 1528.275,\n 1524.075,\n 1527.196]\nsage: T2.list()\n[1499.464,\n 1493.059,\n 1506.909,\n 1486.872,\n 1493.657,\n 1496.276,\n 1496.01,\n 1493.497,\n 1497.991,\n 1492.52,\n 1488.484,\n 1515.637,\n 1483.794,\n 1496.187,\n 1492.245,\n 1496.936,\n 1492.311,\n 1490.689,\n 1495.659,\n 1490.345]\n```\nwith means and standard deviations\n\n```\nsage: T0.mean()\n1484.4252000000001\nsage: T0.standard_deviation()\n6.349568941854885\nsage: T1.mean()\n1533.16115\nsage: T1.standard_deviation()\n8.900689998533823\nsage: T2.mean()\n1494.9271000000003\nsage: T2.standard_deviation()\n6.912493905203355\n```\n\nI have no idea how to compute from these data whether there is a significant increase of x% of startup time.",
    "created_at": "2013-06-27T22:14:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161392",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:62'>**Comment 62:**</a>
Let's try a bit more. I created time series T0,T1,T2 for 20 startup-time tests, for only the dependencies, the first two patches or all patches. I got time series

```
sage: sage: T0.list()
[1489.553,
 1480.942,
 1478.854,
 1486.503,
 1475.071,
 1475.266,
 1479.731,
 1476.892,
 1496.149,
 1489.795,
 1485.942,
 1492.043,
 1484.346,
 1482.017,
 1488.826,
 1473.604,
 1490.681,
 1488.502,
 1488.512,
 1485.275]
sage: T1.list()
[1549.77,
 1533.565,
 1530.685,
 1532.984,
 1530.423,
 1528.377,
 1534.03,
 1522.763,
 1534.116,
 1531.709,
 1529.705,
 1561.183,
 1534.724,
 1524.297,
 1533.473,
 1540.683,
 1531.19,
 1528.275,
 1524.075,
 1527.196]
sage: T2.list()
[1499.464,
 1493.059,
 1506.909,
 1486.872,
 1493.657,
 1496.276,
 1496.01,
 1493.497,
 1497.991,
 1492.52,
 1488.484,
 1515.637,
 1483.794,
 1496.187,
 1492.245,
 1496.936,
 1492.311,
 1490.689,
 1495.659,
 1490.345]
```
with means and standard deviations

```
sage: T0.mean()
1484.4252000000001
sage: T0.standard_deviation()
6.349568941854885
sage: T1.mean()
1533.16115
sage: T1.standard_deviation()
8.900689998533823
sage: T2.mean()
1494.9271000000003
sage: T2.standard_deviation()
6.912493905203355
```

I have no idea how to compute from these data whether there is a significant increase of x% of startup time.



---

archive/issue_comments_161393.json:
```json
{
    "body": "**Changing author** from \"Nicolas M. Thi\u00e9ry\" to \"Nicolas M. Thi\u00e9ry, Simon King\".",
    "created_at": "2013-06-28T11:55:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161393",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing author** from "Nicolas M. Thi√©ry" to "Nicolas M. Thi√©ry, Simon King".



---

archive/issue_comments_161394.json:
```json
{
    "body": "**Work Issues:** Add tests in c3_controlled",
    "created_at": "2013-06-28T11:55:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161394",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** Add tests in c3_controlled



---

archive/issue_comments_161395.json:
```json
{
    "body": "<a id='comment:63'>**Comment 63:**</a>\nHooray!!!!! Did you see what the patchbot plugins have to tell??\n\n- Doctest coverage: `+Missing doctests  misc/c3_controlled.pyx 18 / 20 = 90%`. That's my fault, I need to add tests for the functions I introduced.\n\n- Startup modules: Of course, there is now c3_controlled. No surprise and now problem\n\n- Startup time:\n\n  ```\n  -Main:   1.5331 sec (30 samples, std_dev=0.0508)\n  -Ticket: 1.5186 sec (30 samples, std_dev=0.0525)\n  +real\t0m1.482s\n  +user\t0m1.243s\n  +sys\t0m0.227s\n  +9, 1.5900211334228516, 1.6482288837432861, 1.5097029209136963, 1.4862918853759766, 1.623434066772461, 1.4829378128051758, 1.582334041595459, 1.6098928451538086, 1.554724931716919, 1.5065560340881348, 1.495615005493164, 1.5109539031982422, 1.5232598781585693, 1.4945759773254395, 1.4797320365905762, 1.6103341579437256, 1.5885298252105713, 1.5899219512939453, 1.4962730407714844, 1.5993151664733887, 1.5715739727020264, 1.5021510124206543, 1.5274248123168945, 1.4769189357757568, 1.6029491424560547, 1.625540018081665, 1.6075868606567383, 1.5096728801727295, 1.6023800373077393]\n  \n  -Average decrease of 0.014 secs or 0.94%.\n  +Main:   1.5629 sec (30 samples, std_dev=0.0471)\n  +Ticket: 1.5551 sec (30 samples, std_dev=0.0561)\n  +\n  +Average decrease of 0.0079 secs or 0.5%.\n  \n  -No statistically significant difference.\n  +With 32% confidence, startup time decreased by at least 0.25%\n  +With 44% confidence, startup time decreased by at least 0.1%\n  ```\n\nIn other words, the problem is solved!\n\nI think I can give your patch a positive review. My patches are big enough so that I should add me as author, and someone else needs to review them. And I will soon add the missing tests in C3_controlled.",
    "created_at": "2013-06-28T11:55:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161395",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:63'>**Comment 63:**</a>
Hooray!!!!! Did you see what the patchbot plugins have to tell??

- Doctest coverage: `+Missing doctests  misc/c3_controlled.pyx 18 / 20 = 90%`. That's my fault, I need to add tests for the functions I introduced.

- Startup modules: Of course, there is now c3_controlled. No surprise and now problem

- Startup time:

  ```
  -Main:   1.5331 sec (30 samples, std_dev=0.0508)
  -Ticket: 1.5186 sec (30 samples, std_dev=0.0525)
  +real	0m1.482s
  +user	0m1.243s
  +sys	0m0.227s
  +9, 1.5900211334228516, 1.6482288837432861, 1.5097029209136963, 1.4862918853759766, 1.623434066772461, 1.4829378128051758, 1.582334041595459, 1.6098928451538086, 1.554724931716919, 1.5065560340881348, 1.495615005493164, 1.5109539031982422, 1.5232598781585693, 1.4945759773254395, 1.4797320365905762, 1.6103341579437256, 1.5885298252105713, 1.5899219512939453, 1.4962730407714844, 1.5993151664733887, 1.5715739727020264, 1.5021510124206543, 1.5274248123168945, 1.4769189357757568, 1.6029491424560547, 1.625540018081665, 1.6075868606567383, 1.5096728801727295, 1.6023800373077393]
  
  -Average decrease of 0.014 secs or 0.94%.
  +Main:   1.5629 sec (30 samples, std_dev=0.0471)
  +Ticket: 1.5551 sec (30 samples, std_dev=0.0561)
  +
  +Average decrease of 0.0079 secs or 0.5%.
  
  -No statistically significant difference.
  +With 32% confidence, startup time decreased by at least 0.25%
  +With 44% confidence, startup time decreased by at least 0.1%
  ```

In other words, the problem is solved!

I think I can give your patch a positive review. My patches are big enough so that I should add me as author, and someone else needs to review them. And I will soon add the missing tests in C3_controlled.



---

archive/issue_comments_161396.json:
```json
{
    "body": "<a id='comment:64'>**Comment 64:**</a>\nConcerning a small function I added:\n\n```\nsage: from operator import attrgetter\nsage: f = attrgetter(\"_cmp_key\")\nsage: C = Rings()\nsage: %timeit a = f(C)\n1000000 loops, best of 3: 439 ns per loop\nsage: from sage.misc.c3_controlled import category_sort_key\nsage: %timeit a = category_sort_key(C)\n10000000 loops, best of 3: 154 ns per loop\n```\n\nThat's why I added it (and: It is cpdef inline, hence, if Cython is clever, the speed difference with attrgetter will be even better).",
    "created_at": "2013-06-28T12:07:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161396",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:64'>**Comment 64:**</a>
Concerning a small function I added:

```
sage: from operator import attrgetter
sage: f = attrgetter("_cmp_key")
sage: C = Rings()
sage: %timeit a = f(C)
1000000 loops, best of 3: 439 ns per loop
sage: from sage.misc.c3_controlled import category_sort_key
sage: %timeit a = category_sort_key(C)
10000000 loops, best of 3: 154 ns per loop
```

That's why I added it (and: It is cpdef inline, hence, if Cython is clever, the speed difference with attrgetter will be even better).



---

archive/issue_comments_161397.json:
```json
{
    "body": "Another attempt to make the startup faster",
    "created_at": "2013-06-28T12:07:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161397",
    "user": "https://github.com/simon-king-jena"
}
```

Another attempt to make the startup faster



---

archive/issue_comments_161398.json:
```json
{
    "body": "**Changing work issues** from \"Add tests in c3_controlled\" to \"\".",
    "created_at": "2013-06-28T12:08:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161398",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work issues** from "Add tests in c3_controlled" to "".



---

archive/issue_comments_161399.json:
```json
{
    "body": "<a id='comment:65'>**Comment 65:**</a>\n**Attachment:** [trac13589_cython_cmp_key.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch.gz)\n\nI have added the two missing tests, updating the cython_cmp_key patch.\n\nApply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch trac13589_cython_cmp_key.patch",
    "created_at": "2013-06-28T12:08:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161399",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:65'>**Comment 65:**</a>
**Attachment:** [trac13589_cython_cmp_key.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch.gz)

I have added the two missing tests, updating the cython_cmp_key patch.

Apply trac_13589-categories-c3_under_control-nt.patch trac13589_cmp_key_attribute.patch trac13589_improve_startuptime.patch trac13589_cython_cmp_key.patch



---

archive/issue_comments_161400.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -62,14 +62,6 @@\n \n - Extract category_sample from category_graph\n \n-Apply\n------\n-\n-- [attachment:trac_13589-categories-c3_under_control-nt.patch]\n-- [attachment:trac13589_cmp_key_attribute.patch]\n-- [attachment:trac13589_improve_startuptime.patch]\n-- [attachment:trac13589_cython_cmp_key.patch]\n-\n Credits\n -------\n \n@@ -78,3 +70,9 @@\n implementation of C3.\n ```\n \n+**__Apply__**\n+\n+- [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)\n+- [attachment:trac13589_cmp_key_attribute.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch)\n+- [attachment:trac13589_improve_startuptime.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch)\n+- [attachment:trac13589_cython_cmp_key.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch)\n``````\n",
    "created_at": "2013-06-28T12:11:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161400",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -62,14 +62,6 @@
 
 - Extract category_sample from category_graph
 
-Apply
------
-
-- [attachment:trac_13589-categories-c3_under_control-nt.patch]
-- [attachment:trac13589_cmp_key_attribute.patch]
-- [attachment:trac13589_improve_startuptime.patch]
-- [attachment:trac13589_cython_cmp_key.patch]
-
 Credits
 -------
 
@@ -78,3 +70,9 @@
 implementation of C3.
 ```
 
+**__Apply__**
+
+- [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)
+- [attachment:trac13589_cmp_key_attribute.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch)
+- [attachment:trac13589_improve_startuptime.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch)
+- [attachment:trac13589_cython_cmp_key.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch)
``````




---

archive/issue_comments_161401.json:
```json
{
    "body": "<a id='comment:67'>**Comment 67:**</a>\nNow there is a second patchbot commenting: It finds 0.5% regression (not 5%)!",
    "created_at": "2013-06-28T13:15:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161401",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:67'>**Comment 67:**</a>
Now there is a second patchbot commenting: It finds 0.5% regression (not 5%)!



---

archive/issue_comments_161402.json:
```json
{
    "body": "<a id='comment:68'>**Comment 68:**</a>\nReplying to [@simon-king-jena](#comment%3A67):\n> Now there is a second patchbot commenting: It finds 0.5% regression (not 5%)!\n\nI misread. 0.5% is not significant. Only 0.25% is significant. So, virtually nothing.",
    "created_at": "2013-06-28T13:20:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161402",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:68'>**Comment 68:**</a>
Replying to [@simon-king-jena](#comment%3A67):
> Now there is a second patchbot commenting: It finds 0.5% regression (not 5%)!

I misread. 0.5% is not significant. Only 0.25% is significant. So, virtually nothing.



---

archive/issue_comments_161403.json:
```json
{
    "body": "<a id='comment:69'>**Comment 69:**</a>\nOh wow!\n\nCongrats Simon :-) \n\nI was not expecting we could really do anything about that, and had just sent an e-mail to sage-devel; counter e-mail sent!\n\nThanks a lot, I'll review your patches!",
    "created_at": "2013-06-28T13:25:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161403",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:69'>**Comment 69:**</a>
Oh wow!

Congrats Simon :-) 

I was not expecting we could really do anything about that, and had just sent an e-mail to sage-devel; counter e-mail sent!

Thanks a lot, I'll review your patches!



---

archive/issue_comments_161404.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -76,3 +76,5 @@\n - [attachment:trac13589_cmp_key_attribute.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch)\n - [attachment:trac13589_improve_startuptime.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch)\n - [attachment:trac13589_cython_cmp_key.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch)\n+- [attachment:trac13589_cython_cmp_key-review-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key-review-nt.patch)\n+\n``````\n",
    "created_at": "2013-07-02T16:29:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161404",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -76,3 +76,5 @@
 - [attachment:trac13589_cmp_key_attribute.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch)
 - [attachment:trac13589_improve_startuptime.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch)
 - [attachment:trac13589_cython_cmp_key.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch)
+- [attachment:trac13589_cython_cmp_key-review-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key-review-nt.patch)
+
``````




---

archive/issue_comments_161405.json:
```json
{
    "body": "<a id='comment:71'>**Comment 71:**</a>\nI started to work on the things we had discussed over the phone. I attached the preliminary patch to see what the patchbot says.",
    "created_at": "2013-07-02T16:33:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161405",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:71'>**Comment 71:**</a>
I started to work on the things we had discussed over the phone. I attached the preliminary patch to see what the patchbot says.



---

archive/issue_comments_161406.json:
```json
{
    "body": "<a id='comment:72'>**Comment 72:**</a>\nOne typo in the review patch: \"It is sematically equivalent\" should be \"It is semantically equivalent\". Also I think you mean\n\n```\n:func:`operator.attrgetter```(\"cmp_key\")``\n```\nnot\n\n```\n:func:`operator.attrgetter```(category)``\n```\n\nI wonder: You changed the default sort function from `category_sort_key` to `identity` (as we agreed on by phone), but you do not explicitly use the now non-default `category_sort_key` when calling c3_sorted_merge in sage.categories.category, isn't it? That should be fixed.",
    "created_at": "2013-07-02T21:13:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161406",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:72'>**Comment 72:**</a>
One typo in the review patch: "It is sematically equivalent" should be "It is semantically equivalent". Also I think you mean

```
:func:`operator.attrgetter```("cmp_key")``
```
not

```
:func:`operator.attrgetter```(category)``
```

I wonder: You changed the default sort function from `category_sort_key` to `identity` (as we agreed on by phone), but you do not explicitly use the now non-default `category_sort_key` when calling c3_sorted_merge in sage.categories.category, isn't it? That should be fixed.



---

archive/issue_comments_161407.json:
```json
{
    "body": "<a id='comment:73'>**Comment 73:**</a>\nWorse: Compilation of sage.misc.c3_controlled fails with\n\n```\nError compiling Cython file:\n------------------------------------------------------------\n...\n\n        sage: from sage.misc.c3_controlled import category_sort_key\n        sage: category_sort_key(Rings()) is Rings()._cmp_key\n        True\n    \"\"\"\n    return C._cmp_key\n           ^\n------------------------------------------------------------\n\nsage/misc/c3_controlled.pyx:377:12: undeclared name not builtin: C\n```",
    "created_at": "2013-07-02T21:19:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161407",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:73'>**Comment 73:**</a>
Worse: Compilation of sage.misc.c3_controlled fails with

```
Error compiling Cython file:
------------------------------------------------------------
...

        sage: from sage.misc.c3_controlled import category_sort_key
        sage: category_sort_key(Rings()) is Rings()._cmp_key
        True
    """
    return C._cmp_key
           ^
------------------------------------------------------------

sage/misc/c3_controlled.pyx:377:12: undeclared name not builtin: C
```



---

archive/issue_comments_161408.json:
```json
{
    "body": "<a id='comment:74'>**Comment 74:**</a>\nAfter trivially changing it, building Sage works, but it crashes at startup with\n\n```\n/home/simon/SAGE/prerelease/sage-5.11.beta3/local/lib/python2.7/site-packages/sage/categories/category.pyc in _all_super_categories(self=Category of category_singleton)\n    871              Category of rngs,\n    872              Category of semirings,\n    873              Category of monoids,\n    874              Category of semigroups,\n    875              Category of magmas,\n    876              Category of commutative additive groups,\n    877              Category of commutative additive monoids,\n    878              Category of commutative additive semigroups,\n    879              Category of additive magmas,\n    880              Category of sets,\n    881              Category of sets with partial maps,\n    882              Category of objects]\n    883         \"\"\"\n    884         (result, bases) = C3_sorted_merge([cat._all_super_categories\n    885                                            for cat in self._super_categories] +\n--> 886                                           [self._super_categories])\n        self._super_categories = [Category of rngs, Category of semirings]\n    887         self._super_categories_for_classes = bases\n    888         return [self] + result\n    889 \n    890     @lazy_attribute\n    891     def _all_super_categories_proper(self):\n    892         r\"\"\"\n    893         All the proper super categories of this category.\n    894 \n    895         Since :trac:`11943`, the order of super categories is\n    896         determined by Python's method resolution order C3 algorithm.\n    897 \n    898         .. seealso:: :meth:`all_super_categories`\n    899 \n    900         .. note:: this attribute is likely to eventually become a tuple.\n    901 \n\n/home/simon/SAGE/prerelease/sage-5.11.beta3/local/lib/python2.7/site-packages/sage/misc/c3_controlled.so in sage.misc.c3_controlled.C3_sorted_merge (sage/misc/c3_controlled.c:4377)()\n\nKeyError: Category of sets\n```\n\nBut this can be fixed by using `key=category_sort_key` in C3_sorted_merge.\n\nHence, with the following diff, Sage starts:\n\n```diff\ndiff --git a/sage/categories/category.py b/sage/categories/category.py\n--- a/sage/categories/category.py\n+++ b/sage/categories/category.py\n@@ -883,7 +883,8 @@\n         \"\"\"\n         (result, bases) = C3_sorted_merge([cat._all_super_categories\n                                            for cat in self._super_categories] +\n-                                          [self._super_categories])\n+                                          [self._super_categories],\n+                                          key = category_sort_key)\n         self._super_categories_for_classes = bases\n         return [self] + result\n \ndiff --git a/sage/misc/c3_controlled.pyx b/sage/misc/c3_controlled.pyx\n--- a/sage/misc/c3_controlled.pyx\n+++ b/sage/misc/c3_controlled.pyx\n@@ -374,7 +374,7 @@\n         sage: category_sort_key(Rings()) is Rings()._cmp_key\n         True\n     \"\"\"\n-    return C._cmp_key\n+    return category._cmp_key\n \n cdef class CmpKey:\n     r\"\"\"\n```",
    "created_at": "2013-07-02T21:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161408",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:74'>**Comment 74:**</a>
After trivially changing it, building Sage works, but it crashes at startup with

```
/home/simon/SAGE/prerelease/sage-5.11.beta3/local/lib/python2.7/site-packages/sage/categories/category.pyc in _all_super_categories(self=Category of category_singleton)
    871              Category of rngs,
    872              Category of semirings,
    873              Category of monoids,
    874              Category of semigroups,
    875              Category of magmas,
    876              Category of commutative additive groups,
    877              Category of commutative additive monoids,
    878              Category of commutative additive semigroups,
    879              Category of additive magmas,
    880              Category of sets,
    881              Category of sets with partial maps,
    882              Category of objects]
    883         """
    884         (result, bases) = C3_sorted_merge([cat._all_super_categories
    885                                            for cat in self._super_categories] +
--> 886                                           [self._super_categories])
        self._super_categories = [Category of rngs, Category of semirings]
    887         self._super_categories_for_classes = bases
    888         return [self] + result
    889 
    890     @lazy_attribute
    891     def _all_super_categories_proper(self):
    892         r"""
    893         All the proper super categories of this category.
    894 
    895         Since :trac:`11943`, the order of super categories is
    896         determined by Python's method resolution order C3 algorithm.
    897 
    898         .. seealso:: :meth:`all_super_categories`
    899 
    900         .. note:: this attribute is likely to eventually become a tuple.
    901 

/home/simon/SAGE/prerelease/sage-5.11.beta3/local/lib/python2.7/site-packages/sage/misc/c3_controlled.so in sage.misc.c3_controlled.C3_sorted_merge (sage/misc/c3_controlled.c:4377)()

KeyError: Category of sets
```

But this can be fixed by using `key=category_sort_key` in C3_sorted_merge.

Hence, with the following diff, Sage starts:

```diff
diff --git a/sage/categories/category.py b/sage/categories/category.py
--- a/sage/categories/category.py
+++ b/sage/categories/category.py
@@ -883,7 +883,8 @@
         """
         (result, bases) = C3_sorted_merge([cat._all_super_categories
                                            for cat in self._super_categories] +
-                                          [self._super_categories])
+                                          [self._super_categories],
+                                          key = category_sort_key)
         self._super_categories_for_classes = bases
         return [self] + result
 
diff --git a/sage/misc/c3_controlled.pyx b/sage/misc/c3_controlled.pyx
--- a/sage/misc/c3_controlled.pyx
+++ b/sage/misc/c3_controlled.pyx
@@ -374,7 +374,7 @@
         sage: category_sort_key(Rings()) is Rings()._cmp_key
         True
     """
-    return C._cmp_key
+    return category._cmp_key
 
 cdef class CmpKey:
     r"""
```



---

archive/issue_comments_161409.json:
```json
{
    "body": "<a id='comment:75'>**Comment 75:**</a>\nOops, sorry for the wasted time; I posted this in a rush and it was half baked with the last round of changes not tested ... Here is an updated patch which fixes the mentionned issues.",
    "created_at": "2013-07-03T05:32:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161409",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:75'>**Comment 75:**</a>
Oops, sorry for the wasted time; I posted this in a rush and it was half baked with the last round of changes not tested ... Here is an updated patch which fixes the mentionned issues.



---

archive/issue_comments_161410.json:
```json
{
    "body": "<a id='comment:76'>**Comment 76:**</a>\n**Attachment:** [trac13589_cython_cmp_key-review-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key-review-nt.patch.gz)\n\nThe patch looks good. I only wonder about the findings of the startup-time plugin.",
    "created_at": "2013-07-03T10:39:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161410",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:76'>**Comment 76:**</a>
**Attachment:** [trac13589_cython_cmp_key-review-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key-review-nt.patch.gz)

The patch looks good. I only wonder about the findings of the startup-time plugin.



---

archive/issue_comments_161411.json:
```json
{
    "body": "<a id='comment:77'>**Comment 77:**</a>\nWhy the heck is no patchbot giving a result? It is now 15 hours after attaching the review patch!",
    "created_at": "2013-07-03T20:57:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161411",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:77'>**Comment 77:**</a>
Why the heck is no patchbot giving a result? It is now 15 hours after attaching the review patch!



---

archive/issue_events_160883.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-04T18:43:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160883"
}
```



---

archive/issue_events_160884.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-04T18:43:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160884"
}
```



---

archive/issue_comments_161412.json:
```json
{
    "body": "**Work Issues:** commit message for review patch",
    "created_at": "2013-07-04T18:43:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161412",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** commit message for review patch



---

archive/issue_comments_161413.json:
```json
{
    "body": "<a id='comment:78'>**Comment 78:**</a>\nHooray, patchbot is back, and says:\n\n```\n+With 60% confidence, startup time increased by at least 0.5%\n+With 96% confidence, startup time increased by at least 0.25%\n+With 99.1% confidence, startup time increased by at least 0.1%\n```\n\n60% confidence is not significant, hence, we only have a significant regression of 0.25%, which I deem acceptable and a price worth paying.\n\nSo, I'm already putting it to positive review, but please add a proper commit message to the review patch!",
    "created_at": "2013-07-04T18:43:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161413",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:78'>**Comment 78:**</a>
Hooray, patchbot is back, and says:

```
+With 60% confidence, startup time increased by at least 0.5%
+With 96% confidence, startup time increased by at least 0.25%
+With 99.1% confidence, startup time increased by at least 0.1%
```

60% confidence is not significant, hence, we only have a significant regression of 0.25%, which I deem acceptable and a price worth paying.

So, I'm already putting it to positive review, but please add a proper commit message to the review patch!



---

archive/issue_comments_161414.json:
```json
{
    "body": "<a id='comment:79'>**Comment 79:**</a>\nExcellent! I'll fold the patches together and double check the commit message tomorrow.",
    "created_at": "2013-07-05T00:10:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161414",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:79'>**Comment 79:**</a>
Excellent! I'll fold the patches together and double check the commit message tomorrow.



---

archive/issue_comments_161415.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -73,8 +73,4 @@\n **__Apply__**\n \n - [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)\n-- [attachment:trac13589_cmp_key_attribute.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch)\n-- [attachment:trac13589_improve_startuptime.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch)\n-- [attachment:trac13589_cython_cmp_key.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch)\n-- [attachment:trac13589_cython_cmp_key-review-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key-review-nt.patch)\n \n``````\n",
    "created_at": "2013-07-05T10:14:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161415",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -73,8 +73,4 @@
 **__Apply__**
 
 - [attachment:trac_13589-categories-c3_under_control-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch)
-- [attachment:trac13589_cmp_key_attribute.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cmp_key_attribute.patch)
-- [attachment:trac13589_improve_startuptime.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_improve_startuptime.patch)
-- [attachment:trac13589_cython_cmp_key.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key.patch)
-- [attachment:trac13589_cython_cmp_key-review-nt.patch](https://github.com/sagemath/sage/files/ticket13589/trac13589_cython_cmp_key-review-nt.patch)
 
``````




---

archive/issue_comments_161416.json:
```json
{
    "body": "**Changing work issues** from \"commit message for review patch\" to \"\".",
    "created_at": "2013-07-05T10:14:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161416",
    "user": "https://github.com/nthiery"
}
```

**Changing work issues** from "commit message for review patch" to "".



---

archive/issue_comments_161417.json:
```json
{
    "body": "**Attachment:** [trac_13589-categories-c3_under_control-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch.gz)",
    "created_at": "2013-07-05T10:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161417",
    "user": "https://github.com/nthiery"
}
```

**Attachment:** [trac_13589-categories-c3_under_control-nt.patch.gz](https://github.com/sagemath/sage/files/ticket13589/trac_13589-categories-c3_under_control-nt.patch.gz)



---

archive/issue_comments_161418.json:
```json
{
    "body": "<a id='comment:81'>**Comment 81:**</a>\nPatchbot getting confused again about which patch to apply.\n\nApply: trac_13589-categories-c3_under_control-nt.patch\n\nGetting really tired of this ...",
    "created_at": "2013-07-13T12:15:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161418",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:81'>**Comment 81:**</a>
Patchbot getting confused again about which patch to apply.

Apply: trac_13589-categories-c3_under_control-nt.patch

Getting really tired of this ...



---

archive/issue_comments_161419.json:
```json
{
    "body": "<a id='comment:82'>**Comment 82:**</a>\nWithout the colon perhaps?\n\napply trac_13589-categories-c3_under_control-nt.patch\n\n(No idea how it works, I just want all the stuff depending on this to be checked.)",
    "created_at": "2013-07-23T09:50:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161419",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:82'>**Comment 82:**</a>
Without the colon perhaps?

apply trac_13589-categories-c3_under_control-nt.patch

(No idea how it works, I just want all the stuff depending on this to be checked.)



---

archive/issue_events_160885.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-24T06:25:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160885"
}
```



---

archive/issue_events_160886.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-24T06:25:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160886"
}
```



---

archive/issue_events_160887.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-02T14:15:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160887"
}
```



---

archive/issue_events_160888.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-02T14:15:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13589#event-160888"
}
```



---

archive/issue_comments_161420.json:
```json
{
    "body": "**Merged:** sage-5.12.beta0",
    "created_at": "2013-08-02T14:15:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161420",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.12.beta0



---

archive/issue_comments_161421.json:
```json
{
    "body": "<a id='comment:85'>**Comment 85:**</a>\nWhile looking through the Sage sources, I noticed the following doctest, coming from this ticket:\n\n```\n    sage: for l in L:\n    ....:     x = HierarchyElement(10, l.to_poset())\n    ....:     try:\n    ....:         x.mro_standard\n    ....:         assert False\n    ....:     except:\n    ....:         pass\n    ....:     assert x.mro            == list(P)\n    ....:     assert x.mro_controlled == list(P)\n    ....:     assert x.all_bases_len() == 15\n    ....:     stats.append(x.all_bases_controlled_len()-x.all_bases_len())\n```\n\nWhat is the purpose of the `assert False` here? I am asking because\n\n```\ntry:\n    foo()\n    assert False\nexcept:\n    pass\n```\nis entirely equivalent to\n\n```\ntry:\n    foo()\nexcept:\n    pass\n```",
    "created_at": "2014-08-20T11:27:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161421",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:85'>**Comment 85:**</a>
While looking through the Sage sources, I noticed the following doctest, coming from this ticket:

```
    sage: for l in L:
    ....:     x = HierarchyElement(10, l.to_poset())
    ....:     try:
    ....:         x.mro_standard
    ....:         assert False
    ....:     except:
    ....:         pass
    ....:     assert x.mro            == list(P)
    ....:     assert x.mro_controlled == list(P)
    ....:     assert x.all_bases_len() == 15
    ....:     stats.append(x.all_bases_controlled_len()-x.all_bases_len())
```

What is the purpose of the `assert False` here? I am asking because

```
try:
    foo()
    assert False
except:
    pass
```
is entirely equivalent to

```
try:
    foo()
except:
    pass
```



---

archive/issue_comments_161422.json:
```json
{
    "body": "<a id='comment:86'>**Comment 86:**</a>\n**bump**",
    "created_at": "2014-10-01T06:33:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161422",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:86'>**Comment 86:**</a>
**bump**



---

archive/issue_comments_161423.json:
```json
{
    "body": "<a id='comment:87'>**Comment 87:**</a>\nReplying to [@jdemeyer](#comment%3A86):\n> **bump**\n\nThanks for spotting, that was an oversight indeed! See #17106 (needs review).",
    "created_at": "2014-10-06T16:59:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13589#issuecomment-161423",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:87'>**Comment 87:**</a>
Replying to [@jdemeyer](#comment%3A86):
> **bump**

Thanks for spotting, that was an oversight indeed! See #17106 (needs review).
