# Issue 13579: Python sys.path security risk

archive/issues_013375.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-mvngu"
    ],
    "body": "`test_executable` runs various executables in `/tmp`. When running a script, Python puts the directory containing that script in `sys.path`. Therefore, it is trivial for any user to have code executed by the user running the doctests. For example:\n\n```\n[eviluser@hostname ~]$ echo 'print \"EVIL!!\"' > /tmp/socket.py\n...\n[vbraun@hostname ~]$ sage -t -force_lib devel/sage/sage/tests/cmdline.py\nsage -t -force_lib \"devel/sage/sage/tests/cmdline.py\"       \n**********************************************************************\nFile \"/home/vbraun/opt/sage-5.4.beta1/devel/sage/sage/tests/cmdline.py\", line 248:\n    sage: print out\nExpected:\n    1\nGot:\n    EVIL!!\n```\n`test_executable` should securely create a temp directory and run the executable in there.\n\n**Apply**:\n1. [attachment: 13579_sagelib.patch](https://github.com/sagemath/sage/files/ticket13579/13579_sagelib.patch.gz) to the Sage library.\n2. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).\n3. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n\n*Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)\n\n*See also*: [https://github.com/ipython/ipython/issues/7044](https://github.com/ipython/ipython/issues/7044)\n\nCC:  @jdemeyer\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Volker Braun, Jeroen Demeyer, David Roe**\n\nAuthor: **Jeroen Demeyer, Volker Braun**\n\nMerged: **sage-5.4.rc2**\n\nComponent: **doctest coverage**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13579_\n\n",
    "closed_at": "2012-10-18T19:09:41Z",
    "created_at": "2012-10-07T15:32:57Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Python sys.path security risk",
    "type": "issue",
    "updated_at": "2018-10-10T12:24:17Z",
    "url": "https://github.com/sagemath/sage/issues/13579",
    "user": "https://github.com/vbraun"
}
```
`test_executable` runs various executables in `/tmp`. When running a script, Python puts the directory containing that script in `sys.path`. Therefore, it is trivial for any user to have code executed by the user running the doctests. For example:

```
[eviluser@hostname ~]$ echo 'print "EVIL!!"' > /tmp/socket.py
...
[vbraun@hostname ~]$ sage -t -force_lib devel/sage/sage/tests/cmdline.py
sage -t -force_lib "devel/sage/sage/tests/cmdline.py"       
**********************************************************************
File "/home/vbraun/opt/sage-5.4.beta1/devel/sage/sage/tests/cmdline.py", line 248:
    sage: print out
Expected:
    1
Got:
    EVIL!!
```
`test_executable` should securely create a temp directory and run the executable in there.

**Apply**:
1. [attachment: 13579_sagelib.patch](https://github.com/sagemath/sage/files/ticket13579/13579_sagelib.patch.gz) to the Sage library.
2. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).
3. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))

*Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)

*See also*: [https://github.com/ipython/ipython/issues/7044](https://github.com/ipython/ipython/issues/7044)

CC:  @jdemeyer

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Volker Braun, Jeroen Demeyer, David Roe**

Author: **Jeroen Demeyer, Volker Braun**

Merged: **sage-5.4.rc2**

Component: **doctest coverage**

_Issue created by migration from https://trac.sagemath.org/ticket/13579_





---

archive/issue_events_187855.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-07T15:32:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "milestone_number": null,
    "milestone_title": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187855"
}
```



---

archive/issue_events_187856.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-07T15:32:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187856"
}
```



---

archive/issue_events_187857.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-07T15:32:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187857"
}
```



---

archive/issue_events_187858.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-07T15:32:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187858"
}
```



---

archive/issue_events_187859.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2012-10-07T15:32:57Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187859"
}
```



---

archive/issue_comments_158588.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-`test_executable` runs various executables in `/tmp`. Since Python has `.` in `sys.path`, it is trivial for any user to have code executed by the user running the doctests. For example:\n+`test_executable` runs various executables in `/tmp`. When running a script, Python puts the directory containing that script in `sys.path`. Therefore, it is trivial for any user to have code executed by the user running the doctests. For example:\n \n ```\n [eviluser@hostname ~]$ echo 'print \"EVIL!!\"' > /tmp/socket.py\n``````\n",
    "created_at": "2012-10-08T08:31:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158588",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-`test_executable` runs various executables in `/tmp`. Since Python has `.` in `sys.path`, it is trivial for any user to have code executed by the user running the doctests. For example:
+`test_executable` runs various executables in `/tmp`. When running a script, Python puts the directory containing that script in `sys.path`. Therefore, it is trivial for any user to have code executed by the user running the doctests. For example:
 
 ```
 [eviluser@hostname ~]$ echo 'print "EVIL!!"' > /tmp/socket.py
``````




---

archive/issue_events_187860.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-08T08:32:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "milestone_number": null,
    "milestone_title": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187860"
}
```



---

archive/issue_events_187861.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-08T08:32:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "milestone_number": null,
    "milestone_title": "sage-5.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187861"
}
```



---

archive/issue_comments_158589.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAttachment: **[13579_secure_tmp.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz)**\n\nOops, looks like we did it at the same time.",
    "created_at": "2012-10-08T09:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158589",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:3" align="right">comment:3</div>

Attachment: **[13579_secure_tmp.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz)**

Oops, looks like we did it at the same time.



---

archive/issue_comments_158590.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI'm fine with your patch. All doctests pass with both patches applied.",
    "created_at": "2012-10-08T13:31:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158590",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

I'm fine with your patch. All doctests pass with both patches applied.



---

archive/issue_events_187862.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-08T13:31:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187862"
}
```



---

archive/issue_comments_158591.json:
```json
{
    "body": "Reviewer: **Volker Braun, Jeroen Demeyer**",
    "created_at": "2012-10-08T13:31:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158591",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun, Jeroen Demeyer**



---

archive/issue_comments_158592.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,3 +14,5 @@\n     EVIL!!\n ```\n `test_executable` should securely create a temp directory and run the executable in there.\n+\n+Attach [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n``````\n",
    "created_at": "2012-10-08T13:31:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158592",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,3 +14,5 @@
     EVIL!!
 ```
 `test_executable` should securely create a temp directory and run the executable in there.
+
+Attach [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
``````




---

archive/issue_comments_158593.json:
```json
{
    "body": "Author: **Jeroen Demeyer, Volker Braun**",
    "created_at": "2012-10-08T13:31:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158593",
    "user": "https://github.com/vbraun"
}
```

Author: **Jeroen Demeyer, Volker Braun**



---

archive/issue_comments_158594.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,4 +15,4 @@\n ```\n `test_executable` should securely create a temp directory and run the executable in there.\n \n-Attach [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n+Apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n``````\n",
    "created_at": "2012-10-08T13:32:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158594",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,4 +15,4 @@
 ```
 `test_executable` should securely create a temp directory and run the executable in there.
 
-Attach [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
+Apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
``````




---

archive/issue_comments_158595.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI'd say that the function `get_tmpdir()` is a bit overkill.\n\nWhy not simply put\n\n```\nsage: test_tmpdir = tmp_dir('cmdline_test_')\n```\ninside the doctest?",
    "created_at": "2012-10-08T13:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158595",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

I'd say that the function `get_tmpdir()` is a bit overkill.

Why not simply put

```
sage: test_tmpdir = tmp_dir('cmdline_test_')
```
inside the doctest?



---

archive/issue_comments_158596.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIn the doctests there is also the case where you check that you can read from the current dir, so you need to create a file in the tmp dir and execute in the same dir. Hence its important that the name is cached in `sage.tests.cmdline`...",
    "created_at": "2012-10-08T13:45:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158596",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

In the doctests there is also the case where you check that you can read from the current dir, so you need to create a file in the tmp dir and execute in the same dir. Hence its important that the name is cached in `sage.tests.cmdline`...



---

archive/issue_comments_158597.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@vbraun](#comment%3A7):\n> execute in the same dir.\n\nI don't think we should supply an explicit working directory in `Popen()`.  I think the explicit `os.chdir()` statements in the doctest are clearer.\n\nThere are various other things which I'd like to change, so I'll prepare a reviewer patch.",
    "created_at": "2012-10-08T14:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158597",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@vbraun](#comment%3A7):
> execute in the same dir.

I don't think we should supply an explicit working directory in `Popen()`.  I think the explicit `os.chdir()` statements in the doctest are clearer.

There are various other things which I'd like to change, so I'll prepare a reviewer patch.



---

archive/issue_comments_158598.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.",
    "created_at": "2012-10-08T14:25:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158598",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:9" align="right">comment:9</div>

I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.



---

archive/issue_comments_158599.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@vbraun](#comment%3A9):\n> I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.\n\nThe insecurity is not because of `test_executable`, but because of Python.  So such a check should be added in `spkg/bin/sage` before running `sage-run`.",
    "created_at": "2012-10-09T15:03:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158599",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@vbraun](#comment%3A9):
> I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.

The insecurity is not because of `test_executable`, but because of Python.  So such a check should be added in `spkg/bin/sage` before running `sage-run`.



---

archive/issue_comments_158600.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nIts pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. \n\nI'm in favor of removing cwd from `sys.path` in `sage-env` if it is not a subdirectory of the users home directory. Thats a pretty specific measure that keeps the convenience of easy importing while keeping use pretty safe. But that should be an additional security measure, and is definitely not the solution to the issue here.\n\n`test_executable` has to be implemented in a manner that its safety is not dependent on other scripts, or we will see the same issue crop up again at a later time.",
    "created_at": "2012-10-09T16:43:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158600",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:11" align="right">comment:11</div>

Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. 

I'm in favor of removing cwd from `sys.path` in `sage-env` if it is not a subdirectory of the users home directory. Thats a pretty specific measure that keeps the convenience of easy importing while keeping use pretty safe. But that should be an additional security measure, and is definitely not the solution to the issue here.

`test_executable` has to be implemented in a manner that its safety is not dependent on other scripts, or we will see the same issue crop up again at a later time.



---

archive/issue_comments_158601.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@vbraun](#comment%3A11):\n> Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. \n\nHow about checking that the script is owned by the same user as the directory it is contained in?  I think that would work pretty well.\n\n> But that should be an additional security measure, and is definitely not the solution to the issue here.\n\nI disagree.  I think `sage-run` is the real issue and that adding stuff to `test_executable` is simply a work-around.",
    "created_at": "2012-10-10T06:42:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158601",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@vbraun](#comment%3A11):
> Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. 

How about checking that the script is owned by the same user as the directory it is contained in?  I think that would work pretty well.

> But that should be an additional security measure, and is definitely not the solution to the issue here.

I disagree.  I think `sage-run` is the real issue and that adding stuff to `test_executable` is simply a work-around.



---

archive/issue_comments_158602.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment%3A12):\n> Replying to [@vbraun](#comment%3A11):\n> > Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model.\n\nI think all systems on which Sage runs have at least the classic unix security model.  Additions like SELinux mostly affect system services, and normally have no impact on normal users.  As far as Python or Sage is concerned, I think we can still check the standard Unix permissions.",
    "created_at": "2012-10-10T10:11:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158602",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment%3A12):
> Replying to [@vbraun](#comment%3A11):
> > Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model.

I think all systems on which Sage runs have at least the classic unix security model.  Additions like SELinux mostly affect system services, and normally have no impact on normal users.  As far as Python or Sage is concerned, I think we can still check the standard Unix permissions.



---

archive/issue_comments_158603.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nWell `test_executable` doesn't just run Sage, it will run other programs as well. Which may or may not look at files relative to cwd, or may introduce such a misfeature in a future version. Or a user might just import the sage library into their own python interpreter. There is only one way to be absolutely safe, and that is by controlling the path explicitly. Hence the design of my patch.",
    "created_at": "2012-10-10T10:14:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158603",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:14" align="right">comment:14</div>

Well `test_executable` doesn't just run Sage, it will run other programs as well. Which may or may not look at files relative to cwd, or may introduce such a misfeature in a future version. Or a user might just import the sage library into their own python interpreter. There is only one way to be absolutely safe, and that is by controlling the path explicitly. Hence the design of my patch.



---

archive/issue_comments_158604.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI think this should be reported upstream to Python.  Volker, do you intend to do this or shall I?",
    "created_at": "2012-10-10T10:16:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158604",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

I think this should be reported upstream to Python.  Volker, do you intend to do this or shall I?



---

archive/issue_comments_158605.json:
```json
{
    "body": "Upstream: **Not yet reported upstream; Will do shortly.**",
    "created_at": "2012-10-10T10:16:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158605",
    "user": "https://github.com/jdemeyer"
}
```

Upstream: **Not yet reported upstream; Will do shortly.**



---

archive/issue_comments_158606.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nCPython handles this already, cwd is not in the path if it is run non-interactively:\n\n```\n[vbraun@laptop ~]$ cat /tmp/test.py\n#!/usr/bin/env  python\nimport sys\nprint sys.path\n\n[vbraun@laptop ~]$ /tmp/test.py \n['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]\n\n[vbraun@laptop ~]$ python /tmp/test.py \n['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]\n\n[vbraun@laptop tmp]$ python\nPython 2.7.3 (default, Jul 24 2012, 10:05:38) \n[GCC 4.7.0 20120507 (Red Hat 4.7.0-5)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sys\n>>> sys.path\n['', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]\n```\nCPython doesn't check for permissions of the script directory, though arguably you want the script directory in the path if you put the script there in the first place.",
    "created_at": "2012-10-10T10:59:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158606",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

CPython handles this already, cwd is not in the path if it is run non-interactively:

```
[vbraun@laptop ~]$ cat /tmp/test.py
#!/usr/bin/env  python
import sys
print sys.path

[vbraun@laptop ~]$ /tmp/test.py 
['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]

[vbraun@laptop ~]$ python /tmp/test.py 
['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]

[vbraun@laptop tmp]$ python
Python 2.7.3 (default, Jul 24 2012, 10:05:38) 
[GCC 4.7.0 20120507 (Red Hat 4.7.0-5)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.path
['', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]
```
CPython doesn't check for permissions of the script directory, though arguably you want the script directory in the path if you put the script there in the first place.



---

archive/issue_comments_158607.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@vbraun](#comment%3A16):\n> CPython handles this already, cwd is not in the path if it is run non-interactively:\n\nThe script directory (`/tmp` in this case) is in `sys.path`.  That's the problem.",
    "created_at": "2012-10-10T11:26:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158607",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@vbraun](#comment%3A16):
> CPython handles this already, cwd is not in the path if it is run non-interactively:

The script directory (`/tmp` in this case) is in `sys.path`.  That's the problem.



---

archive/issue_comments_158608.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@vbraun](#comment%3A16):\n> arguably you want the script directory in the path if you put the script there in the first place.\n\nI think it is very unexpected (to me at least) that CPython suddenly reads other files in the directory where the script lives.  If I create a shell script in `/tmp`, it's not going to magically add `/tmp` to the `$PATH`.  That's fail-safe and that's how it should be.",
    "created_at": "2012-10-10T11:32:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158608",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@vbraun](#comment%3A16):
> arguably you want the script directory in the path if you put the script there in the first place.

I think it is very unexpected (to me at least) that CPython suddenly reads other files in the directory where the script lives.  If I create a shell script in `/tmp`, it's not going to magically add `/tmp` to the `$PATH`.  That's fail-safe and that's how it should be.



---

archive/issue_comments_158609.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nPython programs often consist of multiple files that need to be imported, whereas shell scripts don't. So you can't really compare the two cases.\n\nI'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it.",
    "created_at": "2012-10-10T12:08:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158609",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

Python programs often consist of multiple files that need to be imported, whereas shell scripts don't. So you can't really compare the two cases.

I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it.



---

archive/issue_comments_158610.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@vbraun](#comment%3A19):\n> I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it. \n\nI'm not sure whether upstream is really aware of the security consequences of their `sys.path` handling.\n\nMy proposal would not disable the \"script directory\" situation completely: I would add the script directory to `sys.path` **only if it is safe** to do so.  In normal situations (a script with 0755 permissions in a directory with 0755 permissions owned by the same user), I would keep the current `sys.path` handling.",
    "created_at": "2012-10-10T12:18:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158610",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@vbraun](#comment%3A19):
> I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it. 

I'm not sure whether upstream is really aware of the security consequences of their `sys.path` handling.

My proposal would not disable the "script directory" situation completely: I would add the script directory to `sys.path` **only if it is safe** to do so.  In normal situations (a script with 0755 permissions in a directory with 0755 permissions owned by the same user), I would keep the current `sys.path` handling.



---

archive/issue_comments_158611.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI've added a patch to `sage-run` that matches the plain Python behavior, and will print a warning if the user is not the owner of the script directory.",
    "created_at": "2012-10-10T12:20:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158611",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:21" align="right">comment:21</div>

I've added a patch to `sage-run` that matches the plain Python behavior, and will print a warning if the user is not the owner of the script directory.



---

archive/issue_comments_158612.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,4 +15,6 @@\n ```\n `test_executable` should securely create a temp directory and run the executable in there.\n \n-Apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n+* apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n+* apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n+* apply [attachment: trac_bin_13579_clean_paths.patch](https://github.com/sagemath/sage/files/ticket13579/trac_bin_13579_clean_paths.patch.gz) to the `SAGE_LOCAL/bin` repository.\n``````\n",
    "created_at": "2012-10-10T12:20:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158612",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,4 +15,6 @@
 ```
 `test_executable` should securely create a temp directory and run the executable in there.
 
-Apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz), [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
+* apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
+* apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
+* apply [attachment: trac_bin_13579_clean_paths.patch](https://github.com/sagemath/sage/files/ticket13579/trac_bin_13579_clean_paths.patch.gz) to the `SAGE_LOCAL/bin` repository.
``````




---

archive/issue_comments_158613.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI plan to add a patch to the Python spkg fixing the root cause of this issue.",
    "created_at": "2012-10-10T12:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158613",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

I plan to add a patch to the Python spkg fixing the root cause of this issue.



---

archive/issue_comments_158614.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThe Python behaviour is explicitly specified here http://docs.python.org/library/sys.html#sys.path\n\nI also found the following Gentoo bug report that discusses exactly this issue: https://bugs.gentoo.org/show_bug.cgi?id=224925",
    "created_at": "2012-10-10T12:30:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158614",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:23" align="right">comment:23</div>

The Python behaviour is explicitly specified here http://docs.python.org/library/sys.html#sys.path

I also found the following Gentoo bug report that discusses exactly this issue: https://bugs.gentoo.org/show_bug.cgi?id=224925



---

archive/issue_comments_158615.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-10-10T12:34:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158615",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_158616.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAttachment: **[trac_13579_fix_test_executable.patch.gz](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz)**\n\nThat new import function in the gentoo bug report seems reasonable.  In fact, we can also check all of the sys.path entries and make sure they start with SAGE_ROOT before running the test script.",
    "created_at": "2012-10-10T13:27:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158616",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:24" align="right">comment:24</div>

Attachment: **[trac_13579_fix_test_executable.patch.gz](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz)**

That new import function in the gentoo bug report seems reasonable.  In fact, we can also check all of the sys.path entries and make sure they start with SAGE_ROOT before running the test script.



---

archive/issue_comments_158617.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThe patch in the gentoo bug report was rejected because it breaks the Python specified behavior. In fact, its possible that somebody's code relies on the Python specified behavior and will become a security threat if the script directory is not in `sys.path[0]`. I'd strongly advise against breaking the Python specs just because you don't like them.",
    "created_at": "2012-10-10T13:40:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158617",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

The patch in the gentoo bug report was rejected because it breaks the Python specified behavior. In fact, its possible that somebody's code relies on the Python specified behavior and will become a security threat if the script directory is not in `sys.path[0]`. I'd strongly advise against breaking the Python specs just because you don't like them.



---

archive/issue_comments_158618.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nAlso, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from `import foobar`?",
    "created_at": "2012-10-10T13:46:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158618",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:26" align="right">comment:26</div>

Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from `import foobar`?



---

archive/issue_comments_158619.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@vbraun](#comment%3A25):\n> The patch in the gentoo bug report was rejected because it breaks the Python specified behavior.\n\nAs I said, that's not what I what do.  I would check permissions/owners of the script and its directory and act on that.",
    "created_at": "2012-10-10T13:58:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158619",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@vbraun](#comment%3A25):
> The patch in the gentoo bug report was rejected because it breaks the Python specified behavior.

As I said, that's not what I what do.  I would check permissions/owners of the script and its directory and act on that.



---

archive/issue_comments_158620.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@vbraun](#comment%3A26):\n> Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from import foobar?\n\nSure, but doing something like\n\n```\nimport sys\n```\nis very common in Python-land.  I don't think you can blame the user for doing that.",
    "created_at": "2012-10-10T14:01:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158620",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@vbraun](#comment%3A26):
> Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from import foobar?

Sure, but doing something like

```
import sys
```
is very common in Python-land.  I don't think you can blame the user for doing that.



---

archive/issue_comments_158621.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nEven putting the script directory *last* instead of first in `sys.path` would help a lot.",
    "created_at": "2012-10-10T14:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158621",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Even putting the script directory *last* instead of first in `sys.path` would help a lot.



---

archive/issue_comments_158622.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@vbraun](#comment%3A25):\n> I'd strongly advise against breaking the Python specs just because you don't like them.\n\nThat's a very silly advise when the specs are inherently unsafe.  If the specs are bad, I don't mind breaking them.  Especially if my proposal would not change anything for most use cases.",
    "created_at": "2012-10-10T14:03:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158622",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@vbraun](#comment%3A25):
> I'd strongly advise against breaking the Python specs just because you don't like them.

That's a very silly advise when the specs are inherently unsafe.  If the specs are bad, I don't mind breaking them.  Especially if my proposal would not change anything for most use cases.



---

archive/issue_comments_158623.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nWhat is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`). If you want to silently drop `sys.path[0]` then you are just teaching unsafe habits, and tears will be shed later when your student uses an unpatched Python...",
    "created_at": "2012-10-10T14:13:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158623",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:31" align="right">comment:31</div>

What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`). If you want to silently drop `sys.path[0]` then you are just teaching unsafe habits, and tears will be shed later when your student uses an unpatched Python...



---

archive/issue_comments_158624.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI was suggesting that for running tests, we could modify import.\n\nA separate suggestion is to modify import always, and insist that the user use relative imports when they really want to import something in the current directory.  That definitely breaks python behavior, but it is more explicit and secure.",
    "created_at": "2012-10-10T14:21:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158624",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:32" align="right">comment:32</div>

I was suggesting that for running tests, we could modify import.

A separate suggestion is to modify import always, and insist that the user use relative imports when they really want to import something in the current directory.  That definitely breaks python behavior, but it is more explicit and secure.



---

archive/issue_comments_158625.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@vbraun](#comment%3A31):\n> What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`).\n\nOK, so how about printing a warning and dropping `sys.path[0]`?",
    "created_at": "2012-10-10T14:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158625",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@vbraun](#comment%3A31):
> What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`).

OK, so how about printing a warning and dropping `sys.path[0]`?



---

archive/issue_comments_158626.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@jdemeyer](#comment%3A33):\n> OK, so how about printing a warning and dropping `sys.path[0]`?\n\nWell if you desperately want it then knock yourself out, but I don't see any benefit over just printing a warning.\n\nThe reason for why Python acts the way it does is such that the admin can globally install Python programs. Which will generally be in a root-owned directory (just like /tmp but without `o+w`).",
    "created_at": "2012-10-10T19:21:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158626",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@jdemeyer](#comment%3A33):
> OK, so how about printing a warning and dropping `sys.path[0]`?

Well if you desperately want it then knock yourself out, but I don't see any benefit over just printing a warning.

The reason for why Python acts the way it does is such that the admin can globally install Python programs. Which will generally be in a root-owned directory (just like /tmp but without `o+w`).



---

archive/issue_comments_158627.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,3 +18,4 @@\n * apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n * apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n * apply [attachment: trac_bin_13579_clean_paths.patch](https://github.com/sagemath/sage/files/ticket13579/trac_bin_13579_clean_paths.patch.gz) to the `SAGE_LOCAL/bin` repository.\n+* new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n``````\n",
    "created_at": "2012-10-11T13:41:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158627",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,3 +18,4 @@
 * apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
 * apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
 * apply [attachment: trac_bin_13579_clean_paths.patch](https://github.com/sagemath/sage/files/ticket13579/trac_bin_13579_clean_paths.patch.gz) to the `SAGE_LOCAL/bin` repository.
+* new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
``````




---

archive/issue_events_187863.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-11T13:41:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187863"
}
```



---

archive/issue_events_187864.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-11T13:41:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187864"
}
```



---

archive/issue_comments_158628.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,5 +17,4 @@\n \n * apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n * apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n-* apply [attachment: trac_bin_13579_clean_paths.patch](https://github.com/sagemath/sage/files/ticket13579/trac_bin_13579_clean_paths.patch.gz) to the `SAGE_LOCAL/bin` repository.\n * new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n``````\n",
    "created_at": "2012-10-11T13:42:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158628",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,5 +17,4 @@
 
 * apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
 * apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
-* apply [attachment: trac_bin_13579_clean_paths.patch](https://github.com/sagemath/sage/files/ticket13579/trac_bin_13579_clean_paths.patch.gz) to the `SAGE_LOCAL/bin` repository.
 * new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
``````




---

archive/issue_comments_158629.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nDo the write permissions on the directory actually say anything about security? Imagine the following:\n\n```\n$ su A\n$ mkdir /tmp/test\n$ chmod a+wrx /tmp/test\n$ mkdir /tmp/test/secure\n$ chmod go-w /tmp/test/secure\n$ cp python_test.py /tmp/test/secure\n$ /tmp/test/secure/python_test.py\n[...]\n```\nNow (from a different terminal):\n\n```\n$ su B\n$ mkdir /tmp/test/new\n$ cp -R /tmp/test/secure /tmp/test/new\n$ cp evil_sys.py /tmp/test/new/sys.py\n$ mv /tmp/test/secure /tmp/test/secure_bak; mv /tmp/test/new /tmp/test/secure\n```\nAny open files for the running `python_test.py` will remain, but any files that are newly looked up by (absolute) path name will be found in what used to be `/tmp/test/new`. In particular a late `import sys`.\n\nOf course, this is why there's a `t` flag on `/tmp`.\n\nIn any case, apparently python comes with a caution: Don't run scripts in directories writeable by people you don't trust, not even `t` flagged ones.\n\nWe're changing that caution to: Don't run scripts in directories that have components in their path that are writeable by people you don't trust, although `t` flagged is fine lower down. We'll warn you if the top level is writeable, since that is particularly easy to exploit.\n\nThe proposed change fixes the particular issue for Sage, but with the formulation above, I don't think there's any chance of this getting accepted upstream. It doesn't look like a real solution. It's just kicking the ball a little further (far enough for us).",
    "created_at": "2012-10-11T15:47:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158629",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:37" align="right">comment:37</div>

Do the write permissions on the directory actually say anything about security? Imagine the following:

```
$ su A
$ mkdir /tmp/test
$ chmod a+wrx /tmp/test
$ mkdir /tmp/test/secure
$ chmod go-w /tmp/test/secure
$ cp python_test.py /tmp/test/secure
$ /tmp/test/secure/python_test.py
[...]
```
Now (from a different terminal):

```
$ su B
$ mkdir /tmp/test/new
$ cp -R /tmp/test/secure /tmp/test/new
$ cp evil_sys.py /tmp/test/new/sys.py
$ mv /tmp/test/secure /tmp/test/secure_bak; mv /tmp/test/new /tmp/test/secure
```
Any open files for the running `python_test.py` will remain, but any files that are newly looked up by (absolute) path name will be found in what used to be `/tmp/test/new`. In particular a late `import sys`.

Of course, this is why there's a `t` flag on `/tmp`.

In any case, apparently python comes with a caution: Don't run scripts in directories writeable by people you don't trust, not even `t` flagged ones.

We're changing that caution to: Don't run scripts in directories that have components in their path that are writeable by people you don't trust, although `t` flagged is fine lower down. We'll warn you if the top level is writeable, since that is particularly easy to exploit.

The proposed change fixes the particular issue for Sage, but with the formulation above, I don't think there's any chance of this getting accepted upstream. It doesn't look like a real solution. It's just kicking the ball a little further (far enough for us).



---

archive/issue_comments_158630.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nI think there is no way you can expect any degree of safety if you manually make a directory world-writeable and then execute things in there. You should be allowed to shoot your own foot if you desperately want to. In particular, even if Python would check every directory permission there is still a race before `chmod go-w /tmp/test/secure`.\n\nIt would still be good to get rid of some of the sharp edges in Python wrt. execution in /tmp; But Jeroen's current patch would e.g. prevent you from giving file ownership of a script directory to `nobody`. IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).",
    "created_at": "2012-10-11T16:33:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158630",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:38" align="right">comment:38</div>

I think there is no way you can expect any degree of safety if you manually make a directory world-writeable and then execute things in there. You should be allowed to shoot your own foot if you desperately want to. In particular, even if Python would check every directory permission there is still a race before `chmod go-w /tmp/test/secure`.

It would still be good to get rid of some of the sharp edges in Python wrt. execution in /tmp; But Jeroen's current patch would e.g. prevent you from giving file ownership of a script directory to `nobody`. IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).



---

archive/issue_comments_158631.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nI agree with Volker.  Nils's issue isn't a Python issue.  It's an obvious consequence of creating subdirectories of a world-writable directory and Unix's permission system.  When you do stuff in (subdirectories of) a world-writable directory, you get what you deserve.  Similarly, Python cannot (and should not) protect a user from exectuting a script with `-rwxrwxrwx` permissions.",
    "created_at": "2012-10-11T16:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158631",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

I agree with Volker.  Nils's issue isn't a Python issue.  It's an obvious consequence of creating subdirectories of a world-writable directory and Unix's permission system.  When you do stuff in (subdirectories of) a world-writable directory, you get what you deserve.  Similarly, Python cannot (and should not) protect a user from exectuting a script with `-rwxrwxrwx` permissions.



---

archive/issue_comments_158632.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@vbraun](#comment%3A38):\n>  IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).\n\nEven that may be intentional. Many linux distributions by default make a separate group for each individual. On a machine where you trust every account, `o+w` would not necessarily indicate a security hole.\n\nThat being said, I think the proposed patch provides an acceptable workaround and I don't have any better ideas.",
    "created_at": "2012-10-11T18:49:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158632",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@vbraun](#comment%3A38):
>  IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).

Even that may be intentional. Many linux distributions by default make a separate group for each individual. On a machine where you trust every account, `o+w` would not necessarily indicate a security hole.

That being said, I think the proposed patch provides an acceptable workaround and I don't have any better ideas.



---

archive/issue_comments_158633.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nI agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault. \n\nA case can be made for tests, but it seems it would be better to simple place test executables in a better place.",
    "created_at": "2012-10-11T19:25:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158633",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:41" align="right">comment:41</div>

I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault. 

A case can be made for tests, but it seems it would be better to simple place test executables in a better place.



---

archive/issue_comments_158634.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@robertwb](#comment%3A41):\n> A case can be made for tests, but it seems it would be better to simple place test executables in a better place. \n\n+1",
    "created_at": "2012-10-11T19:29:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158634",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@robertwb](#comment%3A41):
> A case can be made for tests, but it seems it would be better to simple place test executables in a better place. 

+1



---

archive/issue_comments_158635.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@robertwb](#comment%3A41):\n> I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault.\n\nAs I already argued, I totally disagree with this.  If the spec is bad then the spec must be fixed.\n\nI'll report this upstream and see what happens...",
    "created_at": "2012-10-11T19:31:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158635",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@robertwb](#comment%3A41):
> I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault.

As I already argued, I totally disagree with this.  If the spec is bad then the spec must be fixed.

I'll report this upstream and see what happens...



---

archive/issue_events_187865.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-11T20:11:10Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "title_is": "Python sys.path security risk",
    "title_was": "test_executable security risk",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187865"
}
```



---

archive/issue_comments_158636.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,3 +18,5 @@\n * apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n * apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n * new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n+\n+*Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)\n``````\n",
    "created_at": "2012-10-11T20:12:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158636",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,3 +18,5 @@
 * apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
 * apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
 * new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
+
+*Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)
``````




---

archive/issue_comments_158637.json:
```json
{
    "body": "Changed upstream from **Not yet reported upstream; Will do shortly.** to **Reported upstream. No feedback yet.**",
    "created_at": "2012-10-11T20:12:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158637",
    "user": "https://github.com/jdemeyer"
}
```

Changed upstream from **Not yet reported upstream; Will do shortly.** to **Reported upstream. No feedback yet.**



---

archive/issue_comments_158638.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nI consider the Python spkg to be ready for review.",
    "created_at": "2012-10-12T08:06:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158638",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:46" align="right">comment:46</div>

I consider the Python spkg to be ready for review.



---

archive/issue_comments_158639.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nConcerning the Sage library patch: why did you change `doc/common/builder.py`?",
    "created_at": "2012-10-12T08:06:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158639",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:47" align="right">comment:47</div>

Concerning the Sage library patch: why did you change `doc/common/builder.py`?



---

archive/issue_comments_158640.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nReplying to [@jdemeyer](#comment%3A47):\n> Concerning the Sage library patch: why did you change `doc/common/builder.py`?\n\nThe new `tmp_filename` and `tmp_dir` create a file/directory (the only safe way to deal with temporaries), but the doctest wanted a non-existing directory name. Needless to say, a function that returns a not-yet-existing filename is just a race condition in the making.",
    "created_at": "2012-10-12T09:25:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158640",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:48" align="right">comment:48</div>

Replying to [@jdemeyer](#comment%3A47):
> Concerning the Sage library patch: why did you change `doc/common/builder.py`?

The new `tmp_filename` and `tmp_dir` create a file/directory (the only safe way to deal with temporaries), but the doctest wanted a non-existing directory name. Needless to say, a function that returns a not-yet-existing filename is just a race condition in the making.



---

archive/issue_comments_158641.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,8 +15,10 @@\n ```\n `test_executable` should securely create a temp directory and run the executable in there.\n \n-* apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n-* apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n-* new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n+**Apply**:\n+1. [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n+2. [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n+3. [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz) to the Sage library.\n+4. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n \n *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)\n``````\n",
    "created_at": "2012-10-12T10:01:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158641",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,8 +15,10 @@
 ```
 `test_executable` should securely create a temp directory and run the executable in there.
 
-* apply [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
-* apply [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
-* new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
+**Apply**:
+1. [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
+2. [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
+3. [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz) to the Sage library.
+4. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
 
 *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)
``````




---

archive/issue_events_187866.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-12T13:38:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187866"
}
```



---

archive/issue_events_187867.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-12T13:38:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187867"
}
```



---

archive/issue_comments_158642.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nCase (B): (script dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)\n\nCase (C): (script dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.\n\nIn fact, if the dir is `go-w` and owned by a different UID, the script is very likely also owned by a different UID. The security risk really isn't in the imports in that case (if there is any at all)\n\nNone of these affect correct functioning of sage with the patch, since the required paths are explicitly added to sys.path, but it does illustrate that your detection heuristics are not very accurate.\n\nAs pointed out before, even `o+w` isn't necessarily a security risk, but since `/tmp` likely is, I'd find that an acceptable compromise. The other cases are harder to work around if they bite you. Really, the import behaviour only causes additional security risks on directories writeable by untrusted people *and the sticky bit set*. Otherwise, you can't trust the script you're running in the first place! Would it be possible to only do these checks in the presence of a sticky bit?",
    "created_at": "2012-10-12T16:08:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158642",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:51" align="right">comment:51</div>

Case (B): (script dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)

Case (C): (script dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.

In fact, if the dir is `go-w` and owned by a different UID, the script is very likely also owned by a different UID. The security risk really isn't in the imports in that case (if there is any at all)

None of these affect correct functioning of sage with the patch, since the required paths are explicitly added to sys.path, but it does illustrate that your detection heuristics are not very accurate.

As pointed out before, even `o+w` isn't necessarily a security risk, but since `/tmp` likely is, I'd find that an acceptable compromise. The other cases are harder to work around if they bite you. Really, the import behaviour only causes additional security risks on directories writeable by untrusted people *and the sticky bit set*. Otherwise, you can't trust the script you're running in the first place! Would it be possible to only do these checks in the presence of a sticky bit?



---

archive/issue_comments_158643.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nReplying to [@nbruin](#comment%3A51):\n> Case (B): (current dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)\n\nThen it's likely that *both* the Python script and the directory containing it are group-writable by the same group, which is allowed by my patch.\n\n> Case (C): (current dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.\n\nMy patch allows a directory owned by the same user as the Python executable.  In fact, I precisely had this scenario in mind, that's why I added this check.",
    "created_at": "2012-10-12T16:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158643",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:52" align="right">comment:52</div>

Replying to [@nbruin](#comment%3A51):
> Case (B): (current dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)

Then it's likely that *both* the Python script and the directory containing it are group-writable by the same group, which is allowed by my patch.

> Case (C): (current dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.

My patch allows a directory owned by the same user as the Python executable.  In fact, I precisely had this scenario in mind, that's why I added this check.



---

archive/issue_comments_158644.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@nbruin](#comment%3A51):\n> Would it be possible to only do these checks in the presence of a sticky bit?\n\nI have no idea about the portability of \"sticky bit\" behaviour.  If you know for sure that every Unix system supports the sticky bit in the same way as Linux, that's fine for me.",
    "created_at": "2012-10-12T16:56:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158644",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@nbruin](#comment%3A51):
> Would it be possible to only do these checks in the presence of a sticky bit?

I have no idea about the portability of "sticky bit" behaviour.  If you know for sure that every Unix system supports the sticky bit in the same way as Linux, that's fine for me.



---

archive/issue_comments_158645.json:
```json
{
    "body": "Attachment: **[13579_review.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz)**",
    "created_at": "2012-10-12T17:00:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158645",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[13579_review.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz)**



---

archive/issue_comments_158646.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nThe \"sticky bit\" S_ISVTX is documented by POSIX, see [http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02](http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02).\n\nBased on this, I will change my patch.",
    "created_at": "2012-10-14T13:11:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158646",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:54" align="right">comment:54</div>

The "sticky bit" S_ISVTX is documented by POSIX, see [http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02](http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02).

Based on this, I will change my patch.



---

archive/issue_comments_158647.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nNew version, needs review.",
    "created_at": "2012-10-14T19:11:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158647",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:55" align="right">comment:55</div>

New version, needs review.



---

archive/issue_comments_158648.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nFirst of all, the discussion on the Python bugtracker shows that this version of the patch is not going to be upstream. I would prefer a minimal patch that just adds a warning while keeping the old behavior that could be incorporated upstream. Having said that, I don't mind if we try out this patch in Sage until the next upstream release.\n* Error messages don't clearly state that this is a security risk. The \"not adding directory to sys.path since the write permissions are too loose\" implies that its OK to run scripts off `/tmp` and therefore implicitly encourages insecure behavior.\n* Since many packages (including some in the stdlib) re-add `cwd` if it is missing, the patch doesn't actually guarantee safe execution in `/tmp`.\n\nA short & sweet **Warning: It is not safe to run scripts in a world-writeable directory (including /tmp)** would be better ihmo.",
    "created_at": "2012-10-15T09:49:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158648",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:56" align="right">comment:56</div>

First of all, the discussion on the Python bugtracker shows that this version of the patch is not going to be upstream. I would prefer a minimal patch that just adds a warning while keeping the old behavior that could be incorporated upstream. Having said that, I don't mind if we try out this patch in Sage until the next upstream release.
* Error messages don't clearly state that this is a security risk. The "not adding directory to sys.path since the write permissions are too loose" implies that its OK to run scripts off `/tmp` and therefore implicitly encourages insecure behavior.
* Since many packages (including some in the stdlib) re-add `cwd` if it is missing, the patch doesn't actually guarantee safe execution in `/tmp`.

A short & sweet **Warning: It is not safe to run scripts in a world-writeable directory (including /tmp)** would be better ihmo.



---

archive/issue_events_187868.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-15T09:49:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187868"
}
```



---

archive/issue_events_187869.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-10-15T09:49:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187869"
}
```



---

archive/issue_comments_158649.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nI don't mind changing the warning message to something more severe.  Something like\n\n`RuntimeWarning: not adding directory '%s' to sys.path since the write permissions are too loose. Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory.`",
    "created_at": "2012-10-15T10:34:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158649",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:57" align="right">comment:57</div>

I don't mind changing the warning message to something more severe.  Something like

`RuntimeWarning: not adding directory '%s' to sys.path since the write permissions are too loose. Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory.`



---

archive/issue_comments_158650.json:
```json
{
    "body": "Attachment: **[sys_path_security.patch.gz](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz)**\n\nPatch added to the Python sources",
    "created_at": "2012-10-15T20:45:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158650",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[sys_path_security.patch.gz](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz)**

Patch added to the Python sources



---

archive/issue_comments_158651.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nI updated the spkg with the new longer warning message.\n\nVolker, just to be clear: can you confirm that your \"positive_review\" also covers [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz)?",
    "created_at": "2012-10-15T20:47:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158651",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:58" align="right">comment:58</div>

I updated the spkg with the new longer warning message.

Volker, just to be clear: can you confirm that your "positive_review" also covers [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz)?



---

archive/issue_comments_158652.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nAs I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution. Why are you so desperate to teach bad habits and booby-trap it for future users? When I changed it in my patch, it was precisely to be free of this hidden assumption. And you undid that for no good reason.\n\nI agree that its safe the way the testsuite currently uses `test_executable`, so if you really want to ship it its at least better than before.",
    "created_at": "2012-10-15T21:34:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158652",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:59" align="right">comment:59</div>

As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution. Why are you so desperate to teach bad habits and booby-trap it for future users? When I changed it in my patch, it was precisely to be free of this hidden assumption. And you undid that for no good reason.

I agree that its safe the way the testsuite currently uses `test_executable`, so if you really want to ship it its at least better than before.



---

archive/issue_comments_158653.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@vbraun](#comment%3A59):\n> As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution.\n\nSerious question: why do you consider `test_executable()` as much more dangerous than other doctesting?  I.e. you seem to say that it's okay to run doctests in `/tmp` except for `test_executable()`.\n\nI think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.\n\nThe problem I have with your approach is that it unexpectedly changes directory.  In some cases, you might want to run a test from a given directory, but that's impossible with your patch.\n\nWould you accept a patch which checks in `test_executable()` (or maybe `sage-doctest`?) that the current directory is not world-writable and raises an exception if it is?",
    "created_at": "2012-10-16T06:39:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158653",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@vbraun](#comment%3A59):
> As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution.

Serious question: why do you consider `test_executable()` as much more dangerous than other doctesting?  I.e. you seem to say that it's okay to run doctests in `/tmp` except for `test_executable()`.

I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.

The problem I have with your approach is that it unexpectedly changes directory.  In some cases, you might want to run a test from a given directory, but that's impossible with your patch.

Would you accept a patch which checks in `test_executable()` (or maybe `sage-doctest`?) that the current directory is not world-writable and raises an exception if it is?



---

archive/issue_comments_158654.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nGiven what we learned in this ticket, I think **the only safe way to use `Popen` is by supplying a `cwd=` argument** with a directory that you set up (even if its just `SAGE_TMP`). Perhaps with the exception of posix standard binaries like `ls` or binaries that you wrote yourself. Its a simple pattern, easy to communicate and enforce, and will absolutely prevent this kind of problem. Basically, it forces the programmer to think about the choice of working directory.\n\nSure, you can make this whole issue more difficult to exploit by checking that the directory is not world-writable. But that does't plug the underlying issue. \n\nAlso, the Sage testsuite never ran a test in a specific directory. Its hard to imagine how that would be portable, to start with. But in the hypothetical case that one would need such a functionality, it could be added as an optional keyword parameter to `test_executable`.\n\nI don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`.",
    "created_at": "2012-10-16T12:02:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158654",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:61" align="right">comment:61</div>

Given what we learned in this ticket, I think **the only safe way to use `Popen` is by supplying a `cwd=` argument** with a directory that you set up (even if its just `SAGE_TMP`). Perhaps with the exception of posix standard binaries like `ls` or binaries that you wrote yourself. Its a simple pattern, easy to communicate and enforce, and will absolutely prevent this kind of problem. Basically, it forces the programmer to think about the choice of working directory.

Sure, you can make this whole issue more difficult to exploit by checking that the directory is not world-writable. But that does't plug the underlying issue. 

Also, the Sage testsuite never ran a test in a specific directory. Its hard to imagine how that would be portable, to start with. But in the hypothetical case that one would need such a functionality, it could be added as an optional keyword parameter to `test_executable`.

I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`.



---

archive/issue_comments_158655.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nReplying to [@vbraun](#comment%3A61):\n> I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`. \n\nI agree with this, so I think we should stop focusing on `test_executable()`.  I'm preparing a patch, stay tuned...",
    "created_at": "2012-10-16T14:54:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158655",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:62" align="right">comment:62</div>

Replying to [@vbraun](#comment%3A61):
> I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`. 

I agree with this, so I think we should stop focusing on `test_executable()`.  I'm preparing a patch, stay tuned...



---

archive/issue_comments_158656.json:
```json
{
    "body": "Attachment: **[13579_scripts.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz)**",
    "created_at": "2012-10-17T07:11:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158656",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[13579_scripts.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz)**



---

archive/issue_events_187870.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-17T07:13:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187870"
}
```



---

archive/issue_events_187871.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-17T07:13:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187871"
}
```



---

archive/issue_comments_158657.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nAttachment: **[13579_test_permissions.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_test_permissions.patch.gz)**",
    "created_at": "2012-10-17T07:13:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158657",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:63" align="right">comment:63</div>

Attachment: **[13579_test_permissions.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_test_permissions.patch.gz)**



---

archive/issue_comments_158658.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -19,6 +19,8 @@\n 1. [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n 2. [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n 3. [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz) to the Sage library.\n-4. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n+4. [attachment: 13579_test_permissions.patch](https://github.com/sagemath/sage/files/ticket13579/13579_test_permissions.patch.gz) to the Sage library.\n+5. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).\n+6. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n \n *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)\n``````\n",
    "created_at": "2012-10-17T07:13:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158658",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -19,6 +19,8 @@
 1. [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
 2. [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
 3. [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz) to the Sage library.
-4. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
+4. [attachment: 13579_test_permissions.patch](https://github.com/sagemath/sage/files/ticket13579/13579_test_permissions.patch.gz) to the Sage library.
+5. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).
+6. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
 
 *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)
``````




---

archive/issue_events_187872.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-17T07:13:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187872"
}
```



---

archive/issue_events_187873.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-17T07:13:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187873"
}
```



---

archive/issue_comments_158659.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nVolker, I added a patch for `sage-test` and `sage-ptest` (why are these 2 different files anyway?) such that they will refuse to run *any* doctests from an unsafe directory.  I think this makes much more sense than fixing \"only\" `test_executable()`.\n\nNeeds review",
    "created_at": "2012-10-17T07:15:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158659",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:65" align="right">comment:65</div>

Volker, I added a patch for `sage-test` and `sage-ptest` (why are these 2 different files anyway?) such that they will refuse to run *any* doctests from an unsafe directory.  I think this makes much more sense than fixing "only" `test_executable()`.

Needs review



---

archive/issue_comments_158660.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nThey're getting deleted by #12415.  Now I need to update 12415_script.patch again....\n\nI will make sure this behavior is incorporated into the #12415 framework.",
    "created_at": "2012-10-17T07:32:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158660",
    "user": "https://github.com/roed314"
}
```

<div id="comment:66" align="right">comment:66</div>

They're getting deleted by #12415.  Now I need to update 12415_script.patch again....

I will make sure this behavior is incorporated into the #12415 framework.



---

archive/issue_comments_158661.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nWhat did you do to `13579_test_permissions.patch`?  I'm happy to sign off on the patch to the scripts repo.",
    "created_at": "2012-10-17T07:40:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158661",
    "user": "https://github.com/roed314"
}
```

<div id="comment:67" align="right">comment:67</div>

What did you do to `13579_test_permissions.patch`?  I'm happy to sign off on the patch to the scripts repo.



---

archive/issue_comments_158662.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nReplying to [@roed314](#comment%3A67):\n> What did you do to `13579_test_permissions.patch`?\n\nWhat do you mean, I don't understand your question.",
    "created_at": "2012-10-17T11:32:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158662",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:68" align="right">comment:68</div>

Replying to [@roed314](#comment%3A67):
> What did you do to `13579_test_permissions.patch`?

What do you mean, I don't understand your question.



---

archive/issue_comments_158663.json:
```json
{
    "body": "Changed reviewer from **Volker Braun, Jeroen Demeyer** to **Volker Braun, Jeroen Demeyer, David Roe**",
    "created_at": "2012-10-17T11:32:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158663",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Volker Braun, Jeroen Demeyer** to **Volker Braun, Jeroen Demeyer, David Roe**



---

archive/issue_comments_158664.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nThe timestamp said that 13579_test_permissions.patch changed after you marked it as needs work the most recent time.  That's all.",
    "created_at": "2012-10-17T16:31:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158664",
    "user": "https://github.com/roed314"
}
```

<div id="comment:70" align="right">comment:70</div>

The timestamp said that 13579_test_permissions.patch changed after you marked it as needs work the most recent time.  That's all.



---

archive/issue_comments_158665.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nI thought that file had existed before.  Anyway, it looks fine, so I'll give a positive review.",
    "created_at": "2012-10-17T16:33:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158665",
    "user": "https://github.com/roed314"
}
```

<div id="comment:71" align="right">comment:71</div>

I thought that file had existed before.  Anyway, it looks fine, so I'll give a positive review.



---

archive/issue_events_187874.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2012-10-17T16:33:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187874"
}
```



---

archive/issue_events_187875.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2012-10-17T16:33:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187875"
}
```



---

archive/issue_comments_158666.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nVolker, I hope you can be happy with these patches.  I know `test_executable()` isn't as secure as you wanted, but I think that problem is solved by doing the tests before allowing doctesting at all.",
    "created_at": "2012-10-17T20:50:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158666",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:72" align="right">comment:72</div>

Volker, I hope you can be happy with these patches.  I know `test_executable()` isn't as secure as you wanted, but I think that problem is solved by doing the tests before allowing doctesting at all.



---

archive/issue_comments_158667.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,11 +16,8 @@\n `test_executable` should securely create a temp directory and run the executable in there.\n \n **Apply**:\n-1. [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.\n-2. [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.\n-3. [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz) to the Sage library.\n-4. [attachment: 13579_test_permissions.patch](https://github.com/sagemath/sage/files/ticket13579/13579_test_permissions.patch.gz) to the Sage library.\n-5. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).\n-6. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n+1. [attachment: 13579_sagelib.patch](https://github.com/sagemath/sage/files/ticket13579/13579_sagelib.patch.gz) to the Sage library.\n+2. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).\n+3. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n \n *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)\n``````\n",
    "created_at": "2012-10-18T06:51:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158667",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,11 +16,8 @@
 `test_executable` should securely create a temp directory and run the executable in there.
 
 **Apply**:
-1. [attachment: 13579_secure_tmp.patch](https://github.com/sagemath/sage/files/ticket13579/13579_secure_tmp.patch.gz) to the Sage library.
-2. [attachment: trac_13579_fix_test_executable.patch](https://github.com/sagemath/sage/files/ticket13579/trac_13579_fix_test_executable.patch.gz) to the Sage library.
-3. [attachment: 13579_review.patch](https://github.com/sagemath/sage/files/ticket13579/13579_review.patch.gz) to the Sage library.
-4. [attachment: 13579_test_permissions.patch](https://github.com/sagemath/sage/files/ticket13579/13579_test_permissions.patch.gz) to the Sage library.
-5. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).
-6. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
+1. [attachment: 13579_sagelib.patch](https://github.com/sagemath/sage/files/ticket13579/13579_sagelib.patch.gz) to the Sage library.
+2. [attachment: 13579_scripts.patch](https://github.com/sagemath/sage/files/ticket13579/13579_scripts.patch.gz) to Sage scripts (`local/bin`).
+3. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
 
 *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)
``````




---

archive/issue_comments_158668.json:
```json
{
    "body": "Attachment: **[13579_sagelib.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_sagelib.patch.gz)**\n\nAll Sage library patches folded",
    "created_at": "2012-10-18T12:13:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158668",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[13579_sagelib.patch.gz](https://github.com/sagemath/sage/files/ticket13579/13579_sagelib.patch.gz)**

All Sage library patches folded



---

archive/issue_events_187876.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-18T19:09:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187876"
}
```



---

archive/issue_events_187877.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-18T19:09:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13579#event-187877"
}
```



---

archive/issue_comments_158669.json:
```json
{
    "body": "Merged: **sage-5.4.rc2**",
    "created_at": "2012-10-18T19:09:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158669",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.4.rc2**



---

archive/issue_comments_158670.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nReplying to [@jdemeyer](#comment%3A60):\n\n> I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.\n\nI did this many times. (But of course I grew up with an idea that the worst thing that can happen to your program is that the stack of punchcards it is contained in is dropped on the floor and messed up :-))",
    "created_at": "2012-10-19T00:24:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158670",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:75" align="right">comment:75</div>

Replying to [@jdemeyer](#comment%3A60):

> I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.

I did this many times. (But of course I grew up with an idea that the worst thing that can happen to your program is that the stack of punchcards it is contained in is dropped on the floor and messed up :-))



---

archive/issue_comments_158671.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nThe patch breaks my patchbot, even though it is running in a safe directory. Details at #13631",
    "created_at": "2012-10-20T13:52:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158671",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:76" align="right">comment:76</div>

The patch breaks my patchbot, even though it is running in a safe directory. Details at #13631



---

archive/issue_comments_158672.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nYo, dudes, you missed a place for temp files.\n\n```\nfrom sage.misc.temporary_file import tmp_filename, tmp_dir\n```\nin animate.py wasn't enough - see [this ask.sagemath.org question](http://ask.sagemath.org/question/2065/module-object-has-no-attribute-graphics_filename).  I've opened #13807 for this.",
    "created_at": "2012-12-07T13:22:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158672",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:77" align="right">comment:77</div>

Yo, dudes, you missed a place for temp files.

```
from sage.misc.temporary_file import tmp_filename, tmp_dir
```
in animate.py wasn't enough - see [this ask.sagemath.org question](http://ask.sagemath.org/question/2065/module-object-has-no-attribute-graphics_filename).  I've opened #13807 for this.



---

archive/issue_comments_158673.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nCopy-pasted from sage-release:\n\n```\n$ env SAGE_TESTDIR=/tmp ./sage -t devel/sage/sage/tests/cmdline.py\nsage -t  \"devel/sage/sage/tests/cmdline.py\"\nsys:1: RuntimeWarning: not adding directory '/private/tmp' to sys.path since everybody can write to it.\nUntrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 312:\n    sage: ret\nExpected:\n    0\nGot:\n    128\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 314:\n    sage: out.find(\"All tests passed!\") >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 317:\n    sage: ret\nExpected:\n    0\nGot:\n    128\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 319:\n    sage: out.find(\"All tests passed!\") >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 items had failures:\n   4 of 203 in __main__.example_1\n***Test Failed*** 4 failures.\nFor whitespace errors, see the file /tmp/cmdline_77447.py\n     [84.3 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n    sage -t  \"devel/sage/sage/tests/cmdline.py\"\nTotal time for all tests: 84.4 seconds\n\n\nSame with 'make testlong'; './sage -tp 1 ...' and 'make ptestlong' in contrast work.\n```",
    "created_at": "2013-01-12T17:40:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158673",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:78" align="right">comment:78</div>

Copy-pasted from sage-release:

```
$ env SAGE_TESTDIR=/tmp ./sage -t devel/sage/sage/tests/cmdline.py
sage -t  "devel/sage/sage/tests/cmdline.py"
sys:1: RuntimeWarning: not adding directory '/private/tmp' to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 312:
    sage: ret
Expected:
    0
Got:
    128
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 314:
    sage: out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 317:
    sage: ret
Expected:
    0
Got:
    128
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 319:
    sage: out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
   4 of 203 in __main__.example_1
***Test Failed*** 4 failures.
For whitespace errors, see the file /tmp/cmdline_77447.py
     [84.3 s]

----------------------------------------------------------------------
The following tests failed:


    sage -t  "devel/sage/sage/tests/cmdline.py"
Total time for all tests: 84.4 seconds


Same with 'make testlong'; './sage -tp 1 ...' and 'make ptestlong' in contrast work.
```



---

archive/issue_comments_158674.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nAs Volker explained, that's a feature, not a bug.",
    "created_at": "2013-01-12T18:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158674",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:79" align="right">comment:79</div>

As Volker explained, that's a feature, not a bug.



---

archive/issue_comments_158675.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nReplying to [@jdemeyer](#comment%3A79):\n> As Volker explained, that's a feature, not a bug.\n\nNope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).",
    "created_at": "2013-01-12T18:19:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158675",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:80" align="right">comment:80</div>

Replying to [@jdemeyer](#comment%3A79):
> As Volker explained, that's a feature, not a bug.

Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).



---

archive/issue_comments_158676.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nReplying to [@nexttime](#comment%3A80):\n> Replying to [@jdemeyer](#comment%3A79):\n> > As Volker explained, that's a feature, not a bug.\n\n> \n> Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).\n\n\n```\n...\n    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create\n    a file and preparse it::\n\n        sage: s = '\\\"\\\"\\\"\\nThis is a test file.\\n\\\"\\\"\\\"\\ndef my_add(a,b):\\n    \\\"\\\"\\\"\\n    Add a to b.\\n\\n        EXAMPLES::\\n\\n            sage: my_add(2,2)\\n            4\\n        \\\"\\\"\\\"\\n    return a+b\\n'\n        sage: script = os.path.join(tmp_dir(), 'my_script.sage')\n        sage: script_py = script[:-5] + '.py'\n        sage: F = open(script, 'w')\n        sage: F.write(s)\n        sage: F.close()\n        sage: (out, err, ret) = test_executable([\"sage\", \"--preparse\", script])\n        sage: ret\n        0\n        sage: os.path.isfile(script_py)\n        True\n\n    Now test my_script.sage and the preparsed version my_script.py::\n\n        sage: (out, err, ret) = test_executable([\"sage\", \"-t\", script])\n        sage: ret\n        0\n        sage: out.find(\"All tests passed!\") >= 0\n        True\n        sage: (out, err, ret) = test_executable([\"sage\", \"-t\", script_py])\n        sage: ret\n        0\n        sage: out.find(\"All tests passed!\") >= 0\n        True\n...\n```\n\nThe latter four tests failed.",
    "created_at": "2013-01-12T18:25:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158676",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:81" align="right">comment:81</div>

Replying to [@nexttime](#comment%3A80):
> Replying to [@jdemeyer](#comment%3A79):
> > As Volker explained, that's a feature, not a bug.

> 
> Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).


```
...
    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create
    a file and preparse it::

        sage: s = '\"\"\"\nThis is a test file.\n\"\"\"\ndef my_add(a,b):\n    \"\"\"\n    Add a to b.\n\n        EXAMPLES::\n\n            sage: my_add(2,2)\n            4\n        \"\"\"\n    return a+b\n'
        sage: script = os.path.join(tmp_dir(), 'my_script.sage')
        sage: script_py = script[:-5] + '.py'
        sage: F = open(script, 'w')
        sage: F.write(s)
        sage: F.close()
        sage: (out, err, ret) = test_executable(["sage", "--preparse", script])
        sage: ret
        0
        sage: os.path.isfile(script_py)
        True

    Now test my_script.sage and the preparsed version my_script.py::

        sage: (out, err, ret) = test_executable(["sage", "-t", script])
        sage: ret
        0
        sage: out.find("All tests passed!") >= 0
        True
        sage: (out, err, ret) = test_executable(["sage", "-t", script_py])
        sage: ret
        0
        sage: out.find("All tests passed!") >= 0
        True
...
```

The latter four tests failed.



---

archive/issue_comments_158677.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\nYou'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.",
    "created_at": "2013-01-12T18:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158677",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:82" align="right">comment:82</div>

You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.



---

archive/issue_comments_158678.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nReplying to [@vbraun](#comment%3A82):\n> You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.\n\nThat's unrelated.  It's IMHO pretty ok to have `SAGE_TESTDIR=/tmp` (or whatever world-writable scratch directory; same for `SAGE_TMP`).\n\nThe test just shouldn't write the script into that directory, but instead into a \"safe\" subdir, just where all other doctest scripts end up.\n\nOrthogonal to the safety issue, the test could just fail because different test instances (in this case, on different machines, but sharing the test directory) use the same file at the same time.",
    "created_at": "2013-01-12T19:23:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158678",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:83" align="right">comment:83</div>

Replying to [@vbraun](#comment%3A82):
> You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.

That's unrelated.  It's IMHO pretty ok to have `SAGE_TESTDIR=/tmp` (or whatever world-writable scratch directory; same for `SAGE_TMP`).

The test just shouldn't write the script into that directory, but instead into a "safe" subdir, just where all other doctest scripts end up.

Orthogonal to the safety issue, the test could just fail because different test instances (in this case, on different machines, but sharing the test directory) use the same file at the same time.



---

archive/issue_comments_158679.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -21,3 +21,5 @@\n 3. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))\n \n *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)\n+\n+*See also*: [https://github.com/ipython/ipython/issues/7044](https://github.com/ipython/ipython/issues/7044)\n``````\n",
    "created_at": "2014-11-27T14:53:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158679",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -21,3 +21,5 @@
 3. new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/python-2.7.3.p1.spkg) (patch added: [attachment: sys_path_security.patch](https://github.com/sagemath/sage/files/ticket13579/sys_path_security.patch.gz))
 
 *Reported upstream*: [http://bugs.python.org/issue16202](http://bugs.python.org/issue16202)
+
+*See also*: [https://github.com/ipython/ipython/issues/7044](https://github.com/ipython/ipython/issues/7044)
``````




---

archive/issue_comments_158680.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nCan we get rid of this patch during the Python 3 upgrade by using Python's isolated mode (`-I`)? There's an unanswered question about this at https://bugs.python.org/issue16202 btw.",
    "created_at": "2018-08-24T01:13:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158680",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:85" align="right">comment:85</div>

Can we get rid of this patch during the Python 3 upgrade by using Python's isolated mode (`-I`)? There's an unanswered question about this at https://bugs.python.org/issue16202 btw.



---

archive/issue_comments_158681.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nThere is a followup now at #26457.",
    "created_at": "2018-10-10T12:24:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13579#issuecomment-158681",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:86" align="right">comment:86</div>

There is a followup now at #26457.
