# Issue 13352: Running time improvement of the bitset_len method

archive/issues_013180.json:
```json
{
    "body": "This patch improves the running time of the `bitset_len` method by using `mpn_popcount()`.\n\nBefore:\n\n```\nsage: B = Bitset('10'*10000)\nsage: len(B)\n10000\nsage: %timeit len(B)\n1000 loops, best of 3: 245 us per loop\n```\n\nAfter:\n\n```\nsage: B = Bitset('10'*10000)\nsage: len(B)\n10000\nsage: %timeit len(B)\n100000 loops, best of 3: 2.52 us per loop\n```\n\nThis patch also reorganizes the bitset files, including deleting the `sage/misc/bitset_pxd.pxi` file.\n\nAPPLY:\n\n* [attachment:trac_13352_bitset_len_v4.patch]\n\nAssignee: @jasongrout\n\nCC:  @nathanncohen @nexttime\n\nReviewer: David Coudert\n\nAuthor: David Coudert, Jeroen Demeyer\n\nMerged: sage-5.13.rc0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13352\n\n",
    "closed_at": "2013-12-11T11:02:53Z",
    "created_at": "2012-08-08T23:19:17Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "Running time improvement of the bitset_len method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13352",
    "user": "https://github.com/dcoudert"
}
```
This patch improves the running time of the `bitset_len` method by using `mpn_popcount()`.

Before:

```
sage: B = Bitset('10'*10000)
sage: len(B)
10000
sage: %timeit len(B)
1000 loops, best of 3: 245 us per loop
```

After:

```
sage: B = Bitset('10'*10000)
sage: len(B)
10000
sage: %timeit len(B)
100000 loops, best of 3: 2.52 us per loop
```

This patch also reorganizes the bitset files, including deleting the `sage/misc/bitset_pxd.pxi` file.

APPLY:

* [attachment:trac_13352_bitset_len_v4.patch]

Assignee: @jasongrout

CC:  @nathanncohen @nexttime

Reviewer: David Coudert

Author: David Coudert, Jeroen Demeyer

Merged: sage-5.13.rc0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13352





---

archive/issue_comments_205167.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-08T23:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205167",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_205168.json:
```json
{
    "body": "<a id='comment:2'></a>\nI'd rather \"implement\" the functions in C (where you can use the C preprocessor and `__builtin_popcount()` if available) and write a thin Cython wrapper.\n\nGCC e.g. chooses efficient machine implementations (probably a single instruction), depending on the (configured or specified) target and perhaps also further compiler flags.\n\nNote that GMP has functions like `mpz_popcount()` for `mpz_t`s as well.\n\n\n---\n\nNot sure what the `parallel` refers to ... ;-)",
    "created_at": "2012-08-09T14:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205168",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:2'></a>
I'd rather "implement" the functions in C (where you can use the C preprocessor and `__builtin_popcount()` if available) and write a thin Cython wrapper.

GCC e.g. chooses efficient machine implementations (probably a single instruction), depending on the (configured or specified) target and perhaps also further compiler flags.

Note that GMP has functions like `mpz_popcount()` for `mpz_t`s as well.


---

Not sure what the `parallel` refers to ... ;-)



---

archive/issue_comments_205169.json:
```json
{
    "body": "trials not working",
    "created_at": "2012-08-09T14:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205169",
    "user": "https://github.com/dcoudert"
}
```

trials not working



---

archive/issue_comments_205170.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -33,3 +33,9 @@\n \n The alternative would be to use functions `__builtin_popcount()` and `__builtin_popcountll()`. They are extremely fast but they required to add flag ``-mpopcnt`` or ``-msse4.2`` to the gcc compiler. Can we do that? how? \n \n+\n+APPLY:\n+\n+* trac_13352_bitset_len.patch\n+\n+\n``````\n",
    "created_at": "2012-08-09T15:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205170",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -33,3 +33,9 @@
 
 The alternative would be to use functions `__builtin_popcount()` and `__builtin_popcountll()`. They are extremely fast but they required to add flag ``-mpopcnt`` or ``-msse4.2`` to the gcc compiler. Can we do that? how? 
 
+
+APPLY:
+
+* trac_13352_bitset_len.patch
+
+
``````




---

archive/issue_comments_205171.json:
```json
{
    "body": "<a id='comment:3'></a>\nAttachment [trac_13352-bitcount-in-c.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352-bitcount-in-c.patch) by @dcoudert created at 2012-08-09 15:00:43\n\nReplying to [leif](#comment%3A2):\n> I'd rather \"implement\" the functions in C (where you can use the C preprocessor and `__builtin_popcount()` if available) and write a thin Cython wrapper.\n> \n> GCC e.g. chooses efficient machine implementations (probably a single instruction), depending on the (configured or specified) target and perhaps also further compiler flags.\n\n\nAs reported in https://groups.google.com/forum/#!topic/sage-devel/GnudTUwbGG4, I tried to implement the function in C with `__builtin_popcount()`. I was able to compile successfully, but then sage was not working anymore.\nSee attached patch [attachment:trac_13352-bitcount-in-c.patch].\n\n\n> Note that GMP has functions like `mpz_popcount()` for `mpz_t`s as well.\n\n\nIt could be another solution, but I have not been able yet to find how to access the functions used for int behind? \n\n\n> Not sure what the `parallel` refers to ... ;-)\n\nIn fact, the 4 lines ` n = __COUNT32__(n, 0) ` can be executed in parallel and gcc is sometimes able to optimize the sequence of instructions. For instance, all methods have similar running times on my macbook air, but parallel methods are slower on my old PC (system still in 32-bits...).",
    "created_at": "2012-08-09T15:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205171",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>
Attachment [trac_13352-bitcount-in-c.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352-bitcount-in-c.patch) by @dcoudert created at 2012-08-09 15:00:43

Replying to [leif](#comment%3A2):
> I'd rather "implement" the functions in C (where you can use the C preprocessor and `__builtin_popcount()` if available) and write a thin Cython wrapper.
> 
> GCC e.g. chooses efficient machine implementations (probably a single instruction), depending on the (configured or specified) target and perhaps also further compiler flags.


As reported in https://groups.google.com/forum/#!topic/sage-devel/GnudTUwbGG4, I tried to implement the function in C with `__builtin_popcount()`. I was able to compile successfully, but then sage was not working anymore.
See attached patch [attachment:trac_13352-bitcount-in-c.patch].


> Note that GMP has functions like `mpz_popcount()` for `mpz_t`s as well.


It could be another solution, but I have not been able yet to find how to access the functions used for int behind? 


> Not sure what the `parallel` refers to ... ;-)

In fact, the 4 lines ` n = __COUNT32__(n, 0) ` can be executed in parallel and gcc is sometimes able to optimize the sequence of instructions. For instance, all methods have similar running times on my macbook air, but parallel methods are slower on my old PC (system still in 32-bits...).



---

archive/issue_comments_205172.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -36,6 +36,6 @@\n \n APPLY:\n \n-* trac_13352_bitset_len.patch\n+* [attachment:trac_13352_bitset_len.patch]\n \n \n``````\n",
    "created_at": "2012-08-09T15:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205172",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -36,6 +36,6 @@
 
 APPLY:
 
-* trac_13352_bitset_len.patch
+* [attachment:trac_13352_bitset_len.patch]
 
 
``````




---

archive/issue_comments_205173.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [dcoudert](#comment%3A3):\n> Replying to [leif](#comment%3A2):\n> > Not sure what the `parallel` refers to ... ;-)\n\n> In fact, the 4 lines ` n = __COUNT32__(n, 0) ` can be executed in parallel\n\nWell, obviously not, since you have the data dependence on `n`. ;-)\n\n\n\n\n\nBtw., you should use `UINT32_C(1)` instead of `0x1u` etc., and e.g. `UINT32_MAX` instead of `(<uint32_t>-1)` (Cython code) etc.\n\nThe types of the shift parameters (of `__TWO??__()`) are slightly overdim'ed...",
    "created_at": "2012-08-09T18:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205173",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
Replying to [dcoudert](#comment%3A3):
> Replying to [leif](#comment%3A2):
> > Not sure what the `parallel` refers to ... ;-)

> In fact, the 4 lines ` n = __COUNT32__(n, 0) ` can be executed in parallel

Well, obviously not, since you have the data dependence on `n`. ;-)





Btw., you should use `UINT32_C(1)` instead of `0x1u` etc., and e.g. `UINT32_MAX` instead of `(<uint32_t>-1)` (Cython code) etc.

The types of the shift parameters (of `__TWO??__()`) are slightly overdim'ed...



---

archive/issue_comments_205174.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm able to import UINT32_MAX, but not UINT32_C.\n- with `from libc.stdint cimport UINT32_C`: it is apparently not imported\n- with `from libc.stdint import UINT32_C`: it compiles, but sage crashes with weird messages\n\nAny special trick?",
    "created_at": "2012-08-09T20:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205174",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:6'></a>
I'm able to import UINT32_MAX, but not UINT32_C.
- with `from libc.stdint cimport UINT32_C`: it is apparently not imported
- with `from libc.stdint import UINT32_C`: it compiles, but sage crashes with weird messages

Any special trick?



---

archive/issue_events_043076.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13352#event-43076"
}
```



---

archive/issue_comments_205175.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [trac_13352_bitset_len.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len.patch) by @jdemeyer created at 2013-08-13 15:35:53",
    "created_at": "2013-08-13T15:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205175",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Attachment [trac_13352_bitset_len.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len.patch) by @jdemeyer created at 2013-08-13 15:35:53



---

archive/issue_comments_205176.json:
```json
{
    "body": "Attachment [trac_13352_bitset_len_v2.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len_v2.patch) by @dcoudert created at 2013-08-18 14:51:21",
    "created_at": "2013-08-18T14:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205176",
    "user": "https://github.com/dcoudert"
}
```

Attachment [trac_13352_bitset_len_v2.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len_v2.patch) by @dcoudert created at 2013-08-18 14:51:21



---

archive/issue_comments_205177.json:
```json
{
    "body": "<a id='comment:8'></a>\nHello,\n\nSince I have now understood how to use `__builtin_popcountl` (not obvious when you don't know), I have uploaded a new version of the patch.\n\nbefore:\n\n```\nsage: B = Bitset('00'*10000+'1')\nsage: len(B)\n1\nsage: %timeit len(B)\n1000000 loops, best of 3: 268 ns per loop\nsage: B = Bitset('10'*10000)\nsage: len(B)\n10000\nsage: %timeit len(B)\n1000 loops, best of 3: 245 us per loop\nsage: B = Bitset('10'*1000000)\nsage: len(B)\n1000000\nsage: %timeit len(B)\n10 loops, best of 3: 24.1 ms per loop\n```\n\nafter:\n\n```\nsage: B = Bitset('00'*10000+'1')\nsage: len(B)\n1\nsage: %timeit len(B)\n1000000 loops, best of 3: 275 ns per loop\nsage: B = Bitset('10'*10000)\nsage: len(B)\n10000\nsage: %timeit len(B)\n100000 loops, best of 3: 2.52 us per loop\nsage: B = Bitset('10'*1000000)\nsage: len(B)\n1000000\nsage: %timeit len(B)\n1000 loops, best of 3: 236 us per loop\n```\n\n\nI'm wondering if I should add a wrapper in case the `__builtin_popcountl` method is not available. This is not difficult, but I don't know which environnement variables should be tested.\n\nThanks.",
    "created_at": "2013-08-18T15:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205177",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:8'></a>
Hello,

Since I have now understood how to use `__builtin_popcountl` (not obvious when you don't know), I have uploaded a new version of the patch.

before:

```
sage: B = Bitset('00'*10000+'1')
sage: len(B)
1
sage: %timeit len(B)
1000000 loops, best of 3: 268 ns per loop
sage: B = Bitset('10'*10000)
sage: len(B)
10000
sage: %timeit len(B)
1000 loops, best of 3: 245 us per loop
sage: B = Bitset('10'*1000000)
sage: len(B)
1000000
sage: %timeit len(B)
10 loops, best of 3: 24.1 ms per loop
```

after:

```
sage: B = Bitset('00'*10000+'1')
sage: len(B)
1
sage: %timeit len(B)
1000000 loops, best of 3: 275 ns per loop
sage: B = Bitset('10'*10000)
sage: len(B)
10000
sage: %timeit len(B)
100000 loops, best of 3: 2.52 us per loop
sage: B = Bitset('10'*1000000)
sage: len(B)
1000000
sage: %timeit len(B)
1000 loops, best of 3: 236 us per loop
```


I'm wondering if I should add a wrapper in case the `__builtin_popcountl` method is not available. This is not difficult, but I don't know which environnement variables should be tested.

Thanks.



---

archive/issue_comments_205178.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,41 +1,28 @@\n-This patch improves the running time of the `bitset_len` method by using fast methods for counting bits in 32 and 64 bits integers (popcount). It\n-- adds file `bitcount.pxi` to `sage/misc/`. This file contains the functions for counting bits in 32 or 64 bits integers\n-- adds corresponding tests to file `misc_c.pyx`\n-- modifies the `bitset_len` function accordingly\n+This patch improves the running time of the `bitset_len` method by using `__builtin_popcount()`.\n \n Before:\n \n ```\n-sage: x = FrozenBitset('10'*1003002); len(x)\n-1003002\n-sage: %timeit len(x)\n-125 loops, best of 3: 5.27 ms per loop\n-sage: x = FrozenBitset('10'*10705); len(x)\n-10705\n-sage: %timeit len(x)\n-625 loops, best of 3: 56.3 \u00b5s per loop\n+sage: B = Bitset('10'*10000)\n+sage: len(B)\n+10000\n+sage: %timeit len(B)\n+1000 loops, best of 3: 245 us per loop\n ```\n \n After:\n \n ```\n-sage: x = FrozenBitset('10'*1003002); len(x)\n-1003002\n-sage: %timeit len(x)\n-625 loops, best of 3: 865 \u00b5s per loop\n-sage: x = FrozenBitset('10'*10705); len(x)\n-10705\n-sage: %timeit len(x)\n-625 loops, best of 3: 9.39 \u00b5s per loop\n+sage: B = Bitset('10'*10000)\n+sage: len(B)\n+10000\n+sage: %timeit len(B)\n+100000 loops, best of 3: 2.52 us per loop\n ```\n-\n-The ``popcount_32`` method is the same than the function used in patch #12371. \n-\n-The alternative would be to use functions `__builtin_popcount()` and `__builtin_popcountll()`. They are extremely fast but they required to add flag ``-mpopcnt`` or ``-msse4.2`` to the gcc compiler. Can we do that? how? \n \n \n APPLY:\n \n-* [attachment:trac_13352_bitset_len.patch]\n+* [attachment:trac_13352_bitset_len_v2.patch]\n \n \n``````\n",
    "created_at": "2013-08-18T15:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205178",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,41 +1,28 @@
-This patch improves the running time of the `bitset_len` method by using fast methods for counting bits in 32 and 64 bits integers (popcount). It
-- adds file `bitcount.pxi` to `sage/misc/`. This file contains the functions for counting bits in 32 or 64 bits integers
-- adds corresponding tests to file `misc_c.pyx`
-- modifies the `bitset_len` function accordingly
+This patch improves the running time of the `bitset_len` method by using `__builtin_popcount()`.
 
 Before:
 
 ```
-sage: x = FrozenBitset('10'*1003002); len(x)
-1003002
-sage: %timeit len(x)
-125 loops, best of 3: 5.27 ms per loop
-sage: x = FrozenBitset('10'*10705); len(x)
-10705
-sage: %timeit len(x)
-625 loops, best of 3: 56.3 µs per loop
+sage: B = Bitset('10'*10000)
+sage: len(B)
+10000
+sage: %timeit len(B)
+1000 loops, best of 3: 245 us per loop
 ```
 
 After:
 
 ```
-sage: x = FrozenBitset('10'*1003002); len(x)
-1003002
-sage: %timeit len(x)
-625 loops, best of 3: 865 µs per loop
-sage: x = FrozenBitset('10'*10705); len(x)
-10705
-sage: %timeit len(x)
-625 loops, best of 3: 9.39 µs per loop
+sage: B = Bitset('10'*10000)
+sage: len(B)
+10000
+sage: %timeit len(B)
+100000 loops, best of 3: 2.52 us per loop
 ```
-
-The ``popcount_32`` method is the same than the function used in patch #12371. 
-
-The alternative would be to use functions `__builtin_popcount()` and `__builtin_popcountll()`. They are extremely fast but they required to add flag ``-mpopcnt`` or ``-msse4.2`` to the gcc compiler. Can we do that? how? 
 
 
 APPLY:
 
-* [attachment:trac_13352_bitset_len.patch]
+* [attachment:trac_13352_bitset_len_v2.patch]
 
 
``````




---

archive/issue_comments_205179.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,6 +23,6 @@\n \n APPLY:\n \n-* [attachment:trac_13352_bitset_len_v2.patch]\n+* [attachment:trac_13352_bitset_len_v3.patch]\n \n \n``````\n",
    "created_at": "2013-08-26T13:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205179",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,6 +23,6 @@
 
 APPLY:
 
-* [attachment:trac_13352_bitset_len_v2.patch]
+* [attachment:trac_13352_bitset_len_v3.patch]
 
 
``````




---

archive/issue_comments_205180.json:
```json
{
    "body": "<a id='comment:9'></a>\nI have now implemented the function in C in file `popcount.h` with a small wrapper. The result is a bit slower than without wrapper, but still way faster than previous method.\n\n```\nsage: B = Bitset('00'*10000+'1')\nsage: len(B)\n1\nsage: %timeit len(B)\n1000000 loops, best of 3: 361 ns per loop\nsage: B = Bitset('10'*10000)\nsage: %timeit len(B)\n100000 loops, best of 3: 3.03 us per loop\nsage: B = Bitset('10'*1000000)\nsage: len(B)\n1000000\nsage: %timeit len(B)\n1000 loops, best of 3: 287 us per loop\n```\n\nI have used the `_WIN32` flag, but I'm not sure it's the good one. So if one knows the best flag to use to detect when the `__builtin_popcount` method is not available, please let me know.",
    "created_at": "2013-08-26T13:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205180",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:9'></a>
I have now implemented the function in C in file `popcount.h` with a small wrapper. The result is a bit slower than without wrapper, but still way faster than previous method.

```
sage: B = Bitset('00'*10000+'1')
sage: len(B)
1
sage: %timeit len(B)
1000000 loops, best of 3: 361 ns per loop
sage: B = Bitset('10'*10000)
sage: %timeit len(B)
100000 loops, best of 3: 3.03 us per loop
sage: B = Bitset('10'*1000000)
sage: len(B)
1000000
sage: %timeit len(B)
1000 loops, best of 3: 287 us per loop
```

I have used the `_WIN32` flag, but I'm not sure it's the good one. So if one knows the best flag to use to detect when the `__builtin_popcount` method is not available, please let me know.



---

archive/issue_comments_205181.json:
```json
{
    "body": "<a id='comment:10'></a>\nHello,\n\nafter browsing the web, I came up with this new version. The current version tests is the cpu has builtin support. If yes, we use builtin version. Else, we use hakmem methods.\n* http://gcc.gnu.org/onlinedocs/gcc/X86-Built_002din-Functions.html\n* http://gcc.gnu.org/gcc-4.8/changes.html\n* http://www.spinics.net/lists/linux-ext4/msg35827.html\n\nWe don't need all the methods for `bitset_len` but it could be useful for other usage.\n\nLet me know if it is OK.",
    "created_at": "2013-09-16T21:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205181",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:10'></a>
Hello,

after browsing the web, I came up with this new version. The current version tests is the cpu has builtin support. If yes, we use builtin version. Else, we use hakmem methods.
* http://gcc.gnu.org/onlinedocs/gcc/X86-Built_002din-Functions.html
* http://gcc.gnu.org/gcc-4.8/changes.html
* http://www.spinics.net/lists/linux-ext4/msg35827.html

We don't need all the methods for `bitset_len` but it could be useful for other usage.

Let me know if it is OK.



---

archive/issue_comments_205182.json:
```json
{
    "body": "<a id='comment:11'></a>\nHMmmmmmmmm.... I'm trying to understand the code and it's much more complicated than what I actually read. Funny, looks like you can have as much fun with GCC than with Python, and decide how stuff is to be run at run time instead of compile time `:-P`\n\nThis being said, if I understand well what \"ifunc\" does I do not see how the popcount instruction will be used when available. To me it looks like you should make sure that the file is compiled with the `-mpopcnt` GCC flag (so that `__builtin_popcnt` is always replaced by the popcount instruction even if it does not exist), and that this ifunc trick means to avoid using this instruction if it is detected that, at runtime, it is not available.\n\nThis being said, it is a very nice trick `O_o`\n\nNathann",
    "created_at": "2013-09-17T09:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205182",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:11'></a>
HMmmmmmmmm.... I'm trying to understand the code and it's much more complicated than what I actually read. Funny, looks like you can have as much fun with GCC than with Python, and decide how stuff is to be run at run time instead of compile time `:-P`

This being said, if I understand well what "ifunc" does I do not see how the popcount instruction will be used when available. To me it looks like you should make sure that the file is compiled with the `-mpopcnt` GCC flag (so that `__builtin_popcnt` is always replaced by the popcount instruction even if it does not exist), and that this ifunc trick means to avoid using this instruction if it is detected that, at runtime, it is not available.

This being said, it is a very nice trick `O_o`

Nathann



---

archive/issue_comments_205183.json:
```json
{
    "body": "<a id='comment:12'></a>\nI would also say that those 2 blocks \n\n```\n__attribute__ ((__target__ (\"popcnt\"))) \n static unsigned int builtin_popcount(unsigned int w){ \n return (sizeof(unsigned int)==4? __builtin_popcount(w) : __builtin_popcountl(w)); \n } \n```\n\nare mistakes. Whatever happens, regardless of the architecture, `__builtin_popcount` works on int type, and `__builtin_popcountl` works on long types.\n\nAlso, perhaps you should credit Cristian Rodr\u00edguez somewhere `:-P`\n\nNathann",
    "created_at": "2013-09-17T09:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205183",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:12'></a>
I would also say that those 2 blocks 

```
__attribute__ ((__target__ ("popcnt"))) 
 static unsigned int builtin_popcount(unsigned int w){ 
 return (sizeof(unsigned int)==4? __builtin_popcount(w) : __builtin_popcountl(w)); 
 } 
```

are mistakes. Whatever happens, regardless of the architecture, `__builtin_popcount` works on int type, and `__builtin_popcountl` works on long types.

Also, perhaps you should credit Cristian Rodríguez somewhere `:-P`

Nathann



---

archive/issue_comments_205184.json:
```json
{
    "body": "<a id='comment:13'></a>\nAttachment [trac_13352_bitset_len_v3.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len_v3.patch) by @dcoudert created at 2013-09-17 15:28:18\n\nRight. I have simplified the code and add credits to Cristian Rodriguez.",
    "created_at": "2013-09-17T15:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205184",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:13'></a>
Attachment [trac_13352_bitset_len_v3.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len_v3.patch) by @dcoudert created at 2013-09-17 15:28:18

Right. I have simplified the code and add credits to Cristian Rodriguez.



---

archive/issue_comments_205185.json:
```json
{
    "body": "<a id='comment:14'></a>\nHere's a slightly cleaner version which does not use ifunc but only G++'s multiversionning. C's looking very much like Python these days `:-PPPP`\n\nNice links :\n* http://gcc.gnu.org/wiki/FunctionMultiVersioning\n* http://gcc.gnu.org/onlinedocs/gcc/Function-Multiversioning.html\n\nNathann",
    "created_at": "2013-09-19T15:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205185",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:14'></a>
Here's a slightly cleaner version which does not use ifunc but only G++'s multiversionning. C's looking very much like Python these days `:-PPPP`

Nice links :
* http://gcc.gnu.org/wiki/FunctionMultiVersioning
* http://gcc.gnu.org/onlinedocs/gcc/Function-Multiversioning.html

Nathann



---

archive/issue_comments_205186.json:
```json
{
    "body": "Attachment [a.c](tarball://root/attachments/some-uuid/ticket13352/a.c) by @nathanncohen created at 2013-09-19 15:21:33",
    "created_at": "2013-09-19T15:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205186",
    "user": "https://github.com/nathanncohen"
}
```

Attachment [a.c](tarball://root/attachments/some-uuid/ticket13352/a.c) by @nathanncohen created at 2013-09-19 15:21:33



---

archive/issue_comments_205187.json:
```json
{
    "body": "<a id='comment:15'></a>\nUnfortunately, I'm unable to use this for the patch because the \"default\" keyword is not recognized.",
    "created_at": "2013-09-19T21:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205187",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:15'></a>
Unfortunately, I'm unable to use this for the patch because the "default" keyword is not recognized.



---

archive/issue_comments_205188.json:
```json
{
    "body": "<a id='comment:16'></a>\nHmmmmmm... Well, it seems that this feature is only available in gcc 4.8+. I asked Volker for his advice on this ticket (or rather on the .c file I uploaded), and he told me that we should check for both gcc 4.8+ and x86 (ifdef `__i386__`).\n\nBesides, he saw on that link (http://gcc.gnu.org/bugzilla/show_bug.cgi?id=36041, though I can't find out where on the page) that GCC was about to patch that, and improve the generic version of `__builtin_gcc`. If that's the case, perhaps we should just use theirs, waiting for the patch to be merged with a future gcc release. Otherwise we can use the MIT HAKMEM version indeed.\n\nI'll try to send a version with both codes today. And we'll remove the old one in a couple of years `:-P`\n\nNathann",
    "created_at": "2013-09-20T07:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205188",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>
Hmmmmmm... Well, it seems that this feature is only available in gcc 4.8+. I asked Volker for his advice on this ticket (or rather on the .c file I uploaded), and he told me that we should check for both gcc 4.8+ and x86 (ifdef `__i386__`).

Besides, he saw on that link (http://gcc.gnu.org/bugzilla/show_bug.cgi?id=36041, though I can't find out where on the page) that GCC was about to patch that, and improve the generic version of `__builtin_gcc`. If that's the case, perhaps we should just use theirs, waiting for the patch to be merged with a future gcc release. Otherwise we can use the MIT HAKMEM version indeed.

I'll try to send a version with both codes today. And we'll remove the old one in a couple of years `:-P`

Nathann



---

archive/issue_comments_205189.json:
```json
{
    "body": "<a id='comment:17'></a>\nHey I don't get it... In your patch you also use a attribute/target with popcount. You can't compile my code yet you can compile yours ? And that means that they added this attribute/target feature before adding the \"default\" keyword ? `O_o`\n\nNathann",
    "created_at": "2013-09-20T07:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205189",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:17'></a>
Hey I don't get it... In your patch you also use a attribute/target with popcount. You can't compile my code yet you can compile yours ? And that means that they added this attribute/target feature before adding the "default" keyword ? `O_o`

Nathann



---

archive/issue_comments_205190.json:
```json
{
    "body": "<a id='comment:18'></a>\nApparently yes. Have you tried to modify the patch and compile on your own computer?",
    "created_at": "2013-09-20T07:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205190",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:18'></a>
Apparently yes. Have you tried to modify the patch and compile on your own computer?



---

archive/issue_comments_205191.json:
```json
{
    "body": "<a id='comment:19'></a>\nI'm trying, but it takes forever to compile. What happens if you replace \"default\" with \"\"  in the .c file ?\n\nNathann",
    "created_at": "2013-09-20T07:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205191",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:19'></a>
I'm trying, but it takes forever to compile. What happens if you replace "default" with ""  in the .c file ?

Nathann



---

archive/issue_comments_205192.json:
```json
{
    "body": "<a id='comment:20'></a>\nArg. This \"\" fails `:-/`\n\nNathann",
    "created_at": "2013-09-20T07:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205192",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:20'></a>
Arg. This "" fails `:-/`

Nathann



---

archive/issue_comments_205193.json:
```json
{
    "body": "<a id='comment:21'></a>\nHMmmmmmm `O_o`\n\nWhat I get when running tests is :\n\n```\nTraceback (most recent call last):\n  File \"/home/ncohen/.Sage/local/bin/sage-runtests\", line 79, in <module>\n    from sage.doctest.control import DocTestController\n  File \"/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 27, in <module>\n    from sources import FileDocTestSource, DictAsObject\n  File \"/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/sources.py\", line 27, in <module>\n    from util import NestedName\n  File \"/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/util.py\", line 23, in <module>\n    from sage.misc.misc import walltime, cputime\n  File \"/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/misc/misc.py\", line 565, in <module>\n    from sage.misc.misc_c import prod, running_total, balanced_sum, is_64_bit, is_32_bit\nImportError: /home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/misc/misc_c.so: undefined symbol: __builtin_popcount\n```\n\nNathann",
    "created_at": "2013-09-20T08:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205193",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:21'></a>
HMmmmmmm `O_o`

What I get when running tests is :

```
Traceback (most recent call last):
  File "/home/ncohen/.Sage/local/bin/sage-runtests", line 79, in <module>
    from sage.doctest.control import DocTestController
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 27, in <module>
    from sources import FileDocTestSource, DictAsObject
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/sources.py", line 27, in <module>
    from util import NestedName
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/util.py", line 23, in <module>
    from sage.misc.misc import walltime, cputime
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/misc/misc.py", line 565, in <module>
    from sage.misc.misc_c import prod, running_total, balanced_sum, is_64_bit, is_32_bit
ImportError: /home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/misc/misc_c.so: undefined symbol: __builtin_popcount
```

Nathann



---

archive/issue_comments_205194.json:
```json
{
    "body": "<a id='comment:22'></a>\n(that was with your patch applied)",
    "created_at": "2013-09-20T09:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205194",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:22'></a>
(that was with your patch applied)



---

archive/issue_comments_205195.json:
```json
{
    "body": "<a id='comment:23'></a>\nso you mean with patch http://trac.sagemath.org/raw-attachment/ticket/13352/trac_13352_bitset_len_v3.patch as it is or a modified version ?\n\n\nWhen I try to replace my patch with what you have put in a.c file, I get:\n\n```\nIn file included from sage/coding/binary_code.c:319:0:\n./sage/misc/popcount.h:107:3: error: attribute(target(\"default\")) is unknown\n./sage/misc/popcount.h:123:3: error: attribute(target(\"default\")) is unknown\n./sage/misc/popcount.h:128:14: error: redefinition of \u2018popcount\u2019\n./sage/misc/popcount.h:123:14: note: previous definition of \u2018popcount\u2019 was here\n./sage/misc/popcount.h:132:14: error: redefinition of \u2018popcountl\u2019\n./sage/misc/popcount.h:107:14: note: previous definition of \u2018popcountl\u2019 was here\nerror: command 'gcc' failed with exit status 1\nError installing modified sage library code.\n```",
    "created_at": "2013-09-20T09:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205195",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:23'></a>
so you mean with patch http://trac.sagemath.org/raw-attachment/ticket/13352/trac_13352_bitset_len_v3.patch as it is or a modified version ?


When I try to replace my patch with what you have put in a.c file, I get:

```
In file included from sage/coding/binary_code.c:319:0:
./sage/misc/popcount.h:107:3: error: attribute(target("default")) is unknown
./sage/misc/popcount.h:123:3: error: attribute(target("default")) is unknown
./sage/misc/popcount.h:128:14: error: redefinition of ‘popcount’
./sage/misc/popcount.h:123:14: note: previous definition of ‘popcount’ was here
./sage/misc/popcount.h:132:14: error: redefinition of ‘popcountl’
./sage/misc/popcount.h:107:14: note: previous definition of ‘popcountl’ was here
error: command 'gcc' failed with exit status 1
Error installing modified sage library code.
```



---

archive/issue_comments_205196.json:
```json
{
    "body": "<a id='comment:24'></a>\nI meant your patch, without modifications. As for the errors you get, I think it's because the file gets compiled with gcc instead of g++. Volker said that it should be sufficient to make it a .cc file, and that GCC would take the hint and use the right compiler instead. It does work when outside of Sage :\n\n```\n~$ cp a.cc a.c\n~$ gcc a.c -o a\na.c:31:12: error: redefinition of \u2018popcount\u2019\n inline int popcount(unsigned int i){\n            ^\na.c:26:12: note: previous definition of \u2018popcount\u2019 was here\n inline int popcount(unsigned int i){\n            ^\na.c:35:12: error: redefinition of \u2018popcountl\u2019\n inline int popcountl(unsigned long i){\n            ^\na.c:10:12: note: previous definition of \u2018popcountl\u2019 was here\n inline int popcountl(unsigned long i){\n            ^\n~$ gcc a.cc -o a\n~$ \n```\n\nThough there does not seem to be anything wrong with \"default\" on my computer. Which version of gcc are you using ? It's probably < 4.8.\n\nNathann",
    "created_at": "2013-09-20T09:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205196",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:24'></a>
I meant your patch, without modifications. As for the errors you get, I think it's because the file gets compiled with gcc instead of g++. Volker said that it should be sufficient to make it a .cc file, and that GCC would take the hint and use the right compiler instead. It does work when outside of Sage :

```
~$ cp a.cc a.c
~$ gcc a.c -o a
a.c:31:12: error: redefinition of ‘popcount’
 inline int popcount(unsigned int i){
            ^
a.c:26:12: note: previous definition of ‘popcount’ was here
 inline int popcount(unsigned int i){
            ^
a.c:35:12: error: redefinition of ‘popcountl’
 inline int popcountl(unsigned long i){
            ^
a.c:10:12: note: previous definition of ‘popcountl’ was here
 inline int popcountl(unsigned long i){
            ^
~$ gcc a.cc -o a
~$ 
```

Though there does not seem to be anything wrong with "default" on my computer. Which version of gcc are you using ? It's probably < 4.8.

Nathann



---

archive/issue_comments_205197.json:
```json
{
    "body": "<a id='comment:25'></a>\ngcc (GCC) 4.6.3 20120306.",
    "created_at": "2013-09-20T09:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205197",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:25'></a>
gcc (GCC) 4.6.3 20120306.



---

archive/issue_comments_205198.json:
```json
{
    "body": "<a id='comment:26'></a>\nHelloooooooo ! Just to mention that I have been fighting with multiversionning in Sage+GCC for two days now, and that I can't seem to make it work. It works outside of Sage, it segfaults inside of Sage and I have no idea why.\n\nOh, and there is a `#DEFINE NO_INLINE` among the default preprocessor variables for anything that gets compiled by Sage it seems.\n\nNathann",
    "created_at": "2013-09-21T08:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205198",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:26'></a>
Helloooooooo ! Just to mention that I have been fighting with multiversionning in Sage+GCC for two days now, and that I can't seem to make it work. It works outside of Sage, it segfaults inside of Sage and I have no idea why.

Oh, and there is a `#DEFINE NO_INLINE` among the default preprocessor variables for anything that gets compiled by Sage it seems.

Nathann



---

archive/issue_comments_205199.json:
```json
{
    "body": "<a id='comment:27'></a>\nSo unless someone has a good solution, we can make a patch containing only the hakmem methods, and if one is later able to make `__builtin_popcount` running, then we may switch to it.\nDo you agree?",
    "created_at": "2013-09-21T15:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205199",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:27'></a>
So unless someone has a good solution, we can make a patch containing only the hakmem methods, and if one is later able to make `__builtin_popcount` running, then we may switch to it.
Do you agree?



---

archive/issue_comments_205200.json:
```json
{
    "body": "<a id='comment:28'></a>\nYep, it makes sense but it is a pity `:-/`\n\nI wrote to sage-devel, just in case ... \n\nhttps://groups.google.com/d/topic/sage-devel/FIxzZv0L_lo/discussion\n\nNathann",
    "created_at": "2013-09-22T08:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205200",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:28'></a>
Yep, it makes sense but it is a pity `:-/`

I wrote to sage-devel, just in case ... 

https://groups.google.com/d/topic/sage-devel/FIxzZv0L_lo/discussion

Nathann



---

archive/issue_comments_205201.json:
```json
{
    "body": "<a id='comment:29'></a>\nI think a great suggestion implied by #14704 is to use `mpn_popcount()` for this. That's essentially one line of code to call that function :-)",
    "created_at": "2013-12-10T09:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205201",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
I think a great suggestion implied by #14704 is to use `mpn_popcount()` for this. That's essentially one line of code to call that function :-)



---

archive/issue_comments_205202.json:
```json
{
    "body": "<a id='comment:30'></a>\nI'm working on a patch which does this...",
    "created_at": "2013-12-10T09:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205202",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>
I'm working on a patch which does this...



---

archive/issue_comments_205203.json:
```json
{
    "body": "<a id='comment:31'></a>\nThat would be great if you have the good trick to use that method. I tried some time ago to use `mpz_popcount` and failed.",
    "created_at": "2013-12-10T10:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205203",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:31'></a>
That would be great if you have the good trick to use that method. I tried some time ago to use `mpz_popcount` and failed.



---

archive/issue_comments_205204.json:
```json
{
    "body": "<a id='comment:32'></a>\nI'm also merging `bitset_pxd.pxi` and `bitset.pxd` (I see no reason why these would be two separate files) and moving the doctests to `bitset.pyx`.",
    "created_at": "2013-12-10T10:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205204",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>
I'm also merging `bitset_pxd.pxi` and `bitset.pxd` (I see no reason why these would be two separate files) and moving the doctests to `bitset.pyx`.



---

archive/issue_comments_205205.json:
```json
{
    "body": "<a id='comment:33'></a>\nHmmmmmmmmmm `O_O`\n\nYou are on a dangerous road, Jeroen. The road to many broken dependencies in the graph/ folder `:-PPPPPP`\n\nNathann",
    "created_at": "2013-12-10T10:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205205",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:33'></a>
Hmmmmmmmmmm `O_O`

You are on a dangerous road, Jeroen. The road to many broken dependencies in the graph/ folder `:-PPPPPP`

Nathann



---

archive/issue_comments_205206.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [ncohen](#comment%3A33):\n> Hmmmmmmmmmm `O_O`\n> \n> You are on a dangerous road, Jeroen. The road to many broken dependencies in the graph/ folder `:-PPPPPP`\n\n\nYou mean because of `bitset_pxd.pxi`? I could simply leave that file with a one-liner\n\n```\nfrom sage.misc.bitset cimport *\n```\nif you prefer.",
    "created_at": "2013-12-10T10:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205206",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>
Replying to [ncohen](#comment%3A33):
> Hmmmmmmmmmm `O_O`
> 
> You are on a dangerous road, Jeroen. The road to many broken dependencies in the graph/ folder `:-PPPPPP`


You mean because of `bitset_pxd.pxi`? I could simply leave that file with a one-liner

```
from sage.misc.bitset cimport *
```
if you prefer.



---

archive/issue_comments_205207.json:
```json
{
    "body": "Changing author from \"David Coudert\" to \"David Coudert, Jeroen Demeyer\"",
    "created_at": "2013-12-10T10:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205207",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "David Coudert" to "David Coudert, Jeroen Demeyer"



---

archive/issue_comments_205208.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,6 +23,4 @@\n \n APPLY:\n \n-* [attachment:trac_13352_bitset_len_v3.patch]\n-\n-\n+* [attachment:trac_13352_bitset_len_v4.patch]\n``````\n",
    "created_at": "2013-12-10T10:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205208",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,6 +23,4 @@
 
 APPLY:
 
-* [attachment:trac_13352_bitset_len_v3.patch]
-
-
+* [attachment:trac_13352_bitset_len_v4.patch]
``````




---

archive/issue_comments_205209.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [dcoudert](#comment%3A31):\n> That would be great if you have the good trick to use that method. I tried some time ago to use `mpz_popcount` and failed. \n\nThe trick is to use `mpn_popcount` instead of `mpz_popcount`.",
    "created_at": "2013-12-10T11:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205209",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>
Replying to [dcoudert](#comment%3A31):
> That would be great if you have the good trick to use that method. I tried some time ago to use `mpz_popcount` and failed. 

The trick is to use `mpn_popcount` instead of `mpz_popcount`.



---

archive/issue_comments_205210.json:
```json
{
    "body": "<a id='comment:37'></a>\nSpeed is much better too.\n\nWith [attachment:trac_13352_bitset_len_v3.patch\u200b]:\n\n```\nsage: B = Bitset('10'*10000)\nsage: timeit('len(B)',repeat=100,number=10000)\n10000 loops, best of 100: 1.24 \u00b5s per loop\nsage: B = Bitset('00'*10000)\nsage: timeit('len(B)',repeat=100,number=10000)\n10000 loops, best of 100: 254 ns per loop\n```\n\nWith [attachment:trac_13352_bitset_len_v4.patch\u200b]:\n\n```\nsage: B = Bitset('10'*10000)\nsage: timeit('len(B)',repeat=100,number=10000)\n10000 loops, best of 100: 168 ns per loop\nsage: B = Bitset('00'*10000)\nsage:  timeit('len(B)',repeat=100,number=10000)\n10000 loops, best of 100: 168 ns per loop\n```",
    "created_at": "2013-12-10T11:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205210",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
Speed is much better too.

With [attachment:trac_13352_bitset_len_v3.patch​]:

```
sage: B = Bitset('10'*10000)
sage: timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 1.24 µs per loop
sage: B = Bitset('00'*10000)
sage: timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 254 ns per loop
```

With [attachment:trac_13352_bitset_len_v4.patch​]:

```
sage: B = Bitset('10'*10000)
sage: timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 168 ns per loop
sage: B = Bitset('00'*10000)
sage:  timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 168 ns per loop
```



---

archive/issue_comments_205211.json:
```json
{
    "body": "<a id='comment:38'></a>\nSimilar improvements could be made to other bitset functions (in particular to `bitset_next()` and the like). But that would be for a new ticket...",
    "created_at": "2013-12-10T12:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205211",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>
Similar improvements could be made to other bitset functions (in particular to `bitset_next()` and the like). But that would be for a new ticket...



---

archive/issue_comments_205212.json:
```json
{
    "body": "<a id='comment:39'></a>\nStrangely, many places were importing `bitset` without actually using bitsets... so I removed those redundant imports.\n\nEven stranger were two files `sage/combinat/debruijn_sequence.pxd` and `sage/matroids/unpickling.pxd` containing just one line\n\n```\ninclude 'sage/misc/bitset_pxd.pxi' \n```\nwhich was in both cases unused.",
    "created_at": "2013-12-10T12:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205212",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>
Strangely, many places were importing `bitset` without actually using bitsets... so I removed those redundant imports.

Even stranger were two files `sage/combinat/debruijn_sequence.pxd` and `sage/matroids/unpickling.pxd` containing just one line

```
include 'sage/misc/bitset_pxd.pxi' 
```
which was in both cases unused.



---

archive/issue_comments_205213.json:
```json
{
    "body": "Attachment [trac_13352_bitset_len_v4.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len_v4.patch) by @jdemeyer created at 2013-12-10 12:58:11",
    "created_at": "2013-12-10T12:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205213",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_13352_bitset_len_v4.patch](tarball://root/attachments/some-uuid/ticket13352/trac_13352_bitset_len_v4.patch) by @jdemeyer created at 2013-12-10 12:58:11



---

archive/issue_comments_205214.json:
```json
{
    "body": "<a id='comment:40'></a>\nExcellent! The patch is working perfectly (install, doctests on sage/ , etc.). The simplification of the hamming weight method is also very good.\n\nThank you very much.\n\nShould we let Nathann conclude on the status of this ticket?",
    "created_at": "2013-12-10T13:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205214",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:40'></a>
Excellent! The patch is working perfectly (install, doctests on sage/ , etc.). The simplification of the hamming weight method is also very good.

Thank you very much.

Should we let Nathann conclude on the status of this ticket?



---

archive/issue_comments_205215.json:
```json
{
    "body": "<a id='comment:41'></a>\nSee also #10093 for another bitset-related ticket ready for review.",
    "created_at": "2013-12-10T14:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205215",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
See also #10093 for another bitset-related ticket ready for review.



---

archive/issue_comments_205216.json:
```json
{
    "body": "<a id='comment:42'></a>\n> Should we let Nathann conclude on the status of this ticket?\n\n\nNo sorry, please deal with this without me, I'm already juggling with 1000 patches right now `O_o`\n\nNathann",
    "created_at": "2013-12-10T14:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205216",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:42'></a>
> Should we let Nathann conclude on the status of this ticket?


No sorry, please deal with this without me, I'm already juggling with 1000 patches right now `O_o`

Nathann



---

archive/issue_comments_205217.json:
```json
{
    "body": "<a id='comment:43'></a>\nFor me the patch proposed by Jeroen is OK (and I can install #10093 on top of it), so I set its status to positive.",
    "created_at": "2013-12-10T14:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205217",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:43'></a>
For me the patch proposed by Jeroen is OK (and I can install #10093 on top of it), so I set its status to positive.



---

archive/issue_comments_205218.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-10T14:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205218",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_205219.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Coudert\"",
    "created_at": "2013-12-10T15:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205219",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "David Coudert"



---

archive/issue_comments_205220.json:
```json
{
    "body": "<a id='comment:45'></a>\nThis is ridiculous and shows how fast `mpn_popcount()` is:\n\n```\nsage: B = FrozenBitset(capacity=10^5)\nsage: timeit('B.isempty()', repeat=100, number=10000)\n10000 loops, best of 100: 980 ns per loop\nsage: timeit('len(B)', repeat=100, number=10000)\n10000 loops, best of 100: 573 ns per loop\n```",
    "created_at": "2013-12-10T17:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205220",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>
This is ridiculous and shows how fast `mpn_popcount()` is:

```
sage: B = FrozenBitset(capacity=10^5)
sage: timeit('B.isempty()', repeat=100, number=10000)
10000 loops, best of 100: 980 ns per loop
sage: timeit('len(B)', repeat=100, number=10000)
10000 loops, best of 100: 573 ns per loop
```



---

archive/issue_comments_205221.json:
```json
{
    "body": "<a id='comment:46'></a>\nHmmmmmm... Would you happen to have the popcount instruction on the computer on which you try this ?\n\nNathann",
    "created_at": "2013-12-10T20:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205221",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:46'></a>
Hmmmmmm... Would you happen to have the popcount instruction on the computer on which you try this ?

Nathann



---

archive/issue_comments_205222.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [ncohen](#comment%3A46):\n> Hmmmmmm... Would you happen to have the popcount instruction on the computer on which you try this ?\n\n\nI think so, yes.",
    "created_at": "2013-12-10T20:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205222",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>
Replying to [ncohen](#comment%3A46):
> Hmmmmmm... Would you happen to have the popcount instruction on the computer on which you try this ?


I think so, yes.



---

archive/issue_comments_205223.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-11T11:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205223",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_043077.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-11T11:02:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13352#event-43077"
}
```



---

archive/issue_comments_205224.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.13.rc0\"",
    "created_at": "2013-12-11T11:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205224",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.13.rc0"



---

archive/issue_comments_205225.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,6 +20,7 @@\n 100000 loops, best of 3: 2.52 us per loop\n ```\n \n+This patch also reorganizes the bitset files, including deleting the `sage/misc/bitset_pxd.pxi` file.\n \n APPLY:\n \n``````\n",
    "created_at": "2014-01-20T14:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205225",
    "user": "https://github.com/jasongrout"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,6 +20,7 @@
 100000 loops, best of 3: 2.52 us per loop
 ```
 
+This patch also reorganizes the bitset files, including deleting the `sage/misc/bitset_pxd.pxi` file.
 
 APPLY:
 
``````




---

archive/issue_comments_205226.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This patch improves the running time of the `bitset_len` method by using `__builtin_popcount()`.\n+This patch improves the running time of the `bitset_len` method by using `mpn_popcount()`.\n \n Before:\n \n``````\n",
    "created_at": "2014-01-20T14:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205226",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This patch improves the running time of the `bitset_len` method by using `__builtin_popcount()`.
+This patch improves the running time of the `bitset_len` method by using `mpn_popcount()`.
 
 Before:
 
``````




---

archive/issue_comments_205227.json:
```json
{
    "body": "<a id='comment:50'></a>\nI changed the description since we use `mpn_popcount` and not `___builtin_popcount`",
    "created_at": "2014-01-20T14:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205227",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:50'></a>
I changed the description since we use `mpn_popcount` and not `___builtin_popcount`



---

archive/issue_comments_205228.json:
```json
{
    "body": "<a id='comment:51'></a>\nFollow-up: #16937",
    "created_at": "2014-09-05T13:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13352#issuecomment-205228",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
Follow-up: #16937
