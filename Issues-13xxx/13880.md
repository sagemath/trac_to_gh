# Issue 13880: Respect ulimit -v for GAP memory pool size

archive/issues_013676.json:
```json
{
    "assignees": [
        "https://github.com/jasongrout"
    ],
    "body": "Limit the GAP pool size to 1/10 of the ulimit -v, if the user has set one. Also, allow zero-sized swap in a doctest.\n\nApply [attachment: trac_13880_gap_pool_RLIMIT_AS.patch](https://github.com/sagemath/sage/files/ticket13880/trac_13880_gap_pool_RLIMIT_AS.patch.gz)\n\nComponent: **misc**\n\nAuthor: **Volker Braun**\n\nReviewer: **Dmitrii Pasechnik**\n\nMerged: **sage-5.6.beta3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13880_\n\n",
    "closed_at": "2013-01-07T20:57:46Z",
    "created_at": "2012-12-29T19:18:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Respect ulimit -v for GAP memory pool size",
    "type": "issue",
    "updated_at": "2013-01-07T20:57:46Z",
    "url": "https://github.com/sagemath/sage/issues/13880",
    "user": "https://github.com/vbraun"
}
```
Limit the GAP pool size to 1/10 of the ulimit -v, if the user has set one. Also, allow zero-sized swap in a doctest.

Apply [attachment: trac_13880_gap_pool_RLIMIT_AS.patch](https://github.com/sagemath/sage/files/ticket13880/trac_13880_gap_pool_RLIMIT_AS.patch.gz)

Component: **misc**

Author: **Volker Braun**

Reviewer: **Dmitrii Pasechnik**

Merged: **sage-5.6.beta3**

_Issue created by migration from https://trac.sagemath.org/ticket/13880_





---

archive/issue_events_192978.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-29T19:18:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192978"
}
```



---

archive/issue_events_192979.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-29T19:18:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192979"
}
```



---

archive/issue_events_192980.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-29T19:18:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192980"
}
```



---

archive/issue_events_192981.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2012-12-29T19:18:53Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192981"
}
```



---

archive/issue_comments_163903.json:
```json
{
    "body": "Attachment: **[trac_13880_swap_doctest_fix.patch.gz](https://github.com/sagemath/sage/files/ticket13880/trac_13880_swap_doctest_fix.patch.gz)**\n\nUpdated patch",
    "created_at": "2012-12-29T19:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163903",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_13880_swap_doctest_fix.patch.gz](https://github.com/sagemath/sage/files/ticket13880/trac_13880_swap_doctest_fix.patch.gz)**

Updated patch



---

archive/issue_events_192982.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-29T19:23:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192982"
}
```



---

archive/issue_comments_163904.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2012-12-29T19:23:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163904",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_events_192983.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-29T20:44:35Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "title_is": "Respect ulimit -v for GAP memory pool size",
    "title_was": "Fix doctest for amout of swap",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192983"
}
```



---

archive/issue_comments_163905.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-Allow zero-sized swap in a doctest.\n+Limit the GAP pool size to 1/10 of the ulimit -v, if the user has set one. Also, allow zero-sized swap in a doctest.\n+\n+Apply [attachment: trac_13880_gap_pool_RLIMIT_AS.patch](https://github.com/sagemath/sage/files/ticket13880/trac_13880_gap_pool_RLIMIT_AS.patch.gz)\n``````\n",
    "created_at": "2012-12-29T20:44:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163905",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-Allow zero-sized swap in a doctest.
+Limit the GAP pool size to 1/10 of the ulimit -v, if the user has set one. Also, allow zero-sized swap in a doctest.
+
+Apply [attachment: trac_13880_gap_pool_RLIMIT_AS.patch](https://github.com/sagemath/sage/files/ticket13880/trac_13880_gap_pool_RLIMIT_AS.patch.gz)
``````




---

archive/issue_comments_163906.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nWhy `available_swap() in ZZ`?\n\n\n\n\nI'm not sure whether the fallback value of `virtual_memory_limit()` (`self.available_swap() + self.available_ram()`) is appropriate.\n\nIt doesn't take into account the memory already used by the process, and the available (or total) swap can be much larger than what's available to *a single process* (e.g. 16 GB swap space on a 32-bit processor or OS); similar for the RAM \"available\".",
    "created_at": "2012-12-29T21:45:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163906",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:3" align="right">comment:3</div>

Why `available_swap() in ZZ`?




I'm not sure whether the fallback value of `virtual_memory_limit()` (`self.available_swap() + self.available_ram()`) is appropriate.

It doesn't take into account the memory already used by the process, and the available (or total) swap can be much larger than what's available to *a single process* (e.g. 16 GB swap space on a 32-bit processor or OS); similar for the RAM "available".



---

archive/issue_comments_163907.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nexttime](#comment%3A3):\n> Why `available_swap() in ZZ`?\n\nTo test that it returns an integer as promised in the docstring.\n\nI've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.",
    "created_at": "2012-12-29T22:20:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163907",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nexttime](#comment%3A3):
> Why `available_swap() in ZZ`?

To test that it returns an integer as promised in the docstring.

I've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.



---

archive/issue_comments_163908.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@vbraun](#comment%3A4):\n> Replying to [@nexttime](#comment%3A3):\n> > Why `available_swap() in ZZ`?\n\n> \n> To test that it returns an integer as promised in the docstring.\n\nNot that obvious, to me at least... ;-)\n\nStill wonder whether we shouldn't also test that the result is actually non-negative.\n\n\n\n\n> I've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.\n\nOk.  (The more common case -- which I meant -- is having >> 2 GB *swap space*, which is handled now as well.)\n\n\n\n\nSlightly related (`memory_info.py` probably deserved its own ticket):\n\n`available_ram()` should probably have an optional boolean parameter to not just return the amount of *free* memory (\"`MemFree`\"), as this can often be pretty close to zero, due to buffering and especially caching.  (I.e., the amount of \"available\" RAM, allocatable by a process without running out of [physical] memory, might in fact be much larger, regardless of whether swap space is available or not.)  \n\nAs is, although its docstring contains \"free\" in parentheses, the term \"available RAM\" is IMHO potentially misleading.\n\nW.r.t. GAP, I think it may currently \"run out of memory\" simply because [there's no or not enough swap space *and*] most (or at least much) of the physical memory is eaten up by just caches.",
    "created_at": "2012-12-30T01:46:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163908",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@vbraun](#comment%3A4):
> Replying to [@nexttime](#comment%3A3):
> > Why `available_swap() in ZZ`?

> 
> To test that it returns an integer as promised in the docstring.

Not that obvious, to me at least... ;-)

Still wonder whether we shouldn't also test that the result is actually non-negative.




> I've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.

Ok.  (The more common case -- which I meant -- is having >> 2 GB *swap space*, which is handled now as well.)




Slightly related (`memory_info.py` probably deserved its own ticket):

`available_ram()` should probably have an optional boolean parameter to not just return the amount of *free* memory ("`MemFree`"), as this can often be pretty close to zero, due to buffering and especially caching.  (I.e., the amount of "available" RAM, allocatable by a process without running out of [physical] memory, might in fact be much larger, regardless of whether swap space is available or not.)  

As is, although its docstring contains "free" in parentheses, the term "available RAM" is IMHO potentially misleading.

W.r.t. GAP, I think it may currently "run out of memory" simply because [there's no or not enough swap space *and*] most (or at least much) of the physical memory is eaten up by just caches.



---

archive/issue_comments_163909.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI disagree with\n\n```\nsuggested_size = min(suggested_size, int(mem.virtual_memory_limit()/10))\n```\nThis `virtual_memory_limit` is *per-process*, so the suggested size should be roughly equal to `virtual_memory_limit`, not much less. Maybe something like\n\n```\n# Respect ulimit -v, use slightly less than maximum allowed amount of memory\nsuggested_size = min(suggested_size, int(mem.virtual_memory_limit()*7/8))\n```",
    "created_at": "2012-12-30T08:51:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163909",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

I disagree with

```
suggested_size = min(suggested_size, int(mem.virtual_memory_limit()/10))
```
This `virtual_memory_limit` is *per-process*, so the suggested size should be roughly equal to `virtual_memory_limit`, not much less. Maybe something like

```
# Respect ulimit -v, use slightly less than maximum allowed amount of memory
suggested_size = min(suggested_size, int(mem.virtual_memory_limit()*7/8))
```



---

archive/issue_events_192984.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-30T09:03:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192984"
}
```



---

archive/issue_events_192985.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-30T09:03:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192985"
}
```



---

archive/issue_comments_163910.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.\n\nFor libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.\n\nAlso, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.",
    "created_at": "2012-12-30T10:21:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163910",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">comment:8</div>

I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.

For libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.

Also, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.



---

archive/issue_comments_163911.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@vbraun](#comment%3A8):\n> I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.\n\nBut I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the \"halving pool size\" messages).\n\n> For libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.\n\nNo, because this ticket doesn't refer to libGAP.\n\n> Also, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.\n\nI don't think the user intends GAP to take 1/10th of the memory either. If I would set the memory limit to 2GB and GAP doesn't want to allocate 300MB, I would be quite surprised.\n\nI do agree this is all bikeshedding, that's why I intentionally don't set this to needs_work.",
    "created_at": "2012-12-30T10:58:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163911",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@vbraun](#comment%3A8):
> I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.

But I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the "halving pool size" messages).

> For libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.

No, because this ticket doesn't refer to libGAP.

> Also, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.

I don't think the user intends GAP to take 1/10th of the memory either. If I would set the memory limit to 2GB and GAP doesn't want to allocate 300MB, I would be quite surprised.

I do agree this is all bikeshedding, that's why I intentionally don't set this to needs_work.



---

archive/issue_comments_163912.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment%3A9):\n> But I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the \"halving pool size\" messages).\n\nNot if you use libgap. It also adjusts to the point where you don't have any virtual memory left for Sage and then other stuff runs of of memory.",
    "created_at": "2012-12-30T11:15:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163912",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment%3A9):
> But I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the "halving pool size" messages).

Not if you use libgap. It also adjusts to the point where you don't have any virtual memory left for Sage and then other stuff runs of of memory.



---

archive/issue_comments_163913.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe libGAP discussion IMHO belongs to another ticket (and is IMHO pretty irrelevant at this point).  Dima mentioned the GAP developers seem to be working on a new memory manager, probably also because the current one is unsuitable for a library, at least when used together with other libraries or memory managers.\n\n\n\n\nWould it make sense to use a different pool size for doctesting (i.e., a close[r]-to-minimal one)?\n\n\n\n\nI still believe the current implementation will prevent GAP from working if the RAM is filled up with buffers and caches (and there's no or \"not enough\" swap space), which to me doesn't seem to be too untypical.  Haven't tried yet though.",
    "created_at": "2012-12-30T18:56:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163913",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:11" align="right">comment:11</div>

The libGAP discussion IMHO belongs to another ticket (and is IMHO pretty irrelevant at this point).  Dima mentioned the GAP developers seem to be working on a new memory manager, probably also because the current one is unsuitable for a library, at least when used together with other libraries or memory managers.




Would it make sense to use a different pool size for doctesting (i.e., a close[r]-to-minimal one)?




I still believe the current implementation will prevent GAP from working if the RAM is filled up with buffers and caches (and there's no or "not enough" swap space), which to me doesn't seem to be too untypical.  Haven't tried yet though.



---

archive/issue_comments_163914.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThe libGAP discussion is relevant because they share the function to determine the pool size.\n\nIf you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.",
    "created_at": "2012-12-30T20:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163914",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">comment:12</div>

The libGAP discussion is relevant because they share the function to determine the pool size.

If you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.



---

archive/issue_comments_163915.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@vbraun](#comment%3A12):\n> The libGAP discussion is relevant because they share the function to determine the pool size.\n\nPerhaps the `suggested_size` routine needs a flag `for_libgap=true/false` then, to compute appropriate defaults for either situation. Obviously, the two cases ask for separate considerations in the face of per-process limits.\n\nIsn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.",
    "created_at": "2012-12-30T20:45:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163915",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@vbraun](#comment%3A12):
> The libGAP discussion is relevant because they share the function to determine the pool size.

Perhaps the `suggested_size` routine needs a flag `for_libgap=true/false` then, to compute appropriate defaults for either situation. Obviously, the two cases ask for separate considerations in the face of per-process limits.

Isn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.



---

archive/issue_comments_163916.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@nbruin](#comment%3A13):\n> Isn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.\n\nThat's what I meant with (currently) \"irrelevant\".  (Besides that libGAP may come with a new / alternate memory manager when Sage is \"ready\" for it.)",
    "created_at": "2012-12-30T21:08:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163916",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@nbruin](#comment%3A13):
> Isn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.

That's what I meant with (currently) "irrelevant".  (Besides that libGAP may come with a new / alternate memory manager when Sage is "ready" for it.)



---

archive/issue_comments_163917.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@vbraun](#comment%3A12):\n> If you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.\n\nOk.  That's probably enough for \"ordinary\" Sage sessions as well.\n\nNot sure right now how it behaves when users happen to need a larger pool size.  (They should get an appropriate error message, and the pool size should be easily customizable.  AFAIK, the latter currently requires modifying `$DOT_SAGE/init.sage`.)",
    "created_at": "2012-12-30T21:22:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163917",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@vbraun](#comment%3A12):
> If you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.

Ok.  That's probably enough for "ordinary" Sage sessions as well.

Not sure right now how it behaves when users happen to need a larger pool size.  (They should get an appropriate error message, and the pool size should be easily customizable.  AFAIK, the latter currently requires modifying `$DOT_SAGE/init.sage`.)



---

archive/issue_comments_163918.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nYou can always use `sage.interfaces.gap.set_gap_memory_pool_size()` before starting any gap computation if you want to set it manually. This is not changed in this ticket.",
    "created_at": "2012-12-30T21:58:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163918",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

You can always use `sage.interfaces.gap.set_gap_memory_pool_size()` before starting any gap computation if you want to set it manually. This is not changed in this ticket.



---

archive/issue_comments_163919.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@nexttime](#comment%3A14):\n> Besides that libGAP may come with a new / alternate memory manager when Sage is \"ready\" for it.\n\nLibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. But ready it is.",
    "created_at": "2012-12-30T22:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163919",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@nexttime](#comment%3A14):
> Besides that libGAP may come with a new / alternate memory manager when Sage is "ready" for it.

LibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. But ready it is.



---

archive/issue_comments_163920.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@vbraun](#comment%3A17):\n> Replying to [@nexttime](#comment%3A14):\n> > Besides that libGAP may come with a new / alternate memory manager when Sage is \"ready\" for it.\n\n> \n> LibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. \n\nI'm working on this from a crevasse in a local Singaporean glacier. It helps against hardware overheating...",
    "created_at": "2013-01-02T13:32:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163920",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@vbraun](#comment%3A17):
> Replying to [@nexttime](#comment%3A14):
> > Besides that libGAP may come with a new / alternate memory manager when Sage is "ready" for it.

> 
> LibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. 

I'm working on this from a crevasse in a local Singaporean glacier. It helps against hardware overheating...



---

archive/issue_comments_163921.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI am testing this on a system where mem.available_swap() comes up negative:\n\n```\nsage: t = mem._parse_proc_meminfo(); t\n{'available_ram': 1435963392, 'total_swap': 10909376512, 'available_swap': 8558673920, 'Committed_AS': 16000847872, 'total_ram': 7929249792}\nsage: mem.available_swap()\n-5091471360\n```\nwhich is not surprising, as mem.available_swap() computes ` t['total_swap']-t['Committed_AS']`, rather than returning `t['available_swap']`. \n\nWhat is going on? A bug or a feature?\n\nThat's how far I get digging up the cause of\n\n```\nsage -t -long \"devel/sage-main/sage/misc/memory_info.py\"    \n**********************************************************************\nFile \"/usr/local/src/sage/sage-5.5/devel/sage-main/sage/misc/memory_info.py\", line 122:\n    sage: mem.virtual_memory_limit() > 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 items had failures:\n```",
    "created_at": "2013-01-03T03:12:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163921",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:19" align="right">comment:19</div>

I am testing this on a system where mem.available_swap() comes up negative:

```
sage: t = mem._parse_proc_meminfo(); t
{'available_ram': 1435963392, 'total_swap': 10909376512, 'available_swap': 8558673920, 'Committed_AS': 16000847872, 'total_ram': 7929249792}
sage: mem.available_swap()
-5091471360
```
which is not surprising, as mem.available_swap() computes ` t['total_swap']-t['Committed_AS']`, rather than returning `t['available_swap']`. 

What is going on? A bug or a feature?

That's how far I get digging up the cause of

```
sage -t -long "devel/sage-main/sage/misc/memory_info.py"    
**********************************************************************
File "/usr/local/src/sage/sage-5.5/devel/sage-main/sage/misc/memory_info.py", line 122:
    sage: mem.virtual_memory_limit() > 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
```



---

archive/issue_comments_163922.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nHow about the following patch:\n\n```\ndiff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py\n--- a/sage/misc/memory_info.py\n+++ b/sage/misc/memory_info.py\n@@ -263,7 +263,10 @@\n         \"\"\"\n         info = self._parse_proc_meminfo()\n         try:\n-            return info['total_swap'] - info['Committed_AS']\n+            dif = info['total_swap'] - info['Committed_AS']\n+            if dif > 0:\n+               return dif\n+            return info['available_swap']\n         except KeyError:\n             return info['available_swap']\n```\nat least this fixes the doctests on the system in question",
    "created_at": "2013-01-04T04:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163922",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:20" align="right">comment:20</div>

How about the following patch:

```
diff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py
--- a/sage/misc/memory_info.py
+++ b/sage/misc/memory_info.py
@@ -263,7 +263,10 @@
         """
         info = self._parse_proc_meminfo()
         try:
-            return info['total_swap'] - info['Committed_AS']
+            dif = info['total_swap'] - info['Committed_AS']
+            if dif > 0:
+               return dif
+            return info['available_swap']
         except KeyError:
             return info['available_swap']
```
at least this fixes the doctests on the system in question



---

archive/issue_comments_163923.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@dimpase](#comment%3A20):\n> How about the following patch:\n> \n> ```\n> diff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py\n> --- a/sage/misc/memory_info.py\n> +++ b/sage/misc/memory_info.py\n> @@ -263,7 +263,10 @@\n>          \"\"\"\n>          info = self._parse_proc_meminfo()\n>          try:\n> -            return info['total_swap'] - info['Committed_AS']\n> +            dif = info['total_swap'] - info['Committed_AS']\n> +            if dif > 0:\n> +               return dif\n> +            return info['available_swap']\n>          except KeyError:\n>              return info['available_swap']\n> ```\n> at least this fixes the doctests on the system in question\n\nI actually have no clear idea why 'Committed_AS' gets into the picture here. E.g. I read\n\n[Committed_AS: An estimate of how much RAM you would need to make a 99.99% guarantee that there never is OOM (out of memory) for this workload. Normally the kernel will overcommit memory. That means, say you do a 1GB malloc, nothing happens, really. Only when you start USING that malloc memory you will get real memory on demand, and just as much as you use. So you sort of take a mortgage and hope the bank doesn't go bust. Other cases might include when you mmap a file that's shared only when you write to it and you get a private copy of that data. While it normally is shared between processes. The Committed_AS is a guesstimate of how much RAM/swap you would need worst-case.](http://www.redhat.com/advice/tips/meminfo.html)\n\nSo this is a worst-case estimate, and `info['total_swap'] < info['Committed_AS']` means, from the OS point of view, that you're living on the edge. Well, maybe. And the measurement is taken while `make -j4 ptestlong` on this 4-processor machine.",
    "created_at": "2013-01-04T05:47:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163923",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@dimpase](#comment%3A20):
> How about the following patch:
> 
> ```
> diff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py
> --- a/sage/misc/memory_info.py
> +++ b/sage/misc/memory_info.py
> @@ -263,7 +263,10 @@
>          """
>          info = self._parse_proc_meminfo()
>          try:
> -            return info['total_swap'] - info['Committed_AS']
> +            dif = info['total_swap'] - info['Committed_AS']
> +            if dif > 0:
> +               return dif
> +            return info['available_swap']
>          except KeyError:
>              return info['available_swap']
> ```
> at least this fixes the doctests on the system in question

I actually have no clear idea why 'Committed_AS' gets into the picture here. E.g. I read

[Committed_AS: An estimate of how much RAM you would need to make a 99.99% guarantee that there never is OOM (out of memory) for this workload. Normally the kernel will overcommit memory. That means, say you do a 1GB malloc, nothing happens, really. Only when you start USING that malloc memory you will get real memory on demand, and just as much as you use. So you sort of take a mortgage and hope the bank doesn't go bust. Other cases might include when you mmap a file that's shared only when you write to it and you get a private copy of that data. While it normally is shared between processes. The Committed_AS is a guesstimate of how much RAM/swap you would need worst-case.](http://www.redhat.com/advice/tips/meminfo.html)

So this is a worst-case estimate, and `info['total_swap'] < info['Committed_AS']` means, from the OS point of view, that you're living on the edge. Well, maybe. And the measurement is taken while `make -j4 ptestlong` on this 4-processor machine.



---

archive/issue_events_192986.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-04T09:40:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192986"
}
```



---

archive/issue_events_192987.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-04T09:40:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192987"
}
```



---

archive/issue_comments_163924.json:
```json
{
    "body": "Work Issues: **mem.available_swap() can be negative**",
    "created_at": "2013-01-04T09:40:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163924",
    "user": "https://github.com/jdemeyer"
}
```

Work Issues: **mem.available_swap() can be negative**



---

archive/issue_comments_163925.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\ndimpase: the new test simply checks\n\n```\nMemoryInfo().available_swap() in ZZ\n```\nso perhaps this is a feature, not a bug? I don't mind that `available_swap()` can be negative.",
    "created_at": "2013-01-04T09:43:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163925",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

dimpase: the new test simply checks

```
MemoryInfo().available_swap() in ZZ
```
so perhaps this is a feature, not a bug? I don't mind that `available_swap()` can be negative.



---

archive/issue_comments_163926.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThe problem is that I don't know an easy way to report \"available swap\". It could all be reserved by some other gap session for all we know. So `Total-Committed_AS` is a good approximation. Yes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.",
    "created_at": "2013-01-04T11:05:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163926",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:24" align="right">comment:24</div>

The problem is that I don't know an easy way to report "available swap". It could all be reserved by some other gap session for all we know. So `Total-Committed_AS` is a good approximation. Yes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.



---

archive/issue_events_192988.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-04T11:07:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192988"
}
```



---

archive/issue_events_192989.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-04T11:07:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192989"
}
```



---

archive/issue_comments_163927.json:
```json
{
    "body": "Changed work issues from **mem.available_swap() can be negative** to none",
    "created_at": "2013-01-04T11:07:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163927",
    "user": "https://github.com/vbraun"
}
```

Changed work issues from **mem.available_swap() can be negative** to none



---

archive/issue_comments_163928.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@vbraun](#comment%3A24):\n> The problem is that I don't know an easy way to report \"available swap\".\n\nhow about `self._parse_proc_meminfo()['available_swap']` ?\n\nAs it is now, this value can be different from `MemoryInfo().available_swap()`, and this is rather confusing.\n\n\n> It could all be reserved by some other gap session for all we know. \n\nbut we also know that this might be a huge overestimate.\n\n> So `Total-Committed_AS` is a good approximation. \n\nat least it should be named differently, not `MemoryInfo().available_swap()`, to avoid the clash with `self._parse_proc_meminfo()['available_swap']`\n\nYes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.",
    "created_at": "2013-01-04T11:31:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163928",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@vbraun](#comment%3A24):
> The problem is that I don't know an easy way to report "available swap".

how about `self._parse_proc_meminfo()['available_swap']` ?

As it is now, this value can be different from `MemoryInfo().available_swap()`, and this is rather confusing.


> It could all be reserved by some other gap session for all we know. 

but we also know that this might be a huge overestimate.

> So `Total-Committed_AS` is a good approximation. 

at least it should be named differently, not `MemoryInfo().available_swap()`, to avoid the clash with `self._parse_proc_meminfo()['available_swap']`

Yes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.



---

archive/issue_comments_163929.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\n`/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.\n\n\nI've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.",
    "created_at": "2013-01-04T11:54:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163929",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:27" align="right">comment:27</div>

`/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.


I've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.



---

archive/issue_comments_163930.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@vbraun](#comment%3A27):\n> `/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.\n> \n> \n> I've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.\n\nThis is not enough.\nI still get \n\n```\nFile \"/usr/local/src/sage/sage-5.6.beta2/devel/sage-main/sage/misc/memory_info.py\", line 122:\n    sage: mem.virtual_memory_limit() > 0\nExpected:\n    True\nGot:\n    False\n```\n\nvirtual_memory_limit() as implemented is too conservative, I think. Indeed:\n\n```\nsage: from sage.misc.memory_info import MemoryInfo\nsage: mem = MemoryInfo()\nsage: mem.av\nmem.available_ram   mem.available_swap  \nsage: mem.available_swap()\n-5123952640\nsage: mem.available_ram() \n1262751744\nsage: mem.virtual_memory_limit()\n-3861200896\n```\n\nunless you will allow virtual_memory_limit() be negative, too, but this is IMHO even weirder...\nShouldn't an implementation respect the overcommitting settings somehow?",
    "created_at": "2013-01-04T15:49:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163930",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@vbraun](#comment%3A27):
> `/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.
> 
> 
> I've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.

This is not enough.
I still get 

```
File "/usr/local/src/sage/sage-5.6.beta2/devel/sage-main/sage/misc/memory_info.py", line 122:
    sage: mem.virtual_memory_limit() > 0
Expected:
    True
Got:
    False
```

virtual_memory_limit() as implemented is too conservative, I think. Indeed:

```
sage: from sage.misc.memory_info import MemoryInfo
sage: mem = MemoryInfo()
sage: mem.av
mem.available_ram   mem.available_swap  
sage: mem.available_swap()
-5123952640
sage: mem.available_ram() 
1262751744
sage: mem.virtual_memory_limit()
-3861200896
```

unless you will allow virtual_memory_limit() be negative, too, but this is IMHO even weirder...
Shouldn't an implementation respect the overcommitting settings somehow?



---

archive/issue_comments_163931.json:
```json
{
    "body": "Attachment: **[trac_13880_gap_pool_RLIMIT_AS.patch.gz](https://github.com/sagemath/sage/files/ticket13880/trac_13880_gap_pool_RLIMIT_AS.patch.gz)**\n\nUpdated patch",
    "created_at": "2013-01-04T16:00:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163931",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_13880_gap_pool_RLIMIT_AS.patch.gz](https://github.com/sagemath/sage/files/ticket13880/trac_13880_gap_pool_RLIMIT_AS.patch.gz)**

Updated patch



---

archive/issue_comments_163932.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).",
    "created_at": "2013-01-04T16:01:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163932",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:29" align="right">comment:29</div>

I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).



---

archive/issue_comments_163933.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@vbraun](#comment%3A29):\n> I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).\n\nWhy don't you use 'free_swap' instead of 'available_swap' ?\nThis reflects the reality and the system settings (for overcommitting) far better.\n\nWith 'total swap'+'total ram' one would potentially end up with too much swap reserved for GAP.",
    "created_at": "2013-01-04T16:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163933",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@vbraun](#comment%3A29):
> I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).

Why don't you use 'free_swap' instead of 'available_swap' ?
This reflects the reality and the system settings (for overcommitting) far better.

With 'total swap'+'total ram' one would potentially end up with too much swap reserved for GAP.



---

archive/issue_comments_163934.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nNo, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE).",
    "created_at": "2013-01-04T16:18:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163934",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:31" align="right">comment:31</div>

No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE).



---

archive/issue_comments_163935.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@vbraun](#comment%3A31):\n> No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE). \n\nThe docstring for virtual memory limit  says:\n\n```\n    This is the value set by ``ulimit -v`` at the command line or\n    a practical limit if no limit is set.\n```\nThis does not describe the current implementation. (And it wasn't really true before, either).",
    "created_at": "2013-01-04T16:49:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163935",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@vbraun](#comment%3A31):
> No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE). 

The docstring for virtual memory limit  says:

```
    This is the value set by ``ulimit -v`` at the command line or
    a practical limit if no limit is set.
```
This does not describe the current implementation. (And it wasn't really true before, either).



---

archive/issue_comments_163936.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nWhy not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.",
    "created_at": "2013-01-04T17:00:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163936",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:33" align="right">comment:33</div>

Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.



---

archive/issue_comments_163937.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@vbraun](#comment%3A33):\n> Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.\n\nbecause you neither return **the** value X set by ``ulimit -v`` (you return X+Y, for some nonzero Y), nor anything practical (no single process can reach this limit, ever) to speak about.",
    "created_at": "2013-01-04T17:13:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163937",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@vbraun](#comment%3A33):
> Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.

because you neither return **the** value X set by ``ulimit -v`` (you return X+Y, for some nonzero Y), nor anything practical (no single process can reach this limit, ever) to speak about.



---

archive/issue_comments_163938.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nAre you sure? I do return RLIMIT_AS if set:\n\n```\n[vbraun@volker-desktop ~]$ ulimit -v 12341234\n[vbraun@volker-desktop ~]$ sage \n...\nsage: from sage.misc.memory_info import MemoryInfo  \nsage: MemoryInfo().virtual_memory_limit()\n12637423616\nsage: _/1024\n12341234\n```\nAnd you probably can request total ram+swap thanks to overcommit if not much else is going on or the overcommit ratio is stupidly high.",
    "created_at": "2013-01-04T17:20:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163938",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:35" align="right">comment:35</div>

Are you sure? I do return RLIMIT_AS if set:

```
[vbraun@volker-desktop ~]$ ulimit -v 12341234
[vbraun@volker-desktop ~]$ sage 
...
sage: from sage.misc.memory_info import MemoryInfo  
sage: MemoryInfo().virtual_memory_limit()
12637423616
sage: _/1024
12341234
```
And you probably can request total ram+swap thanks to overcommit if not much else is going on or the overcommit ratio is stupidly high.



---

archive/issue_events_192990.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2013-01-05T02:01:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192990"
}
```



---

archive/issue_events_192991.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2013-01-05T02:01:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192991"
}
```



---

archive/issue_comments_163939.json:
```json
{
    "body": "Reviewer: **Dmitrii Pasechnik**",
    "created_at": "2013-01-07T09:46:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163939",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Dmitrii Pasechnik**



---

archive/issue_comments_163940.json:
```json
{
    "body": "Merged: **sage-5.6.beta3**",
    "created_at": "2013-01-07T20:57:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13880#issuecomment-163940",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.6.beta3**



---

archive/issue_events_192992.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-07T20:57:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192992"
}
```



---

archive/issue_events_192993.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-07T20:57:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13880",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13880#event-192993"
}
```
