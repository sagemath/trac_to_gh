# Issue 13157: inline_fortran is STILL broken on OS X

archive/issues_012985.json:
```json
{
    "body": "Despite #7465 being closed as \"worksforme\", the following snippet in the notebook in Sage-5.2 on Mac OS X 10.7.4 fails.\n\n```\n%fortran\nC FILE: FIB1.F\n      SUBROUTINE FIB(A,N)\nC\nC     CALCULATE FIRST N FIBONACCI NUMBERS\nC\n      INTEGER N\n      REAL*8 A(N)\n      DO I=1,N\n         IF (I.EQ.1) THEN\n            A(I) = 0.0D0\n         ELSEIF (I.EQ.2) THEN\n            A(I) = 1.0D0\n         ELSE \n            A(I) = A(I-1) + A(I-2)\n         ENDIF\n      ENDDO\n      END\nC END FILE FIB1.F\n```\n\nHere is the error in full: http://pastebin.com/iVBkjckp\n\n**Apply**:\n1. [attachment:13157_inline_fortran.patch] to the Sage library.\n2. [attachment:13157_scripts.patch] to `$SAGE_ROOT/local/bin`.\n\n**Assignee:** @williamstein\n\n**CC:**  @kcrisman mvngu flawrence\n\n**Keywords:** fortran osx\n\n**Reviewer:** Karl-Dieter Crisman, Benjamin Jones\n\n**Author:** Jeroen Demeyer\n\n**Merged:** sage-5.4.beta0\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13157\n\n",
    "closed_at": "2012-09-04T11:56:44Z",
    "created_at": "2012-06-23T17:51:08Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4",
    "title": "inline_fortran is STILL broken on OS X",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13157",
    "user": "https://github.com/benjaminfjones"
}
```
Despite #7465 being closed as "worksforme", the following snippet in the notebook in Sage-5.2 on Mac OS X 10.7.4 fails.

```
%fortran
C FILE: FIB1.F
      SUBROUTINE FIB(A,N)
C
C     CALCULATE FIRST N FIBONACCI NUMBERS
C
      INTEGER N
      REAL*8 A(N)
      DO I=1,N
         IF (I.EQ.1) THEN
            A(I) = 0.0D0
         ELSEIF (I.EQ.2) THEN
            A(I) = 1.0D0
         ELSE 
            A(I) = A(I-1) + A(I-2)
         ENDIF
      ENDDO
      END
C END FILE FIB1.F
```

Here is the error in full: http://pastebin.com/iVBkjckp

**Apply**:
1. [attachment:13157_inline_fortran.patch] to the Sage library.
2. [attachment:13157_scripts.patch] to `$SAGE_ROOT/local/bin`.

**Assignee:** @williamstein

**CC:**  @kcrisman mvngu flawrence

**Keywords:** fortran osx

**Reviewer:** Karl-Dieter Crisman, Benjamin Jones

**Author:** Jeroen Demeyer

**Merged:** sage-5.4.beta0

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/13157





---

archive/issue_comments_200178.json:
```json
{
    "body": "<a id='comment:1'></a>\nUmm, there is something really odd here.  The flags passed seem to indicate something went quite wrong.  For instance, one bit is\n\n```\n/var/folders/f4/881mfg491yxdf3zx37ynf5580000gn/T/tmpSLdvBd/Users/bael/.sage/temp/Baels_MacBook_Air.local/2689/tmp_0.o -LUsing built-in specs. COLLECT_GCC=gfortran COLLECT_LTO_WRAPPER=/Users/bael/sage/sage-5.0.1/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper /Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3 -l gfortran -o ./fortran_module_0.so -l gfortran -shared-libgcc\n```\nWhat the heck?\n\n```\n-LUsing built-in specs. COLLECT_GCC=gfortran \n```\nNo wonder the errors look like\n\n```\ngfortran: error: built-in: No such file or directory\ngfortran: error: specs.: No such file or directory\ngfortran: error: COLLECT_GCC=gfortran: No such file or directory\n```\nI don't know how that verbiage got passed there, though.\n\nAnyway, since\n\n```\n/Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3\" -lgfortran -o ./fortran_module_0.so\" failed with exit status 1\n```\nthat means it's no surprise that at the end\n\n```\n    os.unlink(name + '.so')\nOSError: [Errno 2] No such file or directory: 'fortran_module_0.so'\n```\nthough that is just a symptom.\n\nDoes ticket:8010:attachment:trac-8010_numpy.patch (sorry, can't get the link right) look like it might solve it for you, just on the off chance?  One would have to make a new spkg, of course.  But the patch was never applied, to my knowledge.",
    "created_at": "2012-06-25T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200178",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:1'></a>
Umm, there is something really odd here.  The flags passed seem to indicate something went quite wrong.  For instance, one bit is

```
/var/folders/f4/881mfg491yxdf3zx37ynf5580000gn/T/tmpSLdvBd/Users/bael/.sage/temp/Baels_MacBook_Air.local/2689/tmp_0.o -LUsing built-in specs. COLLECT_GCC=gfortran COLLECT_LTO_WRAPPER=/Users/bael/sage/sage-5.0.1/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper /Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3 -l gfortran -o ./fortran_module_0.so -l gfortran -shared-libgcc
```
What the heck?

```
-LUsing built-in specs. COLLECT_GCC=gfortran 
```
No wonder the errors look like

```
gfortran: error: built-in: No such file or directory
gfortran: error: specs.: No such file or directory
gfortran: error: COLLECT_GCC=gfortran: No such file or directory
```
I don't know how that verbiage got passed there, though.

Anyway, since

```
/Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3" -lgfortran -o ./fortran_module_0.so" failed with exit status 1
```
that means it's no surprise that at the end

```
    os.unlink(name + '.so')
OSError: [Errno 2] No such file or directory: 'fortran_module_0.so'
```
though that is just a symptom.

Does ticket:8010:attachment:trac-8010_numpy.patch (sorry, can't get the link right) look like it might solve it for you, just on the off chance?  One would have to make a new spkg, of course.  But the patch was never applied, to my knowledge.



---

archive/issue_comments_200179.json:
```json
{
    "body": "<a id='comment:2'></a>\nWait, there is no `sage_fortran` any more, so that doesn't make sense to apply anyway.  And the [current numpy code](https://github.com/numpy/numpy/blob/master/numpy/distutils/fcompiler/gnu.py#L73) has\n\n```\n'linker_so'    : [None, \"-g\", \"-Wall\"],\n```\nso the `shared` business can't be the issue, or at least not in exactly the same way.\n\nI can also confirm that this is not just a Lion issue; the same happens on 10.6.",
    "created_at": "2012-06-25T18:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200179",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:2'></a>
Wait, there is no `sage_fortran` any more, so that doesn't make sense to apply anyway.  And the [current numpy code](https://github.com/numpy/numpy/blob/master/numpy/distutils/fcompiler/gnu.py#L73) has

```
'linker_so'    : [None, "-g", "-Wall"],
```
so the `shared` business can't be the issue, or at least not in exactly the same way.

I can also confirm that this is not just a Lion issue; the same happens on 10.6.



---

archive/issue_events_042258.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "rename": {
        "from": "%fortran in the notebook (and fortran.eval on command line) is STILL broken on OS X",
        "to": "inline_fortran is STILL broken on OS X"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13157#event-42258"
}
```



---

archive/issue_comments_200180.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Despite #7465 being closed as \"worksforme\", the following snippet in the notebook in Sage-5.0.1 (official binary) on Mac OS X 10.7.4 fails.\n+Despite #7465 being closed as \"worksforme\", the following snippet in the notebook in Sage-5.2 on Mac OS X 10.7.4 fails.\n \n ```\n %fortran          \t\n``````\n",
    "created_at": "2012-08-20T12:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200180",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Despite #7465 being closed as "worksforme", the following snippet in the notebook in Sage-5.0.1 (official binary) on Mac OS X 10.7.4 fails.
+Despite #7465 being closed as "worksforme", the following snippet in the notebook in Sage-5.2 on Mac OS X 10.7.4 fails.
 
 ```
 %fortran          	
``````




---

archive/issue_comments_200181.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2012-08-22T09:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200181",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_200182.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -24,4 +24,6 @@\n \n Here is the error in full: http://pastebin.com/iVBkjckp\n \n-Looking through the convoluted ticket relationships (#7465, #8010, etc..) it looks like numpy spkg was patched to fix the problem with the `-shared` link flag at some point, and sometime later the numpy was upgraded (perhaps making the patch unnecessary (??)) and now it might be some other issue having to do with the gcc/gfortran spkg. Just a guess.\n+**Apply**:\n+1. [attachment:13157_inline_fortran.patch] to the Sage library.\n+2. [attachment:13157_scripts.patch] to `$SAGE_ROOT/local/bin`.\n``````\n",
    "created_at": "2012-08-22T09:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200182",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -24,4 +24,6 @@
 
 Here is the error in full: http://pastebin.com/iVBkjckp
 
-Looking through the convoluted ticket relationships (#7465, #8010, etc..) it looks like numpy spkg was patched to fix the problem with the `-shared` link flag at some point, and sometime later the numpy was upgraded (perhaps making the patch unnecessary (??)) and now it might be some other issue having to do with the gcc/gfortran spkg. Just a guess.
+**Apply**:
+1. [attachment:13157_inline_fortran.patch] to the Sage library.
+2. [attachment:13157_scripts.patch] to `$SAGE_ROOT/local/bin`.
``````




---

archive/issue_comments_200183.json:
```json
{
    "body": "<a id='comment:4'></a>\nAttachment [13157_scripts.patch](tarball://root/attachments/some-uuid/ticket13157/13157_scripts.patch) by @jdemeyer created at 2012-08-22 09:34:25",
    "created_at": "2012-08-22T09:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200183",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Attachment [13157_scripts.patch](tarball://root/attachments/some-uuid/ticket13157/13157_scripts.patch) by @jdemeyer created at 2012-08-22 09:34:25



---

archive/issue_comments_200184.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2012-08-22T09:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200184",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_200185.json:
```json
{
    "body": "<a id='comment:5'></a>\nAttachment [13157_inline_fortran.patch](tarball://root/attachments/some-uuid/ticket13157/13157_inline_fortran.patch) by @jdemeyer created at 2012-08-22 09:40:41\n\nThe file `inline_fortan.py` still lacks documentation, but I don't feel like fixing that now. Needs testing and review.",
    "created_at": "2012-08-22T09:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200185",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Attachment [13157_inline_fortran.patch](tarball://root/attachments/some-uuid/ticket13157/13157_inline_fortran.patch) by @jdemeyer created at 2012-08-22 09:40:41

The file `inline_fortan.py` still lacks documentation, but I don't feel like fixing that now. Needs testing and review.



---

archive/issue_comments_200186.json:
```json
{
    "body": "<a id='comment:6'></a>\nTested on Linux, OS X and OpenSolaris, works fine.",
    "created_at": "2012-08-23T12:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200186",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Tested on Linux, OS X and OpenSolaris, works fine.



---

archive/issue_comments_200187.json:
```json
{
    "body": "<a id='comment:7'></a>\nAny reviewers?",
    "created_at": "2012-08-31T08:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200187",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Any reviewers?



---

archive/issue_comments_200188.json:
```json
{
    "body": "**Reviewer:** Karl-Dieter Crisman",
    "created_at": "2012-08-31T12:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200188",
    "user": "https://github.com/kcrisman"
}
```

**Reviewer:** Karl-Dieter Crisman



---

archive/issue_comments_200189.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis works fine on OS X now.  The code changes are minimal and make sense - nice error test.  I only tested this on OS X 10.7, not previous systems; I guess someone should test this doesn't break anything on Linux, and take jdemeyer's word for it on OpenSolaris.\n\nAny reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...",
    "created_at": "2012-08-31T12:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200189",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'></a>
This works fine on OS X now.  The code changes are minimal and make sense - nice error test.  I only tested this on OS X 10.7, not previous systems; I guess someone should test this doesn't break anything on Linux, and take jdemeyer's word for it on OpenSolaris.

Any reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...



---

archive/issue_comments_200190.json:
```json
{
    "body": "<a id='comment:9'></a>\nI tested this on many platforms and it works.  Is that sufficient for positive review then?\n\nReplying to [kcrisman](#comment%3A8):\n> Any reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...\n\nThe redirection\n\n```\n1>&2 >foo\n```\nis equivalent to\n\n```\n>foo\n```\nIt's like saying: redirect stdout to stderr.  Oh, never mind, redirect it to `foo` instead.  This doesn't really make sense, so I assume it's a mistake.\n\nWhile\n\n```\n>foo 2>&1\n```\nmeans: redirect stdout to `foo`.  Now redirect stderr to the **new** stdout, which is `foo`.  This therefore redirects both stdout and stderr to `foo`.\n\n*Off topic and just for educational value*: the redirection\n\n```\n2>&1 >foo\n```\nwould mean: redirect stderr to the **current** stdout.  Now redirect stdout (but not stderr) to `foo`.",
    "created_at": "2012-09-03T12:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200190",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
I tested this on many platforms and it works.  Is that sufficient for positive review then?

Replying to [kcrisman](#comment%3A8):
> Any reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...

The redirection

```
1>&2 >foo
```
is equivalent to

```
>foo
```
It's like saying: redirect stdout to stderr.  Oh, never mind, redirect it to `foo` instead.  This doesn't really make sense, so I assume it's a mistake.

While

```
>foo 2>&1
```
means: redirect stdout to `foo`.  Now redirect stderr to the **new** stdout, which is `foo`.  This therefore redirects both stdout and stderr to `foo`.

*Off topic and just for educational value*: the redirection

```
2>&1 >foo
```
would mean: redirect stderr to the **current** stdout.  Now redirect stdout (but not stderr) to `foo`.



---

archive/issue_comments_200191.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-09-04T02:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200191",
    "user": "https://github.com/benjaminfjones"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_200192.json:
```json
{
    "body": "**Changing reviewer** from \"Karl-Dieter Crisman\" to \"Karl-Dieter Crisman, Benjamin Jones\".",
    "created_at": "2012-09-04T02:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200192",
    "user": "https://github.com/benjaminfjones"
}
```

**Changing reviewer** from "Karl-Dieter Crisman" to "Karl-Dieter Crisman, Benjamin Jones".



---

archive/issue_comments_200193.json:
```json
{
    "body": "<a id='comment:10'></a>\nI just tested on OS X 10.7, OS X 10.6, and Debian linux and it looks good to go.",
    "created_at": "2012-09-04T02:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200193",
    "user": "https://github.com/benjaminfjones"
}
```

<a id='comment:10'></a>
I just tested on OS X 10.7, OS X 10.6, and Debian linux and it looks good to go.



---

archive/issue_events_042259.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-09-04T08:30:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "milestone": "sage-5.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13157#event-42259"
}
```



---

archive/issue_comments_200194.json:
```json
{
    "body": "**Merged:** sage-5.4.beta0",
    "created_at": "2012-09-04T11:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200194",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.4.beta0



---

archive/issue_events_042260.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-09-04T11:56:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13157#event-42260"
}
```



---

archive/issue_comments_200195.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2012-09-04T11:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200195",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed



---

archive/issue_comments_200196.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n Despite #7465 being closed as \"worksforme\", the following snippet in the notebook in Sage-5.2 on Mac OS X 10.7.4 fails.\n \n ```\n-%fortran          \t\n+%fortran\n C FILE: FIB1.F\n       SUBROUTINE FIB(A,N)\n C\n``````\n",
    "created_at": "2015-09-06T15:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13157#issuecomment-200196",
    "user": "https://github.com/fchapoton"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 Despite #7465 being closed as "worksforme", the following snippet in the notebook in Sage-5.2 on Mac OS X 10.7.4 fails.
 
 ```
-%fortran          	
+%fortran
 C FILE: FIB1.F
       SUBROUTINE FIB(A,N)
 C
``````

