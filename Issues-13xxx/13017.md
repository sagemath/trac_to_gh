# Issue 13017: fan isomorphism check

archive/issues_013017.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @novoselt\n\nKeywords: toric\n\nThis patch implements testing for isomorphism (equivalence up to `GL(n,ZZ)` rotation) of fans\n\n```\n  sage: m1 = matrix([(1, 0), (0, -5), (-3, 4)])\n  sage: m2 = matrix([(3, 0), (1, 0), (-2, 1)])\n  sage: m1.elementary_divisors() == m2.elementary_divisors() == [1,1,0]\n  True\n  sage: fan1 = Fan([Cone([m1*vector([23, 14]), m1*vector([   3,100])]), \n  ...               Cone([m1*vector([-1,-14]), m1*vector([-100, -5])])])\n  sage: fan2 = Fan([Cone([m2*vector([23, 14]), m2*vector([   3,100])]), \n  ...               Cone([m2*vector([-1,-14]), m2*vector([-100, -5])])])\n  sage: fan1.is_isomorphic(fan2)\n  True\n  sage: fan1.isomorphism(fan2)\n  Fan morphism defined by the matrix\n  [18  1 -5]\n  [ 4  0 -1]\n  [ 5  0 -1]\n  Domain fan: Rational polyhedral fan in 3-d lattice N\n  Codomain fan: Rational polyhedral fan in 3-d lattice N\n```\nThis is implemented by first computing the isomorphisms of auxiliary labelled graphs, and then trying to lift those to actual fan morphisms.\n\nApply:\n* [This is the Trac macro *attachment:trac_13189_Hirzebruch_Jung_continued_fraction.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_Hirzebruch_Jung_continued_fraction.patch-macro)\n* [This is the Trac macro *attachment:trac_13189_virtual_rays.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_virtual_rays.patch-macro)\n* [This is the Trac macro *attachment:trac_13189_fan_isomorphism.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_fan_isomorphism.patch-macro)\n* [This is the Trac macro *attachment:trac_13189_cone_isomorphism.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_cone_isomorphism.patch-macro)\n* [This is the Trac macro *attachment:trac_13189_reviewer.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_reviewer.patch-macro)\n\nIssue created by migration from https://trac.sagemath.org/ticket/13189\n\n",
    "closed_at": "2012-08-14T07:04:10Z",
    "created_at": "2012-06-30T17:33:34Z",
    "labels": [
        "component: algebraic geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.3",
    "title": "fan isomorphism check",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13017",
    "user": "https://github.com/vbraun"
}
```
Assignee: @aghitza

CC:  @novoselt

Keywords: toric

This patch implements testing for isomorphism (equivalence up to `GL(n,ZZ)` rotation) of fans

```
  sage: m1 = matrix([(1, 0), (0, -5), (-3, 4)])
  sage: m2 = matrix([(3, 0), (1, 0), (-2, 1)])
  sage: m1.elementary_divisors() == m2.elementary_divisors() == [1,1,0]
  True
  sage: fan1 = Fan([Cone([m1*vector([23, 14]), m1*vector([   3,100])]), 
  ...               Cone([m1*vector([-1,-14]), m1*vector([-100, -5])])])
  sage: fan2 = Fan([Cone([m2*vector([23, 14]), m2*vector([   3,100])]), 
  ...               Cone([m2*vector([-1,-14]), m2*vector([-100, -5])])])
  sage: fan1.is_isomorphic(fan2)
  True
  sage: fan1.isomorphism(fan2)
  Fan morphism defined by the matrix
  [18  1 -5]
  [ 4  0 -1]
  [ 5  0 -1]
  Domain fan: Rational polyhedral fan in 3-d lattice N
  Codomain fan: Rational polyhedral fan in 3-d lattice N
```
This is implemented by first computing the isomorphisms of auxiliary labelled graphs, and then trying to lift those to actual fan morphisms.

Apply:
* [This is the Trac macro *attachment:trac_13189_Hirzebruch_Jung_continued_fraction.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_Hirzebruch_Jung_continued_fraction.patch-macro)
* [This is the Trac macro *attachment:trac_13189_virtual_rays.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_virtual_rays.patch-macro)
* [This is the Trac macro *attachment:trac_13189_fan_isomorphism.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_fan_isomorphism.patch-macro)
* [This is the Trac macro *attachment:trac_13189_cone_isomorphism.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_cone_isomorphism.patch-macro)
* [This is the Trac macro *attachment:trac_13189_reviewer.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_13189_reviewer.patch-macro)

Issue created by migration from https://trac.sagemath.org/ticket/13189





---

archive/issue_comments_157145.json:
```json
{
    "body": "Attachment [trac_13189_Hirzebruch_Jung_continued_fraction.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_Hirzebruch_Jung_continued_fraction.patch) by @vbraun created at 2012-06-30 18:10:51\n\nUpdated patch",
    "created_at": "2012-06-30T18:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157145",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_13189_Hirzebruch_Jung_continued_fraction.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_Hirzebruch_Jung_continued_fraction.patch) by @vbraun created at 2012-06-30 18:10:51

Updated patch



---

archive/issue_comments_157146.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-06-30T18:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157146",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_157147.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-06-30T18:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157147",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_157148.json:
```json
{
    "body": "Attachment [trac_13189_virtual_rays.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_virtual_rays.patch) by @vbraun created at 2012-06-30 18:12:11",
    "created_at": "2012-06-30T18:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157148",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_13189_virtual_rays.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_virtual_rays.patch) by @vbraun created at 2012-06-30 18:12:11



---

archive/issue_comments_157149.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-07-02T13:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157149",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_157150.json:
```json
{
    "body": "Attachment [trac_13189_fan_isomorphism.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_fan_isomorphism.patch) by @vbraun created at 2012-07-02 13:20:58\n\nComputing the graph automorphism group goes through GAP, which is slow. The updated patch uses a special version of the isomorphism check for 2-d fans which avoids this.",
    "created_at": "2012-07-02T13:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157150",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_13189_fan_isomorphism.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_fan_isomorphism.patch) by @vbraun created at 2012-07-02 13:20:58

Computing the graph automorphism group goes through GAP, which is slow. The updated patch uses a special version of the isomorphism check for 2-d fans which avoids this.



---

archive/issue_comments_157151.json:
```json
{
    "body": "I thought Robert Miller wrote a very fast graph automorphism group code for Sage - am I confusing it with something else?",
    "created_at": "2012-07-03T17:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157151",
    "user": "https://github.com/novoselt"
}
```

I thought Robert Miller wrote a very fast graph automorphism group code for Sage - am I confusing it with something else?



---

archive/issue_comments_157152.json:
```json
{
    "body": "There is very nice code to compute one particular graph isomorphism, but I want to iterate over all graph isomorphisms. I'm doing this by combining the chose iso with the automorphisms of one of the graphs. But enumerating the automorphism group is using GAP, presumably you can gain more through group theory than what you can gain by making the graph theory fast.",
    "created_at": "2012-07-03T17:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157152",
    "user": "https://github.com/vbraun"
}
```

There is very nice code to compute one particular graph isomorphism, but I want to iterate over all graph isomorphisms. I'm doing this by combining the chose iso with the automorphisms of one of the graphs. But enumerating the automorphism group is using GAP, presumably you can gain more through group theory than what you can gain by making the graph theory fast.



---

archive/issue_comments_157153.json:
```json
{
    "body": "Glanced through, spotted a few typos that I'll fix in the reviewer patch.\n\nWhat do you mean by the following change of output description??\n\n```\nBy default, ``True`` if ``self`` and ``other`` are in the same\n`GL(n, \\ZZ)`-orbit, ``False`` otherwise.\n```\n\nDo you mind if I also switch computation of the virtual rays to the fan constructor and allow user to specify them? It is convenient e.g. when considering an affine toric variety corresponding to a face of another cone, or a subfanfan with similar structure. Then coordinates on the smaller variety can match the bigger ones.",
    "created_at": "2012-07-12T17:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157153",
    "user": "https://github.com/novoselt"
}
```

Glanced through, spotted a few typos that I'll fix in the reviewer patch.

What do you mean by the following change of output description??

```
By default, ``True`` if ``self`` and ``other`` are in the same
`GL(n, \ZZ)`-orbit, ``False`` otherwise.
```

Do you mind if I also switch computation of the virtual rays to the fan constructor and allow user to specify them? It is convenient e.g. when considering an affine toric variety corresponding to a face of another cone, or a subfanfan with similar structure. Then coordinates on the smaller variety can match the bigger ones.



---

archive/issue_comments_157154.json:
```json
{
    "body": "Got one error testing `cone.py`:\n\n```\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.2.beta0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/novoselt/sage-5.2.beta0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/novoselt/sage-5.2.beta0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_26[13]>\", line 9, in <module>\n        frac = Hirzebruch_Jung_continued_fraction_list(k/d)\n      File \"/home/novoselt/sage-5.2.beta0/local/lib/python/site-packages/sage/rings/arith.py\", line 4193, in Hirzebruch_Jung_continued_fraction_list\n        if not sage.rings.rational.is_Rational(x):\n    AttributeError: 'module' object has no attribute 'is_Rational'\n```\n\nThe new module also has to be included into documentation, I think. Is there actually a particular reason why it is not just in `fan.py`?",
    "created_at": "2012-07-12T18:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157154",
    "user": "https://github.com/novoselt"
}
```

Got one error testing `cone.py`:

```
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.2.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/novoselt/sage-5.2.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/novoselt/sage-5.2.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_26[13]>", line 9, in <module>
        frac = Hirzebruch_Jung_continued_fraction_list(k/d)
      File "/home/novoselt/sage-5.2.beta0/local/lib/python/site-packages/sage/rings/arith.py", line 4193, in Hirzebruch_Jung_continued_fraction_list
        if not sage.rings.rational.is_Rational(x):
    AttributeError: 'module' object has no attribute 'is_Rational'
```

The new module also has to be included into documentation, I think. Is there actually a particular reason why it is not just in `fan.py`?



---

archive/issue_comments_157155.json:
```json
{
    "body": "Replying to [comment:7 novoselt]:\n> What do you mean by the following change of output description??\n> \n> ```\n> By default, ``True`` if ``self`` and ``other`` are in the same\n> `GL(n, \\ZZ)`-orbit, ``False`` otherwise.\n> ```\n\n\nI'm trying to say that it returns whether the two fans are equivalent up to a `GL(n,ZZ)` basis change. Apparently not comprehensible enough ;-)\n\n> Do you mind if I also switch computation of the virtual rays to the fan constructor and allow user to specify them?\n\n\nIf you want to implement that, go for it.",
    "created_at": "2012-07-12T20:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157155",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:7 novoselt]:
> What do you mean by the following change of output description??
> 
> ```
> By default, ``True`` if ``self`` and ``other`` are in the same
> `GL(n, \ZZ)`-orbit, ``False`` otherwise.
> ```


I'm trying to say that it returns whether the two fans are equivalent up to a `GL(n,ZZ)` basis change. Apparently not comprehensible enough ;-)

> Do you mind if I also switch computation of the virtual rays to the fan constructor and allow user to specify them?


If you want to implement that, go for it.



---

archive/issue_comments_157156.json:
```json
{
    "body": "Replying to [comment:8 novoselt]:\n> The new module also has to be included into documentation, I think. Is there actually a particular reason why it is not just in `fan.py`?\n\n\nThe `fan_isomorphism.py` file is just a way to prevent `fan.py` from getting too large. The relevant user-visible documentation is in `fan.py`, so I don't think we should include `fan_isomorphism.py` in the developer guide.",
    "created_at": "2012-07-12T20:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157156",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:8 novoselt]:
> The new module also has to be included into documentation, I think. Is there actually a particular reason why it is not just in `fan.py`?


The `fan_isomorphism.py` file is just a way to prevent `fan.py` from getting too large. The relevant user-visible documentation is in `fan.py`, so I don't think we should include `fan_isomorphism.py` in the developer guide.



---

archive/issue_comments_157157.json:
```json
{
    "body": "Tests pass now. The first patch is OK modulo changes, going through others...",
    "created_at": "2012-07-20T21:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157157",
    "user": "https://github.com/novoselt"
}
```

Tests pass now. The first patch is OK modulo changes, going through others...



---

archive/issue_comments_157158.json:
```json
{
    "body": "Attachment [trac_13189_reviewer.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_reviewer.patch) by @novoselt created at 2012-08-01 19:15:21",
    "created_at": "2012-08-01T19:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157158",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_13189_reviewer.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_reviewer.patch) by @novoselt created at 2012-08-01 19:15:21



---

archive/issue_comments_157159.json:
```json
{
    "body": "OK, positive review to Volker's patches modulo reviewer's one, which needs review now.\n\nChanges:\n* move `virtual_rays` method to fans only and allow specifying them during fan construction;\n* allow addition of point collections, which results in some simplification of code and examples;\n* a bunch of clarification/typo fixes in the documentation.\n\nAlso, am I right that with automatically chosen virtual rays the choice cannot affect the isomorphism of cones?",
    "created_at": "2012-08-01T22:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157159",
    "user": "https://github.com/novoselt"
}
```

OK, positive review to Volker's patches modulo reviewer's one, which needs review now.

Changes:
* move `virtual_rays` method to fans only and allow specifying them during fan construction;
* allow addition of point collections, which results in some simplification of code and examples;
* a bunch of clarification/typo fixes in the documentation.

Also, am I right that with automatically chosen virtual rays the choice cannot affect the isomorphism of cones?



---

archive/issue_comments_157160.json:
```json
{
    "body": "Changing keywords from \"\" to \"toric\".",
    "created_at": "2012-08-01T22:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157160",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "" to "toric".



---

archive/issue_comments_157161.json:
```json
{
    "body": "For the record: I have removed trailing whitespaces on new lines in the reviewer patch, so I don't think that patchbot should complain. As far as I know, ticket numbers are automatically added, so it should not complain either. And all tests pass, patchbot errors are not related.",
    "created_at": "2012-08-01T23:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157161",
    "user": "https://github.com/novoselt"
}
```

For the record: I have removed trailing whitespaces on new lines in the reviewer patch, so I don't think that patchbot should complain. As far as I know, ticket numbers are automatically added, so it should not complain either. And all tests pass, patchbot errors are not related.



---

archive/issue_comments_157162.json:
```json
{
    "body": "Added commit message",
    "created_at": "2012-08-04T14:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157162",
    "user": "https://github.com/vbraun"
}
```

Added commit message



---

archive/issue_comments_157163.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-08-04T15:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157163",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_157164.json:
```json
{
    "body": "Attachment [trac_13189_cone_isomorphism.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_cone_isomorphism.patch) by @vbraun created at 2012-08-04 15:02:18\n\nI forgot the commit message in trac_13189_cone_isomorphism.patch, no actual code changes.\n\nThe reviewer patch looks good to me.\n\nThe virtual ray choice doesn't change whether or not there is a isomorphism of two cones / two fans (barring any bugs), but the matrix entries of the lattice map of course differ.",
    "created_at": "2012-08-04T15:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157164",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_13189_cone_isomorphism.patch](tarball://root/attachments/some-uuid/ticket13189/trac_13189_cone_isomorphism.patch) by @vbraun created at 2012-08-04 15:02:18

I forgot the commit message in trac_13189_cone_isomorphism.patch, no actual code changes.

The reviewer patch looks good to me.

The virtual ray choice doesn't change whether or not there is a isomorphism of two cones / two fans (barring any bugs), but the matrix entries of the lattice map of course differ.



---

archive/issue_comments_157165.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-14T07:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13017#issuecomment-157165",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_036358.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-14T07:04:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13017",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13017#event-36358"
}
```
