# Issue 13191: Construct a 2-d fan from rays only

archive/issues_013019.json:
```json
{
    "body": "It would be convenient to construct a 2-d fan just from rays (by creating the maximal number of 2-d cones). This is what this patch does.\n\n```\nsage: fan = Fan2d([(1,1), (-1,-1), (1,-1), (-1,1)])\nsage: [ cone.ambient_ray_indices() for cone in fan ]\n[(2, 1), (1, 3), (3, 0), (0, 2)]\nsage: fan.is_complete()\nTrue\n```\n\nAssignee: @aghitza\n\nCC:  @novoselt\n\nKeywords: toric\n\nReviewer: Andrey Novoseltsev\n\nAuthor: Volker Braun\n\nMerged: sage-5.2.beta1\n\nDependencies: #12544\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13191\n\n",
    "closed_at": "2012-07-13T11:44:15Z",
    "created_at": "2012-07-01T20:39:48Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.2",
    "title": "Construct a 2-d fan from rays only",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13191",
    "user": "https://github.com/vbraun"
}
```
It would be convenient to construct a 2-d fan just from rays (by creating the maximal number of 2-d cones). This is what this patch does.

```
sage: fan = Fan2d([(1,1), (-1,-1), (1,-1), (-1,1)])
sage: [ cone.ambient_ray_indices() for cone in fan ]
[(2, 1), (1, 3), (3, 0), (0, 2)]
sage: fan.is_complete()
True
```

Assignee: @aghitza

CC:  @novoselt

Keywords: toric

Reviewer: Andrey Novoseltsev

Author: Volker Braun

Merged: sage-5.2.beta1

Dependencies: #12544

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13191





---

archive/issue_comments_167412.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-01T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167412",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_167413.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n It would be convenient to construct a 2-d fan just from rays (by creating the maximal number of 2-d cones). This is what this patch does.\n+\n+```\n+sage: fan = Fan2d([(1,1), (-1,-1), (1,-1), (-1,1)])\n+sage: [ cone.ambient_ray_indices() for cone in fan ]\n+[(2, 1), (1, 3), (3, 0), (0, 2)]\n+sage: fan.is_complete()\n+True\n+```\n \n Author: Volker Braun\n \n``````\n",
    "created_at": "2012-07-01T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167413",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,12 @@
 It would be convenient to construct a 2-d fan just from rays (by creating the maximal number of 2-d cones). This is what this patch does.
+
+```
+sage: fan = Fan2d([(1,1), (-1,-1), (1,-1), (-1,1)])
+sage: [ cone.ambient_ray_indices() for cone in fan ]
+[(2, 1), (1, 3), (3, 0), (0, 2)]
+sage: fan.is_complete()
+True
+```
 
 Author: Volker Braun
 
``````




---

archive/issue_comments_167414.json:
```json
{
    "body": "<a id='comment:2'></a>The updated patch removes duplicated rays (without changing the order) to match the usual `Fan()` behavior.",
    "created_at": "2012-07-02T13:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167414",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>The updated patch removes duplicated rays (without changing the order) to match the usual `Fan()` behavior.



---

archive/issue_comments_167415.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-07-07T14:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167415",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_167416.json:
```json
{
    "body": "Changing keywords from \"\" to \"toric\".",
    "created_at": "2012-07-07T14:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167416",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "" to "toric".



---

archive/issue_comments_167417.json:
```json
{
    "body": "Changing component from algebraic geometry to geometry.",
    "created_at": "2012-07-07T14:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167417",
    "user": "https://github.com/novoselt"
}
```

Changing component from algebraic geometry to geometry.



---

archive/issue_comments_167418.json:
```json
{
    "body": "<a id='comment:3'></a>How about expanding one-liner\n\n```\nConstruct a 2-dimensional fan\n```\ninto\n\n```\nConstruct the maximal 2-d fan with given ``rays``.\n```\n?\n\nIt would be nice also to have a more descriptive name, maybe `FanFromRays`? And perhaps one example can go to the module-level documentation to increase visibility of the constructor. (Or it can be mentioned in the documentation of `Fan`.)\n\nI also believe that one more case needs special treatment: two opposite rays, in which case there are two 1-d generating cones. (So far care was taken of no rays at all and a single ray.)",
    "created_at": "2012-07-07T14:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167418",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:3'></a>How about expanding one-liner

```
Construct a 2-dimensional fan
```
into

```
Construct the maximal 2-d fan with given ``rays``.
```
?

It would be nice also to have a more descriptive name, maybe `FanFromRays`? And perhaps one example can go to the module-level documentation to increase visibility of the constructor. (Or it can be mentioned in the documentation of `Fan`.)

I also believe that one more case needs special treatment: two opposite rays, in which case there are two 1-d generating cones. (So far care was taken of no rays at all and a single ray.)



---

archive/issue_comments_167419.json:
```json
{
    "body": "<a id='comment:4'></a>I've added it more prominently to the documentation and fixed the opposite ray case.\n\nI think `FanFromRays` is confusing since it only works in 2d. Right now tab-completion will tell you that there is a `Fan2d`, so if that is what you want then its clear that it is the right method. For experts its clear that this means you don't need to specify cones manually, but if there is any question there is always the online help.",
    "created_at": "2012-07-08T11:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167419",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>I've added it more prominently to the documentation and fixed the opposite ray case.

I think `FanFromRays` is confusing since it only works in 2d. Right now tab-completion will tell you that there is a `Fan2d`, so if that is what you want then its clear that it is the right method. For experts its clear that this means you don't need to specify cones manually, but if there is any question there is always the online help.



---

archive/issue_comments_167420.json:
```json
{
    "body": "<a id='comment:6'></a>\n```\nsage: Fan2d([(0,1)])\nRational polyhedral fan in 2-d lattice N\nsage: _.is_complete()\nTrue\n```\n\nSelecting distinct rays is a bit convoluted, but especially strange is repeating this selection on sorted rays which are already distinct just to trigger the complete removal of a single ray. How about something like this:\n\n```\n...\nn = len(rays)\nif n == 1 or n == 2 and rays[0] == -rays[1]:\n    cones = [(i, ) for i in range(n)]\n    return RationalPolyhedralFan(cones, rays, lattice, False) \n\nimport math\nsorted_rays = sorted(...)\ncones = []\n...\n# there are definitely some 2-d cones now\n```",
    "created_at": "2012-07-08T15:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167420",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>
```
sage: Fan2d([(0,1)])
Rational polyhedral fan in 2-d lattice N
sage: _.is_complete()
True
```

Selecting distinct rays is a bit convoluted, but especially strange is repeating this selection on sorted rays which are already distinct just to trigger the complete removal of a single ray. How about something like this:

```
...
n = len(rays)
if n == 1 or n == 2 and rays[0] == -rays[1]:
    cones = [(i, ) for i in range(n)]
    return RationalPolyhedralFan(cones, rays, lattice, False) 

import math
sorted_rays = sorted(...)
cones = []
...
# there are definitely some 2-d cones now
```



---

archive/issue_comments_167421.json:
```json
{
    "body": "<a id='comment:7'></a>Just as in the `Fan()` constructor, it is permissible to pass an arbitrary number of duplicate rays. For example:\n\n```\nsage: Fan2d([(0,1), (1,0), (0,1), (1,0)])\nRational polyhedral fan in 2-d lattice N\n```\nI fixed the completeness bug.",
    "created_at": "2012-07-08T16:38:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167421",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>Just as in the `Fan()` constructor, it is permissible to pass an arbitrary number of duplicate rays. For example:

```
sage: Fan2d([(0,1), (1,0), (0,1), (1,0)])
Rational polyhedral fan in 2-d lattice N
```
I fixed the completeness bug.



---

archive/issue_comments_167422.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-07-08T16:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167422",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_167423.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [trac_13191_auto_fan_2d.patch](tarball://root/attachments/some-uuid/ticket13191/trac_13191_auto_fan_2d.patch) by @vbraun created at 2012-07-08 16:38:51",
    "created_at": "2012-07-08T16:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167423",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>Attachment [trac_13191_auto_fan_2d.patch](tarball://root/attachments/some-uuid/ticket13191/trac_13191_auto_fan_2d.patch) by @vbraun created at 2012-07-08 16:38:51



---

archive/issue_comments_167424.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-07-08T16:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167424",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_167425.json:
```json
{
    "body": "<a id='comment:9'></a>Attachment [trac_13191_reviewer.patch](tarball://root/attachments/some-uuid/ticket13191/trac_13191_reviewer.patch) by @novoselt created at 2012-07-08 17:28:22\n\nI was complaining not about removing duplicates - that is fine - but about the way how it is done. Nonetheless, it is still clear what is going on. But the line\n\n```\nsorted_rays = [ r for i,r in enumerate(sorted_rays) if r[1] != sorted_rays[i-1][1] ] \n```\nis very confusing: sorted rays are already unique and the equality can be triggered only when the first element is equal to the previous, i.e. the last one, which is the same as first when the length is one. In other words the effect of this line is the same as\n\n```\nif len(sorted_rays) == 1: sorted_rays = []\n```\nand it does require some thinking to figure out that this is what happening and then realize how the rest of the code depends on it.\n\nSo I still propose to unwind the code a bit, if you agree with the changes in the reviewer patch, please set it to positive review!",
    "created_at": "2012-07-08T17:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167425",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'></a>Attachment [trac_13191_reviewer.patch](tarball://root/attachments/some-uuid/ticket13191/trac_13191_reviewer.patch) by @novoselt created at 2012-07-08 17:28:22

I was complaining not about removing duplicates - that is fine - but about the way how it is done. Nonetheless, it is still clear what is going on. But the line

```
sorted_rays = [ r for i,r in enumerate(sorted_rays) if r[1] != sorted_rays[i-1][1] ] 
```
is very confusing: sorted rays are already unique and the equality can be triggered only when the first element is equal to the previous, i.e. the last one, which is the same as first when the length is one. In other words the effect of this line is the same as

```
if len(sorted_rays) == 1: sorted_rays = []
```
and it does require some thinking to figure out that this is what happening and then realize how the rest of the code depends on it.

So I still propose to unwind the code a bit, if you agree with the changes in the reviewer patch, please set it to positive review!



---

archive/issue_comments_167426.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-08T18:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167426",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_167427.json:
```json
{
    "body": "<a id='comment:10'></a>Ok now I get it ;-)\n\nYour patch look good to me!",
    "created_at": "2012-07-08T18:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167427",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>Ok now I get it ;-)

Your patch look good to me!



---

archive/issue_events_036373.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-07-13T11:44:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13191#event-36373"
}
```



---

archive/issue_comments_167428.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-07-13T11:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13191#issuecomment-167428",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
