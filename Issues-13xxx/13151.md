# Issue 13151: fix pickling of Matrix_modn_dense_double on SPARC

archive/issues_012979.json:
```json
{
    "body": "On the Skynet machine `mark` (Solaris SPARC), pickling a `Matrix_modn_dense_double` results in a Bus Error (as reported at #12841):\n\n```\nsage -t  --long -force_lib devel/sage/sage/matrix/matrix_modn_dense.pyx\n**********************************************************************\nFile \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/devel/sage-main/sage/matrix/matrix_modn_dense.pyx\", line 464:\n    sage: data, version = A._pickle()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_6[8]>\", line 1, in <module>\n        data, version = A._pickle()###line 464:\n    sage: data, version = A._pickle()\n      File \"matrix_modn_dense_template.pxi\", line 636, in sage.matrix.matrix_modn_dense_double.Matrix_modn_dense_template._pickle (sage/matrix/matrix_modn_dense_double.cpp:6518)\n        sig_on()\n    RuntimeError: Bus error\n**********************************************************************\n```\n\n**Assignee:** drkirkby\n\n**CC:**  @vbraun @jdemeyer drkirkby jpflori @nexttime\n\n**Keywords:** Solaris SPARC\n\n**Reviewer:** Jean-Pierre Flori\n\n**Author:** Jeroen Demeyer\n\n**Merged:** sage-5.9.beta5\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13151\n\n",
    "closed_at": "2013-04-11T07:35:35Z",
    "created_at": "2012-06-22T09:47:57Z",
    "labels": [
        "component: porting: solaris",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "fix pickling of Matrix_modn_dense_double on SPARC",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13151",
    "user": "https://github.com/malb"
}
```
On the Skynet machine `mark` (Solaris SPARC), pickling a `Matrix_modn_dense_double` results in a Bus Error (as reported at #12841):

```
sage -t  --long -force_lib devel/sage/sage/matrix/matrix_modn_dense.pyx
**********************************************************************
File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/devel/sage-main/sage/matrix/matrix_modn_dense.pyx", line 464:
    sage: data, version = A._pickle()
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_6[8]>", line 1, in <module>
        data, version = A._pickle()###line 464:
    sage: data, version = A._pickle()
      File "matrix_modn_dense_template.pxi", line 636, in sage.matrix.matrix_modn_dense_double.Matrix_modn_dense_template._pickle (sage/matrix/matrix_modn_dense_double.cpp:6518)
        sig_on()
    RuntimeError: Bus error
**********************************************************************
```

**Assignee:** drkirkby

**CC:**  @vbraun @jdemeyer drkirkby jpflori @nexttime

**Keywords:** Solaris SPARC

**Reviewer:** Jean-Pierre Flori

**Author:** Jeroen Demeyer

**Merged:** sage-5.9.beta5

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/13151





---

archive/issue_comments_200068.json:
```json
{
    "body": "<a id='comment:1'></a>\nVolker reported at #12841:\n\n> The output of PyString_FromStringAndSize is 4 but not 8-byte aligned. By faking it\n> \n> ```\n>            um = <mod_int*>((<char *>s)+4)\n> ```\n> I avoided the crash.\n",
    "created_at": "2012-06-22T09:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200068",
    "user": "https://github.com/malb"
}
```

<a id='comment:1'></a>
Volker reported at #12841:

> The output of PyString_FromStringAndSize is 4 but not 8-byte aligned. By faking it
> 
> ```
>            um = <mod_int*>((<char *>s)+4)
> ```
> I avoided the crash.




---

archive/issue_comments_200069.json:
```json
{
    "body": "<a id='comment:2'></a>\nI tried `gcc -munaligned-doubles` but that didn't help.\n\nThe problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.",
    "created_at": "2012-06-22T10:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200069",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>
I tried `gcc -munaligned-doubles` but that didn't help.

The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.



---

archive/issue_comments_200070.json:
```json
{
    "body": "<a id='comment:3'></a>\nI've built 32-bit Sage on OpenIndiana and it works fine, for the record.",
    "created_at": "2012-06-22T11:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200070",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
I've built 32-bit Sage on OpenIndiana and it works fine, for the record.



---

archive/issue_comments_200071.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [vbraun](#comment%3A3):\n> I've built 32-bit Sage on OpenIndiana and it works fine, for the record.\n\nOn SPARC hardware?",
    "created_at": "2012-06-22T12:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200071",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Replying to [vbraun](#comment%3A3):
> I've built 32-bit Sage on OpenIndiana and it works fine, for the record.

On SPARC hardware?



---

archive/issue_comments_200072.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [jdemeyer](#comment%3A4):\n> On SPARC hardware?\n\n\nVery funny. OI doesn't even support SPARC ;-)",
    "created_at": "2012-06-22T12:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200072",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>
Replying to [jdemeyer](#comment%3A4):
> On SPARC hardware?


Very funny. OI doesn't even support SPARC ;-)



---

archive/issue_comments_200073.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [vbraun](#comment%3A5):\n> Replying to [jdemeyer](#comment%3A4):\n> > On SPARC hardware?\n\n> \n> Very funny. OI doesn't even support SPARC ;-)\n\nI didn't know that, but anyway it makes your comment irrelevant.  It is more of a hardware-related issue than a software-related issue.",
    "created_at": "2012-06-22T12:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200073",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Replying to [vbraun](#comment%3A5):
> Replying to [jdemeyer](#comment%3A4):
> > On SPARC hardware?

> 
> Very funny. OI doesn't even support SPARC ;-)

I didn't know that, but anyway it makes your comment irrelevant.  It is more of a hardware-related issue than a software-related issue.



---

archive/issue_comments_200074.json:
```json
{
    "body": "<a id='comment:7'></a>\neplying to [vbraun](#comment%3A2):\n> I tried `gcc -munaligned-doubles` but that didn't help.\n> \n> The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.\n\nThat's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.\n\nThe obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.",
    "created_at": "2012-06-22T12:14:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200074",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
eplying to [vbraun](#comment%3A2):
> I tried `gcc -munaligned-doubles` but that didn't help.
> 
> The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.

That's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.

The obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.



---

archive/issue_comments_200075.json:
```json
{
    "body": "<a id='comment:8'></a>\nSome more testing reveals that a) malloc on SPARC is in fact 8-byte aligned (as specified by the C99 standard), and b) the **output of `PyString_FromStringAndSize` is never 8-byte aligned,** not on SPARC 32-bit, OI 32-bit, Linux 64-bit:\n\n```\nsage: cython(\"\"\"\n....: def f():\n....:         cdef char* buf\n....:     s = PyString_FromStringAndSize(NULL, 1*8)\n....:     buf = <char*>s\n....:     return <int>buf\n....: \"\"\")\nsage: \nsage: set([ f() % 8 for i in range(100) ])\nset([4])\n```",
    "created_at": "2012-06-22T13:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200075",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
Some more testing reveals that a) malloc on SPARC is in fact 8-byte aligned (as specified by the C99 standard), and b) the **output of `PyString_FromStringAndSize` is never 8-byte aligned,** not on SPARC 32-bit, OI 32-bit, Linux 64-bit:

```
sage: cython("""
....: def f():
....:         cdef char* buf
....:     s = PyString_FromStringAndSize(NULL, 1*8)
....:     buf = <char*>s
....:     return <int>buf
....: """)
sage: 
sage: set([ f() % 8 for i in range(100) ])
set([4])
```



---

archive/issue_comments_200076.json:
```json
{
    "body": "<a id='comment:9'></a>\nFor debugging purposes it might be useful to know that you can turn off the misalignment support and trigger bus errors on x86 processors:\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <inttypes.h>\n\n/* Run as (on x86 processors):\n * $ gcc -o test test.c && ./test\n * Bus error (core dumped)\n */\n\n\nint main(void)\n{\n  __asm__(\"pushf\\n\"\n\t  \"orl $0x40000, (%rsp)\\n\"\n\t  \"popf\");\n \n    char *ptr = malloc(20);\n    ptr += 4;\n\n    uint64_t *uint64_ptr = (uint64_t*)ptr;\n    (*uint64_ptr) = (uint64_t)1;\n\n    return 0;\n}\n```",
    "created_at": "2012-06-22T14:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200076",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>
For debugging purposes it might be useful to know that you can turn off the misalignment support and trigger bus errors on x86 processors:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <inttypes.h>

/* Run as (on x86 processors):
 * $ gcc -o test test.c && ./test
 * Bus error (core dumped)
 */


int main(void)
{
  __asm__("pushf\n"
	  "orl $0x40000, (%rsp)\n"
	  "popf");
 
    char *ptr = malloc(20);
    ptr += 4;

    uint64_t *uint64_ptr = (uint64_t*)ptr;
    (*uint64_ptr) = (uint64_t)1;

    return 0;
}
```



---

archive/issue_comments_200077.json:
```json
{
    "body": "**Changing assignee** from @williamstein to drkirkby.",
    "created_at": "2012-06-22T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200077",
    "user": "https://github.com/jdemeyer"
}
```

**Changing assignee** from @williamstein to drkirkby.



---

archive/issue_comments_200078.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,23 @@\n-On mark/skynet pickling a `Matrix_modn_dense_double` results in a bus error as reported at #12841.\n+On the Skynet machine `mark` (Solaris SPARC), pickling a `Matrix_modn_dense_double` results in a Bus Error (as reported at #12841):\n+\n+```\n+sage -t  --long -force_lib devel/sage/sage/matrix/matrix_modn_dense.pyx\n+**********************************************************************\n+File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/devel/sage-main/sage/matrix/matrix_modn_dense.pyx\", line 464:\n+    sage: data, version = A._pickle()\n+Exception raised:\n+    Traceback (most recent call last):\n+      File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n+        self.run_one_example(test, example, filename, compileflags)\n+      File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/sagedoctest.py\", line 38, in run_one_example\n+        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n+      File \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n+        compileflags, 1) in test.globs\n+      File \"<doctest __main__.example_6[8]>\", line 1, in <module>\n+        data, version = A._pickle()###line 464:\n+    sage: data, version = A._pickle()\n+      File \"matrix_modn_dense_template.pxi\", line 636, in sage.matrix.matrix_modn_dense_double.Matrix_modn_dense_template._pickle (sage/matrix/matrix_modn_dense_double.cpp:6518)\n+        sig_on()\n+    RuntimeError: Bus error\n+**********************************************************************\n+```\n``````\n",
    "created_at": "2012-06-22T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200078",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,23 @@
-On mark/skynet pickling a `Matrix_modn_dense_double` results in a bus error as reported at #12841.
+On the Skynet machine `mark` (Solaris SPARC), pickling a `Matrix_modn_dense_double` results in a Bus Error (as reported at #12841):
+
+```
+sage -t  --long -force_lib devel/sage/sage/matrix/matrix_modn_dense.pyx
+**********************************************************************
+File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/devel/sage-main/sage/matrix/matrix_modn_dense.pyx", line 464:
+    sage: data, version = A._pickle()
+Exception raised:
+    Traceback (most recent call last):
+      File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
+        self.run_one_example(test, example, filename, compileflags)
+      File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
+        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
+      File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.2.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
+        compileflags, 1) in test.globs
+      File "<doctest __main__.example_6[8]>", line 1, in <module>
+        data, version = A._pickle()###line 464:
+    sage: data, version = A._pickle()
+      File "matrix_modn_dense_template.pxi", line 636, in sage.matrix.matrix_modn_dense_double.Matrix_modn_dense_template._pickle (sage/matrix/matrix_modn_dense_double.cpp:6518)
+        sig_on()
+    RuntimeError: Bus error
+**********************************************************************
+```
``````




---

archive/issue_comments_200079.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"SPARC\".",
    "created_at": "2012-06-22T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200079",
    "user": "https://github.com/jdemeyer"
}
```

**Changing keywords** from "" to "SPARC".



---

archive/issue_events_042239.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "label": "component: porting",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13151#event-42239"
}
```



---

archive/issue_events_042240.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "rename": {
        "from": "fix pickling of Matrix_modn_dense_double on Solaris (Mark)",
        "to": "fix pickling of Matrix_modn_dense_double on SPARC"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13151#event-42240"
}
```



---

archive/issue_comments_200080.json:
```json
{
    "body": "<a id='comment:11'></a>\nI noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, but not with the sage-5.1.beta3 build. Both shipped with mercurial-1.8.4. Perhaps our gcc spkg is at fault? The working build used `/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld`\n\n```\n-bash-3.00$ ./sage -hg qpush\n/home/vbraun/opt/mark/sage-5.1.beta3/spkg/bin/sage: line 641: 21670 Bus Error               (core dumped) \"$SAGE_LOCAL/bin/hg\" \"$@\"\n-bash-3.00$ pstack core\ncore 'core' of 21670:   python /home/vbraun/opt/mark/sage-5.1.beta3/local/bin/hg qpush\n fea40f14 parse_dirstate (3be794, fea417c0, 3bec40, 3bec51, ff223ebc, 2b37d0) + b8\n ff203388 PyCFunction_Call (3725a8, 390170, 0, e9850, 0, fea40e5c) + e0\n ff270f1c PyEval_EvalFrameEx (3be5f0, 0, 38c8a0, 22bc60, 209e0, 390170) + 6030\n ff271738 PyEval_EvalFrameEx (3be490, 0, 3be5f4, 33bb05, 209e0, 209e0) + 684c\n ff271738 PyEval_EvalFrameEx (3b53c8, 0, 3be494, 123b40, 209e0, 209e0) + 684c\n ff272acc PyEval_EvalCodeEx (1291d0, 3b53d4, 3b53c8, 24be4c, 3, 0) + 924\n ff1ea2b0 function_call (13de70, 24be40, 0, 17e4f8, 13de70, 1813a4) + 8c\n ff1be5c8 PyObject_Call (13de70, 24be40, 0, ff337c78, ff1ea224, 24be30) + 60\n ff1bedc8 PyObject_CallFunctionObjArgs (13de70, 3426f0, ffbfce14, ffbfce14, 0, 24be40) + d4\n ff205ea8 _PyObject_GenericGetAttrWithDict (0, 1c69c0, 2a8d20, 3426f0, ff223ebc, 2b37d0) + d0\n ff2052c4 PyObject_GetAttr (2b37d0, 1c69c0, ffffffff, ef088, ef088, 2b37d0) + 64\n ff26cbd0 PyEval_EvalFrameEx (3bc888, 0, 33fe50, 33bdad, 209e0, 3bc9d0) + 1ce4\n ff272acc PyEval_EvalCodeEx (339c38, 3bc890, 3bc888, 355c44, 2, 0) + 924\n ff1ea2b0 function_call (33df30, 355c38, 0, c, 33df30, 24be40) + 8c\n[...]\n ff297134 PyRun_FileExFlags (feef31f4, ffbff48b, 16ec00, 52660, 52660, 11fa88) + 7c\n ff297d18 PyRun_SimpleFileExFlags (ffbff4b8, ffbff48b, 1, ffbff294, ff2eac90, feef31f4) + d4\n ff2ac8f4 Py_Main  (1, ffbff2fc, ff33a55c, 0, feef31f4, 0) + c38\n 0001055c _start   (0, 0, 0, 0, 0, 0) + 5c\n```",
    "created_at": "2012-06-22T18:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200080",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, but not with the sage-5.1.beta3 build. Both shipped with mercurial-1.8.4. Perhaps our gcc spkg is at fault? The working build used `/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld`

```
-bash-3.00$ ./sage -hg qpush
/home/vbraun/opt/mark/sage-5.1.beta3/spkg/bin/sage: line 641: 21670 Bus Error               (core dumped) "$SAGE_LOCAL/bin/hg" "$@"
-bash-3.00$ pstack core
core 'core' of 21670:   python /home/vbraun/opt/mark/sage-5.1.beta3/local/bin/hg qpush
 fea40f14 parse_dirstate (3be794, fea417c0, 3bec40, 3bec51, ff223ebc, 2b37d0) + b8
 ff203388 PyCFunction_Call (3725a8, 390170, 0, e9850, 0, fea40e5c) + e0
 ff270f1c PyEval_EvalFrameEx (3be5f0, 0, 38c8a0, 22bc60, 209e0, 390170) + 6030
 ff271738 PyEval_EvalFrameEx (3be490, 0, 3be5f4, 33bb05, 209e0, 209e0) + 684c
 ff271738 PyEval_EvalFrameEx (3b53c8, 0, 3be494, 123b40, 209e0, 209e0) + 684c
 ff272acc PyEval_EvalCodeEx (1291d0, 3b53d4, 3b53c8, 24be4c, 3, 0) + 924
 ff1ea2b0 function_call (13de70, 24be40, 0, 17e4f8, 13de70, 1813a4) + 8c
 ff1be5c8 PyObject_Call (13de70, 24be40, 0, ff337c78, ff1ea224, 24be30) + 60
 ff1bedc8 PyObject_CallFunctionObjArgs (13de70, 3426f0, ffbfce14, ffbfce14, 0, 24be40) + d4
 ff205ea8 _PyObject_GenericGetAttrWithDict (0, 1c69c0, 2a8d20, 3426f0, ff223ebc, 2b37d0) + d0
 ff2052c4 PyObject_GetAttr (2b37d0, 1c69c0, ffffffff, ef088, ef088, 2b37d0) + 64
 ff26cbd0 PyEval_EvalFrameEx (3bc888, 0, 33fe50, 33bdad, 209e0, 3bc9d0) + 1ce4
 ff272acc PyEval_EvalCodeEx (339c38, 3bc890, 3bc888, 355c44, 2, 0) + 924
 ff1ea2b0 function_call (33df30, 355c38, 0, c, 33df30, 24be40) + 8c
[...]
 ff297134 PyRun_FileExFlags (feef31f4, ffbff48b, 16ec00, 52660, 52660, 11fa88) + 7c
 ff297d18 PyRun_SimpleFileExFlags (ffbff4b8, ffbff48b, 1, ffbff294, ff2eac90, feef31f4) + d4
 ff2ac8f4 Py_Main  (1, ffbff2fc, ff33a55c, 0, feef31f4, 0) + c38
 0001055c _start   (0, 0, 0, 0, 0, 0) + 5c
```



---

archive/issue_comments_200081.json:
```json
{
    "body": "<a id='comment:12'></a>\nI can confirm the `hg` problem, but don't feel like investigating that now.\n\nYou could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).",
    "created_at": "2012-06-22T21:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200081",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
I can confirm the `hg` problem, but don't feel like investigating that now.

You could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).



---

archive/issue_comments_200082.json:
```json
{
    "body": "<a id='comment:13'></a>\nBack to the pickling issue, why do cast double to uint64_t at all? Since we clearly don't care about endianness, why not just memcpy the bare data?",
    "created_at": "2012-06-22T23:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200082",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>
Back to the pickling issue, why do cast double to uint64_t at all? Since we clearly don't care about endianness, why not just memcpy the bare data?



---

archive/issue_comments_200083.json:
```json
{
    "body": "<a id='comment:14'></a>\nWhen we load a pickle from machine A on machine B and they have different endianness, then we care about fixing that.",
    "created_at": "2012-06-23T10:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200083",
    "user": "https://github.com/malb"
}
```

<a id='comment:14'></a>
When we load a pickle from machine A on machine B and they have different endianness, then we care about fixing that.



---

archive/issue_comments_200084.json:
```json
{
    "body": "**Changing keywords** from \"SPARC\" to \"Solaris SPARC\".",
    "created_at": "2012-09-03T07:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200084",
    "user": "https://github.com/jdemeyer"
}
```

**Changing keywords** from "SPARC" to "Solaris SPARC".



---

archive/issue_comments_200085.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [jdemeyer](#comment%3A12):\n> I can confirm the `hg` problem, but don't feel like investigating that now.\n> \n> You could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).\n\n\nI built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage. I get the same problem, so it is not some bug related to the particular gcc in Sage. \n\nIs Skynet's SPARC machine running? If not, and someone wants to look at this, they can use my SPARC. I don't keep it on 24/7, but now I am writing some code to control a vector network analyzer, so the machine will be on for a week or two. \n\nDave",
    "created_at": "2012-09-03T17:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200085",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:16'></a>
Replying to [jdemeyer](#comment%3A12):
> I can confirm the `hg` problem, but don't feel like investigating that now.
> 
> You could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).


I built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage. I get the same problem, so it is not some bug related to the particular gcc in Sage. 

Is Skynet's SPARC machine running? If not, and someone wants to look at this, they can use my SPARC. I don't keep it on 24/7, but now I am writing some code to control a vector network analyzer, so the machine will be on for a week or two. 

Dave



---

archive/issue_comments_200086.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [drkirkby](#comment%3A16):\n> Is Skynet's SPARC machine running?\n\nYes, it is.",
    "created_at": "2012-09-04T07:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200086",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
Replying to [drkirkby](#comment%3A16):
> Is Skynet's SPARC machine running?

Yes, it is.



---

archive/issue_comments_200087.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [drkirkby](#comment%3A16):\n> I built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage.\n\nWhich assembler/linker is that using?",
    "created_at": "2012-09-04T07:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200087",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Replying to [drkirkby](#comment%3A16):
> I built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage.

Which assembler/linker is that using?



---

archive/issue_comments_200088.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [vbraun](#comment%3A11):\n> I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]\n\n\nDoesn't really surprise me... ;-)\n\n(I've tested it with GCC 4.5.1 and 4.6.1.)",
    "created_at": "2013-04-01T14:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200088",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:21'></a>
Replying to [vbraun](#comment%3A11):
> I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]


Doesn't really surprise me... ;-)

(I've tested it with GCC 4.5.1 and 4.6.1.)



---

archive/issue_comments_200089.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [leif](#comment%3A21):\n> Replying to [vbraun](#comment%3A11):\n> > I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]\n\n> \n> Doesn't really surprise me... ;-)\n> \n> (I've tested it with GCC 4.5.1 and 4.6.1.)\n\nOn my 5.9.beta3 setup (with Sage's GCC), ./sage -hg seems fine as well.",
    "created_at": "2013-04-03T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200089",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:22'></a>
Replying to [leif](#comment%3A21):
> Replying to [vbraun](#comment%3A11):
> > I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]

> 
> Doesn't really surprise me... ;-)
> 
> (I've tested it with GCC 4.5.1 and 4.6.1.)

On my 5.9.beta3 setup (with Sage's GCC), ./sage -hg seems fine as well.



---

archive/issue_comments_200090.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [jdemeyer](#comment%3A7):\n> eplying to [vbraun](#comment%3A2):\n> > I tried `gcc -munaligned-doubles` but that didn't help.\n> > \n> > The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.\n\n> That's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.\n> \n> The obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.\n\nSo should we go with that solution?",
    "created_at": "2013-04-03T14:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200090",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:23'></a>
Replying to [jdemeyer](#comment%3A7):
> eplying to [vbraun](#comment%3A2):
> > I tried `gcc -munaligned-doubles` but that didn't help.
> > 
> > The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.

> That's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.
> 
> The obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.

So should we go with that solution?



---

archive/issue_comments_200091.json:
```json
{
    "body": "<a id='comment:24'></a>\nNot that we really care if matrix unpickling is a little slower...",
    "created_at": "2013-04-03T14:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200091",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:24'></a>
Not that we really care if matrix unpickling is a little slower...



---

archive/issue_comments_200092.json:
```json
{
    "body": "<a id='comment:25'></a>\nOK, you write the patch or me (just asking to avoid duplicating effort).\n\nIt would be really cool if we could have full SPARC suppport in sage-5.9, and maybe even full Cygwin support also.",
    "created_at": "2013-04-04T07:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200092",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
OK, you write the patch or me (just asking to avoid duplicating effort).

It would be really cool if we could have full SPARC suppport in sage-5.9, and maybe even full Cygwin support also.



---

archive/issue_comments_200093.json:
```json
{
    "body": "<a id='comment:26'></a>\nI won't have time before late tonight, so please go ahead and I'll review it later if that suits you.",
    "created_at": "2013-04-04T07:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200093",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:26'></a>
I won't have time before late tonight, so please go ahead and I'll review it later if that suits you.



---

archive/issue_comments_200094.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-04-08T14:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200094",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_200095.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2013-04-08T14:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200095",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_events_042241.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "label": "component: porting",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13151#event-42241"
}
```



---

archive/issue_comments_200096.json:
```json
{
    "body": "<a id='comment:29'></a>\nSee #14429 for another SPARC-related ticket. When applying #13151 and #14429, there should be no more doctest failures on Solaris SPARC, i.e. Solaris SPARC would become fully supported with these two tickets.",
    "created_at": "2013-04-09T10:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200096",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
See #14429 for another SPARC-related ticket. When applying #13151 and #14429, there should be no more doctest failures on Solaris SPARC, i.e. Solaris SPARC would become fully supported with these two tickets.



---

archive/issue_comments_200097.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-04-10T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200097",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_200098.json:
```json
{
    "body": "**Reviewer:** Jean-Pierre Flori",
    "created_at": "2013-04-10T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200098",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Reviewer:** Jean-Pierre Flori



---

archive/issue_comments_200099.json:
```json
{
    "body": "<a id='comment:30'></a>\nThis works fine and the patch looks ok, implementing the solution which was suggested here.",
    "created_at": "2013-04-10T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200099",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:30'></a>
This works fine and the patch looks ok, implementing the solution which was suggested here.



---

archive/attachments_017780.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13151_alignment.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket13151/13151_alignment.patch",
    "created_at": "2013-04-10T10:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_200100.json:
```json
{
    "body": "",
    "created_at": "2013-04-10T10:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200100",
    "user": "https://github.com/jdemeyer"
}
```





---

archive/issue_comments_200101.json:
```json
{
    "body": "<a id='comment:31'></a>\nI fixed a small mistake: the `sig_on()` should be *outside* the `try/finally` statement. I assume that the positive review still stands.",
    "created_at": "2013-04-10T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200101",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
I fixed a small mistake: the `sig_on()` should be *outside* the `try/finally` statement. I assume that the positive review still stands.



---

archive/issue_events_042242.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-11T07:35:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13151#event-42242"
}
```



---

archive/issue_comments_200102.json:
```json
{
    "body": "**Merged:** sage-5.9.beta5",
    "created_at": "2013-04-11T07:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200102",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.9.beta5



---

archive/issue_comments_200103.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2013-04-11T07:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13151#issuecomment-200103",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed
