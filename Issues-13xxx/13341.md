# Issue 13341: GAP's spkg-install fails on recent Cygwin

archive/issues_013169.json:
```json
{
    "body": "The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.\n\nUse spkg at [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg)\n\n**CC:**  @dimpase\n\n**Keywords:** cygwin gap spkg\n\n**Reviewer:** Dmitrii Pasechnik\n\n**Author:** Jean-Pierre Flori, Leif Leonhardy\n\n**Merged:** sage-5.3.rc1\n\nIssue created by migration from https://trac.sagemath.org/ticket/13341\n\n",
    "closed_at": "2012-08-27T10:38:23Z",
    "created_at": "2012-08-05T09:45:12Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.3",
    "title": "GAP's spkg-install fails on recent Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/13341",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.

Use spkg at [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg)

**CC:**  @dimpase

**Keywords:** cygwin gap spkg

**Reviewer:** Dmitrii Pasechnik

**Author:** Jean-Pierre Flori, Leif Leonhardy

**Merged:** sage-5.3.rc1

Issue created by migration from https://trac.sagemath.org/ticket/13341





---

archive/attachments_018067.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "spkg.diff",
    "asset_url": "tarball://root/attachments/ticket13341/spkg.diff",
    "created_at": "2012-08-05T10:02:35Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13341/spkg.diff",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```



---

archive/issue_comments_157004.json:
```json
{
    "body": "Attachment [spkg.diff](https://github.com/sagemath/sage/files/ticket13341/spkg.diff) by jpflori created at 2012-08-05 10:02:35\n\nSpkg diff, for review only.",
    "created_at": "2012-08-05T10:02:35Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157004",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [spkg.diff](https://github.com/sagemath/sage/files/ticket13341/spkg.diff) by jpflori created at 2012-08-05 10:02:35

Spkg diff, for review only.



---

archive/issue_comments_157005.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,5 @@\n The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.\n+\n+Use spkg at\n+http://perso.telecom-paristech.fr/~flori/sage/gap-4.4.12.p8.spkg\n+\n``````\n",
    "created_at": "2012-08-05T10:04:44Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157005",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,5 @@
 The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.
+
+Use spkg at
+http://perso.telecom-paristech.fr/~flori/sage/gap-4.4.12.p8.spkg
+
``````




---

archive/issue_comments_157006.json:
```json
{
    "body": "**Author:** Jean-Pierre Flori",
    "created_at": "2012-08-05T10:04:44Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157006",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Author:** Jean-Pierre Flori



---

archive/issue_events_113310.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jpflori",
    "created_at": "2012-08-05T10:04:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113310"
}
```



---

archive/issue_events_113311.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2012-08-05T18:55:36Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "rename": {
        "from": "Gap spkg fails on recent Cygwin",
        "to": "GAP's spkg-install fails on recent Cygwin"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113311"
}
```



---

archive/issue_comments_157007.json:
```json
{
    "body": "<a id='comment:2'></a>\nRather than expressing hope, how about testing for the presence of `gap`? ;-)\n\nYou could also just use `ln -sf ...` (\"force\"), which doesn't fail if the source (second parameter) already exists, i.e., with `-f` a new link is created regardless.  No idea how that behaves on Cygwin with \"virtual\" files; it may create a cycle (symbolic link from 'gap.exe' to itself), or fail in other ways, then hopefully raising an error...\n\n(Note that `ln -s <non-existent-1> <non-existent-2>` does **not** fail, but instead creates a \"dead\" symbolic link [although not sure about that on Cygwin, since we use `touch` to create a dummy target].  So you may also have to check whether the target, `gap.exe`, really exists, i.e., the \"build\" so far succeeded, here meaning `mkdir`, `cd` and `touch` worked... :-) )\n\n\nIf you don't want to use the \"force\" option, you could instead do\n\n```sh\n        mkdir -p bin/i686-pc-cygwin-gcc &&\n        cd bin/i686-pc-cygwin-gcc &&\n        touch gap.exe &&\n        (test -f gap || ln -s gap.exe gap)   # Probably don't use '-x'\n                                             # since 'gap.exe' is yet a dummy.\n\n        if [[ $? -ne 0 ]]; then\n           # *Something* really went wrong...\n           ...\n           exit 1\n```\n\nBut perhaps it's better to at least slightly untangle the command chain:\n\n```sh\n        mkdir -p bin/i686-pc-cygwin-gcc &&\n        cd bin/i686-pc-cygwin-gcc &&\n        touch gap.exe\n\n        if [[ $? -ne 0 ]]; then\n            # Some serious error...\n            ...\n            exit 1\n        fi\n\n        # We may need a link from 'gap' to 'gap.exe', since the former later gets\n        # stripped by GAP.\n        # On newer Cygwins, 'gap' is automatically \"translated\" to 'gap.exe',\n        # such that 'ln' (without '-f') would fail (and we don't have to create the\n        # link on these systems anyway, since 'strip gap' there works without it).\n        if [[ ! -f gap ]]; then\n            ln -s gap.exe gap\n            # May check exit status here, since the above should never fail.\n        fi\n```",
    "created_at": "2012-08-05T18:55:36Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157007",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:2'></a>
Rather than expressing hope, how about testing for the presence of `gap`? ;-)

You could also just use `ln -sf ...` ("force"), which doesn't fail if the source (second parameter) already exists, i.e., with `-f` a new link is created regardless.  No idea how that behaves on Cygwin with "virtual" files; it may create a cycle (symbolic link from 'gap.exe' to itself), or fail in other ways, then hopefully raising an error...

(Note that `ln -s <non-existent-1> <non-existent-2>` does **not** fail, but instead creates a "dead" symbolic link [although not sure about that on Cygwin, since we use `touch` to create a dummy target].  So you may also have to check whether the target, `gap.exe`, really exists, i.e., the "build" so far succeeded, here meaning `mkdir`, `cd` and `touch` worked... :-) )


If you don't want to use the "force" option, you could instead do

```sh
        mkdir -p bin/i686-pc-cygwin-gcc &&
        cd bin/i686-pc-cygwin-gcc &&
        touch gap.exe &&
        (test -f gap || ln -s gap.exe gap)   # Probably don't use '-x'
                                             # since 'gap.exe' is yet a dummy.

        if [[ $? -ne 0 ]]; then
           # *Something* really went wrong...
           ...
           exit 1
```

But perhaps it's better to at least slightly untangle the command chain:

```sh
        mkdir -p bin/i686-pc-cygwin-gcc &&
        cd bin/i686-pc-cygwin-gcc &&
        touch gap.exe

        if [[ $? -ne 0 ]]; then
            # Some serious error...
            ...
            exit 1
        fi

        # We may need a link from 'gap' to 'gap.exe', since the former later gets
        # stripped by GAP.
        # On newer Cygwins, 'gap' is automatically "translated" to 'gap.exe',
        # such that 'ln' (without '-f') would fail (and we don't have to create the
        # link on these systems anyway, since 'strip gap' there works without it).
        if [[ ! -f gap ]]; then
            ln -s gap.exe gap
            # May check exit status here, since the above should never fail.
        fi
```



---

archive/issue_comments_157008.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [leif](#comment%3A2):\n> Rather than expressing hope, how about testing for the presence of `gap`? ;-)\n\n\nGood point, let's do something more sensible.\nI prefer your two second solutions.\nMaybe more the last one, although I'm not sure the first exit code test is really needed.\nBut ok it does not hurt.",
    "created_at": "2012-08-05T19:18:22Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157008",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:3'></a>
Replying to [leif](#comment%3A2):
> Rather than expressing hope, how about testing for the presence of `gap`? ;-)


Good point, let's do something more sensible.
I prefer your two second solutions.
Maybe more the last one, although I'm not sure the first exit code test is really needed.
But ok it does not hurt.



---

archive/issue_comments_157009.json:
```json
{
    "body": "**Work_Issues:** use better script",
    "created_at": "2012-08-05T19:18:56Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157009",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Work_Issues:** use better script



---

archive/issue_events_113312.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jpflori",
    "created_at": "2012-08-05T19:18:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113312"
}
```



---

archive/issue_events_113313.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jpflori",
    "created_at": "2012-08-05T19:18:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113313"
}
```



---

archive/issue_events_113314.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jpflori",
    "created_at": "2012-08-05T19:38:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113314"
}
```



---

archive/issue_events_113315.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jpflori",
    "created_at": "2012-08-05T19:38:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113315"
}
```



---

archive/issue_comments_157010.json:
```json
{
    "body": "<a id='comment:5'></a>\nSpkg updated.",
    "created_at": "2012-08-05T19:38:40Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157010",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:5'></a>
Spkg updated.



---

archive/issue_comments_157011.json:
```json
{
    "body": "**Changing work_issues** from \"use better script\" to \"\".",
    "created_at": "2012-08-05T19:38:40Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157011",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Changing work_issues** from "use better script" to "".



---

archive/issue_comments_157012.json:
```json
{
    "body": "**Changing author** from \"Jean-Pierre Flori\" to \"Jean-Pierre Flori, Leif Leonhardy\".",
    "created_at": "2012-08-05T19:38:40Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157012",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Changing author** from "Jean-Pierre Flori" to "Jean-Pierre Flori, Leif Leonhardy".



---

archive/attachments_018068.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "spkg.2.diff",
    "asset_url": "tarball://root/attachments/ticket13341/spkg.2.diff",
    "created_at": "2012-08-05T19:39:08Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket13341/spkg.2.diff",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```



---

archive/issue_comments_157013.json:
```json
{
    "body": "Attachment [spkg.2.diff](https://github.com/sagemath/sage/files/ticket13341/spkg.2.diff) by jpflori created at 2012-08-05 19:39:08\n\nspkg diff, for review only",
    "created_at": "2012-08-05T19:39:08Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157013",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [spkg.2.diff](https://github.com/sagemath/sage/files/ticket13341/spkg.2.diff) by jpflori created at 2012-08-05 19:39:08

spkg diff, for review only



---

archive/issue_comments_157014.json:
```json
{
    "body": "<a id='comment:6'></a>\nMmm something got broken in the last spkg, please disregard it.",
    "created_at": "2012-08-05T19:45:23Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157014",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:6'></a>
Mmm something got broken in the last spkg, please disregard it.



---

archive/issue_comments_157015.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis should be fixed now.",
    "created_at": "2012-08-05T19:50:40Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157015",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:7'></a>
This should be fixed now.



---

archive/issue_comments_157016.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnyone reviewing this?",
    "created_at": "2012-08-20T09:06:16Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157016",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:8'></a>
Anyone reviewing this?



---

archive/issue_comments_157017.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [jpflori](#comment%3A8):\n> Anyone reviewing this?\n\n\nI'll test that it builds on CYGWIN, and that ./sage -gap works. That's the best I can do on the current Win7 system I have access to.",
    "created_at": "2012-08-20T09:26:37Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157017",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
Replying to [jpflori](#comment%3A8):
> Anyone reviewing this?


I'll test that it builds on CYGWIN, and that ./sage -gap works. That's the best I can do on the current Win7 system I have access to.



---

archive/issue_events_113316.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2012-08-20T11:39:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113316"
}
```



---

archive/issue_events_113317.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2012-08-20T11:39:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113317"
}
```



---

archive/issue_comments_157018.json:
```json
{
    "body": "<a id='comment:10'></a>\nAll good, as far as I see.",
    "created_at": "2012-08-20T11:39:24Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157018",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
All good, as far as I see.



---

archive/issue_comments_157019.json:
```json
{
    "body": "**Reviewer:** Dmitrii Pasechnik",
    "created_at": "2012-08-22T09:44:53Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157019",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Dmitrii Pasechnik



---

archive/issue_events_113318.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-22T09:44:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "milestone": "sage-5.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113318"
}
```



---

archive/issue_events_113319.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-22T09:44:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "milestone": "sage-5.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113319"
}
```



---

archive/issue_comments_157020.json:
```json
{
    "body": "**Merged:** sage-5.3.rc1",
    "created_at": "2012-08-27T10:38:23Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157020",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.3.rc1



---

archive/issue_events_113320.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-27T10:38:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113320"
}
```



---

archive/issue_events_113321.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-27T10:38:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113321"
}
```



---

archive/issue_events_113322.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-27T11:04:44Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "milestone": "sage-5.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113322"
}
```



---

archive/issue_events_113323.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-27T11:04:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "milestone": "sage-5.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13341#event-113323"
}
```



---

archive/issue_comments_157021.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,3 @@\n The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.\n \n-Use spkg at\n-http://perso.telecom-paristech.fr/~flori/sage/gap-4.4.12.p8.spkg\n-\n+Use spkg at [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg)\n``````\n",
    "created_at": "2012-09-01T14:15:54Z",
    "issue": "https://github.com/sagemath/sage/issues/13341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13341#issuecomment-157021",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,3 @@
 The ln trick to symlink gap and gap.exe which used to be needed now fails and stop the installation.
 
-Use spkg at
-http://perso.telecom-paristech.fr/~flori/sage/gap-4.4.12.p8.spkg
-
+Use spkg at [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.4.12.p8.spkg)
``````

