# Issue 13417: Improved iteration on finite \ZZ-submodules and vector spaces over finite fields

archive/issues_013245.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @ppurka\n\nThis patch defines an iterator class for finite \\ZZ-submodules and especially for subspaces over finite fields.\n\nIt improves the running times of this computations significantly:\n\n```\n    sage: from sage.modules.finite_submodule_iter import FiniteFieldsubspace_iterator\n    sage: A = random_matrix(GF(2), 15, 100)\n    sage: X = A.row_space()\n    sage: x = [0 for _ in X] #long time #takes 7.12 seconds\n    sage: y = [0 for _ in FiniteFieldsubspace_iterator(A)] # takes 0.05 seconds\n```\n\n---\nApply in this order to `devel/sage`:\n1. [attachment:trac_13417-submodule_iter.2.patch]\n2. [attachment:trac_13417-review.patch]\n\nIssue created by migration from https://trac.sagemath.org/ticket/13417\n\n",
    "closed_at": "2012-12-18T11:15:27Z",
    "created_at": "2012-08-31T13:52:15Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.6",
    "title": "Improved iteration on finite \\ZZ-submodules and vector spaces over finite fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13417",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```
Assignee: @aghitza

CC:  @ppurka

This patch defines an iterator class for finite \ZZ-submodules and especially for subspaces over finite fields.

It improves the running times of this computations significantly:

```
    sage: from sage.modules.finite_submodule_iter import FiniteFieldsubspace_iterator
    sage: A = random_matrix(GF(2), 15, 100)
    sage: X = A.row_space()
    sage: x = [0 for _ in X] #long time #takes 7.12 seconds
    sage: y = [0 for _ in FiniteFieldsubspace_iterator(A)] # takes 0.05 seconds
```

---
Apply in this order to `devel/sage`:
1. [attachment:trac_13417-submodule_iter.2.patch]
2. [attachment:trac_13417-review.patch]

Issue created by migration from https://trac.sagemath.org/ticket/13417





---

archive/issue_comments_162028.json:
```json
{
    "body": "Attachment [submodule_iter.patch](tarball://root/attachments/some-uuid/ticket13417/submodule_iter.patch) by tfeulner created at 2012-08-31 14:05:06",
    "created_at": "2012-08-31T14:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162028",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

Attachment [submodule_iter.patch](tarball://root/attachments/some-uuid/ticket13417/submodule_iter.patch) by tfeulner created at 2012-08-31 14:05:06



---

archive/issue_comments_162029.json:
```json
{
    "body": "The `__iter__` methods are untouched in `sage.modules.free_modules`. Should this happen in a seperate ticket?",
    "created_at": "2012-08-31T14:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162029",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

The `__iter__` methods are untouched in `sage.modules.free_modules`. Should this happen in a seperate ticket?



---

archive/issue_comments_162030.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-09-03T14:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162030",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162031.json:
```json
{
    "body": "The attachment [attachment:trac_13417-submodule_iter.patch] contains an update to the patch that we arrived at after a long (off-ticket) discussion with tfeulner. Needs review. :)\n\nPatchbot: apply trac_13417-submodule_iter.patch",
    "created_at": "2012-11-09T10:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162031",
    "user": "https://github.com/ppurka"
}
```

The attachment [attachment:trac_13417-submodule_iter.patch] contains an update to the patch that we arrived at after a long (off-ticket) discussion with tfeulner. Needs review. :)

Patchbot: apply trac_13417-submodule_iter.patch



---

archive/issue_comments_162032.json:
```json
{
    "body": "Updated patch.",
    "created_at": "2012-11-09T12:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162032",
    "user": "https://github.com/ppurka"
}
```

Updated patch.



---

archive/issue_comments_162033.json:
```json
{
    "body": "Attachment [trac_13417-submodule_iter.patch](tarball://root/attachments/some-uuid/ticket13417/trac_13417-submodule_iter.patch) by @ppurka created at 2012-11-09 12:06:17\n\nI made a small change in the patch. The line\n\n```\n        basis = [_p*x for _p in pows for x in basis] # a ZZ_p-basis for the vectorspace \n```\nis changed to\n\n```\n        basis = [_p*x for x in basis for _p in pows] # a ZZ_p-basis for the vectorspace\n```\nFunctionally the patch is unchanged, but this small change will enable me to implement `__getitem__` for a linear code (the current implementation of `__getitem__` is a memory hog).",
    "created_at": "2012-11-09T12:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162033",
    "user": "https://github.com/ppurka"
}
```

Attachment [trac_13417-submodule_iter.patch](tarball://root/attachments/some-uuid/ticket13417/trac_13417-submodule_iter.patch) by @ppurka created at 2012-11-09 12:06:17

I made a small change in the patch. The line

```
        basis = [_p*x for _p in pows for x in basis] # a ZZ_p-basis for the vectorspace 
```
is changed to

```
        basis = [_p*x for x in basis for _p in pows] # a ZZ_p-basis for the vectorspace
```
Functionally the patch is unchanged, but this small change will enable me to implement `__getitem__` for a linear code (the current implementation of `__getitem__` is a memory hog).



---

archive/issue_comments_162034.json:
```json
{
    "body": "This update allows the user to iterate over cosets of such modules. Furthermore, I added a class to iterate over the set of projective points in the case  of subspaces.\n\n---\nPatchbot: apply trac_13417-submodule_iter.2.patch",
    "created_at": "2012-11-12T11:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162034",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

This update allows the user to iterate over cosets of such modules. Furthermore, I added a class to iterate over the set of projective points in the case  of subspaces.

---
Patchbot: apply trac_13417-submodule_iter.2.patch



---

archive/issue_events_037239.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/tfeulner",
    "created_at": "2012-11-15T08:21:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13417#event-37239"
}
```



---

archive/issue_comments_162035.json:
```json
{
    "body": "I am curious - maybe I am missing something here. Why is a vector which has the first nonzero element as 2 appearing in the projective point list? Isn't it the \"norm\" to have the first nonzero element in the vector be 1?\n\n```python\nsage: A = random_matrix(GF(3), 2, 3); A\n[2 0 2]\n[0 1 1]\nsage: list(FiniteFieldsubspace_projPoint_iterator(A))\n[(2, 0, 2), (0, 1, 1), (2, 1, 0), (1, 1, 2)]\n```",
    "created_at": "2012-11-30T07:40:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162035",
    "user": "https://github.com/ppurka"
}
```

I am curious - maybe I am missing something here. Why is a vector which has the first nonzero element as 2 appearing in the projective point list? Isn't it the "norm" to have the first nonzero element in the vector be 1?

```python
sage: A = random_matrix(GF(3), 2, 3); A
[2 0 2]
[0 1 1]
sage: list(FiniteFieldsubspace_projPoint_iterator(A))
[(2, 0, 2), (0, 1, 1), (2, 1, 0), (1, 1, 2)]
```



---

archive/issue_comments_162036.json:
```json
{
    "body": "Replying to [comment:8 ppurka]:\n> I am curious - maybe I am missing something here. Why is a vector which has the first nonzero element as 2 appearing in the projective point list? Isn't it the \"norm\" to have the first nonzero element in the vector be 1?\n\n\nMaybe I should have been more precise in the description of this class. For me, a point is just a one-dimensional subspace. The iterator should just return one basis vector for each one-dimensional subspace.\n\nIn fact, the way we construct these representatives can be seen as a multiplication by a vector w from the left. The last nonzero coordinate of w is equal to 1. I am not sure about the \"norm\" for projective points.\n\nI will modifiy the description of this class. The problem could be solved by\nechelonizing the basis during the init method (I will only provide an optional argument for those who do care).",
    "created_at": "2012-11-30T08:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162036",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

Replying to [comment:8 ppurka]:
> I am curious - maybe I am missing something here. Why is a vector which has the first nonzero element as 2 appearing in the projective point list? Isn't it the "norm" to have the first nonzero element in the vector be 1?


Maybe I should have been more precise in the description of this class. For me, a point is just a one-dimensional subspace. The iterator should just return one basis vector for each one-dimensional subspace.

In fact, the way we construct these representatives can be seen as a multiplication by a vector w from the left. The last nonzero coordinate of w is equal to 1. I am not sure about the "norm" for projective points.

I will modifiy the description of this class. The problem could be solved by
echelonizing the basis during the init method (I will only provide an optional argument for those who do care).



---

archive/issue_comments_162037.json:
```json
{
    "body": "By \"norm\" I meant that in usual places like textbooks, the convention followed is to have the first nonzero element as 1. Am I right? The reason is that once someone new uses this class, the output will not conform to what one would expect. I am myself not very familiar with projective spaces, so this was the first thing I noticed. Technically, the output is correct since the output contains only the representatives of each line.\n\nEchelonizing the basis is too much computations I think. All that is required is to determine the first nonzero element of a vector and multiply by its inverse. Something like\n\n```python\nring = v.base_ring()\nfor vi in v:\n   if vi:\n      if vi != ring.one():\n          v = vi**(-1) * v\n      break\n```\nThis can be done only once during the iteration.",
    "created_at": "2012-11-30T08:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162037",
    "user": "https://github.com/ppurka"
}
```

By "norm" I meant that in usual places like textbooks, the convention followed is to have the first nonzero element as 1. Am I right? The reason is that once someone new uses this class, the output will not conform to what one would expect. I am myself not very familiar with projective spaces, so this was the first thing I noticed. Technically, the output is correct since the output contains only the representatives of each line.

Echelonizing the basis is too much computations I think. All that is required is to determine the first nonzero element of a vector and multiply by its inverse. Something like

```python
ring = v.base_ring()
for vi in v:
   if vi:
      if vi != ring.one():
          v = vi**(-1) * v
      break
```
This can be done only once during the iteration.



---

archive/issue_comments_162038.json:
```json
{
    "body": "Replying to [comment:10 ppurka]:\n> By \"norm\" I meant that in usual places like textbooks, the convention followed is to have the first nonzero element as 1. Am I right? \n\nWell, this is at least the standard within Sage, so we should follow this.\n> \n> Echelonizing the basis is too much computations I think. All that is required is to determine the first nonzero element of a vector and multiply by its inverse. \n\nI do not understand why this should be too complicated, as far as I understand you would suggest to normalize all computed vectors (by the way there is already a function ```v.normalize()``` doing exactly the same)? But there are (q<sup>k</sup>-1)/(q-1) of them, while you have only to echelonize a (k x n) matrix over F<sub>q</sub>.",
    "created_at": "2012-11-30T09:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162038",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

Replying to [comment:10 ppurka]:
> By "norm" I meant that in usual places like textbooks, the convention followed is to have the first nonzero element as 1. Am I right? 

Well, this is at least the standard within Sage, so we should follow this.
> 
> Echelonizing the basis is too much computations I think. All that is required is to determine the first nonzero element of a vector and multiply by its inverse. 

I do not understand why this should be too complicated, as far as I understand you would suggest to normalize all computed vectors (by the way there is already a function ```v.normalize()``` doing exactly the same)? But there are (q<sup>k</sup>-1)/(q-1) of them, while you have only to echelonize a (k x n) matrix over F<sub>q</sub>.



---

archive/issue_comments_162039.json:
```json
{
    "body": "normalizing the returned vectors",
    "created_at": "2012-11-30T09:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162039",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

normalizing the returned vectors



---

archive/issue_comments_162040.json:
```json
{
    "body": "Attachment [trac_13417-submodule_iter.2.patch](tarball://root/attachments/some-uuid/ticket13417/trac_13417-submodule_iter.2.patch) by @ppurka created at 2012-11-30 10:31:34\n\nReplying to [comment:11 tfeulner]:\n> I do not understand why this should be too complicated, as far as I understand you would suggest to normalize all computed vectors (by the way there is already a function ```v.normalize()``` doing exactly the same)? But there are (q<sup>k</sup>-1)/(q-1) of them, while you have only to echelonize a (k x n) matrix over F<sub>q</sub>.\n\nOh ok. I see. I was thinking that one could get by by normalizing only the basis vectors, but I was wrong.",
    "created_at": "2012-11-30T10:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162040",
    "user": "https://github.com/ppurka"
}
```

Attachment [trac_13417-submodule_iter.2.patch](tarball://root/attachments/some-uuid/ticket13417/trac_13417-submodule_iter.2.patch) by @ppurka created at 2012-11-30 10:31:34

Replying to [comment:11 tfeulner]:
> I do not understand why this should be too complicated, as far as I understand you would suggest to normalize all computed vectors (by the way there is already a function ```v.normalize()``` doing exactly the same)? But there are (q<sup>k</sup>-1)/(q-1) of them, while you have only to echelonize a (k x n) matrix over F<sub>q</sub>.

Oh ok. I see. I was thinking that one could get by by normalizing only the basis vectors, but I was wrong.



---

archive/issue_comments_162041.json:
```json
{
    "body": "Attachment [trac_13417-review.patch](tarball://root/attachments/some-uuid/ticket13417/trac_13417-review.patch) by @ppurka created at 2012-11-30 11:32:22\n\napply to devel/sage after original patch.",
    "created_at": "2012-11-30T11:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162041",
    "user": "https://github.com/ppurka"
}
```

Attachment [trac_13417-review.patch](tarball://root/attachments/some-uuid/ticket13417/trac_13417-review.patch) by @ppurka created at 2012-11-30 11:32:22

apply to devel/sage after original patch.



---

archive/issue_comments_162042.json:
```json
{
    "body": "Ok. The code works, and looks good to me. It is positive review from my side. I am attaching a [attachment:trac_13417-review.patch review patch] which does only two changes - get rid of trailing whitespace, and change a comparison  `== None` to `is None`. If you are ok with this patch, then you can set it to positive review.\n\nPatchbot: apply trac_13417-submodule_iter.2.patch trac_13417-review.patch",
    "created_at": "2012-11-30T11:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162042",
    "user": "https://github.com/ppurka"
}
```

Ok. The code works, and looks good to me. It is positive review from my side. I am attaching a [attachment:trac_13417-review.patch review patch] which does only two changes - get rid of trailing whitespace, and change a comparison  `== None` to `is None`. If you are ok with this patch, then you can set it to positive review.

Patchbot: apply trac_13417-submodule_iter.2.patch trac_13417-review.patch



---

archive/issue_comments_162043.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-11-30T12:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162043",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162044.json:
```json
{
    "body": "Replying to [comment:13 ppurka]:\n> Ok. The code works, and looks good to me. It is positive review from my side. I am attaching a [attachment:trac_13417-review.patch review patch] which does only two changes - get rid of trailing whitespace, and change a comparison  `== None` to `is None`. If you are ok with this patch, then you can set it to positive review.\n\n\nThese changes look good to me, sorry for the whitespaces.",
    "created_at": "2012-11-30T12:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162044",
    "user": "https://trac.sagemath.org/admin/accounts/users/tfeulner"
}
```

Replying to [comment:13 ppurka]:
> Ok. The code works, and looks good to me. It is positive review from my side. I am attaching a [attachment:trac_13417-review.patch review patch] which does only two changes - get rid of trailing whitespace, and change a comparison  `== None` to `is None`. If you are ok with this patch, then you can set it to positive review.


These changes look good to me, sorry for the whitespaces.



---

archive/issue_events_037240.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-03T13:53:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13417#event-37240"
}
```



---

archive/issue_events_037241.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-03T13:53:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "milestone": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13417#event-37241"
}
```



---

archive/issue_comments_162045.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-12-18T11:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13417#issuecomment-162045",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_037242.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-18T11:15:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13417",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13417#event-37242"
}
```
