# Issue 13257: Coercion from `ZZ['x']` to `Integers(n)['x']` is VERY slow

archive/issues_013085.json:
```json
{
    "body": "As reported by Fredrik Johansson in #12173 this is a horrible horror:\n\n```\nsage: a = ZZ['x'](range(100000))\nsage: R = Integers(3)['x']\nsage: %time R(a);\nCPU times: user 39.38 s, sys: 28.55 s, total: 67.93 s\nWall time: 71.19 s\n```\n\n\n**Assignee:** @robertwb\n\n**CC:**  @fredrik-johansson jlopez simonking\n\n**Keywords:** days45\n\n**Reviewer:** Jean-Pierre Flori\n\n**Resolution:** worksforme\n\nIssue created by migration from https://trac.sagemath.org/ticket/13257\n\n",
    "closed_at": "2013-06-06T12:43:39Z",
    "created_at": "2012-07-15T10:15:52Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Coercion from `ZZ['x']` to `Integers(n)['x']` is VERY slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13257",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```
As reported by Fredrik Johansson in #12173 this is a horrible horror:

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: %time R(a);
CPU times: user 39.38 s, sys: 28.55 s, total: 67.93 s
Wall time: 71.19 s
```


**Assignee:** @robertwb

**CC:**  @fredrik-johansson jlopez simonking

**Keywords:** days45

**Reviewer:** Jean-Pierre Flori

**Resolution:** worksforme

Issue created by migration from https://trac.sagemath.org/ticket/13257





---

archive/issue_comments_202966.json:
```json
{
    "body": "<a id='comment:1'></a>\nPruning the command shows the whole time is spent calling `R._element_constructor_(a)` so we should take a look on how that function works to see what's going on.\n\n```\nsage: %prun R(a);\n         22 function calls in 66.593 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n        1   66.592   66.592   66.593   66.593 polynomial_ring.py:290(_element_constructor_)\n        1    0.000    0.000   66.593   66.593 <string>:1(<module>)\n        2    0.000    0.000    0.000    0.000 polynomial_ring.py:716(__hash__)\n        6    0.000    0.000    0.000    0.000 {isinstance}\n        3    0.000    0.000    0.000    0.000 {cmp}\n        1    0.000    0.000    0.000    0.000 {method 'has_coerce_map_from' of 'sage.structure.parent.Parent' objects}\n        3    0.000    0.000    0.000    0.000 integer_mod_ring.py:1030(__cmp__)\n        3    0.000    0.000    0.000    0.000 {method 'base_ring' of 'sage.structure.category_object.CategoryObject' objects}\n        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}\n        1    0.000    0.000    0.000    0.000 {method 'parent' of 'sage.structure.element.Element' objects}\n```",
    "created_at": "2012-07-15T10:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202966",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

<a id='comment:1'></a>
Pruning the command shows the whole time is spent calling `R._element_constructor_(a)` so we should take a look on how that function works to see what's going on.

```
sage: %prun R(a);
         22 function calls in 66.593 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1   66.592   66.592   66.593   66.593 polynomial_ring.py:290(_element_constructor_)
        1    0.000    0.000   66.593   66.593 <string>:1(<module>)
        2    0.000    0.000    0.000    0.000 polynomial_ring.py:716(__hash__)
        6    0.000    0.000    0.000    0.000 {isinstance}
        3    0.000    0.000    0.000    0.000 {cmp}
        1    0.000    0.000    0.000    0.000 {method 'has_coerce_map_from' of 'sage.structure.parent.Parent' objects}
        3    0.000    0.000    0.000    0.000 integer_mod_ring.py:1030(__cmp__)
        3    0.000    0.000    0.000    0.000 {method 'base_ring' of 'sage.structure.category_object.CategoryObject' objects}
        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}
        1    0.000    0.000    0.000    0.000 {method 'parent' of 'sage.structure.element.Element' objects}
```



---

archive/issue_comments_202967.json:
```json
{
    "body": "<a id='comment:2'></a>\nAs a point of comparison, if we convert the polynomial back into a list then the operation runs about 500x faster:\n\n```\nsage: %time R(list(a));\nCPU times: user 0.12 s, sys: 0.02 s, total: 0.14 s\nWall time: 0.14 s\n```\nSo we probably have a 'lost in coercion' situation here.",
    "created_at": "2012-07-15T10:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202967",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

<a id='comment:2'></a>
As a point of comparison, if we convert the polynomial back into a list then the operation runs about 500x faster:

```
sage: %time R(list(a));
CPU times: user 0.12 s, sys: 0.02 s, total: 0.14 s
Wall time: 0.14 s
```
So we probably have a 'lost in coercion' situation here.



---

archive/issue_comments_202968.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-As reported by Fredrik Johansson in #12713 this is a horrible horror:\n+As reported by Fredrik Johansson in #12173 this is a horrible horror:\n \n ```\n sage: a = ZZ['x'](range(100000))\n``````\n",
    "created_at": "2012-07-15T12:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202968",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-As reported by Fredrik Johansson in #12713 this is a horrible horror:
+As reported by Fredrik Johansson in #12173 this is a horrible horror:
 
 ```
 sage: a = ZZ['x'](range(100000))
``````




---

archive/issue_comments_202969.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe main problem is in compiled files (which is why `%prun` doesn't see it). In particular `polynomial_modz_flint.pyx` `_element_constructor_` calls `Polynomial_template`'s `__init__()` which converts `a` into a list of coefficients, which then reconstructs the polynomial by adding individual monomials together.\n\nWhere the time is taken is each time a monomial is added, a new polynomial is created. A partial solution is to convert polynomial inputs in `_element_consturctor_` to a list and do that (this runs fast because it just does the coefficient coercion and sets the coefficient list of the new polynomial). I haven't looked too deeply into a general solution yet (I don't quite know if this is the only case where this slowdown occurs), but I would suspect one exists.\n\nBest,\n\nTravis",
    "created_at": "2013-02-05T14:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202969",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
The main problem is in compiled files (which is why `%prun` doesn't see it). In particular `polynomial_modz_flint.pyx` `_element_constructor_` calls `Polynomial_template`'s `__init__()` which converts `a` into a list of coefficients, which then reconstructs the polynomial by adding individual monomials together.

Where the time is taken is each time a monomial is added, a new polynomial is created. A partial solution is to convert polynomial inputs in `_element_consturctor_` to a list and do that (this runs fast because it just does the coefficient coercion and sets the coefficient list of the new polynomial). I haven't looked too deeply into a general solution yet (I don't quite know if this is the only case where this slowdown occurs), but I would suspect one exists.

Best,

Travis



---

archive/issue_comments_202970.json:
```json
{
    "body": "**Author:** Travis Scrimshaw",
    "created_at": "2013-02-11T00:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202970",
    "user": "https://github.com/tscrim"
}
```

**Author:** Travis Scrimshaw



---

archive/issue_comments_202971.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-02-11T00:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202971",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_202972.json:
```json
{
    "body": "<a id='comment:5'></a>\nWell, I should say that's where it used to be...it's now in `polynomial_ring.py`.\n\nSomething even more scary to me, this did not scale linearly with `n`:\n\n```\nsage: a = ZZ['x'](range(30000)) \nsage: R = Integers(3)['x']\nsage: %time L = R(a)\nCPU times: user 4.48 s, sys: 0.03 s, total: 4.52 s\nWall time: 4.61 s\nsage: a = ZZ['x'](range(60000))\nsage: %time L = R(a)\nCPU times: user 17.84 s, sys: 0.09 s, total: 17.93 s\nWall time: 18.22 s\n```\n\nHowever I'm uploading a patch which just checks if it is a polynomial, and if so, it handles it as if it were a list. With the patch:\n\n```\nsage: a = ZZ['x'](range(1000000)) # Note the number of 0's\nsage: R = Integers(3)['x']\nsage: %time L = R(a)\nCPU times: user 2.00 s, sys: 0.19 s, total: 2.18 s\nWall time: 2.55 s\n```\n\nTo be honest, I'm still not perfectly happy with this solution since feels like a hack. If someone else can find an example of a significant slowdown which is not caught by this patch, please share. However as it stands, this patch is ready for review.\n\nBest\n\nTravis",
    "created_at": "2013-02-11T00:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202972",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Well, I should say that's where it used to be...it's now in `polynomial_ring.py`.

Something even more scary to me, this did not scale linearly with `n`:

```
sage: a = ZZ['x'](range(30000)) 
sage: R = Integers(3)['x']
sage: %time L = R(a)
CPU times: user 4.48 s, sys: 0.03 s, total: 4.52 s
Wall time: 4.61 s
sage: a = ZZ['x'](range(60000))
sage: %time L = R(a)
CPU times: user 17.84 s, sys: 0.09 s, total: 17.93 s
Wall time: 18.22 s
```

However I'm uploading a patch which just checks if it is a polynomial, and if so, it handles it as if it were a list. With the patch:

```
sage: a = ZZ['x'](range(1000000)) # Note the number of 0's
sage: R = Integers(3)['x']
sage: %time L = R(a)
CPU times: user 2.00 s, sys: 0.19 s, total: 2.18 s
Wall time: 2.55 s
```

To be honest, I'm still not perfectly happy with this solution since feels like a hack. If someone else can find an example of a significant slowdown which is not caught by this patch, please share. However as it stands, this patch is ready for review.

Best

Travis



---

archive/issue_comments_202973.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2013-02-12T07:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202973",
    "user": "https://github.com/robertwb"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_202974.json:
```json
{
    "body": "<a id='comment:6'></a>\nWon't this patch break\n\n```\nsage: R.<x> = ZZ[]\nsage: S.<y> = R[]\nsage: S._element_constructor_(x^2)\n x^2\n```\n\nI think polynomial_template should be fixed, at the cost of requiring a couple more special methods.",
    "created_at": "2013-02-12T07:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202974",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:6'></a>
Won't this patch break

```
sage: R.<x> = ZZ[]
sage: S.<y> = R[]
sage: S._element_constructor_(x^2)
 x^2
```

I think polynomial_template should be fixed, at the cost of requiring a couple more special methods.



---

archive/issue_comments_202975.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [robertwb](#comment%3A6):\n> Won't this patch break\n> \n> ```\n> sage: R.<x> = ZZ[]\n> sage: S.<y> = R[]\n> sage: S._element_constructor_(x^2)\n>  x^2\n> ```\n> \n\nYes it does:\n\n```\nsage: S._element_constructor_(x^2)\ny^2\n```\n\n> I think polynomial_template should be fixed, at the cost of requiring a couple more special methods.\n\n\nI'll see what I can do.\n\nThanks,\n\nTravis",
    "created_at": "2013-02-13T14:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202975",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>
Replying to [robertwb](#comment%3A6):
> Won't this patch break
> 
> ```
> sage: R.<x> = ZZ[]
> sage: S.<y> = R[]
> sage: S._element_constructor_(x^2)
>  x^2
> ```
> 

Yes it does:

```
sage: S._element_constructor_(x^2)
y^2
```

> I think polynomial_template should be fixed, at the cost of requiring a couple more special methods.


I'll see what I can do.

Thanks,

Travis



---

archive/issue_comments_202976.json:
```json
{
    "body": "Changed implementation",
    "created_at": "2013-02-15T20:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202976",
    "user": "https://github.com/tscrim"
}
```

Changed implementation



---

archive/issue_comments_202977.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202977",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_202978.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"days45\".",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202978",
    "user": "https://github.com/tscrim"
}
```

**Changing keywords** from "" to "days45".



---

archive/attachments_017950.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13257-modn_conversion_speedup-ts.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket13257/trac_13257-modn_conversion_speedup-ts.patch",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/tscrim"
}
```



---

archive/issue_comments_202979.json:
```json
{
    "body": "<a id='comment:8'></a>\nI've changed the fix to have `Polynomial_template` just convert the input polynomial into a list of coefficients and then pass that list back as a corresponding call the the *original* class's `__init__()` (rather than back to `Polynomial_template`) to take advantage of the specific implementations. This doesn't work quite as well for `GF2`, but that was significantly faster before anyways.\n\nMy timings with the patch:\n\n```\nsage: a = ZZ['x'](range(100000))\nsage: R = Integers(3)['x']\nsage: %time L = R(a)\nCPU times: user 0.22 s, sys: 0.05 s, total: 0.26 s\nWall time: 0.35 s\nsage: type(L)\nsage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint\n\nsage: S = GF(3)['x']\nsage: %time L = S(a)\nCPU times: user 0.22 s, sys: 0.00 s, total: 0.22 s\nWall time: 0.26 s\nsage: type(L)\nsage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint\n\nsage: T = GF(2)['x'] % different because it uses NTL\nCPU times: user 1.40 s, sys: 0.00 s, total: 1.40 s\nWall time: 1.50 s\nsage: %time L = T(list(a))\nCPU times: user 1.06 s, sys: 0.00 s, total: 1.06 s\nWall time: 1.16 s\nsage: type(L)\nsage.rings.polynomial.polynomial_gf2x.Polynomial_GF2X\n```\n\nReady for review again.\n\nThanks,\n\nTravis",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202979",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
I've changed the fix to have `Polynomial_template` just convert the input polynomial into a list of coefficients and then pass that list back as a corresponding call the the *original* class's `__init__()` (rather than back to `Polynomial_template`) to take advantage of the specific implementations. This doesn't work quite as well for `GF2`, but that was significantly faster before anyways.

My timings with the patch:

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: %time L = R(a)
CPU times: user 0.22 s, sys: 0.05 s, total: 0.26 s
Wall time: 0.35 s
sage: type(L)
sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint

sage: S = GF(3)['x']
sage: %time L = S(a)
CPU times: user 0.22 s, sys: 0.00 s, total: 0.22 s
Wall time: 0.26 s
sage: type(L)
sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint

sage: T = GF(2)['x'] % different because it uses NTL
CPU times: user 1.40 s, sys: 0.00 s, total: 1.40 s
Wall time: 1.50 s
sage: %time L = T(list(a))
CPU times: user 1.06 s, sys: 0.00 s, total: 1.06 s
Wall time: 1.16 s
sage: type(L)
sage.rings.polynomial.polynomial_gf2x.Polynomial_GF2X
```

Ready for review again.

Thanks,

Travis



---

archive/issue_events_042652.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jpflori",
    "created_at": "2013-06-04T13:07:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13257#event-42652"
}
```



---

archive/issue_comments_202980.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-06-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202980",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_202981.json:
```json
{
    "body": "**Reviewer:** Jean-Pierre Flori",
    "created_at": "2013-06-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202981",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Reviewer:** Jean-Pierre Flori



---

archive/issue_comments_202982.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think the horrible horror has been fixed in #12173 itself.\nAt least it takes 0 sec on my computer to perform this (except for Integers(2) where it is slightly solwer, 0.41 sec, surely because NTL is slow :)).\n\nSo I propose to close this as duplicate.",
    "created_at": "2013-06-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202982",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:9'></a>
I think the horrible horror has been fixed in #12173 itself.
At least it takes 0 sec on my computer to perform this (except for Integers(2) where it is slightly solwer, 0.41 sec, surely because NTL is slow :)).

So I propose to close this as duplicate.



---

archive/issue_comments_202983.json:
```json
{
    "body": "**Changing author** from \"Travis Scrimshaw\" to \"\".",
    "created_at": "2013-06-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202983",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

**Changing author** from "Travis Scrimshaw" to "".



---

archive/issue_comments_202984.json:
```json
{
    "body": "<a id='comment:10'></a>\nAgreed. On `5.10.beta5`:\n\n```\nsage: %time L = R(a)\nCPU times: user 0.06 s, sys: 0.00 s, total: 0.07 s\nWall time: 0.07 s\n```",
    "created_at": "2013-06-04T14:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202984",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>
Agreed. On `5.10.beta5`:

```
sage: %time L = R(a)
CPU times: user 0.06 s, sys: 0.00 s, total: 0.07 s
Wall time: 0.07 s
```



---

archive/issue_comments_202985.json:
```json
{
    "body": "**Resolution:** worksforme",
    "created_at": "2013-06-06T12:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13257#issuecomment-202985",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** worksforme



---

archive/issue_events_042653.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-06T12:43:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13257",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13257#event-42653"
}
```
