# Issue 13731: Fix libsingular memory management

archive/issues_013527.json:
```json
{
    "assignees": [],
    "body": "We created a new patchlevel for the singular-3-1-5 spkg. It contains backports of some upstream fixes of several memory corruptions.\n\nIf one does `export SINGULAR_XALLOC=yes` before installing the spkg, Singular's usual memory manager \"omalloc\" will be replaced by \"xalloc\". This is a compatibility layer on top of malloc. The resulting Singular executable and library will be slower, but allows the use of some debug tools.\n\nHere is the background.\n\nWe have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything.\n\nPreliminary packages for linux and for osx using malloc are found here:\n\n* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux). It replaces omalloc by the system malloc and tries to keep the changes small. It does build a libsingular library, but the Singular executable does not work.\n* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX). Same as the previous item.\n\nWith the help from [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus), we managed to use xalloc instead of malloc. We now obtain Singular executable and library, and can still use debugging tools.\n\n**__Install__**\n\n* [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg)\n\nThe spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)(https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\nIt usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. \n\n**__Bugs fixed__**\n\nWith the preliminary [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:\n\n```\n$ export MALLOC_CHECK_ 3\n$ sage\n...\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\n*** glibc detected *** /usr/local/sage/5.5b1/local/bin/python: free(): \n```\ngdb backtrace:\n\n```\n#0  0x00000031cfe36285 in raise () from /lib64/libc.so.6\n#1  0x00000031cfe37b9b in abort () from /lib64/libc.so.6\n#2  0x00000031cfe7774e in __libc_message () from /lib64/libc.so.6\n#3  0x00000031cfe7da76 in malloc_printerr () from /lib64/libc.so.6\n#4  0x00007fffd82d5c34 in gnc_mm_Mult_nn (F0=<optimized out>,\nG0=<optimized out>, r=0x2faa720) at gring.cc:507\n#5  0x00007fffd82d6abc in gnc_p_Mult_mm_Common (p=0x326e8c0,\nm=<optimized out>, side=0, r=0x2faa720) at gring.cc:424\n#6  0x00007fffd76c7860 in nc_mm_Mult_pp (p=0x342aaf0, r=0x2faa720,\nm=0x2fb6530) at /usr/local/sage/5.5b1/local/include/singular/gring.h:\n171\n#7  pp_Mult_qq (r=0x2faa720, q=0x342aaf0, p=0x2fb6530) at /usr/local/\nsage/5.5b1/local/include/singular/pInline2.h:667\n#8  __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul\n(__pyx_v_ret=0x7fffffffb3c8, __pyx_v_p=0x2fb6530, __pyx_v_q=0x342aaf0,\n__pyx_v_r=0x2faa720)\n    at sage/libs/singular/polynomial.cpp:3895\n#9  0x00007fffd7b096f8 in\n__pyx_f_4sage_5rings_10polynomial_6plural_19NCPolynomial_plural__mul_\n(__pyx_v_left=0x7fffbe6bd758, __pyx_v_right=0x7fffbe6bd878,\n__pyx_skip_dispatch=<optimized out>)\n    at sage/rings/polynomial/plural.cpp:12060\n```\nrunning it in valgrind gets you complaints about the same locations.\n\nOn OSX, `MALLOC_CHECK_` is not available. But gmalloc does detect the crash.\n\nThe new spkg fixes that problem\n\n**__Testing__**\n\nMeanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes. With the exeption of one unrelated problem in sage/graphs/, the whole Sage test suite passes on Linux with `export MALLOC_CHECK_=yes`.\n\n\nAssignee: **@rlmill**\n\nCC:  @simon-king-jena @kiwifb @malb\n\nUpstream: **Fixed upstream, in a later stable release.**\n\nReviewer: **Nils Bruin**\n\nAuthor: **Nils Bruin, Simon King**\n\nMerged: **sage-5.6.beta0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13731_\n\n",
    "closed_at": "2012-12-26T16:27:40Z",
    "created_at": "2012-11-20T20:16:43Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20memleak",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix libsingular memory management",
    "type": "issue",
    "updated_at": "2012-12-28T11:37:19Z",
    "url": "https://github.com/sagemath/sage/issues/13731",
    "user": "https://github.com/nbruin"
}
```
We created a new patchlevel for the singular-3-1-5 spkg. It contains backports of some upstream fixes of several memory corruptions.

If one does `export SINGULAR_XALLOC=yes` before installing the spkg, Singular's usual memory manager "omalloc" will be replaced by "xalloc". This is a compatibility layer on top of malloc. The resulting Singular executable and library will be slower, but allows the use of some debug tools.

Here is the background.

We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything.

Preliminary packages for linux and for osx using malloc are found here:

* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux). It replaces omalloc by the system malloc and tries to keep the changes small. It does build a libsingular library, but the Singular executable does not work.
* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX). Same as the previous item.

With the help from [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus), we managed to use xalloc instead of malloc. We now obtain Singular executable and library, and can still use debugging tools.

**__Install__**

* [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg)

The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)(https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. 

**__Bugs fixed__**

With the preliminary [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:

```
$ export MALLOC_CHECK_ 3
$ sage
...
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
*** glibc detected *** /usr/local/sage/5.5b1/local/bin/python: free(): 
```
gdb backtrace:

```
#0  0x00000031cfe36285 in raise () from /lib64/libc.so.6
#1  0x00000031cfe37b9b in abort () from /lib64/libc.so.6
#2  0x00000031cfe7774e in __libc_message () from /lib64/libc.so.6
#3  0x00000031cfe7da76 in malloc_printerr () from /lib64/libc.so.6
#4  0x00007fffd82d5c34 in gnc_mm_Mult_nn (F0=<optimized out>,
G0=<optimized out>, r=0x2faa720) at gring.cc:507
#5  0x00007fffd82d6abc in gnc_p_Mult_mm_Common (p=0x326e8c0,
m=<optimized out>, side=0, r=0x2faa720) at gring.cc:424
#6  0x00007fffd76c7860 in nc_mm_Mult_pp (p=0x342aaf0, r=0x2faa720,
m=0x2fb6530) at /usr/local/sage/5.5b1/local/include/singular/gring.h:
171
#7  pp_Mult_qq (r=0x2faa720, q=0x342aaf0, p=0x2fb6530) at /usr/local/
sage/5.5b1/local/include/singular/pInline2.h:667
#8  __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul
(__pyx_v_ret=0x7fffffffb3c8, __pyx_v_p=0x2fb6530, __pyx_v_q=0x342aaf0,
__pyx_v_r=0x2faa720)
    at sage/libs/singular/polynomial.cpp:3895
#9  0x00007fffd7b096f8 in
__pyx_f_4sage_5rings_10polynomial_6plural_19NCPolynomial_plural__mul_
(__pyx_v_left=0x7fffbe6bd758, __pyx_v_right=0x7fffbe6bd878,
__pyx_skip_dispatch=<optimized out>)
    at sage/rings/polynomial/plural.cpp:12060
```
running it in valgrind gets you complaints about the same locations.

On OSX, `MALLOC_CHECK_` is not available. But gmalloc does detect the crash.

The new spkg fixes that problem

**__Testing__**

Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes. With the exeption of one unrelated problem in sage/graphs/, the whole Sage test suite passes on Linux with `export MALLOC_CHECK_=yes`.


Assignee: **@rlmill**

CC:  @simon-king-jena @kiwifb @malb

Upstream: **Fixed upstream, in a later stable release.**

Reviewer: **Nils Bruin**

Author: **Nils Bruin, Simon King**

Merged: **sage-5.6.beta0**

_Issue created by migration from https://trac.sagemath.org/ticket/13731_





---

archive/issue_events_170307.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-11-20T20:16:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170307"
}
```



---

archive/issue_events_170308.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-11-20T20:16:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20memleak",
    "label_color": "000080",
    "label_name": "component: memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170308"
}
```



---

archive/issue_events_170309.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-11-20T20:16:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170309"
}
```



---

archive/issue_events_170310.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-11-20T20:16:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170310"
}
```



---

archive/issue_comments_163816.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nSee also #13447 for previous uses of libsingular-malloc, as well as \n[this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/86040baea9c27b20?hl=en)",
    "created_at": "2012-11-20T20:23:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163816",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'>Comment 1:</a>
See also #13447 for previous uses of libsingular-malloc, as well as 
[this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/86040baea9c27b20?hl=en)



---

archive/issue_comments_163817.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nWe can also use ElectricFence as a malloc substitute:\n\n```\n$ export LD_PRELOAD=libefence.so\n$ export EF_ALLOW_MALLOC_0=1     #apparently sage/python does a malloc(0) somewhere\n$ echo 512000 | sudo tee /proc/sys/vm/max_map_count #efence uses mprotect A LOT\n$ ./sage -t --gdb devel/sage/sage/libs/singular/function.pyx \n```\nThis gives an error in a different location. Traceback:\n\n```\n#0  0x00007fffce9fb3f2 in List<CanonicalForm>::isEmpty(this=0x7fffa515b000) at ./templates/ftmpl_list.cc:256\n#1  0x00007fffce96a350 in multiFactorize (F=..., v=...) at facFactorize.cc:710\n#2  0x00007fffce905e9d in ratSqrfFactorize (v=..., G=...) at facFactorize.h:45\n#3  ratFactorize (G=..., v=..., substCheck=<optimized out>) at facFactorize.h:125\n#4  0x00007fffce90303c in factorize (f=..., issqrfree=false) at cf_factor.cc:651\n#5  0x00007fffce7a5b44 in singclap_factorize (f=0x7fff9e16dfd0, v=0x7fffffffb548, with_exps=0) at clapsing.cc:835\n#6  0x00007fffce720d50 in jjFAC_P (res=0x7fff9e16ffc0, u=0x7fff9ea7afc0) at iparith.cc:3995\n#7  0x00007fffce729c42 in iiExprArith1 (res=0x7fff9e16ffc0, a=0x7fff9ea7afc0, op=424) at iparith.cc:7869\n#8  0x00007fffce12df55 in __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call(__pyx_v_self=0x7fff9e967b48, __pyx_v_argument_list=0x7fff9e975b40, __pyx_optional_args=<optimized out>) at sage/lib/singular/function.cpp:11286 \n```\nAll these error point in the same direction, though: As soon as we start interacting with the singular *interpreter* we get exposed to whatever memory management it does and we're in big trouble. Use of libsingular on more basic levels usually doesn't expose us to libsingular memory management, so no problems arise.",
    "created_at": "2012-11-20T20:29:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163817",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'>Comment 2:</a>
We can also use ElectricFence as a malloc substitute:

```
$ export LD_PRELOAD=libefence.so
$ export EF_ALLOW_MALLOC_0=1     #apparently sage/python does a malloc(0) somewhere
$ echo 512000 | sudo tee /proc/sys/vm/max_map_count #efence uses mprotect A LOT
$ ./sage -t --gdb devel/sage/sage/libs/singular/function.pyx 
```
This gives an error in a different location. Traceback:

```
#0  0x00007fffce9fb3f2 in List<CanonicalForm>::isEmpty(this=0x7fffa515b000) at ./templates/ftmpl_list.cc:256
#1  0x00007fffce96a350 in multiFactorize (F=..., v=...) at facFactorize.cc:710
#2  0x00007fffce905e9d in ratSqrfFactorize (v=..., G=...) at facFactorize.h:45
#3  ratFactorize (G=..., v=..., substCheck=<optimized out>) at facFactorize.h:125
#4  0x00007fffce90303c in factorize (f=..., issqrfree=false) at cf_factor.cc:651
#5  0x00007fffce7a5b44 in singclap_factorize (f=0x7fff9e16dfd0, v=0x7fffffffb548, with_exps=0) at clapsing.cc:835
#6  0x00007fffce720d50 in jjFAC_P (res=0x7fff9e16ffc0, u=0x7fff9ea7afc0) at iparith.cc:3995
#7  0x00007fffce729c42 in iiExprArith1 (res=0x7fff9e16ffc0, a=0x7fff9ea7afc0, op=424) at iparith.cc:7869
#8  0x00007fffce12df55 in __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call(__pyx_v_self=0x7fff9e967b48, __pyx_v_argument_list=0x7fff9e975b40, __pyx_optional_args=<optimized out>) at sage/lib/singular/function.cpp:11286 
```
All these error point in the same direction, though: As soon as we start interacting with the singular *interpreter* we get exposed to whatever memory management it does and we're in big trouble. Use of libsingular on more basic levels usually doesn't expose us to libsingular memory management, so no problems arise.



---

archive/issue_comments_163818.json:
```json
{
    "body": "\n```\n$ export MALLOC_CHECK_ 3\n$ sage ... sage: A.<x,y> = FreeAlgebra (QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y ***\nglibc detected *** /usr/local/sage/5.5b1/local/bin/python: free():\n```\n\nI do not see this in my current sagemath-5.4 rpm package, but I suspect it may have been either corrected or worked around by one of the patches at http://pkgs.fedoraproject.org/cgit/Singular.git/tree most likely `Singular-undefined.patch`, but the padding added by `Singular-M2_memutil_debuggging.patch` may be actually hiding some problem. Or, it may be something different, the singular rpm was known to not build properly or generate proper binaries if an older singular was installed but I did not care much about that because official rpms are built in a *clean* chroot.",
    "created_at": "2012-11-21T00:49:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163818",
    "user": "https://github.com/sagetrac-pcpa"
}
```


```
$ export MALLOC_CHECK_ 3
$ sage ... sage: A.<x,y> = FreeAlgebra (QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y ***
glibc detected *** /usr/local/sage/5.5b1/local/bin/python: free():
```

I do not see this in my current sagemath-5.4 rpm package, but I suspect it may have been either corrected or worked around by one of the patches at http://pkgs.fedoraproject.org/cgit/Singular.git/tree most likely `Singular-undefined.patch`, but the padding added by `Singular-M2_memutil_debuggging.patch` may be actually hiding some problem. Or, it may be something different, the singular rpm was known to not build properly or generate proper binaries if an older singular was installed but I did not care much about that because official rpms are built in a *clean* chroot.



---

archive/issue_comments_163819.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [pcpa](#comment%3A4):\n> I do not see this in my current sagemath-5.4 rpm package\n\nThanks for checking!\n\nAre you sure your singular gets built to use the glibc malloc for all small allocations and not omalloc on \"malloc\"-ed pages? You may try setting `EXTRA=0` to remove the padding. I don't expect that padding comes into play, though. I suspect a double free or a free on a pointer that doesn't point to a malloc-ed block to begin with.",
    "created_at": "2012-11-21T01:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163819",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [pcpa](#comment%3A4):
> I do not see this in my current sagemath-5.4 rpm package

Thanks for checking!

Are you sure your singular gets built to use the glibc malloc for all small allocations and not omalloc on "malloc"-ed pages? You may try setting `EXTRA=0` to remove the padding. I don't expect that padding comes into play, though. I suspect a double free or a free on a pointer that doesn't point to a malloc-ed block to begin with.



---

archive/issue_comments_163820.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@nbruin](#comment%3A5):\n> Replying to [pcpa](#comment%3A4):\n> > I do not see this in my current sagemath-5.4 rpm package\n\n> Thanks for checking!\n> \n> Are you sure your singular gets built to use the glibc malloc for all small allocations and not omalloc on \"malloc\"-ed pages? You may try setting `EXTRA=0` to remove the padding. I don't expect that padding comes into play, though. I suspect a double free or a free on a pointer that doesn't point to a malloc-ed block to begin with.\n\n  Sorry, I completely misunderstood what was mean't by the spkg and the '--with-emulate-omalloc' option. I will try to debug more later, but I cannot build the Singular rpm with that option as it always fails in the kernel subdirectory due to missing omEmulate* declarations.",
    "created_at": "2012-11-21T03:58:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163820",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@nbruin](#comment%3A5):
> Replying to [pcpa](#comment%3A4):
> > I do not see this in my current sagemath-5.4 rpm package

> Thanks for checking!
> 
> Are you sure your singular gets built to use the glibc malloc for all small allocations and not omalloc on "malloc"-ed pages? You may try setting `EXTRA=0` to remove the padding. I don't expect that padding comes into play, though. I suspect a double free or a free on a pointer that doesn't point to a malloc-ed block to begin with.

  Sorry, I completely misunderstood what was mean't by the spkg and the '--with-emulate-omalloc' option. I will try to debug more later, but I cannot build the Singular rpm with that option as it always fails in the kernel subdirectory due to missing omEmulate* declarations.



---

archive/issue_comments_163821.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\n>   Sorry, I completely misunderstood what was mean't by the spkg and the '--with-emulate-omalloc' option. I will try to debug more later, but I cannot build the Singular rpm with that option as it always fails in the kernel subdirectory due to missing omEmulate* declarations.\n\nYes, my edits in the linked-to singular spkgs add declarations to make those errors go away. I didn't exactly respect the rest of build options in the process, though (because I didn't understand them). Cleaning that up to a well-defined patch to the singular package would be a great help.",
    "created_at": "2012-11-21T06:12:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163821",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'>Comment 7:</a>
>   Sorry, I completely misunderstood what was mean't by the spkg and the '--with-emulate-omalloc' option. I will try to debug more later, but I cannot build the Singular rpm with that option as it always fails in the kernel subdirectory due to missing omEmulate* declarations.

Yes, my edits in the linked-to singular spkgs add declarations to make those errors go away. I didn't exactly respect the rest of build options in the process, though (because I didn't understand them). Cleaning that up to a well-defined patch to the singular package would be a great help.



---

archive/issue_comments_163822.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nI am trying to build Sage-5.5.rc0 with the malloc singular spkg for linux. Platform: `openSuse` 12.1, on Intel Core2 Duo.\n\nWhat I tried: Untar the sage tarball, replace the usual Singular spkg with yours, and type make. \nSingular fails to build, because of\n\n```\ng++ -O2 -I. -I.. -I/home/simon/SAGE/debug/sage-5.5.rc0/local -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include  -I/usr/local/include  -DNDEBUG -DOM_NDEBUG -Dx86_64_Linux -DHAVE_CONFIG_H -DESINGULAR -DPROTO -o ESingular emacs.cc ../kernel/fegetopt.o \\\n-rdynamic -L/home/simon/SAGE/debug/sage-5.5.rc0/local/kernel -L../kernel -lkernel -L/home/simon/SAGE/debug/sage-5.5.rc0/local/lib -L/home/simon/SAGE/debug/sage-5.5.rc0/local/lib  -L/usr/local/lib  -ldl -lm -lsingfac -lsingcf -lntl -lgmp -lreadline -lncurses -lnsl -lm  -lnsl -lbsd  -lomalloc -lpthread  ../kernel/mmalloc.o\n/usr/lib64/gcc/x86_64-suse-linux/4.6/../../../../x86_64-suse-linux/bin/ld: cannot find -lbsd\n```\n\nCould it be that it is a problem with `SAGE_ROOT/local/lib` versus `SAGE_ROOT/local/lib64`? That used sometimes to be a problem with `openSuse`.",
    "created_at": "2012-11-21T10:54:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163822",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'>Comment 8:</a>
I am trying to build Sage-5.5.rc0 with the malloc singular spkg for linux. Platform: `openSuse` 12.1, on Intel Core2 Duo.

What I tried: Untar the sage tarball, replace the usual Singular spkg with yours, and type make. 
Singular fails to build, because of

```
g++ -O2 -I. -I.. -I/home/simon/SAGE/debug/sage-5.5.rc0/local -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include  -I/usr/local/include  -DNDEBUG -DOM_NDEBUG -Dx86_64_Linux -DHAVE_CONFIG_H -DESINGULAR -DPROTO -o ESingular emacs.cc ../kernel/fegetopt.o \
-rdynamic -L/home/simon/SAGE/debug/sage-5.5.rc0/local/kernel -L../kernel -lkernel -L/home/simon/SAGE/debug/sage-5.5.rc0/local/lib -L/home/simon/SAGE/debug/sage-5.5.rc0/local/lib  -L/usr/local/lib  -ldl -lm -lsingfac -lsingcf -lntl -lgmp -lreadline -lncurses -lnsl -lm  -lnsl -lbsd  -lomalloc -lpthread  ../kernel/mmalloc.o
/usr/lib64/gcc/x86_64-suse-linux/4.6/../../../../x86_64-suse-linux/bin/ld: cannot find -lbsd
```

Could it be that it is a problem with `SAGE_ROOT/local/lib` versus `SAGE_ROOT/local/lib64`? That used sometimes to be a problem with `openSuse`.



---

archive/issue_comments_163823.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nNo, libdir is used in spkg-install. But I wonder: The original Singular spkg contains three Makefiles: in dyn_modules/python, in calldummy/ and in omalloc/Misc/dlmalloc. But the malloc Singular package from here contains 14 Makefiles. Could it be that some of them should better be created by `./configure`?",
    "created_at": "2012-11-21T12:59:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163823",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'>Comment 9:</a>
No, libdir is used in spkg-install. But I wonder: The original Singular spkg contains three Makefiles: in dyn_modules/python, in calldummy/ and in omalloc/Misc/dlmalloc. But the malloc Singular package from here contains 14 Makefiles. Could it be that some of them should better be created by `./configure`?



---

archive/issue_comments_163824.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nThe spkg also contains several files created by configure scripts. Is that really intended?",
    "created_at": "2012-11-21T13:48:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163824",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'>Comment 10:</a>
The spkg also contains several files created by configure scripts. Is that really intended?



---

archive/issue_comments_163825.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nWhen I removed all autogenerated files from your spkg, installing singular-3-1-5.malloc-linux succeeded!\n\nI guess you are aware that one is supposed to leave the Singular source files untouched when creating an spkg - after all, Singular-malloc is for testing only.",
    "created_at": "2012-11-21T14:29:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163825",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'>Comment 11:</a>
When I removed all autogenerated files from your spkg, installing singular-3-1-5.malloc-linux succeeded!

I guess you are aware that one is supposed to leave the Singular source files untouched when creating an spkg - after all, Singular-malloc is for testing only.



---

archive/issue_comments_163826.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nBuilding sage-5.5.rc0 did *almost* succeed.\n\n```\n...\ngcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include/singular/ -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include/csage -I/home/simon/SAGE/debug/sage-5.5.rc0/devel/sage/sage/ext -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include/python2.7 -c sage/algebras/letterplace/free_algebra_element_letterplace.cpp -o build/temp.linux-x86_64-2.7/sage/algebras/letterplace/free_algebra_element_letterplace.o -w\ncc1plus: warning: command line option \u2018-Wstrict-prototypes\u2019 is valid for Ada/C/ObjC but not for C++ [enabled by default]\ncc1plus: warning: command line option \u2018-Wstrict-prototypes\u2019 is valid for Ada/C/ObjC but not for C++ [enabled by default]\nIn file included from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/singular/structs.h:13:0,\n                 from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/libsingular.h:6,\n                 from sage/algebras/letterplace/free_algebra_element_letterplace.cpp:283:\n/home/simon/SAGE/debug/sage-5.5.rc0/local/include/omalloc.h:784:30: fatal error: omalloc/omMalloc.h: Datei oder Verzeichnis nicht gefundenIn file included from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/singular/structs.h:13:0,\n                 from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/libsingular.h:6,\n                 from sage/algebras/letterplace/free_algebra_letterplace.cpp:283:\n/home/simon/SAGE/debug/sage-5.5.rc0/local/include/omalloc.h:784:30: fatal error: omalloc/omMalloc.h: Datei oder Verzeichnis nicht gefunden\ncompilation terminated.\n```\n\nSo, that looks like coming from Plural.\n\nOn the other hand, your example in the ticket description does use plural.\n\nWhat went wrong here? I did erase src/omalloc/omMalloc.h from your spkg, since it is not part of the \"original\" Singular spkg (hence, I thought it was autogenerated).",
    "created_at": "2012-11-21T15:28:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163826",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'>Comment 12:</a>
Building sage-5.5.rc0 did *almost* succeed.

```
...
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include/singular/ -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include/csage -I/home/simon/SAGE/debug/sage-5.5.rc0/devel/sage/sage/ext -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include/python2.7 -c sage/algebras/letterplace/free_algebra_element_letterplace.cpp -o build/temp.linux-x86_64-2.7/sage/algebras/letterplace/free_algebra_element_letterplace.o -w
cc1plus: warning: command line option ‘-Wstrict-prototypes’ is valid for Ada/C/ObjC but not for C++ [enabled by default]
cc1plus: warning: command line option ‘-Wstrict-prototypes’ is valid for Ada/C/ObjC but not for C++ [enabled by default]
In file included from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/singular/structs.h:13:0,
                 from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/libsingular.h:6,
                 from sage/algebras/letterplace/free_algebra_element_letterplace.cpp:283:
/home/simon/SAGE/debug/sage-5.5.rc0/local/include/omalloc.h:784:30: fatal error: omalloc/omMalloc.h: Datei oder Verzeichnis nicht gefundenIn file included from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/singular/structs.h:13:0,
                 from /home/simon/SAGE/debug/sage-5.5.rc0/local/include/libsingular.h:6,
                 from sage/algebras/letterplace/free_algebra_letterplace.cpp:283:
/home/simon/SAGE/debug/sage-5.5.rc0/local/include/omalloc.h:784:30: fatal error: omalloc/omMalloc.h: Datei oder Verzeichnis nicht gefunden
compilation terminated.
```

So, that looks like coming from Plural.

On the other hand, your example in the ticket description does use plural.

What went wrong here? I did erase src/omalloc/omMalloc.h from your spkg, since it is not part of the "original" Singular spkg (hence, I thought it was autogenerated).



---

archive/issue_comments_163827.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nPS: Here is a part of the install log for singular-malloc:\n\n```\nupdating cache .././config.cache\ncreating ./config.status\ncreating Makefile\ncreating omConfig.h\ncreating omlimits.h\ncreating omMalloc.h\nconfiguring in factory\nrunning /bin/sh ./configure  --prefix=/home/simon/SAGE/debug/sage-5.5.rc0/local --exec-prefix=/home/simon/SAGE/debug/sage-5.5.rc0/local --bindir=/home/simon/SAGE/debug/sage-5.5.rc0/local/bin --libdir=/home/simon/SAGE/debug/sage-5.5.rc0/local/lib --with-apint=gmp --with-malloc=system --with-emulate-omalloc --with-NTL --without-MP --without-lex --without-Boost --without-flint --enable-Singular --enable-factory --enable-libfac --enable-IntegerProgramming --disable-doc --with-debug --includedir=/home/simon/SAGE/debug/sage-5.5.rc0/local/include --enable-omalloc --with-external-config_h='/home/simon/SAGE/debug/sage-5.5.rc0/spkg/build/singular-3-1-5.malloc-linux/src/Singular/omSingularConfig.h' --with-track-custom --enable-Plural --with-factory --with-libfac --with-Singular=yes --cache-file=.././config.cache --srcdir=.\n```\nSo, the missing header actually is created.\n\nAlso, I don't understand why `omMalloc.h` is needed: In a previous Sage installation with the standard Singular 3-1-5 package, I can't find `omMalloc.h` in `SAGE_ROOT/local/...`.",
    "created_at": "2012-11-21T15:34:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163827",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'>Comment 13:</a>
PS: Here is a part of the install log for singular-malloc:

```
updating cache .././config.cache
creating ./config.status
creating Makefile
creating omConfig.h
creating omlimits.h
creating omMalloc.h
configuring in factory
running /bin/sh ./configure  --prefix=/home/simon/SAGE/debug/sage-5.5.rc0/local --exec-prefix=/home/simon/SAGE/debug/sage-5.5.rc0/local --bindir=/home/simon/SAGE/debug/sage-5.5.rc0/local/bin --libdir=/home/simon/SAGE/debug/sage-5.5.rc0/local/lib --with-apint=gmp --with-malloc=system --with-emulate-omalloc --with-NTL --without-MP --without-lex --without-Boost --without-flint --enable-Singular --enable-factory --enable-libfac --enable-IntegerProgramming --disable-doc --with-debug --includedir=/home/simon/SAGE/debug/sage-5.5.rc0/local/include --enable-omalloc --with-external-config_h='/home/simon/SAGE/debug/sage-5.5.rc0/spkg/build/singular-3-1-5.malloc-linux/src/Singular/omSingularConfig.h' --with-track-custom --enable-Plural --with-factory --with-libfac --with-Singular=yes --cache-file=.././config.cache --srcdir=.
```
So, the missing header actually is created.

Also, I don't understand why `omMalloc.h` is needed: In a previous Sage installation with the standard Singular 3-1-5 package, I can't find `omMalloc.h` in `SAGE_ROOT/local/...`.



---

archive/issue_comments_163828.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@simon-king-jena](#comment%3A13):\n> So, the missing header is actually is created.\n\nYes, indeed, and that is the one I copy over manually because I didn't figure out how to do it in the install script (that should be straightforward though)\n \n> Also, I don't understand why `omMalloc.h` is needed: In a previous Sage installation with the standard Singular 3-1-5 package, I can't find `omMalloc.h` in `SAGE_ROOT/local/...`.\n\nIt might not be. The reason why it is needed now is because of the rough way I mutilated the omalloc source in Singular. Its configuration process is a big tangle of pasting together header files, so when I finally found a way to effect the desired changes I was already happy. That involved knocking out some `#ifdef ... #endif` preprocessor directives in the source. I'm sure it's straightforward to fix that a little more nicely (I wasn't aiming for production code at the time, just a quick tool to debug stuff). That activated a `#include <omalloc/omAlloc.h>` as well.\nI don't know if errors happen if you delete that line.\nAnyway, the `libsingular*.pyx` files import the header file in which that include ends up, so that's why presently, that file needs to be in the include paths used by `sage -b`.\n\nI wasn't exaggerating when I called the package rather untidy ...",
    "created_at": "2012-11-21T17:05:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163828",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@simon-king-jena](#comment%3A13):
> So, the missing header is actually is created.

Yes, indeed, and that is the one I copy over manually because I didn't figure out how to do it in the install script (that should be straightforward though)
 
> Also, I don't understand why `omMalloc.h` is needed: In a previous Sage installation with the standard Singular 3-1-5 package, I can't find `omMalloc.h` in `SAGE_ROOT/local/...`.

It might not be. The reason why it is needed now is because of the rough way I mutilated the omalloc source in Singular. Its configuration process is a big tangle of pasting together header files, so when I finally found a way to effect the desired changes I was already happy. That involved knocking out some `#ifdef ... #endif` preprocessor directives in the source. I'm sure it's straightforward to fix that a little more nicely (I wasn't aiming for production code at the time, just a quick tool to debug stuff). That activated a `#include <omalloc/omAlloc.h>` as well.
I don't know if errors happen if you delete that line.
Anyway, the `libsingular*.pyx` files import the header file in which that include ends up, so that's why presently, that file needs to be in the include paths used by `sage -b`.

I wasn't exaggerating when I called the package rather untidy ...



---

archive/issue_comments_163829.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nI managed to build Sage with Singular-malloc. What I did to make it work:\n\n* open the spkg\n* remove all autogenerated files\n* change src/omalloc/Makefile.in so that the freshly built `omMalloc.h` is installed in `$(includedir)/omalloc` (creating that directory first)\n\nApparently the singular executable is not usable (when I try to start it, it simply seems to hang).\n\nI can reproduce the crash from the ticket description:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage\n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\n*** glibc detected *** python: free(): invalid pointer: 0x0000000002806c90 ***\n======= Backtrace: =========\n/lib64/libc.so.6(+0x766d6)[0x7fa9ed9cc6d6]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z14gnc_mm_Mult_nnPiS_P9sip_sring+0x294)[0x7fa9d35c7c54]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z20gnc_p_Mult_mm_CommonP8spolyrecS0_iP9sip_sring+0x1ec)[0x7fa9d35c8acc]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/libs/singular/polynomial.so(+0x4bd0)[0x7fa9d29a9bd0]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0x1fbd8)[0x7fa9d2deebd8]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/structure/element.so(+0x2a399)[0x7fa9e4bed399]\n...\n```\n\nSo, that's a good platform to try to hunt the Heisenbugs from #12215, #715 and friends once and for all.",
    "created_at": "2012-11-22T08:01:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163829",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'>Comment 16:</a>
I managed to build Sage with Singular-malloc. What I did to make it work:

* open the spkg
* remove all autogenerated files
* change src/omalloc/Makefile.in so that the freshly built `omMalloc.h` is installed in `$(includedir)/omalloc` (creating that directory first)

Apparently the singular executable is not usable (when I try to start it, it simply seems to hang).

I can reproduce the crash from the ticket description:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
*** glibc detected *** python: free(): invalid pointer: 0x0000000002806c90 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x766d6)[0x7fa9ed9cc6d6]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z14gnc_mm_Mult_nnPiS_P9sip_sring+0x294)[0x7fa9d35c7c54]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z20gnc_p_Mult_mm_CommonP8spolyrecS0_iP9sip_sring+0x1ec)[0x7fa9d35c8acc]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/libs/singular/polynomial.so(+0x4bd0)[0x7fa9d29a9bd0]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0x1fbd8)[0x7fa9d2deebd8]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/structure/element.so(+0x2a399)[0x7fa9e4bed399]
...
```

So, that's a good platform to try to hunt the Heisenbugs from #12215, #715 and friends once and for all.



---

archive/issue_comments_163830.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nHow do I make it create a core dump, and how do I open it with gdb? I recall something with \"ulimit -c\", but I can't recall the details...\n\n`sage -gdb` does not work, by the way:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage -gdb\n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\n/home/simon/SAGE/debug/sage-5.5.rc0/local/bin/sage-ipython\nGNU gdb (GDB) SUSE (7.3-41.1.2)\nCopyright (C) 2011 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-suse-linux\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /home/simon/SAGE/debug/sage-5.5.rc0/local/bin/python...done.\n[Thread debugging using libthread_db enabled]\nPython 2.7.3 (default, Nov 21 2012, 11:21:15) \n[GCC 4.6.2] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n---------------------------------------------------------------------------\nImportError                               Traceback (most recent call last)\n\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/IPython/ipmaker.pyc in force_import(modname, force_reload)\n     61         reload(sys.modules[modname])\n     62     else:\n---> 63         __import__(modname)\n     64         \n     65 \n\nImportError: No module named ipy_profile_sage\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\n------------------------------------------------------------\n   File \"<ipython console>\", line 1\n     A.<x,y> = FreeAlgebra(QQ, 2)\n       ^\nSyntaxError: invalid syntax\n```",
    "created_at": "2012-11-22T08:05:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163830",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'>Comment 17:</a>
How do I make it create a core dump, and how do I open it with gdb? I recall something with "ulimit -c", but I can't recall the details...

`sage -gdb` does not work, by the way:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage -gdb
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
/home/simon/SAGE/debug/sage-5.5.rc0/local/bin/sage-ipython
GNU gdb (GDB) SUSE (7.3-41.1.2)
Copyright (C) 2011 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-suse-linux".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /home/simon/SAGE/debug/sage-5.5.rc0/local/bin/python...done.
[Thread debugging using libthread_db enabled]
Python 2.7.3 (default, Nov 21 2012, 11:21:15) 
[GCC 4.6.2] on linux2
Type "help", "copyright", "credits" or "license" for more information.
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)

/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/IPython/ipmaker.pyc in force_import(modname, force_reload)
     61         reload(sys.modules[modname])
     62     else:
---> 63         __import__(modname)
     64         
     65 

ImportError: No module named ipy_profile_sage
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.

sage: A.<x,y> = FreeAlgebra(QQ, 2)
------------------------------------------------------------
   File "<ipython console>", line 1
     A.<x,y> = FreeAlgebra(QQ, 2)
       ^
SyntaxError: invalid syntax
```



---

archive/issue_comments_163831.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nReplying to [@simon-king-jena](#comment%3A17):\n> How do I make it create a core dump, and how do I open it with gdb? I recall something with \"ulimit -c\", but I can't recall the details...\n\nI'd guess `ulimit -c unlimited`.\n\n> `sage -gdb` does not work, by the way:\n\nYes, I had the same problem (and it's not singular-malloc's fault). It seems to be a bad interaction between ipython and gdb. `sage -t -gdb` does work, so I've just worked around it by wrapping it in a little test file:\n`tester.py`:\n\n```\ndef t():\n    r\"\"\"\n    sage: A.<x,y> = FreeAlgebra(QQ, 2)\n    sage: P.<x,y> = A.g_algebra({y*x:-x*y})\n    sage: x*y\n    \"\"\"\n    pass\n```\nCongratulations on getting my franken-spkg to build ...",
    "created_at": "2012-11-22T09:28:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163831",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:18'>Comment 18:</a>
Replying to [@simon-king-jena](#comment%3A17):
> How do I make it create a core dump, and how do I open it with gdb? I recall something with "ulimit -c", but I can't recall the details...

I'd guess `ulimit -c unlimited`.

> `sage -gdb` does not work, by the way:

Yes, I had the same problem (and it's not singular-malloc's fault). It seems to be a bad interaction between ipython and gdb. `sage -t -gdb` does work, so I've just worked around it by wrapping it in a little test file:
`tester.py`:

```
def t():
    r"""
    sage: A.<x,y> = FreeAlgebra(QQ, 2)
    sage: P.<x,y> = A.g_algebra({y*x:-x*y})
    sage: x*y
    """
    pass
```
Congratulations on getting my franken-spkg to build ...



---

archive/issue_comments_163832.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@nbruin](#comment%3A18):\n> Replying to [@simon-king-jena](#comment%3A17):\n> > How do I make it create a core dump, and how do I open it with gdb? I recall something with \"ulimit -c\", but I can't recall the details...\n\n> \n> I'd guess `ulimit -c unlimited`.\n\nThanks!\n\nAnd then, it is `gdb -c <name_of_core_dump>`, right?",
    "created_at": "2012-11-22T09:53:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163832",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@nbruin](#comment%3A18):
> Replying to [@simon-king-jena](#comment%3A17):
> > How do I make it create a core dump, and how do I open it with gdb? I recall something with "ulimit -c", but I can't recall the details...

> 
> I'd guess `ulimit -c unlimited`.

Thanks!

And then, it is `gdb -c <name_of_core_dump>`, right?



---

archive/issue_comments_163833.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nBy the way, what is the ultimate aim of this ticket? Replacing Singular's memory management by malloc makes Singular very slow, if I understand correctly. So, the aim is to provide a tool to investigate flaws in Sage-Singular interrelation, right?\n\nSo, could one say that the aim is to provide an optional package?",
    "created_at": "2012-11-22T10:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163833",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'>Comment 20:</a>
By the way, what is the ultimate aim of this ticket? Replacing Singular's memory management by malloc makes Singular very slow, if I understand correctly. So, the aim is to provide a tool to investigate flaws in Sage-Singular interrelation, right?

So, could one say that the aim is to provide an optional package?



---

archive/issue_comments_163834.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nFirst observation: The crash has nothing to do with coercion.\n\n```\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x._mul_(y)\n*** glibc detected *** python: free(): invalid pointer: 0x0000000002dd86c0 ***\n```\nThat's a good news, because the absence of coercion makes life *a lot* easier...",
    "created_at": "2012-11-22T10:46:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163834",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'>Comment 21:</a>
First observation: The crash has nothing to do with coercion.

```
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x._mul_(y)
*** glibc detected *** python: free(): invalid pointer: 0x0000000002dd86c0 ***
```
That's a good news, because the absence of coercion makes life *a lot* easier...



---

archive/issue_comments_163835.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nNow the bad news: By inserting print statements into the `_mul_` method, I found that the crash occurs in the line\n\n```\n        singular_polynomial_mul(&_p, left._poly,\n                                 (<NCPolynomial_plural>right)._poly,\n                                 (<NCPolynomialRing_plural>left._parent)._ring)\n```\nI was somehow hoping that it would happen in the `new_NCP` function.",
    "created_at": "2012-11-22T10:49:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163835",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'>Comment 22:</a>
Now the bad news: By inserting print statements into the `_mul_` method, I found that the crash occurs in the line

```
        singular_polynomial_mul(&_p, left._poly,
                                 (<NCPolynomial_plural>right)._poly,
                                 (<NCPolynomialRing_plural>left._parent)._ring)
```
I was somehow hoping that it would happen in the `new_NCP` function.



---

archive/issue_comments_163836.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nNews become worse: The crash happens in `pp_Mult_qq`, so that I start to believe it might be an upstream problem.",
    "created_at": "2012-11-22T10:56:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163836",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'>Comment 23:</a>
News become worse: The crash happens in `pp_Mult_qq`, so that I start to believe it might be an upstream problem.



---

archive/issue_comments_163837.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nThe `pp_Mult_qq` function has three arguments: Two pointers p,q to polynomials, and a pointer r to a ring.\n\nWhen I tested, the hex address of the polynomials resp. the ring being pointed at were\n\n```\np = 0x2dd3e10\nq = 0x2dd38a0\nr = 0x2dfa7e0\n```\nBut I can't relate these figures to the address reported by the backtrace:\n\n```\n*** glibc detected *** python: free(): invalid pointer: 0x0000000002bb4ee0 ***\n```\n\nDo you have an idea how this can be interpreted?",
    "created_at": "2012-11-22T11:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163837",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'>Comment 24:</a>
The `pp_Mult_qq` function has three arguments: Two pointers p,q to polynomials, and a pointer r to a ring.

When I tested, the hex address of the polynomials resp. the ring being pointed at were

```
p = 0x2dd3e10
q = 0x2dd38a0
r = 0x2dfa7e0
```
But I can't relate these figures to the address reported by the backtrace:

```
*** glibc detected *** python: free(): invalid pointer: 0x0000000002bb4ee0 ***
```

Do you have an idea how this can be interpreted?



---

archive/issue_comments_163838.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nLooking into the upstream sources and trying to find what the gdb backtrace is telling, I see in line 667 of `pInline2.h`:\n\n```\nPINLINE2 poly pp_Mult_qq(poly p, poly q, const ring r)\n{\n  poly last;\n  if (p == NULL || q == NULL) return NULL;\n\n  if (pNext(p) == NULL)\n  {\n#ifdef HAVE_PLURAL\n    if (rIsPluralRing(r))\n      return nc_mm_Mult_pp(p, q, r);\n#endif\n    return r->p_Procs->pp_Mult_mm(q, p, r, last);\n  }\n```\nand line 667 is `return nc_mm_Mult_pp(p, q, r)`. That function is defined in `gring.h` (why in a *header* file, by the way?). I find no indication of \"free\" being used there, except that it calls `r->GetNC()->p_Procs.mm_Mult_pp(...)`, and I have no idea where that method is being defined.\n\nSo, I'll ask upstream.",
    "created_at": "2012-11-22T11:28:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163838",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'>Comment 25:</a>
Looking into the upstream sources and trying to find what the gdb backtrace is telling, I see in line 667 of `pInline2.h`:

```
PINLINE2 poly pp_Mult_qq(poly p, poly q, const ring r)
{
  poly last;
  if (p == NULL || q == NULL) return NULL;

  if (pNext(p) == NULL)
  {
#ifdef HAVE_PLURAL
    if (rIsPluralRing(r))
      return nc_mm_Mult_pp(p, q, r);
#endif
    return r->p_Procs->pp_Mult_mm(q, p, r, last);
  }
```
and line 667 is `return nc_mm_Mult_pp(p, q, r)`. That function is defined in `gring.h` (why in a *header* file, by the way?). I find no indication of "free" being used there, except that it calls `r->GetNC()->p_Procs.mm_Mult_pp(...)`, and I have no idea where that method is being defined.

So, I'll ask upstream.



---

archive/issue_comments_163839.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nI should have read your backtrace more carefully. It mentions `gnc_mm_Mult_nn`, and that's what I am analysing now. A shame that one needs to recompile so many things for testing it...",
    "created_at": "2012-11-22T14:46:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163839",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:26'>Comment 26:</a>
I should have read your backtrace more carefully. It mentions `gnc_mm_Mult_nn`, and that's what I am analysing now. A shame that one needs to recompile so many things for testing it...



---

archive/issue_comments_163840.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nOK, the error occurs in the function `poly gnc_mm_Mult_nn(int *F0, int *G0, const ring r)`, whose definition in `kernel/gring.cc` starts at line 463.\n\nI inserted some print statements, and found the crash occurs in this chunk of code:\n\n```\n  if (iF<=jG)\n    /* i.e. no mixed exp_num , MERGE case */\n  {\n    p_MemAdd_LengthGeneral(F, G, ExpSize/sizeof(long));\n    p_SetExpV(out,F,r);\n    p_Setm(out,r);\n    //    omFreeSize((ADDRESS)F,ExpSize);\n    printf(\"second freeT F,rN\\n\");\n    freeT(F,rN);\n    printf(\"second freeT G,rN\\n\");\n    freeT(G,rN);\n    printf(\"second return out\\n\");\n    return(out);\n  }\n```\nThe last line printed is `second freeT F,rN`. Hence, F seems to be corrupted. Here is ho F is created:\n\n```\n  int *F=(int *)omAlloc0((rN+1)*sizeof(int));\n  int *G=(int *)omAlloc0((rN+1)*sizeof(int));\n\n  memcpy(F, F0,(rN+1)*sizeof(int));\n  // pExpVectorCopy(F,F0);\n  memcpy(G, G0,(rN+1)*sizeof(int));\n  //  pExpVectorCopy(G,G0);\n  F[0]=0; /* important for p_MemAdd */\n  G[0]=0;\n```\n\nIs it a problem that `omAlloc0` is explicitly called? Or is it just a macro, and actually defaults to malloc with your spkg?",
    "created_at": "2012-11-22T15:24:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163840",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'>Comment 27:</a>
OK, the error occurs in the function `poly gnc_mm_Mult_nn(int *F0, int *G0, const ring r)`, whose definition in `kernel/gring.cc` starts at line 463.

I inserted some print statements, and found the crash occurs in this chunk of code:

```
  if (iF<=jG)
    /* i.e. no mixed exp_num , MERGE case */
  {
    p_MemAdd_LengthGeneral(F, G, ExpSize/sizeof(long));
    p_SetExpV(out,F,r);
    p_Setm(out,r);
    //    omFreeSize((ADDRESS)F,ExpSize);
    printf("second freeT F,rN\n");
    freeT(F,rN);
    printf("second freeT G,rN\n");
    freeT(G,rN);
    printf("second return out\n");
    return(out);
  }
```
The last line printed is `second freeT F,rN`. Hence, F seems to be corrupted. Here is ho F is created:

```
  int *F=(int *)omAlloc0((rN+1)*sizeof(int));
  int *G=(int *)omAlloc0((rN+1)*sizeof(int));

  memcpy(F, F0,(rN+1)*sizeof(int));
  // pExpVectorCopy(F,F0);
  memcpy(G, G0,(rN+1)*sizeof(int));
  //  pExpVectorCopy(G,G0);
  F[0]=0; /* important for p_MemAdd */
  G[0]=0;
```

Is it a problem that `omAlloc0` is explicitly called? Or is it just a macro, and actually defaults to malloc with your spkg?



---

archive/issue_comments_163841.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nReplying to [@simon-king-jena](#comment%3A27):\n> The last line printed is `second freeT F,rN`. Hence, F seems to be corrupted. Here is ho F is created:\n> \n> ```\n>   int *F=(int *)omAlloc0((rN+1)*sizeof(int));\n>   int *G=(int *)omAlloc0((rN+1)*sizeof(int));\n> \n>   memcpy(F, F0,(rN+1)*sizeof(int));\n>   // pExpVectorCopy(F,F0);\n>   memcpy(G, G0,(rN+1)*sizeof(int));\n>   //  pExpVectorCopy(G,G0);\n>   F[0]=0; /* important for p_MemAdd */\n>   G[0]=0;\n> ```\n> \n> Is it a problem that `omAlloc0` is explicitly called? Or is it just a macro, and actually defaults to malloc with your spkg?\n\nThat all should be safe. (omalloc already had an omEmulateAlloc config option, but it was missing declarations and therefore Singular failed to compile. I added those. Part of it was an `omMemDup` routine that takes only a pointer, so it needs to know how large the block pointed to actually is. I needed the linux-specific `malloc_usable_size` for this. It looks into the 8 bytes preceding the block, which makes valgrind complain)\n\nThe actual declarations are for the most part near `omalloc.h:777`, which comes from omAllocDecl.h:280.\n\n```\n#define omAlloc0(size)                          omEmulateAlloc0(size)\n```\nwhich is only defined in `omAllocEmulate.c`:\n\n```\nvoid* omEmulateAlloc0(size_t size)\n{\n  void* addr = OM_MALLOC_MALLOC(size);\n  memset(addr, 0, size);\n  return addr;\n}\n```\nwhere 'OM_MALLOC_MALLOC' is 'malloc' as far as I can tell (the number of indirections involved in omalloc probably is very useful but it drove me to despair). So that looks perfectly safe to me. Furthermore, I didn't touch that file.\n\nI suppose the corruption happens somewhere lower down. Incidentally, the valgrind report points to *exactly* those two snippets. So valgrind reporting for these things is really very good.",
    "created_at": "2012-11-22T17:13:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163841",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:28'>Comment 28:</a>
Replying to [@simon-king-jena](#comment%3A27):
> The last line printed is `second freeT F,rN`. Hence, F seems to be corrupted. Here is ho F is created:
> 
> ```
>   int *F=(int *)omAlloc0((rN+1)*sizeof(int));
>   int *G=(int *)omAlloc0((rN+1)*sizeof(int));
> 
>   memcpy(F, F0,(rN+1)*sizeof(int));
>   // pExpVectorCopy(F,F0);
>   memcpy(G, G0,(rN+1)*sizeof(int));
>   //  pExpVectorCopy(G,G0);
>   F[0]=0; /* important for p_MemAdd */
>   G[0]=0;
> ```
> 
> Is it a problem that `omAlloc0` is explicitly called? Or is it just a macro, and actually defaults to malloc with your spkg?

That all should be safe. (omalloc already had an omEmulateAlloc config option, but it was missing declarations and therefore Singular failed to compile. I added those. Part of it was an `omMemDup` routine that takes only a pointer, so it needs to know how large the block pointed to actually is. I needed the linux-specific `malloc_usable_size` for this. It looks into the 8 bytes preceding the block, which makes valgrind complain)

The actual declarations are for the most part near `omalloc.h:777`, which comes from omAllocDecl.h:280.

```
#define omAlloc0(size)                          omEmulateAlloc0(size)
```
which is only defined in `omAllocEmulate.c`:

```
void* omEmulateAlloc0(size_t size)
{
  void* addr = OM_MALLOC_MALLOC(size);
  memset(addr, 0, size);
  return addr;
}
```
where 'OM_MALLOC_MALLOC' is 'malloc' as far as I can tell (the number of indirections involved in omalloc probably is very useful but it drove me to despair). So that looks perfectly safe to me. Furthermore, I didn't touch that file.

I suppose the corruption happens somewhere lower down. Incidentally, the valgrind report points to *exactly* those two snippets. So valgrind reporting for these things is really very good.



---

archive/issue_comments_163842.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nReplying to [@nbruin](#comment%3A28):\n> That all should be safe.\n\n... which is bad, because I need someone that I can blame }:->\n\n> I suppose the corruption happens somewhere lower down. Incidentally, the valgrind report points to *exactly* those two snippets. So valgrind reporting for these things is really very good.\n\nIt is not clear to me what you mean by \"those two snippets\": The definition of `omEmulateAlloc0`, or the snippets that I provided in my previous post?",
    "created_at": "2012-11-22T17:38:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163842",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'>Comment 29:</a>
Replying to [@nbruin](#comment%3A28):
> That all should be safe.

... which is bad, because I need someone that I can blame }:->

> I suppose the corruption happens somewhere lower down. Incidentally, the valgrind report points to *exactly* those two snippets. So valgrind reporting for these things is really very good.

It is not clear to me what you mean by "those two snippets": The definition of `omEmulateAlloc0`, or the snippets that I provided in my previous post?



---

archive/issue_comments_163843.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nReplying to [@simon-king-jena](#comment%3A29):\n> It is not clear to me what you mean by \"those two snippets\": \n\nThis one:\n> the snippets that I provided in my previous post?\n\nBut don't take my word for it. The report is in the `sage-devel` thread:\n\n```\n==20553== Invalid read of size 8\n==20553==    at 0x2694CB7C: gnc_mm_Mult_nn(int*, int*, sip_sring*) (gring.cc:503)\n==20553==    by 0x2694DABB: gnc_p_Mult_mm_Common(spolyrec*, spolyrec*, int, sip_sring*) (gring.cc:424)\n==20553==    by 0x269C7726: p_Power(spolyrec*, int, sip_sring*) (gring.h:181)\n...\n==20553==  Address 0x40c39c48 is 8 bytes inside a block of size 12 alloc'd\n==20553==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==20553==    by 0x26BADA45: omEmulateAlloc0 (omAllocEmulate.c:15)\n==20553==    by 0x2694C9EE: gnc_mm_Mult_nn(int*, int*, sip_sring*) (gring.cc:472)\n==20553==    by 0x2694DABB: gnc_p_Mult_mm_Common(spolyrec*, spolyrec*, int, sip_sring*) (gring.cc:424)\n==20553==    by 0x269C7726: p_Power(spolyrec*, int, sip_sring*) (gring.h:181)\n```\nWait a minute ... valgrind complains EARLIER! Line 503 rather than 507. So valgrind already seems unhappy with\n\n```\n    p_MemAdd_LengthGeneral(F, G, ExpSize/sizeof(long));\n```\nIt's not immediately clear to me that `ExpSize/sizeof(long)` really is (at most) `rN+1` (see `p_MemAdd.h` for the definition). The singular source is now my most-grepped directory.",
    "created_at": "2012-11-22T18:18:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163843",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:30'>Comment 30:</a>
Replying to [@simon-king-jena](#comment%3A29):
> It is not clear to me what you mean by "those two snippets": 

This one:
> the snippets that I provided in my previous post?

But don't take my word for it. The report is in the `sage-devel` thread:

```
==20553== Invalid read of size 8
==20553==    at 0x2694CB7C: gnc_mm_Mult_nn(int*, int*, sip_sring*) (gring.cc:503)
==20553==    by 0x2694DABB: gnc_p_Mult_mm_Common(spolyrec*, spolyrec*, int, sip_sring*) (gring.cc:424)
==20553==    by 0x269C7726: p_Power(spolyrec*, int, sip_sring*) (gring.h:181)
...
==20553==  Address 0x40c39c48 is 8 bytes inside a block of size 12 alloc'd
==20553==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==20553==    by 0x26BADA45: omEmulateAlloc0 (omAllocEmulate.c:15)
==20553==    by 0x2694C9EE: gnc_mm_Mult_nn(int*, int*, sip_sring*) (gring.cc:472)
==20553==    by 0x2694DABB: gnc_p_Mult_mm_Common(spolyrec*, spolyrec*, int, sip_sring*) (gring.cc:424)
==20553==    by 0x269C7726: p_Power(spolyrec*, int, sip_sring*) (gring.h:181)
```
Wait a minute ... valgrind complains EARLIER! Line 503 rather than 507. So valgrind already seems unhappy with

```
    p_MemAdd_LengthGeneral(F, G, ExpSize/sizeof(long));
```
It's not immediately clear to me that `ExpSize/sizeof(long)` really is (at most) `rN+1` (see `p_MemAdd.h` for the definition). The singular source is now my most-grepped directory.



---

archive/issue_comments_163844.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\n> It's not immediately clear to me that `ExpSize/sizeof(long)` really is (at most) `rN+1` (see `p_MemAdd.h` for the definition).\n\nIn fact, it certainly is not:\n\n```\nint ExpSize=(((rN+1)*sizeof(int)+sizeof(long)-1)/sizeof(long))*sizeof(long);\n```\nso `ExpSize` gets rounded *up*. If `sizeof(int)=4` and `sizeof(long)=8` then for `rN=2` we get `(rN+1)*sizeof(int)=12` and `ExpSize=16` (which, by the valgrind report, is probably exactly the case we're in). So `p_MemAdd_LengthGeneral` is definitely writing out of bounds. I think this code should simply read:\n\n```\n  int *F=(int *)omAlloc0(ExpSize);\n  int *G=(int *)omAlloc0(ExpSize);\n\n  memcpy(F, F0,(rN+1)*sizeof(int));\n  // pExpVectorCopy(F,F0);\n  memcpy(G, G0,(rN+1)*sizeof(int));\n```\n**EDIT:** Oops, don't change the memcpy, since the source may not have such a large allocation. The target is 0-initialized, so the extra space should not be a problem.\n\nGod knows why they add an array of int as an array of long in\n\n```\np_MemAdd_LengthGeneral(F, G, ExpSize/sizeof(long));\n```\nAre they sure there's no carry (I guess, if these are non-negative signed ints the sign bit would buffer any carry).\n\nIs it viable to simply ditch Singular :-?\n\nBy the way, since most architectures with `sizeof(long)=8` would be 8-byte aligned anyway, I doubt that this error would ever lead to real trouble. But the sloppiness surely is worrying.",
    "created_at": "2012-11-22T19:17:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163844",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:31'>Comment 31:</a>
> It's not immediately clear to me that `ExpSize/sizeof(long)` really is (at most) `rN+1` (see `p_MemAdd.h` for the definition).

In fact, it certainly is not:

```
int ExpSize=(((rN+1)*sizeof(int)+sizeof(long)-1)/sizeof(long))*sizeof(long);
```
so `ExpSize` gets rounded *up*. If `sizeof(int)=4` and `sizeof(long)=8` then for `rN=2` we get `(rN+1)*sizeof(int)=12` and `ExpSize=16` (which, by the valgrind report, is probably exactly the case we're in). So `p_MemAdd_LengthGeneral` is definitely writing out of bounds. I think this code should simply read:

```
  int *F=(int *)omAlloc0(ExpSize);
  int *G=(int *)omAlloc0(ExpSize);

  memcpy(F, F0,(rN+1)*sizeof(int));
  // pExpVectorCopy(F,F0);
  memcpy(G, G0,(rN+1)*sizeof(int));
```
**EDIT:** Oops, don't change the memcpy, since the source may not have such a large allocation. The target is 0-initialized, so the extra space should not be a problem.

God knows why they add an array of int as an array of long in

```
p_MemAdd_LengthGeneral(F, G, ExpSize/sizeof(long));
```
Are they sure there's no carry (I guess, if these are non-negative signed ints the sign bit would buffer any carry).

Is it viable to simply ditch Singular :-?

By the way, since most architectures with `sizeof(long)=8` would be 8-byte aligned anyway, I doubt that this error would ever lead to real trouble. But the sloppiness surely is worrying.



---

archive/issue_comments_163845.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nOK, making the changes outlined above do make\n\n```\n ./sage -t devel/sage/sage/libs/singular/function.pyx\n```\npass with `MALLOC_CHECK_=3`. So: yes, `singular-malloc` found a real issue in the singular code (please report upstream!).\n\nBugs like this *could* trip up singular on architectures that have default 4-byte alignment and `sizeof(long) = 8`. From `omTables.c` we see that bins that have a length that are not a multiple of 8 are used in that case:\n\n```\n#ifdef OM_ALIGN_8\n\nsize_t om_BinSize [SIZEOF_OM_BIN_PAGE / MIN_BIN_BLOCKS] =\n{   8,  16,  24,  32,\n    40,  48,  56,  64, 72,\n    80,  96, 112, 128, 144,\n    160, 192, 224,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*9)) / 8)*8,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*6)) / 8)*8,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*4)) / 8)*8,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*2)) / 8)*8,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR))   / 8)*8,\n    OM_MAX_BLOCK_SIZE};\n\n#else /* ! OM_ALIGN_8 */\n\nsize_t om_BinSize [SIZEOF_OM_BIN_PAGE / MIN_BIN_BLOCKS] =\n{   8,  12,  16,  20,\n    24,  28,  32,\n    40,  48,  56,  64,\n    80,  96, 112, 128,\n    160, 192, 224,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*9)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*6)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*4)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*2)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,\n    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR))   / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,\n    OM_MAX_BLOCK_SIZE};\n\n#endif /* OM_ALIGN_8 */\n```\n\nRunning the same file with valgrind does give a couple of reports of the form:\n\n```\n==30816== Conditional jump or move depends on uninitialised value(s)\n==30816==    at 0x26942A01: hGetmem(int, int**, monrec*) (hutil.cc:1026)\n==30816==    by 0x26940296: hHilbStep(int*, int**, int, int*, int, int*, int) (hilb.cc:142)\n==30816==    by 0x2694047C: hHilbStep(int*, int**, int, int*, int, int*, int) (hilb.cc:186)\n==30816==    by 0x26940AEB: hSeries(sip_sideal*, intvec*, int, intvec*, sip_sideal*, sip_sring*) (hilb.cc:285)\n==30816==    by 0x26A62E0D: khCheck(sip_sideal*, intvec*, intvec*, int&, int&, skStrategy*) (khstd.cc:75)\n==30816==    by 0x2697EE07: bba(sip_sideal*, sip_sideal*, intvec*, intvec*, skStrategy*) (kstd2.cc:1214)\n==30816==    by 0x26973F5A: kStd(sip_sideal*, sip_sideal*, tHomog, intvec**, intvec*, int, int, intvec*) (kstd1.cc:1819)\n==30816==    by 0x268B3B27: jjSTD_HILB(sleftv*, sleftv*, sleftv*) (iparith.cc:3321)\n```\nand also (and this one seems to be what `ElectricFence` trips on):\n\n```\n==30816== Invalid read of size 8\n==30816==    at 0x26B8B3F2: List<CanonicalForm>::isEmpty() const (ftmpl_list.cc:256)\n==30816==    by 0x26AFA34F: multiFactorize(CanonicalForm const&, Variable const&) (facFactorize.cc:710)\n==30816==    by 0x26A95E9C: ratFactorize(CanonicalForm const&, Variable const&, bool) (facFactorize.h:45)\n==30816==    by 0x26A9303B: factorize(CanonicalForm const&, bool) (cf_factor.cc:651)\n==30816==    by 0x26935B43: singclap_factorize(spolyrec*, intvec**, int) (clapsing.cc:835)\n==30816==    by 0x268B0D4F: jjFAC_P(sleftv*, sleftv*) (iparith.cc:3995)\n==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)\n==30816==    by 0x270C9F54: __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call(__pyx_obj_4sage_4libs_8singular_8function_KernelCallHandler*, __pyx_obj_4sage_4libs_8singular_8function_Converter*, __pyx_opt_args_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call*) (function.cpp:11286)\n...\n==30816==  Address 0x40c08620 is 0 bytes after a block of size 32 alloc'd\n==30816==    at 0x4A06A97: operator new[](unsigned long) (vg_replace_malloc.c:363)\n==30816==    by 0x26AFA10B: multiFactorize(CanonicalForm const&, Variable const&) (facFactorize.cc:688)\n==30816==    by 0x26A95E9C: ratFactorize(CanonicalForm const&, Variable const&, bool) (facFactorize.h:45)\n==30816==    by 0x26A9303B: factorize(CanonicalForm const&, bool) (cf_factor.cc:651)\n==30816==    by 0x26935B43: singclap_factorize(spolyrec*, intvec**, int) (clapsing.cc:835)\n==30816==    by 0x268B0D4F: jjFAC_P(sleftv*, sleftv*) (iparith.cc:3995)\n==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)\n==30816==    by 0x270C9F54: __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call(__pyx_obj_4sage_4libs_8singular_8function_KernelCallHandler*, __pyx_obj_4sage_4libs_8singular_8function_Converter*, __pyx_opt_args_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call*) (function.cpp:11286)\n```\nand one further report:\n\n```\n==30816== Invalid read of size 4\n==30816==    at 0x269CE137: rOrd_is_Totaldegree_Ordering(sip_sring*) (ring.cc:2074)\n==30816==    by 0x269CFE12: rComplete(sip_sring*, int) (ring.cc:3469)\n==30816==    by 0x269D315C: rDefault(int, int, char**, int, int*, int*, int*, int**) (ring.cc:150)\n==30816==    by 0x269D3214: rDefault(int, int, char**) (ring.cc:167)\n==30816==    by 0x269C06F9: nInitChar(sip_sring*) (numbers.cc:267)\n==30816==    by 0x269CEF07: rComplete(sip_sring*, int) (ring.cc:3546)\n==30816==    by 0x268FA13F: rInit(sleftv*, sleftv*, sleftv*) (ipshell.cc:5127)\n==30816==    by 0x268D7607: yyparse() (grammar.y:1288)\n==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)\n==30816==    by 0x268D7D32: yyparse() (grammar.y:659)\n==30816==    by 0x268ED5A7: iiAllStart(procinfo*, char*, feBufferTypes, int) (iplib.cc:316)\n==30816==    by 0x268ED73E: iiPStart(idrec*, sleftv*) (iplib.cc:417)\n==30816==    by 0x268EDC60: iiMake_proc(idrec*, sip_package*, sleftv*) (iplib.cc:539)\n...\n==30816==  Address 0x40a7b208 is 0 bytes after a block of size 8 alloc'd\n==30816==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==30816==    by 0x269D31BD: rDefault(int, int, char**) (ring.cc:157)\n==30816==    by 0x269C06F9: nInitChar(sip_sring*) (numbers.cc:267)\n==30816==    by 0x269CEF07: rComplete(sip_sring*, int) (ring.cc:3546)\n==30816==    by 0x268FA13F: rInit(sleftv*, sleftv*, sleftv*) (ipshell.cc:5127)\n==30816==    by 0x268D7607: yyparse() (grammar.y:1288)\n==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)\n==30816==    by 0x268D7D32: yyparse() (grammar.y:659)\n==30816==    by 0x268ED5A7: iiAllStart(procinfo*, char*, feBufferTypes, int) (iplib.cc:316)\n==30816==    by 0x268ED73E: iiPStart(idrec*, sleftv*) (iplib.cc:417)\n==30816==    by 0x268EDC60: iiMake_proc(idrec*, sip_package*, sleftv*) (iplib.cc:539)\n```",
    "created_at": "2012-11-22T19:48:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163845",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:32'>Comment 32:</a>
OK, making the changes outlined above do make

```
 ./sage -t devel/sage/sage/libs/singular/function.pyx
```
pass with `MALLOC_CHECK_=3`. So: yes, `singular-malloc` found a real issue in the singular code (please report upstream!).

Bugs like this *could* trip up singular on architectures that have default 4-byte alignment and `sizeof(long) = 8`. From `omTables.c` we see that bins that have a length that are not a multiple of 8 are used in that case:

```
#ifdef OM_ALIGN_8

size_t om_BinSize [SIZEOF_OM_BIN_PAGE / MIN_BIN_BLOCKS] =
{   8,  16,  24,  32,
    40,  48,  56,  64, 72,
    80,  96, 112, 128, 144,
    160, 192, 224,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*9)) / 8)*8,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*6)) / 8)*8,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*4)) / 8)*8,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*2)) / 8)*8,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR))   / 8)*8,
    OM_MAX_BLOCK_SIZE};

#else /* ! OM_ALIGN_8 */

size_t om_BinSize [SIZEOF_OM_BIN_PAGE / MIN_BIN_BLOCKS] =
{   8,  12,  16,  20,
    24,  28,  32,
    40,  48,  56,  64,
    80,  96, 112, 128,
    160, 192, 224,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*9)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*6)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*4)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR*2)) / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,
    ((SIZEOF_OM_BIN_PAGE / (MIN_BIN_BLOCKS + INCR_FACTOR))   / SIZEOF_STRICT_ALIGNMENT)*SIZEOF_STRICT_ALIGNMENT,
    OM_MAX_BLOCK_SIZE};

#endif /* OM_ALIGN_8 */
```

Running the same file with valgrind does give a couple of reports of the form:

```
==30816== Conditional jump or move depends on uninitialised value(s)
==30816==    at 0x26942A01: hGetmem(int, int**, monrec*) (hutil.cc:1026)
==30816==    by 0x26940296: hHilbStep(int*, int**, int, int*, int, int*, int) (hilb.cc:142)
==30816==    by 0x2694047C: hHilbStep(int*, int**, int, int*, int, int*, int) (hilb.cc:186)
==30816==    by 0x26940AEB: hSeries(sip_sideal*, intvec*, int, intvec*, sip_sideal*, sip_sring*) (hilb.cc:285)
==30816==    by 0x26A62E0D: khCheck(sip_sideal*, intvec*, intvec*, int&, int&, skStrategy*) (khstd.cc:75)
==30816==    by 0x2697EE07: bba(sip_sideal*, sip_sideal*, intvec*, intvec*, skStrategy*) (kstd2.cc:1214)
==30816==    by 0x26973F5A: kStd(sip_sideal*, sip_sideal*, tHomog, intvec**, intvec*, int, int, intvec*) (kstd1.cc:1819)
==30816==    by 0x268B3B27: jjSTD_HILB(sleftv*, sleftv*, sleftv*) (iparith.cc:3321)
```
and also (and this one seems to be what `ElectricFence` trips on):

```
==30816== Invalid read of size 8
==30816==    at 0x26B8B3F2: List<CanonicalForm>::isEmpty() const (ftmpl_list.cc:256)
==30816==    by 0x26AFA34F: multiFactorize(CanonicalForm const&, Variable const&) (facFactorize.cc:710)
==30816==    by 0x26A95E9C: ratFactorize(CanonicalForm const&, Variable const&, bool) (facFactorize.h:45)
==30816==    by 0x26A9303B: factorize(CanonicalForm const&, bool) (cf_factor.cc:651)
==30816==    by 0x26935B43: singclap_factorize(spolyrec*, intvec**, int) (clapsing.cc:835)
==30816==    by 0x268B0D4F: jjFAC_P(sleftv*, sleftv*) (iparith.cc:3995)
==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)
==30816==    by 0x270C9F54: __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call(__pyx_obj_4sage_4libs_8singular_8function_KernelCallHandler*, __pyx_obj_4sage_4libs_8singular_8function_Converter*, __pyx_opt_args_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call*) (function.cpp:11286)
...
==30816==  Address 0x40c08620 is 0 bytes after a block of size 32 alloc'd
==30816==    at 0x4A06A97: operator new[](unsigned long) (vg_replace_malloc.c:363)
==30816==    by 0x26AFA10B: multiFactorize(CanonicalForm const&, Variable const&) (facFactorize.cc:688)
==30816==    by 0x26A95E9C: ratFactorize(CanonicalForm const&, Variable const&, bool) (facFactorize.h:45)
==30816==    by 0x26A9303B: factorize(CanonicalForm const&, bool) (cf_factor.cc:651)
==30816==    by 0x26935B43: singclap_factorize(spolyrec*, intvec**, int) (clapsing.cc:835)
==30816==    by 0x268B0D4F: jjFAC_P(sleftv*, sleftv*) (iparith.cc:3995)
==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)
==30816==    by 0x270C9F54: __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call(__pyx_obj_4sage_4libs_8singular_8function_KernelCallHandler*, __pyx_obj_4sage_4libs_8singular_8function_Converter*, __pyx_opt_args_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call*) (function.cpp:11286)
```
and one further report:

```
==30816== Invalid read of size 4
==30816==    at 0x269CE137: rOrd_is_Totaldegree_Ordering(sip_sring*) (ring.cc:2074)
==30816==    by 0x269CFE12: rComplete(sip_sring*, int) (ring.cc:3469)
==30816==    by 0x269D315C: rDefault(int, int, char**, int, int*, int*, int*, int**) (ring.cc:150)
==30816==    by 0x269D3214: rDefault(int, int, char**) (ring.cc:167)
==30816==    by 0x269C06F9: nInitChar(sip_sring*) (numbers.cc:267)
==30816==    by 0x269CEF07: rComplete(sip_sring*, int) (ring.cc:3546)
==30816==    by 0x268FA13F: rInit(sleftv*, sleftv*, sleftv*) (ipshell.cc:5127)
==30816==    by 0x268D7607: yyparse() (grammar.y:1288)
==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)
==30816==    by 0x268D7D32: yyparse() (grammar.y:659)
==30816==    by 0x268ED5A7: iiAllStart(procinfo*, char*, feBufferTypes, int) (iplib.cc:316)
==30816==    by 0x268ED73E: iiPStart(idrec*, sleftv*) (iplib.cc:417)
==30816==    by 0x268EDC60: iiMake_proc(idrec*, sip_package*, sleftv*) (iplib.cc:539)
...
==30816==  Address 0x40a7b208 is 0 bytes after a block of size 8 alloc'd
==30816==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==30816==    by 0x269D31BD: rDefault(int, int, char**) (ring.cc:157)
==30816==    by 0x269C06F9: nInitChar(sip_sring*) (numbers.cc:267)
==30816==    by 0x269CEF07: rComplete(sip_sring*, int) (ring.cc:3546)
==30816==    by 0x268FA13F: rInit(sleftv*, sleftv*, sleftv*) (ipshell.cc:5127)
==30816==    by 0x268D7607: yyparse() (grammar.y:1288)
==30816==    by 0x268B9C41: iiExprArith1(sleftv*, sleftv*, int) (iparith.cc:7869)
==30816==    by 0x268D7D32: yyparse() (grammar.y:659)
==30816==    by 0x268ED5A7: iiAllStart(procinfo*, char*, feBufferTypes, int) (iplib.cc:316)
==30816==    by 0x268ED73E: iiPStart(idrec*, sleftv*) (iplib.cc:417)
==30816==    by 0x268EDC60: iiMake_proc(idrec*, sip_package*, sleftv*) (iplib.cc:539)
```



---

archive/issue_comments_163846.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\n> \n> ```\n> ==30816== Invalid read of size 4\n> ==30816==    at 0x269CE137: rOrd_is_Totaldegree_Ordering(sip_sring*) (ring.cc:2074)\n> ...\n> ```\n\nThis is like shooting fish in a barrel. `ring.cc:157`:\n\n```\n...\n  int *order = (int *) omAlloc(2* sizeof(int));\n...\n  return rDefault(ch,N,n,2,order,block0,block1);\n```\ncalling `ring.cc:127` (the variable `order` above gets passed as the parameter `ord` in the code below):\n\n```\n  ring r=(ring) omAlloc0Bin(sip_sring_bin);\n...\n  r->order = ord;\n...\n  rComplete(r);\n```\ncalling `ring.cc:3469`:\n\n```\n  if (rOrd_is_Totaldegree_Ordering(r) || rOrd_is_WeightedDegree_Ordering(r))\n```\ncalling `ring.cc:2065`:\n\n```\nBOOLEAN rOrd_is_Totaldegree_Ordering(ring r)\n{\n  // Hmm.... what about Syz orderings?\n  return (rVar(r) > 1 &&\n          ((rHasSimpleOrder(r) &&\n           (rOrder_is_DegOrdering((rRingOrder_t)r->order[0]) ||\n            rOrder_is_DegOrdering(( rRingOrder_t)r->order[1]))) ||\n           (rHasSimpleOrderAA(r) &&\n            (rOrder_is_DegOrdering((rRingOrder_t)r->order[1]) ||\n             rOrder_is_DegOrdering((rRingOrder_t)r->order[2])))));\n}\n```\nAs you see, that last line `...r->ord[2]` is indeed out of bound on a `2*sizeof(int)` block. The valgrind session seems to indicate this code path is indeed exercised.",
    "created_at": "2012-11-23T07:56:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163846",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:33'>Comment 33:</a>
> 
> ```
> ==30816== Invalid read of size 4
> ==30816==    at 0x269CE137: rOrd_is_Totaldegree_Ordering(sip_sring*) (ring.cc:2074)
> ...
> ```

This is like shooting fish in a barrel. `ring.cc:157`:

```
...
  int *order = (int *) omAlloc(2* sizeof(int));
...
  return rDefault(ch,N,n,2,order,block0,block1);
```
calling `ring.cc:127` (the variable `order` above gets passed as the parameter `ord` in the code below):

```
  ring r=(ring) omAlloc0Bin(sip_sring_bin);
...
  r->order = ord;
...
  rComplete(r);
```
calling `ring.cc:3469`:

```
  if (rOrd_is_Totaldegree_Ordering(r) || rOrd_is_WeightedDegree_Ordering(r))
```
calling `ring.cc:2065`:

```
BOOLEAN rOrd_is_Totaldegree_Ordering(ring r)
{
  // Hmm.... what about Syz orderings?
  return (rVar(r) > 1 &&
          ((rHasSimpleOrder(r) &&
           (rOrder_is_DegOrdering((rRingOrder_t)r->order[0]) ||
            rOrder_is_DegOrdering(( rRingOrder_t)r->order[1]))) ||
           (rHasSimpleOrderAA(r) &&
            (rOrder_is_DegOrdering((rRingOrder_t)r->order[1]) ||
             rOrder_is_DegOrdering((rRingOrder_t)r->order[2])))));
}
```
As you see, that last line `...r->ord[2]` is indeed out of bound on a `2*sizeof(int)` block. The valgrind session seems to indicate this code path is indeed exercised.



---

archive/issue_comments_163847.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nReplying to [@nbruin](#comment%3A30):\n> It's not immediately clear to me that `ExpSize/sizeof(long)` really is (at most) `rN+1`\n\nDo you mean `(rN+1)*sizeof(int)`?",
    "created_at": "2012-11-23T08:43:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163847",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:34'>Comment 34:</a>
Replying to [@nbruin](#comment%3A30):
> It's not immediately clear to me that `ExpSize/sizeof(long)` really is (at most) `rN+1`

Do you mean `(rN+1)*sizeof(int)`?



---

archive/issue_comments_163848.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nFor the record: The problem is reported [upstream](http://www.singular.uni-kl.de:8002/trac/ticket/463), and Hannes seems to acknowledge that there is a problem.",
    "created_at": "2012-11-23T10:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163848",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'>Comment 35:</a>
For the record: The problem is reported [upstream](http://www.singular.uni-kl.de:8002/trac/ticket/463), and Hannes seems to acknowledge that there is a problem.



---

archive/issue_comments_163849.json:
```json
{
    "body": "Upstream: **Reported upstream. Developers acknowledge bug.**",
    "created_at": "2012-11-23T10:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163849",
    "user": "https://github.com/simon-king-jena"
}
```

Upstream: **Reported upstream. Developers acknowledge bug.**



---

archive/issue_comments_163850.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nI am a bit puzzled: I thought that I had posted a comment roughly as follows, but it seems to have vanished.\n\nIt would take some time to get a fix into a stable Singular release, and it would take even more time until the next stable Singular release is in Sage.\n\nHence: Could you create diff files for your fixes in the Singular source code (I am not talking about the malloc thing but about the bug fixes), so that one can put them into the `patches/` directory of the Singular spkg?",
    "created_at": "2012-11-23T10:55:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163850",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:36'>Comment 36:</a>
I am a bit puzzled: I thought that I had posted a comment roughly as follows, but it seems to have vanished.

It would take some time to get a fix into a stable Singular release, and it would take even more time until the next stable Singular release is in Sage.

Hence: Could you create diff files for your fixes in the Singular source code (I am not talking about the malloc thing but about the bug fixes), so that one can put them into the `patches/` directory of the Singular spkg?



---

archive/issue_comments_163851.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nReplying to [@simon-king-jena](#comment%3A36):\n> Hence: Could you create diff files for your fixes in the Singular source code (I am not talking about the malloc thing but about the bug fixes), so that one can put them into the `patches/` directory of the Singular spkg?\n\nFor the bug that tripped `MALLOC_CHECK_`: sure. That's just a 2-line change which I'm fairly confident is safe to make.\n\n```diff\n-  int *F=(int *)omAlloc0((rN+1)*sizeof(int));\n+  int *F=(int *)omAlloc0(ExpSize);\n-  int *G=(int *)omAlloc0((rN+1)*sizeof(int));\n+  int *G=(int *)omAlloc0(ExpSize);\n```\n\nFor the second bug: I have no idea how to fix that. Just doing\n\n```diff\n-  int *order = (int *) omAlloc(2* sizeof(int))\n+  int *order = (int *) omAlloc(3* sizeof(int))\n```\nmay work but is a bit questionable.\n\nAlso I have no experience in making patch files for the singular source. It may be a bit more robust to take whatever change Singular makes to their development version and backport that.\n\nAlso: we're not done yet. There's still a branch on what valgrind thinks is an uninitialized value and there's the `List<CanonicalForm>::isEmpty()` issue which ventures into templated code, so I'm at a loss for that.\n\nPurpose of this ticket: I guess it's vague. Feel free to specify. I was actually hoping that after seeing that singular-malloc can expose issues that are otherwise hard to find, Singular might be interesting in adopting it and including it as a honest configure option (resolving the problem with the executable too). Then we can just put the proper doc in the spkg. If they don't do that, we could still do so but as a patch to singular.  My goal was just to get rid of Heisenbugs in our communication with Singular.",
    "created_at": "2012-11-23T17:43:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163851",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:37'>Comment 37:</a>
Replying to [@simon-king-jena](#comment%3A36):
> Hence: Could you create diff files for your fixes in the Singular source code (I am not talking about the malloc thing but about the bug fixes), so that one can put them into the `patches/` directory of the Singular spkg?

For the bug that tripped `MALLOC_CHECK_`: sure. That's just a 2-line change which I'm fairly confident is safe to make.

```diff
-  int *F=(int *)omAlloc0((rN+1)*sizeof(int));
+  int *F=(int *)omAlloc0(ExpSize);
-  int *G=(int *)omAlloc0((rN+1)*sizeof(int));
+  int *G=(int *)omAlloc0(ExpSize);
```

For the second bug: I have no idea how to fix that. Just doing

```diff
-  int *order = (int *) omAlloc(2* sizeof(int))
+  int *order = (int *) omAlloc(3* sizeof(int))
```
may work but is a bit questionable.

Also I have no experience in making patch files for the singular source. It may be a bit more robust to take whatever change Singular makes to their development version and backport that.

Also: we're not done yet. There's still a branch on what valgrind thinks is an uninitialized value and there's the `List<CanonicalForm>::isEmpty()` issue which ventures into templated code, so I'm at a loss for that.

Purpose of this ticket: I guess it's vague. Feel free to specify. I was actually hoping that after seeing that singular-malloc can expose issues that are otherwise hard to find, Singular might be interesting in adopting it and including it as a honest configure option (resolving the problem with the executable too). Then we can just put the proper doc in the spkg. If they don't do that, we could still do so but as a patch to singular.  My goal was just to get rid of Heisenbugs in our communication with Singular.



---

archive/issue_comments_163852.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nReplying to [@nbruin](#comment%3A37):\n> Replying to [@simon-king-jena](#comment%3A36):\n> > Hence: Could you create diff files for your fixes in the Singular source code (I am not talking about the malloc thing but about the bug fixes), so that one can put them into the `patches/` directory of the Singular spkg?\n\n> \n> For the bug that tripped `MALLOC_CHECK_`: sure. That's just a 2-line change which I'm fairly confident is safe to make.\n> \n> ```diff\n> -  int *F=(int *)omAlloc0((rN+1)*sizeof(int));\n> +  int *F=(int *)omAlloc0(ExpSize);\n> -  int *G=(int *)omAlloc0((rN+1)*sizeof(int));\n> +  int *G=(int *)omAlloc0(ExpSize);\n> ```\n> \n> For the second bug: I have no idea how to fix that. Just doing\n> \n> ```diff\n> -  int *order = (int *) omAlloc(2* sizeof(int))\n> +  int *order = (int *) omAlloc(3* sizeof(int))\n> ```\n> may work but is a bit questionable.\n\nCan you suggest that as a fix on the singular ticket? Or shall I communicate it?\n\n> Also I have no experience in making patch files for the singular source.\n\nThat's easy.\n\n* Create a diff with context (is that called \"unified\"? I am not sure).\n* Give it a good name and perhaps a commit message, and put it into the `patches/` folder of the Singular spkg. Just look what you currently find in that folder. The point is: The patches placed into the `patches/` folder are automatically applied before building Singular.\n* *Do **not** change the files in `src/`*! They are supposed to be identical with the official Singular 3-1-5 source files.\n* Rename the spkg into `singular-3-1-5.p2.spkg`.\n* Update `SPKG.txt`, describing the new patch.\n* Both the `patches/` folder and `SPKG.txt` are under version control, hence, you also need to `hg commit`.\n* Pack the spkg, post it somewhere, and ask me or someone else for a review.\n\nThe same patch could be put into your `malloc-Singular/patches/`, so that we can test whether the problem is really solved. And if it is, then the patch in the usual omalloc Singular should be fine to go.\n\n> It may be a bit more robust to take whatever change Singular makes to their development version and backport that.\n\nWell, let's see what the Singular team thinks of your suggestion... \n\nIf they react quickly, then we could take the patch from Singular trac. If they are too slow, we take your patch from Sage trac.\n\n> Also: we're not done yet. There's still a branch on what valgrind thinks is an uninitialized value and there's the `List<CanonicalForm>::isEmpty()` issue which ventures into templated code, so I'm at a loss for that.\n\nSure. Could be that we will open further Singular trac tickets, and could be that there will be two or three more patches in `patches/`...\n \n> Purpose of this ticket: I guess it's vague. Feel free to specify. I was actually hoping that after seeing that singular-malloc can expose issues that are otherwise hard to find, Singular might be interesting in adopting it and including it as a honest configure option (resolving the problem with the executable too). Then we can just put the proper doc in the spkg.\n\nI see that the `patches/` directory contains a sub-directory `patches/conditional/` containing a patch `sage_debug.patch` and a patch for cygwin. The changes that you've done in the Singular source code to use malloc could be put into `patches/conditional/`. Probably spkg-install needs to be changed to take the new option into account.\n\n> If they don't do that, we could still do so but as a patch to singular.\n\nI think it will be a patch to the Singular spkg *in any case*. Waiting for Singular 3-1-6 (which will hopefully contain a fix for the memory problem) is probably no option.",
    "created_at": "2012-11-23T19:45:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163852",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:38'>Comment 38:</a>
Replying to [@nbruin](#comment%3A37):
> Replying to [@simon-king-jena](#comment%3A36):
> > Hence: Could you create diff files for your fixes in the Singular source code (I am not talking about the malloc thing but about the bug fixes), so that one can put them into the `patches/` directory of the Singular spkg?

> 
> For the bug that tripped `MALLOC_CHECK_`: sure. That's just a 2-line change which I'm fairly confident is safe to make.
> 
> ```diff
> -  int *F=(int *)omAlloc0((rN+1)*sizeof(int));
> +  int *F=(int *)omAlloc0(ExpSize);
> -  int *G=(int *)omAlloc0((rN+1)*sizeof(int));
> +  int *G=(int *)omAlloc0(ExpSize);
> ```
> 
> For the second bug: I have no idea how to fix that. Just doing
> 
> ```diff
> -  int *order = (int *) omAlloc(2* sizeof(int))
> +  int *order = (int *) omAlloc(3* sizeof(int))
> ```
> may work but is a bit questionable.

Can you suggest that as a fix on the singular ticket? Or shall I communicate it?

> Also I have no experience in making patch files for the singular source.

That's easy.

* Create a diff with context (is that called "unified"? I am not sure).
* Give it a good name and perhaps a commit message, and put it into the `patches/` folder of the Singular spkg. Just look what you currently find in that folder. The point is: The patches placed into the `patches/` folder are automatically applied before building Singular.
* *Do **not** change the files in `src/`*! They are supposed to be identical with the official Singular 3-1-5 source files.
* Rename the spkg into `singular-3-1-5.p2.spkg`.
* Update `SPKG.txt`, describing the new patch.
* Both the `patches/` folder and `SPKG.txt` are under version control, hence, you also need to `hg commit`.
* Pack the spkg, post it somewhere, and ask me or someone else for a review.

The same patch could be put into your `malloc-Singular/patches/`, so that we can test whether the problem is really solved. And if it is, then the patch in the usual omalloc Singular should be fine to go.

> It may be a bit more robust to take whatever change Singular makes to their development version and backport that.

Well, let's see what the Singular team thinks of your suggestion... 

If they react quickly, then we could take the patch from Singular trac. If they are too slow, we take your patch from Sage trac.

> Also: we're not done yet. There's still a branch on what valgrind thinks is an uninitialized value and there's the `List<CanonicalForm>::isEmpty()` issue which ventures into templated code, so I'm at a loss for that.

Sure. Could be that we will open further Singular trac tickets, and could be that there will be two or three more patches in `patches/`...
 
> Purpose of this ticket: I guess it's vague. Feel free to specify. I was actually hoping that after seeing that singular-malloc can expose issues that are otherwise hard to find, Singular might be interesting in adopting it and including it as a honest configure option (resolving the problem with the executable too). Then we can just put the proper doc in the spkg.

I see that the `patches/` directory contains a sub-directory `patches/conditional/` containing a patch `sage_debug.patch` and a patch for cygwin. The changes that you've done in the Singular source code to use malloc could be put into `patches/conditional/`. Probably spkg-install needs to be changed to take the new option into account.

> If they don't do that, we could still do so but as a patch to singular.

I think it will be a patch to the Singular spkg *in any case*. Waiting for Singular 3-1-6 (which will hopefully contain a fix for the memory problem) is probably no option.



---

archive/issue_comments_163853.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nI've put the following two files into the `patches/` folder of the singular-3-1-5.malloc-linux spkg:\n\n* `sage_trac13731_gnc_mm_Mult_nn.patch`\n\n   ```diff\n   # HG changeset patch\n   # User Simon King <simon.king@uni-jena.de>\n   # Date 1353701669 -3600\n   # Node ID 0f5e07666bc133a0d38cb846120c0103c4c2b0ae\n   # Parent  3eb11c08dd9611b7fdba4622cc0d1660527f9e96\n   #13731: Fix allocated size of F and G in gnc_mm_Mult_nn\n   \n   diff --git a/src/kernel/gring.cc b/src/kernel/gring.cc\n   --- a/src/kernel/gring.cc\n   +++ b/src/kernel/gring.cc\n   @@ -469,8 +469,8 @@\n      int rN=r->N;\n      int ExpSize=(((rN+1)*sizeof(int)+sizeof(long)-1)/sizeof(long))*sizeof(long);\n    \n   -  int *F=(int *)omAlloc0((rN+1)*sizeof(int));\n   -  int *G=(int *)omAlloc0((rN+1)*sizeof(int));\n   +  int *F=(int *)omAlloc0(ExpSize);\n   +  int *G=(int *)omAlloc0(ExpSize);\n    \n      memcpy(F, F0,(rN+1)*sizeof(int));\n      // pExpVectorCopy(F,F0);\n  ```\n\n* patches/sage_trac13731_size_of_order.patch\n\n   ```diff\n   # HG changeset patch\n   # User Simon King <simon.king@uni-jena.de>\n   # Date 1353701944 -3600\n   # Node ID 3ab3d75bf03794d94037c3e33711fdd773d858dc\n   # Parent  0f5e07666bc133a0d38cb846120c0103c4c2b0ae\n   #13731: Fix allocated size for order (in ring.cc)\n   \n   diff --git a/src/kernel/ring.cc b/src/kernel/ring.cc\n   --- a/src/kernel/ring.cc\n   +++ b/src/kernel/ring.cc\n   @@ -154,7 +154,7 @@\n    ring rDefault(int ch, int N, char **n)\n    {\n      /*order: lp,0*/\n   -  int *order = (int *) omAlloc(2* sizeof(int));\n   +  int *order = (int *) omAlloc(3* sizeof(int));\n      int *block0 = (int *)omAlloc0(2 * sizeof(int));\n      int *block1 = (int *)omAlloc0(2 * sizeof(int));\n      /* ringorder dp for the first block: var 1..N */\n  ```\n\nHowever, after re-installing the package, the crash persists!\n\n```\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\n*** glibc detected *** python: free(): invalid pointer: 0x0000000002bb11c0 ***\n======= Backtrace: =========\n/lib64/libc.so.6(+0x766d6)[0x7f8243e866d6]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z14gnc_mm_Mult_nnPiS_P9sip_sring+0x294)[0x7f8229a81c54]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z20gnc_p_Mult_mm_CommonP8spolyrecS0_iP9sip_sring+0x1ec)[0x7f8229a82acc]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/libs/singular/polynomial.so(+0x4bd0)[0x7f8228e63bd0]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0x1fbd8)[0x7f82292a8bd8]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/structure/element.so(+0x2a399)[0x7f823b0a7399]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x48a4f)[0x7f8244a63a4f]\n```\n\nThat's bad. Didn't you say the change fixes it for you?",
    "created_at": "2012-11-23T20:51:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163853",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:39'>Comment 39:</a>
I've put the following two files into the `patches/` folder of the singular-3-1-5.malloc-linux spkg:

* `sage_trac13731_gnc_mm_Mult_nn.patch`

   ```diff
   # HG changeset patch
   # User Simon King <simon.king@uni-jena.de>
   # Date 1353701669 -3600
   # Node ID 0f5e07666bc133a0d38cb846120c0103c4c2b0ae
   # Parent  3eb11c08dd9611b7fdba4622cc0d1660527f9e96
   #13731: Fix allocated size of F and G in gnc_mm_Mult_nn
   
   diff --git a/src/kernel/gring.cc b/src/kernel/gring.cc
   --- a/src/kernel/gring.cc
   +++ b/src/kernel/gring.cc
   @@ -469,8 +469,8 @@
      int rN=r->N;
      int ExpSize=(((rN+1)*sizeof(int)+sizeof(long)-1)/sizeof(long))*sizeof(long);
    
   -  int *F=(int *)omAlloc0((rN+1)*sizeof(int));
   -  int *G=(int *)omAlloc0((rN+1)*sizeof(int));
   +  int *F=(int *)omAlloc0(ExpSize);
   +  int *G=(int *)omAlloc0(ExpSize);
    
      memcpy(F, F0,(rN+1)*sizeof(int));
      // pExpVectorCopy(F,F0);
  ```

* patches/sage_trac13731_size_of_order.patch

   ```diff
   # HG changeset patch
   # User Simon King <simon.king@uni-jena.de>
   # Date 1353701944 -3600
   # Node ID 3ab3d75bf03794d94037c3e33711fdd773d858dc
   # Parent  0f5e07666bc133a0d38cb846120c0103c4c2b0ae
   #13731: Fix allocated size for order (in ring.cc)
   
   diff --git a/src/kernel/ring.cc b/src/kernel/ring.cc
   --- a/src/kernel/ring.cc
   +++ b/src/kernel/ring.cc
   @@ -154,7 +154,7 @@
    ring rDefault(int ch, int N, char **n)
    {
      /*order: lp,0*/
   -  int *order = (int *) omAlloc(2* sizeof(int));
   +  int *order = (int *) omAlloc(3* sizeof(int));
      int *block0 = (int *)omAlloc0(2 * sizeof(int));
      int *block1 = (int *)omAlloc0(2 * sizeof(int));
      /* ringorder dp for the first block: var 1..N */
  ```

However, after re-installing the package, the crash persists!

```
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
*** glibc detected *** python: free(): invalid pointer: 0x0000000002bb11c0 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x766d6)[0x7f8243e866d6]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z14gnc_mm_Mult_nnPiS_P9sip_sring+0x294)[0x7f8229a81c54]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z20gnc_p_Mult_mm_CommonP8spolyrecS0_iP9sip_sring+0x1ec)[0x7f8229a82acc]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/libs/singular/polynomial.so(+0x4bd0)[0x7f8228e63bd0]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0x1fbd8)[0x7f82292a8bd8]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/structure/element.so(+0x2a399)[0x7f823b0a7399]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x48a4f)[0x7f8244a63a4f]
```

That's bad. Didn't you say the change fixes it for you?



---

archive/issue_comments_163854.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nAha! You also changed spkg-install, so that the patches are actually *not* applied! That is of course the reason why it didn't work.",
    "created_at": "2012-11-23T21:01:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163854",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'>Comment 40:</a>
Aha! You also changed spkg-install, so that the patches are actually *not* applied! That is of course the reason why it didn't work.



---

archive/issue_comments_163855.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nReplying to [@simon-king-jena](#comment%3A39):\n> I've put the following two files into the `patches/` folder of the singular-3-1-5.malloc-linux spkg:\n\n[...]\n\nPerhaps backport this instead (should be pretty straightforward to replace the patches):\n\n[http://www.singular.uni-kl.de:8002/trac/changeset/15435](http://www.singular.uni-kl.de:8002/trac/changeset/15435)\n\nIt looks like the second issue is also addressed. Are the other issues within your reach to investigate? I'm not really comfortable tracing through templated C++.\n\nThe FC16 packaged valgrind didn't work for me due to unsupported machine instructions, but the latest valgrind release fixes that and installing that in /usr/local was a breeze! I can thoroughly recommend using it. The information it gives seem spot-on.\n(I was able to diagnose both these issues by just looking at the valgrind report and tracing through the code from allocation to access error. It won't always be that straightforward, but one can hope)\n\nWith\n\n[http://sage.math.washington.edu/home/nbruin/sage.supp](http://sage.math.washington.edu/home/nbruin/sage.supp)\n\nthe amount of false (or at least for me uninteresting) reports is bearable.\n\nIt's unlikely, but the errors we've found could lead to random corruptions and hence explain the peculiar system-dependent bugs we've experienced.\n\nI'm afraid we're not done yet, though: Although we haven't found a GC mismatch here, we're pretty sure they exist. Also these corruptions should cause bad problems all around, not just after introducing GC.",
    "created_at": "2012-11-23T22:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163855",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:41'>Comment 41:</a>
Replying to [@simon-king-jena](#comment%3A39):
> I've put the following two files into the `patches/` folder of the singular-3-1-5.malloc-linux spkg:

[...]

Perhaps backport this instead (should be pretty straightforward to replace the patches):

[http://www.singular.uni-kl.de:8002/trac/changeset/15435](http://www.singular.uni-kl.de:8002/trac/changeset/15435)

It looks like the second issue is also addressed. Are the other issues within your reach to investigate? I'm not really comfortable tracing through templated C++.

The FC16 packaged valgrind didn't work for me due to unsupported machine instructions, but the latest valgrind release fixes that and installing that in /usr/local was a breeze! I can thoroughly recommend using it. The information it gives seem spot-on.
(I was able to diagnose both these issues by just looking at the valgrind report and tracing through the code from allocation to access error. It won't always be that straightforward, but one can hope)

With

[http://sage.math.washington.edu/home/nbruin/sage.supp](http://sage.math.washington.edu/home/nbruin/sage.supp)

the amount of false (or at least for me uninteresting) reports is bearable.

It's unlikely, but the errors we've found could lead to random corruptions and hence explain the peculiar system-dependent bugs we've experienced.

I'm afraid we're not done yet, though: Although we haven't found a GC mismatch here, we're pretty sure they exist. Also these corruptions should cause bad problems all around, not just after introducing GC.



---

archive/issue_comments_163856.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\n> \n> ```\n> ==30816== Conditional jump or move depends on uninitialised value(s)\n> ==30816==    at 0x26942A01: hGetmem(int, int**, monrec*)\n> ```\n\nI think this one is benign, because rewriting the code to the functionally equivalent\n\n`hutil.cc:1020:`\n\n```diff\nscfmon hGetmem(int lm, scfmon old, monp monmem)\n{\n   scfmon x = monmem->mo;\n   int  lx = monmem->a;\n   if ((x==NULL) || (lm > lx))\n   {\n-    if ((x!=NULL)&&(lx>0)) omFreeSize((ADDRESS)x, lx * sizeof(scmon));\n+    if (x!=NULL) if (lx>0) omFreeSize((ADDRESS)x, lx * sizeof(scmon));\n     monmem->mo = x = (scfmon)omAlloc(lm * sizeof(scmon));\n     monmem->a = lm;\n   }\n   memcpy(x, old, lm * sizeof(scmon));\n   return x;\n}\n```\nmakes the reports go away. I guess gcc optimizes out the shortcutting because it's not a benefit here and valgrind doesn't see through the fact that the undefined value doesn't influence the outcome.",
    "created_at": "2012-11-24T00:23:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163856",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:42'>Comment 42:</a>
> 
> ```
> ==30816== Conditional jump or move depends on uninitialised value(s)
> ==30816==    at 0x26942A01: hGetmem(int, int**, monrec*)
> ```

I think this one is benign, because rewriting the code to the functionally equivalent

`hutil.cc:1020:`

```diff
scfmon hGetmem(int lm, scfmon old, monp monmem)
{
   scfmon x = monmem->mo;
   int  lx = monmem->a;
   if ((x==NULL) || (lm > lx))
   {
-    if ((x!=NULL)&&(lx>0)) omFreeSize((ADDRESS)x, lx * sizeof(scmon));
+    if (x!=NULL) if (lx>0) omFreeSize((ADDRESS)x, lx * sizeof(scmon));
     monmem->mo = x = (scfmon)omAlloc(lm * sizeof(scmon));
     monmem->a = lm;
   }
   memcpy(x, old, lm * sizeof(scmon));
   return x;
}
```
makes the reports go away. I guess gcc optimizes out the shortcutting because it's not a benefit here and valgrind doesn't see through the fact that the undefined value doesn't influence the outcome.



---

archive/issue_comments_163857.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nReplying to [@nbruin](#comment%3A2):\n> \n> ```\n> #0  0x00007fffce9fb3f2 in List<CanonicalForm>::isEmpty(this=0x7fffa515b000) at ./templates/ftmpl_list.cc:256\n> #1  0x00007fffce96a350 in multiFactorize (F=..., v=...) at facFactorize.cc:710\n> ```\n\nI think this one is rather straightforward too (and a genuine out-of-bounds reference!):\nfacFactorize.cc:688\n\n```\n    CFList* bufAeval2= new CFList [A.level() - 2];\n...\n    evaluationWRTDifferentSecondVars (bufAeval2, bufEvaluation, A);\n\n    for (int j= 0; j < A.level() - 1; j++)\n    {\n      if (!bufAeval2[j].isEmpty())\n        counter++;\n    }\n```\nso this queries all elements `bufAeval2[0],...,bufAeval2[A.level()-2]`. However,\nif this allocates an array as it does in C, then the `new` command above only\ncreates\n`bufAeval2[0],...,bufAeval2[A.level()-3]` (i.e., A.level()-2 of them, but\n0-based.\n\nThe initialization by `evaluationWRTDifferentSecondVars` seems to corroborate\nthat:\n\nfacFqFactorize.cc:1778\n\n```\nvoid\nevaluationWRTDifferentSecondVars (CFList*& Aeval, const CFList& evaluation,\n                                  const CanonicalForm& A)\n{\n  CanonicalForm tmp;\n  CFList tmp2;\n  CFListIterator iter;\n  for (int i= A.level(); i > 2; i--)\n  {\n...\n    if (preserveDegree)\n      Aeval [i - 3]= tmp2;\n    else\n      Aeval [i - 3]= CFList();\n  }\n}\n```\nSo only `Aeval[0], ..., Aeval[A.level()-3]` get initialized.\n\nThus, the reference to `!bufAeval2[j].isEmpty()` with `j = A.level() - 2` indeed seems out of bounds to me. The abundance of bound errors in Singular is really making me feel uncomfortable. The Singular team should really take their memory audits a little more seriously. They're playing russian roulette with mathematical correctness.",
    "created_at": "2012-11-24T00:58:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163857",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:43'>Comment 43:</a>
Replying to [@nbruin](#comment%3A2):
> 
> ```
> #0  0x00007fffce9fb3f2 in List<CanonicalForm>::isEmpty(this=0x7fffa515b000) at ./templates/ftmpl_list.cc:256
> #1  0x00007fffce96a350 in multiFactorize (F=..., v=...) at facFactorize.cc:710
> ```

I think this one is rather straightforward too (and a genuine out-of-bounds reference!):
facFactorize.cc:688

```
    CFList* bufAeval2= new CFList [A.level() - 2];
...
    evaluationWRTDifferentSecondVars (bufAeval2, bufEvaluation, A);

    for (int j= 0; j < A.level() - 1; j++)
    {
      if (!bufAeval2[j].isEmpty())
        counter++;
    }
```
so this queries all elements `bufAeval2[0],...,bufAeval2[A.level()-2]`. However,
if this allocates an array as it does in C, then the `new` command above only
creates
`bufAeval2[0],...,bufAeval2[A.level()-3]` (i.e., A.level()-2 of them, but
0-based.

The initialization by `evaluationWRTDifferentSecondVars` seems to corroborate
that:

facFqFactorize.cc:1778

```
void
evaluationWRTDifferentSecondVars (CFList*& Aeval, const CFList& evaluation,
                                  const CanonicalForm& A)
{
  CanonicalForm tmp;
  CFList tmp2;
  CFListIterator iter;
  for (int i= A.level(); i > 2; i--)
  {
...
    if (preserveDegree)
      Aeval [i - 3]= tmp2;
    else
      Aeval [i - 3]= CFList();
  }
}
```
So only `Aeval[0], ..., Aeval[A.level()-3]` get initialized.

Thus, the reference to `!bufAeval2[j].isEmpty()` with `j = A.level() - 2` indeed seems out of bounds to me. The abundance of bound errors in Singular is really making me feel uncomfortable. The Singular team should really take their memory audits a little more seriously. They're playing russian roulette with mathematical correctness.



---

archive/issue_comments_163858.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nReplying to [@nbruin](#comment%3A41):\n> Replying to [@simon-king-jena](#comment%3A39):\n> > I've put the following two files into the `patches/` folder of the singular-3-1-5.malloc-linux spkg:\n\n> [...]\n> \n> Perhaps backport this instead (should be pretty straightforward to replace the patches):\n> \n> [http://www.singular.uni-kl.de:8002/trac/changeset/15435](http://www.singular.uni-kl.de:8002/trac/changeset/15435)\n\nYes, that looks like the right thing to do.\n\nMy plan is to take your Singular-malloc spkg and turn it into a \"proper\" spkg, in the sense that the changes that you did to the source code will become patches that are *optionally* applied (say, if one does `export SAGE_SINGULA_MALLOC=yes`).\n\nThe backported fix will of course be an unconditional patch.\n\n> It looks like the second issue is also addressed. Are the other issues within your reach to investigate? I'm not really comfortable tracing through templated C++.\n\nNeither am I. But at least (in contrast to me!) you are comfortable to work with valgrind! Perhaps you could open a ticket to make your `.supp` file available to people? After all, there is a totally outdated valgrind spkg...",
    "created_at": "2012-11-24T07:52:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163858",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:44'>Comment 44:</a>
Replying to [@nbruin](#comment%3A41):
> Replying to [@simon-king-jena](#comment%3A39):
> > I've put the following two files into the `patches/` folder of the singular-3-1-5.malloc-linux spkg:

> [...]
> 
> Perhaps backport this instead (should be pretty straightforward to replace the patches):
> 
> [http://www.singular.uni-kl.de:8002/trac/changeset/15435](http://www.singular.uni-kl.de:8002/trac/changeset/15435)

Yes, that looks like the right thing to do.

My plan is to take your Singular-malloc spkg and turn it into a "proper" spkg, in the sense that the changes that you did to the source code will become patches that are *optionally* applied (say, if one does `export SAGE_SINGULA_MALLOC=yes`).

The backported fix will of course be an unconditional patch.

> It looks like the second issue is also addressed. Are the other issues within your reach to investigate? I'm not really comfortable tracing through templated C++.

Neither am I. But at least (in contrast to me!) you are comfortable to work with valgrind! Perhaps you could open a ticket to make your `.supp` file available to people? After all, there is a totally outdated valgrind spkg...



---

archive/issue_comments_163859.json:
```json
{
    "body": "<a id='comment:45'>Comment 45:</a>\nNow I try to patch the standard Singular spkg so that one can *optionally* use malloc. But I have two questions on how you created the singular-malloc spkg.\n\nRecall that I have removed (or at least I tried to remove) all auto-generated files that I found in your spkg in order to make it work on my `openSuse` laptop. The changes compared with the original sources are:\n\n```\nM src/Singular/Makefile.in\nM src/Singular/Minor.h\nM src/Singular/configure\nM src/Singular/configure.in\nM src/Singular/sing_win.cc\nM src/factory/assert.h\nM src/factory/cf_chinese.cc\nM src/factory/cf_util.cc\nM src/factory/cf_util.h\nM src/factory/facBivar.h\nM src/factory/facFactorize.h\nM src/factory/facFqBivar.cc\nM src/omalloc/Makefile.in\nM src/omalloc/omAllocDecl.h\nM src/omalloc/omAllocFunc.c\nM src/omalloc/omMallocSystem.h\nM src/omalloc/omalloc.c\nM src/omalloc/pmalloc.h\n? src/factory/gen_cf_gmp.sh\n? src/omalloc/omTables.h\n? src/omalloc/omTables.inc\n```\nSo, first question: Is it correct that all three new files are needed for malloc support? I'd rather think that `gen_cf_gmp.sh` should not be here, because it contains explicit paths:\n\n```\n#!/bin/sh\nGMP_H_T=\"gen_cf_gmp.o: gen_cf_gmp.cc /usr/local/sage/5.5b1/local/include/gmp.h \\ \"\nGMP_H=`echo $GMP_H_T| sed -e 's/^.*gmp.cc//' -e 's/ .$//'`\necho generating cf_gmp.h from $GMP_H\ncat $GMP_H | grep -v __GMP_DECLSPEC_XX |grep -v std::FILE > cf_gmp.h\n```\n\nSecond question: Is it not the case that `src/Singular/configure` is auto-generated from `src/Singular/configure.in`? Or is it really essential that `src/Singular/configure` is as in your spkg?",
    "created_at": "2012-11-24T08:27:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163859",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:45'>Comment 45:</a>
Now I try to patch the standard Singular spkg so that one can *optionally* use malloc. But I have two questions on how you created the singular-malloc spkg.

Recall that I have removed (or at least I tried to remove) all auto-generated files that I found in your spkg in order to make it work on my `openSuse` laptop. The changes compared with the original sources are:

```
M src/Singular/Makefile.in
M src/Singular/Minor.h
M src/Singular/configure
M src/Singular/configure.in
M src/Singular/sing_win.cc
M src/factory/assert.h
M src/factory/cf_chinese.cc
M src/factory/cf_util.cc
M src/factory/cf_util.h
M src/factory/facBivar.h
M src/factory/facFactorize.h
M src/factory/facFqBivar.cc
M src/omalloc/Makefile.in
M src/omalloc/omAllocDecl.h
M src/omalloc/omAllocFunc.c
M src/omalloc/omMallocSystem.h
M src/omalloc/omalloc.c
M src/omalloc/pmalloc.h
? src/factory/gen_cf_gmp.sh
? src/omalloc/omTables.h
? src/omalloc/omTables.inc
```
So, first question: Is it correct that all three new files are needed for malloc support? I'd rather think that `gen_cf_gmp.sh` should not be here, because it contains explicit paths:

```
#!/bin/sh
GMP_H_T="gen_cf_gmp.o: gen_cf_gmp.cc /usr/local/sage/5.5b1/local/include/gmp.h \ "
GMP_H=`echo $GMP_H_T| sed -e 's/^.*gmp.cc//' -e 's/ .$//'`
echo generating cf_gmp.h from $GMP_H
cat $GMP_H | grep -v __GMP_DECLSPEC_XX |grep -v std::FILE > cf_gmp.h
```

Second question: Is it not the case that `src/Singular/configure` is auto-generated from `src/Singular/configure.in`? Or is it really essential that `src/Singular/configure` is as in your spkg?



---

archive/issue_comments_163860.json:
```json
{
    "body": "<a id='comment:46'>Comment 46:</a>\nPS: Actually it seems to me that the changes in `src/Singular/configure.in` and `src/Singular/configure` are due to the patch `patches/singular_trac_443.patch` that is to be applied anyway.",
    "created_at": "2012-11-24T08:35:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163860",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'>Comment 46:</a>
PS: Actually it seems to me that the changes in `src/Singular/configure.in` and `src/Singular/configure` are due to the patch `patches/singular_trac_443.patch` that is to be applied anyway.



---

archive/issue_comments_163861.json:
```json
{
    "body": "<a id='comment:47'>Comment 47:</a>\n`src/omalloc/omTables.inc` doesn't state that it is auto-generated, but it certainly looks like.\n\nSo, third question: Did you write `src/omalloc/omTables.inc` yourself? Or can I safely delete it?",
    "created_at": "2012-11-24T08:39:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163861",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'>Comment 47:</a>
`src/omalloc/omTables.inc` doesn't state that it is auto-generated, but it certainly looks like.

So, third question: Did you write `src/omalloc/omTables.inc` yourself? Or can I safely delete it?



---

archive/issue_comments_163862.json:
```json
{
    "body": "<a id='comment:48'>Comment 48:</a>\nReplying to [@simon-king-jena](#comment%3A45):\n> \n> ```\n> M src/omalloc/omAllocDecl.h\n> M src/omalloc/omAllocFunc.c\n> M src/omalloc/omMallocSystem.h\n> M src/omalloc/omalloc.c\n> M src/omalloc/pmalloc.h\n> ```\n> So, first question: Is it correct that all three new files are needed for malloc support?\n\nI didn't make any new files and I only seriously edited things in the `omalloc` directory. I may have done some rough hacking in config files to ensure that the changes took effect, but I believe that it should be possible to do without by someone who know how to pass the correct options to configure etc.\n\nTo make the \"spkg\" I only did a \"make clean\" and a command to make the dir into a spkg. I disabled the \"patch application\" in spkg-install because that made it fail the second time I ran it (which is inconvenient when you're editing the package!)\n\nNote that `malloc_usable_size` for glibc has the same function as `malloc_size` on BSD (OSX), so if there's a convenient config option to choose between the two you can make the spkg so that it compiles on both.\n\nThe omalloc package is obviously written in such a way that it can build in different ways, depending on config options passed at build-time. What I did was resurrect one of those options (it didn't provide all the functionality that singular needs). It should be possible to adapt my changes accordingly. Then it's not essential to conditionally apply the patches. It's just that I have zero experience with all the \"#ifdef\" voodoo that seems to be associated with production-quality code.\n\nI found that \"meld\" was a very convenient way of browsing the changes I'd made (comparing against a pristine directory). It can do a graphically displayed diff on an entire tree. It's what I used to make the linux package from the OSX one I had.",
    "created_at": "2012-11-24T08:53:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163862",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:48'>Comment 48:</a>
Replying to [@simon-king-jena](#comment%3A45):
> 
> ```
> M src/omalloc/omAllocDecl.h
> M src/omalloc/omAllocFunc.c
> M src/omalloc/omMallocSystem.h
> M src/omalloc/omalloc.c
> M src/omalloc/pmalloc.h
> ```
> So, first question: Is it correct that all three new files are needed for malloc support?

I didn't make any new files and I only seriously edited things in the `omalloc` directory. I may have done some rough hacking in config files to ensure that the changes took effect, but I believe that it should be possible to do without by someone who know how to pass the correct options to configure etc.

To make the "spkg" I only did a "make clean" and a command to make the dir into a spkg. I disabled the "patch application" in spkg-install because that made it fail the second time I ran it (which is inconvenient when you're editing the package!)

Note that `malloc_usable_size` for glibc has the same function as `malloc_size` on BSD (OSX), so if there's a convenient config option to choose between the two you can make the spkg so that it compiles on both.

The omalloc package is obviously written in such a way that it can build in different ways, depending on config options passed at build-time. What I did was resurrect one of those options (it didn't provide all the functionality that singular needs). It should be possible to adapt my changes accordingly. Then it's not essential to conditionally apply the patches. It's just that I have zero experience with all the "#ifdef" voodoo that seems to be associated with production-quality code.

I found that "meld" was a very convenient way of browsing the changes I'd made (comparing against a pristine directory). It can do a graphically displayed diff on an entire tree. It's what I used to make the linux package from the OSX one I had.



---

archive/issue_comments_163863.json:
```json
{
    "body": "<a id='comment:49'>Comment 49:</a>\nReplying to [@nbruin](#comment%3A48):\n> Replying to [@simon-king-jena](#comment%3A45):\n> > \n> > ```\n> > M src/omalloc/omAllocDecl.h\n> > M src/omalloc/omAllocFunc.c\n> > M src/omalloc/omMallocSystem.h\n> > M src/omalloc/omalloc.c\n> > M src/omalloc/pmalloc.h\n> > ```\n> > So, first question: Is it correct that all three new files are needed for malloc support?\n\n> \n> I didn't make any new files and I only seriously edited things in the `omalloc` directory.\n\nOK, so, I assume you only edited the five files indicated above, and did no other changes by yourself.\n\n> I may have done some rough hacking in config files to ensure that the changes took effect, but I believe that it should be possible to do without by someone who know how to pass the correct options to configure etc.\n\nWell, I don't know. \n\n> To make the \"spkg\" I only did a \"make clean\" and a command to make the dir into a spkg.\n\nThat means that *all* patches from the `patches/` directory are applied in your code, and if `make clean` is imperfect then it also means that some auto-generated (machine dependent) files are in your code.\n\n> I disabled the \"patch application\" in spkg-install because that made it fail the second time I ran it (which is inconvenient when you're editing the package!)\n\nSure, because you started with code that already contains all patches.\n\n> Note that `malloc_usable_size` for glibc has the same function as `malloc_size` on BSD (OSX), so if there's a convenient config option to choose between the two you can make the spkg so that it compiles on both.\n\nHm. I see the following definition\n\n`src/omalloc/dlmalloc.h`\n\n```\n/* define to -1 if you want that this implementation provides\n   malloc/calloc/realloc/free funcs */\n#ifndef OM_PROVIDE_MALLOC\n#define OM_PROVIDE_MALLOC 0\n#endif\n\n#ifndef HAVE__USR_INCLUDE_MALLOC_H\n#undef  HAVE__USR_INCLUDE_MALLOC_H\n#endif\n\n#ifdef HAVE__USR_INCLUDE_MALLOC_H\n#define HAVE_USR_INCLUDE_MALLOC_H 1\n#endif\n\n#define OM_MALLOC_MALLOC   mALLOc\n#define OM_MALLOC_REALLOC  rEALLOc\n#define OM_MALLOC_FREE     fREe\n#define OM_MALLOC_VALLOC   vALLOc\n#define OM_MALLOC_VFREE(addr, size) OM_MALLOC_FREE(addr)\n#define OM_MALLOC_SIZEOF_ADDR(addr) malloc_usable_size(addr)\n#define cfree cFREe\n```\n\nI don't totally understand the comment \"define to -1 if you want that this implementation provides malloc/calloc/realloc/free func\". Does that perhaps mean that `export OM_PROVIDE_MALLOC=-1` is all what one need to use system malloc?\n\nBut I wonder: You say that `malloc_usable_size` is not available on OSX. Then, the line\n\n```\n#define OM_MALLOC_SIZEOF_ADDR(addr) malloc_usable_size(addr)\n```\nsounds like a bug to me. I'll ask Hannes.",
    "created_at": "2012-11-24T09:50:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163863",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:49'>Comment 49:</a>
Replying to [@nbruin](#comment%3A48):
> Replying to [@simon-king-jena](#comment%3A45):
> > 
> > ```
> > M src/omalloc/omAllocDecl.h
> > M src/omalloc/omAllocFunc.c
> > M src/omalloc/omMallocSystem.h
> > M src/omalloc/omalloc.c
> > M src/omalloc/pmalloc.h
> > ```
> > So, first question: Is it correct that all three new files are needed for malloc support?

> 
> I didn't make any new files and I only seriously edited things in the `omalloc` directory.

OK, so, I assume you only edited the five files indicated above, and did no other changes by yourself.

> I may have done some rough hacking in config files to ensure that the changes took effect, but I believe that it should be possible to do without by someone who know how to pass the correct options to configure etc.

Well, I don't know. 

> To make the "spkg" I only did a "make clean" and a command to make the dir into a spkg.

That means that *all* patches from the `patches/` directory are applied in your code, and if `make clean` is imperfect then it also means that some auto-generated (machine dependent) files are in your code.

> I disabled the "patch application" in spkg-install because that made it fail the second time I ran it (which is inconvenient when you're editing the package!)

Sure, because you started with code that already contains all patches.

> Note that `malloc_usable_size` for glibc has the same function as `malloc_size` on BSD (OSX), so if there's a convenient config option to choose between the two you can make the spkg so that it compiles on both.

Hm. I see the following definition

`src/omalloc/dlmalloc.h`

```
/* define to -1 if you want that this implementation provides
   malloc/calloc/realloc/free funcs */
#ifndef OM_PROVIDE_MALLOC
#define OM_PROVIDE_MALLOC 0
#endif

#ifndef HAVE__USR_INCLUDE_MALLOC_H
#undef  HAVE__USR_INCLUDE_MALLOC_H
#endif

#ifdef HAVE__USR_INCLUDE_MALLOC_H
#define HAVE_USR_INCLUDE_MALLOC_H 1
#endif

#define OM_MALLOC_MALLOC   mALLOc
#define OM_MALLOC_REALLOC  rEALLOc
#define OM_MALLOC_FREE     fREe
#define OM_MALLOC_VALLOC   vALLOc
#define OM_MALLOC_VFREE(addr, size) OM_MALLOC_FREE(addr)
#define OM_MALLOC_SIZEOF_ADDR(addr) malloc_usable_size(addr)
#define cfree cFREe
```

I don't totally understand the comment "define to -1 if you want that this implementation provides malloc/calloc/realloc/free func". Does that perhaps mean that `export OM_PROVIDE_MALLOC=-1` is all what one need to use system malloc?

But I wonder: You say that `malloc_usable_size` is not available on OSX. Then, the line

```
#define OM_MALLOC_SIZEOF_ADDR(addr) malloc_usable_size(addr)
```
sounds like a bug to me. I'll ask Hannes.



---

archive/issue_comments_163864.json:
```json
{
    "body": "<a id='comment:50'>Comment 50:</a>\nReplying to [@simon-king-jena](#comment%3A49):\n> But I wonder: You say that `malloc_usable_size` is not available on OSX. Then, the line\n> \n> ```\n> #define OM_MALLOC_SIZEOF_ADDR(addr) malloc_usable_size(addr)\n> ```\n> sounds like a bug to me. I'll ask Hannes.\n\nThat definition only occurs in `dlmalloc.h`, right? I don't think other files import that header file, so probably `dlmalloc` only gets used under certain configure options. I wasn't able to trace through how omalloc gets configured/built. It seems to be a value for configure:\n\n```\n --with-malloc=system|dlmalloc|gmalloc|pmalloc|external\n```\n(given that singular builds just fine on OSX this cannot be a real problem)\n\nBut yes, these changes are best made with input from someone familiar with omalloc, so hopefully Hannes can help.",
    "created_at": "2012-11-24T18:21:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163864",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:50'>Comment 50:</a>
Replying to [@simon-king-jena](#comment%3A49):
> But I wonder: You say that `malloc_usable_size` is not available on OSX. Then, the line
> 
> ```
> #define OM_MALLOC_SIZEOF_ADDR(addr) malloc_usable_size(addr)
> ```
> sounds like a bug to me. I'll ask Hannes.

That definition only occurs in `dlmalloc.h`, right? I don't think other files import that header file, so probably `dlmalloc` only gets used under certain configure options. I wasn't able to trace through how omalloc gets configured/built. It seems to be a value for configure:

```
 --with-malloc=system|dlmalloc|gmalloc|pmalloc|external
```
(given that singular builds just fine on OSX this cannot be a real problem)

But yes, these changes are best made with input from someone familiar with omalloc, so hopefully Hannes can help.



---

archive/issue_comments_163865.json:
```json
{
    "body": "<a id='comment:51'>Comment 51:</a>\nReplying to [@nbruin](#comment%3A50):\n> It seems to be a value for configure:\n> \n> ```\n>  --with-malloc=system|dlmalloc|gmalloc|pmalloc|external\n> ```\n\nThen the question arises: Why is it not enough to pass the `--with-malloc=system` to Singular? Why did the additional changes become necessary that you made on five files in `src/omalloc/`?\n\nFor example, you edited `src/omalloc/omAllocDecl.h` to make the emulation unconditional. Is that really needed, if there is a configuration option anyway?\n\n> But yes, these changes are best made with input from someone familiar with omalloc, so hopefully Hannes can help.\n\nI asked, but he didn't reply yet. Well, it's week-end, after all...",
    "created_at": "2012-11-24T20:25:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163865",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:51'>Comment 51:</a>
Replying to [@nbruin](#comment%3A50):
> It seems to be a value for configure:
> 
> ```
>  --with-malloc=system|dlmalloc|gmalloc|pmalloc|external
> ```

Then the question arises: Why is it not enough to pass the `--with-malloc=system` to Singular? Why did the additional changes become necessary that you made on five files in `src/omalloc/`?

For example, you edited `src/omalloc/omAllocDecl.h` to make the emulation unconditional. Is that really needed, if there is a configuration option anyway?

> But yes, these changes are best made with input from someone familiar with omalloc, so hopefully Hannes can help.

I asked, but he didn't reply yet. Well, it's week-end, after all...



---

archive/issue_comments_163866.json:
```json
{
    "body": "<a id='comment:52'>Comment 52:</a>\nReplying to [@simon-king-jena](#comment%3A51):\n> Replying to [@nbruin](#comment%3A50):\n> > It seems to be a value for configure:\n> > \n> > ```\n> >  --with-malloc=system|dlmalloc|gmalloc|pmalloc|external\n> > ```\n\n> Then the question arises: Why is it not enough to pass the `--with-malloc=system` to Singular? Why did the additional changes become necessary that you made on five files in `src/omalloc/`?\n\nI think I can explain that: omalloc is written to work *on top of* another memory manager. It doesn't call `mmap` or `sbrk` by itself. So I think this option selects which malloc is used to serve omalloc with pages.\n\n`dlmalloc` is simply a full-fledged memory manager that happens to be shipped with omalloc and can be used as a backend. If you look in `dlmalloc.c`, there is actually an implementation of `malloc_usable_size`. So I guess you can build omalloc in a way that is independent of the malloc offered by the clib and just uses system calls to `mmap` or `sbrk` directly.\n\nThe *other* configuration options (you'll have to read up on it to be sure) deal with what services omalloc provides and how it does it.\n\nThere's an option that selects whether omalloc should offer the standard 'malloc/realloc/free' interface to its own allocators.\n\nThere is also an option that selects how omalloc does its job: whether it should do what it is designed for or whether it should just honour the requests it receives by passing them on 1-1 to the underlying memory allocator. That's the option that had fallen into disuse within singular and had become defunct. I tried to bring its functionality back to the level required for singular. I hacked my way to getting omalloc to compile in that mode. However, I'm sure this can be done in a nicer fashion.\n \n> For example, you edited `src/omalloc/omAllocDecl.h` to make the emulation unconditional. Is that really needed, if there is a configuration option anyway?\n\nNo I'm sure it's not. I didn't figure out a way that positively confirmed for me that just passing in an option helped (partially because I couldn't interact directly with the singular configure script: the spkg-install plays games too in order to build both an executable and libsingular). But someone more familiar with how configure and conditional compilation setups usually work can probably very easily put that in order.",
    "created_at": "2012-11-24T21:53:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163866",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:52'>Comment 52:</a>
Replying to [@simon-king-jena](#comment%3A51):
> Replying to [@nbruin](#comment%3A50):
> > It seems to be a value for configure:
> > 
> > ```
> >  --with-malloc=system|dlmalloc|gmalloc|pmalloc|external
> > ```

> Then the question arises: Why is it not enough to pass the `--with-malloc=system` to Singular? Why did the additional changes become necessary that you made on five files in `src/omalloc/`?

I think I can explain that: omalloc is written to work *on top of* another memory manager. It doesn't call `mmap` or `sbrk` by itself. So I think this option selects which malloc is used to serve omalloc with pages.

`dlmalloc` is simply a full-fledged memory manager that happens to be shipped with omalloc and can be used as a backend. If you look in `dlmalloc.c`, there is actually an implementation of `malloc_usable_size`. So I guess you can build omalloc in a way that is independent of the malloc offered by the clib and just uses system calls to `mmap` or `sbrk` directly.

The *other* configuration options (you'll have to read up on it to be sure) deal with what services omalloc provides and how it does it.

There's an option that selects whether omalloc should offer the standard 'malloc/realloc/free' interface to its own allocators.

There is also an option that selects how omalloc does its job: whether it should do what it is designed for or whether it should just honour the requests it receives by passing them on 1-1 to the underlying memory allocator. That's the option that had fallen into disuse within singular and had become defunct. I tried to bring its functionality back to the level required for singular. I hacked my way to getting omalloc to compile in that mode. However, I'm sure this can be done in a nicer fashion.
 
> For example, you edited `src/omalloc/omAllocDecl.h` to make the emulation unconditional. Is that really needed, if there is a configuration option anyway?

No I'm sure it's not. I didn't figure out a way that positively confirmed for me that just passing in an option helped (partially because I couldn't interact directly with the singular configure script: the spkg-install plays games too in order to build both an executable and libsingular). But someone more familiar with how configure and conditional compilation setups usually work can probably very easily put that in order.



---

archive/issue_comments_163867.json:
```json
{
    "body": "<a id='comment:53'>Comment 53:</a>\nReplying to [@nbruin](#comment%3A52):\n> I think I can explain that: omalloc is written to work *on top of* another memory manager.\n\nSo, that is `--with-malloc=...`.\n\n> There's an option that selects whether omalloc should offer the standard 'malloc/realloc/free' interface to its own allocators.\n\nWhat does that mean? If one uses omalloc, why should one *not* want that it offers `malloc/realloc/free`?\n \n> There is also an option that selects how omalloc does its job: whether it should do what it is designed for or whether it should just honour the requests it receives by passing them on 1-1 to the underlying memory allocator.\n\nSo, that's the option that we need, right? Is that `--with-emulate-omalloc` that you added to spkg-install?\n\nI guess I am now experiencing the same that you did: If `--with-emulate-omalloc` is the *only* change, then installing the spkg fails with\n\n```\nIn file included from ../kernel/bigintmat.h:13:0,\n                 from bigintmat.cc:10:\n../kernel/intvec.h: In constructor \u2018intvec::intvec(int)\u2019:\n../kernel/intvec.h:26:18: error: \u2018omEmulateAlloc0\u2019 was not declared in this scope\nbigintmat.cc: In member function \u2018int* bigintmat::getwid(int)\u2019:\nbigintmat.cc:379:31: error: \u2018omStrDup\u2019 was not declared in this scope\nbigintmat.cc: In member function \u2018void bigintmat::pprint(int)\u2019:\nbigintmat.cc:414:18: error: \u2018omEmulateAlloc0\u2019 was not declared in this scope\nbigintmat.cc:421:32: error: \u2018omStrDup\u2019 was not declared in this scope\n```",
    "created_at": "2012-11-24T22:07:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163867",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:53'>Comment 53:</a>
Replying to [@nbruin](#comment%3A52):
> I think I can explain that: omalloc is written to work *on top of* another memory manager.

So, that is `--with-malloc=...`.

> There's an option that selects whether omalloc should offer the standard 'malloc/realloc/free' interface to its own allocators.

What does that mean? If one uses omalloc, why should one *not* want that it offers `malloc/realloc/free`?
 
> There is also an option that selects how omalloc does its job: whether it should do what it is designed for or whether it should just honour the requests it receives by passing them on 1-1 to the underlying memory allocator.

So, that's the option that we need, right? Is that `--with-emulate-omalloc` that you added to spkg-install?

I guess I am now experiencing the same that you did: If `--with-emulate-omalloc` is the *only* change, then installing the spkg fails with

```
In file included from ../kernel/bigintmat.h:13:0,
                 from bigintmat.cc:10:
../kernel/intvec.h: In constructor ‘intvec::intvec(int)’:
../kernel/intvec.h:26:18: error: ‘omEmulateAlloc0’ was not declared in this scope
bigintmat.cc: In member function ‘int* bigintmat::getwid(int)’:
bigintmat.cc:379:31: error: ‘omStrDup’ was not declared in this scope
bigintmat.cc: In member function ‘void bigintmat::pprint(int)’:
bigintmat.cc:414:18: error: ‘omEmulateAlloc0’ was not declared in this scope
bigintmat.cc:421:32: error: ‘omStrDup’ was not declared in this scope
```



---

archive/issue_comments_163868.json:
```json
{
    "body": "<a id='comment:54'>Comment 54:</a>\nReplying to [@simon-king-jena](#comment%3A53):\n> > There's an option that selects whether omalloc should offer the standard 'malloc/realloc/free' interface to its own allocators.\n\n> \n> What does that mean? If one uses omalloc, why should one *not* want that it offers `malloc/realloc/free`?\n\nIt selects whether omalloc should offer its services *under those names*, i.e., as a drop-in replacement for the standard libc memory manager. That's not what Singular does. It uses the various *omalloc* routines, which offer extra options. Otherwise, changing Singular would have been a matter of \"dropping out\" the drop-in replacement. Instead we have to jump through hoops to get omalloc to use libc's malloc (or whatever drop-in replacement we want to use, like ElectricFence) behind the scenes.",
    "created_at": "2012-11-25T03:28:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163868",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:54'>Comment 54:</a>
Replying to [@simon-king-jena](#comment%3A53):
> > There's an option that selects whether omalloc should offer the standard 'malloc/realloc/free' interface to its own allocators.

> 
> What does that mean? If one uses omalloc, why should one *not* want that it offers `malloc/realloc/free`?

It selects whether omalloc should offer its services *under those names*, i.e., as a drop-in replacement for the standard libc memory manager. That's not what Singular does. It uses the various *omalloc* routines, which offer extra options. Otherwise, changing Singular would have been a matter of "dropping out" the drop-in replacement. Instead we have to jump through hoops to get omalloc to use libc's malloc (or whatever drop-in replacement we want to use, like ElectricFence) behind the scenes.



---

archive/issue_comments_163869.json:
```json
{
    "body": "<a id='comment:55'>Comment 55:</a>\nReplying to [@simon-king-jena](#comment%3A53):\n> I guess I am now experiencing the same that you did: If `--with-emulate-omalloc` is the *only* change, then installing the spkg fails with\n> \n> ```\n> In file included from ../kernel/bigintmat.h:13:0,\n>                  from bigintmat.cc:10:\n> ../kernel/intvec.h: In constructor \u2018intvec::intvec(int)\u2019:\n> ../kernel/intvec.h:26:18: error: \u2018omEmulateAlloc0\u2019 was not declared in this scope\n> bigintmat.cc: In member function \u2018int* bigintmat::getwid(int)\u2019:\n> bigintmat.cc:379:31: error: \u2018omStrDup\u2019 was not declared in this scope\n> bigintmat.cc: In member function \u2018void bigintmat::pprint(int)\u2019:\n> bigintmat.cc:414:18: error: \u2018omEmulateAlloc0\u2019 was not declared in this scope\n> bigintmat.cc:421:32: error: \u2018omStrDup\u2019 was not declared in this scope\n> ```\n\nYay! indeed. Those are some of the routines I provided. So yes, it's probably best if you just use my changes for information and as hints for how to provide the missing functionality, but then integrate it more cleanly (I had a couple of rounds of these; the hard one being omMemDup, which you don't seem to hit yet). The `omEmulateAlloc0` is a weird one since that IS implemented in `omAllocEmulate.c` I think I solved that one by simply including the relevant declaration in `omAllocDecl.h`.",
    "created_at": "2012-11-25T03:39:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163869",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:55'>Comment 55:</a>
Replying to [@simon-king-jena](#comment%3A53):
> I guess I am now experiencing the same that you did: If `--with-emulate-omalloc` is the *only* change, then installing the spkg fails with
> 
> ```
> In file included from ../kernel/bigintmat.h:13:0,
>                  from bigintmat.cc:10:
> ../kernel/intvec.h: In constructor ‘intvec::intvec(int)’:
> ../kernel/intvec.h:26:18: error: ‘omEmulateAlloc0’ was not declared in this scope
> bigintmat.cc: In member function ‘int* bigintmat::getwid(int)’:
> bigintmat.cc:379:31: error: ‘omStrDup’ was not declared in this scope
> bigintmat.cc: In member function ‘void bigintmat::pprint(int)’:
> bigintmat.cc:414:18: error: ‘omEmulateAlloc0’ was not declared in this scope
> bigintmat.cc:421:32: error: ‘omStrDup’ was not declared in this scope
> ```

Yay! indeed. Those are some of the routines I provided. So yes, it's probably best if you just use my changes for information and as hints for how to provide the missing functionality, but then integrate it more cleanly (I had a couple of rounds of these; the hard one being omMemDup, which you don't seem to hit yet). The `omEmulateAlloc0` is a weird one since that IS implemented in `omAllocEmulate.c` I think I solved that one by simply including the relevant declaration in `omAllocDecl.h`.



---

archive/issue_comments_163870.json:
```json
{
    "body": "A patch for the singular spkg to produce a libsingular that uses malloc",
    "created_at": "2012-11-25T08:34:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163870",
    "user": "https://github.com/simon-king-jena"
}
```

A patch for the singular spkg to produce a libsingular that uses malloc



---

archive/issue_comments_163871.json:
```json
{
    "body": "<a id='comment:56'>Comment 56:</a>\nAttachment: **[sage_trac_13731.patch.gz](https://github.com/sagemath/sage/files/ticket13731/sage_trac_13731.patch.gz)**\n\nWhat I did to produce a singular spkg that produces a malloc-libsingular:\n\n* Drop [attachment: sage_trac_13731.patch.gz](https://github.com/sagemath/sage/files/ticket13731/sage_trac_13731.patch.gz) into the spkg's `patches/` directory\n* Apply the following change to spkg-install:\n\n   ```patch\n   diff --git a/spkg-install b/spkg-install\n   --- a/spkg-install\n   +++ b/spkg-install\n   @@ -134,6 +134,7 @@\n                    --libdir=\"$SAGE_LOCAL\"/lib \\\n                    --with-apint=gmp \\\n                    --with-malloc=system \\\n   +                --with-emulate-omalloc \\\n                    --with-NTL \\\n                    --without-MP \\\n                    --without-lex \\\n  ```\n\nWith that, I seem to get a working libsingular, and I get the due segfault with `export MALLOC_CHECK_=3` in the example of the ticket description. However, I do not obtain a working Singular executable.\n\nI am now testing whether the spkg works on bsd.math as well.",
    "created_at": "2012-11-25T08:39:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163871",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:56'>Comment 56:</a>
Attachment: **[sage_trac_13731.patch.gz](https://github.com/sagemath/sage/files/ticket13731/sage_trac_13731.patch.gz)**

What I did to produce a singular spkg that produces a malloc-libsingular:

* Drop [attachment: sage_trac_13731.patch.gz](https://github.com/sagemath/sage/files/ticket13731/sage_trac_13731.patch.gz) into the spkg's `patches/` directory
* Apply the following change to spkg-install:

   ```patch
   diff --git a/spkg-install b/spkg-install
   --- a/spkg-install
   +++ b/spkg-install
   @@ -134,6 +134,7 @@
                    --libdir="$SAGE_LOCAL"/lib \
                    --with-apint=gmp \
                    --with-malloc=system \
   +                --with-emulate-omalloc \
                    --with-NTL \
                    --without-MP \
                    --without-lex \
  ```

With that, I seem to get a working libsingular, and I get the due segfault with `export MALLOC_CHECK_=3` in the example of the ticket description. However, I do not obtain a working Singular executable.

I am now testing whether the spkg works on bsd.math as well.



---

archive/issue_comments_163872.json:
```json
{
    "body": "<a id='comment:57'>Comment 57:</a>\nUnfortunately, it does *not* work on bsd.math: The problem appears to be that there is no malloc.h available:\n\n```\nIn file included from ./omalloc.h:785:0,\n                 from omalloc.c:16:\n../omalloc/omMalloc.h:12:20: fatal error: malloc.h: No such file or directory\ncompilation terminated.\n```\n\nThat's really strange. Shouldn't malloc be available system wide?",
    "created_at": "2012-11-25T08:59:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163872",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:57'>Comment 57:</a>
Unfortunately, it does *not* work on bsd.math: The problem appears to be that there is no malloc.h available:

```
In file included from ./omalloc.h:785:0,
                 from omalloc.c:16:
../omalloc/omMalloc.h:12:20: fatal error: malloc.h: No such file or directory
compilation terminated.
```

That's really strange. Shouldn't malloc be available system wide?



---

archive/issue_comments_163873.json:
```json
{
    "body": "<a id='comment:58'>Comment 58:</a>\nbsd.math is OS X, isn't it? I think I had trouble with that recently because malloc.h is in a subdirectory - not at the top level. You would need an extra -I I guess. I'll see if I can find it.",
    "created_at": "2012-11-25T09:04:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163873",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:58'>Comment 58:</a>
bsd.math is OS X, isn't it? I think I had trouble with that recently because malloc.h is in a subdirectory - not at the top level. You would need an extra -I I guess. I'll see if I can find it.



---

archive/issue_comments_163874.json:
```json
{
    "body": "<a id='comment:59'>Comment 59:</a>\nIt is in /usr/include/malloc/",
    "created_at": "2012-11-25T09:06:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163874",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:59'>Comment 59:</a>
It is in /usr/include/malloc/



---

archive/issue_comments_163875.json:
```json
{
    "body": "<a id='comment:60'>Comment 60:</a>\nI am puzzled.\n\nWhen I put\n\n```\n#if defined(ix86Mac_darwin) || defined(x86_64Mac_darwin) || defined(ppcMac_darwin)\n#include <malloc/malloc.h>\n#else\n#include <malloc.h>\n#endif\n```\nin `src/omalloc/omMallocSystem.h` (which is responsible for including malloc.h), things do still not work and it still complains that it can not find malloc.h. But in the installation log, I see the line\n\n```\nchecking uname for singular... (cached) x86_64Mac-darwin\n```\nand `omMalloc.h` is created only *after* that line. Hence I don't understand why it doesn't try to pick up `malloc/malloc.h`.",
    "created_at": "2012-11-25T09:39:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163875",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:60'>Comment 60:</a>
I am puzzled.

When I put

```
#if defined(ix86Mac_darwin) || defined(x86_64Mac_darwin) || defined(ppcMac_darwin)
#include <malloc/malloc.h>
#else
#include <malloc.h>
#endif
```
in `src/omalloc/omMallocSystem.h` (which is responsible for including malloc.h), things do still not work and it still complains that it can not find malloc.h. But in the installation log, I see the line

```
checking uname for singular... (cached) x86_64Mac-darwin
```
and `omMalloc.h` is created only *after* that line. Hence I don't understand why it doesn't try to pick up `malloc/malloc.h`.



---

archive/issue_comments_163876.json:
```json
{
    "body": "<a id='comment:61'>Comment 61:</a>\nReplying to [@simon-king-jena](#comment%3A60):\n> \n> ```\n> #if defined(ix86Mac_darwin) || defined(x86_64Mac_darwin) || defined(ppcMac_darwin)\n> #include <malloc/malloc.h>\n> #else\n> #include <malloc.h>\n> #endif\n> ```\n> \n> ```\n> checking uname for singular... (cached) x86_64Mac-darwin\n> ```\n\nHow nasty! It defines `x86_64Mac-darwin`, but the person who originally wrote the check for the platforms wrote `x86_64Mac_darwin`!!",
    "created_at": "2012-11-25T09:41:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163876",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:61'>Comment 61:</a>
Replying to [@simon-king-jena](#comment%3A60):
> 
> ```
> #if defined(ix86Mac_darwin) || defined(x86_64Mac_darwin) || defined(ppcMac_darwin)
> #include <malloc/malloc.h>
> #else
> #include <malloc.h>
> #endif
> ```
> 
> ```
> checking uname for singular... (cached) x86_64Mac-darwin
> ```

How nasty! It defines `x86_64Mac-darwin`, but the person who originally wrote the check for the platforms wrote `x86_64Mac_darwin`!!



---

archive/issue_comments_163877.json:
```json
{
    "body": "<a id='comment:62'>Comment 62:</a>\nRool eyes.... but not completely surprised.",
    "created_at": "2012-11-25T09:47:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163877",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:62'>Comment 62:</a>
Rool eyes.... but not completely surprised.



---

archive/issue_comments_163878.json:
```json
{
    "body": "<a id='comment:63'>Comment 63:</a>\nReplying to [@kiwifb](#comment%3A62):\n> Rool eyes.... but not completely surprised.\n\nBut on the other hand, it can not be \"-\" (minus sign!) between Mac and darwin. Anyway. There must be a test on which platform we are. How to?",
    "created_at": "2012-11-25T09:53:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163878",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:63'>Comment 63:</a>
Replying to [@kiwifb](#comment%3A62):
> Rool eyes.... but not completely surprised.

But on the other hand, it can not be "-" (minus sign!) between Mac and darwin. Anyway. There must be a test on which platform we are. How to?



---

archive/issue_comments_163879.json:
```json
{
    "body": "<a id='comment:64'>Comment 64:</a>\nI am not sure what you would get for a non-mac darwin target, otherwise the easiest thing is probably \ngcc -dumpmachine, On my 10.5.8 machine:\n\n```\nBlueFerniMac1:~ frb15$ gcc -dumpmachine\ni686-apple-darwin9\n```",
    "created_at": "2012-11-25T10:07:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163879",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:64'>Comment 64:</a>
I am not sure what you would get for a non-mac darwin target, otherwise the easiest thing is probably 
gcc -dumpmachine, On my 10.5.8 machine:

```
BlueFerniMac1:~ frb15$ gcc -dumpmachine
i686-apple-darwin9
```



---

archive/issue_comments_163880.json:
```json
{
    "body": "<a id='comment:65'>Comment 65:</a>\nReplying to [@kiwifb](#comment%3A64):\n> I am not sure what you would get for a non-mac darwin target, otherwise the easiest thing is probably \n> gcc -dumpmachine, On my 10.5.8 machine:\n> \n> ```\n> BlueFerniMac1:~ frb15$ gcc -dumpmachine\n> i686-apple-darwin9\n> ```\n\nThank you! But I would rather expect that those things are done during configuration, and then the type of the platform is stored in a variable. I'm asking Hans Sch\u00f6nemann how Singular deals with different platforms.",
    "created_at": "2012-11-25T11:06:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163880",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:65'>Comment 65:</a>
Replying to [@kiwifb](#comment%3A64):
> I am not sure what you would get for a non-mac darwin target, otherwise the easiest thing is probably 
> gcc -dumpmachine, On my 10.5.8 machine:
> 
> ```
> BlueFerniMac1:~ frb15$ gcc -dumpmachine
> i686-apple-darwin9
> ```

Thank you! But I would rather expect that those things are done during configuration, and then the type of the platform is stored in a variable. I'm asking Hans Schönemann how Singular deals with different platforms.



---

archive/issue_comments_163881.json:
```json
{
    "body": "Attachment: **[singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz)**\n\nBackporting Singular changeset 15435",
    "created_at": "2012-11-25T19:27:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163881",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz)**

Backporting Singular changeset 15435



---

archive/issue_comments_163882.json:
```json
{
    "body": "<a id='comment:66'>Comment 66:</a>\nI have backported Singular changeset 15435.\n\nWhen I put [attachment: sage_trac_13731.patch.gz](https://github.com/sagemath/sage/files/ticket13731/sage_trac_13731.patch.gz) and [attachment: singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz) into the spkg's patches/ directory and apply the change to spkg-install mentioned in [comment:56](#comment%3A56), then I get\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage \n...\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x._mul_(y)\nx*y\n```\nSo, indeed the original problem got fixed upstream.\n\nPlans:\n\n* My suggestion is to put the second patch (the backported fix) into our standard Singular spkg.\n* We should of course follow the original plan and see whether we can find further sloppy allocations in Singular, so that #715 and friends can be made work in a reliable way.\n* Can someone tell me how to tell autoconf that it shall create a configure script that tells the preprocessor that we are on Darwin and hence must include malloc/malloc.h in place of malloc.h?",
    "created_at": "2012-11-25T19:36:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163882",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:66'>Comment 66:</a>
I have backported Singular changeset 15435.

When I put [attachment: sage_trac_13731.patch.gz](https://github.com/sagemath/sage/files/ticket13731/sage_trac_13731.patch.gz) and [attachment: singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz) into the spkg's patches/ directory and apply the change to spkg-install mentioned in [comment:56](#comment%3A56), then I get

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage 
...
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x._mul_(y)
x*y
```
So, indeed the original problem got fixed upstream.

Plans:

* My suggestion is to put the second patch (the backported fix) into our standard Singular spkg.
* We should of course follow the original plan and see whether we can find further sloppy allocations in Singular, so that #715 and friends can be made work in a reliable way.
* Can someone tell me how to tell autoconf that it shall create a configure script that tells the preprocessor that we are on Darwin and hence must include malloc/malloc.h in place of malloc.h?



---

archive/issue_comments_163883.json:
```json
{
    "body": "<a id='comment:67'>Comment 67:</a>\nAfter more thinking I think you may want to use [AC_CANONICAL_TARGET](http://www.delorie.com/gnu/docs/autoconf/autoconf_127.html) it is usually used for cross compilation but it should work in this case. It is much better than testing gcc since we may want to use clang.",
    "created_at": "2012-11-25T20:22:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163883",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:67'>Comment 67:</a>
After more thinking I think you may want to use [AC_CANONICAL_TARGET](http://www.delorie.com/gnu/docs/autoconf/autoconf_127.html) it is usually used for cross compilation but it should work in this case. It is much better than testing gcc since we may want to use clang.



---

archive/issue_comments_163884.json:
```json
{
    "body": "<a id='comment:68'>Comment 68:</a>\nJust a quick comment: The normal way of using `malloc` is via `#include <stdlib.h>`. It's only because we need `malloc_usable_size` or `malloc_size` that we need `malloc.h`. You're already choosing between those using an `#if defined(...)`, so why not use the same mechanism for the compile?\nGiven that this code should only be relevant for *debug* builds of singular, I don't think it's worth overhauling the process by which omalloc produces its header field.\n\nThe likely programmatic injection point for changes seems to be the `makeheader` script which is invoked in the makefile rule for `malloc.h`, but I'm not sure that that has capabilities of building header files based on conditionals by default.",
    "created_at": "2012-11-25T22:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163884",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:68'>Comment 68:</a>
Just a quick comment: The normal way of using `malloc` is via `#include <stdlib.h>`. It's only because we need `malloc_usable_size` or `malloc_size` that we need `malloc.h`. You're already choosing between those using an `#if defined(...)`, so why not use the same mechanism for the compile?
Given that this code should only be relevant for *debug* builds of singular, I don't think it's worth overhauling the process by which omalloc produces its header field.

The likely programmatic injection point for changes seems to be the `makeheader` script which is invoked in the makefile rule for `malloc.h`, but I'm not sure that that has capabilities of building header files based on conditionals by default.



---

archive/issue_comments_163885.json:
```json
{
    "body": "<a id='comment:69'>Comment 69:</a>\nReplying to [@kiwifb](#comment%3A67):\n> After more thinking I think you may want to use [AC_CANONICAL_TARGET](http://www.delorie.com/gnu/docs/autoconf/autoconf_127.html) it is usually used for cross compilation but it should work in this case. It is much better than testing gcc since we may want to use clang.\n\nMy question was actually not so much about \"How to detect the platform with autoconf?\", because I see in the existing configure.in how it can be done. The question is more \"How to define a symbol, say, `HAVE_DARWIN` so that the preprocessor is aware of it?\".\n\nI tried to do `export HAVE_DARWIN=1` in spkg-build, but it didn't work. I tried `AC_DEFINE(HAVE_DARWIN,1)`, but it didn't work. Here, \"didn't work\" means that the preprocessor has always been in the `else` part of the following lines:\n\n```\n#ifdef HAVE_DARWIN\n#include \"malloc/malloc.h\"\n#else\n#include \"malloc.h\"\n#endif\n```",
    "created_at": "2012-11-26T09:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163885",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:69'>Comment 69:</a>
Replying to [@kiwifb](#comment%3A67):
> After more thinking I think you may want to use [AC_CANONICAL_TARGET](http://www.delorie.com/gnu/docs/autoconf/autoconf_127.html) it is usually used for cross compilation but it should work in this case. It is much better than testing gcc since we may want to use clang.

My question was actually not so much about "How to detect the platform with autoconf?", because I see in the existing configure.in how it can be done. The question is more "How to define a symbol, say, `HAVE_DARWIN` so that the preprocessor is aware of it?".

I tried to do `export HAVE_DARWIN=1` in spkg-build, but it didn't work. I tried `AC_DEFINE(HAVE_DARWIN,1)`, but it didn't work. Here, "didn't work" means that the preprocessor has always been in the `else` part of the following lines:

```
#ifdef HAVE_DARWIN
#include "malloc/malloc.h"
#else
#include "malloc.h"
#endif
```



---

archive/issue_comments_163886.json:
```json
{
    "body": "<a id='comment:70'>Comment 70:</a>\nReplying to [@nbruin](#comment%3A68):\n> Just a quick comment: The normal way of using `malloc` is via `#include <stdlib.h>`. It's only because we need `malloc_usable_size` or `malloc_size` that we need `malloc.h`. You're already choosing between those using an `#if defined(...)`, so why not use the same mechanism for the compile?\n\nWell, I don't know whether that way of chosing works. It definitely does not for the `#include \"malloc.h\"` versus `#include \"malloc/malloc.h\"` thingy.\n\n> The likely programmatic injection point for changes seems to be the `makeheader` script which is invoked in the makefile rule for `malloc.h`, but I'm not sure that that has capabilities of building header files based on conditionals by default.\n\nI haven't looked into that.> Given that this code should only be relevant for *debug* builds of singular, I don't think it's worth overhauling the process by which omalloc produces its header field.\n\nProbably right. We should better focus on using the debug spkg to detect more memory corruptions.\n\nJust to be on the safe side: Does [attachment: singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz) fix all upstream problems that we have detected so far?\n\n* The one from the ticket description is fixed.\n* Is the one from [comment:33](#comment%3A33) addressed?\n* Is the one from [comment:42](#comment%3A42) addressed? I understand that one isn't critical, though.\n* The one from [comment:43](#comment%3A43) does not seem to be addressed, and I think I didn't mention it upstream, yet.",
    "created_at": "2012-11-26T09:46:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163886",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:70'>Comment 70:</a>
Replying to [@nbruin](#comment%3A68):
> Just a quick comment: The normal way of using `malloc` is via `#include <stdlib.h>`. It's only because we need `malloc_usable_size` or `malloc_size` that we need `malloc.h`. You're already choosing between those using an `#if defined(...)`, so why not use the same mechanism for the compile?

Well, I don't know whether that way of chosing works. It definitely does not for the `#include "malloc.h"` versus `#include "malloc/malloc.h"` thingy.

> The likely programmatic injection point for changes seems to be the `makeheader` script which is invoked in the makefile rule for `malloc.h`, but I'm not sure that that has capabilities of building header files based on conditionals by default.

I haven't looked into that.> Given that this code should only be relevant for *debug* builds of singular, I don't think it's worth overhauling the process by which omalloc produces its header field.

Probably right. We should better focus on using the debug spkg to detect more memory corruptions.

Just to be on the safe side: Does [attachment: singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz) fix all upstream problems that we have detected so far?

* The one from the ticket description is fixed.
* Is the one from [comment:33](#comment%3A33) addressed?
* Is the one from [comment:42](#comment%3A42) addressed? I understand that one isn't critical, though.
* The one from [comment:43](#comment%3A43) does not seem to be addressed, and I think I didn't mention it upstream, yet.



---

archive/issue_comments_163887.json:
```json
{
    "body": "<a id='comment:71'>Comment 71:</a>\nI think AC_DEFINE puts stuff in config.h and you would have to include config.h before this piece of code. Having a code file changed from configure is quite some work. I would have to look it up.",
    "created_at": "2012-11-26T09:51:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163887",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:71'>Comment 71:</a>
I think AC_DEFINE puts stuff in config.h and you would have to include config.h before this piece of code. Having a code file changed from configure is quite some work. I would have to look it up.



---

archive/issue_comments_163888.json:
```json
{
    "body": "<a id='comment:72'>Comment 72:</a>\nReplying to [@kiwifb](#comment%3A71):\n> I think AC_DEFINE puts stuff in config.h and you would have to include config.h before this piece of code.\n\nThat's probably it! Is it needed to use `AC_SUBS` as well? I read somewhere that this would do something with a header file, so, it is not clear to me whether `AC_DEFINE` is enough or `AC_SUBS` is needed in addition.",
    "created_at": "2012-11-26T09:59:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163888",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:72'>Comment 72:</a>
Replying to [@kiwifb](#comment%3A71):
> I think AC_DEFINE puts stuff in config.h and you would have to include config.h before this piece of code.

That's probably it! Is it needed to use `AC_SUBS` as well? I read somewhere that this would do something with a header file, so, it is not clear to me whether `AC_DEFINE` is enough or `AC_SUBS` is needed in addition.



---

archive/issue_comments_163889.json:
```json
{
    "body": "<a id='comment:73'>Comment 73:</a>\nReplying to [@simon-king-jena](#comment%3A72):\n> Replying to [@kiwifb](#comment%3A71):\n> > I think AC_DEFINE puts stuff in config.h and you would have to include config.h before this piece of code.\n\n> \n> That's probably it! Is it needed to use `AC_SUBS` as well? I read somewhere that this would do something with a header file, so, it is not clear to me whether `AC_DEFINE` is enough or `AC_SUBS` is needed in addition.\n\nI have read more about it at http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.69/html_node/Defining-Symbols.html and it goes in config.h if AC_CONFIG_HEADERS is called. AC_SUBST usually acts on Makefile.in preferably generated from Makefile.am and you have to put some code for it to work IIRC. Substituting in a specific myfile.c.in is something else altogether, I need to look it up. \n\nI don't know that stuff from the top of my head unfortunately.",
    "created_at": "2012-11-26T10:04:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163889",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:73'>Comment 73:</a>
Replying to [@simon-king-jena](#comment%3A72):
> Replying to [@kiwifb](#comment%3A71):
> > I think AC_DEFINE puts stuff in config.h and you would have to include config.h before this piece of code.

> 
> That's probably it! Is it needed to use `AC_SUBS` as well? I read somewhere that this would do something with a header file, so, it is not clear to me whether `AC_DEFINE` is enough or `AC_SUBS` is needed in addition.

I have read more about it at http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.69/html_node/Defining-Symbols.html and it goes in config.h if AC_CONFIG_HEADERS is called. AC_SUBST usually acts on Makefile.in preferably generated from Makefile.am and you have to put some code for it to work IIRC. Substituting in a specific myfile.c.in is something else altogether, I need to look it up. 

I don't know that stuff from the top of my head unfortunately.



---

archive/issue_comments_163890.json:
```json
{
    "body": "<a id='comment:74'>Comment 74:</a>\nReplying to [@kiwifb](#comment%3A73):\n> I have read more about it at http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.69/html_node/Defining-Symbols.html and it goes in config.h if AC_CONFIG_HEADERS is called.\n\nThank you! So, I'd need to add `AC_CONFIG_HEADERS` as well, because the only place where `AC_CONFIG_HEADER` is used is in `gfanlib/configure.ac`.\n\n> AC_SUBST usually acts on Makefile.in preferably generated from Makefile.am and you have to put some code for it to work IIRC.\n\nMakefile.am does not exist in the Singular sources. However, `AC_SUBST` is used in several places.\n\nAnyway, I guess inserting `AC_CONFIG_HEADERS` is the easiest thing to do.",
    "created_at": "2012-11-26T10:15:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163890",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:74'>Comment 74:</a>
Replying to [@kiwifb](#comment%3A73):
> I have read more about it at http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.69/html_node/Defining-Symbols.html and it goes in config.h if AC_CONFIG_HEADERS is called.

Thank you! So, I'd need to add `AC_CONFIG_HEADERS` as well, because the only place where `AC_CONFIG_HEADER` is used is in `gfanlib/configure.ac`.

> AC_SUBST usually acts on Makefile.in preferably generated from Makefile.am and you have to put some code for it to work IIRC.

Makefile.am does not exist in the Singular sources. However, `AC_SUBST` is used in several places.

Anyway, I guess inserting `AC_CONFIG_HEADERS` is the easiest thing to do.



---

archive/issue_comments_163891.json:
```json
{
    "body": "<a id='comment:75'>Comment 75:</a>\nI wouldn't add AC_CONFIG_HEADERS if it isn't already there. Are you working on the top level or at the Singular folder level? configure.in in Singular does call AC_CONFIG_HEADERS and puts definitions in mod2.h.",
    "created_at": "2012-11-26T10:27:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163891",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:75'>Comment 75:</a>
I wouldn't add AC_CONFIG_HEADERS if it isn't already there. Are you working on the top level or at the Singular folder level? configure.in in Singular does call AC_CONFIG_HEADERS and puts definitions in mod2.h.



---

archive/issue_comments_163892.json:
```json
{
    "body": "<a id='comment:76'>Comment 76:</a>\nReplying to [@kiwifb](#comment%3A75):\n> I wouldn't add AC_CONFIG_HEADERS if it isn't already there. Are you working on the top level or at the Singular folder level? configure.in in Singular does call AC_CONFIG_HEADERS and puts definitions in mod2.h.\n\nNo, it doesn't use AC_CONFIG_HEADERS but AC_CONFIG_HEADER. That's why grep didn't find it.\n\nEven better: omalloc/configure.in uses it as well - hence, this should be the right place to put the missing symbol.",
    "created_at": "2012-11-26T10:49:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163892",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:76'>Comment 76:</a>
Replying to [@kiwifb](#comment%3A75):
> I wouldn't add AC_CONFIG_HEADERS if it isn't already there. Are you working on the top level or at the Singular folder level? configure.in in Singular does call AC_CONFIG_HEADERS and puts definitions in mod2.h.

No, it doesn't use AC_CONFIG_HEADERS but AC_CONFIG_HEADER. That's why grep didn't find it.

Even better: omalloc/configure.in uses it as well - hence, this should be the right place to put the missing symbol.



---

archive/issue_comments_163893.json:
```json
{
    "body": "<a id='comment:77'>Comment 77:</a>\nI am slightly shocked that omalloc/configure.in uses a hardcoded path to malloc.h:\n\n```\nAC_CHECK_HEADERS(unistd.h sys/mman.h fcntl.h /usr/include/malloc.h)\n```\n\nIsn't that bad?",
    "created_at": "2012-11-26T11:07:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163893",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:77'>Comment 77:</a>
I am slightly shocked that omalloc/configure.in uses a hardcoded path to malloc.h:

```
AC_CHECK_HEADERS(unistd.h sys/mman.h fcntl.h /usr/include/malloc.h)
```

Isn't that bad?



---

archive/issue_comments_163894.json:
```json
{
    "body": "<a id='comment:78'>Comment 78:</a>\nCcing Marting Albrecht, because he knows the Singular spkg.\n\nNext thing I wonder about: The spkg contains src/omalloc/configure, but on top it says that this is auto-generated. By consequence, when I tried to change src/omalloc/configure.in, my changes had no effect.\n\nSo, my first guess was that configure has to be removed - but that didn't work.\n\nMartin, do you think patching src/omalloc/configure directly is the right thing to do? Or what should I do in order to change the configuration in src/omalloc?",
    "created_at": "2012-11-26T11:53:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163894",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:78'>Comment 78:</a>
Ccing Marting Albrecht, because he knows the Singular spkg.

Next thing I wonder about: The spkg contains src/omalloc/configure, but on top it says that this is auto-generated. By consequence, when I tried to change src/omalloc/configure.in, my changes had no effect.

So, my first guess was that configure has to be removed - but that didn't work.

Martin, do you think patching src/omalloc/configure directly is the right thing to do? Or what should I do in order to change the configuration in src/omalloc?



---

archive/issue_comments_163895.json:
```json
{
    "body": "<a id='comment:79'>Comment 79:</a>\nSimon, `configure` is generated from `configure.in` using `autoconf`. However, Singular requires a special autoconf version (I think it is a particularly old one) which makes fixing things in its configure script tricky. I think this should go on [libsingular-devel]. Hans can help, I think.",
    "created_at": "2012-11-26T12:16:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163895",
    "user": "https://github.com/malb"
}
```

<a id='comment:79'>Comment 79:</a>
Simon, `configure` is generated from `configure.in` using `autoconf`. However, Singular requires a special autoconf version (I think it is a particularly old one) which makes fixing things in its configure script tricky. I think this should go on [libsingular-devel]. Hans can help, I think.



---

archive/issue_comments_163896.json:
```json
{
    "body": "<a id='comment:80'>Comment 80:</a>\nReplying to [@malb](#comment%3A79):\n> Simon, `configure` is generated from `configure.in` using `autoconf`. However, Singular requires a special autoconf version (I think it is a particularly old one) which makes fixing things in its configure script tricky. I think this should go on [libsingular-devel]. Hans can help, I think.\n\nI am not subscribed to libsingular-devel. Can you provide a link?\n\nFYI: \n\nI think this ticket has two purposes.\n\n1. Create a Singular spkg that builds both on linux and osx and replaces omalloc by malloc, so that it is easier to track down memory corruptions in Singular that became apparent by #715 and friends. It is just a tool to analyse things - in fact, it wouldn't even yield a working Singular executable.\n2. The study of memory corruptions should help to fix them - and the fixes should not only be upstream, but should be backported to a new patch level of our Singular 3-1-5 spkg.\n\nThe problem with src/omalloc/configure *only* concerns purpose 1. Hence, if directly editing src/omalloc/configure is dirty but works, then I wouldn't mind to do it, just so that it builds on osx.\n\nFortunately, the fixes in purpose 2. would probably not involve the configuration scripts.",
    "created_at": "2012-11-26T12:39:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163896",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:80'>Comment 80:</a>
Replying to [@malb](#comment%3A79):
> Simon, `configure` is generated from `configure.in` using `autoconf`. However, Singular requires a special autoconf version (I think it is a particularly old one) which makes fixing things in its configure script tricky. I think this should go on [libsingular-devel]. Hans can help, I think.

I am not subscribed to libsingular-devel. Can you provide a link?

FYI: 

I think this ticket has two purposes.

1. Create a Singular spkg that builds both on linux and osx and replaces omalloc by malloc, so that it is easier to track down memory corruptions in Singular that became apparent by #715 and friends. It is just a tool to analyse things - in fact, it wouldn't even yield a working Singular executable.
2. The study of memory corruptions should help to fix them - and the fixes should not only be upstream, but should be backported to a new patch level of our Singular 3-1-5 spkg.

The problem with src/omalloc/configure *only* concerns purpose 1. Hence, if directly editing src/omalloc/configure is dirty but works, then I wouldn't mind to do it, just so that it builds on osx.

Fortunately, the fixes in purpose 2. would probably not involve the configuration scripts.



---

archive/issue_comments_163897.json:
```json
{
    "body": "<a id='comment:81'>Comment 81:</a>\nSorry, when posting the previous comment, I forgot to delete two paragraphs before submitting...",
    "created_at": "2012-11-26T12:40:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163897",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:81'>Comment 81:</a>
Sorry, when posting the previous comment, I forgot to delete two paragraphs before submitting...



---

archive/issue_comments_163898.json:
```json
{
    "body": "<a id='comment:82'>Comment 82:</a>\nOn [libsingular-devel](https://groups.google.com/forum/#!topic/libsingular-devel/AZI-6eZAgus), Hans suggests to use xalloc, not malloc to detect memory-related problems.\n\nNils, do you know how to do those things?",
    "created_at": "2012-11-26T14:39:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163898",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:82'>Comment 82:</a>
On [libsingular-devel](https://groups.google.com/forum/#!topic/libsingular-devel/AZI-6eZAgus), Hans suggests to use xalloc, not malloc to detect memory-related problems.

Nils, do you know how to do those things?



---

archive/issue_comments_163899.json:
```json
{
    "body": "<a id='comment:83'>Comment 83:</a>\nReplying to [@simon-king-jena](#comment%3A82):\n> Nils, do you know how to do those things?\n\nNo, I don't, but it looks like you're learning how to on libsingular-devel already. The `xalloc` approach seems to be what I was contemplating before I read up on `malloc_size` and `malloc_usable_size`. It's interesting to see that the singular people thought it was easier to write a wrapper from scratch than to amend `omalloc`. I can sympathize with that, although it wasn't so bad in the end.\n\nIf xalloc does result in a usable executable, that would be great! I wonder what prevents us from getting that.\n\nIt may be that once you've built xalloc.so, you can just do `LD_PRELOAD=xalloc.so` to pre-empt the normal omalloc routines. That's how things like `ElectricFence` capture malloc action (provided omalloc doesn't get statically linked)",
    "created_at": "2012-11-26T20:48:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163899",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:83'>Comment 83:</a>
Replying to [@simon-king-jena](#comment%3A82):
> Nils, do you know how to do those things?

No, I don't, but it looks like you're learning how to on libsingular-devel already. The `xalloc` approach seems to be what I was contemplating before I read up on `malloc_size` and `malloc_usable_size`. It's interesting to see that the singular people thought it was easier to write a wrapper from scratch than to amend `omalloc`. I can sympathize with that, although it wasn't so bad in the end.

If xalloc does result in a usable executable, that would be great! I wonder what prevents us from getting that.

It may be that once you've built xalloc.so, you can just do `LD_PRELOAD=xalloc.so` to pre-empt the normal omalloc routines. That's how things like `ElectricFence` capture malloc action (provided omalloc doesn't get statically linked)



---

archive/issue_comments_163900.json:
```json
{
    "body": "<a id='comment:84'>Comment 84:</a>\nSorry, my knowledge of automake is too limited. So far, I did not succeed to create a package that replaces omalloc by xalloc.\n\nWhat I did (see also the thread in libsingular):\n\n* replace omalloc/ by the contents of xalloc/ in Singular Spielwiese\n* run `aclocal` in omalloc\n* run `autoconf` in omalloc\n* run `automake --install-missing` in omalloc\n* run `automake` again in omalloc\n* add the line `install-nolns: install` to the resulting `Makefile.in`\n* turn all this into a conditional patch, that is applied if `export SINGULAR_XALLOC=yes` was done.\n\nWhen I try to install the spkg, it fails with\n\n```\nmake install-nolns in omalloc\nmake[1]: Entering directory `/home/simon/SAGE/debug/sage-5.5.rc0/spkg/build/singular-3-1-5.p2/src/omalloc'\n/bin/sh ./libtool  --tag=CC   --mode=compile gcc -DPACKAGE_NAME=\\\"xalloc\\\" -DPACKAGE_TARNAME=\\\"xalloc\\\" -DPACKAGE_VERSION=\\\"3.1.2.sw\\\" -DPACKAGE_STRING=\\\"xalloc\\ 3.1.2.sw\\\" -DPACKAGE_BUGREPORT=\\\"\\\" -DPACKAGE_URL=\\\"\\\" -DPACKAGE=\\\"xalloc\\\" -DVERSION=\\\"3.1.2.sw\\\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\\\".libs/\\\" -I.  -I. -DHAVE_CONFIG_H -DNDEBUG -DOM_NDEBUG -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include  -O3  -O2 -g  -fPIC -MT libomalloc_la-dummy.lo -MD -MP -MF .deps/libomalloc_la-dummy.Tpo -c -o libomalloc_la-dummy.lo `test -f 'dummy.c' || echo './'`dummy.c\nmv -f .deps/libomalloc_la-dummy.Tpo .deps/libomalloc_la-dummy.Plo\nmv: Aufruf von stat f\u00fcr \u201e.deps/libomalloc_la-dummy.Tpo\u201c nicht m\u00f6glich: Datei oder Verzeichnis nicht gefunden\nmake[1]: *** [libomalloc_la-dummy.lo] Fehler 1\nmake[1]: Leaving directory `/home/simon/SAGE/debug/sage-5.5.rc0/spkg/build/singular-3-1-5.p2/src/omalloc'\nmake: *** [install-nolns] Fehler 1\nUnable to build and install Singular\nError building Singular (error in build_singular).\n```\nApparently the .deps directory was automatically created by the script `./depcomp`, that belongs to those installed by automake --install-missing. Its content after the installation failed:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ls spkg/build/singular-3-1-5.p2/src/omalloc/.deps/\nlibomalloc_g_la-dummy.Plo  libomalloc_la-dummy.Plo\n```\n\nAnd to be honest, I don't see the point of the `dummy.c` file in xalloc, which is:\n\n```\n#include \"omalloc.h\"\n\nint om_sing_opt_show_mem; /* dummy */\nstruct omInfo_s om_Info; /* dummy */\nstruct omOpts_s om_Opts; /* dummy */\n```",
    "created_at": "2012-11-27T13:12:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163900",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:84'>Comment 84:</a>
Sorry, my knowledge of automake is too limited. So far, I did not succeed to create a package that replaces omalloc by xalloc.

What I did (see also the thread in libsingular):

* replace omalloc/ by the contents of xalloc/ in Singular Spielwiese
* run `aclocal` in omalloc
* run `autoconf` in omalloc
* run `automake --install-missing` in omalloc
* run `automake` again in omalloc
* add the line `install-nolns: install` to the resulting `Makefile.in`
* turn all this into a conditional patch, that is applied if `export SINGULAR_XALLOC=yes` was done.

When I try to install the spkg, it fails with

```
make install-nolns in omalloc
make[1]: Entering directory `/home/simon/SAGE/debug/sage-5.5.rc0/spkg/build/singular-3-1-5.p2/src/omalloc'
/bin/sh ./libtool  --tag=CC   --mode=compile gcc -DPACKAGE_NAME=\"xalloc\" -DPACKAGE_TARNAME=\"xalloc\" -DPACKAGE_VERSION=\"3.1.2.sw\" -DPACKAGE_STRING=\"xalloc\ 3.1.2.sw\" -DPACKAGE_BUGREPORT=\"\" -DPACKAGE_URL=\"\" -DPACKAGE=\"xalloc\" -DVERSION=\"3.1.2.sw\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -I.  -I. -DHAVE_CONFIG_H -DNDEBUG -DOM_NDEBUG -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include -I/home/simon/SAGE/debug/sage-5.5.rc0/local/include  -O3  -O2 -g  -fPIC -MT libomalloc_la-dummy.lo -MD -MP -MF .deps/libomalloc_la-dummy.Tpo -c -o libomalloc_la-dummy.lo `test -f 'dummy.c' || echo './'`dummy.c
mv -f .deps/libomalloc_la-dummy.Tpo .deps/libomalloc_la-dummy.Plo
mv: Aufruf von stat für „.deps/libomalloc_la-dummy.Tpo“ nicht möglich: Datei oder Verzeichnis nicht gefunden
make[1]: *** [libomalloc_la-dummy.lo] Fehler 1
make[1]: Leaving directory `/home/simon/SAGE/debug/sage-5.5.rc0/spkg/build/singular-3-1-5.p2/src/omalloc'
make: *** [install-nolns] Fehler 1
Unable to build and install Singular
Error building Singular (error in build_singular).
```
Apparently the .deps directory was automatically created by the script `./depcomp`, that belongs to those installed by automake --install-missing. Its content after the installation failed:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ls spkg/build/singular-3-1-5.p2/src/omalloc/.deps/
libomalloc_g_la-dummy.Plo  libomalloc_la-dummy.Plo
```

And to be honest, I don't see the point of the `dummy.c` file in xalloc, which is:

```
#include "omalloc.h"

int om_sing_opt_show_mem; /* dummy */
struct omInfo_s om_Info; /* dummy */
struct omOpts_s om_Opts; /* dummy */
```



---

archive/issue_comments_163901.json:
```json
{
    "body": "<a id='comment:85'>Comment 85:</a>\nWith the help of the good people of [libsingular-devel](https://groups.google.com/forum/#!msg/libsingular-devel/AZI-6eZAgus/xx44G16DKRUJ), I managed to create a [new singular spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg).\n\nWhen you `export SINGULAR_XALLOC=yes` then the spkg creates a libsingular library and a Singular executable (yes, it starts and can compute things!!) with omalloc replaced by xalloc (a compatibility layer on top of malloc). Otherwise, the spkg just builds with omalloc.\n\nThe good news:\n\n1. Singular works.\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage -singular\n                     SINGULAR                                 /  Development\n A Computer Algebra System for Polynomial Computations       /   version 3-1-5\n                                                           0<\n by: W. Decker, G.-M. Greuel, G. Pfister, H. Schoenemann     \\   Jul 2012\nFB Mathematik der Universitaet, D-67653 Kaiserslautern        \\\n> ring r;\n> x;\nx\n> x*y+z;\nxy+z\n> quit;\nAuf Wiedersehen.\n```\n  There is no crash in the example above!\n2. Sage starts and quits just fine, even if libsingular is involved:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage \n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: P.<x,y> = QQ[]\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.05s, Wall time 0m9.80s).\n```\n3. We can reproduce the error from the ticket description:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage \n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x._mul_(y)\n*** glibc detected *** python: free(): invalid pointer: 0x0000000002cf4920 ***\n======= Backtrace: =========\n/lib64/libc.so.6(+0x766d6)[0x7f4331a486d6]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z14gnc_mm_Mult_nnPiS_P9sip_sring+0x301)[0x7f431764de91]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z20gnc_p_Mult_mm_CommonP8spolyrecS0_iP9sip_sring+0x21c)[0x7f431764ef5c]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/libs/singular/polynomial.so(+0x4c60)[0x7f4316a2cc60]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0x1d278)[0x7f4316e70278]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0xbb63)[0x7f4316e5eb63]\n...\n```\n4. Even better: We additionally get a crash when we do the example without `MALLOC_CHECK`, namely when quitting Sage:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage\n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x._mul_(y)\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.18s, Wall time 0m7.89s).\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7f657e22bc77]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7f657e22bca9]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sage_signal_handler+0x216)[0x7f657e22b886]\n/lib64/libpthread.so.0(+0xfd00)[0x7f6583601d00]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x129940)[0x7f6583938940]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyGC_Collect+0x24)[0x7f6583939694]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Finalize+0x116)[0x7f6583925316]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Exit+0x8)[0x7f6583924308]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x115434)[0x7f6583924434]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyErr_PrintEx+0x205)[0x7f65839246d5]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1fe)[0x7f6583924b4e]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Main+0xbd5)[0x7f6583938035]\n/lib64/libc.so.6(__libc_start_main+0xed)[0x7f6582c2523d]\npython[0x4006e1]\n\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n/home/simon/SAGE/debug/sage-5.5.rc0/spkg/bin/sage: Zeile 310: 25245 Speicherzugriffsfehler  sage-ipython \"$@\" -i\n```\n\n**__Conclusion__**\n\nI think this spkg is something we can work with to detect errors.",
    "created_at": "2012-11-29T13:27:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163901",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:85'>Comment 85:</a>
With the help of the good people of [libsingular-devel](https://groups.google.com/forum/#!msg/libsingular-devel/AZI-6eZAgus/xx44G16DKRUJ), I managed to create a [new singular spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg).

When you `export SINGULAR_XALLOC=yes` then the spkg creates a libsingular library and a Singular executable (yes, it starts and can compute things!!) with omalloc replaced by xalloc (a compatibility layer on top of malloc). Otherwise, the spkg just builds with omalloc.

The good news:

1. Singular works.

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage -singular
                     SINGULAR                                 /  Development
 A Computer Algebra System for Polynomial Computations       /   version 3-1-5
                                                           0<
 by: W. Decker, G.-M. Greuel, G. Pfister, H. Schoenemann     \   Jul 2012
FB Mathematik der Universitaet, D-67653 Kaiserslautern        \
> ring r;
> x;
x
> x*y+z;
xy+z
> quit;
Auf Wiedersehen.
```
  There is no crash in the example above!
2. Sage starts and quits just fine, even if libsingular is involved:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage 
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: P.<x,y> = QQ[]
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.05s, Wall time 0m9.80s).
```
3. We can reproduce the error from the ticket description:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage 
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x._mul_(y)
*** glibc detected *** python: free(): invalid pointer: 0x0000000002cf4920 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x766d6)[0x7f4331a486d6]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z14gnc_mm_Mult_nnPiS_P9sip_sring+0x301)[0x7f431764de91]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libsingular.so(_Z20gnc_p_Mult_mm_CommonP8spolyrecS0_iP9sip_sring+0x21c)[0x7f431764ef5c]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/libs/singular/polynomial.so(+0x4c60)[0x7f4316a2cc60]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0x1d278)[0x7f4316e70278]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/plural.so(+0xbb63)[0x7f4316e5eb63]
...
```
4. Even better: We additionally get a crash when we do the example without `MALLOC_CHECK`, namely when quitting Sage:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x._mul_(y)
x*y
sage: quit
Exiting Sage (CPU time 0m0.18s, Wall time 0m7.89s).
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7f657e22bc77]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7f657e22bca9]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sage_signal_handler+0x216)[0x7f657e22b886]
/lib64/libpthread.so.0(+0xfd00)[0x7f6583601d00]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x129940)[0x7f6583938940]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyGC_Collect+0x24)[0x7f6583939694]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Finalize+0x116)[0x7f6583925316]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Exit+0x8)[0x7f6583924308]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x115434)[0x7f6583924434]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyErr_PrintEx+0x205)[0x7f65839246d5]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1fe)[0x7f6583924b4e]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Main+0xbd5)[0x7f6583938035]
/lib64/libc.so.6(__libc_start_main+0xed)[0x7f6582c2523d]
python[0x4006e1]

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/home/simon/SAGE/debug/sage-5.5.rc0/spkg/bin/sage: Zeile 310: 25245 Speicherzugriffsfehler  sage-ipython "$@" -i
```

**__Conclusion__**

I think this spkg is something we can work with to detect errors.



---

archive/issue_comments_163902.json:
```json
{
    "body": "<a id='comment:86'>Comment 86:</a>\nPS:\n\n* I did not test whether this spkg builds on OSX.\n* The next step should be to include the bug fix from [attachment: singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz) and similar upstream fixes, and see whether the crash persists...",
    "created_at": "2012-11-29T13:31:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163902",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:86'>Comment 86:</a>
PS:

* I did not test whether this spkg builds on OSX.
* The next step should be to include the bug fix from [attachment: singular_15435.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_15435.patch.gz) and similar upstream fixes, and see whether the crash persists...



---

archive/issue_comments_163903.json:
```json
{
    "body": "<a id='comment:87'>Comment 87:</a>\nPPS: I am afraid the bug fixes and the xalloc patch do not commute. Hence, when including the fixes, I need to update the xalloc patch as well.",
    "created_at": "2012-11-29T13:37:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163903",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:87'>Comment 87:</a>
PPS: I am afraid the bug fixes and the xalloc patch do not commute. Hence, when including the fixes, I need to update the xalloc patch as well.



---

archive/issue_comments_163904.json:
```json
{
    "body": "<a id='comment:88'>Comment 88:</a>\nHooray, it does build on OSX (bsd.math)!!",
    "created_at": "2012-11-29T14:09:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163904",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:88'>Comment 88:</a>
Hooray, it does build on OSX (bsd.math)!!



---

archive/issue_comments_163905.json:
```json
{
    "body": "Attachment: **[singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)**\n\nBackporting a small part of Singular changeset baadc0f7",
    "created_at": "2012-11-29T21:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163905",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)**

Backporting a small part of Singular changeset baadc0f7



---

archive/issue_comments_163906.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,12 +1,15 @@\n-We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything. Example spkgs for that are\n+We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything.\n \n-[http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux)\n+For that purpose, one can use one of the following:\n \n-[http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX)\n+* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux). It replaces omalloc by the system malloc and tries to keep the changes small. It does build a libsingular library, but the Singular executable does not work.\n+* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX). Same as the previous item.\n+* [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).\n+  * It contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\n+  * It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. See the discussion on [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus)\n+  * It builds both a working libsingular library and a Singular executable.\n \n-**WARNING:** I don't think these packages produce a viable singular executable, so save your original one. The singular library seems to be fine, though. Only install these on a dedicated debugging install!\n-\n-Anyway, with this singular on linux:\n+With the [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:\n \n ```\n $ export MALLOC_CHECK_ 3\n@@ -43,4 +46,4 @@\n __pyx_skip_dispatch=<optimized out>)\n     at sage/rings/polynomial/plural.cpp:12060\n ```\n-running it in valgrind gets you complaints about the same locations. There's a slim chance this error is an artifact of the way libsingular-malloc is constructed, but I think that's unlikely. I think it's more likely this is a reliable way of detecting the same issues that are haunting us intermittently on various architectures.\n+running it in valgrind gets you complaints about the same locations. Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes.\n``````\n",
    "created_at": "2012-11-29T21:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163906",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,12 +1,15 @@
-We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything. Example spkgs for that are
+We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything.
 
-[http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux)
+For that purpose, one can use one of the following:
 
-[http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX)
+* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux). It replaces omalloc by the system malloc and tries to keep the changes small. It does build a libsingular library, but the Singular executable does not work.
+* [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX). Same as the previous item.
+* [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).
+  * It contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
+  * It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. See the discussion on [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus)
+  * It builds both a working libsingular library and a Singular executable.
 
-**WARNING:** I don't think these packages produce a viable singular executable, so save your original one. The singular library seems to be fine, though. Only install these on a dedicated debugging install!
-
-Anyway, with this singular on linux:
+With the [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:
 
 ```
 $ export MALLOC_CHECK_ 3
@@ -43,4 +46,4 @@
 __pyx_skip_dispatch=<optimized out>)
     at sage/rings/polynomial/plural.cpp:12060
 ```
-running it in valgrind gets you complaints about the same locations. There's a slim chance this error is an artifact of the way libsingular-malloc is constructed, but I think that's unlikely. I think it's more likely this is a reliable way of detecting the same issues that are haunting us intermittently on various architectures.
+running it in valgrind gets you complaints about the same locations. Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes.
``````




---

archive/issue_comments_163907.json:
```json
{
    "body": "Author: **Nils Bruin, Simon King**",
    "created_at": "2012-11-29T21:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163907",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Nils Bruin, Simon King**



---

archive/issue_comments_163908.json:
```json
{
    "body": "Changed upstream from **Reported upstream. Developers acknowledge bug.** to **Fixed upstream, in a later stable release.**",
    "created_at": "2012-11-29T21:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163908",
    "user": "https://github.com/simon-king-jena"
}
```

Changed upstream from **Reported upstream. Developers acknowledge bug.** to **Fixed upstream, in a later stable release.**



---

archive/issue_comments_163909.json:
```json
{
    "body": "<a id='comment:90'>Comment 90:</a>\nThe [new Singular spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) is intended to eventually become a new patch level of the standard Singular spkg.\n\nThe spkg is not ready for review yet (for example, SPKG.txt needs to be updated, and there are uncommited changes). But it contains two bug fixes from upstream, it builds on Linux and OSX, and one can *optionally* build libsingular and the Singular executable based on xalloc.\n\nThe disadvantage is that there are much more changes to the upstream sources compared with Nils' spkg. So, it could very well be that in the xalloc version one sees bugs that are actually artefacts of totally stripping down omalloc.\n\nHere  is what happens with the new spkg, build with `export SINGULAR_XALLOC=yes` on my `openSuse` laptop:\n\n**__Without MALLOC_CHECK__**\n\n* Sage can not quit after executing a very basic polynomial arithmetics:\n\n```\nsage: P.<x,y> = QQ[]\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.04s, Wall time 0m3.72s).\n```\n  The shell prompt does not return, ctrl-C has no effect - I have to pkill all Python processes! Note that `P.<x,y>=QQ[]` alone does *not* trigger the problem.\n* In the example from the ticket description, one does not get a crash when multiplying two elements of a g-algebra, but one gets a crash when quitting Sage afterwards:\n\n```\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.19s, Wall time 0m19.09s).\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7f951301ac77]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7f951301aca9]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sage_signal_handler+0x216)[0x7f951301a886]\n/lib64/libpthread.so.0(+0xfd00)[0x7f95183f0d00]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x129940)[0x7f9518727940]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyGC_Collect+0x24)[0x7f9518728694]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Finalize+0x116)[0x7f9518714316]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Exit+0x8)[0x7f9518713308]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x115434)[0x7f9518713434]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyErr_PrintEx+0x205)[0x7f95187136d5]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1fe)[0x7f9518713b4e]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Main+0xbd5)[0x7f9518727035]\n/lib64/libc.so.6(__libc_start_main+0xed)[0x7f9517a1423d]\npython[0x4006e1]\n\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n/home/simon/SAGE/debug/sage-5.5.rc0/spkg/bin/sage: Zeile 310:  5308 Speicherzugriffsfehler  sage-ipython \"$@\" -i\n```\n\n**__With `export MALLOC_CHECK=3`__**\n\n* Sage crashes when quitting after executing a very basic polynomial arithmetics:\n\n```\nsage: P.<x,y> = QQ[]\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.05s, Wall time 0m26.09s).\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7fcc69d1ac77]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7fcc69d1aca9]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sage_signal_handler+0x216)[0x7fcc69d1a886]\n/lib64/libpthread.so.0(+0xfd00)[0x7fcc6f339d00]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x1296d8)[0x7fcc6f6706d8]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x75bca)[0x7fcc6f5bcbca]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x129977)[0x7fcc6f670977]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyGC_Collect+0x24)[0x7fcc6f671694]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Finalize+0x116)[0x7fcc6f65d316]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Exit+0x8)[0x7fcc6f65c308]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x115434)[0x7fcc6f65c434]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyErr_PrintEx+0x205)[0x7fcc6f65c6d5]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1fe)[0x7fcc6f65cb4e]\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Main+0xbd5)[0x7fcc6f670035]\n/lib64/libc.so.6(__libc_start_main+0xed)[0x7fcc6e95d23d]\npython[0x4006e1]\n\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n/home/simon/SAGE/debug/sage-5.5.rc0/spkg/bin/sage: Zeile 310:  5393 Speicherzugriffsfehler  sage-ipython \"$@\" -i\n```\n* There is a memory corruption detected already when creating the g-algebra. The Sage or shell prompt does not appear, ctrl-C has no effect, I need to pkill python:\n\n```\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\n*** glibc detected *** python: malloc(): memory corruption: 0x0000000002c8db40 ***\n```\n\nTwo upstream bugs were fixed in the new spkg. Now the question is whether the findings above will point to further upstream bugs or are simply consequences of the rather brutal approach of replacing omalloc with xalloc.\n\nNils, can you analyse what is happening here? You are a lot better than I in using gdb and valgrind.",
    "created_at": "2012-11-29T22:06:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163909",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:90'>Comment 90:</a>
The [new Singular spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) is intended to eventually become a new patch level of the standard Singular spkg.

The spkg is not ready for review yet (for example, SPKG.txt needs to be updated, and there are uncommited changes). But it contains two bug fixes from upstream, it builds on Linux and OSX, and one can *optionally* build libsingular and the Singular executable based on xalloc.

The disadvantage is that there are much more changes to the upstream sources compared with Nils' spkg. So, it could very well be that in the xalloc version one sees bugs that are actually artefacts of totally stripping down omalloc.

Here  is what happens with the new spkg, build with `export SINGULAR_XALLOC=yes` on my `openSuse` laptop:

**__Without MALLOC_CHECK__**

* Sage can not quit after executing a very basic polynomial arithmetics:

```
sage: P.<x,y> = QQ[]
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.04s, Wall time 0m3.72s).
```
  The shell prompt does not return, ctrl-C has no effect - I have to pkill all Python processes! Note that `P.<x,y>=QQ[]` alone does *not* trigger the problem.
* In the example from the ticket description, one does not get a crash when multiplying two elements of a g-algebra, but one gets a crash when quitting Sage afterwards:

```
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.19s, Wall time 0m19.09s).
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7f951301ac77]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7f951301aca9]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sage_signal_handler+0x216)[0x7f951301a886]
/lib64/libpthread.so.0(+0xfd00)[0x7f95183f0d00]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x129940)[0x7f9518727940]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyGC_Collect+0x24)[0x7f9518728694]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Finalize+0x116)[0x7f9518714316]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Exit+0x8)[0x7f9518713308]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x115434)[0x7f9518713434]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyErr_PrintEx+0x205)[0x7f95187136d5]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1fe)[0x7f9518713b4e]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Main+0xbd5)[0x7f9518727035]
/lib64/libc.so.6(__libc_start_main+0xed)[0x7f9517a1423d]
python[0x4006e1]

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/home/simon/SAGE/debug/sage-5.5.rc0/spkg/bin/sage: Zeile 310:  5308 Speicherzugriffsfehler  sage-ipython "$@" -i
```

**__With `export MALLOC_CHECK=3`__**

* Sage crashes when quitting after executing a very basic polynomial arithmetics:

```
sage: P.<x,y> = QQ[]
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.05s, Wall time 0m26.09s).
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7fcc69d1ac77]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7fcc69d1aca9]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libcsage.so(sage_signal_handler+0x216)[0x7fcc69d1a886]
/lib64/libpthread.so.0(+0xfd00)[0x7fcc6f339d00]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x1296d8)[0x7fcc6f6706d8]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x75bca)[0x7fcc6f5bcbca]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x129977)[0x7fcc6f670977]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyGC_Collect+0x24)[0x7fcc6f671694]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Finalize+0x116)[0x7fcc6f65d316]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Exit+0x8)[0x7fcc6f65c308]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(+0x115434)[0x7fcc6f65c434]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyErr_PrintEx+0x205)[0x7fcc6f65c6d5]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1fe)[0x7fcc6f65cb4e]
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/libpython2.7.so.1.0(Py_Main+0xbd5)[0x7fcc6f670035]
/lib64/libc.so.6(__libc_start_main+0xed)[0x7fcc6e95d23d]
python[0x4006e1]

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/home/simon/SAGE/debug/sage-5.5.rc0/spkg/bin/sage: Zeile 310:  5393 Speicherzugriffsfehler  sage-ipython "$@" -i
```
* There is a memory corruption detected already when creating the g-algebra. The Sage or shell prompt does not appear, ctrl-C has no effect, I need to pkill python:

```
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
*** glibc detected *** python: malloc(): memory corruption: 0x0000000002c8db40 ***
```

Two upstream bugs were fixed in the new spkg. Now the question is whether the findings above will point to further upstream bugs or are simply consequences of the rather brutal approach of replacing omalloc with xalloc.

Nils, can you analyse what is happening here? You are a lot better than I in using gdb and valgrind.



---

archive/issue_comments_163910.json:
```json
{
    "body": "<a id='comment:91'>Comment 91:</a>\n> \n> ```\n> sage: P.<x,y> = QQ[]\n> sage: x*y\n> x*y\n> ```\n\nI put this in a file to run as a doctest using valgrind and gdb. The crash happens in python's gcmodule, so the memory corruption is severe.\n\n```\n==12827== Invalid write of size 8\n==12827==    at 0x26A58673: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (pp_Mult_mm__T.cc:48)\n==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)\n==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n...\n==12827==  Address 0x101597c0 is 0 bytes after a block of size 16 alloc'd\n==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)\n==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)\n==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)\n\n==12827== Invalid write of size 8\n==12827==    at 0x26A5867F: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (pp_Mult_mm__T.cc:49)\n==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)\n==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)\n...\n==12827==  Address 0x101597c8 is 8 bytes after a block of size 16 alloc'd\n==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)\n==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)\n==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)\n```\nSimilar message 16 bytes past and one invalid write `Address 0x101597d8 is not stack'd, malloc'd or (recently) free'd`\n\nAlso:\n\n```\n==12827== Invalid read of size 8\n==12827==    at 0x269A4A56: nlNormalize(snumber*&) (longrat.cc:1122)\n==12827==    by 0x269C7E50: p_Normalize(spolyrec*, sip_sring*) (polys.cc:647)\n==12827==    by 0x265BD052: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:31792)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)\n...\n==12827==  Address 0x101597c0 is 0 bytes after a block of size 16 alloc'd\n==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)\n==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)\n==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)\n\n==12827== Invalid read of size 8\n==12827==    at 0x269CBC3D: p_String0(spolyrec*, sip_sring*, sip_sring*) (polys0.cc:90)\n==12827==    by 0x27748087: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_str(spolyrec*, sip_sring*) (polynomial.cpp:4266)\n==12827==    by 0x2658F9B1: __pyx_pw_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_33_repr_(_object*, _object*) (multi_polynomial_libsingular.cpp:17242)\n==12827==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==12827==    by 0x10CD2408: __pyx_pw_4sage_9structure_11sage_object_10SageObject_5__repr__ (sage_object.c:1790)\n...\n==12827==  Address 0x101597d8 is not stack'd, malloc'd or (recently) free'd\n\n==12827== Invalid read of size 8\n==12827==    at 0x269CB926: writemon(spolyrec*, int, sip_sring*) (polys0.cc:25)\n==12827==    by 0x269CBC82: p_String0(spolyrec*, sip_sring*, sip_sring*) (polys0.cc:92)\n==12827==    by 0x27748087: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_str(spolyrec*, sip_sring*) (polynomial.cpp:4266)\n==12827==    by 0x2658F9B1: __pyx_pw_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_33_repr_(_object*, _object*) (multi_polynomial_libsingular.cpp:17242)\n...\n==12827==  Address 0x101597c0 is 0 bytes after a block of size 16 alloc'd\n==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)\n==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)\n==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)\n==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)\n```\netc. I tracked down the other bugs from similar information, so good luck! My guess is that this PolyBin is a little more required than assumed.\n\nThis is really just running the test and copy/paste from valgrind! It's much faster if you can do this yourself.\n}}}",
    "created_at": "2012-11-30T00:39:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163910",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:91'>Comment 91:</a>
> 
> ```
> sage: P.<x,y> = QQ[]
> sage: x*y
> x*y
> ```

I put this in a file to run as a doctest using valgrind and gdb. The crash happens in python's gcmodule, so the memory corruption is severe.

```
==12827== Invalid write of size 8
==12827==    at 0x26A58673: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (pp_Mult_mm__T.cc:48)
==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)
==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
...
==12827==  Address 0x101597c0 is 0 bytes after a block of size 16 alloc'd
==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)
==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)
==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)

==12827== Invalid write of size 8
==12827==    at 0x26A5867F: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (pp_Mult_mm__T.cc:49)
==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)
==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)
...
==12827==  Address 0x101597c8 is 8 bytes after a block of size 16 alloc'd
==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)
==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)
==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)
```
Similar message 16 bytes past and one invalid write `Address 0x101597d8 is not stack'd, malloc'd or (recently) free'd`

Also:

```
==12827== Invalid read of size 8
==12827==    at 0x269A4A56: nlNormalize(snumber*&) (longrat.cc:1122)
==12827==    by 0x269C7E50: p_Normalize(spolyrec*, sip_sring*) (polys.cc:647)
==12827==    by 0x265BD052: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:31792)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)
...
==12827==  Address 0x101597c0 is 0 bytes after a block of size 16 alloc'd
==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)
==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)
==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
==12827==    by 0x4C5435E: binary_op1 (abstract.c:945)

==12827== Invalid read of size 8
==12827==    at 0x269CBC3D: p_String0(spolyrec*, sip_sring*, sip_sring*) (polys0.cc:90)
==12827==    by 0x27748087: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_str(spolyrec*, sip_sring*) (polynomial.cpp:4266)
==12827==    by 0x2658F9B1: __pyx_pw_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_33_repr_(_object*, _object*) (multi_polynomial_libsingular.cpp:17242)
==12827==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==12827==    by 0x10CD2408: __pyx_pw_4sage_9structure_11sage_object_10SageObject_5__repr__ (sage_object.c:1790)
...
==12827==  Address 0x101597d8 is not stack'd, malloc'd or (recently) free'd

==12827== Invalid read of size 8
==12827==    at 0x269CB926: writemon(spolyrec*, int, sip_sring*) (polys0.cc:25)
==12827==    by 0x269CBC82: p_String0(spolyrec*, sip_sring*, sip_sring*) (polys0.cc:92)
==12827==    by 0x27748087: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_str(spolyrec*, sip_sring*) (polynomial.cpp:4266)
==12827==    by 0x2658F9B1: __pyx_pw_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_33_repr_(_object*, _object*) (multi_polynomial_libsingular.cpp:17242)
...
==12827==  Address 0x101597c0 is 0 bytes after a block of size 16 alloc'd
==12827==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==12827==    by 0x26A5865E: pp_Mult_mm__FieldQ_LengthThree_OrdGeneral (omalloc.h:85)
==12827==    by 0x27748935: __pyx_f_4sage_4libs_8singular_10polynomial_singular_polynomial_mul(spolyrec**, spolyrec*, spolyrec*, sip_sring*) (pInline2.h:673)
==12827==    by 0x265BCE3F: __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__mul_(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, __pyx_obj_4sage_9structure_7element_RingElement*, int) (multi_polynomial_libsingular.cpp:16475)
==12827==    by 0x154E9EA8: __pyx_pw_4sage_9structure_7element_11RingElement_11__mul__ (element.c:14091)
```
etc. I tracked down the other bugs from similar information, so good luck! My guess is that this PolyBin is a little more required than assumed.

This is really just running the test and copy/paste from valgrind! It's much faster if you can do this yourself.
}}}



---

archive/issue_comments_163911.json:
```json
{
    "body": "<a id='comment:92'>Comment 92:</a>\nIndeed, `kernel/pp_Mult_mm__T.cc:32`:\n\n```\n  omBin bin = ri->PolyBin;\n  DECLARE_LENGTH(const unsigned long length = ri->ExpL_Size);\n  const unsigned long* m_e = m->exp;\n  pAssume(!n_IsZero(ln,ri));\n  pAssume1(p_GetComp(m, ri) == 0 || p_MaxComp(p, ri) == 0);\n  number tmp;\n\n  do\n  {\n    tmp = n_Mult(ln, pGetCoeff(p), ri);\n#ifdef HAVE_ZERODIVISORS\n    if (! n_IsZero(tmp, ri))\n    {\n#endif\n      p_AllocBin( pNext(q), bin, ri);\n      q = pNext(q);\n      pSetCoeff0(q, tmp);\n```\nI haven't looked into what happens here exactly, but `r->PolyBin` does get passed around. It might not be deref problem, though, but:\n`omalloc/omalloc.h:142` (xalloc really)\n\n```\n#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(sizeof(B))\n#define omTypeAlloc(T,P,S)       P=(T)omAlloc(S)\n#define omTypeAlloc0Bin(T,P,B)   P=(T)omAlloc0(B)\n```\nlooks suspicious to me. The two allocbin routines look incompatible to me. I think they are supposed to have the same interface type.",
    "created_at": "2012-11-30T01:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163911",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:92'>Comment 92:</a>
Indeed, `kernel/pp_Mult_mm__T.cc:32`:

```
  omBin bin = ri->PolyBin;
  DECLARE_LENGTH(const unsigned long length = ri->ExpL_Size);
  const unsigned long* m_e = m->exp;
  pAssume(!n_IsZero(ln,ri));
  pAssume1(p_GetComp(m, ri) == 0 || p_MaxComp(p, ri) == 0);
  number tmp;

  do
  {
    tmp = n_Mult(ln, pGetCoeff(p), ri);
#ifdef HAVE_ZERODIVISORS
    if (! n_IsZero(tmp, ri))
    {
#endif
      p_AllocBin( pNext(q), bin, ri);
      q = pNext(q);
      pSetCoeff0(q, tmp);
```
I haven't looked into what happens here exactly, but `r->PolyBin` does get passed around. It might not be deref problem, though, but:
`omalloc/omalloc.h:142` (xalloc really)

```
#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(sizeof(B))
#define omTypeAlloc(T,P,S)       P=(T)omAlloc(S)
#define omTypeAlloc0Bin(T,P,B)   P=(T)omAlloc0(B)
```
looks suspicious to me. The two allocbin routines look incompatible to me. I think they are supposed to have the same interface type.



---

archive/issue_comments_163912.json:
```json
{
    "body": "<a id='comment:93'>Comment 93:</a>\nReplying to [@nbruin](#comment%3A92):\n> I haven't looked into what happens here exactly, but `r->PolyBin` does get passed around. It might not be deref problem, though, but:\n> `omalloc/omalloc.h:142` (xalloc really)\n> \n> ```\n> #define omTypeAllocBin(T,P,B)    P=(T)omAlloc(sizeof(B))\n> #define omTypeAlloc(T,P,S)       P=(T)omAlloc(S)\n> #define omTypeAlloc0Bin(T,P,B)   P=(T)omAlloc0(B)\n> ```\n> looks suspicious to me. The two allocbin routines look incompatible to me. I think they are supposed to have the same interface type.\n\nCould very well be. The \"sizeof(...)\" was my addition - without it, the compiler would complain, and indeed looking into the code it seems that a size was expected. Perhaps I should add the \"sizeof\" to the other two macros as well, even though the compiler did not complain about them.\n\nOr, yet another possibility: If I am not mistaken, the bins don't really matter when omalloc is ripped out. Hence, one could perhaps simply do *nothing* instead?\n\nAlternatively, one could think of defining `typedef size_t* omBin;` rather than the current `typedef size_t omBin`, so that at least we have a pointer which we can allocate memory for.",
    "created_at": "2012-11-30T06:34:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163912",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:93'>Comment 93:</a>
Replying to [@nbruin](#comment%3A92):
> I haven't looked into what happens here exactly, but `r->PolyBin` does get passed around. It might not be deref problem, though, but:
> `omalloc/omalloc.h:142` (xalloc really)
> 
> ```
> #define omTypeAllocBin(T,P,B)    P=(T)omAlloc(sizeof(B))
> #define omTypeAlloc(T,P,S)       P=(T)omAlloc(S)
> #define omTypeAlloc0Bin(T,P,B)   P=(T)omAlloc0(B)
> ```
> looks suspicious to me. The two allocbin routines look incompatible to me. I think they are supposed to have the same interface type.

Could very well be. The "sizeof(...)" was my addition - without it, the compiler would complain, and indeed looking into the code it seems that a size was expected. Perhaps I should add the "sizeof" to the other two macros as well, even though the compiler did not complain about them.

Or, yet another possibility: If I am not mistaken, the bins don't really matter when omalloc is ripped out. Hence, one could perhaps simply do *nothing* instead?

Alternatively, one could think of defining `typedef size_t* omBin;` rather than the current `typedef size_t omBin`, so that at least we have a pointer which we can allocate memory for.



---

archive/issue_comments_163913.json:
```json
{
    "body": "<a id='comment:94'>Comment 94:</a>\nWell, `pNext(q)` (soon to be `q`) gets allocated via:\n\n```\n#define p_AllocBin(p, bin, r)   omTypeAllocBin(poly, p, bin)\n```\nIf I'm not mistaken, a `poly` is a pointer to what is ultimately\n\n```\nstruct  spolyrec\n{\n  poly      next;           // next needs to be the first field\n  number    coef;           // and coef the second --- do not change this !!!\n  unsigned long exp[VARS];  // make sure that exp is aligned\n};\n```\nso whatever you allocate, it had better have enough room for that.\n\nAs far as I understand, a \"bin\" is a (collection of) page(s) that gets used for allocation of same-sized memory blocks. So I'd expect an alloc that uses a bin reference to get the size to alocate from the bin rather than as a parameter. Here, things get allocated from the \"poly\" bin. So perhaps you don't need bins per se, but I think you do need to keep enough of the bin to know what size memory blocks are associated with it. The above code doesn't seem to do that (none of it).\n\nI would think `(T)omAlloc(sizeof(*T))` or something like that would be closer to what's required. \nAt least (assuming T is a pointer type) it would allocate a block that's big enough to let a T type point to. But I may well be misreading the code.",
    "created_at": "2012-11-30T07:18:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163913",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:94'>Comment 94:</a>
Well, `pNext(q)` (soon to be `q`) gets allocated via:

```
#define p_AllocBin(p, bin, r)   omTypeAllocBin(poly, p, bin)
```
If I'm not mistaken, a `poly` is a pointer to what is ultimately

```
struct  spolyrec
{
  poly      next;           // next needs to be the first field
  number    coef;           // and coef the second --- do not change this !!!
  unsigned long exp[VARS];  // make sure that exp is aligned
};
```
so whatever you allocate, it had better have enough room for that.

As far as I understand, a "bin" is a (collection of) page(s) that gets used for allocation of same-sized memory blocks. So I'd expect an alloc that uses a bin reference to get the size to alocate from the bin rather than as a parameter. Here, things get allocated from the "poly" bin. So perhaps you don't need bins per se, but I think you do need to keep enough of the bin to know what size memory blocks are associated with it. The above code doesn't seem to do that (none of it).

I would think `(T)omAlloc(sizeof(*T))` or something like that would be closer to what's required. 
At least (assuming T is a pointer type) it would allocate a block that's big enough to let a T type point to. But I may well be misreading the code.



---

archive/issue_comments_163914.json:
```json
{
    "body": "<a id='comment:95'>Comment 95:</a>\nOK, my C skills are insufficient for this:\n\n```\n#include<stdio.h>\n\ntypedef struct{\n  int a; int b; int c; int d; int e;\n} composite;\n\ntypedef composite *pointer;\n\nvoid main() {\n  pointer v;\n  printf(\"sizeof(composite)=%d\\n\",sizeof(composite));\n  printf(\"sizeof(t)=%d\\n\",sizeof(t));\n  printf(\"sizeof(*v)=%d\\n\",sizeof(*v));\n};\n```\nproduces the desired output:\n\n```\nsizeof(composite)=20\nsizeof(pointer)=8\nsizeof(*v)=20\n```\nSo if I have my hands on an instance of a \"pointer\" variable, I can get the size of the structure pointed to by dereferencing. However, if I want to get this straight from the pointer type there doesn't seem to be a syntax for it. `sizeof(*pointer)` gives an error ... How do you get that information?\n\n**SOLVED:**\n\n```\n  printf(\"sizeof(*(pointer)NULL)=%d\\n\",sizeof(*(pointer)NULL));\n```",
    "created_at": "2012-11-30T07:53:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163914",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:95'>Comment 95:</a>
OK, my C skills are insufficient for this:

```
#include<stdio.h>

typedef struct{
  int a; int b; int c; int d; int e;
} composite;

typedef composite *pointer;

void main() {
  pointer v;
  printf("sizeof(composite)=%d\n",sizeof(composite));
  printf("sizeof(t)=%d\n",sizeof(t));
  printf("sizeof(*v)=%d\n",sizeof(*v));
};
```
produces the desired output:

```
sizeof(composite)=20
sizeof(pointer)=8
sizeof(*v)=20
```
So if I have my hands on an instance of a "pointer" variable, I can get the size of the structure pointed to by dereferencing. However, if I want to get this straight from the pointer type there doesn't seem to be a syntax for it. `sizeof(*pointer)` gives an error ... How do you get that information?

**SOLVED:**

```
  printf("sizeof(*(pointer)NULL)=%d\n",sizeof(*(pointer)NULL));
```



---

archive/issue_comments_163915.json:
```json
{
    "body": "<a id='comment:96'>Comment 96:</a>\nOK, this trick doesn't work. There are calls of the form\n\n```\nomTypeAllocBin(void*, addr, InternalInteger_bin);\n```\nwhich prevent \nand there are calls to `omAllocBin` anyway that only have the bin, not a type hint for how much memory should be allocated. So removing bins completely will simply not work: you need them at least as a storage container for block lengths associated to them.\n\nShort: The `AllocBin` routines seem to allocate *from* a bin, not the bin itself. I think you can take this back to libsingular-devel. Hannes claims that xalloc is a sufficient omalloc replacement, so he probably has a solution to this (which I bet is resurrecting omBin_s and supporting rudimentary initialization of it. We only need the sizeW field on these things)\n\nIn fact, from the line\n\n```\nomBin slists_bin = omGetSpecBin(sizeof(slists));\n```\nI bet that you can declare\n\n```\ntypedef struct omBin_s {\n  size_t sizeW;\n  size_t sizeB;\n} omBin_t;\ntypedef omBin_t* omBin;\n\nstatic inline omBin omGetSpecBin(size_t S)\n{   omBin bin = (omBin)malloc(sizeof(omBin_t));\n    bin->sizeB = S;\n    bin->sizeW = S/sizeof(long);\n    return bin;\n}\n\nstatic inline void omUnGetSpecBin(omBin bin)\n{\n    free(bin);\n}\n\n#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B->sizeB)\n```\netc.",
    "created_at": "2012-11-30T08:37:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163915",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:96'>Comment 96:</a>
OK, this trick doesn't work. There are calls of the form

```
omTypeAllocBin(void*, addr, InternalInteger_bin);
```
which prevent 
and there are calls to `omAllocBin` anyway that only have the bin, not a type hint for how much memory should be allocated. So removing bins completely will simply not work: you need them at least as a storage container for block lengths associated to them.

Short: The `AllocBin` routines seem to allocate *from* a bin, not the bin itself. I think you can take this back to libsingular-devel. Hannes claims that xalloc is a sufficient omalloc replacement, so he probably has a solution to this (which I bet is resurrecting omBin_s and supporting rudimentary initialization of it. We only need the sizeW field on these things)

In fact, from the line

```
omBin slists_bin = omGetSpecBin(sizeof(slists));
```
I bet that you can declare

```
typedef struct omBin_s {
  size_t sizeW;
  size_t sizeB;
} omBin_t;
typedef omBin_t* omBin;

static inline omBin omGetSpecBin(size_t S)
{   omBin bin = (omBin)malloc(sizeof(omBin_t));
    bin->sizeB = S;
    bin->sizeW = S/sizeof(long);
    return bin;
}

static inline void omUnGetSpecBin(omBin bin)
{
    free(bin);
}

#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B->sizeB)
```
etc.



---

archive/issue_comments_163916.json:
```json
{
    "body": "<a id='comment:97'>Comment 97:</a>\nNO!! It's much easier. Hannes is right: just store bin->sizeB directly in the bin. Then\n\n```\n#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B)\n```\nis the correct description, since the bin now simply IS the size_t.",
    "created_at": "2012-11-30T08:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163916",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:97'>Comment 97:</a>
NO!! It's much easier. Hannes is right: just store bin->sizeB directly in the bin. Then

```
#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B)
```
is the correct description, since the bin now simply IS the size_t.



---

archive/issue_comments_163917.json:
```json
{
    "body": "<a id='comment:98'>Comment 98:</a>\nReplying to [@nbruin](#comment%3A97):\n> NO!! It's much easier. Hannes is right: just store bin->sizeB directly in the bin. Then\n> \n> ```\n> #define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B)\n> ```\n> is the correct description, since the bin now simply IS the size_t.\n\nSorry, I don't get that.\n\n```\ntypedef size_t  omBin;\n\nstatic inline omBin omGetSpecBin(size_t S)\n{   return (omBin)sizeof(omBin_t);\n}\n```\nor what?\n\nAnd remove `omUnGetSpecBin`? \n\nAnd then\n\n```\n#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B)\n```\n?",
    "created_at": "2012-11-30T10:09:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163917",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:98'>Comment 98:</a>
Replying to [@nbruin](#comment%3A97):
> NO!! It's much easier. Hannes is right: just store bin->sizeB directly in the bin. Then
> 
> ```
> #define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B)
> ```
> is the correct description, since the bin now simply IS the size_t.

Sorry, I don't get that.

```
typedef size_t  omBin;

static inline omBin omGetSpecBin(size_t S)
{   return (omBin)sizeof(omBin_t);
}
```
or what?

And remove `omUnGetSpecBin`? 

And then

```
#define omTypeAllocBin(T,P,B)    P=(T)omAlloc(B)
```
?



---

archive/issue_comments_163918.json:
```json
{
    "body": "<a id='comment:99'>Comment 99:</a>\nPS: Could you please have a look at the file `omalloc/Makefile` that my patch creates? It contains\n\n```\ninstall-nolns: install\ninstall-libsingular: install\n```\nBoth targets `install-nolns` and `install-libsingular` are requested. Does that mean that the compilation is done twice? If this is so, how can I prevent it?",
    "created_at": "2012-11-30T10:31:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163918",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:99'>Comment 99:</a>
PS: Could you please have a look at the file `omalloc/Makefile` that my patch creates? It contains

```
install-nolns: install
install-libsingular: install
```
Both targets `install-nolns` and `install-libsingular` are requested. Does that mean that the compilation is done twice? If this is so, how can I prevent it?



---

archive/issue_comments_163919.json:
```json
{
    "body": "<a id='comment:0'>Comment 0:</a>\nNo. It doesn't work in the way I just tried. Now Sage won't even start.",
    "created_at": "2012-11-30T10:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163919",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'>Comment 0:</a>
No. It doesn't work in the way I just tried. Now Sage won't even start.



---

archive/issue_comments_163920.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nI have updated the [new spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) and posted a new version of [attachment: singular_xalloc.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_xalloc.patch.gz).\n\nNow it seems to work!\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage \n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.48s, Wall time 0m10.86s).\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage \n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: P.<x,y> = QQ[]\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.04s, Wall time 0m6.09s).\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage \n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m0.17s, Wall time 0m8.22s).\n```\n\nMy suggestion: Using the doc tests (run with `MALLOC_CHECK_=3`), we try to detect further crashes. This may result in further up- or downstream fixes. Eventually, the new spkg shall become standard, with all the fixes backported, and with optional xalloc support.",
    "created_at": "2012-11-30T12:00:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163920",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'>Comment 1:</a>
I have updated the [new spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) and posted a new version of [attachment: singular_xalloc.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_xalloc.patch.gz).

Now it seems to work!

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage 
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.48s, Wall time 0m10.86s).
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> export MALLOC_CHECK_=3
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage 
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: P.<x,y> = QQ[]
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.04s, Wall time 0m6.09s).
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> ./sage 
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m0.17s, Wall time 0m8.22s).
```

My suggestion: Using the doc tests (run with `MALLOC_CHECK_=3`), we try to detect further crashes. This may result in further up- or downstream fixes. Eventually, the new spkg shall become standard, with all the fixes backported, and with optional xalloc support.



---

archive/issue_comments_163921.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI am now running `make test` with `MALLOC_CHECK_=3` and it seems to work quit well!\n\nHowever, it seems that the spkg should also install `omalloc/mylimits.h`: It turns out that `./sage -br` only works since there is `mylimits.h` around from building the original singular spkg.",
    "created_at": "2012-11-30T13:36:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163921",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'>Comment 2:</a>
I am now running `make test` with `MALLOC_CHECK_=3` and it seems to work quit well!

However, it seems that the spkg should also install `omalloc/mylimits.h`: It turns out that `./sage -br` only works since there is `mylimits.h` around from building the original singular spkg.



---

archive/issue_comments_163922.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nPS: Normally, mylimits.h just includes \"limits.h\" - but in IRIX-6 machines that wouldn't work, and so on these machines the header omlimits.h generated by the configure script would be included.\n\nHence, I will soon create a new spkg that installs mylimits.h including limits.h - but the xalloc-version of the spkg will not work on IRIX-6 machines.",
    "created_at": "2012-11-30T13:45:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163922",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'>Comment 3:</a>
PS: Normally, mylimits.h just includes "limits.h" - but in IRIX-6 machines that wouldn't work, and so on these machines the header omlimits.h generated by the configure script would be included.

Hence, I will soon create a new spkg that installs mylimits.h including limits.h - but the xalloc-version of the spkg will not work on IRIX-6 machines.



---

archive/issue_comments_163923.json:
```json
{
    "body": "Build Singular and libsingular with omalloc replaced by xalloc",
    "created_at": "2012-11-30T14:25:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163923",
    "user": "https://github.com/simon-king-jena"
}
```

Build Singular and libsingular with omalloc replaced by xalloc



---

archive/issue_comments_163924.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nAttachment: **[singular_xalloc.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_xalloc.patch.gz)**\n\nPPS: The spkg installing mylimits.h is already posted.",
    "created_at": "2012-11-30T14:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163924",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'>Comment 4:</a>
Attachment: **[singular_xalloc.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_xalloc.patch.gz)**

PPS: The spkg installing mylimits.h is already posted.



---

archive/issue_comments_163925.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\n`make test` reports\n\n```\n        sage -t  -force_lib \"devel/sage/sage/graphs/graph_generators.py\" # Killed/crashed\n        sage -t  -force_lib \"devel/sage/sage/misc/sageinspect.py\"\nTotal time for all tests: 6884.7 seconds\nmake: *** [test] Fehler 132\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> echo $SINGULAR_XALLOC\nyes\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> echo $MALLOC_CHECK_\n3\n```\n\nTo be on the safe side, can you verify that I did not misspell the environment variable? I.e., is there a trailing underscore?\n\nNote that the error in sageinspect is due to the fact that I also had #11768 applied, which needs work. I don't know if the crash in graph_generators is related.\n\nIs that good or bad?\n\n* It is good, since the xalloc version of Singular works very well, and the crashes we discussed here have apparently been fixed upstream (and the fixes backported). Hence, I am now going to finalise the spkg for review.\n* It is bad, since I think we had hoped that we see easy-to-analyse crashes in garbage collection - after all, I am using sage-5.5.rc0, which has some of the weak reference patches applied. But if there is no crash, there is nothing to analyse.\n\nHowever, if I recall correctly, the crashes did only occur when also considering #12215, not only #715 and #11521.",
    "created_at": "2012-11-30T14:35:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163925",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'>Comment 5:</a>
`make test` reports

```
        sage -t  -force_lib "devel/sage/sage/graphs/graph_generators.py" # Killed/crashed
        sage -t  -force_lib "devel/sage/sage/misc/sageinspect.py"
Total time for all tests: 6884.7 seconds
make: *** [test] Fehler 132
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> echo $SINGULAR_XALLOC
yes
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0> echo $MALLOC_CHECK_
3
```

To be on the safe side, can you verify that I did not misspell the environment variable? I.e., is there a trailing underscore?

Note that the error in sageinspect is due to the fact that I also had #11768 applied, which needs work. I don't know if the crash in graph_generators is related.

Is that good or bad?

* It is good, since the xalloc version of Singular works very well, and the crashes we discussed here have apparently been fixed upstream (and the fixes backported). Hence, I am now going to finalise the spkg for review.
* It is bad, since I think we had hoped that we see easy-to-analyse crashes in garbage collection - after all, I am using sage-5.5.rc0, which has some of the weak reference patches applied. But if there is no crash, there is nothing to analyse.

However, if I recall correctly, the crashes did only occur when also considering #12215, not only #715 and #11521.



---

archive/issue_comments_163926.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nPS: The graph_generators test pass fine if `MALLOC_CHECK_` is not defined. Hence, we see a new bug here. I'll report on sage-devel.",
    "created_at": "2012-11-30T15:43:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163926",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'>Comment 6:</a>
PS: The graph_generators test pass fine if `MALLOC_CHECK_` is not defined. Hence, we see a new bug here. I'll report on sage-devel.



---

archive/issue_comments_163927.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nPPS: The graph_generators test also crashes with the default omalloc Singular. Hence, it definitely is unrelated.",
    "created_at": "2012-11-30T15:46:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163927",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'>Comment 7:</a>
PPS: The graph_generators test also crashes with the default omalloc Singular. Hence, it definitely is unrelated.



---

archive/issue_comments_163928.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nPPPS:\n\n```\nAll tests passed!\nTotal time for all tests: 6376.5 seconds\nbash-3.2$ echo $MALLOC_CHECK_\n3\n```\nwith the xalloc singular on bsd.math!!",
    "created_at": "2012-11-30T17:15:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163928",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'>Comment 8:</a>
PPPS:

```
All tests passed!
Total time for all tests: 6376.5 seconds
bash-3.2$ echo $MALLOC_CHECK_
3
```
with the xalloc singular on bsd.math!!



---

archive/issue_comments_163929.json:
```json
{
    "body": "<a id='comment:109'>Comment 109:</a>\nReplying to [@simon-king-jena](#comment%3A108):\n> PPPS:\n> \n> ```\n> All tests passed!\n> Total time for all tests: 6376.5 seconds\n> bash-3.2$ echo $MALLOC_CHECK_\n> 3\n> ```\n> with the xalloc singular on bsd.math!!\n\nThat variable doesn't do anything on OSX, so congratulations that xalloc works on OSX, but you haven't done stringent memory checking yet. Try\n\n```\nexport DYLD_INSERT_LIBRARIES=/usr/lib/libgmalloc.dylib\n```\ninstead. see `man libgmalloc` for various options to select what should be guarded.\n(warning: It will run MUCH slower and take MUCH more memory. It seems gmalloc is about as strict as `ElectricFence` which is also incredibly slow. Valgrind is speedy by comparison)",
    "created_at": "2012-11-30T17:36:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163929",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:109'>Comment 109:</a>
Replying to [@simon-king-jena](#comment%3A108):
> PPPS:
> 
> ```
> All tests passed!
> Total time for all tests: 6376.5 seconds
> bash-3.2$ echo $MALLOC_CHECK_
> 3
> ```
> with the xalloc singular on bsd.math!!

That variable doesn't do anything on OSX, so congratulations that xalloc works on OSX, but you haven't done stringent memory checking yet. Try

```
export DYLD_INSERT_LIBRARIES=/usr/lib/libgmalloc.dylib
```
instead. see `man libgmalloc` for various options to select what should be guarded.
(warning: It will run MUCH slower and take MUCH more memory. It seems gmalloc is about as strict as `ElectricFence` which is also incredibly slow. Valgrind is speedy by comparison)



---

archive/issue_comments_163930.json:
```json
{
    "body": "<a id='comment:110'>Comment 110:</a>\nReplying to [@nbruin](#comment%3A109):\n> That variable doesn't do anything on OSX, so congratulations that xalloc works on OSX, but you haven't done stringent memory checking yet. Try\n> \n> ```\n> export DYLD_INSERT_LIBRARIES=/usr/lib/libgmalloc.dylib\n> ```\n> instead. see `man libgmalloc` for various options to select what should be guarded.\n> (warning: It will run MUCH slower and take MUCH more memory. It seems gmalloc is about as strict as `ElectricFence` which is also incredibly slow. Valgrind is speedy by comparison)\n\nThank you!\n\nFirst result:\n\n```\n----------------------------------------------------------------------\n| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nGuardMalloc: Allocations will be placed on 16 byte boundaries.\nGuardMalloc:  - Some buffer overruns may not be noticed.\nGuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.\nGuardMalloc: GuardMalloc version 23\nGuardMalloc: Allocations will be placed on 16 byte boundaries.\nGuardMalloc:  - Some buffer overruns may not be noticed.\nGuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.\nGuardMalloc: GuardMalloc version 23\nGuardMalloc: Allocations will be placed on 16 byte boundaries.\nGuardMalloc:  - Some buffer overruns may not be noticed.\nGuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.\nGuardMalloc: GuardMalloc version 23\nGuardMalloc: Allocations will be placed on 16 byte boundaries.\nGuardMalloc:  - Some buffer overruns may not be noticed.\nGuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.\nGuardMalloc: GuardMalloc version 23\nsage: A.<x,y> = FreeAlgebra(QQ, 2)\nsage: P.<x,y> = A.g_algebra({y*x:-x*y})\nsage: x*y\nx*y\nsage: quit\nExiting Sage (CPU time 0m24.65s, Wall time 1m15.86s).\n```\n\nSo, the bug really is fixed, on OSX as well.\n\nSecond result: Yes, it is *incredibly* slow!\n\nNevertheless, I just started `sage -testall` under gmalloc on bsd.math. Let's see whether it will finish this year...",
    "created_at": "2012-11-30T18:48:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163930",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:110'>Comment 110:</a>
Replying to [@nbruin](#comment%3A109):
> That variable doesn't do anything on OSX, so congratulations that xalloc works on OSX, but you haven't done stringent memory checking yet. Try
> 
> ```
> export DYLD_INSERT_LIBRARIES=/usr/lib/libgmalloc.dylib
> ```
> instead. see `man libgmalloc` for various options to select what should be guarded.
> (warning: It will run MUCH slower and take MUCH more memory. It seems gmalloc is about as strict as `ElectricFence` which is also incredibly slow. Valgrind is speedy by comparison)

Thank you!

First result:

```
----------------------------------------------------------------------
| Sage Version 5.5.rc0, Release Date: 2012-11-17                     |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
GuardMalloc: Allocations will be placed on 16 byte boundaries.
GuardMalloc:  - Some buffer overruns may not be noticed.
GuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.
GuardMalloc: GuardMalloc version 23
GuardMalloc: Allocations will be placed on 16 byte boundaries.
GuardMalloc:  - Some buffer overruns may not be noticed.
GuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.
GuardMalloc: GuardMalloc version 23
GuardMalloc: Allocations will be placed on 16 byte boundaries.
GuardMalloc:  - Some buffer overruns may not be noticed.
GuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.
GuardMalloc: GuardMalloc version 23
GuardMalloc: Allocations will be placed on 16 byte boundaries.
GuardMalloc:  - Some buffer overruns may not be noticed.
GuardMalloc:  - Applications using vector instructions (e.g., SSE or Altivec) should work.
GuardMalloc: GuardMalloc version 23
sage: A.<x,y> = FreeAlgebra(QQ, 2)
sage: P.<x,y> = A.g_algebra({y*x:-x*y})
sage: x*y
x*y
sage: quit
Exiting Sage (CPU time 0m24.65s, Wall time 1m15.86s).
```

So, the bug really is fixed, on OSX as well.

Second result: Yes, it is *incredibly* slow!

Nevertheless, I just started `sage -testall` under gmalloc on bsd.math. Let's see whether it will finish this year...



---

archive/issue_comments_163931.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nHow can I increase the timeout for doctests? According to what google gave me, I tried `export TIMEOUT=1800`, but that didn't work.",
    "created_at": "2012-12-01T10:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163931",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'>Comment 1:</a>
How can I increase the timeout for doctests? According to what google gave me, I tried `export TIMEOUT=1800`, but that didn't work.



---

archive/issue_comments_163932.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nAha! It seems to require `SAGE_TIMEOUT`!",
    "created_at": "2012-12-01T10:52:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163932",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'>Comment 2:</a>
Aha! It seems to require `SAGE_TIMEOUT`!



---

archive/issue_comments_163933.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nEven a timeout of 1800 seconds is not enough for any test. I tried sage/schemes (because memory problems often show up there), but every single test times out.",
    "created_at": "2012-12-01T14:15:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163933",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'>Comment 3:</a>
Even a timeout of 1800 seconds is not enough for any test. I tried sage/schemes (because memory problems often show up there), but every single test times out.



---

archive/issue_comments_163934.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nI think running `sage -t --gdb ...` disables the timeout. If you're just testing a single file you might as well do that (in `screen` of course--it'll be a while before you check back). It's how I got thetraceback for the first heisenbug. It also leaves you immediately with an environment where you can examine the backtrace etc.",
    "created_at": "2012-12-01T17:30:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163934",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'>Comment 4:</a>
I think running `sage -t --gdb ...` disables the timeout. If you're just testing a single file you might as well do that (in `screen` of course--it'll be a while before you check back). It's how I got thetraceback for the first heisenbug. It also leaves you immediately with an environment where you can examine the backtrace etc.



---

archive/issue_comments_163935.json:
```json
{
    "body": "<a id='comment:115'>Comment 115:</a>\nReplying to [@nbruin](#comment%3A114):\n> I think running `sage -t --gdb ...` disables the timeout. If you're just testing a single file you might as well do that (in `screen` of course--it'll be a while before you check back). It's how I got thetraceback for the first heisenbug. It also leaves you immediately with an environment where you can examine the backtrace etc.\n\nWell, I first wanted to have a \"quick\" overview: Is there any problematic test? Namely, on Linux, everything works just fine with MALLOC_CHECK_ (except the known problem with the graphs). And *if* there is another crash on OSX in the quick test then I wanted to analyse it more deeply.\n\nBut the only test that did not timeout with `SAGE_TIMEOUT=1800` was a test that normally takes 3.5 seconds...\n\nIs there any other memory checker than gmalloc that I can use on OSX, that is faster and finds *some* of the issues that gmalloc would find?",
    "created_at": "2012-12-01T18:15:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163935",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:115'>Comment 115:</a>
Replying to [@nbruin](#comment%3A114):
> I think running `sage -t --gdb ...` disables the timeout. If you're just testing a single file you might as well do that (in `screen` of course--it'll be a while before you check back). It's how I got thetraceback for the first heisenbug. It also leaves you immediately with an environment where you can examine the backtrace etc.

Well, I first wanted to have a "quick" overview: Is there any problematic test? Namely, on Linux, everything works just fine with MALLOC_CHECK_ (except the known problem with the graphs). And *if* there is another crash on OSX in the quick test then I wanted to analyse it more deeply.

But the only test that did not timeout with `SAGE_TIMEOUT=1800` was a test that normally takes 3.5 seconds...

Is there any other memory checker than gmalloc that I can use on OSX, that is faster and finds *some* of the issues that gmalloc would find?



---

archive/issue_comments_163936.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nConcerning the packaging of `xalloc` in the singular package. Presently:\n\n```\n$ ls -l /tmp/singular_xalloc.patch\n-r--------. 1  847572 Dec  1 10:05 /tmp/singular_xalloc.patch\n$ grep '^-' /tmp/singular_xalloc.patch |wc\n  26089  106795  824416\n$ grep '^+' /tmp/singular_xalloc.patch |wc\n    374    1168   10286\n```\nso it's a large patch: 800kB on 8MB for the spkg. I guess it'll compress well, so the ration is not quite 10%, but still: The patch mainly consists of exactly listing all the files in the `omalloc` directory in order to delete them. That means that we're now shipping `omalloc` twice in order to be able to remove it.\n\nI propose to code the patch differently:\n- put xalloc into its own subdir; inside next to `omalloc` probably. You can do this by patch or something else.\n- If `SINGULAR_XALLOC` is `yes`, do explicit `mv` and or `ln -s` commands to more the original `omalloc` out of the way and replace it by `xalloc`\n- the changes to the singular source itself should of course remain in the patch file.\nPerhaps it's not according to the letter of \"use patch to change src\", but patch is just inappropriate for a `rip out and replace` operation like this.",
    "created_at": "2012-12-01T18:20:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163936",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'>Comment 6:</a>
Concerning the packaging of `xalloc` in the singular package. Presently:

```
$ ls -l /tmp/singular_xalloc.patch
-r--------. 1  847572 Dec  1 10:05 /tmp/singular_xalloc.patch
$ grep '^-' /tmp/singular_xalloc.patch |wc
  26089  106795  824416
$ grep '^+' /tmp/singular_xalloc.patch |wc
    374    1168   10286
```
so it's a large patch: 800kB on 8MB for the spkg. I guess it'll compress well, so the ration is not quite 10%, but still: The patch mainly consists of exactly listing all the files in the `omalloc` directory in order to delete them. That means that we're now shipping `omalloc` twice in order to be able to remove it.

I propose to code the patch differently:
- put xalloc into its own subdir; inside next to `omalloc` probably. You can do this by patch or something else.
- If `SINGULAR_XALLOC` is `yes`, do explicit `mv` and or `ln -s` commands to more the original `omalloc` out of the way and replace it by `xalloc`
- the changes to the singular source itself should of course remain in the patch file.
Perhaps it's not according to the letter of "use patch to change src", but patch is just inappropriate for a `rip out and replace` operation like this.



---

archive/issue_events_170311.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-12-03T13:04:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170311"
}
```



---

archive/issue_comments_163937.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,15 +1,28 @@\n+We created a new patchlevel for the singular-3-1-5 spkg. It contains backports of some upstream fixes of several memory corruptions.\n+\n+If one does `export SINGULAR_XALLOC=yes` before installing the spkg, Singular's usual memory manager \"omalloc\" will be replaced by \"xalloc\". This is a compatibility layer on top of malloc. The resulting Singular executable and library will be slower, but allows the use of some debug tools.\n+\n+Here is the background.\n+\n We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything.\n \n-For that purpose, one can use one of the following:\n+Preliminary packages for linux and for osx using malloc are found here:\n \n * [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux). It replaces omalloc by the system malloc and tries to keep the changes small. It does build a libsingular library, but the Singular executable does not work.\n * [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX). Same as the previous item.\n+\n+With the help from [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus), we managed to use xalloc instead of malloc. We now obtain Singular executable and library, and can still use debugging tools.\n+\n+**__Install__**\n+\n * [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).\n-  * It contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\n-  * It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. See the discussion on [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus)\n-  * It builds both a working libsingular library and a Singular executable.\n \n-With the [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:\n+The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\n+It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. \n+\n+**__Bugs fixed__**\n+\n+With the preliminary [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:\n \n ```\n $ export MALLOC_CHECK_ 3\n@@ -46,4 +59,13 @@\n __pyx_skip_dispatch=<optimized out>)\n     at sage/rings/polynomial/plural.cpp:12060\n ```\n-running it in valgrind gets you complaints about the same locations. Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes.\n+running it in valgrind gets you complaints about the same locations.\n+\n+On OSX, `MALLOC_CHECK_` is not available. But gmalloc does detect the crash.\n+\n+The new spkg fixes that problem\n+\n+**__Testing__**\n+\n+Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes. With the exeption of one unrelated problem in sage/graphs/, the whole Sage test suite passes on Linux with `export MALLOC_CHECK_=yes`.\n+\n``````\n",
    "created_at": "2012-12-03T13:04:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163937",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,15 +1,28 @@
+We created a new patchlevel for the singular-3-1-5 spkg. It contains backports of some upstream fixes of several memory corruptions.
+
+If one does `export SINGULAR_XALLOC=yes` before installing the spkg, Singular's usual memory manager "omalloc" will be replaced by "xalloc". This is a compatibility layer on top of malloc. The resulting Singular executable and library will be slower, but allows the use of some debug tools.
+
+Here is the background.
+
 We have several indications that interaction with libsingular's memory management is tricky. Debugging is hard, because libsingular uses omalloc for its memory management and that hides all allocation/deallocation from conventional memory checking tools. Singular's allocation library is relatively pluggable, though, and (at a speed penalty) one can mostly switch it to using the system malloc for everything.
 
-For that purpose, one can use one of the following:
+Preliminary packages for linux and for osx using malloc are found here:
 
 * [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg) (for linux). It replaces omalloc by the system malloc and tries to keep the changes small. It does build a libsingular library, but the Singular executable does not work.
 * [http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc.spkg) (for OSX). Same as the previous item.
+
+With the help from [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus), we managed to use xalloc instead of malloc. We now obtain Singular executable and library, and can still use debugging tools.
+
+**__Install__**
+
 * [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).
-  * It contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
-  * It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. See the discussion on [libsingular-devel](https://groups.google.com/forum/?hl=en&fromgroups=#!topic/libsingular-devel/AZI-6eZAgus)
-  * It builds both a working libsingular library and a Singular executable.
 
-With the [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:
+The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
+It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. 
+
+**__Bugs fixed__**
+
+With the preliminary [linux spkg](http://sage.math.washington.edu/home/nbruin/singular-3-1-5.malloc-linux.spkg), one obtains:
 
 ```
 $ export MALLOC_CHECK_ 3
@@ -46,4 +59,13 @@
 __pyx_skip_dispatch=<optimized out>)
     at sage/rings/polynomial/plural.cpp:12060
 ```
-running it in valgrind gets you complaints about the same locations. Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes.
+running it in valgrind gets you complaints about the same locations.
+
+On OSX, `MALLOC_CHECK_` is not available. But gmalloc does detect the crash.
+
+The new spkg fixes that problem
+
+**__Testing__**
+
+Meanwhile two of the underlying problems where found and fixed upstream. [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) contains backports of these fixes. With the exeption of one unrelated problem in sage/graphs/, the whole Sage test suite passes on Linux with `export MALLOC_CHECK_=yes`.
+
``````




---

archive/issue_comments_163938.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nI have produced a new patchlevel for the singular spkg. The optional patch is now smaller, since I simply erase the content of the omalloc/ folder, so that the removed files are not part of the patch.\n\nNeeds review!",
    "created_at": "2012-12-03T13:04:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163938",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'>Comment 7:</a>
I have produced a new patchlevel for the singular spkg. The optional patch is now smaller, since I simply erase the content of the omalloc/ folder, so that the removed files are not part of the patch.

Needs review!



---

archive/issue_comments_163939.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nWith singular-xalloc and using gmalloc on bsd.math, I tested sage/schemes. Of course, most tests timed out. But these few did fail differently:\n\n```\n        sage -t  \"devel/sage/sage/schemes/toric/divisor_class.pyx\"\n        sage -t  \"devel/sage/sage/schemes/toric/fano_variety.py\"\n        sage -t  \"devel/sage/sage/schemes/toric/homset.py\"\n        sage -t  \"devel/sage/sage/schemes/toric/library.py\"\n```\n\nI don't know why, but there was no test.log for it. Hence, I am now repeating these tests separately.",
    "created_at": "2012-12-06T07:18:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163939",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'>Comment 8:</a>
With singular-xalloc and using gmalloc on bsd.math, I tested sage/schemes. Of course, most tests timed out. But these few did fail differently:

```
        sage -t  "devel/sage/sage/schemes/toric/divisor_class.pyx"
        sage -t  "devel/sage/sage/schemes/toric/fano_variety.py"
        sage -t  "devel/sage/sage/schemes/toric/homset.py"
        sage -t  "devel/sage/sage/schemes/toric/library.py"
```

I don't know why, but there was no test.log for it. Hence, I am now repeating these tests separately.



---

archive/issue_comments_163940.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nValgrind gives suspicious records for two of these tests:\n\n`sage -t --valgrind \"devel/sage/sage/schemes/toric/fano_variety.py\"`\n\n```\n==20768== Syscall param open(filename) points to unaddressable byte(s)\n==20768==    at 0x31CFEE41F0: __open_nocancel (in /lib64/libc-2.14.90.so)\n==20768==    by 0x31CFE79508: _IO_file_fopen@@GLIBC_2.2.5 (in /lib64/libc-2.14.90.so)\n==20768==    by 0x31CFE6E265: __fopen_internal (in /lib64/libc-2.14.90.so)\n==20768==    by 0x31D6275A06: std::__basic_file<char>::open(char const*, std::_Ios_Openmode, int) (in /usr/lib64/libstdc++.so.6.0.16)\n==20768==    by 0x31D627947B: std::basic_filebuf<char, std::char_traits<char> >::open(char const*, std::_Ios_Openmode) (in /usr/lib64/libstdc++.so.6.0.16)\n==20768==    by 0x31D627A9D2: std::basic_ofstream<char, std::char_traits<char> >::basic_ofstream(char const*, std::_Ios_Openmode) (in /usr/lib64/libstdc++.so.6.0.16)\n==20768==    by 0x2D69E6E2: LinBox::commentator() (commentator.h:857)\n==20768==    by 0x2D7BF15E: unsigned long& LinBox::rank<LinBox::BlasMatrix<LinBox::PID_integer>, LinBox::HybridSpecifier>(unsigned long&, LinBox::BlasMatrix<LinBox::PID_integer> const&, LinBox::RingCategories::IntegerTag const&, LinBox::HybridSpecifier const&) (rank.h:629)\n==20768==    by 0x2D6A864C: linbox_integer_dense_rank(__mpz_struct (**) [1], unsigned long, unsigned long) (rank.h:110)\n==20768==    by 0x2B4B25FC: __pyx_pf_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_100_rank_linbox (matrix_integer_dense.c:25464)\n==20768==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==20768==    by 0x2B4BFC5E: __pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_99rank (matrix_integer_dense.c:25357)\n==20768==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==20768==    by 0x2BB90582: __pyx_pw_4sage_6matrix_21matrix_rational_dense_21Matrix_rational_dense_83rank (matrix_rational_dense.c:21989)\n==20768==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==20768==    by 0x2973737D: __pyx_pw_4sage_6matrix_7matrix2_6Matrix_7solve_right (matrix2.c:4604)\n==20768==    by 0x4CFC624: PyEval_EvalFrameEx (ceval.c:4021)\n==20768==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==20768==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n==20768==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==20768==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n==20768==  Address 0x0 is not stack'd, malloc'd or (recently) free'd\n```\nI don't know how serious it is to call open with a zero pointer. Probably not at all...\n\n\n`sage -t  \"devel/sage/sage/schemes/toric/library.py\"`:\n\n```\n==21248== Invalid read of size 8\n==21248==    at 0x3432C24F: __pyx_f_4sage_9functions_8prime_pi_7PrimePi_prime_phi_small (prime_pi.c:2190)\n==21248==    by 0x3432A937: __pyx_f_4sage_9functions_8prime_pi_7PrimePi_prime_phi_large (prime_pi.c:1624)\n==21248==    by 0x3432B349: __pyx_pf_4sage_9functions_8prime_pi_7PrimePi_4__call__ (prime_pi.c:1489)\n==21248==    by 0x3432BBBC: __pyx_pw_4sage_9functions_8prime_pi_7PrimePi_5__call__ (prime_pi.c:1202)\n==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==21248==    by 0x2ADCA63A: __pyx_pw_4sage_3ext_13multi_modular_22MultiModularBasis_base_5__init__ (multi_modular.c:4498)\n==21248==    by 0x4CB5DC7: type_call (typeobject.c:737)\n==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==21248==    by 0x2B4CCDF4: __pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_45_multiply_multi_modular (matrix_integer_dense.c:12884)\n==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==21248==    by 0x2B4BE7C6: __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__matrix_times_matrix_ (matrix_integer_dense.c:10112)\n==21248==    by 0x43DCC37E: __pyx_f_4sage_6matrix_6action_18MatrixMatrixAction__call_ (action.c:3179)\n==21248==    by 0x151550FE: __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_bin_op (coerce.c:6785)\n==21248==    by 0x14CE7775: __pyx_pw_4sage_9structure_7element_6Matrix_5__mul__ (element.c:19222)\n==21248==    by 0x4C5435E: binary_op1 (abstract.c:945)\n==21248==    by 0x4C572A7: PyNumber_Multiply (abstract.c:1216)\n==21248==    by 0x4CFA2F0: PyEval_EvalFrameEx (ceval.c:1264)\n==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)\n==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)\n==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)\n==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==21248==  Address 0x3f42f390 is 0 bytes after a block of size 336 alloc'd\n==21248==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)\n==21248==    by 0x3432B173: __pyx_pf_4sage_9functions_8prime_pi_7PrimePi_4__call__ (memory.h:32)\n==21248==    by 0x3432BBBC: __pyx_pw_4sage_9functions_8prime_pi_7PrimePi_5__call__ (prime_pi.c:1202)\n==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==21248==    by 0x2ADCA63A: __pyx_pw_4sage_3ext_13multi_modular_22MultiModularBasis_base_5__init__ (multi_modular.c:4498)\n==21248==    by 0x4CB5DC7: type_call (typeobject.c:737)\n==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==21248==    by 0x2B4CCDF4: __pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_45_multiply_multi_modular (matrix_integer_dense.c:12884)\n==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)\n==21248==    by 0x2B4BE7C6: __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__matrix_times_matrix_ (matrix_integer_dense.c:10112)\n==21248==    by 0x43DCC37E: __pyx_f_4sage_6matrix_6action_18MatrixMatrixAction__call_ (action.c:3179)\n==21248==    by 0x151550FE: __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_bin_op (coerce.c:6785)\n==21248==    by 0x14CE7775: __pyx_pw_4sage_9structure_7element_6Matrix_5__mul__ (element.c:19222)\n==21248==    by 0x4C5435E: binary_op1 (abstract.c:945)\n==21248==    by 0x4C572A7: PyNumber_Multiply (abstract.c:1216)\n==21248==    by 0x4CFA2F0: PyEval_EvalFrameEx (ceval.c:1264)\n==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)\n==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)\n==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)\n==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)\n==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)\n```\nThis looks like an off-by-one on an array of small primes. Indeed, in\n\n`sage/functions/prime_pi.pyx`:196\n\n```\n        self.primes = <long*> sage_malloc(self.primeCount*sizeof(long))\n```\n\nwhereas in\n\n`sage/functions/prime_pi.pyx`:263\n\n```\n        for i in range(4, self.primeCount):\n            if prime >= m_max: break\n            x = N / prime\n            if preTransition:\n                if prime*prime <= x:\n                    sum -= self.prime_phi_small(x, prime) - i\n                else:\n                    sum -= self.prime_phi_small(x) - i\n                    preTransition = False\n            else:\n                sum -= self.prime_phi_small(x) - i\n            prime = self.primes[i + 1]\n        return sum\n```\nThe last line indeed gets `prime` from an unallocated address. However, that value doesn't get used. So if this instruction succeeds I don't think it'll do harm, but in extremely unlucky situations (when `self.primes` is just at the edge of a page) this could lead to a segfault. The same thing happens at other places in this file too.\n\nThe sanitary thing is to allocate one \"long\" more. Then we'll only read memory that's guaranteed to exist.",
    "created_at": "2012-12-06T18:16:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163940",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'>Comment 9:</a>
Valgrind gives suspicious records for two of these tests:

`sage -t --valgrind "devel/sage/sage/schemes/toric/fano_variety.py"`

```
==20768== Syscall param open(filename) points to unaddressable byte(s)
==20768==    at 0x31CFEE41F0: __open_nocancel (in /lib64/libc-2.14.90.so)
==20768==    by 0x31CFE79508: _IO_file_fopen@@GLIBC_2.2.5 (in /lib64/libc-2.14.90.so)
==20768==    by 0x31CFE6E265: __fopen_internal (in /lib64/libc-2.14.90.so)
==20768==    by 0x31D6275A06: std::__basic_file<char>::open(char const*, std::_Ios_Openmode, int) (in /usr/lib64/libstdc++.so.6.0.16)
==20768==    by 0x31D627947B: std::basic_filebuf<char, std::char_traits<char> >::open(char const*, std::_Ios_Openmode) (in /usr/lib64/libstdc++.so.6.0.16)
==20768==    by 0x31D627A9D2: std::basic_ofstream<char, std::char_traits<char> >::basic_ofstream(char const*, std::_Ios_Openmode) (in /usr/lib64/libstdc++.so.6.0.16)
==20768==    by 0x2D69E6E2: LinBox::commentator() (commentator.h:857)
==20768==    by 0x2D7BF15E: unsigned long& LinBox::rank<LinBox::BlasMatrix<LinBox::PID_integer>, LinBox::HybridSpecifier>(unsigned long&, LinBox::BlasMatrix<LinBox::PID_integer> const&, LinBox::RingCategories::IntegerTag const&, LinBox::HybridSpecifier const&) (rank.h:629)
==20768==    by 0x2D6A864C: linbox_integer_dense_rank(__mpz_struct (**) [1], unsigned long, unsigned long) (rank.h:110)
==20768==    by 0x2B4B25FC: __pyx_pf_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_100_rank_linbox (matrix_integer_dense.c:25464)
==20768==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==20768==    by 0x2B4BFC5E: __pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_99rank (matrix_integer_dense.c:25357)
==20768==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==20768==    by 0x2BB90582: __pyx_pw_4sage_6matrix_21matrix_rational_dense_21Matrix_rational_dense_83rank (matrix_rational_dense.c:21989)
==20768==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==20768==    by 0x2973737D: __pyx_pw_4sage_6matrix_7matrix2_6Matrix_7solve_right (matrix2.c:4604)
==20768==    by 0x4CFC624: PyEval_EvalFrameEx (ceval.c:4021)
==20768==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==20768==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
==20768==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==20768==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
==20768==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
```
I don't know how serious it is to call open with a zero pointer. Probably not at all...


`sage -t  "devel/sage/sage/schemes/toric/library.py"`:

```
==21248== Invalid read of size 8
==21248==    at 0x3432C24F: __pyx_f_4sage_9functions_8prime_pi_7PrimePi_prime_phi_small (prime_pi.c:2190)
==21248==    by 0x3432A937: __pyx_f_4sage_9functions_8prime_pi_7PrimePi_prime_phi_large (prime_pi.c:1624)
==21248==    by 0x3432B349: __pyx_pf_4sage_9functions_8prime_pi_7PrimePi_4__call__ (prime_pi.c:1489)
==21248==    by 0x3432BBBC: __pyx_pw_4sage_9functions_8prime_pi_7PrimePi_5__call__ (prime_pi.c:1202)
==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==21248==    by 0x2ADCA63A: __pyx_pw_4sage_3ext_13multi_modular_22MultiModularBasis_base_5__init__ (multi_modular.c:4498)
==21248==    by 0x4CB5DC7: type_call (typeobject.c:737)
==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==21248==    by 0x2B4CCDF4: __pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_45_multiply_multi_modular (matrix_integer_dense.c:12884)
==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==21248==    by 0x2B4BE7C6: __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__matrix_times_matrix_ (matrix_integer_dense.c:10112)
==21248==    by 0x43DCC37E: __pyx_f_4sage_6matrix_6action_18MatrixMatrixAction__call_ (action.c:3179)
==21248==    by 0x151550FE: __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_bin_op (coerce.c:6785)
==21248==    by 0x14CE7775: __pyx_pw_4sage_9structure_7element_6Matrix_5__mul__ (element.c:19222)
==21248==    by 0x4C5435E: binary_op1 (abstract.c:945)
==21248==    by 0x4C572A7: PyNumber_Multiply (abstract.c:1216)
==21248==    by 0x4CFA2F0: PyEval_EvalFrameEx (ceval.c:1264)
==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)
==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)
==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)
==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==21248==  Address 0x3f42f390 is 0 bytes after a block of size 336 alloc'd
==21248==    at 0x4A0762F: malloc (vg_replace_malloc.c:270)
==21248==    by 0x3432B173: __pyx_pf_4sage_9functions_8prime_pi_7PrimePi_4__call__ (memory.h:32)
==21248==    by 0x3432BBBC: __pyx_pw_4sage_9functions_8prime_pi_7PrimePi_5__call__ (prime_pi.c:1202)
==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==21248==    by 0x2ADCA63A: __pyx_pw_4sage_3ext_13multi_modular_22MultiModularBasis_base_5__init__ (multi_modular.c:4498)
==21248==    by 0x4CB5DC7: type_call (typeobject.c:737)
==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==21248==    by 0x2B4CCDF4: __pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_45_multiply_multi_modular (matrix_integer_dense.c:12884)
==21248==    by 0x4C59402: PyObject_Call (abstract.c:2529)
==21248==    by 0x2B4BE7C6: __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__matrix_times_matrix_ (matrix_integer_dense.c:10112)
==21248==    by 0x43DCC37E: __pyx_f_4sage_6matrix_6action_18MatrixMatrixAction__call_ (action.c:3179)
==21248==    by 0x151550FE: __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_bin_op (coerce.c:6785)
==21248==    by 0x14CE7775: __pyx_pw_4sage_9structure_7element_6Matrix_5__mul__ (element.c:19222)
==21248==    by 0x4C5435E: binary_op1 (abstract.c:945)
==21248==    by 0x4C572A7: PyNumber_Multiply (abstract.c:1216)
==21248==    by 0x4CFA2F0: PyEval_EvalFrameEx (ceval.c:1264)
==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)
==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)
==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
==21248==    by 0x4CFD3CA: PyEval_EvalFrameEx (ceval.c:4107)
==21248==    by 0x4CFE274: PyEval_EvalCodeEx (ceval.c:3253)
==21248==    by 0x4CFC69F: PyEval_EvalFrameEx (ceval.c:4117)
```
This looks like an off-by-one on an array of small primes. Indeed, in

`sage/functions/prime_pi.pyx`:196

```
        self.primes = <long*> sage_malloc(self.primeCount*sizeof(long))
```

whereas in

`sage/functions/prime_pi.pyx`:263

```
        for i in range(4, self.primeCount):
            if prime >= m_max: break
            x = N / prime
            if preTransition:
                if prime*prime <= x:
                    sum -= self.prime_phi_small(x, prime) - i
                else:
                    sum -= self.prime_phi_small(x) - i
                    preTransition = False
            else:
                sum -= self.prime_phi_small(x) - i
            prime = self.primes[i + 1]
        return sum
```
The last line indeed gets `prime` from an unallocated address. However, that value doesn't get used. So if this instruction succeeds I don't think it'll do harm, but in extremely unlucky situations (when `self.primes` is just at the edge of a page) this could lead to a segfault. The same thing happens at other places in this file too.

The sanitary thing is to allocate one "long" more. Then we'll only read memory that's guaranteed to exist.



---

archive/issue_events_170312.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-12-07T21:29:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170312"
}
```



---

archive/issue_events_170313.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-12-07T21:29:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170313"
}
```



---

archive/issue_comments_163941.json:
```json
{
    "body": "<a id='comment:0'>Comment 0:</a>\ndoctests check out as far as I can test. Business rules for spkg have been followed, so I think this can get a positive review.\n\nThe new spkg doesn't actually contain code written by me, so I think I'm eligible to give a positive review.",
    "created_at": "2012-12-07T21:29:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163941",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:0'>Comment 0:</a>
doctests check out as far as I can test. Business rules for spkg have been followed, so I think this can get a positive review.

The new spkg doesn't actually contain code written by me, so I think I'm eligible to give a positive review.



---

archive/issue_events_170314.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-12-07T21:29:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170314"
}
```



---

archive/issue_events_170315.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-12-07T21:29:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "milestone_number": null,
    "milestone_title": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170315"
}
```



---

archive/issue_events_170316.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-15T02:26:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "milestone_number": null,
    "milestone_title": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170316"
}
```



---

archive/issue_events_170317.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-15T02:26:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170317"
}
```



---

archive/issue_comments_163942.json:
```json
{
    "body": "Reviewer: **Nils Bruin**",
    "created_at": "2012-12-15T02:26:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163942",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Nils Bruin**



---

archive/issue_comments_163943.json:
```json
{
    "body": "<a id='comment:122'>Comment 122:</a>\nReplying to [@nbruin](#comment%3A119):\n> Valgrind gives suspicious records for two of these tests:\n\n>\n> ...\n>\n> `sage -t  \"devel/sage/sage/schemes/toric/library.py\"`:\n>\n> ...\n>\n> This looks like an off-by-one on an array of small primes. Indeed, in\n> \n> `sage/functions/prime_pi.pyx`:196\n>\n> ```\n>         self.primes = <long*> sage_malloc(self.primeCount*sizeof(long))\n> ```\n> \n> whereas in\n> \n> `sage/functions/prime_pi.pyx`:263\n>\n> ```\n>         for i in range(4, self.primeCount):\n>             if prime >= m_max: break\n>             x = N / prime\n>             if preTransition:\n>                 if prime*prime <= x:\n>                     sum -= self.prime_phi_small(x, prime) - i\n>                 else:\n>                     sum -= self.prime_phi_small(x) - i\n>                     preTransition = False\n>             else:\n>                 sum -= self.prime_phi_small(x) - i\n>             prime = self.primes[i + 1]\n>         return sum\n> ```\n> The last line indeed gets `prime` from an unallocated address. However, that value doesn't get used. So if this instruction succeeds I don't think it'll do harm, but in extremely unlucky situations (when `self.primes` is just at the edge of a page) this could lead to a segfault. The same thing happens at other places in this file too.\n> \n> The sanitary thing is to allocate one \"long\" more. Then we'll only read memory that's guaranteed to exist.\n\nOK, but that wouldn't be an upstream bug, right?\n\nShall it then be dealt with on a different ticket, or shall we provide a patch for the Sage library, in addition to the new Singular spkg?",
    "created_at": "2012-12-15T11:24:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163943",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:122'>Comment 122:</a>
Replying to [@nbruin](#comment%3A119):
> Valgrind gives suspicious records for two of these tests:

>
> ...
>
> `sage -t  "devel/sage/sage/schemes/toric/library.py"`:
>
> ...
>
> This looks like an off-by-one on an array of small primes. Indeed, in
> 
> `sage/functions/prime_pi.pyx`:196
>
> ```
>         self.primes = <long*> sage_malloc(self.primeCount*sizeof(long))
> ```
> 
> whereas in
> 
> `sage/functions/prime_pi.pyx`:263
>
> ```
>         for i in range(4, self.primeCount):
>             if prime >= m_max: break
>             x = N / prime
>             if preTransition:
>                 if prime*prime <= x:
>                     sum -= self.prime_phi_small(x, prime) - i
>                 else:
>                     sum -= self.prime_phi_small(x) - i
>                     preTransition = False
>             else:
>                 sum -= self.prime_phi_small(x) - i
>             prime = self.primes[i + 1]
>         return sum
> ```
> The last line indeed gets `prime` from an unallocated address. However, that value doesn't get used. So if this instruction succeeds I don't think it'll do harm, but in extremely unlucky situations (when `self.primes` is just at the edge of a page) this could lead to a segfault. The same thing happens at other places in this file too.
> 
> The sanitary thing is to allocate one "long" more. Then we'll only read memory that's guaranteed to exist.

OK, but that wouldn't be an upstream bug, right?

Shall it then be dealt with on a different ticket, or shall we provide a patch for the Sage library, in addition to the new Singular spkg?



---

archive/issue_comments_163944.json:
```json
{
    "body": "<a id='comment:123'>Comment 123:</a>\nReplying to [@simon-king-jena](#comment%3A122):\n> OK, but that wouldn't be an upstream bug, right?\n> Shall it then be dealt with on a different ticket, or shall we provide a patch for the Sage library, in addition to the new Singular spkg?\n\nAbsolutely a separate ticket! Those issues have nothing to do with singular. They are just diagnosed by running doctests through Valgrind.",
    "created_at": "2012-12-16T03:14:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163944",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:123'>Comment 123:</a>
Replying to [@simon-king-jena](#comment%3A122):
> OK, but that wouldn't be an upstream bug, right?
> Shall it then be dealt with on a different ticket, or shall we provide a patch for the Sage library, in addition to the new Singular spkg?

Absolutely a separate ticket! Those issues have nothing to do with singular. They are just diagnosed by running doctests through Valgrind.



---

archive/issue_comments_163945.json:
```json
{
    "body": "Merged: **sage-5.6.beta0**",
    "created_at": "2012-12-18T11:14:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163945",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.6.beta0**



---

archive/issue_events_170318.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-18T11:14:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170318"
}
```



---

archive/issue_events_170319.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-18T11:14:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170319"
}
```



---

archive/issue_comments_163946.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,7 +17,7 @@\n \n * [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).\n \n-The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\n+The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)(https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\n It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. \n \n **__Bugs fixed__**\n``````\n",
    "created_at": "2012-12-21T07:41:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163946",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,7 +17,7 @@
 
 * [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).
 
-The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch](https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
+The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)(https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
 It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. 
 
 **__Bugs fixed__**
``````




---

archive/issue_comments_163947.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nWhere did the Makefile for xalloc come from? It's written in a non-autotools way and should be fixed. It's probably easy to fix, but it should be reported \"upstream\", whoever that is.",
    "created_at": "2012-12-21T07:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163947",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'>Comment 6:</a>
Where did the Makefile for xalloc come from? It's written in a non-autotools way and should be fixed. It's probably easy to fix, but it should be reported "upstream", whoever that is.



---

archive/issue_comments_163948.json:
```json
{
    "body": "Changed merged from **sage-5.6.beta0** to none",
    "created_at": "2012-12-21T07:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163948",
    "user": "https://github.com/jdemeyer"
}
```

Changed merged from **sage-5.6.beta0** to none



---

archive/issue_comments_163949.json:
```json
{
    "body": "<a id='comment:128'>Comment 128:</a>\nReplying to [@jdemeyer](#comment%3A126):\n> Where did the Makefile for xalloc come from? It's written in a non-autotools way and should be fixed. It's probably easy to fix, but it should be reported \"upstream\", whoever that is.\n\nIt originally came from upstream (i.e., Hans Sch\u00f6nemann), but the \"install\" bits are my modifications. I have no idea how to use autotools to do it correctly.",
    "created_at": "2012-12-21T10:01:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163949",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:128'>Comment 128:</a>
Replying to [@jdemeyer](#comment%3A126):
> Where did the Makefile for xalloc come from? It's written in a non-autotools way and should be fixed. It's probably easy to fix, but it should be reported "upstream", whoever that is.

It originally came from upstream (i.e., Hans Schönemann), but the "install" bits are my modifications. I have no idea how to use autotools to do it correctly.



---

archive/issue_comments_163950.json:
```json
{
    "body": "<a id='comment:129'>Comment 129:</a>\nReplying to [@simon-king-jena](#comment%3A128):\n> Replying to [@jdemeyer](#comment%3A126):\n> > Where did the Makefile for xalloc come from? It's written in a non-autotools way and should be fixed. It's probably easy to fix, but it should be reported \"upstream\", whoever that is.\n\n> \n> It originally came from upstream (i.e., Hans Sch\u00f6nemann), but the \"install\" bits are my modifications. I have no idea how to use autotools to do it correctly.\n\nPS: I don't think that it would be needed to inform upstream, because the optional xalloc support is not and (to my knowledge) will not be part of an official Singular release.",
    "created_at": "2012-12-21T10:19:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163950",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:129'>Comment 129:</a>
Replying to [@simon-king-jena](#comment%3A128):
> Replying to [@jdemeyer](#comment%3A126):
> > Where did the Makefile for xalloc come from? It's written in a non-autotools way and should be fixed. It's probably easy to fix, but it should be reported "upstream", whoever that is.

> 
> It originally came from upstream (i.e., Hans Schönemann), but the "install" bits are my modifications. I have no idea how to use autotools to do it correctly.

PS: I don't think that it would be needed to inform upstream, because the optional xalloc support is not and (to my knowledge) will not be part of an official Singular release.



---

archive/issue_comments_163951.json:
```json
{
    "body": "<a id='comment:0'>Comment 0:</a>\nI'll fix the Makefile, hang on...",
    "created_at": "2012-12-21T10:31:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163951",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:0'>Comment 0:</a>
I'll fix the Makefile, hang on...



---

archive/issue_events_170320.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T10:59:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170320"
}
```



---

archive/issue_comments_163952.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,7 +15,7 @@\n \n **__Install__**\n \n-* [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).\n+* [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg)\n \n The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)(https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.\n It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. \n``````\n",
    "created_at": "2012-12-21T10:59:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163952",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,7 +15,7 @@
 
 **__Install__**
 
-* [http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg](http://sage.math.washington.edu/home/SimonKing/SAGE/spkgs/singular-3-1-5.p2.spkg) (both linux and OSX).
+* [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-5.p2.spkg)
 
 The spkg contains [and [attachment: singular_part_of_changeset_baadc0f7.patch.gz](https://github.com/sagemath/sage/files/ticket13731/singular_part_of_changeset_baadc0f7.patch.gz)(https://github.com/sagemath/sage/files/ticket13731/d7d910ba5517703669285fbee93e3c52.gz), which backport upstream fixes.
 It usually builds with omalloc. If `export SINGULAR_XALLOC=yes`, then it builds with xalloc, which is a compatibility layer for omalloc on top of malloc. 
``````




---

archive/issue_comments_163953.json:
```json
{
    "body": "Patch added to the spkg",
    "created_at": "2012-12-21T11:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163953",
    "user": "https://github.com/jdemeyer"
}
```

Patch added to the spkg



---

archive/issue_comments_163954.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nAttachment: **[xalloc-makefile.diff.gz](https://github.com/sagemath/sage/files/ticket13731/xalloc-makefile.diff.gz)**\n\nI changed the spkg, the changes are here: [attachment: xalloc-makefile.diff.gz](https://github.com/sagemath/sage/files/ticket13731/xalloc-makefile.diff.gz). Needs review.",
    "created_at": "2012-12-21T11:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163954",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'>Comment 2:</a>
Attachment: **[xalloc-makefile.diff.gz](https://github.com/sagemath/sage/files/ticket13731/xalloc-makefile.diff.gz)**

I changed the spkg, the changes are here: [attachment: xalloc-makefile.diff.gz](https://github.com/sagemath/sage/files/ticket13731/xalloc-makefile.diff.gz). Needs review.



---

archive/issue_comments_163955.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nI'm trying to run Sage under the electric fence memory debugger and also ran into the `prime_phi` issue. It seems you managed to discuss it in detail but then failed to open an actual ticket for it. This is now #13861",
    "created_at": "2012-12-24T13:31:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163955",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'>Comment 3:</a>
I'm trying to run Sage under the electric fence memory debugger and also ran into the `prime_phi` issue. It seems you managed to discuss it in detail but then failed to open an actual ticket for it. This is now #13861



---

archive/issue_comments_163956.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nJeroen's changes look good to me.",
    "created_at": "2012-12-24T13:43:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163956",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'>Comment 4:</a>
Jeroen's changes look good to me.



---

archive/issue_events_170321.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-24T13:43:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170321"
}
```



---

archive/issue_events_170322.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-24T13:43:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170322"
}
```



---

archive/issue_events_170323.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-26T16:27:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170323"
}
```



---

archive/issue_events_170324.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-26T16:27:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13731#event-170324"
}
```



---

archive/issue_comments_163957.json:
```json
{
    "body": "Merged: **sage-5.6.beta0**",
    "created_at": "2012-12-26T16:27:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163957",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.6.beta0**



---

archive/issue_comments_163958.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nSorry for asking so late (after resolving the ticket as fixed). But perhaps it has been a bad idea to use a new environment variable `SINGULAR_XALLOC` to trigger the use of xalloc. What do you think: Would it be a better idea to build singular with xalloc if `SAGE_DEBUG` is set to \"yes\", as in #13864?",
    "created_at": "2012-12-26T17:38:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163958",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'>Comment 6:</a>
Sorry for asking so late (after resolving the ticket as fixed). But perhaps it has been a bad idea to use a new environment variable `SINGULAR_XALLOC` to trigger the use of xalloc. What do you think: Would it be a better idea to build singular with xalloc if `SAGE_DEBUG` is set to "yes", as in #13864?



---

archive/issue_comments_163959.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nSwitching `SINGULAR_XALLOC` to `SAGE_DEBUG` will be done in #13876.",
    "created_at": "2012-12-28T11:37:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13731",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13731#issuecomment-163959",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'>Comment 7:</a>
Switching `SINGULAR_XALLOC` to `SAGE_DEBUG` will be done in #13876.
