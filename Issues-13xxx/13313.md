# Issue 13313: Fix gcc error in pyzmq-2.1.11.p0.spkg

archive/issues_013141.json:
```json
{
    "body": "Here is the new proposed spkg: \n\n    http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg\n\nAs reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq #12843 (after its dependency zeromq of course!) on OSX 10.5.8 :\n\n```\ngcc version 4.6.3 (GCC)\n****************************************************\nrunning configure\n******************************************\nConfigure: Autodetecting ZMQ settings...\n    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local\ngcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o\ngcc: erreur: i386: No such file or directory\ngcc: erreur: unrecognized option \u2018-arch\u2019\nFatal:\n    Failed to compile ZMQ test program.  Please check to make sure:\n\n    * You have a C compiler installed\n    * A development version of Python is installed (including header files)\n    * A development version of ZMQ >= 2.1.4 is installed (including header files)\n    * If ZMQ is not in a default location, supply the argument --zmq=<path>\n    * If you did recently install ZMQ to a default location,\n      try rebuilding the ld cache with `sudo ldconfig`\n      or specify zmq's location with `--zmq=/usr/local`\n   \nerror: command 'gcc' failed with exit status 1\n******************************************\n```\n\nThe reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.\n\nThe following patch applied on the spkg fixes the problem :\n\n```diff\npyzmq-2.1.11.p1/patches $ cat buildutils.patch\n--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500\n+++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400\n@@ -111,13 +111,7 @@\n    \n     cpreargs = lpreargs = None\n     if sys.platform == 'darwin':\n-        # use appropriate arch for comiler\n-        if platform.architecture()[0]=='32bit':\n-            cpreargs = ['-arch','i386']\n-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']\n-        else:\n-            # allow for missing UB arch, since it will still work:\n-            lpreargs = ['-undefined', 'dynamic_lookup']\n+        lpreargs = ['-undefined', 'dynamic_lookup']\n \n     objs = cc.compile([cfile],extra_preargs=cpreargs)\n     cc.link_executable(objs, efile, extra_preargs=lpreargs)\n```\n\n\nAssignee: tbd\n\nReviewer: Volker Braun\n\nAuthor: S\u00e9bastien Labb\u00e9\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13313\n\n",
    "closed_at": "2013-01-26T10:03:59Z",
    "created_at": "2012-07-31T15:42:45Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "Fix gcc error in pyzmq-2.1.11.p0.spkg",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13313",
    "user": "https://github.com/seblabbe"
}
```
Here is the new proposed spkg: 

    http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg

As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq #12843 (after its dependency zeromq of course!) on OSX 10.5.8 :

```
gcc version 4.6.3 (GCC)
****************************************************
running configure
******************************************
Configure: Autodetecting ZMQ settings...
    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
gcc: erreur: i386: No such file or directory
gcc: erreur: unrecognized option ‘-arch’
Fatal:
    Failed to compile ZMQ test program.  Please check to make sure:

    * You have a C compiler installed
    * A development version of Python is installed (including header files)
    * A development version of ZMQ >= 2.1.4 is installed (including header files)
    * If ZMQ is not in a default location, supply the argument --zmq=<path>
    * If you did recently install ZMQ to a default location,
      try rebuilding the ld cache with `sudo ldconfig`
      or specify zmq's location with `--zmq=/usr/local`
   
error: command 'gcc' failed with exit status 1
******************************************
```

The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.

The following patch applied on the spkg fixes the problem :

```diff
pyzmq-2.1.11.p1/patches $ cat buildutils.patch
--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500
+++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400
@@ -111,13 +111,7 @@
    
     cpreargs = lpreargs = None
     if sys.platform == 'darwin':
-        # use appropriate arch for comiler
-        if platform.architecture()[0]=='32bit':
-            cpreargs = ['-arch','i386']
-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']
-        else:
-            # allow for missing UB arch, since it will still work:
-            lpreargs = ['-undefined', 'dynamic_lookup']
+        lpreargs = ['-undefined', 'dynamic_lookup']
 
     objs = cc.compile([cfile],extra_preargs=cpreargs)
     cc.link_executable(objs, efile, extra_preargs=lpreargs)
```


Assignee: tbd

Reviewer: Volker Braun

Author: Sébastien Labbé

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13313





---

archive/issue_comments_198821.json:
```json
{
    "body": "<a id='comment:1'></a>Could you create a proper patch and upload it as an attachment?",
    "created_at": "2012-07-31T16:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198821",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>Could you create a proper patch and upload it as an attachment?



---

archive/issue_comments_198822.json:
```json
{
    "body": "Changing component from packages to optional packages.",
    "created_at": "2012-07-31T16:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198822",
    "user": "https://github.com/dimpase"
}
```

Changing component from packages to optional packages.



---

archive/issue_comments_198823.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,6 +25,8 @@\n ******************************************\n ```\n \n+The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.\n+\n The following patch seems to fix the problem :\n \n ```diff\n@@ -48,6 +50,7 @@\n      cc.link_executable(objs, efile, extra_preargs=lpreargs)\n ```\n \n+\n Comment: 1\n \n Component: packages\n``````\n",
    "created_at": "2012-07-31T16:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198823",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,6 +25,8 @@
 ******************************************
 ```
 
+The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.
+
 The following patch seems to fix the problem :
 
 ```diff
@@ -48,6 +50,7 @@
      cc.link_executable(objs, efile, extra_preargs=lpreargs)
 ```
 
+
 Comment: 1
 
 Component: packages
``````




---

archive/issue_comments_198824.json:
```json
{
    "body": "<a id='comment:2'></a>Attachment [buildutils.patch](tarball://root/attachments/some-uuid/ticket13313/buildutils.patch) by @seblabbe created at 2012-07-31 16:48:54\n\nThe patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.\n\nS\u00e9bastien",
    "created_at": "2012-07-31T16:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198824",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:2'></a>Attachment [buildutils.patch](tarball://root/attachments/some-uuid/ticket13313/buildutils.patch) by @seblabbe created at 2012-07-31 16:48:54

The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.

Sébastien



---

archive/issue_comments_198825.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 slabbe]:\n> The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.\n> \n\n\nin a nutshell: \n\n* rename the package directory pyzmq-2.1.11.p2\n* put the patch in pyzmq-2.1.11.p2/patches\n* adjust spkg-install so that this patch is applied (assuming your patch is not a change to Sage's patches to the upstream, but a change of the upstream)\n* create pyzmq-2.1.11.p2.spkg by running sage -spkg pyzmq-2.1.11.p2/ in the corresponding directory i.e. `SAGEROOT/spkg/optional`\n* test it.\n* upload it somewhere and put a link to it into the ticket description.\n* mark the ticket as needing review\n\n(I know, sounds like a lot of work :-))",
    "created_at": "2012-07-31T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198825",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>Replying to [comment:2 slabbe]:
> The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.
> 


in a nutshell: 

* rename the package directory pyzmq-2.1.11.p2
* put the patch in pyzmq-2.1.11.p2/patches
* adjust spkg-install so that this patch is applied (assuming your patch is not a change to Sage's patches to the upstream, but a change of the upstream)
* create pyzmq-2.1.11.p2.spkg by running sage -spkg pyzmq-2.1.11.p2/ in the corresponding directory i.e. `SAGEROOT/spkg/optional`
* test it.
* upload it somewhere and put a link to it into the ticket description.
* mark the ticket as needing review

(I know, sounds like a lot of work :-))



---

archive/issue_comments_198826.json:
```json
{
    "body": "<a id='comment:4'></a>Ok thanks for the cheering. I also read [Patching a spkg](http://www.sagemath.org/doc/developer/patching_spkgs.html/) in the Developper Guide. Here is my first patch to a package (p0 was the most recent version) :\n\nhttp://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg\n\nNeeds review!",
    "created_at": "2012-07-31T18:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198826",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:4'></a>Ok thanks for the cheering. I also read [Patching a spkg](http://www.sagemath.org/doc/developer/patching_spkgs.html/) in the Developper Guide. Here is my first patch to a package (p0 was the most recent version) :

http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg

Needs review!



---

archive/issue_comments_198827.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-31T18:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198827",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_198828.json:
```json
{
    "body": "<a id='comment:6'></a>Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. \n\nThe patch looks good to me, fwiw.",
    "created_at": "2012-07-31T18:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198828",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. 

The patch looks good to me, fwiw.



---

archive/issue_comments_198829.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 vbraun]:\n> Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. \n\n\nHi Volker,\n\nwell, it was a (brain)dead response by me, the code is alive. \nLater I was able to reproduce the bug on another installation.",
    "created_at": "2012-08-01T00:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198829",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>Replying to [comment:6 vbraun]:
> Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. 


Hi Volker,

well, it was a (brain)dead response by me, the code is alive. 
Later I was able to reproduce the bug on another installation.



---

archive/issue_comments_198830.json:
```json
{
    "body": "<a id='comment:8'></a>The patch worked for me.",
    "created_at": "2012-08-02T14:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198830",
    "user": "https://trac.sagemath.org/admin/accounts/users/jtremblay"
}
```

<a id='comment:8'></a>The patch worked for me.



---

archive/issue_comments_198831.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 jtremblay]:\n> The patch worked for me.\n\n\nThe patch or the spkg ? On which machine ?",
    "created_at": "2012-08-02T18:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198831",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:9'></a>Replying to [comment:8 jtremblay]:
> The patch worked for me.


The patch or the spkg ? On which machine ?



---

archive/issue_comments_198832.json:
```json
{
    "body": "<a id='comment:10'></a>The spkg, on OSX 10.7.3 with Sage 5.2 binaries.",
    "created_at": "2012-08-02T18:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198832",
    "user": "https://trac.sagemath.org/admin/accounts/users/jtremblay"
}
```

<a id='comment:10'></a>The spkg, on OSX 10.7.3 with Sage 5.2 binaries.



---

archive/issue_comments_198833.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 jtremblay]:\n> The spkg, on OSX 10.7.3 with Sage 5.2 binaries.\n\n\nAnd were you obtaining the same problem as me while installing pyzmq-2.1.11.p0.spkg ?",
    "created_at": "2012-08-02T18:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198833",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:11'></a>Replying to [comment:10 jtremblay]:
> The spkg, on OSX 10.7.3 with Sage 5.2 binaries.


And were you obtaining the same problem as me while installing pyzmq-2.1.11.p0.spkg ?



---

archive/issue_comments_198834.json:
```json
{
    "body": "<a id='comment:12'></a>Apparently not, zmq was not installed when I tried installing pyzmq :\n\n```\nExtracting package /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg\n-rw-r--r--  1 tremblayj  wheel  464755  2 Aug 10:02 /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg\nFinished extraction\n****************************************************\nHost system:\nDarwin jerometremblayportable.local 11.4.0 Darwin Kernel Version 11.4.0: Mon Apr  9 19:32:15 PDT 2012; root:xnu-1699.26.8~1/RELEASE_X86_64 x86_64\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/Library/sage/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper\nTarget: x86_64-apple-darwin10.8.0\nConfigured with: ../src/configure --prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-local-prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-gmp=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpfr=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpc=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-system-zlib --disable-multilib  \nThread model: posix\ngcc version 4.6.3 (GCC) \n****************************************************\nrunning configure\n******************************************\nConfigure: Autodetecting ZMQ settings...\n    Custom ZMQ dir:       /Library/sage/local\ngcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -I/Library/sage/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o\ndetect/vers.c:3:17: fatal error: zmq.h: No such file or directory\ncompilation terminated.\nFatal: \n    Failed to compile ZMQ test program.  Please check to make sure:\n\n    * You have a C compiler installed\n    * A development version of Python is installed (including header files)\n    * A development version of ZMQ >= 2.1.4 is installed (including header files)\n    * If ZMQ is not in a default location, supply the argument --zmq=<path>\n    * If you did recently install ZMQ to a default location, \n      try rebuilding the ld cache with `sudo ldconfig`\n      or specify zmq's location with `--zmq=/usr/local`\n    \nerror: command 'gcc' failed with exit status 1\n\n```",
    "created_at": "2012-08-02T19:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198834",
    "user": "https://trac.sagemath.org/admin/accounts/users/jtremblay"
}
```

<a id='comment:12'></a>Apparently not, zmq was not installed when I tried installing pyzmq :

```
Extracting package /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg
-rw-r--r--  1 tremblayj  wheel  464755  2 Aug 10:02 /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg
Finished extraction
****************************************************
Host system:
Darwin jerometremblayportable.local 11.4.0 Darwin Kernel Version 11.4.0: Mon Apr  9 19:32:15 PDT 2012; root:xnu-1699.26.8~1/RELEASE_X86_64 x86_64
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/Library/sage/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper
Target: x86_64-apple-darwin10.8.0
Configured with: ../src/configure --prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-local-prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-gmp=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpfr=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpc=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-system-zlib --disable-multilib  
Thread model: posix
gcc version 4.6.3 (GCC) 
****************************************************
running configure
******************************************
Configure: Autodetecting ZMQ settings...
    Custom ZMQ dir:       /Library/sage/local
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -I/Library/sage/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
detect/vers.c:3:17: fatal error: zmq.h: No such file or directory
compilation terminated.
Fatal: 
    Failed to compile ZMQ test program.  Please check to make sure:

    * You have a C compiler installed
    * A development version of Python is installed (including header files)
    * A development version of ZMQ >= 2.1.4 is installed (including header files)
    * If ZMQ is not in a default location, supply the argument --zmq=<path>
    * If you did recently install ZMQ to a default location, 
      try rebuilding the ld cache with `sudo ldconfig`
      or specify zmq's location with `--zmq=/usr/local`
    
error: command 'gcc' failed with exit status 1

```



---

archive/issue_comments_198835.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 jtremblay]:\n> Apparently not, zmq was not installed when I tried installing pyzmq :\n\n\nYes, but this was not my question: zeromq needs to be installed before pyzmq.\n\nTo summarize: \n\n- The `pyzmq-2.1.11.p0.spkg` is broken on OSX 10.5.8.\n- The `pyzmq-2.1.11.p1.spkg` fixes the bug at least for OSX 10.5.8. \n- The `pyzmq-2.1.11.p1.spkg` also work on OSX 10.7.3.\n- And we do not know if `pyzmq-2.1.11.p0.spkg` was broken on OSX 10.7.3 also (which was my previous question).\n\n#12719 will be merged soon, so it would be nice if this ticket could be reviewed, no?",
    "created_at": "2013-01-25T10:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198835",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:13'></a>Replying to [comment:12 jtremblay]:
> Apparently not, zmq was not installed when I tried installing pyzmq :


Yes, but this was not my question: zeromq needs to be installed before pyzmq.

To summarize: 

- The `pyzmq-2.1.11.p0.spkg` is broken on OSX 10.5.8.
- The `pyzmq-2.1.11.p1.spkg` fixes the bug at least for OSX 10.5.8. 
- The `pyzmq-2.1.11.p1.spkg` also work on OSX 10.7.3.
- And we do not know if `pyzmq-2.1.11.p0.spkg` was broken on OSX 10.7.3 also (which was my previous question).

#12719 will be merged soon, so it would be nice if this ticket could be reviewed, no?



---

archive/issue_comments_198836.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,58 @@\n+Here is the new proposed spkg: \n+\n+    http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg\n+\n+As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq (#12843) on OSX 10.5.8 :\n+\n+```\n+gcc version 4.6.3 (GCC)\n+****************************************************\n+running configure\n+******************************************\n+Configure: Autodetecting ZMQ settings...\n+    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local\n+gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o\n+gcc: erreur: i386: No such file or directory\n+gcc: erreur: unrecognized option \u2018-arch\u2019\n+Fatal:\n+    Failed to compile ZMQ test program.  Please check to make sure:\n+\n+    * You have a C compiler installed\n+    * A development version of Python is installed (including header files)\n+    * A development version of ZMQ >= 2.1.4 is installed (including header files)\n+    * If ZMQ is not in a default location, supply the argument --zmq=<path>\n+    * If you did recently install ZMQ to a default location,\n+      try rebuilding the ld cache with `sudo ldconfig`\n+      or specify zmq's location with `--zmq=/usr/local`\n+   \n+error: command 'gcc' failed with exit status 1\n+******************************************\n+```\n+\n+The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.\n+\n+The following patch applied on the spkg fixes the problem :\n+\n+```diff\n+pyzmq-2.1.11.p1/patches $ cat buildutils.patch\n+--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500\n++++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400\n+@@ -111,13 +111,7 @@\n+    \n+     cpreargs = lpreargs = None\n+     if sys.platform == 'darwin':\n+-        # use appropriate arch for comiler\n+-        if platform.architecture()[0]=='32bit':\n+-            cpreargs = ['-arch','i386']\n+-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']\n+-        else:\n+-            # allow for missing UB arch, since it will still work:\n+-            lpreargs = ['-undefined', 'dynamic_lookup']\n++        lpreargs = ['-undefined', 'dynamic_lookup']\n+ \n+     objs = cc.compile([cfile],extra_preargs=cpreargs)\n+     cc.link_executable(objs, efile, extra_preargs=lpreargs)\n+```\n \n \n Comment: 1\n``````\n",
    "created_at": "2013-01-25T10:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198836",
    "user": "https://github.com/seblabbe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,58 @@
+Here is the new proposed spkg: 
+
+    http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg
+
+As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq (#12843) on OSX 10.5.8 :
+
+```
+gcc version 4.6.3 (GCC)
+****************************************************
+running configure
+******************************************
+Configure: Autodetecting ZMQ settings...
+    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local
+gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
+gcc: erreur: i386: No such file or directory
+gcc: erreur: unrecognized option ‘-arch’
+Fatal:
+    Failed to compile ZMQ test program.  Please check to make sure:
+
+    * You have a C compiler installed
+    * A development version of Python is installed (including header files)
+    * A development version of ZMQ >= 2.1.4 is installed (including header files)
+    * If ZMQ is not in a default location, supply the argument --zmq=<path>
+    * If you did recently install ZMQ to a default location,
+      try rebuilding the ld cache with `sudo ldconfig`
+      or specify zmq's location with `--zmq=/usr/local`
+   
+error: command 'gcc' failed with exit status 1
+******************************************
+```
+
+The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.
+
+The following patch applied on the spkg fixes the problem :
+
+```diff
+pyzmq-2.1.11.p1/patches $ cat buildutils.patch
+--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500
++++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400
+@@ -111,13 +111,7 @@
+    
+     cpreargs = lpreargs = None
+     if sys.platform == 'darwin':
+-        # use appropriate arch for comiler
+-        if platform.architecture()[0]=='32bit':
+-            cpreargs = ['-arch','i386']
+-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']
+-        else:
+-            # allow for missing UB arch, since it will still work:
+-            lpreargs = ['-undefined', 'dynamic_lookup']
++        lpreargs = ['-undefined', 'dynamic_lookup']
+ 
+     objs = cc.compile([cfile],extra_preargs=cpreargs)
+     cc.link_executable(objs, efile, extra_preargs=lpreargs)
+```
 
 
 Comment: 1
``````




---

archive/issue_comments_198837.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,58 @@\n+Here is the new proposed spkg: \n+\n+    http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg\n+\n+As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq #12843 (after its dependency zeromq of course!) on OSX 10.5.8 :\n+\n+```\n+gcc version 4.6.3 (GCC)\n+****************************************************\n+running configure\n+******************************************\n+Configure: Autodetecting ZMQ settings...\n+    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local\n+gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o\n+gcc: erreur: i386: No such file or directory\n+gcc: erreur: unrecognized option \u2018-arch\u2019\n+Fatal:\n+    Failed to compile ZMQ test program.  Please check to make sure:\n+\n+    * You have a C compiler installed\n+    * A development version of Python is installed (including header files)\n+    * A development version of ZMQ >= 2.1.4 is installed (including header files)\n+    * If ZMQ is not in a default location, supply the argument --zmq=<path>\n+    * If you did recently install ZMQ to a default location,\n+      try rebuilding the ld cache with `sudo ldconfig`\n+      or specify zmq's location with `--zmq=/usr/local`\n+   \n+error: command 'gcc' failed with exit status 1\n+******************************************\n+```\n+\n+The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.\n+\n+The following patch applied on the spkg fixes the problem :\n+\n+```diff\n+pyzmq-2.1.11.p1/patches $ cat buildutils.patch\n+--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500\n++++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400\n+@@ -111,13 +111,7 @@\n+    \n+     cpreargs = lpreargs = None\n+     if sys.platform == 'darwin':\n+-        # use appropriate arch for comiler\n+-        if platform.architecture()[0]=='32bit':\n+-            cpreargs = ['-arch','i386']\n+-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']\n+-        else:\n+-            # allow for missing UB arch, since it will still work:\n+-            lpreargs = ['-undefined', 'dynamic_lookup']\n++        lpreargs = ['-undefined', 'dynamic_lookup']\n+ \n+     objs = cc.compile([cfile],extra_preargs=cpreargs)\n+     cc.link_executable(objs, efile, extra_preargs=lpreargs)\n+```\n \n \n Comment: 1\n``````\n",
    "created_at": "2013-01-25T11:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198837",
    "user": "https://github.com/seblabbe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,58 @@
+Here is the new proposed spkg: 
+
+    http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg
+
+As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq #12843 (after its dependency zeromq of course!) on OSX 10.5.8 :
+
+```
+gcc version 4.6.3 (GCC)
+****************************************************
+running configure
+******************************************
+Configure: Autodetecting ZMQ settings...
+    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local
+gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
+gcc: erreur: i386: No such file or directory
+gcc: erreur: unrecognized option ‘-arch’
+Fatal:
+    Failed to compile ZMQ test program.  Please check to make sure:
+
+    * You have a C compiler installed
+    * A development version of Python is installed (including header files)
+    * A development version of ZMQ >= 2.1.4 is installed (including header files)
+    * If ZMQ is not in a default location, supply the argument --zmq=<path>
+    * If you did recently install ZMQ to a default location,
+      try rebuilding the ld cache with `sudo ldconfig`
+      or specify zmq's location with `--zmq=/usr/local`
+   
+error: command 'gcc' failed with exit status 1
+******************************************
+```
+
+The reason to this is that Sage's gcc spkg does not build a compiler which  understands the option `-arch` of Apple's clone of gcc.
+
+The following patch applied on the spkg fixes the problem :
+
+```diff
+pyzmq-2.1.11.p1/patches $ cat buildutils.patch
+--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500
++++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400
+@@ -111,13 +111,7 @@
+    
+     cpreargs = lpreargs = None
+     if sys.platform == 'darwin':
+-        # use appropriate arch for comiler
+-        if platform.architecture()[0]=='32bit':
+-            cpreargs = ['-arch','i386']
+-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']
+-        else:
+-            # allow for missing UB arch, since it will still work:
+-            lpreargs = ['-undefined', 'dynamic_lookup']
++        lpreargs = ['-undefined', 'dynamic_lookup']
+ 
+     objs = cc.compile([cfile],extra_preargs=cpreargs)
+     cc.link_executable(objs, efile, extra_preargs=lpreargs)
+```
 
 
 Comment: 1
``````




---

archive/issue_comments_198838.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-25T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198838",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_198839.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2013-01-25T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198839",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_198840.json:
```json
{
    "body": "Changing author from \"\" to \"Sebastien Labbe\"",
    "created_at": "2013-01-25T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198840",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Sebastien Labbe"



---

archive/issue_comments_198841.json:
```json
{
    "body": "<a id='comment:16'></a>Looks good to me.",
    "created_at": "2013-01-25T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198841",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Looks good to me.



---

archive/issue_comments_198842.json:
```json
{
    "body": "<a id='comment:17'></a>spkg is on its way to the servers!",
    "created_at": "2013-01-25T13:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198842",
    "user": "https://github.com/haraldschilly"
}
```

<a id='comment:17'></a>spkg is on its way to the servers!



---

archive/issue_comments_198843.json:
```json
{
    "body": "Changing author from \"Sebastien Labbe\" to \"S\u00e9bastien Labb\u00e9\"",
    "created_at": "2013-01-25T16:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198843",
    "user": "https://github.com/seblabbe"
}
```

Changing author from "Sebastien Labbe" to "Sébastien Labbé"



---

archive/issue_events_036842.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-26T10:03:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13313#event-36842"
}
```



---

archive/issue_comments_198844.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-26T10:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13313#issuecomment-198844",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
