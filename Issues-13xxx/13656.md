# Issue 13656: cached functions cannot be used as evalf

archive/issues_013452.json:
```json
{
    "body": "An error occurs when trying to use a cached function as the `evalf_func` argument to function. The error seems to be that some part of sage assumes that it can compute a hash value using `evalf_func`'s `func_code` attribute, which a cached function object doesn't have.\n\n```\nsage: def evalf(self, x, parent=complex):\n....:     return 20\n....: \nsage: f = function('f', evalf_func=evalf)\nsage: @cached_function\n....: def evalg(self, x, parent=complex):\n....:     return 30\n....: \nsage: g = function('g', evalf_func=evalg)\nException AttributeError: \"'sage.misc.cachefunc.CachedFunction' object has no attribute 'func_code'\" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored\n```\n\n**Assignee:** @jasongrout\n\n**Author:** tkluck\n\nIssue created by migration from https://trac.sagemath.org/ticket/13656\n\n",
    "created_at": "2012-10-26T15:35:39Z",
    "labels": [
        "component: misc",
        "minor",
        "bug",
        "needs info"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "cached functions cannot be used as evalf",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13656",
    "user": "https://github.com/tkluck"
}
```
An error occurs when trying to use a cached function as the `evalf_func` argument to function. The error seems to be that some part of sage assumes that it can compute a hash value using `evalf_func`'s `func_code` attribute, which a cached function object doesn't have.

```
sage: def evalf(self, x, parent=complex):
....:     return 20
....: 
sage: f = function('f', evalf_func=evalf)
sage: @cached_function
....: def evalg(self, x, parent=complex):
....:     return 30
....: 
sage: g = function('g', evalf_func=evalg)
Exception AttributeError: "'sage.misc.cachefunc.CachedFunction' object has no attribute 'func_code'" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored
```

**Assignee:** @jasongrout

**Author:** tkluck

Issue created by migration from https://trac.sagemath.org/ticket/13656





---

archive/issue_events_116686.json:
```json
{
    "actor": "https://github.com/tkluck",
    "created_at": "2012-10-26T15:51:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116686"
}
```



---

archive/issue_comments_162551.json:
```json
{
    "body": "<a id='comment:1'></a>\nI've attached a simple patch that lets cached functions expose its underlying function's attributes. Maybe that's overkill?",
    "created_at": "2012-10-26T15:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162551",
    "user": "https://github.com/tkluck"
}
```

<a id='comment:1'></a>
I've attached a simple patch that lets cached functions expose its underlying function's attributes. Maybe that's overkill?



---

archive/issue_comments_162552.json:
```json
{
    "body": "**Author:** tkluck",
    "created_at": "2012-10-26T15:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162552",
    "user": "https://github.com/tkluck"
}
```

**Author:** tkluck



---

archive/issue_comments_162553.json:
```json
{
    "body": "a preliminary fix",
    "created_at": "2012-10-26T15:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162553",
    "user": "https://github.com/tkluck"
}
```

a preliminary fix



---

archive/attachments_018468.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13656_allow_to_hash_symfunctions_even_with_cached_methods.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket13656/trac_13656_allow_to_hash_symfunctions_even_with_cached_methods.patch",
    "created_at": "2013-01-31T20:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/tscrim"
}
```



---

archive/issue_comments_162554.json:
```json
{
    "body": "<a id='comment:2'></a>\nI don't think it's overkill, but I'm not an expert. However your patch will need to have docstrings and tests in each of the methods, and it will need to have a test showing that <code>:trac:\\`13656\\`</code> was fixed. Also you'll need to fill in your real name as the author here.\n\nBest,\n\nTravis",
    "created_at": "2013-01-31T20:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162554",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
I don't think it's overkill, but I'm not an expert. However your patch will need to have docstrings and tests in each of the methods, and it will need to have a test showing that <code>:trac:\`13656\`</code> was fixed. Also you'll need to fill in your real name as the author here.

Best,

Travis



---

archive/issue_comments_162555.json:
```json
{
    "body": "<a id='comment:3'></a>\nThinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.\n\nI'll try to find out where this hashing is done and how to fix it.",
    "created_at": "2013-03-11T15:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162555",
    "user": "https://github.com/tkluck"
}
```

<a id='comment:3'></a>
Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.

I'll try to find out where this hashing is done and how to fix it.



---

archive/issue_events_116687.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116687"
}
```



---

archive/issue_events_116688.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116688"
}
```



---

archive/issue_events_116689.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116689"
}
```



---

archive/issue_events_116690.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116690"
}
```



---

archive/issue_events_116691.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-02-12T19:58:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116691"
}
```



---

archive/issue_events_116692.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-02-12T19:58:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116692"
}
```



---

archive/issue_comments_162556.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [tkluck](#comment%3A3):\n> Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.\n> \n> I'll try to find out where this hashing is done and how to fix it.\n\nThe error itself is also strange: there is a python exception that gets *ignored*. That can happen in `_dealloc_` code, or it could be happening in a cython routine that has no way of reporting back an error condition. That could point to a missing \"except\" clause in a declaration.\n\nIn fact, you do end up with an object. It just doesn't work properly:\n\n```\nsage: f(1).n()\n20\nsage: g(1).n()\nKeyError: 'x'\n```",
    "created_at": "2014-02-13T01:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162556",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>
Replying to [tkluck](#comment%3A3):
> Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.
> 
> I'll try to find out where this hashing is done and how to fix it.

The error itself is also strange: there is a python exception that gets *ignored*. That can happen in `_dealloc_` code, or it could be happening in a cython routine that has no way of reporting back an error condition. That could point to a missing "except" clause in a declaration.

In fact, you do end up with an object. It just doesn't work properly:

```
sage: f(1).n()
20
sage: g(1).n()
KeyError: 'x'
```



---

archive/issue_comments_162557.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [nbruin](#comment%3A7):\n> That could point to a missing \"except\" clause in a declaration.\n\n\nIndeed, in `function.pyx`, line 998 we have\n\n```\n    cdef long _hash_(self) except -1:\n```\nbut the corresponding line in `function.pxd`, line 40 is\n\n```\n    cdef long _hash_(self)\n```\nApparently the `pxd` declaration gets precedence and as a result cython doesn't have an opportunity to report an error, hence the \"ignored\". I'll check on the cython list if that is appropriate behaviour.\n\nThe fix in the mean time is to include the `except -1` in the `.pxd` file as well.",
    "created_at": "2014-02-13T03:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13656#issuecomment-162557",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>
Replying to [nbruin](#comment%3A7):
> That could point to a missing "except" clause in a declaration.


Indeed, in `function.pyx`, line 998 we have

```
    cdef long _hash_(self) except -1:
```
but the corresponding line in `function.pxd`, line 40 is

```
    cdef long _hash_(self)
```
Apparently the `pxd` declaration gets precedence and as a result cython doesn't have an opportunity to report an error, hence the "ignored". I'll check on the cython list if that is appropriate behaviour.

The fix in the mean time is to include the `except -1` in the `.pxd` file as well.



---

archive/issue_events_116693.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116693"
}
```



---

archive/issue_events_116694.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116694"
}
```



---

archive/issue_events_116695.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116695"
}
```



---

archive/issue_events_116696.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13656",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13656#event-116696"
}
```
