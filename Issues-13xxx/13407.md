# Issue 13407: Move sage-make_relative to sage-location

archive/issues_013235.json:
```json
{
    "body": "There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the `sage-make_relative` Python script opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a Sage build fails.\n\nExample from `install.log` of a failed parallel build:\n\n```\nsage_fortran -fPIC  -c sposv.f -o sposv.o\nsage_fortran -fPIC  -c sposvx.f -o sposvx.o\nsage_fortran -fPIC  -c spotf2.f -o spotf2.o\nMaking Python scripts relocatable...\nsage_fortran -fPIC  -c spotrf.f -o spotrf.o\nsage_fortran -fPIC  -c spotri.f -o spotri.o\nsage_fortran -fPIC  -c spotrs.f -o spotrs.o\nsage_fortran -fPIC  -c sppcon.f -o sppcon.o\nmake[2]: execvp: sage_fortran: Text file busy\nmake[2]: *** [sppcon.o] Error 127\nmake[2]: *** Waiting for unfinished jobs....\nmake[2]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'\nmake[1]: *** [lapacklib] Error 2\nmake[1]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'\nError compiling lapack.\n```\n\nThe best solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.  It also means we need a mechanism to force a `sage-location` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file\n\n```\n$SAGE_LOCAL/lib/sage-force-relocate.txt\n```\n\nApply:\n1. [attachment:13407_make_relative.patch] to the scripts repository.\n2. [attachment:13407_spkg.patch] to the `SAGE_ROOT` repository.\n\nAssignee: GeorgSWeber\n\nReviewer: Dmitrii Pasechnik\n\nAuthor: Jeroen Demeyer\n\nMerged: sage-5.4.1.rc1\n\nDependencies: #13397, #13452\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13407\n\n",
    "closed_at": "2012-11-14T08:30:19Z",
    "created_at": "2012-08-28T11:55:40Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4.1",
    "title": "Move sage-make_relative to sage-location",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13407",
    "user": "https://github.com/jdemeyer"
}
```
There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the `sage-make_relative` Python script opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a Sage build fails.

Example from `install.log` of a failed parallel build:

```
sage_fortran -fPIC  -c sposv.f -o sposv.o
sage_fortran -fPIC  -c sposvx.f -o sposvx.o
sage_fortran -fPIC  -c spotf2.f -o spotf2.o
Making Python scripts relocatable...
sage_fortran -fPIC  -c spotrf.f -o spotrf.o
sage_fortran -fPIC  -c spotri.f -o spotri.o
sage_fortran -fPIC  -c spotrs.f -o spotrs.o
sage_fortran -fPIC  -c sppcon.f -o sppcon.o
make[2]: execvp: sage_fortran: Text file busy
make[2]: *** [sppcon.o] Error 127
make[2]: *** Waiting for unfinished jobs....
make[2]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'
make[1]: *** [lapacklib] Error 2
make[1]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'
Error compiling lapack.
```

The best solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.  It also means we need a mechanism to force a `sage-location` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file

```
$SAGE_LOCAL/lib/sage-force-relocate.txt
```

Apply:
1. [attachment:13407_make_relative.patch] to the scripts repository.
2. [attachment:13407_spkg.patch] to the `SAGE_ROOT` repository.

Assignee: GeorgSWeber

Reviewer: Dmitrii Pasechnik

Author: Jeroen Demeyer

Merged: sage-5.4.1.rc1

Dependencies: #13397, #13452

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13407





---

archive/issue_comments_172553.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-There is a rare race condition associated to \\`sage-make_relative\\`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the \\`sage-make_relative\\` opens all files in \\`$SAGE_LOCAL/bin\\` for writing, it can happen that a parallel Sage build fails.\n+There is a rare race condition associated to \\`sage-make_relative\\`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the \\`sage-make_relative\\` Python script opens all files in \\`$SAGE_LOCAL/bin\\` for writing, it can happen that a Sage build fails.\n \n Example from \\`install.log\\` of a failed parallel build:\n \n```\n",
    "created_at": "2012-08-28T12:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172553",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-There is a rare race condition associated to \`sage-make_relative\`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the \`sage-make_relative\` opens all files in \`$SAGE_LOCAL/bin\` for writing, it can happen that a parallel Sage build fails.
+There is a rare race condition associated to \`sage-make_relative\`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the \`sage-make_relative\` Python script opens all files in \`$SAGE_LOCAL/bin\` for writing, it can happen that a Sage build fails.
 
 Example from \`install.log\` of a failed parallel build:
 
```




---

archive/issue_comments_172554.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,30 @@\n+There is a rare race condition associated to \\`sage-make_relative\\`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the \\`sage-make_relative\\` Python script opens all files in \\`$SAGE_LOCAL/bin\\` for writing, it can happen that a Sage build fails.\n \n+Example from \\`install.log\\` of a failed parallel build:\n+\n+\\`\\`\\`\n+sage_fortran -fPIC  -c sposv.f -o sposv.o\n+sage_fortran -fPIC  -c sposvx.f -o sposvx.o\n+sage_fortran -fPIC  -c spotf2.f -o spotf2.o\n+Making Python scripts relocatable...\n+sage_fortran -fPIC  -c spotrf.f -o spotrf.o\n+sage_fortran -fPIC  -c spotri.f -o spotri.o\n+sage_fortran -fPIC  -c spotrs.f -o spotrs.o\n+sage_fortran -fPIC  -c sppcon.f -o sppcon.o\n+make[2]: execvp: sage_fortran: Text file busy\n+make[2]: *** [sppcon.o] Error 127\n+make[2]: *** Waiting for unfinished jobs....\n+make[2]: Leaving directory \\`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'\n+make[1]: *** [lapacklib] Error 2\n+make[1]: Leaving directory \\`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'\n+Error compiling lapack.\n+\\`\\`\\`\n+\n+The best solution is to move \\`sage-make_relative\\` to \\`sage-location\\`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in \\`$SAGE_LOCAL/bin\\` is checked after every package is installed.  It also means we need a mechanism to force a \\`sage-location\\` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file\n+\n+\\`\\`\\`\n+$SAGE_LOCAL/lib/sage-force-relocate.txt\n+\\`\\`\\`\n \n Comment: 1\n \n```\n",
    "created_at": "2012-09-14T09:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172554",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,30 @@
+There is a rare race condition associated to \`sage-make_relative\`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the \`sage-make_relative\` Python script opens all files in \`$SAGE_LOCAL/bin\` for writing, it can happen that a Sage build fails.
 
+Example from \`install.log\` of a failed parallel build:
+
+\`\`\`
+sage_fortran -fPIC  -c sposv.f -o sposv.o
+sage_fortran -fPIC  -c sposvx.f -o sposvx.o
+sage_fortran -fPIC  -c spotf2.f -o spotf2.o
+Making Python scripts relocatable...
+sage_fortran -fPIC  -c spotrf.f -o spotrf.o
+sage_fortran -fPIC  -c spotri.f -o spotri.o
+sage_fortran -fPIC  -c spotrs.f -o spotrs.o
+sage_fortran -fPIC  -c sppcon.f -o sppcon.o
+make[2]: execvp: sage_fortran: Text file busy
+make[2]: *** [sppcon.o] Error 127
+make[2]: *** Waiting for unfinished jobs....
+make[2]: Leaving directory \`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'
+make[1]: *** [lapacklib] Error 2
+make[1]: Leaving directory \`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'
+Error compiling lapack.
+\`\`\`
+
+The best solution is to move \`sage-make_relative\` to \`sage-location\`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in \`$SAGE_LOCAL/bin\` is checked after every package is installed.  It also means we need a mechanism to force a \`sage-location\` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file
+
+\`\`\`
+$SAGE_LOCAL/lib/sage-force-relocate.txt
+\`\`\`
 
 Comment: 1
 
```




---

archive/issue_comments_172555.json:
```json
{
    "body": "Attachment [13407_make_relative.patch](tarball://root/attachments/some-uuid/ticket13407/13407_make_relative.patch) by @jdemeyer created at 2012-09-14 12:00:22",
    "created_at": "2012-09-14T12:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172555",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13407_make_relative.patch](tarball://root/attachments/some-uuid/ticket13407/13407_make_relative.patch) by @jdemeyer created at 2012-09-14 12:00:22



---

archive/issue_comments_172556.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [13407_spkg.patch](tarball://root/attachments/some-uuid/ticket13407/13407_spkg.patch) by @jdemeyer created at 2012-09-14 12:02:05",
    "created_at": "2012-09-14T12:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172556",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Attachment [13407_spkg.patch](tarball://root/attachments/some-uuid/ticket13407/13407_spkg.patch) by @jdemeyer created at 2012-09-14 12:02:05



---

archive/issue_comments_172557.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+There is a rare race condition associated to \\`sage-make_relative\\`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the \\`sage-make_relative\\` Python script opens all files in \\`$SAGE_LOCAL/bin\\` for writing, it can happen that a Sage build fails.\n \n+Example from \\`install.log\\` of a failed parallel build:\n+\n+\\`\\`\\`\n+sage_fortran -fPIC  -c sposv.f -o sposv.o\n+sage_fortran -fPIC  -c sposvx.f -o sposvx.o\n+sage_fortran -fPIC  -c spotf2.f -o spotf2.o\n+Making Python scripts relocatable...\n+sage_fortran -fPIC  -c spotrf.f -o spotrf.o\n+sage_fortran -fPIC  -c spotri.f -o spotri.o\n+sage_fortran -fPIC  -c spotrs.f -o spotrs.o\n+sage_fortran -fPIC  -c sppcon.f -o sppcon.o\n+make[2]: execvp: sage_fortran: Text file busy\n+make[2]: *** [sppcon.o] Error 127\n+make[2]: *** Waiting for unfinished jobs....\n+make[2]: Leaving directory \\`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'\n+make[1]: *** [lapacklib] Error 2\n+make[1]: Leaving directory \\`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'\n+Error compiling lapack.\n+\\`\\`\\`\n+\n+The best solution is to move \\`sage-make_relative\\` to \\`sage-location\\`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in \\`$SAGE_LOCAL/bin\\` is checked after every package is installed.  It also means we need a mechanism to force a \\`sage-location\\` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file\n+\n+\\`\\`\\`\n+$SAGE_LOCAL/lib/sage-force-relocate.txt\n+\\`\\`\\`\n+\n+Apply:\n+1. [attachment:13407_make_relative.patch] to the scripts repository.\n+2. [attachment:13407_spkg.patch] to the \\`SAGE_ROOT\\` repository.\n \n Comment: 1\n \n```\n",
    "created_at": "2012-09-14T12:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172557",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,34 @@
+There is a rare race condition associated to \`sage-make_relative\`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the \`sage-make_relative\` Python script opens all files in \`$SAGE_LOCAL/bin\` for writing, it can happen that a Sage build fails.
 
+Example from \`install.log\` of a failed parallel build:
+
+\`\`\`
+sage_fortran -fPIC  -c sposv.f -o sposv.o
+sage_fortran -fPIC  -c sposvx.f -o sposvx.o
+sage_fortran -fPIC  -c spotf2.f -o spotf2.o
+Making Python scripts relocatable...
+sage_fortran -fPIC  -c spotrf.f -o spotrf.o
+sage_fortran -fPIC  -c spotri.f -o spotri.o
+sage_fortran -fPIC  -c spotrs.f -o spotrs.o
+sage_fortran -fPIC  -c sppcon.f -o sppcon.o
+make[2]: execvp: sage_fortran: Text file busy
+make[2]: *** [sppcon.o] Error 127
+make[2]: *** Waiting for unfinished jobs....
+make[2]: Leaving directory \`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'
+make[1]: *** [lapacklib] Error 2
+make[1]: Leaving directory \`/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'
+Error compiling lapack.
+\`\`\`
+
+The best solution is to move \`sage-make_relative\` to \`sage-location\`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in \`$SAGE_LOCAL/bin\` is checked after every package is installed.  It also means we need a mechanism to force a \`sage-location\` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file
+
+\`\`\`
+$SAGE_LOCAL/lib/sage-force-relocate.txt
+\`\`\`
+
+Apply:
+1. [attachment:13407_make_relative.patch] to the scripts repository.
+2. [attachment:13407_spkg.patch] to the \`SAGE_ROOT\` repository.
 
 Comment: 1
 
```




---

archive/issue_comments_172558.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-09-16T17:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172558",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_172559.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-11-12T15:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172559",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172560.json:
```json
{
    "body": "<a id='comment:5'></a>all seems to make sense, and it does work.",
    "created_at": "2012-11-12T15:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172560",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>all seems to make sense, and it does work.



---

archive/issue_events_037218.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-12T16:37:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "milestone": "sage-5.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13407#event-37218"
}
```



---

archive/issue_comments_172561.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-14T08:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-172561",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_037219.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-14T08:30:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13407#event-37219"
}
```
