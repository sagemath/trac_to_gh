# Issue 13407: Move sage-make_relative to sage-location

archive/issues_013235.json:
```json
{
    "body": "There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the `sage-make_relative` Python script opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a Sage build fails.\n\nExample from `install.log` of a failed parallel build:\n\n```\nsage_fortran -fPIC  -c sposv.f -o sposv.o\nsage_fortran -fPIC  -c sposvx.f -o sposvx.o\nsage_fortran -fPIC  -c spotf2.f -o spotf2.o\nMaking Python scripts relocatable...\nsage_fortran -fPIC  -c spotrf.f -o spotrf.o\nsage_fortran -fPIC  -c spotri.f -o spotri.o\nsage_fortran -fPIC  -c spotrs.f -o spotrs.o\nsage_fortran -fPIC  -c sppcon.f -o sppcon.o\nmake[2]: execvp: sage_fortran: Text file busy\nmake[2]: *** [sppcon.o] Error 127\nmake[2]: *** Waiting for unfinished jobs....\nmake[2]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'\nmake[1]: *** [lapacklib] Error 2\nmake[1]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'\nError compiling lapack.\n```\n\nThe best solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.  It also means we need a mechanism to force a `sage-location` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file\n\n```\n$SAGE_LOCAL/lib/sage-force-relocate.txt\n```\n\nApply:\n1. [attachment:13407_make_relative.patch] to the scripts repository.\n2. [attachment:13407_spkg.patch] to the `SAGE_ROOT` repository.\n\nAssignee: GeorgSWeber\n\nReviewer: Dmitrii Pasechnik\n\nAuthor: Jeroen Demeyer\n\nMerged: sage-5.4.1.rc1\n\nDependencies: #13397, #13452\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13407\n\n",
    "closed_at": "2012-11-14T08:30:19Z",
    "created_at": "2012-08-28T11:55:40Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4.1",
    "title": "Move sage-make_relative to sage-location",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13407",
    "user": "https://github.com/jdemeyer"
}
```
There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the `sage-make_relative` Python script opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a Sage build fails.

Example from `install.log` of a failed parallel build:

```
sage_fortran -fPIC  -c sposv.f -o sposv.o
sage_fortran -fPIC  -c sposvx.f -o sposvx.o
sage_fortran -fPIC  -c spotf2.f -o spotf2.o
Making Python scripts relocatable...
sage_fortran -fPIC  -c spotrf.f -o spotrf.o
sage_fortran -fPIC  -c spotri.f -o spotri.o
sage_fortran -fPIC  -c spotrs.f -o spotrs.o
sage_fortran -fPIC  -c sppcon.f -o sppcon.o
make[2]: execvp: sage_fortran: Text file busy
make[2]: *** [sppcon.o] Error 127
make[2]: *** Waiting for unfinished jobs....
make[2]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'
make[1]: *** [lapacklib] Error 2
make[1]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'
Error compiling lapack.
```

The best solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.  It also means we need a mechanism to force a `sage-location` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file

```
$SAGE_LOCAL/lib/sage-force-relocate.txt
```

Apply:
1. [attachment:13407_make_relative.patch] to the scripts repository.
2. [attachment:13407_spkg.patch] to the `SAGE_ROOT` repository.

Assignee: GeorgSWeber

Reviewer: Dmitrii Pasechnik

Author: Jeroen Demeyer

Merged: sage-5.4.1.rc1

Dependencies: #13397, #13452

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13407





---

archive/issue_comments_201515.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the `sage-make_relative` opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a parallel Sage build fails.\n+There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a \"Text file busy\" error). Since the `sage-make_relative` Python script opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a Sage build fails.\n \n Example from `install.log` of a failed parallel build:\n \n``````\n",
    "created_at": "2012-08-28T12:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201515",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the `sage-make_relative` opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a parallel Sage build fails.
+There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the `sage-make_relative` Python script opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a Sage build fails.
 
 Example from `install.log` of a failed parallel build:
 
``````




---

archive/issue_comments_201516.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#13397, #13452\"",
    "created_at": "2012-09-14T09:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201516",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#13397, #13452"



---

archive/issue_comments_201517.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,6 +20,8 @@\n Error compiling lapack.\n ```\n \n-The most obvious solution is to fix `sage-make_relative` to first open the file only for reading and then reopen it for writing only if needed.\n+The best solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.  It also means we need a mechanism to force a `sage-location` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file\n \n-However, I think a better solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.\n+```\n+$SAGE_LOCAL/lib/sage-force-relocate.txt\n+```\n``````\n",
    "created_at": "2012-09-14T09:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201517",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,6 +20,8 @@
 Error compiling lapack.
 ```
 
-The most obvious solution is to fix `sage-make_relative` to first open the file only for reading and then reopen it for writing only if needed.
+The best solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.  It also means we need a mechanism to force a `sage-location` run even when the installation tree hasn't moved.  For this, I propose to use the existence of the file
 
-However, I think a better solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.
+```
+$SAGE_LOCAL/lib/sage-force-relocate.txt
+```
``````




---

archive/issue_comments_201518.json:
```json
{
    "body": "Attachment [13407_make_relative.patch](tarball://root/attachments/some-uuid/ticket13407/13407_make_relative.patch) by @jdemeyer created at 2012-09-14 12:00:22",
    "created_at": "2012-09-14T12:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201518",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13407_make_relative.patch](tarball://root/attachments/some-uuid/ticket13407/13407_make_relative.patch) by @jdemeyer created at 2012-09-14 12:00:22



---

archive/issue_comments_201519.json:
```json
{
    "body": "<a id='comment:3'></a>\nAttachment [13407_spkg.patch](tarball://root/attachments/some-uuid/ticket13407/13407_spkg.patch) by @jdemeyer created at 2012-09-14 12:02:05",
    "created_at": "2012-09-14T12:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201519",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Attachment [13407_spkg.patch](tarball://root/attachments/some-uuid/ticket13407/13407_spkg.patch) by @jdemeyer created at 2012-09-14 12:02:05



---

archive/issue_comments_201520.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,3 +25,7 @@\n ```\n $SAGE_LOCAL/lib/sage-force-relocate.txt\n ```\n+\n+Apply:\n+1. [attachment:13407_make_relative.patch] to the scripts repository.\n+2. [attachment:13407_spkg.patch] to the `SAGE_ROOT` repository.\n``````\n",
    "created_at": "2012-09-14T12:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201520",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,3 +25,7 @@
 ```
 $SAGE_LOCAL/lib/sage-force-relocate.txt
 ```
+
+Apply:
+1. [attachment:13407_make_relative.patch] to the scripts repository.
+2. [attachment:13407_spkg.patch] to the `SAGE_ROOT` repository.
``````




---

archive/issue_comments_201521.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2012-09-16T17:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201521",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_201522.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-09-16T17:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201522",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_201523.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-11-12T15:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201523",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_201524.json:
```json
{
    "body": "<a id='comment:5'></a>\nall seems to make sense, and it does work.",
    "created_at": "2012-11-12T15:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201524",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
all seems to make sense, and it does work.



---

archive/issue_comments_201525.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dmitrii Pasechnik\"",
    "created_at": "2012-11-12T16:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201525",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Dmitrii Pasechnik"



---

archive/issue_events_037218.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-12T16:37:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "milestone": "sage-5.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13407#event-37218"
}
```



---

archive/issue_comments_201526.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.4.1.rc1\"",
    "created_at": "2012-11-14T08:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201526",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.4.1.rc1"



---

archive/issue_comments_201527.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-14T08:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13407#issuecomment-201527",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_037219.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-14T08:30:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13407",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13407#event-37219"
}
```
