# Issue 13537: Proper deallocation of the (unique) pari instance

archive/issues_013537.json:
```json
{
    "body": "Assignee: @rlmill\n\nCC:  jpflori @zimmermann6 @vbraun @robertwb @nbruin @malb @orlitzky\n\nKeywords: pari deallocation\n\nCurrently, the unique instance of Pari is deallocated *manually* when Sage executes sage.all.quit_sage.\n\nI think that's unsafe. In fact, it led to problems at #12215. My suggestion is to deallocate the unique Pari instance in the default Cython way: With a `__dealloc__` method.\n\nHence, I am moving a part of the second patch of #12215 to here. I believe this is cleaner than packing a bunch of unrelated changes into one ticket.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13741\n\n",
    "closed_at": "2012-12-16T13:58:18Z",
    "created_at": "2012-11-22T10:34:22Z",
    "labels": [
        "component: memleak",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.5",
    "title": "Proper deallocation of the (unique) pari instance",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13537",
    "user": "https://github.com/simon-king-jena"
}
```
Assignee: @rlmill

CC:  jpflori @zimmermann6 @vbraun @robertwb @nbruin @malb @orlitzky

Keywords: pari deallocation

Currently, the unique instance of Pari is deallocated *manually* when Sage executes sage.all.quit_sage.

I think that's unsafe. In fact, it led to problems at #12215. My suggestion is to deallocate the unique Pari instance in the default Cython way: With a `__dealloc__` method.

Hence, I am moving a part of the second patch of #12215 to here. I believe this is cleaner than packing a bunch of unrelated changes into one ticket.

Issue created by migration from https://trac.sagemath.org/ticket/13741





---

archive/issue_comments_167100.json:
```json
{
    "body": "I don't know how to make a proper doctest. One could (just for testing) create a second pari instance - and the fact that there is no crash would then constitute the test...\n\nWhat do you think?",
    "created_at": "2012-11-22T10:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167100",
    "user": "https://github.com/simon-king-jena"
}
```

I don't know how to make a proper doctest. One could (just for testing) create a second pari instance - and the fact that there is no crash would then constitute the test...

What do you think?



---

archive/issue_comments_167101.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-11-22T10:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167101",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_167102.json:
```json
{
    "body": "Replying to [comment:1 SimonKing]:\n> I don't know how to make a proper doctest. One could (just for testing) create a second pari instance - and the fact that there is no crash would then constitute the test...\n> \n> What do you think?\n\nThat might be a good idea.\n\nI'll have a look at the libpari interface code and see if that looks feasible.",
    "created_at": "2012-11-22T17:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167102",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:1 SimonKing]:
> I don't know how to make a proper doctest. One could (just for testing) create a second pari instance - and the fact that there is no crash would then constitute the test...
> 
> What do you think?

That might be a good idea.

I'll have a look at the libpari interface code and see if that looks feasible.



---

archive/issue_events_038488.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-23T13:29:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13537#event-38488"
}
```



---

archive/issue_comments_167103.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2012-11-23T13:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167103",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_167104.json:
```json
{
    "body": "I don't think allocating a second instance is possible at all because of C stuff in PARI which would get overwritten (e.g. calling pari_init twice in a row would not be that nice).\n\nWe could hope to be able to properly shutdown the PARI instance and reinstantiating it, but that looks non-trivial.\nE.g. some gen elements are defined in gen.pyx at the top level and point to the unique PARI.\nSo we should first list all of them, delete them properly, then reinstantiate PARI.\nFortunately for us, in a normal use, this is done automatically by Python upon exit (and thanks to your patch the unique PARI instance lives long enough).",
    "created_at": "2012-11-30T10:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167104",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I don't think allocating a second instance is possible at all because of C stuff in PARI which would get overwritten (e.g. calling pari_init twice in a row would not be that nice).

We could hope to be able to properly shutdown the PARI instance and reinstantiating it, but that looks non-trivial.
E.g. some gen elements are defined in gen.pyx at the top level and point to the unique PARI.
So we should first list all of them, delete them properly, then reinstantiate PARI.
Fortunately for us, in a normal use, this is done automatically by Python upon exit (and thanks to your patch the unique PARI instance lives long enough).



---

archive/issue_comments_167105.json:
```json
{
    "body": "So, Jean-Pierre, you suggest that the fact that Sage does not crash when exiting is good enough for a test? Shall I add a docstring to the dealloc method saying exactly this?",
    "created_at": "2012-11-30T12:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167105",
    "user": "https://github.com/simon-king-jena"
}
```

So, Jean-Pierre, you suggest that the fact that Sage does not crash when exiting is good enough for a test? Shall I add a docstring to the dealloc method saying exactly this?



---

archive/issue_comments_167106.json:
```json
{
    "body": "I think so.\n\nThe only other \"proper\" solution I see is to gather all allocation made at the top level of gen.pyx into a global function or a member function of PariInstance, and call this function from the top level after the PariInstance is initialized.\n(This part part might be optional, we could just list them for deallocation below).\nThen define a counter part to this function which would deallocate these objects.\nAnd for our test we would first call this last function, then del the pari unique instance, then reinit it (provided the PARI lib really supports that, but that seems plausible).\nBut that would only work if no things outside of gen.pyx directly use the unique pari instance (or at least no other things that would get initialized by the doctest framework), as far as I know and flint is concerned, there are several places in Sage code where the FLINT memory is accessed making an approach as suggested above impossible in the case of FLINT, maybe not in a doctesting context, but for general use of Sage.\n\nAll that said, deallocation of gen's does not involve the Pari instance they were created with, and the memory they use does not belong to PARI (i.e. PARI will not try to deallocate this memory when quitting, what FLINT would do following my above remarks), but the fact that at the python level they have a reference to this instance would make calling \"del\" on the unique Pari instance useless unless we proceed as above and first delete all these global gen's automatically created when importing gen.pyx.",
    "created_at": "2012-11-30T12:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167106",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think so.

The only other "proper" solution I see is to gather all allocation made at the top level of gen.pyx into a global function or a member function of PariInstance, and call this function from the top level after the PariInstance is initialized.
(This part part might be optional, we could just list them for deallocation below).
Then define a counter part to this function which would deallocate these objects.
And for our test we would first call this last function, then del the pari unique instance, then reinit it (provided the PARI lib really supports that, but that seems plausible).
But that would only work if no things outside of gen.pyx directly use the unique pari instance (or at least no other things that would get initialized by the doctest framework), as far as I know and flint is concerned, there are several places in Sage code where the FLINT memory is accessed making an approach as suggested above impossible in the case of FLINT, maybe not in a doctesting context, but for general use of Sage.

All that said, deallocation of gen's does not involve the Pari instance they were created with, and the memory they use does not belong to PARI (i.e. PARI will not try to deallocate this memory when quitting, what FLINT would do following my above remarks), but the fact that at the python level they have a reference to this instance would make calling "del" on the unique Pari instance useless unless we proceed as above and first delete all these global gen's automatically created when importing gen.pyx.



---

archive/issue_comments_167107.json:
```json
{
    "body": "Attachment [trac13741_pari_dealloc.patch](tarball://root/attachments/some-uuid/ticket13741/trac13741_pari_dealloc.patch) by @simon-king-jena created at 2012-11-30 15:09:03\n\nPari deallocation in a more Cythonic way",
    "created_at": "2012-11-30T15:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167107",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac13741_pari_dealloc.patch](tarball://root/attachments/some-uuid/ticket13741/trac13741_pari_dealloc.patch) by @simon-king-jena created at 2012-11-30 15:09:03

Pari deallocation in a more Cythonic way



---

archive/issue_comments_167108.json:
```json
{
    "body": "I did not add a test, for the reasons we discussed, but I added a comment in the docstring of `__dealloc__`. Needs review.",
    "created_at": "2012-11-30T15:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167108",
    "user": "https://github.com/simon-king-jena"
}
```

I did not add a test, for the reasons we discussed, but I added a comment in the docstring of `__dealloc__`. Needs review.



---

archive/issue_comments_167109.json:
```json
{
    "body": "Could you just remove the ending newline and use a ..NOTE:: contruction?\n\nI'm not really sure the shared C-data is really what should be said.\nI'd rather say something like\n\"Crafting a direct doctest for this method would entail properly deallocating all Sage objects indirectly pointing to the PARI library and all C data instantiated at PARI library initialization to be sure that a new initialization of the PARI library does not create conflicts.\nThe first step is exactly what Python garbage collector will do when exiting Sage and can be highly non-trivial.\nThe second one is exactly what the __dealloc__ method should do.\nIf one of these steps is not performed carefully, then it can lead to crashes when Sage exits.\nTherefore, a direct doctest does not provide more evidence on the fact that the unique PARI instance is properly deallocated, than the fact that Sage does not crash when exiting and we rely on this indirect doctest.\"\n\nWhat do you think?",
    "created_at": "2012-12-04T20:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167109",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Could you just remove the ending newline and use a ..NOTE:: contruction?

I'm not really sure the shared C-data is really what should be said.
I'd rather say something like
"Crafting a direct doctest for this method would entail properly deallocating all Sage objects indirectly pointing to the PARI library and all C data instantiated at PARI library initialization to be sure that a new initialization of the PARI library does not create conflicts.
The first step is exactly what Python garbage collector will do when exiting Sage and can be highly non-trivial.
The second one is exactly what the __dealloc__ method should do.
If one of these steps is not performed carefully, then it can lead to crashes when Sage exits.
Therefore, a direct doctest does not provide more evidence on the fact that the unique PARI instance is properly deallocated, than the fact that Sage does not crash when exiting and we rely on this indirect doctest."

What do you think?



---

archive/issue_comments_167110.json:
```json
{
    "body": "Is this ticket actually up for review? Are we just bikeshedding the hypothetical layout of the docstring if underscore methods would actually appear in the reference manual?",
    "created_at": "2012-12-12T17:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167110",
    "user": "https://github.com/vbraun"
}
```

Is this ticket actually up for review? Are we just bikeshedding the hypothetical layout of the docstring if underscore methods would actually appear in the reference manual?



---

archive/issue_comments_167111.json:
```json
{
    "body": "Replying to [comment:9 vbraun]:\n> Is this ticket actually up for review? Are we just bikeshedding the hypothetical layout of the docstring if underscore methods would actually appear in the reference manual?\nExactly... although this docstring will be useful for future development and let people know what really happens under the rug.\n\nBut feel free to pick either Simon docstring or mine, or mix'em up as you prefer and we can get this in.\nNow Jeroen seems to be back this issue looks indeed less important than releasing Sage 5.5.",
    "created_at": "2012-12-12T22:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167111",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:9 vbraun]:
> Is this ticket actually up for review? Are we just bikeshedding the hypothetical layout of the docstring if underscore methods would actually appear in the reference manual?
Exactly... although this docstring will be useful for future development and let people know what really happens under the rug.

But feel free to pick either Simon docstring or mine, or mix'em up as you prefer and we can get this in.
Now Jeroen seems to be back this issue looks indeed less important than releasing Sage 5.5.



---

archive/issue_comments_167112.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-12-13T14:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167112",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_167113.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-12-16T13:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167113",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_038489.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-16T13:58:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13537#event-38489"
}
```



---

archive/issue_comments_167114.json:
```json
{
    "body": "Follow-up: #18385\n\n(Since the PARI instance is a [module-]global variable, its `__dealloc__()` never gets called.  This doesn't really hurt, except that Valgrind complains about even more memory leaks.)",
    "created_at": "2015-05-09T08:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13537#issuecomment-167114",
    "user": "https://github.com/nexttime"
}
```

Follow-up: #18385

(Since the PARI instance is a [module-]global variable, its `__dealloc__()` never gets called.  This doesn't really hurt, except that Valgrind complains about even more memory leaks.)
