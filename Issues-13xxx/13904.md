# Issue 13904: Better deletion of items of TripleDict

archive/issues_013700.json:
```json
{
    "assignees": [
        "https://github.com/rlmill"
    ],
    "body": "In #715, `TripleDict` has been modified, so that the key items are compared by identity rather than equality, and so that weak keys are used when possible.\n\nHowever, as it turns out, the deletion of the items tracked in a `TripleDict` was done improperly. The aim of this ticket is to fix that.\n\nSuperseded by #13387.\n\nDepends on #13896\nDepends on #12313\n\nCC:  @nbruin @vbraun @jpflori\n\nReviewer: **Simon King, Jean-Pierre Flori**\n\nComponent: **memleak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13904_\n\n",
    "closed_at": "2013-02-28T10:59:30Z",
    "created_at": "2013-01-03T18:16:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/duplicate",
        "https://github.com/sagemath/sage/labels/memleak"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Better deletion of items of TripleDict",
    "type": "issue",
    "updated_at": "2013-02-28T10:59:30Z",
    "url": "https://github.com/sagemath/sage/issues/13904",
    "user": "https://github.com/simon-king-jena"
}
```
In #715, `TripleDict` has been modified, so that the key items are compared by identity rather than equality, and so that weak keys are used when possible.

However, as it turns out, the deletion of the items tracked in a `TripleDict` was done improperly. The aim of this ticket is to fix that.

Superseded by #13387.

Depends on #13896
Depends on #12313

CC:  @nbruin @vbraun @jpflori

Reviewer: **Simon King, Jean-Pierre Flori**

Component: **memleak**

_Issue created by migration from https://trac.sagemath.org/ticket/13904_





---

archive/issue_events_195233.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-03T18:16:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195233"
}
```



---

archive/issue_events_195234.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-03T18:16:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "696969",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195234"
}
```



---

archive/issue_events_195235.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-03T18:16:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195235"
}
```



---

archive/issue_events_195236.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-03T18:16:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195236"
}
```



---

archive/issue_events_195237.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2013-01-03T18:16:33Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "subject": "https://github.com/simon-king-jena",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195237"
}
```



---

archive/issue_comments_164443.json:
```json
{
    "body": "Attachment: **[trac_13904_fix_del.patch.gz](https://github.com/sagemath/sage/files/ticket13904/trac_13904_fix_del.patch.gz)**\n\nAttempt to fix `TripleDict.__delitem__`",
    "created_at": "2013-01-03T18:25:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164443",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac_13904_fix_del.patch.gz](https://github.com/sagemath/sage/files/ticket13904/trac_13904_fix_del.patch.gz)**

Attempt to fix `TripleDict.__delitem__`



---

archive/issue_comments_164444.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThere's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.\n\nThe following might be a solution:\n- equip TripleDict with an attribute `self.deathrow=[]`.\n- when TripleDictEraser finds itself removing a non-weakreffed key (other than None, int, float, etc), it appends the key to `self.deathrow` instead.\nThis way, we don't trigger the deletion (and the whole cascade that may follow) in the callback.\n\nDeathrow will be cleaned up eventually, as part of the regular cleanup code for deallocation of TripleDict.\n\nThe problem is that weakref callback operates in a strange environment: There is a dealloc call higher up the stack somewhere. Normally python code doesn't run under those circumstances. It shouldn't make much difference, but you should *absolutely not* delete that object again. Hence, I think the default should be: Don't delete objects in callback. You can modify this rule, but only on a case-by-case basis, by carefully reasoning that the deletions that you do allow won't lead to nasty unpredictable deletion cascades.",
    "created_at": "2013-01-03T18:39:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164444",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.

The following might be a solution:
- equip TripleDict with an attribute `self.deathrow=[]`.
- when TripleDictEraser finds itself removing a non-weakreffed key (other than None, int, float, etc), it appends the key to `self.deathrow` instead.
This way, we don't trigger the deletion (and the whole cascade that may follow) in the callback.

Deathrow will be cleaned up eventually, as part of the regular cleanup code for deallocation of TripleDict.

The problem is that weakref callback operates in a strange environment: There is a dealloc call higher up the stack somewhere. Normally python code doesn't run under those circumstances. It shouldn't make much difference, but you should *absolutely not* delete that object again. Hence, I think the default should be: Don't delete objects in callback. You can modify this rule, but only on a case-by-case basis, by carefully reasoning that the deletions that you do allow won't lead to nasty unpredictable deletion cascades.



---

archive/issue_comments_164445.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI don't think we need this ticket for the `__delitem__` optimization. That can be wrapped into #13387.",
    "created_at": "2013-01-03T18:41:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164445",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2" align="right">comment:2</div>

I don't think we need this ticket for the `__delitem__` optimization. That can be wrapped into #13387.



---

archive/issue_comments_164446.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nNils, indeed it might be an idea to use the ideas from #13387. However, the ticket here is not about optimization.\n\nAnyway.\n\nI am starting with Sage's debug version as in #13864. With the first patch applied, one gets a crash in modules/module.pyx\n\nWith both patches applied, one gets\n\n```\nsage -t  \"devel/sage-main/sage/modules/module.pyx\"          \n         [3.5 s]\n```\nSo, that looks like a progress.\n\nHowever, at least with a slightly different version of the first patch, make ptest still results in\n\n```\n        sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_point.py # Killed/crashed\n        sage -t  -force_lib devel/sage/sage/algebras/free_algebra_quotient.py # Killed/crashed\n        sage -t  -force_lib devel/sage/sage/algebras/free_algebra_quotient_element.py # Killed/crashed\n        sage -t  -force_lib devel/sage/sage/categories/modules_with_basis.py # Killed/crashed\n        sage -t  -force_lib devel/sage/sage/categories/homset.py # 1 doctests failed\n```\nwhen both patches are applied. Note, however, that I can *not* reproduce these crashes when I run them independently.\n\nHence, one needs to dig deeper. See [comment:1](#comment:1).",
    "created_at": "2013-01-03T18:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164446",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Nils, indeed it might be an idea to use the ideas from #13387. However, the ticket here is not about optimization.

Anyway.

I am starting with Sage's debug version as in #13864. With the first patch applied, one gets a crash in modules/module.pyx

With both patches applied, one gets

```
sage -t  "devel/sage-main/sage/modules/module.pyx"          
         [3.5 s]
```
So, that looks like a progress.

However, at least with a slightly different version of the first patch, make ptest still results in

```
        sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_point.py # Killed/crashed
        sage -t  -force_lib devel/sage/sage/algebras/free_algebra_quotient.py # Killed/crashed
        sage -t  -force_lib devel/sage/sage/algebras/free_algebra_quotient_element.py # Killed/crashed
        sage -t  -force_lib devel/sage/sage/categories/modules_with_basis.py # Killed/crashed
        sage -t  -force_lib devel/sage/sage/categories/homset.py # 1 doctests failed
```
when both patches are applied. Note, however, that I can *not* reproduce these crashes when I run them independently.

Hence, one needs to dig deeper. See [comment:1](#comment:1).



---

archive/issue_comments_164447.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nbruin](#comment:1):\n> There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.\n\nAh, you say that the problem actually isn't so much the `__delitem__` but the callback? OK, I'll have a look into that. And of course we should try to rebase #13387.",
    "created_at": "2013-01-03T18:49:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164447",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nbruin](#comment:1):
> There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.

Ah, you say that the problem actually isn't so much the `__delitem__` but the callback? OK, I'll have a look into that. And of course we should try to rebase #13387.



---

archive/issue_comments_164448.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOops, I just notice that the patch attempts to fix `TripleDictEraser.__call__`, hence, the callback, but not `TripleDict.__delitem__`. So, I *did* have a look into the callback function...",
    "created_at": "2013-01-03T18:57:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164448",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

Oops, I just notice that the patch attempts to fix `TripleDictEraser.__call__`, hence, the callback, but not `TripleDict.__delitem__`. So, I *did* have a look into the callback function...



---

archive/issue_comments_164449.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@simon-king-jena](#comment:4):\n> Ah, you say that the problem actually isn't so much the `__delitem__` but the callback? OK, I'll have a look into that. And of course we should try to rebase #13387.\n\nThe `__delitem__` isn't *wrong*. It just happens to be slightly more memory intensive that the straight `del`, so it happened to trigger a GC. The crash was due to Cython not handling GC during deallocation properly. That's getting fixed with #13896. The potential issue I described above hasn't been observed. I suspect that one could engineer an example. Perhaps one should (Robert's cython test case for #13896 can serve as a template). It's just that memory management is such a sensitive business that one should really (informally) prove bad scenarios can't happen rather than wait until they do. I think the scenario I describe can happen and I don't see what measures in the python code would prevent it.\n\nOne way to solve this would be to forbid non-weakreffable container types to be used as keys. The problem is that I can't think of a reliable test for that. Since the consequences of violating might lead to incredibly insidious memory corruptions, I think we should guard against it. A consequence is that any non-weakreffable (non-whitelisted such as None or int) key automatically has its life span bounded below by the lifetime of the `TripleDict`, even if the entry in which it served got removed due to a weakref dying (explicit key deletions would be fine). I don't see how we could get hold of a hook where clearing `deathrow` would be safe.",
    "created_at": "2013-01-03T19:42:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164449",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@simon-king-jena](#comment:4):
> Ah, you say that the problem actually isn't so much the `__delitem__` but the callback? OK, I'll have a look into that. And of course we should try to rebase #13387.

The `__delitem__` isn't *wrong*. It just happens to be slightly more memory intensive that the straight `del`, so it happened to trigger a GC. The crash was due to Cython not handling GC during deallocation properly. That's getting fixed with #13896. The potential issue I described above hasn't been observed. I suspect that one could engineer an example. Perhaps one should (Robert's cython test case for #13896 can serve as a template). It's just that memory management is such a sensitive business that one should really (informally) prove bad scenarios can't happen rather than wait until they do. I think the scenario I describe can happen and I don't see what measures in the python code would prevent it.

One way to solve this would be to forbid non-weakreffable container types to be used as keys. The problem is that I can't think of a reliable test for that. Since the consequences of violating might lead to incredibly insidious memory corruptions, I think we should guard against it. A consequence is that any non-weakreffable (non-whitelisted such as None or int) key automatically has its life span bounded below by the lifetime of the `TripleDict`, even if the entry in which it served got removed due to a weakref dying (explicit key deletions would be fine). I don't see how we could get hold of a hook where clearing `deathrow` would be safe.



---

archive/issue_comments_164450.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@nbruin](#comment:1):\n> There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.\n\nIs what you describe as follows?\n\nLet's say we have a key `(A,B,C)`, where `A` is weakrefed and got deleted, so that the key `(A,B,C)` gets removed by means of `A`'s callback function. Now let `B` be non-weakrefable. Assume further that the key triple is the last reference to B, and assume that `B` has an attribute that constitutes a (strong? weak?) reference to `A`. Then, deletion of `B` would trigger a second deletion of `A`.\n\nOr did I misunderstand? Can you elaborate a bit more, please?",
    "created_at": "2013-01-03T19:53:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164450",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@nbruin](#comment:1):
> There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.

Is what you describe as follows?

Let's say we have a key `(A,B,C)`, where `A` is weakrefed and got deleted, so that the key `(A,B,C)` gets removed by means of `A`'s callback function. Now let `B` be non-weakrefable. Assume further that the key triple is the last reference to B, and assume that `B` has an attribute that constitutes a (strong? weak?) reference to `A`. Then, deletion of `B` would trigger a second deletion of `A`.

Or did I misunderstand? Can you elaborate a bit more, please?



---

archive/issue_comments_164451.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@simon-king-jena](#comment:7):\n> Let's say we have a key `(A,B,C)`, where `A` is weakrefed and got deleted, so that the key `(A,B,C)` gets removed by means of `A`'s callback function. Now let `B` be non-weakrefable. Assume further that the key triple is the last reference to B, and assume that `B` has an attribute that constitutes a (strong? weak?) reference to `A`. Then, deletion of `B` would trigger a second deletion of `A`.\n\nYes, that's correct. It would have to be a strong reference from B to A, because deletion of weakrefs should not trigger deletion cascades. Of course, that means the reference count to A isn't 0, so normally A would not be eligible for deletion ... but if A and B are found to be cyclic garbage, deallocation could still occur. We'd be at the mercy of GC for how the chain gets broken up and deleted.\n\nIn fact, moving B to `deathrow` could be tricky, because that would resurrect `B` (generally frowned upon), albeit only within the cyclic garbage. OK, I'll try and see if I can make a testcase that triggers this behaviour. At this point I don't even know how to fix this. Perhaps we should just forbid non-weakreffable keys that refer to another key component. Mind you, that forbids\n\n```\n(None, ZZ, ZZ(1) )\n```\nas a key, which doesn't immediately look completely unlikely. We don't generate keys like that, but someone else might ...",
    "created_at": "2013-01-03T20:06:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164451",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@simon-king-jena](#comment:7):
> Let's say we have a key `(A,B,C)`, where `A` is weakrefed and got deleted, so that the key `(A,B,C)` gets removed by means of `A`'s callback function. Now let `B` be non-weakrefable. Assume further that the key triple is the last reference to B, and assume that `B` has an attribute that constitutes a (strong? weak?) reference to `A`. Then, deletion of `B` would trigger a second deletion of `A`.

Yes, that's correct. It would have to be a strong reference from B to A, because deletion of weakrefs should not trigger deletion cascades. Of course, that means the reference count to A isn't 0, so normally A would not be eligible for deletion ... but if A and B are found to be cyclic garbage, deallocation could still occur. We'd be at the mercy of GC for how the chain gets broken up and deleted.

In fact, moving B to `deathrow` could be tricky, because that would resurrect `B` (generally frowned upon), albeit only within the cyclic garbage. OK, I'll try and see if I can make a testcase that triggers this behaviour. At this point I don't even know how to fix this. Perhaps we should just forbid non-weakreffable keys that refer to another key component. Mind you, that forbids

```
(None, ZZ, ZZ(1) )
```
as a key, which doesn't immediately look completely unlikely. We don't generate keys like that, but someone else might ...



---

archive/issue_comments_164452.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@nbruin](#comment:1):\n> There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.\n\nPS: Why can this only happen with a non-weakreffable key? In particular, what are the keys in our crashing example? Namely, in its current use, I don't think that there are any non-weakreffable keys other than None and ints.\n\n> The following might be a solution:\n> - equip TripleDict with an attribute `self.deathrow=[]`.\n> - when TripleDictEraser finds itself removing a non-weakreffed key (other than None, int, float, etc), it appends the key to `self.deathrow` instead.\n> This way, we don't trigger the deletion (and the whole cascade that may follow) in the callback.\n> \n> Deathrow will be cleaned up eventually, as part of the regular cleanup code for deallocation of TripleDict.\n> \n> The problem is that weakref callback operates in a strange environment: There is a dealloc call higher up the stack somewhere. Normally python code doesn't run under those circumstances. It shouldn't make much difference, but you should *absolutely not* delete that object again. Hence, I think the default should be: Don't delete objects in callback.\n\nOne could provide a new method `TripleDict.kill_deathrow`, that will be called in any other method of `TripleDict`. Hence, the deletions would occur when the `TripleDict` will be used another time, and in particular this will only happen *after* the \"dealloc call higher up the stack\" has been completed.\n\nPerhaps `kill_deathrow` could also be called at the beginning of the callback function - so that it performs the deletions that were scheduled by the preceding callback function.\n\nProblem could be a severe slow-down.",
    "created_at": "2013-01-03T20:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164452",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@nbruin](#comment:1):
> There's the more severe problem that during GC cleanup, a weakref callback could lead to the deletion of a non-weakreffable key, which could retrigger the dealloc of the object that has just generated the weakref. That would lead to a double dealloc.

PS: Why can this only happen with a non-weakreffable key? In particular, what are the keys in our crashing example? Namely, in its current use, I don't think that there are any non-weakreffable keys other than None and ints.

> The following might be a solution:
> - equip TripleDict with an attribute `self.deathrow=[]`.
> - when TripleDictEraser finds itself removing a non-weakreffed key (other than None, int, float, etc), it appends the key to `self.deathrow` instead.
> This way, we don't trigger the deletion (and the whole cascade that may follow) in the callback.
> 
> Deathrow will be cleaned up eventually, as part of the regular cleanup code for deallocation of TripleDict.
> 
> The problem is that weakref callback operates in a strange environment: There is a dealloc call higher up the stack somewhere. Normally python code doesn't run under those circumstances. It shouldn't make much difference, but you should *absolutely not* delete that object again. Hence, I think the default should be: Don't delete objects in callback.

One could provide a new method `TripleDict.kill_deathrow`, that will be called in any other method of `TripleDict`. Hence, the deletions would occur when the `TripleDict` will be used another time, and in particular this will only happen *after* the "dealloc call higher up the stack" has been completed.

Perhaps `kill_deathrow` could also be called at the beginning of the callback function - so that it performs the deletions that were scheduled by the preceding callback function.

Problem could be a severe slow-down.



---

archive/issue_comments_164453.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@simon-king-jena](#comment:9):\n> PS: Why can this only happen with a non-weakreffable key? In particular, what are the keys in our crashing example? Namely, in its current use, I don't think that there are any non-weakreffable keys other than None and ints.\n\nThe cython-induced crash has only weakreffable keys. The hypothetical behaviour *has not been observed*.\n\n> One could provide a new method `TripleDict.kill_deathrow`, that will be called in any other method of `TripleDict`. Hence, the deletions would occur when the `TripleDict` will be used another time, and in particular this will only happen *after* the \"dealloc call higher up the stack\" has been completed.\n\nBut arbitrary code can be executed during weakref callbacks, including arbitrary `TripleDict` operations. So you'd never be sure if it's safe to kill `deathrow`. \n\nReally, this is starting to look more like a design deficiency in CPython: it should really mark objects on which dealloc is running to prevent GC, decref, whatever, from reentering dealloc. Preventing this by code protocol just seems to unduly restrict allowed data structures.\n\n> Perhaps `kill_deathrow` could also be called at the beginning of the callback function - so that it performs the deletions that were scheduled by the preceding callback function.\n\nYou wouldn't be sure that deathrow entries are now safe to delete ...\n\n**EXECUTIVE DECISION:** we mandate that key components to `TripleDict` be either weakreffable or do not hold references to other objects (i.e., are non container-types). Perhaps we can relax this rule once we come up with a smart mechanism.",
    "created_at": "2013-01-03T20:42:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164453",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@simon-king-jena](#comment:9):
> PS: Why can this only happen with a non-weakreffable key? In particular, what are the keys in our crashing example? Namely, in its current use, I don't think that there are any non-weakreffable keys other than None and ints.

The cython-induced crash has only weakreffable keys. The hypothetical behaviour *has not been observed*.

> One could provide a new method `TripleDict.kill_deathrow`, that will be called in any other method of `TripleDict`. Hence, the deletions would occur when the `TripleDict` will be used another time, and in particular this will only happen *after* the "dealloc call higher up the stack" has been completed.

But arbitrary code can be executed during weakref callbacks, including arbitrary `TripleDict` operations. So you'd never be sure if it's safe to kill `deathrow`. 

Really, this is starting to look more like a design deficiency in CPython: it should really mark objects on which dealloc is running to prevent GC, decref, whatever, from reentering dealloc. Preventing this by code protocol just seems to unduly restrict allowed data structures.

> Perhaps `kill_deathrow` could also be called at the beginning of the callback function - so that it performs the deletions that were scheduled by the preceding callback function.

You wouldn't be sure that deathrow entries are now safe to delete ...

**EXECUTIVE DECISION:** we mandate that key components to `TripleDict` be either weakreffable or do not hold references to other objects (i.e., are non container-types). Perhaps we can relax this rule once we come up with a smart mechanism.



---

archive/issue_comments_164454.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@nbruin](#comment:10):\n> Replying to [@simon-king-jena](#comment:9):\n> > PS: Why can this only happen with a non-weakreffable key? In particular, what are the keys in our crashing example? Namely, in its current use, I don't think that there are any non-weakreffable keys other than None and ints.\n\n> \n> The cython-induced crash has only weakreffable keys...\n\n... and is an upstream bug in Cython?\n\n\n> > One could provide a new method `TripleDict.kill_deathrow`, that will be called in any other method of `TripleDict`. Hence, the deletions would occur when the `TripleDict` will be used another time, and in particular this will only happen *after* the \"dealloc call higher up the stack\" has been completed.\n\n> \n> But arbitrary code can be executed during weakref callbacks, including arbitrary `TripleDict` operations. So you'd never be sure if it's safe to kill `deathrow`.\n\nNot quite, because we Know exactly what is happening in our weakref callbacks (namely: In the `__call__` method of `TripleDictEraser`). The callback function will not call any method of `TripleDict`.\n\n> > Perhaps `kill_deathrow` could also be called at the beginning of the callback function - so that it performs the deletions that were scheduled by the preceding callback function.\n\n> \n> You wouldn't be sure that deathrow entries are now safe to delete ...\n\nAgreed.\n\n> **EXECUTIVE DECISION:** we mandate that key components to `TripleDict` be either weakreffable or do not hold references to other objects (i.e., are non container-types). Perhaps we can relax this rule once we come up with a smart mechanism.\n\nI guess this would be the easiest solution on the short run. Do you think of a whitelist, i.e., explicitly allowing `NoneType`, `int`, `long` and so on?",
    "created_at": "2013-01-03T20:51:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164454",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@nbruin](#comment:10):
> Replying to [@simon-king-jena](#comment:9):
> > PS: Why can this only happen with a non-weakreffable key? In particular, what are the keys in our crashing example? Namely, in its current use, I don't think that there are any non-weakreffable keys other than None and ints.

> 
> The cython-induced crash has only weakreffable keys...

... and is an upstream bug in Cython?


> > One could provide a new method `TripleDict.kill_deathrow`, that will be called in any other method of `TripleDict`. Hence, the deletions would occur when the `TripleDict` will be used another time, and in particular this will only happen *after* the "dealloc call higher up the stack" has been completed.

> 
> But arbitrary code can be executed during weakref callbacks, including arbitrary `TripleDict` operations. So you'd never be sure if it's safe to kill `deathrow`.

Not quite, because we Know exactly what is happening in our weakref callbacks (namely: In the `__call__` method of `TripleDictEraser`). The callback function will not call any method of `TripleDict`.

> > Perhaps `kill_deathrow` could also be called at the beginning of the callback function - so that it performs the deletions that were scheduled by the preceding callback function.

> 
> You wouldn't be sure that deathrow entries are now safe to delete ...

Agreed.

> **EXECUTIVE DECISION:** we mandate that key components to `TripleDict` be either weakreffable or do not hold references to other objects (i.e., are non container-types). Perhaps we can relax this rule once we come up with a smart mechanism.

I guess this would be the easiest solution on the short run. Do you think of a whitelist, i.e., explicitly allowing `NoneType`, `int`, `long` and so on?



---

archive/issue_comments_164455.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nBy the way, my first attachment is wrong anyway, because I mispelled `gc.isenabled()`.",
    "created_at": "2013-01-03T21:06:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164455",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

By the way, my first attachment is wrong anyway, because I mispelled `gc.isenabled()`.



---

archive/issue_comments_164456.json:
```json
{
    "body": "For debugging only. Increase the likelyhood that a gc occurs during a weakref callback",
    "created_at": "2013-01-03T21:07:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164456",
    "user": "https://github.com/simon-king-jena"
}
```

For debugging only. Increase the likelyhood that a gc occurs during a weakref callback



---

archive/issue_comments_164457.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAttachment: **[trac_13904_debug_only.patch.gz](https://github.com/sagemath/sage/files/ticket13904/trac_13904_debug_only.patch.gz)**\n\nThe \"debug_only\" patch is updated. With it, I tried the following:\n\n```\nsage: cython(\"\"\"\n....: cdef class A:\n....:     cdef object x\n....:     def __init__(self, x):\n....:         self.x = x\n....: \"\"\")\nsage: import gc\nsage: from sage.structure.coerce_dict import TripleDict\nsage: T = TripleDict(31)\nsage: while(1):\n....:     b = B()\n....:     a = A(b)\n....:     T[b,a,None] = a\n....:     del a,b\n....:     foo = gc.collect()\n....:     \n```\n\nThat should be exactly the theoretical situation you were describing, isn't it?\n\nBut there is no crash. When I interrupt it after a while, with Ctrl-C, I get\n\n```\nsage: len(T)\n1681\n```\nThis I don't understand. Is `TripleDict` broken, in the sense of it doesn't allow its weak keys be cleared??",
    "created_at": "2013-01-03T21:26:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164457",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

Attachment: **[trac_13904_debug_only.patch.gz](https://github.com/sagemath/sage/files/ticket13904/trac_13904_debug_only.patch.gz)**

The "debug_only" patch is updated. With it, I tried the following:

```
sage: cython("""
....: cdef class A:
....:     cdef object x
....:     def __init__(self, x):
....:         self.x = x
....: """)
sage: import gc
sage: from sage.structure.coerce_dict import TripleDict
sage: T = TripleDict(31)
sage: while(1):
....:     b = B()
....:     a = A(b)
....:     T[b,a,None] = a
....:     del a,b
....:     foo = gc.collect()
....:     
```

That should be exactly the theoretical situation you were describing, isn't it?

But there is no crash. When I interrupt it after a while, with Ctrl-C, I get

```
sage: len(T)
1681
```
This I don't understand. Is `TripleDict` broken, in the sense of it doesn't allow its weak keys be cleared??



---

archive/issue_comments_164458.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@simon-king-jena](#comment:13):\n> This I don't understand. Is `TripleDict` broken, in the sense of it doesn't allow its weak keys be cleared??\n\nWell, certainly the weak keys can be cleared. But apparently they can not be cleared, if there is a non-weakreffable item in the key that holds a reference to a weakreffable item in the key.\n\nHence, on the one hand, it seems that the situation you constructed is a non-issue, because the callback function for the weak reference will not be called.\n\nOn the other hand, it is yet another reason to not allow non-weakreffable containers as key.",
    "created_at": "2013-01-03T21:36:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164458",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@simon-king-jena](#comment:13):
> This I don't understand. Is `TripleDict` broken, in the sense of it doesn't allow its weak keys be cleared??

Well, certainly the weak keys can be cleared. But apparently they can not be cleared, if there is a non-weakreffable item in the key that holds a reference to a weakreffable item in the key.

Hence, on the one hand, it seems that the situation you constructed is a non-issue, because the callback function for the weak reference will not be called.

On the other hand, it is yet another reason to not allow non-weakreffable containers as key.



---

archive/issue_comments_164459.json:
```json
{
    "body": "Script that tries to cause a double dealloc but fails because python is mature",
    "created_at": "2013-01-03T21:41:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164459",
    "user": "https://github.com/nbruin"
}
```

Script that tries to cause a double dealloc but fails because python is mature



---

archive/issue_comments_164460.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAttachment: **[test.sage.gz](https://github.com/sagemath/sage/files/ticket13904/test.sage.gz)**\n\nHOORAY!\nAs [Modules/gc_weakref.txt](http://hg.python.org/cpython/file/4b42d7f288c5/Modules/gc_weakref.txt) shows, Zope has already put very good stresstests on python's clearing of weakrefs in cyclic garbage. I think we're safe with `TripleDict` as it is, because python takes special precautions when running weakref callbacks in cleaning up cyclic garbage. In our case the weakref itself is part of the cyclic garbage. That means Python always stacks the deck such that the weakref appears to be cleared prior to the deletion of what it references. Hence, the callback doesn't happen! I think we're safe with TripleDict as it is.",
    "created_at": "2013-01-03T21:47:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164460",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

Attachment: **[test.sage.gz](https://github.com/sagemath/sage/files/ticket13904/test.sage.gz)**

HOORAY!
As [Modules/gc_weakref.txt](http://hg.python.org/cpython/file/4b42d7f288c5/Modules/gc_weakref.txt) shows, Zope has already put very good stresstests on python's clearing of weakrefs in cyclic garbage. I think we're safe with `TripleDict` as it is, because python takes special precautions when running weakref callbacks in cleaning up cyclic garbage. In our case the weakref itself is part of the cyclic garbage. That means Python always stacks the deck such that the weakref appears to be cleared prior to the deletion of what it references. Hence, the callback doesn't happen! I think we're safe with TripleDict as it is.



---

archive/issue_comments_164461.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@simon-king-jena](#comment:13):\n\n> But there is no crash. When I interrupt it after a while, with Ctrl-C, I get\n> \n> ```\n> sage: len(T)\n> 1681\n> ```\n> This I don't understand. Is `TripleDict` broken, in the sense of it doesn't allow its weak keys be cleared??\n\nNo, nothing is broken. You haven't included the definition of `B`, but I assume it's a weakreffable type.\n\nAlthough you delete `a,b`, your dictionary `T` is still holding a strong reference to `a` (because it can't weakref it) and `a` is holding a strong reference to `b`, so `b` is reachable. Nothing gets collected.\n\nThings are collectible once you throw away `T` but thanks to the special handling of callbacks in cyclic garbage this is always handled properly.",
    "created_at": "2013-01-03T21:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164461",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@simon-king-jena](#comment:13):

> But there is no crash. When I interrupt it after a while, with Ctrl-C, I get
> 
> ```
> sage: len(T)
> 1681
> ```
> This I don't understand. Is `TripleDict` broken, in the sense of it doesn't allow its weak keys be cleared??

No, nothing is broken. You haven't included the definition of `B`, but I assume it's a weakreffable type.

Although you delete `a,b`, your dictionary `T` is still holding a strong reference to `a` (because it can't weakref it) and `a` is holding a strong reference to `b`, so `b` is reachable. Nothing gets collected.

Things are collectible once you throw away `T` but thanks to the special handling of callbacks in cyclic garbage this is always handled properly.



---

archive/issue_comments_164462.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@nbruin](#comment:15):\n> I think we're safe with `TripleDict` as it is.\n\nOK. But I wouldn't like to resolve this ticket as \"wontfix\" or \"duplicate\".\n\nStill, we should use \"del\", not \"`__delitem__`\", because it gives shorter C-code. And in addition to that, we should see whether the new Cython from #13896 fixes the problem.",
    "created_at": "2013-01-03T21:56:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164462",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@nbruin](#comment:15):
> I think we're safe with `TripleDict` as it is.

OK. But I wouldn't like to resolve this ticket as "wontfix" or "duplicate".

Still, we should use "del", not "`__delitem__`", because it gives shorter C-code. And in addition to that, we should see whether the new Cython from #13896 fixes the problem.



---

archive/issue_comments_164463.json:
```json
{
    "body": "Dependencies: **#13896**",
    "created_at": "2013-01-03T21:57:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164463",
    "user": "https://github.com/simon-king-jena"
}
```

Dependencies: **#13896**



---

archive/issue_comments_164464.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@simon-king-jena](#comment:17):\n\n> Still, we should use \"del\", not \"`__delitem__`\", because it gives shorter C-code. And in addition to that, we should see whether the new Cython from #13896 fixes the problem.\n\nYes, go ahead. Since there is no urgent issue anymore, use this ticket for whatever you want (and yes, that cython does solve the problem, if you compile the whole library with it. I'm now pretty confident I know exactly what went wrong, after seeing it happen on bit-level ...). The `gc_weakref.txt` is a fascinating read and should be required for anybody intending to meddle with sage's memory management.",
    "created_at": "2013-01-03T22:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164464",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@simon-king-jena](#comment:17):

> Still, we should use "del", not "`__delitem__`", because it gives shorter C-code. And in addition to that, we should see whether the new Cython from #13896 fixes the problem.

Yes, go ahead. Since there is no urgent issue anymore, use this ticket for whatever you want (and yes, that cython does solve the problem, if you compile the whole library with it. I'm now pretty confident I know exactly what went wrong, after seeing it happen on bit-level ...). The `gc_weakref.txt` is a fascinating read and should be required for anybody intending to meddle with sage's memory management.



---

archive/issue_comments_164465.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nIt seems that indeed #13896 fixes the problem. Hooray `\\<sup>.</sup>/`\n\nHence, the priority regarding #715 is to upgrade Cython. The change from calling `__delitem__` to `del` should be done (here) as well, but not so urgent.",
    "created_at": "2013-01-03T22:39:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164465",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

It seems that indeed #13896 fixes the problem. Hooray `\<sup>.</sup>/`

Hence, the priority regarding #715 is to upgrade Cython. The change from calling `__delitem__` to `del` should be done (here) as well, but not so urgent.



---

archive/issue_comments_164466.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nCan we get the change from `__delitem__` to del quickly in?\nIt is trivial, produce better C code, and potentially avoid horribly complicated gc problems?\n\nFrom what I've really quickly read, Nils pointed out another problem with weakrefs and callbacks, but let's go one step at a time and deal with that elsewhere (or move the trivial fix on a separate ticket).",
    "created_at": "2013-01-04T10:18:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164466",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:22" align="right">comment:22</div>

Can we get the change from `__delitem__` to del quickly in?
It is trivial, produce better C code, and potentially avoid horribly complicated gc problems?

From what I've really quickly read, Nils pointed out another problem with weakrefs and callbacks, but let's go one step at a time and deal with that elsewhere (or move the trivial fix on a separate ticket).



---

archive/issue_events_195238.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2013-01-04T10:21:30Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "title_is": "Better deletion of items of TripleDict",
    "title_was": "Proper deletion of items of TripleDict",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195238"
}
```



---

archive/issue_comments_164467.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nOh in fact, I've read a little less quickly and the problem Nils thought about does not occur?\nSo let's just get the trivial improvement here.\nI agree it is not a fix, but an imporvement, so I've changed the ticket title to reflect that as well.\n\nAnd in case one really wants to let garbage collection occurs during weakref callback or whenever, there are always ways to do that.",
    "created_at": "2013-01-04T10:21:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164467",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:23" align="right">comment:23</div>

Oh in fact, I've read a little less quickly and the problem Nils thought about does not occur?
So let's just get the trivial improvement here.
I agree it is not a fix, but an imporvement, so I've changed the ticket title to reflect that as well.

And in case one really wants to let garbage collection occurs during weakref callback or whenever, there are always ways to do that.



---

archive/issue_comments_164468.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jpflori](#comment:23):\n> Oh in fact, I've read a little less quickly and the problem Nils thought about does not occur?\n\nYes, because \"Python is more mature than we thought\"...\n\n> So let's just get the trivial improvement here.\n> I agree it is not a fix, but an imporvement\n\nBut, for the record, it is fixed with the new Cython spkg from #13896.",
    "created_at": "2013-01-04T10:34:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164468",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jpflori](#comment:23):
> Oh in fact, I've read a little less quickly and the problem Nils thought about does not occur?

Yes, because "Python is more mature than we thought"...

> So let's just get the trivial improvement here.
> I agree it is not a fix, but an imporvement

But, for the record, it is fixed with the new Cython spkg from #13896.



---

archive/issue_comments_164469.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nNote that #12313 comprises a patch that makes the callback of a `TripleDictEraser` (hence, the deletion of dead items of a `TripleDict`) more secure. But I forgot to include the little improvement from here. Hence, I still think this ticket here is valid.",
    "created_at": "2013-01-19T18:23:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164469",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

Note that #12313 comprises a patch that makes the callback of a `TripleDictEraser` (hence, the deletion of dead items of a `TripleDict`) more secure. But I forgot to include the little improvement from here. Hence, I still think this ticket here is valid.



---

archive/issue_comments_164470.json:
```json
{
    "body": "Use del rather then calling `__delitem__` directly, in `TripleDict` and `MonoDict`",
    "created_at": "2013-01-21T10:08:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164470",
    "user": "https://github.com/simon-king-jena"
}
```

Use del rather then calling `__delitem__` directly, in `TripleDict` and `MonoDict`



---

archive/issue_events_195239.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-21T10:10:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195239"
}
```



---

archive/issue_comments_164471.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nAttachment: **[trac13904_use_del.patch.gz](https://github.com/sagemath/sage/files/ticket13904/trac13904_use_del.patch.gz)**\n\nI think using `del` rather than calling `__delitem__` makes sense even though the segfaults from #715 seem to be fixed by the Cython upgrade: Apparently `del` results in shorter C code.\n\nThe new patch uses `del` both on `TripleDict` and the new `MonoDict`, hence, it depends on #12313, where the latter was introduced.\n\nApply trac13904_use_del.patch",
    "created_at": "2013-01-21T10:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164471",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

Attachment: **[trac13904_use_del.patch.gz](https://github.com/sagemath/sage/files/ticket13904/trac13904_use_del.patch.gz)**

I think using `del` rather than calling `__delitem__` makes sense even though the segfaults from #715 seem to be fixed by the Cython upgrade: Apparently `del` results in shorter C code.

The new patch uses `del` both on `TripleDict` and the new `MonoDict`, hence, it depends on #12313, where the latter was introduced.

Apply trac13904_use_del.patch



---

archive/issue_comments_164472.json:
```json
{
    "body": "Changed dependencies from **#13896** to **#13896, #12313**",
    "created_at": "2013-01-21T10:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164472",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#13896** to **#13896, #12313**



---

archive/issue_comments_164473.json:
```json
{
    "body": "Author: **Simon King**",
    "created_at": "2013-01-21T10:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164473",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Simon King**



---

archive/issue_events_195240.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2013-01-21T10:13:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195240"
}
```



---

archive/issue_events_195241.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2013-01-21T10:13:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195241"
}
```



---

archive/issue_comments_164474.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n In #715, `TripleDict` has been modified, so that the key items are compared by identity rather than equality, and so that weak keys are used when possible.\n \n However, as it turns out, the deletion of the items tracked in a `TripleDict` was done improperly. The aim of this ticket is to fix that.\n+\n+Apply [attachment: trac13904_use_del.patch](https://github.com/sagemath/sage/files/ticket13904/trac13904_use_del.patch.gz).\n``````\n",
    "created_at": "2013-01-21T10:13:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164474",
    "user": "https://github.com/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 In #715, `TripleDict` has been modified, so that the key items are compared by identity rather than equality, and so that weak keys are used when possible.
 
 However, as it turns out, the deletion of the items tracked in a `TripleDict` was done improperly. The aim of this ticket is to fix that.
+
+Apply [attachment: trac13904_use_del.patch](https://github.com/sagemath/sage/files/ticket13904/trac13904_use_del.patch.gz).
``````




---

archive/issue_comments_164475.json:
```json
{
    "body": "Reviewer: **Jean-Pierre Flori**",
    "created_at": "2013-01-21T10:13:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164475",
    "user": "https://github.com/jpflori"
}
```

Reviewer: **Jean-Pierre Flori**



---

archive/issue_events_195242.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T10:34:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195242"
}
```



---

archive/issue_events_195243.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T10:34:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195243"
}
```



---

archive/issue_events_195244.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-01T07:14:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195244"
}
```



---

archive/issue_events_195245.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-01T07:14:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195245"
}
```



---

archive/issue_comments_164476.json:
```json
{
    "body": "Merged: **sage-5.8.beta0**",
    "created_at": "2013-02-17T22:43:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164476",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.8.beta0**



---

archive/issue_events_195246.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-17T22:43:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195246"
}
```



---

archive/issue_events_195247.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-17T22:43:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195247"
}
```



---

archive/issue_comments_164477.json:
```json
{
    "body": "Changed merged from **sage-5.8.beta0** to none",
    "created_at": "2013-02-20T16:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164477",
    "user": "https://github.com/jdemeyer"
}
```

Changed merged from **sage-5.8.beta0** to none



---

archive/issue_comments_164478.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nUnmerging because of trouble with #12313.",
    "created_at": "2013-02-20T16:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164478",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Unmerging because of trouble with #12313.



---

archive/issue_comments_164479.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nPerhaps try #13387 instead? With the solution there, this ticket is superseded there. It improves the performance of these dictionaries in some other ways as well.",
    "created_at": "2013-02-20T17:19:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164479",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:32" align="right">comment:32</div>

Perhaps try #13387 instead? With the solution there, this ticket is superseded there. It improves the performance of these dictionaries in some other ways as well.



---

archive/issue_comments_164480.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nSo this one should get closed as #12313 and #13387 will get merged together?",
    "created_at": "2013-02-28T10:49:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164480",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:33" align="right">comment:33</div>

So this one should get closed as #12313 and #13387 will get merged together?



---

archive/issue_events_195248.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2013-02-28T10:49:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195248"
}
```



---

archive/issue_comments_164481.json:
```json
{
    "body": "Changed reviewer from **Jean-Pierre Flori** to **Simon King, Jean-Pierre Flori**",
    "created_at": "2013-02-28T10:59:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164481",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Jean-Pierre Flori** to **Simon King, Jean-Pierre Flori**



---

archive/issue_events_195249.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T10:59:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195249"
}
```



---

archive/issue_events_195250.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T10:59:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "a6a6a6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195250"
}
```



---

archive/issue_comments_164482.json:
```json
{
    "body": "Changed author from **Simon King** to none",
    "created_at": "2013-02-28T10:59:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164482",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Simon King** to none



---

archive/issue_comments_164483.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,4 @@\n \n However, as it turns out, the deletion of the items tracked in a `TripleDict` was done improperly. The aim of this ticket is to fix that.\n \n-Apply [attachment: trac13904_use_del.patch](https://github.com/sagemath/sage/files/ticket13904/trac13904_use_del.patch.gz).\n+Superseded by #13387.\n``````\n",
    "created_at": "2013-02-28T10:59:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13904#issuecomment-164483",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,4 @@
 
 However, as it turns out, the deletion of the items tracked in a `TripleDict` was done improperly. The aim of this ticket is to fix that.
 
-Apply [attachment: trac13904_use_del.patch](https://github.com/sagemath/sage/files/ticket13904/trac13904_use_del.patch.gz).
+Superseded by #13387.
``````




---

archive/issue_events_195251.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T10:59:30Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195251"
}
```



---

archive/issue_events_195252.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T10:59:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195252"
}
```



---

archive/issue_events_195253.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T10:59:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13904",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13904#event-195253"
}
```
