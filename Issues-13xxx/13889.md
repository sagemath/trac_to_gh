# Issue 13889: Better automatic backtrace

archive/issues_013685.json:
```json
{
    "assignees": [
        "https://github.com/jdemeyer"
    ],
    "body": "When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.\n\nThe log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted.\n\nApply\n* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)\n* [attachment: 13889_disable_osx.patch](https://github.com/sagemath/sage/files/ticket13889/13889_disable_osx.patch.gz)\n* [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo\n\nDepends on #13881\nDepends on #13866\n\nCC:  @simon-king-jena\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Volker Braun**\n\nMerged: **sage-5.7.beta0**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13889_\n\n",
    "closed_at": "2013-01-21T21:09:02Z",
    "created_at": "2012-12-30T18:08:45Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Better automatic backtrace",
    "type": "issue",
    "updated_at": "2013-01-28T17:48:30Z",
    "url": "https://github.com/sagemath/sage/issues/13889",
    "user": "https://github.com/vbraun"
}
```
When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.

The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted.

Apply
* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)
* [attachment: 13889_disable_osx.patch](https://github.com/sagemath/sage/files/ticket13889/13889_disable_osx.patch.gz)
* [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo

Depends on #13881
Depends on #13866

CC:  @simon-king-jena

Reviewer: **Jeroen Demeyer**

Author: **Volker Braun**

Merged: **sage-5.7.beta0**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/13889_





---

archive/issue_events_193120.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-30T18:08:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193120"
}
```



---

archive/issue_events_193121.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-30T18:08:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193121"
}
```



---

archive/issue_events_193122.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-30T18:08:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193122"
}
```



---

archive/issue_events_193123.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-30T18:08:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193123"
}
```



---

archive/issue_events_193124.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2012-12-30T18:08:45Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193124"
}
```



---

archive/issue_comments_164064.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,5 @@\n When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.\n+\n+Apply\n+* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) to Sage library\n+* [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo\n``````\n",
    "created_at": "2012-12-30T18:12:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164064",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,5 @@
 When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.
+
+Apply
+* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) to Sage library
+* [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo
``````




---

archive/issue_comments_164065.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.\n+\n+The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted. A sample log is [attachment: sage_crash_wKcUKj.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_wKcUKj.log)\n \n Apply\n * [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) to Sage library\n``````\n",
    "created_at": "2012-12-30T18:15:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164065",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.
+
+The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted. A sample log is [attachment: sage_crash_wKcUKj.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_wKcUKj.log)
 
 Apply
 * [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) to Sage library
``````




---

archive/issue_comments_164066.json:
```json
{
    "body": "Dependencies: **#13881**",
    "created_at": "2012-12-30T18:16:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164066",
    "user": "https://github.com/vbraun"
}
```

Dependencies: **#13881**



---

archive/issue_comments_164067.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2012-12-30T18:16:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164067",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_events_193125.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-30T18:16:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193125"
}
```



---

archive/issue_comments_164068.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI don't think I know enough about gdb to review this completely, but some remarks anyway:\n\n1. There is a double \"and\" in\n\n```\n\"Sage will now try to attach the debugger to get more information and\\n\"\n\"and then terminate.\\n\"\n```\n\n2. Why should the CSI script kill the Sage process? Couldn't you use a different IPC mechanism, such as a simple `wait()` (or a different signal or a pipe if you want)? The sentence \"The target process is frozen while this script runs and resumes when it is finished.\" in `sage-CSI` is currently wrong.\n\n3. I preferred how the backtrace currently appears **before** the \"Unhandled SIGSEGV: ...\" message. When something goes wrong, that message stands out at the end of the console output. I think all those backtraces might confuse less experienced Sage users.\n\n4. In `run_gdb()`, `stderr` will always be `None` since you didn't redirect it. That's fine, so remove\n\n```\nif stderr != None: \n    result.append('An error ocurred:') \n    result.append(stderr)\n```\n\n5. The `Popen` command should probably be wrapped in a\n\n```\ntry:\n    cmd = Popen(...)\nexcept OSError:\n    return \"\"\n```\nblock to handle the case that `gdb` isn't installed (and I guess empty backtraces should not be saved to a file).",
    "created_at": "2013-01-03T14:49:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164068",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

I don't think I know enough about gdb to review this completely, but some remarks anyway:

1. There is a double "and" in

```
"Sage will now try to attach the debugger to get more information and\n"
"and then terminate.\n"
```

2. Why should the CSI script kill the Sage process? Couldn't you use a different IPC mechanism, such as a simple `wait()` (or a different signal or a pipe if you want)? The sentence "The target process is frozen while this script runs and resumes when it is finished." in `sage-CSI` is currently wrong.

3. I preferred how the backtrace currently appears **before** the "Unhandled SIGSEGV: ..." message. When something goes wrong, that message stands out at the end of the console output. I think all those backtraces might confuse less experienced Sage users.

4. In `run_gdb()`, `stderr` will always be `None` since you didn't redirect it. That's fine, so remove

```
if stderr != None: 
    result.append('An error ocurred:') 
    result.append(stderr)
```

5. The `Popen` command should probably be wrapped in a

```
try:
    cmd = Popen(...)
except OSError:
    return ""
```
block to handle the case that `gdb` isn't installed (and I guess empty backtraces should not be saved to a file).



---

archive/issue_comments_164069.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@jdemeyer](#comment%3A6):\n> I don't think I know enough about gdb\n\nAt least you certainly know more than I do. So, sorry for my unqualified comments...\n\n> 3. I preferred how the backtrace currently appears **before** the \"Unhandled SIGSEGV: ...\" message. When something goes wrong, that message stands out at the end of the console output.\n\nYes, when an error in Python is raised, one first sees the backtrace and then the error message. If Sage crashes, it makes sense to show first the backtrace and then the error message as well.\n\n> I think all those backtraces might confuse less experienced Sage users.\n\nWell, a less experienced Sage user will hopefully never see such backtraces.\n\nWhat I mean is: Sage is supposed to run without crashes when doing low-level stuff. Hence, crashes are supposed to *only* occur if the user creates new buggy Cython programs in Sage, or tries to tweak Sage until it exposes its existing bugs. And I think a user who does such \"real\" programming and developing is experienced enough to not be confused by a backtrace.",
    "created_at": "2013-01-03T15:18:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164069",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@jdemeyer](#comment%3A6):
> I don't think I know enough about gdb

At least you certainly know more than I do. So, sorry for my unqualified comments...

> 3. I preferred how the backtrace currently appears **before** the "Unhandled SIGSEGV: ..." message. When something goes wrong, that message stands out at the end of the console output.

Yes, when an error in Python is raised, one first sees the backtrace and then the error message. If Sage crashes, it makes sense to show first the backtrace and then the error message as well.

> I think all those backtraces might confuse less experienced Sage users.

Well, a less experienced Sage user will hopefully never see such backtraces.

What I mean is: Sage is supposed to run without crashes when doing low-level stuff. Hence, crashes are supposed to *only* occur if the user creates new buggy Cython programs in Sage, or tries to tweak Sage until it exposes its existing bugs. And I think a user who does such "real" programming and developing is experienced enough to not be confused by a backtrace.



---

archive/issue_comments_164070.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@simon-king-jena](#comment%3A7):\n> Well, a less experienced Sage user will hopefully never see such backtraces.\n> \n> What I mean is: Sage is supposed to run without crashes when doing low-level stuff.\n\nUnfornately, \"hopefully\" and \"should\" aren't always applicable. There are plenty of cases where seemingly innocent calculations produce the dreaded \"Unhandled SIGSEGV\" message.",
    "created_at": "2013-01-03T15:24:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164070",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@simon-king-jena](#comment%3A7):
> Well, a less experienced Sage user will hopefully never see such backtraces.
> 
> What I mean is: Sage is supposed to run without crashes when doing low-level stuff.

Unfornately, "hopefully" and "should" aren't always applicable. There are plenty of cases where seemingly innocent calculations produce the dreaded "Unhandled SIGSEGV" message.



---

archive/issue_comments_164071.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIt makes sense to have the \"Unhandled SIGSEGV...\" message at the end. I don't think trying to get back from the debugger into the main program is a good idea. Sage is currently in a signal handler after something bad happened, there are no guarantees that anything is still working. In fact, just calling `printf()` from the signal handler is, strictly speaking, illegal. But the `sage-CSI` script can easily print the message.\n\nThe \"The target process is frozen while this script runs and resumes when it is finished.\" is correct (unless you add `--kill`, what did you expect). In fact you can use the `sage-CSI` to see the status of a long-running computation without disturbing it if you don't pass `--kill`.",
    "created_at": "2013-01-03T15:42:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164071",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:9" align="right">comment:9</div>

It makes sense to have the "Unhandled SIGSEGV..." message at the end. I don't think trying to get back from the debugger into the main program is a good idea. Sage is currently in a signal handler after something bad happened, there are no guarantees that anything is still working. In fact, just calling `printf()` from the signal handler is, strictly speaking, illegal. But the `sage-CSI` script can easily print the message.

The "The target process is frozen while this script runs and resumes when it is finished." is correct (unless you add `--kill`, what did you expect). In fact you can use the `sage-CSI` to see the status of a long-running computation without disturbing it if you don't pass `--kill`.



---

archive/issue_comments_164072.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@vbraun](#comment%3A9):\n> It makes sense to have the \"Unhandled SIGSEGV...\" message at the end. I don't think trying to get back from the debugger into the main program is a good idea. Sage is currently in a signal handler after something bad happened, there are no guarantees that anything is still working.\n\nTrue, but what's your point? Your `execlp()` might also fail for this reason. While `fork()` and `wait()` are basically pure system calls, so much less probable to fail.\n\nSo I stand by my proposal to remove the `sleep(10)` kludge and replace it by a `wait()`. Then you don't need to kill the parent process.",
    "created_at": "2013-01-03T16:21:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164072",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@vbraun](#comment%3A9):
> It makes sense to have the "Unhandled SIGSEGV..." message at the end. I don't think trying to get back from the debugger into the main program is a good idea. Sage is currently in a signal handler after something bad happened, there are no guarantees that anything is still working.

True, but what's your point? Your `execlp()` might also fail for this reason. While `fork()` and `wait()` are basically pure system calls, so much less probable to fail.

So I stand by my proposal to remove the `sleep(10)` kludge and replace it by a `wait()`. Then you don't need to kill the parent process.



---

archive/issue_comments_164073.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI don't mind going the `wait()` route. Its still illegal to use `printf()` in the signal handler but seems to work more often than not.",
    "created_at": "2013-01-03T16:43:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164073",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:11" align="right">comment:11</div>

I don't mind going the `wait()` route. Its still illegal to use `printf()` in the signal handler but seems to work more often than not.



---

archive/issue_comments_164074.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI've addressed all issues. Also, I don't see why you need to be an expert in GDB to review this ticket.. ;-)",
    "created_at": "2013-01-04T16:30:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164074",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">comment:12</div>

I've addressed all issues. Also, I don't see why you need to be an expert in GDB to review this ticket.. ;-)



---

archive/issue_comments_164075.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe GDB thing doesn't quite work for me, don't know why:\n\n```\n------------------------------------------------------------------------\nAttaching to process id 8267.\nGNU gdb 6.7.1\nCopyright (C) 2007 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-pc-linux-gnu\".\n(gdb) Hangup detected on fd 0\nerror detected on stdin\nSaved trace to /home/jdemeyer/.sage/crash_logs/sage_crash_WM1Ga9.log\n\n------------------------------------------------------------------------\n```",
    "created_at": "2013-01-12T19:17:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164075",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

The GDB thing doesn't quite work for me, don't know why:

```
------------------------------------------------------------------------
Attaching to process id 8267.
GNU gdb 6.7.1
Copyright (C) 2007 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-pc-linux-gnu".
(gdb) Hangup detected on fd 0
error detected on stdin
Saved trace to /home/jdemeyer/.sage/crash_logs/sage_crash_WM1Ga9.log

------------------------------------------------------------------------
```



---

archive/issue_comments_164076.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nGdb 6.7.1 is ancient (vintage 2007). I doubt it has any Python supporty...",
    "created_at": "2013-01-12T19:21:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164076",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:14" align="right">comment:14</div>

Gdb 6.7.1 is ancient (vintage 2007). I doubt it has any Python supporty...



---

archive/issue_comments_164077.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nFair enough, compiling `gdb-7.5` now...",
    "created_at": "2013-01-12T19:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164077",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Fair enough, compiling `gdb-7.5` now...



---

archive/issue_comments_164078.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nPlease have a look at this logfile, the last part looks broken.\n\nIt was generated by\n\n```\n./sage -c \"from sage.tests.interrupt import *; unguarded_abort()\"\n```",
    "created_at": "2013-01-12T21:39:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164078",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Please have a look at this logfile, the last part looks broken.

It was generated by

```
./sage -c "from sage.tests.interrupt import *; unguarded_abort()"
```



---

archive/issue_events_193126.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-12T21:44:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193126"
}
```



---

archive/issue_events_193127.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-12T21:44:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193127"
}
```



---

archive/issue_comments_164079.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,5 +3,5 @@\n The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted. A sample log is [attachment: sage_crash_wKcUKj.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_wKcUKj.log)\n \n Apply\n-* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) to Sage library\n+* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) and [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz) to Sage library\n * [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo\n``````\n",
    "created_at": "2013-01-12T21:44:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164079",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,5 +3,5 @@
 The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted. A sample log is [attachment: sage_crash_wKcUKj.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_wKcUKj.log)
 
 Apply
-* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) to Sage library
+* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) and [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz) to Sage library
 * [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo
``````




---

archive/issue_comments_164080.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.\n \n-The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted. A sample log is [attachment: sage_crash_wKcUKj.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_wKcUKj.log)\n+The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted.\n \n Apply\n * [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) and [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz) to Sage library\n``````\n",
    "created_at": "2013-01-12T21:44:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164080",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 When Sage encounters a SIGSEGV, it uses the glibc backtrace. This is sometimes seen in doctests that are not reproducible, making it hard to debug. The aim of this ticket is to return better automatic stack traces by automatically attaching gdb and running scripts in gdb's Python interpreter. This will will pinpoint the cause much easier, especially in a debug build.
 
-The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted. A sample log is [attachment: sage_crash_wKcUKj.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_wKcUKj.log)
+The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted.
 
 Apply
 * [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) and [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz) to Sage library
``````




---

archive/issue_comments_164081.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nWhat happens if you import site into the python interpreter in gdb?\n\n```\n(gdb) python import site\n(gdb) python import sys               \n(gdb) python print sys.modules['site']\n<module 'site' from '/home/vbraun/opt/sage-5.5.rc1/local/lib/python/site.pyc'>\n```\nDid you build gdb with python enabled? This should be the default but obviously requires Python to be installed in Gentoo. \n\n```\n(sage-sh) vbraun@volker-desktop:spkg$ ldd /usr/bin/gdb\n\tlinux-vdso.so.1 =>  (0x00007fffd2584000)\n\tlibreadline.so.6 => /home/vbraun/opt/sage-5.5.rc1/local/lib/libreadline.so.6 (0x00007faa4059e000)\n\tlibselinux.so.1 => /lib64/libselinux.so.1 (0x000000325f400000)\n\tlibncurses.so.5 => /lib64/libncurses.so.5 (0x000000327a400000)\n\tlibtinfo.so.5 => /lib64/libtinfo.so.5 (0x0000003275400000)\n\tlibz.so.1 => /home/vbraun/opt/sage-5.5.rc1/local/lib/libz.so.1 (0x00007faa4035f000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x000000325e400000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x000000325dc00000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x000000325d800000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x0000003276800000)\n\tlibpython2.7.so.1.0 => /home/vbraun/opt/sage-5.5.rc1/local/lib/libpython2.7.so.1.0 (0x00007faa3ff7f000)\n\tlibexpat.so.1 => /lib64/libexpat.so.1 (0x0000003262800000)\n\tliblzma.so.5 => /lib64/liblzma.so.5 (0x0000003264000000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x000000325d400000)\n\tlibpcre.so.1 => /lib64/libpcre.so.1 (0x000000325f000000)\n\t/lib64/ld-linux-x86-64.so.2 (0x000000325d000000)\n\tlibrt.so.1 => /lib64/librt.so.1 (0x000000325e000000)\n```",
    "created_at": "2013-01-12T22:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164081",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

What happens if you import site into the python interpreter in gdb?

```
(gdb) python import site
(gdb) python import sys               
(gdb) python print sys.modules['site']
<module 'site' from '/home/vbraun/opt/sage-5.5.rc1/local/lib/python/site.pyc'>
```
Did you build gdb with python enabled? This should be the default but obviously requires Python to be installed in Gentoo. 

```
(sage-sh) vbraun@volker-desktop:spkg$ ldd /usr/bin/gdb
	linux-vdso.so.1 =>  (0x00007fffd2584000)
	libreadline.so.6 => /home/vbraun/opt/sage-5.5.rc1/local/lib/libreadline.so.6 (0x00007faa4059e000)
	libselinux.so.1 => /lib64/libselinux.so.1 (0x000000325f400000)
	libncurses.so.5 => /lib64/libncurses.so.5 (0x000000327a400000)
	libtinfo.so.5 => /lib64/libtinfo.so.5 (0x0000003275400000)
	libz.so.1 => /home/vbraun/opt/sage-5.5.rc1/local/lib/libz.so.1 (0x00007faa4035f000)
	libm.so.6 => /lib64/libm.so.6 (0x000000325e400000)
	libdl.so.2 => /lib64/libdl.so.2 (0x000000325dc00000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x000000325d800000)
	libutil.so.1 => /lib64/libutil.so.1 (0x0000003276800000)
	libpython2.7.so.1.0 => /home/vbraun/opt/sage-5.5.rc1/local/lib/libpython2.7.so.1.0 (0x00007faa3ff7f000)
	libexpat.so.1 => /lib64/libexpat.so.1 (0x0000003262800000)
	liblzma.so.5 => /lib64/liblzma.so.5 (0x0000003264000000)
	libc.so.6 => /lib64/libc.so.6 (0x000000325d400000)
	libpcre.so.1 => /lib64/libpcre.so.1 (0x000000325f000000)
	/lib64/ld-linux-x86-64.so.2 (0x000000325d000000)
	librt.so.1 => /lib64/librt.so.1 (0x000000325e000000)
```



---

archive/issue_comments_164082.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nOn further thought, it seems that your OS Python was built without weakref, but Sage Python is of course built with weakref.",
    "created_at": "2013-01-12T22:08:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164082",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:20" align="right">comment:20</div>

On further thought, it seems that your OS Python was built without weakref, but Sage Python is of course built with weakref.



---

archive/issue_comments_164083.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nEven just starting `gdb` within a Sage shell gives me:\n\n```\n(sage-sh) jdemeyer@arcanis:sage-5.6.beta3$ gdb\n'import site' failed; use -v for traceback\nTraceback (most recent call last):\n  File \"<string>\", line 1, in <module>\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/os.py\", line 398, in <module>\n    import UserDict\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/UserDict.py\", line 83, in <module>\n    import _abcoll\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/_abcoll.py\", line 11, in <module>\n    from abc import ABCMeta, abstractmethod\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/abc.py\", line 8, in <module>\n    from _weakrefset import WeakSet\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/_weakrefset.py\", line 5, in <module>\n    from _weakref import ref\nImportError: No module named _weakref\nGNU gdb (Gentoo 7.5 p1) 7.5\nCopyright (C) 2012 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-pc-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://bugs.gentoo.org/>.\n(gdb)\n```\n\nAren't there always going to be problems if `gdb` uses system Python instead of Sage python?",
    "created_at": "2013-01-12T22:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164083",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Even just starting `gdb` within a Sage shell gives me:

```
(sage-sh) jdemeyer@arcanis:sage-5.6.beta3$ gdb
'import site' failed; use -v for traceback
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/os.py", line 398, in <module>
    import UserDict
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/UserDict.py", line 83, in <module>
    import _abcoll
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/_abcoll.py", line 11, in <module>
    from abc import ABCMeta, abstractmethod
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/abc.py", line 8, in <module>
    from _weakrefset import WeakSet
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/_weakrefset.py", line 5, in <module>
    from _weakref import ref
ImportError: No module named _weakref
GNU gdb (Gentoo 7.5 p1) 7.5
Copyright (C) 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-pc-linux-gnu".
For bug reporting instructions, please see:
<http://bugs.gentoo.org/>.
(gdb)
```

Aren't there always going to be problems if `gdb` uses system Python instead of Sage python?



---

archive/issue_comments_164084.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nWell I only tried it on my machine, and there it works. Both Fedora 18 and Sage use Python 2.7.3, so it is no surprise that it works. \n\nIts curious that you get the backtrace immediately, line 14 and 15 in your log were printed by  Python (line 36 and 37 in `sage-CSI`). I guess interactive use tries to load the os module and we are screwed. Though we could at least use that to give a better error message.\n\nWe could unset `LD_LIBRARY_PATH` but you also need Cython to get the Cython source information. So I guess we should point users to the gdb spkg #13866.",
    "created_at": "2013-01-12T22:26:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164084",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:22" align="right">comment:22</div>

Well I only tried it on my machine, and there it works. Both Fedora 18 and Sage use Python 2.7.3, so it is no surprise that it works. 

Its curious that you get the backtrace immediately, line 14 and 15 in your log were printed by  Python (line 36 and 37 in `sage-CSI`). I guess interactive use tries to load the os module and we are screwed. Though we could at least use that to give a better error message.

We could unset `LD_LIBRARY_PATH` but you also need Cython to get the Cython source information. So I guess we should point users to the gdb spkg #13866.



---

archive/issue_comments_164085.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI've added some checking for gdb errors to point users towards he Sage gdb spkg. Untested since it does work for me ;-)",
    "created_at": "2013-01-12T22:49:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164085",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:23" align="right">comment:23</div>

I've added some checking for gdb errors to point users towards he Sage gdb spkg. Untested since it does work for me ;-)



---

archive/issue_comments_164086.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI do indeed get that message:\n\n```\nAn error was sent to stderr:\n'import site' failed; use -v for traceback\nTraceback (most recent call last):\n  File \"<string>\", line 1, in <module>\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/os.py\", line 398, in <module>\n    import UserDict\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/UserDict.py\", line 83, in <module>\n    import _abcoll\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/_abcoll.py\", line 11, in <module>\n    from abc import ABCMeta, abstractmethod\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/abc.py\", line 8, in <module>\n    from _weakrefset import WeakSet\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/_weakrefset.py\", line 5, in <module>\n    from _weakref import ref\nImportError: No module named _weakref\nwarning: Could not load shared library symbols for linux-vdso.so.1.\nDo you need \"set solib-search-path\" or \"set sysroot\"?\nwarning: File \"/home/jdemeyer/local/lib64/libstdc++.so.6.0.16-gdb.py\" auto-loading has been declined by your `auto-load safe-path' set to \"$debugdir:$datadir/auto-load\".\nTraceback (most recent call last):\n  File \"<string>\", line 4, in <module>\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/os.py\", line 398, in <module>\n    import UserDict\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/UserDict.py\", line 83, in <module>\n    import _abcoll\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/_abcoll.py\", line 11, in <module>\n    from abc import ABCMeta, abstractmethod\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/abc.py\", line 8, in <module>\n    from _weakrefset import WeakSet\n  File \"/usr/local/src/sage-5.6.beta3/local/lib/python/_weakrefset.py\", line 5, in <module>\n    from _weakref import ref\nImportError: No module named _weakref\nError while executing Python code.\n\nThe GDB/Python support seems to not work.\nInstall the gdb spkg (sage -f gdb) for enhanced tracebacks.\n```",
    "created_at": "2013-01-14T10:15:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164086",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

I do indeed get that message:

```
An error was sent to stderr:
'import site' failed; use -v for traceback
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/os.py", line 398, in <module>
    import UserDict
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/UserDict.py", line 83, in <module>
    import _abcoll
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/_abcoll.py", line 11, in <module>
    from abc import ABCMeta, abstractmethod
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/abc.py", line 8, in <module>
    from _weakrefset import WeakSet
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/_weakrefset.py", line 5, in <module>
    from _weakref import ref
ImportError: No module named _weakref
warning: Could not load shared library symbols for linux-vdso.so.1.
Do you need "set solib-search-path" or "set sysroot"?
warning: File "/home/jdemeyer/local/lib64/libstdc++.so.6.0.16-gdb.py" auto-loading has been declined by your `auto-load safe-path' set to "$debugdir:$datadir/auto-load".
Traceback (most recent call last):
  File "<string>", line 4, in <module>
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/os.py", line 398, in <module>
    import UserDict
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/UserDict.py", line 83, in <module>
    import _abcoll
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/_abcoll.py", line 11, in <module>
    from abc import ABCMeta, abstractmethod
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/abc.py", line 8, in <module>
    from _weakrefset import WeakSet
  File "/usr/local/src/sage-5.6.beta3/local/lib/python/_weakrefset.py", line 5, in <module>
    from _weakref import ref
ImportError: No module named _weakref
Error while executing Python code.

The GDB/Python support seems to not work.
Install the gdb spkg (sage -f gdb) for enhanced tracebacks.
```



---

archive/issue_comments_164087.json:
```json
{
    "body": "Changed dependencies from **#13881** to **#13881, #13866**",
    "created_at": "2013-01-14T10:15:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164087",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#13881** to **#13881, #13866**



---

archive/issue_comments_164088.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nIt would be nice if we could somehow force system gdb to use Sage's version of Python.",
    "created_at": "2013-01-14T10:16:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164088",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

It would be nice if we could somehow force system gdb to use Sage's version of Python.



---

archive/issue_comments_164089.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nIt seems that gdb doesn't pick up Sage's Python if the library versions don't match.  Part of the `strace` from \"gdb\":\n\n```\nopen(\"/usr/local/src/sage-5.6.beta3/local/lib/libpython2.6.so.1.0\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\nopen(\"/usr/local/src/sage-5.6.beta3/local/lib/R/lib/libpython2.6.so.1.0\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\nopen(\"/home/jdemeyer/local/lib/libpython2.6.so.1.0\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\nopen(\"/home/jdemeyer/local/lib32/libpython2.6.so.1.0\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\nopen(\"/home/jdemeyer/local/lib64/libpython2.6.so.1.0\", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)\nopen(\"/usr/lib/libpython2.6.so.1.0\", O_RDONLY|O_CLOEXEC) = 3\n```\nBut imports come from Sage:\n\n```\nopen(\"/usr/local/src/sage-5.6.beta3/local/lib/python/os.py\", O_RDONLY) = 4\n```",
    "created_at": "2013-01-14T10:22:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164089",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

It seems that gdb doesn't pick up Sage's Python if the library versions don't match.  Part of the `strace` from "gdb":

```
open("/usr/local/src/sage-5.6.beta3/local/lib/libpython2.6.so.1.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/usr/local/src/sage-5.6.beta3/local/lib/R/lib/libpython2.6.so.1.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/home/jdemeyer/local/lib/libpython2.6.so.1.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/home/jdemeyer/local/lib32/libpython2.6.so.1.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/home/jdemeyer/local/lib64/libpython2.6.so.1.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/usr/lib/libpython2.6.so.1.0", O_RDONLY|O_CLOEXEC) = 3
```
But imports come from Sage:

```
open("/usr/local/src/sage-5.6.beta3/local/lib/python/os.py", O_RDONLY) = 4
```



---

archive/issue_comments_164090.json:
```json
{
    "body": "Sample log",
    "created_at": "2013-01-14T10:25:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164090",
    "user": "https://github.com/jdemeyer"
}
```

Sample log



---

archive/issue_comments_164091.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nAttachment: **[sage_crash_Ho8Cji.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_Ho8Cji.log)**\n\nWith the `gdb` spkg: [attachment: sage_crash_Ho8Cji.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_Ho8Cji.log)",
    "created_at": "2013-01-14T10:26:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164091",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Attachment: **[sage_crash_Ho8Cji.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_Ho8Cji.log)**

With the `gdb` spkg: [attachment: sage_crash_Ho8Cji.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_Ho8Cji.log)



---

archive/issue_comments_164092.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nSimply putting a symbolic link\n\n```\nln -s libpython2.7.so.1.0 libpython2.6.so.1.0\n```\nin `$SAGE_ROOT/local/lib` made system-gdb work fine.",
    "created_at": "2013-01-14T10:33:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164092",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Simply putting a symbolic link

```
ln -s libpython2.7.so.1.0 libpython2.6.so.1.0
```
in `$SAGE_ROOT/local/lib` made system-gdb work fine.



---

archive/issue_comments_164093.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nWhich make me wonder: should we change the Python spkg to make symbolic links like to one above (say, based on which libraries exist in `/usr/lib`).",
    "created_at": "2013-01-14T10:39:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164093",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Which make me wonder: should we change the Python spkg to make symbolic links like to one above (say, based on which libraries exist in `/usr/lib`).



---

archive/issue_events_193128.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2013-01-14T11:12:42Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193128"
}
```



---

archive/issue_events_193129.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-14T11:12:42Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193129"
}
```



---

archive/issue_comments_164094.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThe script correctly detects if `gdb` is not installed:\n\n```\n------------------------------------------------------------------------\nAttaching to process id 22967.\nUnable to start gdb (not installed?)\nThe GDB/Python support seems to not work.\nInstall the gdb spkg (sage -f gdb) for enhanced tracebacks.\n------------------------------------------------------------------------\n```",
    "created_at": "2013-01-14T11:12:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164094",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

The script correctly detects if `gdb` is not installed:

```
------------------------------------------------------------------------
Attaching to process id 22967.
Unable to start gdb (not installed?)
The GDB/Python support seems to not work.
Install the gdb spkg (sage -f gdb) for enhanced tracebacks.
------------------------------------------------------------------------
```



---

archive/issue_comments_164095.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@jdemeyer](#comment%3A29):\n> Which make me wonder: should we change the Python spkg to make symbolic links like to one above (say, based on which libraries exist in `/usr/lib`).\n\nNo, definitely not. Library versioning is there for a reason. In the case of GDB you might get away with it since GDB just runs an embedded Python, but anything that really touches Python internals might get very upset.\n\nBut maybe we can LD_PRELOAD libpython just for gdb, does that work?",
    "created_at": "2013-01-14T11:17:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164095",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@jdemeyer](#comment%3A29):
> Which make me wonder: should we change the Python spkg to make symbolic links like to one above (say, based on which libraries exist in `/usr/lib`).

No, definitely not. Library versioning is there for a reason. In the case of GDB you might get away with it since GDB just runs an embedded Python, but anything that really touches Python internals might get very upset.

But maybe we can LD_PRELOAD libpython just for gdb, does that work?



---

archive/issue_comments_164096.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThe log with the gdb spkg ([attachment: sage_crash_Ho8Cji.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_Ho8Cji.log)) shows the intended output. There is an error at the end because you don't have debugging symbols for system libraries. We could suppress that but then it can also be a useful reminder if you suspect that the bad stuff happens in glibc, say.",
    "created_at": "2013-01-14T11:20:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164096",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:32" align="right">comment:32</div>

The log with the gdb spkg ([attachment: sage_crash_Ho8Cji.log](https://github.com/sagemath/sage/files/ticket13889/sage_crash_Ho8Cji.log)) shows the intended output. There is an error at the end because you don't have debugging symbols for system libraries. We could suppress that but then it can also be a useful reminder if you suspect that the bad stuff happens in glibc, say.



---

archive/issue_comments_164097.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@vbraun](#comment%3A31):\n> Replying to [@jdemeyer](#comment%3A29):\n> > Which make me wonder: should we change the Python spkg to make symbolic links like to one above (say, based on which libraries exist in `/usr/lib`).\n\n> \n> No, definitely not. Library versioning is there for a reason. In the case of GDB you might get away with it since GDB just runs an embedded Python, but anything that really touches Python internals might get very upset.\n> \n> But maybe we can LD_PRELOAD libpython just for gdb, does that work?\n\nYes, it does, at least for Python-2.6.\n\nWhen system Python is 2.4, it doesn't work.  I don't have a system with Python 2.5 and a sufficiently recent GDB.",
    "created_at": "2013-01-14T11:28:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164097",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@vbraun](#comment%3A31):
> Replying to [@jdemeyer](#comment%3A29):
> > Which make me wonder: should we change the Python spkg to make symbolic links like to one above (say, based on which libraries exist in `/usr/lib`).

> 
> No, definitely not. Library versioning is there for a reason. In the case of GDB you might get away with it since GDB just runs an embedded Python, but anything that really touches Python internals might get very upset.
> 
> But maybe we can LD_PRELOAD libpython just for gdb, does that work?

Yes, it does, at least for Python-2.6.

When system Python is 2.4, it doesn't work.  I don't have a system with Python 2.5 and a sufficiently recent GDB.



---

archive/issue_comments_164098.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI've added `LD_PRELOAD` / `DYLD_INSERT_LIBRARIES` and better diagnostic for gdb errors.",
    "created_at": "2013-01-14T12:04:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164098",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:34" align="right">comment:34</div>

I've added `LD_PRELOAD` / `DYLD_INSERT_LIBRARIES` and better diagnostic for gdb errors.



---

archive/issue_events_193130.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-14T12:39:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193130"
}
```



---

archive/issue_events_193131.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-14T12:39:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193131"
}
```



---

archive/issue_comments_164099.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nLooks good so far.  I'm going to test it on a few different systems (in particular OS X).\n\nDo you agree with [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz)?",
    "created_at": "2013-01-14T12:42:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164099",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">comment:36</div>

Looks good so far.  I'm going to test it on a few different systems (in particular OS X).

Do you agree with [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz)?



---

archive/issue_comments_164100.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@jdemeyer](#comment%3A36):\n> Do you agree with [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz)?\n\nYes!",
    "created_at": "2013-01-14T12:59:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164100",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@jdemeyer](#comment%3A36):
> Do you agree with [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz)?

Yes!



---

archive/issue_comments_164101.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nCould you add\n\n```\nlibpython = os.path.join(env['SAGE_LOCAL'], 'lib', libpython)\n```\nsince libpython is returned as relative path and causes `gdb` to fail to start on OS X.\n\nBut even with this change, the hack doesn't work on OS X.\n\nSystem `gdb`:\n\n```\n(sage subshell) bsd:sage-4.8 jdemeyer$ DYLD_INSERT_LIBRARIES=\"$SAGE_LOCAL/lib/libpython2.7.dylib\" /usr/bin/gdb\ndyld: Symbol not found: _environ\n  Referenced from: /Users/jdemeyer/sage-4.8/local/lib/libpython2.7.dylib\n  Expected in: flat namespace\n in /Users/jdemeyer/sage-4.8/local/lib/libpython2.7.dylib\nTrace/BPT trap\n```\n\n`gdb` spkg but compiled (on purpose) with the wrong Python version:\n\n```\n(sage subshell) bsd:sage-4.8 jdemeyer$ DYLD_INSERT_LIBRARIES=\"$SAGE_LOCAL/lib/libpython2.7.dylib\" gdb\n'import site' failed; use -v for traceback\nTraceback (most recent call last):\n  File \"<string>\", line 1, in <module>\n  File \"/Users/jdemeyer/sage-4.8/local/lib/python/os.py\", line 398, in <module>\n    import UserDict\n  File \"/Users/jdemeyer/sage-4.8/local/lib/python/UserDict.py\", line 83, in <module>\n    import _abcoll\n  File \"/Users/jdemeyer/sage-4.8/local/lib/python/_abcoll.py\", line 11, in <module>\n    from abc import ABCMeta, abstractmethod\n  File \"/Users/jdemeyer/sage-4.8/local/lib/python/abc.py\", line 8, in <module>\n    from _weakrefset import WeakSet\n  File \"/Users/jdemeyer/sage-4.8/local/lib/python/_weakrefset.py\", line 5, in <module>\n    from _weakref import ref\nImportError: No module named _weakref\nGNU gdb (GDB) 7.5.1\nCopyright (C) 2012 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-apple-darwin10.8.0\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>.\n(gdb)\n```",
    "created_at": "2013-01-15T09:27:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164101",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Could you add

```
libpython = os.path.join(env['SAGE_LOCAL'], 'lib', libpython)
```
since libpython is returned as relative path and causes `gdb` to fail to start on OS X.

But even with this change, the hack doesn't work on OS X.

System `gdb`:

```
(sage subshell) bsd:sage-4.8 jdemeyer$ DYLD_INSERT_LIBRARIES="$SAGE_LOCAL/lib/libpython2.7.dylib" /usr/bin/gdb
dyld: Symbol not found: _environ
  Referenced from: /Users/jdemeyer/sage-4.8/local/lib/libpython2.7.dylib
  Expected in: flat namespace
 in /Users/jdemeyer/sage-4.8/local/lib/libpython2.7.dylib
Trace/BPT trap
```

`gdb` spkg but compiled (on purpose) with the wrong Python version:

```
(sage subshell) bsd:sage-4.8 jdemeyer$ DYLD_INSERT_LIBRARIES="$SAGE_LOCAL/lib/libpython2.7.dylib" gdb
'import site' failed; use -v for traceback
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/Users/jdemeyer/sage-4.8/local/lib/python/os.py", line 398, in <module>
    import UserDict
  File "/Users/jdemeyer/sage-4.8/local/lib/python/UserDict.py", line 83, in <module>
    import _abcoll
  File "/Users/jdemeyer/sage-4.8/local/lib/python/_abcoll.py", line 11, in <module>
    from abc import ABCMeta, abstractmethod
  File "/Users/jdemeyer/sage-4.8/local/lib/python/abc.py", line 8, in <module>
    from _weakrefset import WeakSet
  File "/Users/jdemeyer/sage-4.8/local/lib/python/_weakrefset.py", line 5, in <module>
    from _weakref import ref
ImportError: No module named _weakref
GNU gdb (GDB) 7.5.1
Copyright (C) 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-apple-darwin10.8.0".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
(gdb)
```



---

archive/issue_comments_164102.json:
```json
{
    "body": "Attachment: **[trac_13889_crime_scene_inspector.patch.gz](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz)**\n\nUpdated patch",
    "created_at": "2013-01-15T10:15:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164102",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_13889_crime_scene_inspector.patch.gz](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz)**

Updated patch



---

archive/issue_comments_164103.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nI've added the full path name since it can't hurt.\n\nUpon reflection, I think this is the reason why it does not and cannot work on OSX. In order to protect their precious DRM, Apple has disabled much of the ptrace API. A consequence is that /usr/bin/gdb needs special permissions (it is setgid on OSX, but a normal program on Linux) to fully function. And the dynamic linker disallows library interposition for setgid binaries. In fact, /usr/bin/gdb on osx is a shell script that unsets `DYLD_*` variables before the dynamic linker even gets a chance to complain about them.",
    "created_at": "2013-01-15T10:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164103",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:39" align="right">comment:39</div>

I've added the full path name since it can't hurt.

Upon reflection, I think this is the reason why it does not and cannot work on OSX. In order to protect their precious DRM, Apple has disabled much of the ptrace API. A consequence is that /usr/bin/gdb needs special permissions (it is setgid on OSX, but a normal program on Linux) to fully function. And the dynamic linker disallows library interposition for setgid binaries. In fact, /usr/bin/gdb on osx is a shell script that unsets `DYLD_*` variables before the dynamic linker even gets a chance to complain about them.



---

archive/issue_comments_164104.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nSo you're saying that the `gdb` spkg wouldn't work on OS X?",
    "created_at": "2013-01-15T10:47:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164104",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:40" align="right">comment:40</div>

So you're saying that the `gdb` spkg wouldn't work on OS X?



---

archive/issue_comments_164105.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nI think it'll work if you make gdb suid root, or if you codesign it and make it setgid procmod. But without elevated permissions it won't:\n\n```\n(sage-sh) vbraun@bsd:sage-5.4.rc1$ gdb python\nGNU gdb (GDB) 7.5.1\nCopyright (C) 2012 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-apple-darwin10.8.0\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /Users/vbraun/sage-5.4.rc1/local/bin/python...\nwarning: `/Users/vbraun/sage-5.4.rc1/spkg/build/python-2.7.3.p0/src/Modules/python.o': can't open to read symbols: No such file or directory.\n(no debugging symbols found)...done.\n(gdb) run\nStarting program: /Users/vbraun/sage-5.4.rc1/local/bin/python \nUnable to find Mach task port for process-id 27416: (os/kern) failure (0x5).\n (please check gdb is codesigned - see taskgated(8))\n```",
    "created_at": "2013-01-15T12:05:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164105",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:41" align="right">comment:41</div>

I think it'll work if you make gdb suid root, or if you codesign it and make it setgid procmod. But without elevated permissions it won't:

```
(sage-sh) vbraun@bsd:sage-5.4.rc1$ gdb python
GNU gdb (GDB) 7.5.1
Copyright (C) 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-apple-darwin10.8.0".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /Users/vbraun/sage-5.4.rc1/local/bin/python...
warning: `/Users/vbraun/sage-5.4.rc1/spkg/build/python-2.7.3.p0/src/Modules/python.o': can't open to read symbols: No such file or directory.
(no debugging symbols found)...done.
(gdb) run
Starting program: /Users/vbraun/sage-5.4.rc1/local/bin/python 
Unable to find Mach task port for process-id 27416: (os/kern) failure (0x5).
 (please check gdb is codesigned - see taskgated(8))
```



---

archive/issue_comments_164106.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-01-15T16:19:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164106",
    "user": "https://github.com/jdemeyer"
}
```

Updated patch



---

archive/issue_comments_164107.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,5 +3,5 @@\n The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted.\n \n Apply\n-* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) and [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz) to Sage library\n+* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)\n * [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo\n``````\n",
    "created_at": "2013-01-15T16:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164107",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,5 +3,5 @@
 The log is printed to stdout and automatically saved to a log file in `$DOT_SAGE/crash_logs` with logs older than a week automatically deleted.
 
 Apply
-* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz) and [attachment: 13889_sagelib_review.patch](https://github.com/sagemath/sage/files/ticket13889/13889_sagelib_review.patch.gz) to Sage library
+* [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)
 * [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo
``````




---

archive/issue_comments_164108.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nAttachment: **[trac_13889_enhanced_backtrace.patch.gz](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)**\n\nI merged both sagelib patches and removed the unneeded change to `sage/tests/interrupt.pyx`.",
    "created_at": "2013-01-15T16:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164108",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:42" align="right">comment:42</div>

Attachment: **[trac_13889_enhanced_backtrace.patch.gz](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)**

I merged both sagelib patches and removed the unneeded change to `sage/tests/interrupt.pyx`.



---

archive/issue_comments_164109.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2013-01-15T16:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164109",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_193132.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-15T16:22:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193132"
}
```



---

archive/issue_events_193133.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-15T16:22:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193133"
}
```



---

archive/issue_events_193134.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-15T22:03:08Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193134"
}
```



---

archive/issue_events_193135.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-15T22:03:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193135"
}
```



---

archive/issue_events_193136.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-20T20:14:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193136"
}
```



---

archive/issue_events_193137.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-20T20:14:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193137"
}
```



---

archive/issue_comments_164110.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nThis is an annoying problem on OS X:\n\n```\n$ gdb\nGNU gdb 6.3.50-20050815 (Apple version gdb-1822) (Sun Aug  5 03:00:42 UTC 2012)\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"x86_64-apple-darwin\".\n(gdb) attach 71798\nWe need authorization from an admin user to run the debugger.\nThis will only happen once per login session.\nAdmin username (dehayebuildbot):\n```\n\nAt this point, `gdb` just \"hangs\" causing doctest timeouts.  The best solution might simply be to not run `gdb` at all on OS X, since it's never going to work anyway.",
    "created_at": "2013-01-20T20:14:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164110",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:44" align="right">comment:44</div>

This is an annoying problem on OS X:

```
$ gdb
GNU gdb 6.3.50-20050815 (Apple version gdb-1822) (Sun Aug  5 03:00:42 UTC 2012)
Copyright 2004 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "x86_64-apple-darwin".
(gdb) attach 71798
We need authorization from an admin user to run the debugger.
This will only happen once per login session.
Admin username (dehayebuildbot):
```

At this point, `gdb` just "hangs" causing doctest timeouts.  The best solution might simply be to not run `gdb` at all on OS X, since it's never going to work anyway.



---

archive/issue_comments_164111.json:
```json
{
    "body": "Initial patch",
    "created_at": "2013-01-20T21:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164111",
    "user": "https://github.com/vbraun"
}
```

Initial patch



---

archive/issue_events_193138.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-20T21:12:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193138"
}
```



---

archive/issue_events_193139.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-20T21:12:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193139"
}
```



---

archive/issue_comments_164112.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,4 +4,5 @@\n \n Apply\n * [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)\n+* [attachment: 13889_disable_osx.patch](https://github.com/sagemath/sage/files/ticket13889/13889_disable_osx.patch.gz)\n * [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo\n``````\n",
    "created_at": "2013-01-20T21:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164112",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,4 +4,5 @@
 
 Apply
 * [attachment: trac_13889_enhanced_backtrace.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_enhanced_backtrace.patch.gz)
+* [attachment: 13889_disable_osx.patch](https://github.com/sagemath/sage/files/ticket13889/13889_disable_osx.patch.gz)
 * [attachment: trac_13889_crime_scene_inspector.patch](https://github.com/sagemath/sage/files/ticket13889/trac_13889_crime_scene_inspector.patch.gz) to the `$SAGE_LOCAL/bin` repo
``````




---

archive/issue_comments_164113.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nAttachment: **[13889_disable_osx.patch.gz](https://github.com/sagemath/sage/files/ticket13889/13889_disable_osx.patch.gz)**\n\nfixed",
    "created_at": "2013-01-20T21:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164113",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:45" align="right">comment:45</div>

Attachment: **[13889_disable_osx.patch.gz](https://github.com/sagemath/sage/files/ticket13889/13889_disable_osx.patch.gz)**

fixed



---

archive/issue_comments_164114.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\n\n```\nSee http://trac.sagemath.org/13889 for how Apple screwed this up\n```\n:-)\n\nGoing to test it...",
    "created_at": "2013-01-20T21:44:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164114",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:46" align="right">comment:46</div>


```
See http://trac.sagemath.org/13889 for how Apple screwed this up
```
:-)

Going to test it...



---

archive/issue_events_193140.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T13:17:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193140"
}
```



---

archive/issue_events_193141.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T13:17:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193141"
}
```



---

archive/issue_comments_164115.json:
```json
{
    "body": "Merged: **sage-5.7.beta0**",
    "created_at": "2013-01-21T21:09:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164115",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.7.beta0**



---

archive/issue_events_193142.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:09:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193142"
}
```



---

archive/issue_events_193143.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:09:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13889#event-193143"
}
```



---

archive/issue_comments_164116.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nI noticed that the \"Cython backtrace\" is ordered differently from the \"Stack backtrace\", which is quite confusing.  It would be better to respect the `gdb` ordering (print newest frame first).\n\nWould it be possible to change this?",
    "created_at": "2013-01-28T16:39:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164116",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:49" align="right">comment:49</div>

I noticed that the "Cython backtrace" is ordered differently from the "Stack backtrace", which is quite confusing.  It would be better to respect the `gdb` ordering (print newest frame first).

Would it be possible to change this?



---

archive/issue_comments_164117.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@jdemeyer](#comment%3A49):\n> I noticed that the \"Cython backtrace\" is ordered differently from the \"Stack backtrace\"\n\nThis is now #14030",
    "created_at": "2013-01-28T17:48:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13889",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13889#issuecomment-164117",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@jdemeyer](#comment%3A49):
> I noticed that the "Cython backtrace" is ordered differently from the "Stack backtrace"

This is now #14030
